<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/shell_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2004-2022. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(shell_SUITE).
<a name="21"/>   21: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1, 
<a name="22"/>   22: 	 init_per_group/2,end_per_group/2]).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-export</b>([forget/1, records/1, known_bugs/1, otp_5226/1, otp_5327/1,
<a name="25"/>   25: 	 otp_5435/1, otp_5195/1, otp_5915/1, otp_5916/1,
<a name="26"/>   26: 	 bs_match_misc_SUITE/1, bs_match_int_SUITE/1,
<a name="27"/>   27: 	 bs_match_tail_SUITE/1, bs_match_bin_SUITE/1,
<a name="28"/>   28: 	 bs_construct_SUITE/1,
<a name="29"/>   29: 	 refman_bit_syntax/1, 
<a name="30"/>   30: 	 progex_bit_syntax/1, progex_records/1, 
<a name="31"/>   31: 	 progex_lc/1, progex_funs/1,
<a name="32"/>   32: 	 otp_5990/1, otp_6166/1, otp_6554/1,
<a name="33"/>   33: 	 otp_7184/1, otp_7232/1, otp_8393/1, otp_10302/1, otp_13719/1,
<a name="34"/>   34:          otp_14285/1, otp_14296/1, typed_records/1]).
<a name="35"/>   35: 
<a name="36"/>   36: <b>-export</b>([ start_restricted_from_shell/1, 
<a name="37"/>   37: 	  start_restricted_on_command_line/1,restricted_local/1]).
<a name="38"/>   38: 
<a name="39"/>   39: <i>%% Internal export.</i>
<a name="40"/>   40: <b>-export</b>([otp_5435_2/0, prompt1/1, prompt2/1, prompt3/1, prompt4/1,
<a name="41"/>   41: 	 prompt5/1]).
<a name="42"/>   42: 
<a name="43"/>   43: <i>%%</i>
<a name="44"/>   44: <i>%% Define to run outside of test server</i>
<a name="45"/>   45: <i>%%</i>
<a name="46"/>   46: <i>%% -define(STANDALONE,1).</i>
<a name="47"/>   47: 
<a name="48"/>   48: <b>-ifdef</b>(STANDALONE).
<a name="49"/>   49: <b>-define</b>(config(A,B),config(A,B)).
<a name="50"/>   50: <b>-export</b>([config/2]).
<a name="51"/>   51: <b>-define</b>(line, noop, ).
<a name="52"/>   52: config(priv_dir,_) -&gt;
<a name="53"/>   53:     &quot;.&quot;.
<a name="54"/>   54: -else.
<a name="55"/>   55: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="56"/>   56: <b>-export</b>([init_per_testcase/2, end_per_testcase/2]).
<a name="init_per_testcase-2"/><a name="57"/>   57: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="58"/>   58:     OrigPath = code:get_path(),
<a name="59"/>   59:     code:add_patha(proplists:get_value(priv_dir,Config)),
<a name="init_per_testcase-last_expr"/><a name="60"/>   60:     [{orig_path,OrigPath} | Config].
<a name="61"/>   61: 
<a name="end_per_testcase-2"/><a name="62"/>   62: <b>end_per_testcase</b>(_Case, Config) -&gt;
<a name="63"/>   63:     OrigPath = proplists:get_value(orig_path,Config),
<a name="64"/>   64:     code:set_path(OrigPath),
<a name="65"/>   65:     application:unset_env(stdlib, restricted_shell),
<a name="66"/>   66:     purge_and_delete(user_default),
<a name="67"/>   67:     %% used by `records' test case
<a name="68"/>   68:     purge_and_delete(test),
<a name="end_per_testcase-last_expr"/><a name="69"/>   69:     ok.
<a name="70"/>   70: -endif.
<a name="71"/>   71: 
<a name="suite-0"/><a name="72"/>   72: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="73"/>   73:     [{ct_hooks,[ts_install_cth]},
<a name="74"/>   74:      {timetrap,{minutes,10}}].
<a name="75"/>   75: 
<a name="all-0"/><a name="76"/>   76: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="77"/>   77:     [forget, known_bugs, otp_5226, otp_5327,
<a name="78"/>   78:      otp_5435, otp_5195, otp_5915, otp_5916, {group, bits},
<a name="79"/>   79:      {group, refman}, {group, progex}, {group, tickets},
<a name="80"/>   80:      {group, restricted}, {group, records}].
<a name="81"/>   81: 
<a name="groups-0"/><a name="82"/>   82: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="83"/>   83:     [{restricted, [],
<a name="84"/>   84:       [start_restricted_from_shell,
<a name="85"/>   85:        start_restricted_on_command_line, restricted_local]},
<a name="86"/>   86:      {bits, [],
<a name="87"/>   87:       [bs_match_misc_SUITE, bs_match_tail_SUITE,
<a name="88"/>   88:        bs_match_bin_SUITE, bs_construct_SUITE]},
<a name="89"/>   89:      {records, [],
<a name="90"/>   90:       [records, typed_records]},
<a name="91"/>   91:      {refman, [], [refman_bit_syntax]},
<a name="92"/>   92:      {progex, [],
<a name="93"/>   93:       [progex_bit_syntax, progex_records, progex_lc,
<a name="94"/>   94:        progex_funs]},
<a name="95"/>   95:      {tickets, [],
<a name="96"/>   96:       [otp_5990, otp_6166, otp_6554, otp_7184,
<a name="97"/>   97:        otp_7232, otp_8393, otp_10302, otp_13719, otp_14285, otp_14296]}].
<a name="98"/>   98: 
<a name="init_per_suite-1"/><a name="99"/>   99: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="100"/>  100:     Config.
<a name="101"/>  101: 
<a name="end_per_suite-1"/><a name="102"/>  102: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="103"/>  103:     ok.
<a name="104"/>  104: 
<a name="init_per_group-2"/><a name="105"/>  105: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="106"/>  106:     Config.
<a name="107"/>  107: 
<a name="end_per_group-2"/><a name="108"/>  108: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="109"/>  109:     Config.
<a name="110"/>  110: 
<a name="111"/>  111: 
<a name="112"/>  112: <b>-record</b>(state, {bin, reply, leader, unic = latin1}).
<a name="113"/>  113: 
<a name="114"/>  114: 
<a name="115"/>  115: <i>%% Test that a restricted shell can be started from the normal shell.</i>
<a name="start_restricted_from_shell-1"/><a name="116"/>  116: <b>start_restricted_from_shell</b>(Config) when is_list(Config) -&gt;
<a name="117"/>  117:     [{error,nofile}] = scan(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="118"/>  118: 			      &quot;nonexisting_module) end.&quot;&gt;&gt;),
<a name="119"/>  119:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="120"/>  120: 			 &quot;test_restricted.erl&quot;),
<a name="121"/>  121:     Contents = &lt;&lt;&quot;-module(test_restricted).
<a name="122"/>  122:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="123"/>  123: local_allowed(m,[],State) -&gt;
<a name="124"/>  124:     {true,State};
<a name="125"/>  125: local_allowed(ugly,[],_State) -&gt;
<a name="126"/>  126:     non_conforming_reply;
<a name="127"/>  127: local_allowed(_,_,State) -&gt;
<a name="128"/>  128:     {false,State}.
<a name="129"/>  129: 
<a name="130"/>  130: non_local_allowed({shell,stop_restricted},[],State) -&gt;
<a name="131"/>  131:     {true,State};
<a name="132"/>  132: non_local_allowed({erlang,'+'},[_],State) -&gt;
<a name="133"/>  133:     {true,State};
<a name="134"/>  134: non_local_allowed({erlang,'-'},[_,_],_State) -&gt;
<a name="135"/>  135:     non_conforming_reply;
<a name="136"/>  136: non_local_allowed({h, d}, [Arg], S) -&gt;
<a name="137"/>  137:     {{redirect, {erlang,hd}, [Arg]}, S};
<a name="138"/>  138: non_local_allowed(_,_,State) -&gt;
<a name="139"/>  139:     {false,State}.
<a name="140"/>  140: &quot;&gt;&gt;,
<a name="141"/>  141:     ok = compile_file(Config, Test, Contents, []),
<a name="142"/>  142: &quot;exception exit: restricted shell starts now&quot; =
<a name="143"/>  143: comm_err(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="144"/>  144: 	   &quot;test_restricted) end.&quot;&gt;&gt;),
<a name="145"/>  145: {ok, test_restricted} =
<a name="146"/>  146: application:get_env(stdlib, restricted_shell),
<a name="147"/>  147: &quot;Module&quot; ++ _ = t({&lt;&lt;&quot;begin m() end.&quot;&gt;&gt;, utf8}),
<a name="148"/>  148: &quot;exception exit: restricted shell does not allow c(foo)&quot; =
<a name="149"/>  149: comm_err(&lt;&lt;&quot;begin c(foo) end.&quot;&gt;&gt;),
<a name="150"/>  150: &quot;exception exit: restricted shell does not allow init:stop()&quot; =
<a name="151"/>  151: comm_err(&lt;&lt;&quot;begin init:stop() end.&quot;&gt;&gt;),
<a name="152"/>  152: &quot;exception exit: restricted shell does not allow init:stop()&quot; =
<a name="153"/>  153: comm_err(&lt;&lt;&quot;begin F = fun() -&gt; init:stop() end, F() end.&quot;&gt;&gt;),
<a name="154"/>  154: &quot;exception error: an error occurred when evaluating an arithmetic expression&quot; =
<a name="155"/>  155: comm_err(&lt;&lt;&quot;begin +a end.&quot;&gt;&gt;),
<a name="156"/>  156: &quot;exception exit: restricted shell does not allow a + b&quot; =
<a name="157"/>  157: comm_err(&lt;&lt;&quot;begin a+b end.&quot;&gt;&gt;),
<a name="158"/>  158: &quot;exception exit: restricted shell does not allow - b&quot; =
<a name="159"/>  159: comm_err(&lt;&lt;&quot;begin -b end.&quot;&gt;&gt;),
<a name="160"/>  160: &quot;exception exit: restricted shell does not allow 1 + 2&quot; =
<a name="161"/>  161: comm_err(&lt;&lt;&quot;begin if atom(1 + 2&gt; 0) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="162"/>  162: &quot;exception exit: restricted shell does not allow 1 + 2&quot; =
<a name="163"/>  163: comm_err(&lt;&lt;&quot;begin if is_atom(1 + 2&gt; 0) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="164"/>  164: &quot;exception exit: restricted shell does not allow - 2&quot; =
<a name="165"/>  165: comm_err(&lt;&lt;&quot;begin if - 2 -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="166"/>  166: &quot;exception exit: restricted shell does not allow - 2&quot; =
<a name="167"/>  167: comm_err(&lt;&lt;&quot;begin if (- 2 &gt; 0)  andalso true -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="168"/>  168: &quot;exception exit: restricted shell does not allow - 2&quot; =
<a name="169"/>  169: comm_err(&lt;&lt;&quot;begin if (- 2 &gt; 0)  orelse true -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="170"/>  170: &quot;exception exit: restricted shell does not allow 1 + 2&quot; =
<a name="171"/>  171: comm_err(&lt;&lt;&quot;begin if 1 + 2 &gt; 0 -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="172"/>  172: &quot;exception exit: restricted shell does not allow 1 + 2&quot; =
<a name="173"/>  173: comm_err(&lt;&lt;&quot;begin if erlang:is_atom(1 + 2&gt; 0) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="174"/>  174: &quot;exception exit: restricted shell does not allow is_integer(1)&quot; =
<a name="175"/>  175: comm_err(&lt;&lt;&quot;begin if is_integer(1) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="176"/>  176: &quot;exception exit: restricted shell does not allow is_integer(1)&quot; =
<a name="177"/>  177: comm_err(&lt;&lt;&quot;begin if integer(1) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="178"/>  178: &quot;exception exit: &quot;
<a name="179"/>  179: &quot;restricted shell module returned bad value non_conforming_reply&quot; =
<a name="180"/>  180: comm_err(&lt;&lt;&quot;ugly().&quot;&gt;&gt;),
<a name="181"/>  181: [one] = scan(&lt;&lt;&quot;h:d([one,two]).&quot;&gt;&gt;),
<a name="182"/>  182: &quot;exception exit: &quot;
<a name="183"/>  183: &quot;restricted shell module returned bad value non_conforming_reply&quot; =
<a name="184"/>  184: comm_err(&lt;&lt;&quot;1 - 2.&quot;&gt;&gt;),
<a name="185"/>  185: &quot;exception exit: restricted shell stopped&quot;=
<a name="186"/>  186: comm_err(&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;),
<a name="187"/>  187: undefined =
<a name="188"/>  188: application:get_env(stdlib, restricted_shell),
<a name="start_restricted_from_shell-last_expr"/><a name="189"/>  189: ok.
<a name="190"/>  190: 
<a name="191"/>  191: <i>%% Check restricted shell when started from the command line.</i>
<a name="start_restricted_on_command_line-1"/><a name="192"/>  192: <b>start_restricted_on_command_line</b>(Config) when is_list(Config) -&gt;
<a name="193"/>  193:     {ok, Peer, Node} = ?CT_PEER([&quot;-pa&quot;, proplists:get_value(priv_dir,Config),
<a name="194"/>  194: 			         &quot;-stdlib&quot;, &quot;restricted_shell&quot;, &quot;foo&quot;]),
<a name="195"/>  195:     &quot;Warning! Restricted shell module foo not found: nofile&quot;++_ =
<a name="196"/>  196: 	t({Node, &lt;&lt;&quot;begin m() end.&quot;&gt;&gt;}),
<a name="197"/>  197:     &quot;exception exit: restricted shell does not allow m()&quot; =
<a name="198"/>  198: 	comm_err({Node, &lt;&lt;&quot;begin m() end.&quot;&gt;&gt;}),
<a name="199"/>  199:     [ok] =
<a name="200"/>  200: 	(catch scan({Node, &lt;&lt;&quot;begin q() end.&quot;&gt;&gt;})),
<a name="201"/>  201:     peer:stop(Peer),
<a name="202"/>  202:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="203"/>  203: 			       &quot;test_restricted2.erl&quot;),
<a name="204"/>  204:     Contents = &lt;&lt;&quot;-module(test_restricted2).
<a name="205"/>  205:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="206"/>  206:                   local_allowed(m,[],State) -&gt;
<a name="207"/>  207:                       {true,State};
<a name="208"/>  208:                   local_allowed(_,_,State) -&gt;
<a name="209"/>  209:                       {false,State}.
<a name="210"/>  210: 
<a name="211"/>  211:                   non_local_allowed({shell,stop_restricted},[],State) -&gt;
<a name="212"/>  212:                       {true,State};
<a name="213"/>  213:                   non_local_allowed({erlang,node},[],State) -&gt;
<a name="214"/>  214:                       {true,State};
<a name="215"/>  215:                   non_local_allowed(_,_,State) -&gt;
<a name="216"/>  216:                       {false,State}.
<a name="217"/>  217:                  &quot;&gt;&gt;,
<a name="218"/>  218:     ok = compile_file(Config, Test, Contents, []),
<a name="219"/>  219:     {ok, Peer2, Node2} = ?CT_PEER([&quot;-pa&quot;, proplists:get_value(priv_dir,Config),
<a name="220"/>  220: 				  &quot;-stdlib&quot;, &quot;restricted_shell&quot;, &quot;test_restricted2&quot;]),
<a name="221"/>  221:     &quot;Module&quot; ++ _ = t({Node2,&lt;&lt;&quot;begin m() end.&quot;&gt;&gt;, utf8}),
<a name="222"/>  222:     &quot;exception exit: restricted shell does not allow c(foo)&quot; =
<a name="223"/>  223: 	comm_err({Node2,&lt;&lt;&quot;begin c(foo) end.&quot;&gt;&gt;}),
<a name="224"/>  224:     &quot;exception exit: restricted shell does not allow init:stop()&quot; =
<a name="225"/>  225: 	comm_err({Node2,&lt;&lt;&quot;begin init:stop() end.&quot;&gt;&gt;}),
<a name="226"/>  226:     &quot;exception exit: restricted shell does not allow init:stop()&quot; =
<a name="227"/>  227: 	comm_err({Node2,&lt;&lt;&quot;begin F = fun() -&gt; init:stop() end, F() end.&quot;&gt;&gt;}),
<a name="228"/>  228:     [Node2] =
<a name="229"/>  229: 	scan({Node2, &lt;&lt;&quot;begin erlang:node() end.&quot;&gt;&gt;}),
<a name="230"/>  230:     [Node2] =
<a name="231"/>  231: 	scan({Node2, &lt;&lt;&quot;begin node() end.&quot;&gt;&gt;}),
<a name="232"/>  232:     &quot;exception exit: restricted shell stopped&quot;=
<a name="233"/>  233: 	comm_err({Node2,&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;}),
<a name="234"/>  234:     [ok] =
<a name="235"/>  235: 	scan({Node2, &lt;&lt;&quot;begin q() end.&quot;&gt;&gt;}),
<a name="236"/>  236:     peer:stop(Peer2),
<a name="start_restricted_on_command_line-last_expr"/><a name="237"/>  237:     ok.
<a name="238"/>  238: 
<a name="239"/>  239: <i>%% Tests calling local shell functions with spectacular arguments in</i>
<a name="240"/>  240: <i>%% restricted shell.</i>
<a name="restricted_local-1"/><a name="241"/>  241: <b>restricted_local</b>(Config) when is_list(Config) -&gt;
<a name="242"/>  242:     [{error,nofile}] = scan(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="243"/>  243: 				    &quot;nonexisting_module) end.&quot;&gt;&gt;),
<a name="244"/>  244:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="245"/>  245: 			       &quot;test_restricted_local.erl&quot;),
<a name="246"/>  246:     Contents = &lt;&lt;&quot;-module(test_restricted_local).
<a name="247"/>  247:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="248"/>  248:                   local_allowed(m,[],State) -&gt;
<a name="249"/>  249:                       {true,State};
<a name="250"/>  250:                   local_allowed(banan,_,State) -&gt;
<a name="251"/>  251:                       {true,State};
<a name="252"/>  252:                   local_allowed(funkis,_,State) -&gt;
<a name="253"/>  253:                       {true,State};
<a name="254"/>  254:                   local_allowed(c,_,State) -&gt;
<a name="255"/>  255:                       {true,State};
<a name="256"/>  256:                   local_allowed(_,_,State) -&gt;
<a name="257"/>  257:                       {false,State}.
<a name="258"/>  258: 
<a name="259"/>  259:                   non_local_allowed({erlang,raise},[error, _, _],State) -&gt;
<a name="260"/>  260:                       {true,State};
<a name="261"/>  261:                   non_local_allowed({shell,stop_restricted},[],State) -&gt;
<a name="262"/>  262:                       {true,State};
<a name="263"/>  263:                   non_local_allowed(_,_,State) -&gt;
<a name="264"/>  264:                       {false,State}.
<a name="265"/>  265:                  &quot;&gt;&gt;,
<a name="266"/>  266:     ok = compile_file(Config, Test, Contents, []),
<a name="267"/>  267:     Test2 = filename:join(proplists:get_value(priv_dir, Config),
<a name="268"/>  268: 			       &quot;user_default.erl&quot;),
<a name="269"/>  269:     Contents2 = &lt;&lt;&quot;-module(user_default).
<a name="270"/>  270:                   -export([funkis/1,apple/1]).
<a name="271"/>  271:                   funkis(F) when is_function(F) -&gt;
<a name="272"/>  272:                       funkis;
<a name="273"/>  273:                   funkis(_) -&gt;
<a name="274"/>  274:                       nofunkis.
<a name="275"/>  275:                   apple(_) -&gt;
<a name="276"/>  276:                       apple.
<a name="277"/>  277:                  &quot;&gt;&gt;,
<a name="278"/>  278:     ok = compile_file(Config, Test2, Contents2, []),
<a name="279"/>  279:     &quot;exception exit: restricted shell starts now&quot; =
<a name="280"/>  280: 	comm_err(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="281"/>  281: 			 &quot;test_restricted_local) end.&quot;&gt;&gt;),
<a name="282"/>  282:     {ok, test_restricted_local} =
<a name="283"/>  283: 	application:get_env(stdlib, restricted_shell),
<a name="284"/>  284:     &quot;exception exit: restricted shell does not allow foo(&quot; ++ _ =
<a name="285"/>  285: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, foo(F) end.&quot;&gt;&gt;),
<a name="286"/>  286:     &quot;exception error: undefined shell command banan/1&quot; =
<a name="287"/>  287: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, banan(F) end.&quot;&gt;&gt;),
<a name="288"/>  288:     &quot;Recompiling &quot;++_ = t(&lt;&lt;&quot;c(shell_SUITE).&quot;&gt;&gt;),
<a name="289"/>  289:     &quot;exception exit: restricted shell does not allow l(&quot; ++ _ =
<a name="290"/>  290: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, l(F) end.&quot;&gt;&gt;),
<a name="291"/>  291:     &quot;exception error: variable 'F' is unbound&quot; =
<a name="292"/>  292: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, f(F), F end.&quot;&gt;&gt;),
<a name="293"/>  293:     [funkis] =
<a name="294"/>  294: 	scan(&lt;&lt;&quot;begin F=fun() -&gt; hello end, funkis(F) end.&quot;&gt;&gt;),
<a name="295"/>  295:     &quot;exception exit: restricted shell does not allow apple(&quot; ++ _ =
<a name="296"/>  296: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, apple(F) end.&quot;&gt;&gt;),
<a name="297"/>  297:     &quot;exception exit: restricted shell stopped&quot;=
<a name="298"/>  298: 	comm_err(&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;),
<a name="299"/>  299:     undefined =
<a name="300"/>  300: 	application:get_env(stdlib, restricted_shell),
<a name="301"/>  301:     true = purge_and_delete(user_default),
<a name="restricted_local-last_expr"/><a name="302"/>  302:     ok.
<a name="303"/>  303:     
<a name="304"/>  304: 
<a name="305"/>  305: <i>%% f/0 and f/1.</i>
<a name="forget-1"/><a name="306"/>  306: <b>forget</b>(Config) when is_list(Config) -&gt;
<a name="307"/>  307:     %% f/0
<a name="308"/>  308:     [ok] = scan(&lt;&lt;&quot;begin f() end.&quot;&gt;&gt;),
<a name="309"/>  309:     &quot;1:13: variable 'A' is unbound&quot; =
<a name="310"/>  310:         comm_err(&lt;&lt;&quot;A = 3, f(), A.&quot;&gt;&gt;),
<a name="311"/>  311:     [ok] = scan(&lt;&lt;&quot;A = 3, A = f(), A.&quot;&gt;&gt;),
<a name="312"/>  312: 
<a name="313"/>  313:     %% f/1
<a name="314"/>  314:     [ok] = scan(&lt;&lt;&quot;begin f(A) end.&quot;&gt;&gt;),
<a name="315"/>  315:     &quot;1:14: variable 'A' is unbound&quot; =
<a name="316"/>  316:         comm_err(&lt;&lt;&quot;A = 3, f(A), A.&quot;&gt;&gt;),
<a name="317"/>  317:     [ok] = scan(&lt;&lt;&quot;A = 3, A = f(A), A.&quot;&gt;&gt;),
<a name="318"/>  318:     &quot;exception error: no function clause matching call to f/1&quot; =
<a name="319"/>  319:         comm_err(&lt;&lt;&quot;f(a).&quot;&gt;&gt;),
<a name="forget-last_expr"/><a name="320"/>  320:     ok.
<a name="321"/>  321: 
<a name="322"/>  322: <i>%% Test of the record support. OTP-5063.</i>
<a name="records-1"/><a name="323"/>  323: <b>records</b>(Config) when is_list(Config) -&gt;
<a name="324"/>  324:     %% rd/2
<a name="325"/>  325:     [{attribute,_,record,{bar,_}},ok] =
<a name="326"/>  326:         scan(&lt;&lt;&quot;rd(foo,{bar}), 
<a name="327"/>  327:                 rd(bar,{foo = (#foo{})#foo.bar}),
<a name="328"/>  328:                 rl(bar).&quot;&gt;&gt;),
<a name="329"/>  329:     &quot;variable 'R' is unbound&quot; = % used to work (before OTP-5878, R11B)
<a name="330"/>  330:         exit_string(&lt;&lt;&quot;rd(foo,{bar}), 
<a name="331"/>  331:                        R = #foo{},
<a name="332"/>  332:                        rd(bar,{foo = R#foo.bar}).&quot;&gt;&gt;),
<a name="333"/>  333:     &quot;exception error: no function clause matching call to rd/2&quot; =
<a name="334"/>  334:         comm_err(&lt;&lt;&quot;rd({foo},{bar}).&quot;&gt;&gt;),
<a name="335"/>  335:     &quot;bad record declaration&quot; = exit_string(&lt;&lt;&quot;A = bar, rd(foo,A).&quot;&gt;&gt;),
<a name="336"/>  336:     [foo] = scan(&lt;&lt;&quot;begin rd(foo,{bar}) end.&quot;&gt;&gt;),
<a name="337"/>  337:     &quot;1:22: record foo undefined&quot; =
<a name="338"/>  338:          comm_err(&lt;&lt;&quot;begin rd(foo,{bar}), #foo{} end.&quot;&gt;&gt;),
<a name="339"/>  339:     ['f o o'] = scan(&lt;&lt;&quot;rd('f o o', {bar}).&quot;&gt;&gt;),
<a name="340"/>  340:     [foo] = scan(&lt;&lt;&quot;rd(foo,{bar}), rd(foo,{foo = #foo{}}).&quot;&gt;&gt;),
<a name="341"/>  341: 
<a name="342"/>  342:     %% rf/0,1
<a name="343"/>  343:     [_, {attribute,_,record,{foo,_}},ok] =
<a name="344"/>  344:          scan(&lt;&lt;&quot;rf('_'). rd(foo,{bar}),rl().&quot;&gt;&gt;),
<a name="345"/>  345:     &quot;1:33: record foo undefined&quot; =
<a name="346"/>  346:         comm_err(&lt;&lt;&quot;rd(foo,{bar}), #foo{}, rf(foo), #foo{}.&quot;&gt;&gt;),
<a name="347"/>  347:     [ok,{foo,undefined}] =
<a name="348"/>  348:         scan(&lt;&lt;&quot;rd(foo,{bar}), A = #foo{}, rf(foo). A.&quot;&gt;&gt;),
<a name="349"/>  349:     [_] = scan(&lt;&lt;&quot;begin rf() end.&quot;&gt;&gt;),
<a name="350"/>  350:     [ok] = scan(&lt;&lt;&quot;begin rf(foo) end.&quot;&gt;&gt;),
<a name="351"/>  351: 
<a name="352"/>  352:     %% rp/1
<a name="353"/>  353:     &quot;#foo{bar = undefined}.\nok.\n&quot; =
<a name="354"/>  354:         t(&lt;&lt;&quot;rd(foo,{bar}), rp(#foo{}).&quot;&gt;&gt;),
<a name="355"/>  355:     [{foo,3,4,3},ok] = scan(&lt;&lt;&quot;rd(foo,{a = 3, b}), rp({foo,3,4,3}).&quot;&gt;&gt;),
<a name="356"/>  356:     &quot;#foo{a = 12}.\nok.\n&quot; = t(&lt;&lt;&quot;rd(foo,{a = 3}), rp({foo,12}).&quot;&gt;&gt;),
<a name="357"/>  357:     [{[{foo}],12},ok] = scan(&lt;&lt;&quot;rd(foo,{a = 3}), rp({[{foo}],12}).&quot;&gt;&gt;),
<a name="358"/>  358: 
<a name="359"/>  359:     %% rr/1,2,3
<a name="360"/>  360:     MS = ?MODULE_STRING,
<a name="361"/>  361:     RR1 = &quot;rr(&quot; ++ MS ++ &quot;). #state{}.&quot;,
<a name="362"/>  362:     &quot;[state]\n&quot;
<a name="363"/>  363:           &quot;#state{bin = undefined,reply = undefined,leader = undefined,\n&quot;
<a name="364"/>  364:           &quot;       unic = latin1}.\n&quot; =
<a name="365"/>  365:         t(RR1),
<a name="366"/>  366:     RR2 = &quot;rr(&quot; ++ MS ++ &quot;,[state]). #state{}.&quot;,
<a name="367"/>  367:     &quot;[state]\n&quot;
<a name="368"/>  368:           &quot;#state{bin = undefined,reply = undefined,leader = undefined,\n&quot;
<a name="369"/>  369:           &quot;       unic = latin1}.\n&quot; =
<a name="370"/>  370:         t(RR2),
<a name="371"/>  371:     RR3 = &quot;rr(&quot; ++ MS ++ &quot;,'_'). #state{}.&quot;,
<a name="372"/>  372:     &quot;[state]\n&quot;
<a name="373"/>  373:           &quot;#state{bin = undefined,reply = undefined,leader = undefined,\n&quot;
<a name="374"/>  374:           &quot;       unic = latin1}.\n&quot; =
<a name="375"/>  375:         t(RR3),
<a name="376"/>  376:     RR4 = &quot;rr(&quot; ++ MS ++ &quot;, '_', {d,test1}).&quot;,
<a name="377"/>  377:     [[state]] = scan(RR4),
<a name="378"/>  378: 
<a name="379"/>  379:     Test = filename:join(proplists:get_value(priv_dir, Config), &quot;test.erl&quot;),
<a name="380"/>  380:     BeamDir = filename:join(proplists:get_value(priv_dir, Config), &quot;beam&quot;),
<a name="381"/>  381:     BeamFile = filename:join(BeamDir, &quot;test&quot;),
<a name="382"/>  382:     ok = file:make_dir(BeamDir),
<a name="383"/>  383:     Contents = &lt;&lt;&quot;-module(test).
<a name="384"/>  384:                   -record(state, {bin :: binary(),
<a name="385"/>  385:                                   reply = no,
<a name="386"/>  386:                                   leader = some :: atom()}).
<a name="387"/>  387: 
<a name="388"/>  388:                   -ifdef(test1).
<a name="389"/>  389:                   -record(test1, {f}).
<a name="390"/>  390:                   -endif.
<a name="391"/>  391: 
<a name="392"/>  392:                   -ifdef(test2).
<a name="393"/>  393:                   -record(test2, {g}).
<a name="394"/>  394:                   -endif.
<a name="395"/>  395:                  &quot;&gt;&gt;,
<a name="396"/>  396:     ok = file:write_file(Test, Contents),
<a name="397"/>  397:     {ok, test} = compile:file(Test, [{outdir, BeamDir}]),
<a name="398"/>  398: 
<a name="399"/>  399:     RR5 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;, '_', {d,test1}), rl([test1,test2]).&quot;,
<a name="400"/>  400:     A1 = erl_anno:new(1),
<a name="401"/>  401:     [{attribute,A1,record,{test1,_}},ok] = scan(RR5),
<a name="402"/>  402:     RR6 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;, '_', {d,test2}), rl([test1,test2]).&quot;,
<a name="403"/>  403:     [{attribute,A1,record,{test2,_}},ok] = scan(RR6),
<a name="404"/>  404:     RR7 = &quot;rr(\&quot;&quot; ++ Test ++ 
<a name="405"/>  405:            &quot;\&quot;, '_', [{d,test1},{d,test2,17}]), rl([test1,test2]).&quot;,
<a name="406"/>  406:     [{attribute,A1,record,{test1,_}},{attribute,A1,record,{test2,_}},ok] =
<a name="407"/>  407:         scan(RR7),
<a name="408"/>  408:     PreReply = scan(&lt;&lt;&quot;rr(prim_file).&quot;&gt;&gt;), % preloaded...
<a name="409"/>  409:     true = is_list(PreReply),
<a name="410"/>  410:     Dir = filename:join(proplists:get_value(priv_dir, Config), &quot;*.erl&quot;),
<a name="411"/>  411:     RR8 = &quot;rp(rr(\&quot;&quot; ++ Dir ++ &quot;\&quot;)).&quot;,
<a name="412"/>  412:     [_,ok] = scan(RR8),
<a name="413"/>  413: 
<a name="414"/>  414:     {module, test} = code:load_abs(BeamFile),
<a name="415"/>  415:     [[state]] = scan(&lt;&lt;&quot;rr(test).&quot;&gt;&gt;),
<a name="416"/>  416:     file:delete(Test),
<a name="417"/>  417:     file:delete(BeamFile++&quot;.beam&quot;),
<a name="418"/>  418: 
<a name="419"/>  419:     RR1000 = &quot;begin rr(&quot; ++ MS ++ &quot;) end.&quot;,
<a name="420"/>  420:     [_] = scan(RR1000),
<a name="421"/>  421:     RR1001 = &quot;begin rr(&quot; ++ MS ++ &quot;, state) end.&quot;,
<a name="422"/>  422:     [_] = scan(RR1001),
<a name="423"/>  423:     RR1002 = &quot;begin rr(&quot; ++ MS ++ &quot;, state,{i,'.'}) end.&quot;,
<a name="424"/>  424:     [_] = scan(RR1002),
<a name="425"/>  425: 
<a name="426"/>  426:     [{error,nofile}] = scan(&lt;&lt;&quot;rr(not_a_module).&quot;&gt;&gt;),
<a name="427"/>  427:     [{error,invalid_filename}] = scan(&lt;&lt;&quot;rr({foo}).&quot;&gt;&gt;),
<a name="428"/>  428:     [[]] = scan(&lt;&lt;&quot;rr(\&quot;not_a_file\&quot;).&quot;&gt;&gt;),
<a name="429"/>  429: 
<a name="430"/>  430:     %% load record from archive
<a name="431"/>  431:     true = purge_and_delete(test),
<a name="432"/>  432: 
<a name="433"/>  433:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="434"/>  434:     AppDir = filename:join(PrivDir, &quot;test_app&quot;),
<a name="435"/>  435:     ok = file:make_dir(AppDir),
<a name="436"/>  436:     AppEbinDir = filename:join(AppDir, &quot;ebin&quot;),
<a name="437"/>  437:     ok = file:make_dir(AppEbinDir),
<a name="438"/>  438: 
<a name="439"/>  439:     ok = file:write_file(Test, Contents),
<a name="440"/>  440:     {ok, test} = compile:file(Test, [{outdir, AppEbinDir}]),
<a name="441"/>  441: 
<a name="442"/>  442:     Ext = init:archive_extension(),
<a name="443"/>  443:     Archive = filename:join(PrivDir, &quot;test_app&quot; ++ Ext),
<a name="444"/>  444:     {ok, _} = zip:create(Archive, [&quot;test_app&quot;], [{compress, []}, {cwd, PrivDir}]),
<a name="445"/>  445: 
<a name="446"/>  446:     ArchiveEbinDir = filename:join(Archive, &quot;test_app/ebin&quot;),
<a name="447"/>  447:     true = code:add_path(ArchiveEbinDir),
<a name="448"/>  448:     {module, test} = code:load_file(test),
<a name="449"/>  449:     BeamInArchive = filename:join(ArchiveEbinDir, &quot;test.beam&quot;),
<a name="450"/>  450:     BeamInArchive = code:which(test),
<a name="451"/>  451: 
<a name="452"/>  452:     [[state]] = scan(&lt;&lt;&quot;rr(test).&quot;&gt;&gt;),
<a name="453"/>  453: 
<a name="454"/>  454:     %% using records
<a name="455"/>  455:     [2] = scan(&lt;&lt;&quot;rd(foo,{bar}), record_info(size, foo).&quot;&gt;&gt;),
<a name="456"/>  456:     [true] = scan(&lt;&lt;&quot;rd(foo,{bar}), is_record(#foo{}, foo).&quot;&gt;&gt;),
<a name="457"/>  457:     [true] = scan(&lt;&lt;&quot;rd(foo,{bar}), erlang:is_record(#foo{}, foo).&quot;&gt;&gt;),
<a name="458"/>  458:     [true] = scan(&lt;&lt;&quot;rd(foo,{bar}),
<a name="459"/>  459:                      fun() when record(#foo{},foo) -&gt; true end().&quot;&gt;&gt;),
<a name="460"/>  460:     [2] = scan(&lt;&lt;&quot;rd(foo,{bar}), #foo.bar.&quot;&gt;&gt;),
<a name="461"/>  461:     &quot;#foo{bar = 17}.\n&quot; =
<a name="462"/>  462:         t(&lt;&lt;&quot;rd(foo,{bar}), A = #foo{}, A#foo{bar = 17}.&quot;&gt;&gt;),
<a name="463"/>  463: 
<a name="464"/>  464:     %% test of is_record/2 in lc
<a name="465"/>  465:     &quot;[#foo{bar = 3}].\n&quot; =
<a name="466"/>  466:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="467"/>  467:             &quot;is_record(X, foo)].&quot;&gt;&gt;),
<a name="468"/>  468:     &quot;[x,[],{a,b}].\n&quot; =
<a name="469"/>  469:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="470"/>  470:             &quot;not is_record(X, foo)].&quot;&gt;&gt;),
<a name="471"/>  471:     &quot;[#foo{bar = 3}].\n&quot; =
<a name="472"/>  472:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="473"/>  473:             &quot;begin is_record(X, foo) end].&quot;&gt;&gt;),
<a name="474"/>  474:     &quot;[x,[],{a,b}].\n&quot; =
<a name="475"/>  475:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="476"/>  476:             &quot;begin not is_record(X, foo) end].&quot;&gt;&gt;),
<a name="477"/>  477: 
<a name="478"/>  478:     &quot;[#foo{bar = 3},x,[],{a,b}].\n&quot; =
<a name="479"/>  479:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="480"/>  480:             &quot;is_record(X, foo) or not is_binary(X)].&quot;&gt;&gt;),
<a name="481"/>  481:     &quot;[#foo{bar = 3},x,[],{a,b}].\n&quot; =
<a name="482"/>  482:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="483"/>  483:             &quot;not is_record(X, foo) or not is_binary(X)].&quot;&gt;&gt;),
<a name="484"/>  484:     &quot;[#foo{bar = 3}].\n&quot; =
<a name="485"/>  485:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="486"/>  486:             &quot;is_record(X, foo) or is_reference(X)].&quot;&gt;&gt;),
<a name="487"/>  487:     &quot;[x,[],{a,b}].\n&quot; =
<a name="488"/>  488:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="489"/>  489:             &quot;not is_record(X, foo) or is_reference(X)].&quot;&gt;&gt;),
<a name="490"/>  490: 
<a name="491"/>  491:     &quot;[#foo{bar = 3},x,[],{a,b}].\n&quot; =
<a name="492"/>  492:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="493"/>  493:             &quot;begin is_record(X, foo) or not is_binary(X) end].&quot;&gt;&gt;),
<a name="494"/>  494:     &quot;[#foo{bar = 3},x,[],{a,b}].\n&quot; =
<a name="495"/>  495:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="496"/>  496:             &quot;begin not is_record(X, foo) or not is_binary(X) end].&quot;&gt;&gt;),
<a name="497"/>  497:     &quot;[#foo{bar = 3}].\n&quot; =
<a name="498"/>  498:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="499"/>  499:             &quot;begin is_record(X, foo) or is_reference(X) end].&quot;&gt;&gt;),
<a name="500"/>  500:     &quot;[x,[],{a,b}].\n&quot; =
<a name="501"/>  501:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="502"/>  502:             &quot;begin not is_record(X, foo) or is_reference(X) end].&quot;&gt;&gt;),
<a name="503"/>  503: 
<a name="504"/>  504:     [ok] =
<a name="505"/>  505:         scan(&lt;&lt;&quot;rd(a,{}), is_record({a},a) andalso true, b().&quot;&gt;&gt;),
<a name="506"/>  506:     
<a name="507"/>  507:     %% nested record defs
<a name="508"/>  508:     &quot;#b{a = #a{}}.\n&quot; = t(&lt;&lt;&quot;rd(a,{}), rd(b, {a = #a{}}), #b{}.&quot;&gt;&gt;),
<a name="509"/>  509: 
<a name="510"/>  510:     [ok,ok,ok] = scan(&lt;&lt;&quot;rf('_'), rp(rp(rl(rf(rf(rf(rl())))))).&quot;&gt;&gt;),
<a name="511"/>  511: 
<a name="records-last_expr"/><a name="512"/>  512:     ok.
<a name="513"/>  513: 
<a name="514"/>  514: <i>%% Test of typed record support.</i>
<a name="typed_records-1"/><a name="515"/>  515: <b>typed_records</b>(Config) when is_list(Config) -&gt;
<a name="516"/>  516:     Test = filename:join(proplists:get_value(priv_dir, Config), &quot;test.hrl&quot;),
<a name="517"/>  517:     Contents = &lt;&lt;&quot;-module(test).
<a name="518"/>  518:                   -record(r0,{f :: any()}).
<a name="519"/>  519:                   -record(r1,{f1 :: #r1{} | undefined, f2 :: #r0{} | atom()}).
<a name="520"/>  520:                   -record(r2,{f :: #r2{} | undefined}).
<a name="521"/>  521:                  &quot;&gt;&gt;,
<a name="522"/>  522:     ok = file:write_file(Test, Contents),
<a name="523"/>  523: 
<a name="524"/>  524:     RR1 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="525"/>  525:           #r1{} = (#r1{f1=#r1{f1=undefined, f2=x}, f2 = #r0{}})#r1.f1,
<a name="526"/>  526:           ok.&quot;,
<a name="527"/>  527:     RR2 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="528"/>  528:           #r0{} = (#r1{f1=#r1{f1=undefined, f2=x}, f2 = #r0{}})#r1.f2,
<a name="529"/>  529:           ok. &quot;,
<a name="530"/>  530:     RR3 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="531"/>  531:           #r1{f2=#r0{}} = (#r1{f1=#r1{f1=undefined, f2=#r0{}}, f2 = x})#r1.f1,
<a name="532"/>  532:           ok.&quot;,
<a name="533"/>  533:     RR4 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="534"/>  534:           (#r1{f2 = #r0{}})#r1{f2 = x},
<a name="535"/>  535:           ok. &quot;,
<a name="536"/>  536:     RR5 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="537"/>  537:           (#r1{f2 = #r0{}})#r1{f1 = #r1{}},
<a name="538"/>  538:           ok. &quot;,
<a name="539"/>  539:     RR6 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="540"/>  540:            (#r2{f=#r2{f=undefined}})#r2.f,
<a name="541"/>  541:           ok.&quot;,
<a name="542"/>  542:     RR7 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="543"/>  543:            #r2{} = (#r2{f=#r2{f=undefined}})#r2.f,
<a name="544"/>  544:           ok.&quot;,
<a name="545"/>  545:     [ok] = scan(RR1),
<a name="546"/>  546:     [ok] = scan(RR2),
<a name="547"/>  547:     [ok] = scan(RR3),
<a name="548"/>  548:     [ok] = scan(RR4),
<a name="549"/>  549:     [ok] = scan(RR5),
<a name="550"/>  550:     [ok] = scan(RR6),
<a name="551"/>  551:     [ok] = scan(RR7),
<a name="552"/>  552: 
<a name="553"/>  553:     file:delete(Test),
<a name="typed_records-last_expr"/><a name="554"/>  554:     ok.
<a name="555"/>  555: 
<a name="556"/>  556: <i>%% Known bugs.</i>
<a name="known_bugs-1"/><a name="557"/>  557: <b>known_bugs</b>(Config) when is_list(Config) -&gt;
<a name="558"/>  558:     %% erl_eval:merge_bindings/2 cannot handle _removal_ of bindings.
<a name="559"/>  559:     [3] = scan(&lt;&lt;&quot;A = 3, length(begin f(A), [3] end), A.&quot;&gt;&gt;),
<a name="known_bugs-last_expr"/><a name="560"/>  560:     ok.
<a name="561"/>  561: 
<a name="562"/>  562: <i>%% OTP-5226. Wildcards accepted when reading BEAM files using rr/1,2,3.</i>
<a name="otp_5226-1"/><a name="563"/>  563: <b>otp_5226</b>(Config) when is_list(Config) -&gt;
<a name="564"/>  564:     Test1 = &lt;&lt;&quot;-module(test1).
<a name="565"/>  565:                -record('_test1', {a,b}).&quot;&gt;&gt;,
<a name="566"/>  566:     Test2 = &lt;&lt;&quot;-module(test2).
<a name="567"/>  567:                -record('_test2', {c,d}).&quot;&gt;&gt;,
<a name="568"/>  568:     File1 = filename(&quot;test1.erl&quot;, Config),
<a name="569"/>  569: 	      File2 = filename(&quot;test2.erl&quot;, Config),
<a name="570"/>  570: 	      Beam = filename(&quot;*.beam&quot;, Config),
<a name="571"/>  571: 	      ok = compile_file(Config, File1, Test1, [no_debug_info]),
<a name="572"/>  572: 	      ok = compile_file(Config, File2, Test2, [no_debug_info]),
<a name="573"/>  573: 	      RR = &quot;rr(\&quot;&quot; ++ Beam ++ &quot;\&quot;).&quot;,
<a name="574"/>  574: 	      [Recs] = scan(RR),
<a name="575"/>  575: 	      true = lists:member('_test1', Recs),
<a name="576"/>  576: 	      true = lists:member('_test2', Recs),
<a name="577"/>  577: 	      file:delete(filename(&quot;test1.beam&quot;, Config)),
<a name="578"/>  578: 	      file:delete(filename(&quot;test2.beam&quot;, Config)),
<a name="579"/>  579: 	      file:delete(File1),
<a name="580"/>  580: 	      file:delete(File2),
<a name="otp_5226-last_expr"/><a name="581"/>  581: 	      ok.
<a name="582"/>  582: 
<a name="583"/>  583: <i>%% OTP-5226. Test of eval_bits, mostly.</i>
<a name="otp_5327-1"/><a name="584"/>  584: <b>otp_5327</b>(Config) when is_list(Config) -&gt;
<a name="585"/>  585:     &quot;exception error: bad argument&quot; =
<a name="586"/>  586:         comm_err(&lt;&lt;&quot;&lt;&lt;\&quot;hej\&quot;:default&gt;&gt;.&quot;&gt;&gt;),
<a name="587"/>  587:     L1 = erl_anno:new(1),
<a name="588"/>  588:     &lt;&lt;&quot;abc&quot;&gt;&gt; =
<a name="589"/>  589:         erl_parse:normalise({bin,L1,[{bin_element,L1,{string,L1,&quot;abc&quot;},
<a name="590"/>  590:                                       default,default}]}),
<a name="591"/>  591:     [&lt;&lt;&quot;abc&quot;&gt;&gt;] = scan(&lt;&lt;&quot;&lt;&lt;(&lt;&lt;\&quot;abc\&quot;&gt;&gt;):3/binary&gt;&gt;.&quot;&gt;&gt;),
<a name="592"/>  592:     [&lt;&lt;&quot;abc&quot;&gt;&gt;] = scan(&lt;&lt;&quot;&lt;&lt;(&lt;&lt;\&quot;abc\&quot;&gt;&gt;)/binary&gt;&gt;.&quot;&gt;&gt;),
<a name="593"/>  593:     &quot;exception error: construction of binary failed&quot; =
<a name="594"/>  594:         comm_err(&lt;&lt;&quot;&lt;&lt;(&lt;&lt;\&quot;abc\&quot;&gt;&gt;):4/binary&gt;&gt;.&quot;&gt;&gt;),
<a name="595"/>  595:     true = byte_size(hd(scan(&quot;&lt;&lt;3.14:64/float&gt;&gt;.&quot;))) =:= 8,
<a name="596"/>  596:     true = byte_size(hd(scan(&quot;&lt;&lt;3.14:32/float&gt;&gt;.&quot;))) =:= 4,
<a name="597"/>  597:     &quot;exception error: construction of binary failed&quot; =
<a name="598"/>  598:         comm_err(&lt;&lt;&quot;&lt;&lt;3.14:128/float&gt;&gt;.&quot;&gt;&gt;),
<a name="599"/>  599:     &quot;exception error: bad argument&quot; =
<a name="600"/>  600:         comm_err(&lt;&lt;&quot;&lt;&lt;10:default&gt;&gt;.&quot;&gt;&gt;),
<a name="601"/>  601:     [&lt;&lt;98,1:1&gt;&gt;] = scan(&lt;&lt;&quot;&lt;&lt;3:3,5:6&gt;&gt;.&quot;&gt;&gt;),
<a name="602"/>  602:     {'EXIT',{badarg,_}} =
<a name="603"/>  603:         (catch erl_parse:normalise({bin,L1,[{bin_element,L1,{integer,L1,17},
<a name="604"/>  604:                                              {atom,L1,all},
<a name="605"/>  605:                                              default}]})),
<a name="606"/>  606:     [&lt;&lt;-20/signed&gt;&gt;] = scan(&lt;&lt;&quot;&lt;&lt;-20/signed&gt;&gt; = &lt;&lt;-20&gt;&gt;.&quot;&gt;&gt;),
<a name="607"/>  607:     [&lt;&lt;-300:16/signed&gt;&gt;] =
<a name="608"/>  608: 	scan(&lt;&lt;&quot;&lt;&lt;-300:16/signed&gt;&gt; = &lt;&lt;-300:16&gt;&gt;.&quot;&gt;&gt;),
<a name="609"/>  609:     [&lt;&lt;-1000:24/signed&gt;&gt;] =
<a name="610"/>  610: 	scan(&lt;&lt;&quot;&lt;&lt;-1000:24/signed&gt;&gt; = &lt;&lt;-1000:24&gt;&gt;.&quot;&gt;&gt;),
<a name="611"/>  611:     [&lt;&lt;-(1 bsl 29):32/signed&gt;&gt;] =
<a name="612"/>  612:         scan(&lt;&lt;&quot;&lt;&lt;-(1 bsl 29):32/signed&gt;&gt; = &lt;&lt;-(1 bsl 29):32&gt;&gt;.&quot;&gt;&gt;),
<a name="613"/>  613: 
<a name="614"/>  614:     &quot;exception error: no match of right hand side value &lt;&lt;0,0,0&gt;&gt;&quot; =
<a name="615"/>  615:         comm_err(&lt;&lt;&quot;&lt;&lt;B:3/unit:7-binary,_/binary&gt;&gt; = &lt;&lt;0:24&gt;&gt;.&quot;&gt;&gt;),
<a name="616"/>  616:     true = [&lt;&lt;103133:64/float&gt;&gt;] =:=
<a name="617"/>  617:         scan(&lt;&lt;&quot;&lt;&lt;103133:64/float&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="618"/>  618:     true = [&lt;&lt;103133.0:64/float&gt;&gt;] =:=
<a name="619"/>  619:         scan(&lt;&lt;&quot;&lt;&lt;103133.0:64/float&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="620"/>  620:     true = [&lt;&lt;103133:64/float&gt;&gt;] =:= scan(&lt;&lt;&quot;&lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="621"/>  621:     Int = 17,
<a name="622"/>  622:     true = [&lt;&lt;Int:64/float&gt;&gt;] =:= scan(&lt;&lt;&quot;Int = 17, &lt;&lt;Int:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="623"/>  623:     &quot;exception error: no match of right hand side value&quot; ++ _ =
<a name="624"/>  624:         comm_err(&lt;&lt;&quot;&lt;&lt;103133:64/binary&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="625"/>  625:     &quot;exception error: interpreted function with arity 1 called with two arguments&quot; =
<a name="626"/>  626:         comm_err(&lt;&lt;&quot;(fun(X) -&gt; X end)(a,b).&quot;&gt;&gt;),
<a name="627"/>  627:     {'EXIT', {{badmatch,&lt;&lt;17:32&gt;&gt;}, _}} =
<a name="628"/>  628:         (catch evaluate(&quot;&lt;&lt;A:a&gt;&gt; = &lt;&lt;17:32&gt;&gt;.&quot;, [])),
<a name="629"/>  629:     C = &lt;&lt;&quot;
<a name="630"/>  630:          &lt;&lt;A:4,B:4,C:4,D:4,E:4,F:4&gt;&gt; = &lt;&lt;\&quot;hej\&quot;&gt;&gt;,
<a name="631"/>  631:          case &lt;&lt;7:4,A:4,B:4,C:4,D:4,E:4,F:4,3:4&gt;&gt; of
<a name="632"/>  632:             &lt;&lt;_:4,\&quot;hej\&quot;,3:4&gt;&gt; -&gt; 1;
<a name="633"/>  633:             _ -&gt; 2
<a name="634"/>  634:          end.
<a name="635"/>  635:         &quot;&gt;&gt;,
<a name="636"/>  636:     1 = evaluate(C, []),
<a name="637"/>  637:     %% unbound_var would be nicer...
<a name="638"/>  638:     {'EXIT',{{illegal_pattern,_},_}} =
<a name="639"/>  639:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;A:B&gt;&gt; = &lt;&lt;17:32&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="640"/>  640:     %% A badarith exception is turned into badmatch.
<a name="641"/>  641:     {'EXIT', {{badmatch,&lt;&lt;1777:32&gt;&gt;}, _}} =
<a name="642"/>  642:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;A:(1/0)&gt;&gt; = &lt;&lt;1777:32&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="643"/>  643:     %% undefined_bittype is turned into badmatch:
<a name="644"/>  644:     {'EXIT',{{badmatch,&lt;&lt;17:32&gt;&gt;},_}} =
<a name="645"/>  645:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;A/apa&gt;&gt; = &lt;&lt;17:32&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="646"/>  646:     {'EXIT',_} =
<a name="647"/>  647:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;17/binary-unit:8-unit:16&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="648"/>  648:     {'EXIT',_} =
<a name="649"/>  649:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;17:32/unsigned-signed&gt;&gt; = &lt;&lt;17:32&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="650"/>  650:     {'EXIT',_} =
<a name="651"/>  651:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;17:32/unsigned-signed&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="652"/>  652:     &lt;&lt;17:32&gt;&gt; = evaluate(&lt;&lt;&quot;&lt;&lt;17:32/signed-signed&gt;&gt;.&quot;&gt;&gt;, []),
<a name="653"/>  653:     {'EXIT',_} =
<a name="654"/>  654:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;32/unit:8&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="otp_5327-last_expr"/><a name="655"/>  655:     ok.
<a name="656"/>  656: 
<a name="657"/>  657: <i>%% OTP-5435. compiler application not in the path.</i>
<a name="otp_5435-1"/><a name="658"/>  658: <b>otp_5435</b>(Config) when is_list(Config) -&gt;
<a name="659"/>  659:     true = &lt;&lt;103133:64/float&gt;&gt; =:=
<a name="660"/>  660:         evaluate(&lt;&lt;&quot;&lt;&lt;103133:64/float&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;, []),
<a name="661"/>  661:     true = &lt;&lt;103133.0:64/float&gt;&gt; =:=
<a name="662"/>  662:         evaluate(&lt;&lt;&quot;&lt;&lt;103133.0:64/float&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;, []),
<a name="663"/>  663:     true = is_alive(),
<a name="664"/>  664:     {ok, Peer, Node} = ?CT_PEER(),
<a name="665"/>  665:     ok = rpc:call(Node, ?MODULE, otp_5435_2, []),
<a name="666"/>  666:     peer:stop(Peer),
<a name="otp_5435-last_expr"/><a name="667"/>  667:     ok.
<a name="668"/>  668: 
<a name="otp_5435_2-0"/><a name="669"/>  669: <b>otp_5435_2</b>() -&gt;
<a name="670"/>  670:     true = code:del_path(compiler),
<a name="671"/>  671:     %% Make sure record evaluation is not dependent on the compiler
<a name="672"/>  672:     %% application being in the path.
<a name="673"/>  673:     %% OTP-5876.
<a name="674"/>  674:     [{attribute,_,record,{bar,_}},ok] =
<a name="675"/>  675:         scan(&lt;&lt;&quot;rd(foo,{bar}), 
<a name="676"/>  676:                 rd(bar,{foo = (#foo{})#foo.bar}),
<a name="677"/>  677: 	       rl(bar).&quot;&gt;&gt;),
<a name="otp_5435_2-last_expr"/><a name="678"/>  678:     ok.
<a name="679"/>  679: 
<a name="680"/>  680: <i>%% OTP-5195. QLC, mostly.</i>
<a name="otp_5195-1"/><a name="681"/>  681: <b>otp_5195</b>(Config) when is_list(Config) -&gt;
<a name="682"/>  682:     %% QLC. It was easier to put these cases here than in qlc_SUITE.
<a name="683"/>  683:     &quot;[#a{b = undefined}].\n&quot; =
<a name="684"/>  684:         t(&lt;&lt;&quot;rd(a,{b}), qlc:e(qlc:q([X || X &lt;- [#a{}],is_record(X, a)])).&quot;&gt;&gt;),
<a name="685"/>  685: 
<a name="686"/>  686:     %% An experimental shell used to translate error tuples:
<a name="687"/>  687:     %% &quot;(qlc) \&quot;1: generated variable 'X' must not be used in &quot;
<a name="688"/>  688:     %% &quot;list expression\&quot;.\n&quot; = 
<a name="689"/>  689:     %%    t(&lt;&lt;&quot;qlc:q([X || X &lt;- [{a}], Y &lt;- [X]]).&quot;&gt;&gt;),
<a name="690"/>  690:     %% Same as last one (if the shell does not translate error tuples):
<a name="691"/>  691:     [{error,qlc,{{1,31},qlc,{used_generator_variable,'X'}}}] =
<a name="692"/>  692:         scan(&lt;&lt;&quot;qlc:q([X || X &lt;- [{a}], Y &lt;- [X]]).&quot;&gt;&gt;),
<a name="693"/>  693:     {error,qlc,{1,qlc,{used_generator_variable,'X'}}} =
<a name="694"/>  694:         evaluate(&lt;&lt;&quot;qlc:q([X || X &lt;- [{a}], Y &lt;- [X]]).&quot;&gt;&gt;, []),
<a name="695"/>  695:     Ugly = &lt;&lt;&quot;qlc:e(qlc:q([X || X &lt;- qlc:append([[1,2,3],ugly()])])).&quot;&gt;&gt;,
<a name="696"/>  696:     &quot;undefined shell command ugly/0&quot; = error_string(Ugly),
<a name="697"/>  697:     {'EXIT',{undef,_}} = (catch evaluate(Ugly, [])),
<a name="698"/>  698: 
<a name="699"/>  699:     V_1 = &lt;&lt;&quot;qlc:e(qlc:q([X || X &lt;- qlc:append([[1,2,3],v(-1)])])).&quot;&gt;&gt;,
<a name="700"/>  700:     &quot;-1: command not found&quot; = comm_err(V_1),
<a name="701"/>  701:     {'EXIT', {undef,_}} = (catch evaluate(V_1, [])),
<a name="702"/>  702: 
<a name="703"/>  703:     &quot;1\n2\n3\n3.\n&quot; =
<a name="704"/>  704:         t(&lt;&lt;&quot;1. 2. 3. 3 = fun(A) when A =:= 2 -&gt; v(3) end(v(2)).&quot;&gt;&gt;),
<a name="705"/>  705: 
<a name="706"/>  706:     List4 = t(&lt;&lt;&quot;[a,list]. A = [1,2]. &quot;
<a name="707"/>  707: 		&quot;qlc:q([X || X &lt;- qlc:append(A, v(1))]). &quot;
<a name="708"/>  708: 		&quot;[1,2,a,list] = qlc:e(v(-1)).&quot;&gt;&gt;),
<a name="709"/>  709:     &quot;[1,2,a,list].\n&quot; = string:substr(List4, string:len(List4)-13),
<a name="710"/>  710: 
<a name="otp_5195-last_expr"/><a name="711"/>  711:     ok.
<a name="712"/>  712: 
<a name="713"/>  713: <i>%% OTP-5915. Strict record tests in guards.</i>
<a name="otp_5915-1"/><a name="714"/>  714: <b>otp_5915</b>(Config) when is_list(Config) -&gt;
<a name="715"/>  715:     C = &lt;&lt;&quot;
<a name="716"/>  716:         rd(r, {a = 4,b}),
<a name="717"/>  717: 	  rd(r1, {a,b}),
<a name="718"/>  718: 	  rd(r2, {a = #r1{},b,c=length([1,2,3])}),
<a name="719"/>  719: 	  rd(r3, {a = fun(_) -&gt; #r1{} end(1), b}),
<a name="720"/>  720: 
<a name="721"/>  721: 	  foo = fun(A) when A#r1.a &gt; A#r1.b -&gt; foo end(#r1{b = 2}),
<a name="722"/>  722: 	  0 = fun(A) when A#r2.a -&gt; 0 end(#r2{a = true}),
<a name="723"/>  723: 	  1 = fun(A) when (#r1{a = A})#r1.a &gt; 2 -&gt; 1 end(3),
<a name="724"/>  724: 	  2 = fun(N) when ((#r2{a = #r{a = 4}, b = length([a,b,c])})#r2.a)#r.a &gt; N -&gt;
<a name="725"/>  725: 		      2 end(2),
<a name="726"/>  726: 	  3 = fun(A) when (A#r2.a)#r1.a =:= 3 -&gt; 3 end(#r2{a = #r1{a = 3}}),
<a name="727"/>  727: 	  ok = fun() -&gt;
<a name="728"/>  728: 		       F = fun(A) when record(A#r.a, r1) -&gt; 4;
<a name="729"/>  729: 			      (A) when record(A#r1.a, r1) -&gt; 5
<a name="730"/>  730: 			   end,
<a name="731"/>  731: 		       5 = F(#r1{a = #r1{}}),
<a name="732"/>  732: 		       4 = F(#r{a = #r1{}}),
<a name="733"/>  733: 		       ok
<a name="734"/>  734: 	       end(),
<a name="735"/>  735: 	  3 = fun(A) when record(A#r1.a, r),
<a name="736"/>  736: 			  (A#r1.a)#r.a &gt; 3 -&gt; 3
<a name="737"/>  737: 	      end(#r1{a = #r{a = 4}}),
<a name="738"/>  738: 	  7 = fun(A) when record(A#r3.a, r1) -&gt; 7 end(#r3{}),
<a name="739"/>  739: 	  [#r1{a = 2,b = 1}] =
<a name="740"/>  740: 	  fun() -&gt;
<a name="741"/>  741: 		  [A || A &lt;- [#r1{a = 1, b = 3},
<a name="742"/>  742: 			      #r2{a = 2,b = 1},
<a name="743"/>  743: 			      #r1{a = 2, b = 1}],
<a name="744"/>  744: 			A#r1.a &gt;
<a name="745"/>  745: 			    A#r1.b]
<a name="746"/>  746: 	  end(),
<a name="747"/>  747: 	  {[_],b} =
<a name="748"/>  748: 	  fun(L) -&gt;
<a name="749"/>  749:                     %% A is checked only once:
<a name="750"/>  750: 		  R1 = [{A,B} || A &lt;- L, A#r1.a, B &lt;- L, A#r1.b],
<a name="751"/>  751: 		  A = #r2{a = true},
<a name="752"/>  752:                     %% A is checked again:
<a name="753"/>  753: 		  B = if A#r1.a -&gt; a; true -&gt; b end,
<a name="754"/>  754: 		  {R1,B}
<a name="755"/>  755: 	  end([#r1{a = true, b = true}]),
<a name="756"/>  756: 
<a name="757"/>  757: 	  p = fun(A) when (A#r1.a =:= 2) or (A#r2.a =:= 1) -&gt; o;
<a name="758"/>  758: 		 (_) -&gt; p
<a name="759"/>  759: 	      end(#r1{a = 2}),
<a name="760"/>  760: 
<a name="761"/>  761: 	  o = fun(A) when (A#r1.a =:= 2) orelse (A#r2.a =:= 1) -&gt; o;
<a name="762"/>  762: 		 (_) -&gt; p
<a name="763"/>  763: 	      end(#r1{a = 2}),
<a name="764"/>  764: 
<a name="765"/>  765: 	  3 = fun(A) when A#r1.a &gt; 3,
<a name="766"/>  766: 			  record(A, r1) -&gt; 3
<a name="767"/>  767: 	      end(#r1{a = 5}),
<a name="768"/>  768: 
<a name="769"/>  769: 	  ok = fun() -&gt;
<a name="770"/>  770: 		       F = fun(A) when (A#r2.a =:= 1) orelse (A#r2.a) -&gt; 2;
<a name="771"/>  771: 			      (A) when (A#r1.a =:= 1) orelse (A#r1.a) -&gt; 1;
<a name="772"/>  772: 			      (A) when (A#r2.a =:= 2) andalso (A#r2.b) -&gt; 3
<a name="773"/>  773: 			   end,
<a name="774"/>  774: 		       1 = F(#r1{a = 1}),
<a name="775"/>  775: 		       2 = F(#r2{a = true}),
<a name="776"/>  776: 		       3 = F(#r2{a = 2, b = true}),
<a name="777"/>  777: 		       ok
<a name="778"/>  778: 	       end(),
<a name="779"/>  779: 
<a name="780"/>  780: 	  b = fun(A) when false or not (A#r.a =:= 1) -&gt; a;
<a name="781"/>  781: 		 (_) -&gt; b
<a name="782"/>  782: 	      end(#r1{a = 1}),
<a name="783"/>  783: 	  b = fun(A) when not (A#r.a =:= 1) or false -&gt; a;
<a name="784"/>  784: 		 (_) -&gt; b
<a name="785"/>  785: 	      end(#r1{a = 1}),
<a name="786"/>  786: 
<a name="787"/>  787: 	  ok = fun() -&gt;
<a name="788"/>  788: 		       F = fun(A) when not (A#r.a =:= 1) -&gt; yes;
<a name="789"/>  789: 			      (_) -&gt; no
<a name="790"/>  790: 			   end,
<a name="791"/>  791: 		       no = F(#r1{a = 2}),
<a name="792"/>  792: 		       yes = F(#r{a = 2}),
<a name="793"/>  793: 		       no = F(#r{a = 1}),
<a name="794"/>  794: 		       ok
<a name="795"/>  795: 	       end(),
<a name="796"/>  796: 
<a name="797"/>  797: 	  a = fun(A) when record(A, r),
<a name="798"/>  798: 			  A#r.a =:= 1,
<a name="799"/>  799: 			  A#r.b =:= 2 -&gt;a
<a name="800"/>  800: 	      end(#r{a = 1, b = 2}),
<a name="801"/>  801: 	  a = fun(A) when erlang:is_record(A, r),
<a name="802"/>  802: 			  A#r.a =:= 1,
<a name="803"/>  803: 			  A#r.b =:= 2 -&gt; a
<a name="804"/>  804: 	      end(#r{a = 1, b = 2}),
<a name="805"/>  805: 	  a = fun(A) when is_record(A, r),
<a name="806"/>  806: 			  A#r.a =:= 1,
<a name="807"/>  807: 			  A#r.b =:= 2 -&gt; a
<a name="808"/>  808: 	      end(#r{a = 1, b = 2}),
<a name="809"/>  809: 
<a name="810"/>  810: 	  nop = fun(A) when (is_record(A, r1) and (A#r1.a &gt; 3)) or (A#r2.a &lt; 1) -&gt;
<a name="811"/>  811: 			japp;
<a name="812"/>  812: 		   (_) -&gt;
<a name="813"/>  813: 			nop
<a name="814"/>  814: 		end(#r2{a = 0}),
<a name="815"/>  815: 	  nop = fun(A) when (A#r1.a &gt; 3) or (A#r2.a &lt; 1) -&gt; japp;
<a name="816"/>  816: 		   (_) -&gt;
<a name="817"/>  817: 			nop
<a name="818"/>  818: 		end(#r2{a = 0}),
<a name="819"/>  819: 
<a name="820"/>  820: 	  ok = fun() -&gt;
<a name="821"/>  821: 		       F = fun(A) when (A#r1.a =:= 2) or (A#r2.a =:= 1) -&gt; o;
<a name="822"/>  822: 			      (_) -&gt; p
<a name="823"/>  823: 			   end,
<a name="824"/>  824: 		       p = F(#r2{a = 1}),
<a name="825"/>  825: 		       p = F(#r1{a = 2}),
<a name="826"/>  826: 		       ok
<a name="827"/>  827: 	       end(),
<a name="828"/>  828: 
<a name="829"/>  829: 	  ok = fun() -&gt;
<a name="830"/>  830: 		       F = fun(A) when fail, A#r1.a; A#r1.a -&gt; ab;
<a name="831"/>  831: 			      (_) -&gt; bu
<a name="832"/>  832: 			   end,
<a name="833"/>  833: 		       ab = F(#r1{a = true}),
<a name="834"/>  834: 		       bu = F(#r2{a = true}),
<a name="835"/>  835: 		       ok
<a name="836"/>  836: 	       end(),
<a name="837"/>  837: 
<a name="838"/>  838: 	  both = fun(A) when A#r.a, A#r.b -&gt; both
<a name="839"/>  839: 		 end(#r{a = true, b = true}),
<a name="840"/>  840: 
<a name="841"/>  841: 	  ok = fun() -&gt;
<a name="842"/>  842: 		       F = fun(A, B) when ((A#r1.a) orelse (B#r2.a))
<a name="843"/>  843: 					  or (B#r2.b) or (A#r1.b) -&gt; true;
<a name="844"/>  844: 			      (_, _) -&gt; false
<a name="845"/>  845: 			   end,
<a name="846"/>  846: 		       true = F(#r1{a = false, b = false}, #r2{a = false, b = true}),
<a name="847"/>  847: 		       false = F(#r1{a = true, b = true}, #r1{a = false, b = true}),
<a name="848"/>  848: 		       ok
<a name="849"/>  849: 	       end(),
<a name="850"/>  850: 
<a name="851"/>  851: 	  ok.&quot;&gt;&gt;,
<a name="852"/>  852:     [ok] = scan(C),
<a name="otp_5915-last_expr"/><a name="853"/>  853: 	  ok.
<a name="854"/>  854: 
<a name="855"/>  855: <i>%% OTP-5916. erlang:is_record/3 allowed in guards.</i>
<a name="otp_5916-1"/><a name="856"/>  856: <b>otp_5916</b>(Config) when is_list(Config) -&gt;
<a name="857"/>  857:     C = &lt;&lt;&quot;
<a name="858"/>  858:         rd(r1, {a,b}),
<a name="859"/>  859: 	  rd(r2, {a,b}),
<a name="860"/>  860: 
<a name="861"/>  861: 	  true = if erlang:is_record(#r1{},r1,3) -&gt; true; true -&gt;  false end,
<a name="862"/>  862: 	  false = if erlang:is_record(#r2{},r1,3) -&gt; true; true -&gt;  false end,
<a name="863"/>  863: 
<a name="864"/>  864: 	  true = if is_record(#r1{},r1,3) -&gt; true; true -&gt;  false end,
<a name="865"/>  865: 	  false = if is_record(#r2{},r1,3) -&gt; true; true -&gt;  false end,
<a name="866"/>  866: 
<a name="867"/>  867: 	  ok.&quot;&gt;&gt;,
<a name="868"/>  868:     [ok] = scan(C),
<a name="otp_5916-last_expr"/><a name="869"/>  869: 	  ok.
<a name="870"/>  870: 
<a name="871"/>  871: 
<a name="872"/>  872: <i>%% OTP-5327. Adopted from parts of emulator/test/bs_match_misc_SUITE.erl.</i>
<a name="bs_match_misc_SUITE-1"/><a name="873"/>  873: <b>bs_match_misc_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="874"/>  874:     C = &lt;&lt;&quot;
<a name="875"/>  875:       F1 = fun() -&gt; 3.1415 end,
<a name="876"/>  876: 
<a name="877"/>  877: 	  FOne = fun() -&gt; 1.0 end,
<a name="878"/>  878: 
<a name="879"/>  879: 	  Fcmp = fun(F1, F2) when (F1 - F2) / F2 &lt; 0.0000001 -&gt; ok end,
<a name="880"/>  880: 
<a name="881"/>  881: 	  MakeSubBin = fun(Bin0) -&gt;
<a name="882"/>  882: 			       Sz = size(Bin0),
<a name="883"/>  883: 			       Bin1 = &lt;&lt;37,Bin0/binary,38,39&gt;&gt;,
<a name="884"/>  884: 			       &lt;&lt;_:8,Bin:Sz/binary,_:8,_:8&gt;&gt; = Bin1,
<a name="885"/>  885: 			       Bin
<a name="886"/>  886: 		       end,
<a name="887"/>  887: 
<a name="888"/>  888: 	  MatchFloat =
<a name="889"/>  889: 	  fun(Bin0, Fsz, I) -&gt;
<a name="890"/>  890: 		  Bin = MakeSubBin(Bin0),
<a name="891"/>  891: 		  Bsz = size(Bin) * 8,
<a name="892"/>  892: 		  Tsz = Bsz - Fsz - I,
<a name="893"/>  893: 		  &lt;&lt;_:I,F:Fsz/float,_:Tsz&gt;&gt; = Bin,
<a name="894"/>  894: 		  F
<a name="895"/>  895: 	  end,
<a name="896"/>  896: 
<a name="897"/>  897: 	  TFloat = fun() -&gt;
<a name="898"/>  898: 			   F = F1(),
<a name="899"/>  899: 			   G = FOne(),
<a name="900"/>  900: 
<a name="901"/>  901: 			   G = MatchFloat(&lt;&lt;63,128,0,0&gt;&gt;, 32, 0),
<a name="902"/>  902: 			   G = MatchFloat(&lt;&lt;63,240,0,0,0,0,0,0&gt;&gt;, 64, 0),
<a name="903"/>  903: 
<a name="904"/>  904: 			   Fcmp(F, MatchFloat(&lt;&lt;F:32/float&gt;&gt;, 32, 0)),
<a name="905"/>  905: 			   Fcmp(F, MatchFloat(&lt;&lt;F:64/float&gt;&gt;, 64, 0)),
<a name="906"/>  906: 			   Fcmp(F, MatchFloat(&lt;&lt;1:1,F:32/float,127:7&gt;&gt;, 32, 1)),
<a name="907"/>  907: 			   Fcmp(F, MatchFloat(&lt;&lt;1:1,F:64/float,127:7&gt;&gt;, 64, 1)),
<a name="908"/>  908: 			   Fcmp(F, MatchFloat(&lt;&lt;1:13,F:32/float,127:3&gt;&gt;, 32, 13)),
<a name="909"/>  909: 			   Fcmp(F, MatchFloat(&lt;&lt;1:13,F:64/float,127:3&gt;&gt;, 64, 13))
<a name="910"/>  910: 		   end,
<a name="911"/>  911: 	  TFloat(),
<a name="912"/>  912: 
<a name="913"/>  913: 	  F2 = fun() -&gt; 2.7133 end,
<a name="914"/>  914: 
<a name="915"/>  915: 	  MatchFloatLittle = fun(Bin0, Fsz, I) -&gt;
<a name="916"/>  916: 				     Bin = MakeSubBin(Bin0),
<a name="917"/>  917: 				     Bsz = size(Bin) * 8,
<a name="918"/>  918: 				     Tsz = Bsz - Fsz - I,
<a name="919"/>  919: 				     &lt;&lt;_:I,F:Fsz/float-little,_:Tsz&gt;&gt; = Bin,
<a name="920"/>  920: 				     F
<a name="921"/>  921: 			     end,
<a name="922"/>  922: 
<a name="923"/>  923: 	  LittleFloat = fun() -&gt;
<a name="924"/>  924: 				F = F2(),
<a name="925"/>  925: 				G = FOne(),
<a name="926"/>  926: 
<a name="927"/>  927: 				G = MatchFloatLittle(&lt;&lt;0,0,0,0,0,0,240,63&gt;&gt;, 64, 0),
<a name="928"/>  928: 				G = MatchFloatLittle(&lt;&lt;0,0,128,63&gt;&gt;, 32, 0),
<a name="929"/>  929: 
<a name="930"/>  930: 				Fcmp(F, MatchFloatLittle(&lt;&lt;F:32/float-little&gt;&gt;, 32, 0)),
<a name="931"/>  931: 				Fcmp(F, MatchFloatLittle(&lt;&lt;F:64/float-little&gt;&gt;, 64, 0)),
<a name="932"/>  932: 				Fcmp(F, MatchFloatLittle(&lt;&lt;1:1,F:32/float-little,127:7&gt;&gt;, 32, 1)),
<a name="933"/>  933: 				Fcmp(F, MatchFloatLittle(&lt;&lt;1:1,F:64/float-little,127:7&gt;&gt;, 64, 1)),
<a name="934"/>  934: 				Fcmp(F, MatchFloatLittle(&lt;&lt;1:13,F:32/float-little,127:3&gt;&gt;, 32, 13)),
<a name="935"/>  935: 				Fcmp(F, MatchFloatLittle(&lt;&lt;1:13,F:64/float-little,127:3&gt;&gt;, 64, 13))
<a name="936"/>  936: 			end,
<a name="937"/>  937: 	  LittleFloat(),
<a name="938"/>  938: 
<a name="939"/>  939: 	  Sean1 = fun(&lt;&lt;B/binary&gt;&gt;) when size(B) &lt; 4 -&gt; small;
<a name="940"/>  940: 		     (&lt;&lt;1, _B/binary&gt;&gt;) -&gt; large
<a name="941"/>  941: 		  end,
<a name="942"/>  942: 
<a name="943"/>  943: 	  Sean = fun() -&gt;
<a name="944"/>  944: 			 small = Sean1(&lt;&lt;&gt;&gt;),
<a name="945"/>  945: 			 small = Sean1(&lt;&lt;1&gt;&gt;),
<a name="946"/>  946: 			 small = Sean1(&lt;&lt;1,2&gt;&gt;),
<a name="947"/>  947: 			 small = Sean1(&lt;&lt;1,2,3&gt;&gt;),
<a name="948"/>  948: 			 large = Sean1(&lt;&lt;1,2,3,4&gt;&gt;),
<a name="949"/>  949: 
<a name="950"/>  950: 			 small = Sean1(&lt;&lt;4&gt;&gt;),
<a name="951"/>  951: 			 small = Sean1(&lt;&lt;4,5&gt;&gt;),
<a name="952"/>  952: 			 small = Sean1(&lt;&lt;4,5,6&gt;&gt;),
<a name="953"/>  953: 			 {'EXIT',{function_clause,_}} = (catch Sean1(&lt;&lt;4,5,6,7&gt;&gt;))
<a name="954"/>  954: 		 end,
<a name="955"/>  955: 	  Sean(),
<a name="956"/>  956: 
<a name="957"/>  957: 	  NativeBig = fun() -&gt;
<a name="958"/>  958: 			      &lt;&lt;37.33:64/native-float&gt;&gt; = &lt;&lt;37.33:64/big-float&gt;&gt;,
<a name="959"/>  959: 			      &lt;&lt;3974:16/native-integer&gt;&gt; = &lt;&lt;3974:16/big-integer&gt;&gt;
<a name="960"/>  960: 		      end,
<a name="961"/>  961: 
<a name="962"/>  962: 	  NativeLittle = fun() -&gt;
<a name="963"/>  963: 				 &lt;&lt;37869.32343:64/native-float&gt;&gt; = &lt;&lt;37869.32343:64/little-float&gt;&gt;,
<a name="964"/>  964: 				 &lt;&lt;7974:16/native-integer&gt;&gt; = &lt;&lt;7974:16/little-integer&gt;&gt;
<a name="965"/>  965: 			 end,
<a name="966"/>  966: 
<a name="967"/>  967: 	  Native = fun() -&gt;
<a name="968"/>  968: 			   &lt;&lt;3.14:64/native-float&gt;&gt; = &lt;&lt;3.14:64/native-float&gt;&gt;,
<a name="969"/>  969: 			   &lt;&lt;333:16/native&gt;&gt; = &lt;&lt;333:16/native&gt;&gt;,
<a name="970"/>  970: 			   &lt;&lt;38658345:32/native&gt;&gt; = &lt;&lt;38658345:32/native&gt;&gt;,
<a name="971"/>  971: 			   case &lt;&lt;1:16/native&gt;&gt; of
<a name="972"/>  972: 			       &lt;&lt;0,1&gt;&gt; -&gt; NativeBig();
<a name="973"/>  973: 			       &lt;&lt;1,0&gt;&gt; -&gt; NativeLittle()
<a name="974"/>  974: 			   end
<a name="975"/>  975: 		   end,
<a name="976"/>  976: 	  Native(),
<a name="977"/>  977: 
<a name="978"/>  978: 	  Split = fun(&lt;&lt;N:16,B:N/binary,T/binary&gt;&gt;) -&gt; {B,T} end,
<a name="979"/>  979: 
<a name="980"/>  980: 	  Split2 = fun(N, &lt;&lt;N:16,B:N/binary,T/binary&gt;&gt;) -&gt; {B,T} end,
<a name="981"/>  981: 
<a name="982"/>  982: 	  Split_2 = fun(&lt;&lt;N0:8,N:N0,B:N/binary,T/binary&gt;&gt;) -&gt; {B,T} end,
<a name="983"/>  983: 
<a name="984"/>  984: 	  Skip = fun(&lt;&lt;N:8,_:N/binary,T/binary&gt;&gt;) -&gt; T end,
<a name="985"/>  985: 
<a name="986"/>  986: 	  SizeVar = fun() -&gt;
<a name="987"/>  987: 			    {&lt;&lt;45&gt;&gt;,&lt;&lt;&gt;&gt;} = Split(&lt;&lt;1:16,45&gt;&gt;),
<a name="988"/>  988: 			    {&lt;&lt;45&gt;&gt;,&lt;&lt;46,47&gt;&gt;} = Split(&lt;&lt;1:16,45,46,47&gt;&gt;),
<a name="989"/>  989: 			    {&lt;&lt;45,46&gt;&gt;,&lt;&lt;47&gt;&gt;} = Split(&lt;&lt;2:16,45,46,47&gt;&gt;),
<a name="990"/>  990: 
<a name="991"/>  991: 			    {&lt;&lt;45,46,47&gt;&gt;,&lt;&lt;48&gt;&gt;} = Split_2(&lt;&lt;16:8,3:16,45,46,47,48&gt;&gt;),
<a name="992"/>  992: 
<a name="993"/>  993: 			    {&lt;&lt;45,46&gt;&gt;,&lt;&lt;47&gt;&gt;} = Split2(2, &lt;&lt;2:16,45,46,47&gt;&gt;),
<a name="994"/>  994: 			    {'EXIT',{function_clause,_}} =
<a name="995"/>  995: 				(catch Split2(42, &lt;&lt;2:16,45,46,47&gt;&gt;)),
<a name="996"/>  996: 
<a name="997"/>  997: 			    &lt;&lt;\&quot;cdef\&quot;&gt;&gt; = Skip(&lt;&lt;2:8,\&quot;abcdef\&quot;&gt;&gt;)
<a name="998"/>  998:        end,
<a name="999"/>  999: 			      SizeVar(),
<a name="1000"/> 1000: 
<a name="1001"/> 1001: 			      Wcheck = fun(&lt;&lt;A&gt;&gt;) when A==3-&gt; ok1;
<a name="1002"/> 1002: 					  (&lt;&lt;_,_:2/binary&gt;&gt;) -&gt; ok2;
<a name="1003"/> 1003: 					  (&lt;&lt;_&gt;&gt;) -&gt; ok3;
<a name="1004"/> 1004: 					  (Other) -&gt; {error,Other}
<a name="1005"/> 1005: 				       end,
<a name="1006"/> 1006: 
<a name="1007"/> 1007: 			      Wiger = fun()  -&gt;
<a name="1008"/> 1008: 					      ok1 = Wcheck(&lt;&lt;3&gt;&gt;),
<a name="1009"/> 1009: 					      ok2 = Wcheck(&lt;&lt;1,2,3&gt;&gt;),
<a name="1010"/> 1010: 					      ok3 = Wcheck(&lt;&lt;4&gt;&gt;),
<a name="1011"/> 1011: 					      {error,&lt;&lt;1,2,3,4&gt;&gt;} = Wcheck(&lt;&lt;1,2,3,4&gt;&gt;),
<a name="1012"/> 1012: 					      {error,&lt;&lt;&gt;&gt;} = Wcheck(&lt;&lt;&gt;&gt;)
<a name="1013"/> 1013: 				      end,
<a name="1014"/> 1014: 			      Wiger(),
<a name="1015"/> 1015: 
<a name="1016"/> 1016: 			      ok.
<a name="1017"/> 1017: &quot;&gt;&gt;,
<a name="1018"/> 1018:     [ok] = scan(C),
<a name="bs_match_misc_SUITE-last_expr"/><a name="1019"/> 1019: <b>ok = evaluate</b>(C, []).
<a name="1020"/> 1020: 
<a name="1021"/> 1021: <i>%% This one is not run during night builds since it takes several minutes.</i>
<a name="1022"/> 1022: 
<a name="1023"/> 1023: <i>%% OTP-5327. Adopted from emulator/test/bs_match_int_SUITE.erl.</i>
<a name="bs_match_int_SUITE-1"/><a name="1024"/> 1024: <b>bs_match_int_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="1025"/> 1025:     C = &lt;&lt;&quot;
<a name="1026"/> 1026:        FunClause = fun({'EXIT',{function_clause,_}}) -&gt; ok end,
<a name="1027"/> 1027: 
<a name="1028"/> 1028: 	  Mkbin = fun(L) when list(L) -&gt; list_to_binary(L) end,
<a name="1029"/> 1029: 
<a name="1030"/> 1030: 	  GetInt1 = fun(&lt;&lt;I:0&gt;&gt;) -&gt; I;
<a name="1031"/> 1031: 		       (&lt;&lt;I:8&gt;&gt;) -&gt; I;
<a name="1032"/> 1032: 		       (&lt;&lt;I:16&gt;&gt;) -&gt; I;
<a name="1033"/> 1033: 		       (&lt;&lt;I:24&gt;&gt;) -&gt; I;
<a name="1034"/> 1034: 		       (&lt;&lt;I:32&gt;&gt;) -&gt; I
<a name="1035"/> 1035: 		    end,
<a name="1036"/> 1036: 
<a name="1037"/> 1037: 	  GetInt2 = fun(Bin0, I, F) when size(Bin0) &lt; 4 -&gt;
<a name="1038"/> 1038: 			    Bin = &lt;&lt;0,Bin0/binary&gt;&gt;,
<a name="1039"/> 1039: 			    I = GetInt1(Bin),
<a name="1040"/> 1040: 			    F(Bin, I, F);
<a name="1041"/> 1041: 		       (_, I, _F) -&gt; I
<a name="1042"/> 1042: 		    end,
<a name="1043"/> 1043: 
<a name="1044"/> 1044: 	  GetInt = fun(Bin) -&gt;
<a name="1045"/> 1045: 			   I = GetInt1(Bin),
<a name="1046"/> 1046: 			   GetInt2(Bin, I, GetInt2)
<a name="1047"/> 1047: 		   end,
<a name="1048"/> 1048: 
<a name="1049"/> 1049: 
<a name="1050"/> 1050: 	  Cmp128 = fun(&lt;&lt;I:128&gt;&gt;, I) -&gt; equal;
<a name="1051"/> 1051: 		      (_, _) -&gt; not_equal
<a name="1052"/> 1052: 		   end,
<a name="1053"/> 1053: 
<a name="1054"/> 1054: 	  Uint2 = fun([H|T], Acc, F) -&gt; F(T, Acc bsl 8 bor H, F);
<a name="1055"/> 1055: 		     ([], Acc, _F) -&gt; Acc
<a name="1056"/> 1056: 		  end,
<a name="1057"/> 1057: 
<a name="1058"/> 1058: 	  Uint = fun(L) -&gt; Uint2(L, 0, Uint2) end,
<a name="1059"/> 1059: 
<a name="1060"/> 1060: 	  Integer = fun() -&gt;
<a name="1061"/> 1061: 			    0 = GetInt(Mkbin([])),
<a name="1062"/> 1062: 			    0 = GetInt(Mkbin([0])),
<a name="1063"/> 1063: 			    42 = GetInt(Mkbin([42])),
<a name="1064"/> 1064: 			    255 = GetInt(Mkbin([255])),
<a name="1065"/> 1065: 			    256 = GetInt(Mkbin([1,0])),
<a name="1066"/> 1066: 			    257 = GetInt(Mkbin([1,1])),
<a name="1067"/> 1067: 			    258 = GetInt(Mkbin([1,2])),
<a name="1068"/> 1068: 			    258 = GetInt(Mkbin([1,2])),
<a name="1069"/> 1069: 			    65534 = GetInt(Mkbin([255,254])),
<a name="1070"/> 1070: 			    16776455 = GetInt(Mkbin([255,253,7])),
<a name="1071"/> 1071: 			    4245492555 = GetInt(Mkbin([253,13,19,75])),
<a name="1072"/> 1072: 			    4294967294 = GetInt(Mkbin([255,255,255,254])),
<a name="1073"/> 1073: 			    4294967295 = GetInt(Mkbin([255,255,255,255])),
<a name="1074"/> 1074: 			    Eight = [200,1,19,128,222,42,97,111],
<a name="1075"/> 1075: 			    Cmp128(Eight, Uint(Eight)),
<a name="1076"/> 1076: 			    FunClause(catch GetInt(Mkbin(lists:seq(1,5))))
<a name="1077"/> 1077: 		    end,
<a name="1078"/> 1078: 	  Integer(),
<a name="1079"/> 1079: 
<a name="1080"/> 1080: 	  Sint = fun(Bin) -&gt;
<a name="1081"/> 1081: 			 case Bin of
<a name="1082"/> 1082: 			     &lt;&lt;I:8/signed&gt;&gt; -&gt; I;
<a name="1083"/> 1083: 			     &lt;&lt;I:8/signed,_:3,_:5&gt;&gt; -&gt; I;
<a name="1084"/> 1084: 			     Other -&gt; {no_match,Other}
<a name="1085"/> 1085: 			 end
<a name="1086"/> 1086: 		 end,
<a name="1087"/> 1087: 
<a name="1088"/> 1088: 	  SignedInteger = fun() -&gt;
<a name="1089"/> 1089: 				  {no_match,_} = Sint(Mkbin([])),
<a name="1090"/> 1090: 				  {no_match,_} = Sint(Mkbin([1,2,3])),
<a name="1091"/> 1091: 				  127 = Sint(Mkbin([127])),
<a name="1092"/> 1092: 				  -1 = Sint(Mkbin([255])),
<a name="1093"/> 1093: 				  -128 = Sint(Mkbin([128])),
<a name="1094"/> 1094: 				  42 = Sint(Mkbin([42,255])),
<a name="1095"/> 1095: 				  127 = Sint(Mkbin([127,255]))
<a name="1096"/> 1096: 			  end,
<a name="1097"/> 1097: 	  SignedInteger(),
<a name="1098"/> 1098: 
<a name="1099"/> 1099: 	  Dynamic5 = fun(Bin, S1, S2, A, B) -&gt;
<a name="1100"/> 1100: 			     case Bin of
<a name="1101"/> 1101: 				 &lt;&lt;A:S1,B:S2&gt;&gt; -&gt;
<a name="1102"/> 1102:                               %% io:format(\&quot;~p ~p ~p ~p~n\&quot;, [S1,S2,A,B]),
<a name="1103"/> 1103: 				     ok;
<a name="1104"/> 1104: 				 _Other -&gt; erlang:error(badmatch, [Bin,S1,S2,A,B])
<a name="1105"/> 1105: 			     end
<a name="1106"/> 1106: 		     end,
<a name="1107"/> 1107: 
<a name="1108"/> 1108: 	  Dynamic2 = fun(Bin, S1, F) when S1 &gt;= 0 -&gt;
<a name="1109"/> 1109: 			     S2 = size(Bin) * 8 - S1,
<a name="1110"/> 1110: 			     Dynamic5(Bin, S1, S2, (1 bsl S1) - 1, (1 bsl S2) - 1),
<a name="1111"/> 1111: 			     F(Bin, S1-1, F);
<a name="1112"/> 1112: 			(_, _, _) -&gt; ok
<a name="1113"/> 1113: 		     end,
<a name="1114"/> 1114: 
<a name="1115"/> 1115: 	  Dynamic = fun(Bin, S1) -&gt;
<a name="1116"/> 1116: 			    Dynamic2(Bin, S1, Dynamic2)
<a name="1117"/> 1117: 		    end,
<a name="1118"/> 1118: 
<a name="1119"/> 1119: 	  Dynamic(Mkbin([255]), 8),
<a name="1120"/> 1120: 	  Dynamic(Mkbin([255,255]), 16),
<a name="1121"/> 1121: 	  Dynamic(Mkbin([255,255,255]), 24),
<a name="1122"/> 1122: 	  Dynamic(Mkbin([255,255,255,255]), 32),
<a name="1123"/> 1123: 
<a name="1124"/> 1124: 	  BigToLittle4 =
<a name="1125"/> 1125: 	  fun([B0,B1,B2,B3,B4,B5,B6,B7|T], N, Acc, F) when N &gt;= 8 -&gt;
<a name="1126"/> 1126: 		  F(T, N-8, [B0,B1,B2,B3,B4,B5,B6,B7|Acc], F);
<a name="1127"/> 1127: 	     (List, N, Acc, _F) -&gt; lists:sublist(List, 1, N) ++ Acc
<a name="1128"/> 1128: 	  end,
<a name="1129"/> 1129: 
<a name="1130"/> 1130: 	  BigToLittle =
<a name="1131"/> 1131: 	  fun(List, N) -&gt; BigToLittle4(List, N, [], BigToLittle4) end,
<a name="1132"/> 1132: 
<a name="1133"/> 1133: 	  ReversedSublist =
<a name="1134"/> 1134: 	  fun(_List, 0, Acc, _F) -&gt; Acc;
<a name="1135"/> 1135: 	     ([H|T], N, Acc, F) -&gt; F(T, N-1, [H|Acc], F)
<a name="1136"/> 1136: 	  end,
<a name="1137"/> 1137: 
<a name="1138"/> 1138: 	  TwoComplementAndReverse =
<a name="1139"/> 1139: 	  fun([H|T], Carry, Acc, F) -&gt;
<a name="1140"/> 1140: 		  Sum = 1-H+Carry,
<a name="1141"/> 1141: 		  F(T, Sum div 2, [Sum rem 2|Acc], F);
<a name="1142"/> 1142: 	     ([], Carry, Acc, _F) -&gt; [Carry|Acc]
<a name="1143"/> 1143: 	  end,
<a name="1144"/> 1144: 
<a name="1145"/> 1145: 	  MakeInt = fun(_List, 0, Acc, _F) -&gt; Acc;
<a name="1146"/> 1146: 		       ([H|T], N, Acc, F) -&gt; F(T, N-1, Acc bsl 1 bor H, F)
<a name="1147"/> 1147: 		    end,
<a name="1148"/> 1148: 
<a name="1149"/> 1149: 	  MakeSignedInt =
<a name="1150"/> 1150: 	  fun(_List, 0) -&gt; 0;
<a name="1151"/> 1151: 	     ([0|_]=List, N) -&gt; MakeInt(List, N, 0, MakeInt);
<a name="1152"/> 1152: 	     ([1|_]=List0, N) -&gt;
<a name="1153"/> 1153: 		  List1 = ReversedSublist(List0, N, [], ReversedSublist),
<a name="1154"/> 1154: 		  List2 = TwoComplementAndReverse(List1, 1, [],
<a name="1155"/> 1155: 						  TwoComplementAndReverse),
<a name="1156"/> 1156: 		  -MakeInt(List2, length(List2), 0, MakeInt)
<a name="1157"/> 1157: 	  end,
<a name="1158"/> 1158: 
<a name="1159"/> 1159: 	  BitsToList =
<a name="1160"/> 1160: 	  fun([H|T], 0, F) -&gt; F(T, 16#80, F);
<a name="1161"/> 1161: 	     ([H|_]=List, Mask, F) -&gt;
<a name="1162"/> 1162: 		  [case H band Mask of
<a name="1163"/> 1163:                        0 -&gt; 0;
<a name="1164"/> 1164:                        _ -&gt; 1
<a name="1165"/> 1165: 		   end | F(List, Mask bsr 1, F)];
<a name="1166"/> 1166: 	     ([], _, _F) -&gt; []
<a name="1167"/> 1167: 	  end,
<a name="1168"/> 1168: 
<a name="1169"/> 1169: 	  MoreDynamic3 =
<a name="1170"/> 1170: 	  fun(Action, Bin, List, Bef, Aft, F) when Bef =&lt; Aft -&gt;
<a name="1171"/> 1171: 		  Action(Bin, List, Bef, Aft-Bef),
<a name="1172"/> 1172: 		  F(Action, Bin, List, Bef, Aft-1, F);
<a name="1173"/> 1173: 	     (_, _, _, _, _, _) -&gt; ok
<a name="1174"/> 1174: 	  end,
<a name="1175"/> 1175: 
<a name="1176"/> 1176: 	  MoreDynamic2 =
<a name="1177"/> 1177: 	  fun(Action, Bin, [_|T]=List, Bef, F) -&gt;
<a name="1178"/> 1178: 		  MoreDynamic3(Action, Bin, List, Bef, size(Bin)*8,
<a name="1179"/> 1179: 			       MoreDynamic3),
<a name="1180"/> 1180: 		  F(Action, Bin, T, Bef+1, F);
<a name="1181"/> 1181: 	     (_, _, [], _, _F) -&gt; ok
<a name="1182"/> 1182: 	  end,
<a name="1183"/> 1183: 
<a name="1184"/> 1184: 	  MoreDynamic1 =
<a name="1185"/> 1185: 	  fun(Action, Bin) -&gt;
<a name="1186"/> 1186: 		  BitList = BitsToList(binary_to_list(Bin),16#80,BitsToList),
<a name="1187"/> 1187: 		  MoreDynamic2(Action, Bin, BitList, 0, MoreDynamic2)
<a name="1188"/> 1188: 	  end,
<a name="1189"/> 1189: 
<a name="1190"/> 1190: 	  MoreDynamic = fun() -&gt;
<a name="1191"/> 1191:            %% Unsigned big-endian numbers.
<a name="1192"/> 1192: 				Unsigned  = fun(Bin, List, SkipBef, N) -&gt;
<a name="1193"/> 1193: 						    SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1194"/> 1194: 						    &lt;&lt;_:SkipBef,Int:N,_:SkipAft&gt;&gt; = Bin,
<a name="1195"/> 1195: 						    Int = MakeInt(List, N, 0, MakeInt)
<a name="1196"/> 1196: 					    end,
<a name="1197"/> 1197: 				MoreDynamic1(Unsigned, erlang:md5(Mkbin([42]))),
<a name="1198"/> 1198: 
<a name="1199"/> 1199:            %% Signed big-endian numbers.
<a name="1200"/> 1200: 				Signed  = fun(Bin, List, SkipBef, N) -&gt;
<a name="1201"/> 1201: 						  SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1202"/> 1202: 						  &lt;&lt;_:SkipBef,Int:N/signed,_:SkipAft&gt;&gt; = Bin,
<a name="1203"/> 1203: 						  case MakeSignedInt(List, N) of
<a name="1204"/> 1204: 						      Int -&gt; ok;
<a name="1205"/> 1205: 						      Other -&gt;
<a name="1206"/> 1206: 							  io:format(\&quot;Bin = ~p,\&quot;, [Bin]),
<a name="1207"/> 1207:                                      io:format(\&quot;SkipBef = ~p, N = ~p\&quot;, 
<a name="1208"/> 1208:                                                [SkipBef,N]),
<a name="1209"/> 1209: 								    io:format(\&quot;Expected ~p, got ~p\&quot;,
<a name="1210"/> 1210:                                                [Int,Other])
<a name="1211"/> 1211: 								    end
<a name="1212"/> 1212: 								    end,
<a name="1213"/> 1213: 								    MoreDynamic1(Signed, erlang:md5(Mkbin([43]))),
<a name="1214"/> 1214: 
<a name="1215"/> 1215:            %% Unsigned little-endian numbers.
<a name="1216"/> 1216: 								    UnsLittle  = fun(Bin, List, SkipBef, N) -&gt;
<a name="1217"/> 1217: 											 SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1218"/> 1218: 											 &lt;&lt;_:SkipBef,Int:N/little,_:SkipAft&gt;&gt; = Bin,
<a name="1219"/> 1219: 											 Int = MakeInt(BigToLittle(List, N), N, 0,
<a name="1220"/> 1220: 												       MakeInt)
<a name="1221"/> 1221: 										 end,
<a name="1222"/> 1222: 								    MoreDynamic1(UnsLittle, erlang:md5(Mkbin([44]))),
<a name="1223"/> 1223: 
<a name="1224"/> 1224:            %% Signed little-endian numbers.
<a name="1225"/> 1225: 								    SignLittle  = fun(Bin, List, SkipBef, N) -&gt;
<a name="1226"/> 1226: 											  SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1227"/> 1227: 											  &lt;&lt;_:SkipBef,Int:N/signed-little,_:SkipAft&gt;&gt; = Bin,
<a name="1228"/> 1228: 											  Little = BigToLittle(List, N),
<a name="1229"/> 1229: 											  Int = MakeSignedInt(Little, N)
<a name="1230"/> 1230: 										  end,
<a name="1231"/> 1231: 								    MoreDynamic1(SignLittle, erlang:md5(Mkbin([45])))
<a name="1232"/> 1232: 								    end,
<a name="1233"/> 1233: 								    MoreDynamic(),
<a name="1234"/> 1234: 
<a name="1235"/> 1235: 								    ok.
<a name="1236"/> 1236: &quot;&gt;&gt;,
<a name="1237"/> 1237:     [ok] = scan(C),
<a name="bs_match_int_SUITE-last_expr"/><a name="1238"/> 1238: <b>ok = evaluate</b>(C, []).
<a name="1239"/> 1239: 
<a name="1240"/> 1240: <i>%% OTP-5327. Adopted from emulator/test/bs_match_tail_SUITE.erl.</i>
<a name="bs_match_tail_SUITE-1"/><a name="1241"/> 1241: <b>bs_match_tail_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="1242"/> 1242:     C = &lt;&lt;&quot;
<a name="1243"/> 1243:           GetTailUsed = fun(&lt;&lt;A:1,T/binary&gt;&gt;) -&gt; {A,T} end,
<a name="1244"/> 1244: 
<a name="1245"/> 1245:           GetTailUnused = fun(&lt;&lt;A:15,_/binary&gt;&gt;) -&gt; A end,
<a name="1246"/> 1246: 
<a name="1247"/> 1247:           GetDynTailUsed = fun(Bin, Sz) -&gt;
<a name="1248"/> 1248: 				   &lt;&lt;A:Sz,T/binary&gt;&gt; = Bin,
<a name="1249"/> 1249: 				   {A,T}
<a name="1250"/> 1250:                            end,
<a name="1251"/> 1251: 
<a name="1252"/> 1252:           GetDynTailUnused = fun(Bin, Sz) -&gt;
<a name="1253"/> 1253: 				     &lt;&lt;A:Sz,_/binary&gt;&gt; = Bin,
<a name="1254"/> 1254: 				     A
<a name="1255"/> 1255:                              end,
<a name="1256"/> 1256: 
<a name="1257"/> 1257:           Mkbin = fun(L) when list(L) -&gt; list_to_binary(L) end,
<a name="1258"/> 1258: 
<a name="1259"/> 1259:           TestZeroTail = fun(&lt;&lt;A:8&gt;&gt;) -&gt; A end,
<a name="1260"/> 1260: 
<a name="1261"/> 1261:           TestZeroTail2 = fun(&lt;&lt;_A:4,_B:4&gt;&gt;) -&gt; ok end,
<a name="1262"/> 1262: 
<a name="1263"/> 1263:           ZeroTail = fun() -&gt;
<a name="1264"/> 1264: 			     7 = (catch TestZeroTail(Mkbin([7]))),
<a name="1265"/> 1265: 			     {'EXIT',{function_clause,_}} =
<a name="1266"/> 1266: 				 (catch TestZeroTail(Mkbin([1,2]))),
<a name="1267"/> 1267: 			     {'EXIT',{function_clause,_}} =
<a name="1268"/> 1268: 				 (catch TestZeroTail2(Mkbin([1,2,3])))
<a name="1269"/> 1269: 		     end,
<a name="1270"/> 1270:           ZeroTail(),
<a name="1271"/> 1271: 
<a name="1272"/> 1272:           AlGetTailUsed = fun(&lt;&lt;A:16,T/binary&gt;&gt;) -&gt; {A,T} end,
<a name="1273"/> 1273: 
<a name="1274"/> 1274:           AlGetTailUnused = fun(&lt;&lt;A:16,_/binary&gt;&gt;) -&gt; A end,
<a name="1275"/> 1275: 
<a name="1276"/> 1276:           Aligned = fun() -&gt;
<a name="1277"/> 1277: 			    Tail1 = Mkbin([]),
<a name="1278"/> 1278: 			    {258,Tail1} = AlGetTailUsed(Mkbin([1,2])),
<a name="1279"/> 1279: 			    Tail2 = Mkbin(lists:seq(1, 127)),
<a name="1280"/> 1280: 			    {35091,Tail2} = AlGetTailUsed(Mkbin([137,19|Tail2])),
<a name="1281"/> 1281: 
<a name="1282"/> 1282: 			    64896 = AlGetTailUnused(Mkbin([253,128])),
<a name="1283"/> 1283: 			    64895 = AlGetTailUnused(Mkbin([253,127|lists:seq(42, 255)])),
<a name="1284"/> 1284: 
<a name="1285"/> 1285: 			    Tail3 = Mkbin(lists:seq(0, 19)),
<a name="1286"/> 1286: 			    {0,Tail1} = GetDynTailUsed(Tail1, 0),
<a name="1287"/> 1287: 			    {0,Tail3} = GetDynTailUsed(Mkbin([Tail3]), 0),
<a name="1288"/> 1288: 			    {73,Tail3} = GetDynTailUsed(Mkbin([73|Tail3]), 8),
<a name="1289"/> 1289: 
<a name="1290"/> 1290: 			    0 = GetDynTailUnused(Mkbin([]), 0),
<a name="1291"/> 1291: 			    233 = GetDynTailUnused(Mkbin([233]), 8),
<a name="1292"/> 1292: 			    23 = GetDynTailUnused(Mkbin([23,22,2]), 8)
<a name="1293"/> 1293: 		    end,
<a name="1294"/> 1294:           Aligned(),
<a name="1295"/> 1295: 
<a name="1296"/> 1296:           UnAligned = fun() -&gt;
<a name="1297"/> 1297: 			      {'EXIT',{function_clause,_}} =
<a name="1298"/> 1298: 				  (catch GetTailUsed(Mkbin([42]))),
<a name="1299"/> 1299: 			      {'EXIT',{{badmatch,_},_}} =
<a name="1300"/> 1300: 				  (catch GetDynTailUsed(Mkbin([137]), 3)),
<a name="1301"/> 1301: 			      {'EXIT',{function_clause,_}} =
<a name="1302"/> 1302: 				  (catch GetTailUnused(Mkbin([42,33]))),
<a name="1303"/> 1303: 			      {'EXIT',{{badmatch,_},_}} =
<a name="1304"/> 1304: 				  (catch GetDynTailUnused(Mkbin([44]), 7))
<a name="1305"/> 1305: 		      end,
<a name="1306"/> 1306:           UnAligned(),
<a name="1307"/> 1307:           ok.
<a name="1308"/> 1308: &quot;&gt;&gt;,
<a name="1309"/> 1309:     [ok] = scan(C),
<a name="bs_match_tail_SUITE-last_expr"/><a name="1310"/> 1310: <b>ok = evaluate</b>(C, []).
<a name="1311"/> 1311: 
<a name="1312"/> 1312: <i>%% OTP-5327. Adopted from emulator/test/bs_match_bin_SUITE.erl.</i>
<a name="bs_match_bin_SUITE-1"/><a name="1313"/> 1313: <b>bs_match_bin_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="1314"/> 1314:     ByteSplitBinary = 
<a name="1315"/> 1315:         &lt;&lt;&quot;ByteSplit = 
<a name="1316"/> 1316:              fun(L, B, Pos, Fun) when Pos &gt;= 0 -&gt;
<a name="1317"/> 1317:                      Sz1 = Pos,
<a name="1318"/> 1318:                      Sz2 = size(B) - Pos,
<a name="1319"/> 1319:                      &lt;&lt;B1:Sz1/binary,B2:Sz2/binary&gt;&gt; = B,
<a name="1320"/> 1320:                      B1 = list_to_binary(lists:sublist(L, 1, Pos)),
<a name="1321"/> 1321:                      B2 = list_to_binary(lists:nthtail(Pos, L)),
<a name="1322"/> 1322: 		     Fun(L, B, Pos-1, Fun);
<a name="1323"/> 1323: 		(L, B, _, _Fun) -&gt; ok
<a name="1324"/> 1324:              end,
<a name="1325"/> 1325: 	  Mkbin = fun(L) when list(L) -&gt; list_to_binary(L) end,
<a name="1326"/> 1326: 	  L = lists:seq(0, 57),
<a name="1327"/> 1327: 	  B = Mkbin(L),
<a name="1328"/> 1328: 	  ByteSplit(L, B, size(B), ByteSplit),
<a name="1329"/> 1329: 	  Id = fun(I) -&gt; I end,
<a name="1330"/> 1330: 	  MakeUnalignedSubBinary =
<a name="1331"/> 1331: 	  fun(Bin0) -&gt;
<a name="1332"/> 1332: 		  Bin1 = &lt;&lt;0:3,Bin0/binary,31:5&gt;&gt;,
<a name="1333"/> 1333: 		  Sz = size(Bin0),
<a name="1334"/> 1334: 		  &lt;&lt;0:3,Bin:Sz/binary,31:5&gt;&gt; = Id(Bin1),
<a name="1335"/> 1335: 		  Bin
<a name="1336"/> 1336: 	  end,
<a name="1337"/> 1337: 	  Unaligned = MakeUnalignedSubBinary(B),
<a name="1338"/> 1338: 	  ByteSplit(L, Unaligned, size(Unaligned), ByteSplit),
<a name="1339"/> 1339: 	  ok.
<a name="1340"/> 1340: &quot;&gt;&gt;,
<a name="1341"/> 1341:     [ok] = scan(ByteSplitBinary),
<a name="1342"/> 1342: ok = evaluate(ByteSplitBinary, []),
<a name="1343"/> 1343: BitSplitBinary =
<a name="1344"/> 1344: &lt;&lt;&quot;Mkbin = fun(L) when list(L) -&gt; list_to_binary(L) end,
<a name="1345"/> 1345: 
<a name="1346"/> 1346:            MakeInt = 
<a name="1347"/> 1347:   fun(List, 0, Acc, _F) -&gt; Acc;
<a name="1348"/> 1348:      ([H|T], N, Acc, F) -&gt; F(T, N-1, Acc bsl 1 bor H, F)
<a name="1349"/> 1349:   end,
<a name="1350"/> 1350: 
<a name="1351"/> 1351:   MakeBinFromList =
<a name="1352"/> 1352:   fun(List, 0, _F) -&gt; Mkbin([]);
<a name="1353"/> 1353:      (List, N, F) -&gt;
<a name="1354"/> 1354: 	  list_to_binary([MakeInt(List, 8, 0, MakeInt),
<a name="1355"/> 1355: 			  F(lists:nthtail(8, List), N-8, F)])
<a name="1356"/> 1356:   end,
<a name="1357"/> 1357: 
<a name="1358"/> 1358:   BitSplitBinary3 =
<a name="1359"/> 1359:   fun(Action, Bin, List, Bef, Aft, F) when Bef =&lt; Aft -&gt;
<a name="1360"/> 1360: 	  Action(Bin, List, Bef, (Aft-Bef) div 8 * 8),
<a name="1361"/> 1361: 	  F(Action, Bin, List, Bef, Aft-8, F);
<a name="1362"/> 1362:      (_, _, _, _, _, _) -&gt; ok
<a name="1363"/> 1363:   end,
<a name="1364"/> 1364: 
<a name="1365"/> 1365:   BitSplitBinary2 =
<a name="1366"/> 1366:   fun(Action, Bin, [_|T]=List, Bef, F) -&gt;
<a name="1367"/> 1367: 	  BitSplitBinary3(Action, Bin, List, Bef, size(Bin)*8,
<a name="1368"/> 1368: 			  BitSplitBinary3),
<a name="1369"/> 1369: 	  F(Action, Bin, T, Bef+1, F);
<a name="1370"/> 1370:      (Action, Bin, [], Bef, F) -&gt; ok
<a name="1371"/> 1371:   end,
<a name="1372"/> 1372: 
<a name="1373"/> 1373:   BitsToList =
<a name="1374"/> 1374:   fun([H|T], 0, F) -&gt; F(T, 16#80, F);
<a name="1375"/> 1375:      ([H|_]=List, Mask, F) -&gt;
<a name="1376"/> 1376: 	  [case H band Mask of
<a name="1377"/> 1377: 	       0 -&gt; 0;
<a name="1378"/> 1378: 	       _ -&gt; 1
<a name="1379"/> 1379: 	   end | F(List, Mask bsr 1, F)];
<a name="1380"/> 1380:      ([], _, _F) -&gt; []
<a name="1381"/> 1381:   end,
<a name="1382"/> 1382: 
<a name="1383"/> 1383:   BitSplitBinary1 =
<a name="1384"/> 1384:   fun(Action, Bin) -&gt;
<a name="1385"/> 1385: 	  BitList = BitsToList(binary_to_list(Bin), 16#80,
<a name="1386"/> 1386: 			       BitsToList),
<a name="1387"/> 1387: 	  BitSplitBinary2(Action, Bin, BitList, 0, BitSplitBinary2)
<a name="1388"/> 1388:   end,
<a name="1389"/> 1389: 
<a name="1390"/> 1390:   Fun = fun(Bin, List, SkipBef, N) -&gt;
<a name="1391"/> 1391: 		SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1392"/> 1392: 		&lt;&lt;I1:SkipBef,OutBin:N/binary-unit:1,I2:SkipAft&gt;&gt; = Bin,
<a name="1393"/> 1393: 		OutBin = MakeBinFromList(List, N, MakeBinFromList)
<a name="1394"/> 1394: 	end,
<a name="1395"/> 1395: 
<a name="1396"/> 1396:   BitSplitBinary1(Fun, erlang:md5(&lt;&lt;1,2,3&gt;&gt;)),
<a name="1397"/> 1397:   Id = fun(I) -&gt; I end,
<a name="1398"/> 1398:   MakeUnalignedSubBinary =
<a name="1399"/> 1399:   fun(Bin0) -&gt;
<a name="1400"/> 1400: 	  Bin1 = &lt;&lt;0:3,Bin0/binary,31:5&gt;&gt;,
<a name="1401"/> 1401: 	  Sz = size(Bin0),
<a name="1402"/> 1402: 	  &lt;&lt;0:3,Bin:Sz/binary,31:5&gt;&gt; = Id(Bin1),
<a name="1403"/> 1403: 	  Bin
<a name="1404"/> 1404:   end,
<a name="1405"/> 1405:   BitSplitBinary1(Fun, MakeUnalignedSubBinary(erlang:md5(&lt;&lt;1,2,3&gt;&gt;))),
<a name="1406"/> 1406:   ok.
<a name="1407"/> 1407: &quot;&gt;&gt;,
<a name="1408"/> 1408:     [ok] = scan(BitSplitBinary),
<a name="bs_match_bin_SUITE-last_expr"/><a name="1409"/> 1409: <b>ok = evaluate</b>(BitSplitBinary, []).
<a name="1410"/> 1410: 
<a name="1411"/> 1411: <b>-define</b>(FAIL(Expr), &quot;{'EXIT',{badarg,_}} = (catch &quot; ??Expr &quot;)&quot;).
<a name="1412"/> 1412: 
<a name="1413"/> 1413: <b>-define</b>(COF(Int0),
<a name="1414"/> 1414:         &quot;(fun(Int) -&gt;
<a name="1415"/> 1415:                        true = &lt;&lt;Int:32/float&gt;&gt; =:= &lt;&lt;(float(Int)):32/float&gt;&gt;,
<a name="1416"/> 1416: 	true = &lt;&lt;Int:64/float&gt;&gt; =:= &lt;&lt;(float(Int)):64/float&gt;&gt;
<a name="1417"/> 1417: 	    end)(Nonliteral(&quot; ??Int0 &quot;)),
<a name="1418"/> 1418: true = &lt;&lt;&quot; ??Int0 &quot;:32/float&gt;&gt; =:= &lt;&lt;(float(&quot;??Int0&quot;)):32/float&gt;&gt;,
<a name="1419"/> 1419: true = &lt;&lt;&quot; ??Int0 &quot;:64/float&gt;&gt; =:= &lt;&lt;(float(&quot;??Int0&quot;)):64/float&gt;&gt;&quot;).
<a name="1420"/> 1420: 
<a name="1421"/> 1421: <b>-define</b>(COF64(Int0),
<a name="1422"/> 1422:         &quot;(fun(Int) -&gt;
<a name="1423"/> 1423:                        true = &lt;&lt;Int:64/float&gt;&gt; =:= &lt;&lt;(float(Int)):64/float&gt;&gt;
<a name="1424"/> 1424: 	    end)(Nonliteral(&quot; ??Int0 &quot;)),
<a name="1425"/> 1425: true = &lt;&lt;&quot; ??Int0 &quot;:64/float&gt;&gt; =:= &lt;&lt;(float(&quot;??Int0&quot;)):64/float&gt;&gt;&quot;).
<a name="1426"/> 1426: 
<a name="1427"/> 1427: <i>%% OTP-5327. Adopted from parts of emulator/test/bs_construct_SUITE.erl.</i>
<a name="bs_construct_SUITE-1"/><a name="1428"/> 1428: <b>bs_construct_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="1429"/> 1429:     C1 = &lt;&lt;&quot;
<a name="1430"/> 1430: 
<a name="1431"/> 1431:        Testf_1 = fun(W, B) -&gt; &quot;
<a name="1432"/> 1432:             ?FAIL(&lt;&lt;42:W&gt;&gt;) &quot;,&quot;
<a name="1433"/> 1433: 				  ?FAIL(&lt;&lt;3.14:W/float&gt;&gt;) &quot;,&quot;
<a name="1434"/> 1434: 				  ?FAIL(&lt;&lt;B:W/binary&gt;&gt;) &quot;
<a name="1435"/> 1435:        end,
<a name="1436"/> 1436: 
<a name="1437"/> 1437: 	   TestF = fun() -&gt; &quot;
<a name="1438"/> 1438:             ?FAIL(&lt;&lt;3.14&gt;&gt;) &quot;,&quot;
<a name="1439"/> 1439: 				?FAIL(&lt;&lt;&lt;&lt;1,2&gt;&gt;&gt;&gt;) &quot;,&quot;
<a name="1440"/> 1440: 
<a name="1441"/> 1441: 				?FAIL(&lt;&lt;2.71/binary&gt;&gt;) &quot;,&quot;
<a name="1442"/> 1442: 				?FAIL(&lt;&lt;24334/binary&gt;&gt;) &quot;,&quot;
<a name="1443"/> 1443: 				?FAIL(&lt;&lt;24334344294788947129487129487219847/binary&gt;&gt;) &quot;,&quot;
<a name="1444"/> 1444: 
<a name="1445"/> 1445: 				?FAIL(&lt;&lt;&lt;&lt;1,2,3&gt;&gt;/float&gt;&gt;) &quot;,
<a name="1446"/> 1446: 
<a name="1447"/> 1447:             %% Negative field widths.
<a name="1448"/> 1448:             Testf_1(-8, &lt;&lt;1,2,3,4,5&gt;&gt;),&quot;
<a name="1449"/> 1449: 
<a name="1450"/> 1450:             ?FAIL(&lt;&lt;42:(-16)&gt;&gt;) &quot;,&quot;
<a name="1451"/> 1451: 				?FAIL(&lt;&lt;3.14:(-8)/float&gt;&gt;) &quot;,&quot;
<a name="1452"/> 1452: 				?FAIL(&lt;&lt;&lt;&lt;23,56,0,2&gt;&gt;:(-16)/binary&gt;&gt;) &quot;,&quot;
<a name="1453"/> 1453: 				?FAIL(&lt;&lt;&lt;&lt;23,56,0,2&gt;&gt;:(2.5)/binary&gt;&gt;) &quot;,&quot;
<a name="1454"/> 1454: 				?FAIL(&lt;&lt;&lt;&lt;23,56,0,2&gt;&gt;:(anka)&gt;&gt;) &quot;
<a name="1455"/> 1455:        end,                 
<a name="1456"/> 1456: 	   TestF(),
<a name="1457"/> 1457: 
<a name="1458"/> 1458: 	   NotUsed1 = fun(I, BinString) -&gt; &lt;&lt;I:32,BinString/binary&gt;&gt;, ok end,
<a name="1459"/> 1459: 
<a name="1460"/> 1460: 	   NotUsed2 = fun(I, Sz) -&gt; &lt;&lt;I:Sz&gt;&gt;, ok end,
<a name="1461"/> 1461: 
<a name="1462"/> 1462: 	   NotUsed3 = fun(I) -&gt;&lt;&lt;I:(-8)&gt;&gt;, ok end,
<a name="1463"/> 1463: 
<a name="1464"/> 1464: 	   NotUsed = fun() -&gt;
<a name="1465"/> 1465: 			     ok = NotUsed1(3, &lt;&lt;\&quot;dum\&quot;&gt;&gt;),
<a name="1466"/> 1466:             {'EXIT',{badarg,_}} = (catch NotUsed1(3, \&quot;dum\&quot;)), &quot;
<a name="1467"/> 1467: 						  ?FAIL(NotUsed2(444, -2)) &quot;,&quot;
<a name="1468"/> 1468: 						  ?FAIL(NotUsed2(444, anka)) &quot;,&quot;
<a name="1469"/> 1469: 						  ?FAIL(NotUsed3(444)) &quot;
<a name="1470"/> 1470:        end,
<a name="1471"/> 1471: 						  NotUsed(),
<a name="1472"/> 1472: 
<a name="1473"/> 1473: 						  InGuard3 = fun(Bin, A, B) when &lt;&lt;A:13,B:3&gt;&gt; == Bin -&gt; 1;
<a name="1474"/> 1474: 								(Bin, A, B) when &lt;&lt;A:16,B/binary&gt;&gt; == Bin -&gt; 2;
<a name="1475"/> 1475: 								(Bin, A, B) when &lt;&lt;A:14,B/float,3:2&gt;&gt; == Bin -&gt; 3;
<a name="1476"/> 1476: 								(Bin, A, B) when {a,b,&lt;&lt;A:14,B/float,3:2&gt;&gt;} == Bin -&gt;
<a name="1477"/> 1477: 								     cant_happen;
<a name="1478"/> 1478: 								(_, _, _) -&gt; nope
<a name="1479"/> 1479: 							     end,
<a name="1480"/> 1480: 
<a name="1481"/> 1481: 						  InGuard = fun() -&gt;
<a name="1482"/> 1482: 								    1 = InGuard3(&lt;&lt;16#74ad:16&gt;&gt;, 16#e95, 5),
<a name="1483"/> 1483: 								    2 = InGuard3(&lt;&lt;16#3A,16#F7,\&quot;hello\&quot;&gt;&gt;, 16#3AF7, &lt;&lt;\&quot;hello\&quot;&gt;&gt;),
<a name="1484"/> 1484:             3 = InGuard3(&lt;&lt;16#FBCD:14,3.1415/float,3:2&gt;&gt;, 16#FBCD, 3.1415),
<a name="1485"/> 1485: 										   nope = InGuard3(&lt;&lt;1&gt;&gt;, 42, b),
<a name="1486"/> 1486: 										   nope = InGuard3(&lt;&lt;1&gt;&gt;, a, b),
<a name="1487"/> 1487: 										   nope = InGuard3(&lt;&lt;1,2&gt;&gt;, 1, 1),
<a name="1488"/> 1488: 										   nope = InGuard3(&lt;&lt;4,5&gt;&gt;, 1, 2.71),
<a name="1489"/> 1489: 										   nope = InGuard3(&lt;&lt;4,5&gt;&gt;, 1, &lt;&lt;12,13&gt;&gt;)
<a name="1490"/> 1490: 										   end,
<a name="1491"/> 1491: 										   InGuard(),
<a name="1492"/> 1492: 
<a name="1493"/> 1493: 										   Nonliteral = fun(X) -&gt; X end,
<a name="1494"/> 1494: 
<a name="1495"/> 1495: 										   CoerceToFloat = fun() -&gt; &quot;
<a name="1496"/> 1496:            ?COF(0) &quot;,&quot;
<a name="1497"/> 1497: 														?COF(-1) &quot;,&quot;
<a name="1498"/> 1498: 														?COF(1) &quot;,&quot;
<a name="1499"/> 1499: 														?COF(42) &quot;,&quot;
<a name="1500"/> 1500: 														?COF(255) &quot;,&quot;
<a name="1501"/> 1501: 														?COF(-255) &quot;,&quot;
<a name="1502"/> 1502: 														?COF64(298748888888888888888888888883478264866528467367364766666666666666663) &quot;,&quot;
<a name="1503"/> 1503: 														?COF64(-367546729879999999999947826486652846736736476555566666663) &quot;
<a name="1504"/> 1504:        end,
<a name="1505"/> 1505: 										   CoerceToFloat(),
<a name="1506"/> 1506: 										   ok.
<a name="1507"/> 1507: &quot;&gt;&gt;,
<a name="1508"/> 1508:     [ok] = scan(C1),
<a name="1509"/> 1509: ok = evaluate(C1, []),
<a name="1510"/> 1510: 
<a name="1511"/> 1511: <i>%% There is another one, lib/compiler/test/bs_construct_SUITE.erl...</i>
<a name="1512"/> 1512: C2 = &lt;&lt;&quot;
<a name="1513"/> 1513:        I = fun(X) -&gt; X end,
<a name="1514"/> 1514: 
<a name="1515"/> 1515:        Fail = fun() -&gt; 
<a name="1516"/> 1516: 
<a name="1517"/> 1517: 		      I_minus_777 = I(-777),
<a name="1518"/> 1518: 		      I_minus_2047 = I(-2047),
<a name="1519"/> 1519: 
<a name="1520"/> 1520:          %% One negative field size, but the sum of field sizes will be 1 byte.
<a name="1521"/> 1521:          %% Make sure that we reject that properly.
<a name="1522"/> 1522: 
<a name="1523"/> 1523: 		      {'EXIT',{badarg,_}} = (catch &lt;&lt;I_minus_777:2048/unit:8,
<a name="1524"/> 1524: 						     57:I_minus_2047/unit:8&gt;&gt;),
<a name="1525"/> 1525: 
<a name="1526"/> 1526:          %% Same thing, but use literals.
<a name="1527"/> 1527: 		      {'EXIT',{badarg,_}} = (catch &lt;&lt;I_minus_777:2048/unit:8,
<a name="1528"/> 1528: 						     57:(-2047)/unit:8&gt;&gt;),
<a name="1529"/> 1529: 
<a name="1530"/> 1530:          %% Bad alignment.
<a name="1531"/> 1531: 		      I_one = I(1),
<a name="1532"/> 1532: 		      &lt;&lt;1:1&gt;&gt; = &lt;&lt;2375:I_one&gt;&gt;,
<a name="1533"/> 1533: 		      &lt;&lt;3:2&gt;&gt; = &lt;&lt;45:1,2375:I_one&gt;&gt;,
<a name="1534"/> 1534: 		      &lt;&lt;14:4&gt;&gt; = &lt;&lt;45:1,2375:I_one,918:2&gt;&gt;,
<a name="1535"/> 1535: 		      &lt;&lt;118:7&gt;&gt; = &lt;&lt;45:1,2375:I_one,918:5&gt;&gt;,
<a name="1536"/> 1536: 
<a name="1537"/> 1537:          %% Not numbers.
<a name="1538"/> 1538: 		      {'EXIT',{badarg,_}} = (catch &lt;&lt;45:(I(not_a_number))&gt;&gt;),
<a name="1539"/> 1539: 		      {'EXIT',{badarg,_}} = (catch &lt;&lt;13:8,45:(I(not_a_number))&gt;&gt;),
<a name="1540"/> 1540: 
<a name="1541"/> 1541:          %% Unaligned sizes.
<a name="1542"/> 1542: 		      BadSz = I(7),
<a name="1543"/> 1543: 		      &lt;&lt;2:4&gt;&gt; = &lt;&lt;34:4&gt;&gt;,
<a name="1544"/> 1544: 		      &lt;&lt;34:7&gt;&gt; = &lt;&lt;34:BadSz&gt;&gt;,
<a name="1545"/> 1545: 
<a name="1546"/> 1546: 		      [] = [X || {X} &lt;- [], X == &lt;&lt;3:BadSz&gt;&gt;],
<a name="1547"/> 1547: 		      [] = [X || {X} &lt;- [], X == &lt;&lt;3:4&gt;&gt;]
<a name="1548"/> 1548: 	      end,
<a name="1549"/> 1549:        Fail(),
<a name="1550"/> 1550: 
<a name="1551"/> 1551:        FloatBin1 = fun(F) -&gt;
<a name="1552"/> 1552: 			   {&lt;&lt;1,2,3&gt;&gt;,F+3.0}
<a name="1553"/> 1553: 		   end,
<a name="1554"/> 1554: 
<a name="1555"/> 1555:        FloatBin = fun() -&gt;
<a name="1556"/> 1556:            %% Some more coverage.
<a name="1557"/> 1557: 			  {&lt;&lt;1,2,3&gt;&gt;,7.0} = FloatBin1(4)
<a name="1558"/> 1558: 		  end,
<a name="1559"/> 1559:        FloatBin(),
<a name="1560"/> 1560: 
<a name="1561"/> 1561:        ok.
<a name="1562"/> 1562: &quot;&gt;&gt;,
<a name="1563"/> 1563:     [ok] = scan(C2),
<a name="bs_construct_SUITE-last_expr"/><a name="1564"/> 1564: <b>ok = evaluate</b>(C2, []).
<a name="1565"/> 1565: 
<a name="evaluate-2"/><a name="1566"/> 1566: <b>evaluate</b>(B, Vars) when is_binary(B) -&gt;
<a name="1567"/> 1567:     evaluate(binary_to_list(B), Vars);
<a name="1568"/> 1568: <b>evaluate</b>(Str, Vars) -&gt;
<a name="1569"/> 1569:     {ok,Tokens,_} =
<a name="1570"/> 1570: 	erl_scan:string(Str),
<a name="1571"/> 1571:     {ok, Exprs} = erl_parse:parse_exprs(Tokens),
<a name="evaluate-last_expr"/><a name="1572"/> 1572: <b>    case erl_eval:exprs</b>(Exprs, Vars, none) of
<a name="1573"/> 1573: 	{value, Result, _} -&gt;
<a name="1574"/> 1574: 	    Result
<a name="1575"/> 1575:     end.
<a name="1576"/> 1576: 
<a name="1577"/> 1577: 
<a name="1578"/> 1578: <i>%% Bit syntax examples from the Reference Manual. OTP-5237.</i>
<a name="refman_bit_syntax-1"/><a name="1579"/> 1579: <b>refman_bit_syntax</b>(Config) when is_list(Config) -&gt;
<a name="1580"/> 1580:     %% Reference Manual &quot;Bit Syntax Expressions&quot;
<a name="1581"/> 1581:     Bin1 = &lt;&lt;1,17,42&gt;&gt;,
<a name="1582"/> 1582:     true = [1,17,42] =:= binary_to_list(Bin1),
<a name="1583"/> 1583:     Bin2 = &lt;&lt;&quot;abc&quot;&gt;&gt;,
<a name="1584"/> 1584:     true = &quot;abc&quot; =:= binary_to_list(Bin2),
<a name="1585"/> 1585:     Bin3 = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1586"/> 1586:     true = [1,17,0,42] =:= binary_to_list(Bin3),
<a name="1587"/> 1587:     &lt;&lt;_A,_B,C:16&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1588"/> 1588:     true = C =:= 42,
<a name="1589"/> 1589:     &lt;&lt;D:16,_E,F&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1590"/> 1590:     true = D =:= 273,
<a name="1591"/> 1591:     true = F =:= 42,
<a name="1592"/> 1592:     &lt;&lt;_G,H/binary&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1593"/> 1593:     true = H =:= &lt;&lt;17,0,42&gt;&gt;,
<a name="1594"/> 1594: 
<a name="1595"/> 1595:     [ok] =
<a name="1596"/> 1596:         scan(&lt;&lt;&quot;Bin1 = &lt;&lt;1,17,42&gt;&gt;,
<a name="1597"/> 1597:                          true = [1,17,42] =:= binary_to_list(Bin1),
<a name="1598"/> 1598: 	       Bin2 = &lt;&lt;\&quot;abc\&quot;&gt;&gt;,
<a name="1599"/> 1599:                          true = \&quot;abc\&quot; =:= binary_to_list(Bin2),
<a name="1600"/> 1600:                          Bin3 = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1601"/> 1601: 			true =
<a name="1602"/> 1602: 			[1,17,0,42] =:= binary_to_list(Bin3),
<a name="1603"/> 1603: 			&lt;&lt;A,B,C:16&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1604"/> 1604: 			true = C =:= 42,
<a name="1605"/> 1605: 			&lt;&lt;D:16,E,F&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1606"/> 1606: 			true = D =:= 273,
<a name="1607"/> 1607: 			true = F =:= 42,
<a name="1608"/> 1608: 			&lt;&lt;G,H/binary&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1609"/> 1609: 			true = H =:= &lt;&lt;17,0,42&gt;&gt;,
<a name="1610"/> 1610: 			ok.&quot;&gt;&gt;),
<a name="1611"/> 1611: 
<a name="1612"/> 1612:     %% Binary comprehensions.
<a name="1613"/> 1613:     &lt;&lt;2,4,6&gt;&gt; =  &lt;&lt; &lt;&lt; (X*2) &gt;&gt; || &lt;&lt;X&gt;&gt; &lt;= &lt;&lt; 1,2,3 &gt;&gt; &gt;&gt;,
<a name="refman_bit_syntax-last_expr"/><a name="1614"/> 1614: 			ok.
<a name="1615"/> 1615: 
<a name="1616"/> 1616: 
<a name="1617"/> 1617: <b>-define</b>(IP_VERSION, 4).
<a name="1618"/> 1618: <b>-define</b>(IP_MIN_HDR_LEN, 5).
<a name="1619"/> 1619: 
<a name="1620"/> 1620: <i>%% Bit syntax examples from Programming Examples. OTP-5237.</i>
<a name="progex_bit_syntax-1"/><a name="1621"/> 1621: <b>progex_bit_syntax</b>(Config) when is_list(Config) -&gt;
<a name="1622"/> 1622:     Bin11 = &lt;&lt;1, 17, 42&gt;&gt;,
<a name="1623"/> 1623:     true = [1, 17, 42] =:= binary_to_list(Bin11),
<a name="1624"/> 1624:     Bin12 = &lt;&lt;&quot;abc&quot;&gt;&gt;,
<a name="1625"/> 1625:     true = [97, 98, 99] =:= binary_to_list(Bin12),
<a name="1626"/> 1626: 
<a name="1627"/> 1627:     A = 1, B = 17, C = 42,
<a name="1628"/> 1628:     Bin2 = &lt;&lt;A, B, C:16&gt;&gt;,
<a name="1629"/> 1629:     true = [1, 17, 00, 42] =:= binary_to_list(Bin2),
<a name="1630"/> 1630:     &lt;&lt;D:16, E, F/binary&gt;&gt; = Bin2,
<a name="1631"/> 1631:     true = D =:= 273,
<a name="1632"/> 1632:     true = E =:= 00,
<a name="1633"/> 1633:     true = [42] =:= binary_to_list(F),
<a name="1634"/> 1634: 
<a name="1635"/> 1635:     Fun4 = fun(Dgram) -&gt;
<a name="1636"/> 1636:                    DgramSize = byte_size(Dgram),
<a name="1637"/> 1637:                    case Dgram of 
<a name="1638"/> 1638:                        &lt;&lt;?IP_VERSION:4, HLen:4, SrvcType:8, TotLen:16, 
<a name="1639"/> 1639: 			 ID:16, Flgs:3, FragOff:13,
<a name="1640"/> 1640: 			 TTL:8, Proto:8, HdrChkSum:16,
<a name="1641"/> 1641: 			 SrcIP:32, DestIP:32,
<a name="1642"/> 1642: 			 RestDgram/binary&gt;&gt; when HLen&gt;=5, 4*HLen=&lt;DgramSize -&gt;
<a name="1643"/> 1643:                            OptsLen = 4*(HLen - ?IP_MIN_HDR_LEN),
<a name="1644"/> 1644:                            &lt;&lt;Opts:OptsLen/binary,Data/binary&gt;&gt; = RestDgram,
<a name="1645"/> 1645:                            {SrvcType, TotLen, Flgs, FragOff, ID, HdrChkSum,
<a name="1646"/> 1646:                             Proto, TTL, SrcIP, DestIP, Data, Opts};
<a name="1647"/> 1647:                        _ -&gt;
<a name="1648"/> 1648:                            not_ok
<a name="1649"/> 1649:                    end
<a name="1650"/> 1650:            end,
<a name="1651"/> 1651:     true = Fun4(&lt;&lt;&gt;&gt;) =:= not_ok,
<a name="1652"/> 1652:     true = is_tuple(Fun4(list_to_binary([&lt;&lt;?IP_VERSION:4,5:4&gt;&gt;,
<a name="1653"/> 1653:                                          list_to_binary(lists:seq(1,255))]))),
<a name="1654"/> 1654: 
<a name="1655"/> 1655:     X = 23432324, Y = 24324234,
<a name="1656"/> 1656:     &lt;&lt;10:7&gt;&gt; = &lt;&lt;X:1, Y:6&gt;&gt;,
<a name="1657"/> 1657:     Z = 234324324,
<a name="1658"/> 1658:     XYZ = &lt;&lt;X:1, Y:6, Z:1&gt;&gt;,
<a name="1659"/> 1659:     true = [20] =:= binary_to_list(XYZ),
<a name="1660"/> 1660:     Hello1 = &lt;&lt;&quot;hello&quot;&gt;&gt;,
<a name="1661"/> 1661:     Hello2 = &lt;&lt;$h,$e,$l,$l,$o&gt;&gt;,
<a name="1662"/> 1662:     true = &quot;hello&quot; =:= binary_to_list(Hello1),
<a name="1663"/> 1663:     true = &quot;hello&quot; =:= binary_to_list(Hello2),
<a name="1664"/> 1664: 
<a name="1665"/> 1665:     FunM1 = fun(&lt;&lt;X1:7/binary, Y1:1/binary&gt;&gt;) -&gt; {X1,Y1} end,
<a name="1666"/> 1666:     true = {&lt;&lt;&quot;1234567&quot;&gt;&gt;,&lt;&lt;&quot;8&quot;&gt;&gt;} =:= FunM1(&lt;&lt;&quot;12345678&quot;&gt;&gt;),
<a name="1667"/> 1667: 
<a name="1668"/> 1668:     FunM2 = fun(&lt;&lt;_X1:7/binary-unit:7, _Y1:1/binary-unit:1&gt;&gt;) -&gt; ok;
<a name="1669"/> 1669:                (_) -&gt; not_ok end,
<a name="1670"/> 1670:     true = not_ok =:= FunM2(&lt;&lt;&quot;1&quot;&gt;&gt;),
<a name="1671"/> 1671: 
<a name="1672"/> 1672:     BL = [{3,4,5},{6,7,8}],
<a name="1673"/> 1673:     Lst = [0,0,0,3,0,0,0,4,0,0,0,5,0,0,0,6,0,0,0,7,0,0,0,8],
<a name="1674"/> 1674:     B1 = triples_to_bin1(BL),
<a name="1675"/> 1675:     true = Lst =:= binary_to_list(B1),
<a name="1676"/> 1676:     B2 = triples_to_bin2(BL),
<a name="1677"/> 1677:     true = Lst =:= binary_to_list(B2),
<a name="1678"/> 1678: 
<a name="1679"/> 1679:     [ok] = scan(
<a name="1680"/> 1680: 	     &lt;&lt;&quot;Bin11 = &lt;&lt;1, 17, 42&gt;&gt;,
<a name="1681"/> 1681:         true = [1, 17, 42] =:= binary_to_list(Bin11),
<a name="1682"/> 1682: 	       Bin12 = &lt;&lt;\&quot;abc\&quot;&gt;&gt;,
<a name="1683"/> 1683:         true = [97, 98, 99] =:= binary_to_list(Bin12),
<a name="1684"/> 1684: 
<a name="1685"/> 1685: 			 A = 1, B = 17, C = 42,
<a name="1686"/> 1686: 			 Bin2 = &lt;&lt;A, B, C:16&gt;&gt;,
<a name="1687"/> 1687: 			 true = [1, 17, 00, 42] =:= binary_to_list(Bin2),
<a name="1688"/> 1688: 			 &lt;&lt;D:16, E, F/binary&gt;&gt; = Bin2,
<a name="1689"/> 1689: 			 true = D =:= 273,
<a name="1690"/> 1690: 			 true = E =:= 00,
<a name="1691"/> 1691: 			 true = [42] =:= binary_to_list(F),
<a name="1692"/> 1692: 
<a name="1693"/> 1693: 			 Fun4 = fun(Dgram) -&gt;
<a name="1694"/> 1694: 					DgramSize = byte_size(Dgram),
<a name="1695"/> 1695: 					case Dgram of
<a name="1696"/> 1696: 					    &lt;&lt;4:4, HLen:4, SrvcType:8, TotLen:16,
<a name="1697"/> 1697: 					      ID:16, Flgs:3, FragOff:13,
<a name="1698"/> 1698: 					      TTL:8, Proto:8, HdrChkSum:16,
<a name="1699"/> 1699: 					      SrcIP:32, DestIP:32,
<a name="1700"/> 1700: 					      RestDgram/binary&gt;&gt; when HLen&gt;=5,
<a name="1701"/> 1701: 								      4*HLen=&lt;DgramSize -&gt;
<a name="1702"/> 1702: 						OptsLen = 4*(HLen - 5),
<a name="1703"/> 1703: 						&lt;&lt;Opts:OptsLen/binary,Data/binary&gt;&gt; = RestDgram,
<a name="1704"/> 1704: 						{SrvcType, TotLen, Flgs, FragOff, ID, HdrChkSum,
<a name="1705"/> 1705: 						 Proto, TTL, SrcIP, DestIP, Data, Opts};
<a name="1706"/> 1706: 					    _ -&gt;
<a name="1707"/> 1707: 						not_ok
<a name="1708"/> 1708: 					end
<a name="1709"/> 1709: 				end,
<a name="1710"/> 1710: 			 true = Fun4(&lt;&lt;&gt;&gt;) =:= not_ok,
<a name="1711"/> 1711: 			 true = is_tuple(Fun4(list_to_binary
<a name="1712"/> 1712: 						([&lt;&lt;4:4,5:4&gt;&gt;,list_to_binary(lists:seq(1,255))]))),
<a name="1713"/> 1713: 
<a name="1714"/> 1714: 			 X = 23432324, Y = 24324234,
<a name="1715"/> 1715: 			 &lt;&lt;10:7&gt;&gt; = &lt;&lt;X:1, Y:6&gt;&gt;,
<a name="1716"/> 1716: 			 Z = 234324324,
<a name="1717"/> 1717: 			 XYZ = &lt;&lt;X:1, Y:6, Z:1&gt;&gt;,
<a name="1718"/> 1718: 			 true = [20] =:= binary_to_list(XYZ),
<a name="1719"/> 1719: 			 Hello1 = &lt;&lt;\&quot;hello\&quot;&gt;&gt;,
<a name="1720"/> 1720:         Hello2 = &lt;&lt;$h,$e,$l,$l,$o&gt;&gt;,
<a name="1721"/> 1721: 				    true = \&quot;hello\&quot; =:= binary_to_list(Hello1),
<a name="1722"/> 1722:         true = \&quot;hello\&quot; =:= binary_to_list(Hello2),
<a name="1723"/> 1723: 
<a name="1724"/> 1724:         FunM1 = fun(&lt;&lt;X1:7/binary, Y1:1/binary&gt;&gt;) -&gt; {X1,Y1} end,
<a name="1725"/> 1725: 				    true = {&lt;&lt;\&quot;1234567\&quot;&gt;&gt;,&lt;&lt;\&quot;8\&quot;&gt;&gt;} =:= FunM1(&lt;&lt;\&quot;12345678\&quot;&gt;&gt;),
<a name="1726"/> 1726: 
<a name="1727"/> 1727:         FunM2 = fun(&lt;&lt;_X1:7/binary-unit:7, _Y1:1/binary-unit:1&gt;&gt;) -&gt; ok;
<a name="1728"/> 1728:                    (_) -&gt; not_ok end,
<a name="1729"/> 1729: 					      true = not_ok =:= FunM2(&lt;&lt;\&quot;1\&quot;&gt;&gt;),
<a name="1730"/> 1730:         ok.&quot;&gt;&gt;),
<a name="1731"/> 1731: 
<a name="progex_bit_syntax-last_expr"/><a name="1732"/> 1732:     ok.
<a name="1733"/> 1733: 
<a name="triples_to_bin1-1"/><a name="1734"/> 1734: <b>triples_to_bin1</b>(T) -&gt;
<a name="triples_to_bin1-last_expr"/><a name="1735"/> 1735: <b>    triples_to_bin1</b>(T, &lt;&lt;&gt;&gt;).
<a name="1736"/> 1736: 
<a name="triples_to_bin1-2"/><a name="1737"/> 1737: <b>triples_to_bin1</b>([{X,Y,Z} | T], Acc) -&gt;
<a name="1738"/> 1738:     triples_to_bin1(T, &lt;&lt;Acc/binary, X:32, Y:32, Z:32&gt;&gt;);   % inefficient
<a name="1739"/> 1739: <b>triples_to_bin1</b>([], Acc) -&gt; 
<a name="triples_to_bin1-last_expr"/><a name="1740"/> 1740:     Acc.
<a name="1741"/> 1741: 
<a name="triples_to_bin2-1"/><a name="1742"/> 1742: <b>triples_to_bin2</b>(T) -&gt;
<a name="triples_to_bin2-last_expr"/><a name="1743"/> 1743: <b>    triples_to_bin2</b>(T, []).
<a name="1744"/> 1744: 
<a name="triples_to_bin2-2"/><a name="1745"/> 1745: <b>triples_to_bin2</b>([{X,Y,Z} | T], Acc) -&gt;
<a name="1746"/> 1746:     triples_to_bin2(T, [&lt;&lt;X:32, Y:32, Z:32&gt;&gt; | Acc]);
<a name="1747"/> 1747: <b>triples_to_bin2</b>([], Acc) -&gt; 
<a name="triples_to_bin2-last_expr"/><a name="1748"/> 1748: <b>    list_to_binary</b>(lists:reverse(Acc)).
<a name="1749"/> 1749: 
<a name="1750"/> 1750: <i>%% Record examples from Programming Examples. OTP-5237.</i>
<a name="progex_records-1"/><a name="1751"/> 1751: <b>progex_records</b>(Config) when is_list(Config) -&gt;
<a name="1752"/> 1752:     Test1 = 
<a name="1753"/> 1753: 	&lt;&lt;&quot;-module(recs).
<a name="1754"/> 1754:           -record(person, {name = \&quot;\&quot;, phone = [], address}).
<a name="1755"/> 1755:           -record(name, {first = \&quot;Robert\&quot;, last = \&quot;Ericsson\&quot;}).
<a name="1756"/> 1756:           -record(person2, {name = #name{}, phone}).
<a name="1757"/> 1757: <b>-export</b>([t/0]).
<a name="1758"/> 1758: 
<a name="1759"/> 1759: t() -&gt;
<a name="1760"/> 1760:     _P1 = #person{phone=[0,8,2,3,4,3,1,2], name=\&quot;Robert\&quot;},
<a name="1761"/> 1761:               \&quot;Robert\&quot; = _P1#person.name,
<a name="1762"/> 1762:               [0,8,2,3,4,3,1,2] = _P1#person.phone,
<a name="1763"/> 1763: 		  undefined = _P1#person.address,
<a name="1764"/> 1764: 
<a name="1765"/> 1765: 		  _P2 = #person{name = \&quot;Jakob\&quot;, _ = '_'},
<a name="1766"/> 1766:                \&quot;Jakob\&quot; = _P2#person.name,
<a name="1767"/> 1767:               '_' = _P2#person.phone,
<a name="1768"/> 1768: 				'_' = _P2#person.address,
<a name="1769"/> 1769: 
<a name="1770"/> 1770: 				P = #person{name = \&quot;Joe\&quot;, phone = [0,8,2,3,4,3,1,2]},
<a name="1771"/> 1771:               \&quot;Joe\&quot; = P#person.name,
<a name="1772"/> 1772:               [0,8,2,3,4,3,1,2] = P#person.phone,
<a name="1773"/> 1773: 					    undefined = P#person.address,
<a name="1774"/> 1774: 
<a name="1775"/> 1775: 					    P1 = #person{name=\&quot;Joe\&quot;, phone=[1,2,3], address=\&quot;A street\&quot;},
<a name="1776"/> 1776:               P2 = P1#person{name=\&quot;Robert\&quot;},
<a name="1777"/> 1777:               \&quot;Robert\&quot; = P2#person.name,
<a name="1778"/> 1778:               [1,2,3] = P2#person.phone,
<a name="1779"/> 1779: 			     \&quot;A street\&quot; = P2#person.address,
<a name="1780"/> 1780:               a_person = foo(P1),
<a name="1781"/> 1781: 
<a name="1782"/> 1782: 			     {found, [1,2,3]} =
<a name="1783"/> 1783: 				 find_phone([#person{name = a},
<a name="1784"/> 1784: 					     #person{name = b, phone = [3,2,1]},
<a name="1785"/> 1785: 					     #person{name = c, phone = [1,2,3]}],
<a name="1786"/> 1786: 					    c),
<a name="1787"/> 1787: 
<a name="1788"/> 1788: 			     P3 = #person{name=\&quot;Joe\&quot;, phone=[0,0,7], address=\&quot;A street\&quot;},
<a name="1789"/> 1789:               #person{name = Name} = P3, 
<a name="1790"/> 1790: 					  \&quot;Joe\&quot; = Name,
<a name="1791"/> 1791: 
<a name="1792"/> 1792:               \&quot;Robert\&quot; = demo(),
<a name="1793"/> 1793:               ok.
<a name="1794"/> 1794: 
<a name="1795"/> 1795: foo(P) when is_record(P, person) -&gt; a_person;
<a name="1796"/> 1796: foo(_) -&gt; not_a_person.
<a name="1797"/> 1797: 
<a name="1798"/> 1798: find_phone([#person{name=Name, phone=Phone} | _], Name) -&gt;
<a name="1799"/> 1799:     {found,  Phone};
<a name="1800"/> 1800: find_phone([_| T], Name) -&gt;
<a name="1801"/> 1801:     find_phone(T, Name);
<a name="1802"/> 1802: find_phone([], _Name) -&gt;
<a name="1803"/> 1803:     not_found.
<a name="1804"/> 1804: 
<a name="1805"/> 1805: demo() -&gt;
<a name="1806"/> 1806:     P = #person2{name= #name{first=\&quot;Robert\&quot;,last=\&quot;Virding\&quot;},
<a name="1807"/> 1807:                                phone=123},
<a name="1808"/> 1808: 		 _First = (P#person2.name)#name.first.
<a name="1809"/> 1809: &quot;&gt;&gt;,
<a name="1810"/> 1810:     ok = run_file(Config, recs, Test1),
<a name="1811"/> 1811: 
<a name="1812"/> 1812: Test1_shell =
<a name="1813"/> 1813: &lt;&lt;&quot;rd(person, {name = \&quot;\&quot;, phone = [], address}),
<a name="1814"/> 1814:           rd(name, {first = \&quot;Robert\&quot;, last = \&quot;Ericsson\&quot;}),
<a name="1815"/> 1815:           rd(person2, {name = #name{}, phone}),
<a name="1816"/> 1816: 
<a name="1817"/> 1817: 		    _P1 = #person{phone=[0,8,2,3,4,3,1,2], name=\&quot;Robert\&quot;},
<a name="1818"/> 1818:           \&quot;Robert\&quot; = _P1#person.name,
<a name="1819"/> 1819:           [0,8,2,3,4,3,1,2] = _P1#person.phone,
<a name="1820"/> 1820: 				  undefined = _P1#person.address,
<a name="1821"/> 1821: 
<a name="1822"/> 1822: 				  _P2 = #person{name = \&quot;Jakob\&quot;, _ = '_'},
<a name="1823"/> 1823:            \&quot;Jakob\&quot; = _P2#person.name,
<a name="1824"/> 1824:           '_' = _P2#person.phone,
<a name="1825"/> 1825: 						'_' = _P2#person.address,
<a name="1826"/> 1826: 
<a name="1827"/> 1827: 						P = #person{name = \&quot;Joe\&quot;, phone = [0,8,2,3,4,3,1,2]},
<a name="1828"/> 1828:           \&quot;Joe\&quot; = P#person.name,
<a name="1829"/> 1829:           [0,8,2,3,4,3,1,2] = P#person.phone,
<a name="1830"/> 1830: 							    undefined = P#person.address,
<a name="1831"/> 1831: 
<a name="1832"/> 1832: 							    P1 = #person{name=\&quot;Joe\&quot;, phone=[1,2,3], address=\&quot;A street\&quot;},
<a name="1833"/> 1833:           P2 = P1#person{name=\&quot;Robert\&quot;},
<a name="1834"/> 1834:           \&quot;Robert\&quot; = P2#person.name,
<a name="1835"/> 1835:           [1,2,3] = P2#person.phone,
<a name="1836"/> 1836: 			 \&quot;A street\&quot; = P2#person.address,
<a name="1837"/> 1837:           Foo = fun(P) when is_record(P, person) -&gt; a_person;
<a name="1838"/> 1838:                    (_) -&gt; not_a_person
<a name="1839"/> 1839:                 end,
<a name="1840"/> 1840: 			 a_person = Foo(P1),
<a name="1841"/> 1841: 
<a name="1842"/> 1842: 			 Find = fun([#person{name=Name, phone=Phone} | _], Name, Fn) -&gt;
<a name="1843"/> 1843: 					{found,  Phone};
<a name="1844"/> 1844: 				   ([_| T], Name, Fn) -&gt;
<a name="1845"/> 1845: 					Fn(T, Name, Fn);
<a name="1846"/> 1846: 				   ([], _Name, _Fn) -&gt;
<a name="1847"/> 1847: 					not_found
<a name="1848"/> 1848: 				end,
<a name="1849"/> 1849: 
<a name="1850"/> 1850: 			 {found, [1,2,3]} = Find([#person{name = a},
<a name="1851"/> 1851: 						  #person{name = b, phone = [3,2,1]},
<a name="1852"/> 1852: 						  #person{name = c, phone = [1,2,3]}],
<a name="1853"/> 1853: 						 c,
<a name="1854"/> 1854: 						 Find),
<a name="1855"/> 1855: 
<a name="1856"/> 1856: 			 P3 = #person{name=\&quot;Joe\&quot;, phone=[0,0,7], address=\&quot;A street\&quot;},
<a name="1857"/> 1857:           #person{name = Name} = P3, 
<a name="1858"/> 1858: 				      \&quot;Joe\&quot; = Name,
<a name="1859"/> 1859: 
<a name="1860"/> 1860:           Demo = fun() -&gt;
<a name="1861"/> 1861: 			 P17 = #person2{name= #name{first=\&quot;Robert\&quot;,last=\&quot;Virding\&quot;},
<a name="1862"/> 1862:                            phone=123},
<a name="1863"/> 1863: 					_First = (P17#person2.name)#name.first
<a name="1864"/> 1864: 					end,
<a name="1865"/> 1865: 
<a name="1866"/> 1866: 					\&quot;Robert\&quot; = Demo(),
<a name="1867"/> 1867:           ok.
<a name="1868"/> 1868: &quot;&gt;&gt;,
<a name="1869"/> 1869:     [ok] = scan(Test1_shell),
<a name="1870"/> 1870: 
<a name="1871"/> 1871: Test2 =
<a name="1872"/> 1872: &lt;&lt;&quot;-module(recs).
<a name="1873"/> 1873:           -record(person, {name, age, phone = [], dict = []}).
<a name="1874"/> 1874: <b>-export</b>([t/0]).
<a name="1875"/> 1875: 
<a name="1876"/> 1876: t() -&gt; ok.
<a name="1877"/> 1877: 
<a name="1878"/> 1878: make_hacker_without_phone(Name, Age) -&gt;
<a name="1879"/> 1879:     #person{name = Name, age = Age,
<a name="1880"/> 1880: 	    dict = [{computer_knowledge, excellent},
<a name="1881"/> 1881: 		    {drinks, coke}]}.
<a name="1882"/> 1882: print(#person{name = Name, age = Age,
<a name="1883"/> 1883: 	      phone = Phone, dict = Dict}) -&gt;
<a name="1884"/> 1884:     io:format(\&quot;Name: ~s, Age: ~w, Phone: ~w ~n\&quot;
<a name="1885"/> 1885:                         \&quot;Dictionary: ~w.~n\&quot;, [Name, Age, Phone, Dict]).
<a name="1886"/> 1886: 
<a name="1887"/> 1887:           birthday(P) when record(P, person) -&gt; 
<a name="1888"/> 1888: 		     P#person{age = P#person.age + 1}.
<a name="1889"/> 1889: 
<a name="1890"/> 1890: register_two_hackers() -&gt;
<a name="1891"/> 1891:     Hacker1 = make_hacker_without_phone(\&quot;Joe\&quot;, 29),
<a name="1892"/> 1892:              OldHacker = birthday(Hacker1),
<a name="1893"/> 1893:              %% The central_register_server should have
<a name="1894"/> 1894:              %% an interface function for this.
<a name="1895"/> 1895: 					central_register_server ! {register_person, Hacker1},
<a name="1896"/> 1896: 					central_register_server ! {register_person,
<a name="1897"/> 1897: 								   OldHacker#person{name = \&quot;Robert\&quot;,
<a name="1898"/> 1898:                                         phone = [0,8,3,2,4,5,3,1]}}.
<a name="1899"/> 1899: &quot;&gt;&gt;,
<a name="1900"/> 1900:     ok = run_file(Config, recs, Test2),
<a name="progex_records-last_expr"/><a name="1901"/> 1901: ok.
<a name="1902"/> 1902: 
<a name="1903"/> 1903: <i>%% List comprehension examples from Programming Examples. OTP-5237.</i>
<a name="progex_lc-1"/><a name="1904"/> 1904: <b>progex_lc</b>(Config) when is_list(Config) -&gt;
<a name="1905"/> 1905:     Test1 = 
<a name="1906"/> 1906: 	&lt;&lt;&quot;-module(lc).
<a name="1907"/> 1907:           -export([t/0]).
<a name="1908"/> 1908: 
<a name="1909"/> 1909: t() -&gt;
<a name="1910"/> 1910:     [a,4,b,5,6] = [X || X &lt;- [1,2,a,3,4,b,5,6], X &gt; 3],
<a name="1911"/> 1911:     [4,5,6] = [X || X &lt;- [1,2,a,3,4,b,5,6], integer(X), X &gt; 3],
<a name="1912"/> 1912:     [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] =
<a name="1913"/> 1913: 	[{X, Y} || X &lt;- [1,2,3], Y &lt;- [a,b]],
<a name="1914"/> 1914: 
<a name="1915"/> 1915:     [1,2,3,4,5,6,7,8] = sort([4,5,1,8,3,6,7,2]),
<a name="1916"/> 1916:     [[b,u,g],[b,g,u],[u,b,g],[u,g,b],[g,b,u],[g,u,b]] =
<a name="1917"/> 1917: 	perms([b,u,g]),
<a name="1918"/> 1918:     [] = pyth(11),
<a name="1919"/> 1919:     [{3,4,5},{4,3,5}] = pyth(12),
<a name="1920"/> 1920:     [{3,4,5},{4,3,5},{5,12,13},{6,8,10},{8,6,10},{8,15,17},
<a name="1921"/> 1921:      {9,12,15},{12,5,13},{12,9,15},{12,16,20},{15,8,17},
<a name="1922"/> 1922:      {16,12,20}] = pyth(50),
<a name="1923"/> 1923:     [] = pyth1(11),
<a name="1924"/> 1924:     [{3,4,5},{4,3,5}] = pyth1(12),
<a name="1925"/> 1925:     [{3,4,5},{4,3,5},{5,12,13},{6,8,10},{8,6,10},{8,15,17},
<a name="1926"/> 1926:      {9,12,15},{12,5,13},{12,9,15},{12,16,20},{15,8,17},
<a name="1927"/> 1927:      {16,12,20}] = pyth1(50),
<a name="1928"/> 1928:     [1,2,3,4,5] = append([[1,2,3],[4,5]]),
<a name="1929"/> 1929:     [2,3,4] = map(fun(X) -&gt; X + 1 end, [1,2,3]),
<a name="1930"/> 1930:     [2,4] = filter(fun(X) -&gt; X &gt; 1 end, [0,2,4]),
<a name="1931"/> 1931:     [1,2,3,7] = select(b,[{a,1},{b,2},{c,3},{b,7}]),
<a name="1932"/> 1932:     [2,7] = select2(b,[{a,1},{b,2},{c,3},{b,7}]),
<a name="1933"/> 1933:     ok.
<a name="1934"/> 1934: 
<a name="1935"/> 1935: sort([Pivot|T]) -&gt;
<a name="1936"/> 1936:     sort([ X || X &lt;- T, X &lt; Pivot]) ++
<a name="1937"/> 1937: 	[Pivot] ++
<a name="1938"/> 1938: 	sort([ X || X &lt;- T, X &gt;= Pivot]);
<a name="1939"/> 1939: sort([]) -&gt; [].
<a name="1940"/> 1940: 
<a name="1941"/> 1941: perms([]) -&gt; [[]];
<a name="1942"/> 1942: perms(L)  -&gt; [[H|T] || H &lt;- L, T &lt;- perms(L--[H])].
<a name="1943"/> 1943: 
<a name="1944"/> 1944: pyth(N) -&gt;
<a name="1945"/> 1945:     [ {A,B,C} ||
<a name="1946"/> 1946: 	A &lt;- lists:seq(1,N),
<a name="1947"/> 1947: 	B &lt;- lists:seq(1,N),
<a name="1948"/> 1948: 	C &lt;- lists:seq(1,N),
<a name="1949"/> 1949: 	A+B+C =&lt; N,
<a name="1950"/> 1950: 	A*A+B*B == C*C
<a name="1951"/> 1951:     ].
<a name="1952"/> 1952: 
<a name="1953"/> 1953: pyth1(N) -&gt;
<a name="1954"/> 1954:     [{A,B,C} ||
<a name="1955"/> 1955: 	A &lt;- lists:seq(1,N),
<a name="1956"/> 1956: 	B &lt;- lists:seq(1,N-A+1),
<a name="1957"/> 1957: 	C &lt;- lists:seq(1,N-A-B+2),
<a name="1958"/> 1958: 	A+B+C =&lt; N,
<a name="1959"/> 1959: 	A*A+B*B == C*C ].
<a name="1960"/> 1960: 
<a name="1961"/> 1961: append(L)   -&gt;  [X || L1 &lt;- L, X &lt;- L1].
<a name="1962"/> 1962: map(Fun, L) -&gt; [Fun(X) || X &lt;- L].
<a name="1963"/> 1963: filter(Pred, L) -&gt; [X || X &lt;- L, Pred(X)].
<a name="1964"/> 1964: 
<a name="1965"/> 1965: select(X, L) -&gt;  [Y || {X, Y} &lt;- L].
<a name="1966"/> 1966: select2(X, L) -&gt;  [Y || {X1, Y} &lt;- L, X == X1].
<a name="1967"/> 1967: &quot;&gt;&gt;,
<a name="1968"/> 1968:     ok = run_file(Config, lc, Test1),
<a name="1969"/> 1969: 
<a name="1970"/> 1970: Test1_shell =
<a name="1971"/> 1971: &lt;&lt;&quot;[a,4,b,5,6] = [X || X &lt;- [1,2,a,3,4,b,5,6], X &gt; 3],
<a name="1972"/> 1972:           [4,5,6] = [X || X &lt;- [1,2,a,3,4,b,5,6], integer(X), X &gt; 3],
<a name="1973"/> 1973:   [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] =
<a name="1974"/> 1974:   [{X, Y} || X &lt;- [1,2,3], Y &lt;- [a,b]],
<a name="1975"/> 1975: 
<a name="1976"/> 1976:   Sort = fun([Pivot|T], Fn) -&gt;
<a name="1977"/> 1977: 		 Fn([ X || X &lt;- T, X &lt; Pivot], Fn) ++
<a name="1978"/> 1978: 		     [Pivot] ++
<a name="1979"/> 1979: 		     Fn([ X || X &lt;- T, X &gt;= Pivot], Fn);
<a name="1980"/> 1980: 	    ([], _Fn) -&gt; []
<a name="1981"/> 1981: 	 end,
<a name="1982"/> 1982: 
<a name="1983"/> 1983:   [1,2,3,4,5,6,7,8] = Sort([4,5,1,8,3,6,7,2], Sort),
<a name="1984"/> 1984:   Perms = fun([], _Fn) -&gt; [[]];
<a name="1985"/> 1985: 	     (L, Fn)  -&gt; [[H|T] || H &lt;- L, T &lt;- Fn(L--[H], Fn)]
<a name="1986"/> 1986: 	  end,
<a name="1987"/> 1987:   [[b,u,g],[b,g,u],[u,b,g],[u,g,b],[g,b,u],[g,u,b]] =
<a name="1988"/> 1988:   Perms([b,u,g], Perms),
<a name="1989"/> 1989: 
<a name="1990"/> 1990:   Pyth = fun(N) -&gt;
<a name="1991"/> 1991: 		 [ {A,B,C} ||
<a name="1992"/> 1992: 		     A &lt;- lists:seq(1,N),
<a name="1993"/> 1993: 		     B &lt;- lists:seq(1,N),
<a name="1994"/> 1994: 		     C &lt;- lists:seq(1,N),
<a name="1995"/> 1995: 		     A+B+C =&lt; N,
<a name="1996"/> 1996: 		     A*A+B*B == C*C
<a name="1997"/> 1997: 		 ]
<a name="1998"/> 1998: 	 end,
<a name="1999"/> 1999: 
<a name="2000"/> 2000:   [] = Pyth(11),
<a name="2001"/> 2001:   [{3,4,5},{4,3,5}] = Pyth(12),
<a name="2002"/> 2002: <i>%%[{3,4,5},{4,3,5},{5,12,13},{6,8,10},{8,6,10},{8,15,17},</i>
<a name="2003"/> 2003: <i>%% {9,12,15},{12,5,13},{12,9,15},{12,16,20},{15,8,17},</i>
<a name="2004"/> 2004: <i>%% {16,12,20}] = Pyth(50),</i>
<a name="2005"/> 2005: 
<a name="2006"/> 2006:   Pyth1 = fun(N) -&gt;
<a name="2007"/> 2007: 		  [{A,B,C} ||
<a name="2008"/> 2008: 		      A &lt;- lists:seq(1,N),
<a name="2009"/> 2009: 		      B &lt;- lists:seq(1,N-A+1),
<a name="2010"/> 2010: 		      C &lt;- lists:seq(1,N-A-B+2),
<a name="2011"/> 2011: 		      A+B+C =&lt; N,
<a name="2012"/> 2012: 		      A*A+B*B == C*C ]
<a name="2013"/> 2013: 	  end,
<a name="2014"/> 2014: 
<a name="2015"/> 2015:   [] = Pyth1(11),
<a name="2016"/> 2016:   [{3,4,5},{4,3,5}] = Pyth1(12),
<a name="2017"/> 2017:   [{3,4,5},{4,3,5},{5,12,13},{6,8,10},{8,6,10},{8,15,17},
<a name="2018"/> 2018:    {9,12,15},{12,5,13},{12,9,15},{12,16,20},{15,8,17},
<a name="2019"/> 2019:    {16,12,20}] = Pyth1(50),
<a name="2020"/> 2020: 
<a name="2021"/> 2021:   Append = fun(L)   -&gt;  [X || L1 &lt;- L, X &lt;- L1] end,
<a name="2022"/> 2022:   [1,2,3,4,5] = Append([[1,2,3],[4,5]]),
<a name="2023"/> 2023:   Map = fun(Fun, L) -&gt; [Fun(X) || X &lt;- L] end,
<a name="2024"/> 2024:   [2,3,4] = Map(fun(X) -&gt; X + 1 end, [1,2,3]),
<a name="2025"/> 2025:   Filter = fun(Pred, L) -&gt; [X || X &lt;- L, Pred(X)] end,
<a name="2026"/> 2026:   [2,4] = Filter(fun(X) -&gt; X &gt; 1 end, [0,2,4]),
<a name="2027"/> 2027: 
<a name="2028"/> 2028:   Select = fun(X, L) -&gt;  [Y || {X, Y} &lt;- L] end,
<a name="2029"/> 2029:   [1,2,3,7] = Select(b,[{a,1},{b,2},{c,3},{b,7}]),
<a name="2030"/> 2030:   Select2 = fun(X, L) -&gt;  [Y || {X1, Y} &lt;- L, X == X1] end,
<a name="2031"/> 2031:   [2,7] = Select2(b,[{a,1},{b,2},{c,3},{b,7}]),
<a name="2032"/> 2032:   ok.
<a name="2033"/> 2033: &quot;&gt;&gt;,
<a name="2034"/> 2034:     [ok] = scan(Test1_shell),
<a name="progex_lc-last_expr"/><a name="2035"/> 2035: ok.
<a name="2036"/> 2036: 
<a name="2037"/> 2037: <i>%% Funs examples from Programming Examples. OTP-5237.</i>
<a name="progex_funs-1"/><a name="2038"/> 2038: <b>progex_funs</b>(Config) when is_list(Config) -&gt;
<a name="2039"/> 2039:     Test1 = 
<a name="2040"/> 2040: 	&lt;&lt;&quot;-module(funs).
<a name="2041"/> 2041:           -export([t/0]).
<a name="2042"/> 2042: 
<a name="2043"/> 2043: double([H|T]) -&gt; [2*H|double(T)];
<a name="2044"/> 2044: double([])    -&gt; [].
<a name="2045"/> 2045: 
<a name="2046"/> 2046: add_one([H|T]) -&gt; [H+1|add_one(T)];
<a name="2047"/> 2047: add_one([])    -&gt; [].
<a name="2048"/> 2048: 
<a name="2049"/> 2049: map(F, [H|T]) -&gt; [F(H)|map(F, T)];
<a name="2050"/> 2050: map(F, [])    -&gt; [].
<a name="2051"/> 2051: 
<a name="2052"/> 2052: double2(L)  -&gt; map(fun(X) -&gt; 2*X end, L).
<a name="2053"/> 2053: add_one2(L) -&gt; map(fun(X) -&gt; 1 + X end, L).
<a name="2054"/> 2054: 
<a name="2055"/> 2055: print_list(Stream, [H|T]) -&gt;
<a name="2056"/> 2056:     io:format(Stream, \&quot;~p~n\&quot;, [H]),
<a name="2057"/> 2057:               print_list(Stream, T);
<a name="2058"/> 2058: 		  print_list(Stream, []) -&gt;
<a name="2059"/> 2059: 		     true.
<a name="2060"/> 2060: 
<a name="2061"/> 2061: broadcast(Msg, [Pid|Pids]) -&gt;
<a name="2062"/> 2062:     Pid ! Msg,
<a name="2063"/> 2063:     broadcast(Msg, Pids);
<a name="2064"/> 2064: broadcast(_, []) -&gt;
<a name="2065"/> 2065:     true.
<a name="2066"/> 2066: 
<a name="2067"/> 2067: foreach(F, [H|T]) -&gt;
<a name="2068"/> 2068:     F(H),
<a name="2069"/> 2069:     foreach(F, T);
<a name="2070"/> 2070: foreach(F, []) -&gt;
<a name="2071"/> 2071:     ok.
<a name="2072"/> 2072: 
<a name="2073"/> 2073: print_list2(S, L) -&gt;
<a name="2074"/> 2074:     foreach(fun(H) -&gt; io:format(S, \&quot;~p~n\&quot;,[H]) end, L).
<a name="2075"/> 2075: 
<a name="2076"/> 2076:           broadcast2(M, L) -&gt; foreach(fun(Pid) -&gt; Pid ! M end, L).
<a name="2077"/> 2077: 
<a name="2078"/> 2078: t1() -&gt; map(fun(X) -&gt; 2 * X end, [1,2,3,4,5]).
<a name="2079"/> 2079: 
<a name="2080"/> 2080: t2() -&gt; map(fun double/1, [1,2,3,4,5]).
<a name="2081"/> 2081: 
<a name="2082"/> 2082: t3() -&gt; map({?MODULE, double3}, [1,2,3,4,5]).
<a name="2083"/> 2083: 
<a name="2084"/> 2084: double3(X) -&gt; X * 2.
<a name="2085"/> 2085: 
<a name="2086"/> 2086: f(F, Args) when function(F) -&gt;
<a name="2087"/> 2087:     apply(F, Args);
<a name="2088"/> 2088: f(N, _) when integer(N) -&gt;
<a name="2089"/> 2089:     N.
<a name="2090"/> 2090: 
<a name="2091"/> 2091: print_list3(File, List) -&gt;
<a name="2092"/> 2092:     {ok, Stream} = file:open(File, write),
<a name="2093"/> 2093:     foreach(fun(X) -&gt; io:format(Stream,\&quot;~p~n\&quot;,[X]) end, List),
<a name="2094"/> 2094:               file:close(Stream).
<a name="2095"/> 2095: 
<a name="2096"/> 2096: print_list4(File, List) -&gt;
<a name="2097"/> 2097:     {ok, Stream} = file:open(File, write),
<a name="2098"/> 2098:     foreach(fun(File) -&gt;
<a name="2099"/> 2099: 		    io:format(Stream,\&quot;~p~n\&quot;,[File])
<a name="2100"/> 2100:                       end, List),
<a name="2101"/> 2101: 		    file:close(Stream).
<a name="2102"/> 2102: 
<a name="2103"/> 2103: any(Pred, [H|T]) -&gt;
<a name="2104"/> 2104:     case Pred(H) of
<a name="2105"/> 2105: 	true  -&gt;  true;
<a name="2106"/> 2106: 	false -&gt;  any(Pred, T)
<a name="2107"/> 2107:     end;
<a name="2108"/> 2108: any(Pred, []) -&gt;
<a name="2109"/> 2109:     false.
<a name="2110"/> 2110: 
<a name="2111"/> 2111: all(Pred, [H|T]) -&gt;
<a name="2112"/> 2112:     case Pred(H) of
<a name="2113"/> 2113: 	true  -&gt;  all(Pred, T);
<a name="2114"/> 2114: 	false -&gt;  false
<a name="2115"/> 2115:     end;
<a name="2116"/> 2116: all(Pred, []) -&gt;
<a name="2117"/> 2117:     true.
<a name="2118"/> 2118: 
<a name="2119"/> 2119: foldl(F, Accu, [Hd|Tail]) -&gt;
<a name="2120"/> 2120:     foldl(F, F(Hd, Accu), Tail);
<a name="2121"/> 2121: foldl(F, Accu, []) -&gt; Accu.
<a name="2122"/> 2122: 
<a name="2123"/> 2123: mapfoldl(F, Accu0, [Hd|Tail]) -&gt;
<a name="2124"/> 2124:     {R,Accu1} = F(Hd, Accu0),
<a name="2125"/> 2125:     {Rs,Accu2} = mapfoldl(F, Accu1, Tail),
<a name="2126"/> 2126:     {[R|Rs], Accu2};
<a name="2127"/> 2127: mapfoldl(F, Accu, []) -&gt; {[], Accu}.
<a name="2128"/> 2128: 
<a name="2129"/> 2129: filter(F, [H|T]) -&gt;
<a name="2130"/> 2130:     case F(H) of
<a name="2131"/> 2131: 	true  -&gt; [H|filter(F, T)];
<a name="2132"/> 2132: 	false -&gt; filter(F, T)
<a name="2133"/> 2133:     end;
<a name="2134"/> 2134: filter(F, []) -&gt; [].
<a name="2135"/> 2135: 
<a name="2136"/> 2136: diff(L1, L2) -&gt;
<a name="2137"/> 2137:     filter(fun(X) -&gt; not lists:member(X, L2) end, L1).
<a name="2138"/> 2138: 
<a name="2139"/> 2139: intersection(L1,L2) -&gt; filter(fun(X) -&gt; lists:member(X,L1) end, L2).
<a name="2140"/> 2140: 
<a name="2141"/> 2141: takewhile(Pred, [H|T]) -&gt;
<a name="2142"/> 2142:     case Pred(H) of
<a name="2143"/> 2143: 	true  -&gt; [H|takewhile(Pred, T)];
<a name="2144"/> 2144: 	false -&gt; []
<a name="2145"/> 2145:     end;
<a name="2146"/> 2146: takewhile(Pred, []) -&gt;
<a name="2147"/> 2147:     [].
<a name="2148"/> 2148: 
<a name="2149"/> 2149: dropwhile(Pred, [H|T]) -&gt;
<a name="2150"/> 2150:     case Pred(H) of
<a name="2151"/> 2151: 	true  -&gt; dropwhile(Pred, T);
<a name="2152"/> 2152: 	false -&gt; [H|T]
<a name="2153"/> 2153:     end;
<a name="2154"/> 2154: dropwhile(Pred, []) -&gt;
<a name="2155"/> 2155:     [].
<a name="2156"/> 2156: 
<a name="2157"/> 2157: splitlist(Pred, L) -&gt;
<a name="2158"/> 2158:     splitlist(Pred, L, []).
<a name="2159"/> 2159: 
<a name="2160"/> 2160: splitlist(Pred, [H|T], L) -&gt;
<a name="2161"/> 2161:     case Pred(H) of
<a name="2162"/> 2162: 	true  -&gt; splitlist(Pred, T, [H|L]);
<a name="2163"/> 2163: 	false -&gt; {lists:reverse(L), [H|T]}
<a name="2164"/> 2164:     end;
<a name="2165"/> 2165: splitlist(Pred, [], L) -&gt;
<a name="2166"/> 2166:     {lists:reverse(L), []}.
<a name="2167"/> 2167: 
<a name="2168"/> 2168: first(Pred, [H|T]) -&gt;
<a name="2169"/> 2169:     case Pred(H) of
<a name="2170"/> 2170: 	true -&gt;
<a name="2171"/> 2171: 	    {true, H};
<a name="2172"/> 2172: 	false -&gt;
<a name="2173"/> 2173: 	    first(Pred, T)
<a name="2174"/> 2174:     end;
<a name="2175"/> 2175: first(Pred, []) -&gt;
<a name="2176"/> 2176:     false.
<a name="2177"/> 2177: 
<a name="2178"/> 2178: ints_from(N) -&gt;
<a name="2179"/> 2179:     fun() -&gt;
<a name="2180"/> 2180: 	    [N|ints_from(N+1)]
<a name="2181"/> 2181:     end.
<a name="2182"/> 2182: 
<a name="2183"/> 2183: pconst(X) -&gt;
<a name="2184"/> 2184:     fun (T) -&gt;
<a name="2185"/> 2185: 	    case T of
<a name="2186"/> 2186: 		[X|T1] -&gt; {ok, {const, X}, T1};
<a name="2187"/> 2187: 		_      -&gt; fail
<a name="2188"/> 2188: 	    end
<a name="2189"/> 2189:     end.
<a name="2190"/> 2190: 
<a name="2191"/> 2191: pand(P1, P2) -&gt;
<a name="2192"/> 2192:     fun (T) -&gt;
<a name="2193"/> 2193: 	    case P1(T) of
<a name="2194"/> 2194: 		{ok, R1, T1} -&gt;
<a name="2195"/> 2195: 		    case P2(T1) of
<a name="2196"/> 2196: 			{ok, R2, T2} -&gt;
<a name="2197"/> 2197: 			    {ok, {'and', R1, R2}};
<a name="2198"/> 2198: 			fail -&gt;
<a name="2199"/> 2199: 			    fail
<a name="2200"/> 2200: 		    end;
<a name="2201"/> 2201: 		fail -&gt;
<a name="2202"/> 2202: 		    fail
<a name="2203"/> 2203: 	    end
<a name="2204"/> 2204:     end.
<a name="2205"/> 2205: 
<a name="2206"/> 2206: por(P1, P2) -&gt;
<a name="2207"/> 2207:     fun (T) -&gt;
<a name="2208"/> 2208: 	    case P1(T) of
<a name="2209"/> 2209: 		{ok, R, T1} -&gt;
<a name="2210"/> 2210: 		    {ok, {'or',1,R}, T1};
<a name="2211"/> 2211: 		fail -&gt;
<a name="2212"/> 2212: 		    case P2(T) of
<a name="2213"/> 2213: 			{ok, R1, T1} -&gt;
<a name="2214"/> 2214: 			    {ok, {'or',2,R1}, T1};
<a name="2215"/> 2215: 			fail -&gt;
<a name="2216"/> 2216: 			    fail
<a name="2217"/> 2217: 		    end
<a name="2218"/> 2218: 	    end
<a name="2219"/> 2219:     end.
<a name="2220"/> 2220: 
<a name="2221"/> 2221: grammar() -&gt;
<a name="2222"/> 2222:     pand(
<a name="2223"/> 2223:       por(pconst(a), pconst(b)),
<a name="2224"/> 2224:       por(pconst(c), pconst(d))).
<a name="2225"/> 2225: 
<a name="2226"/> 2226: parse(List) -&gt;
<a name="2227"/> 2227:     (grammar())(List).
<a name="2228"/> 2228: 
<a name="2229"/> 2229: 
<a name="2230"/> 2230: t() -&gt;
<a name="2231"/> 2231:     [2,4,6,8] = double([1,2,3,4]),
<a name="2232"/> 2232:     [2,3,4,5] = add_one([1,2,3,4]),
<a name="2233"/> 2233:     [2,4,6,8] = double2([1,2,3,4]),
<a name="2234"/> 2234:     [2,3,4,5] = add_one2([1,2,3,4]),
<a name="2235"/> 2235:     XX = ints_from(1),
<a name="2236"/> 2236:     [1 | _] = XX(),
<a name="2237"/> 2237:     1 = hd(XX()),
<a name="2238"/> 2238:     Y = tl(XX()),
<a name="2239"/> 2239:     2 = hd(Y()),
<a name="2240"/> 2240: 
<a name="2241"/> 2241:     P1 = pconst(a),
<a name="2242"/> 2242:     {ok,{const,a},[b,c]} = P1([a,b,c]),
<a name="2243"/> 2243:     fail = P1([x,y,z]),
<a name="2244"/> 2244: 
<a name="2245"/> 2245:     {ok,{'and',{'or',1,{const,a}},{'or',1,{const,c}}}} =
<a name="2246"/> 2246: 	parse([a,c]),
<a name="2247"/> 2247:     {ok,{'and',{'or',1,{const,a}},{'or',2,{const,d}}}} =
<a name="2248"/> 2248: 	parse([a,d]),
<a name="2249"/> 2249:     {ok,{'and',{'or',2,{const,b}},{'or',1,{const,c}}}} =
<a name="2250"/> 2250: 	parse([b,c]),
<a name="2251"/> 2251:     {ok,{'and',{'or',2,{const,b}},{'or',2,{const,d}}}} =
<a name="2252"/> 2252: 	parse([b,d]),
<a name="2253"/> 2253:     fail = parse([a,b]),
<a name="2254"/> 2254:     ok.
<a name="2255"/> 2255: &quot;&gt;&gt;,
<a name="2256"/> 2256:     ok = run_file(Config, funs, Test1),
<a name="2257"/> 2257: 
<a name="2258"/> 2258: Test2_shell =
<a name="2259"/> 2259: &lt;&lt;&quot;Double = fun(X) -&gt; 2 * X end,
<a name="2260"/> 2260:           [2,4,6,8,10] = lists:map(Double, [1,2,3,4,5]),
<a name="2261"/> 2261: 
<a name="2262"/> 2262:   Big =  fun(X) -&gt; if X &gt; 10 -&gt; true; true -&gt; false end end,
<a name="2263"/> 2263:   false = lists:any(Big, [1,2,3,4]),
<a name="2264"/> 2264:   true = lists:any(Big, [1,2,3,12,5]),
<a name="2265"/> 2265:   false = lists:all(Big, [1,2,3,4,12,6]),
<a name="2266"/> 2266:   true = lists:all(Big, [12,13,14,15]),
<a name="2267"/> 2267:   L = [\&quot;I\&quot;,\&quot;like\&quot;,\&quot;Erlang\&quot;],
<a name="2268"/> 2268:           11 = lists:foldl(fun(X, Sum) -&gt; length(X) + Sum end, 0, L),
<a name="2269"/> 2269:        Upcase =  fun(X) when $a =&lt; X,  X =&lt; $z -&gt; X + $A - $a;
<a name="2270"/> 2270: 		    (X) -&gt; X
<a name="2271"/> 2271: 		 end,
<a name="2272"/> 2272:        Upcase_word = fun(X) -&gt; lists:map(Upcase, X) end,
<a name="2273"/> 2273:        \&quot;ERLANG\&quot; = Upcase_word(\&quot;Erlang\&quot;),
<a name="2274"/> 2274:           [\&quot;I\&quot;,\&quot;LIKE\&quot;,\&quot;ERLANG\&quot;] = lists:map(Upcase_word, L),
<a name="2275"/> 2275:           {[\&quot;I\&quot;,\&quot;LIKE\&quot;,\&quot;ERLANG\&quot;],11} =
<a name="2276"/> 2276:                lists:mapfoldl(fun(Word, Sum) -&gt; 
<a name="2277"/> 2277: 				      {Upcase_word(Word), Sum + length(Word)}
<a name="2278"/> 2278:                               end, 0, L),
<a name="2279"/> 2279: 	    [500,12,45] = lists:filter(Big, [500,12,2,45,6,7]),
<a name="2280"/> 2280: 	    [200,500,45] = lists:takewhile(Big, [200,500,45,5,3,45,6]),
<a name="2281"/> 2281: 	    [5,3,45,6] = lists:dropwhile(Big, [200,500,45,5,3,45,6]),
<a name="2282"/> 2282: 	    {[200,500,45],[5,3,45,6]} =
<a name="2283"/> 2283: 		lists:splitwith(Big, [200,500,45,5,3,45,6]),
<a name="2284"/> 2284:           %% {true,45} = lists:first(Big, [1,2,45,6,123]),
<a name="2285"/> 2285:           %% false = lists:first(Big, [1,2,4,5]),
<a name="2286"/> 2286: 
<a name="2287"/> 2287: 	    Adder = fun(X) -&gt; fun(Y) -&gt; X + Y end end,
<a name="2288"/> 2288: 	    Add6 = Adder(6),
<a name="2289"/> 2289: 	    16 = Add6(10),
<a name="2290"/> 2290: 	    ok.
<a name="2291"/> 2291: &quot;&gt;&gt;,
<a name="2292"/> 2292:     [ok] = scan(Test2_shell),
<a name="progex_funs-last_expr"/><a name="2293"/> 2293: ok.
<a name="2294"/> 2294: 
<a name="2295"/> 2295: 
<a name="2296"/> 2296: <i>%% OTP-5990. {erlang,is_record}.</i>
<a name="otp_5990-1"/><a name="2297"/> 2297: <b>otp_5990</b>(Config) when is_list(Config) -&gt;
<a name="2298"/> 2298:     [true] =
<a name="2299"/> 2299:         scan(&lt;&lt;&quot;rd('OrdSet', {orddata = {},ordtype = type}), &quot;
<a name="2300"/> 2300:                &quot;S = #'OrdSet'{ordtype = {}}, &quot;
<a name="2301"/> 2301:                &quot;if tuple(S#'OrdSet'.ordtype) -&gt; true; true -&gt; false end.&quot;&gt;&gt;),
<a name="otp_5990-last_expr"/><a name="2302"/> 2302:     ok.
<a name="2303"/> 2303: 
<a name="2304"/> 2304: <i>%% OTP-6166. Order of record definitions.</i>
<a name="otp_6166-1"/><a name="2305"/> 2305: <b>otp_6166</b>(Config) when is_list(Config) -&gt;
<a name="2306"/> 2306:     Test1 = filename:join(proplists:get_value(priv_dir, Config), &quot;test1.hrl&quot;),
<a name="2307"/> 2307:     Contents1 = &lt;&lt;&quot;-module(test1).
<a name="2308"/> 2308:                    -record(r5, {f}). -record(r3, {f = #r5{}}). &quot;
<a name="2309"/> 2309:                   &quot;-record(r1, {f = #r3{}}). -record(r4, {f = #r1{}}). &quot;
<a name="2310"/> 2310: &quot;-record(r2, {f = #r4{}}).&quot;&gt;&gt;,
<a name="2311"/> 2311:     ok = file:write_file(Test1, Contents1),
<a name="2312"/> 2312: 
<a name="2313"/> 2313:     Test2 = filename:join(proplists:get_value(priv_dir, Config), &quot;test2.hrl&quot;),
<a name="2314"/> 2314:     Contents2 = &lt;&lt;&quot;-module(test2).
<a name="2315"/> 2315:                    -record(r5, {f}). -record(r3, {f = #r5{}}). &quot;
<a name="2316"/> 2316:                   &quot;-record(r1, {f = #r3{}}). -record(r4, {f = #r1{}}). &quot;
<a name="2317"/> 2317:                   &quot;-record(r2, {f = #r4{}}).
<a name="2318"/> 2318:                    -record(r6, {f = #r5{}}).            % r6 &gt; r0
<a name="2319"/> 2319:                    -record(r0, {f = #r5{}, g = #r5{}}). % r0 &lt; r5&quot;&gt;&gt;,
<a name="2320"/> 2320:     ok = file:write_file(Test2, Contents2),
<a name="2321"/> 2321:     
<a name="2322"/> 2322:     RR12 = &quot;[r1,r2,r3,r4,r5] = rr(\&quot;&quot; ++ Test1 ++ &quot;\&quot;), 
<a name="2323"/> 2323:             [r0,r1,r2,r3,r4,r5,r6] = rr(\&quot;&quot; ++ Test2 ++ &quot;\&quot;), 
<a name="2324"/> 2324:             R0 = #r0{}, R6 = #r6{}, 
<a name="2325"/> 2325:             true = is_record(R0, r0),
<a name="2326"/> 2326:             true = is_record(R6, r6),
<a name="2327"/> 2327:             ok. &quot;,
<a name="2328"/> 2328:     [ok] = scan(RR12),
<a name="2329"/> 2329: 
<a name="2330"/> 2330:     file:delete(Test1),
<a name="2331"/> 2331:     file:delete(Test2),
<a name="otp_6166-last_expr"/><a name="2332"/> 2332:     ok.
<a name="2333"/> 2333: 
<a name="2334"/> 2334: <i>%% OTP-6554. Formatted exits and error messages.</i>
<a name="otp_6554-1"/><a name="2335"/> 2335: <b>otp_6554</b>(Config) when is_list(Config) -&gt;
<a name="2336"/> 2336:     %% Should check the stacktrace as well...
<a name="2337"/> 2337:     &quot;exception error: bad argument&quot; =
<a name="2338"/> 2338:         comm_err(&lt;&lt;&quot;math:sqrt(a).&quot;&gt;&gt;),
<a name="2339"/> 2339:     &quot;exception error: bad argument&quot; =
<a name="2340"/> 2340:         comm_err(&lt;&lt;&quot;fun(X, Y) -&gt; X ++ Y end(a, b).&quot;&gt;&gt;),
<a name="2341"/> 2341:     &quot;exception error: bad argument&quot; =
<a name="2342"/> 2342:         comm_err(&lt;&lt;&quot;math:sqrt(lists:seq(1,40)).&quot;&gt;&gt;),
<a name="2343"/> 2343:     &quot;exception error: bad argument&quot; =
<a name="2344"/> 2344:         comm_err(&lt;&lt;&quot;math:sqrt(lists:seq(1,10)).&quot;&gt;&gt;),
<a name="2345"/> 2345:     &quot;exception error: bad argument&quot; =
<a name="2346"/> 2346:         comm_err(&lt;&lt;&quot;a ++ b.&quot;&gt;&gt;),
<a name="2347"/> 2347:     &quot;exception error: bad argument&quot; =
<a name="2348"/> 2348:         comm_err(&lt;&lt;&quot;I = {file_info,undefined,undefined,undefined,undefined,
<a name="2349"/> 2349:                          undefined,undefined,undefined,undefined,undefined,
<a name="2350"/> 2350:                          undefined,undefined,undefined,undefined},
<a name="2351"/> 2351:                     aa ++ I.&quot;&gt;&gt;),
<a name="2352"/> 2352:     &quot;exception error: bad argument&quot; =
<a name="2353"/> 2353:         comm_err(&lt;&lt;&quot;I = {file_info,undefined,undefined,undefined,undefined,
<a name="2354"/> 2354:                          undefined,undefined,undefined,undefined,undefined,
<a name="2355"/> 2355:                          undefined,undefined,undefined,undefined},
<a name="2356"/> 2356:                     aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa ++ I.&quot;&gt;&gt;),
<a name="2357"/> 2357:     &quot;exception error: bad argument&quot; =
<a name="2358"/> 2358:         comm_err(&lt;&lt;&quot;I = {file_info,undefined,undefined,undefined,undefined,
<a name="2359"/> 2359:                          undefined,undefined,undefined,undefined,undefined,
<a name="2360"/> 2360:                          undefined,undefined,undefined,undefined},
<a name="2361"/> 2361:                     I ++ I.&quot;&gt;&gt;),
<a name="2362"/> 2362:     &quot;exception error: bad argument&quot; =
<a name="2363"/> 2363:         comm_err(&lt;&lt;&quot;fun(X) -&gt; not X end(a).&quot;&gt;&gt;),
<a name="2364"/> 2364:     &quot;exception error: bad argument: a&quot; =
<a name="2365"/> 2365:         comm_err(&lt;&lt;&quot;fun(A, B) -&gt; A orelse B end(a, b).&quot;&gt;&gt;),
<a name="2366"/> 2366:     &quot;exception error: bad key: key&quot; =
<a name="2367"/> 2367:         comm_err(&lt;&lt;&quot;map_get(key, #{}).&quot;&gt;&gt;),
<a name="2368"/> 2368:     &quot;exception error: bad map: not_a_map&quot; =
<a name="2369"/> 2369:         comm_err(&lt;&lt;&quot;map_get(key, not_a_map).&quot;&gt;&gt;),
<a name="2370"/> 2370:     &quot;exception error: an error occurred when evaluating an arithmetic expression&quot; =
<a name="2371"/> 2371:         comm_err(&lt;&lt;&quot;math:sqrt(2)/round(math:sqrt(0)).&quot;&gt;&gt;),
<a name="2372"/> 2372:     &quot;exception error: interpreted function with arity 1 called with no arguments&quot; =
<a name="2373"/> 2373:         comm_err(&lt;&lt;&quot;fun(V) -&gt; V end().&quot;&gt;&gt;),
<a name="2374"/> 2374:     &quot;exception error: interpreted function with arity 1 called with two arguments&quot; =
<a name="2375"/> 2375:         comm_err(&lt;&lt;&quot;fun(V) -&gt; V end(1,2).&quot;&gt;&gt;),
<a name="2376"/> 2376:     &quot;exception error: interpreted function with arity 0 called with one argument&quot; =
<a name="2377"/> 2377:         comm_err(&lt;&lt;&quot;fun() -&gt; v end(1).&quot;&gt;&gt;),
<a name="2378"/> 2378:     &quot;exception error: interpreted function with arity 0 called with 4 arguments&quot; =
<a name="2379"/> 2379:         comm_err(&lt;&lt;&quot;fun() -&gt; v end(1,2,3,4).&quot;&gt;&gt;),
<a name="2380"/> 2380:     &quot;exception error: math:sqrt/1 called with two arguments&quot; =
<a name="2381"/> 2381:         comm_err(&lt;&lt;&quot;fun math:sqrt/1(1,2).&quot;&gt;&gt;),
<a name="2382"/> 2382:     &quot;exception error: bad function 1.&quot; ++ _ =
<a name="2383"/> 2383:         comm_err(&lt;&lt;&quot;(math:sqrt(2))().&quot;&gt;&gt;),
<a name="2384"/> 2384:     &quot;exception error: bad function [1,&quot; ++ _ =
<a name="2385"/> 2385:         comm_err(&lt;&lt;&quot;(lists:seq(1, 100))().&quot;&gt;&gt;),
<a name="2386"/> 2386:     &quot;exception error: no match of right hand side value 1&quot; ++ _ =
<a name="2387"/> 2387:         comm_err(&lt;&lt;&quot;a = math:sqrt(2).&quot;&gt;&gt;),
<a name="2388"/> 2388:     &quot;exception error: no match of right hand side value&quot; ++ _ =
<a name="2389"/> 2389:         comm_err(&lt;&lt;&quot;I = {file_info,undefined,undefined,undefined,undefined,
<a name="2390"/> 2390:                          undefined,undefined,undefined,undefined,undefined,
<a name="2391"/> 2391:                          undefined,undefined,undefined,undefined},
<a name="2392"/> 2392:                     a = I.&quot;&gt;&gt;),
<a name="2393"/> 2393:     &quot;exception error: no case clause matching 1&quot; ++ _ =
<a name="2394"/> 2394:         comm_err(&lt;&lt;&quot;case math:sqrt(2) of a -&gt; ok end.&quot;&gt;&gt;),
<a name="2395"/> 2395:     &quot;exception error: no case clause matching [1,&quot; ++ _ =
<a name="2396"/> 2396:         comm_err(&lt;&lt;&quot;V = lists:seq(1, 20), case V of a -&gt; ok end.&quot;&gt;&gt;),
<a name="2397"/> 2397:     &quot;exception error: no function clause matching&quot; =
<a name="2398"/> 2398:         comm_err(&lt;&lt;&quot;fun(P) when is_pid(P) -&gt; true end(a).&quot;&gt;&gt;),
<a name="2399"/> 2399:     &quot;exception error: {function_clause,&quot; =
<a name="2400"/> 2400:         comm_err(&lt;&lt;&quot;erlang:error(function_clause, &quot;
<a name="2401"/> 2401:                    &quot;[unproper | list]).&quot;&gt;&gt;),
<a name="2402"/> 2402:     %% Cheating:
<a name="2403"/> 2403:     &quot;exception error: no function clause matching &quot;
<a name="2404"/> 2404:         &quot;shell:apply_fun(4)&quot; ++ _ =
<a name="2405"/> 2405:         comm_err(&lt;&lt;&quot;erlang:error(function_clause, [4]).&quot;&gt;&gt;),
<a name="2406"/> 2406:     &quot;exception error: no function clause matching &quot;
<a name="2407"/> 2407:         &quot;lists:reverse(&quot; ++ _ =
<a name="2408"/> 2408:         comm_err(&lt;&lt;&quot;F=fun() -&gt; hello end, lists:reverse(F).&quot;&gt;&gt;),
<a name="2409"/> 2409:     &quot;exception error: no function clause matching &quot;
<a name="2410"/> 2410:         &quot;lists:reverse(34) (lists.erl, line &quot; ++ _ =
<a name="2411"/> 2411:         comm_err(&lt;&lt;&quot;lists:reverse(34).&quot;&gt;&gt;),
<a name="2412"/> 2412:     &quot;exception error: function_clause&quot; =
<a name="2413"/> 2413:         comm_err(&lt;&lt;&quot;erlang:error(function_clause, 4).&quot;&gt;&gt;),
<a name="2414"/> 2414:     &quot;exception error: no function clause matching&quot; ++ _ =
<a name="2415"/> 2415:         comm_err(&lt;&lt;&quot;fun(a, b, c, d) -&gt; foo end&quot;
<a name="2416"/> 2416:                    &quot;       (lists:seq(1,17),&quot;
<a name="2417"/> 2417:                    &quot;        lists:seq(1, 18),&quot;
<a name="2418"/> 2418:                    &quot;        lists:seq(1, 40),&quot;
<a name="2419"/> 2419:                    &quot;        lists:seq(1, 5)).&quot;&gt;&gt;),
<a name="2420"/> 2420: 
<a name="2421"/> 2421:     &quot;exception error: no function clause matching&quot; =
<a name="2422"/> 2422:         comm_err(&lt;&lt;&quot;fun(P, q) when is_pid(P) -&gt; true end(a, b).&quot;&gt;&gt;),
<a name="2423"/> 2423:     &quot;exception error: no true branch found when evaluating an if expression&quot; =
<a name="2424"/> 2424:         comm_err(&lt;&lt;&quot;if length([a,b]) &gt; 17 -&gt; a end.&quot;&gt;&gt;),
<a name="2425"/> 2425:     &quot;exception error: no such process or port&quot; =
<a name="2426"/> 2426:         comm_err(&lt;&lt;&quot;Pid = spawn(fun() -&gt; a end),&quot;
<a name="2427"/> 2427:                    &quot;timer:sleep(1),&quot;
<a name="2428"/> 2428:                    &quot;link(Pid).&quot;&gt;&gt;),
<a name="2429"/> 2429:     &quot;exception error: a system limit has been reached&quot; =
<a name="2430"/> 2430:         comm_err(&lt;&lt;&quot;list_to_atom(lists:duplicate(300,$a)).&quot;&gt;&gt;),
<a name="2431"/> 2431:     &quot;exception error: bad receive timeout value&quot; =
<a name="2432"/> 2432:         comm_err(&lt;&lt;&quot;receive after a -&gt; foo end.&quot;&gt;&gt;),
<a name="2433"/> 2433:     &quot;exception error: no try clause matching 1&quot; ++ _ =
<a name="2434"/> 2434:         comm_err(&lt;&lt;&quot;try math:sqrt(2) of bar -&gt; yes after 3 end.&quot;&gt;&gt;),
<a name="2435"/> 2435:     &quot;exception error: no try clause matching [1&quot; ++ _ =
<a name="2436"/> 2436:         comm_err(&lt;&lt;&quot;V = lists:seq(1, 20),&quot;
<a name="2437"/> 2437:                    &quot;try V of bar -&gt; yes after 3 end.&quot;&gt;&gt;),
<a name="2438"/> 2438:     &quot;exception error: undefined function math:sqrt/2&quot; =
<a name="2439"/> 2439:         comm_err(&lt;&lt;&quot;math:sqrt(2, 2).&quot;&gt;&gt;),
<a name="2440"/> 2440:     &quot;exception error: limit of number of arguments to interpreted function &quot;
<a name="2441"/> 2441:           &quot;exceeded&quot; = 
<a name="2442"/> 2442:         comm_err(&lt;&lt;&quot;fun(A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U) -&gt;&quot;
<a name="2443"/> 2443:                    &quot;   a end().&quot;&gt;&gt;),
<a name="2444"/> 2444:     &quot;exception error: bad filter a&quot; =
<a name="2445"/> 2445:         comm_err(&lt;&lt;&quot;[b || begin a end].&quot;&gt;&gt;),
<a name="2446"/> 2446:     &quot;exception error: bad generator a&quot; =
<a name="2447"/> 2447:         comm_err(&lt;&lt;&quot;[X || X &lt;- a].&quot;&gt;&gt;),
<a name="2448"/> 2448:     &quot;exception throw: undef&quot; = comm_err(&lt;&lt;&quot;throw(undef).&quot;&gt;&gt;),
<a name="2449"/> 2449:     &quot;exception exit: undef&quot; = comm_err(&lt;&lt;&quot;exit(undef).&quot;&gt;&gt;),
<a name="2450"/> 2450: 
<a name="2451"/> 2451:     &quot;exception exit: foo&quot; =
<a name="2452"/> 2452:           comm_err(&lt;&lt;&quot;catch spawn_link(fun() -&gt;&quot;
<a name="2453"/> 2453:                      &quot;                     timer:sleep(300), exit(foo) &quot;
<a name="2454"/> 2454:                      &quot;                 end),&quot;
<a name="2455"/> 2455:                      &quot;timer:sleep(500).&quot;&gt;&gt;),
<a name="2456"/> 2456:     [ok] = scan(
<a name="2457"/> 2457:                    &lt;&lt;&quot;begin process_flag(trap_exit, true),&quot;
<a name="2458"/> 2458:                      &quot;  Pid = spawn_link(fun() -&gt;&quot;
<a name="2459"/> 2459:                      &quot;                       timer:sleep(300), exit(foo) &quot;
<a name="2460"/> 2460:                      &quot;                   end),&quot;
<a name="2461"/> 2461:                      &quot;  timer:sleep(500),&quot;
<a name="2462"/> 2462:                      &quot;  receive {'EXIT', Pid, foo} -&gt; ok end end.&quot;&gt;&gt;),
<a name="2463"/> 2463:     &quot;exception exit: badarith&quot; =
<a name="2464"/> 2464:           comm_err(&lt;&lt;&quot;catch spawn_link(fun() -&gt;&quot;
<a name="2465"/> 2465:                      &quot;                     timer:sleep(300), 1/0 &quot;
<a name="2466"/> 2466:                      &quot;                 end),&quot;
<a name="2467"/> 2467:                      &quot;timer:sleep(500).&quot;&gt;&gt;),
<a name="2468"/> 2468:     &quot;exception exit: {nocatch,foo}&quot; =
<a name="2469"/> 2469:           comm_err(&lt;&lt;&quot;catch spawn_link(fun() -&gt;&quot;
<a name="2470"/> 2470:                      &quot;                     timer:sleep(300), throw(foo) &quot;
<a name="2471"/> 2471:                      &quot;                 end),&quot;
<a name="2472"/> 2472:                      &quot;timer:sleep(500).&quot;&gt;&gt;),
<a name="2473"/> 2473:     [ok] = scan(
<a name="2474"/> 2474:                    &lt;&lt;&quot;begin process_flag(trap_exit, true),&quot;
<a name="2475"/> 2475:                      &quot;  Pid = spawn_link(fun() -&gt;&quot;
<a name="2476"/> 2476:                      &quot;                       timer:sleep(300), throw(foo) &quot;
<a name="2477"/> 2477:                      &quot;                   end),&quot;
<a name="2478"/> 2478:                      &quot;  timer:sleep(500),&quot;
<a name="2479"/> 2479:                      &quot;  receive {'EXIT', Pid, {{nocatch,foo},_}} -&gt; ok end &quot;
<a name="2480"/> 2480:                      &quot;end.&quot;&gt;&gt;),
<a name="2481"/> 2481: 
<a name="2482"/> 2482:     &quot;exception error: an error occurred when evaluating an arithmetic expression&quot; =
<a name="2483"/> 2483:         comm_err(&lt;&lt;&quot;begin catch_exception(true), 1/0 end.&quot;&gt;&gt;),
<a name="2484"/> 2484:     &quot;exception error: an error occurred when evaluating an arithmetic expression&quot; =
<a name="2485"/> 2485:         comm_err(&lt;&lt;&quot;begin catch_exception(false), 1/0 end.&quot;&gt;&gt;),
<a name="2486"/> 2486:     &quot;exception error: no function clause matching call to catch_exception/1&quot; =
<a name="2487"/> 2487:         comm_err(&lt;&lt;&quot;catch_exception(1).&quot;&gt;&gt;),
<a name="2488"/> 2488: 
<a name="2489"/> 2489:     %% A bug was corrected (expansion of 'try'):
<a name="2490"/> 2490:     &quot;2: command not found&quot; =
<a name="2491"/> 2491:         comm_err(&lt;&lt;&quot;try 1 of 1 -&gt; v(2) after 3 end.&quot;&gt;&gt;),
<a name="2492"/> 2492:     %% Cover a few lines:
<a name="2493"/> 2493:     &quot;3: command not found&quot; =
<a name="2494"/> 2494:         comm_err(&lt;&lt;&quot;receive foo -&gt; foo after 0 -&gt; v(3) end.&quot;&gt;&gt;),
<a name="2495"/> 2495:     &quot;3: command not found&quot; =
<a name="2496"/> 2496:         comm_err(&lt;&lt;&quot;receive foo -&gt; foo after 0 -&gt; e(3) end.&quot;&gt;&gt;),
<a name="2497"/> 2497:     &quot;1 / 0: command not found&quot; = comm_err(&lt;&lt;&quot;v(1/0).&quot;&gt;&gt;),
<a name="2498"/> 2498:     &quot;1\n1.\n&quot; = t(&lt;&lt;&quot;1. e(1).&quot;&gt;&gt;),
<a name="2499"/> 2499:     [ok] = scan(&lt;&lt;&quot;h().&quot;&gt;&gt;),
<a name="2500"/> 2500:     &quot;exception exit: normal&quot; = comm_err(&lt;&lt;&quot;exit(normal).&quot;&gt;&gt;),
<a name="2501"/> 2501:     [foo] = scan(&lt;&lt;&quot;begin history(0), foo end.&quot;&gt;&gt;),
<a name="2502"/> 2502:     application:unset_env(stdlib, shell_history_length),
<a name="2503"/> 2503:     [true] = scan(&lt;&lt;&quot;begin &lt;&lt;10:(1024*1024*10)&gt;&gt;,&quot;
<a name="2504"/> 2504:                           &quot;&lt;&lt;10:(1024*1024*10)&gt;&gt;, garbage_collect() end.&quot;&gt;&gt;),
<a name="2505"/> 2505:     &quot;1:3: syntax error before: '.'&quot; = comm_err(&quot;1-.&quot;),
<a name="2506"/> 2506:     %% comm_err(&lt;&lt;&quot;exit().&quot;&gt;&gt;), % would hang
<a name="2507"/> 2507:     &quot;exception error: no function clause matching call to history/1&quot; =
<a name="2508"/> 2508:         comm_err(&lt;&lt;&quot;history(foo).&quot;&gt;&gt;),
<a name="2509"/> 2509:     &quot;exception error: no function clause matching call to results/1&quot; =
<a name="2510"/> 2510:         comm_err(&lt;&lt;&quot;results(foo).&quot;&gt;&gt;),
<a name="2511"/> 2511: 
<a name="2512"/> 2512:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="2513"/> 2513: 			       &quot;otp_6554.erl&quot;),
<a name="2514"/> 2514:     Contents = &lt;&lt;&quot;-module(otp_6554).
<a name="2515"/> 2515:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="2516"/> 2516:                   local_allowed(_,_,State) -&gt;
<a name="2517"/> 2517:                       {true,State}.
<a name="2518"/> 2518: 
<a name="2519"/> 2519:                   non_local_allowed(_,_,State) -&gt;
<a name="2520"/> 2520:                       {true,State}.
<a name="2521"/> 2521:                  &quot;&gt;&gt;,
<a name="2522"/> 2522:     ok = compile_file(Config, Test, Contents, []),
<a name="2523"/> 2523:     &quot;exception exit: restricted shell starts now&quot; =
<a name="2524"/> 2524: 	comm_err(&lt;&lt;&quot;begin shell:start_restricted(otp_6554) end.&quot;&gt;&gt;),
<a name="2525"/> 2525:     &quot;-record(r,{}).\n1.\nok.\n&quot; =
<a name="2526"/> 2526:                     t(&lt;&lt;&quot;f(), f(B), h(), b(), history(20), results(20),&quot;
<a name="2527"/> 2527:                         &quot;rd(r, {}), rl(r), rf('_'), rl(), rf(),&quot;
<a name="2528"/> 2528:                         &quot;rp(1), _ = rr({foo}), _ = rr({foo}, []),&quot;
<a name="2529"/> 2529:                         &quot;rr({foo}, [], []), ok.&quot;&gt;&gt;),
<a name="2530"/> 2530:     &quot;false.\n&quot; = t(&lt;&lt;&quot;catch_exception(true).&quot;&gt;&gt;),
<a name="2531"/> 2531:     &quot;exception exit: restricted shell stopped&quot;=
<a name="2532"/> 2532: 	comm_err(&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;),
<a name="2533"/> 2533:     &quot;true.\n&quot; = t(&lt;&lt;&quot;catch_exception(false).&quot;&gt;&gt;),
<a name="2534"/> 2534: 
<a name="2535"/> 2535:     &quot;20\n1\n1\n1: results(2)\n2: 1\n-&gt; 1\n3: v(2)\n-&gt; 1.\nok.\n&quot; =
<a name="2536"/> 2536:              t(&lt;&lt;&quot;results(2). 1. v(2). h().&quot;&gt;&gt;),
<a name="2537"/> 2537:     application:unset_env(stdlib, shell_saved_results),
<a name="2538"/> 2538:     &quot;1\nfoo\n17\nB = foo\nC = 17\nF = fun() -&gt;\n           foo&quot;
<a name="2539"/> 2539:           &quot;\n    end.\nok.\n&quot; = 
<a name="2540"/> 2540:         t(&lt;&lt;&quot;begin F = fun() -&gt; foo end, 1 end. B = F(). C = 17. b().&quot;&gt;&gt;),
<a name="2541"/> 2541: 
<a name="2542"/> 2542:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;#{v(3) =&gt; v}.&quot;&gt;&gt;),
<a name="2543"/> 2543:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;#{k =&gt; v(3)}.&quot;&gt;&gt;),
<a name="2544"/> 2544:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;#{v(3) := v}.&quot;&gt;&gt;),
<a name="2545"/> 2545:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;#{k := v(3)}.&quot;&gt;&gt;),
<a name="2546"/> 2546:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;(v(3))#{}.&quot;&gt;&gt;),
<a name="2547"/> 2547:     %% Tests I'd like to do: (you should try them manually)
<a name="2548"/> 2548:     %% &quot;catch spawn_link(fun() -&gt; timer:sleep(1000), exit(foo) end).&quot;
<a name="2549"/> 2549:     %%   &quot;** exception error: foo&quot; should be output after 1 second
<a name="2550"/> 2550:     %% &quot;catch spawn_link(fun() -&gt; timer:sleep(1000), 1/0 end).&quot;
<a name="2551"/> 2551:     %%   &quot;** exception error: bad argument...&quot; should be output after 1 second
<a name="2552"/> 2552:     %% &quot;1/0&quot;, &quot;exit(foo)&quot;, &quot;throw(foo)&quot;.
<a name="2553"/> 2553:     %%   &quot;h().&quot; should show {'EXIT', {badarith,..}}, {'EXIT',{foo,...}},
<a name="2554"/> 2554:     %%   and {'EXIT',{{nocatch,foo},...}}.
<a name="2555"/> 2555: 
<a name="otp_6554-last_expr"/><a name="2556"/> 2556:     ok.
<a name="2557"/> 2557: 
<a name="2558"/> 2558: <i>%% OTP-7184. Propagate exit signals from dying evaluator process.</i>
<a name="otp_7184-1"/><a name="2559"/> 2559: <b>otp_7184</b>(Config) when is_list(Config) -&gt;
<a name="2560"/> 2560:     register(otp_7184, self()),
<a name="2561"/> 2561:     catch
<a name="2562"/> 2562:            t(&lt;&lt;&quot;P = self(),
<a name="2563"/> 2563:                 spawn_link(fun() -&gt; process_flag(trap_exit,true),
<a name="2564"/> 2564:                                     P ! up,
<a name="2565"/> 2565:                                     receive X -&gt; 
<a name="2566"/> 2566:                                         otp_7184 ! {otp_7184, X}
<a name="2567"/> 2567:                                     end 
<a name="2568"/> 2568:                            end),
<a name="2569"/> 2569:                 receive up -&gt; ok end,
<a name="2570"/> 2570:                 erlang:raise(throw, thrown, []).&quot;&gt;&gt;),
<a name="2571"/> 2571:     receive {otp_7184,{'EXIT',_,{{nocatch,thrown},[]}}} -&gt; ok end,
<a name="2572"/> 2572: 
<a name="2573"/> 2573:     catch
<a name="2574"/> 2574:            t(&lt;&lt;&quot;P = self(),
<a name="2575"/> 2575:                 spawn_link(fun() -&gt; process_flag(trap_exit,true),
<a name="2576"/> 2576:                                     P ! up,
<a name="2577"/> 2577:                                     receive X -&gt; 
<a name="2578"/> 2578:                                         otp_7184 ! {otp_7184, X}
<a name="2579"/> 2579:                                     end 
<a name="2580"/> 2580:                            end),
<a name="2581"/> 2581:                 receive up -&gt; ok end,
<a name="2582"/> 2582:                 erlang:raise(exit, fini, []).&quot;&gt;&gt;),
<a name="2583"/> 2583:     receive {otp_7184,{'EXIT',_,{fini,[]}}} -&gt; ok end,
<a name="2584"/> 2584: 
<a name="2585"/> 2585:     catch
<a name="2586"/> 2586:            t(&lt;&lt;&quot;P = self(),
<a name="2587"/> 2587:                 spawn_link(fun() -&gt; process_flag(trap_exit,true),
<a name="2588"/> 2588:                                     P ! up,
<a name="2589"/> 2589:                                     receive X -&gt; 
<a name="2590"/> 2590:                                         otp_7184 ! {otp_7184,X}
<a name="2591"/> 2591:                                     end 
<a name="2592"/> 2592:                            end),
<a name="2593"/> 2593:                 receive up -&gt; ok end,
<a name="2594"/> 2594:                 erlang:raise(error, bad, []).&quot;&gt;&gt;),
<a name="2595"/> 2595:     receive {otp_7184,{'EXIT',_,{bad,[]}}} -&gt; ok end,
<a name="2596"/> 2596: 
<a name="2597"/> 2597:     unregister(otp_7184),
<a name="2598"/> 2598: 
<a name="2599"/> 2599:     %% v/1, a few missed cases
<a name="2600"/> 2600:     &quot;17\n&lt;&lt;0,0,0,64&gt;&gt;.\nok.\n&quot; =
<a name="2601"/> 2601:         t(&lt;&lt;&quot;17. &quot;
<a name="2602"/> 2602:             &quot;&lt;&lt;64:32&gt;&gt;. &quot;
<a name="2603"/> 2603:            &quot;&lt;&lt;64&gt;&gt; = &lt;&lt; &lt;&lt; X &gt;&gt; || &lt;&lt; X &gt;&gt;  &lt;= v(2), X &gt; v(1) &gt;&gt;, ok.&quot;&gt;&gt;),
<a name="2604"/> 2604: 
<a name="2605"/> 2605:     &quot;17\n&lt;&lt;0,17&gt;&gt;.\n&quot; =t(&lt;&lt;&quot;17. &lt;&lt;(v(1)):16&gt;&gt;.&quot;&gt;&gt;),
<a name="2606"/> 2606: 
<a name="otp_7184-last_expr"/><a name="2607"/> 2607:     ok.
<a name="2608"/> 2608: 
<a name="2609"/> 2609: <i>%% OTP-7232. qlc:info() bug.</i>
<a name="otp_7232-1"/><a name="2610"/> 2610: <b>otp_7232</b>(Config) when is_list(Config) -&gt;
<a name="2611"/> 2611:     Info = &lt;&lt;&quot;qlc:info(qlc:sort(qlc:q([X || X &lt;- [55296,56296]]), &quot;
<a name="2612"/> 2612:              &quot;{order, fun(A,B)-&gt; A&gt;B end})).&quot;&gt;&gt;,
<a name="2613"/> 2613:     &quot;qlc:sort([55296, 56296],\n&quot;
<a name="2614"/> 2614:     &quot;         [{order,\n&quot;
<a name="2615"/> 2615:     &quot;           fun(A, B) -&gt;\n&quot;
<a name="2616"/> 2616:     &quot;                  A &gt; B\n&quot;
<a name="2617"/> 2617:     &quot;           end}])&quot; = evaluate(Info, []),
<a name="otp_7232-last_expr"/><a name="2618"/> 2618:     ok.
<a name="2619"/> 2619: 
<a name="2620"/> 2620: <i>%% OTP-8393. Prompt string.</i>
<a name="otp_8393-1"/><a name="2621"/> 2621: <b>otp_8393</b>(Config) when is_list(Config) -&gt;
<a name="2622"/> 2622:     _ = shell:prompt_func(default),
<a name="2623"/> 2623:     &quot;Bad prompt function: '&gt; '&quot; =
<a name="2624"/> 2624:         prompt_err(&lt;&lt;&quot;shell:prompt_func('&gt; ').&quot;&gt;&gt;),
<a name="2625"/> 2625: 
<a name="2626"/> 2626:     _ = shell:prompt_func(default),
<a name="2627"/> 2627:     &quot;exception error: an error occurred when evaluating an arithmetic expression&quot;++_ =
<a name="2628"/> 2628:         prompt_err(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt4}).&quot;&gt;&gt;),
<a name="2629"/> 2629: 
<a name="2630"/> 2630:     _ = shell:prompt_func(default),
<a name="2631"/> 2631:     &quot;default.\n&quot; =
<a name="2632"/> 2632:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt2}).&quot;&gt;&gt;),
<a name="2633"/> 2633: 
<a name="2634"/> 2634:     _ = shell:prompt_func(default),
<a name="2635"/> 2635:     &quot;default\nl.\n&quot; =
<a name="2636"/> 2636:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt3}). l.&quot;&gt;&gt;),
<a name="2637"/> 2637: 
<a name="2638"/> 2638:     %%
<a name="2639"/> 2639:     %% Although this tests that you can set a unicode prompt function
<a name="2640"/> 2640:     %% it does not really test that it does work with the io-servers.
<a name="2641"/> 2641:     %% That is instead tested in the io_proto_SUITE, which has
<a name="2642"/> 2642:     %% the right infrastructure in place for such tests. /PaN
<a name="2643"/> 2643:     %%
<a name="2644"/> 2644:     _ = shell:prompt_func(default),
<a name="2645"/> 2645:     &quot;default\nl.\n&quot; =
<a name="2646"/> 2646:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt5}). l.&quot;&gt;&gt;),
<a name="2647"/> 2647: 
<a name="2648"/> 2648:     %% Restricted shell.
<a name="2649"/> 2649:     Contents = &lt;&lt;&quot;-module(test_restricted_shell).
<a name="2650"/> 2650:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="2651"/> 2651:                   local_allowed(_,_,State) -&gt;
<a name="2652"/> 2652:                       {false,State}.
<a name="2653"/> 2653: 
<a name="2654"/> 2654:                   non_local_allowed({shell,stop_restricted},[],State) -&gt;
<a name="2655"/> 2655:                       {true,State};
<a name="2656"/> 2656:                   non_local_allowed({shell,prompt_func},[_L],State) -&gt;
<a name="2657"/> 2657:                       {true,State};
<a name="2658"/> 2658:                   non_local_allowed({shell_SUITE,prompt1},[_L],State) -&gt;
<a name="2659"/> 2659:                       {true,State};
<a name="2660"/> 2660:                   non_local_allowed(_,_,State) -&gt;
<a name="2661"/> 2661:                       {false,State}.
<a name="2662"/> 2662:                  &quot;&gt;&gt;,
<a name="2663"/> 2663:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="2664"/> 2664: 			       &quot;test_restricted_shell.erl&quot;),
<a name="2665"/> 2665:     ok = compile_file(Config, Test, Contents, []),
<a name="2666"/> 2666:     _ = shell:prompt_func(default),
<a name="2667"/> 2667:     &quot;exception exit: restricted shell starts now&quot; =
<a name="2668"/> 2668: 	comm_err(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="2669"/> 2669: 			 &quot;test_restricted_shell) end.&quot;&gt;&gt;),
<a name="2670"/> 2670:     &quot;default.\n&quot;++_ =
<a name="2671"/> 2671:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt1}).&quot;&gt;&gt;),
<a name="2672"/> 2672:     &quot;exception exit: restricted shell does not allow apple(&quot; ++ _ =
<a name="2673"/> 2673: 	comm_err(&lt;&lt;&quot;apple(1).&quot;&gt;&gt;),
<a name="2674"/> 2674:     &quot;{shell_SUITE,prompt1}.\n&quot; =
<a name="2675"/> 2675:         t(&lt;&lt;&quot;shell:prompt_func(default).&quot;&gt;&gt;),
<a name="2676"/> 2676:     &quot;exception exit: restricted shell stopped&quot;=
<a name="2677"/> 2677: 	comm_err(&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;),
<a name="2678"/> 2678:     undefined =
<a name="2679"/> 2679: 	application:get_env(stdlib, restricted_shell),
<a name="2680"/> 2680: 
<a name="2681"/> 2681:     NR = shell:results(20),
<a name="2682"/> 2682:     &quot;default\n20.\n&quot; =
<a name="2683"/> 2683:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt3}). results(0).&quot;&gt;&gt;),
<a name="2684"/> 2684: 
<a name="2685"/> 2685:     _ = shell:prompt_func(default),
<a name="2686"/> 2686:     0 = shell:results(NR),
<a name="otp_8393-last_expr"/><a name="2687"/> 2687:     ok.
<a name="2688"/> 2688: 
<a name="prompt1-1"/><a name="2689"/> 2689: <b>prompt1</b>(_L) -&gt;
<a name="prompt1-last_expr"/><a name="2690"/> 2690:     &quot;prompt&gt; &quot;.
<a name="2691"/> 2691: 
<a name="prompt2-1"/><a name="2692"/> 2692: <b>prompt2</b>(_L) -&gt;
<a name="prompt2-last_expr"/><a name="2693"/> 2693:     {'EXIT', []}.
<a name="2694"/> 2694: 
<a name="prompt3-1"/><a name="2695"/> 2695: <b>prompt3</b>(L) -&gt;
<a name="2696"/> 2696:     N = proplists:get_value(history, L),
<a name="prompt3-last_expr"/><a name="2697"/> 2697: <b>    integer_to_list</b>(N).
<a name="2698"/> 2698: 
<a name="prompt4-1"/><a name="2699"/> 2699: <b>prompt4</b>(_L) -&gt;
<a name="prompt4-last_expr"/><a name="2700"/> 2700: <b>    erlang:apply</b>(fun erlang:'/'/2, [1,0]).
<a name="2701"/> 2701: 
<a name="prompt5-1"/><a name="2702"/> 2702: <b>prompt5</b>(_L) -&gt;
<a name="prompt5-last_expr"/><a name="2703"/> 2703:     [1050,1072,1082,1074,1086,32,1077,32,85,110,105,99,111,100,101,32,63].
<a name="2704"/> 2704: 
<a name="2705"/> 2705: <b>-ifdef</b>(not_used).
<a name="2706"/> 2706: exit_term(B) -&gt;
<a name="2707"/> 2707:     &quot;** exception exit:&quot; ++ Reply = t(B),
<a name="2708"/> 2708:     S0 = string:left(Reply, string:chr(Reply, $\n)-1),
<a name="2709"/> 2709:     S = string:strip(S0, right, $*),
<a name="2710"/> 2710:     {ok,Ts,_} = erl_scan:string(S),
<a name="2711"/> 2711:     {ok,Term} = erl_parse:parse_term(Ts),
<a name="2712"/> 2712:     Term.
<a name="2713"/> 2713: -endif.
<a name="2714"/> 2714: 
<a name="error_string-1"/><a name="2715"/> 2715: <b>error_string</b>(B) -&gt;
<a name="2716"/> 2716:     &quot;** exception error:&quot; ++ Reply = t(B),    
<a name="error_string-last_expr"/><a name="2717"/> 2717: <b>    caught_string</b>(Reply).
<a name="2718"/> 2718: 
<a name="exit_string-1"/><a name="2719"/> 2719: <b>exit_string</b>(B) -&gt;
<a name="2720"/> 2720:     &quot;** exception exit:&quot; ++ Reply = t(B),
<a name="exit_string-last_expr"/><a name="2721"/> 2721: <b>    caught_string</b>(Reply).
<a name="2722"/> 2722: 
<a name="caught_string-1"/><a name="2723"/> 2723: <b>caught_string</b>(Reply) -&gt;
<a name="2724"/> 2724:     S0 = string:left(Reply, string:chr(Reply, $\n)-1),
<a name="2725"/> 2725:     S1 = string:strip(S0, right, $.),
<a name="2726"/> 2726:     S2 = string:strip(S1, left, $*),
<a name="2727"/> 2727:     S =  string:strip(S2, both, $ ),
<a name="caught_string-last_expr"/><a name="2728"/> 2728: <b>    string:strip</b>(S, both, $&quot;).
<a name="2729"/> 2729: 
<a name="comm_err-1"/><a name="2730"/> 2730: <b>comm_err</b>(B) -&gt;
<a name="2731"/> 2731:     Reply = t(B),
<a name="2732"/> 2732:     S0 = string:left(Reply, string:chr(Reply, $\n)-1),
<a name="2733"/> 2733:     S1 = string:strip(S0, left, $*),
<a name="2734"/> 2734:     S2 = string:strip(S1, both, $ ),
<a name="2735"/> 2735:     S = string:strip(S2, both, $&quot;),
<a name="comm_err-last_expr"/><a name="2736"/> 2736: <b>    string:strip</b>(S, right, $.).
<a name="2737"/> 2737: 
<a name="prompt_err-1"/><a name="2738"/> 2738: <b>prompt_err</b>(B) -&gt;
<a name="2739"/> 2739:     Reply = t(B),
<a name="2740"/> 2740:     S00 = string:sub_string(Reply, string:chr(Reply, $\n)+1),
<a name="2741"/> 2741:     S0 = string:left(S00, string:chr(S00, $\n)-1),
<a name="2742"/> 2742:     S1 = string:strip(S0, left, $*),
<a name="2743"/> 2743:     S2 = string:strip(S1, both, $ ),
<a name="2744"/> 2744:     S = string:strip(S2, both, $&quot;),
<a name="prompt_err-last_expr"/><a name="2745"/> 2745: <b>    string:strip</b>(S, right, $.).
<a name="2746"/> 2746: 
<a name="2747"/> 2747: <i>%% OTP-10302. Unicode. Also OTP-14285, Unicode atoms.</i>
<a name="otp_10302-1"/><a name="2748"/> 2748: <b>otp_10302</b>(Config) when is_list(Config) -&gt;
<a name="2749"/> 2749:     {ok, Peer, Node} = ?CT_PEER([&quot;-pa&quot;, proplists:get_value(priv_dir,Config),
<a name="2750"/> 2750: 			         &quot;+pc&quot;, &quot;unicode&quot;]),
<a name="2751"/> 2751:     Test1 =
<a name="2752"/> 2752:         &lt;&lt;&quot;begin
<a name="2753"/> 2753:                io:setopts([{encoding,utf8}]),
<a name="2754"/> 2754:                [1024] = \&quot;\\x{400}\&quot;,
<a name="2755"/> 2755:                rd(rec, {a = \&quot;\\x{400}\&quot;}),
<a name="2756"/> 2756:                ok = rl(rec)
<a name="2757"/> 2757:             end.&quot;&gt;&gt;,
<a name="2758"/> 2758:     &quot;-record(rec,{a = \&quot;\x{400}\&quot;}).\nok.\n&quot; = t({Node,Test1}),
<a name="2759"/> 2759: 
<a name="2760"/> 2760:     Test3 =
<a name="2761"/> 2761:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2762"/> 2762:            rd(rec, {a = \&quot;\\x{400}\&quot;}).
<a name="2763"/> 2763:            ok = rp(#rec{}).&quot;&gt;&gt;,
<a name="2764"/> 2764:     &quot;ok.\nrec\n#rec{a = \&quot;\x{400}\&quot;}.\nok.\n&quot; = t({Node,Test3}),
<a name="2765"/> 2765: 
<a name="2766"/> 2766:     Test4 =
<a name="2767"/> 2767:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2768"/> 2768:            A = [1024] = \&quot;\\x{400}\&quot;.
<a name="2769"/> 2769:            b().
<a name="2770"/> 2770:            h().&quot;&gt;&gt;,
<a name="2771"/> 2771: 
<a name="2772"/> 2772:     &quot;ok.\n\&quot;\x{400}\&quot;\nA = \&quot;\x{400}\&quot;.\nok.\n&quot;
<a name="2773"/> 2773:     &quot;1: io:setopts([{encoding, utf8}])\n-&gt; ok.\n&quot;
<a name="2774"/> 2774:     &quot;2: A = [1024] = \&quot;\x{400}\&quot;\n-&gt; \&quot;\x{400}\&quot;\n&quot;
<a name="2775"/> 2775:     &quot;3: b()\n-&gt; ok.\nok.\n&quot; = t({Node,Test4}),
<a name="2776"/> 2776: 
<a name="2777"/> 2777:     Test5 =
<a name="2778"/> 2778:         &lt;&lt;&quot;begin
<a name="2779"/> 2779:                io:setopts([{encoding,utf8}]),
<a name="2780"/> 2780:                results(0),
<a name="2781"/> 2781:                A = [1024] = \&quot;\\x{400}\&quot;,
<a name="2782"/> 2782:                b(),
<a name="2783"/> 2783:                h()
<a name="2784"/> 2784:            end.&quot;&gt;&gt;,
<a name="2785"/> 2785:     &quot;A = \&quot;\x{400}\&quot;.\nok.\n&quot; = t({Node,Test5}),
<a name="2786"/> 2786: 
<a name="2787"/> 2787:     %% One $&quot; is &quot;lost&quot;:
<a name="2788"/> 2788:     true =
<a name="2789"/> 2789:        &quot;\x{400}\&quot;: command not found&quot; =:=
<a name="2790"/> 2790:        prompt_err({Node,
<a name="2791"/> 2791:                    &lt;&lt;&quot;io:setopts([{encoding,utf8}]). v(\&quot;\x{400}\&quot;).&quot;/utf8&gt;&gt;,
<a name="2792"/> 2792:                    unicode}),
<a name="2793"/> 2793: 
<a name="2794"/> 2794:     &quot;ok.\ndefault\n* Bad prompt function: \&quot;\x{400}\&quot;.\n&quot; =
<a name="2795"/> 2795:         t({Node,&lt;&lt;&quot;io:setopts([{encoding,utf8}]). &quot;
<a name="2796"/> 2796:              &quot;shell:prompt_func(\&quot;\x{400}\&quot;).&quot;/utf8&gt;&gt;,
<a name="2797"/> 2797:            unicode}),
<a name="2798"/> 2798:     rpc:call(Node,shell, prompt_func, [default]),
<a name="2799"/> 2799:     _ = shell:prompt_func(default),
<a name="2800"/> 2800: 
<a name="2801"/> 2801:     %% Test erl_error:format_exception() (cf. OTP-6554)
<a name="2802"/> 2802:     Test6 =
<a name="2803"/> 2803:         &lt;&lt;&quot;begin
<a name="2804"/> 2804:                A = &lt;&lt;\&quot;\\xaa\&quot;&gt;&gt;,
<a name="2805"/> 2805:                S = lists:flatten(io_lib:format(\&quot;~p/~p.\&quot;, [A, A])),
<a name="2806"/> 2806:                {ok, Ts, _} = erl_scan:string(S, 1),
<a name="2807"/> 2807:                {ok, Es} = erl_parse:parse_exprs(Ts),
<a name="2808"/> 2808:                B = erl_eval:new_bindings(),
<a name="2809"/> 2809:                erl_eval:exprs(Es, B)
<a name="2810"/> 2810:            end.&quot;&gt;&gt;,
<a name="2811"/> 2811: 
<a name="2812"/> 2812:     &quot;** exception error: an error occurred when evaluating&quot;
<a name="2813"/> 2813:         &quot; an arithmetic expression\n     in operator  '/'/2\n&quot;
<a name="2814"/> 2814:         &quot;        called as &lt;&lt;\&quot;\xaa\&quot;&gt;&gt; / &lt;&lt;\&quot;\xaa\&quot;&gt;&gt;.\n&quot; = t(Test6),
<a name="2815"/> 2815:     Test7 =
<a name="2816"/> 2816:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2817"/> 2817:            A = &lt;&lt;\&quot;\\xaa\&quot;&gt;&gt;,
<a name="2818"/> 2818:            S = lists:flatten(io_lib:format(\&quot;~p/~p.\&quot;, [A, A])),
<a name="2819"/> 2819:            {ok, Ts, _} = erl_scan:string(S, 1),
<a name="2820"/> 2820:            {ok, Es} = erl_parse:parse_exprs(Ts),
<a name="2821"/> 2821:            B = erl_eval:new_bindings(),
<a name="2822"/> 2822:            erl_eval:exprs(Es, B).&quot;&gt;&gt;,
<a name="2823"/> 2823:     
<a name="2824"/> 2824:     &quot;ok.\n** exception error: an error occurred when evaluating&quot;
<a name="2825"/> 2825:         &quot; an arithmetic expression\n     in operator  '/'/2\n&quot;
<a name="2826"/> 2826:         &quot;        called as &lt;&lt;\&quot;\&quot;&gt;&gt; / &lt;&lt;\&quot;\&quot;&gt;&gt;.\n&quot; = t({Node,Test7}),
<a name="2827"/> 2827:     Test8 =
<a name="2828"/> 2828:         &lt;&lt;&quot;begin
<a name="2829"/> 2829:                A = [1089],
<a name="2830"/> 2830:                S = lists:flatten(io_lib:format(\&quot;~tp/~tp.\&quot;, [A, A])),
<a name="2831"/> 2831:                {ok, Ts, _} = erl_scan:string(S, 1),
<a name="2832"/> 2832:                {ok, Es} = erl_parse:parse_exprs(Ts),
<a name="2833"/> 2833:                B = erl_eval:new_bindings(),
<a name="2834"/> 2834:                erl_eval:exprs(Es, B)
<a name="2835"/> 2835:            end.&quot;&gt;&gt;,
<a name="2836"/> 2836:     &quot;** exception error: an error occurred when evaluating&quot;
<a name="2837"/> 2837:         &quot; an arithmetic expression\n     in operator  '/'/2\n&quot;
<a name="2838"/> 2838:         &quot;        called as [1089] / [1089].\n&quot; = t(Test8),
<a name="2839"/> 2839:     Test9 =
<a name="2840"/> 2840:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2841"/> 2841:            A = [1089],
<a name="2842"/> 2842:            S = lists:flatten(io_lib:format(\&quot;~tp/~tp.\&quot;, [A, A])),
<a name="2843"/> 2843:            {ok, Ts, _} = erl_scan:string(S, 1),
<a name="2844"/> 2844:            {ok, Es} = erl_parse:parse_exprs(Ts),
<a name="2845"/> 2845:            B = erl_eval:new_bindings(),
<a name="2846"/> 2846:            erl_eval:exprs(Es, B).&quot;&gt;&gt;,
<a name="2847"/> 2847: 
<a name="2848"/> 2848:     &quot;ok.\n** exception error: an error occurred when evaluating&quot;
<a name="2849"/> 2849:         &quot; an arithmetic expression\n     in operator  '/'/2\n&quot;
<a name="2850"/> 2850:         &quot;        called as \&quot;\x{441}\&quot; / \&quot;\x{441}\&quot;.\n&quot; = t({Node,Test9}),
<a name="2851"/> 2851:     Test10 =
<a name="2852"/> 2852:         &lt;&lt;&quot;A = {\&quot;1\\xaa\&quot;,
<a name="2853"/> 2853:            $\\xaa,
<a name="2854"/> 2854:            &lt;&lt; &lt;&lt;\&quot;hi\&quot;&gt;&gt;/binary &gt;&gt;,
<a name="2855"/> 2855:            &lt;&lt;\&quot;1\xaa\&quot;&gt;&gt;},
<a name="2856"/> 2856:            fun(a) -&gt; true end(A).&quot;&gt;&gt;,
<a name="2857"/> 2857:     &quot;** exception error: no function clause matching \n&quot;
<a name="2858"/> 2858:     &quot;                    erl_eval:'-inside-an-interpreted-fun-'&quot;
<a name="2859"/> 2859:     &quot;({\&quot;1\xc2\xaa\&quot;,170,&lt;&lt;\&quot;hi\&quot;&gt;&gt;,\n                                    &quot;
<a name="2860"/> 2860:     &quot;                        &lt;&lt;\&quot;1\xc2\xaa\&quot;&gt;&gt;}) .\n&quot; = t(Test10),
<a name="2861"/> 2861:     Test11 =
<a name="2862"/> 2862:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2863"/> 2863:            A = {\&quot;1\\xaa\&quot;,
<a name="2864"/> 2864:            $\\xaa,
<a name="2865"/> 2865:            &lt;&lt; &lt;&lt;\&quot;hi\&quot;&gt;&gt;/binary &gt;&gt;,
<a name="2866"/> 2866:            &lt;&lt;\&quot;1\xaa\&quot;&gt;&gt;},
<a name="2867"/> 2867:            fun(a) -&gt; true end(A).&quot;&gt;&gt;,
<a name="2868"/> 2868: 
<a name="2869"/> 2869:     &quot;ok.\n** exception error: no function clause matching \n&quot;
<a name="2870"/> 2870:     &quot;                    erl_eval:'-inside-an-interpreted-fun-'&quot;
<a name="2871"/> 2871:     &quot;({\&quot;1\xaa\&quot;,170,&lt;&lt;\&quot;hi\&quot;&gt;&gt;,\n                                           &quot;
<a name="2872"/> 2872:     &quot;                 &lt;&lt;\&quot;1\xaa\&quot;/utf8&gt;&gt;}) .\n&quot;  = t({Node,Test11}),
<a name="2873"/> 2873:     Test12 = &lt;&lt;&quot;fun(a, b) -&gt; false end(65, [1089]).&quot;&gt;&gt;,
<a name="2874"/> 2874:     &quot;** exception error: no function clause matching \n&quot;
<a name="2875"/> 2875:     &quot;                    erl_eval:'-inside-an-interpreted-fun-'(65,[1089])&quot;
<a name="2876"/> 2876:     &quot; .\n&quot; = t(Test12),
<a name="2877"/> 2877:     Test13 =
<a name="2878"/> 2878:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2879"/> 2879:            fun(a, b) -&gt; false end(65, [1089]).&quot;&gt;&gt;,
<a name="2880"/> 2880:     &quot;ok.\n** exception error: no function clause matching \n&quot;
<a name="2881"/> 2881:     &quot;                    erl_eval:'-inside-an-interpreted-fun-'(65,\&quot;\x{441}\&quot;)&quot;
<a name="2882"/> 2882:     &quot; .\n&quot; = t({Node,Test13}),
<a name="2883"/> 2883: 
<a name="2884"/> 2884:     %% Unicode atoms.
<a name="2885"/> 2885:     Test14 = &lt;&lt;&quot;'\\x{447}\\x{435}'().&quot;&gt;&gt;,
<a name="2886"/> 2886:     &quot;** exception error: undefined shell command '\\x{447}\\x{435}'/0.\n&quot; =
<a name="2887"/> 2887:         t(Test14),
<a name="2888"/> 2888:     Test15 = &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2889"/> 2889:                 '\\x{447}\\x{435}'().&quot;&gt;&gt;,
<a name="2890"/> 2890:     &quot;ok.\n** exception error: undefined shell command '\x{447}\x{435}'/0.\n&quot; =
<a name="2891"/> 2891:         t({Node,Test15}),
<a name="2892"/> 2892:     Test16 = &lt;&lt;&quot;shell_SUITE:'\\x{447}\\x{435}'().&quot;&gt;&gt;,
<a name="2893"/> 2893:     &quot;** exception error: undefined function &quot;
<a name="2894"/> 2894:    &quot;shell_SUITE:'\\x{447}\\x{435}'/0.\n&quot; = t(Test16),
<a name="2895"/> 2895:     Test17 = &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2896"/> 2896:                 shell_SUITE:'\\x{447}\\x{435}'().&quot;&gt;&gt;,
<a name="2897"/> 2897:     &quot;ok.\n** exception error: undefined function &quot;
<a name="2898"/> 2898:     &quot;shell_SUITE:'\x{447}\x{435}'/0.\n&quot; =
<a name="2899"/> 2899:         t({Node,Test17}),
<a name="2900"/> 2900:     peer:stop(Peer),
<a name="otp_10302-last_expr"/><a name="2901"/> 2901:     ok.
<a name="2902"/> 2902: 
<a name="otp_13719-1"/><a name="2903"/> 2903: <b>otp_13719</b>(Config) when is_list(Config) -&gt;
<a name="2904"/> 2904:     Test = &lt;&lt;&quot;-module(otp_13719).
<a name="2905"/> 2905:               -record(bar, {}).
<a name="2906"/> 2906:               -record(foo, {bar :: #bar{}}).&quot;&gt;&gt;,
<a name="2907"/> 2907:     File = filename(&quot;otp_13719.erl&quot;, Config),
<a name="2908"/> 2908:     Beam = filename(&quot;otp_13719.beam&quot;, Config),
<a name="2909"/> 2909:     ok = compile_file(Config, File, Test, []),
<a name="2910"/> 2910:     RR = &quot;rr(\&quot;&quot; ++ Beam ++ &quot;\&quot;). #foo{}.&quot;,
<a name="2911"/> 2911:     &quot;[bar,foo]\n#foo{bar = undefined}.\n&quot; = t(RR),
<a name="2912"/> 2912:     file:delete(filename(&quot;test.beam&quot;, Config)),
<a name="2913"/> 2913:     file:delete(File),
<a name="otp_13719-last_expr"/><a name="2914"/> 2914:     ok.
<a name="2915"/> 2915: 
<a name="otp_14285-1"/><a name="2916"/> 2916: <b>otp_14285</b>(Config) -&gt;
<a name="2917"/> 2917:     {ok, Peer, Node} = ?CT_PEER([&quot;-pa&quot;, proplists:get_value(priv_dir,Config),
<a name="2918"/> 2918:         &quot;+pc&quot;, &quot;unicode&quot;]),
<a name="2919"/> 2919:     Test1 =
<a name="2920"/> 2920:         &lt;&lt;&quot;begin
<a name="2921"/> 2921:                io:setopts([{encoding,utf8}]),
<a name="2922"/> 2922:                [1024] = atom_to_list('\\x{400}'),
<a name="2923"/> 2923:                rd('\\x{400}', {'\\x{400}' = '\\x{400}'}),
<a name="2924"/> 2924:                ok = rl('\\x{400}')
<a name="2925"/> 2925:            end.&quot;&gt;&gt;,
<a name="2926"/> 2926:     &quot;-record('\x{400}',{'\x{400}' = '\x{400}'}).\nok.\n&quot; =
<a name="2927"/> 2927:         t({Node,Test1}),
<a name="2928"/> 2928:     peer:stop(Peer),
<a name="otp_14285-last_expr"/><a name="2929"/> 2929:     ok.
<a name="2930"/> 2930: 
<a name="otp_14296-1"/><a name="2931"/> 2931: <b>otp_14296</b>(Config) when is_list(Config) -&gt;
<a name="2932"/> 2932:     fun() -&gt;
<a name="2933"/> 2933:             F = fun() -&gt; a end,
<a name="2934"/> 2934:             LocalFun = term_to_string(F),
<a name="2935"/> 2935:             S = LocalFun ++ &quot;.&quot;,
<a name="2936"/> 2936:             &quot;1:2: syntax error before: Fun&quot; = comm_err(S)
<a name="2937"/> 2937:     end(),
<a name="2938"/> 2938: 
<a name="2939"/> 2939:     fun() -&gt;
<a name="2940"/> 2940:             F = fun mod:func/1,
<a name="2941"/> 2941:             ExternalFun = term_to_string(F),
<a name="2942"/> 2942:             S = ExternalFun ++ &quot;.&quot;,
<a name="2943"/> 2943:             R = ExternalFun ++ &quot;.\n&quot;,
<a name="2944"/> 2944:             R = t(S)
<a name="2945"/> 2945:     end(),
<a name="2946"/> 2946: 
<a name="2947"/> 2947:     fun() -&gt;
<a name="2948"/> 2948:             UnknownPid = &quot;&lt;100000.0.0&gt;&quot;,
<a name="2949"/> 2949:             S = UnknownPid ++ &quot;.&quot;,
<a name="2950"/> 2950:             &quot;1:1: syntax error before: '&lt;'&quot; = comm_err(S)
<a name="2951"/> 2951:     end(),
<a name="2952"/> 2952: 
<a name="2953"/> 2953:     fun() -&gt;
<a name="2954"/> 2954:             KnownPid = term_to_string(self()),
<a name="2955"/> 2955:             S = KnownPid ++ &quot;.&quot;,
<a name="2956"/> 2956:             R = KnownPid ++ &quot;.\n&quot;,
<a name="2957"/> 2957:             R = t(S)
<a name="2958"/> 2958:     end(),
<a name="2959"/> 2959: 
<a name="2960"/> 2960:     fun() -&gt;
<a name="2961"/> 2961:             Port = open_port({spawn, &quot;erl -s erlang halt&quot;}, [{line,1}]),
<a name="2962"/> 2962:             KnownPort = erlang:port_to_list(Port),
<a name="2963"/> 2963:             S = KnownPort ++ &quot;.&quot;,
<a name="2964"/> 2964:             R = KnownPort ++ &quot;.\n&quot;,
<a name="2965"/> 2965:             R = t(S)
<a name="2966"/> 2966:     end(),
<a name="2967"/> 2967: 
<a name="2968"/> 2968:     fun() -&gt;
<a name="2969"/> 2969:             UnknownPort = &quot;#Port&lt;100000.0&gt;&quot;,
<a name="2970"/> 2970:             S = UnknownPort ++ &quot;.&quot;,
<a name="2971"/> 2971:             &quot;1:2: syntax error before: Port&quot; = comm_err(S)
<a name="2972"/> 2972:     end(),
<a name="2973"/> 2973: 
<a name="2974"/> 2974:     fun() -&gt;
<a name="2975"/> 2975:             UnknownRef = &quot;#Ref&lt;100000.0.0.0&gt;&quot;,
<a name="2976"/> 2976:             S = UnknownRef ++ &quot;.&quot;,
<a name="2977"/> 2977:             &quot;1:2: syntax error before: Ref&quot; = comm_err(S)
<a name="2978"/> 2978:     end(),
<a name="2979"/> 2979: 
<a name="2980"/> 2980:     fun() -&gt;
<a name="2981"/> 2981:             KnownRef = term_to_string(make_ref()),
<a name="2982"/> 2982:             S = KnownRef ++ &quot;.&quot;,
<a name="2983"/> 2983:             R = KnownRef ++ &quot;.\n&quot;,
<a name="2984"/> 2984:             R = t(S)
<a name="2985"/> 2985:     end(),
<a name="2986"/> 2986: 
<a name="2987"/> 2987:     %% Test erl_eval:extended_parse_term/1
<a name="2988"/> 2988:     TF = fun(S) -&gt;
<a name="2989"/> 2989:                  {ok, Ts, _} = erl_scan:string(S++&quot;.&quot;, 1, [text]),
<a name="2990"/> 2990:                  case erl_eval:extended_parse_term(Ts) of
<a name="2991"/> 2991:                      {ok, Term} -&gt; Term;
<a name="2992"/> 2992:                      {error, _}=Error -&gt; Error
<a name="2993"/> 2993:                  end
<a name="2994"/> 2994:          end,
<a name="2995"/> 2995:     Fun = fun m:f/1,
<a name="2996"/> 2996:     Fun = TF(term_to_string(Fun)),
<a name="2997"/> 2997:     Fun = TF(&quot;fun m:f/1&quot;),
<a name="2998"/> 2998:     Pid = self(),
<a name="2999"/> 2999:     Pid = TF(term_to_string(Pid)),
<a name="3000"/> 3000:     Ref = make_ref(),
<a name="3001"/> 3001:     Ref = TF(term_to_string(Ref)),
<a name="3002"/> 3002:     Term = {[10, a], {&quot;foo&quot;, []}, #{x =&gt; &lt;&lt;&quot;bar&quot;&gt;&gt;}},
<a name="3003"/> 3003:     Term = TF(lists:flatten(io_lib:format(&quot;~p&quot;, [Term]))),
<a name="3004"/> 3004:     {$a, F1, &quot;foo&quot;} = TF(&quot;{$a, 1.0, \&quot;foo\&quot;}&quot;),
<a name="3005"/> 3005:     true = is_float(F1),
<a name="3006"/> 3006:     3 = TF(&quot;+3&quot;),
<a name="3007"/> 3007:     $a = TF(&quot;+$a&quot;),
<a name="3008"/> 3008:     true = is_float(TF(&quot;+1.0&quot;)),
<a name="3009"/> 3009:     true  = -3 =:= TF(&quot;-3&quot;),
<a name="3010"/> 3010:     true = -$a =:= TF(&quot;-$a&quot;),
<a name="3011"/> 3011:     true = is_float(TF(&quot;-1.0&quot;)),
<a name="3012"/> 3012:     {error, {_, _, [&quot;syntax error&quot;++_|_]}} = TF(&quot;{1&quot;),
<a name="3013"/> 3013:     {error, {_,_,&quot;bad term&quot;}} = TF(&quot;fun() -&gt; foo end&quot;),
<a name="3014"/> 3014:     {error, {_,_,&quot;bad term&quot;}} = TF(&quot;1, 2&quot;),
<a name="otp_14296-last_expr"/><a name="3015"/> 3015:     ok.
<a name="3016"/> 3016: 
<a name="term_to_string-1"/><a name="3017"/> 3017: <b>term_to_string</b>(T) -&gt;
<a name="term_to_string-last_expr"/><a name="3018"/> 3018: <b>    lists:flatten</b>(io_lib:format(&quot;~w&quot;, [T])).
<a name="3019"/> 3019: 
<a name="scan-1"/><a name="3020"/> 3020: <b>scan</b>(B) -&gt;
<a name="3021"/> 3021:     F = fun(Ts) -&gt; 
<a name="3022"/> 3022:                 case erl_parse:parse_term(Ts) of
<a name="3023"/> 3023:                     {ok,Term} -&gt;
<a name="3024"/> 3024:                         Term;
<a name="3025"/> 3025:                     _Error -&gt;
<a name="3026"/> 3026:                         {ok,Form} = erl_parse:parse_form(Ts),
<a name="3027"/> 3027:                         Form
<a name="3028"/> 3028:                 end
<a name="3029"/> 3029:         end,
<a name="scan-last_expr"/><a name="3030"/> 3030: <b>    scan</b>(t(B), F).
<a name="3031"/> 3031: 
<a name="scan-2"/><a name="3032"/> 3032: <b>scan</b>(S0, F) -&gt;
<a name="scan-last_expr"/><a name="3033"/> 3033: <b>    case erl_scan:tokens</b>([], S0, 1) of
<a name="3034"/> 3034:         {done,{ok,Ts,_},S} -&gt;
<a name="3035"/> 3035:             [F(Ts) | scan(S, F)];
<a name="3036"/> 3036:         _Else -&gt;
<a name="3037"/> 3037:             []
<a name="3038"/> 3038:     end.
<a name="3039"/> 3039: 
<a name="t-1"/><a name="3040"/> 3040: <b>t</b>({Node,Bin,Enc}) when is_atom(Node),is_binary(Bin), is_atom(Enc) -&gt;
<a name="3041"/> 3041:     t0({Bin,Enc}, fun() -&gt; start_new_shell(Node) end);
<a name="3042"/> 3042: <b>t</b>({Node,Bin}) when is_atom(Node),is_binary(Bin) -&gt;
<a name="3043"/> 3043:     t0({Bin,latin1}, fun() -&gt; start_new_shell(Node) end);
<a name="3044"/> 3044: <b>t</b>(Bin) when is_binary(Bin) -&gt;
<a name="3045"/> 3045:     t0({Bin,latin1}, fun() -&gt; start_new_shell() end);
<a name="3046"/> 3046: <b>t</b>({Bin,Enc}) when is_binary(Bin), is_atom(Enc) -&gt;
<a name="3047"/> 3047:     t0({Bin,Enc}, fun() -&gt; start_new_shell() end);
<a name="3048"/> 3048: <b>t</b>(L) -&gt;
<a name="t-last_expr"/><a name="3049"/> 3049: <b>    t</b>(list_to_binary(L)).
<a name="3050"/> 3050: 
<a name="t0-2"/><a name="3051"/> 3051: <b>t0</b>({Bin,Enc}, F) -&gt;
<a name="3052"/> 3052:     %% Spawn a process so that io_request messages do not interfer.
<a name="3053"/> 3053:     P = self(),
<a name="3054"/> 3054:     C = spawn(fun() -&gt; t1(P, {Bin, Enc}, F) end),
<a name="t0-last_expr"/><a name="3055"/> 3055:     receive {C, R} -&gt; R end.
<a name="3056"/> 3056: 
<a name="t1-3"/><a name="3057"/> 3057: <b>t1</b>(Parent, {Bin,Enc}, F) -&gt;
<a name="3058"/> 3058:     io:format(&quot;*** Testing ~s~n&quot;, [binary_to_list(Bin)]),
<a name="3059"/> 3059:     S = #state{bin = Bin, unic = Enc, reply = [], leader = group_leader()},
<a name="3060"/> 3060:     group_leader(self(), self()),
<a name="3061"/> 3061:     _Shell = F(),
<a name="t1-last_expr"/><a name="3062"/> 3062:     try 
<a name="3063"/> 3063:         server_loop(S)
<a name="3064"/> 3064:     catch exit:R -&gt; Parent ! {self(), R};
<a name="3065"/> 3065:           throw:{?MODULE,LoopReply,latin1} -&gt;
<a name="3066"/> 3066: 	    L0 = binary_to_list(list_to_binary(LoopReply)),
<a name="3067"/> 3067: 	    [$\n | L1] = lists:dropwhile(fun(X) -&gt; X =/= $\n end, L0),
<a name="3068"/> 3068: 	    Parent ! {self(), dotify(L1)};
<a name="3069"/> 3069:           throw:{?MODULE,LoopReply,_Uni} -&gt;
<a name="3070"/> 3070: 	    Tmp = unicode:characters_to_binary(LoopReply),
<a name="3071"/> 3071: 	    L0 = unicode:characters_to_list(Tmp),
<a name="3072"/> 3072: 	    [$\n | L1] = lists:dropwhile(fun(X) -&gt; X =/= $\n end, L0),
<a name="3073"/> 3073: 	    Parent ! {self(), dotify(L1)}
<a name="3074"/> 3074:     after group_leader(S#state.leader, self())
<a name="3075"/> 3075:     end.
<a name="3076"/> 3076: 
<a name="dotify-1"/><a name="3077"/> 3077: <b>dotify</b>([$., $\n | L]) -&gt;
<a name="3078"/> 3078:     [$., $\n | dotify(L)];
<a name="3079"/> 3079: <b>dotify</b>([$,, $\n | L]) -&gt;
<a name="3080"/> 3080:     [$,, $\n | dotify(L)];
<a name="3081"/> 3081: <b>dotify</b>(&quot;ok\n&quot; ++ L) -&gt;
<a name="3082"/> 3082:     &quot;ok.\n&quot; ++ dotify(L);
<a name="3083"/> 3083: <b>dotify</b>(&quot;\nok\n&quot; ++ L) -&gt;
<a name="3084"/> 3084:     &quot;.\nok.\n&quot; ++ dotify(L);
<a name="3085"/> 3085: <b>dotify</b>([$\n]) -&gt;
<a name="3086"/> 3086:     [$., $\n];
<a name="3087"/> 3087: <b>dotify</b>([C | L]) -&gt;
<a name="3088"/> 3088:     [C | dotify(L)];
<a name="3089"/> 3089: <b>dotify</b>([]) -&gt;
<a name="dotify-last_expr"/><a name="3090"/> 3090:     [].
<a name="3091"/> 3091: 
<a name="start_new_shell-0"/><a name="3092"/> 3092: <b>start_new_shell</b>() -&gt;
<a name="3093"/> 3093:     Shell = shell:start(),
<a name="3094"/> 3094:     link(Shell),
<a name="start_new_shell-last_expr"/><a name="3095"/> 3095:     Shell.
<a name="3096"/> 3096: 
<a name="start_new_shell-1"/><a name="3097"/> 3097: <b>start_new_shell</b>(Node) -&gt;
<a name="3098"/> 3098:     Shell = rpc:call(Node,shell,start,[]),
<a name="3099"/> 3099:     link(Shell),
<a name="start_new_shell-last_expr"/><a name="3100"/> 3100:     Shell.
<a name="3101"/> 3101: 
<a name="3102"/> 3102: <i>%% This is a very minimal implementation of the IO protocol...</i>
<a name="3103"/> 3103: 
<a name="server_loop-1"/><a name="3104"/> 3104: <b>server_loop</b>(S) -&gt;
<a name="server_loop-last_expr"/><a name="3105"/> 3105:     receive 
<a name="3106"/> 3106:         {io_request, From, ReplyAs, Request} when is_pid(From) -&gt;
<a name="3107"/> 3107: 	    server_loop(do_io_request(Request, From, S, ReplyAs));
<a name="3108"/> 3108: 	NotExpected -&gt;
<a name="3109"/> 3109:             exit(NotExpected)
<a name="3110"/> 3110:     end.
<a name="3111"/> 3111:             
<a name="do_io_request-4"/><a name="3112"/> 3112: <b>do_io_request</b>(Req, From, S, ReplyAs) -&gt;
<a name="do_io_request-last_expr"/><a name="3113"/> 3113: <b>    case io_requests</b>([Req], [], S) of
<a name="3114"/> 3114:         {_Status,{eof,_},S1} -&gt;
<a name="3115"/> 3115: 	    io_reply(From, ReplyAs, {error,terminated}),
<a name="3116"/> 3116: 	    throw({?MODULE,S1#state.reply,S1#state.unic});
<a name="3117"/> 3117: 	{_Status,Reply,S1} -&gt;
<a name="3118"/> 3118: 	    io_reply(From, ReplyAs, Reply),
<a name="3119"/> 3119: 	    S1
<a name="3120"/> 3120:     end.
<a name="3121"/> 3121: 
<a name="io_reply-3"/><a name="3122"/> 3122: <b>io_reply</b>(From, ReplyAs, Reply) -&gt;
<a name="io_reply-last_expr"/><a name="3123"/> 3123:     From ! {io_reply, ReplyAs, Reply}.
<a name="3124"/> 3124: 
<a name="io_requests-3"/><a name="3125"/> 3125: <b>io_requests</b>([{requests, Rs1} | Rs], Cont, S) -&gt;
<a name="3126"/> 3126:     io_requests(Rs1, [Rs | Cont], S);
<a name="3127"/> 3127: <b>io_requests</b>([R | Rs], Cont, S) -&gt;
<a name="3128"/> 3128:     case io_request(R, S) of
<a name="3129"/> 3129:         {ok, ok, S1} -&gt;
<a name="3130"/> 3130:             io_requests(Rs, Cont, S1);
<a name="3131"/> 3131:         Reply -&gt;
<a name="3132"/> 3132:             Reply
<a name="3133"/> 3133:     end;
<a name="3134"/> 3134: <b>io_requests</b>([], [Rs|Cont], S) -&gt;
<a name="3135"/> 3135:     io_requests(Rs, Cont, S);
<a name="3136"/> 3136: <b>io_requests</b>([], [], S) -&gt; 
<a name="io_requests-last_expr"/><a name="3137"/> 3137:     {ok,ok,S}.
<a name="3138"/> 3138: 
<a name="io_request-2"/><a name="3139"/> 3139: <b>io_request</b>({setopts, Opts}, S) -&gt;
<a name="3140"/> 3140:     #state{unic = OldEnc, bin = Bin} = S,
<a name="3141"/> 3141:     NewEnc = case proplists:get_value(encoding, Opts) of
<a name="3142"/> 3142:                  undefined -&gt; OldEnc;
<a name="3143"/> 3143:                  utf8 -&gt; unicode;
<a name="3144"/> 3144:                  New -&gt; New
<a name="3145"/> 3145:              end,
<a name="3146"/> 3146:     NewBin = case {OldEnc, NewEnc} of
<a name="3147"/> 3147:                  {E, E} -&gt; Bin;
<a name="3148"/> 3148:                  {latin1, _} -&gt;
<a name="3149"/> 3149:                      unicode:characters_to_binary(Bin, latin1, unicode);
<a name="3150"/> 3150:                  {_, latin1} -&gt;
<a name="3151"/> 3151:                      unicode:characters_to_binary(Bin, unicode, latin1);
<a name="3152"/> 3152:                  {_, _} -&gt; Bin
<a name="3153"/> 3153:              end,
<a name="3154"/> 3154:     {ok, ok, S#state{unic = NewEnc, bin = NewBin}};
<a name="3155"/> 3155: <b>io_request</b>(getopts, S) -&gt;
<a name="3156"/> 3156:     {ok,[{encoding,S#state.unic}],S};
<a name="3157"/> 3157: <b>io_request</b>({get_geometry,columns}, S) -&gt;
<a name="3158"/> 3158:     {ok,80,S};
<a name="3159"/> 3159: <b>io_request</b>({get_geometry,rows}, S) -&gt;
<a name="3160"/> 3160:     {ok,24,S};
<a name="3161"/> 3161: <b>io_request</b>({put_chars,latin1,Chars}, S) -&gt;
<a name="3162"/> 3162:     {ok,ok,S#state{reply = [S#state.reply | Chars]}};
<a name="3163"/> 3163: <b>io_request</b>({put_chars,unicode,Chars0}, S) -&gt;
<a name="3164"/> 3164:     Chars = unicode:characters_to_list(Chars0),
<a name="3165"/> 3165:     {ok,ok,S#state{reply = [S#state.reply | Chars]}};
<a name="3166"/> 3166: <b>io_request</b>({put_chars,Enc,Mod,Func,Args}, S) -&gt;
<a name="3167"/> 3167:     case catch apply(Mod, Func, Args) of
<a name="3168"/> 3168:         Chars when is_list(Chars) -&gt; 
<a name="3169"/> 3169:             io_request({put_chars,Enc,Chars}, S)
<a name="3170"/> 3170:     end;
<a name="3171"/> 3171: <b>io_request</b>({get_until,Enc,_Prompt,Mod,Func,ExtraArgs}, S) -&gt;
<a name="io_request-last_expr"/><a name="3172"/> 3172: <b>    get_until</b>(Mod, Func, ExtraArgs, S, Enc).
<a name="3173"/> 3173: 
<a name="get_until-5"/><a name="3174"/> 3174: <b>get_until</b>(Mod, Func, ExtraArgs, S, Enc) -&gt;
<a name="get_until-last_expr"/><a name="3175"/> 3175: <b>    get_until_loop</b>(Mod, Func, ExtraArgs, S, {more,[]}, Enc).
<a name="3176"/> 3176: 
<a name="get_until_loop-6"/><a name="3177"/> 3177: <b>get_until_loop</b>(M, F, As, S, {more,Cont}, Enc) -&gt;
<a name="3178"/> 3178:     Bin = S#state.bin,
<a name="3179"/> 3179:     case byte_size(Bin) of
<a name="3180"/> 3180:         0 -&gt;
<a name="3181"/> 3181:             get_until_loop(M, F, As, S, 
<a name="3182"/> 3182:                            catch apply(M, F, [Cont,eof|As]), Enc);
<a name="3183"/> 3183: 	_ when S#state.unic =:= latin1 -&gt;
<a name="3184"/> 3184: 	    get_until_loop(M, F, As, S#state{bin = &lt;&lt;&gt;&gt;},
<a name="3185"/> 3185: 			   catch apply(M, F, [Cont,binary_to_list(Bin)|As]), Enc);
<a name="3186"/> 3186: 	_ -&gt;
<a name="3187"/> 3187: 	    get_until_loop(M, F, As, S#state{bin = &lt;&lt;&gt;&gt;},
<a name="3188"/> 3188: 			   catch apply(M, F, [Cont,unicode:characters_to_list(Bin)|As]), Enc)
<a name="3189"/> 3189:     end;
<a name="3190"/> 3190: <b>get_until_loop</b>(_M, _F, _As, S, {done,Res,Buf}, Enc) -&gt;
<a name="3191"/> 3191:     {ok,Res,S#state{bin = buf2bin(Buf, Enc)}};
<a name="3192"/> 3192: <b>get_until_loop</b>(_M, F, _As, S, _Other, _Enc) -&gt;
<a name="get_until_loop-last_expr"/><a name="3193"/> 3193:     {error,{error,F},S}.
<a name="3194"/> 3194: 
<a name="buf2bin-2"/><a name="3195"/> 3195: <b>buf2bin</b>(eof,_) -&gt;
<a name="3196"/> 3196:     &lt;&lt;&gt;&gt;;
<a name="3197"/> 3197: <b>buf2bin</b>(Buf,latin1) -&gt;
<a name="3198"/> 3198:     list_to_binary(Buf);
<a name="3199"/> 3199: <b>buf2bin</b>(Buf,utf8) -&gt;
<a name="3200"/> 3200:     unicode:characters_to_binary(Buf,unicode,unicode);
<a name="3201"/> 3201: <b>buf2bin</b>(Buf,unicode) -&gt;
<a name="buf2bin-last_expr"/><a name="3202"/> 3202: <b>    unicode:characters_to_binary</b>(Buf,unicode,unicode).
<a name="3203"/> 3203: 
<a name="run_file-3"/><a name="3204"/> 3204: <b>run_file</b>(Config, Module, Test) -&gt;
<a name="3205"/> 3205:     FileName = filename(lists:concat([Module, &quot;.erl&quot;]), Config),
<a name="3206"/> 3206:     BeamFile = filename(lists:concat([Module, &quot;.beam&quot;]), Config),
<a name="3207"/> 3207:     LoadBeamFile = filename(Module, Config),
<a name="3208"/> 3208:     ok = file:write_file(FileName, Test),
<a name="3209"/> 3209:     ok = compile_file(Config, FileName, Test, []),
<a name="3210"/> 3210:     code:purge(Module),
<a name="3211"/> 3211:     {module, Module} = code:load_abs(LoadBeamFile), 
<a name="3212"/> 3212:     ok = Module:t(),
<a name="3213"/> 3213:     file:delete(FileName),
<a name="3214"/> 3214:     file:delete(BeamFile),
<a name="run_file-last_expr"/><a name="3215"/> 3215:     ok.
<a name="3216"/> 3216: 
<a name="compile_file-4"/><a name="3217"/> 3217: <b>compile_file</b>(Config, File, Test, Opts0) -&gt;
<a name="3218"/> 3218:     Opts = [export_all,nowarn_export_all,return,{outdir,proplists:get_value(priv_dir, Config)}|Opts0],
<a name="3219"/> 3219:     ok = file:write_file(File, Test),
<a name="compile_file-last_expr"/><a name="3220"/> 3220: <b>    case compile:file</b>(File, Opts) of
<a name="3221"/> 3221:               {ok, _M, _Ws} -&gt; ok;
<a name="3222"/> 3222:               _ -&gt; error
<a name="3223"/> 3223:           end.
<a name="3224"/> 3224: 
<a name="filename-2"/><a name="3225"/> 3225: <b>filename</b>(Name, Config) when is_atom(Name) -&gt;
<a name="3226"/> 3226:     filename(atom_to_list(Name), Config);
<a name="3227"/> 3227: <b>filename</b>(Name, Config) -&gt;
<a name="filename-last_expr"/><a name="3228"/> 3228: <b>    filename:join</b>(proplists:get_value(priv_dir, Config), Name).
<a name="3229"/> 3229: 
<a name="purge_and_delete-1"/><a name="3230"/> 3230: <b>purge_and_delete</b>(Module) -&gt;
<a name="3231"/> 3231:     (catch code:purge(Module)),
<a name="purge_and_delete-last_expr"/><a name="3232"/> 3232: <b>    </b>(catch code:delete(Module)).
</pre>
</body>
</html>
