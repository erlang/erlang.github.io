<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/ssh/make_test_dir/ssh_test/ssh_sftpd_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2006-2024. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <b>-module</b>(ssh_sftpd_SUITE).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-export</b>([
<a name="25"/>   25:          suite/0,
<a name="26"/>   26:          all/0,
<a name="27"/>   27:          groups/0,
<a name="28"/>   28:          init_per_suite/1,
<a name="29"/>   29:          end_per_suite/1,
<a name="30"/>   30:          init_per_group/2,
<a name="31"/>   31:          end_per_group/2,
<a name="32"/>   32:          init_per_testcase/2,
<a name="33"/>   33:          end_per_testcase/2
<a name="34"/>   34:         ]).
<a name="35"/>   35: 
<a name="36"/>   36: <b>-export</b>([
<a name="37"/>   37:          access_outside_root/1,
<a name="38"/>   38:          links/1,
<a name="39"/>   39:          mk_rm_dir/1,
<a name="40"/>   40:          open_close_dir/1,
<a name="41"/>   41:          open_close_file/1,
<a name="42"/>   42:          open_file_dir_v5/1,
<a name="43"/>   43:          open_file_dir_v6/1,
<a name="44"/>   44:          read_dir/1,
<a name="45"/>   45:          read_file/1,
<a name="46"/>   46:          real_path/1,
<a name="47"/>   47:          relative_path/1,
<a name="48"/>   48:          relpath/1,
<a name="49"/>   49:          remove_file/1,
<a name="50"/>   50:          rename_file/1,
<a name="51"/>   51:          retrieve_attributes/1,
<a name="52"/>   52:          root_with_cwd/1,
<a name="53"/>   53:          set_attributes/1,
<a name="54"/>   54:          sshd_read_file/1,
<a name="55"/>   55:          ver3_open_flags/1,
<a name="56"/>   56:          ver3_rename/1,
<a name="57"/>   57:          ver6_basic/1,
<a name="58"/>   58:          write_file/1
<a name="59"/>   59:         ]).
<a name="60"/>   60: 
<a name="61"/>   61: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="62"/>   62: <b>-include_lib</b>(&quot;kernel/include/file.hrl&quot;).
<a name="63"/>   63: <b>-include</b>(&quot;ssh_xfer.hrl&quot;).
<a name="64"/>   64: <b>-include</b>(&quot;ssh.hrl&quot;).
<a name="65"/>   65: <b>-include</b>(&quot;ssh_test_lib.hrl&quot;).
<a name="66"/>   66: 
<a name="67"/>   67: <b>-define</b>(USER, &quot;Alladin&quot;).
<a name="68"/>   68: <b>-define</b>(PASSWD, &quot;Sesame&quot;).
<a name="69"/>   69: <i>%% -define(XFER_PACKET_SIZE, 32768).</i>
<a name="70"/>   70: <i>%% -define(XFER_WINDOW_SIZE, 4*?XFER_PACKET_SIZE).</i>
<a name="71"/>   71: <b>-define</b>(SSH_TIMEOUT, 5000).
<a name="72"/>   72: <b>-define</b>(REG_ATTERS, &lt;&lt;0,0,0,0,1&gt;&gt;).
<a name="73"/>   73: <b>-define</b>(UNIX_EPOCH,  62167219200).
<a name="74"/>   74: 
<a name="75"/>   75: <b>-define</b>(is_set(F, Bits),
<a name="76"/>   76: 	((F) band (Bits)) == (F)).
<a name="77"/>   77: 
<a name="78"/>   78: <i>%%--------------------------------------------------------------------</i>
<a name="79"/>   79: <i>%% Common Test interface functions -----------------------------------</i>
<a name="80"/>   80: <i>%%--------------------------------------------------------------------</i>
<a name="81"/>   81: 
<a name="suite-0"/><a name="82"/>   82: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="83"/>   83:     [{timetrap,{seconds,20}}].
<a name="84"/>   84: 
<a name="all-0"/><a name="85"/>   85: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="86"/>   86:     [open_close_file, 
<a name="87"/>   87:      open_close_dir, 
<a name="88"/>   88:      read_file, 
<a name="89"/>   89:      read_dir,
<a name="90"/>   90:      write_file, 
<a name="91"/>   91:      rename_file, 
<a name="92"/>   92:      mk_rm_dir, 
<a name="93"/>   93:      remove_file,
<a name="94"/>   94:      real_path, 
<a name="95"/>   95:      retrieve_attributes, 
<a name="96"/>   96:      set_attributes, 
<a name="97"/>   97:      links,
<a name="98"/>   98:      ver3_rename,
<a name="99"/>   99:      ver3_open_flags,
<a name="100"/>  100:      relpath, 
<a name="101"/>  101:      sshd_read_file,
<a name="102"/>  102:      ver6_basic,
<a name="103"/>  103:      access_outside_root,
<a name="104"/>  104:      root_with_cwd,
<a name="105"/>  105:      relative_path,
<a name="106"/>  106:      open_file_dir_v5,
<a name="107"/>  107:      open_file_dir_v6].
<a name="108"/>  108: 
<a name="groups-0"/><a name="109"/>  109: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="110"/>  110:     [].
<a name="111"/>  111: 
<a name="112"/>  112: <i>%%--------------------------------------------------------------------</i>
<a name="113"/>  113: 
<a name="init_per_suite-1"/><a name="114"/>  114: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="115"/>  115: <b>    ?CHECK_CRYPTO</b>(
<a name="116"/>  116:        begin
<a name="117"/>  117:            ssh:start(),
<a name="118"/>  118:            ct:log(&quot;Pub keys setup for: ~p&quot;,
<a name="119"/>  119:                   [ssh_test_lib:setup_all_user_host_keys(Config)]),
<a name="120"/>  120: 	   %% to make sure we don't use public-key-auth
<a name="121"/>  121: 	   %% this should be tested by other test suites
<a name="122"/>  122: 	   UserDir = filename:join(proplists:get_value(priv_dir, Config), nopubkey), 
<a name="123"/>  123: 	   file:make_dir(UserDir),  
<a name="124"/>  124: 	   Config
<a name="125"/>  125:        end).
<a name="126"/>  126: 
<a name="end_per_suite-1"/><a name="127"/>  127: <b>end_per_suite</b>(Config) -&gt;
<a name="128"/>  128:     UserDir = filename:join(proplists:get_value(priv_dir, Config), nopubkey),
<a name="129"/>  129:     file:del_dir(UserDir),
<a name="end_per_suite-last_expr"/><a name="130"/>  130: <b>    ssh:stop</b>().
<a name="131"/>  131: 
<a name="132"/>  132: <i>%%--------------------------------------------------------------------</i>
<a name="133"/>  133: 
<a name="init_per_group-2"/><a name="134"/>  134: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="135"/>  135: 	Config.
<a name="136"/>  136: 
<a name="end_per_group-2"/><a name="137"/>  137: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="138"/>  138: 	Config.
<a name="139"/>  139: 
<a name="140"/>  140: <i>%%--------------------------------------------------------------------</i>
<a name="141"/>  141: 
<a name="init_per_testcase-2"/><a name="142"/>  142: <b>init_per_testcase</b>(TestCase, Config) -&gt;
<a name="143"/>  143:     ssh:start(),
<a name="144"/>  144:     prep(Config),
<a name="145"/>  145:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="146"/>  146:     ClientUserDir = filename:join(PrivDir, nopubkey),
<a name="147"/>  147:     SystemDir = filename:join(proplists:get_value(priv_dir, Config), system),
<a name="148"/>  148: 
<a name="149"/>  149:     Options = [{system_dir, SystemDir},
<a name="150"/>  150: 	       {user_dir, PrivDir},
<a name="151"/>  151: 	       {user_passwords,[{?USER, ?PASSWD}]},
<a name="152"/>  152: 	       {pwdfun, fun(_,_) -&gt; true end}],
<a name="153"/>  153:     {ok, Sftpd} = case TestCase of
<a name="154"/>  154: 		      ver6_basic -&gt;
<a name="155"/>  155: 			  SubSystems = [ssh_sftpd:subsystem_spec([{sftpd_vsn, 6}])],
<a name="156"/>  156: 			  ssh:daemon(0, [{subsystems, SubSystems}|Options]);
<a name="157"/>  157:                       access_outside_root -&gt;
<a name="158"/>  158:                           %% Build RootDir/access_outside_root/a/b and set Root and CWD
<a name="159"/>  159:                           BaseDir = filename:join(PrivDir, access_outside_root),
<a name="160"/>  160:                           RootDir = filename:join(BaseDir, a),
<a name="161"/>  161:                           CWD     = filename:join(RootDir, b),
<a name="162"/>  162:                           %% Make the directory chain:
<a name="163"/>  163:                           ok = filelib:ensure_dir(filename:join(CWD, tmp)),
<a name="164"/>  164:                           SubSystems = [ssh_sftpd:subsystem_spec([{root, RootDir},
<a name="165"/>  165:                                                                   {cwd, CWD}])],
<a name="166"/>  166:                           ssh:daemon(0, [{subsystems, SubSystems}|Options]);
<a name="167"/>  167: 		      root_with_cwd -&gt;
<a name="168"/>  168: 			  RootDir = filename:join(PrivDir, root_with_cwd),
<a name="169"/>  169: 			  CWD     = filename:join(RootDir, home),
<a name="170"/>  170: 			  SubSystems = [ssh_sftpd:subsystem_spec([{root, RootDir}, {cwd, CWD}])],
<a name="171"/>  171: 			  ssh:daemon(0, [{subsystems, SubSystems}|Options]);
<a name="172"/>  172: 		      relative_path -&gt;
<a name="173"/>  173: 			  SubSystems = [ssh_sftpd:subsystem_spec([{cwd, PrivDir}])],
<a name="174"/>  174: 			  ssh:daemon(0, [{subsystems, SubSystems}|Options]);
<a name="175"/>  175: 		      open_file_dir_v5 -&gt;
<a name="176"/>  176: 			  SubSystems = [ssh_sftpd:subsystem_spec([{cwd, PrivDir}])],
<a name="177"/>  177: 			  ssh:daemon(0, [{subsystems, SubSystems}|Options]);
<a name="178"/>  178: 		      open_file_dir_v6 -&gt;
<a name="179"/>  179: 			  SubSystems = [ssh_sftpd:subsystem_spec([{cwd, PrivDir},
<a name="180"/>  180: 								  {sftpd_vsn, 6}])],
<a name="181"/>  181: 			  ssh:daemon(0, [{subsystems, SubSystems}|Options]);
<a name="182"/>  182: 		      _ -&gt;
<a name="183"/>  183: 			  SubSystems = [ssh_sftpd:subsystem_spec([])],
<a name="184"/>  184: 			  ssh:daemon(0, [{subsystems, SubSystems}|Options])
<a name="185"/>  185: 		  end,
<a name="186"/>  186: 
<a name="187"/>  187:     Port = ssh_test_lib:daemon_port(Sftpd),
<a name="188"/>  188:     
<a name="189"/>  189:     Cm = ssh_test_lib:connect(Port,
<a name="190"/>  190: 			      [{user_dir, ClientUserDir},
<a name="191"/>  191: 			       {user, ?USER}, {password, ?PASSWD},
<a name="192"/>  192: 			       {user_interaction, false},
<a name="193"/>  193: 			       {silently_accept_hosts, true}]),
<a name="194"/>  194:     {ok, Channel} =
<a name="195"/>  195: 	ssh_connection:session_channel(Cm, ?XFER_WINDOW_SIZE,
<a name="196"/>  196: 				       ?XFER_PACKET_SIZE, ?SSH_TIMEOUT),
<a name="197"/>  197:     
<a name="198"/>  198:     success = ssh_connection:subsystem(Cm, Channel, &quot;sftp&quot;, ?SSH_TIMEOUT),
<a name="199"/>  199: 
<a name="200"/>  200:     ProtocolVer = case atom_to_list(TestCase) of
<a name="201"/>  201: 		      &quot;ver3_&quot; ++ _ -&gt;
<a name="202"/>  202: 			  3;
<a name="203"/>  203: 		      _ -&gt;
<a name="204"/>  204: 			  ?SSH_SFTP_PROTOCOL_VERSION
<a name="205"/>  205: 		  end,
<a name="206"/>  206: 
<a name="207"/>  207:     Data = &lt;&lt;?UINT32(ProtocolVer)&gt;&gt; ,
<a name="208"/>  208: 
<a name="209"/>  209:     Size = 1 + size(Data),
<a name="210"/>  210: 
<a name="211"/>  211:     ssh_connection:send(Cm, Channel, &lt;&lt; ?UINT32(Size),
<a name="212"/>  212: 				      ?SSH_FXP_INIT, Data/binary &gt;&gt;),
<a name="213"/>  213: 
<a name="214"/>  214:     {ok, &lt;&lt;?SSH_FXP_VERSION, ?UINT32(Version), _Ext/binary&gt;&gt;, _}
<a name="215"/>  215: 	= reply(Cm, Channel),
<a name="216"/>  216: 
<a name="217"/>  217:     ct:log(&quot;Client: ~p Server ~p~n&quot;, [ProtocolVer, Version]),
<a name="218"/>  218: 
<a name="init_per_testcase-last_expr"/><a name="219"/>  219:     [{sftp, {Cm, Channel}}, {sftpd, Sftpd }| Config].
<a name="220"/>  220: 
<a name="end_per_testcase-2"/><a name="221"/>  221: <b>end_per_testcase</b>(_TestCase, Config) -&gt;
<a name="222"/>  222:     catch ssh:stop_daemon(proplists:get_value(sftpd, Config)),
<a name="223"/>  223:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="224"/>  224:     ssh_connection:close(Cm, Channel),
<a name="225"/>  225:     ssh:close(Cm),
<a name="end_per_testcase-last_expr"/><a name="226"/>  226: <b>    ssh:stop</b>().
<a name="227"/>  227: 
<a name="228"/>  228: <i>%%--------------------------------------------------------------------</i>
<a name="229"/>  229: <i>%% Test Cases --------------------------------------------------------</i>
<a name="230"/>  230: <i>%%--------------------------------------------------------------------</i>
<a name="open_close_file-1"/><a name="231"/>  231: <b>open_close_file</b>(Config) when is_list(Config) -&gt;
<a name="232"/>  232:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="233"/>  233:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="234"/>  234:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="235"/>  235:     ReqId = 0,
<a name="236"/>  236: 
<a name="237"/>  237:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId), Handle/binary&gt;&gt;, _} =
<a name="238"/>  238: 	open_file(FileName, Cm, Channel, ReqId,
<a name="239"/>  239: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="240"/>  240: 		  ?SSH_FXF_OPEN_EXISTING),
<a name="241"/>  241: 
<a name="242"/>  242:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="243"/>  243: 	  ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} = close(Handle, ReqId,
<a name="244"/>  244: 						      Cm, Channel),
<a name="245"/>  245:     NewReqId = ReqId + 1,
<a name="246"/>  246:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="247"/>  247: 	  ?UINT32(?SSH_FX_INVALID_HANDLE), _/binary&gt;&gt;, _} =
<a name="248"/>  248: 	close(Handle, ReqId, Cm, Channel),
<a name="249"/>  249: 
<a name="250"/>  250:     NewReqId1 = NewReqId + 1,
<a name="251"/>  251:     %%  {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId),  % Ver 6 we have 5
<a name="252"/>  252:     %% 	   ?UINT32(?SSH_FX_FILE_IS_A_DIRECTORY), _/binary&gt;&gt;, _} =
<a name="open_close_file-last_expr"/><a name="253"/>  253: <b>    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(NewReqId1),
<a name="254"/>  254: 	  ?UINT32(?SSH_FX_FAILURE), _/binary&gt;&gt;, _} =
<a name="255"/>  255: 	open_file(PrivDir, Cm, Channel, NewReqId1,
<a name="256"/>  256: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="257"/>  257: 		  ?SSH_FXF_OPEN_EXISTING).
<a name="258"/>  258: 
<a name="ver3_open_flags-1"/><a name="259"/>  259: <b>ver3_open_flags</b>(Config) when is_list(Config) -&gt;
<a name="260"/>  260:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="261"/>  261:     FileName = filename:join(PrivDir, &quot;not_exist.txt&quot;),
<a name="262"/>  262:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="263"/>  263:     ReqId = 0,
<a name="264"/>  264:     
<a name="265"/>  265:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId), Handle/binary&gt;&gt;, _} =
<a name="266"/>  266: 	open_file_v3(FileName, Cm, Channel, ReqId,
<a name="267"/>  267: 		     ?SSH_FXF_CREAT bor ?SSH_FXF_TRUNC),
<a name="268"/>  268:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="269"/>  269: 	   ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} = close(Handle, ReqId,
<a name="270"/>  270: 						       Cm, Channel),
<a name="271"/>  271:    
<a name="272"/>  272:     NewFileName = filename:join(PrivDir, &quot;not_exist2.txt&quot;),
<a name="273"/>  273:     NewReqId = ReqId + 1, 
<a name="274"/>  274:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(NewReqId), NewHandle/binary&gt;&gt;, _} =
<a name="275"/>  275:      	open_file_v3(NewFileName, Cm, Channel, NewReqId,
<a name="276"/>  276:     		     ?SSH_FXF_CREAT bor ?SSH_FXF_EXCL),
<a name="277"/>  277:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId),
<a name="278"/>  278:     	   ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} = close(NewHandle, NewReqId,
<a name="279"/>  279:     						       Cm, Channel),
<a name="280"/>  280:     
<a name="281"/>  281:     NewFileName1 = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="282"/>  282:     NewReqId1 = NewReqId + 1,
<a name="283"/>  283:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(NewReqId1), NewHandle1/binary&gt;&gt;, _} =
<a name="284"/>  284: 	open_file_v3(NewFileName1, Cm, Channel, NewReqId1,
<a name="285"/>  285: 		     ?SSH_FXF_READ bor ?SSH_FXF_WRITE bor ?SSH_FXF_APPEND),
<a name="ver3_open_flags-last_expr"/><a name="286"/>  286: <b>     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(NewReqId1),
<a name="287"/>  287: 	   ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} = close(NewHandle1, NewReqId1,
<a name="288"/>  288: 						       Cm, Channel).
<a name="289"/>  289:     
<a name="290"/>  290: <i>%%--------------------------------------------------------------------</i>
<a name="open_close_dir-1"/><a name="291"/>  291: <b>open_close_dir</b>(Config) when is_list(Config) -&gt;
<a name="292"/>  292:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="293"/>  293:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="294"/>  294:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="295"/>  295:     ReqId = 0,
<a name="296"/>  296: 
<a name="297"/>  297:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId), Handle/binary&gt;&gt;, _} =
<a name="298"/>  298: 	open_dir(PrivDir, Cm, Channel, ReqId),
<a name="299"/>  299: 
<a name="300"/>  300:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="301"/>  301: 	  ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} = close(Handle, ReqId,
<a name="302"/>  302: 						      Cm, Channel),
<a name="303"/>  303: 
<a name="304"/>  304:     NewReqId = 1,
<a name="open_close_dir-last_expr"/><a name="305"/>  305: <b>    case open_dir</b>(FileName, Cm, Channel, NewReqId) of
<a name="306"/>  306: 	{ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId),
<a name="307"/>  307: 	      ?UINT32(?SSH_FX_NOT_A_DIRECTORY), _/binary&gt;&gt;, _} -&gt;
<a name="308"/>  308: 	    %% Only if server is using vsn &gt; 5.
<a name="309"/>  309: 	    ok;
<a name="310"/>  310: 	{ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId),
<a name="311"/>  311: 	      ?UINT32(?SSH_FX_FAILURE), _/binary&gt;&gt;, _} -&gt;
<a name="312"/>  312: 	    ok
<a name="313"/>  313:     end.
<a name="314"/>  314: 
<a name="315"/>  315: <i>%%--------------------------------------------------------------------</i>
<a name="read_file-1"/><a name="316"/>  316: <b>read_file</b>(Config) when is_list(Config) -&gt;
<a name="317"/>  317:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="318"/>  318:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="319"/>  319: 
<a name="320"/>  320:     ReqId = 0,
<a name="321"/>  321:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="322"/>  322: 
<a name="323"/>  323:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId), Handle/binary&gt;&gt;, _} =
<a name="324"/>  324: 	open_file(FileName, Cm, Channel, ReqId,
<a name="325"/>  325: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="326"/>  326: 		  ?SSH_FXF_OPEN_EXISTING),
<a name="327"/>  327: 
<a name="328"/>  328:     NewReqId = 1,
<a name="329"/>  329: 
<a name="330"/>  330:     {ok, &lt;&lt;?SSH_FXP_DATA, ?UINT32(NewReqId), ?UINT32(_Length),
<a name="331"/>  331: 	  Data/binary&gt;&gt;, _} =
<a name="332"/>  332: 	read_file(Handle, 100, 0, Cm, Channel, NewReqId),
<a name="333"/>  333: 
<a name="read_file-last_expr"/><a name="334"/>  334: <b>    {ok, Data} = file:read_file</b>(FileName).
<a name="335"/>  335: 
<a name="336"/>  336: <i>%%--------------------------------------------------------------------</i>
<a name="read_dir-1"/><a name="337"/>  337: <b>read_dir</b>(Config) when is_list(Config) -&gt;
<a name="338"/>  338:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="339"/>  339:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="340"/>  340:     ReqId = 0,
<a name="341"/>  341:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId), Handle/binary&gt;&gt;, _} =
<a name="342"/>  342: 	open_dir(PrivDir, Cm, Channel, ReqId),
<a name="read_dir-last_expr"/><a name="343"/>  343: <b>    ok = read_dir</b>(Handle, Cm, Channel, ReqId).
<a name="344"/>  344: 
<a name="345"/>  345: <i>%%--------------------------------------------------------------------</i>
<a name="write_file-1"/><a name="346"/>  346: <b>write_file</b>(Config) when is_list(Config) -&gt;
<a name="347"/>  347:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="348"/>  348:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="349"/>  349: 
<a name="350"/>  350:     ReqId = 0,
<a name="351"/>  351:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="352"/>  352: 
<a name="353"/>  353:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId), Handle/binary&gt;&gt;, _} =
<a name="354"/>  354: 	open_file(FileName, Cm, Channel, ReqId,
<a name="355"/>  355: 		  ?ACE4_WRITE_DATA  bor ?ACE4_WRITE_ATTRIBUTES,
<a name="356"/>  356: 		  ?SSH_FXF_OPEN_EXISTING),
<a name="357"/>  357: 
<a name="358"/>  358:     NewReqId = 1,
<a name="359"/>  359:     Data =  list_to_binary(&quot;Write file test&quot;),
<a name="360"/>  360: 
<a name="361"/>  361:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId), ?UINT32(?SSH_FX_OK),
<a name="362"/>  362: 	  _/binary&gt;&gt;, _}
<a name="363"/>  363: 	= write_file(Handle, Data, 0, Cm, Channel, NewReqId),
<a name="364"/>  364: 
<a name="write_file-last_expr"/><a name="365"/>  365: <b>    {ok, Data} = file:read_file</b>(FileName).
<a name="366"/>  366: 
<a name="367"/>  367: <i>%%--------------------------------------------------------------------</i>
<a name="remove_file-1"/><a name="368"/>  368: <b>remove_file</b>(Config) when is_list(Config) -&gt;
<a name="369"/>  369:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="370"/>  370:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="371"/>  371:     ReqId = 0,
<a name="372"/>  372:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="373"/>  373: 
<a name="374"/>  374:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="375"/>  375: 	   ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} =
<a name="376"/>  376: 	remove(FileName, Cm, Channel, ReqId),
<a name="377"/>  377: 
<a name="378"/>  378:     NewReqId = 1,
<a name="379"/>  379:     %%  {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId), % ver 6 we have 5
<a name="380"/>  380:     %% 	  ?UINT32(?SSH_FX_FILE_IS_A_DIRECTORY ), _/binary&gt;&gt;, _} =
<a name="381"/>  381: 
<a name="remove_file-last_expr"/><a name="382"/>  382: <b>    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(NewReqId),
<a name="383"/>  383: 	  ?UINT32(?SSH_FX_FAILURE), _/binary&gt;&gt;, _} =
<a name="384"/>  384: 	remove(PrivDir, Cm, Channel, NewReqId).
<a name="385"/>  385: 
<a name="386"/>  386: <i>%%--------------------------------------------------------------------</i>
<a name="rename_file-1"/><a name="387"/>  387: <b>rename_file</b>(Config) when is_list(Config) -&gt;
<a name="388"/>  388:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="389"/>  389:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="390"/>  390:     NewFileName = filename:join(PrivDir, &quot;test1.txt&quot;),
<a name="391"/>  391:     ReqId = 0,
<a name="392"/>  392:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="393"/>  393: 
<a name="394"/>  394:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="395"/>  395: 	  ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} =
<a name="396"/>  396: 	rename(FileName, NewFileName, Cm, Channel, ReqId, 6, 0),
<a name="397"/>  397: 
<a name="398"/>  398:     NewReqId = ReqId + 1,
<a name="399"/>  399: 
<a name="400"/>  400:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId),
<a name="401"/>  401: 	  ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} =
<a name="402"/>  402: 	rename(NewFileName, FileName, Cm, Channel, NewReqId, 6,
<a name="403"/>  403: 	       ?SSH_FXP_RENAME_OVERWRITE),
<a name="404"/>  404: 
<a name="405"/>  405:     NewReqId1 = NewReqId + 1,
<a name="406"/>  406:     file:copy(FileName, NewFileName),
<a name="407"/>  407: 
<a name="408"/>  408:     %% No overwrite
<a name="409"/>  409:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId1),
<a name="410"/>  410: 	  ?UINT32(?SSH_FX_FILE_ALREADY_EXISTS), _/binary&gt;&gt;, _} =
<a name="411"/>  411: 	rename(FileName, NewFileName, Cm, Channel, NewReqId1, 6,
<a name="412"/>  412: 	       ?SSH_FXP_RENAME_NATIVE),
<a name="413"/>  413: 
<a name="414"/>  414:     NewReqId2 = NewReqId1 + 1,
<a name="415"/>  415: 
<a name="rename_file-last_expr"/><a name="416"/>  416: <b>    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(NewReqId2),
<a name="417"/>  417: 	  ?UINT32(?SSH_FX_OP_UNSUPPORTED), _/binary&gt;&gt;, _} =
<a name="418"/>  418: 	rename(FileName, NewFileName, Cm, Channel, NewReqId2, 6,
<a name="419"/>  419: 	       ?SSH_FXP_RENAME_ATOMIC).
<a name="420"/>  420: 
<a name="421"/>  421: <i>%%--------------------------------------------------------------------</i>
<a name="mk_rm_dir-1"/><a name="422"/>  422: <b>mk_rm_dir</b>(Config) when is_list(Config) -&gt;
<a name="423"/>  423:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="424"/>  424:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="425"/>  425:     DirName = filename:join(PrivDir, &quot;test&quot;),
<a name="426"/>  426:     ReqId = 0,
<a name="427"/>  427:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId), ?UINT32(?SSH_FX_OK),
<a name="428"/>  428: 	  _/binary&gt;&gt;, _} = mkdir(DirName, Cm, Channel, ReqId),
<a name="429"/>  429: 
<a name="430"/>  430:     NewReqId = 1,
<a name="431"/>  431:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId), ?UINT32(?SSH_FX_FILE_ALREADY_EXISTS),
<a name="432"/>  432: 	  _/binary&gt;&gt;, _} = mkdir(DirName, Cm, Channel, NewReqId),
<a name="433"/>  433: 
<a name="434"/>  434:     NewReqId1 = 2,
<a name="435"/>  435:     {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId1), ?UINT32(?SSH_FX_OK),
<a name="436"/>  436: 	    _/binary&gt;&gt;, _} = rmdir(DirName, Cm, Channel, NewReqId1),
<a name="437"/>  437: 
<a name="438"/>  438:     NewReqId2 = 3,
<a name="mk_rm_dir-last_expr"/><a name="439"/>  439: <b>    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(NewReqId2), ?UINT32(?SSH_FX_NO_SUCH_FILE),
<a name="440"/>  440: 	    _/binary&gt;&gt;, _} = rmdir(DirName, Cm, Channel, NewReqId2).
<a name="441"/>  441: 
<a name="442"/>  442: <i>%%--------------------------------------------------------------------</i>
<a name="real_path-1"/><a name="443"/>  443: <b>real_path</b>(Config) when is_list(Config) -&gt;
<a name="real_path-last_expr"/><a name="444"/>  444: <b>    case os:type</b>() of
<a name="445"/>  445: 	{win32, _} -&gt;
<a name="446"/>  446: 	    {skip,  &quot;Not a relevant test on windows&quot;};
<a name="447"/>  447: 	_ -&gt;
<a name="448"/>  448: 	    ReqId = 0,
<a name="449"/>  449: 	    {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="450"/>  450: 	    PrivDir = proplists:get_value(priv_dir, Config),
<a name="451"/>  451: 	    TestDir = filename:join(PrivDir, &quot;ssh_test&quot;),
<a name="452"/>  452: 	    ok = file:make_dir(TestDir),
<a name="453"/>  453: 
<a name="454"/>  454: 	    OrigPath = filename:join(TestDir, &quot;..&quot;),
<a name="455"/>  455: 
<a name="456"/>  456: 	    {ok, &lt;&lt;?SSH_FXP_NAME, ?UINT32(ReqId), ?UINT32(_), ?UINT32(Len),
<a name="457"/>  457: 	     Path:Len/binary, _/binary&gt;&gt;, _}
<a name="458"/>  458: 		= real_path(OrigPath, Cm, Channel, ReqId),
<a name="459"/>  459: 
<a name="460"/>  460: 	    RealPath = filename:absname(binary_to_list(Path)),
<a name="461"/>  461: 	    AbsPrivDir = filename:absname(PrivDir),
<a name="462"/>  462: 
<a name="463"/>  463: 	    ct:log(&quot;Path: ~p PrivDir: ~p~n&quot;, [RealPath, AbsPrivDir]),
<a name="464"/>  464: 
<a name="465"/>  465: 	    true = RealPath == AbsPrivDir
<a name="466"/>  466:     end.
<a name="467"/>  467: 
<a name="468"/>  468: <i>%%--------------------------------------------------------------------</i>
<a name="links-1"/><a name="469"/>  469: <b>links</b>(Config) when is_list(Config) -&gt;
<a name="links-last_expr"/><a name="470"/>  470: <b>    case os:type</b>() of
<a name="471"/>  471: 	{win32, _} -&gt;
<a name="472"/>  472: 	    {skip, &quot;Links are not fully supported by windows&quot;};
<a name="473"/>  473: 	_ -&gt;
<a name="474"/>  474: 	    ReqId = 0,
<a name="475"/>  475: 	    {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="476"/>  476: 	    PrivDir =  proplists:get_value(priv_dir, Config),
<a name="477"/>  477: 	    FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="478"/>  478: 	    LinkFileName = filename:join(PrivDir, &quot;link_test.txt&quot;),
<a name="479"/>  479: 
<a name="480"/>  480: 	    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="481"/>  481: 		  ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} =
<a name="482"/>  482: 		create_link(LinkFileName, FileName, Cm, Channel, ReqId),
<a name="483"/>  483: 
<a name="484"/>  484: 	    NewReqId = 1,
<a name="485"/>  485: 	    {ok, &lt;&lt;?SSH_FXP_NAME, ?UINT32(NewReqId), ?UINT32(_), ?UINT32(Len),
<a name="486"/>  486: 		  Path:Len/binary, _/binary&gt;&gt;, _}
<a name="487"/>  487: 		= read_link(LinkFileName, Cm, Channel, NewReqId),
<a name="488"/>  488: 
<a name="489"/>  489: 
<a name="490"/>  490: 	    true = binary_to_list(Path) == FileName,
<a name="491"/>  491: 
<a name="492"/>  492: 	    ct:log(&quot;Path: ~p~n&quot;, [binary_to_list(Path)])
<a name="493"/>  493:     end.
<a name="494"/>  494: 
<a name="495"/>  495: <i>%%--------------------------------------------------------------------</i>
<a name="retrieve_attributes-1"/><a name="496"/>  496: <b>retrieve_attributes</b>(Config) when is_list(Config) -&gt;
<a name="497"/>  497:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="498"/>  498:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="499"/>  499:     ReqId = 0,
<a name="500"/>  500:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="501"/>  501: 
<a name="502"/>  502:     {ok, FileInfo} = file:read_file_info(FileName),
<a name="503"/>  503: 
<a name="504"/>  504:     AttrValues =
<a name="505"/>  505: 	retrive_attributes(FileName, Cm, Channel, ReqId),
<a name="506"/>  506: 
<a name="507"/>  507:     Type =  encode_file_type(FileInfo#file_info.type),
<a name="508"/>  508:     Size = FileInfo#file_info.size,
<a name="509"/>  509:     Owner = FileInfo#file_info.uid,
<a name="510"/>  510:     Group =  FileInfo#file_info.gid,
<a name="511"/>  511:     Permissions = FileInfo#file_info.mode,
<a name="512"/>  512:     Atime =  calendar:datetime_to_gregorian_seconds(
<a name="513"/>  513: 	       erlang:localtime_to_universaltime(FileInfo#file_info.atime))
<a name="514"/>  514: 	-  ?UNIX_EPOCH,
<a name="515"/>  515:     Mtime =  calendar:datetime_to_gregorian_seconds(
<a name="516"/>  516: 	       erlang:localtime_to_universaltime(FileInfo#file_info.mtime))
<a name="517"/>  517: 	-  ?UNIX_EPOCH,
<a name="518"/>  518:     Ctime =  calendar:datetime_to_gregorian_seconds(
<a name="519"/>  519: 	       erlang:localtime_to_universaltime(FileInfo#file_info.ctime))
<a name="520"/>  520: 	-  ?UNIX_EPOCH,
<a name="521"/>  521: 
<a name="retrieve_attributes-last_expr"/><a name="522"/>  522: <b>    lists:foreach</b>(fun(Value) -&gt;
<a name="523"/>  523: 			  &lt;&lt;?UINT32(Flags), _/binary&gt;&gt; = Value,
<a name="524"/>  524: 			  true = ?is_set(?SSH_FILEXFER_ATTR_SIZE,
<a name="525"/>  525: 					Flags),
<a name="526"/>  526: 			  true = ?is_set(?SSH_FILEXFER_ATTR_PERMISSIONS,
<a name="527"/>  527: 					Flags),
<a name="528"/>  528: 			  true = ?is_set(?SSH_FILEXFER_ATTR_ACCESSTIME,
<a name="529"/>  529: 					Flags),
<a name="530"/>  530: 			  true = ?is_set(?SSH_FILEXFER_ATTR_CREATETIME,
<a name="531"/>  531: 					Flags),
<a name="532"/>  532: 			  true = ?is_set(?SSH_FILEXFER_ATTR_MODIFYTIME,
<a name="533"/>  533: 					Flags),
<a name="534"/>  534: 			  true = ?is_set(?SSH_FILEXFER_ATTR_OWNERGROUP,
<a name="535"/>  535: 					 Flags),
<a name="536"/>  536: 			  false = ?is_set(?SSH_FILEXFER_ATTR_ACL,
<a name="537"/>  537: 					Flags),
<a name="538"/>  538: 			  false = ?is_set(?SSH_FILEXFER_ATTR_SUBSECOND_TIMES,
<a name="539"/>  539: 					Flags),
<a name="540"/>  540: 			  false = ?is_set(?SSH_FILEXFER_ATTR_BITS,
<a name="541"/>  541: 					Flags),
<a name="542"/>  542: 			  false = ?is_set(?SSH_FILEXFER_ATTR_EXTENDED,
<a name="543"/>  543: 					Flags),
<a name="544"/>  544: 
<a name="545"/>  545: 			  &lt;&lt;?UINT32(_Flags), ?BYTE(Type),
<a name="546"/>  546: 			   ?UINT64(Size),
<a name="547"/>  547: 			   ?UINT32(OwnerLen), BinOwner:OwnerLen/binary,
<a name="548"/>  548: 			   ?UINT32(GroupLen), BinGroup:GroupLen/binary,
<a name="549"/>  549: 			   ?UINT32(Permissions),
<a name="550"/>  550: 			   ?UINT64(Atime),
<a name="551"/>  551: 			   ?UINT64(Ctime),
<a name="552"/>  552: 			   ?UINT64(Mtime)&gt;&gt; = Value,
<a name="553"/>  553: 
<a name="554"/>  554: 			  Owner = list_to_integer(binary_to_list(BinOwner)),
<a name="555"/>  555: 			  Group =  list_to_integer(binary_to_list(BinGroup))
<a name="556"/>  556: 		  end, AttrValues).
<a name="557"/>  557: 
<a name="558"/>  558: <i>%%--------------------------------------------------------------------</i>
<a name="set_attributes-1"/><a name="559"/>  559: <b>set_attributes</b>(Config) when is_list(Config) -&gt;
<a name="set_attributes-last_expr"/><a name="560"/>  560: <b>    case os:type</b>() of
<a name="561"/>  561: 	{win32, _} -&gt;
<a name="562"/>  562: 	    {skip,  &quot;Known error bug in erts file:read_file_info&quot;};
<a name="563"/>  563: 	_ -&gt;
<a name="564"/>  564: 	    PrivDir =  proplists:get_value(priv_dir, Config),
<a name="565"/>  565: 	    FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="566"/>  566: 	    ReqId = 0,
<a name="567"/>  567: 	    {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="568"/>  568: 
<a name="569"/>  569: 	    {ok, FileInfo} = file:read_file_info(FileName),
<a name="570"/>  570: 
<a name="571"/>  571: 	    OrigPermissions = FileInfo#file_info.mode,
<a name="572"/>  572: 	    Permissions = not_default_permissions(),
<a name="573"/>  573: 
<a name="574"/>  574: 	    Flags = ?SSH_FILEXFER_ATTR_PERMISSIONS,
<a name="575"/>  575: 
<a name="576"/>  576: 	    Atters = [?uint32(Flags), ?byte(?SSH_FILEXFER_TYPE_REGULAR),
<a name="577"/>  577: 		      ?uint32(Permissions)],
<a name="578"/>  578: 
<a name="579"/>  579: 	    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="580"/>  580: 		   ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} =
<a name="581"/>  581: 		set_attributes_file(FileName, Atters, Cm, Channel, ReqId),
<a name="582"/>  582: 
<a name="583"/>  583: 	    {ok, NewFileInfo} = file:read_file_info(FileName),
<a name="584"/>  584: 	    NewPermissions = NewFileInfo#file_info.mode,
<a name="585"/>  585: 
<a name="586"/>  586: 	    %% Can not test that NewPermissions = Permissions as
<a name="587"/>  587: 	    %% on Unix platforms, other bits than those listed in the
<a name="588"/>  588: 	    %% API may be set.
<a name="589"/>  589: 	    ct:log(&quot;Org: ~p New: ~p~n&quot;, [OrigPermissions, NewPermissions]),
<a name="590"/>  590: 	    true = OrigPermissions =/= NewPermissions,
<a name="591"/>  591: 
<a name="592"/>  592: 	    ct:log(&quot;Try to open the file&quot;),
<a name="593"/>  593: 	    NewReqId = 2,
<a name="594"/>  594: 	    {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(NewReqId), Handle/binary&gt;&gt;, _} =
<a name="595"/>  595: 		open_file(FileName, Cm, Channel, NewReqId,
<a name="596"/>  596: 			  ?ACE4_READ_DATA bor ?ACE4_WRITE_ATTRIBUTES,
<a name="597"/>  597: 			  ?SSH_FXF_OPEN_EXISTING),
<a name="598"/>  598: 
<a name="599"/>  599: 	    NewAtters = [?uint32(Flags), ?byte(?SSH_FILEXFER_TYPE_REGULAR),
<a name="600"/>  600: 			 ?uint32(OrigPermissions)],
<a name="601"/>  601: 
<a name="602"/>  602: 	    NewReqId1 = 3,
<a name="603"/>  603: 
<a name="604"/>  604: 	    ct:log(&quot;Set original permissions on the now open file&quot;),
<a name="605"/>  605: 
<a name="606"/>  606: 	    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(NewReqId1),
<a name="607"/>  607: 		   ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} =
<a name="608"/>  608: 		set_attributes_open_file(Handle, NewAtters, Cm, Channel, NewReqId1),
<a name="609"/>  609: 
<a name="610"/>  610: 	    {ok, NewFileInfo1} = file:read_file_info(FileName),
<a name="611"/>  611: 	    OrigPermissions = NewFileInfo1#file_info.mode
<a name="612"/>  612:     end.
<a name="613"/>  613: 
<a name="614"/>  614: <i>%%--------------------------------------------------------------------</i>
<a name="ver3_rename-1"/><a name="615"/>  615: <b>ver3_rename</b>(Config) when is_list(Config) -&gt;
<a name="616"/>  616:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="617"/>  617:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="618"/>  618:     NewFileName = filename:join(PrivDir, &quot;test1.txt&quot;),
<a name="619"/>  619:     ReqId = 0,
<a name="620"/>  620:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="621"/>  621: 
<a name="ver3_rename-last_expr"/><a name="622"/>  622: <b>    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(ReqId),
<a name="623"/>  623: 	  ?UINT32(?SSH_FX_OK), _/binary&gt;&gt;, _} =
<a name="624"/>  624: 	rename(FileName, NewFileName, Cm, Channel, ReqId, 3, 0).
<a name="625"/>  625: 
<a name="626"/>  626: <i>%%--------------------------------------------------------------------</i>
<a name="relpath-1"/><a name="627"/>  627: <b>relpath</b>(Config) when is_list(Config) -&gt;
<a name="628"/>  628:     ReqId = 0,
<a name="629"/>  629:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="630"/>  630: 
<a name="relpath-last_expr"/><a name="631"/>  631: <b>    case os:type</b>() of
<a name="632"/>  632: 	{win32, _} -&gt;
<a name="633"/>  633: 	    {skip,  &quot;Not a relevant test on windows&quot;};
<a name="634"/>  634: 	_ -&gt;
<a name="635"/>  635: 	    {ok, &lt;&lt;?SSH_FXP_NAME, ?UINT32(ReqId), ?UINT32(_), ?UINT32(Len),
<a name="636"/>  636: 		  Root:Len/binary, _/binary&gt;&gt;, _}
<a name="637"/>  637: 		= real_path(&quot;/..&quot;, Cm, Channel, ReqId),
<a name="638"/>  638: 
<a name="639"/>  639: 	    &lt;&lt;&quot;/&quot;&gt;&gt; = Root,
<a name="640"/>  640: 
<a name="641"/>  641: 	    {ok, &lt;&lt;?SSH_FXP_NAME, ?UINT32(ReqId), ?UINT32(_), ?UINT32(Len),
<a name="642"/>  642: 		  Path:Len/binary, _/binary&gt;&gt;, _}
<a name="643"/>  643: 		= real_path(&quot;/usr/bin/../..&quot;, Cm, Channel, ReqId),
<a name="644"/>  644: 	    Root = Path
<a name="645"/>  645:     end.
<a name="646"/>  646: 
<a name="647"/>  647: <i>%%--------------------------------------------------------------------</i>
<a name="sshd_read_file-1"/><a name="648"/>  648: <b>sshd_read_file</b>(Config) when is_list(Config) -&gt;
<a name="649"/>  649:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="650"/>  650:     FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="651"/>  651: 
<a name="652"/>  652:     ReqId = 0,
<a name="653"/>  653:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="654"/>  654: 
<a name="655"/>  655:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId), Handle/binary&gt;&gt;, _} =
<a name="656"/>  656: 	open_file(FileName, Cm, Channel, ReqId,
<a name="657"/>  657: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="658"/>  658: 		  ?SSH_FXF_OPEN_EXISTING),
<a name="659"/>  659: 
<a name="660"/>  660:     NewReqId = 1,
<a name="661"/>  661: 
<a name="662"/>  662:     {ok, &lt;&lt;?SSH_FXP_DATA, ?UINT32(NewReqId), ?UINT32(_Length),
<a name="663"/>  663: 	  Data/binary&gt;&gt;, _} =
<a name="664"/>  664: 	read_file(Handle, 100, 0, Cm, Channel, NewReqId),
<a name="665"/>  665: 
<a name="sshd_read_file-last_expr"/><a name="666"/>  666: <b>    {ok, Data} = file:read_file</b>(FileName).
<a name="667"/>  667: <i>%%--------------------------------------------------------------------</i>
<a name="ver6_basic-1"/><a name="668"/>  668: <b>ver6_basic</b>(Config) when is_list(Config) -&gt;
<a name="669"/>  669:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="670"/>  670:     %FileName = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="671"/>  671:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="672"/>  672:     ReqId = 0,
<a name="ver6_basic-last_expr"/><a name="673"/>  673: <b>    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(ReqId),  % Ver 6 we have 5
<a name="674"/>  674: 	   ?UINT32(?SSH_FX_FILE_IS_A_DIRECTORY), _/binary&gt;&gt;, _} =
<a name="675"/>  675: 	open_file(PrivDir, Cm, Channel, ReqId,
<a name="676"/>  676: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="677"/>  677: 		  ?SSH_FXF_OPEN_EXISTING).
<a name="678"/>  678: 
<a name="679"/>  679: <i>%%--------------------------------------------------------------------</i>
<a name="access_outside_root-1"/><a name="680"/>  680: <b>access_outside_root</b>(Config) when is_list(Config) -&gt;
<a name="681"/>  681:     PrivDir  =  proplists:get_value(priv_dir, Config),
<a name="682"/>  682:     BaseDir  = filename:join(PrivDir, access_outside_root),
<a name="683"/>  683:     %% A file outside the tree below RootDir which is BaseDir/a
<a name="684"/>  684:     %% Make the file  BaseDir/bad :
<a name="685"/>  685:     BadFilePath = filename:join([BaseDir, bad]),
<a name="686"/>  686:     ok = file:write_file(BadFilePath, &lt;&lt;&gt;&gt;),
<a name="687"/>  687:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="688"/>  688:     %% Try to access a file parallel to the RootDir:
<a name="689"/>  689:     try_access(&quot;/../bad&quot;,   Cm, Channel, 0),
<a name="690"/>  690:     %% Try to access the same file via the CWD which is /b relative to the RootDir:
<a name="access_outside_root-last_expr"/><a name="691"/>  691: <b>    try_access</b>(&quot;../../bad&quot;, Cm, Channel, 1).
<a name="692"/>  692: 
<a name="693"/>  693: 
<a name="try_access-4"/><a name="694"/>  694: <b>try_access</b>(Path, Cm, Channel, ReqId) -&gt;
<a name="695"/>  695:     Return = 
<a name="696"/>  696:         open_file(Path, Cm, Channel, ReqId, 
<a name="697"/>  697:                   ?ACE4_READ_DATA bor ?ACE4_READ_ATTRIBUTES,
<a name="698"/>  698:                   ?SSH_FXF_OPEN_EXISTING),
<a name="699"/>  699:     ct:log(&quot;Try open ~p -&gt; ~p&quot;,[Path,Return]),
<a name="try_access-last_expr"/><a name="700"/>  700:     case Return of
<a name="701"/>  701:         {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId), _Handle0/binary&gt;&gt;, _} -&gt;
<a name="702"/>  702:             ct:fail(&quot;Could open a file outside the root tree!&quot;);
<a name="703"/>  703:         {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId), ?UINT32(Code), Rest/binary&gt;&gt;, &lt;&lt;&gt;&gt;} -&gt;
<a name="704"/>  704:             case Code of
<a name="705"/>  705:                 ?SSH_FX_FILE_IS_A_DIRECTORY -&gt;
<a name="706"/>  706:                     ct:log(&quot;Got the expected SSH_FX_FILE_IS_A_DIRECTORY status&quot;,[]),
<a name="707"/>  707:                     ok;
<a name="708"/>  708:                 ?SSH_FX_FAILURE -&gt;
<a name="709"/>  709:                     ct:log(&quot;Got the expected SSH_FX_FAILURE status&quot;,[]),
<a name="710"/>  710:                     ok;
<a name="711"/>  711:                 _ -&gt;
<a name="712"/>  712:                     case Rest of
<a name="713"/>  713:                         &lt;&lt;?UINT32(Len), Txt:Len/binary, _/binary&gt;&gt; -&gt;
<a name="714"/>  714:                             ct:fail(&quot;Got unexpected SSH_FX_code: ~p (~p)&quot;,[Code,Txt]);
<a name="715"/>  715:                         _ -&gt;
<a name="716"/>  716:                             ct:fail(&quot;Got unexpected SSH_FX_code: ~p&quot;,[Code])
<a name="717"/>  717:                     end
<a name="718"/>  718:             end;
<a name="719"/>  719:         _ -&gt;
<a name="720"/>  720:             ct:fail(&quot;Completely unexpected return: ~p&quot;, [Return])
<a name="721"/>  721:     end.
<a name="722"/>  722: 
<a name="723"/>  723: <i>%%--------------------------------------------------------------------</i>
<a name="root_with_cwd-1"/><a name="724"/>  724: <b>root_with_cwd</b>(Config) when is_list(Config) -&gt;
<a name="725"/>  725:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="726"/>  726:     RootDir = filename:join(PrivDir, root_with_cwd),
<a name="727"/>  727:     CWD     = filename:join(RootDir, home),
<a name="728"/>  728:     FileName = &quot;root_with_cwd.txt&quot;,
<a name="729"/>  729:     FilePath = filename:join(CWD, FileName),
<a name="730"/>  730:     ok = filelib:ensure_dir(FilePath),
<a name="731"/>  731:     ok = file:write_file(FilePath ++ &quot;0&quot;, &lt;&lt;&gt;&gt;),
<a name="732"/>  732:     ok = file:write_file(FilePath ++ &quot;1&quot;, &lt;&lt;&gt;&gt;),
<a name="733"/>  733:     ok = file:write_file(FilePath ++ &quot;2&quot;, &lt;&lt;&gt;&gt;),
<a name="734"/>  734:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="735"/>  735:     ReqId0 = 0,
<a name="736"/>  736:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId0), _Handle0/binary&gt;&gt;, _} =
<a name="737"/>  737: 	open_file(FileName ++ &quot;0&quot;, Cm, Channel, ReqId0,
<a name="738"/>  738: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="739"/>  739: 		  ?SSH_FXF_OPEN_EXISTING),
<a name="740"/>  740:     ReqId1 = 1,
<a name="741"/>  741:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(ReqId1), _Handle1/binary&gt;&gt;, _} =
<a name="742"/>  742: 	open_file(&quot;./&quot; ++ FileName ++ &quot;1&quot;, Cm, Channel, ReqId1,
<a name="743"/>  743: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="744"/>  744: 		  ?SSH_FXF_OPEN_EXISTING),
<a name="745"/>  745:     ReqId2 = 2,
<a name="root_with_cwd-last_expr"/><a name="746"/>  746: <b>    {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32</b>(ReqId2), _Handle2/binary&gt;&gt;, _} =
<a name="747"/>  747: 	open_file(&quot;/home/&quot; ++ FileName ++ &quot;2&quot;, Cm, Channel, ReqId2,
<a name="748"/>  748: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="749"/>  749: 		  ?SSH_FXF_OPEN_EXISTING).
<a name="750"/>  750: 
<a name="751"/>  751: <i>%%--------------------------------------------------------------------</i>
<a name="relative_path-1"/><a name="752"/>  752: <b>relative_path</b>(Config) when is_list(Config) -&gt;
<a name="753"/>  753:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="754"/>  754:     FileName = &quot;test_relative_path.txt&quot;,
<a name="755"/>  755:     FilePath = filename:join(PrivDir, FileName),
<a name="756"/>  756:     ok = filelib:ensure_dir(FilePath),
<a name="757"/>  757:     ok = file:write_file(FilePath, &lt;&lt;&gt;&gt;),
<a name="758"/>  758:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="759"/>  759:     ReqId = 0,
<a name="relative_path-last_expr"/><a name="760"/>  760: <b>    {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32</b>(ReqId), _Handle/binary&gt;&gt;, _} =
<a name="761"/>  761:         open_file(FileName, Cm, Channel, ReqId,
<a name="762"/>  762:                   ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="763"/>  763:                   ?SSH_FXF_OPEN_EXISTING).
<a name="764"/>  764: 
<a name="765"/>  765: <i>%%--------------------------------------------------------------------</i>
<a name="open_file_dir_v5-1"/><a name="766"/>  766: <b>open_file_dir_v5</b>(Config) when is_list(Config) -&gt;
<a name="767"/>  767:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="768"/>  768:     FileName = &quot;open_file_dir_v5&quot;,
<a name="769"/>  769:     FilePath = filename:join(PrivDir, FileName),
<a name="770"/>  770:     ok = filelib:ensure_dir(FilePath),
<a name="771"/>  771:     ok = file:make_dir(FilePath),
<a name="772"/>  772:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="773"/>  773:     ReqId = 0,
<a name="open_file_dir_v5-last_expr"/><a name="774"/>  774: <b>    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(ReqId),
<a name="775"/>  775: 	   ?UINT32(?SSH_FX_FAILURE), _/binary&gt;&gt;, _} =
<a name="776"/>  776:         open_file(FileName, Cm, Channel, ReqId,
<a name="777"/>  777:                   ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="778"/>  778:                   ?SSH_FXF_OPEN_EXISTING).
<a name="779"/>  779: 
<a name="780"/>  780: <i>%%--------------------------------------------------------------------</i>
<a name="open_file_dir_v6-1"/><a name="781"/>  781: <b>open_file_dir_v6</b>(Config) when is_list(Config) -&gt;
<a name="782"/>  782:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="783"/>  783:     FileName = &quot;open_file_dir_v6&quot;,
<a name="784"/>  784:     FilePath = filename:join(PrivDir, FileName),
<a name="785"/>  785:     ok = filelib:ensure_dir(FilePath),
<a name="786"/>  786:     ok = file:make_dir(FilePath),
<a name="787"/>  787:     {Cm, Channel} = proplists:get_value(sftp, Config),
<a name="788"/>  788:     ReqId = 0,
<a name="open_file_dir_v6-last_expr"/><a name="789"/>  789: <b>    {ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32</b>(ReqId),
<a name="790"/>  790: 	   ?UINT32(?SSH_FX_FILE_IS_A_DIRECTORY), _/binary&gt;&gt;, _} =
<a name="791"/>  791:         open_file(FileName, Cm, Channel, ReqId,
<a name="792"/>  792:                   ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="793"/>  793:                   ?SSH_FXF_OPEN_EXISTING).
<a name="794"/>  794: 
<a name="795"/>  795: <i>%%--------------------------------------------------------------------</i>
<a name="796"/>  796: <i>%% Internal functions ------------------------------------------------</i>
<a name="797"/>  797: <i>%%--------------------------------------------------------------------</i>
<a name="prep-1"/><a name="798"/>  798: <b>prep</b>(Config) -&gt;
<a name="799"/>  799:     PrivDir =  proplists:get_value(priv_dir, Config),
<a name="800"/>  800:     TestFile = filename:join(PrivDir, &quot;test.txt&quot;),
<a name="801"/>  801:     TestFile1 = filename:join(PrivDir, &quot;test1.txt&quot;),
<a name="802"/>  802: 
<a name="803"/>  803:     file:delete(TestFile),
<a name="804"/>  804:     file:delete(TestFile1),
<a name="805"/>  805: 
<a name="806"/>  806:     %% Initial config
<a name="807"/>  807:     DataDir = proplists:get_value(data_dir, Config),
<a name="808"/>  808:     FileName = filename:join(DataDir, &quot;test.txt&quot;),
<a name="809"/>  809:     file:copy(FileName, TestFile),
<a name="810"/>  810:     Mode = 8#00400 bor 8#00200 bor 8#00040, % read &amp; write owner, read group
<a name="811"/>  811:     {ok, FileInfo} = file:read_file_info(TestFile),
<a name="prep-last_expr"/><a name="812"/>  812: <b>    ok = file:write_file_info</b>(TestFile,
<a name="813"/>  813: 			      FileInfo#file_info{mode = Mode}).
<a name="814"/>  814: 
<a name="reply-2"/><a name="815"/>  815: <b>reply</b>(Cm, Channel) -&gt;
<a name="reply-last_expr"/><a name="816"/>  816: <b>    reply</b>(Cm, Channel,&lt;&lt;&gt;&gt;).
<a name="817"/>  817: 
<a name="reply-3"/><a name="818"/>  818: <b>reply</b>(Cm, Channel, RBuf) -&gt;
<a name="reply-last_expr"/><a name="819"/>  819:     receive
<a name="820"/>  820: 	{ssh_cm, Cm, {data, Channel, 0, Data}} -&gt;
<a name="821"/>  821: 	    case &lt;&lt;RBuf/binary, Data/binary&gt;&gt; of
<a name="822"/>  822: 		&lt;&lt;?UINT32(Len),Reply:Len/binary,Rest/binary&gt;&gt; -&gt;
<a name="823"/>  823: 		    {ok, Reply, Rest};
<a name="824"/>  824: 		RBuf2 -&gt;
<a name="825"/>  825: 		    reply(Cm, Channel, RBuf2)
<a name="826"/>  826: 	    end;
<a name="827"/>  827: 	{ssh_cm, Cm, {eof, Channel}} -&gt;
<a name="828"/>  828: 	    eof;
<a name="829"/>  829: 	{ssh_cm, Cm, {closed, Channel}} -&gt;
<a name="830"/>  830: 	    closed;
<a name="831"/>  831: 	{ssh_cm, Cm, Msg} -&gt;
<a name="832"/>  832: 	    ct:fail(Msg)
<a name="833"/>  833:     after 
<a name="834"/>  834: 	90000 -&gt; ct:fail(&quot;timeout ~p:~p&quot;,[?MODULE,?LINE])
<a name="835"/>  835:     end.
<a name="836"/>  836: 
<a name="open_file-6"/><a name="837"/>  837: <b>open_file</b>(File, Cm, Channel, ReqId, Access, Flags) -&gt;
<a name="838"/>  838:     Data = list_to_binary([?uint32(ReqId),
<a name="839"/>  839: 			   ?binary(list_to_binary(File)),
<a name="840"/>  840: 			   ?uint32(Access),
<a name="841"/>  841: 			   ?uint32(Flags),
<a name="842"/>  842: 			   ?REG_ATTERS]),
<a name="843"/>  843:     Size = 1 + size(Data),
<a name="844"/>  844:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="845"/>  845: 				      ?SSH_FXP_OPEN, Data/binary&gt;&gt;),
<a name="open_file-last_expr"/><a name="846"/>  846: <b>    reply</b>(Cm, Channel).
<a name="847"/>  847: 
<a name="open_file_v3-5"/><a name="848"/>  848: <b>open_file_v3</b>(File, Cm, Channel, ReqId, Flags) -&gt;
<a name="849"/>  849: 
<a name="850"/>  850:     Data = list_to_binary([?uint32(ReqId),
<a name="851"/>  851: 			   ?binary(list_to_binary(File)),
<a name="852"/>  852: 			   ?uint32(Flags),
<a name="853"/>  853: 			   ?REG_ATTERS]),
<a name="854"/>  854:     Size = 1 + size(Data),
<a name="855"/>  855:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="856"/>  856: 				      ?SSH_FXP_OPEN, Data/binary&gt;&gt;),
<a name="open_file_v3-last_expr"/><a name="857"/>  857: <b>    reply</b>(Cm, Channel).
<a name="858"/>  858: 
<a name="859"/>  859: 
<a name="close-4"/><a name="860"/>  860: <b>close</b>(Handle, ReqId, Cm , Channel) -&gt;
<a name="861"/>  861:     Data = list_to_binary([?uint32(ReqId), Handle]),
<a name="862"/>  862: 
<a name="863"/>  863:     Size = 1 + size(Data),
<a name="864"/>  864: 
<a name="865"/>  865:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size), ?SSH_FXP_CLOSE,
<a name="866"/>  866: 			      Data/binary&gt;&gt;),
<a name="867"/>  867: 
<a name="close-last_expr"/><a name="868"/>  868: <b>    reply</b>(Cm, Channel).
<a name="869"/>  869: 
<a name="870"/>  870: 
<a name="871"/>  871: 
<a name="open_dir-4"/><a name="872"/>  872: <b>open_dir</b>(Dir, Cm, Channel, ReqId) -&gt;
<a name="873"/>  873:     Data = list_to_binary([?uint32(ReqId),
<a name="874"/>  874: 			   ?binary(list_to_binary(Dir))]),
<a name="875"/>  875:     Size = 1 + size(Data),
<a name="876"/>  876:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="877"/>  877: 				      ?SSH_FXP_OPENDIR, Data/binary&gt;&gt;),
<a name="open_dir-last_expr"/><a name="878"/>  878: <b>    reply</b>(Cm, Channel).
<a name="879"/>  879: 
<a name="880"/>  880: 
<a name="rename-7"/><a name="881"/>  881: <b>rename</b>(OldName, NewName, Cm, Channel, ReqId, Version, Flags) -&gt;
<a name="882"/>  882:     Data =
<a name="883"/>  883: 	case Version of
<a name="884"/>  884: 	    3 -&gt;
<a name="885"/>  885: 		list_to_binary([?uint32(ReqId),
<a name="886"/>  886: 				?binary(list_to_binary(OldName)),
<a name="887"/>  887: 				?binary(list_to_binary(NewName))]);
<a name="888"/>  888: 	    _ -&gt;
<a name="889"/>  889: 		list_to_binary([?uint32(ReqId),
<a name="890"/>  890: 				?binary(list_to_binary(OldName)),
<a name="891"/>  891: 				?binary(list_to_binary(NewName)),
<a name="892"/>  892: 				?uint32(Flags)])
<a name="893"/>  893: 	end,
<a name="894"/>  894:     Size = 1 + size(Data),
<a name="895"/>  895:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="896"/>  896: 				      ?SSH_FXP_RENAME, Data/binary&gt;&gt;),
<a name="rename-last_expr"/><a name="897"/>  897: <b>    reply</b>(Cm, Channel).
<a name="898"/>  898: 
<a name="899"/>  899: 
<a name="mkdir-4"/><a name="900"/>  900: <b>mkdir</b>(Dir, Cm, Channel, ReqId)-&gt;
<a name="901"/>  901:     Data = list_to_binary([?uint32(ReqId),
<a name="902"/>  902: 			   ?binary(list_to_binary(Dir)),
<a name="903"/>  903: 			   ?REG_ATTERS]),
<a name="904"/>  904:     Size = 1 + size(Data),
<a name="905"/>  905:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="906"/>  906: 				      ?SSH_FXP_MKDIR, Data/binary&gt;&gt;),
<a name="mkdir-last_expr"/><a name="907"/>  907: <b>    reply</b>(Cm, Channel).
<a name="908"/>  908: 
<a name="909"/>  909: 
<a name="rmdir-4"/><a name="910"/>  910: <b>rmdir</b>(Dir, Cm, Channel, ReqId) -&gt;
<a name="911"/>  911:     Data = list_to_binary([?uint32(ReqId),
<a name="912"/>  912: 			   ?binary(list_to_binary(Dir))]),
<a name="913"/>  913:     Size = 1 + size(Data),
<a name="914"/>  914:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="915"/>  915: 			      ?SSH_FXP_RMDIR, Data/binary&gt;&gt;),
<a name="rmdir-last_expr"/><a name="916"/>  916: <b>    reply</b>(Cm, Channel).
<a name="917"/>  917: 
<a name="remove-4"/><a name="918"/>  918: <b>remove</b>(File, Cm, Channel, ReqId) -&gt;
<a name="919"/>  919:     Data = list_to_binary([?uint32(ReqId),
<a name="920"/>  920: 			   ?binary(list_to_binary(File))]),
<a name="921"/>  921:     Size = 1 + size(Data),
<a name="922"/>  922:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="923"/>  923: 			      ?SSH_FXP_REMOVE, Data/binary&gt;&gt;),
<a name="remove-last_expr"/><a name="924"/>  924: <b>    reply</b>(Cm, Channel).
<a name="925"/>  925: 
<a name="926"/>  926: 
<a name="read_dir-4"/><a name="927"/>  927: <b>read_dir</b>(Handle, Cm, Channel, ReqId) -&gt;
<a name="928"/>  928: 
<a name="929"/>  929:     Data = list_to_binary([?uint32(ReqId), Handle]),
<a name="930"/>  930:     Size = 1 + size(Data),
<a name="931"/>  931:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="932"/>  932: 			      ?SSH_FXP_READDIR, Data/binary&gt;&gt;),
<a name="read_dir-last_expr"/><a name="933"/>  933: <b>    case reply</b>(Cm, Channel) of
<a name="934"/>  934: 	{ok, &lt;&lt;?SSH_FXP_NAME, ?UINT32(ReqId), ?UINT32(Count),
<a name="935"/>  935: 	       ?UINT32(Len), Listing:Len/binary, _/binary&gt;&gt;, _} -&gt;
<a name="936"/>  936: 	    ct:log(&quot;Count: ~p Listing: ~p~n&quot;,
<a name="937"/>  937: 			       [Count, binary_to_list(Listing)]),
<a name="938"/>  938: 	    read_dir(Handle, Cm, Channel, ReqId);
<a name="939"/>  939: 	{ok, &lt;&lt;?SSH_FXP_STATUS, ?UINT32(ReqId),
<a name="940"/>  940: 	      ?UINT32(?SSH_FX_EOF), _/binary&gt;&gt;, _}  -&gt;
<a name="941"/>  941: 	    ok
<a name="942"/>  942:     end.
<a name="943"/>  943: 
<a name="read_file-6"/><a name="944"/>  944: <b>read_file</b>(Handle, MaxLength, OffSet, Cm, Channel, ReqId) -&gt;
<a name="945"/>  945:     Data = list_to_binary([?uint32(ReqId), Handle,
<a name="946"/>  946: 			   ?uint64(OffSet),
<a name="947"/>  947: 			   ?uint32(MaxLength)]),
<a name="948"/>  948:     Size = 1 + size(Data),
<a name="949"/>  949:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="950"/>  950: 			      ?SSH_FXP_READ, Data/binary&gt;&gt;),
<a name="read_file-last_expr"/><a name="951"/>  951: <b>    reply</b>(Cm, Channel).
<a name="952"/>  952: 
<a name="953"/>  953: 
<a name="write_file-6"/><a name="954"/>  954: <b>write_file</b>(Handle, FileData, OffSet, Cm, Channel, ReqId) -&gt;
<a name="955"/>  955:     Data = list_to_binary([?uint32(ReqId), Handle,
<a name="956"/>  956: 			   ?uint64(OffSet),
<a name="957"/>  957: 			   ?binary(FileData)]),
<a name="958"/>  958:     Size = 1 + size(Data),
<a name="959"/>  959:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="960"/>  960: 			      ?SSH_FXP_WRITE, Data/binary&gt;&gt;),
<a name="write_file-last_expr"/><a name="961"/>  961: <b>    reply</b>(Cm, Channel).
<a name="962"/>  962: 
<a name="963"/>  963: 
<a name="real_path-4"/><a name="964"/>  964: <b>real_path</b>(OrigPath, Cm, Channel, ReqId) -&gt;
<a name="965"/>  965:     Data = list_to_binary([?uint32(ReqId),
<a name="966"/>  966: 			   ?binary(list_to_binary(OrigPath))]),
<a name="967"/>  967:     Size = 1 + size(Data),
<a name="968"/>  968:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="969"/>  969: 			      ?SSH_FXP_REALPATH, Data/binary&gt;&gt;),
<a name="real_path-last_expr"/><a name="970"/>  970: <b>    reply</b>(Cm, Channel).
<a name="971"/>  971: 
<a name="create_link-5"/><a name="972"/>  972: <b>create_link</b>(LinkPath, Path, Cm, Channel, ReqId) -&gt;
<a name="973"/>  973:      Data = list_to_binary([?uint32(ReqId),
<a name="974"/>  974: 			   ?binary(list_to_binary(LinkPath)),
<a name="975"/>  975: 			   ?binary(list_to_binary(Path))]),
<a name="976"/>  976:      Size = 1 + size(Data),
<a name="977"/>  977:      ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="978"/>  978: 			      ?SSH_FXP_SYMLINK, Data/binary&gt;&gt;),
<a name="create_link-last_expr"/><a name="979"/>  979: <b>     reply</b>(Cm, Channel).
<a name="980"/>  980: 
<a name="981"/>  981: 
<a name="read_link-4"/><a name="982"/>  982: <b>read_link</b>(Link, Cm, Channel, ReqId) -&gt;
<a name="983"/>  983:     Data = list_to_binary([?uint32(ReqId),
<a name="984"/>  984: 			   ?binary(list_to_binary(Link))]),
<a name="985"/>  985:     Size = 1 + size(Data),
<a name="986"/>  986:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="987"/>  987: 			      ?SSH_FXP_READLINK, Data/binary&gt;&gt;),
<a name="read_link-last_expr"/><a name="988"/>  988: <b>    reply</b>(Cm, Channel).
<a name="989"/>  989: 
<a name="retrive_attributes_file-5"/><a name="990"/>  990: <b>retrive_attributes_file</b>(FilePath, Flags, Cm, Channel, ReqId) -&gt;
<a name="991"/>  991:     Data = list_to_binary([?uint32(ReqId),
<a name="992"/>  992: 			   ?binary(list_to_binary(FilePath)),
<a name="993"/>  993: 			   ?uint32(Flags)]),
<a name="994"/>  994:     Size = 1 + size(Data),
<a name="995"/>  995:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="996"/>  996: 			      ?SSH_FXP_STAT, Data/binary&gt;&gt;),
<a name="retrive_attributes_file-last_expr"/><a name="997"/>  997: <b>    reply</b>(Cm, Channel).
<a name="998"/>  998: 
<a name="retrive_attributes_file_or_link-5"/><a name="999"/>  999: <b>retrive_attributes_file_or_link</b>(FilePath, Flags, Cm, Channel, ReqId) -&gt;
<a name="1000"/> 1000:     Data = list_to_binary([?uint32(ReqId),
<a name="1001"/> 1001: 			   ?binary(list_to_binary(FilePath)),
<a name="1002"/> 1002: 			   ?uint32(Flags)]),
<a name="1003"/> 1003:     Size = 1 + size(Data),
<a name="1004"/> 1004:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="1005"/> 1005: 			      ?SSH_FXP_LSTAT, Data/binary&gt;&gt;),
<a name="retrive_attributes_file_or_link-last_expr"/><a name="1006"/> 1006: <b>    reply</b>(Cm, Channel).
<a name="1007"/> 1007: 
<a name="retrive_attributes_open_file-5"/><a name="1008"/> 1008: <b>retrive_attributes_open_file</b>(Handle, Flags, Cm, Channel, ReqId) -&gt;
<a name="1009"/> 1009: 
<a name="1010"/> 1010:     Data = list_to_binary([?uint32(ReqId),
<a name="1011"/> 1011: 			   Handle,
<a name="1012"/> 1012: 			   ?uint32(Flags)]),
<a name="1013"/> 1013:     Size = 1 + size(Data),
<a name="1014"/> 1014:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="1015"/> 1015: 			      ?SSH_FXP_FSTAT, Data/binary&gt;&gt;),
<a name="retrive_attributes_open_file-last_expr"/><a name="1016"/> 1016: <b>    reply</b>(Cm, Channel).
<a name="1017"/> 1017: 
<a name="retrive_attributes-4"/><a name="1018"/> 1018: <b>retrive_attributes</b>(FileName, Cm, Channel, ReqId) -&gt;
<a name="1019"/> 1019: 
<a name="1020"/> 1020:     Attr =  ?SSH_FILEXFER_ATTR_SIZE,
<a name="1021"/> 1021: 
<a name="1022"/> 1022:     {ok, &lt;&lt;?SSH_FXP_ATTRS, ?UINT32(ReqId), Value/binary&gt;&gt;, _}
<a name="1023"/> 1023: 	= retrive_attributes_file(FileName, Attr,
<a name="1024"/> 1024: 				  Cm, Channel, ReqId),
<a name="1025"/> 1025: 
<a name="1026"/> 1026:     NewReqId = ReqId + 1,
<a name="1027"/> 1027:     {ok, &lt;&lt;?SSH_FXP_ATTRS, ?UINT32(NewReqId), Value1/binary&gt;&gt;, _}
<a name="1028"/> 1028: 	= retrive_attributes_file_or_link(FileName,
<a name="1029"/> 1029: 					  Attr, Cm, Channel, NewReqId),
<a name="1030"/> 1030: 
<a name="1031"/> 1031:     NewReqId1 = NewReqId + 1,
<a name="1032"/> 1032:     {ok, &lt;&lt;?SSH_FXP_HANDLE, ?UINT32(NewReqId1), Handle/binary&gt;&gt;, _} =
<a name="1033"/> 1033: 	open_file(FileName, Cm, Channel, NewReqId1,
<a name="1034"/> 1034: 		  ?ACE4_READ_DATA  bor ?ACE4_READ_ATTRIBUTES,
<a name="1035"/> 1035: 		  ?SSH_FXF_OPEN_EXISTING),
<a name="1036"/> 1036: 
<a name="1037"/> 1037:     NewReqId2 = NewReqId1 + 1,
<a name="1038"/> 1038:     {ok, &lt;&lt;?SSH_FXP_ATTRS, ?UINT32(NewReqId2), Value2/binary&gt;&gt;, _}
<a name="1039"/> 1039: 	= retrive_attributes_open_file(Handle, Attr, Cm, Channel, NewReqId2),
<a name="1040"/> 1040: 
<a name="retrive_attributes-last_expr"/><a name="1041"/> 1041:     [Value, Value1, Value2].
<a name="1042"/> 1042: 
<a name="set_attributes_file-5"/><a name="1043"/> 1043: <b>set_attributes_file</b>(FilePath, Atters, Cm, Channel, ReqId) -&gt;
<a name="1044"/> 1044:     Data = list_to_binary([?uint32(ReqId),
<a name="1045"/> 1045: 			   ?binary(list_to_binary(FilePath)),
<a name="1046"/> 1046: 			   Atters]),
<a name="1047"/> 1047:     Size = 1 + size(Data),
<a name="1048"/> 1048:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="1049"/> 1049: 			      ?SSH_FXP_SETSTAT, Data/binary&gt;&gt;),
<a name="set_attributes_file-last_expr"/><a name="1050"/> 1050: <b>    reply</b>(Cm, Channel).
<a name="1051"/> 1051: 
<a name="1052"/> 1052: 
<a name="set_attributes_open_file-5"/><a name="1053"/> 1053: <b>set_attributes_open_file</b>(Handle, Atters, Cm, Channel, ReqId) -&gt;
<a name="1054"/> 1054: 
<a name="1055"/> 1055:     Data = list_to_binary([?uint32(ReqId),
<a name="1056"/> 1056: 			   Handle,
<a name="1057"/> 1057: 			   Atters]),
<a name="1058"/> 1058:     Size = 1 + size(Data),
<a name="1059"/> 1059:     ssh_connection:send(Cm, Channel, &lt;&lt;?UINT32(Size),
<a name="1060"/> 1060: 			      ?SSH_FXP_FSETSTAT, Data/binary&gt;&gt;),
<a name="set_attributes_open_file-last_expr"/><a name="1061"/> 1061: <b>    reply</b>(Cm, Channel).
<a name="1062"/> 1062: 
<a name="1063"/> 1063: 
<a name="encode_file_type-1"/><a name="1064"/> 1064: <b>encode_file_type</b>(Type) -&gt;
<a name="encode_file_type-last_expr"/><a name="1065"/> 1065:     case Type of
<a name="1066"/> 1066: 	regular -&gt; ?SSH_FILEXFER_TYPE_REGULAR;
<a name="1067"/> 1067: 	directory -&gt; ?SSH_FILEXFER_TYPE_DIRECTORY;
<a name="1068"/> 1068: 	symlink -&gt; ?SSH_FILEXFER_TYPE_SYMLINK;
<a name="1069"/> 1069: 	special -&gt; ?SSH_FILEXFER_TYPE_SPECIAL;
<a name="1070"/> 1070: 	unknown -&gt; ?SSH_FILEXFER_TYPE_UNKNOWN;
<a name="1071"/> 1071: 	other -&gt; ?SSH_FILEXFER_TYPE_UNKNOWN;
<a name="1072"/> 1072: 	socket -&gt; ?SSH_FILEXFER_TYPE_SOCKET;
<a name="1073"/> 1073: 	char_device -&gt; ?SSH_FILEXFER_TYPE_CHAR_DEVICE;
<a name="1074"/> 1074: 	block_device -&gt; ?SSH_FILEXFER_TYPE_BLOCK_DEVICE;
<a name="1075"/> 1075: 	fifo -&gt; ?SSH_FILEXFER_TYPE_FIFO;
<a name="1076"/> 1076: 	undefined -&gt; ?SSH_FILEXFER_TYPE_UNKNOWN
<a name="1077"/> 1077:     end.
<a name="1078"/> 1078: 
<a name="not_default_permissions-0"/><a name="1079"/> 1079: <b>not_default_permissions</b>() -&gt;
<a name="not_default_permissions-last_expr"/><a name="1080"/> 1080:     8#600. %% User read-write-only
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
