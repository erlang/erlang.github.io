<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/kernel/make_test_dir/kernel_test/socket_api_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2024-2024. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%% There are some environment variables that can be used to &quot;manipulate&quot;</i>
<a name="22"/>   22: <i>%% the test suite: </i>
<a name="23"/>   23: <i>%%</i>
<a name="24"/>   24: <i>%% Variable that controls which 'groups' are to run (with default values)</i>
<a name="25"/>   25: <i>%%</i>
<a name="26"/>   26: <i>%%         ESOCK_TEST_API_MISC     include</i>
<a name="27"/>   27: <i>%%         ESOCK_TEST_API_BASIC    include</i>
<a name="28"/>   28: <i>%%         ESOCK_TEST_API_SENDFILE include</i>
<a name="29"/>   29: <i>%%         ESOCK_TEST_API_FROM_FD  include</i>
<a name="30"/>   30: <i>%%         ESOCK_TEST_API_OPTS     include</i>
<a name="31"/>   31: <i>%%         ESOCK_TEST_API_OPWTO    include</i>
<a name="32"/>   32: <i>%%</i>
<a name="33"/>   33: <i>%% Variable that controls &quot;verbosity&quot; of the test case(s):</i>
<a name="34"/>   34: <i>%%</i>
<a name="35"/>   35: <i>%%         ESOCK_TEST_QUIET: true (default) | false</i>
<a name="36"/>   36: <i>%%</i>
<a name="37"/>   37: 
<a name="38"/>   38: <i>%% Run the entire test suite: </i>
<a name="39"/>   39: <i>%% ts:run(kernel, socket_SUITE, [batch]).</i>
<a name="40"/>   40: <i>%%</i>
<a name="41"/>   41: <i>%% Run a specific group:</i>
<a name="42"/>   42: <i>%% ts:run(kernel, socket_SUITE, {group, foo}, [batch]).</i>
<a name="43"/>   43: <i>%%</i>
<a name="44"/>   44: <i>%% Run a specific test case:</i>
<a name="45"/>   45: <i>%% ts:run(kernel, socket_SUITE, foo, [batch]).</i>
<a name="46"/>   46: <i>%%</i>
<a name="47"/>   47: <i>%% (cd /mnt/c/$LOCAL_TESTS/26/kernel_test/ &amp;&amp; $ERL_TOP/bin/win32/erl.exe -sname kernel-26-tester -pa c:$LOCAL_TESTS/26/test_server)</i>
<a name="48"/>   48: <i>%% application:set_env(kernel, test_inet_backends, true).</i>
<a name="49"/>   49: <i>%% S = fun() -&gt; ts:run(kernel, socket_SUITE, [batch]) end.</i>
<a name="50"/>   50: <i>%% S = fun(SUITE) -&gt; ts:run(kernel, SUITE, [batch]) end.</i>
<a name="51"/>   51: <i>%% S = fun() -&gt; ct:run_test([{suite, socket_SUITE}]) end.</i>
<a name="52"/>   52: <i>%% S = fun(SUITE) -&gt; ct:run_test([{suite, SUITE}]) end.</i>
<a name="53"/>   53: <i>%% G = fun(GROUP) -&gt; ts:run(kernel, socket_SUITE, {group, GROUP}, [batch]) end.</i>
<a name="54"/>   54: <i>%% G = fun(SUITE, GROUP) -&gt; ts:run(kernel, SUITE, {group, GROUP}, [batch]) end.</i>
<a name="55"/>   55: <i>%% G = fun(GROUP) -&gt; ct:run_test([{suite, socket_SUITE}, {group, GROUP}]) end.</i>
<a name="56"/>   56: <i>%% G = fun(SUITE, GROUP) -&gt; ct:run_test([{suite, SUITE}, {group, GROUP}]) end.</i>
<a name="57"/>   57: <i>%% T = fun(TC) -&gt; ts:run(kernel, socket_SUITE, TC, [batch]) end.</i>
<a name="58"/>   58: <i>%% T = fun(TC) -&gt; ct:run_test([{suite, socket_SUITE}, {testcase, TC}]) end.</i>
<a name="59"/>   59: <i>%% T = fun(S, TC) -&gt; ct:run_test([{suite, S}, {testcase, TC}]) end.</i>
<a name="60"/>   60: <i>%% T = fun(S, G, TC) -&gt; ct:run_test([{suite, S}, {group, G}, {testcase, TC}]) end.</i>
<a name="61"/>   61: <i>%%</i>
<a name="62"/>   62: <i>%% Some official info about AF_UNIX</i>
<a name="63"/>   63: <i>%% https://devblogs.microsoft.com/commandline/windowswsl-interop-with-af_unix/</i>
<a name="64"/>   64: 
<a name="65"/>   65: 
<a name="66"/>   66: 
<a name="67"/>   67: <b>-module</b>(socket_api_SUITE).
<a name="68"/>   68: 
<a name="69"/>   69: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="70"/>   70: <b>-include_lib</b>(&quot;common_test/include/ct_event.hrl&quot;).
<a name="71"/>   71: <b>-include</b>(&quot;socket_test_evaluator.hrl&quot;).
<a name="72"/>   72: <b>-include</b>(&quot;kernel_test_lib.hrl&quot;).
<a name="73"/>   73: 
<a name="74"/>   74: <i>%% Suite exports</i>
<a name="75"/>   75: <b>-export</b>([suite/0, all/0, groups/0]).
<a name="76"/>   76: <b>-export</b>([init_per_suite/1,    end_per_suite/1,
<a name="77"/>   77:          init_per_group/2,    end_per_group/2,
<a name="78"/>   78:          init_per_testcase/2, end_per_testcase/2]).
<a name="79"/>   79: 
<a name="80"/>   80: <i>%% Test cases</i>
<a name="81"/>   81: <b>-export</b>([
<a name="82"/>   82:          %% *** API Misc ***
<a name="83"/>   83:          api_m_info/1,
<a name="84"/>   84:          api_m_debug/1,
<a name="85"/>   85:          api_m_error_open/1,
<a name="86"/>   86:          api_m_error_bind/1,
<a name="87"/>   87: 
<a name="88"/>   88:          %% *** API Basic ***
<a name="89"/>   89:          api_b_simple_open_and_close_udp4/1,
<a name="90"/>   90:          api_b_simple_open_and_close_udp6/1,
<a name="91"/>   91:          api_b_simple_open_and_close_tcp4/1,
<a name="92"/>   92:          api_b_simple_open_and_close_tcp6/1,
<a name="93"/>   93:          api_b_open_and_info_udp4/1,
<a name="94"/>   94:          api_b_open_and_info_udp6/1,
<a name="95"/>   95:          api_b_open_and_info_tcp4/1,
<a name="96"/>   96:          api_b_open_and_info_tcp6/1,
<a name="97"/>   97:          api_b_open_and_close_udp4/1,
<a name="98"/>   98:          api_b_open_and_close_udp6/1,
<a name="99"/>   99:          api_b_open_and_close_tcp4/1,
<a name="100"/>  100:          api_b_open_and_close_tcp6/1,
<a name="101"/>  101:          api_b_open_and_close_udpL/1,
<a name="102"/>  102:          api_b_open_and_close_tcpL/1,
<a name="103"/>  103:          api_b_open_and_close_seqpL/1,
<a name="104"/>  104: 	 api_b_open_and_close_seqp_sctp4/1,
<a name="105"/>  105: 	 api_b_open_and_close_seqp_sctp6/1,
<a name="106"/>  106: 	 api_b_open_and_close_stream_sctp4/1,
<a name="107"/>  107: 	 api_b_open_and_close_stream_sctp6/1,
<a name="108"/>  108:          api_b_open_and_maybe_close_raw/1,
<a name="109"/>  109:          api_b_sendto_and_recvfrom_udp4/1,
<a name="110"/>  110:          api_b_sendto_and_recvfrom_udpL/1,
<a name="111"/>  111:          api_b_sendmsg_and_recvmsg_udp4/1,
<a name="112"/>  112:          api_b_sendmsg_and_recvmsg_udpL/1,
<a name="113"/>  113:          api_b_send_and_recv_tcp4/1,
<a name="114"/>  114:          api_b_send_and_recv_stream_sctp4/1,
<a name="115"/>  115:          api_b_sendv_and_recv_tcp4/1,
<a name="116"/>  116:          api_b_send_and_recv_tcpL/1,
<a name="117"/>  117:          api_b_send_and_recv_seqpL/1,
<a name="118"/>  118:          api_b_sendmsg_and_recvmsg_tcp4/1,
<a name="119"/>  119:          api_b_sendmsg_and_recvmsg_tcpL/1,
<a name="120"/>  120:          api_b_sendmsg_and_recvmsg_seqpL/1,
<a name="121"/>  121:          api_b_sendmsg_and_recvmsg_stream_sctp4/1,
<a name="122"/>  122:          api_b_sendmsg_iov_dgram_inet/1,
<a name="123"/>  123:          api_b_sendmsg_iov_dgram_inet6/1,
<a name="124"/>  124:          api_b_sendmsg_iov_dgram_local/1,
<a name="125"/>  125:          api_b_sendmsg_iov_stream_inet/1,
<a name="126"/>  126:          api_b_sendmsg_iov_stream_inet6/1,
<a name="127"/>  127:          api_b_sendmsg_iov_stream_local/1,
<a name="128"/>  128:          api_b_dgram_connect_udp4/1,
<a name="129"/>  129:          api_b_dgram_connect_udp6/1,
<a name="130"/>  130:          api_b_sendv_tcp4/1,
<a name="131"/>  131:          api_b_sendv_tcp6/1,
<a name="132"/>  132: 
<a name="133"/>  133:          %% *** API sendfile ***
<a name="134"/>  134:          api_sendfile_inet/1,
<a name="135"/>  135:          api_sendfile_inet6/1,
<a name="136"/>  136:          api_sendfile_local/1,
<a name="137"/>  137:          api_sendfile_loop_inet/1,
<a name="138"/>  138:          api_sendfile_loop_inet6/1,
<a name="139"/>  139:          api_sendfile_loop_local/1,
<a name="140"/>  140: 
<a name="141"/>  141:          %% *** API socket from FD ***
<a name="142"/>  142:          api_ffd_open_wod_and_info_udp4/1,
<a name="143"/>  143:          api_ffd_open_wod_and_info_udp6/1,
<a name="144"/>  144:          api_ffd_open_wod_and_info_tcp4/1,
<a name="145"/>  145:          api_ffd_open_wod_and_info_tcp6/1,
<a name="146"/>  146:          api_ffd_open_wd_and_info_udp4/1,
<a name="147"/>  147:          api_ffd_open_wd_and_info_udp6/1,
<a name="148"/>  148:          api_ffd_open_wd_and_info_tcp4/1,
<a name="149"/>  149:          api_ffd_open_wd_and_info_tcp6/1,
<a name="150"/>  150:          api_ffd_open_and_open_wod_and_send_udp4/1,
<a name="151"/>  151:          api_ffd_open_and_open_wod_and_send_udp6/1,
<a name="152"/>  152:          api_ffd_open_and_open_wd_and_send_udp4/1,
<a name="153"/>  153:          api_ffd_open_and_open_wd_and_send_udp6/1,
<a name="154"/>  154:          api_ffd_open_connect_and_open_wod_and_send_tcp4/1,
<a name="155"/>  155:          api_ffd_open_connect_and_open_wod_and_send_tcp6/1,
<a name="156"/>  156:          api_ffd_open_connect_and_open_wd_and_send_tcp4/1,
<a name="157"/>  157:          api_ffd_open_connect_and_open_wd_and_send_tcp6/1,
<a name="158"/>  158: 
<a name="159"/>  159: 
<a name="160"/>  160:          %% *** API async ***
<a name="161"/>  161:          api_a_connect_tcp4/1,
<a name="162"/>  162:          api_a_connect_tcp6/1,
<a name="163"/>  163:          api_a_sendto_and_recvfrom_udp4/1,
<a name="164"/>  164:          api_a_sendto_and_recvfrom_udp6/1,
<a name="165"/>  165:          api_a_sendmsg_and_recvmsg_udp4/1,
<a name="166"/>  166:          api_a_sendmsg_and_recvmsg_udp6/1,
<a name="167"/>  167:          api_a_send_and_recv_tcp4/1,
<a name="168"/>  168:          api_a_send_and_recv_tcp6/1,
<a name="169"/>  169:          api_a_send_and_recv_sctp4/1,
<a name="170"/>  170:          api_a_send_and_recv_sctp6/1,
<a name="171"/>  171:          api_a_sendmsg_and_recvmsg_tcp4/1,
<a name="172"/>  172:          api_a_sendmsg_and_recvmsg_tcp6/1,
<a name="173"/>  173:          api_a_recvfrom_cancel_udp4/1,
<a name="174"/>  174:          api_a_recvfrom_cancel_udp6/1,
<a name="175"/>  175:          api_a_recvmsg_cancel_udp4/1,
<a name="176"/>  176:          api_a_recvmsg_cancel_udp6/1,
<a name="177"/>  177:          api_a_accept_cancel_tcp4/1,
<a name="178"/>  178:          api_a_accept_cancel_tcp6/1,
<a name="179"/>  179:          api_a_recv_cancel_tcp4/1,
<a name="180"/>  180:          api_a_recv_cancel_tcp6/1,
<a name="181"/>  181:          api_a_recvmsg_cancel_tcp4/1,
<a name="182"/>  182:          api_a_recvmsg_cancel_tcp6/1,
<a name="183"/>  183:          api_a_mrecvfrom_cancel_udp4/1,
<a name="184"/>  184:          api_a_mrecvfrom_cancel_udp6/1,
<a name="185"/>  185:          api_a_mrecvmsg_cancel_udp4/1,
<a name="186"/>  186:          api_a_mrecvmsg_cancel_udp6/1,
<a name="187"/>  187:          api_a_maccept_cancel_tcp4/1,
<a name="188"/>  188:          api_a_maccept_cancel_tcp6/1,
<a name="189"/>  189:          api_a_mrecv_cancel_tcp4/1,
<a name="190"/>  190:          api_a_mrecv_cancel_tcp6/1,
<a name="191"/>  191:          api_a_mrecvmsg_cancel_tcp4/1,
<a name="192"/>  192:          api_a_mrecvmsg_cancel_tcp6/1,
<a name="193"/>  193: 
<a name="194"/>  194: 
<a name="195"/>  195:          %% *** API Options ***
<a name="196"/>  196:          api_opt_simple_otp_options/1,
<a name="197"/>  197:          api_opt_simple_otp_meta_option/1,
<a name="198"/>  198:          api_opt_simple_otp_rcvbuf_option/1,
<a name="199"/>  199:          api_opt_simple_otp_controlling_process/1,
<a name="200"/>  200:          api_opt_sock_acceptconn_udp/1,
<a name="201"/>  201:          api_opt_sock_acceptconn_tcp/1,
<a name="202"/>  202:          api_opt_sock_acceptfilter/1,
<a name="203"/>  203:          api_opt_sock_bindtodevice/1,
<a name="204"/>  204:          api_opt_sock_broadcast/1,
<a name="205"/>  205:          api_opt_sock_debug/1,
<a name="206"/>  206:          api_opt_sock_domain/1,
<a name="207"/>  207:          api_opt_sock_dontroute/1,
<a name="208"/>  208:          api_opt_sock_error/1,
<a name="209"/>  209:          api_opt_sock_keepalive/1,
<a name="210"/>  210:          api_opt_sock_linger/1,
<a name="211"/>  211:          api_opt_sock_mark/1,
<a name="212"/>  212:          api_opt_sock_maxdg/1,
<a name="213"/>  213:          api_opt_sock_max_msg_size/1,
<a name="214"/>  214:          api_opt_sock_oobinline/1,
<a name="215"/>  215:          api_opt_sock_passcred_tcp4/1,
<a name="216"/>  216:          api_opt_sock_peek_off_tcpL/1,
<a name="217"/>  217:          api_opt_sock_peercred_tcpL/1,
<a name="218"/>  218:          api_opt_sock_priority_udp4/1,
<a name="219"/>  219:          api_opt_sock_priority_tcp4/1,
<a name="220"/>  220:          api_opt_sock_rcvbuf_udp4/1,
<a name="221"/>  221:          api_opt_sock_rcvlowat_udp4/1,
<a name="222"/>  222:          api_opt_sock_rcvtimeo_udp4/1,
<a name="223"/>  223:          api_opt_sock_reuseaddr/1,
<a name="224"/>  224:          api_opt_sock_exclusiveaddruse/1,
<a name="225"/>  225:          api_opt_sock_bsp_state/1,
<a name="226"/>  226:          api_opt_sock_sndbuf_udp4/1,
<a name="227"/>  227:          api_opt_sock_sndlowat_udp4/1,
<a name="228"/>  228:          api_opt_sock_sndtimeo_udp4/1,
<a name="229"/>  229:          api_opt_sock_timestamp_udp4/1,
<a name="230"/>  230:          api_opt_sock_timestamp_tcp4/1,
<a name="231"/>  231:          api_opt_ip_add_drop_membership/0, api_opt_ip_add_drop_membership/1,
<a name="232"/>  232:          api_opt_ip_pktinfo_udp4/1,
<a name="233"/>  233:          api_opt_ip_recvopts_udp4/1,
<a name="234"/>  234:          api_opt_ip_recvorigdstaddr_udp4/1,
<a name="235"/>  235:          api_opt_ip_recvtos_udp4/1,
<a name="236"/>  236:          api_opt_ip_recvttl_udp4/1,
<a name="237"/>  237:          api_opt_ip_tos_udp4/1,
<a name="238"/>  238:          api_opt_ip_recverr_udp4/1,
<a name="239"/>  239:          api_opt_ip_mopts_udp4/1,
<a name="240"/>  240:          api_opt_ipv6_recvpktinfo_udp6/1,
<a name="241"/>  241: 	 api_opt_ipv6_flowinfo_udp6/1,
<a name="242"/>  242: 	 api_opt_ipv6_hoplimit_udp6/1,
<a name="243"/>  243: 	 api_opt_ipv6_tclass_udp6/1,
<a name="244"/>  244:          api_opt_ipv6_recverr_udp6/1,
<a name="245"/>  245: 	 api_opt_ipv6_mopts_udp6/1,
<a name="246"/>  246:          api_opt_tcp_congestion_tcp4/1,
<a name="247"/>  247:          api_opt_tcp_cork_tcp4/1,
<a name="248"/>  248:          api_opt_tcp_maxseg_tcp4/1,
<a name="249"/>  249:          api_opt_tcp_nodelay_tcp4/1,
<a name="250"/>  250:          api_opt_tcp_keepcnt_tcp4/1,
<a name="251"/>  251:          api_opt_tcp_keepidle_tcp4/1,
<a name="252"/>  252:          api_opt_tcp_keepintvl_tcp4/1,
<a name="253"/>  253:          api_opt_udp_cork_udp4/1,
<a name="254"/>  254: 
<a name="255"/>  255:          %% *** API Operation Timeout ***
<a name="256"/>  256:          api_to_connect_tcp4/1,
<a name="257"/>  257:          api_to_connect_tcp6/1,
<a name="258"/>  258:          api_to_accept_tcp4/1,
<a name="259"/>  259:          api_to_accept_tcp6/1,
<a name="260"/>  260:          api_to_maccept_tcp4/1,
<a name="261"/>  261:          api_to_maccept_tcp6/1,
<a name="262"/>  262:          api_to_send_tcp4/1,
<a name="263"/>  263:          api_to_send_tcp6/1,
<a name="264"/>  264:          api_to_sendto_udp4/1,
<a name="265"/>  265:          api_to_sendto_udp6/1,
<a name="266"/>  266:          api_to_sendmsg_tcp4/1,
<a name="267"/>  267:          api_to_sendmsg_tcp6/1,
<a name="268"/>  268:          api_to_recv_udp4/1,
<a name="269"/>  269:          api_to_recv_udp6/1,
<a name="270"/>  270:          api_to_recv_tcp4/1,
<a name="271"/>  271:          api_to_recv_tcp6/1,
<a name="272"/>  272:          api_to_recvfrom_udp4/1,
<a name="273"/>  273:          api_to_recvfrom_udp6/1,
<a name="274"/>  274:          api_to_recvmsg_udp4/1,
<a name="275"/>  275:          api_to_recvmsg_udp6/1,
<a name="276"/>  276:          api_to_recvmsg_tcp4/1,
<a name="277"/>  277:          api_to_recvmsg_tcp6/1
<a name="278"/>  278:         ]).
<a name="279"/>  279: 
<a name="280"/>  280: 
<a name="281"/>  281: 
<a name="282"/>  282: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="283"/>  283: 
<a name="284"/>  284: <b>-define</b>(SLIB,       socket_test_lib).
<a name="285"/>  285: <b>-define</b>(KLIB,       kernel_test_lib).
<a name="286"/>  286: <b>-define</b>(LOGGER,     socket_test_logger).
<a name="287"/>  287: 
<a name="288"/>  288: <b>-define</b>(BASIC_REQ,  &lt;&lt;&quot;hejsan&quot;&gt;&gt;).
<a name="289"/>  289: <b>-define</b>(BASIC_REP,  &lt;&lt;&quot;hoppsan&quot;&gt;&gt;).
<a name="290"/>  290: 
<a name="291"/>  291: <i>%% -define(DATA,       &lt;&lt;&quot;HOPPSAN&quot;&gt;&gt;). % Temporary</i>
<a name="292"/>  292: <b>-define</b>(FAIL(R),    exit(R)).
<a name="293"/>  293: 
<a name="294"/>  294: <i>%% -define(SLEEP(T),   receive after T -&gt; ok end).</i>
<a name="295"/>  295: 
<a name="296"/>  296: <i>%% -define(MINS(M),    timer:minutes(M)).</i>
<a name="297"/>  297: <i>%% -define(SECS(S),    timer:seconds(S)).</i>
<a name="298"/>  298: 
<a name="299"/>  299: <i>%% -define(TT(T),      ct:timetrap(T)).</i>
<a name="300"/>  300: 
<a name="301"/>  301: <i>%% -define(F(F, A),    ?SLIB:f(F, A)).</i>
<a name="302"/>  302: <i>%% -define(P(F),       ?SLIB:print(F)).</i>
<a name="303"/>  303: <i>%% -define(P(F, A),    ?SLIB:print(F, A)).</i>
<a name="304"/>  304: 
<a name="305"/>  305: <i>%% -define(WINDOWS, {win32,nt}).</i>
<a name="306"/>  306: 
<a name="307"/>  307: <i>%% -define(START_NODE(NamePre),</i>
<a name="308"/>  308: <i>%%         ?START_NODE(NamePre, 5000)).</i>
<a name="309"/>  309: <i>%% -define(START_NODE(NamePre, Timeout),</i>
<a name="310"/>  310: <i>%%         start_node(?CT_PEER_NAME(NamePre), Timeout)).</i>
<a name="311"/>  311: 
<a name="312"/>  312: 
<a name="313"/>  313: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="314"/>  314: 
<a name="suite-0"/><a name="315"/>  315: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="316"/>  316:     [{ct_hooks, [ts_install_cth]},
<a name="317"/>  317:      {timetrap, {minutes,1}}].
<a name="318"/>  318: 
<a name="all-0"/><a name="319"/>  319: <b>all</b>() -&gt; 
<a name="320"/>  320:     Groups = [
<a name="321"/>  321:               {misc,                   &quot;ESOCK_TEST_API_MISC&quot;,     include},
<a name="322"/>  322:               {basic,                  &quot;ESOCK_TEST_API_BASIC&quot;,    include},
<a name="323"/>  323:               {sendfile,               &quot;ESOCK_TEST_API_SENDFILE&quot;, include},
<a name="324"/>  324:               {from_fd,                &quot;ESOCK_TEST_API_FROM_FD&quot;,  include},
<a name="325"/>  325:               {options,                &quot;ESOCK_TEST_API_OPTS&quot;,     include},
<a name="326"/>  326:               {operation_with_timeout, &quot;ESOCK_TEST_API_OPWTO&quot;,    include}
<a name="327"/>  327:              ],
<a name="all-last_expr"/><a name="328"/>  328: <b>    [use_group</b>(Group, Env, Default) || {Group, Env, Default} &lt;- Groups].
<a name="329"/>  329: 
<a name="use_group-3"/><a name="330"/>  330: <b>use_group</b>(_Group, undefined, exclude) -&gt;
<a name="331"/>  331:     [];
<a name="332"/>  332: <b>use_group</b>(Group, undefined, _Default) -&gt;
<a name="333"/>  333:     [{group, Group}];
<a name="334"/>  334: <b>use_group</b>(Group, Env, Default) -&gt;
<a name="use_group-last_expr"/><a name="335"/>  335: <b>	case os:getenv</b>(Env) of
<a name="336"/>  336: 	    false when (Default =:= include) -&gt;
<a name="337"/>  337: 		[{group, Group}];
<a name="338"/>  338: 	    false -&gt;
<a name="339"/>  339: 		[];
<a name="340"/>  340: 	    Val -&gt;
<a name="341"/>  341: 		case list_to_atom(string:to_lower(Val)) of
<a name="342"/>  342: 		    Use when (Use =:= include) orelse 
<a name="343"/>  343: 			     (Use =:= enable) orelse 
<a name="344"/>  344: 			     (Use =:= true) -&gt;
<a name="345"/>  345: 			[{group, Group}];
<a name="346"/>  346: 		    _ -&gt;
<a name="347"/>  347: 			[]
<a name="348"/>  348: 		end
<a name="349"/>  349: 	end.
<a name="350"/>  350:     
<a name="351"/>  351: 
<a name="groups-0"/><a name="352"/>  352: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="353"/>  353: <b>    [{misc,                    [], api_misc_cases</b>()},
<a name="354"/>  354:      {basic,                   [], api_basic_cases()},
<a name="355"/>  355:      {sendfile,                [], api_sendfile_cases()},
<a name="356"/>  356:      {from_fd,                 [], api_from_fd_cases()},
<a name="357"/>  357:      {async,                   [], api_async_cases()},
<a name="358"/>  358:      {async_ref,               [], api_async_cases()},
<a name="359"/>  359:      {options,                 [], api_options_cases()},
<a name="360"/>  360:      {options_otp,             [], api_options_otp_cases()},
<a name="361"/>  361:      {options_socket,          [], api_options_socket_cases()},
<a name="362"/>  362:      {option_sock_acceptconn,  [], api_option_sock_acceptconn_cases()},
<a name="363"/>  363:      {option_sock_passcred,    [], api_option_sock_passcred_cases()},
<a name="364"/>  364:      {option_sock_priority,    [], api_option_sock_priority_cases()},
<a name="365"/>  365:      {option_sock_buf,         [], api_option_sock_buf_cases()},
<a name="366"/>  366:      {option_sock_lowat,       [], api_option_sock_lowat_cases()},
<a name="367"/>  367:      {option_sock_timeo,       [], api_option_sock_timeo_cases()},
<a name="368"/>  368:      {option_sock_timestamp,   [], api_option_sock_timestamp_cases()},
<a name="369"/>  369:      {options_ip,              [], api_options_ip_cases()},
<a name="370"/>  370:      {options_ipv6,            [], api_options_ipv6_cases()},
<a name="371"/>  371:      {options_tcp,             [], api_options_tcp_cases()},
<a name="372"/>  372:      {options_udp,             [], api_options_udp_cases()},
<a name="373"/>  373:      %% {options_sctp,            [], api_options_sctp_cases()},
<a name="374"/>  374:      {operation_with_timeout,  [], api_op_with_timeout_cases()}
<a name="375"/>  375:     ].
<a name="376"/>  376:      
<a name="api_misc_cases-0"/><a name="377"/>  377: <b>api_misc_cases</b>() -&gt;
<a name="api_misc_cases-last_expr"/><a name="378"/>  378:     [
<a name="379"/>  379:      api_m_info,
<a name="380"/>  380:      api_m_debug,
<a name="381"/>  381:      api_m_error_open,
<a name="382"/>  382:      api_m_error_bind
<a name="383"/>  383:     ].
<a name="384"/>  384: 
<a name="api_basic_cases-0"/><a name="385"/>  385: <b>api_basic_cases</b>() -&gt;
<a name="api_basic_cases-last_expr"/><a name="386"/>  386:     [
<a name="387"/>  387:      api_b_simple_open_and_close_udp4,
<a name="388"/>  388:      api_b_simple_open_and_close_udp6,
<a name="389"/>  389:      api_b_simple_open_and_close_tcp4,
<a name="390"/>  390:      api_b_simple_open_and_close_tcp6,
<a name="391"/>  391:      api_b_open_and_info_udp4,
<a name="392"/>  392:      api_b_open_and_info_udp6,
<a name="393"/>  393:      api_b_open_and_info_tcp4,
<a name="394"/>  394:      api_b_open_and_info_tcp6,
<a name="395"/>  395:      api_b_open_and_close_udp4,
<a name="396"/>  396:      api_b_open_and_close_udp6,
<a name="397"/>  397:      api_b_open_and_close_tcp4,
<a name="398"/>  398:      api_b_open_and_close_tcp6,
<a name="399"/>  399:      api_b_open_and_close_udpL,
<a name="400"/>  400:      api_b_open_and_close_tcpL,
<a name="401"/>  401:      api_b_open_and_close_seqpL,
<a name="402"/>  402:      api_b_open_and_close_seqp_sctp4,
<a name="403"/>  403:      api_b_open_and_close_seqp_sctp6,
<a name="404"/>  404:      api_b_open_and_close_stream_sctp4,
<a name="405"/>  405:      api_b_open_and_close_stream_sctp6,
<a name="406"/>  406:      api_b_open_and_maybe_close_raw,
<a name="407"/>  407:      api_b_sendto_and_recvfrom_udp4,
<a name="408"/>  408:      api_b_sendto_and_recvfrom_udpL,
<a name="409"/>  409:      api_b_sendmsg_and_recvmsg_udp4,
<a name="410"/>  410:      api_b_sendmsg_and_recvmsg_udpL,
<a name="411"/>  411:      api_b_send_and_recv_tcp4,
<a name="412"/>  412:      api_b_send_and_recv_stream_sctp4,
<a name="413"/>  413:      api_b_sendv_and_recv_tcp4,
<a name="414"/>  414:      api_b_send_and_recv_tcpL,
<a name="415"/>  415:      api_b_send_and_recv_seqpL,
<a name="416"/>  416:      api_b_sendmsg_and_recvmsg_tcp4,
<a name="417"/>  417:      api_b_sendmsg_and_recvmsg_tcpL,
<a name="418"/>  418:      api_b_sendmsg_and_recvmsg_seqpL,
<a name="419"/>  419:      api_b_sendmsg_and_recvmsg_stream_sctp4,
<a name="420"/>  420:      api_b_sendmsg_iov_dgram_inet,
<a name="421"/>  421:      api_b_sendmsg_iov_dgram_inet6,
<a name="422"/>  422:      api_b_sendmsg_iov_dgram_local,
<a name="423"/>  423:      api_b_sendmsg_iov_stream_inet,
<a name="424"/>  424:      api_b_sendmsg_iov_stream_inet6,
<a name="425"/>  425:      api_b_sendmsg_iov_stream_local,
<a name="426"/>  426:      api_b_dgram_connect_udp4,
<a name="427"/>  427:      api_b_dgram_connect_udp6,
<a name="428"/>  428:      api_b_sendv_tcp4,
<a name="429"/>  429:      api_b_sendv_tcp6
<a name="430"/>  430:     ].
<a name="431"/>  431: 
<a name="api_sendfile_cases-0"/><a name="432"/>  432: <b>api_sendfile_cases</b>() -&gt;
<a name="api_sendfile_cases-last_expr"/><a name="433"/>  433:     [
<a name="434"/>  434:      api_sendfile_inet,
<a name="435"/>  435:      api_sendfile_inet6,
<a name="436"/>  436:      api_sendfile_local,
<a name="437"/>  437:      api_sendfile_loop_inet,
<a name="438"/>  438:      api_sendfile_loop_inet6,
<a name="439"/>  439:      api_sendfile_loop_local
<a name="440"/>  440:     ].
<a name="441"/>  441: 
<a name="api_from_fd_cases-0"/><a name="442"/>  442: <b>api_from_fd_cases</b>() -&gt;
<a name="api_from_fd_cases-last_expr"/><a name="443"/>  443:     [
<a name="444"/>  444:      api_ffd_open_wod_and_info_udp4,
<a name="445"/>  445:      api_ffd_open_wod_and_info_udp6,
<a name="446"/>  446:      api_ffd_open_wod_and_info_tcp4,
<a name="447"/>  447:      api_ffd_open_wod_and_info_tcp6,
<a name="448"/>  448:      api_ffd_open_wd_and_info_udp4,
<a name="449"/>  449:      api_ffd_open_wd_and_info_udp6,
<a name="450"/>  450:      api_ffd_open_wd_and_info_tcp4,
<a name="451"/>  451:      api_ffd_open_wd_and_info_tcp6,
<a name="452"/>  452:      api_ffd_open_and_open_wod_and_send_udp4,
<a name="453"/>  453:      api_ffd_open_and_open_wod_and_send_udp6,
<a name="454"/>  454:      api_ffd_open_and_open_wd_and_send_udp4,
<a name="455"/>  455:      api_ffd_open_and_open_wd_and_send_udp6,
<a name="456"/>  456:      api_ffd_open_connect_and_open_wod_and_send_tcp4,
<a name="457"/>  457:      api_ffd_open_connect_and_open_wod_and_send_tcp6,
<a name="458"/>  458:      api_ffd_open_connect_and_open_wd_and_send_tcp4,
<a name="459"/>  459:      api_ffd_open_connect_and_open_wd_and_send_tcp6
<a name="460"/>  460:     ].
<a name="461"/>  461: 
<a name="api_async_cases-0"/><a name="462"/>  462: <b>api_async_cases</b>() -&gt;
<a name="api_async_cases-last_expr"/><a name="463"/>  463:     [
<a name="464"/>  464:      api_a_connect_tcp4,
<a name="465"/>  465:      api_a_connect_tcp6,
<a name="466"/>  466:      api_a_sendto_and_recvfrom_udp4,
<a name="467"/>  467:      api_a_sendto_and_recvfrom_udp6,
<a name="468"/>  468:      api_a_sendmsg_and_recvmsg_udp4,
<a name="469"/>  469:      api_a_sendmsg_and_recvmsg_udp6,
<a name="470"/>  470:      api_a_send_and_recv_tcp4,
<a name="471"/>  471:      api_a_send_and_recv_tcp6,
<a name="472"/>  472:      api_a_send_and_recv_sctp4,
<a name="473"/>  473:      api_a_send_and_recv_sctp6,
<a name="474"/>  474:      api_a_sendmsg_and_recvmsg_tcp4,
<a name="475"/>  475:      api_a_sendmsg_and_recvmsg_tcp6,
<a name="476"/>  476:      api_a_recvfrom_cancel_udp4,
<a name="477"/>  477:      api_a_recvfrom_cancel_udp6,
<a name="478"/>  478:      api_a_recvmsg_cancel_udp4,
<a name="479"/>  479:      api_a_recvmsg_cancel_udp6,
<a name="480"/>  480:      api_a_accept_cancel_tcp4,
<a name="481"/>  481:      api_a_accept_cancel_tcp6,
<a name="482"/>  482:      api_a_recv_cancel_tcp4,
<a name="483"/>  483:      api_a_recv_cancel_tcp6,
<a name="484"/>  484:      api_a_recvmsg_cancel_tcp4,
<a name="485"/>  485:      api_a_recvmsg_cancel_tcp6,
<a name="486"/>  486:      api_a_mrecvfrom_cancel_udp4,
<a name="487"/>  487:      api_a_mrecvfrom_cancel_udp6,
<a name="488"/>  488:      api_a_mrecvmsg_cancel_udp4,
<a name="489"/>  489:      api_a_mrecvmsg_cancel_udp6,
<a name="490"/>  490:      api_a_maccept_cancel_tcp4,
<a name="491"/>  491:      api_a_maccept_cancel_tcp6,
<a name="492"/>  492:      api_a_mrecv_cancel_tcp4,
<a name="493"/>  493:      api_a_mrecv_cancel_tcp6,
<a name="494"/>  494:      api_a_mrecvmsg_cancel_tcp4,
<a name="495"/>  495:      api_a_mrecvmsg_cancel_tcp6
<a name="496"/>  496:     ].
<a name="497"/>  497: 
<a name="api_options_cases-0"/><a name="498"/>  498: <b>api_options_cases</b>() -&gt;
<a name="api_options_cases-last_expr"/><a name="499"/>  499:     [
<a name="500"/>  500:      {group, options_otp},
<a name="501"/>  501:      {group, options_socket},
<a name="502"/>  502:      {group, options_ip},
<a name="503"/>  503:      {group, options_ipv6},
<a name="504"/>  504:      {group, options_tcp},
<a name="505"/>  505:      {group, options_udp}
<a name="506"/>  506:      %% {group, options_sctp}
<a name="507"/>  507:     ].
<a name="508"/>  508: 
<a name="api_options_otp_cases-0"/><a name="509"/>  509: <b>api_options_otp_cases</b>() -&gt;
<a name="api_options_otp_cases-last_expr"/><a name="510"/>  510:     [
<a name="511"/>  511:      api_opt_simple_otp_options,
<a name="512"/>  512:      api_opt_simple_otp_meta_option,
<a name="513"/>  513:      api_opt_simple_otp_rcvbuf_option,
<a name="514"/>  514:      api_opt_simple_otp_controlling_process
<a name="515"/>  515:     ].
<a name="516"/>  516: 
<a name="api_options_socket_cases-0"/><a name="517"/>  517: <b>api_options_socket_cases</b>() -&gt;
<a name="api_options_socket_cases-last_expr"/><a name="518"/>  518:     [
<a name="519"/>  519:      {group, option_sock_acceptconn},
<a name="520"/>  520:      api_opt_sock_acceptfilter,
<a name="521"/>  521:      api_opt_sock_bindtodevice,
<a name="522"/>  522:      api_opt_sock_broadcast,
<a name="523"/>  523:      api_opt_sock_debug,
<a name="524"/>  524:      api_opt_sock_domain,
<a name="525"/>  525:      api_opt_sock_dontroute,
<a name="526"/>  526:      api_opt_sock_error,
<a name="527"/>  527:      api_opt_sock_keepalive,
<a name="528"/>  528:      api_opt_sock_linger,
<a name="529"/>  529:      api_opt_sock_mark,
<a name="530"/>  530:      api_opt_sock_maxdg,
<a name="531"/>  531:      api_opt_sock_max_msg_size,
<a name="532"/>  532:      api_opt_sock_oobinline,
<a name="533"/>  533:      {group, option_sock_passcred},
<a name="534"/>  534:      api_opt_sock_peek_off_tcpL,
<a name="535"/>  535:      api_opt_sock_peercred_tcpL,
<a name="536"/>  536:      {group, option_sock_priority},
<a name="537"/>  537:      {group, option_sock_buf},
<a name="538"/>  538:      {group, option_sock_lowat},
<a name="539"/>  539:      {group, option_sock_timeo},
<a name="540"/>  540:      {group, option_sock_timestamp},
<a name="541"/>  541:      api_opt_sock_reuseaddr,
<a name="542"/>  542:      api_opt_sock_exclusiveaddruse,
<a name="543"/>  543:      api_opt_sock_bsp_state
<a name="544"/>  544: 
<a name="545"/>  545:     ].
<a name="546"/>  546: 
<a name="api_option_sock_acceptconn_cases-0"/><a name="547"/>  547: <b>api_option_sock_acceptconn_cases</b>() -&gt;
<a name="api_option_sock_acceptconn_cases-last_expr"/><a name="548"/>  548:     [
<a name="549"/>  549:      api_opt_sock_acceptconn_udp,
<a name="550"/>  550:      api_opt_sock_acceptconn_tcp
<a name="551"/>  551:     ].
<a name="552"/>  552: 
<a name="api_option_sock_passcred_cases-0"/><a name="553"/>  553: <b>api_option_sock_passcred_cases</b>() -&gt;
<a name="api_option_sock_passcred_cases-last_expr"/><a name="554"/>  554:     [
<a name="555"/>  555:      %% api_opt_sock_passcred_udp4,
<a name="556"/>  556:      api_opt_sock_passcred_tcp4
<a name="557"/>  557:     ].
<a name="558"/>  558: 
<a name="api_option_sock_priority_cases-0"/><a name="559"/>  559: <b>api_option_sock_priority_cases</b>() -&gt;
<a name="api_option_sock_priority_cases-last_expr"/><a name="560"/>  560:     [
<a name="561"/>  561:      api_opt_sock_priority_udp4,
<a name="562"/>  562:      api_opt_sock_priority_tcp4%,
<a name="563"/>  563:      %% api_opt_sock_priority_udp6,
<a name="564"/>  564:      %% api_opt_sock_priority_tcp6
<a name="565"/>  565:     ].
<a name="566"/>  566: 
<a name="api_option_sock_buf_cases-0"/><a name="567"/>  567: <b>api_option_sock_buf_cases</b>() -&gt;
<a name="api_option_sock_buf_cases-last_expr"/><a name="568"/>  568:     [
<a name="569"/>  569:      api_opt_sock_rcvbuf_udp4,
<a name="570"/>  570:      api_opt_sock_sndbuf_udp4
<a name="571"/>  571:     ].
<a name="572"/>  572: 
<a name="api_option_sock_lowat_cases-0"/><a name="573"/>  573: <b>api_option_sock_lowat_cases</b>() -&gt;
<a name="api_option_sock_lowat_cases-last_expr"/><a name="574"/>  574:     [
<a name="575"/>  575:      api_opt_sock_rcvlowat_udp4,
<a name="576"/>  576:      api_opt_sock_sndlowat_udp4
<a name="577"/>  577:     ].
<a name="578"/>  578: 
<a name="api_option_sock_timeo_cases-0"/><a name="579"/>  579: <b>api_option_sock_timeo_cases</b>() -&gt;
<a name="api_option_sock_timeo_cases-last_expr"/><a name="580"/>  580:     [
<a name="581"/>  581:      api_opt_sock_rcvtimeo_udp4,
<a name="582"/>  582:      api_opt_sock_sndtimeo_udp4
<a name="583"/>  583:     ].
<a name="584"/>  584: 
<a name="api_option_sock_timestamp_cases-0"/><a name="585"/>  585: <b>api_option_sock_timestamp_cases</b>() -&gt;
<a name="api_option_sock_timestamp_cases-last_expr"/><a name="586"/>  586:     [
<a name="587"/>  587:      api_opt_sock_timestamp_udp4,
<a name="588"/>  588:      api_opt_sock_timestamp_tcp4
<a name="589"/>  589:     ].
<a name="590"/>  590: 
<a name="api_options_ip_cases-0"/><a name="591"/>  591: <b>api_options_ip_cases</b>() -&gt;
<a name="api_options_ip_cases-last_expr"/><a name="592"/>  592:     [
<a name="593"/>  593:      api_opt_ip_add_drop_membership,
<a name="594"/>  594:      api_opt_ip_pktinfo_udp4,
<a name="595"/>  595:      api_opt_ip_recvopts_udp4,
<a name="596"/>  596:      api_opt_ip_recvorigdstaddr_udp4,
<a name="597"/>  597:      api_opt_ip_recvtos_udp4,
<a name="598"/>  598:      api_opt_ip_recvttl_udp4,
<a name="599"/>  599:      api_opt_ip_tos_udp4,
<a name="600"/>  600:      api_opt_ip_recverr_udp4,
<a name="601"/>  601: 
<a name="602"/>  602:      %% Should be last!
<a name="603"/>  603:      api_opt_ip_mopts_udp4
<a name="604"/>  604:     ].
<a name="605"/>  605: 
<a name="api_options_ipv6_cases-0"/><a name="606"/>  606: <b>api_options_ipv6_cases</b>() -&gt;
<a name="api_options_ipv6_cases-last_expr"/><a name="607"/>  607:     [
<a name="608"/>  608:      api_opt_ipv6_recvpktinfo_udp6,
<a name="609"/>  609:      api_opt_ipv6_flowinfo_udp6,
<a name="610"/>  610:      api_opt_ipv6_hoplimit_udp6,
<a name="611"/>  611:      api_opt_ipv6_tclass_udp6,
<a name="612"/>  612:      api_opt_ipv6_recverr_udp6,
<a name="613"/>  613: 
<a name="614"/>  614:      %% Should be last!
<a name="615"/>  615:      api_opt_ipv6_mopts_udp6
<a name="616"/>  616:     ].
<a name="617"/>  617: 
<a name="api_options_tcp_cases-0"/><a name="618"/>  618: <b>api_options_tcp_cases</b>() -&gt;
<a name="api_options_tcp_cases-last_expr"/><a name="619"/>  619:     [
<a name="620"/>  620:      api_opt_tcp_congestion_tcp4,
<a name="621"/>  621:      %% api_opt_tcp_congestion_tcp6,
<a name="622"/>  622:      api_opt_tcp_cork_tcp4,
<a name="623"/>  623:      %% api_opt_tcp_cork_tcp6,
<a name="624"/>  624:      api_opt_tcp_maxseg_tcp4,
<a name="625"/>  625:      %% api_opt_tcp_maxseg_tcp6,
<a name="626"/>  626:      api_opt_tcp_nodelay_tcp4,
<a name="627"/>  627:      %% api_opt_tcp_nodelay_tcp6
<a name="628"/>  628:      api_opt_tcp_keepcnt_tcp4,
<a name="629"/>  629:      api_opt_tcp_keepidle_tcp4,
<a name="630"/>  630:      api_opt_tcp_keepintvl_tcp4
<a name="631"/>  631:     ].
<a name="632"/>  632: 
<a name="api_options_udp_cases-0"/><a name="633"/>  633: <b>api_options_udp_cases</b>() -&gt;
<a name="api_options_udp_cases-last_expr"/><a name="634"/>  634:     [
<a name="635"/>  635:      api_opt_udp_cork_udp4%,
<a name="636"/>  636:      %% api_opt_udp_cork_udp6
<a name="637"/>  637:     ].
<a name="638"/>  638: 
<a name="api_op_with_timeout_cases-0"/><a name="639"/>  639: <b>api_op_with_timeout_cases</b>() -&gt;
<a name="api_op_with_timeout_cases-last_expr"/><a name="640"/>  640:     [
<a name="641"/>  641:      api_to_connect_tcp4,
<a name="642"/>  642:      api_to_connect_tcp6,
<a name="643"/>  643:      api_to_accept_tcp4,
<a name="644"/>  644:      api_to_accept_tcp6,
<a name="645"/>  645:      api_to_maccept_tcp4,
<a name="646"/>  646:      api_to_maccept_tcp6,
<a name="647"/>  647:      api_to_send_tcp4,
<a name="648"/>  648:      api_to_send_tcp6,
<a name="649"/>  649:      api_to_sendto_udp4,
<a name="650"/>  650:      api_to_sendto_udp6,
<a name="651"/>  651:      api_to_sendmsg_tcp4,
<a name="652"/>  652:      api_to_sendmsg_tcp6,
<a name="653"/>  653:      api_to_recv_udp4,
<a name="654"/>  654:      api_to_recv_udp6,
<a name="655"/>  655:      api_to_recv_tcp4,
<a name="656"/>  656:      api_to_recv_tcp6,
<a name="657"/>  657:      api_to_recvfrom_udp4,
<a name="658"/>  658:      api_to_recvfrom_udp6,
<a name="659"/>  659:      api_to_recvmsg_udp4,
<a name="660"/>  660:      api_to_recvmsg_udp6,
<a name="661"/>  661:      api_to_recvmsg_tcp4,
<a name="662"/>  662:      api_to_recvmsg_tcp6
<a name="663"/>  663:     ].
<a name="664"/>  664: 
<a name="665"/>  665: 
<a name="666"/>  666: 
<a name="667"/>  667: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="668"/>  668: 
<a name="init_per_suite-1"/><a name="669"/>  669: <b>init_per_suite</b>(Config0) -&gt;
<a name="670"/>  670:     ?P(&quot;init_per_suite -&gt; entry with&quot;
<a name="671"/>  671:        &quot;~n      Config: ~p&quot;
<a name="672"/>  672:        &quot;~n      Nodes:  ~p&quot;, [Config0, erlang:nodes()]),
<a name="673"/>  673:     
<a name="init_per_suite-last_expr"/><a name="674"/>  674: <b>    try socket:info</b>() of
<a name="675"/>  675:         #{} -&gt;
<a name="676"/>  676:             case ?KLIB:init_per_suite(Config0) of
<a name="677"/>  677:                 {skip, _} = SKIP -&gt;
<a name="678"/>  678:                     SKIP;
<a name="679"/>  679: 
<a name="680"/>  680:                 Config1 when is_list(Config1) -&gt;
<a name="681"/>  681: 
<a name="682"/>  682:                     ?P(&quot;init_per_suite -&gt; end when &quot;
<a name="683"/>  683:                        &quot;~n      Config: ~p&quot;, [Config1]),
<a name="684"/>  684: 
<a name="685"/>  685:                     %% We need a monitor on this node also
<a name="686"/>  686:                     kernel_test_sys_monitor:start(),
<a name="687"/>  687: 
<a name="688"/>  688:                     socket:use_registry(false),
<a name="689"/>  689:                     case quiet_mode(Config1) of
<a name="690"/>  690:                         default -&gt;
<a name="691"/>  691:                             case ?LOGGER:start() of
<a name="692"/>  692:                                 ok -&gt;
<a name="693"/>  693:                                     Config1;
<a name="694"/>  694:                                 {error, Reason} -&gt;
<a name="695"/>  695:                                     ?P(&quot;init_per_suite -&gt; &quot;
<a name="696"/>  696:                                        &quot;Failed starting logger&quot;
<a name="697"/>  697:                                        &quot;~n   Reason: ~p&quot;
<a name="698"/>  698:                                        &quot;~n&quot;, [Reason]),
<a name="699"/>  699:                                     {skip, &quot;Failed starting logger&quot;}
<a name="700"/>  700:                             end;
<a name="701"/>  701:                         Quiet -&gt;
<a name="702"/>  702:                             case ?LOGGER:start(Quiet) of
<a name="703"/>  703:                                 ok -&gt;
<a name="704"/>  704:                                     [{esock_test_quiet, Quiet} | Config1];
<a name="705"/>  705:                                 {error, Reason} -&gt;
<a name="706"/>  706:                                     ?P(&quot;init_per_suite -&gt; &quot;
<a name="707"/>  707:                                        &quot;Failed starting logger&quot;
<a name="708"/>  708:                                        &quot;~n   Reason: ~p&quot;
<a name="709"/>  709:                                        &quot;~n&quot;, [Reason]),
<a name="710"/>  710:                                     {skip, &quot;Failed starting logger&quot;}
<a name="711"/>  711:                             end
<a name="712"/>  712:                     end
<a name="713"/>  713:             end
<a name="714"/>  714:     catch
<a name="715"/>  715:         error : notsup -&gt;
<a name="716"/>  716:             {skip, &quot;esock not supported&quot;};
<a name="717"/>  717:         error : undef -&gt;
<a name="718"/>  718:             {skip, &quot;esock not configured&quot;}
<a name="719"/>  719:     end.
<a name="720"/>  720: 
<a name="end_per_suite-1"/><a name="721"/>  721: <b>end_per_suite</b>(Config0) -&gt;
<a name="722"/>  722: 
<a name="723"/>  723:     ?P(&quot;end_per_suite -&gt; entry with&quot;
<a name="724"/>  724:        &quot;~n      Config: ~p&quot;
<a name="725"/>  725:        &quot;~n      Nodes:  ~p&quot;, [Config0, erlang:nodes()]),
<a name="726"/>  726: 
<a name="727"/>  727:     %% Stop the local monitor
<a name="728"/>  728:     kernel_test_sys_monitor:stop(),
<a name="729"/>  729: 
<a name="730"/>  730:     (catch ?LOGGER:stop()),
<a name="731"/>  731: 
<a name="732"/>  732:     Config1 = ?KLIB:end_per_suite(Config0),
<a name="733"/>  733: 
<a name="734"/>  734:     ?P(&quot;end_per_suite -&gt; &quot;
<a name="735"/>  735:        &quot;~n      Nodes: ~p&quot;, [erlang:nodes()]),
<a name="736"/>  736: 
<a name="end_per_suite-last_expr"/><a name="737"/>  737:     Config1.
<a name="738"/>  738: 
<a name="739"/>  739: 
<a name="init_per_group-2"/><a name="740"/>  740: <b>init_per_group</b>(sendfile = GroupName, Config) -&gt;
<a name="741"/>  741:     io:format(&quot;init_per_group(~w) -&gt; entry with&quot;
<a name="742"/>  742:               &quot;~n   Config: ~p&quot;
<a name="743"/>  743:               &quot;~n&quot;, [GroupName, Config]),
<a name="744"/>  744:     case socket:is_supported(sendfile) of
<a name="745"/>  745:         true -&gt;
<a name="746"/>  746:             Dir = proplists:get_value(priv_dir, Config),
<a name="747"/>  747:             HeaderSize = 1021, % I like prime numbers
<a name="748"/>  748:             DataSize = 1031,  Pow2 = 16, % About 64 MB
<a name="749"/>  749:             Header = rand:bytes(HeaderSize),
<a name="750"/>  750:             Filler = rand:bytes(DataSize),
<a name="751"/>  751:             Trailer = rand:bytes(HeaderSize),
<a name="752"/>  752:             FileName = filename:join(Dir, &quot;sendfile.bin&quot;),
<a name="753"/>  753:             file:write_file(
<a name="754"/>  754:               FileName,
<a name="755"/>  755:               [Header, double_data(Pow2, Filler), Trailer]),
<a name="756"/>  756:             N = 1 bsl Pow2,
<a name="757"/>  757:             [{sendfile_file,
<a name="758"/>  758:               {FileName,
<a name="759"/>  759:                HeaderSize + (N * DataSize) + HeaderSize,
<a name="760"/>  760:                [Header, {N, Filler}, Trailer]}}
<a name="761"/>  761:              | Config];
<a name="762"/>  762:         false -&gt;
<a name="763"/>  763:             Config
<a name="764"/>  764:     end;
<a name="765"/>  765: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="766"/>  766:     Config.
<a name="767"/>  767: 
<a name="end_per_group-2"/><a name="768"/>  768: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="769"/>  769:     Config.
<a name="770"/>  770: 
<a name="771"/>  771: 
<a name="init_per_testcase-2"/><a name="772"/>  772: <b>init_per_testcase</b>(_TC, Config) -&gt;
<a name="773"/>  773:     io:format(&quot;init_per_testcase(~w) -&gt; entry with&quot;
<a name="774"/>  774:               &quot;~n   Config: ~p&quot;
<a name="775"/>  775:               &quot;~n&quot;, [_TC, Config]),
<a name="init_per_testcase-last_expr"/><a name="776"/>  776:     Config.
<a name="777"/>  777: 
<a name="end_per_testcase-2"/><a name="778"/>  778: <b>end_per_testcase</b>(_TC, Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="779"/>  779:     Config.
<a name="780"/>  780: 
<a name="781"/>  781: 
<a name="quiet_mode-1"/><a name="782"/>  782: <b>quiet_mode</b>(Config) -&gt;
<a name="quiet_mode-last_expr"/><a name="783"/>  783: <b>    case lists:keysearch</b>(esock_test_quiet, 1, Config) of
<a name="784"/>  784:         {value, {esock_test_quiet, Quiet}} -&gt;
<a name="785"/>  785:             Quiet;
<a name="786"/>  786:         false -&gt;
<a name="787"/>  787:             case os:getenv(&quot;ESOCK_TEST_QUIET&quot;) of
<a name="788"/>  788:                 &quot;true&quot;  -&gt; true;
<a name="789"/>  789:                 &quot;false&quot; -&gt; false;
<a name="790"/>  790:                 _       -&gt; default
<a name="791"/>  791:             end
<a name="792"/>  792:     end.
<a name="793"/>  793: 
<a name="double_data-2"/><a name="794"/>  794: <b>double_data</b>(0, Data) -&gt;
<a name="795"/>  795:     Data;
<a name="796"/>  796: <b>double_data</b>(N, Data) -&gt;
<a name="double_data-last_expr"/><a name="797"/>  797: <b>    double_data</b>(N - 1, [Data, Data]).
<a name="798"/>  798: 
<a name="799"/>  799: 
<a name="800"/>  800: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="801"/>  801: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="802"/>  802: <i>%%                                                                     %%</i>
<a name="803"/>  803: <i>%%                           API MISC                                  %%</i>
<a name="804"/>  804: <i>%%                                                                     %%</i>
<a name="805"/>  805: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="806"/>  806: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="807"/>  807: 
<a name="808"/>  808: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="809"/>  809: 
<a name="810"/>  810: <i>%% This is an extremely rudimentary test case, that just tests</i>
<a name="811"/>  811: <i>%% that we can call the &quot;global&quot; info function and that it returns</i>
<a name="812"/>  812: <i>%% a non-empty map...</i>
<a name="813"/>  813: 
<a name="api_m_info-1"/><a name="814"/>  814: <b>api_m_info</b>(_Config) when is_list(_Config) -&gt;
<a name="815"/>  815:     ?TT(?SECS(5)),
<a name="api_m_info-last_expr"/><a name="816"/>  816: <b>    tc_try</b>(api_m_info,
<a name="817"/>  817:            fun() -&gt;
<a name="818"/>  818:                    ok = api_m_info()
<a name="819"/>  819:            end).
<a name="820"/>  820: 
<a name="api_m_info-0"/><a name="821"/>  821: <b>api_m_info</b>() -&gt;
<a name="api_m_info-last_expr"/><a name="822"/>  822: <b>    case socket:info</b>() of
<a name="823"/>  823:         Info when is_map(Info) -&gt;
<a name="824"/>  824:             Sz = maps:size(Info),
<a name="825"/>  825:             if
<a name="826"/>  826:                 (Sz &gt; 0) -&gt;
<a name="827"/>  827:                     ok;
<a name="828"/>  828:                 true -&gt;
<a name="829"/>  829:                     ?FAIL(no_info)
<a name="830"/>  830:             end;
<a name="831"/>  831:         Info -&gt;
<a name="832"/>  832:             ?FAIL({invalid_info, Info})
<a name="833"/>  833:     end.
<a name="834"/>  834: 
<a name="835"/>  835: 
<a name="836"/>  836: 
<a name="837"/>  837: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="838"/>  838: 
<a name="839"/>  839: <i>%% A simple test case that tests that the global debug can be changed.</i>
<a name="840"/>  840: <i>%% At the same time, it will test the info function (since it uses it</i>
<a name="841"/>  841: <i>%% for verification).</i>
<a name="842"/>  842: 
<a name="api_m_debug-1"/><a name="843"/>  843: <b>api_m_debug</b>(_Config) when is_list(_Config) -&gt;
<a name="844"/>  844:     ?TT(?SECS(5)),
<a name="api_m_debug-last_expr"/><a name="845"/>  845: <b>    tc_try</b>(api_m_debug,
<a name="846"/>  846:            fun() -&gt; has_bugfree_gcc() end,
<a name="847"/>  847:            fun() -&gt;
<a name="848"/>  848:                    ok = api_m_debug()
<a name="849"/>  849:            end).
<a name="850"/>  850: 
<a name="851"/>  851: <i>%% For some reason this test case triggers a gcc bug, which causes</i>
<a name="852"/>  852: <i>%% a segfault, on an ancient Fedora 16 VM. So, check the version of gcc...</i>
<a name="853"/>  853: <i>%% Not pretty, but the simplest way to skip (without actually testing</i>
<a name="854"/>  854: <i>%% for the host).</i>
<a name="has_bugfree_gcc-0"/><a name="855"/>  855: <b>has_bugfree_gcc</b>() -&gt;
<a name="has_bugfree_gcc-last_expr"/><a name="856"/>  856: <b>    has_bugfree_gcc</b>(os:type()).
<a name="857"/>  857: 
<a name="858"/>  858: <i>%% Make sure we are on linux</i>
<a name="has_bugfree_gcc-1"/><a name="859"/>  859: <b>has_bugfree_gcc</b>({unix, linux}) -&gt;
<a name="860"/>  860:     has_bugfree_gcc2(string:trim(os:cmd(&quot;cat /etc/issue&quot;)));
<a name="861"/>  861: <b>has_bugfree_gcc</b>(_) -&gt;
<a name="has_bugfree_gcc-last_expr"/><a name="862"/>  862:     ok.
<a name="863"/>  863: 
<a name="864"/>  864: <i>%% Make sure we are on Fedora 16</i>
<a name="has_bugfree_gcc2-1"/><a name="865"/>  865: <b>has_bugfree_gcc2</b>(&quot;Fedora release 16 &quot; ++ _) -&gt;
<a name="866"/>  866:     has_bugfree_gcc3(os:cmd(&quot;gcc --version&quot;));
<a name="867"/>  867: <b>has_bugfree_gcc2</b>(&quot;Welcome to SUSE Linux &quot; ++ _) -&gt;
<a name="868"/>  868:     has_bugfree_gcc4(os:cmd(&quot;gcc --version&quot;));
<a name="869"/>  869: <b>has_bugfree_gcc2</b>(_) -&gt;
<a name="has_bugfree_gcc2-last_expr"/><a name="870"/>  870:     ok.
<a name="871"/>  871: 
<a name="has_bugfree_gcc3-1"/><a name="872"/>  872: <b>has_bugfree_gcc3</b>(&quot;gcc (GCC) 4.6.3 20120306 (Red Hat 4.6.3-2&quot; ++ _) -&gt;
<a name="873"/>  873:     skip(&quot;Buggy GCC&quot;);
<a name="874"/>  874: <b>has_bugfree_gcc3</b>(_) -&gt;
<a name="has_bugfree_gcc3-last_expr"/><a name="875"/>  875:     ok.
<a name="876"/>  876: 
<a name="has_bugfree_gcc4-1"/><a name="877"/>  877: <b>has_bugfree_gcc4</b>(&quot;gcc (SUSE Linux) 4.3.2&quot; ++ _) -&gt;
<a name="878"/>  878:     skip(&quot;Buggy GCC&quot;);
<a name="879"/>  879: <b>has_bugfree_gcc4</b>(_) -&gt;
<a name="has_bugfree_gcc4-last_expr"/><a name="880"/>  880:     ok.
<a name="881"/>  881: 
<a name="api_m_debug-0"/><a name="882"/>  882: <b>api_m_debug</b>() -&gt;
<a name="883"/>  883:     i(&quot;get initial info&quot;),
<a name="884"/>  884:     #{debug := D0} = socket:info(),
<a name="885"/>  885:     D1 = not D0,
<a name="886"/>  886:     i(&quot;set new debug (~w =&gt; ~w)&quot;, [D0, D1]),
<a name="887"/>  887:     ok = socket:debug(D1),
<a name="888"/>  888:     i(&quot;get updated info (~w)&quot;, [D1]),
<a name="889"/>  889:     #{debug := D1} = socket:info(),
<a name="890"/>  890:     D2 = not D1,
<a name="891"/>  891:     i(&quot;set new debug (~w =&gt; ~w)&quot;, [D1, D2]),
<a name="892"/>  892:     ok = socket:debug(D2),
<a name="893"/>  893:     i(&quot;get updated info (~w)&quot;, [D2]),
<a name="894"/>  894:     #{debug := D2} = socket:info(),
<a name="895"/>  895:     i(&quot;ok&quot;),
<a name="api_m_debug-last_expr"/><a name="896"/>  896:     ok.
<a name="897"/>  897:     
<a name="898"/>  898: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="899"/>  899: 
<a name="900"/>  900: <i>%% Some tests for API misuses</i>
<a name="901"/>  901: 
<a name="902"/>  902: <b>-define</b>(
<a name="903"/>  903:    EXCEPTION(Code),
<a name="904"/>  904:    exception(fun () -&gt; begin Code end end)).
<a name="905"/>  905: 
<a name="exception-1"/><a name="906"/>  906: <b>exception</b>(Fun) -&gt;
<a name="exception-last_expr"/><a name="907"/>  907: <b>    try Fun</b>() of
<a name="908"/>  908:         Result -&gt;
<a name="909"/>  909:             error({unexpected_return, Result})
<a name="910"/>  910:     catch
<a name="911"/>  911:         Class : Reason -&gt;
<a name="912"/>  912:             {Class, Reason}
<a name="913"/>  913:     end.
<a name="914"/>  914: 
<a name="915"/>  915: 
<a name="api_m_error_open-1"/><a name="916"/>  916: <b>api_m_error_open</b>(Config) when is_list(Config) -&gt;
<a name="917"/>  917:     %%
<a name="918"/>  918:     %% open/1
<a name="919"/>  919:     {error, badarg} =
<a name="920"/>  920:         ?EXCEPTION(
<a name="921"/>  921:            socket:open(should_be_fd) ),
<a name="922"/>  922:     %%
<a name="923"/>  923:     %% open/2
<a name="924"/>  924:     {error, badarg} =
<a name="925"/>  925:         ?EXCEPTION(
<a name="926"/>  926:            socket:open(should_be_fd, #{}) ),
<a name="927"/>  927:     %%
<a name="928"/>  928:     %% A non-atom, non-integer protocol causes an exception
<a name="929"/>  929:     %% in prim_socket, whilst a non-atom, non-integer type
<a name="930"/>  930:     %% or domain causes an error return tuple from the NIF
<a name="931"/>  931:     %% code.  This is a bit inconsistent.  Should we change
<a name="932"/>  932:     %% that, if so - how, and consolidate in tests?
<a name="933"/>  933:     %%
<a name="934"/>  934:     {error,{invalid,{domain,should_be_domain}}} =
<a name="935"/>  935:         socket:open(should_be_domain, dgram),
<a name="936"/>  936:     {error,{invalid,{type,should_be_type}}} =
<a name="937"/>  937:         socket:open(inet, should_be_type),
<a name="938"/>  938:     %%
<a name="939"/>  939:     %% open/3
<a name="940"/>  940:     {error,{invalid,{domain,should_be_domain}}} =
<a name="941"/>  941:         socket:open(should_be_domain, dgram, #{}),
<a name="942"/>  942:     {error,{invalid,{type,should_be_type}}} =
<a name="943"/>  943:         socket:open(inet, should_be_type, #{}),
<a name="944"/>  944:     {error,{invalid,{protocol,should_be_protocol}}} =
<a name="945"/>  945:         socket:open(inet, dgram, should_be_protocol),
<a name="946"/>  946:     %%
<a name="947"/>  947:     %% open/4
<a name="948"/>  948:     {error,{invalid,{domain,should_be_domain}}} =
<a name="949"/>  949:         socket:open(should_be_domain, dgram, default, #{}),
<a name="950"/>  950:     {error,{invalid,{type,should_be_type}}} =
<a name="951"/>  951:         socket:open(inet, should_be_type, default, #{}),
<a name="952"/>  952:     {error,{invalid,{protocol,should_be_protocol}}} =
<a name="953"/>  953:         socket:open(inet, dgram, should_be_protocol, #{}),
<a name="api_m_error_open-last_expr"/><a name="954"/>  954:     {error, badarg} =
<a name="955"/>  955:         ?EXCEPTION(
<a name="956"/>  956:            socket:open(inet, dgram, default, should_be_options) ).
<a name="957"/>  957: 
<a name="958"/>  958: 
<a name="api_m_error_bind-1"/><a name="959"/>  959: <b>api_m_error_bind</b>(Config) when is_list(Config) -&gt;
<a name="960"/>  960:     {ok, S} = socket:open(inet, dgram),
<a name="961"/>  961:     try
<a name="962"/>  962:         %%
<a name="963"/>  963:         %% bind/2
<a name="964"/>  964:         {error, badarg} =
<a name="965"/>  965:             ?EXCEPTION(
<a name="966"/>  966:                socket:bind(should_be_socket, any) ),
<a name="967"/>  967:         {error, badarg} =
<a name="968"/>  968:             ?EXCEPTION(
<a name="969"/>  969:                socket:bind(make_ref(), any) ),
<a name="970"/>  970:         %%
<a name="971"/>  971:         %% A non-map, non-atom Addr causes an {invalid,_}
<a name="972"/>  972:         %% exception.  Should that instead be an error
<a name="973"/>  973:         %% return?
<a name="974"/>  974:         %%
<a name="975"/>  975:         {error,{invalid,{sockaddr,should_be_sockaddr}}} =
<a name="976"/>  976:             socket:bind(S, should_be_sockaddr),
<a name="977"/>  977:         EmptyMap = #{},
<a name="978"/>  978:         {error,{invalid,{sockaddr,family,EmptyMap}}} =
<a name="979"/>  979:             socket:bind(S, EmptyMap),
<a name="980"/>  980:         InvalidKey = #{family =&gt; inet, invalid_key =&gt; []},
<a name="981"/>  981:         {error,{invalid,{sockaddr,{keys,[invalid_key]},InvalidKey}}} =
<a name="982"/>  982:             socket:bind(S, InvalidKey),
<a name="983"/>  983:         InvalidFamily = #{family =&gt; invalid_family},
<a name="984"/>  984:         {error,{invalid,{sockaddr,InvalidFamily}}} =
<a name="985"/>  985:             socket:bind(S, InvalidFamily)
<a name="986"/>  986:     after
<a name="987"/>  987:         _ = socket:close(S)
<a name="988"/>  988:     end,
<a name="api_m_error_bind-last_expr"/><a name="989"/>  989:     ok.
<a name="990"/>  990: 
<a name="991"/>  991: 
<a name="992"/>  992: <i>%% XXX Lots of missing error tests here, for all other API functions...</i>
<a name="993"/>  993: 
<a name="994"/>  994: 
<a name="995"/>  995: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="996"/>  996: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="997"/>  997: <i>%%                                                                     %%</i>
<a name="998"/>  998: <i>%%                           API BASIC                                 %%</i>
<a name="999"/>  999: <i>%%                                                                     %%</i>
<a name="1000"/> 1000: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1001"/> 1001: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1002"/> 1002: 
<a name="1003"/> 1003: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1004"/> 1004: 
<a name="1005"/> 1005: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_udp4-1"/><a name="1006"/> 1006: <b>api_b_simple_open_and_close_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1007"/> 1007:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_udp4-last_expr"/><a name="1008"/> 1008: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1009"/> 1009:            fun() -&gt;
<a name="1010"/> 1010:                    InitState = #{domain   =&gt; inet,
<a name="1011"/> 1011:                                  type     =&gt; dgram,
<a name="1012"/> 1012:                                  protocol =&gt; udp},
<a name="1013"/> 1013:                    ok = api_b_simple_open_and_close(InitState)
<a name="1014"/> 1014:            end).
<a name="1015"/> 1015: 
<a name="1016"/> 1016: 
<a name="1017"/> 1017: 
<a name="1018"/> 1018: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1019"/> 1019: 
<a name="1020"/> 1020: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_udp6-1"/><a name="1021"/> 1021: <b>api_b_simple_open_and_close_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1022"/> 1022:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_udp6-last_expr"/><a name="1023"/> 1023: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1024"/> 1024:            fun() -&gt; has_support_ipv6() end,
<a name="1025"/> 1025:            fun() -&gt;
<a name="1026"/> 1026:                    InitState = #{domain   =&gt; inet6,
<a name="1027"/> 1027:                                  type     =&gt; dgram,
<a name="1028"/> 1028:                                  protocol =&gt; udp},
<a name="1029"/> 1029:                    ok = api_b_simple_open_and_close(InitState)
<a name="1030"/> 1030:            end).
<a name="1031"/> 1031: 
<a name="1032"/> 1032: 
<a name="1033"/> 1033: 
<a name="1034"/> 1034: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1035"/> 1035: 
<a name="1036"/> 1036: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_tcp4-1"/><a name="1037"/> 1037: <b>api_b_simple_open_and_close_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1038"/> 1038:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_tcp4-last_expr"/><a name="1039"/> 1039: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1040"/> 1040:            fun() -&gt;
<a name="1041"/> 1041:                    InitState = #{domain   =&gt; inet,
<a name="1042"/> 1042:                                  type     =&gt; stream,
<a name="1043"/> 1043:                                  protocol =&gt; tcp},
<a name="1044"/> 1044:                    ok = api_b_simple_open_and_close(InitState)
<a name="1045"/> 1045:            end).
<a name="1046"/> 1046: 
<a name="1047"/> 1047: 
<a name="1048"/> 1048: 
<a name="1049"/> 1049: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1050"/> 1050: 
<a name="1051"/> 1051: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_tcp6-1"/><a name="1052"/> 1052: <b>api_b_simple_open_and_close_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1053"/> 1053:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_tcp6-last_expr"/><a name="1054"/> 1054: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1055"/> 1055:            fun() -&gt; has_support_ipv6() end,
<a name="1056"/> 1056:            fun() -&gt;
<a name="1057"/> 1057:                    InitState = #{domain   =&gt; inet6,
<a name="1058"/> 1058:                                  type     =&gt; stream,
<a name="1059"/> 1059:                                  protocol =&gt; tcp},
<a name="1060"/> 1060:                    ok = api_b_simple_open_and_close(InitState)
<a name="1061"/> 1061:            end).
<a name="1062"/> 1062: 
<a name="1063"/> 1063: 
<a name="1064"/> 1064: 
<a name="1065"/> 1065: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1066"/> 1066: 
<a name="api_b_simple_open_and_close-1"/><a name="1067"/> 1067: <b>api_b_simple_open_and_close</b>(InitState) -&gt;
<a name="1068"/> 1068:     Seq = 
<a name="1069"/> 1069:         [
<a name="1070"/> 1070:          #{desc =&gt; &quot;open&quot;,
<a name="1071"/> 1071:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1072"/> 1072:                          type     := Type,
<a name="1073"/> 1073:                          protocol := Protocol} = State) -&gt; 
<a name="1074"/> 1074:                            case socket:open(Domain, Type, Protocol) of
<a name="1075"/> 1075:                                {ok, Sock} -&gt;
<a name="1076"/> 1076:                                    {ok, State#{sock =&gt; Sock}};
<a name="1077"/> 1077:                                {error, _} = ERROR -&gt;
<a name="1078"/> 1078:                                    ERROR
<a name="1079"/> 1079:                            end
<a name="1080"/> 1080:                    end},
<a name="1081"/> 1081: 
<a name="1082"/> 1082:          ?SEV_SLEEP(?SECS(1)),
<a name="1083"/> 1083: 
<a name="1084"/> 1084:          #{desc =&gt; &quot;close socket&quot;,
<a name="1085"/> 1085:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="1086"/> 1086:                            socket:close(Sock)
<a name="1087"/> 1087:                    end},
<a name="1088"/> 1088: 
<a name="1089"/> 1089:          %% *** We are done ***
<a name="1090"/> 1090:          ?SEV_FINISH_NORMAL
<a name="1091"/> 1091:         ],
<a name="1092"/> 1092:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_simple_open_and_close-last_expr"/><a name="1093"/> 1093: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1094"/> 1094: 
<a name="1095"/> 1095: 
<a name="1096"/> 1096: 
<a name="1097"/> 1097: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1098"/> 1098: 
<a name="1099"/> 1099: <i>%% Basically open (create) and info of an IPv4 UDP (dgram) socket.</i>
<a name="1100"/> 1100: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_udp4-1"/><a name="1101"/> 1101: <b>api_b_open_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1102"/> 1102:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_udp4-last_expr"/><a name="1103"/> 1103: <b>    tc_try</b>(api_b_open_and_info_udp4,
<a name="1104"/> 1104:            fun() -&gt;
<a name="1105"/> 1105:                    InitState = #{domain   =&gt; inet,
<a name="1106"/> 1106:                                  type     =&gt; dgram,
<a name="1107"/> 1107:                                  protocol =&gt; udp},
<a name="1108"/> 1108:                    ok = api_b_open_and_info(InitState)
<a name="1109"/> 1109:            end).
<a name="1110"/> 1110: 
<a name="1111"/> 1111: 
<a name="1112"/> 1112: 
<a name="1113"/> 1113: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1114"/> 1114: 
<a name="1115"/> 1115: <i>%% Basically open (create) and info of an IPv6 UDP (dgram) socket.</i>
<a name="1116"/> 1116: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_udp6-1"/><a name="1117"/> 1117: <b>api_b_open_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1118"/> 1118:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_udp6-last_expr"/><a name="1119"/> 1119: <b>    tc_try</b>(api_b_open_and_info_udp6,
<a name="1120"/> 1120:            fun() -&gt; has_support_ipv6() end,
<a name="1121"/> 1121:            fun() -&gt;
<a name="1122"/> 1122:                    InitState = #{domain   =&gt; inet6,
<a name="1123"/> 1123:                                  type     =&gt; dgram,
<a name="1124"/> 1124:                                  protocol =&gt; udp},
<a name="1125"/> 1125:                    ok = api_b_open_and_info(InitState)
<a name="1126"/> 1126:            end).
<a name="1127"/> 1127: 
<a name="1128"/> 1128: 
<a name="1129"/> 1129: 
<a name="1130"/> 1130: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1131"/> 1131: 
<a name="1132"/> 1132: <i>%% Basically open (create) and info of an IPv4 TCP (stream) socket.</i>
<a name="1133"/> 1133: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_tcp4-1"/><a name="1134"/> 1134: <b>api_b_open_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1135"/> 1135:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_tcp4-last_expr"/><a name="1136"/> 1136: <b>    tc_try</b>(api_b_open_and_info_tcp4,
<a name="1137"/> 1137:            fun() -&gt;
<a name="1138"/> 1138:                    InitState = #{domain   =&gt; inet,
<a name="1139"/> 1139:                                  type     =&gt; stream,
<a name="1140"/> 1140:                                  protocol =&gt; tcp},
<a name="1141"/> 1141:                    ok = api_b_open_and_info(InitState)
<a name="1142"/> 1142:            end).
<a name="1143"/> 1143: 
<a name="1144"/> 1144: 
<a name="1145"/> 1145: 
<a name="1146"/> 1146: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1147"/> 1147: 
<a name="1148"/> 1148: <i>%% Basically open (create) and info of an IPv6 TCP (stream) socket.</i>
<a name="1149"/> 1149: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_tcp6-1"/><a name="1150"/> 1150: <b>api_b_open_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1151"/> 1151:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_tcp6-last_expr"/><a name="1152"/> 1152: <b>    tc_try</b>(api_b_open_and_info_tcp6,
<a name="1153"/> 1153:            fun() -&gt; has_support_ipv6() end,
<a name="1154"/> 1154:            fun() -&gt;
<a name="1155"/> 1155:                    InitState = #{domain   =&gt; inet6,
<a name="1156"/> 1156:                                  type     =&gt; stream,
<a name="1157"/> 1157:                                  protocol =&gt; tcp},
<a name="1158"/> 1158:                    ok = api_b_open_and_info(InitState)
<a name="1159"/> 1159:            end).
<a name="1160"/> 1160: 
<a name="1161"/> 1161: 
<a name="1162"/> 1162: 
<a name="1163"/> 1163: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1164"/> 1164: 
<a name="api_b_open_and_info-1"/><a name="1165"/> 1165: <b>api_b_open_and_info</b>(InitState) -&gt;
<a name="1166"/> 1166:     Seq = 
<a name="1167"/> 1167:         [
<a name="1168"/> 1168:          #{desc =&gt; &quot;open&quot;,
<a name="1169"/> 1169:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1170"/> 1170:                          type     := Type,
<a name="1171"/> 1171:                          protocol := Protocol} = State) -&gt; 
<a name="1172"/> 1172:                            case socket:open(Domain, Type, Protocol) of
<a name="1173"/> 1173:                                {ok, Sock} -&gt;
<a name="1174"/> 1174:                                    {ok, State#{sock =&gt; Sock}};
<a name="1175"/> 1175:                                {error, _} = ERROR -&gt;
<a name="1176"/> 1176:                                    ERROR
<a name="1177"/> 1177:                            end
<a name="1178"/> 1178:                    end},
<a name="1179"/> 1179:          #{desc =&gt; &quot;get socket info&quot;,
<a name="1180"/> 1180:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="1181"/> 1181:                            Info = socket:info(Sock),
<a name="1182"/> 1182:                            ?SEV_IPRINT(&quot;Got (some) Info: &quot;
<a name="1183"/> 1183:                                        &quot;~n   ~p&quot;, [Info]),
<a name="1184"/> 1184:                            {ok, State#{info =&gt; Info}}
<a name="1185"/> 1185:                    end},
<a name="1186"/> 1186:          #{desc =&gt; &quot;validate socket info&quot;,
<a name="1187"/> 1187:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1188"/> 1188:                          type     := Type,
<a name="1189"/> 1189:                          protocol := Protocol,
<a name="1190"/> 1190:                          info     := #{domain        := Domain,
<a name="1191"/> 1191:                                        type          := Type,
<a name="1192"/> 1192:                                        protocol      := Protocol,
<a name="1193"/> 1193:                                        counters      := _,
<a name="1194"/> 1194:                                        num_readers   := 0,
<a name="1195"/> 1195:                                        num_writers   := 0,
<a name="1196"/> 1196:                                        num_acceptors := 0}}) -&gt;
<a name="1197"/> 1197:                            ok;
<a name="1198"/> 1198:                       (#{domain   := Domain,
<a name="1199"/> 1199:                          type     := Type,
<a name="1200"/> 1200:                          protocol := Protocol,
<a name="1201"/> 1201:                          info     := Info}) -&gt;
<a name="1202"/> 1202:                            ?SEV_EPRINT(&quot;Unexpected Info: &quot;
<a name="1203"/> 1203:                                        &quot;~n   (expected) Domain:   ~p&quot;
<a name="1204"/> 1204:                                        &quot;~n   (expected) Type:     ~p&quot;
<a name="1205"/> 1205:                                        &quot;~n   (expected) Protocol: ~p&quot;
<a name="1206"/> 1206:                                        &quot;~n   ~p&quot;,
<a name="1207"/> 1207:                                        [Domain, Type, Protocol, Info]),
<a name="1208"/> 1208:                            {error, unexpected_infio}
<a name="1209"/> 1209:                    end},
<a name="1210"/> 1210:          #{desc =&gt; &quot;close socket&quot;,
<a name="1211"/> 1211:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="1212"/> 1212:                            socket:close(Sock)
<a name="1213"/> 1213:                    end},
<a name="1214"/> 1214: 
<a name="1215"/> 1215:          %% *** We are done ***
<a name="1216"/> 1216:          ?SEV_FINISH_NORMAL
<a name="1217"/> 1217:         ],
<a name="1218"/> 1218:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_open_and_info-last_expr"/><a name="1219"/> 1219: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1220"/> 1220: 
<a name="1221"/> 1221: 
<a name="1222"/> 1222: 
<a name="1223"/> 1223: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1224"/> 1224: 
<a name="1225"/> 1225: <i>%% Basically open (create) and close an IPv4 UDP (dgram) socket.</i>
<a name="1226"/> 1226: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udp4-1"/><a name="1227"/> 1227: <b>api_b_open_and_close_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1228"/> 1228:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udp4-last_expr"/><a name="1229"/> 1229: <b>    tc_try</b>(api_b_open_and_close_udp4,
<a name="1230"/> 1230:            fun() -&gt;
<a name="1231"/> 1231:                    InitState = #{domain   =&gt; inet,
<a name="1232"/> 1232:                                  type     =&gt; dgram,
<a name="1233"/> 1233:                                  protocol =&gt; udp},
<a name="1234"/> 1234:                    ok = api_b_open_and_close(InitState)
<a name="1235"/> 1235:            end).
<a name="1236"/> 1236: 
<a name="1237"/> 1237: 
<a name="1238"/> 1238: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1239"/> 1239: 
<a name="1240"/> 1240: <i>%% Basically open (create) and close an IPv6 UDP (dgram) socket.</i>
<a name="1241"/> 1241: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udp6-1"/><a name="1242"/> 1242: <b>api_b_open_and_close_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1243"/> 1243:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udp6-last_expr"/><a name="1244"/> 1244: <b>    tc_try</b>(api_b_open_and_close_udp6,
<a name="1245"/> 1245:            fun() -&gt; has_support_ipv6() end,
<a name="1246"/> 1246:            fun() -&gt;
<a name="1247"/> 1247:                    InitState = #{domain   =&gt; inet6,
<a name="1248"/> 1248:                                  type     =&gt; dgram,
<a name="1249"/> 1249:                                  protocol =&gt; udp},
<a name="1250"/> 1250:                    ok = api_b_open_and_close(InitState)
<a name="1251"/> 1251:            end).
<a name="1252"/> 1252: 
<a name="1253"/> 1253: 
<a name="1254"/> 1254: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1255"/> 1255: 
<a name="1256"/> 1256: <i>%% Basically open (create) and close an IPv4 TCP (stream) socket.</i>
<a name="1257"/> 1257: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcp4-1"/><a name="1258"/> 1258: <b>api_b_open_and_close_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1259"/> 1259:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcp4-last_expr"/><a name="1260"/> 1260: <b>    tc_try</b>(api_b_open_and_close_tcp4,
<a name="1261"/> 1261:            fun() -&gt;
<a name="1262"/> 1262:                    InitState = #{domain   =&gt; inet,
<a name="1263"/> 1263:                                  type     =&gt; stream,
<a name="1264"/> 1264:                                  protocol =&gt; tcp},
<a name="1265"/> 1265:                    ok = api_b_open_and_close(InitState)
<a name="1266"/> 1266:            end).
<a name="1267"/> 1267: 
<a name="1268"/> 1268: 
<a name="1269"/> 1269: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1270"/> 1270: 
<a name="1271"/> 1271: <i>%% Basically open (create) and close an IPv6 TCP (stream) socket.</i>
<a name="1272"/> 1272: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcp6-1"/><a name="1273"/> 1273: <b>api_b_open_and_close_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1274"/> 1274:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcp6-last_expr"/><a name="1275"/> 1275: <b>    tc_try</b>(api_b_open_and_close_tcp6,
<a name="1276"/> 1276:            fun() -&gt; has_support_ipv6() end,
<a name="1277"/> 1277:            fun() -&gt;
<a name="1278"/> 1278:                    InitState = #{domain   =&gt; inet,
<a name="1279"/> 1279:                                  type     =&gt; stream,
<a name="1280"/> 1280:                                  protocol =&gt; tcp},
<a name="1281"/> 1281:                    ok = api_b_open_and_close(InitState)
<a name="1282"/> 1282:            end).
<a name="1283"/> 1283: 
<a name="1284"/> 1284: 
<a name="1285"/> 1285: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1286"/> 1286: 
<a name="1287"/> 1287: <i>%% Basically open (create) and close an Unix Domain dgram (UDP) socket.</i>
<a name="1288"/> 1288: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udpL-1"/><a name="1289"/> 1289: <b>api_b_open_and_close_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1290"/> 1290:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udpL-last_expr"/><a name="1291"/> 1291: <b>    tc_try</b>(api_b_open_and_close_udpL,
<a name="1292"/> 1292:            fun() -&gt;
<a name="1293"/> 1293: 		   has_support_unix_domain_socket(),
<a name="1294"/> 1294: 		   is_not_windows()
<a name="1295"/> 1295: 	   end,
<a name="1296"/> 1296:            fun() -&gt;
<a name="1297"/> 1297:                    InitState = #{domain   =&gt; local,
<a name="1298"/> 1298:                                  type     =&gt; dgram,
<a name="1299"/> 1299:                                  protocol =&gt; default},
<a name="1300"/> 1300:                    ok = api_b_open_and_close(InitState)
<a name="1301"/> 1301:            end).
<a name="1302"/> 1302: 
<a name="1303"/> 1303: 
<a name="1304"/> 1304: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1305"/> 1305: 
<a name="1306"/> 1306: <i>%% Basically open (create) and close an Unix Domain stream (TCP) socket.</i>
<a name="1307"/> 1307: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcpL-1"/><a name="1308"/> 1308: <b>api_b_open_and_close_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1309"/> 1309:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcpL-last_expr"/><a name="1310"/> 1310: <b>    tc_try</b>(api_b_open_and_close_tcpL,
<a name="1311"/> 1311:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="1312"/> 1312:            fun() -&gt;
<a name="1313"/> 1313:                    InitState = #{domain   =&gt; local,
<a name="1314"/> 1314:                                  type     =&gt; stream,
<a name="1315"/> 1315:                                  protocol =&gt; default},
<a name="1316"/> 1316:                    ok = api_b_open_and_close(InitState)
<a name="1317"/> 1317:            end).
<a name="1318"/> 1318: 
<a name="1319"/> 1319: 
<a name="1320"/> 1320: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1321"/> 1321: 
<a name="1322"/> 1322: <i>%% Basically open (create) and close an Unix Domain dgram (UDP) socket.</i>
<a name="1323"/> 1323: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_seqpL-1"/><a name="1324"/> 1324: <b>api_b_open_and_close_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1325"/> 1325:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_seqpL-last_expr"/><a name="1326"/> 1326: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1327"/> 1327:            fun() -&gt;
<a name="1328"/> 1328: 		   has_support_unix_domain_socket(),
<a name="1329"/> 1329:                    is_not_windows()
<a name="1330"/> 1330: 	   end,
<a name="1331"/> 1331:            fun() -&gt;
<a name="1332"/> 1332:                    InitState = #{domain   =&gt; local,
<a name="1333"/> 1333:                                  type     =&gt; seqpacket,
<a name="1334"/> 1334:                                  protocol =&gt; default},
<a name="1335"/> 1335:                    ok = api_b_open_and_close(InitState)
<a name="1336"/> 1336:            end).
<a name="1337"/> 1337: 
<a name="1338"/> 1338: 
<a name="1339"/> 1339: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1340"/> 1340: 
<a name="1341"/> 1341: <i>%% Basically open (create) and close an IPv4 SCTP (seqpacket) socket.</i>
<a name="1342"/> 1342: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_seqp_sctp4-1"/><a name="1343"/> 1343: <b>api_b_open_and_close_seqp_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1344"/> 1344:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_seqp_sctp4-last_expr"/><a name="1345"/> 1345: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1346"/> 1346:            fun() -&gt; has_support_sctp() end,
<a name="1347"/> 1347:            fun() -&gt;
<a name="1348"/> 1348:                    InitState = #{domain   =&gt; inet,
<a name="1349"/> 1349:                                  type     =&gt; seqpacket,
<a name="1350"/> 1350:                                  protocol =&gt; sctp},
<a name="1351"/> 1351:                    ok = api_b_open_and_close(InitState)
<a name="1352"/> 1352:            end).
<a name="1353"/> 1353: 
<a name="1354"/> 1354: 
<a name="1355"/> 1355: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1356"/> 1356: 
<a name="1357"/> 1357: <i>%% Basically open (create) and close an IPv6 SCTP (seqpacket) socket.</i>
<a name="1358"/> 1358: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_seqp_sctp6-1"/><a name="1359"/> 1359: <b>api_b_open_and_close_seqp_sctp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1360"/> 1360:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_seqp_sctp6-last_expr"/><a name="1361"/> 1361: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1362"/> 1362:            fun() -&gt;
<a name="1363"/> 1363:                    has_support_sctp(),
<a name="1364"/> 1364:                    has_support_ipv6()
<a name="1365"/> 1365:            end,
<a name="1366"/> 1366:            fun() -&gt;
<a name="1367"/> 1367:                    InitState = #{domain   =&gt; inet6,
<a name="1368"/> 1368:                                  type     =&gt; seqpacket,
<a name="1369"/> 1369:                                  protocol =&gt; sctp},
<a name="1370"/> 1370:                    ok = api_b_open_and_close(InitState)
<a name="1371"/> 1371:            end).
<a name="1372"/> 1372: 
<a name="1373"/> 1373: 
<a name="1374"/> 1374: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1375"/> 1375: 
<a name="1376"/> 1376: <i>%% Basically open (create) and close an IPv4 SCTP (stream) socket.</i>
<a name="1377"/> 1377: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_stream_sctp4-1"/><a name="1378"/> 1378: <b>api_b_open_and_close_stream_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1379"/> 1379:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_stream_sctp4-last_expr"/><a name="1380"/> 1380: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1381"/> 1381:            fun() -&gt; has_support_sctp() end,
<a name="1382"/> 1382:            fun() -&gt;
<a name="1383"/> 1383:                    InitState = #{domain   =&gt; inet,
<a name="1384"/> 1384:                                  type     =&gt; stream,
<a name="1385"/> 1385:                                  protocol =&gt; sctp},
<a name="1386"/> 1386:                    ok = api_b_open_and_close(InitState)
<a name="1387"/> 1387:            end).
<a name="1388"/> 1388: 
<a name="1389"/> 1389: 
<a name="1390"/> 1390: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1391"/> 1391: 
<a name="1392"/> 1392: <i>%% Basically open (create) and close an IPv6 SCTP (stream) socket.</i>
<a name="1393"/> 1393: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_stream_sctp6-1"/><a name="1394"/> 1394: <b>api_b_open_and_close_stream_sctp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1395"/> 1395:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_stream_sctp6-last_expr"/><a name="1396"/> 1396: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1397"/> 1397:            fun() -&gt;
<a name="1398"/> 1398:                    has_support_sctp(),
<a name="1399"/> 1399:                    has_support_ipv6()
<a name="1400"/> 1400:            end,
<a name="1401"/> 1401:            fun() -&gt;
<a name="1402"/> 1402:                    InitState = #{domain   =&gt; inet6,
<a name="1403"/> 1403:                                  type     =&gt; stream,
<a name="1404"/> 1404:                                  protocol =&gt; sctp},
<a name="1405"/> 1405:                    ok = api_b_open_and_close(InitState)
<a name="1406"/> 1406:            end).
<a name="1407"/> 1407: 
<a name="1408"/> 1408: 
<a name="1409"/> 1409: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1410"/> 1410: 
<a name="api_b_open_and_close-1"/><a name="1411"/> 1411: <b>api_b_open_and_close</b>(InitState) -&gt;
<a name="1412"/> 1412:     Seq = 
<a name="1413"/> 1413:         [
<a name="1414"/> 1414:          #{desc =&gt; &quot;open&quot;,
<a name="1415"/> 1415:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1416"/> 1416:                          type     := Type,
<a name="1417"/> 1417:                          protocol := Protocol} = S) -&gt; 
<a name="1418"/> 1418:                            Res = socket:open(Domain, Type, Protocol), 
<a name="1419"/> 1419:                            {ok, {S, Res}} 
<a name="1420"/> 1420:                    end},
<a name="1421"/> 1421:          #{desc =&gt; &quot;validate open&quot;,
<a name="1422"/> 1422:            cmd  =&gt; fun({S, {ok, Sock}}) -&gt; 
<a name="1423"/> 1423:                            NewS = S#{socket =&gt; Sock},
<a name="1424"/> 1424:                            {ok, NewS};
<a name="1425"/> 1425:                       ({_, {error, epfnosupport = Reason}}) -&gt;
<a name="1426"/> 1426:                            {skip, Reason};
<a name="1427"/> 1427:                       ({_, {error, eprotonosupport = Reason}}) -&gt;
<a name="1428"/> 1428:                            {skip, Reason};
<a name="1429"/> 1429:                       ({_, {error, esocktnosupport = Reason}}) -&gt;
<a name="1430"/> 1430:                            {skip, Reason};
<a name="1431"/> 1431:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1432"/> 1432:                            ERROR
<a name="1433"/> 1433:                    end},
<a name="1434"/> 1434:          #{desc =&gt; &quot;get domain (maybe)&quot;,
<a name="1435"/> 1435:            cmd  =&gt; fun(#{socket := Sock} = S) -&gt;
<a name="1436"/> 1436:                            Res = socket:getopt(Sock, socket, domain),
<a name="1437"/> 1437:                            {ok, {S, Res}}
<a name="1438"/> 1438:                    end},
<a name="1439"/> 1439:          #{desc =&gt; &quot;validate domain (maybe)&quot;,
<a name="1440"/> 1440:            cmd  =&gt; fun({#{domain := Domain} = S, {ok, Domain}}) -&gt; 
<a name="1441"/> 1441:                            ?SEV_IPRINT(&quot;expected domain: ~p&quot;, [Domain]),
<a name="1442"/> 1442:                            {ok, S};
<a name="1443"/> 1443:                       ({#{domain := ExpDomain}, {ok, Domain}}) -&gt;
<a name="1444"/> 1444:                            {error, {unexpected_domain, ExpDomain, Domain}};
<a name="1445"/> 1445:                       %% Some platforms do not support this option
<a name="1446"/> 1446:                       ({S, {error, {invalid, _}} = ERROR}) -&gt;
<a name="1447"/> 1447:                            case
<a name="1448"/> 1448:                                socket:is_supported(options, socket, domain)
<a name="1449"/> 1449:                            of
<a name="1450"/> 1450:                                true -&gt;
<a name="1451"/> 1451:                                    ERROR;
<a name="1452"/> 1452:                                false -&gt;
<a name="1453"/> 1453:                                    ?SEV_IPRINT(&quot;socket option 'domain' &quot;
<a name="1454"/> 1454:                                                &quot;not supported&quot;),
<a name="1455"/> 1455:                                    {ok, S}
<a name="1456"/> 1456:                            end;
<a name="1457"/> 1457:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1458"/> 1458:                            ERROR
<a name="1459"/> 1459:                    end},
<a name="1460"/> 1460:          #{desc =&gt; &quot;get type&quot;,
<a name="1461"/> 1461:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1462"/> 1462:                            Res = socket:getopt(Sock, socket, type), 
<a name="1463"/> 1463:                            {ok, {State, Res}}
<a name="1464"/> 1464:                    end},
<a name="1465"/> 1465:          #{desc =&gt; &quot;validate type&quot;,
<a name="1466"/> 1466:            cmd  =&gt; fun({#{type := Type} = State, {ok, Type}}) -&gt;
<a name="1467"/> 1467:                            ?SEV_IPRINT(&quot;expected type: ~p&quot;, [Type]),
<a name="1468"/> 1468:                            {ok, State};
<a name="1469"/> 1469:                       ({#{type := ExpType}, {ok, Type}}) -&gt;
<a name="1470"/> 1470:                            {error, {unexpected_type, ExpType, Type}};
<a name="1471"/> 1471:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1472"/> 1472:                            ERROR
<a name="1473"/> 1473:                    end},
<a name="1474"/> 1474:          #{desc =&gt; &quot;get protocol (maybe)&quot;,
<a name="1475"/> 1475:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1476"/> 1476:                            Res = socket:getopt(Sock, socket, protocol),
<a name="1477"/> 1477:                            {ok, {State, Res}}
<a name="1478"/> 1478:                    end},
<a name="1479"/> 1479:          #{desc =&gt; &quot;validate protocol&quot;,
<a name="1480"/> 1480:            cmd  =&gt; fun({#{protocol := Protocol} = State, {ok, Protocol}}) -&gt;
<a name="1481"/> 1481:                            ?SEV_IPRINT(&quot;expected protocol: ~p&quot;, [Protocol]),
<a name="1482"/> 1482:                            {ok, State};
<a name="1483"/> 1483:                       ({#{domain   := Domain,
<a name="1484"/> 1484: 			  protocol := ExpProtocol}, {ok, Protocol}}) -&gt;
<a name="1485"/> 1485: 			   %% On OpenBSD (at least 6.6) something screwy happens
<a name="1486"/> 1486: 			   %% when domain = local.
<a name="1487"/> 1487: 			   %% It will report a completely different protocol
<a name="1488"/> 1488: 			   %% (icmp) but everything still works.
<a name="1489"/> 1489:                            %% So we skip if this happens on OpenBSD...
<a name="1490"/> 1490: 			   case os:type() of
<a name="1491"/> 1491: 			       {unix, openbsd} when (Domain =:= local) -&gt;
<a name="1492"/> 1492: 				   {skip, ?F(&quot;Unexpected protocol: ~p instead of ~p&quot;,
<a name="1493"/> 1493: 					     [Protocol, ExpProtocol])};
<a name="1494"/> 1494: 			       _ -&gt;
<a name="1495"/> 1495: 				   {error, {unexpected_protocol,
<a name="1496"/> 1496: 					    ExpProtocol, Protocol}}
<a name="1497"/> 1497: 			   end;
<a name="1498"/> 1498:                       %% Some platforms do not support this option
<a name="1499"/> 1499:                       ({State, {error, {invalid, _}} = ERROR}) -&gt;
<a name="1500"/> 1500: 			   case socket:is_supported(options, socket, protocol) of
<a name="1501"/> 1501: 			       true -&gt;
<a name="1502"/> 1502:                                    ERROR;
<a name="1503"/> 1503: 			       false -&gt;
<a name="1504"/> 1504:                                    ?SEV_IPRINT(&quot;socket option 'protocol' &quot;
<a name="1505"/> 1505:                                                &quot;not supported&quot;),
<a name="1506"/> 1506:                                    {ok, State}
<a name="1507"/> 1507: 			   end;
<a name="1508"/> 1508:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1509"/> 1509:                            ERROR
<a name="1510"/> 1510:                    end},
<a name="1511"/> 1511:          #{desc =&gt; &quot;get controlling-process&quot;,
<a name="1512"/> 1512:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1513"/> 1513:                            Res = socket:getopt(Sock, otp, controlling_process),
<a name="1514"/> 1514:                            {ok, {State, Res}}
<a name="1515"/> 1515:                    end},
<a name="1516"/> 1516:          #{desc =&gt; &quot;validate controlling-process&quot;,
<a name="1517"/> 1517:            cmd  =&gt; fun({State, {ok, Pid}}) -&gt;
<a name="1518"/> 1518:                            case self() of
<a name="1519"/> 1519:                                Pid -&gt;
<a name="1520"/> 1520:                                    {ok, State};
<a name="1521"/> 1521:                                _ -&gt;
<a name="1522"/> 1522:                                    {error, {unexpected_owner, Pid}}
<a name="1523"/> 1523:                            end;
<a name="1524"/> 1524:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1525"/> 1525:                            ERROR
<a name="1526"/> 1526:                    end},
<a name="1527"/> 1527:          #{desc =&gt; &quot;close socket&quot;,
<a name="1528"/> 1528:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1529"/> 1529:                            Res = socket:close(Sock),
<a name="1530"/> 1530:                            {ok, {State, Res}}
<a name="1531"/> 1531:                    end},
<a name="1532"/> 1532:          #{desc =&gt; &quot;validate socket close&quot;,
<a name="1533"/> 1533:            cmd  =&gt; fun({_, ok}) -&gt;
<a name="1534"/> 1534:                            ok;
<a name="1535"/> 1535:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1536"/> 1536:                            ERROR
<a name="1537"/> 1537:                    end},
<a name="1538"/> 1538: 
<a name="1539"/> 1539:          %% *** We are done ***
<a name="1540"/> 1540:          ?SEV_FINISH_NORMAL
<a name="1541"/> 1541:         ],
<a name="1542"/> 1542:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_open_and_close-last_expr"/><a name="1543"/> 1543: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1544"/> 1544: 
<a name="1545"/> 1545: 
<a name="1546"/> 1546: 
<a name="1547"/> 1547: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1548"/> 1548: 
<a name="1549"/> 1549: <i>%% Basically open (create) and (maybe) close an RAW socket.</i>
<a name="1550"/> 1550: 
<a name="api_b_open_and_maybe_close_raw-1"/><a name="1551"/> 1551: <b>api_b_open_and_maybe_close_raw</b>(_Config) when is_list(_Config) -&gt;
<a name="1552"/> 1552:     ?TT(?SECS(5)),
<a name="api_b_open_and_maybe_close_raw-last_expr"/><a name="1553"/> 1553: <b>    tc_try</b>(api_b_open_and_maybe_close_raw,
<a name="1554"/> 1554:            fun() -&gt;
<a name="1555"/> 1555:                    InitState = #{domain   =&gt; inet,
<a name="1556"/> 1556:                                  type     =&gt; raw,
<a name="1557"/> 1557:                                  protocol =&gt; {raw, 255}},
<a name="1558"/> 1558:                    ok = do_api_b_open_and_maybe_close_raw(InitState)
<a name="1559"/> 1559:            end).
<a name="1560"/> 1560: 
<a name="do_api_b_open_and_maybe_close_raw-1"/><a name="1561"/> 1561: <b>do_api_b_open_and_maybe_close_raw</b>(InitState) -&gt;
<a name="1562"/> 1562:     Tester = 
<a name="1563"/> 1563:         [
<a name="1564"/> 1564:          #{desc =&gt; &quot;open&quot;,
<a name="1565"/> 1565:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1566"/> 1566:                          type     := Type,
<a name="1567"/> 1567:                          protocol := Protocol} = State) -&gt; 
<a name="1568"/> 1568:                            ?SEV_IPRINT(&quot;try open with:&quot;
<a name="1569"/> 1569:                                        &quot;~n   Domain:   ~p&quot;
<a name="1570"/> 1570:                                        &quot;~n   Type:     ~p&quot;
<a name="1571"/> 1571:                                        &quot;~n   Protocol: ~p&quot;,
<a name="1572"/> 1572:                                        [Domain, Type, Protocol]),
<a name="1573"/> 1573:                            case socket:open(Domain, Type, Protocol) of
<a name="1574"/> 1574:                                {ok, Sock} -&gt;
<a name="1575"/> 1575:                                    {ok, State#{sock =&gt; Sock}};
<a name="1576"/> 1576:                                {error, Reason} when (Reason =:= eperm) orelse
<a name="1577"/> 1577:                                                     (Reason =:= eacces) -&gt;
<a name="1578"/> 1578:                                    ?SEV_IPRINT(&quot;not allowed (~w) =&gt; SKIP&quot;,
<a name="1579"/> 1579:                                                [Reason]),
<a name="1580"/> 1580:                                    {skip, Reason};
<a name="1581"/> 1581:                                {error, Reason} = ERROR -&gt;
<a name="1582"/> 1582:                                    ?SEV_EPRINT(&quot;open failed:&quot;
<a name="1583"/> 1583:                                                &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="1584"/> 1584:                                    ERROR
<a name="1585"/> 1585:                            end
<a name="1586"/> 1586:                    end},
<a name="1587"/> 1587:          #{desc =&gt; &quot;close socket&quot;,
<a name="1588"/> 1588:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1589"/> 1589:                            ?SEV_IPRINT(&quot;try socket close&quot;),
<a name="1590"/> 1590:                            case socket:close(Sock) of
<a name="1591"/> 1591:                                ok -&gt;
<a name="1592"/> 1592:                                    ?SEV_IPRINT(&quot;socket closed&quot;),
<a name="1593"/> 1593:                                    {ok, maps:remote(sock, State)};
<a name="1594"/> 1594:                                {error, Reason} = ERROR -&gt;
<a name="1595"/> 1595:                                    ?SEV_EPRINT(&quot;close failed:&quot;
<a name="1596"/> 1596:                                                &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="1597"/> 1597:                                    ERROR
<a name="1598"/> 1598:                            end
<a name="1599"/> 1599:                    end},
<a name="1600"/> 1600: 
<a name="1601"/> 1601:          %% *** We are done ***
<a name="1602"/> 1602:          ?SEV_FINISH_NORMAL
<a name="1603"/> 1603:         ],
<a name="1604"/> 1604:     Evaluator = ?SEV_START(&quot;tester&quot;, Tester, InitState),
<a name="do_api_b_open_and_maybe_close_raw-last_expr"/><a name="1605"/> 1605: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1606"/> 1606: 
<a name="1607"/> 1607: 
<a name="1608"/> 1608: 
<a name="1609"/> 1609: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1610"/> 1610: 
<a name="1611"/> 1611: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="1612"/> 1612: <i>%% sendto and recvfrom..</i>
<a name="api_b_sendto_and_recvfrom_udp4-1"/><a name="1613"/> 1613: <b>api_b_sendto_and_recvfrom_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1614"/> 1614:     ?TT(?SECS(5)),
<a name="api_b_sendto_and_recvfrom_udp4-last_expr"/><a name="1615"/> 1615: <b>    tc_try</b>(api_b_sendto_and_recvfrom_udp4,
<a name="1616"/> 1616:            fun() -&gt; has_support_ipv4() end,
<a name="1617"/> 1617:            fun() -&gt;
<a name="1618"/> 1618:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="1619"/> 1619:                                   socket:sendto(Sock, Data, Dest)
<a name="1620"/> 1620:                           end,
<a name="1621"/> 1621:                    Recv = fun(Sock) -&gt;
<a name="1622"/> 1622:                                   socket:recvfrom(Sock)
<a name="1623"/> 1623:                           end,
<a name="1624"/> 1624:                    InitState = #{domain =&gt; inet,
<a name="1625"/> 1625:                                  proto  =&gt; udp,
<a name="1626"/> 1626:                                  send   =&gt; Send,
<a name="1627"/> 1627:                                  recv   =&gt; Recv},
<a name="1628"/> 1628:                    ok = api_b_send_and_recv_udp(InitState)
<a name="1629"/> 1629:            end).
<a name="1630"/> 1630: 
<a name="1631"/> 1631: 
<a name="1632"/> 1632: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1633"/> 1633: 
<a name="1634"/> 1634: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="1635"/> 1635: <i>%% sendto and recvfrom.</i>
<a name="api_b_sendto_and_recvfrom_udpL-1"/><a name="1636"/> 1636: <b>api_b_sendto_and_recvfrom_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1637"/> 1637:     ?TT(?SECS(5)),
<a name="api_b_sendto_and_recvfrom_udpL-last_expr"/><a name="1638"/> 1638: <b>    tc_try</b>(api_b_sendto_and_recvfrom_udpL,
<a name="1639"/> 1639:            fun() -&gt;
<a name="1640"/> 1640:                    has_support_unix_domain_socket(),
<a name="1641"/> 1641: 		   is_not_windows(),
<a name="1642"/> 1642:                    unix_domain_socket_host_cond()
<a name="1643"/> 1643:            end,
<a name="1644"/> 1644:            fun() -&gt;
<a name="1645"/> 1645:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="1646"/> 1646:                                   socket:sendto(Sock, Data, Dest)
<a name="1647"/> 1647:                           end,
<a name="1648"/> 1648:                    Recv = fun(Sock) -&gt;
<a name="1649"/> 1649:                                   socket:recvfrom(Sock)
<a name="1650"/> 1650:                           end,
<a name="1651"/> 1651:                    InitState = #{domain =&gt; local,
<a name="1652"/> 1652:                                  proto  =&gt; default,
<a name="1653"/> 1653:                                  send   =&gt; Send,
<a name="1654"/> 1654:                                  recv   =&gt; Recv},
<a name="1655"/> 1655:                    ok = api_b_send_and_recv_udp(InitState)
<a name="1656"/> 1656:            end).
<a name="1657"/> 1657: 
<a name="1658"/> 1658: 
<a name="1659"/> 1659: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1660"/> 1660: 
<a name="1661"/> 1661: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket</i>
<a name="1662"/> 1662: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_udp4-1"/><a name="1663"/> 1663: <b>api_b_sendmsg_and_recvmsg_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1664"/> 1664:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_udp4-last_expr"/><a name="1665"/> 1665: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_udp4,
<a name="1666"/> 1666:            fun() -&gt; has_support_ipv4() end,
<a name="1667"/> 1667:            fun() -&gt;
<a name="1668"/> 1668:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="1669"/> 1669:                                   %% We need tests for this,
<a name="1670"/> 1670:                                   %% but this is not the place it.
<a name="1671"/> 1671:                                   %% CMsg  = #{level =&gt; ip,
<a name="1672"/> 1672:                                   %%              type  =&gt; tos,
<a name="1673"/> 1673:                                   %%              data  =&gt; reliability},
<a name="1674"/> 1674:                                   %% CMsgs = [CMsg],
<a name="1675"/> 1675:                                   Msg = #{addr =&gt; Dest,
<a name="1676"/> 1676:                                              %% ctrl =&gt; CMsgs,
<a name="1677"/> 1677:                                              iov  =&gt; [Data]},
<a name="1678"/> 1678:                                   socket:sendmsg(Sock, Msg)
<a name="1679"/> 1679:                           end,
<a name="1680"/> 1680:                    Recv = fun(Sock) -&gt;
<a name="1681"/> 1681:                                   %% We have some issues on old darwin...
<a name="1682"/> 1682:                                   %% ok = socket:setopt(Sock, {otp,debug}, true),
<a name="1683"/> 1683:                                   case socket:recvmsg(Sock) of
<a name="1684"/> 1684:                                       {ok, #{addr  := Source,
<a name="1685"/> 1685:                                              iov   := [Data]}} -&gt;
<a name="1686"/> 1686:                                           %% socket:setopt(Sock, otp, debug, false),
<a name="1687"/> 1687:                                           {ok, {Source, Data}};
<a name="1688"/> 1688:                                       {error, _} = ERROR -&gt;
<a name="1689"/> 1689:                                           ERROR
<a name="1690"/> 1690:                                   end
<a name="1691"/> 1691:                           end,
<a name="1692"/> 1692:                    InitState = #{domain =&gt; inet,
<a name="1693"/> 1693:                                  proto  =&gt; udp,
<a name="1694"/> 1694:                                  send   =&gt; Send,
<a name="1695"/> 1695:                                  recv   =&gt; Recv},
<a name="1696"/> 1696:                    ok = api_b_send_and_recv_udp(InitState)
<a name="1697"/> 1697:            end).
<a name="1698"/> 1698: 
<a name="1699"/> 1699: 
<a name="1700"/> 1700: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1701"/> 1701: 
<a name="1702"/> 1702: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket</i>
<a name="1703"/> 1703: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_udpL-1"/><a name="1704"/> 1704: <b>api_b_sendmsg_and_recvmsg_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1705"/> 1705:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_udpL-last_expr"/><a name="1706"/> 1706: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_udpL,
<a name="1707"/> 1707:            fun() -&gt;
<a name="1708"/> 1708:                    has_support_unix_domain_socket(),
<a name="1709"/> 1709: 		   is_not_windows(),
<a name="1710"/> 1710:                    unix_domain_socket_host_cond()
<a name="1711"/> 1711:            end,
<a name="1712"/> 1712:            fun() -&gt;
<a name="1713"/> 1713:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="1714"/> 1714:                                   %% We need tests for this,
<a name="1715"/> 1715:                                   %% but this is not the place it.
<a name="1716"/> 1716:                                   %% CMsg  = #{level =&gt; ip,
<a name="1717"/> 1717:                                   %%              type  =&gt; tos,
<a name="1718"/> 1718:                                   %%              data  =&gt; reliability},
<a name="1719"/> 1719:                                   %% CMsgs = [CMsg],
<a name="1720"/> 1720:                                   Msg = #{addr =&gt; Dest,
<a name="1721"/> 1721:                                              %% ctrl =&gt; CMsgs,
<a name="1722"/> 1722:                                              iov  =&gt; [Data]},
<a name="1723"/> 1723:                                   socket:sendmsg(Sock, Msg)
<a name="1724"/> 1724:                           end,
<a name="1725"/> 1725:                    Recv = fun(Sock) -&gt;
<a name="1726"/> 1726:                                   %% We have some issues on old darwing...
<a name="1727"/> 1727:                                   %% socket:setopt(Sock, otp, debug, true),
<a name="1728"/> 1728:                                   case socket:recvmsg(Sock) of
<a name="1729"/> 1729:                                       {ok, #{addr  := Source,
<a name="1730"/> 1730:                                              iov   := [Data]}} -&gt;
<a name="1731"/> 1731:                                           %% socket:setopt(Sock, otp, debug, false),
<a name="1732"/> 1732:                                           {ok, {Source, Data}};
<a name="1733"/> 1733:                                       {error, _} = ERROR -&gt;
<a name="1734"/> 1734:                                           ERROR
<a name="1735"/> 1735:                                   end
<a name="1736"/> 1736:                           end,
<a name="1737"/> 1737:                    InitState = #{domain =&gt; local,
<a name="1738"/> 1738:                                  proto  =&gt; default,
<a name="1739"/> 1739:                                  send   =&gt; Send,
<a name="1740"/> 1740:                                  recv   =&gt; Recv},
<a name="1741"/> 1741:                    ok = api_b_send_and_recv_udp(InitState)
<a name="1742"/> 1742:            end).
<a name="1743"/> 1743: 
<a name="1744"/> 1744: 
<a name="1745"/> 1745: 
<a name="1746"/> 1746: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1747"/> 1747: 
<a name="api_b_send_and_recv_udp-1"/><a name="1748"/> 1748: <b>api_b_send_and_recv_udp</b>(InitState) -&gt;
<a name="1749"/> 1749:     Seq = 
<a name="1750"/> 1750:         [
<a name="1751"/> 1751:          #{desc =&gt; &quot;local address&quot;,
<a name="1752"/> 1752:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="1753"/> 1753:                            LSASrc = which_local_socket_addr(Domain),
<a name="1754"/> 1754:                            LSADst = which_local_socket_addr(Domain),
<a name="1755"/> 1755:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="1756"/> 1756:                                        lsa_dst =&gt; LSADst}};
<a name="1757"/> 1757:                       (#{domain := Domain} = State) -&gt;
<a name="1758"/> 1758:                            LSA = which_local_socket_addr(Domain),
<a name="1759"/> 1759:                            {ok, State#{lsa_src =&gt; LSA,
<a name="1760"/> 1760:                                        lsa_dst =&gt; LSA}}
<a name="1761"/> 1761:                    end},
<a name="1762"/> 1762: 
<a name="1763"/> 1763:          #{desc =&gt; &quot;open src socket&quot;,
<a name="1764"/> 1764:            cmd  =&gt; fun(#{domain := Domain,
<a name="1765"/> 1765:                          proto  := Proto} = State) -&gt;
<a name="1766"/> 1766:                            Sock = sock_open(Domain, dgram, Proto),
<a name="1767"/> 1767:                            {ok, State#{sock_src =&gt; Sock}}
<a name="1768"/> 1768:                    end},
<a name="1769"/> 1769:          #{desc =&gt; &quot;bind src socket&quot;,
<a name="1770"/> 1770:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="1771"/> 1771:                            case sock_bind(Sock, LSA) of
<a name="1772"/> 1772:                                ok -&gt;
<a name="1773"/> 1773:                                    Port = sock_port(Sock),
<a name="1774"/> 1774:                                    ?SEV_IPRINT(&quot;src bound (to ~p)&quot;, [Port]),
<a name="1775"/> 1775:                                    ok;
<a name="1776"/> 1776:                                {error, Reason} = ERROR -&gt;
<a name="1777"/> 1777:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="1778"/> 1778:                                    ERROR
<a name="1779"/> 1779:                            end
<a name="1780"/> 1780:                    end},
<a name="1781"/> 1781:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="1782"/> 1782:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="1783"/> 1783:                            SASrc = sock_sockname(Sock),
<a name="1784"/> 1784:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="1785"/> 1785:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="1786"/> 1786:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="1787"/> 1787:                    end},
<a name="1788"/> 1788: 
<a name="1789"/> 1789:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="1790"/> 1790:            cmd  =&gt; fun(#{domain := Domain,
<a name="1791"/> 1791:                          proto  := Proto} = State) -&gt;
<a name="1792"/> 1792:                            Sock = sock_open(Domain, dgram, Proto),
<a name="1793"/> 1793:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="1794"/> 1794:                    end},
<a name="1795"/> 1795:          #{desc =&gt; &quot;bind dst socket&quot;,
<a name="1796"/> 1796:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="1797"/> 1797:                            case sock_bind(Sock, LSA) of
<a name="1798"/> 1798:                                ok -&gt;
<a name="1799"/> 1799:                                    Port = sock_port(Sock),
<a name="1800"/> 1800:                                    ?SEV_IPRINT(&quot;src bound (to ~p)&quot;, [Port]),
<a name="1801"/> 1801:                                    ok;
<a name="1802"/> 1802:                                {error, Reason} = ERROR -&gt;
<a name="1803"/> 1803:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="1804"/> 1804:                                    ERROR
<a name="1805"/> 1805:                            end
<a name="1806"/> 1806:                    end},
<a name="1807"/> 1807:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="1808"/> 1808:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="1809"/> 1809:                            SADst = sock_sockname(Sock),
<a name="1810"/> 1810:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="1811"/> 1811:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="1812"/> 1812:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="1813"/> 1813:                    end},
<a name="1814"/> 1814:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="1815"/> 1815:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="1816"/> 1816:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="1817"/> 1817:                    end},
<a name="1818"/> 1818:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="1819"/> 1819:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="1820"/> 1820:                            case Recv(Sock) of
<a name="1821"/> 1821:                                {ok, {Src, ?BASIC_REQ}} -&gt;
<a name="1822"/> 1822:                                    ok;
<a name="1823"/> 1823:                                {ok, UnexpData} -&gt;
<a name="1824"/> 1824:                                    {error, {unexpected_data, UnexpData}};
<a name="1825"/> 1825:                                {error, _} = ERROR -&gt;
<a name="1826"/> 1826:                                    %% At the moment there is no way to get
<a name="1827"/> 1827:                                    %% status or state for the socket...
<a name="1828"/> 1828:                                    ERROR
<a name="1829"/> 1829:                            end
<a name="1830"/> 1830:                    end},
<a name="1831"/> 1831:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="1832"/> 1832:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="1833"/> 1833:                            Send(Sock, ?BASIC_REP, Src)
<a name="1834"/> 1834:                    end},
<a name="1835"/> 1835:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="1836"/> 1836:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="1837"/> 1837:                            case Recv(Sock) of
<a name="1838"/> 1838:                                {ok, {Dst, ?BASIC_REP}} -&gt;
<a name="1839"/> 1839:                                    ok;
<a name="1840"/> 1840:                                {ok, UnexpData} -&gt;
<a name="1841"/> 1841:                                    {error, {unexpected_data, UnexpData}};
<a name="1842"/> 1842:                                {error, _} = ERROR -&gt;
<a name="1843"/> 1843:                                    %% At the moment there is no way to get
<a name="1844"/> 1844:                                    %% status or state for the socket...
<a name="1845"/> 1845:                                    ERROR
<a name="1846"/> 1846:                            end
<a name="1847"/> 1847:                    end},
<a name="1848"/> 1848:          #{desc =&gt; &quot;close src socket&quot;,
<a name="1849"/> 1849:            cmd  =&gt; fun(#{domain   := local,
<a name="1850"/> 1850:                          sock_src := Sock,
<a name="1851"/> 1851:                          lsa_src  := #{path := Path}} = State) -&gt;
<a name="1852"/> 1852:                            ok = socket:close(Sock),
<a name="1853"/> 1853:                            State1 =
<a name="1854"/> 1854:                                unlink_path(Path,
<a name="1855"/> 1855:                                            fun() -&gt; maps:remove(lsa_src, State) end,
<a name="1856"/> 1856:                                            fun() -&gt; State end),
<a name="1857"/> 1857:                            {ok, maps:remove(sock_src, State1)};
<a name="1858"/> 1858:                       (#{sock_src := Sock} = State) -&gt;
<a name="1859"/> 1859:                            ok = socket:close(Sock),
<a name="1860"/> 1860:                            {ok, maps:remove(sock_src, State)}
<a name="1861"/> 1861:                    end},
<a name="1862"/> 1862:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="1863"/> 1863:            cmd  =&gt; fun(#{domain   := local,
<a name="1864"/> 1864:                          sock_dst := Sock,
<a name="1865"/> 1865:                          lsa_dst  := #{path := Path}} = State) -&gt;
<a name="1866"/> 1866:                            ok = socket:close(Sock),
<a name="1867"/> 1867:                            State1 =
<a name="1868"/> 1868:                                unlink_path(Path,
<a name="1869"/> 1869:                                            fun() -&gt; maps:remove(lsa_dst, State) end,
<a name="1870"/> 1870:                                            fun() -&gt; State end),
<a name="1871"/> 1871:                            {ok, maps:remove(sock_dst, State1)};
<a name="1872"/> 1872:                       (#{sock_dst := Sock} = State) -&gt;
<a name="1873"/> 1873:                            ok = socket:close(Sock),
<a name="1874"/> 1874:                            {ok, maps:remove(sock_dst, State)}
<a name="1875"/> 1875:                    end},
<a name="1876"/> 1876: 
<a name="1877"/> 1877:          %% *** We are done ***
<a name="1878"/> 1878:          ?SEV_FINISH_NORMAL
<a name="1879"/> 1879:         ],
<a name="1880"/> 1880:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_send_and_recv_udp-last_expr"/><a name="1881"/> 1881: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1882"/> 1882: 
<a name="1883"/> 1883: 
<a name="1884"/> 1884: 
<a name="1885"/> 1885: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1886"/> 1886: 
<a name="1887"/> 1887: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="1888"/> 1888: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_b_send_and_recv_tcp4-1"/><a name="1889"/> 1889: <b>api_b_send_and_recv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1890"/> 1890:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_tcp4-last_expr"/><a name="1891"/> 1891: <b>    tc_try</b>(api_b_send_and_recv_tcp4,
<a name="1892"/> 1892:            fun() -&gt; has_support_ipv4() end,
<a name="1893"/> 1893:            fun() -&gt;
<a name="1894"/> 1894:                    Send = fun(Sock, Data) -&gt;
<a name="1895"/> 1895:                                   socket:send(Sock, Data)
<a name="1896"/> 1896:                           end,
<a name="1897"/> 1897:                    Recv = fun(Sock) -&gt;
<a name="1898"/> 1898:                                   socket:recv(Sock)
<a name="1899"/> 1899:                           end,
<a name="1900"/> 1900:                    InitState = #{domain =&gt; inet,
<a name="1901"/> 1901:                                  type   =&gt; stream,
<a name="1902"/> 1902:                                  proto  =&gt; tcp,
<a name="1903"/> 1903:                                  send   =&gt; Send,
<a name="1904"/> 1904:                                  recv   =&gt; Recv},
<a name="1905"/> 1905:                    ok = api_b_send_and_recv_conn(InitState)
<a name="1906"/> 1906:            end).
<a name="1907"/> 1907: 
<a name="1908"/> 1908: 
<a name="1909"/> 1909: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1910"/> 1910: 
<a name="1911"/> 1911: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="1912"/> 1912: <i>%% on an IPv4 SCTP (stream) socket.</i>
<a name="api_b_send_and_recv_stream_sctp4-1"/><a name="1913"/> 1913: <b>api_b_send_and_recv_stream_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1914"/> 1914:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_stream_sctp4-last_expr"/><a name="1915"/> 1915: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1916"/> 1916:            fun() -&gt;
<a name="1917"/> 1917:                    has_support_sctp(),
<a name="1918"/> 1918:                    has_support_ipv4()
<a name="1919"/> 1919:            end,
<a name="1920"/> 1920:            fun() -&gt;
<a name="1921"/> 1921:                    Send = fun(Sock, Data) -&gt;
<a name="1922"/> 1922:                                   socket:send(Sock, Data)
<a name="1923"/> 1923:                           end,
<a name="1924"/> 1924:                    Recv = fun(Sock) -&gt;
<a name="1925"/> 1925:                                   socket:recv(Sock)
<a name="1926"/> 1926:                           end,
<a name="1927"/> 1927:                    InitState = #{domain =&gt; inet,
<a name="1928"/> 1928:                                  type   =&gt; stream,
<a name="1929"/> 1929:                                  proto  =&gt; sctp,
<a name="1930"/> 1930:                                  send   =&gt; Send,
<a name="1931"/> 1931:                                  recv   =&gt; Recv},
<a name="1932"/> 1932:                    ok = api_b_send_and_recv_conn(InitState)
<a name="1933"/> 1933:            end).
<a name="1934"/> 1934: 
<a name="1935"/> 1935: 
<a name="1936"/> 1936: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1937"/> 1937: 
<a name="1938"/> 1938: <i>%% Basically send and receive using the sendv and recv functions</i>
<a name="1939"/> 1939: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_b_sendv_and_recv_tcp4-1"/><a name="1940"/> 1940: <b>api_b_sendv_and_recv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1941"/> 1941:     ?TT(?SECS(10)),
<a name="api_b_sendv_and_recv_tcp4-last_expr"/><a name="1942"/> 1942: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1943"/> 1943:            fun() -&gt; has_support_ipv4() end,
<a name="1944"/> 1944:            fun() -&gt;
<a name="1945"/> 1945:                    Send = fun(Sock, Data) -&gt;
<a name="1946"/> 1946:                                   %% Since we are just reusing this test case,
<a name="1947"/> 1947:                                   %% the I/O vector is just one binary.
<a name="1948"/> 1948:                                   %% _ = socket:setopt(Sock, otp, debug, true),
<a name="1949"/> 1949:                                   Res = socket:sendv(Sock, [Data]),
<a name="1950"/> 1950:                                   %% _ = socket:setopt(Sock, otp, debug, false),
<a name="1951"/> 1951:                                   Res
<a name="1952"/> 1952:                           end,
<a name="1953"/> 1953:                    Recv = fun(Sock) -&gt;
<a name="1954"/> 1954:                                   socket:recv(Sock)
<a name="1955"/> 1955:                           end,
<a name="1956"/> 1956:                    InitState = #{domain =&gt; inet,
<a name="1957"/> 1957:                                  type   =&gt; stream,
<a name="1958"/> 1958:                                  proto  =&gt; tcp,
<a name="1959"/> 1959:                                  send   =&gt; Send,
<a name="1960"/> 1960:                                  recv   =&gt; Recv},
<a name="1961"/> 1961:                    ok = api_b_send_and_recv_conn(InitState)
<a name="1962"/> 1962:            end).
<a name="1963"/> 1963: 
<a name="1964"/> 1964: 
<a name="1965"/> 1965: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1966"/> 1966: 
<a name="1967"/> 1967: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="1968"/> 1968: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_send_and_recv_tcpL-1"/><a name="1969"/> 1969: <b>api_b_send_and_recv_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1970"/> 1970:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_tcpL-last_expr"/><a name="1971"/> 1971: <b>    tc_try</b>(api_b_send_and_recv_tcpL,
<a name="1972"/> 1972:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="1973"/> 1973:            fun() -&gt;
<a name="1974"/> 1974:                    Send = fun(Sock, Data) -&gt;
<a name="1975"/> 1975:                                   socket:send(Sock, Data)
<a name="1976"/> 1976:                           end,
<a name="1977"/> 1977:                    Recv = fun(Sock) -&gt;
<a name="1978"/> 1978:                                   socket:recv(Sock)
<a name="1979"/> 1979:                           end,
<a name="1980"/> 1980:                    InitState = #{domain =&gt; local,
<a name="1981"/> 1981:                                  type   =&gt; stream,
<a name="1982"/> 1982:                                  proto  =&gt; default,
<a name="1983"/> 1983:                                  send   =&gt; Send,
<a name="1984"/> 1984:                                  recv   =&gt; Recv},
<a name="1985"/> 1985:                    ok = api_b_send_and_recv_conn(InitState)
<a name="1986"/> 1986:            end).
<a name="1987"/> 1987: 
<a name="1988"/> 1988: 
<a name="1989"/> 1989: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1990"/> 1990: 
<a name="1991"/> 1991: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="1992"/> 1992: <i>%% on an Unix Domain seqpacket socket.</i>
<a name="api_b_send_and_recv_seqpL-1"/><a name="1993"/> 1993: <b>api_b_send_and_recv_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1994"/> 1994:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_seqpL-last_expr"/><a name="1995"/> 1995: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1996"/> 1996:            fun() -&gt;
<a name="1997"/> 1997: 		   has_support_unix_domain_socket(),
<a name="1998"/> 1998:                    is_not_windows()
<a name="1999"/> 1999: 	   end,
<a name="2000"/> 2000:            fun() -&gt;
<a name="2001"/> 2001:                    Send = fun(Sock, Data) -&gt;
<a name="2002"/> 2002:                                   socket:send(Sock, Data)
<a name="2003"/> 2003:                           end,
<a name="2004"/> 2004:                    Recv = fun(Sock) -&gt;
<a name="2005"/> 2005:                                   socket:recv(Sock)
<a name="2006"/> 2006:                           end,
<a name="2007"/> 2007:                    InitState = #{domain =&gt; local,
<a name="2008"/> 2008:                                  type   =&gt; seqpacket,
<a name="2009"/> 2009:                                  proto  =&gt; default,
<a name="2010"/> 2010:                                  send   =&gt; Send,
<a name="2011"/> 2011:                                  recv   =&gt; Recv},
<a name="2012"/> 2012:                    ok = api_b_send_and_recv_conn(InitState)
<a name="2013"/> 2013:            end).
<a name="2014"/> 2014: 
<a name="2015"/> 2015: 
<a name="2016"/> 2016: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2017"/> 2017: 
<a name="2018"/> 2018: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="2019"/> 2019: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_b_sendmsg_and_recvmsg_tcp4-1"/><a name="2020"/> 2020: <b>api_b_sendmsg_and_recvmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2021"/> 2021:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="2022"/> 2022: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_tcp4,
<a name="2023"/> 2023:            fun() -&gt;
<a name="2024"/> 2024:                    is_not_windows(),
<a name="2025"/> 2025:                    has_support_ipv4()
<a name="2026"/> 2026:            end,
<a name="2027"/> 2027:            fun() -&gt;
<a name="2028"/> 2028:                    Send = fun(Sock, Data) -&gt;
<a name="2029"/> 2029:                                   Msg = #{%% ctrl =&gt; CMsgs,
<a name="2030"/> 2030:                                           iov =&gt; [Data]},
<a name="2031"/> 2031:                                   socket:sendmsg(Sock, Msg)
<a name="2032"/> 2032:                           end,
<a name="2033"/> 2033:                    Recv = fun(Sock) -&gt;
<a name="2034"/> 2034:                                   case socket:recvmsg(Sock) of
<a name="2035"/> 2035:                                       {ok, #{addr  := _} = Addr} -&gt;
<a name="2036"/> 2036:                                           {error, {addr, Addr}};
<a name="2037"/> 2037:                                       {ok, #{iov   := [Data]}} -&gt;
<a name="2038"/> 2038:                                           {ok, Data};
<a name="2039"/> 2039:                                       {ok, Msg} -&gt;
<a name="2040"/> 2040:                                           {error, {msg, Msg}};
<a name="2041"/> 2041:                                       {error, _} = ERROR -&gt;
<a name="2042"/> 2042:                                           ERROR
<a name="2043"/> 2043:                                   end
<a name="2044"/> 2044:                           end,
<a name="2045"/> 2045:                    InitState = #{domain =&gt; inet,
<a name="2046"/> 2046:                                  type   =&gt; stream,
<a name="2047"/> 2047:                                  proto  =&gt; tcp,
<a name="2048"/> 2048:                                  send   =&gt; Send,
<a name="2049"/> 2049:                                  recv   =&gt; Recv},
<a name="2050"/> 2050:                    ok = api_b_send_and_recv_conn(InitState)
<a name="2051"/> 2051:            end).
<a name="2052"/> 2052: 
<a name="2053"/> 2053: 
<a name="2054"/> 2054: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2055"/> 2055: 
<a name="2056"/> 2056: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="2057"/> 2057: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_sendmsg_and_recvmsg_tcpL-1"/><a name="2058"/> 2058: <b>api_b_sendmsg_and_recvmsg_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="2059"/> 2059:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_tcpL-last_expr"/><a name="2060"/> 2060: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_tcpL,
<a name="2061"/> 2061:            fun() -&gt;
<a name="2062"/> 2062: 		   has_support_unix_domain_socket(),
<a name="2063"/> 2063: 		   is_not_windows()
<a name="2064"/> 2064: 	   end,
<a name="2065"/> 2065:            fun() -&gt;
<a name="2066"/> 2066:                    Send = fun(Sock, Data) -&gt;
<a name="2067"/> 2067:                                   Msg = #{iov =&gt; [Data]},
<a name="2068"/> 2068:                                   socket:sendmsg(Sock, Msg)
<a name="2069"/> 2069:                           end,
<a name="2070"/> 2070:                    Recv = fun(Sock) -&gt;
<a name="2071"/> 2071:                                   case socket:recvmsg(Sock) of
<a name="2072"/> 2072:                                       %% On some platforms, the address
<a name="2073"/> 2073:                                       %% *is* provided (e.g. linux)
<a name="2074"/> 2074:                                       {ok, #{addr  := #{family := local},
<a name="2075"/> 2075:                                              iov   := [Data]}} -&gt;
<a name="2076"/> 2076:                                           socket:setopt(Sock, 
<a name="2077"/> 2077:                                                         otp, 
<a name="2078"/> 2078:                                                         debug, 
<a name="2079"/> 2079:                                                         false),
<a name="2080"/> 2080:                                           {ok, Data};
<a name="2081"/> 2081:                                       {ok, #{addr := _} = Msg} -&gt;
<a name="2082"/> 2082:                                           {error, {msg, Msg}};
<a name="2083"/> 2083:                                       %% On some platforms, the address
<a name="2084"/> 2084:                                       %% is *not* provided (e.g. FreeBSD)
<a name="2085"/> 2085:                                       {ok, #{iov   := [Data]}} -&gt;
<a name="2086"/> 2086:                                           {ok, Data};
<a name="2087"/> 2087:                                       {ok, Msg} -&gt;
<a name="2088"/> 2088:                                           {error, {msg, Msg}};
<a name="2089"/> 2089:                                       {error, _} = ERROR -&gt;
<a name="2090"/> 2090:                                           socket:setopt(Sock, 
<a name="2091"/> 2091:                                                         otp, 
<a name="2092"/> 2092:                                                         debug, 
<a name="2093"/> 2093:                                                         false),
<a name="2094"/> 2094:                                           ERROR
<a name="2095"/> 2095:                                   end
<a name="2096"/> 2096:                           end,
<a name="2097"/> 2097:                    InitState = #{domain =&gt; local,
<a name="2098"/> 2098:                                  type   =&gt; stream,
<a name="2099"/> 2099:                                  proto  =&gt; default,
<a name="2100"/> 2100:                                  send   =&gt; Send,
<a name="2101"/> 2101:                                  recv   =&gt; Recv},
<a name="2102"/> 2102:                    ok = api_b_send_and_recv_conn(InitState)
<a name="2103"/> 2103:            end).
<a name="2104"/> 2104: 
<a name="2105"/> 2105: 
<a name="2106"/> 2106: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2107"/> 2107: 
<a name="2108"/> 2108: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="2109"/> 2109: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_sendmsg_and_recvmsg_seqpL-1"/><a name="2110"/> 2110: <b>api_b_sendmsg_and_recvmsg_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="2111"/> 2111:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_seqpL-last_expr"/><a name="2112"/> 2112: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2113"/> 2113:            fun() -&gt;
<a name="2114"/> 2114: 		   has_support_unix_domain_socket(),
<a name="2115"/> 2115:                    is_not_windows()
<a name="2116"/> 2116: 	   end,
<a name="2117"/> 2117:            fun() -&gt;
<a name="2118"/> 2118:                    Send =
<a name="2119"/> 2119:                        fun(Sock, Data) -&gt;
<a name="2120"/> 2120:                                Msg =
<a name="2121"/> 2121:                                    #{iov =&gt; [Data]},
<a name="2122"/> 2122:                                socket:sendmsg(Sock, Msg)
<a name="2123"/> 2123:                        end,
<a name="2124"/> 2124:                    Recv = fun(Sock) -&gt;
<a name="2125"/> 2125:                                   case socket:recvmsg(Sock) of
<a name="2126"/> 2126:                                       %% On some platforms, the address
<a name="2127"/> 2127:                                       %% *is* provided (e.g. linux)
<a name="2128"/> 2128:                                       {ok,
<a name="2129"/> 2129:                                        #{addr  := #{family := local},
<a name="2130"/> 2130:                                          iov   := [Data]}} -&gt;
<a name="2131"/> 2131:                                           socket:setopt(
<a name="2132"/> 2132:                                             Sock, otp, debug, false),
<a name="2133"/> 2133:                                           {ok, Data};
<a name="2134"/> 2134:                                       {ok, #{addr := _} = Msg} -&gt;
<a name="2135"/> 2135:                                           {error, {msg, Msg}};
<a name="2136"/> 2136:                                       %% On some platforms, the address
<a name="2137"/> 2137:                                       %% is *not* provided (e.g. FreeBSD)
<a name="2138"/> 2138:                                       {ok,
<a name="2139"/> 2139:                                        #{iov   := [Data]}} -&gt;
<a name="2140"/> 2140:                                           {ok, Data};
<a name="2141"/> 2141:                                       {ok, Msg} -&gt;
<a name="2142"/> 2142:                                           {error, {msg, Msg}};
<a name="2143"/> 2143:                                       {error, _} = ERROR -&gt;
<a name="2144"/> 2144:                                           socket:setopt(
<a name="2145"/> 2145:                                             Sock, otp, debug, false),
<a name="2146"/> 2146:                                           ERROR
<a name="2147"/> 2147:                                   end
<a name="2148"/> 2148:                           end,
<a name="2149"/> 2149:                    InitState =
<a name="2150"/> 2150:                        #{domain =&gt; local,
<a name="2151"/> 2151:                          type   =&gt; seqpacket,
<a name="2152"/> 2152:                          proto  =&gt; default,
<a name="2153"/> 2153:                          send   =&gt; Send,
<a name="2154"/> 2154:                          recv   =&gt; Recv},
<a name="2155"/> 2155:                    ok = api_b_send_and_recv_conn(InitState)
<a name="2156"/> 2156:            end).
<a name="2157"/> 2157: 
<a name="2158"/> 2158: 
<a name="2159"/> 2159: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2160"/> 2160: 
<a name="api_b_send_and_recv_conn-1"/><a name="2161"/> 2161: <b>api_b_send_and_recv_conn</b>(InitState) -&gt;
<a name="2162"/> 2162:     process_flag(trap_exit, true),
<a name="2163"/> 2163: 
<a name="2164"/> 2164:     ServerSeq = 
<a name="2165"/> 2165:         [
<a name="2166"/> 2166:          %% *** Wait for start order ***
<a name="2167"/> 2167:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="2168"/> 2168:            cmd  =&gt; fun(State) -&gt;
<a name="2169"/> 2169:                            Tester = ?SEV_AWAIT_START(),
<a name="2170"/> 2170:                            {ok, State#{tester =&gt; Tester}}
<a name="2171"/> 2171:                    end},
<a name="2172"/> 2172:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="2173"/> 2173:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2174"/> 2174:                            _MRef = erlang:monitor(process, Tester),
<a name="2175"/> 2175:                            ok
<a name="2176"/> 2176:                    end},
<a name="2177"/> 2177: 
<a name="2178"/> 2178:          %% *** Init part ***
<a name="2179"/> 2179:          #{desc =&gt; &quot;which local address&quot;,
<a name="2180"/> 2180:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="2181"/> 2181:                            LSA = which_local_socket_addr(Domain),
<a name="2182"/> 2182: 			   ?SEV_IPRINT(&quot;LSA: ~p&quot;, [LSA]),
<a name="2183"/> 2183:                            {ok, State#{lsa =&gt; LSA}}
<a name="2184"/> 2184:                    end},
<a name="2185"/> 2185:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="2186"/> 2186:            cmd  =&gt; fun(#{domain := Domain,
<a name="2187"/> 2187:                          type := Type,
<a name="2188"/> 2188:                          proto  := Proto} = State) -&gt;
<a name="2189"/> 2189:                            case socket:open(Domain, Type, Proto) of
<a name="2190"/> 2190:                                {ok, Sock} -&gt;
<a name="2191"/> 2191:                                    {ok, State#{lsock =&gt; Sock}};
<a name="2192"/> 2192:                                {error, eprotonosupport = Reason} -&gt;
<a name="2193"/> 2193:                                    {skip, Reason};
<a name="2194"/> 2194:                                {error, _} = ERROR -&gt;
<a name="2195"/> 2195:                                    ERROR
<a name="2196"/> 2196:                            end
<a name="2197"/> 2197:                    end},
<a name="2198"/> 2198:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="2199"/> 2199:            cmd  =&gt; fun(#{domain := local,
<a name="2200"/> 2200:                          lsock  := LSock,
<a name="2201"/> 2201:                          lsa    := LSA} = _State) -&gt;
<a name="2202"/> 2202: 			   ?SEV_IPRINT(&quot;try bind to: &quot;
<a name="2203"/> 2203: 				       &quot;~n   ~p&quot;, [LSA]),
<a name="2204"/> 2204: 			   %% _ = socket:setopt(LSock, otp, debug, true),
<a name="2205"/> 2205:                            case socket:bind(LSock, LSA) of
<a name="2206"/> 2206:                                ok -&gt;
<a name="2207"/> 2207:                                    %% We do not care about the port for local
<a name="2208"/> 2208: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2209"/> 2209:                                    ok;
<a name="2210"/> 2210:                                {error, Reason} = ERROR -&gt;
<a name="2211"/> 2211: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2212"/> 2212: 				   ?SEV_EPRINT(&quot;failed binding: &quot;
<a name="2213"/> 2213: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="2214"/> 2214:                                    ERROR
<a name="2215"/> 2215:                            end;
<a name="2216"/> 2216:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="2217"/> 2217:                            case sock_bind(LSock, LSA) of
<a name="2218"/> 2218:                                ok -&gt;
<a name="2219"/> 2219:                                    Port = sock_port(LSock),
<a name="2220"/> 2220:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="2221"/> 2221:                                    {ok, State#{lport =&gt; Port}};
<a name="2222"/> 2222:                                {error, _} = ERROR -&gt;
<a name="2223"/> 2223:                                    ERROR
<a name="2224"/> 2224:                            end
<a name="2225"/> 2225:                    end},
<a name="2226"/> 2226:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="2227"/> 2227:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="2228"/> 2228:                            socket:listen(LSock)
<a name="2229"/> 2229:                    end},
<a name="2230"/> 2230:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="2231"/> 2231:            cmd  =&gt; fun(#{domain := local,
<a name="2232"/> 2232:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="2233"/> 2233:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="2234"/> 2234:                            ok;
<a name="2235"/> 2235:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="2236"/> 2236:                            %% This is actually not used for unix domain socket
<a name="2237"/> 2237:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="2238"/> 2238:                            ok
<a name="2239"/> 2239:                    end},
<a name="2240"/> 2240: 
<a name="2241"/> 2241:          %% The actual test
<a name="2242"/> 2242:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="2243"/> 2243:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2244"/> 2244:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="2245"/> 2245:                    end},
<a name="2246"/> 2246:          #{desc =&gt; &quot;await connection&quot;,
<a name="2247"/> 2247:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="2248"/> 2248: 			   ?SEV_IPRINT(&quot;try accept&quot;),
<a name="2249"/> 2249:                            case socket:accept(LSock) of
<a name="2250"/> 2250:                                {ok, Sock} -&gt;
<a name="2251"/> 2251:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="2252"/> 2252:                                    {ok, State#{csock =&gt; Sock}};
<a name="2253"/> 2253:                                {error, Reason} = ERROR -&gt;
<a name="2254"/> 2254:                                    ?SEV_EPRINT(&quot;accept failed: &quot;
<a name="2255"/> 2255: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="2256"/> 2256:                                    ERROR
<a name="2257"/> 2257:                            end
<a name="2258"/> 2258:                    end},
<a name="2259"/> 2259:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="2260"/> 2260:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2261"/> 2261:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="2262"/> 2262:                            ok
<a name="2263"/> 2263:                    end},
<a name="2264"/> 2264:          #{desc =&gt; &quot;await (recv) request&quot;,
<a name="2265"/> 2265:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="2266"/> 2266:                            case Recv(Sock) of
<a name="2267"/> 2267:                                {ok, ?BASIC_REQ} -&gt;
<a name="2268"/> 2268:                                    ok;
<a name="2269"/> 2269:                                {error, _} = ERROR -&gt;
<a name="2270"/> 2270:                                    ERROR
<a name="2271"/> 2271:                            end
<a name="2272"/> 2272:                    end},
<a name="2273"/> 2273:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="2274"/> 2274:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2275"/> 2275:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="2276"/> 2276:                            ok
<a name="2277"/> 2277:                    end},
<a name="2278"/> 2278:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="2279"/> 2279:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2280"/> 2280:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="2281"/> 2281:                    end},
<a name="2282"/> 2282:          #{desc =&gt; &quot;send reply&quot;,
<a name="2283"/> 2283:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="2284"/> 2284:                            Send(Sock, ?BASIC_REP)
<a name="2285"/> 2285:                    end},
<a name="2286"/> 2286:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="2287"/> 2287:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2288"/> 2288:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="2289"/> 2289:                            ok
<a name="2290"/> 2290:                    end},
<a name="2291"/> 2291: 
<a name="2292"/> 2292:          %% *** Termination ***
<a name="2293"/> 2293:          #{desc =&gt; &quot;await terminate&quot;,
<a name="2294"/> 2294:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="2295"/> 2295:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="2296"/> 2296:                                ok -&gt;
<a name="2297"/> 2297:                                    {ok, maps:remove(tester, State)};
<a name="2298"/> 2298:                                {error, _} = ERROR -&gt;
<a name="2299"/> 2299:                                    ERROR
<a name="2300"/> 2300:                            end
<a name="2301"/> 2301:                    end},
<a name="2302"/> 2302:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="2303"/> 2303:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="2304"/> 2304:                            ok = socket:close(Sock),
<a name="2305"/> 2305:                            {ok, maps:remove(csock, State)}
<a name="2306"/> 2306:                    end},
<a name="2307"/> 2307:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="2308"/> 2308:            cmd  =&gt; fun(#{domain   := local,
<a name="2309"/> 2309:                          lsock    := Sock,
<a name="2310"/> 2310:                          local_sa := #{path := Path}} = State) -&gt;
<a name="2311"/> 2311:                            ok = socket:close(Sock),
<a name="2312"/> 2312:                            State1 =
<a name="2313"/> 2313:                                unlink_path(Path,
<a name="2314"/> 2314:                                            fun() -&gt;
<a name="2315"/> 2315:                                                    maps:remove(local_sa, State)
<a name="2316"/> 2316:                                            end,
<a name="2317"/> 2317:                                            fun() -&gt; State end),
<a name="2318"/> 2318:                            {ok, maps:remove(lsock, State1)};
<a name="2319"/> 2319:                       (#{lsock := LSock} = State) -&gt;
<a name="2320"/> 2320:                            case socket:close(LSock) of
<a name="2321"/> 2321:                                ok -&gt;
<a name="2322"/> 2322:                                    {ok, maps:remove(lsock, State)};
<a name="2323"/> 2323:                                {error, _} = ERROR -&gt;
<a name="2324"/> 2324:                                    ERROR
<a name="2325"/> 2325:                            end
<a name="2326"/> 2326:                    end},
<a name="2327"/> 2327: 
<a name="2328"/> 2328:          %% *** We are done ***
<a name="2329"/> 2329:          ?SEV_FINISH_NORMAL
<a name="2330"/> 2330:         ],
<a name="2331"/> 2331: 
<a name="2332"/> 2332:     ClientSeq =
<a name="2333"/> 2333:         [
<a name="2334"/> 2334:          %% *** Wait for start order ***
<a name="2335"/> 2335:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="2336"/> 2336:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="2337"/> 2337:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="2338"/> 2338:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="2339"/> 2339:                       (State) -&gt;
<a name="2340"/> 2340:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="2341"/> 2341:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="2342"/> 2342:                    end},
<a name="2343"/> 2343:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="2344"/> 2344:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2345"/> 2345:                            _MRef = erlang:monitor(process, Tester),
<a name="2346"/> 2346:                            ok
<a name="2347"/> 2347:                    end},
<a name="2348"/> 2348: 
<a name="2349"/> 2349:          %% *** The init part ***
<a name="2350"/> 2350:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="2351"/> 2351:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="2352"/> 2352:                          server_path := Path} = State) -&gt;
<a name="2353"/> 2353:                            LSA = which_local_socket_addr(Domain),
<a name="2354"/> 2354:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="2355"/> 2355:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="2356"/> 2356:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="2357"/> 2357:                            LSA = which_local_socket_addr(Domain),
<a name="2358"/> 2358:                            SSA = LSA#{port =&gt; Port},
<a name="2359"/> 2359:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="2360"/> 2360:                    end},
<a name="2361"/> 2361:          #{desc =&gt; &quot;create socket&quot;,
<a name="2362"/> 2362:            cmd  =&gt; fun(#{domain := Domain,
<a name="2363"/> 2363:                          type := Type,
<a name="2364"/> 2364:                          proto  := Proto} = State) -&gt;
<a name="2365"/> 2365:                            case socket:open(Domain, Type, Proto) of
<a name="2366"/> 2366:                                {ok, Sock} -&gt;
<a name="2367"/> 2367:                                    {ok, State#{sock =&gt; Sock}};
<a name="2368"/> 2368:                                {error, _} = ERROR -&gt;
<a name="2369"/> 2369:                                    ERROR
<a name="2370"/> 2370:                            end
<a name="2371"/> 2371:                    end},
<a name="2372"/> 2372:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="2373"/> 2373:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="2374"/> 2374:                            case sock_bind(Sock, LSA) of
<a name="2375"/> 2375:                                ok -&gt;
<a name="2376"/> 2376:                                    ok;
<a name="2377"/> 2377:                                {error, _} = ERROR -&gt;
<a name="2378"/> 2378:                                    ERROR
<a name="2379"/> 2379:                            end
<a name="2380"/> 2380:                    end},
<a name="2381"/> 2381:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="2382"/> 2382:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2383"/> 2383:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="2384"/> 2384:                            ok
<a name="2385"/> 2385:                    end},
<a name="2386"/> 2386: 
<a name="2387"/> 2387:          %% *** The actual test ***
<a name="2388"/> 2388:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="2389"/> 2389:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="2390"/> 2390:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="2391"/> 2391:                    end},
<a name="2392"/> 2392:          #{desc =&gt; &quot;connect to server&quot;,
<a name="2393"/> 2393:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="2394"/> 2394:                            socket:connect(Sock, SSA)
<a name="2395"/> 2395:                    end},
<a name="2396"/> 2396:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="2397"/> 2397:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2398"/> 2398:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="2399"/> 2399:                            ok
<a name="2400"/> 2400:                    end},
<a name="2401"/> 2401:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="2402"/> 2402:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="2403"/> 2403:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="2404"/> 2404:                    end},
<a name="2405"/> 2405:          #{desc =&gt; &quot;send request (to server)&quot;,
<a name="2406"/> 2406:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="2407"/> 2407:                            Send(Sock, ?BASIC_REQ)
<a name="2408"/> 2408:                    end},
<a name="2409"/> 2409:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="2410"/> 2410:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2411"/> 2411:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="2412"/> 2412:                            ok
<a name="2413"/> 2413:                    end},
<a name="2414"/> 2414:          #{desc =&gt; &quot;await recv reply (from server)&quot;,
<a name="2415"/> 2415:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="2416"/> 2416:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="2417"/> 2417:                            ok
<a name="2418"/> 2418:                    end},
<a name="2419"/> 2419:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="2420"/> 2420:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2421"/> 2421:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="2422"/> 2422:                            ok
<a name="2423"/> 2423:                    end},
<a name="2424"/> 2424: 
<a name="2425"/> 2425:          %% *** Termination ***
<a name="2426"/> 2426:          #{desc =&gt; &quot;await terminate&quot;,
<a name="2427"/> 2427:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="2428"/> 2428:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="2429"/> 2429:                                ok -&gt;
<a name="2430"/> 2430:                                    {ok, maps:remove(tester, State)};
<a name="2431"/> 2431:                                {error, _} = ERROR -&gt;
<a name="2432"/> 2432:                                    ERROR
<a name="2433"/> 2433:                            end
<a name="2434"/> 2434:                    end},
<a name="2435"/> 2435:          #{desc =&gt; &quot;close socket&quot;,
<a name="2436"/> 2436:            cmd  =&gt; fun(#{domain   := local,
<a name="2437"/> 2437:                          sock     := Sock,
<a name="2438"/> 2438:                          local_sa := #{path := Path}} = State) -&gt;
<a name="2439"/> 2439:                            ok = socket:close(Sock),
<a name="2440"/> 2440:                            State1 =
<a name="2441"/> 2441:                                unlink_path(Path,
<a name="2442"/> 2442:                                            fun() -&gt;
<a name="2443"/> 2443:                                                    maps:remove(local_sa, State)
<a name="2444"/> 2444:                                            end,
<a name="2445"/> 2445:                                            fun() -&gt; State end),
<a name="2446"/> 2446:                            {ok, maps:remove(sock, State1)};
<a name="2447"/> 2447:                       (#{sock := Sock} = State) -&gt;
<a name="2448"/> 2448:                            ok = socket:close(Sock),
<a name="2449"/> 2449:                            {ok, maps:remove(sock, State)}
<a name="2450"/> 2450:                    end},
<a name="2451"/> 2451: 
<a name="2452"/> 2452:          %% *** We are done ***
<a name="2453"/> 2453:          ?SEV_FINISH_NORMAL
<a name="2454"/> 2454:         ],
<a name="2455"/> 2455: 
<a name="2456"/> 2456:     TesterSeq =
<a name="2457"/> 2457:         [
<a name="2458"/> 2458:          %% *** Init part ***
<a name="2459"/> 2459:          #{desc =&gt; &quot;monitor server&quot;,
<a name="2460"/> 2460:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="2461"/> 2461:                            _MRef = erlang:monitor(process, Pid),
<a name="2462"/> 2462:                            ok
<a name="2463"/> 2463:                    end},
<a name="2464"/> 2464:          #{desc =&gt; &quot;monitor client&quot;,
<a name="2465"/> 2465:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="2466"/> 2466:                            _MRef = erlang:monitor(process, Pid),
<a name="2467"/> 2467:                            ok
<a name="2468"/> 2468:                    end},
<a name="2469"/> 2469: 
<a name="2470"/> 2470:          %% Start the server
<a name="2471"/> 2471:          #{desc =&gt; &quot;order server start&quot;,
<a name="2472"/> 2472:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="2473"/> 2473:                            ?SEV_ANNOUNCE_START(Pid),
<a name="2474"/> 2474:                            ok
<a name="2475"/> 2475:                    end},
<a name="2476"/> 2476:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="2477"/> 2477:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="2478"/> 2478:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="2479"/> 2479:                            {ok, State#{server_port =&gt; Port}}
<a name="2480"/> 2480:                    end},
<a name="2481"/> 2481: 
<a name="2482"/> 2482:          %% Start the client
<a name="2483"/> 2483:          #{desc =&gt; &quot;order client start&quot;,
<a name="2484"/> 2484:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="2485"/> 2485:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="2486"/> 2486:                            ok
<a name="2487"/> 2487:                    end},
<a name="2488"/> 2488:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="2489"/> 2489:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="2490"/> 2490:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="2491"/> 2491:                    end},
<a name="2492"/> 2492: 
<a name="2493"/> 2493:          %% *** The actual test ***
<a name="2494"/> 2494:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="2495"/> 2495:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2496"/> 2496:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="2497"/> 2497:                            ok
<a name="2498"/> 2498:                    end},
<a name="2499"/> 2499:          ?SEV_SLEEP(?SECS(1)),
<a name="2500"/> 2500:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="2501"/> 2501:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2502"/> 2502:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="2503"/> 2503:                            ok
<a name="2504"/> 2504:                    end},
<a name="2505"/> 2505:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="2506"/> 2506:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2507"/> 2507:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="2508"/> 2508:                    end},
<a name="2509"/> 2509:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="2510"/> 2510:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2511"/> 2511:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="2512"/> 2512:                    end},
<a name="2513"/> 2513:          #{desc =&gt; &quot;order client to continue (with send request)&quot;,
<a name="2514"/> 2514:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2515"/> 2515:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="2516"/> 2516:                            ok
<a name="2517"/> 2517:                    end},
<a name="2518"/> 2518:          #{desc =&gt; &quot;await client ready (with send request)&quot;,
<a name="2519"/> 2519:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2520"/> 2520:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="2521"/> 2521:                    end},
<a name="2522"/> 2522:          #{desc =&gt; &quot;await server ready (request recv)&quot;,
<a name="2523"/> 2523:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2524"/> 2524:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="2525"/> 2525:                    end},
<a name="2526"/> 2526:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="2527"/> 2527:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2528"/> 2528:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="2529"/> 2529:                            ok
<a name="2530"/> 2530:                    end},
<a name="2531"/> 2531:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="2532"/> 2532:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2533"/> 2533:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="2534"/> 2534:                    end},
<a name="2535"/> 2535:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="2536"/> 2536:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2537"/> 2537:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="2538"/> 2538:                    end},
<a name="2539"/> 2539: 
<a name="2540"/> 2540: 
<a name="2541"/> 2541:          %% *** Termination ***
<a name="2542"/> 2542:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="2543"/> 2543:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2544"/> 2544:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="2545"/> 2545:                            ok
<a name="2546"/> 2546:                    end},
<a name="2547"/> 2547:          #{desc =&gt; &quot;await client termination&quot;,
<a name="2548"/> 2548:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="2549"/> 2549:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="2550"/> 2550:                            State1 = maps:remove(client, State),
<a name="2551"/> 2551:                            {ok, State1}
<a name="2552"/> 2552:                    end},
<a name="2553"/> 2553:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="2554"/> 2554:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2555"/> 2555:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="2556"/> 2556:                            ok
<a name="2557"/> 2557:                    end},
<a name="2558"/> 2558:          #{desc =&gt; &quot;await server termination&quot;,
<a name="2559"/> 2559:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="2560"/> 2560:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="2561"/> 2561:                            State1 = maps:remove(server, State),
<a name="2562"/> 2562:                            {ok, State1}
<a name="2563"/> 2563:                    end},
<a name="2564"/> 2564: 
<a name="2565"/> 2565:          %% *** We are done ***
<a name="2566"/> 2566:          ?SEV_FINISH_NORMAL
<a name="2567"/> 2567:         ],
<a name="2568"/> 2568: 
<a name="2569"/> 2569:     i(&quot;start server evaluator&quot;),
<a name="2570"/> 2570:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="2571"/> 2571: 
<a name="2572"/> 2572:     i(&quot;start client evaluator&quot;),
<a name="2573"/> 2573:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="2574"/> 2574:     i(&quot;await evaluator(s)&quot;),
<a name="2575"/> 2575: 
<a name="2576"/> 2576:     i(&quot;start tester evaluator&quot;),
<a name="2577"/> 2577:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="2578"/> 2578:                         client =&gt; Client#ev.pid},
<a name="2579"/> 2579:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="2580"/> 2580: 
<a name="api_b_send_and_recv_conn-last_expr"/><a name="2581"/> 2581: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="2582"/> 2582: 
<a name="2583"/> 2583: 
<a name="2584"/> 2584: 
<a name="2585"/> 2585: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2586"/> 2586: 
<a name="2587"/> 2587: <b>-define</b>(REQ_IOV_SND, [&lt;&lt;0:32&gt;&gt;,
<a name="2588"/> 2588:                       &lt;&lt;1:32&gt;&gt;,
<a name="2589"/> 2589:                       &lt;&lt;2:32&gt;&gt;,
<a name="2590"/> 2590:                       &lt;&lt;3:32&gt;&gt;,
<a name="2591"/> 2591:                       &lt;&lt;4:32&gt;&gt;,
<a name="2592"/> 2592:                       &lt;&lt;5:32&gt;&gt;,
<a name="2593"/> 2593:                       &lt;&lt;6:32&gt;&gt;,
<a name="2594"/> 2594:                       &lt;&lt;7:32&gt;&gt;,
<a name="2595"/> 2595:                       &lt;&lt;8:32&gt;&gt;,
<a name="2596"/> 2596:                       &lt;&lt;9:32&gt;&gt;]).
<a name="2597"/> 2597: <b>-define</b>(REQ_IOV_RCV, erlang:iolist_to_binary(?REQ_IOV_SND)).
<a name="2598"/> 2598: <b>-define</b>(REP_IOV_SND, [&lt;&lt;10:32&gt;&gt;,
<a name="2599"/> 2599:                       &lt;&lt;11:32&gt;&gt;,
<a name="2600"/> 2600:                       &lt;&lt;12:32&gt;&gt;,
<a name="2601"/> 2601:                       &lt;&lt;13:32&gt;&gt;,
<a name="2602"/> 2602:                       &lt;&lt;14:32&gt;&gt;,
<a name="2603"/> 2603:                       &lt;&lt;15:32&gt;&gt;,
<a name="2604"/> 2604:                       &lt;&lt;16:32&gt;&gt;,
<a name="2605"/> 2605:                       &lt;&lt;17:32&gt;&gt;,
<a name="2606"/> 2606:                       &lt;&lt;18:32&gt;&gt;,
<a name="2607"/> 2607:                       &lt;&lt;19:32&gt;&gt;]).
<a name="2608"/> 2608: <b>-define</b>(REP_IOV_RCV, erlang:iolist_to_binary(?REP_IOV_SND)).
<a name="2609"/> 2609: 
<a name="ensure_sufficient_iov_max-0"/><a name="2610"/> 2610: <b>ensure_sufficient_iov_max</b>() -&gt;
<a name="ensure_sufficient_iov_max-last_expr"/><a name="2611"/> 2611: <b>    case socket:info</b>() of
<a name="2612"/> 2612:         #{iov_max := IOVMax} -&gt;
<a name="2613"/> 2613:             IOVUsed = length(?REQ_IOV_SND),
<a name="2614"/> 2614:             if
<a name="2615"/> 2615:                 IOVMax &gt;= IOVUsed -&gt;
<a name="2616"/> 2616:                     ok;
<a name="2617"/> 2617:                 true -&gt;
<a name="2618"/> 2618:                     skip({iov_max, IOVMax, IOVUsed})
<a name="2619"/> 2619:             end;
<a name="2620"/> 2620:         _ -&gt;
<a name="2621"/> 2621:             skip(no_info)
<a name="2622"/> 2622:     end.
<a name="2623"/> 2623:     
<a name="2624"/> 2624: 
<a name="2625"/> 2625: <i>%% Basically send a I/O vector and receive using the sendv and recv</i>
<a name="2626"/> 2626: <i>%% functions on an IPv4 TCP (stream) socket.</i>
<a name="api_b_sendv_tcp4-1"/><a name="2627"/> 2627: <b>api_b_sendv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2628"/> 2628:     ?TT(?SECS(10)),
<a name="api_b_sendv_tcp4-last_expr"/><a name="2629"/> 2629: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2630"/> 2630:            fun() -&gt;
<a name="2631"/> 2631:                    has_support_ipv4(),
<a name="2632"/> 2632:                    ensure_sufficient_iov_max()
<a name="2633"/> 2633:            end,
<a name="2634"/> 2634:            fun() -&gt;
<a name="2635"/> 2635:                    Send = fun(Sock, IOV) when is_list(IOV) -&gt;
<a name="2636"/> 2636:                                   %% Since we are just reusing this test case,
<a name="2637"/> 2637:                                   %% the I/O vector is just one binary.
<a name="2638"/> 2638:                                   %% _ = socket:setopt(Sock, otp, debug, true),
<a name="2639"/> 2639:                                   Res = socket:sendv(Sock, IOV),
<a name="2640"/> 2640:                                   %% _ = socket:setopt(Sock, otp, debug, false),
<a name="2641"/> 2641:                                   Res
<a name="2642"/> 2642:                           end,
<a name="2643"/> 2643:                    Recv = fun(Sock) -&gt;
<a name="2644"/> 2644:                                   socket:recv(Sock)
<a name="2645"/> 2645:                           end,
<a name="2646"/> 2646:                    InitState = #{domain =&gt; inet,
<a name="2647"/> 2647:                                  type   =&gt; stream,
<a name="2648"/> 2648:                                  proto  =&gt; tcp,
<a name="2649"/> 2649:                                  send   =&gt; Send,
<a name="2650"/> 2650:                                  recv   =&gt; Recv},
<a name="2651"/> 2651:                    ok = api_b_sendv(InitState)
<a name="2652"/> 2652:            end).
<a name="2653"/> 2653: 
<a name="2654"/> 2654: 
<a name="2655"/> 2655: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2656"/> 2656: 
<a name="2657"/> 2657: <i>%% Basically send a I/O vector and receive using the sendv and recv</i>
<a name="2658"/> 2658: <i>%% functions on an IPv6 TCP (stream) socket.</i>
<a name="api_b_sendv_tcp6-1"/><a name="2659"/> 2659: <b>api_b_sendv_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="2660"/> 2660:     ?TT(?SECS(10)),
<a name="api_b_sendv_tcp6-last_expr"/><a name="2661"/> 2661: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2662"/> 2662:            fun() -&gt;
<a name="2663"/> 2663:                    has_support_ipv6(),
<a name="2664"/> 2664:                    ensure_sufficient_iov_max()
<a name="2665"/> 2665:            end,
<a name="2666"/> 2666:            fun() -&gt;
<a name="2667"/> 2667:                    Send = fun(Sock, IOV) when is_list(IOV) -&gt;
<a name="2668"/> 2668:                                   %% Since we are just reusing this test case,
<a name="2669"/> 2669:                                   %% the I/O vector is just one binary.
<a name="2670"/> 2670:                                   %% _ = socket:setopt(Sock, otp, debug, true),
<a name="2671"/> 2671:                                   Res = socket:sendv(Sock, IOV),
<a name="2672"/> 2672:                                   %% _ = socket:setopt(Sock, otp, debug, false),
<a name="2673"/> 2673:                                   Res
<a name="2674"/> 2674:                           end,
<a name="2675"/> 2675:                    Recv = fun(Sock) -&gt;
<a name="2676"/> 2676:                                   socket:recv(Sock)
<a name="2677"/> 2677:                           end,
<a name="2678"/> 2678:                    InitState = #{domain =&gt; inet6,
<a name="2679"/> 2679:                                  type   =&gt; stream,
<a name="2680"/> 2680:                                  proto  =&gt; tcp,
<a name="2681"/> 2681:                                  send   =&gt; Send,
<a name="2682"/> 2682:                                  recv   =&gt; Recv},
<a name="2683"/> 2683:                    ok = api_b_sendv(InitState)
<a name="2684"/> 2684:            end).
<a name="2685"/> 2685: 
<a name="2686"/> 2686: 
<a name="2687"/> 2687: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2688"/> 2688: 
<a name="api_b_sendv-1"/><a name="2689"/> 2689: <b>api_b_sendv</b>(InitState) -&gt;
<a name="2690"/> 2690:     process_flag(trap_exit, true),
<a name="2691"/> 2691: 
<a name="2692"/> 2692:     ServerSeq = 
<a name="2693"/> 2693:         [
<a name="2694"/> 2694:          %% *** Wait for start order ***
<a name="2695"/> 2695:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="2696"/> 2696:            cmd  =&gt; fun(State) -&gt;
<a name="2697"/> 2697:                            Tester = ?SEV_AWAIT_START(),
<a name="2698"/> 2698:                            {ok, State#{tester =&gt; Tester}}
<a name="2699"/> 2699:                    end},
<a name="2700"/> 2700:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="2701"/> 2701:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2702"/> 2702:                            _MRef = erlang:monitor(process, Tester),
<a name="2703"/> 2703:                            ok
<a name="2704"/> 2704:                    end},
<a name="2705"/> 2705: 
<a name="2706"/> 2706:          %% *** Init part ***
<a name="2707"/> 2707:          #{desc =&gt; &quot;which local address&quot;,
<a name="2708"/> 2708:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="2709"/> 2709:                            LSA = which_local_socket_addr(Domain),
<a name="2710"/> 2710: 			   ?SEV_IPRINT(&quot;LSA: ~p&quot;, [LSA]),
<a name="2711"/> 2711:                            {ok, State#{lsa =&gt; LSA}}
<a name="2712"/> 2712:                    end},
<a name="2713"/> 2713:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="2714"/> 2714:            cmd  =&gt; fun(#{domain := Domain,
<a name="2715"/> 2715:                          type   := Type,
<a name="2716"/> 2716:                          proto  := Proto} = State) -&gt;
<a name="2717"/> 2717:                            case socket:open(Domain, Type, Proto) of
<a name="2718"/> 2718:                                {ok, Sock} -&gt;
<a name="2719"/> 2719:                                    {ok, State#{lsock =&gt; Sock}};
<a name="2720"/> 2720:                                {error, eprotonosupport = Reason} -&gt;
<a name="2721"/> 2721:                                    {skip, Reason};
<a name="2722"/> 2722:                                {error, _} = ERROR -&gt;
<a name="2723"/> 2723:                                    ERROR
<a name="2724"/> 2724:                            end
<a name="2725"/> 2725:                    end},
<a name="2726"/> 2726:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="2727"/> 2727:            cmd  =&gt; fun(#{domain := local,
<a name="2728"/> 2728:                          lsock  := LSock,
<a name="2729"/> 2729:                          lsa    := LSA} = _State) -&gt;
<a name="2730"/> 2730: 			   ?SEV_IPRINT(&quot;try bind to: &quot;
<a name="2731"/> 2731: 				       &quot;~n   ~p&quot;, [LSA]),
<a name="2732"/> 2732: 			   %% _ = socket:setopt(LSock, otp, debug, true),
<a name="2733"/> 2733:                            case socket:bind(LSock, LSA) of
<a name="2734"/> 2734:                                ok -&gt;
<a name="2735"/> 2735:                                    %% We do not care about the port for local
<a name="2736"/> 2736: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2737"/> 2737:                                    ok;
<a name="2738"/> 2738:                                {error, Reason} = ERROR -&gt;
<a name="2739"/> 2739: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2740"/> 2740: 				   ?SEV_EPRINT(&quot;failed binding: &quot;
<a name="2741"/> 2741: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="2742"/> 2742:                                    ERROR
<a name="2743"/> 2743:                            end;
<a name="2744"/> 2744:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="2745"/> 2745:                            case sock_bind(LSock, LSA) of
<a name="2746"/> 2746:                                ok -&gt;
<a name="2747"/> 2747:                                    Port = sock_port(LSock),
<a name="2748"/> 2748:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="2749"/> 2749:                                    {ok, State#{lport =&gt; Port}};
<a name="2750"/> 2750:                                {error, _} = ERROR -&gt;
<a name="2751"/> 2751:                                    ERROR
<a name="2752"/> 2752:                            end
<a name="2753"/> 2753:                    end},
<a name="2754"/> 2754:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="2755"/> 2755:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="2756"/> 2756:                            socket:listen(LSock)
<a name="2757"/> 2757:                    end},
<a name="2758"/> 2758:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="2759"/> 2759:            cmd  =&gt; fun(#{domain := local,
<a name="2760"/> 2760:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="2761"/> 2761:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="2762"/> 2762:                            ok;
<a name="2763"/> 2763:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="2764"/> 2764:                            %% This is actually not used for unix domain socket
<a name="2765"/> 2765:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="2766"/> 2766:                            ok
<a name="2767"/> 2767:                    end},
<a name="2768"/> 2768: 
<a name="2769"/> 2769:          %% The actual test
<a name="2770"/> 2770:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="2771"/> 2771:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2772"/> 2772:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="2773"/> 2773:                    end},
<a name="2774"/> 2774:          #{desc =&gt; &quot;await connection&quot;,
<a name="2775"/> 2775:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="2776"/> 2776: 			   %% _ = socket:setopt(LSock, otp, debug, true),
<a name="2777"/> 2777: 			   ?SEV_IPRINT(&quot;try accept&quot;),
<a name="2778"/> 2778:                            case socket:accept(LSock) of
<a name="2779"/> 2779:                                {ok, Sock} -&gt;
<a name="2780"/> 2780: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2781"/> 2781:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="2782"/> 2782:                                    {ok, State#{csock =&gt; Sock}};
<a name="2783"/> 2783:                                {error, Reason} = ERROR -&gt;
<a name="2784"/> 2784: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2785"/> 2785:                                    ?SEV_EPRINT(&quot;accept failed: &quot;
<a name="2786"/> 2786: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="2787"/> 2787:                                    ERROR
<a name="2788"/> 2788:                            end
<a name="2789"/> 2789:                    end},
<a name="2790"/> 2790:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="2791"/> 2791:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2792"/> 2792:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="2793"/> 2793:                            ok
<a name="2794"/> 2794:                    end},
<a name="2795"/> 2795: 
<a name="2796"/> 2796:          #{desc =&gt; &quot;await (recv) request&quot;,
<a name="2797"/> 2797:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="2798"/> 2798:                            Rep = ?REQ_IOV_RCV,
<a name="2799"/> 2799:                            case Recv(Sock) of
<a name="2800"/> 2800:                                {ok, Rep} -&gt;
<a name="2801"/> 2801:                                    ok;
<a name="2802"/> 2802:                                {error, _} = ERROR -&gt;
<a name="2803"/> 2803:                                    ERROR
<a name="2804"/> 2804:                            end
<a name="2805"/> 2805:                    end},
<a name="2806"/> 2806: 
<a name="2807"/> 2807:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="2808"/> 2808:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2809"/> 2809:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="2810"/> 2810:                            ok
<a name="2811"/> 2811:                    end},
<a name="2812"/> 2812:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="2813"/> 2813:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2814"/> 2814:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="2815"/> 2815:                    end},
<a name="2816"/> 2816:          #{desc =&gt; &quot;send reply&quot;,
<a name="2817"/> 2817:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="2818"/> 2818:                            Send(Sock, ?REP_IOV_SND)
<a name="2819"/> 2819:                    end},
<a name="2820"/> 2820:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="2821"/> 2821:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2822"/> 2822:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="2823"/> 2823:                            ok
<a name="2824"/> 2824:                    end},
<a name="2825"/> 2825: 
<a name="2826"/> 2826:          %% *** Termination ***
<a name="2827"/> 2827:          #{desc =&gt; &quot;await terminate&quot;,
<a name="2828"/> 2828:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="2829"/> 2829:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="2830"/> 2830:                                ok -&gt;
<a name="2831"/> 2831:                                    {ok, maps:remove(tester, State)};
<a name="2832"/> 2832:                                {error, _} = ERROR -&gt;
<a name="2833"/> 2833:                                    ERROR
<a name="2834"/> 2834:                            end
<a name="2835"/> 2835:                    end},
<a name="2836"/> 2836:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="2837"/> 2837:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="2838"/> 2838:                            ok = socket:close(Sock),
<a name="2839"/> 2839:                            {ok, maps:remove(csock, State)}
<a name="2840"/> 2840:                    end},
<a name="2841"/> 2841:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="2842"/> 2842:            cmd  =&gt; fun(#{domain   := local,
<a name="2843"/> 2843:                          lsock    := Sock,
<a name="2844"/> 2844:                          local_sa := #{path := Path}} = State) -&gt;
<a name="2845"/> 2845:                            ok = socket:close(Sock),
<a name="2846"/> 2846:                            State1 =
<a name="2847"/> 2847:                                unlink_path(Path,
<a name="2848"/> 2848:                                            fun() -&gt;
<a name="2849"/> 2849:                                                    maps:remove(local_sa, State)
<a name="2850"/> 2850:                                            end,
<a name="2851"/> 2851:                                            fun() -&gt; State end),
<a name="2852"/> 2852:                            {ok, maps:remove(lsock, State1)};
<a name="2853"/> 2853:                       (#{lsock := LSock} = State) -&gt;
<a name="2854"/> 2854:                            case socket:close(LSock) of
<a name="2855"/> 2855:                                ok -&gt;
<a name="2856"/> 2856:                                    {ok, maps:remove(lsock, State)};
<a name="2857"/> 2857:                                {error, _} = ERROR -&gt;
<a name="2858"/> 2858:                                    ERROR
<a name="2859"/> 2859:                            end
<a name="2860"/> 2860:                    end},
<a name="2861"/> 2861: 
<a name="2862"/> 2862:          %% *** We are done ***
<a name="2863"/> 2863:          ?SEV_FINISH_NORMAL
<a name="2864"/> 2864:         ],
<a name="2865"/> 2865: 
<a name="2866"/> 2866:     ClientSeq =
<a name="2867"/> 2867:         [
<a name="2868"/> 2868:          %% *** Wait for start order ***
<a name="2869"/> 2869:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="2870"/> 2870:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="2871"/> 2871:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="2872"/> 2872:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="2873"/> 2873:                       (State) -&gt;
<a name="2874"/> 2874:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="2875"/> 2875:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="2876"/> 2876:                    end},
<a name="2877"/> 2877:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="2878"/> 2878:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2879"/> 2879:                            _MRef = erlang:monitor(process, Tester),
<a name="2880"/> 2880:                            ok
<a name="2881"/> 2881:                    end},
<a name="2882"/> 2882: 
<a name="2883"/> 2883:          %% *** The init part ***
<a name="2884"/> 2884:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="2885"/> 2885:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="2886"/> 2886:                          server_path := Path} = State) -&gt;
<a name="2887"/> 2887:                            LSA = which_local_socket_addr(Domain),
<a name="2888"/> 2888:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="2889"/> 2889:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="2890"/> 2890:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="2891"/> 2891:                            LSA = which_local_socket_addr(Domain),
<a name="2892"/> 2892:                            SSA = LSA#{port =&gt; Port},
<a name="2893"/> 2893:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="2894"/> 2894:                    end},
<a name="2895"/> 2895:          #{desc =&gt; &quot;create socket&quot;,
<a name="2896"/> 2896:            cmd  =&gt; fun(#{domain := Domain,
<a name="2897"/> 2897:                          type := Type,
<a name="2898"/> 2898:                          proto  := Proto} = State) -&gt;
<a name="2899"/> 2899:                            case socket:open(Domain, Type, Proto) of
<a name="2900"/> 2900:                                {ok, Sock} -&gt;
<a name="2901"/> 2901:                                    {ok, State#{sock =&gt; Sock}};
<a name="2902"/> 2902:                                {error, _} = ERROR -&gt;
<a name="2903"/> 2903:                                    ERROR
<a name="2904"/> 2904:                            end
<a name="2905"/> 2905:                    end},
<a name="2906"/> 2906:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="2907"/> 2907:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="2908"/> 2908:                            case sock_bind(Sock, LSA) of
<a name="2909"/> 2909:                                ok -&gt;
<a name="2910"/> 2910:                                    ok;
<a name="2911"/> 2911:                                {error, _} = ERROR -&gt;
<a name="2912"/> 2912:                                    ERROR
<a name="2913"/> 2913:                            end
<a name="2914"/> 2914:                    end},
<a name="2915"/> 2915:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="2916"/> 2916:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2917"/> 2917:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="2918"/> 2918:                            ok
<a name="2919"/> 2919:                    end},
<a name="2920"/> 2920: 
<a name="2921"/> 2921:          %% *** The actual test ***
<a name="2922"/> 2922:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="2923"/> 2923:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="2924"/> 2924:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="2925"/> 2925:                    end},
<a name="2926"/> 2926:          #{desc =&gt; &quot;connect to server&quot;,
<a name="2927"/> 2927:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="2928"/> 2928:                            socket:connect(Sock, SSA)
<a name="2929"/> 2929:                    end},
<a name="2930"/> 2930:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="2931"/> 2931:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2932"/> 2932:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="2933"/> 2933:                            ok
<a name="2934"/> 2934:                    end},
<a name="2935"/> 2935:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="2936"/> 2936:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="2937"/> 2937:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="2938"/> 2938:                    end},
<a name="2939"/> 2939: 
<a name="2940"/> 2940:          #{desc =&gt; &quot;send request (to server)&quot;,
<a name="2941"/> 2941:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="2942"/> 2942:                            Send(Sock, ?REQ_IOV_SND)
<a name="2943"/> 2943:                    end},
<a name="2944"/> 2944: 
<a name="2945"/> 2945:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="2946"/> 2946:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2947"/> 2947:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="2948"/> 2948:                            ok
<a name="2949"/> 2949:                    end},
<a name="2950"/> 2950:          #{desc =&gt; &quot;await recv reply (from server)&quot;,
<a name="2951"/> 2951:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="2952"/> 2952:                            Rep = ?REP_IOV_RCV,
<a name="2953"/> 2953:                            {ok, Rep} = Recv(Sock),
<a name="2954"/> 2954:                            ok
<a name="2955"/> 2955:                    end},
<a name="2956"/> 2956:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="2957"/> 2957:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2958"/> 2958:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="2959"/> 2959:                            ok
<a name="2960"/> 2960:                    end},
<a name="2961"/> 2961: 
<a name="2962"/> 2962:          %% *** Termination ***
<a name="2963"/> 2963:          #{desc =&gt; &quot;await terminate&quot;,
<a name="2964"/> 2964:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="2965"/> 2965:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="2966"/> 2966:                                ok -&gt;
<a name="2967"/> 2967:                                    {ok, maps:remove(tester, State)};
<a name="2968"/> 2968:                                {error, _} = ERROR -&gt;
<a name="2969"/> 2969:                                    ERROR
<a name="2970"/> 2970:                            end
<a name="2971"/> 2971:                    end},
<a name="2972"/> 2972:          #{desc =&gt; &quot;close socket&quot;,
<a name="2973"/> 2973:            cmd  =&gt; fun(#{domain   := local,
<a name="2974"/> 2974:                          sock     := Sock,
<a name="2975"/> 2975:                          local_sa := #{path := Path}} = State) -&gt;
<a name="2976"/> 2976:                            ok = socket:close(Sock),
<a name="2977"/> 2977:                            State1 =
<a name="2978"/> 2978:                                unlink_path(Path,
<a name="2979"/> 2979:                                            fun() -&gt;
<a name="2980"/> 2980:                                                    maps:remove(local_sa, State)
<a name="2981"/> 2981:                                            end,
<a name="2982"/> 2982:                                            fun() -&gt; State end),
<a name="2983"/> 2983:                            {ok, maps:remove(sock, State1)};
<a name="2984"/> 2984:                       (#{sock := Sock} = State) -&gt;
<a name="2985"/> 2985:                            ok = socket:close(Sock),
<a name="2986"/> 2986:                            {ok, maps:remove(sock, State)}
<a name="2987"/> 2987:                    end},
<a name="2988"/> 2988: 
<a name="2989"/> 2989:          %% *** We are done ***
<a name="2990"/> 2990:          ?SEV_FINISH_NORMAL
<a name="2991"/> 2991:         ],
<a name="2992"/> 2992: 
<a name="2993"/> 2993:     TesterSeq =
<a name="2994"/> 2994:         [
<a name="2995"/> 2995:          %% *** Init part ***
<a name="2996"/> 2996:          #{desc =&gt; &quot;monitor server&quot;,
<a name="2997"/> 2997:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="2998"/> 2998:                            _MRef = erlang:monitor(process, Pid),
<a name="2999"/> 2999:                            ok
<a name="3000"/> 3000:                    end},
<a name="3001"/> 3001:          #{desc =&gt; &quot;monitor client&quot;,
<a name="3002"/> 3002:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="3003"/> 3003:                            _MRef = erlang:monitor(process, Pid),
<a name="3004"/> 3004:                            ok
<a name="3005"/> 3005:                    end},
<a name="3006"/> 3006: 
<a name="3007"/> 3007:          %% Start the server
<a name="3008"/> 3008:          #{desc =&gt; &quot;order server start&quot;,
<a name="3009"/> 3009:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="3010"/> 3010:                            ?SEV_ANNOUNCE_START(Pid),
<a name="3011"/> 3011:                            ok
<a name="3012"/> 3012:                    end},
<a name="3013"/> 3013:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="3014"/> 3014:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="3015"/> 3015:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="3016"/> 3016:                            {ok, State#{server_port =&gt; Port}}
<a name="3017"/> 3017:                    end},
<a name="3018"/> 3018: 
<a name="3019"/> 3019:          %% Start the client
<a name="3020"/> 3020:          #{desc =&gt; &quot;order client start&quot;,
<a name="3021"/> 3021:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="3022"/> 3022:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="3023"/> 3023:                            ok
<a name="3024"/> 3024:                    end},
<a name="3025"/> 3025:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="3026"/> 3026:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="3027"/> 3027:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="3028"/> 3028:                    end},
<a name="3029"/> 3029: 
<a name="3030"/> 3030:          %% *** The actual test ***
<a name="3031"/> 3031:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="3032"/> 3032:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3033"/> 3033:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="3034"/> 3034:                            ok
<a name="3035"/> 3035:                    end},
<a name="3036"/> 3036:          ?SEV_SLEEP(?SECS(1)),
<a name="3037"/> 3037:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="3038"/> 3038:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3039"/> 3039:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="3040"/> 3040:                            ok
<a name="3041"/> 3041:                    end},
<a name="3042"/> 3042:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="3043"/> 3043:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3044"/> 3044:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="3045"/> 3045:                    end},
<a name="3046"/> 3046:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="3047"/> 3047:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3048"/> 3048:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="3049"/> 3049:                    end},
<a name="3050"/> 3050:          #{desc =&gt; &quot;order client to continue (with send request)&quot;,
<a name="3051"/> 3051:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3052"/> 3052:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="3053"/> 3053:                            ok
<a name="3054"/> 3054:                    end},
<a name="3055"/> 3055:          #{desc =&gt; &quot;await client ready (with send request)&quot;,
<a name="3056"/> 3056:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3057"/> 3057:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="3058"/> 3058:                    end},
<a name="3059"/> 3059:          #{desc =&gt; &quot;await server ready (request recv)&quot;,
<a name="3060"/> 3060:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3061"/> 3061:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="3062"/> 3062:                    end},
<a name="3063"/> 3063:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="3064"/> 3064:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3065"/> 3065:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="3066"/> 3066:                            ok
<a name="3067"/> 3067:                    end},
<a name="3068"/> 3068:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="3069"/> 3069:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3070"/> 3070:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="3071"/> 3071:                    end},
<a name="3072"/> 3072:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="3073"/> 3073:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3074"/> 3074:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="3075"/> 3075:                    end},
<a name="3076"/> 3076: 
<a name="3077"/> 3077: 
<a name="3078"/> 3078:          %% *** Termination ***
<a name="3079"/> 3079:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="3080"/> 3080:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3081"/> 3081:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="3082"/> 3082:                            ok
<a name="3083"/> 3083:                    end},
<a name="3084"/> 3084:          #{desc =&gt; &quot;await client termination&quot;,
<a name="3085"/> 3085:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="3086"/> 3086:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="3087"/> 3087:                            State1 = maps:remove(client, State),
<a name="3088"/> 3088:                            {ok, State1}
<a name="3089"/> 3089:                    end},
<a name="3090"/> 3090:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="3091"/> 3091:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3092"/> 3092:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="3093"/> 3093:                            ok
<a name="3094"/> 3094:                    end},
<a name="3095"/> 3095:          #{desc =&gt; &quot;await server termination&quot;,
<a name="3096"/> 3096:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="3097"/> 3097:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="3098"/> 3098:                            State1 = maps:remove(server, State),
<a name="3099"/> 3099:                            {ok, State1}
<a name="3100"/> 3100:                    end},
<a name="3101"/> 3101: 
<a name="3102"/> 3102:          %% *** We are done ***
<a name="3103"/> 3103:          ?SEV_FINISH_NORMAL
<a name="3104"/> 3104:         ],
<a name="3105"/> 3105: 
<a name="3106"/> 3106:     i(&quot;start server evaluator&quot;),
<a name="3107"/> 3107:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="3108"/> 3108: 
<a name="3109"/> 3109:     i(&quot;start client evaluator&quot;),
<a name="3110"/> 3110:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="3111"/> 3111:     i(&quot;await evaluator(s)&quot;),
<a name="3112"/> 3112: 
<a name="3113"/> 3113:     i(&quot;start tester evaluator&quot;),
<a name="3114"/> 3114:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="3115"/> 3115:                         client =&gt; Client#ev.pid},
<a name="3116"/> 3116:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="3117"/> 3117: 
<a name="api_b_sendv-last_expr"/><a name="3118"/> 3118: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="3119"/> 3119: 
<a name="3120"/> 3120: 
<a name="3121"/> 3121: 
<a name="3122"/> 3122: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3123"/> 3123: 
<a name="3124"/> 3124: <i>%% Basically send and receive on an IPv4 SCTP (stream) socket</i>
<a name="3125"/> 3125: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_stream_sctp4-1"/><a name="3126"/> 3126: <b>api_b_sendmsg_and_recvmsg_stream_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3127"/> 3127:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_stream_sctp4-last_expr"/><a name="3128"/> 3128: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3129"/> 3129:            fun() -&gt;
<a name="3130"/> 3130: 		   has_support_sctp(),
<a name="3131"/> 3131:                    has_support_ipv4()%% ,
<a name="3132"/> 3132: 		   %% not_yet_implemented()
<a name="3133"/> 3133: 	   end,
<a name="3134"/> 3134:            fun() -&gt;
<a name="3135"/> 3135:                    Send = fun(Sock, Data) -&gt;
<a name="3136"/> 3136:                                   %% CMsg  = #{level =&gt; sctp,
<a name="3137"/> 3137:                                   %%              type  =&gt; tos,
<a name="3138"/> 3138:                                   %%              data  =&gt; reliability},
<a name="3139"/> 3139:                                   %% CMsgs = [CMsg],
<a name="3140"/> 3140:                                   Msg = #{%% ctrl =&gt; CMsgs,
<a name="3141"/> 3141:                                           iov  =&gt; [Data]},
<a name="3142"/> 3142:                                   socket:sendmsg(Sock, Msg)
<a name="3143"/> 3143:                           end,
<a name="3144"/> 3144:                    Recv = fun(Sock) -&gt;
<a name="3145"/> 3145:                                   case socket:recvmsg(Sock) of
<a name="3146"/> 3146:                                       {ok, #{flags := [eor],
<a name="3147"/> 3147:                                              addr  := _,
<a name="3148"/> 3148:                                              iov   := [Data]}} -&gt;
<a name="3149"/> 3149:                                           {ok, Data};
<a name="3150"/> 3150:                                       {ok, Msg} -&gt;
<a name="3151"/> 3151:                                           {error, {msg, Msg}};
<a name="3152"/> 3152:                                       %% {ok, #{addr  := Source,
<a name="3153"/> 3153:                                       %%        iov   := [Data]}} -&gt;
<a name="3154"/> 3154:                                       %%     {ok, {Source, Data}};
<a name="3155"/> 3155:                                       {error, _} = ERROR -&gt;
<a name="3156"/> 3156:                                           ERROR
<a name="3157"/> 3157:                                   end
<a name="3158"/> 3158:                           end,
<a name="3159"/> 3159:                    InitState = #{domain =&gt; inet,
<a name="3160"/> 3160:                                  type   =&gt; stream,
<a name="3161"/> 3161:                                  proto  =&gt; sctp,
<a name="3162"/> 3162:                                  send   =&gt; Send,
<a name="3163"/> 3163:                                  recv   =&gt; Recv},
<a name="3164"/> 3164:                    %% ok = api_b_send_and_recv_sctp(InitState)
<a name="3165"/> 3165:                    ok = api_b_send_and_recv_conn(InitState)
<a name="3166"/> 3166:            end).
<a name="3167"/> 3167: 
<a name="3168"/> 3168: 
<a name="3169"/> 3169: 
<a name="3170"/> 3170: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3171"/> 3171: 
<a name="3172"/> 3172: <i>%% api_b_send_and_recv_sctp(_InitState) -&gt;</i>
<a name="3173"/> 3173: <i>%%     Seq = </i>
<a name="3174"/> 3174: <i>%%         [</i>
<a name="3175"/> 3175: <i>%%          #{desc =&gt; &quot;local address&quot;,</i>
<a name="3176"/> 3176: <i>%%            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;</i>
<a name="3177"/> 3177: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="3178"/> 3178: <i>%%                            {ok, State#{lsa_src =&gt; LSA,</i>
<a name="3179"/> 3179: <i>%%                                        lsa_dst =&gt; LSA}}</i>
<a name="3180"/> 3180: <i>%%                    end},</i>
<a name="3181"/> 3181: 
<a name="3182"/> 3182: <i>%%          #{desc =&gt; &quot;open src socket&quot;,</i>
<a name="3183"/> 3183: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="3184"/> 3184: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="3185"/> 3185: <i>%%                            Sock = sock_open(Domain, seqpacket, Proto),</i>
<a name="3186"/> 3186: <i>%%                            {ok, State#{sock_src =&gt; Sock}}</i>
<a name="3187"/> 3187: <i>%%                    end},</i>
<a name="3188"/> 3188: <i>%%          #{desc =&gt; &quot;bind src&quot;,</i>
<a name="3189"/> 3189: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;</i>
<a name="3190"/> 3190: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="3191"/> 3191: <i>%%                                ok -&gt;</i>
<a name="3192"/> 3192: <i>%%                                    ?SEV_IPRINT(&quot;src bound&quot;),</i>
<a name="3193"/> 3193: <i>%%                                    ok;</i>
<a name="3194"/> 3194: <i>%%                                {error, Reason} = ERROR -&gt;</i>
<a name="3195"/> 3195: <i>%%                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),</i>
<a name="3196"/> 3196: <i>%%                                    ERROR</i>
<a name="3197"/> 3197: <i>%%                            end</i>
<a name="3198"/> 3198: <i>%%                    end},</i>
<a name="3199"/> 3199: <i>%%          #{desc =&gt; &quot;sockname src socket&quot;,</i>
<a name="3200"/> 3200: <i>%%            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;</i>
<a name="3201"/> 3201: <i>%%                            SASrc = sock_sockname(Sock),</i>
<a name="3202"/> 3202: <i>%%                            ?SEV_IPRINT(&quot;src sockaddr: &quot;</i>
<a name="3203"/> 3203: <i>%%                                        &quot;~n   ~p&quot;, [SASrc]),</i>
<a name="3204"/> 3204: <i>%%                            {ok, State#{sa_src =&gt; SASrc}}</i>
<a name="3205"/> 3205: <i>%%                    end},</i>
<a name="3206"/> 3206: 
<a name="3207"/> 3207: <i>%%          #{desc =&gt; &quot;open dst socket&quot;,</i>
<a name="3208"/> 3208: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="3209"/> 3209: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="3210"/> 3210: <i>%%                            Sock = sock_open(Domain, seqpacket, Proto),</i>
<a name="3211"/> 3211: <i>%%                            {ok, State#{sock_dst =&gt; Sock}}</i>
<a name="3212"/> 3212: <i>%%                    end},</i>
<a name="3213"/> 3213: <i>%%          #{desc =&gt; &quot;bind dst&quot;,</i>
<a name="3214"/> 3214: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;</i>
<a name="3215"/> 3215: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="3216"/> 3216: <i>%%                                ok -&gt;</i>
<a name="3217"/> 3217: <i>%%                                    ?SEV_IPRINT(&quot;src bound&quot;),</i>
<a name="3218"/> 3218: <i>%%                                    ok;</i>
<a name="3219"/> 3219: <i>%%                                {error, Reason} = ERROR -&gt;</i>
<a name="3220"/> 3220: <i>%%                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),</i>
<a name="3221"/> 3221: <i>%%                                    ERROR</i>
<a name="3222"/> 3222: <i>%%                            end</i>
<a name="3223"/> 3223: <i>%%                    end},</i>
<a name="3224"/> 3224: <i>%%          #{desc =&gt; &quot;sockname dst socket&quot;,</i>
<a name="3225"/> 3225: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;</i>
<a name="3226"/> 3226: <i>%%                            SADst = sock_sockname(Sock),</i>
<a name="3227"/> 3227: <i>%%                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;</i>
<a name="3228"/> 3228: <i>%%                                        &quot;~n   ~p&quot;, [SADst]),</i>
<a name="3229"/> 3229: <i>%%                            {ok, State#{sa_dst =&gt; SADst}}</i>
<a name="3230"/> 3230: <i>%%                    end},</i>
<a name="3231"/> 3231: <i>%%          #{desc =&gt; &quot;send req (to dst)&quot;,</i>
<a name="3232"/> 3232: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;</i>
<a name="3233"/> 3233: <i>%%                            Send(Sock, ?BASIC_REQ, Dst)</i>
<a name="3234"/> 3234: <i>%%                    end},</i>
<a name="3235"/> 3235: <i>%%          #{desc =&gt; &quot;recv req (from src)&quot;,</i>
<a name="3236"/> 3236: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;</i>
<a name="3237"/> 3237: <i>%%                            case Recv(Sock) of</i>
<a name="3238"/> 3238: <i>%%                                {ok, {Src, ?BASIC_REQ}} -&gt;</i>
<a name="3239"/> 3239: <i>%%                                    ok;</i>
<a name="3240"/> 3240: <i>%%                                {ok, UnexpData} -&gt;</i>
<a name="3241"/> 3241: <i>%%                                    {error, {unexpected_data, UnexpData}};</i>
<a name="3242"/> 3242: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3243"/> 3243: <i>%%                                    %% At the moment there is no way to get</i>
<a name="3244"/> 3244: <i>%%                                    %% status or state for the socket...</i>
<a name="3245"/> 3245: <i>%%                                    ERROR</i>
<a name="3246"/> 3246: <i>%%                            end</i>
<a name="3247"/> 3247: <i>%%                    end},</i>
<a name="3248"/> 3248: <i>%%          #{desc =&gt; &quot;send rep (to src)&quot;,</i>
<a name="3249"/> 3249: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;</i>
<a name="3250"/> 3250: <i>%%                            Send(Sock, ?BASIC_REP, Src)</i>
<a name="3251"/> 3251: <i>%%                    end},</i>
<a name="3252"/> 3252: <i>%%          #{desc =&gt; &quot;recv rep (from dst)&quot;,</i>
<a name="3253"/> 3253: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;</i>
<a name="3254"/> 3254: <i>%%                            case Recv(Sock) of</i>
<a name="3255"/> 3255: <i>%%                                {ok, {Dst, ?BASIC_REP}} -&gt;</i>
<a name="3256"/> 3256: <i>%%                                    ok;</i>
<a name="3257"/> 3257: <i>%%                                {ok, UnexpData} -&gt;</i>
<a name="3258"/> 3258: <i>%%                                    {error, {unexpected_data, UnexpData}};</i>
<a name="3259"/> 3259: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3260"/> 3260: <i>%%                                    %% At the moment there is no way to get</i>
<a name="3261"/> 3261: <i>%%                                    %% status or state for the socket...</i>
<a name="3262"/> 3262: <i>%%                                    ERROR</i>
<a name="3263"/> 3263: <i>%%                            end</i>
<a name="3264"/> 3264: <i>%%                    end},</i>
<a name="3265"/> 3265: <i>%%          #{desc =&gt; &quot;close src socket&quot;,</i>
<a name="3266"/> 3266: <i>%%            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;</i>
<a name="3267"/> 3267: <i>%%                            ok = socket:close(Sock),</i>
<a name="3268"/> 3268: <i>%%                            {ok, maps:remove(sock_src, State)}</i>
<a name="3269"/> 3269: <i>%%                    end},</i>
<a name="3270"/> 3270: <i>%%          #{desc =&gt; &quot;close dst socket&quot;,</i>
<a name="3271"/> 3271: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;</i>
<a name="3272"/> 3272: <i>%%                            ok = socket:close(Sock),</i>
<a name="3273"/> 3273: <i>%%                            {ok, maps:remove(sock_dst, State)}</i>
<a name="3274"/> 3274: <i>%%                    end},</i>
<a name="3275"/> 3275: 
<a name="3276"/> 3276: <i>%%          %% *** We are done ***</i>
<a name="3277"/> 3277: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="3278"/> 3278: <i>%%         ],</i>
<a name="3279"/> 3279: <i>%%     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),</i>
<a name="3280"/> 3280: <i>%%     ok = ?SEV_AWAIT_FINISH([Evaluator]).</i>
<a name="3281"/> 3281: 
<a name="3282"/> 3282: <i>%%     process_flag(trap_exit, true),</i>
<a name="3283"/> 3283: <i>%%     ServerSeq = </i>
<a name="3284"/> 3284: <i>%%         [</i>
<a name="3285"/> 3285: <i>%%          %% *** Wait for start order ***</i>
<a name="3286"/> 3286: <i>%%          #{desc =&gt; &quot;await start (from tester)&quot;,</i>
<a name="3287"/> 3287: <i>%%            cmd  =&gt; fun(State) -&gt;</i>
<a name="3288"/> 3288: <i>%%                            Tester = ?SEV_AWAIT_START(),</i>
<a name="3289"/> 3289: <i>%%                            {ok, State#{tester =&gt; Tester}}</i>
<a name="3290"/> 3290: <i>%%                    end},</i>
<a name="3291"/> 3291: <i>%%          #{desc =&gt; &quot;monitor tester&quot;,</i>
<a name="3292"/> 3292: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3293"/> 3293: <i>%%                            _MRef = erlang:monitor(process, Tester),</i>
<a name="3294"/> 3294: <i>%%                            ok</i>
<a name="3295"/> 3295: <i>%%                    end},</i>
<a name="3296"/> 3296: 
<a name="3297"/> 3297: <i>%%          %% *** Init part ***</i>
<a name="3298"/> 3298: <i>%%          #{desc =&gt; &quot;which local address&quot;,</i>
<a name="3299"/> 3299: <i>%%            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;</i>
<a name="3300"/> 3300: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="3301"/> 3301: <i>%%                            {ok, State#{lsa =&gt; LSA}}</i>
<a name="3302"/> 3302: <i>%%                    end},</i>
<a name="3303"/> 3303: <i>%%          #{desc =&gt; &quot;create (listen) socket&quot;,</i>
<a name="3304"/> 3304: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="3305"/> 3305: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="3306"/> 3306: <i>%%                            case socket:open(Domain, seqpacket, Proto) of</i>
<a name="3307"/> 3307: <i>%%                                {ok, Sock} -&gt;</i>
<a name="3308"/> 3308: <i>%%                                    {ok, State#{lsock =&gt; Sock}};</i>
<a name="3309"/> 3309: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3310"/> 3310: <i>%%                                    ERROR</i>
<a name="3311"/> 3311: <i>%%                            end</i>
<a name="3312"/> 3312: <i>%%                    end},</i>
<a name="3313"/> 3313: <i>%%          #{desc =&gt; &quot;bind to local address&quot;,</i>
<a name="3314"/> 3314: <i>%%            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;</i>
<a name="3315"/> 3315: <i>%%                            case socket:bind(LSock, LSA) of</i>
<a name="3316"/> 3316: <i>%%                                ok -&gt;</i>
<a name="3317"/> 3317: <i>%%                                    Port = sock_port(LSock),</i>
<a name="3318"/> 3318: <i>%%                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),</i>
<a name="3319"/> 3319: <i>%%                                    {ok, State#{lport =&gt; Port}};</i>
<a name="3320"/> 3320: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3321"/> 3321: <i>%%                                    ERROR</i>
<a name="3322"/> 3322: <i>%%                            end</i>
<a name="3323"/> 3323: <i>%%                    end},</i>
<a name="3324"/> 3324: <i>%%          #{desc =&gt; &quot;make listen socket&quot;,</i>
<a name="3325"/> 3325: <i>%%            cmd  =&gt; fun(#{lsock := LSock}) -&gt;</i>
<a name="3326"/> 3326: <i>%%                            socket:listen(LSock)</i>
<a name="3327"/> 3327: <i>%%                    end},</i>
<a name="3328"/> 3328: <i>%%          #{desc =&gt; &quot;announce ready (init)&quot;,</i>
<a name="3329"/> 3329: <i>%%            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;</i>
<a name="3330"/> 3330: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, init, Port),</i>
<a name="3331"/> 3331: <i>%%                            ok</i>
<a name="3332"/> 3332: <i>%%                    end},</i>
<a name="3333"/> 3333: 
<a name="3334"/> 3334: <i>%%          %% The actual test</i>
<a name="3335"/> 3335: <i>%%          #{desc =&gt; &quot;await continue (accept)&quot;,</i>
<a name="3336"/> 3336: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3337"/> 3337: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)</i>
<a name="3338"/> 3338: <i>%%                    end},</i>
<a name="3339"/> 3339: <i>%%          #{desc =&gt; &quot;accepting (await connection) FAKE&quot;,</i>
<a name="3340"/> 3340: <i>%%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="3341"/> 3341: <i>%% 			   {ok, State#{csock =&gt; LSock}}</i>
<a name="3342"/> 3342: <i>%%                    end},</i>
<a name="3343"/> 3343: <i>%% %%          #{desc =&gt; &quot;accepting (await connection)&quot;,</i>
<a name="3344"/> 3344: <i>%% %%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="3345"/> 3345: <i>%% %% 			   socket:setopt(LSock, otp, debug, true),</i>
<a name="3346"/> 3346: <i>%% %%                            case socket:accept(LSock) of</i>
<a name="3347"/> 3347: <i>%% %%                                {ok, Sock} -&gt;</i>
<a name="3348"/> 3348: <i>%% %% 				   socket:setopt(LSock, otp, debug, false),</i>
<a name="3349"/> 3349: <i>%% %%                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),</i>
<a name="3350"/> 3350: <i>%% %%                                    {ok, State#{csock =&gt; Sock}};</i>
<a name="3351"/> 3351: <i>%% %%                                {error, Reason} = ERROR -&gt;</i>
<a name="3352"/> 3352: <i>%% %% 				   socket:setopt(LSock, otp, debug, false),</i>
<a name="3353"/> 3353: <i>%% %% 				   ?SEV_EPRINT(&quot;Failed accepting: &quot;</i>
<a name="3354"/> 3354: <i>%% %% 					       &quot;~n   ~p&quot;, [Reason]),</i>
<a name="3355"/> 3355: <i>%% %%                                    ERROR</i>
<a name="3356"/> 3356: <i>%% %%                            end</i>
<a name="3357"/> 3357: <i>%% %%                    end},</i>
<a name="3358"/> 3358: <i>%%          #{desc =&gt; &quot;announce ready (accept)&quot;,</i>
<a name="3359"/> 3359: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3360"/> 3360: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, accept),</i>
<a name="3361"/> 3361: <i>%%                            ok</i>
<a name="3362"/> 3362: <i>%%                    end},</i>
<a name="3363"/> 3363: <i>%%          #{desc =&gt; &quot;await (recv) request&quot;,</i>
<a name="3364"/> 3364: <i>%%            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;</i>
<a name="3365"/> 3365: <i>%%                            case Recv(Sock) of</i>
<a name="3366"/> 3366: <i>%%                                {ok, ?BASIC_REQ} -&gt;</i>
<a name="3367"/> 3367: <i>%%                                    ok;</i>
<a name="3368"/> 3368: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3369"/> 3369: <i>%%                                    ERROR</i>
<a name="3370"/> 3370: <i>%%                            end</i>
<a name="3371"/> 3371: <i>%%                    end},</i>
<a name="3372"/> 3372: <i>%%          #{desc =&gt; &quot;announce ready (recv request)&quot;,</i>
<a name="3373"/> 3373: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3374"/> 3374: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, recv_req),</i>
<a name="3375"/> 3375: <i>%%                            ok</i>
<a name="3376"/> 3376: <i>%%                    end},</i>
<a name="3377"/> 3377: <i>%%          #{desc =&gt; &quot;await continue (with send reply)&quot;,</i>
<a name="3378"/> 3378: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3379"/> 3379: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)</i>
<a name="3380"/> 3380: <i>%%                    end},</i>
<a name="3381"/> 3381: <i>%%          #{desc =&gt; &quot;send reply&quot;,</i>
<a name="3382"/> 3382: <i>%%            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;</i>
<a name="3383"/> 3383: <i>%%                            Send(Sock, ?BASIC_REP)</i>
<a name="3384"/> 3384: <i>%%                    end},</i>
<a name="3385"/> 3385: <i>%%          #{desc =&gt; &quot;announce ready (send reply)&quot;,</i>
<a name="3386"/> 3386: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3387"/> 3387: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, send_reply),</i>
<a name="3388"/> 3388: <i>%%                            ok</i>
<a name="3389"/> 3389: <i>%%                    end},</i>
<a name="3390"/> 3390: 
<a name="3391"/> 3391: <i>%%          %% *** Termination ***</i>
<a name="3392"/> 3392: <i>%%          #{desc =&gt; &quot;await terminate&quot;,</i>
<a name="3393"/> 3393: <i>%%            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;</i>
<a name="3394"/> 3394: <i>%%                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of</i>
<a name="3395"/> 3395: <i>%%                                ok -&gt;</i>
<a name="3396"/> 3396: <i>%%                                    {ok, maps:remove(tester, State)};</i>
<a name="3397"/> 3397: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3398"/> 3398: <i>%%                                    ERROR</i>
<a name="3399"/> 3399: <i>%%                            end</i>
<a name="3400"/> 3400: <i>%%                    end},</i>
<a name="3401"/> 3401: <i>%%          #{desc =&gt; &quot;close connection socket&quot;,</i>
<a name="3402"/> 3402: <i>%%            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;</i>
<a name="3403"/> 3403: <i>%%                            ok = socket:close(Sock),</i>
<a name="3404"/> 3404: <i>%%                            {ok, maps:remove(csock, State)}</i>
<a name="3405"/> 3405: <i>%%                    end},</i>
<a name="3406"/> 3406: <i>%%          #{desc =&gt; &quot;close listen socket&quot;,</i>
<a name="3407"/> 3407: <i>%%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="3408"/> 3408: <i>%%                            case socket:close(LSock) of</i>
<a name="3409"/> 3409: <i>%%                                ok -&gt;</i>
<a name="3410"/> 3410: <i>%%                                    {ok, maps:remove(lsock, State)};</i>
<a name="3411"/> 3411: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3412"/> 3412: <i>%%                                    ERROR</i>
<a name="3413"/> 3413: <i>%%                            end</i>
<a name="3414"/> 3414: <i>%%                    end},</i>
<a name="3415"/> 3415: 
<a name="3416"/> 3416: <i>%%          %% *** We are done ***</i>
<a name="3417"/> 3417: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="3418"/> 3418: <i>%%         ],</i>
<a name="3419"/> 3419: 
<a name="3420"/> 3420: <i>%%     ClientSeq = </i>
<a name="3421"/> 3421: <i>%%         [</i>
<a name="3422"/> 3422: <i>%%          %% *** Wait for start order ***</i>
<a name="3423"/> 3423: <i>%%          #{desc =&gt; &quot;await start (from tester)&quot;,</i>
<a name="3424"/> 3424: <i>%%            cmd  =&gt; fun(State) -&gt;</i>
<a name="3425"/> 3425: <i>%%                            {Tester, Port} = ?SEV_AWAIT_START(),</i>
<a name="3426"/> 3426: <i>%%                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}</i>
<a name="3427"/> 3427: <i>%%                    end},</i>
<a name="3428"/> 3428: <i>%%          #{desc =&gt; &quot;monitor tester&quot;,</i>
<a name="3429"/> 3429: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3430"/> 3430: <i>%%                            _MRef = erlang:monitor(process, Tester),</i>
<a name="3431"/> 3431: <i>%%                            ok</i>
<a name="3432"/> 3432: <i>%%                    end},</i>
<a name="3433"/> 3433: 
<a name="3434"/> 3434: <i>%%          %% *** The init part ***</i>
<a name="3435"/> 3435: <i>%%          #{desc =&gt; &quot;which server (local) address&quot;,</i>
<a name="3436"/> 3436: <i>%%            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;</i>
<a name="3437"/> 3437: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="3438"/> 3438: <i>%%                            SSA = LSA#{port =&gt; Port},</i>
<a name="3439"/> 3439: <i>%%                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}</i>
<a name="3440"/> 3440: <i>%%                    end},</i>
<a name="3441"/> 3441: <i>%%          #{desc =&gt; &quot;create socket&quot;,</i>
<a name="3442"/> 3442: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="3443"/> 3443: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="3444"/> 3444: <i>%%                            case socket:open(Domain, seqpacket, Proto) of</i>
<a name="3445"/> 3445: <i>%%                                {ok, Sock} -&gt;</i>
<a name="3446"/> 3446: <i>%%                                    {ok, State#{sock =&gt; Sock}};</i>
<a name="3447"/> 3447: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3448"/> 3448: <i>%%                                    ERROR</i>
<a name="3449"/> 3449: <i>%%                            end</i>
<a name="3450"/> 3450: <i>%%                    end},</i>
<a name="3451"/> 3451: <i>%%          #{desc =&gt; &quot;bind to local address&quot;,</i>
<a name="3452"/> 3452: <i>%%            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;</i>
<a name="3453"/> 3453: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="3454"/> 3454: <i>%%                                ok -&gt;</i>
<a name="3455"/> 3455: <i>%%                                    ok;</i>
<a name="3456"/> 3456: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3457"/> 3457: <i>%%                                    ERROR</i>
<a name="3458"/> 3458: <i>%%                            end</i>
<a name="3459"/> 3459: <i>%%                    end},</i>
<a name="3460"/> 3460: <i>%%          #{desc =&gt; &quot;announce ready (init)&quot;,</i>
<a name="3461"/> 3461: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3462"/> 3462: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, init),</i>
<a name="3463"/> 3463: <i>%%                            ok</i>
<a name="3464"/> 3464: <i>%%                    end},</i>
<a name="3465"/> 3465: 
<a name="3466"/> 3466: <i>%%          %% *** The actual test ***</i>
<a name="3467"/> 3467: <i>%%          #{desc =&gt; &quot;await continue (connect)&quot;,</i>
<a name="3468"/> 3468: <i>%%            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;</i>
<a name="3469"/> 3469: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)</i>
<a name="3470"/> 3470: <i>%%                    end},</i>
<a name="3471"/> 3471: <i>%%          #{desc =&gt; &quot;connect to server&quot;,</i>
<a name="3472"/> 3472: <i>%%            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;</i>
<a name="3473"/> 3473: <i>%%                            case socket:connect(Sock, SSA) of</i>
<a name="3474"/> 3474: <i>%% 			       ok -&gt;</i>
<a name="3475"/> 3475: <i>%% 				   ?SEV_IPRINT(&quot;connected&quot;),</i>
<a name="3476"/> 3476: <i>%% 				   ok;</i>
<a name="3477"/> 3477: <i>%% 			       {error, Reason} = ERROR -&gt;</i>
<a name="3478"/> 3478: <i>%% 				   ?SEV_EPRINT(&quot;Failed connect: &quot;</i>
<a name="3479"/> 3479: <i>%% 					       &quot;~n   ~p&quot;, [Reason]),</i>
<a name="3480"/> 3480: <i>%% 				   ERROR</i>
<a name="3481"/> 3481: <i>%% 			   end</i>
<a name="3482"/> 3482: <i>%%                    end},</i>
<a name="3483"/> 3483: <i>%%          #{desc =&gt; &quot;announce ready (connect)&quot;,</i>
<a name="3484"/> 3484: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3485"/> 3485: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, connect),</i>
<a name="3486"/> 3486: <i>%%                            ok</i>
<a name="3487"/> 3487: <i>%%                    end},</i>
<a name="3488"/> 3488: <i>%%          #{desc =&gt; &quot;await continue (send request)&quot;,</i>
<a name="3489"/> 3489: <i>%%            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;</i>
<a name="3490"/> 3490: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)</i>
<a name="3491"/> 3491: <i>%%                    end},</i>
<a name="3492"/> 3492: <i>%%          #{desc =&gt; &quot;send request (to server)&quot;,</i>
<a name="3493"/> 3493: <i>%%            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;</i>
<a name="3494"/> 3494: <i>%%                            Send(Sock, ?BASIC_REQ)</i>
<a name="3495"/> 3495: <i>%%                    end},</i>
<a name="3496"/> 3496: <i>%%          #{desc =&gt; &quot;announce ready (send request)&quot;,</i>
<a name="3497"/> 3497: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3498"/> 3498: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, send_req),</i>
<a name="3499"/> 3499: <i>%%                            ok</i>
<a name="3500"/> 3500: <i>%%                    end},</i>
<a name="3501"/> 3501: <i>%%          #{desc =&gt; &quot;await recv reply (from server)&quot;,</i>
<a name="3502"/> 3502: <i>%%            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;</i>
<a name="3503"/> 3503: <i>%%                            {ok, ?BASIC_REP} = Recv(Sock),</i>
<a name="3504"/> 3504: <i>%%                            ok</i>
<a name="3505"/> 3505: <i>%%                    end},</i>
<a name="3506"/> 3506: <i>%%          #{desc =&gt; &quot;announce ready (recv reply)&quot;,</i>
<a name="3507"/> 3507: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3508"/> 3508: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),</i>
<a name="3509"/> 3509: <i>%%                            ok</i>
<a name="3510"/> 3510: <i>%%                    end},</i>
<a name="3511"/> 3511: 
<a name="3512"/> 3512: <i>%%          %% *** Termination ***</i>
<a name="3513"/> 3513: <i>%%          #{desc =&gt; &quot;await terminate&quot;,</i>
<a name="3514"/> 3514: <i>%%            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;</i>
<a name="3515"/> 3515: <i>%%                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of</i>
<a name="3516"/> 3516: <i>%%                                ok -&gt;</i>
<a name="3517"/> 3517: <i>%%                                    {ok, maps:remove(tester, State)};</i>
<a name="3518"/> 3518: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3519"/> 3519: <i>%%                                    ERROR</i>
<a name="3520"/> 3520: <i>%%                            end</i>
<a name="3521"/> 3521: <i>%%                    end},</i>
<a name="3522"/> 3522: <i>%%          #{desc =&gt; &quot;close socket&quot;,</i>
<a name="3523"/> 3523: <i>%%            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;</i>
<a name="3524"/> 3524: <i>%%                            ok = socket:close(Sock),</i>
<a name="3525"/> 3525: <i>%%                            {ok, maps:remove(sock, State)}</i>
<a name="3526"/> 3526: <i>%%                    end},</i>
<a name="3527"/> 3527: 
<a name="3528"/> 3528: <i>%%          %% *** We are done ***</i>
<a name="3529"/> 3529: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="3530"/> 3530: <i>%%         ],</i>
<a name="3531"/> 3531: 
<a name="3532"/> 3532: <i>%%     TesterSeq =</i>
<a name="3533"/> 3533: <i>%%         [</i>
<a name="3534"/> 3534: <i>%%          %% *** Init part ***</i>
<a name="3535"/> 3535: <i>%%          #{desc =&gt; &quot;monitor server&quot;,</i>
<a name="3536"/> 3536: <i>%%            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;</i>
<a name="3537"/> 3537: <i>%%                            _MRef = erlang:monitor(process, Pid),</i>
<a name="3538"/> 3538: <i>%%                            ok</i>
<a name="3539"/> 3539: <i>%%                    end},</i>
<a name="3540"/> 3540: <i>%%          #{desc =&gt; &quot;monitor client&quot;,</i>
<a name="3541"/> 3541: <i>%%            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;</i>
<a name="3542"/> 3542: <i>%%                            _MRef = erlang:monitor(process, Pid),</i>
<a name="3543"/> 3543: <i>%%                            ok</i>
<a name="3544"/> 3544: <i>%%                    end},</i>
<a name="3545"/> 3545: 
<a name="3546"/> 3546: <i>%%          %% Start the server</i>
<a name="3547"/> 3547: <i>%%          #{desc =&gt; &quot;order server start&quot;,</i>
<a name="3548"/> 3548: <i>%%            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;</i>
<a name="3549"/> 3549: <i>%%                            ?SEV_ANNOUNCE_START(Pid),</i>
<a name="3550"/> 3550: <i>%%                            ok</i>
<a name="3551"/> 3551: <i>%%                    end},</i>
<a name="3552"/> 3552: <i>%%          #{desc =&gt; &quot;await server ready (init)&quot;,</i>
<a name="3553"/> 3553: <i>%%            cmd  =&gt; fun(#{server := Pid} = State) -&gt;</i>
<a name="3554"/> 3554: <i>%%                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),</i>
<a name="3555"/> 3555: <i>%%                            {ok, State#{server_port =&gt; Port}}</i>
<a name="3556"/> 3556: <i>%%                    end},</i>
<a name="3557"/> 3557: 
<a name="3558"/> 3558: <i>%%          %% Start the client</i>
<a name="3559"/> 3559: <i>%%          #{desc =&gt; &quot;order client start&quot;,</i>
<a name="3560"/> 3560: <i>%%            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;</i>
<a name="3561"/> 3561: <i>%%                            ?SEV_ANNOUNCE_START(Pid, Port),</i>
<a name="3562"/> 3562: <i>%%                            ok</i>
<a name="3563"/> 3563: <i>%%                    end},</i>
<a name="3564"/> 3564: <i>%%          #{desc =&gt; &quot;await client ready (init)&quot;,</i>
<a name="3565"/> 3565: <i>%%            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;</i>
<a name="3566"/> 3566: <i>%%                            ok = ?SEV_AWAIT_READY(Pid, client, init)</i>
<a name="3567"/> 3567: <i>%%                    end},</i>
<a name="3568"/> 3568: 
<a name="3569"/> 3569: <i>%%          %% *** The actual test ***</i>
<a name="3570"/> 3570: <i>%%          #{desc =&gt; &quot;order server to continue (with accept)&quot;,</i>
<a name="3571"/> 3571: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3572"/> 3572: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),</i>
<a name="3573"/> 3573: <i>%%                            ok</i>
<a name="3574"/> 3574: <i>%%                    end},</i>
<a name="3575"/> 3575: <i>%%          ?SEV_SLEEP(?SECS(1)),</i>
<a name="3576"/> 3576: <i>%%          #{desc =&gt; &quot;order client to continue (with connect)&quot;,</i>
<a name="3577"/> 3577: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3578"/> 3578: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),</i>
<a name="3579"/> 3579: <i>%%                            ok</i>
<a name="3580"/> 3580: <i>%%                    end},</i>
<a name="3581"/> 3581: <i>%%          #{desc =&gt; &quot;await client ready (connect)&quot;,</i>
<a name="3582"/> 3582: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3583"/> 3583: <i>%%                            ?SEV_AWAIT_READY(Client, client, connect)</i>
<a name="3584"/> 3584: <i>%%                    end},</i>
<a name="3585"/> 3585: <i>%%          #{desc =&gt; &quot;await server ready (accept)&quot;,</i>
<a name="3586"/> 3586: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3587"/> 3587: <i>%%                            ?SEV_AWAIT_READY(Server, server, accept)</i>
<a name="3588"/> 3588: <i>%%                    end},</i>
<a name="3589"/> 3589: <i>%%          #{desc =&gt; &quot;order client to continue (with send request)&quot;,</i>
<a name="3590"/> 3590: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3591"/> 3591: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),</i>
<a name="3592"/> 3592: <i>%%                            ok</i>
<a name="3593"/> 3593: <i>%%                    end},</i>
<a name="3594"/> 3594: <i>%%          #{desc =&gt; &quot;await client ready (with send request)&quot;,</i>
<a name="3595"/> 3595: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3596"/> 3596: <i>%%                            ?SEV_AWAIT_READY(Client, client, send_req)</i>
<a name="3597"/> 3597: <i>%%                    end},</i>
<a name="3598"/> 3598: <i>%%          #{desc =&gt; &quot;await server ready (request recv)&quot;,</i>
<a name="3599"/> 3599: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3600"/> 3600: <i>%%                            ?SEV_AWAIT_READY(Server, server, recv_req)</i>
<a name="3601"/> 3601: <i>%%                    end},</i>
<a name="3602"/> 3602: <i>%%          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,</i>
<a name="3603"/> 3603: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3604"/> 3604: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),</i>
<a name="3605"/> 3605: <i>%%                            ok</i>
<a name="3606"/> 3606: <i>%%                    end},</i>
<a name="3607"/> 3607: <i>%%          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,</i>
<a name="3608"/> 3608: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3609"/> 3609: <i>%%                            ?SEV_AWAIT_READY(Server, server, send_reply)</i>
<a name="3610"/> 3610: <i>%%                    end},</i>
<a name="3611"/> 3611: <i>%%          #{desc =&gt; &quot;await client ready (reply recv)&quot;,</i>
<a name="3612"/> 3612: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3613"/> 3613: <i>%%                            ?SEV_AWAIT_READY(Client, client, recv_reply)</i>
<a name="3614"/> 3614: <i>%%                    end},</i>
<a name="3615"/> 3615: 
<a name="3616"/> 3616: 
<a name="3617"/> 3617: <i>%%          %% *** Termination ***</i>
<a name="3618"/> 3618: <i>%%          #{desc =&gt; &quot;order client to terminate&quot;,</i>
<a name="3619"/> 3619: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3620"/> 3620: <i>%%                            ?SEV_ANNOUNCE_TERMINATE(Client),</i>
<a name="3621"/> 3621: <i>%%                            ok</i>
<a name="3622"/> 3622: <i>%%                    end},</i>
<a name="3623"/> 3623: <i>%%          #{desc =&gt; &quot;await client termination&quot;,</i>
<a name="3624"/> 3624: <i>%%            cmd  =&gt; fun(#{client := Client} = State) -&gt;</i>
<a name="3625"/> 3625: <i>%%                            ?SEV_AWAIT_TERMINATION(Client),</i>
<a name="3626"/> 3626: <i>%%                            State1 = maps:remove(client, State),</i>
<a name="3627"/> 3627: <i>%%                            {ok, State1}</i>
<a name="3628"/> 3628: <i>%%                    end},</i>
<a name="3629"/> 3629: <i>%%          #{desc =&gt; &quot;order server to terminate&quot;,</i>
<a name="3630"/> 3630: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3631"/> 3631: <i>%%                            ?SEV_ANNOUNCE_TERMINATE(Server),</i>
<a name="3632"/> 3632: <i>%%                            ok</i>
<a name="3633"/> 3633: <i>%%                    end},</i>
<a name="3634"/> 3634: <i>%%          #{desc =&gt; &quot;await server termination&quot;,</i>
<a name="3635"/> 3635: <i>%%            cmd  =&gt; fun(#{server := Server} = State) -&gt;</i>
<a name="3636"/> 3636: <i>%%                            ?SEV_AWAIT_TERMINATION(Server),</i>
<a name="3637"/> 3637: <i>%%                            State1 = maps:remove(server, State),</i>
<a name="3638"/> 3638: <i>%%                            {ok, State1}</i>
<a name="3639"/> 3639: <i>%%                    end},</i>
<a name="3640"/> 3640: 
<a name="3641"/> 3641: <i>%%          %% *** We are done ***</i>
<a name="3642"/> 3642: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="3643"/> 3643: <i>%%         ],</i>
<a name="3644"/> 3644: 
<a name="3645"/> 3645: <i>%%     i(&quot;start server evaluator&quot;),</i>
<a name="3646"/> 3646: <i>%%     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),</i>
<a name="3647"/> 3647: 
<a name="3648"/> 3648: <i>%%     i(&quot;start client evaluator&quot;),</i>
<a name="3649"/> 3649: <i>%%     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),</i>
<a name="3650"/> 3650: <i>%%     i(&quot;await evaluator(s)&quot;),</i>
<a name="3651"/> 3651: 
<a name="3652"/> 3652: <i>%%     i(&quot;start tester evaluator&quot;),</i>
<a name="3653"/> 3653: <i>%%     TesterInitState = #{server =&gt; Server#ev.pid,</i>
<a name="3654"/> 3654: <i>%%                         client =&gt; Client#ev.pid},</i>
<a name="3655"/> 3655: <i>%%     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),</i>
<a name="3656"/> 3656: 
<a name="3657"/> 3657: <i>%%     ok = ?SEV_AWAIT_FINISH([Server, Client, Tester]).</i>
<a name="3658"/> 3658: 
<a name="3659"/> 3659: <i>%%     ok.</i>
<a name="3660"/> 3660: 
<a name="3661"/> 3661: 
<a name="3662"/> 3662: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3663"/> 3663: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3664"/> 3664: <i>%%                                                                     %%</i>
<a name="3665"/> 3665: <i>%%                           API IOV                                   %%</i>
<a name="3666"/> 3666: <i>%%                                                                     %%</i>
<a name="3667"/> 3667: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3668"/> 3668: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3669"/> 3669: 
<a name="api_b_sendmsg_iov_dgram_inet-1"/><a name="3670"/> 3670: <b>api_b_sendmsg_iov_dgram_inet</b>(Config) when is_list(Config) -&gt;
<a name="3671"/> 3671:     has_support_ipv4(),
<a name="api_b_sendmsg_iov_dgram_inet-last_expr"/><a name="3672"/> 3672: <b>    api_b_sendmsg_iov_dgram</b>(inet).
<a name="3673"/> 3673: <i>%%</i>
<a name="api_b_sendmsg_iov_dgram_inet6-1"/><a name="3674"/> 3674: <b>api_b_sendmsg_iov_dgram_inet6</b>(Config) when is_list(Config) -&gt;
<a name="3675"/> 3675:     has_support_ipv6(),
<a name="api_b_sendmsg_iov_dgram_inet6-last_expr"/><a name="3676"/> 3676: <b>    api_b_sendmsg_iov_dgram</b>(inet6).
<a name="3677"/> 3677: <i>%%</i>
<a name="api_b_sendmsg_iov_dgram_local-1"/><a name="3678"/> 3678: <b>api_b_sendmsg_iov_dgram_local</b>(Config) when is_list(Config) -&gt;
<a name="3679"/> 3679:     has_support_unix_domain_socket(),
<a name="3680"/> 3680:     is_not_windows(), % on Windows, local only works for stream sockets
<a name="api_b_sendmsg_iov_dgram_local-last_expr"/><a name="3681"/> 3681: <b>    api_b_sendmsg_iov_dgram</b>(local).
<a name="3682"/> 3682: 
<a name="api_b_sendmsg_iov_stream_inet-1"/><a name="3683"/> 3683: <b>api_b_sendmsg_iov_stream_inet</b>(Config) when is_list(Config) -&gt;
<a name="3684"/> 3684:     has_support_ipv4(),
<a name="3685"/> 3685:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_inet-last_expr"/><a name="3686"/> 3686: <b>    api_b_sendmsg_iov_stream</b>(inet).
<a name="3687"/> 3687: <i>%%</i>
<a name="api_b_sendmsg_iov_stream_inet6-1"/><a name="3688"/> 3688: <b>api_b_sendmsg_iov_stream_inet6</b>(Config) when is_list(Config) -&gt;
<a name="3689"/> 3689:     has_support_ipv6(),
<a name="3690"/> 3690:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_inet6-last_expr"/><a name="3691"/> 3691: <b>    api_b_sendmsg_iov_stream</b>(inet6).
<a name="3692"/> 3692: <i>%%</i>
<a name="api_b_sendmsg_iov_stream_local-1"/><a name="3693"/> 3693: <b>api_b_sendmsg_iov_stream_local</b>(Config) when is_list(Config) -&gt;
<a name="3694"/> 3694:     has_support_unix_domain_socket(),
<a name="3695"/> 3695:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_local-last_expr"/><a name="3696"/> 3696: <b>    api_b_sendmsg_iov_stream</b>(local).
<a name="3697"/> 3697: 
<a name="3698"/> 3698: 
<a name="api_b_sendmsg_iov_dgram-1"/><a name="3699"/> 3699: <b>api_b_sendmsg_iov_dgram</b>(Domain) -&gt;
<a name="3700"/> 3700:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; entry with&quot;
<a name="3701"/> 3701:        &quot;~n   Domain: ~p&quot;, [Domain]),
<a name="3702"/> 3702:     ?TT(?SECS(5)),
<a name="3703"/> 3703:     #{iov_max := IOVMax} = socket:info(),
<a name="3704"/> 3704:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; IOVMax: ~p&quot;, [IOVMax]),
<a name="3705"/> 3705:     IOV =
<a name="3706"/> 3706:         lists:map(
<a name="3707"/> 3707:           fun (N) -&gt; &lt;&lt;(rand:uniform(N) - 1)&gt;&gt; end,
<a name="3708"/> 3708:           lists:duplicate(IOVMax, 256)),
<a name="3709"/> 3709:     IOVTooLarge = IOV ++ IOV,
<a name="3710"/> 3710:     Data = erlang:iolist_to_binary(IOV),
<a name="3711"/> 3711:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: create socket&quot;),
<a name="3712"/> 3712:     {ok, Sa} = socket:open(Domain, dgram, #{debug =&gt; true}),
<a name="api_b_sendmsg_iov_dgram-last_expr"/><a name="3713"/> 3713:     try
<a name="3714"/> 3714: 	?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: create socket&quot;),
<a name="3715"/> 3715:         {ok, Sb} = socket:open(Domain, dgram),
<a name="3716"/> 3716:         try
<a name="3717"/> 3717: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: bind socket&quot;),
<a name="3718"/> 3718:             ok = socket:bind(Sa, which_local_socket_addr(Domain)),
<a name="3719"/> 3719: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: bind socket&quot;),
<a name="3720"/> 3720:             ok = socket:bind(Sb, which_local_socket_addr(Domain)),
<a name="3721"/> 3721: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: get sockname&quot;),
<a name="3722"/> 3722:             {ok, Aa} = socket:sockname(Sa),
<a name="3723"/> 3723: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: get sockname&quot;),
<a name="3724"/> 3724:             {ok, Ab} = socket:sockname(Sb),
<a name="3725"/> 3725:             %%
<a name="3726"/> 3726: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: sendmsg&quot;),
<a name="3727"/> 3727:             ok = socket:sendmsg(Sa, #{addr =&gt; Ab, iov =&gt; IOV}),
<a name="3728"/> 3728: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: recvfrom&quot;),
<a name="3729"/> 3729:             {ok, {Aa, Data}} = socket:recvfrom(Sb),
<a name="3730"/> 3730:             %%
<a name="3731"/> 3731: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: sendmsg (too large =&gt; fail)&quot;),
<a name="3732"/> 3732:             {error, {invalid, _}} =
<a name="3733"/> 3733:                 socket:sendmsg(Sb, #{addr =&gt; Aa, iov =&gt; IOVTooLarge}),
<a name="3734"/> 3734: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; done&quot;),
<a name="3735"/> 3735:             ok
<a name="3736"/> 3736:         after
<a name="3737"/> 3737: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: close socket&quot;),
<a name="3738"/> 3738:             socket:close(Sb)
<a name="3739"/> 3739:         end
<a name="3740"/> 3740:     after
<a name="3741"/> 3741: 	?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: close socket&quot;),
<a name="3742"/> 3742:         socket:close(Sa)
<a name="3743"/> 3743:     end.
<a name="3744"/> 3744: 
<a name="api_b_sendmsg_iov_stream-1"/><a name="3745"/> 3745: <b>api_b_sendmsg_iov_stream</b>(Domain) -&gt;
<a name="3746"/> 3746:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; entry with&quot;
<a name="3747"/> 3747:        &quot;~n   Domain: ~p&quot;, [Domain]),
<a name="3748"/> 3748:     ?TT(?SECS(5)),
<a name="3749"/> 3749:     #{iov_max := IOVMax} = socket:info(),
<a name="3750"/> 3750:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; IOVMax: ~p&quot;, [IOVMax]),
<a name="3751"/> 3751:     IOV =
<a name="3752"/> 3752:         lists:map(
<a name="3753"/> 3753:           fun (N) -&gt; &lt;&lt;(rand:uniform(N) - 1)&gt;&gt; end,
<a name="3754"/> 3754:           lists:duplicate(IOVMax, 256)),
<a name="3755"/> 3755:     IOVTooLarge = IOV ++ IOV,
<a name="3756"/> 3756:     Data = erlang:iolist_to_binary(IOV),
<a name="3757"/> 3757:     DataTooLarge = erlang:iolist_to_binary(IOVTooLarge),
<a name="3758"/> 3758:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; create stream socket a&quot;),
<a name="3759"/> 3759:     {ok, Sa} = socket:open(Domain, stream),
<a name="api_b_sendmsg_iov_stream-last_expr"/><a name="3760"/> 3760:     try
<a name="3761"/> 3761:         case os:type() of
<a name="3762"/> 3762:             {win32,nt} -&gt;
<a name="3763"/> 3763: 		?P(&quot;api_b_sendmsg_iov_stream-&gt; [win] a: bind socket&quot;),
<a name="3764"/> 3764:                 ok = socket:bind(Sa, which_local_socket_addr(Domain));
<a name="3765"/> 3765:             _ -&gt;
<a name="3766"/> 3766:                 ok
<a name="3767"/> 3767:         end,
<a name="3768"/> 3768: 	?P(&quot;api_b_sendmsg_iov_stream -&gt; create stream socket b&quot;),
<a name="3769"/> 3769:         {ok, Sb} = socket:open(Domain, stream),
<a name="3770"/> 3770:         try
<a name="3771"/> 3771: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: bind socket&quot;),
<a name="3772"/> 3772:             ok = socket:bind(Sb, which_local_socket_addr(Domain)),
<a name="3773"/> 3773: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: get sockname&quot;),
<a name="3774"/> 3774:             {ok, Ab} = socket:sockname(Sb),
<a name="3775"/> 3775: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: make socket listen&quot;),
<a name="3776"/> 3776:             ok = socket:listen(Sb),
<a name="3777"/> 3777: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: connect socket to b&quot;),
<a name="3778"/> 3778:             ok = socket:connect(Sa, Ab),
<a name="3779"/> 3779: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: get sockname&quot;),
<a name="3780"/> 3780:             {ok, Aa} = socket:sockname(Sa),
<a name="3781"/> 3781: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: get peername&quot;),
<a name="3782"/> 3782:             {ok, Ab} = socket:peername(Sa),
<a name="3783"/> 3783: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; accept connection (=&gt; c)&quot;),
<a name="3784"/> 3784:             {ok, Sc} = socket:accept(Sb),
<a name="3785"/> 3785:             try
<a name="3786"/> 3786: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: get sockname&quot;),
<a name="3787"/> 3787:                 {ok, Ab} = socket:sockname(Sc),
<a name="3788"/> 3788: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: get peername&quot;),
<a name="3789"/> 3789:                 {ok, Aa} = socket:peername(Sc),
<a name="3790"/> 3790:                 %%
<a name="3791"/> 3791: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; a: sendmsg&quot;),
<a name="3792"/> 3792:                 ok = socket:sendmsg(Sa, #{iov =&gt; IOV}),
<a name="3793"/> 3793: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: recv&quot;),
<a name="3794"/> 3794:                 {ok, Data} =
<a name="3795"/> 3795:                     socket:recv(Sc, byte_size(Data)),
<a name="3796"/> 3796: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: sendmsg (too large)&quot;),
<a name="3797"/> 3797:                 ok = socket:sendmsg(Sc, #{iov =&gt; IOVTooLarge}),
<a name="3798"/> 3798: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; a: recv&quot;),
<a name="3799"/> 3799:                 {ok, DataTooLarge} =
<a name="3800"/> 3800:                     socket:recv(Sa, byte_size(DataTooLarge)),
<a name="3801"/> 3801: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; done&quot;),
<a name="3802"/> 3802:                 ok
<a name="3803"/> 3803:             catch
<a name="3804"/> 3804:                 error:notsup = Reason:_ -&gt;
<a name="3805"/> 3805: 		    ?P(&quot;api_b_sendmsg_iov_stream -&gt; notsup&quot;),
<a name="3806"/> 3806:                     exit({skip, Reason})
<a name="3807"/> 3807:             after
<a name="3808"/> 3808:                 socket:close(Sc)
<a name="3809"/> 3809:             end
<a name="3810"/> 3810:         after
<a name="3811"/> 3811: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; after - b: close socket&quot;),
<a name="3812"/> 3812:             socket:close(Sb)
<a name="3813"/> 3813:         end
<a name="3814"/> 3814:     after
<a name="3815"/> 3815: 	?P(&quot;api_b_sendmsg_iov_stream -&gt; after - a: close socket&quot;),
<a name="3816"/> 3816:         socket:close(Sa)
<a name="3817"/> 3817:     end.
<a name="3818"/> 3818: 
<a name="3819"/> 3819: 
<a name="3820"/> 3820: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3821"/> 3821: 
<a name="3822"/> 3822: <i>%% Basically connect, send and receive using the &quot;common&quot; functions</i>
<a name="3823"/> 3823: <i>%% (send and recv) on an IPv4 UDP (dgram) socket.</i>
<a name="api_b_dgram_connect_udp4-1"/><a name="3824"/> 3824: <b>api_b_dgram_connect_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3825"/> 3825:     ?TT(?SECS(10)),
<a name="api_b_dgram_connect_udp4-last_expr"/><a name="3826"/> 3826: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3827"/> 3827:            fun() -&gt; has_support_ipv4() end,
<a name="3828"/> 3828:            fun() -&gt;
<a name="3829"/> 3829:                    InitState = #{domain =&gt; inet,
<a name="3830"/> 3830:                                  type   =&gt; dgram,
<a name="3831"/> 3831:                                  proto  =&gt; udp},
<a name="3832"/> 3832:                    ok = api_b_dgram_connect(InitState)
<a name="3833"/> 3833:            end).
<a name="3834"/> 3834: 
<a name="3835"/> 3835: 
<a name="3836"/> 3836: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3837"/> 3837: 
<a name="3838"/> 3838: <i>%% Basically connect, send and receive using the &quot;common&quot; functions</i>
<a name="3839"/> 3839: <i>%% (send and recv) on an IPv6 UDP (dgram) socket.</i>
<a name="api_b_dgram_connect_udp6-1"/><a name="3840"/> 3840: <b>api_b_dgram_connect_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="3841"/> 3841:     ?TT(?SECS(10)),
<a name="api_b_dgram_connect_udp6-last_expr"/><a name="3842"/> 3842: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3843"/> 3843:            fun() -&gt; has_support_ipv6() end,
<a name="3844"/> 3844:            fun() -&gt;
<a name="3845"/> 3845:                    InitState = #{domain =&gt; inet6,
<a name="3846"/> 3846:                                  type   =&gt; dgram,
<a name="3847"/> 3847:                                  proto  =&gt; udp},
<a name="3848"/> 3848:                    ok = api_b_dgram_connect(InitState)
<a name="3849"/> 3849:            end).
<a name="3850"/> 3850: 
<a name="3851"/> 3851: 
<a name="3852"/> 3852: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3853"/> 3853: 
<a name="api_b_dgram_connect-1"/><a name="3854"/> 3854: <b>api_b_dgram_connect</b>(InitState) -&gt;
<a name="3855"/> 3855:     PeerSeq = 
<a name="3856"/> 3856:         [
<a name="3857"/> 3857:          %% *** Wait for start order part ***
<a name="3858"/> 3858:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="3859"/> 3859:            cmd  =&gt; fun(State) -&gt;
<a name="3860"/> 3860:                            Tester = ?SEV_AWAIT_START(),
<a name="3861"/> 3861:                            {ok, State#{tester =&gt; Tester}}
<a name="3862"/> 3862:                    end},
<a name="3863"/> 3863:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="3864"/> 3864:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="3865"/> 3865:                            _MRef = erlang:monitor(process, Tester),
<a name="3866"/> 3866:                            ok
<a name="3867"/> 3867:                    end},
<a name="3868"/> 3868: 
<a name="3869"/> 3869:          %% *** Init part ***
<a name="3870"/> 3870:          #{desc =&gt; &quot;which local address&quot;,
<a name="3871"/> 3871:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="3872"/> 3872:                            LSA = which_local_socket_addr(Domain),
<a name="3873"/> 3873:                            {ok, State#{local_sa =&gt; LSA}}
<a name="3874"/> 3874:                    end},
<a name="3875"/> 3875: 
<a name="3876"/> 3876:          #{desc =&gt; &quot;open&quot;,
<a name="3877"/> 3877:            cmd  =&gt; fun(#{domain := Domain,
<a name="3878"/> 3878:                          type   := Type,
<a name="3879"/> 3879:                          proto  := Protocol} = State) -&gt;
<a name="3880"/> 3880:                            case socket:open(Domain, Type, Protocol) of
<a name="3881"/> 3881:                                {ok, Sock} -&gt;
<a name="3882"/> 3882:                                    {ok, State#{sock =&gt; Sock}};
<a name="3883"/> 3883:                                {error, eprotonosupport = Reason}
<a name="3884"/> 3884:                                  when (Reason =:= epfnosupport)    orelse
<a name="3885"/> 3885:                                       (Reason =:= eprotonosupport) orelse
<a name="3886"/> 3886:                                       (Reason =:= esocktnosupport) -&gt;
<a name="3887"/> 3887:                                    ?SEV_IPRINT(&quot;failed open: ~p =&gt; SKIP&quot;,
<a name="3888"/> 3888:                                                [Reason]),
<a name="3889"/> 3889:                                    {skip, Reason};
<a name="3890"/> 3890:                                {error, _} = ERROR -&gt;
<a name="3891"/> 3891:                                    ERROR
<a name="3892"/> 3892:                            end
<a name="3893"/> 3893:                    end},
<a name="3894"/> 3894: 
<a name="3895"/> 3895:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="3896"/> 3896:            cmd  =&gt; fun(#{domain   := local,
<a name="3897"/> 3897:                          sock     := Sock,
<a name="3898"/> 3898:                          local_sa := LSA} = State) -&gt;
<a name="3899"/> 3899:                            case socket:bind(Sock, LSA) of
<a name="3900"/> 3900:                                ok -&gt;
<a name="3901"/> 3901:                                    {ok, State#{sock_sa =&gt; LSA}};
<a name="3902"/> 3902:                                {error, Reason} = ERROR -&gt;
<a name="3903"/> 3903: 				   ?SEV_EPRINT(&quot;failed binding: &quot;
<a name="3904"/> 3904: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="3905"/> 3905:                                    ERROR
<a name="3906"/> 3906:                            end;
<a name="3907"/> 3907:                       (#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="3908"/> 3908:                            case sock_bind(Sock, LSA#{port =&gt; 0}) of
<a name="3909"/> 3909:                                ok -&gt;
<a name="3910"/> 3910:                                    Port = sock_port(Sock),
<a name="3911"/> 3911:                                    {ok, State#{sock_sa =&gt; LSA#{port =&gt; Port}}};
<a name="3912"/> 3912:                                {error, _} = ERROR -&gt;
<a name="3913"/> 3913:                                    ERROR
<a name="3914"/> 3914:                            end
<a name="3915"/> 3915:                    end},
<a name="3916"/> 3916: 
<a name="3917"/> 3917:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="3918"/> 3918:            cmd  =&gt; fun(#{tester := Tester, sock_sa := SSA}) -&gt;
<a name="3919"/> 3919:                            ?SEV_ANNOUNCE_READY(Tester, init, SSA),
<a name="3920"/> 3920:                            ok
<a name="3921"/> 3921:                    end},
<a name="3922"/> 3922: 
<a name="3923"/> 3923:          %% The actual test
<a name="3924"/> 3924:          #{desc =&gt; &quot;await continue (peer sa)&quot;,
<a name="3925"/> 3925:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="3926"/> 3926:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, connect) of
<a name="3927"/> 3927:                                {ok, PeerSA} -&gt;
<a name="3928"/> 3928:                                    ?SEV_IPRINT(&quot;Peer SA:&quot;
<a name="3929"/> 3929:                                                &quot;~n   ~p&quot;, [PeerSA]),
<a name="3930"/> 3930:                                    {ok, State#{peer_sa =&gt; PeerSA}};
<a name="3931"/> 3931:                                {error, _} = ERROR -&gt;
<a name="3932"/> 3932:                                    ERROR
<a name="3933"/> 3933:                            end
<a name="3934"/> 3934:                    end},
<a name="3935"/> 3935: 
<a name="3936"/> 3936:          #{desc =&gt; &quot;connect&quot;,
<a name="3937"/> 3937:            cmd  =&gt; fun(#{sock := Sock, peer_sa := PSA}) -&gt;
<a name="3938"/> 3938:                            ?SEV_IPRINT(&quot;try connect&quot;),
<a name="3939"/> 3939:                            socket:connect(Sock, PSA)
<a name="3940"/> 3940:                    end},
<a name="3941"/> 3941: 
<a name="3942"/> 3942:          #{desc =&gt; &quot;announce ready (connected)&quot;,
<a name="3943"/> 3943:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3944"/> 3944:                            ?SEV_ANNOUNCE_READY(Tester, connected),
<a name="3945"/> 3945:                            ok
<a name="3946"/> 3946:                    end},
<a name="3947"/> 3947: 
<a name="3948"/> 3948:          %% The actual test
<a name="3949"/> 3949:          #{desc =&gt; &quot;await continue (send and recv)&quot;,
<a name="3950"/> 3950:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="3951"/> 3951:                            case ?SEV_AWAIT_CONTINUE(Tester,
<a name="3952"/> 3952:                                                     tester, send_and_recv) of
<a name="3953"/> 3953:                                {ok, Role} -&gt;
<a name="3954"/> 3954:                                    ?SEV_IPRINT(&quot;role: ~p&quot;, [Role]),
<a name="3955"/> 3955:                                    {ok, State#{role =&gt; Role}};
<a name="3956"/> 3956:                                {error, _} = ERROR -&gt;
<a name="3957"/> 3957:                                    ERROR
<a name="3958"/> 3958:                            end
<a name="3959"/> 3959:                    end},
<a name="3960"/> 3960: 
<a name="3961"/> 3961:          #{desc =&gt; &quot;send (client) or recv (server) request&quot;,
<a name="3962"/> 3962:            cmd  =&gt; fun(#{sock := Sock, role := client}) -&gt;
<a name="3963"/> 3963:                            ?SEV_IPRINT(&quot;[client] try send request&quot;),
<a name="3964"/> 3964:                            socket:send(Sock, ?BASIC_REQ);
<a name="3965"/> 3965:                       (#{sock := Sock, role := server}) -&gt;
<a name="3966"/> 3966:                            ?SEV_IPRINT(&quot;[server] try recv request&quot;),
<a name="3967"/> 3967:                            case socket:recv(Sock) of
<a name="3968"/> 3968:                                {ok, ?BASIC_REQ} -&gt;
<a name="3969"/> 3969:                                    ok;
<a name="3970"/> 3970:                                {error, _} = ERROR -&gt;
<a name="3971"/> 3971:                                    ERROR
<a name="3972"/> 3972:                            end
<a name="3973"/> 3973:                    end},
<a name="3974"/> 3974: 
<a name="3975"/> 3975:          #{desc =&gt; &quot;recv (client) send (server) reply&quot;,
<a name="3976"/> 3976:            cmd  =&gt; fun(#{sock := Sock, role := client}) -&gt;
<a name="3977"/> 3977:                            ?SEV_IPRINT(&quot;[client] try recv reply&quot;),
<a name="3978"/> 3978:                            case socket:recv(Sock) of
<a name="3979"/> 3979:                                {ok, ?BASIC_REP} -&gt;
<a name="3980"/> 3980:                                    ok;
<a name="3981"/> 3981:                                {error, _} = ERROR -&gt;
<a name="3982"/> 3982:                                    ERROR
<a name="3983"/> 3983:                            end;
<a name="3984"/> 3984:                       (#{sock := Sock, role := server}) -&gt;
<a name="3985"/> 3985:                            ?SEV_IPRINT(&quot;[server] try send reply&quot;),
<a name="3986"/> 3986:                            socket:send(Sock, ?BASIC_REP)
<a name="3987"/> 3987:                    end},
<a name="3988"/> 3988: 
<a name="3989"/> 3989:          #{desc =&gt; &quot;announce ready (send_and_recv)&quot;,
<a name="3990"/> 3990:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3991"/> 3991:                            ?SEV_ANNOUNCE_READY(Tester, send_and_recv),
<a name="3992"/> 3992:                            ok
<a name="3993"/> 3993:                    end},
<a name="3994"/> 3994: 
<a name="3995"/> 3995: 
<a name="3996"/> 3996:          %% *** Termination ***
<a name="3997"/> 3997:          #{desc =&gt; &quot;await terminate&quot;,
<a name="3998"/> 3998:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="3999"/> 3999:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="4000"/> 4000:                                ok -&gt;
<a name="4001"/> 4001:                                    {ok, maps:remove(tester, State)};
<a name="4002"/> 4002:                                {error, _} = ERROR -&gt;
<a name="4003"/> 4003:                                    ERROR
<a name="4004"/> 4004:                            end
<a name="4005"/> 4005:                    end},
<a name="4006"/> 4006:          #{desc =&gt; &quot;close socket&quot;,
<a name="4007"/> 4007:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="4008"/> 4008:                            socket:close(Sock),
<a name="4009"/> 4009:                            {ok, maps:remove(sock, State)}
<a name="4010"/> 4010:                    end},
<a name="4011"/> 4011: 
<a name="4012"/> 4012:          %% *** We are done ***
<a name="4013"/> 4013:          ?SEV_FINISH_NORMAL
<a name="4014"/> 4014:         ],
<a name="4015"/> 4015: 
<a name="4016"/> 4016: 
<a name="4017"/> 4017:     TesterSeq =
<a name="4018"/> 4018:         [
<a name="4019"/> 4019:          %% *** Init part ***
<a name="4020"/> 4020:          #{desc =&gt; &quot;monitor peer 1&quot;,
<a name="4021"/> 4021:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4022"/> 4022:                            _MRef = erlang:monitor(process, Pid),
<a name="4023"/> 4023:                            ok
<a name="4024"/> 4024:                    end},
<a name="4025"/> 4025:          #{desc =&gt; &quot;monitor peer 2&quot;,
<a name="4026"/> 4026:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4027"/> 4027:                            _MRef = erlang:monitor(process, Pid),
<a name="4028"/> 4028:                            ok
<a name="4029"/> 4029:                    end},
<a name="4030"/> 4030: 
<a name="4031"/> 4031:          #{desc =&gt; &quot;order peer 1 start&quot;,
<a name="4032"/> 4032:            cmd  =&gt; fun(#{peer_1 := Pid}) -&gt;
<a name="4033"/> 4033:                            ?SEV_ANNOUNCE_START(Pid)
<a name="4034"/> 4034:                    end},
<a name="4035"/> 4035:          #{desc =&gt; &quot;order peer 2 start&quot;,
<a name="4036"/> 4036:            cmd  =&gt; fun(#{peer_2 := Pid}) -&gt;
<a name="4037"/> 4037:                            ?SEV_ANNOUNCE_START(Pid)
<a name="4038"/> 4038:                    end},
<a name="4039"/> 4039: 
<a name="4040"/> 4040:          #{desc =&gt; &quot;await peer 1 ready (init)&quot;,
<a name="4041"/> 4041:            cmd  =&gt; fun(#{peer_1 := Pid} = State) -&gt;
<a name="4042"/> 4042:                            {ok, PeerSA} = ?SEV_AWAIT_READY(Pid, peer1, init),
<a name="4043"/> 4043:                            {ok, State#{peer_1_sa =&gt; PeerSA}}
<a name="4044"/> 4044:                    end},
<a name="4045"/> 4045:          #{desc =&gt; &quot;await peer 2 ready (init)&quot;,
<a name="4046"/> 4046:            cmd  =&gt; fun(#{peer_2 := Pid} = State) -&gt;
<a name="4047"/> 4047:                            {ok, PeerSA} = ?SEV_AWAIT_READY(Pid, peer2, init),
<a name="4048"/> 4048:                            {ok, State#{peer_2_sa =&gt; PeerSA}}
<a name="4049"/> 4049:                    end},
<a name="4050"/> 4050: 
<a name="4051"/> 4051: 
<a name="4052"/> 4052:          #{desc =&gt; &quot;order peer 1 to continue (with connect)&quot;,
<a name="4053"/> 4053:            cmd  =&gt; fun(#{peer_1 := Pid, peer_2_sa := PeerSA} = _State) -&gt;
<a name="4054"/> 4054:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect, PeerSA),
<a name="4055"/> 4055:                            ok
<a name="4056"/> 4056:                    end},
<a name="4057"/> 4057:          #{desc =&gt; &quot;order peer 2 to continue (with connect)&quot;,
<a name="4058"/> 4058:            cmd  =&gt; fun(#{peer_2 := Pid, peer_1_sa := PeerSA} = _State) -&gt;
<a name="4059"/> 4059:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect, PeerSA),
<a name="4060"/> 4060:                            ok
<a name="4061"/> 4061:                    end},
<a name="4062"/> 4062: 
<a name="4063"/> 4063: 
<a name="4064"/> 4064:          #{desc =&gt; &quot;await peer 1 ready (connected)&quot;,
<a name="4065"/> 4065:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4066"/> 4066:                            ?SEV_AWAIT_READY(Pid, peer1, connected)
<a name="4067"/> 4067:                    end},
<a name="4068"/> 4068:          #{desc =&gt; &quot;await peer 2 ready (connected)&quot;,
<a name="4069"/> 4069:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4070"/> 4070:                            ?SEV_AWAIT_READY(Pid, peer2, connected)
<a name="4071"/> 4071:                    end},
<a name="4072"/> 4072: 
<a name="4073"/> 4073: 
<a name="4074"/> 4074: 
<a name="4075"/> 4075:          %% We should pick one to issue the request
<a name="4076"/> 4076:          %% (and the other is then to *await* the request
<a name="4077"/> 4077:          %%  and respond).
<a name="4078"/> 4078: 
<a name="4079"/> 4079: 
<a name="4080"/> 4080: 
<a name="4081"/> 4081:          #{desc =&gt; &quot;order peer 1 to continue (with send_and_recv)&quot;,
<a name="4082"/> 4082:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4083"/> 4083:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_and_recv, client),
<a name="4084"/> 4084:                            ok
<a name="4085"/> 4085:                    end},
<a name="4086"/> 4086:          #{desc =&gt; &quot;order peer 2 to continue (with send_and_recv)&quot;,
<a name="4087"/> 4087:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4088"/> 4088:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_and_recv, server),
<a name="4089"/> 4089:                            ok
<a name="4090"/> 4090:                    end},
<a name="4091"/> 4091: 
<a name="4092"/> 4092: 
<a name="4093"/> 4093:          #{desc =&gt; &quot;await peer 1 ready (send_and_recv)&quot;,
<a name="4094"/> 4094:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4095"/> 4095:                            ?SEV_AWAIT_READY(Pid, peer1, send_and_recv)
<a name="4096"/> 4096:                    end},
<a name="4097"/> 4097:          #{desc =&gt; &quot;await peer 2 ready (send_and_recv)&quot;,
<a name="4098"/> 4098:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4099"/> 4099:                            ?SEV_AWAIT_READY(Pid, peer2, send_and_recv)
<a name="4100"/> 4100:                    end},
<a name="4101"/> 4101: 
<a name="4102"/> 4102: 
<a name="4103"/> 4103:          ?SEV_SLEEP(?SECS(1)),
<a name="4104"/> 4104: 
<a name="4105"/> 4105: 
<a name="4106"/> 4106:          %% *** Termination ***
<a name="4107"/> 4107:          #{desc =&gt; &quot;order peer 1 to terminate&quot;,
<a name="4108"/> 4108:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4109"/> 4109:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="4110"/> 4110:                            ok
<a name="4111"/> 4111:                    end},
<a name="4112"/> 4112:          #{desc =&gt; &quot;await peer 1 termination&quot;,
<a name="4113"/> 4113:            cmd  =&gt; fun(#{peer_1 := Pid} = State) -&gt;
<a name="4114"/> 4114:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="4115"/> 4115:                            State1 = maps:remove(peer_1, State),
<a name="4116"/> 4116:                            {ok, State1}
<a name="4117"/> 4117:                    end},
<a name="4118"/> 4118:          #{desc =&gt; &quot;order peer 2 to terminate&quot;,
<a name="4119"/> 4119:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4120"/> 4120:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="4121"/> 4121:                            ok
<a name="4122"/> 4122:                    end},
<a name="4123"/> 4123:          #{desc =&gt; &quot;await peer 2 termination&quot;,
<a name="4124"/> 4124:            cmd  =&gt; fun(#{peer_2 := Pid} = State) -&gt;
<a name="4125"/> 4125:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="4126"/> 4126:                            State1 = maps:remove(peer_2, State),
<a name="4127"/> 4127:                            {ok, State1}
<a name="4128"/> 4128:                    end},
<a name="4129"/> 4129: 
<a name="4130"/> 4130: 
<a name="4131"/> 4131:          %% *** We are done ***
<a name="4132"/> 4132:          ?SEV_FINISH_NORMAL
<a name="4133"/> 4133:         ],
<a name="4134"/> 4134: 
<a name="4135"/> 4135: 
<a name="4136"/> 4136:     Peer1  = ?SEV_START(&quot;peer 1&quot;, PeerSeq,   InitState),
<a name="4137"/> 4137:     Peer2  = ?SEV_START(&quot;peer 2&quot;, PeerSeq,   InitState),
<a name="4138"/> 4138:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, #{peer_1 =&gt; Peer1#ev.pid,
<a name="4139"/> 4139:                                                peer_2 =&gt; Peer2#ev.pid}),
<a name="api_b_dgram_connect-last_expr"/><a name="4140"/> 4140: <b>    ok = ?SEV_AWAIT_FINISH</b>([Peer1, Peer2, Tester]).
<a name="4141"/> 4141: 
<a name="4142"/> 4142: 
<a name="4143"/> 4143: 
<a name="4144"/> 4144: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4145"/> 4145: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4146"/> 4146: <i>%%                                                                     %%</i>
<a name="4147"/> 4147: <i>%%                           API SENDFILE                              %%</i>
<a name="4148"/> 4148: <i>%%                                                                     %%</i>
<a name="4149"/> 4149: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4150"/> 4150: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4151"/> 4151: 
<a name="api_sendfile_inet-1"/><a name="4152"/> 4152: <b>api_sendfile_inet</b>(Config) when is_list(Config) -&gt;
<a name="4153"/> 4153:     has_support_sendfile(),
<a name="4154"/> 4154:     has_support_ipv4(),
<a name="api_sendfile_inet-last_expr"/><a name="4155"/> 4155: <b>    api_sendfile</b>(inet, Config, fun socket:sendfile/2).
<a name="4156"/> 4156: 
<a name="api_sendfile_inet6-1"/><a name="4157"/> 4157: <b>api_sendfile_inet6</b>(Config) when is_list(Config) -&gt;
<a name="4158"/> 4158:     has_support_sendfile(),
<a name="4159"/> 4159:     has_support_ipv6(),
<a name="api_sendfile_inet6-last_expr"/><a name="4160"/> 4160: <b>    api_sendfile</b>(inet6, Config, fun socket:sendfile/2).
<a name="4161"/> 4161: 
<a name="api_sendfile_local-1"/><a name="4162"/> 4162: <b>api_sendfile_local</b>(Config) when is_list(Config) -&gt;
<a name="4163"/> 4163:     has_support_sendfile(),
<a name="4164"/> 4164:     has_support_unix_domain_socket(),
<a name="api_sendfile_local-last_expr"/><a name="4165"/> 4165: <b>    api_sendfile</b>(local, Config, fun socket:sendfile/2).
<a name="4166"/> 4166: 
<a name="4167"/> 4167: 
<a name="4168"/> 4168: 
<a name="api_sendfile_loop_inet-1"/><a name="4169"/> 4169: <b>api_sendfile_loop_inet</b>(Config) when is_list(Config) -&gt;
<a name="4170"/> 4170:     has_support_sendfile(),
<a name="4171"/> 4171:     has_support_ipv4(),
<a name="api_sendfile_loop_inet-last_expr"/><a name="4172"/> 4172: <b>    api_sendfile</b>(inet, Config, fun sendfile_loop/2).
<a name="4173"/> 4173: 
<a name="api_sendfile_loop_inet6-1"/><a name="4174"/> 4174: <b>api_sendfile_loop_inet6</b>(Config) when is_list(Config) -&gt;
<a name="4175"/> 4175:     has_support_sendfile(),
<a name="4176"/> 4176:     has_support_ipv6(),
<a name="api_sendfile_loop_inet6-last_expr"/><a name="4177"/> 4177: <b>    api_sendfile</b>(inet6, Config, fun sendfile_loop/2).
<a name="4178"/> 4178: 
<a name="api_sendfile_loop_local-1"/><a name="4179"/> 4179: <b>api_sendfile_loop_local</b>(Config) when is_list(Config) -&gt;
<a name="4180"/> 4180:     has_support_sendfile(),
<a name="4181"/> 4181:     has_support_unix_domain_socket(),
<a name="api_sendfile_loop_local-last_expr"/><a name="4182"/> 4182: <b>    api_sendfile</b>(local, Config, fun sendfile_loop/2).
<a name="4183"/> 4183: 
<a name="4184"/> 4184: 
<a name="sendfile_loop-2"/><a name="4185"/> 4185: <b>sendfile_loop</b>(Sa, F) -&gt;
<a name="sendfile_loop-last_expr"/><a name="4186"/> 4186: <b>    sendfile_loop</b>(Sa, F, 0).
<a name="4187"/> 4187: 
<a name="sendfile_loop-3"/><a name="4188"/> 4188: <b>sendfile_loop</b>(Sa, Cont, Offset) -&gt;
<a name="4189"/> 4189:     SelectHandle = make_ref(),
<a name="sendfile_loop-last_expr"/><a name="4190"/> 4190: <b>    case socket:sendfile</b>(Sa, Cont, Offset, 0, SelectHandle) of
<a name="4191"/> 4191:         {select, Select} -&gt;
<a name="4192"/> 4192:             receive
<a name="4193"/> 4193:                 {'$socket', Sa, select, SelectHandle} -&gt;
<a name="4194"/> 4194:                     case Select of
<a name="4195"/> 4195:                         {{select_info, _, _} = Cont_1, BytesSent} -&gt;
<a name="4196"/> 4196:                             sendfile_loop(Sa, Cont_1, Offset + BytesSent);
<a name="4197"/> 4197:                         {select_info, _, _} = Cont_1 -&gt;
<a name="4198"/> 4198:                             sendfile_loop(Sa, Cont_1, Offset)
<a name="4199"/> 4199:                     end;
<a name="4200"/> 4200:                 {'$socket', Sa, abort, {SelectHandle, Reason}} -&gt;
<a name="4201"/> 4201:                     {error, {Reason, Offset}}
<a name="4202"/> 4202:             end;
<a name="4203"/> 4203:         {ok, BytesSent} -&gt;
<a name="4204"/> 4204:             {ok, Offset + BytesSent};
<a name="4205"/> 4205:         {error, Reason} = Error -&gt;
<a name="4206"/> 4206:             io:format(
<a name="4207"/> 4207:               &quot;sendfile_loop(~p, ~p, ~p) -&gt; ~p.~n&quot;,
<a name="4208"/> 4208:               [Sa, Cont, Offset, Error]),
<a name="4209"/> 4209:             {error, {Reason, Offset}}
<a name="4210"/> 4210:     end.
<a name="4211"/> 4211: 
<a name="4212"/> 4212: 
<a name="4213"/> 4213: 
<a name="api_sendfile-3"/><a name="4214"/> 4214: <b>api_sendfile</b>(Domain, Config, Sendfile) -&gt;
<a name="api_sendfile-last_expr"/><a name="4215"/> 4215: <b>    case proplists:get_value</b>(sendfile_file, Config) of
<a name="4216"/> 4216:         undefined -&gt;
<a name="4217"/> 4217:             {skip, sendfile_not_supported};
<a name="4218"/> 4218:         {File, Size, Data} -&gt;
<a name="4219"/> 4219:             api_sendfile(Domain, File, Size, Data, Sendfile)
<a name="4220"/> 4220:     end.
<a name="4221"/> 4221: 
<a name="api_sendfile-5"/><a name="4222"/> 4222: <b>api_sendfile</b>(Domain, File, Size, Data, Sendfile) -&gt;
<a name="4223"/> 4223:     ?TT(?SECS(10)),
<a name="4224"/> 4224:     TC = self(),
<a name="4225"/> 4225:     BufSize = Size bsr 10, % /1k
<a name="4226"/> 4226:     BindAddr = which_local_socket_addr(Domain),
<a name="4227"/> 4227:     case BindAddr of
<a name="4228"/> 4228:         #{family := local, path := Path} -&gt;
<a name="4229"/> 4229:             _ =
<a name="4230"/> 4230:                 spawn(
<a name="4231"/> 4231:                   fun () -&gt;
<a name="4232"/> 4232:                           Mref = monitor(process, TC),
<a name="4233"/> 4233:                           receive
<a name="4234"/> 4234:                               {'DOWN', Mref, _, _, _} -&gt;
<a name="4235"/> 4235:                                   unlink_path(Path)
<a name="4236"/> 4236:                           end
<a name="4237"/> 4237:                   end),
<a name="4238"/> 4238:             ok;
<a name="4239"/> 4239:         #{family := _} -&gt;
<a name="4240"/> 4240:             ok
<a name="4241"/> 4241:     end,
<a name="4242"/> 4242:     io:format(&quot;BindAddr = ~p~n&quot;, [BindAddr]),
<a name="4243"/> 4243:     {ok, F} = file:open(File, [raw, read, binary]),
<a name="4244"/> 4244:     io:format(&quot;F = ~p~n&quot;, [F]),
<a name="4245"/> 4245:     {ok, L} = socket:open(Domain, stream),
<a name="4246"/> 4246:     io:format(&quot;L = ~p~n&quot;, [L]),
<a name="4247"/> 4247:     ok = socket:bind(L, BindAddr),
<a name="4248"/> 4248:     ok = socket:listen(L),
<a name="4249"/> 4249:     {ok, Addr} = socket:sockname(L),
<a name="4250"/> 4250:     io:format(&quot;Addr = ~p~n&quot;, [Addr]),
<a name="4251"/> 4251:     {ok, Sa} = socket:open(Domain, stream),
<a name="4252"/> 4252:     io:format(&quot;Sa = ~p~n&quot;, [Sa]),
<a name="4253"/> 4253:     ok = socket:setopt(Sa, {socket,sndbuf}, BufSize),
<a name="4254"/> 4254:     ok = socket:connect(Sa, Addr),
<a name="4255"/> 4255:     {ok, Sb} = socket:accept(L),
<a name="4256"/> 4256:     io:format(&quot;Sb = ~p~n&quot;, [Sb]),
<a name="4257"/> 4257:     ok = socket:setopt(Sb, {socket,rcvbuf}, BufSize),
<a name="4258"/> 4258:     Verifyer =
<a name="4259"/> 4259:         spawn_link(
<a name="4260"/> 4260:           fun () -&gt;
<a name="4261"/> 4261:                   TC ! {self(), api_sendfile_verify(Sb, Data, 0)}
<a name="4262"/> 4262:           end),
<a name="4263"/> 4263:     io:format(&quot;Verifyer = ~p~n&quot;, [Verifyer]),
<a name="4264"/> 4264:     %%
<a name="4265"/> 4265:     SendfileResult = Sendfile(Sa, F),
<a name="4266"/> 4266:     io:format(&quot;SendfileResult = ~p~n&quot;, [SendfileResult]),
<a name="4267"/> 4267:     %%
<a name="api_sendfile-last_expr"/><a name="4268"/> 4268:     receive
<a name="4269"/> 4269:         {Verifyer, VerifyerResult} -&gt;
<a name="4270"/> 4270:             io:format(&quot;VerifyerResult = ~p~n&quot;, [VerifyerResult]),
<a name="4271"/> 4271:             case {SendfileResult, VerifyerResult} of
<a name="4272"/> 4272:                 {{ok, Size}, {ok, Size}} -&gt;
<a name="4273"/> 4273:                     ok;
<a name="4274"/> 4274:                 Other -&gt;
<a name="4275"/> 4275:                     ?FAIL({bad_result, Other})
<a name="4276"/> 4276:             end
<a name="4277"/> 4277:     end.
<a name="4278"/> 4278: 
<a name="api_sendfile_verify-3"/><a name="4279"/> 4279: <b>api_sendfile_verify</b>(_S, [], M) -&gt;
<a name="4280"/> 4280:     {ok, M};
<a name="4281"/> 4281: <b>api_sendfile_verify</b>(S, [Block | Data], M) when is_binary(Block) -&gt;
<a name="4282"/> 4282:     api_sendfile_verify_block(S, Data, M, Block, 1);
<a name="4283"/> 4283: <b>api_sendfile_verify</b>(S, [{N, Block} | Data], M) -&gt;
<a name="api_sendfile_verify-last_expr"/><a name="4284"/> 4284: <b>    api_sendfile_verify_block</b>(S, Data, M, Block, N).
<a name="4285"/> 4285: 
<a name="api_sendfile_verify_block-5"/><a name="4286"/> 4286: <b>api_sendfile_verify_block</b>(S, Data, M, Block, N) -&gt;
<a name="api_sendfile_verify_block-last_expr"/><a name="4287"/> 4287:     if
<a name="4288"/> 4288:         0 &lt; N -&gt;
<a name="4289"/> 4289:             ByteSize = byte_size(Block),
<a name="4290"/> 4290:             case socket:recv(S, ByteSize, 2000) of
<a name="4291"/> 4291:                 {ok, Block} -&gt;
<a name="4292"/> 4292:                     api_sendfile_verify_block(
<a name="4293"/> 4293:                       S, Data, M + ByteSize, Block, N - 1);
<a name="4294"/> 4294:                 Other -&gt;
<a name="4295"/> 4295:                     {error_at, M, Other}
<a name="4296"/> 4296:             end;
<a name="4297"/> 4297:         true -&gt;
<a name="4298"/> 4298:             api_sendfile_verify(S, Data, M)
<a name="4299"/> 4299:     end.
<a name="4300"/> 4300: 
<a name="4301"/> 4301: 
<a name="4302"/> 4302: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4303"/> 4303: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4304"/> 4304: <i>%%                                                                     %%</i>
<a name="4305"/> 4305: <i>%%                           API FROM FD                               %%</i>
<a name="4306"/> 4306: <i>%%                                                                     %%</i>
<a name="4307"/> 4307: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4308"/> 4308: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4309"/> 4309: 
<a name="4310"/> 4310: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4311"/> 4311: 
<a name="4312"/> 4312: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4313"/> 4313: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="4314"/> 4314: <i>%% With some extra checks...</i>
<a name="4315"/> 4315: <i>%% IPv4</i>
<a name="4316"/> 4316: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_udp4-1"/><a name="4317"/> 4317: <b>api_ffd_open_wod_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4318"/> 4318:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_udp4-last_expr"/><a name="4319"/> 4319: <b>    tc_try</b>(api_ffd_open_wod_and_info_udp4,
<a name="4320"/> 4320:            fun() -&gt; has_support_ipv4() end,
<a name="4321"/> 4321:            fun() -&gt;
<a name="4322"/> 4322:                    InitState = #{domain   =&gt; inet,
<a name="4323"/> 4323:                                  type     =&gt; dgram,
<a name="4324"/> 4324:                                  protocol =&gt; udp,
<a name="4325"/> 4325:                                  dup      =&gt; false},
<a name="4326"/> 4326:                    ok = api_ffd_open_and_info(InitState)
<a name="4327"/> 4327:            end).
<a name="4328"/> 4328: 
<a name="4329"/> 4329: 
<a name="4330"/> 4330: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4331"/> 4331: 
<a name="4332"/> 4332: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4333"/> 4333: <i>%% file descriptor (FD) and info of an IPv6 UDP (dgram) socket.</i>
<a name="4334"/> 4334: <i>%% With some extra checks...</i>
<a name="4335"/> 4335: <i>%% IPv6</i>
<a name="4336"/> 4336: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_udp6-1"/><a name="4337"/> 4337: <b>api_ffd_open_wod_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4338"/> 4338:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_udp6-last_expr"/><a name="4339"/> 4339: <b>    tc_try</b>(api_ffd_open_wod_and_info_udp6,
<a name="4340"/> 4340:            fun() -&gt; has_support_ipv6() end,
<a name="4341"/> 4341:            fun() -&gt;
<a name="4342"/> 4342:                    InitState = #{domain   =&gt; inet6,
<a name="4343"/> 4343:                                  type     =&gt; dgram,
<a name="4344"/> 4344:                                  protocol =&gt; udp,
<a name="4345"/> 4345:                                  dup      =&gt; false},
<a name="4346"/> 4346:                    ok = api_ffd_open_and_info(InitState)
<a name="4347"/> 4347:            end).
<a name="4348"/> 4348: 
<a name="4349"/> 4349: 
<a name="4350"/> 4350: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4351"/> 4351: 
<a name="4352"/> 4352: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4353"/> 4353: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="4354"/> 4354: <i>%% With some extra checks...</i>
<a name="4355"/> 4355: <i>%% IPv4</i>
<a name="4356"/> 4356: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_udp4-1"/><a name="4357"/> 4357: <b>api_ffd_open_wd_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4358"/> 4358:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_udp4-last_expr"/><a name="4359"/> 4359: <b>    tc_try</b>(api_ffd_wd_open_and_info_udp4,
<a name="4360"/> 4360:            fun() -&gt; has_support_ipv4() end,
<a name="4361"/> 4361:            fun() -&gt;
<a name="4362"/> 4362:                    InitState = #{domain   =&gt; inet,
<a name="4363"/> 4363:                                  type     =&gt; dgram,
<a name="4364"/> 4364:                                  protocol =&gt; udp,
<a name="4365"/> 4365:                                  dup      =&gt; true},
<a name="4366"/> 4366:                    ok = api_ffd_open_and_info(InitState)
<a name="4367"/> 4367:            end).
<a name="4368"/> 4368: 
<a name="4369"/> 4369: 
<a name="4370"/> 4370: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4371"/> 4371: 
<a name="4372"/> 4372: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4373"/> 4373: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="4374"/> 4374: <i>%% With some extra checks...</i>
<a name="4375"/> 4375: <i>%% IPv6</i>
<a name="4376"/> 4376: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_udp6-1"/><a name="4377"/> 4377: <b>api_ffd_open_wd_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4378"/> 4378:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_udp6-last_expr"/><a name="4379"/> 4379: <b>    tc_try</b>(api_ffd_wd_open_and_info_udp6,
<a name="4380"/> 4380:            fun() -&gt; has_support_ipv6() end,
<a name="4381"/> 4381:            fun() -&gt;
<a name="4382"/> 4382:                    InitState = #{domain   =&gt; inet,
<a name="4383"/> 4383:                                  type     =&gt; dgram,
<a name="4384"/> 4384:                                  protocol =&gt; udp,
<a name="4385"/> 4385:                                  dup      =&gt; true},
<a name="4386"/> 4386:                    ok = api_ffd_open_and_info(InitState)
<a name="4387"/> 4387:            end).
<a name="4388"/> 4388: 
<a name="4389"/> 4389: 
<a name="4390"/> 4390: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4391"/> 4391: 
<a name="4392"/> 4392: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4393"/> 4393: <i>%% file descriptor (FD) and info of an IPv4 TCP (stream) socket.</i>
<a name="4394"/> 4394: <i>%% With some extra checks...</i>
<a name="4395"/> 4395: <i>%% IPv6</i>
<a name="4396"/> 4396: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_tcp4-1"/><a name="4397"/> 4397: <b>api_ffd_open_wod_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4398"/> 4398:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_tcp4-last_expr"/><a name="4399"/> 4399: <b>    tc_try</b>(api_ffd_open_wod_and_info_tcp4,
<a name="4400"/> 4400:            fun() -&gt; has_support_ipv4() end,
<a name="4401"/> 4401:            fun() -&gt;
<a name="4402"/> 4402:                    InitState = #{domain   =&gt; inet,
<a name="4403"/> 4403:                                  type     =&gt; stream,
<a name="4404"/> 4404:                                  protocol =&gt; tcp,
<a name="4405"/> 4405:                                  dup      =&gt; false},
<a name="4406"/> 4406:                    ok = api_ffd_open_and_info(InitState)
<a name="4407"/> 4407:            end).
<a name="4408"/> 4408: 
<a name="4409"/> 4409: 
<a name="4410"/> 4410: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4411"/> 4411: 
<a name="4412"/> 4412: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4413"/> 4413: <i>%% file descriptor (FD) and info of an IPv6 TCP (stream) socket.</i>
<a name="4414"/> 4414: <i>%% With some extra checks...</i>
<a name="4415"/> 4415: <i>%% IPv6</i>
<a name="4416"/> 4416: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_tcp6-1"/><a name="4417"/> 4417: <b>api_ffd_open_wod_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4418"/> 4418:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_tcp6-last_expr"/><a name="4419"/> 4419: <b>    tc_try</b>(api_ffd_open_wod_and_info_tcp6,
<a name="4420"/> 4420:            fun() -&gt; has_support_ipv6() end,
<a name="4421"/> 4421:            fun() -&gt;
<a name="4422"/> 4422:                    InitState = #{domain   =&gt; inet6,
<a name="4423"/> 4423:                                  type     =&gt; stream,
<a name="4424"/> 4424:                                  protocol =&gt; tcp,
<a name="4425"/> 4425:                                  dup      =&gt; false},
<a name="4426"/> 4426:                    ok = api_ffd_open_and_info(InitState)
<a name="4427"/> 4427:            end).
<a name="4428"/> 4428: 
<a name="4429"/> 4429: 
<a name="4430"/> 4430: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4431"/> 4431: 
<a name="4432"/> 4432: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4433"/> 4433: <i>%% file descriptor (FD) and info of an IPv4 TCP (stream) socket.</i>
<a name="4434"/> 4434: <i>%% With some extra checks...</i>
<a name="4435"/> 4435: <i>%% IPv6</i>
<a name="4436"/> 4436: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_tcp4-1"/><a name="4437"/> 4437: <b>api_ffd_open_wd_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4438"/> 4438:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_tcp4-last_expr"/><a name="4439"/> 4439: <b>    tc_try</b>(api_ffd_open_wd_and_info_tcp4,
<a name="4440"/> 4440:            fun() -&gt; has_support_ipv4() end,
<a name="4441"/> 4441:            fun() -&gt;
<a name="4442"/> 4442:                    InitState = #{domain   =&gt; inet,
<a name="4443"/> 4443:                                  type     =&gt; stream,
<a name="4444"/> 4444:                                  protocol =&gt; tcp,
<a name="4445"/> 4445:                                  dup      =&gt; true},
<a name="4446"/> 4446:                    ok = api_ffd_open_and_info(InitState)
<a name="4447"/> 4447:            end).
<a name="4448"/> 4448: 
<a name="4449"/> 4449: 
<a name="4450"/> 4450: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4451"/> 4451: 
<a name="4452"/> 4452: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4453"/> 4453: <i>%% file descriptor (FD) and info of an IPv6 TCP (stream) socket.</i>
<a name="4454"/> 4454: <i>%% With some extra checks...</i>
<a name="4455"/> 4455: <i>%% IPv6</i>
<a name="4456"/> 4456: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_tcp6-1"/><a name="4457"/> 4457: <b>api_ffd_open_wd_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4458"/> 4458:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_tcp6-last_expr"/><a name="4459"/> 4459: <b>    tc_try</b>(api_ffd_open_wd_and_info_tcp6,
<a name="4460"/> 4460:            fun() -&gt; has_support_ipv6() end,
<a name="4461"/> 4461:            fun() -&gt;
<a name="4462"/> 4462:                    InitState = #{domain   =&gt; inet6,
<a name="4463"/> 4463:                                  type     =&gt; stream,
<a name="4464"/> 4464:                                  protocol =&gt; tcp,
<a name="4465"/> 4465:                                  dup      =&gt; true},
<a name="4466"/> 4466:                    ok = api_ffd_open_and_info(InitState)
<a name="4467"/> 4467:            end).
<a name="4468"/> 4468: 
<a name="4469"/> 4469: 
<a name="4470"/> 4470: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4471"/> 4471: 
<a name="api_ffd_open_and_info-1"/><a name="4472"/> 4472: <b>api_ffd_open_and_info</b>(InitState) -&gt;
<a name="4473"/> 4473:     Seq = 
<a name="4474"/> 4474:         [
<a name="4475"/> 4475:          #{desc =&gt; &quot;open&quot;,
<a name="4476"/> 4476:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4477"/> 4477:                          type     := Type,
<a name="4478"/> 4478:                          protocol := Protocol} = State) -&gt; 
<a name="4479"/> 4479:                            case socket:open(Domain, Type, Protocol) of
<a name="4480"/> 4480:                                {ok, Sock1} -&gt;
<a name="4481"/> 4481:                                    {ok, State#{sock1 =&gt; Sock1}};
<a name="4482"/> 4482:                                {error, _} = ERROR -&gt;
<a name="4483"/> 4483:                                    ERROR
<a name="4484"/> 4484:                            end
<a name="4485"/> 4485:                    end},
<a name="4486"/> 4486:          #{desc =&gt; &quot;get socket (1) FD&quot;,
<a name="4487"/> 4487:            cmd  =&gt; fun(#{sock1 := Sock1} = State) -&gt;
<a name="4488"/> 4488:                            case socket:getopt(Sock1, otp, fd) of
<a name="4489"/> 4489:                                {ok, FD} -&gt;
<a name="4490"/> 4490:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="4491"/> 4491:                                    {ok, State#{fd =&gt; FD}};
<a name="4492"/> 4492:                                {error, Reason} = ERROR -&gt;
<a name="4493"/> 4493:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="4494"/> 4494:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="4495"/> 4495:                                    ERROR
<a name="4496"/> 4496:                            end
<a name="4497"/> 4497:                    end},
<a name="4498"/> 4498:          #{desc =&gt; &quot;check if we need to provide domain or not&quot;,
<a name="4499"/> 4499:            cmd  =&gt; fun(#{sock1 := Sock1} = State) -&gt;
<a name="4500"/> 4500:                            case socket:getopt(Sock1, socket, domain) of
<a name="4501"/> 4501:                                {ok, _} -&gt;
<a name="4502"/> 4502:                                    ?SEV_IPRINT(&quot;domain accessible&quot;),
<a name="4503"/> 4503:                                    {ok, State#{provide_domain =&gt; false}};
<a name="4504"/> 4504:                                {error, Reason} -&gt;
<a name="4505"/> 4505:                                    ?SEV_IPRINT(&quot;failed get domain: &quot;
<a name="4506"/> 4506:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="4507"/> 4507:                                    {ok, State#{provide_domain =&gt; true}}
<a name="4508"/> 4508:                            end
<a name="4509"/> 4509:                    end},
<a name="4510"/> 4510:          #{desc =&gt; &quot;check if we need to provide protocol or not&quot;,
<a name="4511"/> 4511:            cmd  =&gt; fun(#{sock1 := Sock1} = State) -&gt;
<a name="4512"/> 4512:                            case socket:getopt(Sock1, socket, protocol) of
<a name="4513"/> 4513:                                {ok, _} -&gt;
<a name="4514"/> 4514:                                    ?SEV_IPRINT(&quot;protocol accessible&quot;),
<a name="4515"/> 4515:                                    {ok, State#{provide_protocol =&gt; false}};
<a name="4516"/> 4516:                                {error, Reason} -&gt;
<a name="4517"/> 4517:                                    ?SEV_IPRINT(&quot;failed get protocol: &quot;
<a name="4518"/> 4518:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="4519"/> 4519:                                    {ok, State#{provide_protocol =&gt; true}}
<a name="4520"/> 4520:                            end
<a name="4521"/> 4521:                    end},
<a name="4522"/> 4522:          #{desc =&gt; &quot;open with FD&quot;,
<a name="4523"/> 4523:            cmd  =&gt; fun(#{fd               := FD,
<a name="4524"/> 4524:                          dup              := DUP,
<a name="4525"/> 4525:                          provide_domain   := PD,
<a name="4526"/> 4526:                          domain           := Domain,
<a name="4527"/> 4527:                          provide_protocol := PP,
<a name="4528"/> 4528:                          protocol         := Protocol} = State) -&gt;
<a name="4529"/> 4529:                            Opts =
<a name="4530"/> 4530:                                case {PD, PP} of
<a name="4531"/> 4531:                                    {true, true} -&gt;
<a name="4532"/> 4532:                                        #{dup      =&gt; DUP,
<a name="4533"/> 4533:                                          domain   =&gt; Domain,
<a name="4534"/> 4534:                                          protocol =&gt; Protocol};
<a name="4535"/> 4535:                                    {true, false} -&gt;
<a name="4536"/> 4536:                                        #{dup      =&gt; DUP,
<a name="4537"/> 4537:                                          domain   =&gt; Domain};
<a name="4538"/> 4538:                                    {false, true} -&gt;
<a name="4539"/> 4539:                                        #{dup      =&gt; DUP,
<a name="4540"/> 4540:                                          protocol =&gt; Protocol};
<a name="4541"/> 4541:                                    {false, false} -&gt;
<a name="4542"/> 4542:                                        #{dup      =&gt; DUP}
<a name="4543"/> 4543:                                end,
<a name="4544"/> 4544:                            ?SEV_IPRINT(&quot;try open socket with&quot;
<a name="4545"/> 4545:                                        &quot;~n   FD:   ~p&quot;
<a name="4546"/> 4546:                                        &quot;~n   Opts: ~p&quot;, [FD, Opts]),
<a name="4547"/> 4547:                            case socket:open(FD, Opts) of
<a name="4548"/> 4548:                                {ok, Sock2} -&gt;
<a name="4549"/> 4549:                                    ?SEV_IPRINT(&quot;socket 2 open&quot;),
<a name="4550"/> 4550:                                    {ok, State#{sock2 =&gt; Sock2}};
<a name="4551"/> 4551:                                {error, Reason} = ERROR -&gt;
<a name="4552"/> 4552:                                    ?SEV_EPRINT(&quot;failed open socket with FD &quot;
<a name="4553"/> 4553:                                                  &quot;(p, ~w): &quot;
<a name="4554"/> 4554:                                                &quot;~n   ~p&quot;, [FD, Reason]),
<a name="4555"/> 4555:                                    ERROR
<a name="4556"/> 4556:                            end
<a name="4557"/> 4557:                    end},
<a name="4558"/> 4558:          #{desc =&gt; &quot;get socket (1) info&quot;,
<a name="4559"/> 4559:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="4560"/> 4560:                            %% socket:setopt(Sock, otp, debug, true),
<a name="4561"/> 4561:                            Info = socket:info(Sock),
<a name="4562"/> 4562:                            %% socket:setopt(Sock, otp, debug, false),
<a name="4563"/> 4563:                            ?SEV_IPRINT(&quot;Got Info: &quot;
<a name="4564"/> 4564:                                        &quot;~n   ~p&quot;, [Info]),
<a name="4565"/> 4565:                            {ok, State#{info1 =&gt; Info}}
<a name="4566"/> 4566:                    end},
<a name="4567"/> 4567:          #{desc =&gt; &quot;get socket (2) info&quot;,
<a name="4568"/> 4568:            cmd  =&gt; fun(#{sock2 := Sock} = State) -&gt;
<a name="4569"/> 4569:                            %% socket:setopt(Sock, otp, debug, true),
<a name="4570"/> 4570:                            Info = socket:info(Sock),
<a name="4571"/> 4571:                            %% socket:setopt(Sock, otp, debug, false),
<a name="4572"/> 4572:                            ?SEV_IPRINT(&quot;Got Info: &quot;
<a name="4573"/> 4573:                                        &quot;~n   ~p&quot;, [Info]),
<a name="4574"/> 4574:                            {ok, State#{info2 =&gt; Info}}
<a name="4575"/> 4575:                    end},
<a name="4576"/> 4576:          #{desc =&gt; &quot;validate socket (1) info&quot;,
<a name="4577"/> 4577:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4578"/> 4578:                          type     := Type,
<a name="4579"/> 4579:                          protocol := Protocol,
<a name="4580"/> 4580:                          info1    := #{domain        := Domain,
<a name="4581"/> 4581:                                        type          := Type,
<a name="4582"/> 4582:                                        protocol      := Protocol,
<a name="4583"/> 4583:                                        ctype         := normal,
<a name="4584"/> 4584:                                        counters      := _,
<a name="4585"/> 4585:                                        num_readers   := 0,
<a name="4586"/> 4586:                                        num_writers   := 0,
<a name="4587"/> 4587:                                        num_acceptors := 0}}) -&gt;
<a name="4588"/> 4588:                            ok;
<a name="4589"/> 4589:                       (#{domain   := Domain,
<a name="4590"/> 4590:                          type     := Type,
<a name="4591"/> 4591:                          protocol := Protocol,
<a name="4592"/> 4592:                          info     := Info}) -&gt;
<a name="4593"/> 4593:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 1: &quot;
<a name="4594"/> 4594:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="4595"/> 4595:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="4596"/> 4596:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="4597"/> 4597:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="4598"/> 4598:                                        &quot;~n   ~p&quot;,
<a name="4599"/> 4599:                                        [Domain, Type, Protocol, normal, Info]),
<a name="4600"/> 4600:                            {error, unexpected_infio}
<a name="4601"/> 4601:                    end},
<a name="4602"/> 4602:          #{desc =&gt; &quot;validate socket (2) info&quot;,
<a name="4603"/> 4603:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4604"/> 4604:                          type     := Type,
<a name="4605"/> 4605:                          protocol := Protocol,
<a name="4606"/> 4606:                          fd       := _FD,
<a name="4607"/> 4607:                          dup      := false,
<a name="4608"/> 4608:                          info2    := #{domain        := Domain,
<a name="4609"/> 4609:                                        type          := Type,
<a name="4610"/> 4610:                                        protocol      := Protocol,
<a name="4611"/> 4611:                                        ctype         := fromfd,
<a name="4612"/> 4612:                                        counters      := _,
<a name="4613"/> 4613:                                        num_readers   := 0,
<a name="4614"/> 4614:                                        num_writers   := 0,
<a name="4615"/> 4615:                                        num_acceptors := 0}}) -&gt;
<a name="4616"/> 4616:                            ok;
<a name="4617"/> 4617:                       (#{domain   := Domain,
<a name="4618"/> 4618:                          type     := Type,
<a name="4619"/> 4619:                          protocol := Protocol,
<a name="4620"/> 4620:                          fd       := _FD,
<a name="4621"/> 4621:                          dup      := false,
<a name="4622"/> 4622:                          info     := Info}) -&gt;
<a name="4623"/> 4623:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 2: &quot;
<a name="4624"/> 4624:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="4625"/> 4625:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="4626"/> 4626:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="4627"/> 4627:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="4628"/> 4628:                                        &quot;~n   ~p&quot;,
<a name="4629"/> 4629:                                        [Domain, Type, Protocol,
<a name="4630"/> 4630:                                         fromfd, Info]),
<a name="4631"/> 4631:                            {error, unexpected_info};
<a name="4632"/> 4632:                       (#{domain   := Domain,
<a name="4633"/> 4633:                          type     := Type,
<a name="4634"/> 4634:                          protocol := Protocol,
<a name="4635"/> 4635:                          fd       := FD,
<a name="4636"/> 4636:                          dup      := true,
<a name="4637"/> 4637:                          info2    := #{domain        := Domain,
<a name="4638"/> 4638:                                        type          := Type,
<a name="4639"/> 4639:                                        protocol      := Protocol,
<a name="4640"/> 4640:                                        ctype         := {fromfd, FD},
<a name="4641"/> 4641:                                        counters      := _,
<a name="4642"/> 4642:                                        num_readers   := 0,
<a name="4643"/> 4643:                                        num_writers   := 0,
<a name="4644"/> 4644:                                        num_acceptors := 0}}) -&gt;
<a name="4645"/> 4645:                            ok;
<a name="4646"/> 4646:                       (#{domain   := Domain,
<a name="4647"/> 4647:                          type     := Type,
<a name="4648"/> 4648:                          protocol := Protocol,
<a name="4649"/> 4649:                          fd       := FD,
<a name="4650"/> 4650:                          dup      := true,
<a name="4651"/> 4651:                          info     := Info}) -&gt;
<a name="4652"/> 4652:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 2: &quot;
<a name="4653"/> 4653:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="4654"/> 4654:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="4655"/> 4655:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="4656"/> 4656:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="4657"/> 4657:                                        &quot;~n   ~p&quot;,
<a name="4658"/> 4658:                                        [Domain, Type, Protocol,
<a name="4659"/> 4659:                                         {fromfd, FD}, Info]),
<a name="4660"/> 4660:                            {error, unexpected_info}
<a name="4661"/> 4661:                    end},
<a name="4662"/> 4662:          #{desc =&gt; &quot;close socket (1)&quot;,
<a name="4663"/> 4663:            cmd  =&gt; fun(#{sock1 := Sock} = _State) -&gt;
<a name="4664"/> 4664:                            socket:close(Sock)
<a name="4665"/> 4665:                    end},
<a name="4666"/> 4666:          #{desc =&gt; &quot;close socket (2)&quot;,
<a name="4667"/> 4667:            cmd  =&gt; fun(#{sock2 := Sock} = _State) -&gt;
<a name="4668"/> 4668:                            socket:close(Sock)
<a name="4669"/> 4669:                    end},
<a name="4670"/> 4670: 
<a name="4671"/> 4671:          %% *** We are done ***
<a name="4672"/> 4672:          ?SEV_FINISH_NORMAL
<a name="4673"/> 4673:         ],
<a name="4674"/> 4674:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_ffd_open_and_info-last_expr"/><a name="4675"/> 4675: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="4676"/> 4676: 
<a name="4677"/> 4677: 
<a name="4678"/> 4678: 
<a name="4679"/> 4679: 
<a name="4680"/> 4680: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4681"/> 4681: 
<a name="4682"/> 4682: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="4683"/> 4683: <i>%% its file descriptor *without* dup.</i>
<a name="4684"/> 4684: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="4685"/> 4685: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="4686"/> 4686: <i>%% has not been closed (test by sending some data).</i>
<a name="4687"/> 4687: <i>%% IPv4 UDP (dgram) socket.</i>
<a name="4688"/> 4688: <i>%%</i>
<a name="4689"/> 4689: <i>%% &lt;WARNING&gt;</i>
<a name="4690"/> 4690: <i>%%</i>
<a name="4691"/> 4691: <i>%% This is *not* how its intended to be used.</i>
<a name="4692"/> 4692: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="4693"/> 4693: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="4694"/> 4694: <i>%% to test it!</i>
<a name="4695"/> 4695: <i>%%</i>
<a name="4696"/> 4696: <i>%% &lt;/WARNING&gt;</i>
<a name="4697"/> 4697: <i>%%</i>
<a name="api_ffd_open_and_open_wod_and_send_udp4-1"/><a name="4698"/> 4698: <b>api_ffd_open_and_open_wod_and_send_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4699"/> 4699:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wod_and_send_udp4-last_expr"/><a name="4700"/> 4700: <b>    tc_try</b>(api_ffd_open_and_open_wod_and_send_udp4,
<a name="4701"/> 4701:            fun() -&gt; has_support_ipv4() end,
<a name="4702"/> 4702:            fun() -&gt;
<a name="4703"/> 4703:                    InitState = #{domain   =&gt; inet,
<a name="4704"/> 4704:                                  type     =&gt; dgram,
<a name="4705"/> 4705:                                  protocol =&gt; udp,
<a name="4706"/> 4706:                                  dup      =&gt; false},
<a name="4707"/> 4707:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="4708"/> 4708:            end).
<a name="4709"/> 4709: 
<a name="4710"/> 4710: 
<a name="4711"/> 4711: 
<a name="4712"/> 4712: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4713"/> 4713: 
<a name="4714"/> 4714: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="4715"/> 4715: <i>%% its file descriptor *without* dup.</i>
<a name="4716"/> 4716: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="4717"/> 4717: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="4718"/> 4718: <i>%% has not been closed (test by sending some data).</i>
<a name="4719"/> 4719: <i>%% IPv6 UDP (dgram) socket.</i>
<a name="4720"/> 4720: <i>%%</i>
<a name="4721"/> 4721: <i>%% &lt;WARNING&gt;</i>
<a name="4722"/> 4722: <i>%%</i>
<a name="4723"/> 4723: <i>%% This is *not* how its intended to be used.</i>
<a name="4724"/> 4724: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="4725"/> 4725: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="4726"/> 4726: <i>%% to test it!</i>
<a name="4727"/> 4727: <i>%%</i>
<a name="4728"/> 4728: <i>%% &lt;/WARNING&gt;</i>
<a name="4729"/> 4729: <i>%%</i>
<a name="api_ffd_open_and_open_wod_and_send_udp6-1"/><a name="4730"/> 4730: <b>api_ffd_open_and_open_wod_and_send_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4731"/> 4731:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wod_and_send_udp6-last_expr"/><a name="4732"/> 4732: <b>    tc_try</b>(api_ffd_open_and_open_wod_and_send_udp6,
<a name="4733"/> 4733:            fun() -&gt; has_support_ipv6() end,
<a name="4734"/> 4734:            fun() -&gt;
<a name="4735"/> 4735:                    InitState = #{domain   =&gt; inet6,
<a name="4736"/> 4736:                                  type     =&gt; dgram,
<a name="4737"/> 4737:                                  protocol =&gt; udp,
<a name="4738"/> 4738:                                  dup      =&gt; false},
<a name="4739"/> 4739:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="4740"/> 4740:            end).
<a name="4741"/> 4741: 
<a name="4742"/> 4742: 
<a name="4743"/> 4743: 
<a name="4744"/> 4744: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4745"/> 4745: 
<a name="4746"/> 4746: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="4747"/> 4747: <i>%% its file descriptor *with* dup.</i>
<a name="4748"/> 4748: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="4749"/> 4749: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="4750"/> 4750: <i>%% has not been closed (test by sending some data).</i>
<a name="4751"/> 4751: <i>%% IPv4 UDP (dgram) socket.</i>
<a name="4752"/> 4752: <i>%%</i>
<a name="api_ffd_open_and_open_wd_and_send_udp4-1"/><a name="4753"/> 4753: <b>api_ffd_open_and_open_wd_and_send_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4754"/> 4754:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wd_and_send_udp4-last_expr"/><a name="4755"/> 4755: <b>    tc_try</b>(api_ffd_open_and_open_wd_and_send_udp4,
<a name="4756"/> 4756:            fun() -&gt; has_support_ipv4() end,
<a name="4757"/> 4757:            fun() -&gt;
<a name="4758"/> 4758:                    InitState = #{domain   =&gt; inet,
<a name="4759"/> 4759:                                  type     =&gt; dgram,
<a name="4760"/> 4760:                                  protocol =&gt; udp,
<a name="4761"/> 4761:                                  dup      =&gt; true},
<a name="4762"/> 4762:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="4763"/> 4763:            end).
<a name="4764"/> 4764: 
<a name="4765"/> 4765: 
<a name="4766"/> 4766: 
<a name="4767"/> 4767: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4768"/> 4768: 
<a name="4769"/> 4769: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="4770"/> 4770: <i>%% its file descriptor *with* dup.</i>
<a name="4771"/> 4771: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="4772"/> 4772: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="4773"/> 4773: <i>%% has not been closed (test by sending some data).</i>
<a name="4774"/> 4774: <i>%% IPv6 UDP (dgram) socket.</i>
<a name="4775"/> 4775: <i>%%</i>
<a name="api_ffd_open_and_open_wd_and_send_udp6-1"/><a name="4776"/> 4776: <b>api_ffd_open_and_open_wd_and_send_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4777"/> 4777:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wd_and_send_udp6-last_expr"/><a name="4778"/> 4778: <b>    tc_try</b>(api_ffd_open_and_open_wd_and_send_udp6,
<a name="4779"/> 4779:            fun() -&gt; has_support_ipv6() end,
<a name="4780"/> 4780:            fun() -&gt;
<a name="4781"/> 4781:                    InitState = #{domain   =&gt; inet6,
<a name="4782"/> 4782:                                  type     =&gt; dgram,
<a name="4783"/> 4783:                                  protocol =&gt; udp,
<a name="4784"/> 4784:                                  dup      =&gt; true},
<a name="4785"/> 4785:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="4786"/> 4786:            end).
<a name="4787"/> 4787: 
<a name="4788"/> 4788: 
<a name="4789"/> 4789: 
<a name="4790"/> 4790: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4791"/> 4791: 
<a name="api_ffd_open_and_open_and_send_udp-1"/><a name="4792"/> 4792: <b>api_ffd_open_and_open_and_send_udp</b>(InitState) -&gt;
<a name="4793"/> 4793:     Send = fun(Sock, Data, Dest) -&gt;
<a name="4794"/> 4794:                    socket:sendto(Sock, Data, Dest)
<a name="4795"/> 4795:            end,
<a name="4796"/> 4796:     Recv = fun(Sock) -&gt;
<a name="4797"/> 4797:                    socket:recvfrom(Sock)
<a name="4798"/> 4798:            end,
<a name="api_ffd_open_and_open_and_send_udp-last_expr"/><a name="4799"/> 4799: <b>    api_ffd_open_and_open_and_send_udp2</b>(InitState#{send   =&gt; Send,
<a name="4800"/> 4800:                                                            recv   =&gt; Recv}).
<a name="4801"/> 4801: 
<a name="api_ffd_open_and_open_and_send_udp2-1"/><a name="4802"/> 4802: <b>api_ffd_open_and_open_and_send_udp2</b>(InitState) -&gt;
<a name="4803"/> 4803:     process_flag(trap_exit, true),
<a name="4804"/> 4804:     ServerSeq = 
<a name="4805"/> 4805:         [
<a name="4806"/> 4806:          %% *** Wait for start order ***
<a name="4807"/> 4807:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="4808"/> 4808:            cmd  =&gt; fun(State) -&gt;
<a name="4809"/> 4809:                            Tester = ?SEV_AWAIT_START(),
<a name="4810"/> 4810:                            {ok, State#{tester =&gt; Tester}}
<a name="4811"/> 4811:                    end},
<a name="4812"/> 4812:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="4813"/> 4813:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4814"/> 4814:                            _MRef = erlang:monitor(process, Tester),
<a name="4815"/> 4815:                            ok
<a name="4816"/> 4816:                    end},
<a name="4817"/> 4817: 
<a name="4818"/> 4818:          %% *** Init part ***
<a name="4819"/> 4819:          #{desc =&gt; &quot;which local address&quot;,
<a name="4820"/> 4820:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="4821"/> 4821:                            LSA = which_local_socket_addr(Domain),
<a name="4822"/> 4822:                            {ok, State#{lsa =&gt; LSA}}
<a name="4823"/> 4823:                    end},
<a name="4824"/> 4824:          #{desc =&gt; &quot;create socket&quot;,
<a name="4825"/> 4825:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4826"/> 4826:                          protocol := Proto} = State) -&gt;
<a name="4827"/> 4827:                            case socket:open(Domain, dgram, Proto) of
<a name="4828"/> 4828:                                {ok, Sock} -&gt;
<a name="4829"/> 4829:                                    {ok, State#{sock =&gt; Sock}};
<a name="4830"/> 4830:                                {error, _} = ERROR -&gt;
<a name="4831"/> 4831:                                    ERROR
<a name="4832"/> 4832:                            end
<a name="4833"/> 4833:                    end},
<a name="4834"/> 4834:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="4835"/> 4835:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = State) -&gt;
<a name="4836"/> 4836:                            case sock_bind(Sock, LSA) of
<a name="4837"/> 4837:                                ok -&gt;
<a name="4838"/> 4838:                                    Port = sock_port(Sock),
<a name="4839"/> 4839:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="4840"/> 4840:                                    {ok, State#{port =&gt; Port}};
<a name="4841"/> 4841:                                {error, _} = ERROR -&gt;
<a name="4842"/> 4842:                                    ERROR
<a name="4843"/> 4843:                            end
<a name="4844"/> 4844:                    end},
<a name="4845"/> 4845:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="4846"/> 4846:            cmd  =&gt; fun(#{tester := Tester, port := Port}) -&gt;
<a name="4847"/> 4847:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="4848"/> 4848:                            ok
<a name="4849"/> 4849:                    end},
<a name="4850"/> 4850: 
<a name="4851"/> 4851:          #{desc =&gt; &quot;await request 1 (recv)&quot;,
<a name="4852"/> 4852:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="4853"/> 4853:                            case Recv(Sock) of
<a name="4854"/> 4854:                                {ok, {Source, ?BASIC_REQ}} -&gt;
<a name="4855"/> 4855:                                    ?SEV_IPRINT(&quot;received request (1) from: &quot;
<a name="4856"/> 4856:                                                &quot;~n   ~p&quot;, [Source]),
<a name="4857"/> 4857:                                    {ok, State#{source =&gt; Source}};
<a name="4858"/> 4858:                                {error, _} = ERROR -&gt;
<a name="4859"/> 4859:                                    ERROR
<a name="4860"/> 4860:                            end
<a name="4861"/> 4861:                    end},
<a name="4862"/> 4862:          #{desc =&gt; &quot;announce ready 1 (recv request)&quot;,
<a name="4863"/> 4863:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4864"/> 4864:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="4865"/> 4865:                            ok
<a name="4866"/> 4866:                    end},
<a name="4867"/> 4867:          #{desc =&gt; &quot;await continue 1 (with send reply)&quot;,
<a name="4868"/> 4868:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4869"/> 4869:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="4870"/> 4870:                    end},
<a name="4871"/> 4871:          #{desc =&gt; &quot;send reply 1&quot;,
<a name="4872"/> 4872:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="4873"/> 4873:                            Send(Sock, ?BASIC_REP, Source)
<a name="4874"/> 4874:                    end},
<a name="4875"/> 4875:          #{desc =&gt; &quot;announce ready 1 (send reply)&quot;,
<a name="4876"/> 4876:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4877"/> 4877:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="4878"/> 4878:                            {ok, maps:remove(source, State)}
<a name="4879"/> 4879:                    end},
<a name="4880"/> 4880: 
<a name="4881"/> 4881:          #{desc =&gt; &quot;await request 2 (recv)&quot;,
<a name="4882"/> 4882:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="4883"/> 4883:                            case Recv(Sock) of
<a name="4884"/> 4884:                                {ok, {Source, ?BASIC_REQ}} -&gt; 
<a name="4885"/> 4885:                                    ?SEV_IPRINT(&quot;received request (2) from: &quot;
<a name="4886"/> 4886:                                                &quot;~n   ~p&quot;, [Source]),
<a name="4887"/> 4887:                                    {ok, State#{source =&gt; Source}};
<a name="4888"/> 4888:                                {error, _} = ERROR -&gt;
<a name="4889"/> 4889:                                    ERROR
<a name="4890"/> 4890:                            end
<a name="4891"/> 4891:                    end},
<a name="4892"/> 4892:          #{desc =&gt; &quot;announce ready 2 (recv request)&quot;,
<a name="4893"/> 4893:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4894"/> 4894:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="4895"/> 4895:                            ok
<a name="4896"/> 4896:                    end},
<a name="4897"/> 4897:          #{desc =&gt; &quot;await continue 2 (with send reply)&quot;,
<a name="4898"/> 4898:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4899"/> 4899:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="4900"/> 4900:                    end},
<a name="4901"/> 4901:          #{desc =&gt; &quot;send reply 2&quot;,
<a name="4902"/> 4902:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="4903"/> 4903:                            Send(Sock, ?BASIC_REP, Source)
<a name="4904"/> 4904:                    end},
<a name="4905"/> 4905:          #{desc =&gt; &quot;announce ready 2 (send reply)&quot;,
<a name="4906"/> 4906:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4907"/> 4907:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="4908"/> 4908:                            {ok, maps:remove(source, State)}
<a name="4909"/> 4909:                    end},
<a name="4910"/> 4910: 
<a name="4911"/> 4911:          #{desc =&gt; &quot;await request 3 (recv)&quot;,
<a name="4912"/> 4912:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="4913"/> 4913:                            case Recv(Sock) of
<a name="4914"/> 4914:                                {ok, {Source, ?BASIC_REQ}} -&gt;
<a name="4915"/> 4915:                                    ?SEV_IPRINT(&quot;received request (2) from: &quot;
<a name="4916"/> 4916:                                                &quot;~n   ~p&quot;, [Source]),
<a name="4917"/> 4917:                                    {ok, State#{source =&gt; Source}};
<a name="4918"/> 4918:                                {error, _} = ERROR -&gt;
<a name="4919"/> 4919:                                    ERROR
<a name="4920"/> 4920:                            end
<a name="4921"/> 4921:                    end},
<a name="4922"/> 4922:          #{desc =&gt; &quot;announce ready 3 (recv request)&quot;,
<a name="4923"/> 4923:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4924"/> 4924:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="4925"/> 4925:                            ok
<a name="4926"/> 4926:                    end},
<a name="4927"/> 4927:          #{desc =&gt; &quot;await continue 3 (with send reply)&quot;,
<a name="4928"/> 4928:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4929"/> 4929:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="4930"/> 4930:                    end},
<a name="4931"/> 4931:          #{desc =&gt; &quot;send reply 3&quot;,
<a name="4932"/> 4932:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="4933"/> 4933:                            Send(Sock, ?BASIC_REP, Source)
<a name="4934"/> 4934:                    end},
<a name="4935"/> 4935:          #{desc =&gt; &quot;announce ready 3 (send reply)&quot;,
<a name="4936"/> 4936:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4937"/> 4937:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="4938"/> 4938:                            {ok, maps:remove(source, State)}
<a name="4939"/> 4939:                    end},
<a name="4940"/> 4940: 
<a name="4941"/> 4941:          %% *** Termination ***
<a name="4942"/> 4942:          #{desc =&gt; &quot;await terminate&quot;,
<a name="4943"/> 4943:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4944"/> 4944:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="4945"/> 4945:                                ok -&gt;
<a name="4946"/> 4946:                                    {ok, maps:remove(tester, State)};
<a name="4947"/> 4947:                                {error, _} = ERROR -&gt;
<a name="4948"/> 4948:                                    ERROR
<a name="4949"/> 4949:                            end
<a name="4950"/> 4950:                    end},
<a name="4951"/> 4951:          #{desc =&gt; &quot;close socket&quot;,
<a name="4952"/> 4952:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="4953"/> 4953:                            ok = socket:close(Sock),
<a name="4954"/> 4954:                            {ok, maps:remove(sock, State)}
<a name="4955"/> 4955:                    end},
<a name="4956"/> 4956: 
<a name="4957"/> 4957:          %% *** We are done ***
<a name="4958"/> 4958:          ?SEV_FINISH_NORMAL
<a name="4959"/> 4959:         ],
<a name="4960"/> 4960: 
<a name="4961"/> 4961: 
<a name="4962"/> 4962:     Client1Seq =
<a name="4963"/> 4963:         [
<a name="4964"/> 4964:          %% *** Wait for start order ***
<a name="4965"/> 4965:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="4966"/> 4966:            cmd  =&gt; fun(State) -&gt;
<a name="4967"/> 4967:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="4968"/> 4968:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="4969"/> 4969:                    end},
<a name="4970"/> 4970:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="4971"/> 4971:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4972"/> 4972:                            _MRef = erlang:monitor(process, Tester),
<a name="4973"/> 4973:                            ok
<a name="4974"/> 4974:                    end},
<a name="4975"/> 4975: 
<a name="4976"/> 4976:          %% *** The init part ***
<a name="4977"/> 4977:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="4978"/> 4978:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="4979"/> 4979:                            LSA = which_local_socket_addr(Domain),
<a name="4980"/> 4980:                            SSA = LSA#{port =&gt; Port},
<a name="4981"/> 4981:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="4982"/> 4982:                    end},
<a name="4983"/> 4983:          #{desc =&gt; &quot;create socket&quot;,
<a name="4984"/> 4984:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4985"/> 4985:                          protocol := Proto} = State) -&gt;
<a name="4986"/> 4986:                            case socket:open(Domain, dgram, Proto) of
<a name="4987"/> 4987:                                {ok, Sock} -&gt;
<a name="4988"/> 4988:                                    {ok, State#{sock =&gt; Sock}};
<a name="4989"/> 4989:                                {error, _} = ERROR -&gt;
<a name="4990"/> 4990:                                    ERROR
<a name="4991"/> 4991:                            end
<a name="4992"/> 4992:                    end},
<a name="4993"/> 4993:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="4994"/> 4994:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="4995"/> 4995:                            case sock_bind(Sock, LSA) of
<a name="4996"/> 4996:                                ok -&gt;
<a name="4997"/> 4997:                                    ok;
<a name="4998"/> 4998:                                {error, _} = ERROR -&gt;
<a name="4999"/> 4999:                                    ERROR
<a name="5000"/> 5000:                            end
<a name="5001"/> 5001:                    end},
<a name="5002"/> 5002:          #{desc =&gt; &quot;get socket FD&quot;,
<a name="5003"/> 5003:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5004"/> 5004:                            case socket:getopt(Sock, otp, fd) of
<a name="5005"/> 5005:                                {ok, FD} -&gt;
<a name="5006"/> 5006:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="5007"/> 5007:                                    {ok, State#{fd =&gt; FD}};
<a name="5008"/> 5008:                                {error, Reason} = ERROR -&gt;
<a name="5009"/> 5009:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="5010"/> 5010:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5011"/> 5011:                                    ERROR
<a name="5012"/> 5012:                            end
<a name="5013"/> 5013:                    end},
<a name="5014"/> 5014:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5015"/> 5015:            cmd  =&gt; fun(#{tester := Tester,
<a name="5016"/> 5016:                          fd     := FD}) -&gt;
<a name="5017"/> 5017:                            ?SEV_ANNOUNCE_READY(Tester, init, FD),
<a name="5018"/> 5018:                            ok
<a name="5019"/> 5019:                    end},
<a name="5020"/> 5020: 
<a name="5021"/> 5021:          %% *** The actual test ***
<a name="5022"/> 5022:          #{desc =&gt; &quot;await continue (send request 1)&quot;,
<a name="5023"/> 5023:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5024"/> 5024:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5025"/> 5025:                    end},
<a name="5026"/> 5026:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="5027"/> 5027:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="5028"/> 5028:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="5029"/> 5029:                    end},
<a name="5030"/> 5030:          #{desc =&gt; &quot;announce ready (send request 1)&quot;,
<a name="5031"/> 5031:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5032"/> 5032:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5033"/> 5033:                            ok
<a name="5034"/> 5034:                    end},
<a name="5035"/> 5035:          #{desc =&gt; &quot;await recv reply 1 (from server)&quot;,
<a name="5036"/> 5036:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5037"/> 5037:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="5038"/> 5038:                            ok
<a name="5039"/> 5039:                    end},
<a name="5040"/> 5040:          #{desc =&gt; &quot;announce ready (recv reply 1)&quot;,
<a name="5041"/> 5041:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5042"/> 5042:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5043"/> 5043:                            ok
<a name="5044"/> 5044:                    end},
<a name="5045"/> 5045: 
<a name="5046"/> 5046:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="5047"/> 5047:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5048"/> 5048:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5049"/> 5049:                    end},
<a name="5050"/> 5050:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="5051"/> 5051:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="5052"/> 5052:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="5053"/> 5053:                    end},
<a name="5054"/> 5054:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="5055"/> 5055:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5056"/> 5056:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5057"/> 5057:                            ok
<a name="5058"/> 5058:                    end},
<a name="5059"/> 5059:          #{desc =&gt; &quot;await recv reply 3 (from server)&quot;,
<a name="5060"/> 5060:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5061"/> 5061:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="5062"/> 5062:                            ok
<a name="5063"/> 5063:                    end},
<a name="5064"/> 5064:          #{desc =&gt; &quot;announce ready (recv reply 3)&quot;,
<a name="5065"/> 5065:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5066"/> 5066:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5067"/> 5067:                            ok
<a name="5068"/> 5068:                    end},
<a name="5069"/> 5069: 
<a name="5070"/> 5070:          %% *** Termination ***
<a name="5071"/> 5071:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5072"/> 5072:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5073"/> 5073:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5074"/> 5074:                                ok -&gt;
<a name="5075"/> 5075:                                    {ok, maps:remove(tester, State)};
<a name="5076"/> 5076:                                {error, _} = ERROR -&gt;
<a name="5077"/> 5077:                                    ERROR
<a name="5078"/> 5078:                            end
<a name="5079"/> 5079:                    end},
<a name="5080"/> 5080:          #{desc =&gt; &quot;close socket&quot;,
<a name="5081"/> 5081:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5082"/> 5082:                            ok = socket:close(Sock),
<a name="5083"/> 5083:                            {ok, maps:remove(sock, State)}
<a name="5084"/> 5084:                    end},
<a name="5085"/> 5085: 
<a name="5086"/> 5086:          %% *** We are done ***
<a name="5087"/> 5087:          ?SEV_FINISH_NORMAL
<a name="5088"/> 5088:         ],
<a name="5089"/> 5089: 
<a name="5090"/> 5090: 
<a name="5091"/> 5091:     Client2Seq =
<a name="5092"/> 5092:         [
<a name="5093"/> 5093:          %% *** Wait for start order ***
<a name="5094"/> 5094:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5095"/> 5095:            cmd  =&gt; fun(State) -&gt;
<a name="5096"/> 5096:                            {Tester, {Port, FD}} = ?SEV_AWAIT_START(),
<a name="5097"/> 5097:                            {ok, State#{tester      =&gt; Tester,
<a name="5098"/> 5098:                                        server_port =&gt; Port,
<a name="5099"/> 5099:                                        fd          =&gt; FD}}
<a name="5100"/> 5100:                    end},
<a name="5101"/> 5101:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5102"/> 5102:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5103"/> 5103:                            _MRef = erlang:monitor(process, Tester),
<a name="5104"/> 5104:                            ok
<a name="5105"/> 5105:                    end},
<a name="5106"/> 5106: 
<a name="5107"/> 5107:          %% *** The init part ***
<a name="5108"/> 5108:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="5109"/> 5109:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="5110"/> 5110:                            LSA = which_local_socket_addr(Domain),
<a name="5111"/> 5111:                            SSA = LSA#{port =&gt; Port},
<a name="5112"/> 5112:                            {ok, State#{server_sa =&gt; SSA}}
<a name="5113"/> 5113:                    end},
<a name="5114"/> 5114:          #{desc =&gt; &quot;create socket&quot;,
<a name="5115"/> 5115:            cmd  =&gt; fun(#{fd     := FD,
<a name="5116"/> 5116:                          dup    := DUP,
<a name="5117"/> 5117:                          domain := Domain} = State) -&gt;
<a name="5118"/> 5118:                            ?SEV_IPRINT(&quot;try create socket with: &quot;
<a name="5119"/> 5119:                                        &quot;~n   FD:     ~p&quot;
<a name="5120"/> 5120:                                        &quot;~n   DUP:    ~p&quot;
<a name="5121"/> 5121:                                        &quot;~n   Domain: ~p&quot;, [FD, DUP, Domain]),
<a name="5122"/> 5122:                            %% On some platforms (Darwin and NetBSD) domain
<a name="5123"/> 5123:                            %% is needed...
<a name="5124"/> 5124:                            case socket:open(FD, #{dup    =&gt; DUP,
<a name="5125"/> 5125:                                                   domain =&gt; Domain}) of
<a name="5126"/> 5126:                                {ok, Sock} -&gt;
<a name="5127"/> 5127:                                    {ok, State#{sock =&gt; Sock}};
<a name="5128"/> 5128:                                {error,
<a name="5129"/> 5129:                                 {invalid,{options,domain,#{dup := DUP}}} = R} -&gt;
<a name="5130"/> 5130:                                    ?SEV_EPRINT(&quot;failed create socket:&quot;
<a name="5131"/> 5131:                                                &quot;~n   ~p&quot;, [R]),
<a name="5132"/> 5132:                                    {skip, domain};
<a name="5133"/> 5133:                                {error, Reason} = ERROR -&gt;
<a name="5134"/> 5134:                                    ?SEV_EPRINT(&quot;failed create socket:&quot;
<a name="5135"/> 5135:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5136"/> 5136:                                    ERROR
<a name="5137"/> 5137:                            end
<a name="5138"/> 5138:                    end},
<a name="5139"/> 5139:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5140"/> 5140:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5141"/> 5141:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="5142"/> 5142:                            ok
<a name="5143"/> 5143:                    end},
<a name="5144"/> 5144: 
<a name="5145"/> 5145:          %% *** The actual test ***
<a name="5146"/> 5146:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="5147"/> 5147:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5148"/> 5148:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5149"/> 5149:                    end},
<a name="5150"/> 5150:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="5151"/> 5151:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="5152"/> 5152:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="5153"/> 5153:                    end},
<a name="5154"/> 5154:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="5155"/> 5155:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5156"/> 5156:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5157"/> 5157:                            ok
<a name="5158"/> 5158:                    end},
<a name="5159"/> 5159:          #{desc =&gt; &quot;await recv reply 2 (from server)&quot;,
<a name="5160"/> 5160:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5161"/> 5161:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="5162"/> 5162:                            ok
<a name="5163"/> 5163:                    end},
<a name="5164"/> 5164:          #{desc =&gt; &quot;announce ready (recv reply 2)&quot;,
<a name="5165"/> 5165:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5166"/> 5166:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5167"/> 5167:                            ok
<a name="5168"/> 5168:                    end},
<a name="5169"/> 5169: 
<a name="5170"/> 5170:          %% *** Termination ***
<a name="5171"/> 5171:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5172"/> 5172:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5173"/> 5173:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5174"/> 5174:                                ok -&gt;
<a name="5175"/> 5175:                                    {ok, maps:remove(tester, State)};
<a name="5176"/> 5176:                                {error, _} = ERROR -&gt;
<a name="5177"/> 5177:                                    ERROR
<a name="5178"/> 5178:                            end
<a name="5179"/> 5179:                    end},
<a name="5180"/> 5180:          #{desc =&gt; &quot;close socket&quot;,
<a name="5181"/> 5181:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5182"/> 5182:                            ok = socket:close(Sock),
<a name="5183"/> 5183:                            {ok, maps:remove(sock, State)}
<a name="5184"/> 5184:                    end},
<a name="5185"/> 5185: 
<a name="5186"/> 5186:          %% *** We are done ***
<a name="5187"/> 5187:          ?SEV_FINISH_NORMAL
<a name="5188"/> 5188:         ],
<a name="5189"/> 5189: 
<a name="5190"/> 5190: 
<a name="5191"/> 5191:     TesterSeq =
<a name="5192"/> 5192:         [
<a name="5193"/> 5193:          %% *** Init part ***
<a name="5194"/> 5194:          #{desc =&gt; &quot;monitor server&quot;,
<a name="5195"/> 5195:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="5196"/> 5196:                            _MRef = erlang:monitor(process, Pid),
<a name="5197"/> 5197:                            ok
<a name="5198"/> 5198:                    end},
<a name="5199"/> 5199:          #{desc =&gt; &quot;monitor client 1&quot;,
<a name="5200"/> 5200:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="5201"/> 5201:                            _MRef = erlang:monitor(process, Pid),
<a name="5202"/> 5202:                            ok
<a name="5203"/> 5203:                    end},
<a name="5204"/> 5204:          #{desc =&gt; &quot;monitor client 2&quot;,
<a name="5205"/> 5205:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="5206"/> 5206:                            _MRef = erlang:monitor(process, Pid),
<a name="5207"/> 5207:                            ok
<a name="5208"/> 5208:                    end},
<a name="5209"/> 5209: 
<a name="5210"/> 5210:          %% Start the server
<a name="5211"/> 5211:          #{desc =&gt; &quot;order server start&quot;,
<a name="5212"/> 5212:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="5213"/> 5213:                            ?SEV_ANNOUNCE_START(Pid),
<a name="5214"/> 5214:                            ok
<a name="5215"/> 5215:                    end},
<a name="5216"/> 5216:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="5217"/> 5217:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="5218"/> 5218:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="5219"/> 5219:                            {ok, State#{server_port =&gt; Port}}
<a name="5220"/> 5220:                    end},
<a name="5221"/> 5221: 
<a name="5222"/> 5222:          %% Start the client 1
<a name="5223"/> 5223:          #{desc =&gt; &quot;order client 1 start&quot;,
<a name="5224"/> 5224:            cmd  =&gt; fun(#{client1 := Pid, server_port := Port} = _State) -&gt;
<a name="5225"/> 5225:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="5226"/> 5226:                            ok
<a name="5227"/> 5227:                    end},
<a name="5228"/> 5228:          #{desc =&gt; &quot;await client 1 ready (init)&quot;,
<a name="5229"/> 5229:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="5230"/> 5230:                            case ?SEV_AWAIT_READY(Pid, client1, init) of
<a name="5231"/> 5231:                                {ok, FD} -&gt;
<a name="5232"/> 5232:                                    {ok, State#{fd =&gt; FD}};
<a name="5233"/> 5233:                                {error, Reason} = ERROR -&gt;
<a name="5234"/> 5234:                                    ?SEV_EPRINT(&quot;Client 1 init error: &quot;
<a name="5235"/> 5235:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5236"/> 5236:                                    ERROR
<a name="5237"/> 5237:                            end
<a name="5238"/> 5238:                    end},
<a name="5239"/> 5239: 
<a name="5240"/> 5240:          ?SEV_SLEEP(?SECS(1)),
<a name="5241"/> 5241: 
<a name="5242"/> 5242:          %% Start the client 2
<a name="5243"/> 5243:          #{desc =&gt; &quot;order client 2 start&quot;,
<a name="5244"/> 5244:            cmd  =&gt; fun(#{client2     := Pid,
<a name="5245"/> 5245:                          server_port := Port,
<a name="5246"/> 5246:                          fd          := FD} = _State) -&gt;
<a name="5247"/> 5247:                            ?SEV_ANNOUNCE_START(Pid, {Port, FD}),
<a name="5248"/> 5248:                            ok
<a name="5249"/> 5249:                    end},
<a name="5250"/> 5250:          #{desc =&gt; &quot;await client 2 ready (init)&quot;,
<a name="5251"/> 5251:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="5252"/> 5252:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="5253"/> 5253:                    end},
<a name="5254"/> 5254: 
<a name="5255"/> 5255:          %% *** The actual test ***
<a name="5256"/> 5256: 
<a name="5257"/> 5257:          #{desc =&gt; &quot;order client 1 to continue (with send request 1)&quot;,
<a name="5258"/> 5258:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5259"/> 5259:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="5260"/> 5260:                            ok
<a name="5261"/> 5261:                    end},
<a name="5262"/> 5262:          #{desc =&gt; &quot;await client 1 ready (with send request 1)&quot;,
<a name="5263"/> 5263:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5264"/> 5264:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="5265"/> 5265:                    end},
<a name="5266"/> 5266:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="5267"/> 5267:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5268"/> 5268:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="5269"/> 5269:                    end},
<a name="5270"/> 5270:          #{desc =&gt; &quot;order server to continue (with send reply 1)&quot;,
<a name="5271"/> 5271:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5272"/> 5272:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="5273"/> 5273:                            ok
<a name="5274"/> 5274:                    end},
<a name="5275"/> 5275:          #{desc =&gt; &quot;await server ready (with reply 1 sent)&quot;,
<a name="5276"/> 5276:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5277"/> 5277:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="5278"/> 5278:                    end},
<a name="5279"/> 5279:          #{desc =&gt; &quot;await client 1 ready (reply recv 1)&quot;,
<a name="5280"/> 5280:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5281"/> 5281:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="5282"/> 5282:                    end},
<a name="5283"/> 5283: 
<a name="5284"/> 5284: 
<a name="5285"/> 5285:          #{desc =&gt; &quot;order client 2 to continue (with send request 2)&quot;,
<a name="5286"/> 5286:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="5287"/> 5287:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="5288"/> 5288:                            ok
<a name="5289"/> 5289:                    end},
<a name="5290"/> 5290:          #{desc =&gt; &quot;await client 2 ready (with send request 2)&quot;,
<a name="5291"/> 5291:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="5292"/> 5292:                            ?SEV_AWAIT_READY(Client, client2, send_req)
<a name="5293"/> 5293:                    end},
<a name="5294"/> 5294:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="5295"/> 5295:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5296"/> 5296:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="5297"/> 5297:                    end},
<a name="5298"/> 5298:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="5299"/> 5299:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5300"/> 5300:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="5301"/> 5301:                            ok
<a name="5302"/> 5302:                    end},
<a name="5303"/> 5303:          #{desc =&gt; &quot;await server ready (with reply 2 sent)&quot;,
<a name="5304"/> 5304:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5305"/> 5305:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="5306"/> 5306:                    end},
<a name="5307"/> 5307:          #{desc =&gt; &quot;await client 2 ready (reply recv 2)&quot;,
<a name="5308"/> 5308:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="5309"/> 5309:                            ?SEV_AWAIT_READY(Client, client2, recv_reply)
<a name="5310"/> 5310:                    end},
<a name="5311"/> 5311: 
<a name="5312"/> 5312: 
<a name="5313"/> 5313:          #{desc =&gt; &quot;order client 2 to terminate&quot;,
<a name="5314"/> 5314:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="5315"/> 5315:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="5316"/> 5316:                            ok
<a name="5317"/> 5317:                    end},
<a name="5318"/> 5318:          #{desc =&gt; &quot;await client 2 termination&quot;,
<a name="5319"/> 5319:            cmd  =&gt; fun(#{client2 := Client} = State) -&gt;
<a name="5320"/> 5320:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="5321"/> 5321:                            State1 = maps:remove(client2, State),
<a name="5322"/> 5322:                            {ok, State1}
<a name="5323"/> 5323:                    end},
<a name="5324"/> 5324: 
<a name="5325"/> 5325: 
<a name="5326"/> 5326:          #{desc =&gt; &quot;order client 1 to continue (with send request 3)&quot;,
<a name="5327"/> 5327:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5328"/> 5328:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="5329"/> 5329:                            ok
<a name="5330"/> 5330:                    end},
<a name="5331"/> 5331:          #{desc =&gt; &quot;await client 1 ready (with send request 3)&quot;,
<a name="5332"/> 5332:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5333"/> 5333:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="5334"/> 5334:                    end},
<a name="5335"/> 5335:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="5336"/> 5336:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5337"/> 5337:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="5338"/> 5338:                    end},
<a name="5339"/> 5339:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="5340"/> 5340:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5341"/> 5341:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="5342"/> 5342:                            ok
<a name="5343"/> 5343:                    end},
<a name="5344"/> 5344:          #{desc =&gt; &quot;await server ready (with reply 3 sent)&quot;,
<a name="5345"/> 5345:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5346"/> 5346:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="5347"/> 5347:                    end},
<a name="5348"/> 5348:          #{desc =&gt; &quot;await client 1 ready (reply recv 3)&quot;,
<a name="5349"/> 5349:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5350"/> 5350:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="5351"/> 5351:                    end},
<a name="5352"/> 5352: 
<a name="5353"/> 5353: 
<a name="5354"/> 5354:          %% *** Termination ***
<a name="5355"/> 5355:          #{desc =&gt; &quot;order client 1 to terminate&quot;,
<a name="5356"/> 5356:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5357"/> 5357:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="5358"/> 5358:                            ok
<a name="5359"/> 5359:                    end},
<a name="5360"/> 5360:          #{desc =&gt; &quot;await client 1 termination&quot;,
<a name="5361"/> 5361:            cmd  =&gt; fun(#{client1 := Client} = State) -&gt;
<a name="5362"/> 5362:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="5363"/> 5363:                            State1 = maps:remove(client1, State),
<a name="5364"/> 5364:                            {ok, State1}
<a name="5365"/> 5365:                    end},
<a name="5366"/> 5366:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="5367"/> 5367:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5368"/> 5368:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="5369"/> 5369:                            ok
<a name="5370"/> 5370:                    end},
<a name="5371"/> 5371:          #{desc =&gt; &quot;await server termination&quot;,
<a name="5372"/> 5372:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="5373"/> 5373:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="5374"/> 5374:                            State1 = maps:remove(server, State),
<a name="5375"/> 5375:                            {ok, State1}
<a name="5376"/> 5376:                    end},
<a name="5377"/> 5377: 
<a name="5378"/> 5378:          %% *** We are done ***
<a name="5379"/> 5379:          ?SEV_FINISH_NORMAL
<a name="5380"/> 5380:         ],
<a name="5381"/> 5381: 
<a name="5382"/> 5382:     i(&quot;start server evaluator&quot;),
<a name="5383"/> 5383:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, maps:remove(dup, InitState)),
<a name="5384"/> 5384: 
<a name="5385"/> 5385:     i(&quot;start (socket origin) client 1 evaluator&quot;),
<a name="5386"/> 5386:     Client1 = ?SEV_START(&quot;client-1&quot;, Client1Seq, maps:remove(dup, InitState)),
<a name="5387"/> 5387:     i(&quot;await evaluator(s)&quot;),
<a name="5388"/> 5388: 
<a name="5389"/> 5389:     i(&quot;start client 2 evaluator&quot;),
<a name="5390"/> 5390:     Client2 = ?SEV_START(&quot;client-2&quot;, Client2Seq, InitState),
<a name="5391"/> 5391:     i(&quot;await evaluator(s)&quot;),
<a name="5392"/> 5392: 
<a name="5393"/> 5393:     i(&quot;start tester evaluator&quot;),
<a name="5394"/> 5394:     TesterInitState = #{server  =&gt; Server#ev.pid,
<a name="5395"/> 5395:                         client1 =&gt; Client1#ev.pid,
<a name="5396"/> 5396:                         client2 =&gt; Client2#ev.pid},
<a name="5397"/> 5397:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="5398"/> 5398: 
<a name="api_ffd_open_and_open_and_send_udp2-last_expr"/><a name="5399"/> 5399: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client1, Client2, Tester]).
<a name="5400"/> 5400: 
<a name="5401"/> 5401: 
<a name="5402"/> 5402: 
<a name="5403"/> 5403: 
<a name="5404"/> 5404: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5405"/> 5405: 
<a name="5406"/> 5406: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="5407"/> 5407: <i>%% another socket (2) from its file descriptor *without* dup.</i>
<a name="5408"/> 5408: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5409"/> 5409: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5410"/> 5410: <i>%% has not been closed (test by sending some data).</i>
<a name="5411"/> 5411: <i>%% IPv4 TCP (stream) socket.</i>
<a name="5412"/> 5412: <i>%%</i>
<a name="5413"/> 5413: <i>%% &lt;WARNING&gt;</i>
<a name="5414"/> 5414: <i>%%</i>
<a name="5415"/> 5415: <i>%% This is *not* how its intended to be used.</i>
<a name="5416"/> 5416: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="5417"/> 5417: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="5418"/> 5418: <i>%% to test it!</i>
<a name="5419"/> 5419: <i>%%</i>
<a name="5420"/> 5420: <i>%% &lt;/WARNING&gt;</i>
<a name="5421"/> 5421: <i>%%</i>
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp4-1"/><a name="5422"/> 5422: <b>api_ffd_open_connect_and_open_wod_and_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5423"/> 5423:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp4-last_expr"/><a name="5424"/> 5424: <b>    tc_try</b>(api_ffd_open_connect_and_open_wod_and_send_tcp4,
<a name="5425"/> 5425:            fun() -&gt;
<a name="5426"/> 5426:                    InitState = #{domain   =&gt; inet,
<a name="5427"/> 5427:                                  type     =&gt; stream,
<a name="5428"/> 5428:                                  protocol =&gt; tcp,
<a name="5429"/> 5429:                                  dup      =&gt; false},
<a name="5430"/> 5430:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="5431"/> 5431:            end).
<a name="5432"/> 5432: 
<a name="5433"/> 5433: 
<a name="5434"/> 5434: 
<a name="5435"/> 5435: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5436"/> 5436: 
<a name="5437"/> 5437: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="5438"/> 5438: <i>%% another socket (2) from its file descriptor *without* dup.</i>
<a name="5439"/> 5439: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5440"/> 5440: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5441"/> 5441: <i>%% has not been closed (test by sending some data).</i>
<a name="5442"/> 5442: <i>%% IPv6 TCP (stream) socket.</i>
<a name="5443"/> 5443: <i>%%</i>
<a name="5444"/> 5444: <i>%% &lt;WARNING&gt;</i>
<a name="5445"/> 5445: <i>%%</i>
<a name="5446"/> 5446: <i>%% This is *not* how its intended to be used.</i>
<a name="5447"/> 5447: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="5448"/> 5448: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="5449"/> 5449: <i>%% to test it!</i>
<a name="5450"/> 5450: <i>%%</i>
<a name="5451"/> 5451: <i>%% &lt;/WARNING&gt;</i>
<a name="5452"/> 5452: <i>%%</i>
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp6-1"/><a name="5453"/> 5453: <b>api_ffd_open_connect_and_open_wod_and_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5454"/> 5454:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp6-last_expr"/><a name="5455"/> 5455: <b>    tc_try</b>(api_ffd_open_connect_and_open_wod_and_send_tcp6,
<a name="5456"/> 5456:            fun() -&gt; has_support_ipv6() end,
<a name="5457"/> 5457:            fun() -&gt;
<a name="5458"/> 5458:                    InitState = #{domain   =&gt; inet6,
<a name="5459"/> 5459:                                  type     =&gt; stream,
<a name="5460"/> 5460:                                  protocol =&gt; tcp,
<a name="5461"/> 5461:                                  dup      =&gt; false},
<a name="5462"/> 5462:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="5463"/> 5463:            end).
<a name="5464"/> 5464: 
<a name="5465"/> 5465: 
<a name="5466"/> 5466: 
<a name="5467"/> 5467: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5468"/> 5468: 
<a name="5469"/> 5469: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="5470"/> 5470: <i>%% another socket (2) from its file descriptor *with* dup.</i>
<a name="5471"/> 5471: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5472"/> 5472: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5473"/> 5473: <i>%% has not been closed (test by sending some data).</i>
<a name="5474"/> 5474: <i>%% IPv4 TCP (stream) socket.</i>
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp4-1"/><a name="5475"/> 5475: <b>api_ffd_open_connect_and_open_wd_and_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5476"/> 5476:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp4-last_expr"/><a name="5477"/> 5477: <b>    tc_try</b>(api_ffd_open_connect_and_open_wd_and_send_tcp4,
<a name="5478"/> 5478:            fun() -&gt;
<a name="5479"/> 5479:                    InitState = #{domain   =&gt; inet,
<a name="5480"/> 5480:                                  type     =&gt; stream,
<a name="5481"/> 5481:                                  protocol =&gt; tcp,
<a name="5482"/> 5482:                                  dup      =&gt; true},
<a name="5483"/> 5483:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="5484"/> 5484:            end).
<a name="5485"/> 5485: 
<a name="5486"/> 5486: 
<a name="5487"/> 5487: 
<a name="5488"/> 5488: 
<a name="5489"/> 5489: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5490"/> 5490: 
<a name="5491"/> 5491: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="5492"/> 5492: <i>%% another socket (2) from its file descriptor *with* dup.</i>
<a name="5493"/> 5493: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5494"/> 5494: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5495"/> 5495: <i>%% has not been closed (test by sending some data).</i>
<a name="5496"/> 5496: <i>%% IPv6 TCP (stream) socket.</i>
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp6-1"/><a name="5497"/> 5497: <b>api_ffd_open_connect_and_open_wd_and_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5498"/> 5498:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp6-last_expr"/><a name="5499"/> 5499: <b>    tc_try</b>(api_ffd_open_connect_and_open_wd_and_send_tcp6,
<a name="5500"/> 5500:            fun() -&gt; has_support_ipv6() end,
<a name="5501"/> 5501:            fun() -&gt;
<a name="5502"/> 5502:                    InitState = #{domain   =&gt; inet6,
<a name="5503"/> 5503:                                  type     =&gt; stream,
<a name="5504"/> 5504:                                  protocol =&gt; tcp,
<a name="5505"/> 5505:                                  dup      =&gt; true},
<a name="5506"/> 5506:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="5507"/> 5507:            end).
<a name="5508"/> 5508: 
<a name="5509"/> 5509: 
<a name="5510"/> 5510: 
<a name="5511"/> 5511: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5512"/> 5512: 
<a name="api_ffd_open_connect_and_open_and_send_tcp-1"/><a name="5513"/> 5513: <b>api_ffd_open_connect_and_open_and_send_tcp</b>(InitState) -&gt;
<a name="5514"/> 5514:     Send = fun(Sock, Data) -&gt;
<a name="5515"/> 5515:                    socket:send(Sock, Data)
<a name="5516"/> 5516:            end,
<a name="5517"/> 5517:     Recv = fun(Sock) -&gt;
<a name="5518"/> 5518:                    socket:recv(Sock)
<a name="5519"/> 5519:            end,
<a name="api_ffd_open_connect_and_open_and_send_tcp-last_expr"/><a name="5520"/> 5520: <b>    api_ffd_open_connect_and_open_and_send_tcp2</b>(InitState#{send   =&gt; Send,
<a name="5521"/> 5521:                                                            recv   =&gt; Recv}).
<a name="5522"/> 5522: 
<a name="api_ffd_open_connect_and_open_and_send_tcp2-1"/><a name="5523"/> 5523: <b>api_ffd_open_connect_and_open_and_send_tcp2</b>(InitState) -&gt;
<a name="5524"/> 5524:     process_flag(trap_exit, true),
<a name="5525"/> 5525:     ServerSeq = 
<a name="5526"/> 5526:         [
<a name="5527"/> 5527:          %% *** Wait for start order ***
<a name="5528"/> 5528:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5529"/> 5529:            cmd  =&gt; fun(State) -&gt;
<a name="5530"/> 5530:                            Tester = ?SEV_AWAIT_START(),
<a name="5531"/> 5531:                            {ok, State#{tester =&gt; Tester}}
<a name="5532"/> 5532:                    end},
<a name="5533"/> 5533:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5534"/> 5534:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5535"/> 5535:                            _MRef = erlang:monitor(process, Tester),
<a name="5536"/> 5536:                            ok
<a name="5537"/> 5537:                    end},
<a name="5538"/> 5538: 
<a name="5539"/> 5539:          %% *** Init part ***
<a name="5540"/> 5540:          #{desc =&gt; &quot;which local address&quot;,
<a name="5541"/> 5541:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="5542"/> 5542:                            LSA = which_local_socket_addr(Domain),
<a name="5543"/> 5543:                            {ok, State#{lsa =&gt; LSA}}
<a name="5544"/> 5544:                    end},
<a name="5545"/> 5545:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="5546"/> 5546:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5547"/> 5547:                          protocol := Proto} = State) -&gt;
<a name="5548"/> 5548:                            case socket:open(Domain, stream, Proto) of
<a name="5549"/> 5549:                                {ok, Sock} -&gt;
<a name="5550"/> 5550:                                    {ok, State#{lsock =&gt; Sock}};
<a name="5551"/> 5551:                                {error, _} = ERROR -&gt;
<a name="5552"/> 5552:                                    ERROR
<a name="5553"/> 5553:                            end
<a name="5554"/> 5554:                    end},
<a name="5555"/> 5555:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="5556"/> 5556:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="5557"/> 5557:                            case sock_bind(LSock, LSA) of
<a name="5558"/> 5558:                                ok -&gt;
<a name="5559"/> 5559:                                    Port = sock_port(LSock),
<a name="5560"/> 5560:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="5561"/> 5561:                                    {ok, State#{lport =&gt; Port}};
<a name="5562"/> 5562:                                {error, _} = ERROR -&gt;
<a name="5563"/> 5563:                                    ERROR
<a name="5564"/> 5564:                            end
<a name="5565"/> 5565:                    end},
<a name="5566"/> 5566:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="5567"/> 5567:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="5568"/> 5568:                            socket:listen(LSock)
<a name="5569"/> 5569:                    end},
<a name="5570"/> 5570:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5571"/> 5571:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="5572"/> 5572:                            %% This is actually not used for unix domain socket
<a name="5573"/> 5573:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="5574"/> 5574:                            ok
<a name="5575"/> 5575:                    end},
<a name="5576"/> 5576: 
<a name="5577"/> 5577:          %% The actual test
<a name="5578"/> 5578:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="5579"/> 5579:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5580"/> 5580:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="5581"/> 5581:                    end},
<a name="5582"/> 5582:          #{desc =&gt; &quot;await connection&quot;,
<a name="5583"/> 5583:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="5584"/> 5584:                            case socket:accept(LSock) of
<a name="5585"/> 5585:                                {ok, Sock} -&gt;
<a name="5586"/> 5586:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="5587"/> 5587:                                    {ok, State#{csock =&gt; Sock}};
<a name="5588"/> 5588:                                {error, _} = ERROR -&gt;
<a name="5589"/> 5589:                                    ERROR
<a name="5590"/> 5590:                            end
<a name="5591"/> 5591:                    end},
<a name="5592"/> 5592:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="5593"/> 5593:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5594"/> 5594:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="5595"/> 5595:                            ok
<a name="5596"/> 5596:                    end},
<a name="5597"/> 5597: 
<a name="5598"/> 5598:          #{desc =&gt; &quot;await request 1 (recv)&quot;,
<a name="5599"/> 5599:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="5600"/> 5600:                            case Recv(Sock) of
<a name="5601"/> 5601:                                {ok, ?BASIC_REQ} -&gt;
<a name="5602"/> 5602:                                    ok;
<a name="5603"/> 5603:                                {error, _} = ERROR -&gt;
<a name="5604"/> 5604:                                    ERROR
<a name="5605"/> 5605:                            end
<a name="5606"/> 5606:                    end},
<a name="5607"/> 5607:          #{desc =&gt; &quot;announce ready 1 (recv request)&quot;,
<a name="5608"/> 5608:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5609"/> 5609:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="5610"/> 5610:                            ok
<a name="5611"/> 5611:                    end},
<a name="5612"/> 5612:          #{desc =&gt; &quot;await continue 1 (with send reply)&quot;,
<a name="5613"/> 5613:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5614"/> 5614:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="5615"/> 5615:                    end},
<a name="5616"/> 5616:          #{desc =&gt; &quot;send reply 1&quot;,
<a name="5617"/> 5617:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="5618"/> 5618:                            Send(Sock, ?BASIC_REP)
<a name="5619"/> 5619:                    end},
<a name="5620"/> 5620:          #{desc =&gt; &quot;announce ready 1 (send reply)&quot;,
<a name="5621"/> 5621:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5622"/> 5622:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="5623"/> 5623:                            ok
<a name="5624"/> 5624:                    end},
<a name="5625"/> 5625: 
<a name="5626"/> 5626:          #{desc =&gt; &quot;await request 2 (recv)&quot;,
<a name="5627"/> 5627:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="5628"/> 5628:                            case Recv(Sock) of
<a name="5629"/> 5629:                                {ok, ?BASIC_REQ} -&gt;
<a name="5630"/> 5630:                                    ok;
<a name="5631"/> 5631:                                {error, _} = ERROR -&gt;
<a name="5632"/> 5632:                                    ERROR
<a name="5633"/> 5633:                            end
<a name="5634"/> 5634:                    end},
<a name="5635"/> 5635:          #{desc =&gt; &quot;announce ready 2 (recv request)&quot;,
<a name="5636"/> 5636:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5637"/> 5637:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="5638"/> 5638:                            ok
<a name="5639"/> 5639:                    end},
<a name="5640"/> 5640:          #{desc =&gt; &quot;await continue 2 (with send reply)&quot;,
<a name="5641"/> 5641:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5642"/> 5642:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="5643"/> 5643:                    end},
<a name="5644"/> 5644:          #{desc =&gt; &quot;send reply 2&quot;,
<a name="5645"/> 5645:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="5646"/> 5646:                            Send(Sock, ?BASIC_REP)
<a name="5647"/> 5647:                    end},
<a name="5648"/> 5648:          #{desc =&gt; &quot;announce ready 2 (send reply)&quot;,
<a name="5649"/> 5649:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5650"/> 5650:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="5651"/> 5651:                            ok
<a name="5652"/> 5652:                    end},
<a name="5653"/> 5653: 
<a name="5654"/> 5654:          #{desc =&gt; &quot;await request 3 (recv)&quot;,
<a name="5655"/> 5655:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="5656"/> 5656:                            case Recv(Sock) of
<a name="5657"/> 5657:                                {ok, ?BASIC_REQ} -&gt;
<a name="5658"/> 5658:                                    ok;
<a name="5659"/> 5659:                                {error, _} = ERROR -&gt;
<a name="5660"/> 5660:                                    ERROR
<a name="5661"/> 5661:                            end
<a name="5662"/> 5662:                    end},
<a name="5663"/> 5663:          #{desc =&gt; &quot;announce ready 3 (recv request)&quot;,
<a name="5664"/> 5664:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5665"/> 5665:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="5666"/> 5666:                            ok
<a name="5667"/> 5667:                    end},
<a name="5668"/> 5668:          #{desc =&gt; &quot;await continue 3 (with send reply)&quot;,
<a name="5669"/> 5669:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5670"/> 5670:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="5671"/> 5671:                    end},
<a name="5672"/> 5672:          #{desc =&gt; &quot;send reply 3&quot;,
<a name="5673"/> 5673:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="5674"/> 5674:                            Send(Sock, ?BASIC_REP)
<a name="5675"/> 5675:                    end},
<a name="5676"/> 5676:          #{desc =&gt; &quot;announce ready 3 (send reply)&quot;,
<a name="5677"/> 5677:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5678"/> 5678:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="5679"/> 5679:                            ok
<a name="5680"/> 5680:                    end},
<a name="5681"/> 5681: 
<a name="5682"/> 5682:          %% *** Termination ***
<a name="5683"/> 5683:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5684"/> 5684:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5685"/> 5685:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5686"/> 5686:                                ok -&gt;
<a name="5687"/> 5687:                                    {ok, maps:remove(tester, State)};
<a name="5688"/> 5688:                                {error, _} = ERROR -&gt;
<a name="5689"/> 5689:                                    ERROR
<a name="5690"/> 5690:                            end
<a name="5691"/> 5691:                    end},
<a name="5692"/> 5692:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="5693"/> 5693:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="5694"/> 5694:                            ok = socket:close(Sock),
<a name="5695"/> 5695:                            {ok, maps:remove(csock, State)}
<a name="5696"/> 5696:                    end},
<a name="5697"/> 5697:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="5698"/> 5698:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="5699"/> 5699:                            case socket:close(LSock) of
<a name="5700"/> 5700:                                ok -&gt;
<a name="5701"/> 5701:                                    {ok, maps:remove(lsock, State)};
<a name="5702"/> 5702:                                {error, _} = ERROR -&gt;
<a name="5703"/> 5703:                                    ERROR
<a name="5704"/> 5704:                            end
<a name="5705"/> 5705:                    end},
<a name="5706"/> 5706: 
<a name="5707"/> 5707:          %% *** We are done ***
<a name="5708"/> 5708:          ?SEV_FINISH_NORMAL
<a name="5709"/> 5709:         ],
<a name="5710"/> 5710: 
<a name="5711"/> 5711: 
<a name="5712"/> 5712:     Client1Seq =
<a name="5713"/> 5713:         [
<a name="5714"/> 5714:          %% *** Wait for start order ***
<a name="5715"/> 5715:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5716"/> 5716:            cmd  =&gt; fun(State) -&gt;
<a name="5717"/> 5717:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="5718"/> 5718:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="5719"/> 5719:                    end},
<a name="5720"/> 5720:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5721"/> 5721:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5722"/> 5722:                            _MRef = erlang:monitor(process, Tester),
<a name="5723"/> 5723:                            ok
<a name="5724"/> 5724:                    end},
<a name="5725"/> 5725: 
<a name="5726"/> 5726:          %% *** The init part ***
<a name="5727"/> 5727:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="5728"/> 5728:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="5729"/> 5729:                            LSA = which_local_socket_addr(Domain),
<a name="5730"/> 5730:                            SSA = LSA#{port =&gt; Port},
<a name="5731"/> 5731:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="5732"/> 5732:                    end},
<a name="5733"/> 5733:          #{desc =&gt; &quot;create socket&quot;,
<a name="5734"/> 5734:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5735"/> 5735:                          protocol := Proto} = State) -&gt;
<a name="5736"/> 5736:                            case socket:open(Domain, stream, Proto) of
<a name="5737"/> 5737:                                {ok, Sock} -&gt;
<a name="5738"/> 5738:                                    {ok, State#{sock =&gt; Sock}};
<a name="5739"/> 5739:                                {error, _} = ERROR -&gt;
<a name="5740"/> 5740:                                    ERROR
<a name="5741"/> 5741:                            end
<a name="5742"/> 5742:                    end},
<a name="5743"/> 5743:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="5744"/> 5744:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="5745"/> 5745:                            case sock_bind(Sock, LSA) of
<a name="5746"/> 5746:                                ok -&gt;
<a name="5747"/> 5747:                                    ok;
<a name="5748"/> 5748:                                {error, _} = ERROR -&gt;
<a name="5749"/> 5749:                                    ERROR
<a name="5750"/> 5750:                            end
<a name="5751"/> 5751:                    end},
<a name="5752"/> 5752:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5753"/> 5753:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5754"/> 5754:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="5755"/> 5755:                            ok
<a name="5756"/> 5756:                    end},
<a name="5757"/> 5757: 
<a name="5758"/> 5758: 
<a name="5759"/> 5759:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="5760"/> 5760:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5761"/> 5761:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="5762"/> 5762:                    end},
<a name="5763"/> 5763:          #{desc =&gt; &quot;connect to server&quot;,
<a name="5764"/> 5764:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="5765"/> 5765:                            socket:connect(Sock, SSA)
<a name="5766"/> 5766:                    end},
<a name="5767"/> 5767:          #{desc =&gt; &quot;get socket FD&quot;,
<a name="5768"/> 5768:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5769"/> 5769:                            case socket:getopt(Sock, otp, fd) of
<a name="5770"/> 5770:                                {ok, FD} -&gt;
<a name="5771"/> 5771:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="5772"/> 5772:                                    {ok, State#{fd =&gt; FD}};
<a name="5773"/> 5773:                                {error, Reason} = ERROR -&gt;
<a name="5774"/> 5774:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="5775"/> 5775:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5776"/> 5776:                                    ERROR
<a name="5777"/> 5777:                            end
<a name="5778"/> 5778:                    end},
<a name="5779"/> 5779:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="5780"/> 5780:            cmd  =&gt; fun(#{tester := Tester,
<a name="5781"/> 5781:                          fd     := FD}) -&gt;
<a name="5782"/> 5782:                            ?SEV_ANNOUNCE_READY(Tester, connect, FD),
<a name="5783"/> 5783:                            ok
<a name="5784"/> 5784:                    end},
<a name="5785"/> 5785: 
<a name="5786"/> 5786: 
<a name="5787"/> 5787:          %% *** The actual test ***
<a name="5788"/> 5788:          #{desc =&gt; &quot;await continue (send request 1)&quot;,
<a name="5789"/> 5789:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5790"/> 5790:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5791"/> 5791:                    end},
<a name="5792"/> 5792:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="5793"/> 5793:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="5794"/> 5794:                            Send(Sock, ?BASIC_REQ)
<a name="5795"/> 5795:                    end},
<a name="5796"/> 5796:          #{desc =&gt; &quot;announce ready (send request 1)&quot;,
<a name="5797"/> 5797:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5798"/> 5798:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5799"/> 5799:                            ok
<a name="5800"/> 5800:                    end},
<a name="5801"/> 5801:          #{desc =&gt; &quot;await recv reply 1 (from server)&quot;,
<a name="5802"/> 5802:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5803"/> 5803:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="5804"/> 5804:                            ok
<a name="5805"/> 5805:                    end},
<a name="5806"/> 5806:          #{desc =&gt; &quot;announce ready (recv reply 1)&quot;,
<a name="5807"/> 5807:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5808"/> 5808:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5809"/> 5809:                            ok
<a name="5810"/> 5810:                    end},
<a name="5811"/> 5811: 
<a name="5812"/> 5812:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="5813"/> 5813:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5814"/> 5814:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5815"/> 5815:                    end},
<a name="5816"/> 5816:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="5817"/> 5817:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="5818"/> 5818:                            Send(Sock, ?BASIC_REQ)
<a name="5819"/> 5819:                    end},
<a name="5820"/> 5820:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="5821"/> 5821:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5822"/> 5822:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5823"/> 5823:                            ok
<a name="5824"/> 5824:                    end},
<a name="5825"/> 5825:          #{desc =&gt; &quot;await recv reply 3 (from server)&quot;,
<a name="5826"/> 5826:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5827"/> 5827:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="5828"/> 5828:                            ok
<a name="5829"/> 5829:                    end},
<a name="5830"/> 5830:          #{desc =&gt; &quot;announce ready (recv reply 3)&quot;,
<a name="5831"/> 5831:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5832"/> 5832:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5833"/> 5833:                            ok
<a name="5834"/> 5834:                    end},
<a name="5835"/> 5835: 
<a name="5836"/> 5836:          %% *** Termination ***
<a name="5837"/> 5837:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5838"/> 5838:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5839"/> 5839:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5840"/> 5840:                                ok -&gt;
<a name="5841"/> 5841:                                    {ok, maps:remove(tester, State)};
<a name="5842"/> 5842:                                {error, _} = ERROR -&gt;
<a name="5843"/> 5843:                                    ERROR
<a name="5844"/> 5844:                            end
<a name="5845"/> 5845:                    end},
<a name="5846"/> 5846:          #{desc =&gt; &quot;close socket&quot;,
<a name="5847"/> 5847:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5848"/> 5848:                            ok = socket:close(Sock),
<a name="5849"/> 5849:                            {ok, maps:remove(sock, State)}
<a name="5850"/> 5850:                    end},
<a name="5851"/> 5851: 
<a name="5852"/> 5852:          %% *** We are done ***
<a name="5853"/> 5853:          ?SEV_FINISH_NORMAL
<a name="5854"/> 5854:         ],
<a name="5855"/> 5855: 
<a name="5856"/> 5856: 
<a name="5857"/> 5857:     Client2Seq =
<a name="5858"/> 5858:         [
<a name="5859"/> 5859:          %% *** Wait for start order ***
<a name="5860"/> 5860:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5861"/> 5861:            cmd  =&gt; fun(State) -&gt;
<a name="5862"/> 5862:                            {Tester, FD} = ?SEV_AWAIT_START(),
<a name="5863"/> 5863:                            {ok, State#{tester =&gt; Tester, fd =&gt; FD}}
<a name="5864"/> 5864:                    end},
<a name="5865"/> 5865:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5866"/> 5866:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5867"/> 5867:                            _MRef = erlang:monitor(process, Tester),
<a name="5868"/> 5868:                            ok
<a name="5869"/> 5869:                    end},
<a name="5870"/> 5870: 
<a name="5871"/> 5871:          %% *** The init part ***
<a name="5872"/> 5872:          #{desc =&gt; &quot;create socket&quot;,
<a name="5873"/> 5873:            cmd  =&gt; fun(#{fd     := FD,
<a name="5874"/> 5874:                          dup    := DUP,
<a name="5875"/> 5875:                          domain := Domain} = State) -&gt;
<a name="5876"/> 5876:                            ?SEV_IPRINT(&quot;try create socket with: &quot;
<a name="5877"/> 5877:                                        &quot;~n   FD:     ~p&quot;
<a name="5878"/> 5878:                                        &quot;~n   DUP:    ~p&quot;
<a name="5879"/> 5879:                                        &quot;~n   Domain: ~p&quot;, [FD, DUP, Domain]),
<a name="5880"/> 5880:                            case socket:open(FD, #{dup    =&gt; DUP,
<a name="5881"/> 5881:                                                   domain =&gt; Domain}) of
<a name="5882"/> 5882:                                {ok, Sock} -&gt;
<a name="5883"/> 5883:                                    {ok, State#{sock =&gt; Sock}};
<a name="5884"/> 5884:                                {error,
<a name="5885"/> 5885:                                 {invalid,{options,domain,#{dup := DUP}}} = R} -&gt;
<a name="5886"/> 5886:                                    ?SEV_EPRINT(&quot;failed create socket:&quot;
<a name="5887"/> 5887:                                                &quot;~n   ~p&quot;, [R]),
<a name="5888"/> 5888:                                    {skip, domain};
<a name="5889"/> 5889:                                {error, Reason} = ERROR -&gt;
<a name="5890"/> 5890:                                    ?SEV_EPRINT(&quot;failed create socket:&quot;
<a name="5891"/> 5891:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5892"/> 5892:                                    ERROR
<a name="5893"/> 5893:                            end
<a name="5894"/> 5894:                    end},
<a name="5895"/> 5895:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5896"/> 5896:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5897"/> 5897:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="5898"/> 5898:                            ok
<a name="5899"/> 5899:                    end},
<a name="5900"/> 5900: 
<a name="5901"/> 5901:          %% *** The actual test ***
<a name="5902"/> 5902:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="5903"/> 5903:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5904"/> 5904:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5905"/> 5905:                    end},
<a name="5906"/> 5906:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="5907"/> 5907:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="5908"/> 5908:                            Send(Sock, ?BASIC_REQ)
<a name="5909"/> 5909:                    end},
<a name="5910"/> 5910:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="5911"/> 5911:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5912"/> 5912:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5913"/> 5913:                            ok
<a name="5914"/> 5914:                    end},
<a name="5915"/> 5915:          #{desc =&gt; &quot;await recv reply 2 (from server)&quot;,
<a name="5916"/> 5916:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5917"/> 5917:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="5918"/> 5918:                            ok
<a name="5919"/> 5919:                    end},
<a name="5920"/> 5920:          #{desc =&gt; &quot;announce ready (recv reply 2)&quot;,
<a name="5921"/> 5921:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5922"/> 5922:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5923"/> 5923:                            ok
<a name="5924"/> 5924:                    end},
<a name="5925"/> 5925: 
<a name="5926"/> 5926:          %% *** Termination ***
<a name="5927"/> 5927:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5928"/> 5928:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5929"/> 5929:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5930"/> 5930:                                ok -&gt;
<a name="5931"/> 5931:                                    {ok, maps:remove(tester, State)};
<a name="5932"/> 5932:                                {error, _} = ERROR -&gt;
<a name="5933"/> 5933:                                    ERROR
<a name="5934"/> 5934:                            end
<a name="5935"/> 5935:                    end},
<a name="5936"/> 5936:          #{desc =&gt; &quot;close socket&quot;,
<a name="5937"/> 5937:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5938"/> 5938:                            ok = socket:close(Sock),
<a name="5939"/> 5939:                            {ok, maps:remove(sock, State)}
<a name="5940"/> 5940:                    end},
<a name="5941"/> 5941: 
<a name="5942"/> 5942:          %% *** We are done ***
<a name="5943"/> 5943:          ?SEV_FINISH_NORMAL
<a name="5944"/> 5944:         ],
<a name="5945"/> 5945: 
<a name="5946"/> 5946: 
<a name="5947"/> 5947:     TesterSeq =
<a name="5948"/> 5948:         [
<a name="5949"/> 5949:          %% *** Init part ***
<a name="5950"/> 5950:          #{desc =&gt; &quot;monitor server&quot;,
<a name="5951"/> 5951:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="5952"/> 5952:                            _MRef = erlang:monitor(process, Pid),
<a name="5953"/> 5953:                            ok
<a name="5954"/> 5954:                    end},
<a name="5955"/> 5955:          #{desc =&gt; &quot;monitor client 1&quot;,
<a name="5956"/> 5956:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="5957"/> 5957:                            _MRef = erlang:monitor(process, Pid),
<a name="5958"/> 5958:                            ok
<a name="5959"/> 5959:                    end},
<a name="5960"/> 5960:          #{desc =&gt; &quot;monitor client 2&quot;,
<a name="5961"/> 5961:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="5962"/> 5962:                            _MRef = erlang:monitor(process, Pid),
<a name="5963"/> 5963:                            ok
<a name="5964"/> 5964:                    end},
<a name="5965"/> 5965: 
<a name="5966"/> 5966:          %% Start the server
<a name="5967"/> 5967:          #{desc =&gt; &quot;order server start&quot;,
<a name="5968"/> 5968:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="5969"/> 5969:                            ?SEV_ANNOUNCE_START(Pid),
<a name="5970"/> 5970:                            ok
<a name="5971"/> 5971:                    end},
<a name="5972"/> 5972:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="5973"/> 5973:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="5974"/> 5974:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="5975"/> 5975:                            {ok, State#{server_port =&gt; Port}}
<a name="5976"/> 5976:                    end},
<a name="5977"/> 5977: 
<a name="5978"/> 5978:          %% Start the client 1
<a name="5979"/> 5979:          #{desc =&gt; &quot;order client 1 start&quot;,
<a name="5980"/> 5980:            cmd  =&gt; fun(#{client1 := Pid, server_port := Port} = _State) -&gt;
<a name="5981"/> 5981:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="5982"/> 5982:                            ok
<a name="5983"/> 5983:                    end},
<a name="5984"/> 5984:          #{desc =&gt; &quot;await client 1 ready (init)&quot;,
<a name="5985"/> 5985:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="5986"/> 5986:                            ok = ?SEV_AWAIT_READY(Pid, client1, init)
<a name="5987"/> 5987:                    end},
<a name="5988"/> 5988: 
<a name="5989"/> 5989:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="5990"/> 5990:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5991"/> 5991:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="5992"/> 5992:                            ok
<a name="5993"/> 5993:                    end},
<a name="5994"/> 5994:          ?SEV_SLEEP(?SECS(1)),
<a name="5995"/> 5995:          #{desc =&gt; &quot;order client 1 to continue (with connect)&quot;,
<a name="5996"/> 5996:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5997"/> 5997:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="5998"/> 5998:                            ok
<a name="5999"/> 5999:                    end},
<a name="6000"/> 6000:          #{desc =&gt; &quot;await client 1 ready (connect)&quot;,
<a name="6001"/> 6001:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="6002"/> 6002:                            {ok, FD} = ?SEV_AWAIT_READY(Pid, client1, connect),
<a name="6003"/> 6003:                            {ok, State#{fd =&gt; FD}}
<a name="6004"/> 6004:                    end},
<a name="6005"/> 6005:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="6006"/> 6006:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6007"/> 6007:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="6008"/> 6008:                    end},         
<a name="6009"/> 6009: 
<a name="6010"/> 6010:          %% Start the client 2
<a name="6011"/> 6011:          #{desc =&gt; &quot;order client 2 start&quot;,
<a name="6012"/> 6012:            cmd  =&gt; fun(#{client2 := Pid, fd := FD} = _State) -&gt;
<a name="6013"/> 6013:                            ?SEV_ANNOUNCE_START(Pid, FD),
<a name="6014"/> 6014:                            ok
<a name="6015"/> 6015:                    end},
<a name="6016"/> 6016:          #{desc =&gt; &quot;await client 2 ready (init)&quot;,
<a name="6017"/> 6017:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="6018"/> 6018:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="6019"/> 6019:                    end},
<a name="6020"/> 6020: 
<a name="6021"/> 6021:          %% *** The actual test ***
<a name="6022"/> 6022: 
<a name="6023"/> 6023:          #{desc =&gt; &quot;order client 1 to continue (with send request 1)&quot;,
<a name="6024"/> 6024:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6025"/> 6025:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6026"/> 6026:                            ok
<a name="6027"/> 6027:                    end},
<a name="6028"/> 6028:          #{desc =&gt; &quot;await client 1 ready (with send request 1)&quot;,
<a name="6029"/> 6029:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6030"/> 6030:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="6031"/> 6031:                    end},
<a name="6032"/> 6032:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="6033"/> 6033:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6034"/> 6034:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6035"/> 6035:                    end},
<a name="6036"/> 6036:          #{desc =&gt; &quot;order server to continue (with send reply 1)&quot;,
<a name="6037"/> 6037:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6038"/> 6038:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6039"/> 6039:                            ok
<a name="6040"/> 6040:                    end},
<a name="6041"/> 6041:          #{desc =&gt; &quot;await server ready (with reply 1 sent)&quot;,
<a name="6042"/> 6042:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6043"/> 6043:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6044"/> 6044:                    end},
<a name="6045"/> 6045:          #{desc =&gt; &quot;await client 1 ready (reply recv 1)&quot;,
<a name="6046"/> 6046:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6047"/> 6047:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="6048"/> 6048:                    end},
<a name="6049"/> 6049: 
<a name="6050"/> 6050: 
<a name="6051"/> 6051:          #{desc =&gt; &quot;order client 2 to continue (with send request 2)&quot;,
<a name="6052"/> 6052:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6053"/> 6053:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6054"/> 6054:                            ok
<a name="6055"/> 6055:                    end},
<a name="6056"/> 6056:          #{desc =&gt; &quot;await client 2 ready (with send request 2)&quot;,
<a name="6057"/> 6057:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6058"/> 6058:                            ?SEV_AWAIT_READY(Client, client2, send_req)
<a name="6059"/> 6059:                    end},
<a name="6060"/> 6060:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="6061"/> 6061:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6062"/> 6062:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6063"/> 6063:                    end},
<a name="6064"/> 6064:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="6065"/> 6065:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6066"/> 6066:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6067"/> 6067:                            ok
<a name="6068"/> 6068:                    end},
<a name="6069"/> 6069:          #{desc =&gt; &quot;await server ready (with reply 2 sent)&quot;,
<a name="6070"/> 6070:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6071"/> 6071:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6072"/> 6072:                    end},
<a name="6073"/> 6073:          #{desc =&gt; &quot;await client 2 ready (reply recv 2)&quot;,
<a name="6074"/> 6074:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6075"/> 6075:                            ?SEV_AWAIT_READY(Client, client2, recv_reply)
<a name="6076"/> 6076:                    end},
<a name="6077"/> 6077: 
<a name="6078"/> 6078: 
<a name="6079"/> 6079:          #{desc =&gt; &quot;order client 2 to terminate&quot;,
<a name="6080"/> 6080:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6081"/> 6081:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="6082"/> 6082:                            ok
<a name="6083"/> 6083:                    end},
<a name="6084"/> 6084:          #{desc =&gt; &quot;await client 2 termination&quot;,
<a name="6085"/> 6085:            cmd  =&gt; fun(#{client2 := Client} = State) -&gt;
<a name="6086"/> 6086:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="6087"/> 6087:                            State1 = maps:remove(client2, State),
<a name="6088"/> 6088:                            {ok, State1}
<a name="6089"/> 6089:                    end},
<a name="6090"/> 6090: 
<a name="6091"/> 6091: 
<a name="6092"/> 6092:          #{desc =&gt; &quot;order client 1 to continue (with send request 3)&quot;,
<a name="6093"/> 6093:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6094"/> 6094:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6095"/> 6095:                            ok
<a name="6096"/> 6096:                    end},
<a name="6097"/> 6097:          #{desc =&gt; &quot;await client 1 ready (with send request 3)&quot;,
<a name="6098"/> 6098:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6099"/> 6099:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="6100"/> 6100:                    end},
<a name="6101"/> 6101:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="6102"/> 6102:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6103"/> 6103:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6104"/> 6104:                    end},
<a name="6105"/> 6105:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="6106"/> 6106:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6107"/> 6107:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6108"/> 6108:                            ok
<a name="6109"/> 6109:                    end},
<a name="6110"/> 6110:          #{desc =&gt; &quot;await server ready (with reply 3 sent)&quot;,
<a name="6111"/> 6111:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6112"/> 6112:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6113"/> 6113:                    end},
<a name="6114"/> 6114:          #{desc =&gt; &quot;await client 1 ready (reply recv 3)&quot;,
<a name="6115"/> 6115:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6116"/> 6116:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="6117"/> 6117:                    end},
<a name="6118"/> 6118: 
<a name="6119"/> 6119: 
<a name="6120"/> 6120:          %% *** Termination ***
<a name="6121"/> 6121:          #{desc =&gt; &quot;order client 1 to terminate&quot;,
<a name="6122"/> 6122:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6123"/> 6123:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="6124"/> 6124:                            ok
<a name="6125"/> 6125:                    end},
<a name="6126"/> 6126:          #{desc =&gt; &quot;await client 1 termination&quot;,
<a name="6127"/> 6127:            cmd  =&gt; fun(#{client1 := Client} = State) -&gt;
<a name="6128"/> 6128:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="6129"/> 6129:                            State1 = maps:remove(client1, State),
<a name="6130"/> 6130:                            {ok, State1}
<a name="6131"/> 6131:                    end},
<a name="6132"/> 6132:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="6133"/> 6133:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6134"/> 6134:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="6135"/> 6135:                            ok
<a name="6136"/> 6136:                    end},
<a name="6137"/> 6137:          #{desc =&gt; &quot;await server termination&quot;,
<a name="6138"/> 6138:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="6139"/> 6139:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="6140"/> 6140:                            State1 = maps:remove(server, State),
<a name="6141"/> 6141:                            {ok, State1}
<a name="6142"/> 6142:                    end},
<a name="6143"/> 6143: 
<a name="6144"/> 6144:          %% *** We are done ***
<a name="6145"/> 6145:          ?SEV_FINISH_NORMAL
<a name="6146"/> 6146:         ],
<a name="6147"/> 6147: 
<a name="6148"/> 6148:     i(&quot;start server evaluator&quot;),
<a name="6149"/> 6149:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, maps:remove(dup, InitState)),
<a name="6150"/> 6150: 
<a name="6151"/> 6151:     i(&quot;start (socket origin) client 1 evaluator&quot;),
<a name="6152"/> 6152:     Client1 = ?SEV_START(&quot;client-1&quot;, Client1Seq, maps:remove(dup, InitState)),
<a name="6153"/> 6153:     i(&quot;await evaluator(s)&quot;),
<a name="6154"/> 6154: 
<a name="6155"/> 6155:     i(&quot;start client 2 evaluator&quot;),
<a name="6156"/> 6156:     Client2 = ?SEV_START(&quot;client-2&quot;, Client2Seq, InitState),
<a name="6157"/> 6157:     i(&quot;await evaluator(s)&quot;),
<a name="6158"/> 6158: 
<a name="6159"/> 6159:     i(&quot;start tester evaluator&quot;),
<a name="6160"/> 6160:     TesterInitState = #{server  =&gt; Server#ev.pid,
<a name="6161"/> 6161:                         client1 =&gt; Client1#ev.pid,
<a name="6162"/> 6162:                         client2 =&gt; Client2#ev.pid},
<a name="6163"/> 6163:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="6164"/> 6164: 
<a name="api_ffd_open_connect_and_open_and_send_tcp2-last_expr"/><a name="6165"/> 6165: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client1, Client2, Tester]).
<a name="6166"/> 6166: 
<a name="6167"/> 6167: 
<a name="6168"/> 6168: 
<a name="6169"/> 6169: 
<a name="6170"/> 6170: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6171"/> 6171: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6172"/> 6172: <i>%%                                                                     %%</i>
<a name="6173"/> 6173: <i>%%                           API ASYNC                                 %%</i>
<a name="6174"/> 6174: <i>%%                                                                     %%</i>
<a name="6175"/> 6175: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6176"/> 6176: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6177"/> 6177: 
<a name="6178"/> 6178: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6179"/> 6179: 
<a name="6180"/> 6180: <i>%% Basically establish a TCP connection via an async connect. IPv4.</i>
<a name="api_a_connect_tcp4-1"/><a name="6181"/> 6181: <b>api_a_connect_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="6182"/> 6182:     ?TT(?SECS(10)),
<a name="api_a_connect_tcp4-last_expr"/><a name="6183"/> 6183: <b>    tc_try</b>(api_a_connect_tcp4,
<a name="6184"/> 6184:            fun() -&gt; has_support_ipv4() end,
<a name="6185"/> 6185:            fun() -&gt;
<a name="6186"/> 6186:                    ok = api_a_connect_tcpD(inet, nowait(Config))
<a name="6187"/> 6187:            end).
<a name="6188"/> 6188: 
<a name="6189"/> 6189: 
<a name="6190"/> 6190: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6191"/> 6191: 
<a name="6192"/> 6192: <i>%% Basically establish a TCP connection via an async connect. IPv6.</i>
<a name="api_a_connect_tcp6-1"/><a name="6193"/> 6193: <b>api_a_connect_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="6194"/> 6194:     ?TT(?SECS(10)),
<a name="api_a_connect_tcp6-last_expr"/><a name="6195"/> 6195: <b>    tc_try</b>(api_a_connect_tcp6,
<a name="6196"/> 6196:            fun() -&gt; has_support_ipv6() end,
<a name="6197"/> 6197:            fun() -&gt;
<a name="6198"/> 6198:                    ok = api_a_connect_tcpD(inet6, nowait(Config))
<a name="6199"/> 6199:            end).
<a name="6200"/> 6200: 
<a name="6201"/> 6201: 
<a name="6202"/> 6202: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6203"/> 6203: 
<a name="api_a_connect_tcpD-2"/><a name="6204"/> 6204: <b>api_a_connect_tcpD</b>(Domain, Nowait) -&gt;
<a name="6205"/> 6205:     Connect = fun(Sock, SockAddr) -&gt;
<a name="6206"/> 6206:                       socket:connect(Sock, SockAddr, Nowait)
<a name="6207"/> 6207:               end,
<a name="6208"/> 6208:     Send = fun(Sock, Data) -&gt;
<a name="6209"/> 6209:                    socket:send(Sock, Data)
<a name="6210"/> 6210:            end,
<a name="6211"/> 6211:     Recv = fun(Sock) -&gt;
<a name="6212"/> 6212:                    socket:recv(Sock)
<a name="6213"/> 6213:            end,
<a name="6214"/> 6214:     InitState = #{domain =&gt; Domain,
<a name="6215"/> 6215:                   connect =&gt; Connect,
<a name="6216"/> 6216:                   send =&gt; Send,
<a name="6217"/> 6217:                   recv =&gt; Recv,
<a name="6218"/> 6218:                   connect_ref =&gt; Nowait},
<a name="api_a_connect_tcpD-last_expr"/><a name="6219"/> 6219: <b>    api_a_connect_tcp</b>(InitState).
<a name="6220"/> 6220: 
<a name="6221"/> 6221: 
<a name="6222"/> 6222: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6223"/> 6223: 
<a name="api_a_connect_tcp-1"/><a name="6224"/> 6224: <b>api_a_connect_tcp</b>(InitState) -&gt;
<a name="6225"/> 6225:     process_flag(trap_exit, true),
<a name="6226"/> 6226:     ServerSeq = 
<a name="6227"/> 6227:         [
<a name="6228"/> 6228:          %% *** Wait for start order ***
<a name="6229"/> 6229:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6230"/> 6230:            cmd  =&gt; fun(State) -&gt;
<a name="6231"/> 6231:                            Tester = ?SEV_AWAIT_START(),
<a name="6232"/> 6232:                            {ok, State#{tester =&gt; Tester}}
<a name="6233"/> 6233:                    end},
<a name="6234"/> 6234:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6235"/> 6235:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6236"/> 6236:                            _MRef = erlang:monitor(process, Tester),
<a name="6237"/> 6237:                            ok
<a name="6238"/> 6238:                    end},
<a name="6239"/> 6239: 
<a name="6240"/> 6240:          %% *** Init part ***
<a name="6241"/> 6241:          #{desc =&gt; &quot;which local address&quot;,
<a name="6242"/> 6242:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6243"/> 6243:                            LSA = which_local_socket_addr(Domain),
<a name="6244"/> 6244:                            {ok, State#{lsa =&gt; LSA}}
<a name="6245"/> 6245:                    end},
<a name="6246"/> 6246:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="6247"/> 6247:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6248"/> 6248:                            case socket:open(Domain, stream, tcp) of
<a name="6249"/> 6249:                                {ok, Sock} -&gt;
<a name="6250"/> 6250:                                    {ok, State#{lsock =&gt; Sock}};
<a name="6251"/> 6251:                                {error, _} = ERROR -&gt;
<a name="6252"/> 6252:                                    ERROR
<a name="6253"/> 6253:                            end
<a name="6254"/> 6254:                    end},
<a name="6255"/> 6255:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="6256"/> 6256:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="6257"/> 6257:                            case sock_bind(LSock, LSA) of
<a name="6258"/> 6258:                                ok -&gt;
<a name="6259"/> 6259:                                    Port = sock_port(LSock),
<a name="6260"/> 6260:                                    {ok, State#{lport =&gt; Port}};
<a name="6261"/> 6261:                                {error, _} = ERROR -&gt;
<a name="6262"/> 6262:                                    ERROR
<a name="6263"/> 6263:                            end
<a name="6264"/> 6264:                    end},
<a name="6265"/> 6265:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="6266"/> 6266:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="6267"/> 6267:                            socket:listen(LSock)
<a name="6268"/> 6268:                    end},
<a name="6269"/> 6269:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6270"/> 6270:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="6271"/> 6271:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="6272"/> 6272:                            ok
<a name="6273"/> 6273:                    end},
<a name="6274"/> 6274: 
<a name="6275"/> 6275:          %% The actual test
<a name="6276"/> 6276:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="6277"/> 6277:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6278"/> 6278:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="6279"/> 6279:                    end},
<a name="6280"/> 6280:          #{desc =&gt; &quot;await connection&quot;,
<a name="6281"/> 6281:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="6282"/> 6282:                            case socket:accept(LSock) of
<a name="6283"/> 6283:                                {ok, Sock} -&gt;
<a name="6284"/> 6284:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="6285"/> 6285:                                    {ok, State#{csock =&gt; Sock}};
<a name="6286"/> 6286:                                {error, _} = ERROR -&gt;
<a name="6287"/> 6287:                                    ERROR
<a name="6288"/> 6288:                            end
<a name="6289"/> 6289:                    end},
<a name="6290"/> 6290:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="6291"/> 6291:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6292"/> 6292:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="6293"/> 6293:                            ok
<a name="6294"/> 6294:                    end},
<a name="6295"/> 6295: 
<a name="6296"/> 6296:          #{desc =&gt; &quot;await continue (recv_req)&quot;,
<a name="6297"/> 6297:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6298"/> 6298:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_req)
<a name="6299"/> 6299:                    end},
<a name="6300"/> 6300:          #{desc =&gt; &quot;recv req&quot;,
<a name="6301"/> 6301:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="6302"/> 6302:                            case Recv(Sock) of
<a name="6303"/> 6303:                                {ok, ?BASIC_REQ} -&gt;
<a name="6304"/> 6304:                                    ok;
<a name="6305"/> 6305:                                {ok, UnexpData} -&gt;
<a name="6306"/> 6306:                                    {error, {unexpected_data, UnexpData}};
<a name="6307"/> 6307:                                {error, _} = ERROR -&gt;
<a name="6308"/> 6308:                                    %% At the moment there is no way to get
<a name="6309"/> 6309:                                    %% status or state for the socket...
<a name="6310"/> 6310:                                    ERROR
<a name="6311"/> 6311:                            end
<a name="6312"/> 6312:                    end},
<a name="6313"/> 6313:          #{desc =&gt; &quot;announce ready (recv_req)&quot;,
<a name="6314"/> 6314:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6315"/> 6315:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="6316"/> 6316:                            ok
<a name="6317"/> 6317:                    end},
<a name="6318"/> 6318:          #{desc =&gt; &quot;await continue (send_rep)&quot;,
<a name="6319"/> 6319:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6320"/> 6320:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_rep)
<a name="6321"/> 6321:                    end},
<a name="6322"/> 6322:          #{desc =&gt; &quot;send rep&quot;,
<a name="6323"/> 6323:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="6324"/> 6324:                            Send(Sock, ?BASIC_REP)
<a name="6325"/> 6325:                    end},
<a name="6326"/> 6326:          #{desc =&gt; &quot;announce ready (send_rep)&quot;,
<a name="6327"/> 6327:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6328"/> 6328:                            ?SEV_ANNOUNCE_READY(Tester, send_rep),
<a name="6329"/> 6329:                            ok
<a name="6330"/> 6330:                    end},
<a name="6331"/> 6331: 	 
<a name="6332"/> 6332: 
<a name="6333"/> 6333:          %% *** Termination ***
<a name="6334"/> 6334:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6335"/> 6335:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6336"/> 6336:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6337"/> 6337:                                ok -&gt;
<a name="6338"/> 6338:                                    {ok, maps:remove(tester, State)};
<a name="6339"/> 6339:                                {error, _} = ERROR -&gt;
<a name="6340"/> 6340:                                    ERROR
<a name="6341"/> 6341:                            end
<a name="6342"/> 6342:                    end},
<a name="6343"/> 6343:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="6344"/> 6344:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="6345"/> 6345:                            ok = socket:close(Sock),
<a name="6346"/> 6346:                            {ok, maps:remove(csock, State)}
<a name="6347"/> 6347:                    end},
<a name="6348"/> 6348:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="6349"/> 6349:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="6350"/> 6350:                            ok = socket:close(Sock),
<a name="6351"/> 6351:                            {ok, maps:remove(lsock, State)}
<a name="6352"/> 6352:                    end},
<a name="6353"/> 6353: 
<a name="6354"/> 6354:          %% *** We are done ***
<a name="6355"/> 6355:          ?SEV_FINISH_NORMAL
<a name="6356"/> 6356:         ],
<a name="6357"/> 6357: 
<a name="6358"/> 6358:     ClientSeq = 
<a name="6359"/> 6359:         [
<a name="6360"/> 6360:          %% *** Wait for start order ***
<a name="6361"/> 6361:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6362"/> 6362:            cmd  =&gt; fun(State) -&gt;
<a name="6363"/> 6363:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="6364"/> 6364:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="6365"/> 6365:                    end},
<a name="6366"/> 6366:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6367"/> 6367:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6368"/> 6368:                            _MRef = erlang:monitor(process, Tester),
<a name="6369"/> 6369:                            ok
<a name="6370"/> 6370:                    end},
<a name="6371"/> 6371: 
<a name="6372"/> 6372:          %% *** The init part ***
<a name="6373"/> 6373:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="6374"/> 6374:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="6375"/> 6375:                            LSA = which_local_socket_addr(Domain),
<a name="6376"/> 6376:                            SSA = LSA#{port =&gt; Port},
<a name="6377"/> 6377:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="6378"/> 6378:                    end},
<a name="6379"/> 6379:          #{desc =&gt; &quot;create socket&quot;,
<a name="6380"/> 6380:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6381"/> 6381:                            case socket:open(Domain, stream, tcp) of
<a name="6382"/> 6382:                                {ok, Sock} -&gt;
<a name="6383"/> 6383:                                    {ok, State#{sock =&gt; Sock}};
<a name="6384"/> 6384:                                {error, _} = ERROR -&gt;
<a name="6385"/> 6385:                                    ERROR
<a name="6386"/> 6386:                            end
<a name="6387"/> 6387:                    end},
<a name="6388"/> 6388:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="6389"/> 6389:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="6390"/> 6390:                            case sock_bind(Sock, LSA) of
<a name="6391"/> 6391:                                ok -&gt;
<a name="6392"/> 6392:                                    ok;
<a name="6393"/> 6393:                                {error, _} = ERROR -&gt;
<a name="6394"/> 6394:                                    ERROR
<a name="6395"/> 6395:                            end
<a name="6396"/> 6396:                    end},
<a name="6397"/> 6397:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6398"/> 6398:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6399"/> 6399:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="6400"/> 6400:                            ok
<a name="6401"/> 6401:                    end},
<a name="6402"/> 6402: 
<a name="6403"/> 6403:          %% *** The actual test ***
<a name="6404"/> 6404:          #{desc =&gt; &quot;await continue (async connect)&quot;,
<a name="6405"/> 6405:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6406"/> 6406:                            ?SEV_AWAIT_CONTINUE(Tester, tester, async_connect)
<a name="6407"/> 6407:                    end},
<a name="6408"/> 6408:          #{desc =&gt; &quot;connect (async) to server&quot;,
<a name="6409"/> 6409:            cmd  =&gt; fun(#{sock        := Sock,
<a name="6410"/> 6410:                          server_sa   := SSA,
<a name="6411"/> 6411:                          connect     := Connect,
<a name="6412"/> 6412:                          connect_ref := SR} = State) -&gt;
<a name="6413"/> 6413:                            case Connect(Sock, SSA) of
<a name="6414"/> 6414:                                ok -&gt;
<a name="6415"/> 6415:                                    ?SEV_IPRINT(&quot;ok -&gt; &quot;
<a name="6416"/> 6416: 					       &quot;unexpected success =&gt; SKIP&quot;, 
<a name="6417"/> 6417:                                                []),
<a name="6418"/> 6418:                                    {skip, unexpected_success};
<a name="6419"/> 6419: 
<a name="6420"/> 6420:                                {select, {select_info, ST, SelectRef}}
<a name="6421"/> 6421:                                  when SR =:= nowait -&gt;
<a name="6422"/> 6422:                                    ?SEV_IPRINT(&quot;select nowait -&gt;&quot;
<a name="6423"/> 6423:                                                &quot;~n   tag: ~p&quot;
<a name="6424"/> 6424:                                                &quot;~n   ref: ~p&quot;,
<a name="6425"/> 6425:                                                [ST, SelectRef]),
<a name="6426"/> 6426:                                    {ok, State#{asynch_tag  =&gt; select,
<a name="6427"/> 6427:                                                connect_tag =&gt; ST,
<a name="6428"/> 6428:                                                connect_ref =&gt; SelectRef}};
<a name="6429"/> 6429:                                {select, {select_info, ST, SR}}
<a name="6430"/> 6430:                                  when is_reference(SR) -&gt;
<a name="6431"/> 6431:                                    ?SEV_IPRINT(&quot;select ref -&gt;&quot;
<a name="6432"/> 6432:                                                &quot;~n   tag: ~p&quot;
<a name="6433"/> 6433:                                                &quot;~n   ref: ~p&quot;, [ST, SR]),
<a name="6434"/> 6434:                                    {ok, State#{asynch_tag  =&gt; select,
<a name="6435"/> 6435:                                                connect_tag =&gt; ST}};
<a name="6436"/> 6436: 
<a name="6437"/> 6437:                                {completion,
<a name="6438"/> 6438:                                 {completion_info, CT, CompletionRef}}
<a name="6439"/> 6439:                                  when SR =:= nowait -&gt;
<a name="6440"/> 6440:                                    ?SEV_IPRINT(&quot;completion nowait -&gt;&quot;
<a name="6441"/> 6441:                                                &quot;~n   tag: ~p&quot;
<a name="6442"/> 6442:                                                &quot;~n   ref: ~p&quot;,
<a name="6443"/> 6443:                                                [CT, CompletionRef]),
<a name="6444"/> 6444:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="6445"/> 6445:                                                connect_tag =&gt; CT,
<a name="6446"/> 6446:                                                connect_ref =&gt; CompletionRef}};
<a name="6447"/> 6447:                                {completion,
<a name="6448"/> 6448:                                 {completion_info, CT, CR}}
<a name="6449"/> 6449:                                  when is_reference(CR) -&gt;
<a name="6450"/> 6450:                                    ?SEV_IPRINT(&quot;completion ref -&gt;&quot;
<a name="6451"/> 6451:                                                &quot;~n   tag: ~p&quot;
<a name="6452"/> 6452:                                                &quot;~n   ref: ~p&quot;, [CT, CR]),
<a name="6453"/> 6453:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="6454"/> 6454:                                                connect_tag =&gt; CT}};
<a name="6455"/> 6455: 
<a name="6456"/> 6456:                                {error, _} = ERROR -&gt;
<a name="6457"/> 6457:                                    ERROR
<a name="6458"/> 6458:                            end
<a name="6459"/> 6459:                    end},
<a name="6460"/> 6460:          #{desc =&gt; &quot;announce ready (connect select|completion)&quot;,
<a name="6461"/> 6461:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6462"/> 6462:                            ?SEV_ANNOUNCE_READY(Tester, connect_select),
<a name="6463"/> 6463:                            ok
<a name="6464"/> 6464:                    end},
<a name="6465"/> 6465:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="6466"/> 6466:            cmd  =&gt; fun(#{sock        := Sock,
<a name="6467"/> 6467:                          asynch_tag  := select,
<a name="6468"/> 6468:                          connect_tag := connect,
<a name="6469"/> 6469:                          connect_ref := Ref}) -&gt;
<a name="6470"/> 6470:                            receive
<a name="6471"/> 6471:                                {'$socket', Sock, select, Ref} -&gt;
<a name="6472"/> 6472:                                    ?SEV_IPRINT(&quot;select message -&gt;&quot;
<a name="6473"/> 6473:                                                &quot;~n   ref: ~p&quot;, [Ref]),
<a name="6474"/> 6474:                                    ok
<a name="6475"/> 6475:                            after 5000 -&gt;
<a name="6476"/> 6476:                                    ?SEV_EPRINT(&quot;timeout: &quot;
<a name="6477"/> 6477:                                                &quot;~n   message queue: ~p&quot;,
<a name="6478"/> 6478:                                                [?MQ()]),
<a name="6479"/> 6479:                                    {error, timeout}
<a name="6480"/> 6480:                            end;
<a name="6481"/> 6481:                       (#{sock        := Sock,
<a name="6482"/> 6482:                          asynch_tag  := completion,
<a name="6483"/> 6483:                          connect_tag := connect,
<a name="6484"/> 6484:                          connect_ref := Ref}) -&gt;
<a name="6485"/> 6485:                            receive
<a name="6486"/> 6486:                                {'$socket', Sock, completion, {Ref, ok = Res}} -&gt;
<a name="6487"/> 6487:                                    ?SEV_IPRINT(&quot;completion message -&gt;&quot;
<a name="6488"/> 6488:                                                &quot;~n   ref: ~p&quot;
<a name="6489"/> 6489:                                                &quot;~n   res: ~p&quot;, [Ref, Res]),
<a name="6490"/> 6490:                                    ok
<a name="6491"/> 6491:                            after 5000 -&gt;
<a name="6492"/> 6492:                                    ?SEV_EPRINT(&quot;timeout: &quot;
<a name="6493"/> 6493:                                                &quot;~n   message queue: ~p&quot;,
<a name="6494"/> 6494:                                                [?MQ()]),
<a name="6495"/> 6495:                                    {error, timeout}
<a name="6496"/> 6496:                            end
<a name="6497"/> 6497:                    end},
<a name="6498"/> 6498:          #{desc =&gt; &quot;announce ready (select|completion)&quot;,
<a name="6499"/> 6499:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6500"/> 6500:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="6501"/> 6501:                            ok
<a name="6502"/> 6502:                    end},
<a name="6503"/> 6503:          #{desc =&gt; &quot;(maybe) connect (async) to server&quot;,
<a name="6504"/> 6504:            cmd  =&gt; fun(#{sock        := Sock,
<a name="6505"/> 6505:                          server_sa   := SSA,
<a name="6506"/> 6506:                          asynch_tag  := select,
<a name="6507"/> 6507:                          connect_tag := connect,
<a name="6508"/> 6508:                          connect     := Connect}) -&gt;
<a name="6509"/> 6509:                            case Connect(Sock, SSA) of
<a name="6510"/> 6510:                                ok -&gt;
<a name="6511"/> 6511:                                    ok;
<a name="6512"/> 6512:                                {select, SelectInfo} -&gt;
<a name="6513"/> 6513:                                    {error, {unexpected_select, SelectInfo}};
<a name="6514"/> 6514:                                {error, _} = ERROR -&gt;
<a name="6515"/> 6515:                                    ERROR
<a name="6516"/> 6516:                            end;
<a name="6517"/> 6517:                       (#{sock        := _Sock,
<a name="6518"/> 6518:                          server_sa   := _SSA,
<a name="6519"/> 6519:                          asynch_tag  := completion,
<a name="6520"/> 6520:                          connect_tag := connect,
<a name="6521"/> 6521:                          connect     := _Connect}) -&gt;
<a name="6522"/> 6522:                            ok
<a name="6523"/> 6523:                    end},
<a name="6524"/> 6524:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="6525"/> 6525:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6526"/> 6526:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="6527"/> 6527:                            ok
<a name="6528"/> 6528:                    end},
<a name="6529"/> 6529:          #{desc =&gt; &quot;get peername&quot;,
<a name="6530"/> 6530:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="6531"/> 6531:                            case socket:peername(Sock) of
<a name="6532"/> 6532:                                {ok, SockAddr} -&gt;
<a name="6533"/> 6533:                                    ?SEV_IPRINT(&quot;Peer Name: ~p&quot;, [SockAddr]),
<a name="6534"/> 6534:                                    ok;
<a name="6535"/> 6535:                                 {error, _} = ERROR -&gt;
<a name="6536"/> 6536:                                    ERROR
<a name="6537"/> 6537:                            end
<a name="6538"/> 6538:                    end},
<a name="6539"/> 6539: 
<a name="6540"/> 6540:          #{desc =&gt; &quot;await continue (send_req)&quot;,
<a name="6541"/> 6541:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6542"/> 6542:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="6543"/> 6543:                    end},
<a name="6544"/> 6544:          #{desc =&gt; &quot;send req&quot;,
<a name="6545"/> 6545:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="6546"/> 6546:                            Send(Sock, ?BASIC_REQ)
<a name="6547"/> 6547:                    end},
<a name="6548"/> 6548:          #{desc =&gt; &quot;announce ready (send_req)&quot;,
<a name="6549"/> 6549:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6550"/> 6550:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="6551"/> 6551:                            ok
<a name="6552"/> 6552:                    end},
<a name="6553"/> 6553:          #{desc =&gt; &quot;await continue (recv_rep)&quot;,
<a name="6554"/> 6554:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6555"/> 6555:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_rep)
<a name="6556"/> 6556:                    end},
<a name="6557"/> 6557:          #{desc =&gt; &quot;recv rep&quot;,
<a name="6558"/> 6558:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="6559"/> 6559:                            case Recv(Sock) of
<a name="6560"/> 6560:                                {ok, ?BASIC_REP} -&gt;
<a name="6561"/> 6561:                                    ok;
<a name="6562"/> 6562:                                {ok, UnexpData} -&gt;
<a name="6563"/> 6563:                                    {error, {unexpected_data, UnexpData}};
<a name="6564"/> 6564:                                {error, _} = ERROR -&gt;
<a name="6565"/> 6565:                                    %% At the moment there is no way to get
<a name="6566"/> 6566:                                    %% status or state for the socket...
<a name="6567"/> 6567:                                    ERROR
<a name="6568"/> 6568:                            end
<a name="6569"/> 6569:                    end},
<a name="6570"/> 6570:          #{desc =&gt; &quot;announce ready (recv_rep)&quot;,
<a name="6571"/> 6571:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6572"/> 6572:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="6573"/> 6573:                            ok
<a name="6574"/> 6574:                    end},
<a name="6575"/> 6575: 
<a name="6576"/> 6576:          %% *** Termination ***
<a name="6577"/> 6577:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6578"/> 6578:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6579"/> 6579:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6580"/> 6580:                                ok -&gt;
<a name="6581"/> 6581:                                    {ok, maps:remove(tester, State)};
<a name="6582"/> 6582:                                {error, _} = ERROR -&gt;
<a name="6583"/> 6583:                                    ERROR
<a name="6584"/> 6584:                            end
<a name="6585"/> 6585:                    end},
<a name="6586"/> 6586:          #{desc =&gt; &quot;close socket&quot;,
<a name="6587"/> 6587:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6588"/> 6588:                            ok = socket:close(Sock),
<a name="6589"/> 6589:                            State2 = maps:remove(sock,         State),
<a name="6590"/> 6590:                            State3 = maps:remove(connect_stag, State2),
<a name="6591"/> 6591:                            State4 = maps:remove(connect_sref, State3),
<a name="6592"/> 6592:                            {ok, State4}
<a name="6593"/> 6593:                    end},
<a name="6594"/> 6594: 
<a name="6595"/> 6595:          %% *** We are done ***
<a name="6596"/> 6596:          ?SEV_FINISH_NORMAL
<a name="6597"/> 6597:         ],
<a name="6598"/> 6598: 
<a name="6599"/> 6599:     TesterSeq =
<a name="6600"/> 6600:         [
<a name="6601"/> 6601:          %% *** Init part ***
<a name="6602"/> 6602:          #{desc =&gt; &quot;monitor server&quot;,
<a name="6603"/> 6603:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="6604"/> 6604:                            _MRef = erlang:monitor(process, Pid),
<a name="6605"/> 6605:                            ok
<a name="6606"/> 6606:                    end},
<a name="6607"/> 6607:          #{desc =&gt; &quot;monitor client&quot;,
<a name="6608"/> 6608:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="6609"/> 6609:                            _MRef = erlang:monitor(process, Pid),
<a name="6610"/> 6610:                            ok
<a name="6611"/> 6611:                    end},
<a name="6612"/> 6612: 
<a name="6613"/> 6613:          %% Start the server
<a name="6614"/> 6614:          #{desc =&gt; &quot;order server start&quot;,
<a name="6615"/> 6615:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="6616"/> 6616:                            ?SEV_ANNOUNCE_START(Pid),
<a name="6617"/> 6617:                            ok
<a name="6618"/> 6618:                    end},
<a name="6619"/> 6619:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="6620"/> 6620:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="6621"/> 6621:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="6622"/> 6622:                            {ok, State#{server_port =&gt; Port}}
<a name="6623"/> 6623:                    end},
<a name="6624"/> 6624: 
<a name="6625"/> 6625:          %% Start the client
<a name="6626"/> 6626:          #{desc =&gt; &quot;order client start&quot;,
<a name="6627"/> 6627:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="6628"/> 6628:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="6629"/> 6629:                            ok
<a name="6630"/> 6630:                    end},
<a name="6631"/> 6631:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="6632"/> 6632:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="6633"/> 6633:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="6634"/> 6634:                    end},
<a name="6635"/> 6635: 
<a name="6636"/> 6636: 
<a name="6637"/> 6637:          %% *** The actual test ***
<a name="6638"/> 6638:          #{desc =&gt; &quot;order client to continue (async connect)&quot;,
<a name="6639"/> 6639:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6640"/> 6640:                            ?SEV_ANNOUNCE_CONTINUE(Client, async_connect),
<a name="6641"/> 6641:                            ok
<a name="6642"/> 6642:                    end},
<a name="6643"/> 6643:          #{desc =&gt; &quot;await client ready (connect select)&quot;,
<a name="6644"/> 6644:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6645"/> 6645:                            ?SEV_AWAIT_READY(Client, client, connect_select)
<a name="6646"/> 6646:                    end},
<a name="6647"/> 6647: 
<a name="6648"/> 6648:          ?SEV_SLEEP(?SECS(1)),
<a name="6649"/> 6649: 
<a name="6650"/> 6650:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="6651"/> 6651:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6652"/> 6652:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="6653"/> 6653:                            ok
<a name="6654"/> 6654:                    end},
<a name="6655"/> 6655:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="6656"/> 6656:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6657"/> 6657:                            ?SEV_AWAIT_READY(Client, client, select)
<a name="6658"/> 6658:                    end},
<a name="6659"/> 6659:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="6660"/> 6660:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6661"/> 6661:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="6662"/> 6662:                    end},
<a name="6663"/> 6663:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="6664"/> 6664:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6665"/> 6665:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="6666"/> 6666:                    end},
<a name="6667"/> 6667: 
<a name="6668"/> 6668:          ?SEV_SLEEP(?SECS(1)),
<a name="6669"/> 6669: 
<a name="6670"/> 6670:          #{desc =&gt; &quot;order server to recv test req (recv req)&quot;,
<a name="6671"/> 6671:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6672"/> 6672:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv_req),
<a name="6673"/> 6673:                            ok
<a name="6674"/> 6674:                    end},
<a name="6675"/> 6675:          #{desc =&gt; &quot;order client to send test req (send req)&quot;,
<a name="6676"/> 6676:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6677"/> 6677:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6678"/> 6678:                            ok
<a name="6679"/> 6679:                    end},
<a name="6680"/> 6680:          #{desc =&gt; &quot;await client ready (send_req)&quot;,
<a name="6681"/> 6681:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6682"/> 6682:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="6683"/> 6683:                    end},
<a name="6684"/> 6684:          #{desc =&gt; &quot;await server ready (recv_req)&quot;,
<a name="6685"/> 6685:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6686"/> 6686:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6687"/> 6687:                    end},
<a name="6688"/> 6688:          #{desc =&gt; &quot;order client to recv test rep (send rep)&quot;,
<a name="6689"/> 6689:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6690"/> 6690:                            ?SEV_ANNOUNCE_CONTINUE(Client, recv_rep),
<a name="6691"/> 6691:                            ok
<a name="6692"/> 6692:                    end},
<a name="6693"/> 6693:          #{desc =&gt; &quot;order server to send test rep (send rep)&quot;,
<a name="6694"/> 6694:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6695"/> 6695:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_rep),
<a name="6696"/> 6696:                            ok
<a name="6697"/> 6697:                    end},
<a name="6698"/> 6698:          #{desc =&gt; &quot;await server ready (send_rep)&quot;,
<a name="6699"/> 6699:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6700"/> 6700:                            ?SEV_AWAIT_READY(Server, server, send_rep)
<a name="6701"/> 6701:                    end},
<a name="6702"/> 6702:          #{desc =&gt; &quot;await client ready (recv_rep)&quot;,
<a name="6703"/> 6703:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6704"/> 6704:                            ?SEV_AWAIT_READY(Client, client, recv_rep)
<a name="6705"/> 6705:                    end},
<a name="6706"/> 6706: 
<a name="6707"/> 6707: 
<a name="6708"/> 6708:          %% *** Termination ***
<a name="6709"/> 6709:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="6710"/> 6710:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6711"/> 6711:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="6712"/> 6712:                            ok
<a name="6713"/> 6713:                    end},
<a name="6714"/> 6714:          #{desc =&gt; &quot;await client termination&quot;,
<a name="6715"/> 6715:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="6716"/> 6716:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="6717"/> 6717:                            State1 = maps:remove(client, State),
<a name="6718"/> 6718:                            {ok, State1}
<a name="6719"/> 6719:                    end},
<a name="6720"/> 6720:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="6721"/> 6721:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6722"/> 6722:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="6723"/> 6723:                            ok
<a name="6724"/> 6724:                    end},
<a name="6725"/> 6725:          #{desc =&gt; &quot;await server termination&quot;,
<a name="6726"/> 6726:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="6727"/> 6727:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="6728"/> 6728:                            State1 = maps:remove(server, State),
<a name="6729"/> 6729:                            {ok, State1}
<a name="6730"/> 6730:                    end},
<a name="6731"/> 6731: 
<a name="6732"/> 6732:          %% *** We are done ***
<a name="6733"/> 6733:          ?SEV_FINISH_NORMAL
<a name="6734"/> 6734:         ],
<a name="6735"/> 6735: 
<a name="6736"/> 6736:     i(&quot;start server evaluator&quot;),
<a name="6737"/> 6737:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="6738"/> 6738: 
<a name="6739"/> 6739:     i(&quot;start client evaluator&quot;),
<a name="6740"/> 6740:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="6741"/> 6741:     i(&quot;await evaluator(s)&quot;),
<a name="6742"/> 6742: 
<a name="6743"/> 6743:     i(&quot;start tester evaluator&quot;),
<a name="6744"/> 6744:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="6745"/> 6745:                         client =&gt; Client#ev.pid},
<a name="6746"/> 6746:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="6747"/> 6747: 
<a name="api_a_connect_tcp-last_expr"/><a name="6748"/> 6748: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="6749"/> 6749: 
<a name="6750"/> 6750: 
<a name="6751"/> 6751: 
<a name="6752"/> 6752: 
<a name="6753"/> 6753: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6754"/> 6754: 
<a name="6755"/> 6755: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="6756"/> 6756: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="6757"/> 6757: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="6758"/> 6758: <i>%% select message). Note that we only do this for the recvfrom,</i>
<a name="6759"/> 6759: <i>%% since its much more difficult to &quot;arrange&quot; for sendto.</i>
<a name="6760"/> 6760: <i>%%</i>
<a name="api_a_sendto_and_recvfrom_udp4-1"/><a name="6761"/> 6761: <b>api_a_sendto_and_recvfrom_udp4</b>(Config) when is_list(Config) -&gt;
<a name="6762"/> 6762:     ?TT(?SECS(5)),
<a name="6763"/> 6763:     Nowait = nowait(Config),
<a name="api_a_sendto_and_recvfrom_udp4-last_expr"/><a name="6764"/> 6764: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="6765"/> 6765:            fun() -&gt; has_support_ipv4() end,
<a name="6766"/> 6766:            fun() -&gt;
<a name="6767"/> 6767:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="6768"/> 6768:                                   socket:sendto(Sock, Data, Dest)
<a name="6769"/> 6769:                           end,
<a name="6770"/> 6770:                    Recv = fun(Sock) -&gt;
<a name="6771"/> 6771:                                   socket:recvfrom(Sock, 0, Nowait)
<a name="6772"/> 6772:                           end,
<a name="6773"/> 6773:                    InitState = #{domain   =&gt; inet,
<a name="6774"/> 6774:                                  send     =&gt; Send,
<a name="6775"/> 6775:                                  recv     =&gt; Recv,
<a name="6776"/> 6776:                                  recv_ref =&gt; Nowait},
<a name="6777"/> 6777:                    ok = api_a_send_and_recv_udp(InitState)
<a name="6778"/> 6778:            end).
<a name="6779"/> 6779: 
<a name="6780"/> 6780: 
<a name="6781"/> 6781: 
<a name="6782"/> 6782: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6783"/> 6783: 
<a name="6784"/> 6784: <i>%% Basically send and receive on an IPv6 UDP (dgram) socket using</i>
<a name="6785"/> 6785: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="6786"/> 6786: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="6787"/> 6787: <i>%% select message). Note that we only do this for the recvfrom,</i>
<a name="6788"/> 6788: <i>%% since its much more difficult to &quot;arrange&quot; for sendto.</i>
<a name="6789"/> 6789: <i>%%</i>
<a name="api_a_sendto_and_recvfrom_udp6-1"/><a name="6790"/> 6790: <b>api_a_sendto_and_recvfrom_udp6</b>(Config) when is_list(Config) -&gt;
<a name="6791"/> 6791:     ?TT(?SECS(5)),
<a name="6792"/> 6792:     Nowait = nowait(Config),
<a name="api_a_sendto_and_recvfrom_udp6-last_expr"/><a name="6793"/> 6793: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="6794"/> 6794:            fun() -&gt; has_support_ipv6() end,
<a name="6795"/> 6795:            fun() -&gt;
<a name="6796"/> 6796:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="6797"/> 6797:                                   socket:sendto(Sock, Data, Dest)
<a name="6798"/> 6798:                           end,
<a name="6799"/> 6799:                    Recv = fun(Sock) -&gt;
<a name="6800"/> 6800:                                   socket:recvfrom(Sock, 0, Nowait)
<a name="6801"/> 6801:                           end,
<a name="6802"/> 6802:                    InitState = #{domain   =&gt; inet6,
<a name="6803"/> 6803:                                  send     =&gt; Send,
<a name="6804"/> 6804:                                  recv     =&gt; Recv,
<a name="6805"/> 6805:                                  recv_ref =&gt; Nowait},
<a name="6806"/> 6806:                    ok = api_a_send_and_recv_udp(InitState)
<a name="6807"/> 6807:            end).
<a name="6808"/> 6808: 
<a name="6809"/> 6809: 
<a name="6810"/> 6810: 
<a name="6811"/> 6811: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6812"/> 6812: 
<a name="6813"/> 6813: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="6814"/> 6814: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="6815"/> 6815: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="6816"/> 6816: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="6817"/> 6817: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="6818"/> 6818: <i>%%</i>
<a name="api_a_sendmsg_and_recvmsg_udp4-1"/><a name="6819"/> 6819: <b>api_a_sendmsg_and_recvmsg_udp4</b>(Config) when is_list(Config) -&gt;
<a name="6820"/> 6820:     ?TT(?SECS(5)),
<a name="6821"/> 6821:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_udp4-last_expr"/><a name="6822"/> 6822: <b>    tc_try</b>(api_a_sendmsg_and_recvmsg_udp4,
<a name="6823"/> 6823:            fun() -&gt; has_support_ipv4() end,
<a name="6824"/> 6824:            fun() -&gt;
<a name="6825"/> 6825:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="6826"/> 6826:                                   Msg = #{addr =&gt; Dest,
<a name="6827"/> 6827:                                              %% ctrl =&gt; CMsgs,
<a name="6828"/> 6828:                                              iov  =&gt; [Data]},
<a name="6829"/> 6829:                                   socket:sendmsg(Sock, Msg)
<a name="6830"/> 6830:                           end,
<a name="6831"/> 6831:                    Recv = fun(Sock) -&gt;
<a name="6832"/> 6832:                                   case socket:recvmsg(Sock, Nowait) of
<a name="6833"/> 6833:                                       {ok, #{addr  := Source,
<a name="6834"/> 6834:                                              iov   := [Data]}} -&gt;
<a name="6835"/> 6835:                                           {ok, {Source, Data}};
<a name="6836"/> 6836:                                       {ok, _} = OK -&gt;
<a name="6837"/> 6837:                                           OK;
<a name="6838"/> 6838:                                       {select, _} = SELECT -&gt;
<a name="6839"/> 6839:                                           SELECT;
<a name="6840"/> 6840:                                       {completion, _} = COMPLETION -&gt;
<a name="6841"/> 6841:                                           COMPLETION;
<a name="6842"/> 6842:                                       {error, _} = ERROR -&gt;
<a name="6843"/> 6843:                                           ERROR
<a name="6844"/> 6844:                                   end
<a name="6845"/> 6845:                           end,
<a name="6846"/> 6846:                    InitState = #{domain   =&gt; inet,
<a name="6847"/> 6847:                                  send     =&gt; Send,
<a name="6848"/> 6848:                                  recv     =&gt; Recv,
<a name="6849"/> 6849:                                  recv_ref =&gt; Nowait},
<a name="6850"/> 6850:                    ok = api_a_send_and_recv_udp(InitState)
<a name="6851"/> 6851:            end).
<a name="6852"/> 6852: 
<a name="6853"/> 6853: 
<a name="6854"/> 6854: 
<a name="6855"/> 6855: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6856"/> 6856: 
<a name="6857"/> 6857: <i>%% Basically send and receive on an IPv6 UDP (dgram) socket using</i>
<a name="6858"/> 6858: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="6859"/> 6859: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="6860"/> 6860: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="6861"/> 6861: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="6862"/> 6862: <i>%%</i>
<a name="api_a_sendmsg_and_recvmsg_udp6-1"/><a name="6863"/> 6863: <b>api_a_sendmsg_and_recvmsg_udp6</b>(Config) when is_list(Config) -&gt;
<a name="6864"/> 6864:     ?TT(?SECS(5)),
<a name="6865"/> 6865:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_udp6-last_expr"/><a name="6866"/> 6866: <b>    tc_try</b>(api_a_sendmsg_and_recvmsg_udp6,
<a name="6867"/> 6867:            fun() -&gt; has_support_ipv6() end,
<a name="6868"/> 6868:            fun() -&gt;
<a name="6869"/> 6869:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="6870"/> 6870:                                   Msg = #{addr =&gt; Dest,
<a name="6871"/> 6871:                                              %% ctrl =&gt; CMsgs,
<a name="6872"/> 6872:                                              iov  =&gt; [Data]},
<a name="6873"/> 6873:                                   socket:sendmsg(Sock, Msg)
<a name="6874"/> 6874:                           end,
<a name="6875"/> 6875:                    Recv = fun(Sock) -&gt;
<a name="6876"/> 6876:                                   case socket:recvmsg(Sock, Nowait) of
<a name="6877"/> 6877:                                       {ok, #{addr  := Source,
<a name="6878"/> 6878:                                              iov   := [Data]}} -&gt;
<a name="6879"/> 6879:                                           {ok, {Source, Data}};
<a name="6880"/> 6880:                                       {ok, _} = OK -&gt;
<a name="6881"/> 6881:                                           OK;
<a name="6882"/> 6882:                                       {select, _} = SELECT -&gt;
<a name="6883"/> 6883:                                           SELECT;
<a name="6884"/> 6884:                                       {completion, _} = COMPLETION -&gt;
<a name="6885"/> 6885:                                           COMPLETION;
<a name="6886"/> 6886:                                       {error, _} = ERROR -&gt;
<a name="6887"/> 6887:                                           ERROR
<a name="6888"/> 6888:                                   end
<a name="6889"/> 6889:                           end,
<a name="6890"/> 6890:                    InitState = #{domain   =&gt; inet6,
<a name="6891"/> 6891:                                  send     =&gt; Send,
<a name="6892"/> 6892:                                  recv     =&gt; Recv,
<a name="6893"/> 6893:                                  recv_ref =&gt; Nowait},
<a name="6894"/> 6894:                    ok = api_a_send_and_recv_udp(InitState)
<a name="6895"/> 6895:            end).
<a name="6896"/> 6896: 
<a name="6897"/> 6897: 
<a name="6898"/> 6898: 
<a name="6899"/> 6899: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6900"/> 6900: 
<a name="api_a_send_and_recv_udp-1"/><a name="6901"/> 6901: <b>api_a_send_and_recv_udp</b>(InitState) -&gt;
<a name="6902"/> 6902:     ServerSeq = 
<a name="6903"/> 6903:         [
<a name="6904"/> 6904:          %% *** Wait for start order part ***
<a name="6905"/> 6905:          #{desc =&gt; &quot;await start&quot;,
<a name="6906"/> 6906:            cmd  =&gt; fun(State) -&gt;
<a name="6907"/> 6907:                            Tester = ?SEV_AWAIT_START(),
<a name="6908"/> 6908:                            {ok, State#{tester =&gt; Tester}}
<a name="6909"/> 6909:                    end},
<a name="6910"/> 6910:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6911"/> 6911:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6912"/> 6912:                            _MRef = erlang:monitor(process, Tester),
<a name="6913"/> 6913:                            ok
<a name="6914"/> 6914:                    end},
<a name="6915"/> 6915: 
<a name="6916"/> 6916:          %% *** Init part ***
<a name="6917"/> 6917:          #{desc =&gt; &quot;which local address&quot;,
<a name="6918"/> 6918:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6919"/> 6919:                            LSA = which_local_socket_addr(Domain),
<a name="6920"/> 6920:                            {ok, State#{local_sa =&gt; LSA}}
<a name="6921"/> 6921:                    end},
<a name="6922"/> 6922:          #{desc =&gt; &quot;create socket&quot;,
<a name="6923"/> 6923:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6924"/> 6924:                            case socket:open(Domain, dgram, udp) of
<a name="6925"/> 6925:                                {ok, Sock} -&gt;
<a name="6926"/> 6926:                                    {ok, State#{sock =&gt; Sock}};
<a name="6927"/> 6927:                                {error, _} = ERROR -&gt;
<a name="6928"/> 6928:                                    ERROR
<a name="6929"/> 6929:                            end
<a name="6930"/> 6930:                    end},
<a name="6931"/> 6931:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="6932"/> 6932:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="6933"/> 6933:                            case sock_bind(Sock, LSA) of
<a name="6934"/> 6934:                                ok -&gt;
<a name="6935"/> 6935:                                    Port = sock_port(Sock),
<a name="6936"/> 6936:                                    {ok, State#{port =&gt; Port}};
<a name="6937"/> 6937:                                {error, _} = ERROR -&gt;
<a name="6938"/> 6938:                                    ERROR
<a name="6939"/> 6939:                            end
<a name="6940"/> 6940:                    end},
<a name="6941"/> 6941:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6942"/> 6942:            cmd  =&gt; fun(#{tester := Tester, local_sa := LSA, port := Port}) -&gt;
<a name="6943"/> 6943:                            ServerSA = LSA#{port =&gt; Port},
<a name="6944"/> 6944:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="6945"/> 6945:                            ok
<a name="6946"/> 6946:                    end},
<a name="6947"/> 6947: 
<a name="6948"/> 6948:          %% The actual test
<a name="6949"/> 6949:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="6950"/> 6950:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6951"/> 6951:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="6952"/> 6952:                    end},
<a name="6953"/> 6953:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="6954"/> 6954:            cmd  =&gt; fun(#{sock     := Sock,
<a name="6955"/> 6955:                          recv     := Recv,
<a name="6956"/> 6956:                          recv_ref := Ref} = State) -&gt;
<a name="6957"/> 6957:                            case Recv(Sock) of
<a name="6958"/> 6958:                                {select, {select_info, Tag, RecvRef}}
<a name="6959"/> 6959:                                  when Ref =:= nowait -&gt;
<a name="6960"/> 6960:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="6961"/> 6961:                                                &quot;~n   Tag: ~p&quot;
<a name="6962"/> 6962:                                                &quot;~n   Ref: ~p&quot;, [Tag, RecvRef]),
<a name="6963"/> 6963:                                    {ok, State#{async_tag =&gt; select,
<a name="6964"/> 6964:                                                recv_tag  =&gt; Tag,
<a name="6965"/> 6965:                                                recv_ref  =&gt; RecvRef}};
<a name="6966"/> 6966:                                {select, {select_info, Tag, Ref}}
<a name="6967"/> 6967:                                  when is_reference(Ref) -&gt;
<a name="6968"/> 6968:                                    ?SEV_IPRINT(&quot;expected select ref: &quot;
<a name="6969"/> 6969:                                                &quot;~n   Tag: ~p&quot;
<a name="6970"/> 6970:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="6971"/> 6971:                                    {ok, State#{async_tag =&gt; select,
<a name="6972"/> 6972:                                                recv_tag  =&gt; Tag}};
<a name="6973"/> 6973: 
<a name="6974"/> 6974:                                {completion, {completion_info, Tag, RecvRef}}
<a name="6975"/> 6975:                                  when Ref =:= nowait -&gt;
<a name="6976"/> 6976:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="6977"/> 6977:                                                &quot;~n   Tag: ~p&quot;
<a name="6978"/> 6978:                                                &quot;~n   Ref: ~p&quot;, [Tag, RecvRef]),
<a name="6979"/> 6979:                                    {ok, State#{async_tag =&gt; completion,
<a name="6980"/> 6980:                                                recv_tag  =&gt; Tag,
<a name="6981"/> 6981:                                                recv_ref  =&gt; RecvRef}};
<a name="6982"/> 6982:                                {completion, {completion_info, Tag, Ref}}
<a name="6983"/> 6983:                                  when is_reference(Ref) -&gt;
<a name="6984"/> 6984:                                    ?SEV_IPRINT(&quot;expected completion ref: &quot;
<a name="6985"/> 6985:                                                &quot;~n   Tag: ~p&quot;
<a name="6986"/> 6986:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="6987"/> 6987:                                    {ok, State#{async_tag =&gt; completion,
<a name="6988"/> 6988:                                                recv_tag  =&gt; Tag}};
<a name="6989"/> 6989: 
<a name="6990"/> 6990:                                {ok, X} -&gt;
<a name="6991"/> 6991:                                    {error, {unexpected_success, X}};
<a name="6992"/> 6992: 
<a name="6993"/> 6993:                                {error, _} = ERROR -&gt;
<a name="6994"/> 6994:                                    ERROR
<a name="6995"/> 6995:                            end
<a name="6996"/> 6996:                    end},
<a name="6997"/> 6997:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="6998"/> 6998:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6999"/> 6999:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="7000"/> 7000:                            ok
<a name="7001"/> 7001:                    end},
<a name="7002"/> 7002:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="7003"/> 7003:            cmd  =&gt; fun(#{async_tag := select,
<a name="7004"/> 7004:                          sock      := Sock,
<a name="7005"/> 7005:                          recv_ref  := RecvRef}) -&gt;
<a name="7006"/> 7006:                            receive
<a name="7007"/> 7007:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="7008"/> 7008:                                    ok
<a name="7009"/> 7009:                            after 5000 -&gt;
<a name="7010"/> 7010:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="7011"/> 7011:                                                &quot;~n   Socket Info:   ~p&quot;
<a name="7012"/> 7012:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="7013"/> 7013:                                                [socket:info(Sock), ?MQ()]),
<a name="7014"/> 7014:                                    {error, timeout}
<a name="7015"/> 7015:                            end;
<a name="7016"/> 7016:                       (#{async_tag := completion,
<a name="7017"/> 7017:                          sock      := Sock,
<a name="7018"/> 7018:                          recv_ref  := RecvRef} = State) -&gt;
<a name="7019"/> 7019:                            receive
<a name="7020"/> 7020:                                %% Recvfrom
<a name="7021"/> 7021:                                {'$socket', Sock, completion,
<a name="7022"/> 7022:                                 {RecvRef, {ok, {Src, ?BASIC_REQ}}}} -&gt;
<a name="7023"/> 7023:                                    {ok, State#{req_src =&gt; Src}};
<a name="7024"/> 7024:                                %% Recvmsg
<a name="7025"/> 7025:                                {'$socket', Sock, completion,
<a name="7026"/> 7026:                                 {RecvRef, {ok, #{addr := Src,
<a name="7027"/> 7027:                                                  iov  := [?BASIC_REQ]}}}} -&gt;
<a name="7028"/> 7028:                                    {ok, State#{req_src =&gt; Src}};
<a name="7029"/> 7029:                                {'$socket', Sock, completion,
<a name="7030"/> 7030:                                 {RecvRef, {ok, Unexpected}}} -&gt;
<a name="7031"/> 7031:                                    ?SEV_EPRINT(&quot;Unexpected success result: &quot;
<a name="7032"/> 7032:                                                &quot;~n   ~p&quot;, [Unexpected]),
<a name="7033"/> 7033:                                    {error, {unexpected_success_result,
<a name="7034"/> 7034:                                             Unexpected}};
<a name="7035"/> 7035:                                {'$socket', Sock, completion,
<a name="7036"/> 7036:                                 {RecvRef, {error, Reason} = ERROR}} -&gt;
<a name="7037"/> 7037:                                    ?SEV_EPRINT(&quot;completion with error: &quot;
<a name="7038"/> 7038:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="7039"/> 7039:                                    ERROR
<a name="7040"/> 7040:                            after 5000 -&gt;
<a name="7041"/> 7041:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="7042"/> 7042:                                                &quot;~n   Socket Info:   ~p&quot;
<a name="7043"/> 7043:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="7044"/> 7044:                                                [socket:info(Sock), ?MQ()]),
<a name="7045"/> 7045:                                    {error, timeout}
<a name="7046"/> 7046:                            end
<a name="7047"/> 7047:                    end},
<a name="7048"/> 7048:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="7049"/> 7049:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7050"/> 7050:                            %% We are actually done *if* this was
<a name="7051"/> 7051:                            %% a completion event, but to make the
<a name="7052"/> 7052:                            %% test case simple...
<a name="7053"/> 7053:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7054"/> 7054:                            ok
<a name="7055"/> 7055:                    end},
<a name="7056"/> 7056:          #{desc =&gt; &quot;now read the data (request), for select&quot;,
<a name="7057"/> 7057:            cmd  =&gt; fun(#{async_tag := select,
<a name="7058"/> 7058:                          sock      := Sock,
<a name="7059"/> 7059:                          recv      := Recv} = State) -&gt;
<a name="7060"/> 7060:                            case Recv(Sock) of
<a name="7061"/> 7061:                                {ok, {Src, ?BASIC_REQ}} -&gt;
<a name="7062"/> 7062:                                    {ok, State#{req_src =&gt; Src}};
<a name="7063"/> 7063:                                {error, _} = ERROR -&gt;
<a name="7064"/> 7064:                                    ERROR
<a name="7065"/> 7065:                            end;
<a name="7066"/> 7066:                       (#{async_tag := completion} = _State) -&gt;
<a name="7067"/> 7067:                            %% We are already done!
<a name="7068"/> 7068:                            ?SEV_IPRINT(&quot;Already done!&quot;),
<a name="7069"/> 7069:                            ok
<a name="7070"/> 7070:                    end},
<a name="7071"/> 7071:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="7072"/> 7072:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7073"/> 7073:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="7074"/> 7074:                            ok
<a name="7075"/> 7075:                    end},
<a name="7076"/> 7076: 
<a name="7077"/> 7077:          #{desc =&gt; &quot;await continue (send reply)&quot;,
<a name="7078"/> 7078:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7079"/> 7079:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="7080"/> 7080:                    end},
<a name="7081"/> 7081:          #{desc =&gt; &quot;send reply&quot;,
<a name="7082"/> 7082:            cmd  =&gt; fun(#{sock := Sock, req_src := Src, send := Send}) -&gt;
<a name="7083"/> 7083:                            Send(Sock, ?BASIC_REP, Src)
<a name="7084"/> 7084:                    end},
<a name="7085"/> 7085:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="7086"/> 7086:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7087"/> 7087:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="7088"/> 7088:                            ok
<a name="7089"/> 7089:                    end},
<a name="7090"/> 7090: 
<a name="7091"/> 7091:          %% Termination
<a name="7092"/> 7092:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="7093"/> 7093:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="7094"/> 7094:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="7095"/> 7095:                                ok -&gt;
<a name="7096"/> 7096:                                    State2 = maps:remove(tester,    State),
<a name="7097"/> 7097:                                    State3 = maps:remove(async_tag, State2),
<a name="7098"/> 7098:                                    State4 = maps:remove(recv_tag,  State3),
<a name="7099"/> 7099:                                    State5 = maps:remove(recv_ref,  State4),
<a name="7100"/> 7100:                                    State6 = maps:remove(req_src,   State5),
<a name="7101"/> 7101:                                    {ok, State6};
<a name="7102"/> 7102:                                {error, _} = ERROR -&gt;
<a name="7103"/> 7103:                                    ERROR
<a name="7104"/> 7104:                            end
<a name="7105"/> 7105:                    end},
<a name="7106"/> 7106:          #{desc =&gt; &quot;close socket&quot;,
<a name="7107"/> 7107:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="7108"/> 7108:                            ok = socket:close(Sock),
<a name="7109"/> 7109:                            {ok, maps:remove(sock, State)}
<a name="7110"/> 7110:                    end},
<a name="7111"/> 7111: 
<a name="7112"/> 7112:          %% *** We are done ***
<a name="7113"/> 7113:          ?SEV_FINISH_NORMAL
<a name="7114"/> 7114:         ],
<a name="7115"/> 7115: 
<a name="7116"/> 7116: 
<a name="7117"/> 7117:     ClientSeq = 
<a name="7118"/> 7118:         [
<a name="7119"/> 7119:          %% *** Wait for start order part ***
<a name="7120"/> 7120:          #{desc =&gt; &quot;await start&quot;,
<a name="7121"/> 7121:            cmd  =&gt; fun(State) -&gt;
<a name="7122"/> 7122:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="7123"/> 7123:                            {ok, State#{tester    =&gt; Tester, 
<a name="7124"/> 7124:                                        server_sa =&gt; ServerSA}}
<a name="7125"/> 7125:                    end},
<a name="7126"/> 7126:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7127"/> 7127:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7128"/> 7128:                            _MRef = erlang:monitor(process, Tester),
<a name="7129"/> 7129:                            ok
<a name="7130"/> 7130:                    end},
<a name="7131"/> 7131: 
<a name="7132"/> 7132:          %% *** Init part ***
<a name="7133"/> 7133:          #{desc =&gt; &quot;local address&quot;,
<a name="7134"/> 7134:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7135"/> 7135:                            LSA = which_local_socket_addr(Domain),
<a name="7136"/> 7136:                            {ok, State#{lsa =&gt; LSA}}
<a name="7137"/> 7137:                    end},
<a name="7138"/> 7138:          #{desc =&gt; &quot;open socket&quot;,
<a name="7139"/> 7139:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7140"/> 7140:                            Sock = sock_open(Domain, dgram, udp),
<a name="7141"/> 7141:                            {ok, State#{sock =&gt; Sock}}
<a name="7142"/> 7142:                    end},
<a name="7143"/> 7143:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="7144"/> 7144:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="7145"/> 7145:                           case sock_bind(Sock, LSA) of
<a name="7146"/> 7146:                                ok -&gt;
<a name="7147"/> 7147:                                    ok;
<a name="7148"/> 7148:                                {error, _} = ERROR -&gt;
<a name="7149"/> 7149:                                    ERROR
<a name="7150"/> 7150:                            end
<a name="7151"/> 7151:                    end},
<a name="7152"/> 7152:          #{desc =&gt; &quot;sockname&quot;,
<a name="7153"/> 7153:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="7154"/> 7154:                            SA = sock_sockname(Sock),
<a name="7155"/> 7155:                            {ok, State#{sa =&gt; SA}}
<a name="7156"/> 7156:                    end},
<a name="7157"/> 7157:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7158"/> 7158:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7159"/> 7159:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="7160"/> 7160:                            ok
<a name="7161"/> 7161:                    end},
<a name="7162"/> 7162: 
<a name="7163"/> 7163:          %% The actual test
<a name="7164"/> 7164:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="7165"/> 7165:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7166"/> 7166:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="7167"/> 7167:                    end},
<a name="7168"/> 7168:          #{desc =&gt; &quot;send request&quot;,
<a name="7169"/> 7169:            cmd  =&gt; fun(#{sock := Sock, server_sa := Server, send := Send}) -&gt;
<a name="7170"/> 7170:                            Send(Sock, ?BASIC_REQ, Server)
<a name="7171"/> 7171:                    end},
<a name="7172"/> 7172:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="7173"/> 7173:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7174"/> 7174:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="7175"/> 7175:                            ok
<a name="7176"/> 7176:                    end},
<a name="7177"/> 7177:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="7178"/> 7178:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7179"/> 7179:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="7180"/> 7180:                    end},
<a name="7181"/> 7181:          #{desc =&gt; &quot;try recv reply (with nowait)&quot;,
<a name="7182"/> 7182:            cmd  =&gt; fun(#{sock     := Sock,
<a name="7183"/> 7183:                          recv     := Recv,
<a name="7184"/> 7184:                          recv_ref := Ref} = State) -&gt;
<a name="7185"/> 7185:                            case Recv(Sock) of
<a name="7186"/> 7186:                                {select, {select_info, Tag, RecvRef}}
<a name="7187"/> 7187:                                  when Ref =:= nowait -&gt;
<a name="7188"/> 7188:                                    {ok, State#{async_tag =&gt; select,
<a name="7189"/> 7189:                                                recv_tag  =&gt; Tag,
<a name="7190"/> 7190:                                                recv_ref  =&gt; RecvRef}};
<a name="7191"/> 7191:                                {select, {select_info, Tag, Ref}}
<a name="7192"/> 7192:                                  when is_reference(Ref) -&gt;
<a name="7193"/> 7193:                                    {ok, State#{async_tag =&gt; select,
<a name="7194"/> 7194:                                                recv_tag  =&gt; Tag}};
<a name="7195"/> 7195:                                {completion, {completion_info, Tag, RecvRef}}
<a name="7196"/> 7196:                                  when Ref =:= nowait -&gt;
<a name="7197"/> 7197:                                    {ok, State#{async_tag =&gt; completion,
<a name="7198"/> 7198:                                                recv_tag  =&gt; Tag,
<a name="7199"/> 7199:                                                recv_ref  =&gt; RecvRef}};
<a name="7200"/> 7200:                                {completion, {completion_info, Tag, Ref}}
<a name="7201"/> 7201:                                  when is_reference(Ref) -&gt;
<a name="7202"/> 7202:                                    {ok, State#{async_tag =&gt; completion,
<a name="7203"/> 7203:                                                recv_tag  =&gt; Tag}};
<a name="7204"/> 7204:                                {ok, X} -&gt;
<a name="7205"/> 7205:                                    {error, {unexpected_select_info, X}};
<a name="7206"/> 7206:                                {error, _} = ERROR -&gt;
<a name="7207"/> 7207:                                    ERROR
<a name="7208"/> 7208:                            end
<a name="7209"/> 7209:                    end},
<a name="7210"/> 7210:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="7211"/> 7211:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7212"/> 7212:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="7213"/> 7213:                            ok
<a name="7214"/> 7214:                    end},
<a name="7215"/> 7215:          #{desc =&gt; &quot;await select message&quot;,
<a name="7216"/> 7216:            cmd  =&gt; fun(#{async_tag := select,
<a name="7217"/> 7217:                          sock      := Sock,
<a name="7218"/> 7218:                          recv_ref  := RecvRef}) -&gt;
<a name="7219"/> 7219:                            receive
<a name="7220"/> 7220:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="7221"/> 7221:                                    ok
<a name="7222"/> 7222:                            end;
<a name="7223"/> 7223:                       (#{async_tag := completion,
<a name="7224"/> 7224:                          sock      := Sock,
<a name="7225"/> 7225:                          recv_ref  := RecvRef}) -&gt;
<a name="7226"/> 7226:                            receive
<a name="7227"/> 7227:                                {'$socket', Sock, completion,
<a name="7228"/> 7228:                                 {RecvRef, {ok, _}}} -&gt;
<a name="7229"/> 7229:                                    ok
<a name="7230"/> 7230:                            end
<a name="7231"/> 7231:                    end},
<a name="7232"/> 7232:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="7233"/> 7233:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7234"/> 7234:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7235"/> 7235:                            ok
<a name="7236"/> 7236:                    end},
<a name="7237"/> 7237:          #{desc =&gt; &quot;now read the data (reply)&quot;,
<a name="7238"/> 7238:            cmd  =&gt; fun(#{async_tag := select,
<a name="7239"/> 7239:                          sock      := Sock,
<a name="7240"/> 7240:                          recv      := Recv}) -&gt;
<a name="7241"/> 7241:                            case Recv(Sock) of
<a name="7242"/> 7242:                                {ok, {_Src, ?BASIC_REP}} -&gt;
<a name="7243"/> 7243:                                    ok;
<a name="7244"/> 7244:                                {error, _} = ERROR -&gt;
<a name="7245"/> 7245:                                    ERROR
<a name="7246"/> 7246:                            end;
<a name="7247"/> 7247:                       (#{async_tag := completion}) -&gt;
<a name="7248"/> 7248:                            ?SEV_IPRINT(&quot;Already read!&quot;),
<a name="7249"/> 7249:                            ok
<a name="7250"/> 7250:                    end},
<a name="7251"/> 7251:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="7252"/> 7252:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7253"/> 7253:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="7254"/> 7254:                            ok
<a name="7255"/> 7255:                    end},
<a name="7256"/> 7256: 
<a name="7257"/> 7257:          %% Termination
<a name="7258"/> 7258:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="7259"/> 7259:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="7260"/> 7260:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="7261"/> 7261:                                ok -&gt;
<a name="7262"/> 7262:                                    State2 = maps:remove(tester,    State),
<a name="7263"/> 7263:                                    State3 = maps:remove(async_tag, State2),
<a name="7264"/> 7264:                                    State4 = maps:remove(recv_tag,  State3),
<a name="7265"/> 7265:                                    State5 = maps:remove(recv_ref,  State4),
<a name="7266"/> 7266:                                    {ok, State5};
<a name="7267"/> 7267:                                {error, _} = ERROR -&gt;
<a name="7268"/> 7268:                                    ERROR
<a name="7269"/> 7269:                            end
<a name="7270"/> 7270:                    end},
<a name="7271"/> 7271:          #{desc =&gt; &quot;close socket&quot;,
<a name="7272"/> 7272:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="7273"/> 7273:                            ok = socket:close(Sock),
<a name="7274"/> 7274:                            {ok, maps:remove(sock, State)}
<a name="7275"/> 7275:                    end},
<a name="7276"/> 7276: 
<a name="7277"/> 7277:          %% *** We are done ***
<a name="7278"/> 7278:          ?SEV_FINISH_NORMAL
<a name="7279"/> 7279:         ],
<a name="7280"/> 7280: 
<a name="7281"/> 7281: 
<a name="7282"/> 7282:     TesterSeq = 
<a name="7283"/> 7283:         [
<a name="7284"/> 7284:          %% *** Init part ***
<a name="7285"/> 7285:          #{desc =&gt; &quot;monitor server&quot;,
<a name="7286"/> 7286:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7287"/> 7287:                            _MRef = erlang:monitor(process, Pid),
<a name="7288"/> 7288:                            ok
<a name="7289"/> 7289:                    end},
<a name="7290"/> 7290:          #{desc =&gt; &quot;monitor client&quot;,
<a name="7291"/> 7291:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7292"/> 7292:                            _MRef = erlang:monitor(process, Pid),
<a name="7293"/> 7293:                            ok
<a name="7294"/> 7294:                    end},
<a name="7295"/> 7295: 
<a name="7296"/> 7296:          %% Start the server
<a name="7297"/> 7297:          #{desc =&gt; &quot;order server start&quot;,
<a name="7298"/> 7298:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7299"/> 7299:                            ?SEV_ANNOUNCE_START(Pid),
<a name="7300"/> 7300:                            ok
<a name="7301"/> 7301:                    end},
<a name="7302"/> 7302:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="7303"/> 7303:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="7304"/> 7304:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="7305"/> 7305:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="7306"/> 7306:                    end},
<a name="7307"/> 7307: 
<a name="7308"/> 7308:          %% Start the client
<a name="7309"/> 7309:          #{desc =&gt; &quot;order client start&quot;,
<a name="7310"/> 7310:            cmd  =&gt; fun(#{client    := Pid, 
<a name="7311"/> 7311:                          server_sa := ServerSA} = _State) -&gt;
<a name="7312"/> 7312:                            ?SEV_ANNOUNCE_START(Pid, ServerSA),
<a name="7313"/> 7313:                            ok
<a name="7314"/> 7314:                    end},
<a name="7315"/> 7315:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="7316"/> 7316:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7317"/> 7317:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="7318"/> 7318:                    end},
<a name="7319"/> 7319:  
<a name="7320"/> 7320:          %% The actual test
<a name="7321"/> 7321:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="7322"/> 7322:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7323"/> 7323:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="7324"/> 7324:                            ok
<a name="7325"/> 7325:                    end},
<a name="7326"/> 7326:          #{desc =&gt; &quot;await server ready (recv_select)&quot;,
<a name="7327"/> 7327:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7328"/> 7328:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="7329"/> 7329:                    end},
<a name="7330"/> 7330: 
<a name="7331"/> 7331:          #{desc =&gt; &quot;order client continue (send request)&quot;,
<a name="7332"/> 7332:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7333"/> 7333:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_req),
<a name="7334"/> 7334:                            ok
<a name="7335"/> 7335:                    end},
<a name="7336"/> 7336:          #{desc =&gt; &quot;await client ready (send request)&quot;,
<a name="7337"/> 7337:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7338"/> 7338:                            ok = ?SEV_AWAIT_READY(Pid, client, send_req)
<a name="7339"/> 7339:                    end},
<a name="7340"/> 7340:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="7341"/> 7341:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7342"/> 7342:                            ok = ?SEV_AWAIT_READY(Pid, server, select)
<a name="7343"/> 7343:                    end},
<a name="7344"/> 7344:          #{desc =&gt; &quot;await server ready (recv request)&quot;,
<a name="7345"/> 7345:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7346"/> 7346:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_req)
<a name="7347"/> 7347:                    end},
<a name="7348"/> 7348: 
<a name="7349"/> 7349:          #{desc =&gt; &quot;order client continue (recv)&quot;,
<a name="7350"/> 7350:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7351"/> 7351:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="7352"/> 7352:                            ok
<a name="7353"/> 7353:                    end},
<a name="7354"/> 7354:          #{desc =&gt; &quot;await client ready (recv_select)&quot;,
<a name="7355"/> 7355:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7356"/> 7356:                            ok = ?SEV_AWAIT_READY(Pid, client, recv_select)
<a name="7357"/> 7357:                    end},
<a name="7358"/> 7358:          #{desc =&gt; &quot;order server continue (send reply)&quot;,
<a name="7359"/> 7359:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7360"/> 7360:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_reply),
<a name="7361"/> 7361:                            ok
<a name="7362"/> 7362:                    end},
<a name="7363"/> 7363:          #{desc =&gt; &quot;await server ready (send)&quot;,
<a name="7364"/> 7364:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7365"/> 7365:                            ok = ?SEV_AWAIT_READY(Pid, server, send)
<a name="7366"/> 7366:                    end},
<a name="7367"/> 7367:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="7368"/> 7368:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7369"/> 7369:                            ok = ?SEV_AWAIT_READY(Pid, client, select)
<a name="7370"/> 7370:                    end},
<a name="7371"/> 7371:          #{desc =&gt; &quot;await client ready (recv reply)&quot;,
<a name="7372"/> 7372:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7373"/> 7373:                            ok = ?SEV_AWAIT_READY(Pid, client, recv_rep)
<a name="7374"/> 7374:                    end},
<a name="7375"/> 7375: 
<a name="7376"/> 7376:          %% Terminations
<a name="7377"/> 7377:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="7378"/> 7378:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7379"/> 7379:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="7380"/> 7380:                            ok
<a name="7381"/> 7381:                    end},
<a name="7382"/> 7382:          #{desc =&gt; &quot;await client termination&quot;,
<a name="7383"/> 7383:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="7384"/> 7384:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="7385"/> 7385:                                ok -&gt;
<a name="7386"/> 7386:                                    State1 = maps:remove(client, State),
<a name="7387"/> 7387:                                    {ok, State1};
<a name="7388"/> 7388:                                {error, _} = ERROR -&gt;
<a name="7389"/> 7389:                                    ERROR
<a name="7390"/> 7390:                            end
<a name="7391"/> 7391:                    end},
<a name="7392"/> 7392:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="7393"/> 7393:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7394"/> 7394:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="7395"/> 7395:                            ok
<a name="7396"/> 7396:                    end},
<a name="7397"/> 7397:          #{desc =&gt; &quot;await server termination&quot;,
<a name="7398"/> 7398:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="7399"/> 7399:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="7400"/> 7400:                                ok -&gt;
<a name="7401"/> 7401:                                    State1 = maps:remove(server, State),
<a name="7402"/> 7402:                                    {ok, State1};
<a name="7403"/> 7403:                                {error, _} = ERROR -&gt;
<a name="7404"/> 7404:                                    ERROR
<a name="7405"/> 7405:                            end
<a name="7406"/> 7406:                    end},
<a name="7407"/> 7407: 
<a name="7408"/> 7408: 
<a name="7409"/> 7409:          %% *** We are done ***
<a name="7410"/> 7410:          ?SEV_FINISH_NORMAL
<a name="7411"/> 7411:         ],
<a name="7412"/> 7412: 
<a name="7413"/> 7413:     i(&quot;start server evaluator&quot;),
<a name="7414"/> 7414:     ServerInitState = InitState,
<a name="7415"/> 7415:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="7416"/> 7416: 
<a name="7417"/> 7417:     i(&quot;start client evaluator(s)&quot;),
<a name="7418"/> 7418:     ClientInitState = InitState,
<a name="7419"/> 7419:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="7420"/> 7420: 
<a name="7421"/> 7421:     i(&quot;start 'tester' evaluator&quot;),
<a name="7422"/> 7422:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="7423"/> 7423:                         client =&gt; Client#ev.pid},
<a name="7424"/> 7424:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="7425"/> 7425: 
<a name="7426"/> 7426:     i(&quot;await evaluator&quot;),
<a name="api_a_send_and_recv_udp-last_expr"/><a name="7427"/> 7427: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="7428"/> 7428: 
<a name="7429"/> 7429: 
<a name="7430"/> 7430: 
<a name="7431"/> 7431: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7432"/> 7432: 
<a name="7433"/> 7433: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="7434"/> 7434: <i>%% on an IPv4 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="7435"/> 7435: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7436"/> 7436: <i>%% select message). Note that we only do this for the recv,</i>
<a name="7437"/> 7437: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="7438"/> 7438: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_tcp4-1"/><a name="7439"/> 7439: <b>api_a_send_and_recv_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="7440"/> 7440:     ?TT(?SECS(10)),
<a name="7441"/> 7441:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_tcp4-last_expr"/><a name="7442"/> 7442: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7443"/> 7443:            fun() -&gt; has_support_ipv4() end,
<a name="7444"/> 7444:            fun() -&gt;
<a name="7445"/> 7445:                    Send = fun(Sock, Data) -&gt;
<a name="7446"/> 7446:                                   socket:send(Sock, Data)
<a name="7447"/> 7447:                           end,
<a name="7448"/> 7448:                    Recv = fun(Sock) -&gt;
<a name="7449"/> 7449:                                   socket:recv(Sock, 0, Nowait)
<a name="7450"/> 7450:                           end,
<a name="7451"/> 7451:                    InitState = #{domain    =&gt; inet,
<a name="7452"/> 7452:                                  proto     =&gt; tcp,
<a name="7453"/> 7453:                                  send      =&gt; Send,
<a name="7454"/> 7454:                                  recv      =&gt; Recv,
<a name="7455"/> 7455:                                  recv_sref =&gt; Nowait},
<a name="7456"/> 7456:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7457"/> 7457:            end).
<a name="7458"/> 7458: 
<a name="7459"/> 7459: 
<a name="7460"/> 7460: 
<a name="7461"/> 7461: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7462"/> 7462: 
<a name="7463"/> 7463: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="7464"/> 7464: <i>%% on an IPv6 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="7465"/> 7465: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7466"/> 7466: <i>%% select message). Note that we only do this for the recv,</i>
<a name="7467"/> 7467: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="7468"/> 7468: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_tcp6-1"/><a name="7469"/> 7469: <b>api_a_send_and_recv_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="7470"/> 7470:     ?TT(?SECS(10)),
<a name="7471"/> 7471:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_tcp6-last_expr"/><a name="7472"/> 7472: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7473"/> 7473:            fun() -&gt; has_support_ipv6() end,
<a name="7474"/> 7474:            fun() -&gt;
<a name="7475"/> 7475:                    Send = fun(Sock, Data) -&gt;
<a name="7476"/> 7476:                                   socket:send(Sock, Data)
<a name="7477"/> 7477:                           end,
<a name="7478"/> 7478:                    Recv = fun(Sock) -&gt;
<a name="7479"/> 7479:                                   socket:recv(Sock, 0, Nowait)
<a name="7480"/> 7480:                           end,
<a name="7481"/> 7481:                    InitState = #{domain    =&gt; inet6,
<a name="7482"/> 7482:                                  proto     =&gt; tcp,
<a name="7483"/> 7483:                                  send      =&gt; Send,
<a name="7484"/> 7484:                                  recv      =&gt; Recv,
<a name="7485"/> 7485:                                  recv_sref =&gt; Nowait},
<a name="7486"/> 7486:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7487"/> 7487:            end).
<a name="7488"/> 7488: 
<a name="7489"/> 7489: 
<a name="7490"/> 7490: 
<a name="7491"/> 7491: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7492"/> 7492: 
<a name="7493"/> 7493: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="7494"/> 7494: <i>%% on an IPv4 SCTP (stream) socket. But we try to be async. That is, we use</i>
<a name="7495"/> 7495: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7496"/> 7496: <i>%% select message). Note that we only do this for the recv,</i>
<a name="7497"/> 7497: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="7498"/> 7498: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_sctp4-1"/><a name="7499"/> 7499: <b>api_a_send_and_recv_sctp4</b>(Config) when is_list(Config) -&gt;
<a name="7500"/> 7500:     ?TT(?SECS(10)),
<a name="7501"/> 7501:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_sctp4-last_expr"/><a name="7502"/> 7502: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7503"/> 7503:            fun() -&gt;
<a name="7504"/> 7504:                    has_support_sctp(),
<a name="7505"/> 7505:                    has_support_ipv4()
<a name="7506"/> 7506:            end,
<a name="7507"/> 7507:            fun() -&gt;
<a name="7508"/> 7508:                    Send = fun(Sock, Data) -&gt;
<a name="7509"/> 7509:                                   socket:send(Sock, Data)
<a name="7510"/> 7510:                           end,
<a name="7511"/> 7511:                    Recv = fun(Sock) -&gt;
<a name="7512"/> 7512:                                   socket:recv(Sock, 0, Nowait)
<a name="7513"/> 7513:                           end,
<a name="7514"/> 7514:                    InitState = #{domain    =&gt; inet,
<a name="7515"/> 7515:                                  proto     =&gt; sctp,
<a name="7516"/> 7516:                                  send      =&gt; Send,
<a name="7517"/> 7517:                                  recv      =&gt; Recv,
<a name="7518"/> 7518:                                  recv_sref =&gt; Nowait},
<a name="7519"/> 7519:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7520"/> 7520:            end).
<a name="7521"/> 7521: 
<a name="7522"/> 7522: 
<a name="7523"/> 7523: 
<a name="7524"/> 7524: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7525"/> 7525: 
<a name="7526"/> 7526: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="7527"/> 7527: <i>%% on an IPv4 SCTP (stream) socket. But we try to be async. That is, we use</i>
<a name="7528"/> 7528: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7529"/> 7529: <i>%% select message). Note that we only do this for the recv,</i>
<a name="7530"/> 7530: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="7531"/> 7531: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_sctp6-1"/><a name="7532"/> 7532: <b>api_a_send_and_recv_sctp6</b>(Config) when is_list(Config) -&gt;
<a name="7533"/> 7533:     ?TT(?SECS(10)),
<a name="7534"/> 7534:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_sctp6-last_expr"/><a name="7535"/> 7535: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7536"/> 7536:            fun() -&gt;
<a name="7537"/> 7537:                    has_support_sctp(),
<a name="7538"/> 7538:                    has_support_ipv6()
<a name="7539"/> 7539:            end,
<a name="7540"/> 7540:            fun() -&gt;
<a name="7541"/> 7541:                    Send = fun(Sock, Data) -&gt;
<a name="7542"/> 7542:                                   socket:send(Sock, Data)
<a name="7543"/> 7543:                           end,
<a name="7544"/> 7544:                    Recv = fun(Sock) -&gt;
<a name="7545"/> 7545:                                   socket:recv(Sock, 0, Nowait)
<a name="7546"/> 7546:                           end,
<a name="7547"/> 7547:                    InitState = #{domain    =&gt; inet6,
<a name="7548"/> 7548:                                  proto     =&gt; sctp,
<a name="7549"/> 7549:                                  send      =&gt; Send,
<a name="7550"/> 7550:                                  recv      =&gt; Recv,
<a name="7551"/> 7551:                                  recv_sref =&gt; Nowait},
<a name="7552"/> 7552:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7553"/> 7553:            end).
<a name="7554"/> 7554: 
<a name="7555"/> 7555: 
<a name="7556"/> 7556: 
<a name="7557"/> 7557: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7558"/> 7558: 
<a name="7559"/> 7559: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="7560"/> 7560: <i>%% on an IPv4 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="7561"/> 7561: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7562"/> 7562: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="7563"/> 7563: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="7564"/> 7564: <i>%% We *also* test async for accept.</i>
<a name="api_a_sendmsg_and_recvmsg_tcp4-1"/><a name="7565"/> 7565: <b>api_a_sendmsg_and_recvmsg_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="7566"/> 7566:     ?TT(?SECS(10)),
<a name="7567"/> 7567:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="7568"/> 7568: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7569"/> 7569:            fun() -&gt;
<a name="7570"/> 7570:                    is_not_windows(),
<a name="7571"/> 7571:                    has_support_ipv4()
<a name="7572"/> 7572:            end,
<a name="7573"/> 7573:            fun() -&gt;
<a name="7574"/> 7574:                    Send = fun(Sock, Data) -&gt;
<a name="7575"/> 7575:                                   Msg = #{iov =&gt; [Data]},
<a name="7576"/> 7576:                                   socket:sendmsg(Sock, Msg)
<a name="7577"/> 7577:                           end,
<a name="7578"/> 7578:                    Recv = fun(Sock) -&gt;
<a name="7579"/> 7579:                                   case socket:recvmsg(Sock, Nowait) of
<a name="7580"/> 7580:                                       {ok, #{iov := [Data]}} -&gt;
<a name="7581"/> 7581:                                           {ok, Data};
<a name="7582"/> 7582:                                       {select, _} = SELECT -&gt;
<a name="7583"/> 7583:                                           SELECT;
<a name="7584"/> 7584: 				      {error, _} = ERROR -&gt;
<a name="7585"/> 7585:                                           ERROR
<a name="7586"/> 7586:                                   end
<a name="7587"/> 7587:                           end,
<a name="7588"/> 7588:                    InitState = #{domain    =&gt; inet,
<a name="7589"/> 7589:                                  proto     =&gt; tcp,
<a name="7590"/> 7590:                                  send      =&gt; Send,
<a name="7591"/> 7591:                                  recv      =&gt; Recv,
<a name="7592"/> 7592:                                  recv_sref =&gt; Nowait},
<a name="7593"/> 7593:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7594"/> 7594:            end).
<a name="7595"/> 7595: 
<a name="7596"/> 7596: 
<a name="7597"/> 7597: 
<a name="7598"/> 7598: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7599"/> 7599: 
<a name="7600"/> 7600: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="7601"/> 7601: <i>%% on an IPv6 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="7602"/> 7602: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7603"/> 7603: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="7604"/> 7604: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="7605"/> 7605: <i>%% We *also* test async for accept.</i>
<a name="api_a_sendmsg_and_recvmsg_tcp6-1"/><a name="7606"/> 7606: <b>api_a_sendmsg_and_recvmsg_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="7607"/> 7607:     ?TT(?SECS(10)),
<a name="7608"/> 7608:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_tcp6-last_expr"/><a name="7609"/> 7609: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7610"/> 7610:            fun() -&gt; has_support_ipv6() end,
<a name="7611"/> 7611:            fun() -&gt;
<a name="7612"/> 7612:                    Send = fun(Sock, Data) -&gt;
<a name="7613"/> 7613:                                   Msg = #{iov =&gt; [Data]},
<a name="7614"/> 7614:                                   socket:sendmsg(Sock, Msg)
<a name="7615"/> 7615:                           end,
<a name="7616"/> 7616:                    Recv = fun(Sock) -&gt;
<a name="7617"/> 7617:                                   case socket:recvmsg(Sock, Nowait) of
<a name="7618"/> 7618:                                       {ok, #{iov := [Data]}} -&gt;
<a name="7619"/> 7619:                                           {ok, Data};
<a name="7620"/> 7620:                                       {select, _} = SELECT -&gt;
<a name="7621"/> 7621:                                           SELECT;
<a name="7622"/> 7622: 				      {error, _} = ERROR -&gt;
<a name="7623"/> 7623:                                           ERROR
<a name="7624"/> 7624:                                   end
<a name="7625"/> 7625:                           end,
<a name="7626"/> 7626:                    InitState = #{domain    =&gt; inet6,
<a name="7627"/> 7627:                                  proto     =&gt; tcp,
<a name="7628"/> 7628:                                  send      =&gt; Send,
<a name="7629"/> 7629:                                  recv      =&gt; Recv,
<a name="7630"/> 7630:                                  recv_sref =&gt; Nowait},
<a name="7631"/> 7631:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7632"/> 7632:            end).
<a name="7633"/> 7633: 
<a name="7634"/> 7634: 
<a name="7635"/> 7635: 
<a name="7636"/> 7636: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7637"/> 7637: 
<a name="api_a_send_and_recv_stream-2"/><a name="7638"/> 7638: <b>api_a_send_and_recv_stream</b>(Config, InitState) -&gt;
<a name="7639"/> 7639:     process_flag(trap_exit, true),
<a name="7640"/> 7640:     ServerSeq = 
<a name="7641"/> 7641:         [
<a name="7642"/> 7642:          %% *** Wait for start order ***
<a name="7643"/> 7643:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="7644"/> 7644:            cmd  =&gt; fun(State) -&gt;
<a name="7645"/> 7645:                            Tester = ?SEV_AWAIT_START(),
<a name="7646"/> 7646:                            {ok, State#{tester =&gt; Tester}}
<a name="7647"/> 7647:                    end},
<a name="7648"/> 7648:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7649"/> 7649:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7650"/> 7650:                            _MRef = erlang:monitor(process, Tester),
<a name="7651"/> 7651:                            ok
<a name="7652"/> 7652:                    end},
<a name="7653"/> 7653: 
<a name="7654"/> 7654:          %% *** Init part ***
<a name="7655"/> 7655:          #{desc =&gt; &quot;which local address&quot;,
<a name="7656"/> 7656:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7657"/> 7657:                            LSA = which_local_socket_addr(Domain),
<a name="7658"/> 7658:                            {ok, State#{lsa =&gt; LSA}}
<a name="7659"/> 7659:                    end},
<a name="7660"/> 7660:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="7661"/> 7661:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="7662"/> 7662:                            ?SEV_IPRINT(&quot;try create (open) ~w (~w) socket&quot;,
<a name="7663"/> 7663:                                        [Proto, Domain]),
<a name="7664"/> 7664:                            case socket:open(Domain, stream, Proto) of
<a name="7665"/> 7665:                                {ok, Sock} -&gt;
<a name="7666"/> 7666:                                    {ok, State#{lsock =&gt; Sock}};
<a name="7667"/> 7667:                                {error, eprotonosupport = Reason} -&gt;
<a name="7668"/> 7668:                                    {skip, Reason};
<a name="7669"/> 7669:                                {error, _} = ERROR -&gt;
<a name="7670"/> 7670:                                    ERROR
<a name="7671"/> 7671:                            end
<a name="7672"/> 7672:                    end},
<a name="7673"/> 7673:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="7674"/> 7674:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="7675"/> 7675:                            case sock_bind(LSock, LSA) of
<a name="7676"/> 7676:                                ok -&gt;
<a name="7677"/> 7677:                                    Port = sock_port(LSock),
<a name="7678"/> 7678:                                    {ok, State#{lport =&gt; Port}};
<a name="7679"/> 7679:                                {error, _} = ERROR -&gt;
<a name="7680"/> 7680:                                    ERROR
<a name="7681"/> 7681:                            end
<a name="7682"/> 7682:                    end},
<a name="7683"/> 7683:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="7684"/> 7684:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="7685"/> 7685:                            socket:listen(LSock)
<a name="7686"/> 7686:                    end},
<a name="7687"/> 7687:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7688"/> 7688:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="7689"/> 7689:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="7690"/> 7690:                            ok
<a name="7691"/> 7691:                    end},
<a name="7692"/> 7692: 
<a name="7693"/> 7693:          %% The actual test
<a name="7694"/> 7694:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="7695"/> 7695:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7696"/> 7696:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="7697"/> 7697:                    end},
<a name="7698"/> 7698:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="7699"/> 7699:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="7700"/> 7700:                            Nowait = nowait(Config),
<a name="7701"/> 7701:                            case socket:accept(LSock, Nowait) of
<a name="7702"/> 7702:                                {select, {select_info, Tag, Ref}}
<a name="7703"/> 7703:                                  when Nowait =:= nowait -&gt;
<a name="7704"/> 7704:                                    ?SEV_IPRINT(&quot;select accept message: &quot;
<a name="7705"/> 7705:                                                &quot;~n   Tag: ~p&quot;
<a name="7706"/> 7706:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7707"/> 7707:                                    {ok, State#{sorc        =&gt; select,
<a name="7708"/> 7708:                                                accept_stag =&gt; Tag,
<a name="7709"/> 7709:                                                accept_sref =&gt; Ref}};
<a name="7710"/> 7710:                                {select, {select_info, Tag, Nowait}}
<a name="7711"/> 7711:                                  when is_reference(Nowait) -&gt;
<a name="7712"/> 7712:                                    ?SEV_IPRINT(&quot;select accept result: &quot;
<a name="7713"/> 7713:                                                &quot;~n   Tag: ~p&quot;
<a name="7714"/> 7714:                                                &quot;~n   Ref: ~p&quot;, [Tag, Nowait]),
<a name="7715"/> 7715:                                    {ok, State#{sorc        =&gt; select,
<a name="7716"/> 7716:                                                accept_stag =&gt; Tag,
<a name="7717"/> 7717:                                                accept_sref =&gt; Nowait}};
<a name="7718"/> 7718: 
<a name="7719"/> 7719:                                {completion, {completion_info, Tag, Ref}}
<a name="7720"/> 7720:                                  when Nowait =:= nowait -&gt;
<a name="7721"/> 7721:                                    ?SEV_IPRINT(&quot;completion accept result: &quot;
<a name="7722"/> 7722:                                                &quot;~n   Tag: ~p&quot;
<a name="7723"/> 7723:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7724"/> 7724:                                    {ok, State#{sorc        =&gt; completion,
<a name="7725"/> 7725:                                                accept_stag =&gt; Tag,
<a name="7726"/> 7726:                                                accept_sref =&gt; Ref}};
<a name="7727"/> 7727:                                {completion, {completion_info, Tag, Nowait}}
<a name="7728"/> 7728:                                  when is_reference(Nowait) -&gt;
<a name="7729"/> 7729:                                    ?SEV_IPRINT(&quot;completion accept result: &quot;
<a name="7730"/> 7730:                                                &quot;~n   Tag: ~p&quot;
<a name="7731"/> 7731:                                                &quot;~n   Ref: ~p&quot;, [Tag, Nowait]),
<a name="7732"/> 7732:                                    {ok, State#{sorc        =&gt; completion,
<a name="7733"/> 7733:                                                accept_stag =&gt; Tag,
<a name="7734"/> 7734:                                                accept_sref =&gt; Nowait}};
<a name="7735"/> 7735: 
<a name="7736"/> 7736:                                {ok, X} -&gt;
<a name="7737"/> 7737:                                    {error, {unexpected_success, X}};
<a name="7738"/> 7738:                                {error, _} = ERROR -&gt;
<a name="7739"/> 7739:                                    ERROR
<a name="7740"/> 7740:                            end
<a name="7741"/> 7741:                    end},
<a name="7742"/> 7742:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="7743"/> 7743:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7744"/> 7744:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="7745"/> 7745:                            ok
<a name="7746"/> 7746:                    end},
<a name="7747"/> 7747:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="7748"/> 7748:            cmd  =&gt; fun(#{lsock := Sock, accept_sref := Ref} = State) -&gt;
<a name="7749"/> 7749:                            receive
<a name="7750"/> 7750:                                {'$socket', Sock, select, Ref} -&gt;
<a name="7751"/> 7751:                                    ?SEV_IPRINT(&quot;select message: &quot;
<a name="7752"/> 7752:                                                &quot;ready for accept&quot;),
<a name="7753"/> 7753:                                    ok;
<a name="7754"/> 7754:                                {'$socket', Sock, completion,
<a name="7755"/> 7755:                                 {Ref, {ok, CSock}}} -&gt;
<a name="7756"/> 7756:                                    ?SEV_IPRINT(&quot;completion message: accepted: &quot;
<a name="7757"/> 7757:                                                &quot;~n   CSock: ~p&quot;, [Sock]),
<a name="7758"/> 7758:                                    {ok, State#{csock =&gt; CSock}}
<a name="7759"/> 7759:                            after 5000 -&gt;
<a name="7760"/> 7760:                                    ?SEV_EPRINT(&quot;select|completion message timeout:&quot;
<a name="7761"/> 7761:                                                &quot;~n   Sock:          ~p&quot;
<a name="7762"/> 7762:                                                &quot;~n   Ref:           ~p&quot;
<a name="7763"/> 7763:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="7764"/> 7764:                                                [Sock, Ref, ?MQ()]),
<a name="7765"/> 7765:                                    {error, timeout}
<a name="7766"/> 7766:                            end
<a name="7767"/> 7767:                    end},
<a name="7768"/> 7768:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="7769"/> 7769:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7770"/> 7770:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7771"/> 7771:                            ok
<a name="7772"/> 7772:                    end},
<a name="7773"/> 7773:          #{desc =&gt; &quot;try accept (again)&quot;,
<a name="7774"/> 7774:            cmd  =&gt; fun(#{lsock := LSock, sorc := select} = State) -&gt;
<a name="7775"/> 7775:                            ?SEV_IPRINT(&quot;try accept again&quot;),
<a name="7776"/> 7776:                            case socket:accept(LSock, nowait) of
<a name="7777"/> 7777:                                {ok, Sock} -&gt;
<a name="7778"/> 7778:                                    ?SEV_IPRINT(&quot;accepted: &quot;
<a name="7779"/> 7779:                                                &quot;~n   Sock: ~p&quot;, [Sock]),
<a name="7780"/> 7780:                                    {ok, State#{csock =&gt; Sock}};
<a name="7781"/> 7781:                                {error, _} = ERROR -&gt;
<a name="7782"/> 7782:                                    ERROR
<a name="7783"/> 7783:                            end;
<a name="7784"/> 7784:                        (#{sorc := completion})-&gt;
<a name="7785"/> 7785:                            ?SEV_IPRINT(&quot;already accepted&quot;),
<a name="7786"/> 7786:                            ok
<a name="7787"/> 7787:                    end},
<a name="7788"/> 7788:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="7789"/> 7789:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7790"/> 7790:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="7791"/> 7791:                            ok
<a name="7792"/> 7792:                    end},
<a name="7793"/> 7793: 
<a name="7794"/> 7794:          #{desc =&gt; &quot;await continue (recv request)&quot;,
<a name="7795"/> 7795:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7796"/> 7796:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_req)
<a name="7797"/> 7797:                    end},
<a name="7798"/> 7798:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="7799"/> 7799:            cmd  =&gt; fun(#{csock     := Sock,
<a name="7800"/> 7800:                          recv      := Recv,
<a name="7801"/> 7801:                          recv_sref := SR} = State) -&gt;
<a name="7802"/> 7802:                            case Recv(Sock) of
<a name="7803"/> 7803:                                {select, {select_info, Tag, Ref}}
<a name="7804"/> 7804:                                  when SR =:= nowait -&gt;
<a name="7805"/> 7805:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="7806"/> 7806:                                                &quot;~n   Tag: ~p&quot;
<a name="7807"/> 7807:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7808"/> 7808:                                    {ok, State#{recv_stag =&gt; Tag,
<a name="7809"/> 7809:                                                recv_sref =&gt; Ref}};
<a name="7810"/> 7810:                                {select, {select_info, Tag, SR}}
<a name="7811"/> 7811:                                  when is_reference(SR) -&gt;
<a name="7812"/> 7812:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="7813"/> 7813:                                                &quot;~n   Tag: ~p&quot;
<a name="7814"/> 7814:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="7815"/> 7815:                                    {ok, State#{recv_stag =&gt; Tag}};
<a name="7816"/> 7816: 
<a name="7817"/> 7817:                                {completion, {completion_info, Tag, Ref}}
<a name="7818"/> 7818:                                  when SR =:= nowait -&gt;
<a name="7819"/> 7819:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="7820"/> 7820:                                                &quot;~n   Tag: ~p&quot;
<a name="7821"/> 7821:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7822"/> 7822:                                    {ok, State#{recv_stag =&gt; Tag,
<a name="7823"/> 7823:                                                recv_sref =&gt; Ref}};
<a name="7824"/> 7824:                                {completion, {completion_info, Tag, SR}}
<a name="7825"/> 7825:                                  when is_reference(SR) -&gt;
<a name="7826"/> 7826:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="7827"/> 7827:                                                &quot;~n   Tag: ~p&quot;
<a name="7828"/> 7828:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="7829"/> 7829:                                    {ok, State#{recv_stag =&gt; Tag}};
<a name="7830"/> 7830: 
<a name="7831"/> 7831:                                {ok, X} -&gt;
<a name="7832"/> 7832:                                    {error, {unexpected_success, X}};
<a name="7833"/> 7833:                                {error, _} = ERROR -&gt;
<a name="7834"/> 7834:                                    ERROR
<a name="7835"/> 7835:                            end
<a name="7836"/> 7836:                    end},
<a name="7837"/> 7837:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="7838"/> 7838:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7839"/> 7839:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="7840"/> 7840:                            ok
<a name="7841"/> 7841:                    end},
<a name="7842"/> 7842:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="7843"/> 7843:            cmd  =&gt; fun(#{csock := Sock, recv_sref := RecvRef}) -&gt;
<a name="7844"/> 7844:                            receive
<a name="7845"/> 7845:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="7846"/> 7846:                                    ok;
<a name="7847"/> 7847:                                {'$socket', Sock, completion,
<a name="7848"/> 7848:                                 {RecvRef, {ok, ?BASIC_REQ}}} -&gt;
<a name="7849"/> 7849:                                    ?SEV_IPRINT(&quot;received expected data&quot;),
<a name="7850"/> 7850:                                    ok;
<a name="7851"/> 7851:                                {'$socket', Sock, completion,
<a name="7852"/> 7852:                                 {RecvRef, {error, Reason} = ERROR}} -&gt;
<a name="7853"/> 7853:                                    ?SEV_EPRINT(&quot;received unexpected error: &quot;
<a name="7854"/> 7854:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="7855"/> 7855:                                    ERROR
<a name="7856"/> 7856:                            end
<a name="7857"/> 7857:                    end},
<a name="7858"/> 7858:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="7859"/> 7859:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7860"/> 7860:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7861"/> 7861:                            ok
<a name="7862"/> 7862:                    end},
<a name="7863"/> 7863:          #{desc =&gt; &quot;now read the data (request)&quot;,
<a name="7864"/> 7864:            cmd  =&gt; fun(#{sorc  := select,
<a name="7865"/> 7865:                          csock := Sock,
<a name="7866"/> 7866:                          recv  := Recv} = _State) -&gt;
<a name="7867"/> 7867:                            case Recv(Sock) of
<a name="7868"/> 7868:                                {ok, ?BASIC_REQ} -&gt;
<a name="7869"/> 7869:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="7870"/> 7870:                                    ok;
<a name="7871"/> 7871:                                {error, _} = ERROR -&gt;
<a name="7872"/> 7872:                                    ERROR
<a name="7873"/> 7873:                            end;
<a name="7874"/> 7874:                       (#{sorc := completion}) -&gt;
<a name="7875"/> 7875:                            ?SEV_IPRINT(&quot;already received&quot;),
<a name="7876"/> 7876:                            ok
<a name="7877"/> 7877:                    end},
<a name="7878"/> 7878:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="7879"/> 7879:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7880"/> 7880:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="7881"/> 7881:                            ok
<a name="7882"/> 7882:                    end},
<a name="7883"/> 7883: 
<a name="7884"/> 7884:          #{desc =&gt; &quot;await continue (send reply)&quot;,
<a name="7885"/> 7885:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7886"/> 7886:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_rep)
<a name="7887"/> 7887:                    end},
<a name="7888"/> 7888:          #{desc =&gt; &quot;send reply&quot;,
<a name="7889"/> 7889:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="7890"/> 7890:                            Send(Sock, ?BASIC_REP)
<a name="7891"/> 7891:                    end},
<a name="7892"/> 7892:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="7893"/> 7893:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7894"/> 7894:                            ?SEV_ANNOUNCE_READY(Tester, send_rep),
<a name="7895"/> 7895:                            ok
<a name="7896"/> 7896:                    end},
<a name="7897"/> 7897: 
<a name="7898"/> 7898:          %% *** Termination ***
<a name="7899"/> 7899:          #{desc =&gt; &quot;await terminate&quot;,
<a name="7900"/> 7900:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="7901"/> 7901:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="7902"/> 7902:                                ok -&gt;
<a name="7903"/> 7903:                                    {ok, maps:remove(tester, State)};
<a name="7904"/> 7904:                                {error, _} = ERROR -&gt;
<a name="7905"/> 7905:                                    ERROR
<a name="7906"/> 7906:                            end
<a name="7907"/> 7907:                    end},
<a name="7908"/> 7908:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="7909"/> 7909:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="7910"/> 7910:                            socket:close(Sock)
<a name="7911"/> 7911:                    end},
<a name="7912"/> 7912:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="7913"/> 7913:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="7914"/> 7914:                            socket:close(Sock)
<a name="7915"/> 7915:                    end},
<a name="7916"/> 7916: 
<a name="7917"/> 7917:          %% *** We are done ***
<a name="7918"/> 7918:          ?SEV_FINISH_NORMAL
<a name="7919"/> 7919:         ],
<a name="7920"/> 7920: 
<a name="7921"/> 7921: 
<a name="7922"/> 7922:     ClientSeq = 
<a name="7923"/> 7923:         [
<a name="7924"/> 7924:          %% *** Wait for start order ***
<a name="7925"/> 7925:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="7926"/> 7926:            cmd  =&gt; fun(State) -&gt;
<a name="7927"/> 7927:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="7928"/> 7928:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="7929"/> 7929:                    end},
<a name="7930"/> 7930:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7931"/> 7931:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7932"/> 7932:                            _MRef = erlang:monitor(process, Tester),
<a name="7933"/> 7933:                            ok
<a name="7934"/> 7934:                    end},
<a name="7935"/> 7935: 
<a name="7936"/> 7936:          %% *** The init part ***
<a name="7937"/> 7937:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="7938"/> 7938:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="7939"/> 7939:                            LSA = which_local_socket_addr(Domain),
<a name="7940"/> 7940:                            SSA = LSA#{port =&gt; Port},
<a name="7941"/> 7941:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="7942"/> 7942:                    end},
<a name="7943"/> 7943:          #{desc =&gt; &quot;create socket&quot;,
<a name="7944"/> 7944:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="7945"/> 7945:                            ?SEV_IPRINT(&quot;try create (open) ~w (~w) socket&quot;,
<a name="7946"/> 7946:                                        [Proto, Domain]),
<a name="7947"/> 7947:                            case socket:open(Domain, stream, Proto) of
<a name="7948"/> 7948:                                {ok, Sock} -&gt;
<a name="7949"/> 7949:                                    {ok, State#{sock =&gt; Sock}};
<a name="7950"/> 7950:                                {error, _} = ERROR -&gt;
<a name="7951"/> 7951:                                    ERROR
<a name="7952"/> 7952:                            end
<a name="7953"/> 7953:                    end},
<a name="7954"/> 7954:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="7955"/> 7955:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="7956"/> 7956:                            case sock_bind(Sock, LSA) of
<a name="7957"/> 7957:                                ok -&gt;
<a name="7958"/> 7958:                                    ok;
<a name="7959"/> 7959:                                {error, _} = ERROR -&gt;
<a name="7960"/> 7960:                                    ERROR
<a name="7961"/> 7961:                            end
<a name="7962"/> 7962:                    end},
<a name="7963"/> 7963:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7964"/> 7964:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7965"/> 7965:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="7966"/> 7966:                            ok
<a name="7967"/> 7967:                    end},
<a name="7968"/> 7968: 
<a name="7969"/> 7969:          %% *** The actual test ***
<a name="7970"/> 7970:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="7971"/> 7971:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7972"/> 7972:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="7973"/> 7973:                    end},
<a name="7974"/> 7974:          #{desc =&gt; &quot;connect to server&quot;,
<a name="7975"/> 7975:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="7976"/> 7976:                            socket:connect(Sock, SSA)
<a name="7977"/> 7977:                    end},
<a name="7978"/> 7978:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="7979"/> 7979:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7980"/> 7980:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="7981"/> 7981:                            ok
<a name="7982"/> 7982:                    end},
<a name="7983"/> 7983: 
<a name="7984"/> 7984:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="7985"/> 7985:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7986"/> 7986:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="7987"/> 7987:                    end},
<a name="7988"/> 7988:          #{desc =&gt; &quot;send request (to server)&quot;,
<a name="7989"/> 7989:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="7990"/> 7990:                            ok = Send(Sock, ?BASIC_REQ)
<a name="7991"/> 7991:                    end},
<a name="7992"/> 7992:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="7993"/> 7993:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7994"/> 7994:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="7995"/> 7995:                            ok
<a name="7996"/> 7996:                    end},
<a name="7997"/> 7997: 
<a name="7998"/> 7998:          #{desc =&gt; &quot;try recv reply (with nowait, expect select|completion)&quot;,
<a name="7999"/> 7999:            cmd  =&gt; fun(#{sock := Sock,
<a name="8000"/> 8000:                          recv := Recv,
<a name="8001"/> 8001:                          recv_sref := SR} = State) -&gt;
<a name="8002"/> 8002:                            case Recv(Sock) of
<a name="8003"/> 8003:                                {select, {select_info, Tag, Ref}}
<a name="8004"/> 8004:                                  when SR =:= nowait -&gt;
<a name="8005"/> 8005:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="8006"/> 8006:                                                &quot;~n   Tag: ~p&quot;
<a name="8007"/> 8007:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8008"/> 8008:                                    {ok, State#{sorc      =&gt; select,
<a name="8009"/> 8009:                                                recv_stag =&gt; Tag,
<a name="8010"/> 8010:                                                recv_sref =&gt; Ref}};
<a name="8011"/> 8011:                                {select, {select_info, Tag, SR}}
<a name="8012"/> 8012:                                  when is_reference(SR) -&gt;
<a name="8013"/> 8013:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="8014"/> 8014:                                                &quot;~n   Tag: ~p&quot;
<a name="8015"/> 8015:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="8016"/> 8016:                                    {ok, State#{sorc      =&gt; select,
<a name="8017"/> 8017:                                                recv_stag =&gt; Tag}};
<a name="8018"/> 8018: 
<a name="8019"/> 8019:                                {completion, {completion_info, Tag, Ref}}
<a name="8020"/> 8020:                                  when SR =:= nowait -&gt;
<a name="8021"/> 8021:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="8022"/> 8022:                                                &quot;~n   Tag: ~p&quot;
<a name="8023"/> 8023:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8024"/> 8024:                                    {ok, State#{sorc      =&gt; completion,
<a name="8025"/> 8025:                                                recv_stag =&gt; Tag,
<a name="8026"/> 8026:                                                recv_sref =&gt; Ref}};
<a name="8027"/> 8027:                                {completion, {completion_info, Tag, SR}}
<a name="8028"/> 8028:                                  when is_reference(SR) -&gt;
<a name="8029"/> 8029:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="8030"/> 8030:                                                &quot;~n   Tag: ~p&quot;
<a name="8031"/> 8031:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="8032"/> 8032:                                    {ok, State#{sorc      =&gt; completion,
<a name="8033"/> 8033:                                                recv_stag =&gt; Tag}};
<a name="8034"/> 8034: 
<a name="8035"/> 8035:                                {ok, X} -&gt;
<a name="8036"/> 8036:                                    {error, {unexpected_success, X}};
<a name="8037"/> 8037:                                {error, _} = ERROR -&gt;
<a name="8038"/> 8038:                                    ERROR
<a name="8039"/> 8039:                            end
<a name="8040"/> 8040:                    end},
<a name="8041"/> 8041:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="8042"/> 8042:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8043"/> 8043:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="8044"/> 8044:                            ok
<a name="8045"/> 8045:                    end},
<a name="8046"/> 8046:          #{desc =&gt; &quot;await select message&quot;,
<a name="8047"/> 8047:            cmd  =&gt; fun(#{sock := Sock, recv_sref := RecvRef}) -&gt;
<a name="8048"/> 8048:                            receive
<a name="8049"/> 8049:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="8050"/> 8050:                                    ok;
<a name="8051"/> 8051:                                {'$socket', Sock, completion,
<a name="8052"/> 8052:                                 {RecvRef, {ok, ?BASIC_REP}}} -&gt;
<a name="8053"/> 8053:                                    ?SEV_IPRINT(&quot;received expected reply&quot;),
<a name="8054"/> 8054:                                    ok
<a name="8055"/> 8055:                            end
<a name="8056"/> 8056:                    end},
<a name="8057"/> 8057:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="8058"/> 8058:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8059"/> 8059:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="8060"/> 8060:                            ok
<a name="8061"/> 8061:                    end},
<a name="8062"/> 8062:          #{desc =&gt; &quot;now read the data (reply)&quot;,
<a name="8063"/> 8063:            cmd  =&gt; fun(#{sorc := select, sock := Sock, recv := Recv}) -&gt;
<a name="8064"/> 8064:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="8065"/> 8065:                            ?SEV_IPRINT(&quot;[select] received expected reply&quot;),
<a name="8066"/> 8066:                            ok;
<a name="8067"/> 8067:                       (#{sorc := completion}) -&gt;
<a name="8068"/> 8068:                            ?SEV_IPRINT(&quot;[completion] &quot;
<a name="8069"/> 8069:                                        &quot;expected reply already received&quot;),
<a name="8070"/> 8070:                            ok
<a name="8071"/> 8071:                    end},
<a name="8072"/> 8072:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="8073"/> 8073:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8074"/> 8074:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="8075"/> 8075:                            ok
<a name="8076"/> 8076:                    end},
<a name="8077"/> 8077: 
<a name="8078"/> 8078:          %% *** Termination ***
<a name="8079"/> 8079:          #{desc =&gt; &quot;await terminate&quot;,
<a name="8080"/> 8080:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8081"/> 8081:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8082"/> 8082:                                ok -&gt;
<a name="8083"/> 8083:                                    {ok, maps:remove(tester, State)};
<a name="8084"/> 8084:                                {error, _} = ERROR -&gt;
<a name="8085"/> 8085:                                    ERROR
<a name="8086"/> 8086:                            end
<a name="8087"/> 8087:                    end},
<a name="8088"/> 8088:          #{desc =&gt; &quot;close socket&quot;,
<a name="8089"/> 8089:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="8090"/> 8090:                            socket:close(Sock)
<a name="8091"/> 8091:                    end},
<a name="8092"/> 8092: 
<a name="8093"/> 8093:          %% *** We are done ***
<a name="8094"/> 8094:          ?SEV_FINISH_NORMAL
<a name="8095"/> 8095:         ],
<a name="8096"/> 8096: 
<a name="8097"/> 8097:     TesterSeq =
<a name="8098"/> 8098:         [
<a name="8099"/> 8099:          %% *** Init part ***
<a name="8100"/> 8100:          #{desc =&gt; &quot;monitor server&quot;,
<a name="8101"/> 8101:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8102"/> 8102:                            _MRef = erlang:monitor(process, Pid),
<a name="8103"/> 8103:                            ok
<a name="8104"/> 8104:                    end},
<a name="8105"/> 8105:          #{desc =&gt; &quot;monitor client&quot;,
<a name="8106"/> 8106:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8107"/> 8107:                            _MRef = erlang:monitor(process, Pid),
<a name="8108"/> 8108:                            ok
<a name="8109"/> 8109:                    end},
<a name="8110"/> 8110: 
<a name="8111"/> 8111:          %% Start the server
<a name="8112"/> 8112:          #{desc =&gt; &quot;order server start&quot;,
<a name="8113"/> 8113:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8114"/> 8114:                            ?SEV_ANNOUNCE_START(Pid),
<a name="8115"/> 8115:                            ok
<a name="8116"/> 8116:                    end},
<a name="8117"/> 8117:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="8118"/> 8118:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8119"/> 8119:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="8120"/> 8120:                            {ok, State#{server_port =&gt; Port}}
<a name="8121"/> 8121:                    end},
<a name="8122"/> 8122: 
<a name="8123"/> 8123:          %% Start the client
<a name="8124"/> 8124:          #{desc =&gt; &quot;order client start&quot;,
<a name="8125"/> 8125:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="8126"/> 8126:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="8127"/> 8127:                            ok
<a name="8128"/> 8128:                    end},
<a name="8129"/> 8129:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="8130"/> 8130:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8131"/> 8131:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="8132"/> 8132:                    end},
<a name="8133"/> 8133: 
<a name="8134"/> 8134:          %% *** The actual test ***
<a name="8135"/> 8135:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="8136"/> 8136:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="8137"/> 8137:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="8138"/> 8138:                            ok
<a name="8139"/> 8139:                    end},
<a name="8140"/> 8140:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="8141"/> 8141:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8142"/> 8142:                            ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="8143"/> 8143:                    end},
<a name="8144"/> 8144:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="8145"/> 8145:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8146"/> 8146:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="8147"/> 8147:                            ok
<a name="8148"/> 8148:                    end},
<a name="8149"/> 8149:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="8150"/> 8150:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8151"/> 8151:                            ?SEV_AWAIT_READY(Pid, server, select)
<a name="8152"/> 8152:                    end},
<a name="8153"/> 8153:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="8154"/> 8154:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8155"/> 8155:                            ?SEV_AWAIT_READY(Pid, server, accept)
<a name="8156"/> 8156:                    end},
<a name="8157"/> 8157:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="8158"/> 8158:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8159"/> 8159:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="8160"/> 8160:                    end},
<a name="8161"/> 8161: 
<a name="8162"/> 8162:          #{desc =&gt; &quot;order server to continue (recv request)&quot;,
<a name="8163"/> 8163:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8164"/> 8164:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv_req),
<a name="8165"/> 8165:                            ok
<a name="8166"/> 8166:                    end},
<a name="8167"/> 8167:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="8168"/> 8168:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8169"/> 8169:                            ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="8170"/> 8170:                    end},
<a name="8171"/> 8171:          #{desc =&gt; &quot;order client to continue (send request)&quot;,
<a name="8172"/> 8172:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8173"/> 8173:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_req),
<a name="8174"/> 8174:                            ok
<a name="8175"/> 8175:                    end},
<a name="8176"/> 8176:          #{desc =&gt; &quot;await client ready (send request)&quot;,
<a name="8177"/> 8177:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="8178"/> 8178:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="8179"/> 8179:                    end},
<a name="8180"/> 8180:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="8181"/> 8181:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8182"/> 8182:                            ?SEV_AWAIT_READY(Pid, server, select)
<a name="8183"/> 8183:                    end},
<a name="8184"/> 8184:          #{desc =&gt; &quot;await server ready (recv request)&quot;,
<a name="8185"/> 8185:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8186"/> 8186:                            ?SEV_AWAIT_READY(Pid, server, recv_req)
<a name="8187"/> 8187:                    end},
<a name="8188"/> 8188: 
<a name="8189"/> 8189:          #{desc =&gt; &quot;order client to continue (recv reply)&quot;,
<a name="8190"/> 8190:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8191"/> 8191:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv_rep),
<a name="8192"/> 8192:                            ok
<a name="8193"/> 8193:                    end},
<a name="8194"/> 8194:          #{desc =&gt; &quot;await client ready (recv select)&quot;,
<a name="8195"/> 8195:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8196"/> 8196:                            ?SEV_AWAIT_READY(Pid, client, recv_select)
<a name="8197"/> 8197:                    end},
<a name="8198"/> 8198:          #{desc =&gt; &quot;order server to continue (send reply)&quot;,
<a name="8199"/> 8199:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8200"/> 8200:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_rep),
<a name="8201"/> 8201:                            ok
<a name="8202"/> 8202:                    end},
<a name="8203"/> 8203:          #{desc =&gt; &quot;await server ready (send reply)&quot;,
<a name="8204"/> 8204:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8205"/> 8205:                            ?SEV_AWAIT_READY(Pid, server, send_rep)
<a name="8206"/> 8206:                    end},
<a name="8207"/> 8207:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="8208"/> 8208:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8209"/> 8209:                            ?SEV_AWAIT_READY(Pid, client, select)
<a name="8210"/> 8210:                    end},
<a name="8211"/> 8211:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="8212"/> 8212:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="8213"/> 8213:                            ?SEV_AWAIT_READY(Client, client, recv_rep)
<a name="8214"/> 8214:                    end},
<a name="8215"/> 8215: 
<a name="8216"/> 8216: 
<a name="8217"/> 8217:          %% *** Termination ***
<a name="8218"/> 8218:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="8219"/> 8219:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="8220"/> 8220:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="8221"/> 8221:                            ok
<a name="8222"/> 8222:                    end},
<a name="8223"/> 8223:          #{desc =&gt; &quot;await client termination&quot;,
<a name="8224"/> 8224:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="8225"/> 8225:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="8226"/> 8226:                            State1 = maps:remove(client, State),
<a name="8227"/> 8227:                            {ok, State1}
<a name="8228"/> 8228:                    end},
<a name="8229"/> 8229:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="8230"/> 8230:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="8231"/> 8231:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="8232"/> 8232:                            ok
<a name="8233"/> 8233:                    end},
<a name="8234"/> 8234:          #{desc =&gt; &quot;await server termination&quot;,
<a name="8235"/> 8235:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="8236"/> 8236:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="8237"/> 8237:                            State1 = maps:remove(server, State),
<a name="8238"/> 8238:                            {ok, State1}
<a name="8239"/> 8239:                    end},
<a name="8240"/> 8240: 
<a name="8241"/> 8241:          %% *** We are done ***
<a name="8242"/> 8242:          ?SEV_FINISH_NORMAL
<a name="8243"/> 8243:         ],
<a name="8244"/> 8244: 
<a name="8245"/> 8245:     i(&quot;start server evaluator&quot;),
<a name="8246"/> 8246:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="8247"/> 8247: 
<a name="8248"/> 8248:     i(&quot;start client evaluator&quot;),
<a name="8249"/> 8249:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="8250"/> 8250: 
<a name="8251"/> 8251:     i(&quot;start tester evaluator&quot;),
<a name="8252"/> 8252:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="8253"/> 8253:                         client =&gt; Client#ev.pid},
<a name="8254"/> 8254:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="8255"/> 8255: 
<a name="8256"/> 8256:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_send_and_recv_stream-last_expr"/><a name="8257"/> 8257: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="8258"/> 8258: 
<a name="8259"/> 8259: 
<a name="8260"/> 8260: 
<a name="8261"/> 8261: 
<a name="8262"/> 8262: 
<a name="8263"/> 8263: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8264"/> 8264: 
<a name="8265"/> 8265: <i>%% Basically we make an async (Timeout = nowait) call to recvfrom,</i>
<a name="8266"/> 8266: <i>%% wait some time and then cancel. IPv4</i>
<a name="8267"/> 8267: <i>%%</i>
<a name="api_a_recvfrom_cancel_udp4-1"/><a name="8268"/> 8268: <b>api_a_recvfrom_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="8269"/> 8269:     ?TT(?SECS(10)),
<a name="8270"/> 8270:     Nowait = nowait(Config),
<a name="api_a_recvfrom_cancel_udp4-last_expr"/><a name="8271"/> 8271: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8272"/> 8272:            fun() -&gt; has_support_ipv4() end,
<a name="8273"/> 8273:            fun() -&gt;
<a name="8274"/> 8274:                    Recv = fun(Sock) -&gt;
<a name="8275"/> 8275:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="8276"/> 8276:                                       {ok, _} = OK -&gt;
<a name="8277"/> 8277:                                           OK;
<a name="8278"/> 8278:                                       {select, _} = SELECT -&gt;
<a name="8279"/> 8279:                                           SELECT;
<a name="8280"/> 8280:                                       {completion, _} = COMPLETION -&gt;
<a name="8281"/> 8281:                                           COMPLETION;
<a name="8282"/> 8282:                                       {error, _} = ERROR -&gt;
<a name="8283"/> 8283:                                           ERROR
<a name="8284"/> 8284:                                   end
<a name="8285"/> 8285:                           end,
<a name="8286"/> 8286:                    InitState = #{domain   =&gt; inet,
<a name="8287"/> 8287:                                  recv     =&gt; Recv,
<a name="8288"/> 8288:                                  recv_ref =&gt; Nowait},
<a name="8289"/> 8289:                    ok = api_a_recv_cancel_udp(InitState)
<a name="8290"/> 8290:            end).
<a name="8291"/> 8291: 
<a name="8292"/> 8292: 
<a name="8293"/> 8293: 
<a name="8294"/> 8294: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8295"/> 8295: 
<a name="8296"/> 8296: <i>%% Basically we make an async (Timeout = nowait) call to recvfrom,</i>
<a name="8297"/> 8297: <i>%% wait some time and then cancel. IPv6</i>
<a name="8298"/> 8298: <i>%%</i>
<a name="api_a_recvfrom_cancel_udp6-1"/><a name="8299"/> 8299: <b>api_a_recvfrom_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="8300"/> 8300:     ?TT(?SECS(10)),
<a name="8301"/> 8301:     Nowait = nowait(Config),
<a name="api_a_recvfrom_cancel_udp6-last_expr"/><a name="8302"/> 8302: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8303"/> 8303:            fun() -&gt; has_support_ipv6() end,
<a name="8304"/> 8304:            fun() -&gt;
<a name="8305"/> 8305:                    Recv = fun(Sock) -&gt;
<a name="8306"/> 8306:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="8307"/> 8307:                                       {ok, _} = OK -&gt;
<a name="8308"/> 8308:                                           OK;
<a name="8309"/> 8309:                                       {select, _} = SELECT -&gt;
<a name="8310"/> 8310:                                           SELECT;
<a name="8311"/> 8311:                                       {completion, _} = COMPLETION -&gt;
<a name="8312"/> 8312:                                           COMPLETION;
<a name="8313"/> 8313:                                       {error, _} = ERROR -&gt;
<a name="8314"/> 8314:                                           ERROR
<a name="8315"/> 8315:                                   end
<a name="8316"/> 8316:                           end,
<a name="8317"/> 8317:                    InitState = #{domain   =&gt; inet6,
<a name="8318"/> 8318:                                  recv     =&gt; Recv,
<a name="8319"/> 8319:                                  recv_ref =&gt; Nowait},
<a name="8320"/> 8320:                    ok = api_a_recv_cancel_udp(InitState)
<a name="8321"/> 8321:            end).
<a name="8322"/> 8322: 
<a name="8323"/> 8323: 
<a name="8324"/> 8324: 
<a name="8325"/> 8325: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8326"/> 8326: 
<a name="8327"/> 8327: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="8328"/> 8328: <i>%% wait some time and then cancel. IPv4</i>
<a name="8329"/> 8329: <i>%%</i>
<a name="api_a_recvmsg_cancel_udp4-1"/><a name="8330"/> 8330: <b>api_a_recvmsg_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="8331"/> 8331:     ?TT(?SECS(10)),
<a name="8332"/> 8332:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_udp4-last_expr"/><a name="8333"/> 8333: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8334"/> 8334:            fun() -&gt; has_support_ipv4() end,
<a name="8335"/> 8335:            fun() -&gt;
<a name="8336"/> 8336:                    Recv = fun(Sock) -&gt;
<a name="8337"/> 8337:                                   case socket:recvmsg(Sock, Nowait) of
<a name="8338"/> 8338:                                       {ok, _} = OK -&gt;
<a name="8339"/> 8339:                                           OK;
<a name="8340"/> 8340:                                       {select, _} = SELECT -&gt;
<a name="8341"/> 8341:                                           SELECT;
<a name="8342"/> 8342:                                       {completion, _} = COMPLETION -&gt;
<a name="8343"/> 8343:                                           COMPLETION;
<a name="8344"/> 8344:                                       {error, _} = ERROR -&gt;
<a name="8345"/> 8345:                                           ERROR
<a name="8346"/> 8346:                                   end
<a name="8347"/> 8347:                           end,
<a name="8348"/> 8348:                    InitState = #{domain   =&gt; inet,
<a name="8349"/> 8349:                                  recv     =&gt; Recv,
<a name="8350"/> 8350:                                  recv_ref =&gt; Nowait},
<a name="8351"/> 8351:                    ok = api_a_recv_cancel_udp(InitState)
<a name="8352"/> 8352:            end).
<a name="8353"/> 8353: 
<a name="8354"/> 8354: 
<a name="8355"/> 8355: 
<a name="8356"/> 8356: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8357"/> 8357: 
<a name="8358"/> 8358: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="8359"/> 8359: <i>%% wait some time and then cancel. IPv6</i>
<a name="8360"/> 8360: <i>%%</i>
<a name="api_a_recvmsg_cancel_udp6-1"/><a name="8361"/> 8361: <b>api_a_recvmsg_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="8362"/> 8362:     ?TT(?SECS(10)),
<a name="8363"/> 8363:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_udp6-last_expr"/><a name="8364"/> 8364: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8365"/> 8365:            fun() -&gt; has_support_ipv6() end,
<a name="8366"/> 8366:            fun() -&gt;
<a name="8367"/> 8367:                    Recv = fun(Sock) -&gt;
<a name="8368"/> 8368:                                   case socket:recvmsg(Sock, Nowait) of
<a name="8369"/> 8369:                                       {ok, _} = OK -&gt;
<a name="8370"/> 8370:                                           OK;
<a name="8371"/> 8371:                                       {select, _} = SELECT -&gt;
<a name="8372"/> 8372:                                           SELECT;
<a name="8373"/> 8373:                                       {completion, _} = COMPLETION -&gt;
<a name="8374"/> 8374:                                           COMPLETION;
<a name="8375"/> 8375:                                       {error, _} = ERROR -&gt;
<a name="8376"/> 8376:                                           ERROR
<a name="8377"/> 8377:                                   end
<a name="8378"/> 8378:                           end,
<a name="8379"/> 8379:                    InitState = #{domain   =&gt; inet6,
<a name="8380"/> 8380:                                  recv     =&gt; Recv,
<a name="8381"/> 8381:                                  recv_ref =&gt; Nowait},
<a name="8382"/> 8382:                    ok = api_a_recv_cancel_udp(InitState)
<a name="8383"/> 8383:            end).
<a name="8384"/> 8384: 
<a name="8385"/> 8385: 
<a name="8386"/> 8386: 
<a name="8387"/> 8387: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8388"/> 8388: 
<a name="api_a_recv_cancel_udp-1"/><a name="8389"/> 8389: <b>api_a_recv_cancel_udp</b>(InitState) -&gt;
<a name="8390"/> 8390:     ServerSeq = 
<a name="8391"/> 8391:         [
<a name="8392"/> 8392:          %% *** Wait for start order part ***
<a name="8393"/> 8393:          #{desc =&gt; &quot;await start&quot;,
<a name="8394"/> 8394:            cmd  =&gt; fun(State) -&gt;
<a name="8395"/> 8395:                            Tester = ?SEV_AWAIT_START(),
<a name="8396"/> 8396:                            {ok, State#{tester =&gt; Tester}}
<a name="8397"/> 8397:                    end},
<a name="8398"/> 8398:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="8399"/> 8399:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8400"/> 8400:                            _MRef = erlang:monitor(process, Tester),
<a name="8401"/> 8401:                            ok
<a name="8402"/> 8402:                    end},
<a name="8403"/> 8403: 
<a name="8404"/> 8404:          %% *** Init part ***
<a name="8405"/> 8405:          #{desc =&gt; &quot;which local address&quot;,
<a name="8406"/> 8406:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8407"/> 8407:                            LSA = which_local_socket_addr(Domain),
<a name="8408"/> 8408:                            {ok, State#{local_sa =&gt; LSA}}
<a name="8409"/> 8409:                    end},
<a name="8410"/> 8410:          #{desc =&gt; &quot;create socket&quot;,
<a name="8411"/> 8411:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8412"/> 8412:                            case socket:open(Domain, dgram, udp) of
<a name="8413"/> 8413:                                {ok, Sock} -&gt;
<a name="8414"/> 8414:                                    {ok, State#{sock =&gt; Sock}};
<a name="8415"/> 8415:                                {error, _} = ERROR -&gt;
<a name="8416"/> 8416:                                    ERROR
<a name="8417"/> 8417:                            end
<a name="8418"/> 8418:                    end},
<a name="8419"/> 8419:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="8420"/> 8420:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="8421"/> 8421:                            case sock_bind(Sock, LSA) of
<a name="8422"/> 8422:                                ok -&gt;
<a name="8423"/> 8423:                                    Port = sock_port(Sock),
<a name="8424"/> 8424:                                    {ok, State#{port =&gt; Port}};
<a name="8425"/> 8425:                                {error, _} = ERROR -&gt;
<a name="8426"/> 8426:                                    ERROR
<a name="8427"/> 8427:                            end
<a name="8428"/> 8428:                    end},
<a name="8429"/> 8429:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="8430"/> 8430:            cmd  =&gt; fun(#{tester := Tester, local_sa := LSA, port := Port}) -&gt;
<a name="8431"/> 8431:                            ServerSA = LSA#{port =&gt; Port},
<a name="8432"/> 8432:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="8433"/> 8433:                            ok
<a name="8434"/> 8434:                    end},
<a name="8435"/> 8435: 
<a name="8436"/> 8436:          %% The actual test
<a name="8437"/> 8437:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="8438"/> 8438:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8439"/> 8439:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="8440"/> 8440:                    end},
<a name="8441"/> 8441:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="8442"/> 8442:            cmd  =&gt; fun(#{sock     := Sock,
<a name="8443"/> 8443:                          recv     := Recv,
<a name="8444"/> 8444:                          recv_ref := Ref} = State) -&gt;
<a name="8445"/> 8445:                            case Recv(Sock) of
<a name="8446"/> 8446:                                {select, SI} when Ref =:= nowait -&gt;
<a name="8447"/> 8447:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="8448"/> 8448:                                {select,
<a name="8449"/> 8449:                                 {select_info, _Tag, Ref} = SI}
<a name="8450"/> 8450:                                  when is_reference(Ref) -&gt;
<a name="8451"/> 8451:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="8452"/> 8452: 
<a name="8453"/> 8453:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="8454"/> 8454:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="8455"/> 8455:                                {completion,
<a name="8456"/> 8456:                                 {completion_info, _Tag, Ref} = CI}
<a name="8457"/> 8457:                                  when is_reference(Ref) -&gt;
<a name="8458"/> 8458:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="8459"/> 8459: 
<a name="8460"/> 8460:                                {ok, X} -&gt;
<a name="8461"/> 8461:                                    {error, {unexpected_success, X}};
<a name="8462"/> 8462: 
<a name="8463"/> 8463:                                {error, _} = ERROR -&gt;
<a name="8464"/> 8464:                                    ERROR
<a name="8465"/> 8465:                            end
<a name="8466"/> 8466:                    end},
<a name="8467"/> 8467:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="8468"/> 8468:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8469"/> 8469:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="8470"/> 8470:                            ok
<a name="8471"/> 8471:                    end},
<a name="8472"/> 8472:          #{desc =&gt; &quot;wait for select message - without success&quot;,
<a name="8473"/> 8473:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="8474"/> 8474:                            receive
<a name="8475"/> 8475:                                {'$socket', Sock, select, Ref} -&gt;
<a name="8476"/> 8476:                                    {error, {unexpected_select, Ref}};
<a name="8477"/> 8477: 
<a name="8478"/> 8478:                                {'$socket', Sock, completion, C} -&gt;
<a name="8479"/> 8479:                                    {error, {unexpected_completion, C}}
<a name="8480"/> 8480: 
<a name="8481"/> 8481:                            after 5000 -&gt;
<a name="8482"/> 8482:                                    ok
<a name="8483"/> 8483:                            end
<a name="8484"/> 8484:                    end},
<a name="8485"/> 8485:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="8486"/> 8486:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8487"/> 8487:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="8488"/> 8488:                            ok
<a name="8489"/> 8489:                    end},
<a name="8490"/> 8490:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="8491"/> 8491:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8492"/> 8492:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="8493"/> 8493:                    end},
<a name="8494"/> 8494:          #{desc =&gt; &quot;cancel&quot;,
<a name="8495"/> 8495:            cmd  =&gt; fun(#{sock := Sock, recv_select_info := SI}) -&gt;
<a name="8496"/> 8496:                            ok = socket:cancel(Sock, SI);
<a name="8497"/> 8497:                       (#{sock := Sock, recv_completion_info := CI}) -&gt;
<a name="8498"/> 8498:                            ok = socket:cancel(Sock, CI)
<a name="8499"/> 8499:                    end},
<a name="8500"/> 8500: 
<a name="8501"/> 8501:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="8502"/> 8502:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8503"/> 8503:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="8504"/> 8504:                            ok
<a name="8505"/> 8505:                    end},
<a name="8506"/> 8506: 
<a name="8507"/> 8507:          %% Termination
<a name="8508"/> 8508:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="8509"/> 8509:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8510"/> 8510:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8511"/> 8511:                                ok -&gt;
<a name="8512"/> 8512:                                    State2 = maps:remove(tester,   State),
<a name="8513"/> 8513:                                    State3 = maps:remove(recv_ref, State2),
<a name="8514"/> 8514:                                    State4 = maps:remove(req_src,  State3),
<a name="8515"/> 8515:                                    {ok, State4};
<a name="8516"/> 8516:                                {error, _} = ERROR -&gt;
<a name="8517"/> 8517:                                    ERROR
<a name="8518"/> 8518:                            end
<a name="8519"/> 8519:                    end},
<a name="8520"/> 8520:          #{desc =&gt; &quot;close socket&quot;,
<a name="8521"/> 8521:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="8522"/> 8522:                            ok = socket:close(Sock),
<a name="8523"/> 8523:                            {ok, maps:remove(sock, State)}
<a name="8524"/> 8524:                    end},
<a name="8525"/> 8525: 
<a name="8526"/> 8526:          %% *** We are done ***
<a name="8527"/> 8527:          ?SEV_FINISH_NORMAL
<a name="8528"/> 8528:         ],
<a name="8529"/> 8529: 
<a name="8530"/> 8530: 
<a name="8531"/> 8531:     TesterSeq = 
<a name="8532"/> 8532:         [
<a name="8533"/> 8533:          %% *** Init part ***
<a name="8534"/> 8534:          #{desc =&gt; &quot;monitor server&quot;,
<a name="8535"/> 8535:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8536"/> 8536:                            _MRef = erlang:monitor(process, Pid),
<a name="8537"/> 8537:                            ok
<a name="8538"/> 8538:                    end},
<a name="8539"/> 8539: 
<a name="8540"/> 8540:          %% Start the server
<a name="8541"/> 8541:          #{desc =&gt; &quot;order server start&quot;,
<a name="8542"/> 8542:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8543"/> 8543:                            ?SEV_ANNOUNCE_START(Pid),
<a name="8544"/> 8544:                            ok
<a name="8545"/> 8545:                    end},
<a name="8546"/> 8546:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="8547"/> 8547:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8548"/> 8548:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="8549"/> 8549:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="8550"/> 8550:                    end},
<a name="8551"/> 8551: 
<a name="8552"/> 8552:          %% The actual test
<a name="8553"/> 8553:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="8554"/> 8554:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8555"/> 8555:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="8556"/> 8556:                            ok
<a name="8557"/> 8557:                    end},
<a name="8558"/> 8558:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="8559"/> 8559:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8560"/> 8560:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="8561"/> 8561:                    end},
<a name="8562"/> 8562:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="8563"/> 8563:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8564"/> 8564:                            ok = ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="8565"/> 8565:                    end},
<a name="8566"/> 8566:          #{desc =&gt; &quot;order server continue (cancel)&quot;,
<a name="8567"/> 8567:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8568"/> 8568:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="8569"/> 8569:                            ok
<a name="8570"/> 8570:                    end},
<a name="8571"/> 8571:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="8572"/> 8572:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8573"/> 8573:                            ok = ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="8574"/> 8574:                    end},
<a name="8575"/> 8575: 
<a name="8576"/> 8576:          %% Terminations
<a name="8577"/> 8577:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="8578"/> 8578:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8579"/> 8579:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="8580"/> 8580:                            ok
<a name="8581"/> 8581:                    end},
<a name="8582"/> 8582:          #{desc =&gt; &quot;await server termination&quot;,
<a name="8583"/> 8583:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8584"/> 8584:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="8585"/> 8585:                                ok -&gt;
<a name="8586"/> 8586:                                    State1 = maps:remove(server, State),
<a name="8587"/> 8587:                                    {ok, State1};
<a name="8588"/> 8588:                                {error, _} = ERROR -&gt;
<a name="8589"/> 8589:                                    ERROR
<a name="8590"/> 8590:                            end
<a name="8591"/> 8591:                    end},
<a name="8592"/> 8592: 
<a name="8593"/> 8593: 
<a name="8594"/> 8594:          %% *** We are done ***
<a name="8595"/> 8595:          ?SEV_FINISH_NORMAL
<a name="8596"/> 8596:         ],
<a name="8597"/> 8597: 
<a name="8598"/> 8598:     i(&quot;start server evaluator&quot;),
<a name="8599"/> 8599:     ServerInitState = InitState,
<a name="8600"/> 8600:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="8601"/> 8601: 
<a name="8602"/> 8602:     i(&quot;start 'tester' evaluator&quot;),
<a name="8603"/> 8603:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="8604"/> 8604:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="8605"/> 8605: 
<a name="8606"/> 8606:     i(&quot;await evaluator&quot;),
<a name="api_a_recv_cancel_udp-last_expr"/><a name="8607"/> 8607: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="8608"/> 8608: 
<a name="8609"/> 8609: 
<a name="8610"/> 8610: 
<a name="8611"/> 8611: 
<a name="8612"/> 8612: 
<a name="8613"/> 8613: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8614"/> 8614: 
<a name="8615"/> 8615: <i>%% Basically we make an async (Timeout = nowait) call to accept,</i>
<a name="8616"/> 8616: <i>%% wait some time and then cancel. IPv4</i>
<a name="8617"/> 8617: <i>%%</i>
<a name="api_a_accept_cancel_tcp4-1"/><a name="8618"/> 8618: <b>api_a_accept_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="8619"/> 8619:     ?TT(?SECS(10)),
<a name="8620"/> 8620:     Nowait = nowait(Config),
<a name="api_a_accept_cancel_tcp4-last_expr"/><a name="8621"/> 8621: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8622"/> 8622:            fun() -&gt; has_support_ipv4() end,
<a name="8623"/> 8623:            fun() -&gt;
<a name="8624"/> 8624:                    Accept = fun(Sock) -&gt;
<a name="8625"/> 8625:                                     case socket:accept(Sock, Nowait) of
<a name="8626"/> 8626:                                         {ok, _} = OK -&gt;
<a name="8627"/> 8627:                                             OK;
<a name="8628"/> 8628:                                         {select, _} = SELECT -&gt;
<a name="8629"/> 8629:                                             SELECT;
<a name="8630"/> 8630:                                         {completion, _} = COMPLETION -&gt;
<a name="8631"/> 8631:                                             COMPLETION;
<a name="8632"/> 8632:                                         {error, _} = ERROR -&gt;
<a name="8633"/> 8633:                                             ERROR
<a name="8634"/> 8634:                                     end
<a name="8635"/> 8635:                             end,
<a name="8636"/> 8636:                    InitState = #{domain     =&gt; inet,
<a name="8637"/> 8637:                                  accept     =&gt; Accept,
<a name="8638"/> 8638:                                  accept_ref =&gt; Nowait},
<a name="8639"/> 8639:                    ok = api_a_accept_cancel_tcp(InitState)
<a name="8640"/> 8640:            end).
<a name="8641"/> 8641: 
<a name="8642"/> 8642: 
<a name="8643"/> 8643: 
<a name="8644"/> 8644: 
<a name="8645"/> 8645: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8646"/> 8646: 
<a name="8647"/> 8647: <i>%% Basically we make an async (Timeout = nowait) call to accept,</i>
<a name="8648"/> 8648: <i>%% wait some time and then cancel. IPv6</i>
<a name="8649"/> 8649: <i>%%</i>
<a name="api_a_accept_cancel_tcp6-1"/><a name="8650"/> 8650: <b>api_a_accept_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="8651"/> 8651:     ?TT(?SECS(10)),
<a name="8652"/> 8652:     Nowait = nowait(Config),
<a name="api_a_accept_cancel_tcp6-last_expr"/><a name="8653"/> 8653: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8654"/> 8654:            fun() -&gt; has_support_ipv6() end,
<a name="8655"/> 8655:            fun() -&gt;
<a name="8656"/> 8656:                    Accept = fun(Sock) -&gt;
<a name="8657"/> 8657:                                     case socket:accept(Sock, Nowait) of
<a name="8658"/> 8658:                                         {ok, _} = OK -&gt;
<a name="8659"/> 8659:                                             OK;
<a name="8660"/> 8660:                                         {select, _} = SELECT -&gt;
<a name="8661"/> 8661:                                             SELECT;
<a name="8662"/> 8662:                                         {completion, _} = COMPLETION -&gt;
<a name="8663"/> 8663:                                             COMPLETION;
<a name="8664"/> 8664:                                         {error, _} = ERROR -&gt;
<a name="8665"/> 8665:                                             ERROR
<a name="8666"/> 8666:                                     end
<a name="8667"/> 8667:                             end,
<a name="8668"/> 8668:                    InitState = #{domain     =&gt; inet6,
<a name="8669"/> 8669:                                  accept     =&gt; Accept,
<a name="8670"/> 8670:                                  accept_ref =&gt; Nowait},
<a name="8671"/> 8671:                    ok = api_a_accept_cancel_tcp(InitState)
<a name="8672"/> 8672:            end).
<a name="8673"/> 8673: 
<a name="8674"/> 8674: 
<a name="8675"/> 8675: 
<a name="8676"/> 8676: 
<a name="8677"/> 8677: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8678"/> 8678: 
<a name="api_a_accept_cancel_tcp-1"/><a name="8679"/> 8679: <b>api_a_accept_cancel_tcp</b>(InitState) -&gt;
<a name="8680"/> 8680:     process_flag(trap_exit, true),
<a name="8681"/> 8681:     ServerSeq = 
<a name="8682"/> 8682:         [
<a name="8683"/> 8683:          %% *** Wait for start order ***
<a name="8684"/> 8684:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="8685"/> 8685:            cmd  =&gt; fun(State) -&gt;
<a name="8686"/> 8686:                            Tester = ?SEV_AWAIT_START(),
<a name="8687"/> 8687:                            {ok, State#{tester =&gt; Tester}}
<a name="8688"/> 8688:                    end},
<a name="8689"/> 8689:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="8690"/> 8690:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8691"/> 8691:                            _MRef = erlang:monitor(process, Tester),
<a name="8692"/> 8692:                            ok
<a name="8693"/> 8693:                    end},
<a name="8694"/> 8694: 
<a name="8695"/> 8695:          %% *** Init part ***
<a name="8696"/> 8696:          #{desc =&gt; &quot;which local address&quot;,
<a name="8697"/> 8697:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8698"/> 8698:                            LSA = which_local_socket_addr(Domain),
<a name="8699"/> 8699:                            {ok, State#{lsa =&gt; LSA}}
<a name="8700"/> 8700:                    end},
<a name="8701"/> 8701:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="8702"/> 8702:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8703"/> 8703:                            case socket:open(Domain, stream, tcp) of
<a name="8704"/> 8704:                                {ok, Sock} -&gt;
<a name="8705"/> 8705:                                    {ok, State#{lsock =&gt; Sock}};
<a name="8706"/> 8706:                                {error, _} = ERROR -&gt;
<a name="8707"/> 8707:                                    ERROR
<a name="8708"/> 8708:                            end
<a name="8709"/> 8709:                    end},
<a name="8710"/> 8710:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="8711"/> 8711:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="8712"/> 8712:                            case sock_bind(LSock, LSA) of
<a name="8713"/> 8713:                                ok -&gt;
<a name="8714"/> 8714:                                    Port = sock_port(LSock),
<a name="8715"/> 8715:                                    {ok, State#{lport =&gt; Port}};
<a name="8716"/> 8716:                                {error, _} = ERROR -&gt;
<a name="8717"/> 8717:                                    ERROR
<a name="8718"/> 8718:                            end
<a name="8719"/> 8719:                    end},
<a name="8720"/> 8720:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="8721"/> 8721:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="8722"/> 8722:                            socket:listen(LSock)
<a name="8723"/> 8723:                    end},
<a name="8724"/> 8724:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="8725"/> 8725:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="8726"/> 8726:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="8727"/> 8727:                            ok
<a name="8728"/> 8728:                    end},
<a name="8729"/> 8729: 
<a name="8730"/> 8730:          %% The actual test
<a name="8731"/> 8731:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="8732"/> 8732:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8733"/> 8733:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="8734"/> 8734:                    end},
<a name="8735"/> 8735:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="8736"/> 8736:            cmd  =&gt; fun(#{lsock      := LSock,
<a name="8737"/> 8737:                          accept     := Accept,
<a name="8738"/> 8738:                          accept_ref := Ref} = State) -&gt;
<a name="8739"/> 8739:                            case Accept(LSock) of
<a name="8740"/> 8740:                                {select, {select_info, T, R} = SI}
<a name="8741"/> 8741:                                  when Ref =:= nowait -&gt;
<a name="8742"/> 8742:                                    ?SEV_IPRINT(&quot;accept select nowait: &quot;
<a name="8743"/> 8743:                                                &quot;~n   T: ~p&quot;
<a name="8744"/> 8744:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="8745"/> 8745:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="8746"/> 8746:                                {select, {select_info, T, Ref} = SI}
<a name="8747"/> 8747:                                  when is_reference(Ref) -&gt;
<a name="8748"/> 8748:                                    ?SEV_IPRINT(&quot;accept select ref: &quot;
<a name="8749"/> 8749:                                                &quot;~n   T: ~p&quot;
<a name="8750"/> 8750:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="8751"/> 8751:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="8752"/> 8752: 
<a name="8753"/> 8753:                                {completion, {completion_info, T, R} = CI}
<a name="8754"/> 8754:                                  when Ref =:= nowait -&gt;
<a name="8755"/> 8755:                                    ?SEV_IPRINT(&quot;accept completion nowait: &quot;
<a name="8756"/> 8756:                                                &quot;~n   T: ~p&quot;
<a name="8757"/> 8757:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="8758"/> 8758:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="8759"/> 8759:                                {completion, {completion_info, T, Ref} = CI}
<a name="8760"/> 8760:                                  when is_reference(Ref) -&gt;
<a name="8761"/> 8761:                                    ?SEV_IPRINT(&quot;accept completion ref: &quot;
<a name="8762"/> 8762:                                                &quot;~n   T: ~p&quot;
<a name="8763"/> 8763:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="8764"/> 8764:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="8765"/> 8765: 
<a name="8766"/> 8766:                                {ok, X} -&gt;
<a name="8767"/> 8767:                                    {error, {unexpected_success, X}};
<a name="8768"/> 8768: 
<a name="8769"/> 8769:                                {error, _} = ERROR -&gt;
<a name="8770"/> 8770:                                    ERROR
<a name="8771"/> 8771:                            end
<a name="8772"/> 8772:                    end},
<a name="8773"/> 8773:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="8774"/> 8774:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8775"/> 8775:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="8776"/> 8776:                            ok
<a name="8777"/> 8777:                    end},
<a name="8778"/> 8778:          #{desc =&gt; &quot;await select message (without success)&quot;,
<a name="8779"/> 8779:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="8780"/> 8780:                            receive
<a name="8781"/> 8781:                                {'$socket', Sock, select, Ref} -&gt;
<a name="8782"/> 8782:                                    {error, {unexpected_select, Ref}};
<a name="8783"/> 8783: 
<a name="8784"/> 8784:                                {'$socket', Sock, completion, C} -&gt;
<a name="8785"/> 8785:                                    {error, {unexpected_completion, C}}
<a name="8786"/> 8786: 
<a name="8787"/> 8787:                            after 5000 -&gt;
<a name="8788"/> 8788:                                    ok
<a name="8789"/> 8789:                            end
<a name="8790"/> 8790:                    end},
<a name="8791"/> 8791:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="8792"/> 8792:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8793"/> 8793:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="8794"/> 8794:                            ok
<a name="8795"/> 8795:                    end},
<a name="8796"/> 8796:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="8797"/> 8797:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8798"/> 8798:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="8799"/> 8799:                    end},
<a name="8800"/> 8800:          #{desc =&gt; &quot;cancel&quot;,
<a name="8801"/> 8801:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="8802"/> 8802:                          accept_select_info := SelectInfo}) -&gt;
<a name="8803"/> 8803:                            ok = socket:cancel(Sock, SelectInfo);
<a name="8804"/> 8804:                       (#{lsock                  := Sock,
<a name="8805"/> 8805:                          accept_completion_info := CompletionInfo}) -&gt;
<a name="8806"/> 8806:                            ok = socket:cancel(Sock, CompletionInfo)
<a name="8807"/> 8807:                    end},
<a name="8808"/> 8808:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="8809"/> 8809:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8810"/> 8810:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="8811"/> 8811:                            ok
<a name="8812"/> 8812:                    end},
<a name="8813"/> 8813: 
<a name="8814"/> 8814:          %% *** Termination ***
<a name="8815"/> 8815:          #{desc =&gt; &quot;await terminate&quot;,
<a name="8816"/> 8816:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8817"/> 8817:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8818"/> 8818:                                ok -&gt;
<a name="8819"/> 8819:                                    {ok, maps:remove(tester, State)};
<a name="8820"/> 8820:                                {error, _} = ERROR -&gt;
<a name="8821"/> 8821:                                    ERROR
<a name="8822"/> 8822:                            end
<a name="8823"/> 8823:                    end},
<a name="8824"/> 8824:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="8825"/> 8825:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="8826"/> 8826:                            socket:close(Sock)
<a name="8827"/> 8827:                    end},
<a name="8828"/> 8828: 
<a name="8829"/> 8829:          %% *** We are done ***
<a name="8830"/> 8830:          ?SEV_FINISH_NORMAL
<a name="8831"/> 8831:         ],
<a name="8832"/> 8832: 
<a name="8833"/> 8833: 
<a name="8834"/> 8834:     TesterSeq =
<a name="8835"/> 8835:         [
<a name="8836"/> 8836:          %% *** Init part ***
<a name="8837"/> 8837:          #{desc =&gt; &quot;monitor server&quot;,
<a name="8838"/> 8838:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8839"/> 8839:                            _MRef = erlang:monitor(process, Pid),
<a name="8840"/> 8840:                            ok
<a name="8841"/> 8841:                    end},
<a name="8842"/> 8842: 
<a name="8843"/> 8843:          %% Start the server
<a name="8844"/> 8844:          #{desc =&gt; &quot;order server start&quot;,
<a name="8845"/> 8845:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8846"/> 8846:                            ?SEV_ANNOUNCE_START(Pid),
<a name="8847"/> 8847:                            ok
<a name="8848"/> 8848:                    end},
<a name="8849"/> 8849:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="8850"/> 8850:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8851"/> 8851:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="8852"/> 8852:                            {ok, State#{server_port =&gt; Port}}
<a name="8853"/> 8853:                    end},
<a name="8854"/> 8854: 
<a name="8855"/> 8855:          %% *** The actual test ***
<a name="8856"/> 8856:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="8857"/> 8857:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="8858"/> 8858:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="8859"/> 8859:                            ok
<a name="8860"/> 8860:                    end},
<a name="8861"/> 8861:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="8862"/> 8862:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8863"/> 8863:                            ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="8864"/> 8864:                    end},
<a name="8865"/> 8865:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="8866"/> 8866:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8867"/> 8867:                            ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="8868"/> 8868:                    end},
<a name="8869"/> 8869:          #{desc =&gt; &quot;order server to continue (cancel)&quot;,
<a name="8870"/> 8870:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8871"/> 8871:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="8872"/> 8872:                            ok
<a name="8873"/> 8873:                    end},
<a name="8874"/> 8874:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="8875"/> 8875:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8876"/> 8876:                            ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="8877"/> 8877:                    end},
<a name="8878"/> 8878: 
<a name="8879"/> 8879:          %% *** Termination ***
<a name="8880"/> 8880:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="8881"/> 8881:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="8882"/> 8882:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="8883"/> 8883:                            ok
<a name="8884"/> 8884:                    end},
<a name="8885"/> 8885:          #{desc =&gt; &quot;await server termination&quot;,
<a name="8886"/> 8886:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="8887"/> 8887:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="8888"/> 8888:                            State1 = maps:remove(server, State),
<a name="8889"/> 8889:                            {ok, State1}
<a name="8890"/> 8890:                    end},
<a name="8891"/> 8891: 
<a name="8892"/> 8892:          %% *** We are done ***
<a name="8893"/> 8893:          ?SEV_FINISH_NORMAL
<a name="8894"/> 8894:         ],
<a name="8895"/> 8895: 
<a name="8896"/> 8896:     i(&quot;start server evaluator&quot;),
<a name="8897"/> 8897:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="8898"/> 8898: 
<a name="8899"/> 8899:     i(&quot;start tester evaluator&quot;),
<a name="8900"/> 8900:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="8901"/> 8901:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="8902"/> 8902: 
<a name="8903"/> 8903:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_accept_cancel_tcp-last_expr"/><a name="8904"/> 8904: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="8905"/> 8905: 
<a name="8906"/> 8906: 
<a name="8907"/> 8907: 
<a name="8908"/> 8908: 
<a name="8909"/> 8909: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8910"/> 8910: 
<a name="8911"/> 8911: <i>%% Basically we make an async (Timeout = nowait) call to recv,</i>
<a name="8912"/> 8912: <i>%% wait some time and then cancel. IPv4</i>
<a name="8913"/> 8913: <i>%%</i>
<a name="api_a_recv_cancel_tcp4-1"/><a name="8914"/> 8914: <b>api_a_recv_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="8915"/> 8915:     ?TT(?SECS(10)),
<a name="8916"/> 8916:     Nowait = nowait(Config),
<a name="api_a_recv_cancel_tcp4-last_expr"/><a name="8917"/> 8917: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8918"/> 8918:            fun() -&gt; has_support_ipv4() end,
<a name="8919"/> 8919:            fun() -&gt;
<a name="8920"/> 8920:                    Recv = fun(Sock) -&gt;
<a name="8921"/> 8921:                                   socket:recv(Sock, 0, Nowait)
<a name="8922"/> 8922:                           end,
<a name="8923"/> 8923:                    InitState = #{domain   =&gt; inet,
<a name="8924"/> 8924:                                  recv     =&gt; Recv,
<a name="8925"/> 8925:                                  recv_ref =&gt; Nowait},
<a name="8926"/> 8926:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="8927"/> 8927:            end).
<a name="8928"/> 8928: 
<a name="8929"/> 8929: 
<a name="8930"/> 8930: 
<a name="8931"/> 8931: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8932"/> 8932: 
<a name="8933"/> 8933: <i>%% Basically we make an async (Timeout = nowait) call to recv,</i>
<a name="8934"/> 8934: <i>%% wait some time and then cancel. IPv6</i>
<a name="8935"/> 8935: <i>%%</i>
<a name="api_a_recv_cancel_tcp6-1"/><a name="8936"/> 8936: <b>api_a_recv_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="8937"/> 8937:     ?TT(?SECS(10)),
<a name="8938"/> 8938:     Nowait = nowait(Config),
<a name="api_a_recv_cancel_tcp6-last_expr"/><a name="8939"/> 8939: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8940"/> 8940:            fun() -&gt; has_support_ipv6() end,
<a name="8941"/> 8941:            fun() -&gt;
<a name="8942"/> 8942:                    Recv = fun(Sock) -&gt;
<a name="8943"/> 8943:                                   socket:recv(Sock, 0, Nowait)
<a name="8944"/> 8944:                           end,
<a name="8945"/> 8945:                    InitState = #{domain   =&gt; inet6,
<a name="8946"/> 8946:                                  recv     =&gt; Recv,
<a name="8947"/> 8947:                                  recv_ref =&gt; Nowait},
<a name="8948"/> 8948:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="8949"/> 8949:            end).
<a name="8950"/> 8950: 
<a name="8951"/> 8951: 
<a name="8952"/> 8952: 
<a name="8953"/> 8953: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8954"/> 8954: 
<a name="8955"/> 8955: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="8956"/> 8956: <i>%% wait some time and then cancel. IPv4</i>
<a name="8957"/> 8957: <i>%%</i>
<a name="api_a_recvmsg_cancel_tcp4-1"/><a name="8958"/> 8958: <b>api_a_recvmsg_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="8959"/> 8959:     ?TT(?SECS(10)),
<a name="8960"/> 8960:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_tcp4-last_expr"/><a name="8961"/> 8961: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8962"/> 8962:            fun() -&gt;
<a name="8963"/> 8963:                    is_not_windows(),
<a name="8964"/> 8964:                    has_support_ipv4()
<a name="8965"/> 8965:            end,
<a name="8966"/> 8966:            fun() -&gt;
<a name="8967"/> 8967:                    Recv = fun(Sock) -&gt;
<a name="8968"/> 8968:                                   socket:recvmsg(Sock, Nowait)
<a name="8969"/> 8969:                           end,
<a name="8970"/> 8970:                    InitState = #{domain   =&gt; inet,
<a name="8971"/> 8971:                                  recv     =&gt; Recv,
<a name="8972"/> 8972:                                  recv_ref =&gt; Nowait},
<a name="8973"/> 8973:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="8974"/> 8974:            end).
<a name="8975"/> 8975: 
<a name="8976"/> 8976: 
<a name="8977"/> 8977: 
<a name="8978"/> 8978: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8979"/> 8979: 
<a name="8980"/> 8980: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="8981"/> 8981: <i>%% wait some time and then cancel. IPv6</i>
<a name="8982"/> 8982: <i>%%</i>
<a name="api_a_recvmsg_cancel_tcp6-1"/><a name="8983"/> 8983: <b>api_a_recvmsg_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="8984"/> 8984:     ?TT(?SECS(10)),
<a name="8985"/> 8985:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_tcp6-last_expr"/><a name="8986"/> 8986: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8987"/> 8987:            fun() -&gt;
<a name="8988"/> 8988:                    is_not_windows(),
<a name="8989"/> 8989:                    has_support_ipv6()
<a name="8990"/> 8990:            end,
<a name="8991"/> 8991:            fun() -&gt;
<a name="8992"/> 8992:                    Recv = fun(Sock) -&gt;
<a name="8993"/> 8993:                                   socket:recvmsg(Sock, Nowait)
<a name="8994"/> 8994:                           end,
<a name="8995"/> 8995:                    InitState = #{domain   =&gt; inet6,
<a name="8996"/> 8996:                                  recv     =&gt; Recv,
<a name="8997"/> 8997:                                  recv_ref =&gt; Nowait},
<a name="8998"/> 8998:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="8999"/> 8999:            end).
<a name="9000"/> 9000: 
<a name="9001"/> 9001: 
<a name="9002"/> 9002: 
<a name="9003"/> 9003: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9004"/> 9004: 
<a name="api_a_recv_cancel_tcp-1"/><a name="9005"/> 9005: <b>api_a_recv_cancel_tcp</b>(InitState) -&gt;
<a name="9006"/> 9006:     process_flag(trap_exit, true),
<a name="9007"/> 9007:     ServerSeq = 
<a name="9008"/> 9008:         [
<a name="9009"/> 9009:          %% *** Wait for start order ***
<a name="9010"/> 9010:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="9011"/> 9011:            cmd  =&gt; fun(State) -&gt;
<a name="9012"/> 9012:                            Tester = ?SEV_AWAIT_START(),
<a name="9013"/> 9013:                            {ok, State#{tester =&gt; Tester}}
<a name="9014"/> 9014:                    end},
<a name="9015"/> 9015:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9016"/> 9016:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9017"/> 9017:                            _MRef = erlang:monitor(process, Tester),
<a name="9018"/> 9018:                            ok
<a name="9019"/> 9019:                    end},
<a name="9020"/> 9020: 
<a name="9021"/> 9021:          %% *** Init part ***
<a name="9022"/> 9022:          #{desc =&gt; &quot;which local address&quot;,
<a name="9023"/> 9023:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9024"/> 9024:                            LSA = which_local_socket_addr(Domain),
<a name="9025"/> 9025:                            {ok, State#{lsa =&gt; LSA}}
<a name="9026"/> 9026:                    end},
<a name="9027"/> 9027:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="9028"/> 9028:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9029"/> 9029:                            case socket:open(Domain, stream, tcp) of
<a name="9030"/> 9030:                                {ok, Sock} -&gt;
<a name="9031"/> 9031:                                    {ok, State#{lsock =&gt; Sock}};
<a name="9032"/> 9032:                                {error, _} = ERROR -&gt;
<a name="9033"/> 9033:                                    ERROR
<a name="9034"/> 9034:                            end
<a name="9035"/> 9035:                    end},
<a name="9036"/> 9036:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="9037"/> 9037:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="9038"/> 9038:                            case sock_bind(LSock, LSA) of
<a name="9039"/> 9039:                                ok -&gt;
<a name="9040"/> 9040:                                    Port = sock_port(LSock),
<a name="9041"/> 9041:                                    {ok, State#{lport =&gt; Port}};
<a name="9042"/> 9042:                                {error, _} = ERROR -&gt;
<a name="9043"/> 9043:                                    ERROR
<a name="9044"/> 9044:                            end
<a name="9045"/> 9045:                    end},
<a name="9046"/> 9046:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="9047"/> 9047:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="9048"/> 9048:                            socket:listen(LSock)
<a name="9049"/> 9049:                    end},
<a name="9050"/> 9050:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9051"/> 9051:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="9052"/> 9052:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="9053"/> 9053:                            ok
<a name="9054"/> 9054:                    end},
<a name="9055"/> 9055: 
<a name="9056"/> 9056:          %% The actual test
<a name="9057"/> 9057:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="9058"/> 9058:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9059"/> 9059:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="9060"/> 9060:                    end},
<a name="9061"/> 9061:          #{desc =&gt; &quot;await connection&quot;,
<a name="9062"/> 9062:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="9063"/> 9063:                            case socket:accept(LSock) of
<a name="9064"/> 9064:                                {ok, CSock} -&gt;
<a name="9065"/> 9065:                                    {ok, State#{csock =&gt; CSock}};
<a name="9066"/> 9066:                                {error, _} = ERROR -&gt;
<a name="9067"/> 9067:                                    ERROR
<a name="9068"/> 9068:                            end
<a name="9069"/> 9069:                    end},
<a name="9070"/> 9070:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="9071"/> 9071:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9072"/> 9072:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="9073"/> 9073:                            ok
<a name="9074"/> 9074:                    end},
<a name="9075"/> 9075: 
<a name="9076"/> 9076:          #{desc =&gt; &quot;await continue (nowait recv)&quot;,
<a name="9077"/> 9077:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9078"/> 9078:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="9079"/> 9079:                    end},
<a name="9080"/> 9080: 
<a name="9081"/> 9081:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="9082"/> 9082:            cmd  =&gt; fun(#{csock    := Sock,
<a name="9083"/> 9083:                          recv     := Recv,
<a name="9084"/> 9084:                          recv_ref := Ref} = State) -&gt;
<a name="9085"/> 9085:                            case Recv(Sock) of
<a name="9086"/> 9086:                                {select, {select_info, T, R} = SI}
<a name="9087"/> 9087:                                  when Ref =:= nowait -&gt;
<a name="9088"/> 9088:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="9089"/> 9089:                                                &quot;~n   Tag: ~p&quot;
<a name="9090"/> 9090:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="9091"/> 9091:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9092"/> 9092:                                {select, {select_info, T, Ref} = SI}
<a name="9093"/> 9093:                                  when is_reference(Ref) -&gt;
<a name="9094"/> 9094:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="9095"/> 9095:                                                &quot;~n   Tag: ~p&quot;
<a name="9096"/> 9096:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="9097"/> 9097:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9098"/> 9098: 
<a name="9099"/> 9099:                                {completion,
<a name="9100"/> 9100:                                 {completion_info, T, R} = CI}
<a name="9101"/> 9101:                                  when Ref =:= nowait -&gt;
<a name="9102"/> 9102:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="9103"/> 9103:                                                &quot;~n   Tag: ~p&quot;
<a name="9104"/> 9104:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="9105"/> 9105:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9106"/> 9106:                                {completion,
<a name="9107"/> 9107:                                 {completion_info, T, Ref} = CI}
<a name="9108"/> 9108:                                  when is_reference(Ref) -&gt;
<a name="9109"/> 9109:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="9110"/> 9110:                                                &quot;~n   Tag: ~p&quot;
<a name="9111"/> 9111:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="9112"/> 9112:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9113"/> 9113: 
<a name="9114"/> 9114:                                {ok, X} -&gt;
<a name="9115"/> 9115:                                    {error, {unexpected_success, X}};
<a name="9116"/> 9116: 
<a name="9117"/> 9117:                                {error, _} = ERROR -&gt;
<a name="9118"/> 9118:                                    ERROR
<a name="9119"/> 9119:                            end
<a name="9120"/> 9120:                    end},
<a name="9121"/> 9121:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="9122"/> 9122:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9123"/> 9123:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="9124"/> 9124:                            ok
<a name="9125"/> 9125:                    end},
<a name="9126"/> 9126:          #{desc =&gt; &quot;await select message&quot;,
<a name="9127"/> 9127:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="9128"/> 9128:                            receive
<a name="9129"/> 9129:                                {'$socket', Sock, select, Ref} -&gt;
<a name="9130"/> 9130:                                    {error, {unexpected_select, Ref}};
<a name="9131"/> 9131: 
<a name="9132"/> 9132:                                {'$socket', Sock, completion, C} -&gt;
<a name="9133"/> 9133:                                    {error, {unexpected_completion, C}}
<a name="9134"/> 9134: 
<a name="9135"/> 9135:                            after 5000 -&gt;
<a name="9136"/> 9136:                                    ok
<a name="9137"/> 9137:                            end
<a name="9138"/> 9138:                    end},
<a name="9139"/> 9139:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="9140"/> 9140:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9141"/> 9141:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="9142"/> 9142:                            ok
<a name="9143"/> 9143:                    end},
<a name="9144"/> 9144:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="9145"/> 9145:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9146"/> 9146:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="9147"/> 9147:                    end},
<a name="9148"/> 9148:          #{desc =&gt; &quot;cancel&quot;,
<a name="9149"/> 9149:            cmd  =&gt; fun(#{csock := Sock, recv_select_info := SI}) -&gt;
<a name="9150"/> 9150:                            ok = socket:cancel(Sock, SI);
<a name="9151"/> 9151: 
<a name="9152"/> 9152:                       (#{csock := Sock, recv_completion_info := CI}) -&gt;
<a name="9153"/> 9153:                            ok = socket:cancel(Sock, CI)
<a name="9154"/> 9154:                    end},
<a name="9155"/> 9155:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="9156"/> 9156:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9157"/> 9157:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="9158"/> 9158:                            ok
<a name="9159"/> 9159:                    end},
<a name="9160"/> 9160: 
<a name="9161"/> 9161:          %% *** Termination ***
<a name="9162"/> 9162:          #{desc =&gt; &quot;await terminate&quot;,
<a name="9163"/> 9163:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9164"/> 9164:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9165"/> 9165:                                ok -&gt;
<a name="9166"/> 9166:                                    {ok, maps:remove(tester, State)};
<a name="9167"/> 9167:                                {error, _} = ERROR -&gt;
<a name="9168"/> 9168:                                    ERROR
<a name="9169"/> 9169:                            end
<a name="9170"/> 9170:                    end},
<a name="9171"/> 9171:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="9172"/> 9172:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="9173"/> 9173:                            socket:close(Sock)
<a name="9174"/> 9174:                    end},
<a name="9175"/> 9175:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="9176"/> 9176:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="9177"/> 9177:                            socket:close(Sock)
<a name="9178"/> 9178:                    end},
<a name="9179"/> 9179: 
<a name="9180"/> 9180:          %% *** We are done ***
<a name="9181"/> 9181:          ?SEV_FINISH_NORMAL
<a name="9182"/> 9182:         ],
<a name="9183"/> 9183: 
<a name="9184"/> 9184: 
<a name="9185"/> 9185:     ClientSeq = 
<a name="9186"/> 9186:         [
<a name="9187"/> 9187:          %% *** Wait for start order ***
<a name="9188"/> 9188:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="9189"/> 9189:            cmd  =&gt; fun(State) -&gt;
<a name="9190"/> 9190:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="9191"/> 9191:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="9192"/> 9192:                    end},
<a name="9193"/> 9193:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9194"/> 9194:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9195"/> 9195:                            _MRef = erlang:monitor(process, Tester),
<a name="9196"/> 9196:                            ok
<a name="9197"/> 9197:                    end},
<a name="9198"/> 9198: 
<a name="9199"/> 9199:          %% *** The init part ***
<a name="9200"/> 9200:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="9201"/> 9201:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="9202"/> 9202:                            LSA = which_local_socket_addr(Domain),
<a name="9203"/> 9203:                            SSA = LSA#{port =&gt; Port},
<a name="9204"/> 9204:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="9205"/> 9205:                    end},
<a name="9206"/> 9206:          #{desc =&gt; &quot;create socket&quot;,
<a name="9207"/> 9207:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9208"/> 9208:                            case socket:open(Domain, stream, tcp) of
<a name="9209"/> 9209:                                {ok, Sock} -&gt;
<a name="9210"/> 9210:                                    {ok, State#{sock =&gt; Sock}};
<a name="9211"/> 9211:                                {error, _} = ERROR -&gt;
<a name="9212"/> 9212:                                    ERROR
<a name="9213"/> 9213:                            end
<a name="9214"/> 9214:                    end},
<a name="9215"/> 9215:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="9216"/> 9216:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="9217"/> 9217:                            case sock_bind(Sock, LSA) of
<a name="9218"/> 9218:                                ok -&gt;
<a name="9219"/> 9219:                                    ok;
<a name="9220"/> 9220:                                {error, _} = ERROR -&gt;
<a name="9221"/> 9221:                                    ERROR
<a name="9222"/> 9222:                            end
<a name="9223"/> 9223:                    end},
<a name="9224"/> 9224:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9225"/> 9225:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9226"/> 9226:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="9227"/> 9227:                            ok
<a name="9228"/> 9228:                    end},
<a name="9229"/> 9229: 
<a name="9230"/> 9230:          %% *** The actual test ***
<a name="9231"/> 9231:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="9232"/> 9232:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9233"/> 9233:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="9234"/> 9234:                    end},
<a name="9235"/> 9235:          #{desc =&gt; &quot;connect to server&quot;,
<a name="9236"/> 9236:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="9237"/> 9237:                            socket:connect(Sock, SSA)
<a name="9238"/> 9238:                    end},
<a name="9239"/> 9239:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="9240"/> 9240:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9241"/> 9241:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="9242"/> 9242:                            ok
<a name="9243"/> 9243:                    end},
<a name="9244"/> 9244: 
<a name="9245"/> 9245:          %% *** Termination ***
<a name="9246"/> 9246:          #{desc =&gt; &quot;await terminate&quot;,
<a name="9247"/> 9247:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9248"/> 9248:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9249"/> 9249:                                ok -&gt;
<a name="9250"/> 9250:                                    {ok, maps:remove(tester, State)};
<a name="9251"/> 9251:                                {error, _} = ERROR -&gt;
<a name="9252"/> 9252:                                    ERROR
<a name="9253"/> 9253:                            end
<a name="9254"/> 9254:                    end},
<a name="9255"/> 9255:          #{desc =&gt; &quot;close socket&quot;,
<a name="9256"/> 9256:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="9257"/> 9257:                            socket:close(Sock)
<a name="9258"/> 9258:                    end},
<a name="9259"/> 9259: 
<a name="9260"/> 9260:          %% *** We are done ***
<a name="9261"/> 9261:          ?SEV_FINISH_NORMAL
<a name="9262"/> 9262:         ],
<a name="9263"/> 9263: 
<a name="9264"/> 9264:     TesterSeq =
<a name="9265"/> 9265:         [
<a name="9266"/> 9266:          %% *** Init part ***
<a name="9267"/> 9267:          #{desc =&gt; &quot;monitor server&quot;,
<a name="9268"/> 9268:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9269"/> 9269:                            _MRef = erlang:monitor(process, Pid),
<a name="9270"/> 9270:                            ok
<a name="9271"/> 9271:                    end},
<a name="9272"/> 9272:          #{desc =&gt; &quot;monitor client&quot;,
<a name="9273"/> 9273:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9274"/> 9274:                            _MRef = erlang:monitor(process, Pid),
<a name="9275"/> 9275:                            ok
<a name="9276"/> 9276:                    end},
<a name="9277"/> 9277: 
<a name="9278"/> 9278:          %% Start the server
<a name="9279"/> 9279:          #{desc =&gt; &quot;order server start&quot;,
<a name="9280"/> 9280:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9281"/> 9281:                            ?SEV_ANNOUNCE_START(Pid),
<a name="9282"/> 9282:                            ok
<a name="9283"/> 9283:                    end},
<a name="9284"/> 9284:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="9285"/> 9285:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9286"/> 9286:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="9287"/> 9287:                            {ok, State#{server_port =&gt; Port}}
<a name="9288"/> 9288:                    end},
<a name="9289"/> 9289: 
<a name="9290"/> 9290:          %% Start the client
<a name="9291"/> 9291:          #{desc =&gt; &quot;order client start&quot;,
<a name="9292"/> 9292:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="9293"/> 9293:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="9294"/> 9294:                            ok
<a name="9295"/> 9295:                    end},
<a name="9296"/> 9296:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="9297"/> 9297:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9298"/> 9298:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="9299"/> 9299:                    end},
<a name="9300"/> 9300: 
<a name="9301"/> 9301:          %% *** The actual test ***
<a name="9302"/> 9302:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="9303"/> 9303:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="9304"/> 9304:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="9305"/> 9305:                            ok
<a name="9306"/> 9306:                    end},
<a name="9307"/> 9307:          #{desc =&gt; &quot;order client to continue (connect)&quot;,
<a name="9308"/> 9308:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9309"/> 9309:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="9310"/> 9310:                            ok
<a name="9311"/> 9311:                    end},
<a name="9312"/> 9312:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="9313"/> 9313:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9314"/> 9314:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="9315"/> 9315:                    end},
<a name="9316"/> 9316:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="9317"/> 9317:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9318"/> 9318:                            ?SEV_AWAIT_READY(Pid, server, accept)
<a name="9319"/> 9319:                    end},
<a name="9320"/> 9320: 
<a name="9321"/> 9321:          #{desc =&gt; &quot;order server to continue (recv)&quot;,
<a name="9322"/> 9322:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9323"/> 9323:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9324"/> 9324:                            ok
<a name="9325"/> 9325:                    end},
<a name="9326"/> 9326:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="9327"/> 9327:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9328"/> 9328:                            ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="9329"/> 9329:                    end},
<a name="9330"/> 9330:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="9331"/> 9331:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9332"/> 9332:                            ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="9333"/> 9333:                    end},
<a name="9334"/> 9334:          #{desc =&gt; &quot;order server to continue (send request)&quot;,
<a name="9335"/> 9335:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9336"/> 9336:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="9337"/> 9337:                            ok
<a name="9338"/> 9338:                    end},
<a name="9339"/> 9339:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="9340"/> 9340:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9341"/> 9341:                            ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="9342"/> 9342:                    end},
<a name="9343"/> 9343: 
<a name="9344"/> 9344:          %% *** Termination ***
<a name="9345"/> 9345:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="9346"/> 9346:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="9347"/> 9347:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="9348"/> 9348:                            ok
<a name="9349"/> 9349:                    end},
<a name="9350"/> 9350:          #{desc =&gt; &quot;await client termination&quot;,
<a name="9351"/> 9351:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="9352"/> 9352:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="9353"/> 9353:                            State1 = maps:remove(client, State),
<a name="9354"/> 9354:                            {ok, State1}
<a name="9355"/> 9355:                    end},
<a name="9356"/> 9356:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="9357"/> 9357:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="9358"/> 9358:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="9359"/> 9359:                            ok
<a name="9360"/> 9360:                    end},
<a name="9361"/> 9361:          #{desc =&gt; &quot;await server termination&quot;,
<a name="9362"/> 9362:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="9363"/> 9363:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="9364"/> 9364:                            State1 = maps:remove(server, State),
<a name="9365"/> 9365:                            {ok, State1}
<a name="9366"/> 9366:                    end},
<a name="9367"/> 9367: 
<a name="9368"/> 9368:          %% *** We are done ***
<a name="9369"/> 9369:          ?SEV_FINISH_NORMAL
<a name="9370"/> 9370:         ],
<a name="9371"/> 9371: 
<a name="9372"/> 9372:     i(&quot;start server evaluator&quot;),
<a name="9373"/> 9373:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="9374"/> 9374: 
<a name="9375"/> 9375:     i(&quot;start client evaluator&quot;),
<a name="9376"/> 9376:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="9377"/> 9377: 
<a name="9378"/> 9378:     i(&quot;start tester evaluator&quot;),
<a name="9379"/> 9379:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="9380"/> 9380:                         client =&gt; Client#ev.pid},
<a name="9381"/> 9381:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="9382"/> 9382: 
<a name="9383"/> 9383:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_recv_cancel_tcp-last_expr"/><a name="9384"/> 9384: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="9385"/> 9385: 
<a name="9386"/> 9386: 
<a name="9387"/> 9387: 
<a name="9388"/> 9388: 
<a name="9389"/> 9389: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9390"/> 9390: 
<a name="9391"/> 9391: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvfrom</i>
<a name="9392"/> 9392: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="9393"/> 9393: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="9394"/> 9394: <i>%%</i>
<a name="api_a_mrecvfrom_cancel_udp4-1"/><a name="9395"/> 9395: <b>api_a_mrecvfrom_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="9396"/> 9396:     ?TT(?SECS(20)),
<a name="9397"/> 9397:     Nowait = nowait(Config),
<a name="api_a_mrecvfrom_cancel_udp4-last_expr"/><a name="9398"/> 9398: <b>    tc_try</b>(api_a_mrecvfrom_cancel_udp4,
<a name="9399"/> 9399:            fun() -&gt; has_support_ipv4() end,
<a name="9400"/> 9400:            fun() -&gt;
<a name="9401"/> 9401:                    Recv = fun(Sock) -&gt;
<a name="9402"/> 9402:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="9403"/> 9403:                                       {ok, _} = OK -&gt;
<a name="9404"/> 9404:                                           OK;
<a name="9405"/> 9405:                                       {select, _} = SELECT -&gt;
<a name="9406"/> 9406:                                           SELECT;
<a name="9407"/> 9407:                                       {completion, _} = COMPLETION -&gt;
<a name="9408"/> 9408:                                           COMPLETION;
<a name="9409"/> 9409:                                       {error, _} = ERROR -&gt;
<a name="9410"/> 9410:                                           ERROR
<a name="9411"/> 9411:                                   end
<a name="9412"/> 9412:                           end,
<a name="9413"/> 9413:                    InitState = #{domain   =&gt; inet,
<a name="9414"/> 9414:                                  recv     =&gt; Recv,
<a name="9415"/> 9415:                                  recv_ref =&gt; Nowait},
<a name="9416"/> 9416:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="9417"/> 9417:            end).
<a name="9418"/> 9418: 
<a name="9419"/> 9419: 
<a name="9420"/> 9420: 
<a name="9421"/> 9421: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9422"/> 9422: 
<a name="9423"/> 9423: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvfrom</i>
<a name="9424"/> 9424: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="9425"/> 9425: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="9426"/> 9426: <i>%%</i>
<a name="api_a_mrecvfrom_cancel_udp6-1"/><a name="9427"/> 9427: <b>api_a_mrecvfrom_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="9428"/> 9428:     ?TT(?SECS(20)),
<a name="9429"/> 9429:     Nowait = nowait(Config),
<a name="api_a_mrecvfrom_cancel_udp6-last_expr"/><a name="9430"/> 9430: <b>    tc_try</b>(api_a_mrecvfrom_cancel_udp6,
<a name="9431"/> 9431:            fun() -&gt; has_support_ipv6() end,
<a name="9432"/> 9432:            fun() -&gt;
<a name="9433"/> 9433:                    Recv = fun(Sock) -&gt;
<a name="9434"/> 9434:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="9435"/> 9435:                                       {ok, _} = OK -&gt;
<a name="9436"/> 9436:                                           OK;
<a name="9437"/> 9437:                                       {select, _} = SELECT -&gt;
<a name="9438"/> 9438:                                           SELECT;
<a name="9439"/> 9439:                                       {completion, _} = COMPLETION -&gt;
<a name="9440"/> 9440:                                           COMPLETION;
<a name="9441"/> 9441:                                       {error, _} = ERROR -&gt;
<a name="9442"/> 9442:                                           ERROR
<a name="9443"/> 9443:                                   end
<a name="9444"/> 9444:                           end,
<a name="9445"/> 9445:                    InitState = #{domain   =&gt; inet6,
<a name="9446"/> 9446:                                  recv     =&gt; Recv,
<a name="9447"/> 9447:                                  recv_ref =&gt; Nowait},
<a name="9448"/> 9448:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="9449"/> 9449:            end).
<a name="9450"/> 9450: 
<a name="9451"/> 9451: 
<a name="9452"/> 9452: 
<a name="9453"/> 9453: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9454"/> 9454: 
<a name="9455"/> 9455: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="9456"/> 9456: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="9457"/> 9457: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="9458"/> 9458: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_udp4-1"/><a name="9459"/> 9459: <b>api_a_mrecvmsg_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="9460"/> 9460:     ?TT(?SECS(20)),
<a name="9461"/> 9461:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_udp4-last_expr"/><a name="9462"/> 9462: <b>    tc_try</b>(api_a_mrecvmsg_cancel_udp4,
<a name="9463"/> 9463:            fun() -&gt; has_support_ipv4() end,
<a name="9464"/> 9464:            fun() -&gt;
<a name="9465"/> 9465:                    Recv = fun(Sock) -&gt;
<a name="9466"/> 9466:                                   case socket:recvmsg(Sock, Nowait) of
<a name="9467"/> 9467:                                       {ok, _} = OK -&gt;
<a name="9468"/> 9468:                                           OK;
<a name="9469"/> 9469:                                       {select, _} = SELECT -&gt;
<a name="9470"/> 9470:                                           SELECT;
<a name="9471"/> 9471:                                       {completion, _} = COMPLETION -&gt;
<a name="9472"/> 9472:                                           COMPLETION;
<a name="9473"/> 9473:                                       {error, _} = ERROR -&gt;
<a name="9474"/> 9474:                                           ERROR
<a name="9475"/> 9475:                                   end
<a name="9476"/> 9476:                           end,
<a name="9477"/> 9477:                    InitState = #{domain   =&gt; inet,
<a name="9478"/> 9478:                                  recv     =&gt; Recv,
<a name="9479"/> 9479:                                  recv_ref =&gt; Nowait},
<a name="9480"/> 9480:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="9481"/> 9481:            end).
<a name="9482"/> 9482: 
<a name="9483"/> 9483: 
<a name="9484"/> 9484: 
<a name="9485"/> 9485: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9486"/> 9486: 
<a name="9487"/> 9487: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="9488"/> 9488: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="9489"/> 9489: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="9490"/> 9490: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_udp6-1"/><a name="9491"/> 9491: <b>api_a_mrecvmsg_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="9492"/> 9492:     ?TT(?SECS(20)),
<a name="9493"/> 9493:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_udp6-last_expr"/><a name="9494"/> 9494: <b>    tc_try</b>(api_a_mrecvmsg_cancel_udp6,
<a name="9495"/> 9495:            fun() -&gt; has_support_ipv6() end,
<a name="9496"/> 9496:            fun() -&gt;
<a name="9497"/> 9497:                    Recv = fun(Sock) -&gt;
<a name="9498"/> 9498:                                   case socket:recvmsg(Sock, Nowait) of
<a name="9499"/> 9499:                                       {ok, _} = OK -&gt;
<a name="9500"/> 9500:                                           OK;
<a name="9501"/> 9501:                                       {select, _} = SELECT -&gt;
<a name="9502"/> 9502:                                           SELECT;
<a name="9503"/> 9503:                                       {completion, _} = COMPLETION -&gt;
<a name="9504"/> 9504:                                           COMPLETION;
<a name="9505"/> 9505:                                       {error, _} = ERROR -&gt;
<a name="9506"/> 9506:                                           ERROR
<a name="9507"/> 9507:                                   end
<a name="9508"/> 9508:                           end,
<a name="9509"/> 9509:                    InitState = #{domain   =&gt; inet6,
<a name="9510"/> 9510:                                  recv     =&gt; Recv,
<a name="9511"/> 9511:                                  recv_ref =&gt; Nowait},
<a name="9512"/> 9512:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="9513"/> 9513:            end).
<a name="9514"/> 9514: 
<a name="9515"/> 9515: 
<a name="9516"/> 9516: 
<a name="9517"/> 9517: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9518"/> 9518: 
<a name="api_a_mrecv_cancel_udp-1"/><a name="9519"/> 9519: <b>api_a_mrecv_cancel_udp</b>(InitState) -&gt;
<a name="9520"/> 9520:     ServerSeq = 
<a name="9521"/> 9521:         [
<a name="9522"/> 9522:          %% *** Wait for start order part ***
<a name="9523"/> 9523:          #{desc =&gt; &quot;await start&quot;,
<a name="9524"/> 9524:            cmd  =&gt; fun(State) -&gt;
<a name="9525"/> 9525:                            Tester = ?SEV_AWAIT_START(),
<a name="9526"/> 9526:                            {ok, State#{tester =&gt; Tester}}
<a name="9527"/> 9527:                    end},
<a name="9528"/> 9528:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9529"/> 9529:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9530"/> 9530:                            _MRef = erlang:monitor(process, Tester),
<a name="9531"/> 9531:                            ok
<a name="9532"/> 9532:                    end},
<a name="9533"/> 9533: 
<a name="9534"/> 9534:          %% *** Init part ***
<a name="9535"/> 9535:          #{desc =&gt; &quot;which local address&quot;,
<a name="9536"/> 9536:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9537"/> 9537:                            LSA = which_local_socket_addr(Domain),
<a name="9538"/> 9538:                            {ok, State#{local_sa =&gt; LSA}}
<a name="9539"/> 9539:                    end},
<a name="9540"/> 9540:          #{desc =&gt; &quot;create socket&quot;,
<a name="9541"/> 9541:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9542"/> 9542:                            case socket:open(Domain, dgram, udp) of
<a name="9543"/> 9543:                                {ok, Sock} -&gt;
<a name="9544"/> 9544:                                    {ok, State#{sock =&gt; Sock}};
<a name="9545"/> 9545:                                {error, _} = ERROR -&gt;
<a name="9546"/> 9546:                                    ERROR
<a name="9547"/> 9547:                            end
<a name="9548"/> 9548:                    end},
<a name="9549"/> 9549:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="9550"/> 9550:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="9551"/> 9551:                            case sock_bind(Sock, LSA) of
<a name="9552"/> 9552:                                ok -&gt;
<a name="9553"/> 9553:                                    Port = sock_port(Sock),
<a name="9554"/> 9554:                                    {ok, State#{port =&gt; Port}};
<a name="9555"/> 9555:                                {error, _} = ERROR -&gt;
<a name="9556"/> 9556:                                    ERROR
<a name="9557"/> 9557:                            end
<a name="9558"/> 9558:                    end},
<a name="9559"/> 9559:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9560"/> 9560:            cmd  =&gt; fun(#{tester := Tester, sock := Sock}) -&gt;
<a name="9561"/> 9561:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="9562"/> 9562:                            ok
<a name="9563"/> 9563:                    end},
<a name="9564"/> 9564: 
<a name="9565"/> 9565:          %% The actual test
<a name="9566"/> 9566:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="9567"/> 9567:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9568"/> 9568:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="9569"/> 9569:                    end},
<a name="9570"/> 9570:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="9571"/> 9571:            cmd  =&gt; fun(#{sock     := Sock,
<a name="9572"/> 9572:                          recv     := Recv,
<a name="9573"/> 9573:                          recv_ref := Ref} = State) -&gt;
<a name="9574"/> 9574:                            case Recv(Sock) of
<a name="9575"/> 9575:                                {select, SI}
<a name="9576"/> 9576:                                  when Ref =:= nowait -&gt;
<a name="9577"/> 9577:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9578"/> 9578:                                {select, {select_info, _Tag, Ref} = SI}
<a name="9579"/> 9579:                                  when is_reference(Ref) -&gt;
<a name="9580"/> 9580:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9581"/> 9581: 
<a name="9582"/> 9582:                                {completion, CI}
<a name="9583"/> 9583:                                  when Ref =:= nowait -&gt;
<a name="9584"/> 9584:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9585"/> 9585:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="9586"/> 9586:                                  when is_reference(Ref) -&gt;
<a name="9587"/> 9587:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9588"/> 9588: 
<a name="9589"/> 9589:                                {ok, X} -&gt;
<a name="9590"/> 9590:                                    {error, {unexpected_success, X}};
<a name="9591"/> 9591: 
<a name="9592"/> 9592:                                {error, _} = ERROR -&gt;
<a name="9593"/> 9593:                                    ERROR
<a name="9594"/> 9594:                            end
<a name="9595"/> 9595:                    end},
<a name="9596"/> 9596:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="9597"/> 9597:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9598"/> 9598:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="9599"/> 9599:                            ok
<a name="9600"/> 9600:                    end},
<a name="9601"/> 9601:          #{desc =&gt; &quot;await abort message&quot;,
<a name="9602"/> 9602:            cmd  =&gt; fun(#{sock             := Sock,
<a name="9603"/> 9603:                          recv_select_info := {select_info, _, Ref}} =
<a name="9604"/> 9604:                            State) -&gt;
<a name="9605"/> 9605:                            receive
<a name="9606"/> 9606:                                {'$socket', Sock, select, Ref} -&gt;
<a name="9607"/> 9607:                                    {error, {unexpected_select, Ref}};
<a name="9608"/> 9608:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="9609"/> 9609:                                    {ok, maps:remove(sock, State)}
<a name="9610"/> 9610:                            after 5000 -&gt;
<a name="9611"/> 9611:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="9612"/> 9612:                                    {error, timeout}
<a name="9613"/> 9613:                            end;
<a name="9614"/> 9614:                       (#{sock                 := Sock,
<a name="9615"/> 9615:                          recv_completion_info := {completion_info, _, Ref}} = 
<a name="9616"/> 9616:                            State) -&gt;
<a name="9617"/> 9617:                            receive
<a name="9618"/> 9618:                                {'$socket', Sock, completion, {Ref, CS}} -&gt;
<a name="9619"/> 9619:                                    {error, {unexpected_completion, CS}};
<a name="9620"/> 9620:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="9621"/> 9621:                                    {ok, maps:remove(sock, State)}
<a name="9622"/> 9622:                            after 5000 -&gt;
<a name="9623"/> 9623:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="9624"/> 9624:                                    {error, timeout}
<a name="9625"/> 9625:                            end
<a name="9626"/> 9626:                    end},
<a name="9627"/> 9627:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="9628"/> 9628:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9629"/> 9629:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="9630"/> 9630:                            ok
<a name="9631"/> 9631:                    end},
<a name="9632"/> 9632: 
<a name="9633"/> 9633:          %% Termination
<a name="9634"/> 9634:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="9635"/> 9635:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9636"/> 9636:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9637"/> 9637:                                ok -&gt;
<a name="9638"/> 9638:                                    State2 = maps:remove(tester,   State),
<a name="9639"/> 9639:                                    State3 = maps:remove(recv_ref, State2),
<a name="9640"/> 9640:                                    {ok, State3};
<a name="9641"/> 9641:                                {error, _} = ERROR -&gt;
<a name="9642"/> 9642:                                    ERROR
<a name="9643"/> 9643:                            end
<a name="9644"/> 9644:                    end},
<a name="9645"/> 9645: 
<a name="9646"/> 9646:          %% *** We are done ***
<a name="9647"/> 9647:          ?SEV_FINISH_NORMAL
<a name="9648"/> 9648:         ],
<a name="9649"/> 9649: 
<a name="9650"/> 9650: 
<a name="9651"/> 9651:     AltServerSeq = 
<a name="9652"/> 9652:         [
<a name="9653"/> 9653:          %% *** Wait for start order part ***
<a name="9654"/> 9654:          #{desc =&gt; &quot;await start&quot;,
<a name="9655"/> 9655:            cmd  =&gt; fun(State) -&gt;
<a name="9656"/> 9656:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="9657"/> 9657:                            {ok, State#{tester =&gt; Tester, sock =&gt; Sock}}
<a name="9658"/> 9658:                    end},
<a name="9659"/> 9659:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9660"/> 9660:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9661"/> 9661:                            _MRef = erlang:monitor(process, Tester),
<a name="9662"/> 9662:                            ok
<a name="9663"/> 9663:                    end},
<a name="9664"/> 9664:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9665"/> 9665:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9666"/> 9666:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="9667"/> 9667:                            ok
<a name="9668"/> 9668:                    end},
<a name="9669"/> 9669: 
<a name="9670"/> 9670:          %% The actual test
<a name="9671"/> 9671:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="9672"/> 9672:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9673"/> 9673:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="9674"/> 9674:                    end},
<a name="9675"/> 9675:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="9676"/> 9676:            cmd  =&gt; fun(#{sock     := Sock,
<a name="9677"/> 9677:                          recv     := Recv,
<a name="9678"/> 9678:                          recv_ref := Ref} = State) -&gt;
<a name="9679"/> 9679:                            case Recv(Sock) of
<a name="9680"/> 9680:                                {select, SI} when Ref =:= nowait -&gt;
<a name="9681"/> 9681:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9682"/> 9682:                                {select,
<a name="9683"/> 9683:                                 {select_info, _Tag, Ref} = SI}
<a name="9684"/> 9684:                                  when is_reference(Ref) -&gt;
<a name="9685"/> 9685:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9686"/> 9686: 
<a name="9687"/> 9687:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="9688"/> 9688:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9689"/> 9689:                                {completion,
<a name="9690"/> 9690:                                 {completion_info, _Tag, Ref} = CI}
<a name="9691"/> 9691:                                  when is_reference(Ref) -&gt;
<a name="9692"/> 9692:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9693"/> 9693: 
<a name="9694"/> 9694:                                {ok, X} -&gt;
<a name="9695"/> 9695:                                    {error, {unexpected_success, X}};
<a name="9696"/> 9696: 
<a name="9697"/> 9697:                                {error, _} = ERROR -&gt;
<a name="9698"/> 9698:                                    ERROR
<a name="9699"/> 9699:                            end
<a name="9700"/> 9700:                    end},
<a name="9701"/> 9701:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="9702"/> 9702:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9703"/> 9703:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="9704"/> 9704:                            ok
<a name="9705"/> 9705:                    end},
<a name="9706"/> 9706:          #{desc =&gt; &quot;await abort message&quot;,
<a name="9707"/> 9707:            cmd  =&gt; fun(#{sock             := Sock,
<a name="9708"/> 9708:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="9709"/> 9709:                            receive
<a name="9710"/> 9710:                                {'$socket', Sock, select, Ref} -&gt;
<a name="9711"/> 9711:                                    {error, {unexpected_select, Ref}};
<a name="9712"/> 9712:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="9713"/> 9713:                                    {ok, maps:remove(sock, State)}
<a name="9714"/> 9714:                            after 5000 -&gt;
<a name="9715"/> 9715:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="9716"/> 9716:                                    {error, timeout}
<a name="9717"/> 9717:                            end;
<a name="9718"/> 9718: 
<a name="9719"/> 9719:                       (#{sock                 := Sock,
<a name="9720"/> 9720:                          recv_completion_info := {completion_info, _, Ref}} =
<a name="9721"/> 9721:                            State) -&gt;
<a name="9722"/> 9722:                            receive
<a name="9723"/> 9723:                                {'$socket', Sock, completion, {Ref, CS}} -&gt;
<a name="9724"/> 9724:                                    {error, {unexpected_completion, CS}};
<a name="9725"/> 9725:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="9726"/> 9726:                                    {ok, maps:remove(sock, State)}
<a name="9727"/> 9727:                            after 5000 -&gt;
<a name="9728"/> 9728:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="9729"/> 9729:                                    {error, timeout}
<a name="9730"/> 9730:                            end
<a name="9731"/> 9731:                    end},
<a name="9732"/> 9732:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="9733"/> 9733:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9734"/> 9734:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="9735"/> 9735:                            ok
<a name="9736"/> 9736:                    end},
<a name="9737"/> 9737: 
<a name="9738"/> 9738:          %% Termination
<a name="9739"/> 9739:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="9740"/> 9740:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9741"/> 9741:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9742"/> 9742:                                ok -&gt;
<a name="9743"/> 9743:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="9744"/> 9744:                                    State1 = maps:remove(recv_select_info, State),
<a name="9745"/> 9745:                                    State2 = maps:remove(recv_completion_info, State1),
<a name="9746"/> 9746:                                    State3 = maps:remove(tester,           State2),
<a name="9747"/> 9747:                                    State4 = maps:remove(sock,             State3),
<a name="9748"/> 9748:                                    {ok, State4};
<a name="9749"/> 9749:                                {error, _} = ERROR -&gt;
<a name="9750"/> 9750:                                    ERROR
<a name="9751"/> 9751:                            end
<a name="9752"/> 9752:                    end},
<a name="9753"/> 9753: 
<a name="9754"/> 9754:          %% *** We are done ***
<a name="9755"/> 9755:          ?SEV_FINISH_NORMAL
<a name="9756"/> 9756:         ],
<a name="9757"/> 9757: 
<a name="9758"/> 9758: 
<a name="9759"/> 9759: 
<a name="9760"/> 9760:     TesterSeq = 
<a name="9761"/> 9761:         [
<a name="9762"/> 9762:          %% *** Init part ***
<a name="9763"/> 9763:          #{desc =&gt; &quot;monitor server&quot;,
<a name="9764"/> 9764:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9765"/> 9765:                            _MRef = erlang:monitor(process, Pid),
<a name="9766"/> 9766:                            ok
<a name="9767"/> 9767:                    end},
<a name="9768"/> 9768:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="9769"/> 9769:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9770"/> 9770:                            _MRef = erlang:monitor(process, Pid),
<a name="9771"/> 9771:                            ok
<a name="9772"/> 9772:                    end},
<a name="9773"/> 9773:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="9774"/> 9774:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9775"/> 9775:                            _MRef = erlang:monitor(process, Pid),
<a name="9776"/> 9776:                            ok
<a name="9777"/> 9777:                    end},
<a name="9778"/> 9778: 
<a name="9779"/> 9779:          %% Start the server
<a name="9780"/> 9780:          #{desc =&gt; &quot;order server start&quot;,
<a name="9781"/> 9781:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9782"/> 9782:                            ?SEV_ANNOUNCE_START(Pid),
<a name="9783"/> 9783:                            ok
<a name="9784"/> 9784:                    end},
<a name="9785"/> 9785:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="9786"/> 9786:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9787"/> 9787:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="9788"/> 9788:                            {ok, State#{sock =&gt; Sock}}
<a name="9789"/> 9789:                    end},
<a name="9790"/> 9790: 
<a name="9791"/> 9791:          %% Start the alt-server 1
<a name="9792"/> 9792:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="9793"/> 9793:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="9794"/> 9794:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="9795"/> 9795:                            ok
<a name="9796"/> 9796:                    end},
<a name="9797"/> 9797:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="9798"/> 9798:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9799"/> 9799:                            ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="9800"/> 9800:                    end},
<a name="9801"/> 9801: 
<a name="9802"/> 9802:          %% Start the alt-server 2
<a name="9803"/> 9803:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="9804"/> 9804:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="9805"/> 9805:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="9806"/> 9806:                            ok
<a name="9807"/> 9807:                    end},
<a name="9808"/> 9808:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="9809"/> 9809:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9810"/> 9810:                            ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="9811"/> 9811:                    end},
<a name="9812"/> 9812: 
<a name="9813"/> 9813: 
<a name="9814"/> 9814:          %% The actual test
<a name="9815"/> 9815:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="9816"/> 9816:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9817"/> 9817:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9818"/> 9818:                            ok
<a name="9819"/> 9819:                    end},
<a name="9820"/> 9820:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="9821"/> 9821:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9822"/> 9822:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="9823"/> 9823:                    end},
<a name="9824"/> 9824: 
<a name="9825"/> 9825:          #{desc =&gt; &quot;order alt-server 1 continue (recv)&quot;,
<a name="9826"/> 9826:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9827"/> 9827:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9828"/> 9828:                            ok
<a name="9829"/> 9829:                    end},
<a name="9830"/> 9830:          #{desc =&gt; &quot;await alt-server 1 ready (recv select)&quot;,
<a name="9831"/> 9831:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9832"/> 9832:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, recv_select)
<a name="9833"/> 9833:                    end},
<a name="9834"/> 9834: 
<a name="9835"/> 9835:          #{desc =&gt; &quot;order alt-server 2 continue (recv)&quot;,
<a name="9836"/> 9836:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9837"/> 9837:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9838"/> 9838:                            ok
<a name="9839"/> 9839:                    end},
<a name="9840"/> 9840:          #{desc =&gt; &quot;await alt-server 2 ready (recv select)&quot;,
<a name="9841"/> 9841:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9842"/> 9842:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, recv_select)
<a name="9843"/> 9843:                    end},
<a name="9844"/> 9844: 
<a name="9845"/> 9845:          ?SEV_SLEEP(?SECS(1)),
<a name="9846"/> 9846: 
<a name="9847"/> 9847:          #{desc =&gt; &quot;close the socket&quot;,
<a name="9848"/> 9848:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="9849"/> 9849:                            socket:close(Sock)
<a name="9850"/> 9850:                    end},
<a name="9851"/> 9851: 
<a name="9852"/> 9852:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="9853"/> 9853:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9854"/> 9854:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="9855"/> 9855:                    end},
<a name="9856"/> 9856:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="9857"/> 9857:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9858"/> 9858:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="9859"/> 9859:                    end},
<a name="9860"/> 9860:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="9861"/> 9861:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9862"/> 9862:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="9863"/> 9863:                    end},
<a name="9864"/> 9864: 
<a name="9865"/> 9865:          %% Terminations
<a name="9866"/> 9866:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="9867"/> 9867:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9868"/> 9868:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="9869"/> 9869:                            ok
<a name="9870"/> 9870:                    end},
<a name="9871"/> 9871:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="9872"/> 9872:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="9873"/> 9873:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="9874"/> 9874:                                ok -&gt;
<a name="9875"/> 9875:                                    State1 = maps:remove(alt_server2, State),
<a name="9876"/> 9876:                                    {ok, State1};
<a name="9877"/> 9877:                                {error, _} = ERROR -&gt;
<a name="9878"/> 9878:                                    ERROR
<a name="9879"/> 9879:                            end
<a name="9880"/> 9880:                    end},
<a name="9881"/> 9881: 
<a name="9882"/> 9882:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="9883"/> 9883:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9884"/> 9884:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="9885"/> 9885:                            ok
<a name="9886"/> 9886:                    end},
<a name="9887"/> 9887:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="9888"/> 9888:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="9889"/> 9889:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="9890"/> 9890:                                ok -&gt;
<a name="9891"/> 9891:                                    State1 = maps:remove(alt_server1, State),
<a name="9892"/> 9892:                                    {ok, State1};
<a name="9893"/> 9893:                                {error, _} = ERROR -&gt;
<a name="9894"/> 9894:                                    ERROR
<a name="9895"/> 9895:                            end
<a name="9896"/> 9896:                    end},
<a name="9897"/> 9897: 
<a name="9898"/> 9898:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="9899"/> 9899:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9900"/> 9900:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="9901"/> 9901:                            ok
<a name="9902"/> 9902:                    end},
<a name="9903"/> 9903:          #{desc =&gt; &quot;await server termination&quot;,
<a name="9904"/> 9904:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9905"/> 9905:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="9906"/> 9906:                                ok -&gt;
<a name="9907"/> 9907:                                    State1 = maps:remove(server, State),
<a name="9908"/> 9908:                                    {ok, State1};
<a name="9909"/> 9909:                                {error, _} = ERROR -&gt;
<a name="9910"/> 9910:                                    ERROR
<a name="9911"/> 9911:                            end
<a name="9912"/> 9912:                    end},
<a name="9913"/> 9913: 
<a name="9914"/> 9914: 
<a name="9915"/> 9915:          %% *** We are done ***
<a name="9916"/> 9916:          ?SEV_FINISH_NORMAL
<a name="9917"/> 9917:         ],
<a name="9918"/> 9918: 
<a name="9919"/> 9919:     i(&quot;start server evaluator&quot;),
<a name="9920"/> 9920:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="9921"/> 9921: 
<a name="9922"/> 9922:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="9923"/> 9923:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="9924"/> 9924: 
<a name="9925"/> 9925:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="9926"/> 9926:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="9927"/> 9927: 
<a name="9928"/> 9928:     i(&quot;start 'tester' evaluator&quot;),
<a name="9929"/> 9929:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="9930"/> 9930:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="9931"/> 9931:                         alt_server2 =&gt; AltServer2#ev.pid},
<a name="9932"/> 9932:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="9933"/> 9933: 
<a name="9934"/> 9934:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_mrecv_cancel_udp-last_expr"/><a name="9935"/> 9935: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Tester]).
<a name="9936"/> 9936: 
<a name="9937"/> 9937: 
<a name="9938"/> 9938: 
<a name="9939"/> 9939: 
<a name="9940"/> 9940: 
<a name="9941"/> 9941: 
<a name="9942"/> 9942: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9943"/> 9943: 
<a name="9944"/> 9944: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to accept</i>
<a name="9945"/> 9945: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="9946"/> 9946: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="9947"/> 9947: <i>%%</i>
<a name="api_a_maccept_cancel_tcp4-1"/><a name="9948"/> 9948: <b>api_a_maccept_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="9949"/> 9949:     ?TT(?SECS(20)),
<a name="9950"/> 9950:     Nowait = nowait(Config),
<a name="api_a_maccept_cancel_tcp4-last_expr"/><a name="9951"/> 9951: <b>    tc_try</b>(api_a_maccept_cancel_tcp4,
<a name="9952"/> 9952:            fun() -&gt; has_support_ipv4() end,
<a name="9953"/> 9953:            fun() -&gt;
<a name="9954"/> 9954:                    Accept = fun(Sock) -&gt;
<a name="9955"/> 9955:                                     case socket:accept(Sock, Nowait) of
<a name="9956"/> 9956:                                         {ok, _} = OK -&gt;
<a name="9957"/> 9957:                                             OK;
<a name="9958"/> 9958:                                         {select, _} = SELECT -&gt;
<a name="9959"/> 9959:                                             SELECT;
<a name="9960"/> 9960:                                         {completion, _} = COMPLETION -&gt;
<a name="9961"/> 9961:                                             COMPLETION;
<a name="9962"/> 9962:                                         {error, _} = ERROR -&gt;
<a name="9963"/> 9963:                                             ERROR
<a name="9964"/> 9964:                                     end
<a name="9965"/> 9965:                             end,
<a name="9966"/> 9966:                    InitState = #{domain     =&gt; inet,
<a name="9967"/> 9967:                                  accept     =&gt; Accept,
<a name="9968"/> 9968:                                  accept_ref =&gt; Nowait},
<a name="9969"/> 9969:                    ok = api_a_maccept_cancel_tcp(InitState)
<a name="9970"/> 9970:            end).
<a name="9971"/> 9971: 
<a name="9972"/> 9972: 
<a name="9973"/> 9973: 
<a name="9974"/> 9974: 
<a name="9975"/> 9975: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9976"/> 9976: 
<a name="9977"/> 9977: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to accept</i>
<a name="9978"/> 9978: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="9979"/> 9979: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="9980"/> 9980: <i>%%</i>
<a name="api_a_maccept_cancel_tcp6-1"/><a name="9981"/> 9981: <b>api_a_maccept_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="9982"/> 9982:     ?TT(?SECS(20)),
<a name="9983"/> 9983:     Nowait = nowait(Config),
<a name="api_a_maccept_cancel_tcp6-last_expr"/><a name="9984"/> 9984: <b>    tc_try</b>(api_a_maccept_cancel_tcp6,
<a name="9985"/> 9985:            fun() -&gt; has_support_ipv6() end,
<a name="9986"/> 9986:            fun() -&gt;
<a name="9987"/> 9987:                    Accept = fun(Sock) -&gt;
<a name="9988"/> 9988:                                     case socket:accept(Sock, Nowait) of
<a name="9989"/> 9989:                                         {ok, _} = OK -&gt;
<a name="9990"/> 9990:                                             OK;
<a name="9991"/> 9991:                                         {select, _} = SELECT -&gt;
<a name="9992"/> 9992:                                             SELECT;
<a name="9993"/> 9993:                                         {completion, _} = COMPLETION -&gt;
<a name="9994"/> 9994:                                             COMPLETION;
<a name="9995"/> 9995:                                         {error, _} = ERROR -&gt;
<a name="9996"/> 9996:                                             ERROR
<a name="9997"/> 9997:                                     end
<a name="9998"/> 9998:                             end,
<a name="9999"/> 9999:                    InitState = #{domain     =&gt; inet6,
<a name="10000"/>10000:                                  accept     =&gt; Accept,
<a name="10001"/>10001:                                  accept_ref =&gt; Nowait},
<a name="10002"/>10002:                    ok = api_a_maccept_cancel_tcp(InitState)
<a name="10003"/>10003:            end).
<a name="10004"/>10004: 
<a name="10005"/>10005: 
<a name="10006"/>10006: 
<a name="10007"/>10007: 
<a name="10008"/>10008: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10009"/>10009: 
<a name="api_a_maccept_cancel_tcp-1"/><a name="10010"/>10010: <b>api_a_maccept_cancel_tcp</b>(InitState) -&gt;
<a name="10011"/>10011:     process_flag(trap_exit, true),
<a name="10012"/>10012:     ServerSeq = 
<a name="10013"/>10013:         [
<a name="10014"/>10014:          %% *** Wait for start order ***
<a name="10015"/>10015:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="10016"/>10016:            cmd  =&gt; fun(State) -&gt;
<a name="10017"/>10017:                            Tester = ?SEV_AWAIT_START(),
<a name="10018"/>10018:                            {ok, State#{tester =&gt; Tester}}
<a name="10019"/>10019:                    end},
<a name="10020"/>10020:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10021"/>10021:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10022"/>10022:                            _MRef = erlang:monitor(process, Tester),
<a name="10023"/>10023:                            ok
<a name="10024"/>10024:                    end},
<a name="10025"/>10025: 
<a name="10026"/>10026:          %% *** Init part ***
<a name="10027"/>10027:          #{desc =&gt; &quot;which local address&quot;,
<a name="10028"/>10028:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10029"/>10029:                            LSA = which_local_socket_addr(Domain),
<a name="10030"/>10030:                            {ok, State#{lsa =&gt; LSA}}
<a name="10031"/>10031:                    end},
<a name="10032"/>10032:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="10033"/>10033:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10034"/>10034:                            case socket:open(Domain, stream, tcp) of
<a name="10035"/>10035:                                {ok, Sock} -&gt;
<a name="10036"/>10036:                                    {ok, State#{lsock =&gt; Sock}};
<a name="10037"/>10037:                                {error, _} = ERROR -&gt;
<a name="10038"/>10038:                                    ERROR
<a name="10039"/>10039:                            end
<a name="10040"/>10040:                    end},
<a name="10041"/>10041:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="10042"/>10042:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="10043"/>10043:                            case sock_bind(LSock, LSA) of
<a name="10044"/>10044:                                ok -&gt;
<a name="10045"/>10045:                                    Port = sock_port(LSock),
<a name="10046"/>10046:                                    {ok, State#{lport =&gt; Port}};
<a name="10047"/>10047:                                {error, _} = ERROR -&gt;
<a name="10048"/>10048:                                    ERROR
<a name="10049"/>10049:                            end
<a name="10050"/>10050:                    end},
<a name="10051"/>10051:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="10052"/>10052:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="10053"/>10053:                            socket:listen(LSock)
<a name="10054"/>10054:                    end},
<a name="10055"/>10055:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10056"/>10056:            cmd  =&gt; fun(#{tester := Tester, lsock := Sock}) -&gt;
<a name="10057"/>10057:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="10058"/>10058:                            ok
<a name="10059"/>10059:                    end},
<a name="10060"/>10060: 
<a name="10061"/>10061:          %% The actual test
<a name="10062"/>10062:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="10063"/>10063:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10064"/>10064:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="10065"/>10065:                    end},
<a name="10066"/>10066:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="10067"/>10067:            cmd  =&gt; fun(#{lsock      := LSock,
<a name="10068"/>10068:                          accept     := Accept,
<a name="10069"/>10069:                          accept_ref := Ref} = State) -&gt;
<a name="10070"/>10070:                            case Accept(LSock) of
<a name="10071"/>10071:                                {select, {select_info, T, R} = SI}
<a name="10072"/>10072:                                  when Ref =:= nowait -&gt;
<a name="10073"/>10073:                                    ?SEV_IPRINT(&quot;accept select nowait: &quot;
<a name="10074"/>10074:                                                &quot;~n   T: ~p&quot;
<a name="10075"/>10075:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="10076"/>10076:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="10077"/>10077:                                {select, {select_info, T, Ref} = SI}
<a name="10078"/>10078:                                  when is_reference(Ref) -&gt;
<a name="10079"/>10079:                                    ?SEV_IPRINT(&quot;accept select ref: &quot;
<a name="10080"/>10080:                                                &quot;~n   T: ~p&quot;
<a name="10081"/>10081:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="10082"/>10082:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="10083"/>10083: 
<a name="10084"/>10084:                                {completion, {completion_info, T, R} = CI}
<a name="10085"/>10085:                                  when Ref =:= nowait -&gt;
<a name="10086"/>10086:                                    ?SEV_IPRINT(&quot;accept completion nowait: &quot;
<a name="10087"/>10087:                                                &quot;~n   T: ~p&quot;
<a name="10088"/>10088:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="10089"/>10089:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="10090"/>10090:                                {completion, {completion_info, T, Ref} = CI}
<a name="10091"/>10091:                                  when is_reference(Ref) -&gt;
<a name="10092"/>10092:                                    ?SEV_IPRINT(&quot;accept completion ref: &quot;
<a name="10093"/>10093:                                                &quot;~n   T: ~p&quot;
<a name="10094"/>10094:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="10095"/>10095:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="10096"/>10096: 
<a name="10097"/>10097:                                {ok, X} -&gt;
<a name="10098"/>10098:                                    {error, {unexpected_success, X}};
<a name="10099"/>10099: 
<a name="10100"/>10100:                                {error, _} = ERROR -&gt;
<a name="10101"/>10101:                                    ERROR
<a name="10102"/>10102:                            end
<a name="10103"/>10103:                    end},
<a name="10104"/>10104:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="10105"/>10105:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10106"/>10106:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="10107"/>10107:                            ok
<a name="10108"/>10108:                    end},
<a name="10109"/>10109:          #{desc =&gt; &quot;await select message (without success)&quot;,
<a name="10110"/>10110:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="10111"/>10111:                          accept_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10112"/>10112:                            receive
<a name="10113"/>10113:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10114"/>10114:                                    {error, {unexpected_select, Ref}};
<a name="10115"/>10115:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10116"/>10116:                                    {ok, maps:remove(lsock, State)}
<a name="10117"/>10117:                            after 5000 -&gt;
<a name="10118"/>10118:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="10119"/>10119:                                                &quot;~n   Sock:          ~p&quot;
<a name="10120"/>10120:                                                &quot;~n   Ref:           ~p&quot;
<a name="10121"/>10121:                                                &quot;~n   message queue: ~p&quot;,
<a name="10122"/>10122:                                                [Sock, Ref, ?MQ()]),
<a name="10123"/>10123:                                    {error, timeout}
<a name="10124"/>10124:                            end;
<a name="10125"/>10125:                       (#{lsock                  := Sock,
<a name="10126"/>10126:                          accept_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="10127"/>10127:                            receive
<a name="10128"/>10128:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="10129"/>10129:                                    {error, {unexpected_completion, C}};
<a name="10130"/>10130:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10131"/>10131:                                    {ok, maps:remove(lsock, State)}
<a name="10132"/>10132:                            after 5000 -&gt;
<a name="10133"/>10133:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="10134"/>10134:                                                &quot;~n   Sock:          ~p&quot;
<a name="10135"/>10135:                                                &quot;~n   Ref:           ~p&quot;
<a name="10136"/>10136:                                                &quot;~n   message queue: ~p&quot;,
<a name="10137"/>10137:                                                [Sock, Ref, ?MQ()]),
<a name="10138"/>10138:                                    {error, timeout}
<a name="10139"/>10139:                            end
<a name="10140"/>10140:                    end},
<a name="10141"/>10141:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10142"/>10142:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10143"/>10143:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10144"/>10144:                            ok
<a name="10145"/>10145:                    end},
<a name="10146"/>10146: 
<a name="10147"/>10147:          %% *** Termination ***
<a name="10148"/>10148:          #{desc =&gt; &quot;await terminate&quot;,
<a name="10149"/>10149:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10150"/>10150:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10151"/>10151:                                ok -&gt;
<a name="10152"/>10152:                                    {ok, maps:remove(tester, State)};
<a name="10153"/>10153:                                {error, _} = ERROR -&gt;
<a name="10154"/>10154:                                    ERROR
<a name="10155"/>10155:                            end
<a name="10156"/>10156:                    end},
<a name="10157"/>10157: 
<a name="10158"/>10158:          %% *** We are done ***
<a name="10159"/>10159:          ?SEV_FINISH_NORMAL
<a name="10160"/>10160:         ],
<a name="10161"/>10161: 
<a name="10162"/>10162: 
<a name="10163"/>10163:     AltServerSeq =
<a name="10164"/>10164:         [
<a name="10165"/>10165:          %% *** Wait for start order part ***
<a name="10166"/>10166:          #{desc =&gt; &quot;await start&quot;,
<a name="10167"/>10167:            cmd  =&gt; fun(State) -&gt;
<a name="10168"/>10168:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="10169"/>10169:                            {ok, State#{tester =&gt; Tester, lsock =&gt; Sock}}
<a name="10170"/>10170:                    end},
<a name="10171"/>10171:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10172"/>10172:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10173"/>10173:                            _MRef = erlang:monitor(process, Tester),
<a name="10174"/>10174:                            ok
<a name="10175"/>10175:                    end},
<a name="10176"/>10176:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10177"/>10177:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10178"/>10178:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="10179"/>10179:                            ok
<a name="10180"/>10180:                    end},
<a name="10181"/>10181: 
<a name="10182"/>10182:          %% The actual test
<a name="10183"/>10183:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="10184"/>10184:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10185"/>10185:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="10186"/>10186:                    end},
<a name="10187"/>10187:          #{desc =&gt; &quot;try accept request (with nowait, expect select)&quot;,
<a name="10188"/>10188:            cmd  =&gt; fun(#{lsock      := Sock,
<a name="10189"/>10189:                          accept     := Accept,
<a name="10190"/>10190:                          accept_ref := Ref} = State) -&gt;
<a name="10191"/>10191:                            case Accept(Sock) of
<a name="10192"/>10192:                                {select, SI} when Ref =:= nowait -&gt;
<a name="10193"/>10193:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="10194"/>10194:                                {select, {select_info, _Tag, Ref} = SI}
<a name="10195"/>10195:                                  when is_reference(Ref) -&gt;
<a name="10196"/>10196:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="10197"/>10197: 
<a name="10198"/>10198:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="10199"/>10199:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="10200"/>10200:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="10201"/>10201:                                  when is_reference(Ref) -&gt;
<a name="10202"/>10202:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="10203"/>10203: 
<a name="10204"/>10204:                                {ok, X} -&gt;
<a name="10205"/>10205:                                    {error, {unexpected_success, X}};
<a name="10206"/>10206: 
<a name="10207"/>10207:                                {error, _} = ERROR -&gt;
<a name="10208"/>10208:                                    ERROR
<a name="10209"/>10209:                            end
<a name="10210"/>10210:                    end},
<a name="10211"/>10211:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="10212"/>10212:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10213"/>10213:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="10214"/>10214:                            ok
<a name="10215"/>10215:                    end},
<a name="10216"/>10216:          #{desc =&gt; &quot;await abort message&quot;,
<a name="10217"/>10217:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="10218"/>10218:                          accept_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10219"/>10219:                            receive
<a name="10220"/>10220:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10221"/>10221:                                    {error, {unexpected_select, Ref}};
<a name="10222"/>10222:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10223"/>10223:                                    {ok, maps:remove(sock, State)}
<a name="10224"/>10224:                            after 5000 -&gt;
<a name="10225"/>10225:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="10226"/>10226:                                                &quot;~n   Sock:          ~p&quot;
<a name="10227"/>10227:                                                &quot;~n   Ref:           ~p&quot;
<a name="10228"/>10228:                                                &quot;~n   message queue: ~p&quot;,
<a name="10229"/>10229:                                                [Sock, Ref, ?MQ()]),
<a name="10230"/>10230:                                    {error, timeout}
<a name="10231"/>10231:                            end;
<a name="10232"/>10232:                       (#{lsock              := Sock,
<a name="10233"/>10233:                          accept_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="10234"/>10234:                            receive
<a name="10235"/>10235:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="10236"/>10236:                                    {error, {unexpected_completion, C}};
<a name="10237"/>10237:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10238"/>10238:                                    {ok, maps:remove(sock, State)}
<a name="10239"/>10239:                            after 5000 -&gt;
<a name="10240"/>10240:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="10241"/>10241:                                                &quot;~n   Sock:          ~p&quot;
<a name="10242"/>10242:                                                &quot;~n   Ref:           ~p&quot;
<a name="10243"/>10243:                                                &quot;~n   message queue: ~p&quot;,
<a name="10244"/>10244:                                                [Sock, Ref, ?MQ()]),
<a name="10245"/>10245:                                    {error, timeout}
<a name="10246"/>10246:                            end
<a name="10247"/>10247:                    end},
<a name="10248"/>10248:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10249"/>10249:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10250"/>10250:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10251"/>10251:                            ok
<a name="10252"/>10252:                    end},
<a name="10253"/>10253: 
<a name="10254"/>10254:          %% Termination
<a name="10255"/>10255:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="10256"/>10256:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10257"/>10257:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10258"/>10258:                                ok -&gt;
<a name="10259"/>10259:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="10260"/>10260:                                    State1 = maps:remove(tester,             State),
<a name="10261"/>10261:                                    State2 = maps:remove(accept_select_info, State1),
<a name="10262"/>10262:                                    State3 = maps:remove(accept_completion_info, State2),
<a name="10263"/>10263:                                    State4 = maps:remove(lsock,              State3),
<a name="10264"/>10264:                                    {ok, State4};
<a name="10265"/>10265:                                {error, _} = ERROR -&gt;
<a name="10266"/>10266:                                    ERROR
<a name="10267"/>10267:                            end
<a name="10268"/>10268:                    end},
<a name="10269"/>10269: 
<a name="10270"/>10270:          %% *** We are done ***
<a name="10271"/>10271:          ?SEV_FINISH_NORMAL
<a name="10272"/>10272:         ],
<a name="10273"/>10273: 
<a name="10274"/>10274: 
<a name="10275"/>10275:     TesterSeq =
<a name="10276"/>10276:         [
<a name="10277"/>10277:          %% *** Init part ***
<a name="10278"/>10278:          #{desc =&gt; &quot;monitor server&quot;,
<a name="10279"/>10279:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10280"/>10280:                            _MRef = erlang:monitor(process, Pid),
<a name="10281"/>10281:                            ok
<a name="10282"/>10282:                    end},
<a name="10283"/>10283:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="10284"/>10284:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10285"/>10285:                            _MRef = erlang:monitor(process, Pid),
<a name="10286"/>10286:                            ok
<a name="10287"/>10287:                    end},
<a name="10288"/>10288:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="10289"/>10289:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10290"/>10290:                            _MRef = erlang:monitor(process, Pid),
<a name="10291"/>10291:                            ok
<a name="10292"/>10292:                    end},
<a name="10293"/>10293: 
<a name="10294"/>10294:          %% Start the server
<a name="10295"/>10295:          #{desc =&gt; &quot;order server start&quot;,
<a name="10296"/>10296:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10297"/>10297:                            ?SEV_ANNOUNCE_START(Pid),
<a name="10298"/>10298:                            ok
<a name="10299"/>10299:                    end},
<a name="10300"/>10300:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="10301"/>10301:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10302"/>10302:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="10303"/>10303:                            {ok, State#{sock =&gt; Sock}}
<a name="10304"/>10304:                    end},
<a name="10305"/>10305: 
<a name="10306"/>10306:          %% Start the alt-server 1
<a name="10307"/>10307:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="10308"/>10308:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="10309"/>10309:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10310"/>10310:                            ok
<a name="10311"/>10311:                    end},
<a name="10312"/>10312:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="10313"/>10313:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10314"/>10314:                            ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="10315"/>10315:                    end},
<a name="10316"/>10316: 
<a name="10317"/>10317:          %% Start the alt-server 2
<a name="10318"/>10318:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="10319"/>10319:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="10320"/>10320:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10321"/>10321:                            ok
<a name="10322"/>10322:                    end},
<a name="10323"/>10323:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="10324"/>10324:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10325"/>10325:                            ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="10326"/>10326:                    end},
<a name="10327"/>10327: 
<a name="10328"/>10328: 
<a name="10329"/>10329:          %% *** The actual test ***
<a name="10330"/>10330:          #{desc =&gt; &quot;order server continue (accept)&quot;,
<a name="10331"/>10331:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10332"/>10332:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="10333"/>10333:                            ok
<a name="10334"/>10334:                    end},
<a name="10335"/>10335:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="10336"/>10336:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10337"/>10337:                            ok = ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="10338"/>10338:                    end},
<a name="10339"/>10339: 
<a name="10340"/>10340:          #{desc =&gt; &quot;order alt-server 1 continue (accept)&quot;,
<a name="10341"/>10341:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10342"/>10342:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="10343"/>10343:                            ok
<a name="10344"/>10344:                    end},
<a name="10345"/>10345:          #{desc =&gt; &quot;await alt-server 1 ready (accept select)&quot;,
<a name="10346"/>10346:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10347"/>10347:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, accept_select)
<a name="10348"/>10348:                    end},
<a name="10349"/>10349: 
<a name="10350"/>10350:          #{desc =&gt; &quot;order alt-server 2 continue (accept)&quot;,
<a name="10351"/>10351:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10352"/>10352:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="10353"/>10353:                            ok
<a name="10354"/>10354:                    end},
<a name="10355"/>10355:          #{desc =&gt; &quot;await alt-server 2 ready (accept select)&quot;,
<a name="10356"/>10356:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10357"/>10357:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, accept_select)
<a name="10358"/>10358:                    end},
<a name="10359"/>10359: 
<a name="10360"/>10360:          ?SEV_SLEEP(?SECS(1)),
<a name="10361"/>10361: 
<a name="10362"/>10362:          #{desc =&gt; &quot;close the socket&quot;,
<a name="10363"/>10363:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="10364"/>10364:                            socket:close(Sock)
<a name="10365"/>10365:                    end},
<a name="10366"/>10366: 
<a name="10367"/>10367:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="10368"/>10368:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10369"/>10369:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="10370"/>10370:                    end},
<a name="10371"/>10371:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="10372"/>10372:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10373"/>10373:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="10374"/>10374:                    end},
<a name="10375"/>10375:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="10376"/>10376:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10377"/>10377:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="10378"/>10378:                    end},
<a name="10379"/>10379: 
<a name="10380"/>10380: 
<a name="10381"/>10381:          %% *** Termination ***
<a name="10382"/>10382:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="10383"/>10383:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10384"/>10384:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="10385"/>10385:                            ok
<a name="10386"/>10386:                    end},
<a name="10387"/>10387:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="10388"/>10388:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="10389"/>10389:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="10390"/>10390:                                ok -&gt;
<a name="10391"/>10391:                                    State1 = maps:remove(alt_server2, State),
<a name="10392"/>10392:                                    {ok, State1};
<a name="10393"/>10393:                                {error, _} = ERROR -&gt;
<a name="10394"/>10394:                                    ERROR
<a name="10395"/>10395:                            end
<a name="10396"/>10396:                    end},
<a name="10397"/>10397: 
<a name="10398"/>10398:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="10399"/>10399:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10400"/>10400:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="10401"/>10401:                            ok
<a name="10402"/>10402:                    end},
<a name="10403"/>10403:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="10404"/>10404:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="10405"/>10405:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="10406"/>10406:                                ok -&gt;
<a name="10407"/>10407:                                    State1 = maps:remove(alt_server1, State),
<a name="10408"/>10408:                                    {ok, State1};
<a name="10409"/>10409:                                {error, _} = ERROR -&gt;
<a name="10410"/>10410:                                    ERROR
<a name="10411"/>10411:                            end
<a name="10412"/>10412:                    end},
<a name="10413"/>10413: 
<a name="10414"/>10414:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="10415"/>10415:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="10416"/>10416:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="10417"/>10417:                            ok
<a name="10418"/>10418:                    end},
<a name="10419"/>10419:          #{desc =&gt; &quot;await server termination&quot;,
<a name="10420"/>10420:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="10421"/>10421:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="10422"/>10422:                            State1 = maps:remove(server, State),
<a name="10423"/>10423:                            {ok, State1}
<a name="10424"/>10424:                    end},
<a name="10425"/>10425: 
<a name="10426"/>10426:          %% *** We are done ***
<a name="10427"/>10427:          ?SEV_FINISH_NORMAL
<a name="10428"/>10428:         ],
<a name="10429"/>10429: 
<a name="10430"/>10430:     i(&quot;start server evaluator&quot;),
<a name="10431"/>10431:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="10432"/>10432: 
<a name="10433"/>10433:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="10434"/>10434:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="10435"/>10435: 
<a name="10436"/>10436:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="10437"/>10437:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="10438"/>10438: 
<a name="10439"/>10439:     i(&quot;start tester evaluator&quot;),
<a name="10440"/>10440:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="10441"/>10441:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="10442"/>10442:                         alt_server2 =&gt; AltServer2#ev.pid},
<a name="10443"/>10443:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="10444"/>10444: 
<a name="10445"/>10445:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_maccept_cancel_tcp-last_expr"/><a name="10446"/>10446: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Tester]).
<a name="10447"/>10447: 
<a name="10448"/>10448: 
<a name="10449"/>10449: 
<a name="10450"/>10450: 
<a name="10451"/>10451: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10452"/>10452: 
<a name="10453"/>10453: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recv</i>
<a name="10454"/>10454: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10455"/>10455: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="10456"/>10456: <i>%%</i>
<a name="api_a_mrecv_cancel_tcp4-1"/><a name="10457"/>10457: <b>api_a_mrecv_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="10458"/>10458:     ?TT(?SECS(20)),
<a name="10459"/>10459:     Nowait = nowait(Config),
<a name="api_a_mrecv_cancel_tcp4-last_expr"/><a name="10460"/>10460: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="10461"/>10461:            fun() -&gt; has_support_ipv4() end,
<a name="10462"/>10462:            fun() -&gt;
<a name="10463"/>10463:                    Recv = fun(Sock) -&gt;
<a name="10464"/>10464:                                   socket:recv(Sock, 0, Nowait)
<a name="10465"/>10465:                           end,
<a name="10466"/>10466:                    InitState = #{domain   =&gt; inet,
<a name="10467"/>10467:                                  recv     =&gt; Recv,
<a name="10468"/>10468:                                  recv_ref =&gt; Nowait},
<a name="10469"/>10469:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="10470"/>10470:            end).
<a name="10471"/>10471: 
<a name="10472"/>10472: 
<a name="10473"/>10473: 
<a name="10474"/>10474: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10475"/>10475: 
<a name="10476"/>10476: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recv</i>
<a name="10477"/>10477: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10478"/>10478: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="10479"/>10479: <i>%%</i>
<a name="api_a_mrecv_cancel_tcp6-1"/><a name="10480"/>10480: <b>api_a_mrecv_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="10481"/>10481:     ?TT(?SECS(20)),
<a name="10482"/>10482:     Nowait = nowait(Config),
<a name="api_a_mrecv_cancel_tcp6-last_expr"/><a name="10483"/>10483: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="10484"/>10484:            fun() -&gt; has_support_ipv6() end,
<a name="10485"/>10485:            fun() -&gt;
<a name="10486"/>10486:                    Recv = fun(Sock) -&gt;
<a name="10487"/>10487:                                   socket:recv(Sock, 0, Nowait)
<a name="10488"/>10488:                           end,
<a name="10489"/>10489:                    InitState = #{domain   =&gt; inet6,
<a name="10490"/>10490:                                  recv     =&gt; Recv,
<a name="10491"/>10491:                                  recv_ref =&gt; Nowait},
<a name="10492"/>10492:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="10493"/>10493:            end).
<a name="10494"/>10494: 
<a name="10495"/>10495: 
<a name="10496"/>10496: 
<a name="10497"/>10497: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10498"/>10498: 
<a name="10499"/>10499: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="10500"/>10500: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10501"/>10501: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="10502"/>10502: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_tcp4-1"/><a name="10503"/>10503: <b>api_a_mrecvmsg_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="10504"/>10504:     ?TT(?SECS(20)),
<a name="10505"/>10505:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_tcp4-last_expr"/><a name="10506"/>10506: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="10507"/>10507:            fun() -&gt;
<a name="10508"/>10508:                    is_not_windows(),
<a name="10509"/>10509:                    has_support_ipv4()
<a name="10510"/>10510:            end,
<a name="10511"/>10511:            fun() -&gt;
<a name="10512"/>10512:                    Recv = fun(Sock) -&gt;
<a name="10513"/>10513:                                   socket:recvmsg(Sock, Nowait)
<a name="10514"/>10514:                           end,
<a name="10515"/>10515:                    InitState = #{domain   =&gt; inet,
<a name="10516"/>10516:                                  recv     =&gt; Recv,
<a name="10517"/>10517:                                  recv_ref =&gt; Nowait},
<a name="10518"/>10518:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="10519"/>10519:            end).
<a name="10520"/>10520: 
<a name="10521"/>10521: 
<a name="10522"/>10522: 
<a name="10523"/>10523: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10524"/>10524: 
<a name="10525"/>10525: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="10526"/>10526: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10527"/>10527: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="10528"/>10528: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_tcp6-1"/><a name="10529"/>10529: <b>api_a_mrecvmsg_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="10530"/>10530:     ?TT(?SECS(20)),
<a name="10531"/>10531:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_tcp6-last_expr"/><a name="10532"/>10532: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="10533"/>10533:            fun() -&gt;
<a name="10534"/>10534:                    is_not_windows(),
<a name="10535"/>10535:                    has_support_ipv6()
<a name="10536"/>10536:            end,
<a name="10537"/>10537:            fun() -&gt;
<a name="10538"/>10538:                    Recv = fun(Sock) -&gt;
<a name="10539"/>10539:                                   socket:recvmsg(Sock, Nowait)
<a name="10540"/>10540:                           end,
<a name="10541"/>10541:                    InitState = #{domain   =&gt; inet6,
<a name="10542"/>10542:                                  recv     =&gt; Recv,
<a name="10543"/>10543:                                  recv_ref =&gt; Nowait},
<a name="10544"/>10544:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="10545"/>10545:            end).
<a name="10546"/>10546: 
<a name="10547"/>10547: 
<a name="10548"/>10548: 
<a name="10549"/>10549: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10550"/>10550: 
<a name="api_a_mrecv_cancel_tcp-1"/><a name="10551"/>10551: <b>api_a_mrecv_cancel_tcp</b>(InitState) -&gt;
<a name="10552"/>10552:     process_flag(trap_exit, true),
<a name="10553"/>10553:     ServerSeq = 
<a name="10554"/>10554:         [
<a name="10555"/>10555:          %% *** Wait for start order ***
<a name="10556"/>10556:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="10557"/>10557:            cmd  =&gt; fun(State) -&gt;
<a name="10558"/>10558:                            Tester = ?SEV_AWAIT_START(),
<a name="10559"/>10559:                            {ok, State#{tester =&gt; Tester}}
<a name="10560"/>10560:                    end},
<a name="10561"/>10561:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10562"/>10562:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10563"/>10563:                            _MRef = erlang:monitor(process, Tester),
<a name="10564"/>10564:                            ok
<a name="10565"/>10565:                    end},
<a name="10566"/>10566: 
<a name="10567"/>10567:          %% *** Init part ***
<a name="10568"/>10568:          #{desc =&gt; &quot;which local address&quot;,
<a name="10569"/>10569:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10570"/>10570:                            LSA = which_local_socket_addr(Domain),
<a name="10571"/>10571:                            {ok, State#{lsa =&gt; LSA}}
<a name="10572"/>10572:                    end},
<a name="10573"/>10573:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="10574"/>10574:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10575"/>10575:                            case socket:open(Domain, stream, tcp) of
<a name="10576"/>10576:                                {ok, Sock} -&gt;
<a name="10577"/>10577:                                    {ok, State#{lsock =&gt; Sock}};
<a name="10578"/>10578:                                {error, _} = ERROR -&gt;
<a name="10579"/>10579:                                    ERROR
<a name="10580"/>10580:                            end
<a name="10581"/>10581:                    end},
<a name="10582"/>10582:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="10583"/>10583:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="10584"/>10584:                            case sock_bind(LSock, LSA) of
<a name="10585"/>10585:                                ok -&gt;
<a name="10586"/>10586:                                    Port = sock_port(LSock),
<a name="10587"/>10587:                                    {ok, State#{lport =&gt; Port}};
<a name="10588"/>10588:                                {error, _} = ERROR -&gt;
<a name="10589"/>10589:                                    ERROR
<a name="10590"/>10590:                            end
<a name="10591"/>10591:                    end},
<a name="10592"/>10592:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="10593"/>10593:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="10594"/>10594:                            socket:listen(LSock)
<a name="10595"/>10595:                    end},
<a name="10596"/>10596:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10597"/>10597:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="10598"/>10598:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="10599"/>10599:                            ok
<a name="10600"/>10600:                    end},
<a name="10601"/>10601: 
<a name="10602"/>10602:          %% The actual test
<a name="10603"/>10603:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="10604"/>10604:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10605"/>10605:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="10606"/>10606:                    end},
<a name="10607"/>10607:          #{desc =&gt; &quot;await connection&quot;,
<a name="10608"/>10608:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="10609"/>10609:                            case socket:accept(LSock) of
<a name="10610"/>10610:                                {ok, CSock} -&gt;
<a name="10611"/>10611:                                    {ok, State#{csock =&gt; CSock}};
<a name="10612"/>10612:                                {error, _} = ERROR -&gt;
<a name="10613"/>10613:                                    ERROR
<a name="10614"/>10614:                            end
<a name="10615"/>10615:                    end},
<a name="10616"/>10616:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="10617"/>10617:            cmd  =&gt; fun(#{tester := Tester, csock := Sock}) -&gt;
<a name="10618"/>10618:                            ?SEV_ANNOUNCE_READY(Tester, accept, Sock),
<a name="10619"/>10619:                            ok
<a name="10620"/>10620:                    end},
<a name="10621"/>10621: 
<a name="10622"/>10622:          #{desc =&gt; &quot;await continue (nowait recv)&quot;,
<a name="10623"/>10623:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10624"/>10624:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="10625"/>10625:                    end},
<a name="10626"/>10626:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="10627"/>10627:            cmd  =&gt; fun(#{csock    := Sock,
<a name="10628"/>10628:                          recv     := Recv,
<a name="10629"/>10629:                          recv_ref := Ref} = State) -&gt;
<a name="10630"/>10630:                            case Recv(Sock) of
<a name="10631"/>10631:                                {select, {select_info, T, R} = SI}
<a name="10632"/>10632:                                  when Ref =:= nowait -&gt;
<a name="10633"/>10633:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="10634"/>10634:                                                &quot;~n   Tag: ~p&quot;
<a name="10635"/>10635:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="10636"/>10636:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10637"/>10637:                                {select, {select_info, T, Ref} = SI}
<a name="10638"/>10638:                                  when is_reference(Ref) -&gt;
<a name="10639"/>10639:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="10640"/>10640:                                                &quot;~n   Tag: ~p&quot;
<a name="10641"/>10641:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="10642"/>10642:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10643"/>10643: 
<a name="10644"/>10644:                                {completion, {completion_info, T, R} = CI}
<a name="10645"/>10645:                                  when Ref =:= nowait -&gt;
<a name="10646"/>10646:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="10647"/>10647:                                                &quot;~n   Tag: ~p&quot;
<a name="10648"/>10648:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="10649"/>10649:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10650"/>10650:                                {completion, {completion_info, T, Ref} = CI}
<a name="10651"/>10651:                                  when is_reference(Ref) -&gt;
<a name="10652"/>10652:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="10653"/>10653:                                                &quot;~n   Tag: ~p&quot;
<a name="10654"/>10654:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="10655"/>10655:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10656"/>10656: 
<a name="10657"/>10657:                                {ok, X} -&gt;
<a name="10658"/>10658:                                    {error, {unexpected_success, X}};
<a name="10659"/>10659: 
<a name="10660"/>10660:                                {error, _} = ERROR -&gt;
<a name="10661"/>10661:                                    ERROR
<a name="10662"/>10662:                            end
<a name="10663"/>10663:                    end},
<a name="10664"/>10664:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="10665"/>10665:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10666"/>10666:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="10667"/>10667:                            ok
<a name="10668"/>10668:                    end},
<a name="10669"/>10669:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="10670"/>10670:            cmd  =&gt; fun(#{csock            := Sock,
<a name="10671"/>10671:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10672"/>10672:                            receive
<a name="10673"/>10673:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10674"/>10674:                                    {error, {unexpected_select, Ref}};
<a name="10675"/>10675:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10676"/>10676:                                    {ok, maps:remove(sock, State)}
<a name="10677"/>10677:                            after 5000 -&gt;
<a name="10678"/>10678:                                    ok
<a name="10679"/>10679:                            end;
<a name="10680"/>10680:                       (#{csock                := Sock,
<a name="10681"/>10681:                          recv_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="10682"/>10682:                            receive
<a name="10683"/>10683:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="10684"/>10684:                                    {error, {unexpected_completion, C}};
<a name="10685"/>10685:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10686"/>10686:                                    {ok, maps:remove(sock, State)}
<a name="10687"/>10687:                            after 5000 -&gt;
<a name="10688"/>10688:                                    ok
<a name="10689"/>10689:                            end
<a name="10690"/>10690:                    end},
<a name="10691"/>10691:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10692"/>10692:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10693"/>10693:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10694"/>10694:                            ok
<a name="10695"/>10695:                    end},
<a name="10696"/>10696: 
<a name="10697"/>10697:          %% *** Termination ***
<a name="10698"/>10698:          #{desc =&gt; &quot;await terminate&quot;,
<a name="10699"/>10699:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10700"/>10700:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10701"/>10701:                                ok -&gt;
<a name="10702"/>10702:                                    {ok, maps:remove(tester, State)};
<a name="10703"/>10703:                                {error, _} = ERROR -&gt;
<a name="10704"/>10704:                                    ERROR
<a name="10705"/>10705:                            end
<a name="10706"/>10706:                    end},
<a name="10707"/>10707:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="10708"/>10708:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="10709"/>10709:                            socket:close(Sock)
<a name="10710"/>10710:                    end},
<a name="10711"/>10711: 
<a name="10712"/>10712:          %% *** We are done ***
<a name="10713"/>10713:          ?SEV_FINISH_NORMAL
<a name="10714"/>10714:         ],
<a name="10715"/>10715: 
<a name="10716"/>10716:     AltServerSeq =
<a name="10717"/>10717:         [
<a name="10718"/>10718:          %% *** Wait for start order part ***
<a name="10719"/>10719:          #{desc =&gt; &quot;await start&quot;,
<a name="10720"/>10720:            cmd  =&gt; fun(State) -&gt;
<a name="10721"/>10721:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="10722"/>10722:                            {ok, State#{tester =&gt; Tester, sock =&gt; Sock}}
<a name="10723"/>10723:                    end},
<a name="10724"/>10724:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10725"/>10725:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10726"/>10726:                            _MRef = erlang:monitor(process, Tester),
<a name="10727"/>10727:                            ok
<a name="10728"/>10728:                    end},
<a name="10729"/>10729:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10730"/>10730:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10731"/>10731:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="10732"/>10732:                            ok
<a name="10733"/>10733:                    end},
<a name="10734"/>10734: 
<a name="10735"/>10735:          %% The actual test
<a name="10736"/>10736:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="10737"/>10737:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10738"/>10738:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="10739"/>10739:                    end},
<a name="10740"/>10740:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="10741"/>10741:            cmd  =&gt; fun(#{sock     := Sock,
<a name="10742"/>10742:                          recv     := Recv,
<a name="10743"/>10743:                          recv_ref := Ref} = State) -&gt;
<a name="10744"/>10744:                            case Recv(Sock) of
<a name="10745"/>10745:                                {select, SI} when Ref =:= nowait -&gt;
<a name="10746"/>10746:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10747"/>10747:                                {select, {select_info, _Tag, Ref} = SI}
<a name="10748"/>10748:                                  when is_reference(Ref) -&gt;
<a name="10749"/>10749:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10750"/>10750: 
<a name="10751"/>10751:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="10752"/>10752:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10753"/>10753:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="10754"/>10754:                                  when is_reference(Ref) -&gt;
<a name="10755"/>10755:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10756"/>10756: 
<a name="10757"/>10757:                                {ok, X} -&gt;
<a name="10758"/>10758:                                    {error, {unexpected_success, X}};
<a name="10759"/>10759: 
<a name="10760"/>10760:                                {error, _} = ERROR -&gt;
<a name="10761"/>10761:                                    ERROR
<a name="10762"/>10762:                            end
<a name="10763"/>10763:                    end},
<a name="10764"/>10764:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="10765"/>10765:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10766"/>10766:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="10767"/>10767:                            ok
<a name="10768"/>10768:                    end},
<a name="10769"/>10769:          #{desc =&gt; &quot;await abort message&quot;,
<a name="10770"/>10770:            cmd  =&gt; fun(#{sock             := Sock,
<a name="10771"/>10771:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10772"/>10772:                            receive
<a name="10773"/>10773:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10774"/>10774:                                    {error, {unexpected_select, Ref}};
<a name="10775"/>10775:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10776"/>10776:                                    {ok, maps:remove(sock, State)}
<a name="10777"/>10777:                            after 5000 -&gt;
<a name="10778"/>10778:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="10779"/>10779:                                    {error, timeout}
<a name="10780"/>10780:                            end;
<a name="10781"/>10781:                       (#{sock             := Sock,
<a name="10782"/>10782:                          recv_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="10783"/>10783:                            receive
<a name="10784"/>10784:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="10785"/>10785:                                    {error, {unexpected_completion, C}};
<a name="10786"/>10786:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10787"/>10787:                                    {ok, maps:remove(sock, State)}
<a name="10788"/>10788:                            after 5000 -&gt;
<a name="10789"/>10789:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="10790"/>10790:                                    {error, timeout}
<a name="10791"/>10791:                            end
<a name="10792"/>10792:                    end},
<a name="10793"/>10793:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10794"/>10794:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10795"/>10795:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10796"/>10796:                            ok
<a name="10797"/>10797:                    end},
<a name="10798"/>10798: 
<a name="10799"/>10799:          %% Termination
<a name="10800"/>10800:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="10801"/>10801:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10802"/>10802:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10803"/>10803:                                ok -&gt;
<a name="10804"/>10804:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="10805"/>10805:                                    State1 = maps:remove(recv_select_info, State),
<a name="10806"/>10806:                                    State2 = maps:remove(recv_completion_info, State1),
<a name="10807"/>10807:                                    State3 = maps:remove(tester,           State2),
<a name="10808"/>10808:                                    State4 = maps:remove(sock,             State3),
<a name="10809"/>10809:                                    {ok, State4};
<a name="10810"/>10810:                                {error, _} = ERROR -&gt;
<a name="10811"/>10811:                                    ERROR
<a name="10812"/>10812:                            end
<a name="10813"/>10813:                    end},
<a name="10814"/>10814: 
<a name="10815"/>10815:          %% *** We are done ***
<a name="10816"/>10816:          ?SEV_FINISH_NORMAL
<a name="10817"/>10817:         ],
<a name="10818"/>10818: 
<a name="10819"/>10819:     ClientSeq = 
<a name="10820"/>10820:         [
<a name="10821"/>10821:          %% *** Wait for start order ***
<a name="10822"/>10822:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="10823"/>10823:            cmd  =&gt; fun(State) -&gt;
<a name="10824"/>10824:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="10825"/>10825:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="10826"/>10826:                    end},
<a name="10827"/>10827:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10828"/>10828:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10829"/>10829:                            _MRef = erlang:monitor(process, Tester),
<a name="10830"/>10830:                            ok
<a name="10831"/>10831:                    end},
<a name="10832"/>10832: 
<a name="10833"/>10833:          %% *** The init part ***
<a name="10834"/>10834:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="10835"/>10835:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="10836"/>10836:                            LSA = which_local_socket_addr(Domain),
<a name="10837"/>10837:                            SSA = LSA#{port =&gt; Port},
<a name="10838"/>10838:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="10839"/>10839:                    end},
<a name="10840"/>10840:          #{desc =&gt; &quot;create socket&quot;,
<a name="10841"/>10841:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10842"/>10842:                            case socket:open(Domain, stream, tcp) of
<a name="10843"/>10843:                                {ok, Sock} -&gt;
<a name="10844"/>10844:                                    {ok, State#{sock =&gt; Sock}};
<a name="10845"/>10845:                                {error, _} = ERROR -&gt;
<a name="10846"/>10846:                                    ERROR
<a name="10847"/>10847:                            end
<a name="10848"/>10848:                    end},
<a name="10849"/>10849:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="10850"/>10850:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="10851"/>10851:                            case sock_bind(Sock, LSA) of
<a name="10852"/>10852:                                ok -&gt;
<a name="10853"/>10853:                                    ok;
<a name="10854"/>10854:                                {error, _} = ERROR -&gt;
<a name="10855"/>10855:                                    ERROR
<a name="10856"/>10856:                            end
<a name="10857"/>10857:                    end},
<a name="10858"/>10858:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10859"/>10859:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10860"/>10860:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="10861"/>10861:                            ok
<a name="10862"/>10862:                    end},
<a name="10863"/>10863: 
<a name="10864"/>10864:          %% *** The actual test ***
<a name="10865"/>10865:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="10866"/>10866:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10867"/>10867:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="10868"/>10868:                    end},
<a name="10869"/>10869:          #{desc =&gt; &quot;connect to server&quot;,
<a name="10870"/>10870:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="10871"/>10871:                            socket:connect(Sock, SSA)
<a name="10872"/>10872:                    end},
<a name="10873"/>10873:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="10874"/>10874:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10875"/>10875:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="10876"/>10876:                            ok
<a name="10877"/>10877:                    end},
<a name="10878"/>10878: 
<a name="10879"/>10879:          %% *** Termination ***
<a name="10880"/>10880:          #{desc =&gt; &quot;await terminate&quot;,
<a name="10881"/>10881:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10882"/>10882:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10883"/>10883:                                ok -&gt;
<a name="10884"/>10884:                                    {ok, maps:remove(tester, State)};
<a name="10885"/>10885:                                {error, _} = ERROR -&gt;
<a name="10886"/>10886:                                    ERROR
<a name="10887"/>10887:                            end
<a name="10888"/>10888:                    end},
<a name="10889"/>10889:          #{desc =&gt; &quot;close socket&quot;,
<a name="10890"/>10890:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="10891"/>10891:                            socket:close(Sock)
<a name="10892"/>10892:                    end},
<a name="10893"/>10893: 
<a name="10894"/>10894:          %% *** We are done ***
<a name="10895"/>10895:          ?SEV_FINISH_NORMAL
<a name="10896"/>10896:         ],
<a name="10897"/>10897: 
<a name="10898"/>10898:     TesterSeq =
<a name="10899"/>10899:         [
<a name="10900"/>10900:          %% *** Init part ***
<a name="10901"/>10901:          #{desc =&gt; &quot;monitor server&quot;,
<a name="10902"/>10902:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10903"/>10903:                            _MRef = erlang:monitor(process, Pid),
<a name="10904"/>10904:                            ok
<a name="10905"/>10905:                    end},
<a name="10906"/>10906:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="10907"/>10907:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10908"/>10908:                            _MRef = erlang:monitor(process, Pid),
<a name="10909"/>10909:                            ok
<a name="10910"/>10910:                    end},
<a name="10911"/>10911:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="10912"/>10912:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10913"/>10913:                            _MRef = erlang:monitor(process, Pid),
<a name="10914"/>10914:                            ok
<a name="10915"/>10915:                    end},
<a name="10916"/>10916:          #{desc =&gt; &quot;monitor client&quot;,
<a name="10917"/>10917:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10918"/>10918:                            _MRef = erlang:monitor(process, Pid),
<a name="10919"/>10919:                            ok
<a name="10920"/>10920:                    end},
<a name="10921"/>10921: 
<a name="10922"/>10922:          %% Start the server
<a name="10923"/>10923:          #{desc =&gt; &quot;order server start&quot;,
<a name="10924"/>10924:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10925"/>10925:                            ?SEV_ANNOUNCE_START(Pid),
<a name="10926"/>10926:                            ok
<a name="10927"/>10927:                    end},
<a name="10928"/>10928:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="10929"/>10929:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10930"/>10930:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="10931"/>10931:                            {ok, State#{server_port =&gt; Port}}
<a name="10932"/>10932:                    end},
<a name="10933"/>10933: 
<a name="10934"/>10934:          %% Start the client
<a name="10935"/>10935:          #{desc =&gt; &quot;order client start&quot;,
<a name="10936"/>10936:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="10937"/>10937:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="10938"/>10938:                            ok
<a name="10939"/>10939:                    end},
<a name="10940"/>10940:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="10941"/>10941:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10942"/>10942:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="10943"/>10943:                    end},
<a name="10944"/>10944: 
<a name="10945"/>10945:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="10946"/>10946:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="10947"/>10947:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="10948"/>10948:                            ok
<a name="10949"/>10949:                    end},
<a name="10950"/>10950:          #{desc =&gt; &quot;order client to continue (connect)&quot;,
<a name="10951"/>10951:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10952"/>10952:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="10953"/>10953:                            ok
<a name="10954"/>10954:                    end},
<a name="10955"/>10955:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="10956"/>10956:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10957"/>10957:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="10958"/>10958:                    end},
<a name="10959"/>10959:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="10960"/>10960:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10961"/>10961:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, accept),
<a name="10962"/>10962:                            {ok, State#{sock =&gt; Sock}}
<a name="10963"/>10963:                    end},
<a name="10964"/>10964: 
<a name="10965"/>10965:          %% Start the alt server 1
<a name="10966"/>10966:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="10967"/>10967:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="10968"/>10968:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10969"/>10969:                            ok
<a name="10970"/>10970:                    end},
<a name="10971"/>10971:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="10972"/>10972:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10973"/>10973:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="10974"/>10974:                    end},
<a name="10975"/>10975: 
<a name="10976"/>10976:          %% Start the alt server 2
<a name="10977"/>10977:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="10978"/>10978:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="10979"/>10979:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10980"/>10980:                            ok
<a name="10981"/>10981:                    end},
<a name="10982"/>10982:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="10983"/>10983:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10984"/>10984:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="10985"/>10985:                    end},
<a name="10986"/>10986: 
<a name="10987"/>10987: 
<a name="10988"/>10988:          %% *** The actual test ***
<a name="10989"/>10989:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="10990"/>10990:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10991"/>10991:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="10992"/>10992:                            ok
<a name="10993"/>10993:                    end},
<a name="10994"/>10994:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="10995"/>10995:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10996"/>10996:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="10997"/>10997:                    end},
<a name="10998"/>10998: 
<a name="10999"/>10999:          #{desc =&gt; &quot;order alt-server 1 continue (recv)&quot;,
<a name="11000"/>11000:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11001"/>11001:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="11002"/>11002:                            ok
<a name="11003"/>11003:                    end},
<a name="11004"/>11004:          #{desc =&gt; &quot;await alt-server 1 ready (recv select)&quot;,
<a name="11005"/>11005:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11006"/>11006:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, recv_select)
<a name="11007"/>11007:                    end},
<a name="11008"/>11008: 
<a name="11009"/>11009:          #{desc =&gt; &quot;order alt-server 2 continue (recv)&quot;,
<a name="11010"/>11010:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11011"/>11011:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="11012"/>11012:                            ok
<a name="11013"/>11013:                    end},
<a name="11014"/>11014:          #{desc =&gt; &quot;await alt-server 2 ready (recv select)&quot;,
<a name="11015"/>11015:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11016"/>11016:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, recv_select)
<a name="11017"/>11017:                    end},
<a name="11018"/>11018: 
<a name="11019"/>11019:          ?SEV_SLEEP(?SECS(1)),
<a name="11020"/>11020: 
<a name="11021"/>11021:          #{desc =&gt; &quot;close the socket&quot;,
<a name="11022"/>11022:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="11023"/>11023:                            socket:close(Sock)
<a name="11024"/>11024:                    end},
<a name="11025"/>11025: 
<a name="11026"/>11026:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="11027"/>11027:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11028"/>11028:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="11029"/>11029:                    end},
<a name="11030"/>11030:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="11031"/>11031:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11032"/>11032:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="11033"/>11033:                    end},
<a name="11034"/>11034:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="11035"/>11035:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11036"/>11036:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="11037"/>11037:                    end},
<a name="11038"/>11038: 
<a name="11039"/>11039:          %% Terminations
<a name="11040"/>11040:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="11041"/>11041:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="11042"/>11042:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="11043"/>11043:                            ok
<a name="11044"/>11044:                    end},
<a name="11045"/>11045:          #{desc =&gt; &quot;await client termination&quot;,
<a name="11046"/>11046:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="11047"/>11047:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="11048"/>11048:                            State1 = maps:remove(client, State),
<a name="11049"/>11049:                            {ok, State1}
<a name="11050"/>11050:                    end},
<a name="11051"/>11051: 
<a name="11052"/>11052:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="11053"/>11053:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11054"/>11054:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="11055"/>11055:                            ok
<a name="11056"/>11056:                    end},
<a name="11057"/>11057:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="11058"/>11058:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="11059"/>11059:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="11060"/>11060:                                ok -&gt;
<a name="11061"/>11061:                                    State1 = maps:remove(alt_server2, State),
<a name="11062"/>11062:                                    {ok, State1};
<a name="11063"/>11063:                                {error, _} = ERROR -&gt;
<a name="11064"/>11064:                                    ERROR
<a name="11065"/>11065:                            end
<a name="11066"/>11066:                    end},
<a name="11067"/>11067: 
<a name="11068"/>11068:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="11069"/>11069:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11070"/>11070:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="11071"/>11071:                            ok
<a name="11072"/>11072:                    end},
<a name="11073"/>11073:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="11074"/>11074:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="11075"/>11075:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="11076"/>11076:                                ok -&gt;
<a name="11077"/>11077:                                    State1 = maps:remove(alt_server1, State),
<a name="11078"/>11078:                                    {ok, State1};
<a name="11079"/>11079:                                {error, _} = ERROR -&gt;
<a name="11080"/>11080:                                    ERROR
<a name="11081"/>11081:                            end
<a name="11082"/>11082:                    end},
<a name="11083"/>11083: 
<a name="11084"/>11084:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="11085"/>11085:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11086"/>11086:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="11087"/>11087:                            ok
<a name="11088"/>11088:                    end},
<a name="11089"/>11089:          #{desc =&gt; &quot;await server termination&quot;,
<a name="11090"/>11090:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="11091"/>11091:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="11092"/>11092:                                ok -&gt;
<a name="11093"/>11093:                                    State1 = maps:remove(server, State),
<a name="11094"/>11094:                                    {ok, State1};
<a name="11095"/>11095:                                {error, _} = ERROR -&gt;
<a name="11096"/>11096:                                    ERROR
<a name="11097"/>11097:                            end
<a name="11098"/>11098:                    end},
<a name="11099"/>11099: 
<a name="11100"/>11100: 
<a name="11101"/>11101:          %% *** We are done ***
<a name="11102"/>11102:          ?SEV_FINISH_NORMAL
<a name="11103"/>11103:         ],
<a name="11104"/>11104: 
<a name="11105"/>11105:     i(&quot;start server evaluator&quot;),
<a name="11106"/>11106:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="11107"/>11107: 
<a name="11108"/>11108:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="11109"/>11109:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="11110"/>11110: 
<a name="11111"/>11111:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="11112"/>11112:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="11113"/>11113: 
<a name="11114"/>11114:     i(&quot;start client evaluator&quot;),
<a name="11115"/>11115:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="11116"/>11116: 
<a name="11117"/>11117:     i(&quot;start tester evaluator&quot;),
<a name="11118"/>11118:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="11119"/>11119:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="11120"/>11120:                         alt_server2 =&gt; AltServer2#ev.pid,
<a name="11121"/>11121:                         client      =&gt; Client#ev.pid},
<a name="11122"/>11122:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="11123"/>11123: 
<a name="11124"/>11124:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_mrecv_cancel_tcp-last_expr"/><a name="11125"/>11125: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Client, Tester]).
<a name="11126"/>11126: 
<a name="11127"/>11127: 
<a name="11128"/>11128: 
<a name="11129"/>11129: 
<a name="11130"/>11130: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11131"/>11131: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11132"/>11132: <i>%%                                                                     %%</i>
<a name="11133"/>11133: <i>%%                           API OPTIONS                               %%</i>
<a name="11134"/>11134: <i>%%                                                                     %%</i>
<a name="11135"/>11135: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11136"/>11136: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11137"/>11137: 
<a name="11138"/>11138: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11139"/>11139: 
<a name="11140"/>11140: <i>%% Perform some simple getopt and setopt with the level = otp options</i>
<a name="api_opt_simple_otp_options-1"/><a name="11141"/>11141: <b>api_opt_simple_otp_options</b>(_Config) when is_list(_Config) -&gt;
<a name="11142"/>11142:     ?TT(?SECS(5)),
<a name="api_opt_simple_otp_options-last_expr"/><a name="11143"/>11143: <b>    tc_try</b>(api_opt_simple_otp_options,
<a name="11144"/>11144:            fun() -&gt; api_opt_simple_otp_options() end).
<a name="11145"/>11145: 
<a name="api_opt_simple_otp_options-0"/><a name="11146"/>11146: <b>api_opt_simple_otp_options</b>() -&gt;
<a name="11147"/>11147:     Get = fun(S, Key) -&gt;
<a name="11148"/>11148:                   socket:getopt(S, otp, Key)
<a name="11149"/>11149:           end,
<a name="11150"/>11150:     Set = fun(S, Key, Val) -&gt;
<a name="11151"/>11151:                   socket:setopt(S, otp, Key, Val)
<a name="11152"/>11152:           end,
<a name="11153"/>11153: 
<a name="11154"/>11154:     Seq = 
<a name="11155"/>11155:         [
<a name="11156"/>11156:          %% *** Init part ***
<a name="11157"/>11157:          #{desc =&gt; &quot;create socket&quot;,
<a name="11158"/>11158:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="11159"/>11159:                          type     := Type,
<a name="11160"/>11160:                          protocol := Protocol} = State) -&gt;
<a name="11161"/>11161:                            Sock = sock_open(Domain, Type, Protocol),
<a name="11162"/>11162:                            {ok, State#{sock =&gt; Sock}}
<a name="11163"/>11163:                    end},
<a name="11164"/>11164:          #{desc =&gt; &quot;create dummy process&quot;,
<a name="11165"/>11165:            cmd  =&gt; fun(State) -&gt;
<a name="11166"/>11166:                            Pid =  spawn_link(fun() -&gt; 
<a name="11167"/>11167:                                                      put(sname, &quot;dummy&quot;),
<a name="11168"/>11168:                                                      receive
<a name="11169"/>11169:                                                          die -&gt; 
<a name="11170"/>11170:                                                              exit(normal) 
<a name="11171"/>11171:                                                      end 
<a name="11172"/>11172:                                              end),
<a name="11173"/>11173:                            {ok, State#{dummy =&gt; Pid}}
<a name="11174"/>11174:                    end},
<a name="11175"/>11175: 
<a name="11176"/>11176:          %% *** Check iow part ***
<a name="11177"/>11177:          #{desc =&gt; &quot;get iow&quot;,
<a name="11178"/>11178:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11179"/>11179:                            case Get(Sock, iow) of
<a name="11180"/>11180:                                {ok, IOW} when is_boolean(IOW) -&gt;
<a name="11181"/>11181:                                    {ok, State#{iow =&gt; IOW}};
<a name="11182"/>11182:                                {ok, _} = OK -&gt;
<a name="11183"/>11183:                                    {error, OK};
<a name="11184"/>11184:                                {error, _} = ERROR -&gt;
<a name="11185"/>11185:                                    ERROR
<a name="11186"/>11186:                            end
<a name="11187"/>11187:                    end},
<a name="11188"/>11188: 
<a name="11189"/>11189:          %% #{desc =&gt; &quot;enable debug&quot;,
<a name="11190"/>11190:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="11191"/>11191:          %%                   ok = socket:setopt(Sock, otp, debug, true)
<a name="11192"/>11192:          %%           end},
<a name="11193"/>11193: 
<a name="11194"/>11194:          #{desc =&gt; &quot;set (new) iow&quot;,
<a name="11195"/>11195:            cmd  =&gt; fun(#{sock := Sock, iow := OldIOW} = State) -&gt;
<a name="11196"/>11196:                            NewIOW = not OldIOW,
<a name="11197"/>11197:                            case Set(Sock, iow, NewIOW) of
<a name="11198"/>11198:                                ok -&gt;
<a name="11199"/>11199:                                    {ok, State#{iow =&gt; NewIOW}};
<a name="11200"/>11200:                                {error, _} = ERROR -&gt;
<a name="11201"/>11201:                                    ERROR
<a name="11202"/>11202:                            end
<a name="11203"/>11203:                    end},
<a name="11204"/>11204:          #{desc =&gt; &quot;get (new) iow&quot;,
<a name="11205"/>11205:            cmd  =&gt; fun(#{sock := Sock, iow := IOW}) -&gt;
<a name="11206"/>11206:                            case Get(Sock, iow) of
<a name="11207"/>11207:                                {ok, IOW} -&gt;
<a name="11208"/>11208:                                    ok;
<a name="11209"/>11209:                                {ok, _} = OK-&gt;
<a name="11210"/>11210:                                    {error, OK};
<a name="11211"/>11211:                                {error, _} = ERROR -&gt;
<a name="11212"/>11212:                                    ERROR
<a name="11213"/>11213:                            end
<a name="11214"/>11214:                    end},
<a name="11215"/>11215: 
<a name="11216"/>11216:          %% *** Check rcvbuf part ***
<a name="11217"/>11217:          #{desc =&gt; &quot;get rcvbuf&quot;,
<a name="11218"/>11218:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11219"/>11219:                            case Get(Sock, rcvbuf) of
<a name="11220"/>11220:                                {ok, RcvBuf} when is_integer(RcvBuf) -&gt;
<a name="11221"/>11221:                                    {ok, State#{rcvbuf =&gt; RcvBuf}};
<a name="11222"/>11222:                                {ok, {N, RcvBuf} = V} when is_integer(N) andalso 
<a name="11223"/>11223:                                                           is_integer(RcvBuf) -&gt;
<a name="11224"/>11224:                                    {ok, State#{rcvbuf =&gt; V}};
<a name="11225"/>11225:                                {ok, _} = OK -&gt;
<a name="11226"/>11226:                                    {error, OK};
<a name="11227"/>11227:                                {error, _} = ERROR -&gt;
<a name="11228"/>11228:                                    ERROR
<a name="11229"/>11229:                            end
<a name="11230"/>11230:                    end},
<a name="11231"/>11231:          #{desc =&gt; &quot;set (new) rcvbuf&quot;,
<a name="11232"/>11232:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := {OldN, OldRcvBuf}} = State) -&gt;
<a name="11233"/>11233:                            NewRcvBuf = {OldN+2, OldRcvBuf + 1024},
<a name="11234"/>11234:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="11235"/>11235:                                ok -&gt;
<a name="11236"/>11236:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11237"/>11237:                                {error, _} = ERROR -&gt;
<a name="11238"/>11238:                                    ERROR
<a name="11239"/>11239:                            end;
<a name="11240"/>11240:                       (#{sock := Sock, rcvbuf := OldRcvBuf} = State) when is_integer(OldRcvBuf) -&gt;
<a name="11241"/>11241:                            NewRcvBuf = 2 * OldRcvBuf,
<a name="11242"/>11242:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="11243"/>11243:                                ok -&gt;
<a name="11244"/>11244:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11245"/>11245:                                {error, _} = ERROR -&gt;
<a name="11246"/>11246:                                    ERROR
<a name="11247"/>11247:                            end;
<a name="11248"/>11248:                       (#{sock := Sock, rcvbuf := OldRcvBuf,
<a name="11249"/>11249:                          type := stream,
<a name="11250"/>11250:                          protocol := tcp} = State) when is_integer(OldRcvBuf) -&gt;
<a name="11251"/>11251:                            NewRcvBuf = {2, OldRcvBuf},
<a name="11252"/>11252:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="11253"/>11253:                                ok -&gt;
<a name="11254"/>11254:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11255"/>11255:                                {error, _} = ERROR -&gt;
<a name="11256"/>11256:                                    ERROR
<a name="11257"/>11257:                            end
<a name="11258"/>11258:                    end},
<a name="11259"/>11259:          #{desc =&gt; &quot;get (new) rcvbuf&quot;,
<a name="11260"/>11260:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := RcvBuf}) -&gt;
<a name="11261"/>11261:                            case Get(Sock, rcvbuf) of
<a name="11262"/>11262:                                {ok, RcvBuf} -&gt;
<a name="11263"/>11263:                                    ok;
<a name="11264"/>11264:                                {ok, _} = OK -&gt;
<a name="11265"/>11265:                                    {error, OK};
<a name="11266"/>11266:                                {error, _} = ERROR -&gt;
<a name="11267"/>11267:                                    ERROR
<a name="11268"/>11268:                            end
<a name="11269"/>11269:                    end},
<a name="11270"/>11270: 
<a name="11271"/>11271:          %% *** Check rcvctrlbuf part ***
<a name="11272"/>11272:          #{desc =&gt; &quot;get rcvctrlbuf&quot;,
<a name="11273"/>11273:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11274"/>11274:                            case Get(Sock, rcvctrlbuf) of
<a name="11275"/>11275:                                {ok, RcvCtrlBuf} when is_integer(RcvCtrlBuf) -&gt;
<a name="11276"/>11276:                                    {ok, State#{rcvctrlbuf =&gt; RcvCtrlBuf}};
<a name="11277"/>11277:                                {ok, _} = OK -&gt;
<a name="11278"/>11278:                                    {error, OK};
<a name="11279"/>11279:                                {error, _} = ERROR -&gt;
<a name="11280"/>11280:                                    ERROR
<a name="11281"/>11281:                            end
<a name="11282"/>11282:                    end},
<a name="11283"/>11283:          #{desc =&gt; &quot;set (new) rcvctrlbuf&quot;,
<a name="11284"/>11284:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := OldRcvCtrlBuf} = State) -&gt;
<a name="11285"/>11285:                            NewRcvCtrlBuf = 2 * OldRcvCtrlBuf,
<a name="11286"/>11286:                            case Set(Sock, rcvctrlbuf, NewRcvCtrlBuf) of
<a name="11287"/>11287:                                ok -&gt;
<a name="11288"/>11288:                                    {ok, State#{rcvctrlbuf =&gt; NewRcvCtrlBuf}};
<a name="11289"/>11289:                                {error, _} = ERROR -&gt;
<a name="11290"/>11290:                                    ERROR
<a name="11291"/>11291:                            end
<a name="11292"/>11292:                    end},
<a name="11293"/>11293:          #{desc =&gt; &quot;get (new) rcvctrlbuf&quot;,
<a name="11294"/>11294:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := RcvCtrlBuf}) -&gt;
<a name="11295"/>11295:                            case Get(Sock, rcvctrlbuf) of
<a name="11296"/>11296:                                {ok, RcvCtrlBuf} -&gt;
<a name="11297"/>11297:                                    ok;
<a name="11298"/>11298:                                {ok, _} = OK -&gt;
<a name="11299"/>11299:                                    {error, OK};
<a name="11300"/>11300:                                {error, _} = ERROR -&gt;
<a name="11301"/>11301:                                    ERROR
<a name="11302"/>11302:                            end
<a name="11303"/>11303:                    end},
<a name="11304"/>11304:          %% *** Check rcvctrlbuf part ***
<a name="11305"/>11305:          #{desc =&gt; &quot;get rcvctrlbuf&quot;,
<a name="11306"/>11306:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11307"/>11307:                            case Get(Sock, rcvctrlbuf) of
<a name="11308"/>11308:                                {ok, RcvCtrlBuf} when is_integer(RcvCtrlBuf) -&gt;
<a name="11309"/>11309:                                    {ok, State#{rcvctrlbuf =&gt; RcvCtrlBuf}};
<a name="11310"/>11310:                                {ok, _} = OK -&gt;
<a name="11311"/>11311:                                    {error, OK};
<a name="11312"/>11312:                                {error, _} = ERROR -&gt;
<a name="11313"/>11313:                                    ERROR
<a name="11314"/>11314:                            end
<a name="11315"/>11315:                    end},
<a name="11316"/>11316:          #{desc =&gt; &quot;set (new) rcvctrlbuf&quot;,
<a name="11317"/>11317:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := OldRcvCtrlBuf} = State) -&gt;
<a name="11318"/>11318:                            NewRcvCtrlBuf = 2 * OldRcvCtrlBuf,
<a name="11319"/>11319:                            case Set(Sock, rcvctrlbuf, NewRcvCtrlBuf) of
<a name="11320"/>11320:                                ok -&gt;
<a name="11321"/>11321:                                    {ok, State#{rcvctrlbuf =&gt; NewRcvCtrlBuf}};
<a name="11322"/>11322:                                {error, _} = ERROR -&gt;
<a name="11323"/>11323:                                    ERROR
<a name="11324"/>11324:                            end
<a name="11325"/>11325:                    end},
<a name="11326"/>11326:          #{desc =&gt; &quot;get (new) rcvctrlbuf&quot;,
<a name="11327"/>11327:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := RcvCtrlBuf}) -&gt;
<a name="11328"/>11328:                            case Get(Sock, rcvctrlbuf) of
<a name="11329"/>11329:                                {ok, RcvCtrlBuf} -&gt;
<a name="11330"/>11330:                                    ok;
<a name="11331"/>11331:                                {ok, _} = OK -&gt;
<a name="11332"/>11332:                                    {error, OK};
<a name="11333"/>11333:                                {error, _} = ERROR -&gt;
<a name="11334"/>11334:                                    ERROR
<a name="11335"/>11335:                            end
<a name="11336"/>11336:                    end},
<a name="11337"/>11337: 
<a name="11338"/>11338: 
<a name="11339"/>11339:          %% *** Check sndctrlbuf part ***
<a name="11340"/>11340:          #{desc =&gt; &quot;get sndctrlbuf&quot;,
<a name="11341"/>11341:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11342"/>11342:                            case Get(Sock, sndctrlbuf) of
<a name="11343"/>11343:                                {ok, SndCtrlBuf} when is_integer(SndCtrlBuf) -&gt;
<a name="11344"/>11344:                                    {ok, State#{sndctrlbuf =&gt; SndCtrlBuf}};
<a name="11345"/>11345:                                {ok, _} = OK -&gt;
<a name="11346"/>11346:                                    {error, OK};
<a name="11347"/>11347:                                {error, _} = ERROR -&gt;
<a name="11348"/>11348:                                    ERROR
<a name="11349"/>11349:                            end
<a name="11350"/>11350:                    end},
<a name="11351"/>11351:          #{desc =&gt; &quot;set (new) sndctrlbuf&quot;,
<a name="11352"/>11352:            cmd  =&gt; fun(#{sock := Sock, sndctrlbuf := OldSndCtrlBuf} = State) -&gt;
<a name="11353"/>11353:                            NewSndCtrlBuf = 2 * OldSndCtrlBuf,
<a name="11354"/>11354:                            case Set(Sock, sndctrlbuf, NewSndCtrlBuf) of
<a name="11355"/>11355:                                ok -&gt;
<a name="11356"/>11356:                                    {ok, State#{sndctrlbuf =&gt; NewSndCtrlBuf}};
<a name="11357"/>11357:                                {error, _} = ERROR -&gt;
<a name="11358"/>11358:                                    ERROR
<a name="11359"/>11359:                            end
<a name="11360"/>11360:                    end},
<a name="11361"/>11361:          #{desc =&gt; &quot;get (new) sndctrlbuf&quot;,
<a name="11362"/>11362:            cmd  =&gt; fun(#{sock := Sock, sndctrlbuf := SndCtrlBuf}) -&gt;
<a name="11363"/>11363:                            case Get(Sock, sndctrlbuf) of
<a name="11364"/>11364:                                {ok, SndCtrlBuf} -&gt;
<a name="11365"/>11365:                                    ok;
<a name="11366"/>11366:                                {ok, _} = OK-&gt;
<a name="11367"/>11367:                                    {error, OK};
<a name="11368"/>11368:                                {error, _} = ERROR -&gt;
<a name="11369"/>11369:                                    ERROR
<a name="11370"/>11370:                            end
<a name="11371"/>11371:                    end},
<a name="11372"/>11372: 
<a name="11373"/>11373:          %% *** Check controlling-process part ***
<a name="11374"/>11374:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="11375"/>11375:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="11376"/>11376:                            Self = self(),
<a name="11377"/>11377:                            case Get(Sock, controlling_process) of
<a name="11378"/>11378:                                {ok, Self} -&gt;
<a name="11379"/>11379:                                    ok;
<a name="11380"/>11380:                                {ok, _} = OK -&gt;
<a name="11381"/>11381:                                    {error, OK};
<a name="11382"/>11382:                                {error, _} = ERROR -&gt;
<a name="11383"/>11383:                                    ERROR
<a name="11384"/>11384:                            end
<a name="11385"/>11385:                    end},
<a name="11386"/>11386:          #{desc =&gt; &quot;set dummy as controlling-process&quot;,
<a name="11387"/>11387:            cmd  =&gt; fun(#{sock := Sock, dummy := Dummy}) -&gt;
<a name="11388"/>11388:                            Set(Sock, controlling_process, Dummy)
<a name="11389"/>11389:                    end},
<a name="11390"/>11390:          #{desc =&gt; &quot;verify dummy as controlling-process&quot;,
<a name="11391"/>11391:            cmd  =&gt; fun(#{sock := Sock, dummy := Dummy}) -&gt;
<a name="11392"/>11392:                            case Get(Sock, controlling_process) of
<a name="11393"/>11393:                                {ok, Dummy} -&gt;
<a name="11394"/>11394:                                    ok;
<a name="11395"/>11395:                                {ok, _} = OK -&gt;
<a name="11396"/>11396:                                    {error, OK};
<a name="11397"/>11397:                                {error, _} = ERROR -&gt;
<a name="11398"/>11398:                                    ERROR
<a name="11399"/>11399:                            end
<a name="11400"/>11400:                    end},
<a name="11401"/>11401: 
<a name="11402"/>11402:          %% *** We are done ***
<a name="11403"/>11403:          #{desc =&gt; &quot;finish&quot;,
<a name="11404"/>11404:            cmd  =&gt; fun(#{ dummy := Dummy }) -&gt;
<a name="11405"/>11405:                            Dummy ! die,
<a name="11406"/>11406:                            {ok, normal}
<a name="11407"/>11407:                    end}
<a name="11408"/>11408:         ],
<a name="11409"/>11409: 
<a name="11410"/>11410:     i(&quot;start tcp (stream) evaluator&quot;),
<a name="11411"/>11411:     InitState1 = #{domain =&gt; inet, type =&gt; stream, protocol =&gt; tcp},
<a name="11412"/>11412:     Tester1 = ?SEV_START(&quot;tcp-tester&quot;, Seq, InitState1),
<a name="11413"/>11413:     i(&quot;await tcp evaluator&quot;),
<a name="11414"/>11414:     ok = ?SEV_AWAIT_FINISH([Tester1]),
<a name="11415"/>11415: 
<a name="11416"/>11416:     i(&quot;start udp (dgram) socket&quot;),
<a name="11417"/>11417:     InitState2 = #{domain =&gt; inet, type =&gt; dgram, protocol =&gt; udp},
<a name="11418"/>11418:     Tester2 = ?SEV_START(&quot;udp-tester&quot;, Seq, InitState2),
<a name="11419"/>11419:     i(&quot;await udp evaluator&quot;),
<a name="api_opt_simple_otp_options-last_expr"/><a name="11420"/>11420: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester2]).
<a name="11421"/>11421: 
<a name="11422"/>11422: 
<a name="11423"/>11423: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11424"/>11424: 
<a name="11425"/>11425: <i>%% Perform some simple getopt and setopt otp meta option</i>
<a name="api_opt_simple_otp_meta_option-1"/><a name="11426"/>11426: <b>api_opt_simple_otp_meta_option</b>(_Config) when is_list(_Config) -&gt;
<a name="11427"/>11427:     ?TT(?SECS(5)),
<a name="api_opt_simple_otp_meta_option-last_expr"/><a name="11428"/>11428: <b>    tc_try</b>(api_opt_simple_otp_meta_option,
<a name="11429"/>11429:            fun() -&gt; api_opt_simple_otp_meta_option() end).
<a name="11430"/>11430: 
<a name="api_opt_simple_otp_meta_option-0"/><a name="11431"/>11431: <b>api_opt_simple_otp_meta_option</b>() -&gt;
<a name="11432"/>11432:     Get = fun(S) -&gt;
<a name="11433"/>11433:                   socket:getopt(S, otp, meta)
<a name="11434"/>11434:           end,
<a name="11435"/>11435:     Set = fun(S, Val) -&gt;
<a name="11436"/>11436:                   socket:setopt(S, otp, meta, Val)
<a name="11437"/>11437:           end,
<a name="11438"/>11438: 
<a name="11439"/>11439:     MainSeq =
<a name="11440"/>11440:         [
<a name="11441"/>11441:          #{desc =&gt; &quot;monitor helper&quot;,
<a name="11442"/>11442:            cmd =&gt; fun(#{helper := Pid}) -&gt;
<a name="11443"/>11443:                           _ = erlang:monitor(process, Pid),
<a name="11444"/>11444:                           ok
<a name="11445"/>11445:                   end},
<a name="11446"/>11446: 
<a name="11447"/>11447:          #{desc =&gt; &quot;create socket&quot;,
<a name="11448"/>11448:            cmd  =&gt; fun(#{domain   := Domain,
<a name="11449"/>11449:                          type     := Type,
<a name="11450"/>11450:                          protocol := Protocol} = State) -&gt;
<a name="11451"/>11451:                            Sock = sock_open(Domain, Type, Protocol),
<a name="11452"/>11452:                            {ok, State#{sock =&gt; Sock}}
<a name="11453"/>11453:                    end},
<a name="11454"/>11454: 
<a name="11455"/>11455:          #{desc =&gt; &quot;get default&quot;,
<a name="11456"/>11456:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="11457"/>11457:                           case Get(Sock) of
<a name="11458"/>11458:                               {ok, undefined} -&gt;
<a name="11459"/>11459:                                   ok;
<a name="11460"/>11460:                               {ok, _} = OK -&gt;
<a name="11461"/>11461:                                   {error, OK};
<a name="11462"/>11462:                               {error, _} = ERROR -&gt;
<a name="11463"/>11463:                                   ERROR
<a name="11464"/>11464:                           end
<a name="11465"/>11465:                   end},
<a name="11466"/>11466: 
<a name="11467"/>11467:          #{desc =&gt; &quot;set value&quot;,
<a name="11468"/>11468:            cmd =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11469"/>11469:                           Value = make_ref(),
<a name="11470"/>11470:                           case Set(Sock, Value) of
<a name="11471"/>11471:                               ok -&gt;
<a name="11472"/>11472:                                   {ok, State#{value =&gt; Value}};
<a name="11473"/>11473:                               {error, _} = ERROR -&gt;
<a name="11474"/>11474:                                   ERROR
<a name="11475"/>11475:                           end
<a name="11476"/>11476:                   end},
<a name="11477"/>11477: 
<a name="11478"/>11478:          #{desc =&gt; &quot;get value&quot;,
<a name="11479"/>11479:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="11480"/>11480:                           case Get(Sock) of
<a name="11481"/>11481:                               {ok, Value} -&gt;
<a name="11482"/>11482:                                   ok;
<a name="11483"/>11483:                               {ok, _} = OK -&gt;
<a name="11484"/>11484:                                   {error, OK};
<a name="11485"/>11485:                               {error, _} = ERROR -&gt;
<a name="11486"/>11486:                                   ERROR
<a name="11487"/>11487:                           end
<a name="11488"/>11488:                   end},
<a name="11489"/>11489: 
<a name="11490"/>11490:          #{desc =&gt; &quot;set complex value&quot;,
<a name="11491"/>11491:            cmd =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11492"/>11492:                           Value =
<a name="11493"/>11493:                               #{a =&gt; 1,
<a name="11494"/>11494:                                 b =&gt; {2, 3},
<a name="11495"/>11495:                                 c =&gt; make_ref(),
<a name="11496"/>11496:                                 d =&gt; self(),
<a name="11497"/>11497:                                 e =&gt; State},
<a name="11498"/>11498:                           case Set(Sock, Value) of
<a name="11499"/>11499:                               ok -&gt;
<a name="11500"/>11500:                                   {ok, State#{value := Value}};
<a name="11501"/>11501:                               {error, _} = ERROR -&gt;
<a name="11502"/>11502:                                   ERROR
<a name="11503"/>11503:                           end
<a name="11504"/>11504:                   end},
<a name="11505"/>11505: 
<a name="11506"/>11506:          #{desc =&gt; &quot;get complex value&quot;,
<a name="11507"/>11507:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="11508"/>11508:                           case Get(Sock) of
<a name="11509"/>11509:                               {ok, Value} -&gt;
<a name="11510"/>11510:                                   ok;
<a name="11511"/>11511:                               {ok, _} = OK-&gt;
<a name="11512"/>11512:                                   {error, OK};
<a name="11513"/>11513:                               {error, _} = ERROR -&gt;
<a name="11514"/>11514:                                   ERROR
<a name="11515"/>11515:                           end
<a name="11516"/>11516:                   end},
<a name="11517"/>11517: 
<a name="11518"/>11518:          #{desc =&gt; &quot;start helper&quot;,
<a name="11519"/>11519:            cmd =&gt; fun(#{helper := Pid,  sock := Sock, value := Value}) -&gt;
<a name="11520"/>11520:                           ?SEV_ANNOUNCE_START(Pid, {Sock, Value}),
<a name="11521"/>11521:                           ok
<a name="11522"/>11522:                   end},
<a name="11523"/>11523: 
<a name="11524"/>11524:          #{desc =&gt; &quot;wait for helper ready&quot;,
<a name="11525"/>11525:            cmd =&gt; fun(#{helper := Pid}) -&gt;
<a name="11526"/>11526:                           ?SEV_AWAIT_READY(Pid, helper, test)
<a name="11527"/>11527:                   end},
<a name="11528"/>11528: 
<a name="11529"/>11529:          #{desc =&gt; &quot;socket close&quot;,
<a name="11530"/>11530:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="11531"/>11531:                           socket:close(Sock)
<a name="11532"/>11532:                   end},
<a name="11533"/>11533: 
<a name="11534"/>11534:         ?SEV_FINISH_NORMAL],
<a name="11535"/>11535: 
<a name="11536"/>11536:     HelperSeq =
<a name="11537"/>11537:         [#{desc =&gt; &quot;await start&quot;,
<a name="11538"/>11538:            cmd =&gt; fun (State) -&gt;
<a name="11539"/>11539:                           {Main, {Sock, Value}} = ?SEV_AWAIT_START(),
<a name="11540"/>11540:                           {ok, State#{main =&gt; Main,
<a name="11541"/>11541:                                       sock =&gt; Sock,
<a name="11542"/>11542:                                       value =&gt; Value}}
<a name="11543"/>11543:                   end},
<a name="11544"/>11544:          #{desc =&gt; &quot;monitor main&quot;,
<a name="11545"/>11545:            cmd =&gt; fun(#{main := Main}) -&gt;
<a name="11546"/>11546:                           _ = erlang:monitor(process, Main),
<a name="11547"/>11547:                           ok
<a name="11548"/>11548:                   end},
<a name="11549"/>11549: 
<a name="11550"/>11550:          #{desc =&gt; &quot;get value&quot;,
<a name="11551"/>11551:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="11552"/>11552:                           case Get(Sock) of
<a name="11553"/>11553:                               {ok, Value} -&gt;
<a name="11554"/>11554:                                   ok;
<a name="11555"/>11555:                               {ok, _} = OK-&gt;
<a name="11556"/>11556:                                   {error, OK};
<a name="11557"/>11557:                               {error, _} = ERROR -&gt;
<a name="11558"/>11558:                                   ERROR
<a name="11559"/>11559:                           end
<a name="11560"/>11560:                   end},
<a name="11561"/>11561: 
<a name="11562"/>11562:          #{desc =&gt; &quot;set and fail&quot;,
<a name="11563"/>11563:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="11564"/>11564:                           Value = self(),
<a name="11565"/>11565:                           case Set(Sock, Value) of
<a name="11566"/>11566:                               ok -&gt;
<a name="11567"/>11567:                                   {error, only_owner_may_set};
<a name="11568"/>11568:                               {error, {invalid, not_owner}} -&gt;
<a name="11569"/>11569:                                   ok;
<a name="11570"/>11570:                               {error, _} = ERROR -&gt;
<a name="11571"/>11571:                                   ERROR
<a name="11572"/>11572:                           end
<a name="11573"/>11573:                   end},
<a name="11574"/>11574: 
<a name="11575"/>11575:          #{desc =&gt; &quot;announce ready (test)&quot;,
<a name="11576"/>11576:            cmd  =&gt; fun(#{main := Main}) -&gt;
<a name="11577"/>11577:                            ?SEV_ANNOUNCE_READY(Main, test),
<a name="11578"/>11578:                            ok
<a name="11579"/>11579:                    end},
<a name="11580"/>11580: 
<a name="11581"/>11581:          ?SEV_FINISH_NORMAL],
<a name="11582"/>11582: 
<a name="11583"/>11583: 
<a name="11584"/>11584:     i(&quot;start tcp helper evaluator&quot;),
<a name="11585"/>11585:     Helper = ?SEV_START(&quot;tcp-helper&quot;, HelperSeq, #{}),
<a name="11586"/>11586: 
<a name="11587"/>11587:     i(&quot;start tcp main evaluator&quot;),
<a name="11588"/>11588:     MainState = #{domain =&gt; inet, type =&gt; stream, protocol =&gt; tcp,
<a name="11589"/>11589:                   helper =&gt; Helper#ev.pid},
<a name="11590"/>11590:     Main = ?SEV_START(&quot;tcp-main&quot;, MainSeq, MainState),
<a name="11591"/>11591: 
<a name="11592"/>11592:     i(&quot;await tcp evaluators&quot;),
<a name="api_opt_simple_otp_meta_option-last_expr"/><a name="11593"/>11593: <b>    ok = ?SEV_AWAIT_FINISH</b>([Helper, Main]).
<a name="11594"/>11594: 
<a name="11595"/>11595: 
<a name="11596"/>11596: 
<a name="11597"/>11597: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11598"/>11598: 
<a name="11599"/>11599: <i>%% Perform some simple operations with the rcvbuf otp option</i>
<a name="11600"/>11600: <i>%% The operations we test here are only for type = stream and</i>
<a name="11601"/>11601: <i>%% protocol = tcp.</i>
<a name="api_opt_simple_otp_rcvbuf_option-1"/><a name="11602"/>11602: <b>api_opt_simple_otp_rcvbuf_option</b>(_Config) when is_list(_Config) -&gt;
<a name="11603"/>11603:     ?TT(?SECS(15)),
<a name="api_opt_simple_otp_rcvbuf_option-last_expr"/><a name="11604"/>11604: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="11605"/>11605:            fun() -&gt;
<a name="11606"/>11606:                    api_opt_simple_otp_rcvbuf_option()
<a name="11607"/>11607:            end).
<a name="11608"/>11608: 
<a name="api_opt_simple_otp_rcvbuf_option-0"/><a name="11609"/>11609: <b>api_opt_simple_otp_rcvbuf_option</b>() -&gt;
<a name="11610"/>11610:     Get = fun(S) -&gt;
<a name="11611"/>11611:                   socket:getopt(S, otp, rcvbuf)
<a name="11612"/>11612:           end,
<a name="11613"/>11613:     Set = fun(S, Val) -&gt;
<a name="11614"/>11614:                   socket:setopt(S, otp, rcvbuf, Val)
<a name="11615"/>11615:           end,
<a name="11616"/>11616: 
<a name="11617"/>11617:     ServerSeq = 
<a name="11618"/>11618:         [
<a name="11619"/>11619:          %% *** Wait for start order part ***
<a name="11620"/>11620:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="11621"/>11621:            cmd  =&gt; fun(State) -&gt;
<a name="11622"/>11622:                            Tester = ?SEV_AWAIT_START(),
<a name="11623"/>11623:                            {ok, State#{tester =&gt; Tester}}
<a name="11624"/>11624:                    end},
<a name="11625"/>11625:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11626"/>11626:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11627"/>11627:                            _MRef = erlang:monitor(process, Tester),
<a name="11628"/>11628:                            ok
<a name="11629"/>11629:                    end},
<a name="11630"/>11630: 
<a name="11631"/>11631:          %% *** Init part ***
<a name="11632"/>11632:          #{desc =&gt; &quot;which local address&quot;,
<a name="11633"/>11633:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11634"/>11634:                            LSA = which_local_socket_addr(Domain),
<a name="11635"/>11635:                            {ok, State#{local_sa =&gt; LSA}}
<a name="11636"/>11636:                    end},
<a name="11637"/>11637:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="11638"/>11638:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11639"/>11639:                            case socket:open(Domain, stream, tcp) of
<a name="11640"/>11640:                                {ok, Sock} -&gt;
<a name="11641"/>11641:                                    {ok, State#{lsock =&gt; Sock}};
<a name="11642"/>11642:                                {error, _} = ERROR -&gt;
<a name="11643"/>11643:                                    ERROR
<a name="11644"/>11644:                            end
<a name="11645"/>11645:                    end},
<a name="11646"/>11646:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="11647"/>11647:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="11648"/>11648:                            case sock_bind(LSock, LSA) of
<a name="11649"/>11649:                                ok -&gt;
<a name="11650"/>11650:                                    Port = sock_port(LSock),
<a name="11651"/>11651:                                    {ok, State#{lport =&gt; Port}};
<a name="11652"/>11652:                                {error, _} = ERROR -&gt;
<a name="11653"/>11653:                                    ERROR
<a name="11654"/>11654:                            end
<a name="11655"/>11655:                    end},
<a name="11656"/>11656:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="11657"/>11657:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="11658"/>11658:                            socket:listen(LSock)
<a name="11659"/>11659:                    end},
<a name="11660"/>11660:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11661"/>11661:            cmd  =&gt; fun(#{tester   := Tester,
<a name="11662"/>11662:                          local_sa := LocalSA,
<a name="11663"/>11663:                          lport    := Port}) -&gt;
<a name="11664"/>11664:                            ServerSA = LocalSA#{port =&gt; Port},
<a name="11665"/>11665:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="11666"/>11666:                            ok
<a name="11667"/>11667:                    end},
<a name="11668"/>11668: 
<a name="11669"/>11669: 
<a name="11670"/>11670:          %% *** The actual test part ***
<a name="11671"/>11671:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="11672"/>11672:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11673"/>11673:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="11674"/>11674:                    end},
<a name="11675"/>11675:          #{desc =&gt; &quot;attempt to accept&quot;,
<a name="11676"/>11676:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="11677"/>11677:                            case socket:accept(LSock) of
<a name="11678"/>11678:                                {ok, Sock} -&gt;
<a name="11679"/>11679:                                    {ok, State#{sock =&gt; Sock}};
<a name="11680"/>11680:                                {error, _} = ERROR -&gt;
<a name="11681"/>11681:                                    ERROR
<a name="11682"/>11682:                            end
<a name="11683"/>11683:                    end},
<a name="11684"/>11684:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="11685"/>11685:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11686"/>11686:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="11687"/>11687:                            ok
<a name="11688"/>11688:                    end},
<a name="11689"/>11689: 
<a name="11690"/>11690:          %% Recv with default size for (otp) rcvbuf
<a name="11691"/>11691:          #{desc =&gt; &quot;await continue (recv initial)&quot;,
<a name="11692"/>11692:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11693"/>11693:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="11694"/>11694:                                {ok, MsgSz} -&gt;
<a name="11695"/>11695:                                    ?SEV_IPRINT(&quot;MsgSz: ~p&quot;, [MsgSz]),
<a name="11696"/>11696:                                    {ok, State#{msg_sz =&gt; MsgSz}};
<a name="11697"/>11697:                                {error, _} = ERROR -&gt;
<a name="11698"/>11698:                                    ERROR
<a name="11699"/>11699:                            end
<a name="11700"/>11700:                    end},
<a name="11701"/>11701:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="11702"/>11702:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="11703"/>11703:                            ?SEV_IPRINT(&quot;try recv ~w bytes when rcvbuf is ~s&quot;, 
<a name="11704"/>11704:                                        [MsgSz,
<a name="11705"/>11705:                                         case Get(Sock) of
<a name="11706"/>11706:                                             {ok, RcvBuf} -&gt; ?F(&quot;~w&quot;, [RcvBuf]);
<a name="11707"/>11707:                                             {error, _}   -&gt; &quot;-&quot;
<a name="11708"/>11708:                                         end]),
<a name="11709"/>11709:                            case socket:recv(Sock) of
<a name="11710"/>11710:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="11711"/>11711:                                    ok;
<a name="11712"/>11712:                                {ok, Data} -&gt;
<a name="11713"/>11713:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="11714"/>11714:                                {error, _} = ERROR -&gt;
<a name="11715"/>11715:                                    ERROR
<a name="11716"/>11716:                            end
<a name="11717"/>11717:                    end},
<a name="11718"/>11718:          #{desc =&gt; &quot;announce ready (recv initial)&quot;,
<a name="11719"/>11719:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11720"/>11720:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="11721"/>11721:                            ok
<a name="11722"/>11722:                    end},
<a name="11723"/>11723: 
<a name="11724"/>11724:          %% Recv with new size (1) for (otp) rcvbuf
<a name="11725"/>11725:          #{desc =&gt; &quot;await continue (recv 1)&quot;,
<a name="11726"/>11726:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11727"/>11727:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="11728"/>11728:                                {ok, NewRcvBuf} -&gt;
<a name="11729"/>11729:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;, [NewRcvBuf]),
<a name="11730"/>11730:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11731"/>11731:                                {error, _} = ERROR -&gt;
<a name="11732"/>11732:                                    ERROR
<a name="11733"/>11733:                            end
<a name="11734"/>11734:                    end},
<a name="11735"/>11735:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="11736"/>11736:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="11737"/>11737:                            case Set(Sock, NewRcvBuf) of
<a name="11738"/>11738:                                ok -&gt;
<a name="11739"/>11739:                                    ok;
<a name="11740"/>11740:                                {error, _} = ERROR -&gt;
<a name="11741"/>11741:                                    ERROR
<a name="11742"/>11742:                            end
<a name="11743"/>11743:                    end},
<a name="11744"/>11744:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="11745"/>11745:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="11746"/>11746:                            ?SEV_IPRINT(&quot;try recv ~w bytes when rcvbuf is ~s&quot;, 
<a name="11747"/>11747:                                        [MsgSz,
<a name="11748"/>11748:                                         case Get(Sock) of
<a name="11749"/>11749:                                             {ok, RcvBuf} -&gt; ?F(&quot;~w&quot;, [RcvBuf]);
<a name="11750"/>11750:                                             {error, _}   -&gt; &quot;-&quot;
<a name="11751"/>11751:                                         end]),
<a name="11752"/>11752:                            case socket:recv(Sock) of
<a name="11753"/>11753:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="11754"/>11754:                                    ok;
<a name="11755"/>11755:                                {ok, Data} -&gt;
<a name="11756"/>11756:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="11757"/>11757:                                {error, _} = ERROR -&gt;
<a name="11758"/>11758:                                    ERROR
<a name="11759"/>11759:                            end
<a name="11760"/>11760:                    end},
<a name="11761"/>11761:          #{desc =&gt; &quot;announce ready (recv 1)&quot;,
<a name="11762"/>11762:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11763"/>11763:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="11764"/>11764:                            ok
<a name="11765"/>11765:                    end},
<a name="11766"/>11766: 
<a name="11767"/>11767:          %% Recv with new size (2) for (otp) rcvbuf
<a name="11768"/>11768:          #{desc =&gt; &quot;await continue (recv 2)&quot;,
<a name="11769"/>11769:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11770"/>11770:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="11771"/>11771:                                {ok, NewRcvBuf} -&gt;
<a name="11772"/>11772:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;, [NewRcvBuf]),
<a name="11773"/>11773:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11774"/>11774:                                {error, _} = ERROR -&gt;
<a name="11775"/>11775:                                    ERROR
<a name="11776"/>11776:                            end
<a name="11777"/>11777:                    end},
<a name="11778"/>11778:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="11779"/>11779:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="11780"/>11780:                            case Set(Sock, NewRcvBuf) of
<a name="11781"/>11781:                                ok -&gt;
<a name="11782"/>11782:                                    ok;
<a name="11783"/>11783:                                {error, _} = ERROR -&gt;
<a name="11784"/>11784:                                    ERROR
<a name="11785"/>11785:                            end
<a name="11786"/>11786:                    end},
<a name="11787"/>11787:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="11788"/>11788:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="11789"/>11789:                            case socket:recv(Sock) of
<a name="11790"/>11790:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="11791"/>11791:                                    ok;
<a name="11792"/>11792:                                {ok, Data} -&gt;
<a name="11793"/>11793:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="11794"/>11794:                                {error, _} = ERROR -&gt;
<a name="11795"/>11795:                                    ERROR
<a name="11796"/>11796:                            end
<a name="11797"/>11797:                    end},
<a name="11798"/>11798:          #{desc =&gt; &quot;announce ready (recv 2)&quot;,
<a name="11799"/>11799:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11800"/>11800:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="11801"/>11801:                            ok
<a name="11802"/>11802:                    end},
<a name="11803"/>11803: 
<a name="11804"/>11804:          %% Recv with new size (3) for (otp) rcvbuf
<a name="11805"/>11805:          #{desc =&gt; &quot;await continue (recv 3, truncated)&quot;,
<a name="11806"/>11806:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11807"/>11807:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="11808"/>11808:                                {ok, {ExpSz, NewRcvBuf}} -&gt;
<a name="11809"/>11809:                                    ?SEV_IPRINT(&quot;set new rcvbuf:&quot;
<a name="11810"/>11810:                                                &quot;~n   New RcvBuf:  ~p&quot;
<a name="11811"/>11811:                                                &quot;~n   Expect Size: ~p&quot;,
<a name="11812"/>11812:                                                [ExpSz, NewRcvBuf]),
<a name="11813"/>11813:                                    {ok, State#{msg_sz =&gt; ExpSz,
<a name="11814"/>11814:                                                rcvbuf =&gt; NewRcvBuf}};
<a name="11815"/>11815:                                {error, _} = ERROR -&gt;
<a name="11816"/>11816:                                    ERROR
<a name="11817"/>11817:                            end
<a name="11818"/>11818:                    end},
<a name="11819"/>11819:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="11820"/>11820:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="11821"/>11821:                            case Set(Sock, NewRcvBuf) of
<a name="11822"/>11822:                                ok -&gt;
<a name="11823"/>11823:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;,
<a name="11824"/>11824:                                                [NewRcvBuf]),
<a name="11825"/>11825:                                    ok;
<a name="11826"/>11826:                                {error, _} = ERROR -&gt;
<a name="11827"/>11827:                                    ERROR
<a name="11828"/>11828:                            end
<a name="11829"/>11829:                    end},
<a name="11830"/>11830:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="11831"/>11831:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="11832"/>11832:                            ?SEV_IPRINT(&quot;try recv ~w bytes of data&quot;, [MsgSz]),
<a name="11833"/>11833:                            case socket:recv(Sock) of
<a name="11834"/>11834:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="11835"/>11835:                                    ok;
<a name="11836"/>11836:                                {ok, Data} -&gt;
<a name="11837"/>11837:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="11838"/>11838:                                {error, _} = ERROR -&gt;
<a name="11839"/>11839:                                    ERROR
<a name="11840"/>11840:                            end
<a name="11841"/>11841:                    end},
<a name="11842"/>11842:          #{desc =&gt; &quot;announce ready (recv)&quot;,
<a name="11843"/>11843:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11844"/>11844:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="11845"/>11845:                            ok
<a name="11846"/>11846:                    end},
<a name="11847"/>11847: 
<a name="11848"/>11848: 
<a name="11849"/>11849:          %% Termination
<a name="11850"/>11850:          #{desc =&gt; &quot;await terminate&quot;,
<a name="11851"/>11851:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11852"/>11852:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="11853"/>11853:                                ok -&gt;
<a name="11854"/>11854:                                    {ok, maps:remove(tester, State)};
<a name="11855"/>11855:                                {error, _} = ERROR -&gt;
<a name="11856"/>11856:                                    ERROR
<a name="11857"/>11857:                            end
<a name="11858"/>11858:                    end},
<a name="11859"/>11859:          #{desc =&gt; &quot;close socket(s)&quot;,
<a name="11860"/>11860:            cmd  =&gt; fun(#{lsock := LSock, sock := Sock} = State) -&gt;
<a name="11861"/>11861:                            sock_close(Sock),
<a name="11862"/>11862:                            sock_close(LSock),
<a name="11863"/>11863:                            State1 = maps:remove(sock,  State),
<a name="11864"/>11864:                            State2 = maps:remove(lport, State1),
<a name="11865"/>11865:                            State3 = maps:remove(lsock, State2),
<a name="11866"/>11866:                            {ok, State3}
<a name="11867"/>11867:                    end},
<a name="11868"/>11868: 
<a name="11869"/>11869:          %% *** We are done ***
<a name="11870"/>11870:          ?SEV_FINISH_NORMAL
<a name="11871"/>11871:         ],
<a name="11872"/>11872: 
<a name="11873"/>11873:     ClientSeq =
<a name="11874"/>11874:         [
<a name="11875"/>11875:          %% *** Wait for start order part ***
<a name="11876"/>11876:          #{desc =&gt; &quot;await start&quot;,
<a name="11877"/>11877:            cmd  =&gt; fun(State) -&gt;
<a name="11878"/>11878:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="11879"/>11879:                            {ok, State#{tester    =&gt; Tester,
<a name="11880"/>11880:                                        server_sa =&gt; ServerSA}}
<a name="11881"/>11881:                    end},
<a name="11882"/>11882:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11883"/>11883:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11884"/>11884:                            _MRef = erlang:monitor(process, Tester),
<a name="11885"/>11885:                            ok
<a name="11886"/>11886:                    end},
<a name="11887"/>11887: 
<a name="11888"/>11888:          %% *** Init part ***
<a name="11889"/>11889:          #{desc =&gt; &quot;which local address&quot;,
<a name="11890"/>11890:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11891"/>11891:                            LSA = which_local_socket_addr(Domain),
<a name="11892"/>11892:                            {ok, State#{local_sa =&gt; LSA}}
<a name="11893"/>11893:                    end},
<a name="11894"/>11894:          #{desc =&gt; &quot;create socket&quot;,
<a name="11895"/>11895:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11896"/>11896:                            case socket:open(Domain, stream, tcp) of
<a name="11897"/>11897:                                {ok, Sock} -&gt;
<a name="11898"/>11898:                                    {ok, State#{sock =&gt; Sock}};
<a name="11899"/>11899:                                {error, _} = ERROR -&gt;
<a name="11900"/>11900:                                    ERROR
<a name="11901"/>11901:                            end
<a name="11902"/>11902:                    end},
<a name="11903"/>11903:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="11904"/>11904:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="11905"/>11905:                            case sock_bind(Sock, LSA) of
<a name="11906"/>11906:                                ok -&gt;
<a name="11907"/>11907:                                    ok;
<a name="11908"/>11908:                                {error, _} = ERROR -&gt;
<a name="11909"/>11909:                                    ERROR
<a name="11910"/>11910:                            end
<a name="11911"/>11911:                    end},
<a name="11912"/>11912:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11913"/>11913:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11914"/>11914:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="11915"/>11915:                            ok
<a name="11916"/>11916:                    end},
<a name="11917"/>11917: 
<a name="11918"/>11918:          %% The actual test
<a name="11919"/>11919:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="11920"/>11920:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11921"/>11921:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="11922"/>11922:                    end},
<a name="11923"/>11923:          #{desc =&gt; &quot;connect to server&quot;,
<a name="11924"/>11924:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="11925"/>11925:                            socket:connect(Sock, SSA)
<a name="11926"/>11926:                    end},
<a name="11927"/>11927:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="11928"/>11928:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11929"/>11929:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="11930"/>11930:                            ok
<a name="11931"/>11931:                    end},
<a name="11932"/>11932: 
<a name="11933"/>11933:          #{desc =&gt; &quot;await continue (send initial)&quot;,
<a name="11934"/>11934:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11935"/>11935:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, send) of
<a name="11936"/>11936:                                {ok, Data} -&gt;
<a name="11937"/>11937:                                    {ok, State#{data =&gt; Data}};
<a name="11938"/>11938:                                {error, _} = ERROR -&gt;
<a name="11939"/>11939:                                    ERROR
<a name="11940"/>11940:                            end
<a name="11941"/>11941:                    end},
<a name="11942"/>11942:          #{desc =&gt; &quot;send (initial) data to server&quot;,
<a name="11943"/>11943:            cmd  =&gt; fun(#{sock := Sock, data := Data} = _State) -&gt;
<a name="11944"/>11944:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="11945"/>11945:                            socket:send(Sock, Data)
<a name="11946"/>11946:                    end},
<a name="11947"/>11947:          #{desc =&gt; &quot;announce ready (send initial)&quot;,
<a name="11948"/>11948:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11949"/>11949:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="11950"/>11950:                            ok
<a name="11951"/>11951:                    end},
<a name="11952"/>11952: 
<a name="11953"/>11953:          #{desc =&gt; &quot;await continue (send 1)&quot;,
<a name="11954"/>11954:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11955"/>11955:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="11956"/>11956:                    end},
<a name="11957"/>11957:          #{desc =&gt; &quot;send (1) data to server&quot;,
<a name="11958"/>11958:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="11959"/>11959:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="11960"/>11960:                            socket:send(Sock, Data)
<a name="11961"/>11961:                    end},
<a name="11962"/>11962:          #{desc =&gt; &quot;announce ready (send 1)&quot;,
<a name="11963"/>11963:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11964"/>11964:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="11965"/>11965:                            ok
<a name="11966"/>11966:                    end},
<a name="11967"/>11967: 
<a name="11968"/>11968:          #{desc =&gt; &quot;await continue (send 2)&quot;,
<a name="11969"/>11969:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11970"/>11970:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="11971"/>11971:                    end},
<a name="11972"/>11972:          #{desc =&gt; &quot;send (2) data to server&quot;,
<a name="11973"/>11973:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="11974"/>11974:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="11975"/>11975:                            socket:send(Sock, Data)
<a name="11976"/>11976:                    end},
<a name="11977"/>11977:          #{desc =&gt; &quot;announce ready (send 2)&quot;,
<a name="11978"/>11978:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11979"/>11979:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="11980"/>11980:                            ok
<a name="11981"/>11981:                    end},
<a name="11982"/>11982: 
<a name="11983"/>11983:          #{desc =&gt; &quot;await continue (send 3)&quot;,
<a name="11984"/>11984:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11985"/>11985:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="11986"/>11986:                    end},
<a name="11987"/>11987:          #{desc =&gt; &quot;send (3) data to server&quot;,
<a name="11988"/>11988:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="11989"/>11989:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="11990"/>11990:                            socket:send(Sock, Data)
<a name="11991"/>11991:                    end},
<a name="11992"/>11992:          #{desc =&gt; &quot;announce ready (send 3)&quot;,
<a name="11993"/>11993:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11994"/>11994:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="11995"/>11995:                            ok
<a name="11996"/>11996:                    end},
<a name="11997"/>11997: 
<a name="11998"/>11998: 
<a name="11999"/>11999:          %% Termination
<a name="12000"/>12000:          #{desc =&gt; &quot;await terminate&quot;,
<a name="12001"/>12001:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12002"/>12002:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="12003"/>12003:                                ok -&gt;
<a name="12004"/>12004:                                    {ok, maps:remove(tester, State)};
<a name="12005"/>12005:                                {error, _} = ERROR -&gt;
<a name="12006"/>12006:                                    ERROR
<a name="12007"/>12007:                            end
<a name="12008"/>12008:                    end},
<a name="12009"/>12009:          #{desc =&gt; &quot;close socket&quot;,
<a name="12010"/>12010:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="12011"/>12011:                            socket:close(Sock)
<a name="12012"/>12012:                    end},
<a name="12013"/>12013: 
<a name="12014"/>12014:          %% *** We are done ***
<a name="12015"/>12015:          ?SEV_FINISH_NORMAL
<a name="12016"/>12016:         ],
<a name="12017"/>12017: 
<a name="12018"/>12018:     TesterSeq =
<a name="12019"/>12019:         [
<a name="12020"/>12020:          %% *** Init part ***
<a name="12021"/>12021:          #{desc =&gt; &quot;monitor server&quot;,
<a name="12022"/>12022:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="12023"/>12023:                            _MRef = erlang:monitor(process, Server),
<a name="12024"/>12024:                            ok
<a name="12025"/>12025:                    end},
<a name="12026"/>12026:          #{desc =&gt; &quot;monitor client&quot;,
<a name="12027"/>12027:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12028"/>12028:                            _MRef = erlang:monitor(process, Client),
<a name="12029"/>12029:                            ok
<a name="12030"/>12030:                    end},
<a name="12031"/>12031:          #{desc =&gt; &quot;order server start&quot;,
<a name="12032"/>12032:            cmd  =&gt; fun(#{server := Server}) -&gt;
<a name="12033"/>12033:                            ?SEV_ANNOUNCE_START(Server)
<a name="12034"/>12034:                    end},
<a name="12035"/>12035:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="12036"/>12036:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="12037"/>12037:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Server, server, init),
<a name="12038"/>12038:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="12039"/>12039:                    end},
<a name="12040"/>12040:          #{desc =&gt; &quot;order client start&quot;,
<a name="12041"/>12041:            cmd  =&gt; fun(#{client    := Client,
<a name="12042"/>12042:                          server_sa := ServerSA}) -&gt;
<a name="12043"/>12043:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="12044"/>12044:                            ok
<a name="12045"/>12045:                    end},
<a name="12046"/>12046:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="12047"/>12047:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12048"/>12048:                            ?SEV_AWAIT_READY(Client, client, init)
<a name="12049"/>12049:                    end},
<a name="12050"/>12050: 
<a name="12051"/>12051: 
<a name="12052"/>12052:          %% The actual test (connecting)
<a name="12053"/>12053:          #{desc =&gt; &quot;order server accept (accept)&quot;,
<a name="12054"/>12054:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="12055"/>12055:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="12056"/>12056:                            ok
<a name="12057"/>12057:                    end},
<a name="12058"/>12058:          ?SEV_SLEEP(?SECS(1)),
<a name="12059"/>12059:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="12060"/>12060:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12061"/>12061:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="12062"/>12062:                            ok
<a name="12063"/>12063:                    end},
<a name="12064"/>12064:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="12065"/>12065:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12066"/>12066:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="12067"/>12067:                    end},
<a name="12068"/>12068:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="12069"/>12069:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="12070"/>12070:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="12071"/>12071:                    end},
<a name="12072"/>12072: 
<a name="12073"/>12073:          %% The actual test (initial part)
<a name="12074"/>12074:          #{desc =&gt; &quot;order client continue (send initial)&quot;,
<a name="12075"/>12075:            cmd  =&gt; fun(#{client := Client, data := Data} = _State) -&gt;
<a name="12076"/>12076:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Data),
<a name="12077"/>12077:                            ok
<a name="12078"/>12078:                    end},
<a name="12079"/>12079:          ?SEV_SLEEP(?SECS(1)),
<a name="12080"/>12080:          #{desc =&gt; &quot;order server continue (recv initial)&quot;,
<a name="12081"/>12081:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="12082"/>12082:                            ExpMsgSz = size(Data),
<a name="12083"/>12083:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, ExpMsgSz),
<a name="12084"/>12084:                            ok
<a name="12085"/>12085:                    end},
<a name="12086"/>12086:          #{desc =&gt; &quot;await client ready (send initial)&quot;,
<a name="12087"/>12087:            cmd  =&gt; fun(#{server := Server,
<a name="12088"/>12088:                          client := Client} = _State) -&gt;
<a name="12089"/>12089:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="12090"/>12090:                                                  [{server, Server}]) of
<a name="12091"/>12091:                                ok -&gt;
<a name="12092"/>12092:                                    ok;
<a name="12093"/>12093:                                {error, _} = ERROR -&gt;
<a name="12094"/>12094:                                    ERROR
<a name="12095"/>12095:                            end
<a name="12096"/>12096:                    end},
<a name="12097"/>12097:          #{desc =&gt; &quot;await server ready (recv initial)&quot;,
<a name="12098"/>12098:            cmd  =&gt; fun(#{server := Server,
<a name="12099"/>12099:                          client := Client} = _State) -&gt;
<a name="12100"/>12100:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="12101"/>12101:                                                  [{client, Client}]) of
<a name="12102"/>12102:                                ok -&gt;
<a name="12103"/>12103:                                    ok;
<a name="12104"/>12104:                                {error, _} = ERROR -&gt;
<a name="12105"/>12105:                                    ERROR
<a name="12106"/>12106:                            end
<a name="12107"/>12107:                    end},
<a name="12108"/>12108: 
<a name="12109"/>12109:          %% The actual test (part 1)
<a name="12110"/>12110:          #{desc =&gt; &quot;order client continue (send 1)&quot;,
<a name="12111"/>12111:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12112"/>12112:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="12113"/>12113:                            ok
<a name="12114"/>12114:                    end},
<a name="12115"/>12115:          ?SEV_SLEEP(?SECS(1)),
<a name="12116"/>12116:          #{desc =&gt; &quot;order server continue (recv 1)&quot;,
<a name="12117"/>12117:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="12118"/>12118:                            MsgSz     = size(Data),
<a name="12119"/>12119:                            NewRcvBuf =
<a name="12120"/>12120:                                case os:type() of
<a name="12121"/>12121:                                    {win32, nt} -&gt;
<a name="12122"/>12122:                                        (((2 * MsgSz) div 1024) + 1) * 1024;
<a name="12123"/>12123:                                    _ -&gt;
<a name="12124"/>12124:                                        {2 + (MsgSz div 1024), 1024}
<a name="12125"/>12125:                                end,
<a name="12126"/>12126:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, NewRcvBuf),
<a name="12127"/>12127:                            ok
<a name="12128"/>12128:                    end},
<a name="12129"/>12129:          #{desc =&gt; &quot;await client ready (send 1)&quot;,
<a name="12130"/>12130:            cmd  =&gt; fun(#{server := Server,
<a name="12131"/>12131:                          client := Client} = _State) -&gt;
<a name="12132"/>12132:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="12133"/>12133:                                                  [{server, Server}]) of
<a name="12134"/>12134:                                ok -&gt;
<a name="12135"/>12135:                                    ok;
<a name="12136"/>12136:                                {error, _} = ERROR -&gt;
<a name="12137"/>12137:                                    ERROR
<a name="12138"/>12138:                            end
<a name="12139"/>12139:                    end},
<a name="12140"/>12140:          #{desc =&gt; &quot;await server ready (recv 1)&quot;,
<a name="12141"/>12141:            cmd  =&gt; fun(#{server := Server,
<a name="12142"/>12142:                          client := Client} = _State) -&gt;
<a name="12143"/>12143:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="12144"/>12144:                                                  [{client, Client}]) of
<a name="12145"/>12145:                                ok -&gt;
<a name="12146"/>12146:                                    ok;
<a name="12147"/>12147:                                {error, _} = ERROR -&gt;
<a name="12148"/>12148:                                    ERROR
<a name="12149"/>12149:                            end
<a name="12150"/>12150:                    end},
<a name="12151"/>12151: 
<a name="12152"/>12152:          %% The actual test (part 2)
<a name="12153"/>12153:          #{desc =&gt; &quot;order client continue (send 2)&quot;,
<a name="12154"/>12154:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12155"/>12155:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="12156"/>12156:                            ok
<a name="12157"/>12157:                    end},
<a name="12158"/>12158:          ?SEV_SLEEP(?SECS(1)),
<a name="12159"/>12159:          #{desc =&gt; &quot;order server continue (recv 2)&quot;,
<a name="12160"/>12160:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="12161"/>12161:                            MsgSz     = size(Data),
<a name="12162"/>12162:                            NewRcvBuf = 
<a name="12163"/>12163:                                case os:type() of
<a name="12164"/>12164:                                    {win32, nt} -&gt;
<a name="12165"/>12165:                                        (((3 * MsgSz) div 1024) + 1) * 1024;
<a name="12166"/>12166:                                    _ -&gt;
<a name="12167"/>12167:                                        {2 + (MsgSz div 2048), 2048}
<a name="12168"/>12168:                                end,
<a name="12169"/>12169:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, NewRcvBuf),
<a name="12170"/>12170:                            ok
<a name="12171"/>12171:                    end},
<a name="12172"/>12172:          #{desc =&gt; &quot;await client ready (send 2)&quot;,
<a name="12173"/>12173:            cmd  =&gt; fun(#{server := Server,
<a name="12174"/>12174:                          client := Client} = _State) -&gt;
<a name="12175"/>12175:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="12176"/>12176:                                                  [{server, Server}]) of
<a name="12177"/>12177:                                ok -&gt;
<a name="12178"/>12178:                                    ok;
<a name="12179"/>12179:                                {error, _} = ERROR -&gt;
<a name="12180"/>12180:                                    ERROR
<a name="12181"/>12181:                            end
<a name="12182"/>12182:                    end},
<a name="12183"/>12183:          #{desc =&gt; &quot;await server ready (recv 2)&quot;,
<a name="12184"/>12184:            cmd  =&gt; fun(#{server := Server,
<a name="12185"/>12185:                          client := Client} = _State) -&gt;
<a name="12186"/>12186:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="12187"/>12187:                                                  [{client, Client}]) of
<a name="12188"/>12188:                                ok -&gt;
<a name="12189"/>12189:                                    ok;
<a name="12190"/>12190:                                {error, _} = ERROR -&gt;
<a name="12191"/>12191:                                    ERROR
<a name="12192"/>12192:                            end
<a name="12193"/>12193:                    end},
<a name="12194"/>12194: 
<a name="12195"/>12195: 
<a name="12196"/>12196:          %% The actual test (part 3)
<a name="12197"/>12197:          #{desc =&gt; &quot;order client continue (send 3)&quot;,
<a name="12198"/>12198:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12199"/>12199:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="12200"/>12200:                            ok
<a name="12201"/>12201:                    end},
<a name="12202"/>12202:          ?SEV_SLEEP(?SECS(1)),
<a name="12203"/>12203:          #{desc =&gt; &quot;order server continue (recv 3)&quot;,
<a name="12204"/>12204:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="12205"/>12205:                            MsgSz = size(Data),
<a name="12206"/>12206:                            BufSz = 2048,
<a name="12207"/>12207:                            N     = MsgSz div BufSz - 1,
<a name="12208"/>12208:                            {ExpSz, NewRcvBuf} =
<a name="12209"/>12209:                                case os:type() of
<a name="12210"/>12210:                                    {win32, nt} -&gt;
<a name="12211"/>12211:                                        {N*BufSz, N*BufSz};
<a name="12212"/>12212:                                    _ -&gt;
<a name="12213"/>12213:                                        {N*BufSz, {N, BufSz}}
<a name="12214"/>12214:                                end,
<a name="12215"/>12215:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv,
<a name="12216"/>12216:                                                   {ExpSz, NewRcvBuf})
<a name="12217"/>12217:                    end},
<a name="12218"/>12218:          #{desc =&gt; &quot;await client ready (send 3)&quot;,
<a name="12219"/>12219:            cmd  =&gt; fun(#{server := Server,
<a name="12220"/>12220:                          client := Client} = _State) -&gt;
<a name="12221"/>12221:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="12222"/>12222:                                                  [{server, Server}]) of
<a name="12223"/>12223:                                ok -&gt;
<a name="12224"/>12224:                                    ok;
<a name="12225"/>12225:                                {error, _} = ERROR -&gt;
<a name="12226"/>12226:                                    ERROR
<a name="12227"/>12227:                            end
<a name="12228"/>12228:                    end},
<a name="12229"/>12229:          #{desc =&gt; &quot;await server ready (recv 3)&quot;,
<a name="12230"/>12230:            cmd  =&gt; fun(#{server := Server,
<a name="12231"/>12231:                          client := Client} = _State) -&gt;
<a name="12232"/>12232:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="12233"/>12233:                                                  [{client, Client}]) of
<a name="12234"/>12234:                                ok -&gt;
<a name="12235"/>12235:                                    ok;
<a name="12236"/>12236:                                {error, _} = ERROR -&gt;
<a name="12237"/>12237:                                    ERROR
<a name="12238"/>12238:                            end
<a name="12239"/>12239:                    end},
<a name="12240"/>12240: 
<a name="12241"/>12241: 
<a name="12242"/>12242:          ?SEV_SLEEP(?SECS(1)),
<a name="12243"/>12243: 
<a name="12244"/>12244:          %% *** Terminate server ***
<a name="12245"/>12245:          #{desc =&gt; &quot;order client terminate&quot;,
<a name="12246"/>12246:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12247"/>12247:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="12248"/>12248:                            ok
<a name="12249"/>12249:                    end},
<a name="12250"/>12250:          #{desc =&gt; &quot;await client down&quot;,
<a name="12251"/>12251:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="12252"/>12252:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="12253"/>12253:                            State1 = maps:remove(client,    State),
<a name="12254"/>12254:                            {ok, State1}
<a name="12255"/>12255:                    end},
<a name="12256"/>12256:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="12257"/>12257:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="12258"/>12258:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="12259"/>12259:                            ok
<a name="12260"/>12260:                    end},
<a name="12261"/>12261:          #{desc =&gt; &quot;await server down&quot;,
<a name="12262"/>12262:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="12263"/>12263:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="12264"/>12264:                            State1 = maps:remove(server,    State),
<a name="12265"/>12265:                            State2 = maps:remove(server_sa, State1),
<a name="12266"/>12266:                            {ok, State2}
<a name="12267"/>12267:                    end},
<a name="12268"/>12268: 
<a name="12269"/>12269:          %% *** We are done ***
<a name="12270"/>12270:          ?SEV_FINISH_NORMAL
<a name="12271"/>12271:         ],
<a name="12272"/>12272: 
<a name="12273"/>12273:     %% Create a data binary of 6*1024 bytes
<a name="12274"/>12274:     Data      = list_to_binary(lists:duplicate(6*4, lists:seq(0, 255))),
<a name="12275"/>12275:     InitState = #{domain =&gt; inet_or_inet6(),
<a name="12276"/>12276:                   data   =&gt; Data},
<a name="12277"/>12277: 
<a name="12278"/>12278:     i(&quot;create server evaluator&quot;),
<a name="12279"/>12279:     ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="12280"/>12280:     Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="12281"/>12281: 
<a name="12282"/>12282:     i(&quot;create client evaluator&quot;),
<a name="12283"/>12283:     ClientInitState = #{host   =&gt; local_host(),
<a name="12284"/>12284:                         domain =&gt; maps:get(domain, InitState)},
<a name="12285"/>12285:     Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="12286"/>12286: 
<a name="12287"/>12287:     i(&quot;create tester evaluator&quot;),
<a name="12288"/>12288:     TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="12289"/>12289:                                  client =&gt; Client#ev.pid},
<a name="12290"/>12290:     Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="12291"/>12291: 
<a name="12292"/>12292:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_simple_otp_rcvbuf_option-last_expr"/><a name="12293"/>12293: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="12294"/>12294: 
<a name="12295"/>12295: 
<a name="12296"/>12296: 
<a name="12297"/>12297: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12298"/>12298: 
<a name="12299"/>12299: <i>%% Perform some simple getopt and setopt with the level = otp options</i>
<a name="api_opt_simple_otp_controlling_process-1"/><a name="12300"/>12300: <b>api_opt_simple_otp_controlling_process</b>(_Config) when is_list(_Config) -&gt;
<a name="12301"/>12301:     ?TT(?SECS(30)),
<a name="api_opt_simple_otp_controlling_process-last_expr"/><a name="12302"/>12302: <b>    tc_try</b>(api_opt_simple_otp_controlling_process,
<a name="12303"/>12303:            fun() -&gt; api_opt_simple_otp_controlling_process() end).
<a name="12304"/>12304: 
<a name="api_opt_simple_otp_controlling_process-0"/><a name="12305"/>12305: <b>api_opt_simple_otp_controlling_process</b>() -&gt;
<a name="12306"/>12306:     Get = fun(S, Key) -&gt;
<a name="12307"/>12307:                   socket:getopt(S, otp, Key)
<a name="12308"/>12308:           end,
<a name="12309"/>12309:     Set = fun(S, Key, Val) -&gt;
<a name="12310"/>12310:                   socket:setopt(S, otp, Key, Val)
<a name="12311"/>12311:           end,
<a name="12312"/>12312: 
<a name="12313"/>12313:     ClientSeq =
<a name="12314"/>12314:         [
<a name="12315"/>12315:          %% *** Init part ***
<a name="12316"/>12316:          #{desc =&gt; &quot;await start&quot;,
<a name="12317"/>12317:            cmd  =&gt; fun(State) -&gt;
<a name="12318"/>12318:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="12319"/>12319:                            {ok, State#{tester =&gt; Tester,
<a name="12320"/>12320:                                        sock   =&gt; Sock}}
<a name="12321"/>12321:                    end},
<a name="12322"/>12322:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="12323"/>12323:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12324"/>12324:                            _MRef = erlang:monitor(process, Tester),
<a name="12325"/>12325:                            ok
<a name="12326"/>12326:                    end},
<a name="12327"/>12327: 
<a name="12328"/>12328:          %% *** The actual test ***
<a name="12329"/>12329:          #{desc =&gt; &quot;verify tester as controlling-process&quot;,
<a name="12330"/>12330:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="12331"/>12331:                            case Get(Sock, controlling_process) of
<a name="12332"/>12332:                                {ok, Tester} -&gt;
<a name="12333"/>12333:                                    ok;
<a name="12334"/>12334:                                {ok, _} = OK -&gt;
<a name="12335"/>12335:                                    {error, OK};
<a name="12336"/>12336:                                {error, _} = ERROR -&gt;
<a name="12337"/>12337:                                    ERROR
<a name="12338"/>12338:                            end
<a name="12339"/>12339:                    end},
<a name="12340"/>12340:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="12341"/>12341:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12342"/>12342:                            case Set(Sock, controlling_process, self()) of
<a name="12343"/>12343:                                {error, {invalid, not_owner}} -&gt;
<a name="12344"/>12344:                                    ok;
<a name="12345"/>12345:                                ok -&gt;
<a name="12346"/>12346:                                    {error, unexpected_success};
<a name="12347"/>12347:                                {error, _} = ERROR -&gt;
<a name="12348"/>12348:                                    ERROR
<a name="12349"/>12349:                            end
<a name="12350"/>12350:                    end},
<a name="12351"/>12351:          #{desc =&gt; &quot;announce ready (not owner)&quot;,
<a name="12352"/>12352:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12353"/>12353:                            ?SEV_ANNOUNCE_READY(Tester, not_owner),
<a name="12354"/>12354:                            ok
<a name="12355"/>12355:                    end},
<a name="12356"/>12356:          #{desc =&gt; &quot;await continue (owner)&quot;,
<a name="12357"/>12357:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12358"/>12358:                            ?SEV_AWAIT_CONTINUE(Tester, tester, owner)
<a name="12359"/>12359:                    end},
<a name="12360"/>12360:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="12361"/>12361:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12362"/>12362:                            Self = self(),
<a name="12363"/>12363:                            case Get(Sock, controlling_process) of
<a name="12364"/>12364:                                {ok, Self} -&gt;
<a name="12365"/>12365:                                    ok;
<a name="12366"/>12366:                                {ok, _} = OK -&gt;
<a name="12367"/>12367:                                    {error, OK};
<a name="12368"/>12368:                                {error, _} = ERROR -&gt;
<a name="12369"/>12369:                                    ERROR
<a name="12370"/>12370:                            end
<a name="12371"/>12371:                    end},
<a name="12372"/>12372:          #{desc =&gt; &quot;attempt controlling-process transfer to tester&quot;,
<a name="12373"/>12373:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="12374"/>12374:                            Set(Sock, controlling_process, Tester)
<a name="12375"/>12375:                    end},
<a name="12376"/>12376:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="12377"/>12377:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12378"/>12378:                            case Set(Sock, controlling_process, self()) of
<a name="12379"/>12379:                                {error, {invalid, not_owner}} -&gt;
<a name="12380"/>12380:                                    ok;
<a name="12381"/>12381:                                ok -&gt;
<a name="12382"/>12382:                                    {error, unexpected_success};
<a name="12383"/>12383:                                {error, _} = ERROR -&gt;
<a name="12384"/>12384:                                    ERROR
<a name="12385"/>12385:                            end
<a name="12386"/>12386:                    end},
<a name="12387"/>12387:          #{desc =&gt; &quot;announce ready (owner)&quot;,
<a name="12388"/>12388:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12389"/>12389:                            ?SEV_ANNOUNCE_READY(Tester, owner),
<a name="12390"/>12390:                            ok
<a name="12391"/>12391: 
<a name="12392"/>12392:                    end},
<a name="12393"/>12393:          
<a name="12394"/>12394:          %% *** Termination ***
<a name="12395"/>12395:          #{desc =&gt; &quot;await termination&quot;,
<a name="12396"/>12396:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12397"/>12397:                            ?SEV_AWAIT_TERMINATE(Tester, tester),
<a name="12398"/>12398:                            State1 = maps:remove(tester, State),
<a name="12399"/>12399:                            State2 = maps:remove(sock, State1),
<a name="12400"/>12400:                            {ok, State2}
<a name="12401"/>12401:                    end},
<a name="12402"/>12402: 
<a name="12403"/>12403:          %% *** We are done ***
<a name="12404"/>12404:          ?SEV_FINISH_NORMAL
<a name="12405"/>12405:         ],
<a name="12406"/>12406: 
<a name="12407"/>12407:     TesterSeq =
<a name="12408"/>12408:         [
<a name="12409"/>12409:          %% *** Init part ***
<a name="12410"/>12410:          #{desc =&gt; &quot;create socket&quot;,
<a name="12411"/>12411:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="12412"/>12412:                          type     := Type,
<a name="12413"/>12413:                          protocol := Protocol} = State) -&gt;
<a name="12414"/>12414:                            Sock = sock_open(Domain, Type, Protocol),
<a name="12415"/>12415:                            {ok, State#{sock =&gt; Sock}}
<a name="12416"/>12416:                    end},
<a name="12417"/>12417:          #{desc =&gt; &quot;monitor client&quot;,
<a name="12418"/>12418:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12419"/>12419:                            _MRef = erlang:monitor(process, Client),
<a name="12420"/>12420:                            ok
<a name="12421"/>12421:                    end},
<a name="12422"/>12422: 
<a name="12423"/>12423:          %% *** The actual test ***
<a name="12424"/>12424:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="12425"/>12425:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12426"/>12426:                            Self = self(),
<a name="12427"/>12427:                            case Get(Sock, controlling_process) of
<a name="12428"/>12428:                                {ok, Self} -&gt;
<a name="12429"/>12429:                                    ok;
<a name="12430"/>12430:                                {ok, _} = OK -&gt;
<a name="12431"/>12431:                                    {error, OK};
<a name="12432"/>12432:                                {error, _} = ERROR -&gt;
<a name="12433"/>12433:                                    ERROR
<a name="12434"/>12434:                            end
<a name="12435"/>12435:                    end},
<a name="12436"/>12436:          #{desc =&gt; &quot;order (client) start&quot;,
<a name="12437"/>12437:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="12438"/>12438:                            ?SEV_ANNOUNCE_START(Client, Sock),
<a name="12439"/>12439:                            ok
<a name="12440"/>12440:                    end},
<a name="12441"/>12441:          #{desc =&gt; &quot;await (client) ready (not owner)&quot;,
<a name="12442"/>12442:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12443"/>12443:                            ?SEV_AWAIT_READY(Client, client, not_owner)
<a name="12444"/>12444:                    end},
<a name="12445"/>12445:          #{desc =&gt; &quot;attempt controlling-process transfer to client&quot;,
<a name="12446"/>12446:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="12447"/>12447:                            Set(Sock, controlling_process, Client)
<a name="12448"/>12448:                    end},
<a name="12449"/>12449:          #{desc =&gt; &quot;verify client as controlling-process&quot;,
<a name="12450"/>12450:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="12451"/>12451:                            case Get(Sock, controlling_process) of
<a name="12452"/>12452:                                {ok, Client} -&gt;
<a name="12453"/>12453:                                    ok;
<a name="12454"/>12454:                                {ok, _} = OK -&gt;
<a name="12455"/>12455:                                    {error, OK};
<a name="12456"/>12456:                                {error, _} = ERROR -&gt;
<a name="12457"/>12457:                                    ERROR
<a name="12458"/>12458:                            end
<a name="12459"/>12459:                    end},
<a name="12460"/>12460:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="12461"/>12461:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12462"/>12462:                            case Set(Sock, controlling_process, self()) of
<a name="12463"/>12463:                                {error, {invalid, not_owner}} -&gt;
<a name="12464"/>12464:                                    ok;
<a name="12465"/>12465:                                ok -&gt;
<a name="12466"/>12466:                                    {error, unexpected_success};
<a name="12467"/>12467:                                {error, _} = ERROR -&gt;
<a name="12468"/>12468:                                    ERROR
<a name="12469"/>12469:                            end
<a name="12470"/>12470:                    end},
<a name="12471"/>12471:          #{desc =&gt; &quot;order (client) continue (owner)&quot;,
<a name="12472"/>12472:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12473"/>12473:                            ?SEV_ANNOUNCE_CONTINUE(Client, owner),
<a name="12474"/>12474:                            ok
<a name="12475"/>12475:                    end},
<a name="12476"/>12476:          #{desc =&gt; &quot;await (client) ready (2)&quot;,
<a name="12477"/>12477:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12478"/>12478:                            ?SEV_AWAIT_READY(Client, client, owner),
<a name="12479"/>12479:                            ok
<a name="12480"/>12480:                    end},
<a name="12481"/>12481:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="12482"/>12482:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12483"/>12483:                            Self = self(),
<a name="12484"/>12484:                            case Get(Sock, controlling_process) of
<a name="12485"/>12485:                                {ok, Self} -&gt;
<a name="12486"/>12486:                                    ok;
<a name="12487"/>12487:                                {ok, _} = OK -&gt;
<a name="12488"/>12488:                                    {error, OK};
<a name="12489"/>12489:                                {error, _} = ERROR -&gt;
<a name="12490"/>12490:                                    ERROR
<a name="12491"/>12491:                            end
<a name="12492"/>12492:                    end},
<a name="12493"/>12493: 
<a name="12494"/>12494:          %% *** Termination ***
<a name="12495"/>12495:          #{desc =&gt; &quot;order (client) terminate&quot;,
<a name="12496"/>12496:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12497"/>12497:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="12498"/>12498:                            ok
<a name="12499"/>12499:                    end},
<a name="12500"/>12500:          #{desc =&gt; &quot;await client termination&quot;,
<a name="12501"/>12501:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="12502"/>12502:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="12503"/>12503:                            {ok, maps:remove(client, State)}
<a name="12504"/>12504:                    end},
<a name="12505"/>12505:          #{desc =&gt; &quot;close socket&quot;,
<a name="12506"/>12506:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12507"/>12507:                            sock_close(Sock),
<a name="12508"/>12508:                            {ok, maps:remove(sock, State)}
<a name="12509"/>12509:                    end},
<a name="12510"/>12510: 
<a name="12511"/>12511:          %% *** We are done ***
<a name="12512"/>12512:          ?SEV_FINISH_NORMAL
<a name="12513"/>12513:         ],
<a name="12514"/>12514: 
<a name="12515"/>12515:     i(&quot;start tcp (stream) client evaluator&quot;),
<a name="12516"/>12516:     ClientInitState1 = #{},
<a name="12517"/>12517:     Client1 = ?SEV_START(&quot;tcp-client&quot;, ClientSeq, ClientInitState1),
<a name="12518"/>12518: 
<a name="12519"/>12519:     i(&quot;start tcp (stream) tester evaluator&quot;),
<a name="12520"/>12520:     TesterInitState1 = #{domain   =&gt; inet,
<a name="12521"/>12521:                          type     =&gt; stream, 
<a name="12522"/>12522:                          protocol =&gt; tcp,
<a name="12523"/>12523:                          client   =&gt; Client1#ev.pid},
<a name="12524"/>12524:     Tester1 = ?SEV_START(&quot;tcp-tester&quot;, TesterSeq, TesterInitState1),
<a name="12525"/>12525: 
<a name="12526"/>12526:     i(&quot;await tcp evaluator(s)&quot;),
<a name="12527"/>12527:     ok = ?SEV_AWAIT_FINISH([Tester1, Client1]),
<a name="12528"/>12528: 
<a name="12529"/>12529:     i(&quot;start udp (dgram) client evaluator&quot;),
<a name="12530"/>12530:     ClientInitState2 = #{},
<a name="12531"/>12531:     Client2 = ?SEV_START(&quot;udp-client&quot;, ClientSeq, ClientInitState2),
<a name="12532"/>12532: 
<a name="12533"/>12533:     i(&quot;start udp (dgram) tester evaluator&quot;),
<a name="12534"/>12534:     TesterInitState2 = #{domain   =&gt; inet,
<a name="12535"/>12535:                          type     =&gt; dgram, 
<a name="12536"/>12536:                          protocol =&gt; udp,
<a name="12537"/>12537:                          client   =&gt; Client2#ev.pid},
<a name="12538"/>12538:     Tester2 = ?SEV_START(&quot;udp-tester&quot;, TesterSeq, TesterInitState2),
<a name="12539"/>12539: 
<a name="12540"/>12540:     i(&quot;await udp evaluator(s)&quot;),
<a name="api_opt_simple_otp_controlling_process-last_expr"/><a name="12541"/>12541: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester2, Client2]).
<a name="12542"/>12542: 
<a name="12543"/>12543: 
<a name="12544"/>12544: 
<a name="12545"/>12545: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12546"/>12546: 
<a name="12547"/>12547: <i>%% Tests the socket option acceptconn for UDP.</i>
<a name="12548"/>12548: <i>%% This should be possible to get but not set.</i>
<a name="12549"/>12549: 
<a name="api_opt_sock_acceptconn_udp-1"/><a name="12550"/>12550: <b>api_opt_sock_acceptconn_udp</b>(_Config) when is_list(_Config) -&gt;
<a name="12551"/>12551:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptconn_udp-last_expr"/><a name="12552"/>12552: <b>    tc_try</b>(api_opt_sock_acceptconn_udp,
<a name="12553"/>12553:            fun() -&gt;
<a name="12554"/>12554:                    has_support_sock_acceptconn()
<a name="12555"/>12555:            end,
<a name="12556"/>12556:            fun() -&gt; api_opt_sock_acceptconn_udp() end).
<a name="12557"/>12557: 
<a name="12558"/>12558: 
<a name="12559"/>12559: 
<a name="api_opt_sock_acceptconn_udp-0"/><a name="12560"/>12560: <b>api_opt_sock_acceptconn_udp</b>() -&gt;
<a name="12561"/>12561:     Opt = acceptconn,
<a name="12562"/>12562:     Set = fun(S, Val) -&gt;
<a name="12563"/>12563:                   socket:setopt(S, socket, Opt, Val)
<a name="12564"/>12564:           end,
<a name="12565"/>12565:     Get = fun(S) -&gt;
<a name="12566"/>12566:                   socket:getopt(S, socket, Opt)
<a name="12567"/>12567:           end,
<a name="12568"/>12568: 
<a name="12569"/>12569:     TesterSeq =
<a name="12570"/>12570:         [
<a name="12571"/>12571:          #{desc =&gt; &quot;which local address&quot;,
<a name="12572"/>12572:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12573"/>12573:                            LSA = which_local_socket_addr(Domain),
<a name="12574"/>12574:                            {ok, State#{local_sa =&gt; LSA}}
<a name="12575"/>12575:                    end},
<a name="12576"/>12576:          #{desc =&gt; &quot;create socket&quot;,
<a name="12577"/>12577:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12578"/>12578:                            case socket:open(Domain, dgram, udp) of
<a name="12579"/>12579:                                {ok, Sock} -&gt;
<a name="12580"/>12580:                                    {ok, State#{sock =&gt; Sock}};
<a name="12581"/>12581:                                {error, _} = ERROR -&gt;
<a name="12582"/>12582:                                    ERROR
<a name="12583"/>12583:                            end
<a name="12584"/>12584:                    end},
<a name="12585"/>12585: 
<a name="12586"/>12586:          #{desc =&gt; &quot;[get] verify socket (before bind)&quot;,
<a name="12587"/>12587:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12588"/>12588:                            case Get(Sock) of
<a name="12589"/>12589:                                {ok, false} -&gt;
<a name="12590"/>12590:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12591"/>12591:                                                &quot;Not accepting connections&quot;),
<a name="12592"/>12592:                                    ok;
<a name="12593"/>12593:                                {ok, true} -&gt;
<a name="12594"/>12594:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12595"/>12595:                                                &quot;Accepting connections&quot;),
<a name="12596"/>12596:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12597"/>12597:                                {error, enoprotoopt = Reason} -&gt;
<a name="12598"/>12598:                                    %% On some platforms this is not accepted
<a name="12599"/>12599:                                    %% for UDP, so skip this part (UDP).
<a name="12600"/>12600:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="12601"/>12601:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="12602"/>12602:                                    (catch socket:close(Sock)),
<a name="12603"/>12603:                                    {skip, Reason};
<a name="12604"/>12604:                                {error, Reason} = ERROR -&gt;
<a name="12605"/>12605:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="12606"/>12606:                                                [Reason]),
<a name="12607"/>12607:                                    ERROR
<a name="12608"/>12608:                            end
<a name="12609"/>12609:                    end},
<a name="12610"/>12610:          #{desc =&gt; &quot;[set] verify socket (before bind)&quot;,
<a name="12611"/>12611:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12612"/>12612:                            case Set(Sock, true) of
<a name="12613"/>12613:                                {error, Reason} -&gt;
<a name="12614"/>12614:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;,
<a name="12615"/>12615:                                                [Reason]),
<a name="12616"/>12616:                                    ok;
<a name="12617"/>12617:                                ok -&gt;
<a name="12618"/>12618:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12619"/>12619:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12620"/>12620:                                    {error, unexpected_success}
<a name="12621"/>12621:                            end
<a name="12622"/>12622:                    end},
<a name="12623"/>12623: 
<a name="12624"/>12624:          #{desc =&gt; &quot;bind socket to local address&quot;,
<a name="12625"/>12625:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="12626"/>12626:                            case sock_bind(Sock, LSA) of
<a name="12627"/>12627:                                ok -&gt;
<a name="12628"/>12628:                                    ok;
<a name="12629"/>12629:                                {error, _} = ERROR -&gt;
<a name="12630"/>12630:                                    ERROR
<a name="12631"/>12631:                            end
<a name="12632"/>12632:                    end},
<a name="12633"/>12633: 
<a name="12634"/>12634:          ?SEV_SLEEP(?SECS(1)),
<a name="12635"/>12635: 
<a name="12636"/>12636:          #{desc =&gt; &quot;[get] verify socket (after bind)&quot;,
<a name="12637"/>12637:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12638"/>12638:                            case Get(Sock) of
<a name="12639"/>12639:                                {ok, false} -&gt;
<a name="12640"/>12640:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12641"/>12641:                                                &quot;Not accepting connections&quot;),
<a name="12642"/>12642:                                    ok;
<a name="12643"/>12643:                                {ok, true} -&gt;
<a name="12644"/>12644:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12645"/>12645:                                                &quot;Accepting connections&quot;),
<a name="12646"/>12646:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12647"/>12647:                                {error, Reason} = ERROR -&gt;
<a name="12648"/>12648:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="12649"/>12649:                                                [Reason]),
<a name="12650"/>12650:                                    ERROR
<a name="12651"/>12651:                            end
<a name="12652"/>12652:                    end},
<a name="12653"/>12653:          #{desc =&gt; &quot;[set] verify socket (after bind)&quot;,
<a name="12654"/>12654:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12655"/>12655:                            case Set(Sock, true) of
<a name="12656"/>12656:                                {error, Reason} -&gt;
<a name="12657"/>12657:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;,
<a name="12658"/>12658:                                                [Reason]),
<a name="12659"/>12659:                                    ok;
<a name="12660"/>12660:                                ok -&gt;
<a name="12661"/>12661:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12662"/>12662:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12663"/>12663:                                    {error, unexpected_success}
<a name="12664"/>12664:                            end
<a name="12665"/>12665:                    end},
<a name="12666"/>12666: 
<a name="12667"/>12667:          %% *** Termination ***
<a name="12668"/>12668:          #{desc =&gt; &quot;close socket&quot;,
<a name="12669"/>12669:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12670"/>12670:                            socket:close(Sock),
<a name="12671"/>12671:                            {ok, maps:remove(sock, State)}
<a name="12672"/>12672:                    end},
<a name="12673"/>12673: 
<a name="12674"/>12674:          %% *** We are done ***
<a name="12675"/>12675:          ?SEV_FINISH_NORMAL
<a name="12676"/>12676:         ],
<a name="12677"/>12677: 
<a name="12678"/>12678:     Domain = inet_or_inet6(),
<a name="12679"/>12679: 
<a name="12680"/>12680:     i(&quot;start tester evaluator&quot;),
<a name="12681"/>12681:     InitState = #{domain  =&gt; Domain},
<a name="12682"/>12682:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="12683"/>12683: 
<a name="12684"/>12684:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_acceptconn_udp-last_expr"/><a name="12685"/>12685: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="12686"/>12686: 
<a name="12687"/>12687: 
<a name="12688"/>12688: 
<a name="12689"/>12689: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12690"/>12690: 
<a name="12691"/>12691: <i>%% Tests the socket option acceptconn for TCP.</i>
<a name="12692"/>12692: <i>%% This should be possible to get but not set.</i>
<a name="12693"/>12693: 
<a name="api_opt_sock_acceptconn_tcp-1"/><a name="12694"/>12694: <b>api_opt_sock_acceptconn_tcp</b>(_Config) when is_list(_Config) -&gt;
<a name="12695"/>12695:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptconn_tcp-last_expr"/><a name="12696"/>12696: <b>    tc_try</b>(api_opt_sock_acceptconn_tcp,
<a name="12697"/>12697:            fun() -&gt;
<a name="12698"/>12698:                    has_support_sock_acceptconn()
<a name="12699"/>12699:            end,
<a name="12700"/>12700:            fun() -&gt; api_opt_sock_acceptconn_tcp() end).
<a name="12701"/>12701: 
<a name="12702"/>12702: 
<a name="12703"/>12703: 
<a name="api_opt_sock_acceptconn_tcp-0"/><a name="12704"/>12704: <b>api_opt_sock_acceptconn_tcp</b>() -&gt;
<a name="12705"/>12705:     Opt = acceptconn,
<a name="12706"/>12706:     Set = fun(S, Val) -&gt;
<a name="12707"/>12707:                   socket:setopt(S, socket, Opt, Val)
<a name="12708"/>12708:           end,
<a name="12709"/>12709:     Get = fun(S) -&gt;
<a name="12710"/>12710:                   socket:getopt(S, socket, Opt)
<a name="12711"/>12711:           end,
<a name="12712"/>12712: 
<a name="12713"/>12713:     TesterSeq =
<a name="12714"/>12714:         [
<a name="12715"/>12715:          #{desc =&gt; &quot;which local address&quot;,
<a name="12716"/>12716:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12717"/>12717:                            LSA = which_local_socket_addr(Domain),
<a name="12718"/>12718:                            {ok, State#{local_sa =&gt; LSA}}
<a name="12719"/>12719:                    end},
<a name="12720"/>12720: 
<a name="12721"/>12721:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="12722"/>12722:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12723"/>12723:                            case socket:open(Domain, stream, tcp) of
<a name="12724"/>12724:                                {ok, Sock} -&gt;
<a name="12725"/>12725:                                    {ok, State#{lsock =&gt; Sock}};
<a name="12726"/>12726:                                {error, _} = ERROR -&gt;
<a name="12727"/>12727:                                    ERROR
<a name="12728"/>12728:                            end
<a name="12729"/>12729:                    end},
<a name="12730"/>12730: 
<a name="12731"/>12731:          #{desc =&gt; &quot;[get] verify listen socket (before bind)&quot;,
<a name="12732"/>12732:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12733"/>12733:                            case Get(Sock) of
<a name="12734"/>12734:                                {ok, false} -&gt;
<a name="12735"/>12735:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12736"/>12736:                                                &quot;Not accepting connections&quot;),
<a name="12737"/>12737:                                    ok;
<a name="12738"/>12738:                                {ok, true} -&gt;
<a name="12739"/>12739:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12740"/>12740:                                                &quot;Accepting connections&quot;),
<a name="12741"/>12741:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12742"/>12742:                                {error, enoprotoopt = Reason} -&gt;
<a name="12743"/>12743:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="12744"/>12744:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="12745"/>12745:                                    (catch socket:close(Sock)),
<a name="12746"/>12746:                                    {skip, Reason};
<a name="12747"/>12747:                                {error, Reason} = ERROR -&gt;
<a name="12748"/>12748:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="12749"/>12749:                                                [Reason]),
<a name="12750"/>12750:                                    ERROR
<a name="12751"/>12751:                            end
<a name="12752"/>12752:                    end},
<a name="12753"/>12753:          #{desc =&gt; &quot;[set] verify listen socket (before bind)&quot;,
<a name="12754"/>12754:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12755"/>12755:                            case Set(Sock, true) of
<a name="12756"/>12756:                                {error, Reason} -&gt;
<a name="12757"/>12757:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12758"/>12758:                                    ok;
<a name="12759"/>12759:                                ok -&gt;
<a name="12760"/>12760:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12761"/>12761:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12762"/>12762:                                    {error, unexpected_success}
<a name="12763"/>12763:                            end
<a name="12764"/>12764:                    end},
<a name="12765"/>12765: 
<a name="12766"/>12766:          ?SEV_SLEEP(?SECS(1)),
<a name="12767"/>12767: 
<a name="12768"/>12768:          #{desc =&gt; &quot;bind listen socket to local address&quot;,
<a name="12769"/>12769:            cmd  =&gt; fun(#{lsock := Sock, local_sa := LSA} = State) -&gt;
<a name="12770"/>12770:                            case sock_bind(Sock, LSA) of
<a name="12771"/>12771:                                ok -&gt;
<a name="12772"/>12772:                                    Port = sock_port(Sock),
<a name="12773"/>12773:                                    {ok, State#{server_sa =&gt; LSA#{port =&gt; Port}}};
<a name="12774"/>12774:                                {error, _} = ERROR -&gt;
<a name="12775"/>12775:                                    ERROR
<a name="12776"/>12776:                            end
<a name="12777"/>12777:                    end},
<a name="12778"/>12778: 
<a name="12779"/>12779:          #{desc =&gt; &quot;[get] verify listen socket (after bind)&quot;,
<a name="12780"/>12780:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12781"/>12781:                            case Get(Sock) of
<a name="12782"/>12782:                                {ok, false} -&gt;
<a name="12783"/>12783:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12784"/>12784:                                                &quot;Not accepting connections&quot;),
<a name="12785"/>12785:                                    ok;
<a name="12786"/>12786:                                {ok, true} -&gt;
<a name="12787"/>12787:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12788"/>12788:                                                &quot;Accepting connections&quot;),
<a name="12789"/>12789:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12790"/>12790:                                {error, Reason} = ERROR -&gt;
<a name="12791"/>12791:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12792"/>12792:                                    ERROR
<a name="12793"/>12793:                            end
<a name="12794"/>12794:                    end},
<a name="12795"/>12795:          #{desc =&gt; &quot;[set] verify listen socket (after bind)&quot;,
<a name="12796"/>12796:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12797"/>12797:                            case Set(Sock, true) of
<a name="12798"/>12798:                                {error, Reason} -&gt;
<a name="12799"/>12799:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12800"/>12800:                                    ok;
<a name="12801"/>12801:                                ok -&gt;
<a name="12802"/>12802:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12803"/>12803:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12804"/>12804:                                    {error, unexpected_success}
<a name="12805"/>12805:                            end
<a name="12806"/>12806:                    end},
<a name="12807"/>12807: 
<a name="12808"/>12808:          ?SEV_SLEEP(?SECS(1)),
<a name="12809"/>12809: 
<a name="12810"/>12810:          #{desc =&gt; &quot;make listen socket accept connections&quot;,
<a name="12811"/>12811:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12812"/>12812:                            case socket:listen(Sock) of
<a name="12813"/>12813:                                ok -&gt;
<a name="12814"/>12814:                                    ok;
<a name="12815"/>12815:                                {error, _} = ERROR -&gt;
<a name="12816"/>12816:                                    ERROR
<a name="12817"/>12817:                            end
<a name="12818"/>12818:                    end},
<a name="12819"/>12819: 
<a name="12820"/>12820:          #{desc =&gt; &quot;[get] verify listen socket (after listen)&quot;,
<a name="12821"/>12821:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12822"/>12822:                            case Get(Sock) of
<a name="12823"/>12823:                                {ok, true} -&gt;
<a name="12824"/>12824:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12825"/>12825:                                                &quot;Accepting connections&quot;),
<a name="12826"/>12826:                                    ok;
<a name="12827"/>12827:                                {ok, false} -&gt;
<a name="12828"/>12828:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12829"/>12829:                                                &quot;Not accepting connections&quot;),
<a name="12830"/>12830:                                    {error, {unexpected_success, {Opt, false}}};
<a name="12831"/>12831:                                {error, Reason} = ERROR -&gt;
<a name="12832"/>12832:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12833"/>12833:                                    ERROR
<a name="12834"/>12834:                            end
<a name="12835"/>12835:                    end},
<a name="12836"/>12836:          #{desc =&gt; &quot;[set] verify listen socket (after listen)&quot;,
<a name="12837"/>12837:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12838"/>12838:                            case Set(Sock, false) of
<a name="12839"/>12839:                                {error, Reason} -&gt;
<a name="12840"/>12840:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12841"/>12841:                                    ok;
<a name="12842"/>12842:                                ok -&gt;
<a name="12843"/>12843:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12844"/>12844:                                                &quot;Set acceptconn (=false)&quot;),
<a name="12845"/>12845:                                    {error, unexpected_success}
<a name="12846"/>12846:                            end
<a name="12847"/>12847:                    end},
<a name="12848"/>12848: 
<a name="12849"/>12849:          ?SEV_SLEEP(?SECS(1)),
<a name="12850"/>12850: 
<a name="12851"/>12851:          #{desc =&gt; &quot;create (connecting) socket&quot;,
<a name="12852"/>12852:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12853"/>12853:                            case socket:open(Domain, stream, tcp) of
<a name="12854"/>12854:                                {ok, Sock} -&gt;
<a name="12855"/>12855:                                    {ok, State#{csockc =&gt; Sock}};
<a name="12856"/>12856:                                {error, _} = ERROR -&gt;
<a name="12857"/>12857:                                    ERROR
<a name="12858"/>12858:                            end
<a name="12859"/>12859:                    end},
<a name="12860"/>12860: 
<a name="12861"/>12861:          #{desc =&gt; &quot;bind connecting socket to local address&quot;,
<a name="12862"/>12862:            cmd  =&gt; fun(#{csockc := Sock, local_sa := LSA} = _State) -&gt;
<a name="12863"/>12863:                            case sock_bind(Sock, LSA) of
<a name="12864"/>12864:                                ok -&gt;
<a name="12865"/>12865:                                    ok;
<a name="12866"/>12866:                                {error, _} = ERROR -&gt;
<a name="12867"/>12867:                                    ERROR
<a name="12868"/>12868:                            end
<a name="12869"/>12869:                    end},
<a name="12870"/>12870: 
<a name="12871"/>12871:          ?SEV_SLEEP(?SECS(1)),
<a name="12872"/>12872: 
<a name="12873"/>12873:          #{desc =&gt; &quot;[get] verify connecting socket (before connect)&quot;,
<a name="12874"/>12874:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="12875"/>12875:                            case Get(Sock) of
<a name="12876"/>12876:                                {ok, false} -&gt;
<a name="12877"/>12877:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12878"/>12878:                                                &quot;Not accepting connections&quot;),
<a name="12879"/>12879:                                    ok;
<a name="12880"/>12880:                                {ok, true} -&gt;
<a name="12881"/>12881:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12882"/>12882:                                                &quot;Accepting connections&quot;),
<a name="12883"/>12883:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12884"/>12884:                                {error, Reason} = ERROR -&gt;
<a name="12885"/>12885:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12886"/>12886:                                    ERROR
<a name="12887"/>12887:                            end
<a name="12888"/>12888:                    end},
<a name="12889"/>12889:          #{desc =&gt; &quot;[set] verify connecting socket (before connect)&quot;,
<a name="12890"/>12890:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="12891"/>12891:                            case Set(Sock, true) of
<a name="12892"/>12892:                                {error, Reason} -&gt;
<a name="12893"/>12893:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12894"/>12894:                                    ok;
<a name="12895"/>12895:                                ok -&gt;
<a name="12896"/>12896:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12897"/>12897:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12898"/>12898:                                    {error, unexpected_success}
<a name="12899"/>12899:                            end
<a name="12900"/>12900:                    end},
<a name="12901"/>12901: 
<a name="12902"/>12902:          ?SEV_SLEEP(?SECS(1)),
<a name="12903"/>12903: 
<a name="12904"/>12904:          #{desc =&gt; &quot;connect to server&quot;,
<a name="12905"/>12905:            cmd  =&gt; fun(#{csockc := Sock, server_sa := SSA} = _State) -&gt;
<a name="12906"/>12906:                            case socket:connect(Sock, SSA) of
<a name="12907"/>12907:                                ok -&gt;
<a name="12908"/>12908:                                    ok;
<a name="12909"/>12909:                                {error, _} = ERROR -&gt;
<a name="12910"/>12910:                                    ERROR
<a name="12911"/>12911:                            end
<a name="12912"/>12912:                    end},
<a name="12913"/>12913: 
<a name="12914"/>12914:          #{desc =&gt; &quot;accept connection&quot;,
<a name="12915"/>12915:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="12916"/>12916:                            case socket:accept(Sock) of
<a name="12917"/>12917:                                {ok, CSock} -&gt;
<a name="12918"/>12918:                                    {ok, State#{csocks =&gt; CSock}};
<a name="12919"/>12919:                                {error, _} = ERROR -&gt;
<a name="12920"/>12920:                                    ERROR
<a name="12921"/>12921:                            end
<a name="12922"/>12922:                    end},
<a name="12923"/>12923: 
<a name="12924"/>12924:          #{desc =&gt; &quot;[get] verify connecting socket (after connect)&quot;,
<a name="12925"/>12925:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="12926"/>12926:                            case Get(Sock) of
<a name="12927"/>12927:                                {ok, false} -&gt;
<a name="12928"/>12928:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12929"/>12929:                                                &quot;Not accepting connections&quot;),
<a name="12930"/>12930:                                    ok;
<a name="12931"/>12931:                                {ok, true} -&gt;
<a name="12932"/>12932:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12933"/>12933:                                                &quot;Accepting connections&quot;),
<a name="12934"/>12934:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12935"/>12935:                                {error, Reason} = ERROR -&gt;
<a name="12936"/>12936:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12937"/>12937:                                    ERROR
<a name="12938"/>12938:                            end
<a name="12939"/>12939:                    end},
<a name="12940"/>12940:          #{desc =&gt; &quot;[set] verify connecting socket (after connect)&quot;,
<a name="12941"/>12941:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="12942"/>12942:                            case Set(Sock, true) of
<a name="12943"/>12943:                                {error, Reason} -&gt;
<a name="12944"/>12944:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12945"/>12945:                                    ok;
<a name="12946"/>12946:                                ok -&gt;
<a name="12947"/>12947:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12948"/>12948:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12949"/>12949:                                    {error, unexpected_success}
<a name="12950"/>12950:                            end
<a name="12951"/>12951:                    end},
<a name="12952"/>12952: 
<a name="12953"/>12953:          #{desc =&gt; &quot;[get] verify connected socket&quot;,
<a name="12954"/>12954:            cmd  =&gt; fun(#{csocks := Sock} = _State) -&gt;
<a name="12955"/>12955:                            case Get(Sock) of
<a name="12956"/>12956:                                {ok, false} -&gt;
<a name="12957"/>12957:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12958"/>12958:                                                &quot;Not accepting connections&quot;),
<a name="12959"/>12959:                                    ok;
<a name="12960"/>12960:                                {ok, true} -&gt;
<a name="12961"/>12961:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12962"/>12962:                                                &quot;Accepting connections&quot;),
<a name="12963"/>12963:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12964"/>12964:                                {error, Reason} = ERROR -&gt;
<a name="12965"/>12965:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12966"/>12966:                                    ERROR
<a name="12967"/>12967:                            end
<a name="12968"/>12968:                    end},
<a name="12969"/>12969:          #{desc =&gt; &quot;[set] verify connected socket&quot;,
<a name="12970"/>12970:            cmd  =&gt; fun(#{csocks := Sock} = _State) -&gt;
<a name="12971"/>12971:                            case Set(Sock, true) of
<a name="12972"/>12972:                                {error, Reason} -&gt;
<a name="12973"/>12973:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12974"/>12974:                                    ok;
<a name="12975"/>12975:                                ok -&gt;
<a name="12976"/>12976:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12977"/>12977:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12978"/>12978:                                    {error, unexpected_success}
<a name="12979"/>12979:                            end
<a name="12980"/>12980:                    end},
<a name="12981"/>12981: 
<a name="12982"/>12982:          #{desc =&gt; &quot;[get] verify listen socket (after connect)&quot;,
<a name="12983"/>12983:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12984"/>12984:                            case Get(Sock) of
<a name="12985"/>12985:                                {ok, true} -&gt;
<a name="12986"/>12986:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12987"/>12987:                                                &quot;Accepting connections&quot;),
<a name="12988"/>12988:                                    ok;
<a name="12989"/>12989:                                {ok, false} -&gt;
<a name="12990"/>12990:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12991"/>12991:                                                &quot;Not accepting connections&quot;),
<a name="12992"/>12992:                                    {error, {unexpected_success, {Opt, false}}};
<a name="12993"/>12993:                                {error, Reason} = ERROR -&gt;
<a name="12994"/>12994:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12995"/>12995:                                    ERROR
<a name="12996"/>12996:                            end
<a name="12997"/>12997:                    end},
<a name="12998"/>12998:          #{desc =&gt; &quot;[set] verify listen socket (after connect)&quot;,
<a name="12999"/>12999:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13000"/>13000:                            case Set(Sock, false) of
<a name="13001"/>13001:                                {error, Reason} -&gt;
<a name="13002"/>13002:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13003"/>13003:                                    ok;
<a name="13004"/>13004:                                ok -&gt;
<a name="13005"/>13005:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13006"/>13006:                                                &quot;Set acceptconn (=false)&quot;),
<a name="13007"/>13007:                                    {error, unexpected_success}
<a name="13008"/>13008:                            end
<a name="13009"/>13009:                    end},
<a name="13010"/>13010: 
<a name="13011"/>13011:          %% *** Termination ***
<a name="13012"/>13012:          #{desc =&gt; &quot;close connecting socket(s)&quot;,
<a name="13013"/>13013:            cmd  =&gt; fun(#{csockc := Sock} = State0) -&gt;
<a name="13014"/>13014:                            socket:close(Sock),
<a name="13015"/>13015:                            State1 = maps:remove(csockc, State0),
<a name="13016"/>13016:                            State2 = maps:remove(csocks, State1), %% Auto-close
<a name="13017"/>13017:                            {ok, maps:remove(csockc, State2)}
<a name="13018"/>13018:                    end},
<a name="13019"/>13019:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="13020"/>13020:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="13021"/>13021:                            socket:close(Sock),
<a name="13022"/>13022:                            {ok, maps:remove(lsock, State)}
<a name="13023"/>13023:                    end},
<a name="13024"/>13024: 
<a name="13025"/>13025:          %% *** We are done ***
<a name="13026"/>13026:          ?SEV_FINISH_NORMAL
<a name="13027"/>13027:         ],
<a name="13028"/>13028: 
<a name="13029"/>13029: 
<a name="13030"/>13030:     Domain = inet_or_inet6(),
<a name="13031"/>13031: 
<a name="13032"/>13032:     i(&quot;start tester evaluator&quot;),
<a name="13033"/>13033:     InitState = #{domain  =&gt; Domain},
<a name="13034"/>13034:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13035"/>13035: 
<a name="13036"/>13036:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_acceptconn_tcp-last_expr"/><a name="13037"/>13037: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13038"/>13038: 
<a name="13039"/>13039: 
<a name="13040"/>13040: 
<a name="13041"/>13041: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13042"/>13042: 
<a name="13043"/>13043: <i>%% Tests the socket option acceptfilter. PLACEHOLDER!</i>
<a name="13044"/>13044: 
<a name="api_opt_sock_acceptfilter-1"/><a name="13045"/>13045: <b>api_opt_sock_acceptfilter</b>(_Config) when is_list(_Config) -&gt;
<a name="13046"/>13046:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptfilter-last_expr"/><a name="13047"/>13047: <b>    tc_try</b>(api_opt_sock_acceptfilter,
<a name="13048"/>13048:            fun() -&gt; not_yet_implemented() end,
<a name="13049"/>13049:            fun() -&gt; ok end).
<a name="13050"/>13050: 
<a name="13051"/>13051: 
<a name="13052"/>13052: 
<a name="13053"/>13053: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13054"/>13054: 
<a name="13055"/>13055: <i>%% Tests the socket option bindtodevice.</i>
<a name="13056"/>13056: <i>%% It has not always been possible to 'get' this option</i>
<a name="13057"/>13057: <i>%% (at least on linux).</i>
<a name="13058"/>13058: 
<a name="api_opt_sock_bindtodevice-1"/><a name="13059"/>13059: <b>api_opt_sock_bindtodevice</b>(_Config) when is_list(_Config) -&gt;
<a name="13060"/>13060:     ?TT(?SECS(30)),
<a name="api_opt_sock_bindtodevice-last_expr"/><a name="13061"/>13061: <b>    tc_try</b>(api_opt_sock_bindtodevice,
<a name="13062"/>13062:            fun() -&gt; has_support_sock_bindtodevice() end,
<a name="13063"/>13063:            fun() -&gt; api_opt_sock_bindtodevice() end).
<a name="13064"/>13064: 
<a name="13065"/>13065: 
<a name="api_opt_sock_bindtodevice-0"/><a name="13066"/>13066: <b>api_opt_sock_bindtodevice</b>() -&gt;
<a name="13067"/>13067:     Opt = bindtodevice,
<a name="13068"/>13068:     Set = fun(S, Val) -&gt;
<a name="13069"/>13069:                   socket:setopt(S, socket, Opt, Val)
<a name="13070"/>13070:           end,
<a name="13071"/>13071:     Get = fun(S) -&gt;
<a name="13072"/>13072:                   socket:getopt(S, socket, Opt)
<a name="13073"/>13073:           end,
<a name="13074"/>13074: 
<a name="13075"/>13075:     TesterSeq =
<a name="13076"/>13076:         [
<a name="13077"/>13077:          #{desc =&gt; &quot;which local address&quot;,
<a name="13078"/>13078:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13079"/>13079:                            case which_local_host_info(Domain) of
<a name="13080"/>13080:                                {ok, #{name := Name, addr := Addr}} -&gt;
<a name="13081"/>13081:                                    ?SEV_IPRINT(&quot;local host info (~p): &quot;
<a name="13082"/>13082:                                                &quot;~n   Name: ~p&quot;
<a name="13083"/>13083:                                                &quot;~n   Addr: ~p&quot;,
<a name="13084"/>13084:                                                [Domain, Name, Addr]),
<a name="13085"/>13085:                                    LSA = #{family =&gt; Domain,
<a name="13086"/>13086:                                            addr   =&gt; Addr},
<a name="13087"/>13087:                                    {ok, State#{dev      =&gt; Name,
<a name="13088"/>13088:                                                local_sa =&gt; LSA}};
<a name="13089"/>13089:                                {error, _} = ERROR -&gt;
<a name="13090"/>13090:                                    ERROR
<a name="13091"/>13091:                            end
<a name="13092"/>13092:                    end},
<a name="13093"/>13093:          #{desc =&gt; &quot;create UDP socket 1&quot;,
<a name="13094"/>13094:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13095"/>13095:                            case socket:open(Domain, dgram, udp) of
<a name="13096"/>13096:                                {ok, Sock} -&gt;
<a name="13097"/>13097:                                    {ok, State#{usock1 =&gt; Sock}};
<a name="13098"/>13098:                                {error, _} = ERROR -&gt;
<a name="13099"/>13099:                                    ERROR
<a name="13100"/>13100:                            end
<a name="13101"/>13101:                    end},
<a name="13102"/>13102:          #{desc =&gt; &quot;create UDP socket 2&quot;,
<a name="13103"/>13103:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13104"/>13104:                            case socket:open(Domain, dgram, udp) of
<a name="13105"/>13105:                                {ok, Sock} -&gt;
<a name="13106"/>13106:                                    {ok, State#{usock2 =&gt; Sock}};
<a name="13107"/>13107:                                {error, _} = ERROR -&gt;
<a name="13108"/>13108:                                    ERROR
<a name="13109"/>13109:                            end
<a name="13110"/>13110:                    end},
<a name="13111"/>13111:          #{desc =&gt; &quot;create TCP socket 1&quot;,
<a name="13112"/>13112:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13113"/>13113:                            case socket:open(Domain, stream, tcp) of
<a name="13114"/>13114:                                {ok, Sock} -&gt;
<a name="13115"/>13115:                                    {ok, State#{tsock1 =&gt; Sock}};
<a name="13116"/>13116:                                {error, _} = ERROR -&gt;
<a name="13117"/>13117:                                    ERROR
<a name="13118"/>13118:                            end
<a name="13119"/>13119:                    end},
<a name="13120"/>13120:          #{desc =&gt; &quot;create TCP socket 2&quot;,
<a name="13121"/>13121:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13122"/>13122:                            case socket:open(Domain, stream, tcp) of
<a name="13123"/>13123:                                {ok, Sock} -&gt;
<a name="13124"/>13124:                                    {ok, State#{tsock2 =&gt; Sock}};
<a name="13125"/>13125:                                {error, _} = ERROR -&gt;
<a name="13126"/>13126:                                    ERROR
<a name="13127"/>13127:                            end
<a name="13128"/>13128:                    end},
<a name="13129"/>13129: 
<a name="13130"/>13130:          #{desc =&gt; &quot;[get] verify UDP socket 1 (before bindtodevice)&quot;,
<a name="13131"/>13131:            cmd  =&gt; fun(#{usock1 := Sock} = _State) -&gt;
<a name="13132"/>13132:                            case Get(Sock) of
<a name="13133"/>13133:                                {ok, Dev} -&gt;
<a name="13134"/>13134:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13135"/>13135:                                    ok;
<a name="13136"/>13136:                                {error, enoprotoopt = Reason} -&gt;
<a name="13137"/>13137:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="13138"/>13138: 					       [Reason]),
<a name="13139"/>13139:                                    {skip, Reason};
<a name="13140"/>13140:                                {error, Reason} = ERROR -&gt;
<a name="13141"/>13141:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13142"/>13142: 					       [Reason]),
<a name="13143"/>13143:                                    ERROR
<a name="13144"/>13144:                            end
<a name="13145"/>13145:                    end},
<a name="13146"/>13146:          #{desc =&gt; &quot;[get] verify UDP socket 2 (before bind)&quot;,
<a name="13147"/>13147:            cmd  =&gt; fun(#{usock2 := Sock} = _State) -&gt;
<a name="13148"/>13148:                            case Get(Sock) of
<a name="13149"/>13149:                                {ok, Dev} -&gt;
<a name="13150"/>13150:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13151"/>13151:                                    ok;
<a name="13152"/>13152:                                {error, Reason} = ERROR -&gt;
<a name="13153"/>13153:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13154"/>13154:                                    ERROR
<a name="13155"/>13155:                            end
<a name="13156"/>13156:                    end},
<a name="13157"/>13157:          #{desc =&gt; &quot;[get] verify TCP socket 1 (before bindtodevice)&quot;,
<a name="13158"/>13158:            cmd  =&gt; fun(#{tsock1 := Sock} = _State) -&gt;
<a name="13159"/>13159:                            case Get(Sock) of
<a name="13160"/>13160:                                {ok, Dev} -&gt;
<a name="13161"/>13161:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13162"/>13162:                                    ok;
<a name="13163"/>13163:                                {error, Reason} = ERROR -&gt;
<a name="13164"/>13164:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13165"/>13165:                                    ERROR
<a name="13166"/>13166:                            end
<a name="13167"/>13167:                    end},
<a name="13168"/>13168:          #{desc =&gt; &quot;[get] verify TCP socket 2 (before bind)&quot;,
<a name="13169"/>13169:            cmd  =&gt; fun(#{tsock2 := Sock} = _State) -&gt;
<a name="13170"/>13170:                            case Get(Sock) of
<a name="13171"/>13171:                                {ok, Dev} -&gt;
<a name="13172"/>13172:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13173"/>13173:                                    ok;
<a name="13174"/>13174:                                {error, Reason} = ERROR -&gt;
<a name="13175"/>13175:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13176"/>13176:                                    ERROR
<a name="13177"/>13177:                            end
<a name="13178"/>13178:                    end},
<a name="13179"/>13179: 
<a name="13180"/>13180:          ?SEV_SLEEP(?SECS(1)),
<a name="13181"/>13181: 
<a name="13182"/>13182:          #{desc =&gt; &quot;Bind UDP socket 1 to device&quot;,
<a name="13183"/>13183:            cmd  =&gt; fun(#{usock1 := Sock, dev := Dev} = State) -&gt;
<a name="13184"/>13184:                            case Set(Sock, Dev) of
<a name="13185"/>13185:                                ok -&gt;
<a name="13186"/>13186:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13187"/>13187:                                    ok;
<a name="13188"/>13188:                                {error, eperm = Reason} -&gt;
<a name="13189"/>13189:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13190"/>13190:                                    (catch socket:close(Sock)),
<a name="13191"/>13191:                                    {ok, State#{usock1 =&gt; skip}};
<a name="13192"/>13192:                                {error, Reason} = ERROR -&gt;
<a name="13193"/>13193:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13194"/>13194:                                    ERROR
<a name="13195"/>13195:                            end
<a name="13196"/>13196:                    end},
<a name="13197"/>13197:          #{desc =&gt; &quot;Bind UDP socket 2 to local address&quot;,
<a name="13198"/>13198:            cmd  =&gt; fun(#{usock2 := Sock, local_sa := LSA} = _State) -&gt;
<a name="13199"/>13199:                            case sock_bind(Sock, LSA) of
<a name="13200"/>13200:                                ok -&gt;
<a name="13201"/>13201:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13202"/>13202:                                    ok;
<a name="13203"/>13203:                                {error, Reason} = ERROR -&gt;
<a name="13204"/>13204:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13205"/>13205:                                    ERROR
<a name="13206"/>13206:                            end
<a name="13207"/>13207:                    end},
<a name="13208"/>13208:          #{desc =&gt; &quot;Bind TCP socket 1 to device&quot;,
<a name="13209"/>13209:            cmd  =&gt; fun(#{usock1 := USock1,
<a name="13210"/>13210:                          tsock1 := Sock, dev := Dev} = State) -&gt;
<a name="13211"/>13211:                            case Set(Sock, Dev) of
<a name="13212"/>13212:                                ok -&gt;
<a name="13213"/>13213:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13214"/>13214:                                    ok;
<a name="13215"/>13215:                                {error, eperm = Reason} when (USock1 =:= skip) -&gt;
<a name="13216"/>13216:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13217"/>13217:                                    {skip, Reason};
<a name="13218"/>13218:                                {error, eperm = Reason} -&gt;
<a name="13219"/>13219:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13220"/>13220:                                    (catch socket:close(Sock)),
<a name="13221"/>13221:                                    {ok, State#{tsock1 =&gt; skip}};
<a name="13222"/>13222:                                {error, Reason} = ERROR -&gt;
<a name="13223"/>13223:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13224"/>13224:                                    ERROR
<a name="13225"/>13225:                            end
<a name="13226"/>13226:                    end},
<a name="13227"/>13227:          #{desc =&gt; &quot;Bind TCP socket 2 to local address&quot;,
<a name="13228"/>13228:            cmd  =&gt; fun(#{tsock2 := Sock, local_sa := LSA} = _State) -&gt;
<a name="13229"/>13229:                            case sock_bind(Sock, LSA) of
<a name="13230"/>13230:                                ok -&gt;
<a name="13231"/>13231:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13232"/>13232:                                    ok;
<a name="13233"/>13233:                                {error, Reason} = ERROR -&gt;
<a name="13234"/>13234:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13235"/>13235:                                    ERROR
<a name="13236"/>13236:                            end
<a name="13237"/>13237:                    end},
<a name="13238"/>13238: 
<a name="13239"/>13239:          ?SEV_SLEEP(?SECS(1)),
<a name="13240"/>13240: 
<a name="13241"/>13241:          #{desc =&gt; &quot;[get] verify UDP socket 1 (after bindtodevice)&quot;,
<a name="13242"/>13242:            cmd  =&gt; fun(#{usock1 := skip} = _State) -&gt;
<a name="13243"/>13243:                            ?SEV_IPRINT(&quot;SKIP'ed (previous eperm)&quot;),
<a name="13244"/>13244:                            ok;
<a name="13245"/>13245:                       (#{usock1 := Sock} = _State) -&gt;
<a name="13246"/>13246:                            case Get(Sock) of
<a name="13247"/>13247:                                {ok, Dev} -&gt;
<a name="13248"/>13248:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13249"/>13249:                                    ok;
<a name="13250"/>13250:                                {error, Reason} = ERROR -&gt;
<a name="13251"/>13251:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13252"/>13252:                                    ERROR
<a name="13253"/>13253:                            end
<a name="13254"/>13254:                    end},
<a name="13255"/>13255:          #{desc =&gt; &quot;[get] verify UDP socket 2 (after bind)&quot;,
<a name="13256"/>13256:            cmd  =&gt; fun(#{usock2 := Sock} = _State) -&gt;
<a name="13257"/>13257:                            case Get(Sock) of
<a name="13258"/>13258:                                {ok, Dev} -&gt;
<a name="13259"/>13259:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13260"/>13260:                                    ok;
<a name="13261"/>13261:                                {error, Reason} = ERROR -&gt;
<a name="13262"/>13262:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13263"/>13263:                                    ERROR
<a name="13264"/>13264:                            end
<a name="13265"/>13265:                    end},
<a name="13266"/>13266:          #{desc =&gt; &quot;[get] verify TCP socket 1 (after bindtodevice)&quot;,
<a name="13267"/>13267:            cmd  =&gt; fun(#{tsock1 := skip} = _State) -&gt;
<a name="13268"/>13268:                            ?SEV_IPRINT(&quot;SKIP'ed (previous eperm)&quot;),
<a name="13269"/>13269:                            ok;
<a name="13270"/>13270:                       (#{tsock1 := Sock} = _State) -&gt;
<a name="13271"/>13271:                            case Get(Sock) of
<a name="13272"/>13272:                                {ok, Dev} -&gt;
<a name="13273"/>13273:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13274"/>13274:                                    ok;
<a name="13275"/>13275:                                {error, Reason} = ERROR -&gt;
<a name="13276"/>13276:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13277"/>13277:                                    ERROR
<a name="13278"/>13278:                            end
<a name="13279"/>13279:                    end},
<a name="13280"/>13280:          #{desc =&gt; &quot;[get] verify TCP socket 2 (after bind)&quot;,
<a name="13281"/>13281:            cmd  =&gt; fun(#{tsock2 := Sock} = _State) -&gt;
<a name="13282"/>13282:                            case Get(Sock) of
<a name="13283"/>13283:                                {ok, Dev} -&gt;
<a name="13284"/>13284:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13285"/>13285:                                    ok;
<a name="13286"/>13286:                                {error, Reason} = ERROR -&gt;
<a name="13287"/>13287:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13288"/>13288:                                    ERROR
<a name="13289"/>13289:                            end
<a name="13290"/>13290:                    end},
<a name="13291"/>13291: 
<a name="13292"/>13292:          ?SEV_SLEEP(?SECS(1)),
<a name="13293"/>13293: 
<a name="13294"/>13294:          %% *** Termination ***
<a name="13295"/>13295:          #{desc =&gt; &quot;close UDP socket 1&quot;,
<a name="13296"/>13296:            cmd  =&gt; fun(#{usock1 := skip} = State) -&gt;
<a name="13297"/>13297:                            ?SEV_IPRINT(&quot;SKIP'ed (already closed)&quot;),
<a name="13298"/>13298:                            {ok, maps:remove(usock1, State)};
<a name="13299"/>13299:                       (#{usock1 := Sock} = State) -&gt;
<a name="13300"/>13300:                            socket:close(Sock),
<a name="13301"/>13301:                            {ok, maps:remove(usock1, State)}
<a name="13302"/>13302:                    end},
<a name="13303"/>13303:          #{desc =&gt; &quot;close UDP socket 2&quot;,
<a name="13304"/>13304:            cmd  =&gt; fun(#{usock2 := Sock} = State) -&gt;
<a name="13305"/>13305:                            socket:close(Sock),
<a name="13306"/>13306:                            {ok, maps:remove(usock2, State)}
<a name="13307"/>13307:                    end},
<a name="13308"/>13308:          #{desc =&gt; &quot;close TCP socket 1&quot;,
<a name="13309"/>13309:            cmd  =&gt; fun(#{tsock1 := skip} = State) -&gt;
<a name="13310"/>13310:                            ?SEV_IPRINT(&quot;SKIP'ed (already closed)&quot;),
<a name="13311"/>13311:                            {ok, maps:remove(tsock1, State)};
<a name="13312"/>13312:                       (#{tsock1 := Sock} = State) -&gt;
<a name="13313"/>13313:                            socket:close(Sock),
<a name="13314"/>13314:                            {ok, maps:remove(tsock1, State)}
<a name="13315"/>13315:                    end},
<a name="13316"/>13316:          #{desc =&gt; &quot;close TCP socket 2&quot;,
<a name="13317"/>13317:            cmd  =&gt; fun(#{tsock2 := Sock} = State) -&gt;
<a name="13318"/>13318:                            socket:close(Sock),
<a name="13319"/>13319:                            {ok, maps:remove(tsock2, State)}
<a name="13320"/>13320:                    end},
<a name="13321"/>13321: 
<a name="13322"/>13322:          %% *** We are done ***
<a name="13323"/>13323:          ?SEV_FINISH_NORMAL
<a name="13324"/>13324:         ],
<a name="13325"/>13325: 
<a name="13326"/>13326:     Domain = inet_or_inet6(),
<a name="13327"/>13327: 
<a name="13328"/>13328:     i(&quot;start tester evaluator&quot;),
<a name="13329"/>13329:     InitState = #{domain  =&gt; Domain},
<a name="13330"/>13330:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13331"/>13331: 
<a name="13332"/>13332:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_bindtodevice-last_expr"/><a name="13333"/>13333: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13334"/>13334: 
<a name="13335"/>13335: 
<a name="13336"/>13336: 
<a name="13337"/>13337: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13338"/>13338: 
<a name="13339"/>13339: <i>%% Tests the socket option broadcast.</i>
<a name="13340"/>13340: <i>%% Make it possible for datagram sockets to send packets to a broadcast</i>
<a name="13341"/>13341: <i>%% address (IPv4 only).</i>
<a name="13342"/>13342: 
<a name="api_opt_sock_broadcast-1"/><a name="13343"/>13343: <b>api_opt_sock_broadcast</b>(_Config) when is_list(_Config) -&gt;
<a name="13344"/>13344:     ?TT(?SECS(30)),
<a name="api_opt_sock_broadcast-last_expr"/><a name="13345"/>13345: <b>    tc_try</b>(api_opt_sock_broadcast,
<a name="13346"/>13346:            fun() -&gt; has_support_sock_broadcast() end,
<a name="13347"/>13347:            fun() -&gt; api_opt_sock_broadcast() end).
<a name="13348"/>13348: 
<a name="13349"/>13349: 
<a name="api_opt_sock_broadcast-0"/><a name="13350"/>13350: <b>api_opt_sock_broadcast</b>() -&gt;
<a name="13351"/>13351:     Opt    = broadcast,
<a name="13352"/>13352:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="13353"/>13353:                      socket:setopt(S, socket, Opt, Val)
<a name="13354"/>13354:              end,
<a name="13355"/>13355:     Get    = fun(S) -&gt;
<a name="13356"/>13356:                      socket:getopt(S, socket, Opt)
<a name="13357"/>13357:              end,
<a name="13358"/>13358: 
<a name="13359"/>13359:     TesterSeq =
<a name="13360"/>13360:         [
<a name="13361"/>13361:          #{desc =&gt; &quot;which local address&quot;,
<a name="13362"/>13362:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13363"/>13363:                            case which_local_host_info(Domain) of
<a name="13364"/>13364:                                {ok, #{name      := Name,
<a name="13365"/>13365:                                       addr      := Addr,
<a name="13366"/>13366:                                       broadaddr := BAddr}}
<a name="13367"/>13367: 				 when (BAddr =/= undefined) -&gt;
<a name="13368"/>13368:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="13369"/>13369:                                                &quot;~n   Name:           ~p&quot;
<a name="13370"/>13370:                                                &quot;~n   Addr:           ~p&quot;
<a name="13371"/>13371:                                                &quot;~n   Broadcast Addr: ~p&quot;,
<a name="13372"/>13372:                                                [Name, Addr, BAddr]),
<a name="13373"/>13373:                                    LSA = #{family =&gt; Domain,
<a name="13374"/>13374:                                            addr   =&gt; Addr},
<a name="13375"/>13375:                                    BSA = #{family =&gt; Domain,
<a name="13376"/>13376:                                            addr   =&gt; BAddr},
<a name="13377"/>13377:                                    {ok, State#{lsa =&gt; LSA,
<a name="13378"/>13378:                                                bsa =&gt; BSA}};
<a name="13379"/>13379: 			       {ok, _} -&gt;
<a name="13380"/>13380: 				   {skip, no_broadcast_address};
<a name="13381"/>13381:                                {error, _} = ERROR -&gt;
<a name="13382"/>13382:                                    ERROR
<a name="13383"/>13383:                            end
<a name="13384"/>13384:                    end},
<a name="13385"/>13385: 
<a name="13386"/>13386:          #{desc =&gt; &quot;[socket 1] create UDP socket (listening 1)&quot;,
<a name="13387"/>13387:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13388"/>13388:                            case socket:open(Domain, dgram, udp) of
<a name="13389"/>13389:                                {ok, Sock} -&gt;
<a name="13390"/>13390:                                    {ok, State#{sock1 =&gt; Sock}};
<a name="13391"/>13391:                                {error, _} = ERROR -&gt;
<a name="13392"/>13392:                                    ERROR
<a name="13393"/>13393:                            end
<a name="13394"/>13394:                    end},
<a name="13395"/>13395:          #{desc =&gt; &quot;[socket 1] Bind UDP socket (to limited broadcast address)&quot;,
<a name="13396"/>13396:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="13397"/>13397: 			   BSA = #{family =&gt; inet,
<a name="13398"/>13398: 				   addr   =&gt; broadcast},
<a name="13399"/>13399:                            ?SEV_IPRINT(&quot;Try bind (socket 1) to: &quot;
<a name="13400"/>13400:                                        &quot;~n   ~p&quot;, [BSA]),
<a name="13401"/>13401:                            case socket:bind(Sock, BSA) of
<a name="13402"/>13402:                                ok -&gt;
<a name="13403"/>13403:                                    Port = sock_port(Sock),
<a name="13404"/>13404:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="13405"/>13405:                                                [Port]),
<a name="13406"/>13406:                                    {ok, State#{sa1 =&gt; BSA#{port =&gt; Port}}};
<a name="13407"/>13407:                                {error, eaddrnotavail = Reason} -&gt;
<a name="13408"/>13408:                                    ?SEV_IPRINT(&quot;~p =&gt; &quot;
<a name="13409"/>13409: 					       &quot;SKIP limited broadcast test&quot;,
<a name="13410"/>13410: 					       [Reason]),
<a name="13411"/>13411:                                    {ok, State#{sa1 =&gt; skip}};
<a name="13412"/>13412:                                {error, Reason} = ERROR -&gt;
<a name="13413"/>13413:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13414"/>13414: 					       [Reason]),
<a name="13415"/>13415:                                    ERROR
<a name="13416"/>13416:                            end
<a name="13417"/>13417:                    end},
<a name="13418"/>13418:          #{desc =&gt; &quot;[socket 1] UDP socket sockname&quot;,
<a name="13419"/>13419:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="13420"/>13420:                            ?SEV_IPRINT(&quot;SKIP limited broadcast test&quot;),
<a name="13421"/>13421:                            ok;
<a name="13422"/>13422: 		      (#{sock1 := Sock} = _State) -&gt;
<a name="13423"/>13423: 			   case socket:sockname(Sock) of
<a name="13424"/>13424: 			       {ok, SA} -&gt;
<a name="13425"/>13425: 				   ?SEV_IPRINT(&quot;SA: ~p&quot;, [SA]),
<a name="13426"/>13426: 				   ok;
<a name="13427"/>13427: 			       {error, _} = ERROR -&gt;
<a name="13428"/>13428: 				   ERROR
<a name="13429"/>13429: 			   end
<a name="13430"/>13430:                    end},
<a name="13431"/>13431: 
<a name="13432"/>13432:          ?SEV_SLEEP(?SECS(1)),
<a name="13433"/>13433: 
<a name="13434"/>13434:          #{desc =&gt; &quot;[socket 2] create UDP socket (listening 2)&quot;,
<a name="13435"/>13435:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13436"/>13436:                            case socket:open(Domain, dgram, udp) of
<a name="13437"/>13437:                                {ok, Sock} -&gt;
<a name="13438"/>13438:                                    {ok, State#{sock2 =&gt; Sock}};
<a name="13439"/>13439:                                {error, _} = ERROR -&gt;
<a name="13440"/>13440:                                    ERROR
<a name="13441"/>13441:                            end
<a name="13442"/>13442:                    end},
<a name="13443"/>13443:          #{desc =&gt; &quot;[socket 2] Bind UDP socket (to subnet-directed broadcast address)&quot;,
<a name="13444"/>13444:            cmd  =&gt; fun(#{sock2 := Sock,
<a name="13445"/>13445: 			 bsa   := BSA} = State) -&gt;
<a name="13446"/>13446:                            ?SEV_IPRINT(&quot;Try bind (socket 1) to: &quot;
<a name="13447"/>13447:                                        &quot;~n   ~p&quot;, [BSA]),
<a name="13448"/>13448:                            case socket:bind(Sock, BSA) of
<a name="13449"/>13449:                                ok -&gt;
<a name="13450"/>13450:                                    Port = sock_port(Sock),
<a name="13451"/>13451:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="13452"/>13452:                                                [Port]),
<a name="13453"/>13453:                                    {ok, State#{sa2 =&gt; BSA#{port =&gt; Port}}};
<a name="13454"/>13454:                                {error, eaddrnotavail = Reason} -&gt;
<a name="13455"/>13455:                                    ?SEV_IPRINT(&quot;~p =&gt; &quot;
<a name="13456"/>13456: 					       &quot;SKIP subnet-directed broadcast test&quot;,
<a name="13457"/>13457: 					       [Reason]),
<a name="13458"/>13458:                                    {ok, State#{sa2 =&gt; skip}};
<a name="13459"/>13459:                                {error, Reason} = ERROR -&gt;
<a name="13460"/>13460:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13461"/>13461: 					       [Reason]),
<a name="13462"/>13462:                                    ERROR
<a name="13463"/>13463:                            end
<a name="13464"/>13464:                    end},
<a name="13465"/>13465:          #{desc =&gt; &quot;[socket 2] UDP socket sockname&quot;,
<a name="13466"/>13466:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="13467"/>13467:                            ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test&quot;),
<a name="13468"/>13468:                            ok;
<a name="13469"/>13469: 		      (#{sock2 := Sock} = _State) -&gt;
<a name="13470"/>13470:                            case socket:sockname(Sock) of
<a name="13471"/>13471:                                {ok, SA} -&gt;
<a name="13472"/>13472: 				   ?SEV_IPRINT(&quot;SA: ~p&quot;, [SA]),
<a name="13473"/>13473:                                    ok;
<a name="13474"/>13474:                                {error, _} = ERROR -&gt;
<a name="13475"/>13475:                                    ERROR
<a name="13476"/>13476:                            end
<a name="13477"/>13477:                    end},
<a name="13478"/>13478: 
<a name="13479"/>13479:          ?SEV_SLEEP(?SECS(1)),
<a name="13480"/>13480: 
<a name="13481"/>13481:          #{desc =&gt; &quot;[socket 3] create UDP socket (sender)&quot;,
<a name="13482"/>13482:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13483"/>13483:                            case socket:open(Domain, dgram, udp) of
<a name="13484"/>13484:                                {ok, Sock} -&gt;
<a name="13485"/>13485:                                    {ok, State#{sock3 =&gt; Sock}};
<a name="13486"/>13486:                                {error, _} = ERROR -&gt;
<a name="13487"/>13487:                                    ERROR
<a name="13488"/>13488:                            end
<a name="13489"/>13489:                    end},
<a name="13490"/>13490:          #{desc =&gt; &quot;[socket 3][get] verify UDP socket (before bind and set)&quot;,
<a name="13491"/>13491:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="13492"/>13492:                            case Get(Sock) of
<a name="13493"/>13493:                                {ok, false} -&gt;
<a name="13494"/>13494:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13495"/>13495:                                                &quot;broadcast not allowed&quot;),
<a name="13496"/>13496:                                    ok;
<a name="13497"/>13497:                                {ok, true} -&gt;
<a name="13498"/>13498:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="13499"/>13499:                                                &quot;broadcast already allowed&quot;),
<a name="13500"/>13500:                                    ok;
<a name="13501"/>13501:                                {error, Reason} = ERROR -&gt;
<a name="13502"/>13502:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13503"/>13503: 					       [Reason]),
<a name="13504"/>13504:                                    ERROR
<a name="13505"/>13505:                            end
<a name="13506"/>13506:                    end},
<a name="13507"/>13507:          #{desc =&gt; &quot;[socket 3] Try make broadcast allowed&quot;,
<a name="13508"/>13508:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="13509"/>13509:                            case Set(Sock, true) of
<a name="13510"/>13510:                                ok -&gt;
<a name="13511"/>13511:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13512"/>13512:                                                &quot;broadcast now allowed&quot;),
<a name="13513"/>13513:                                    ok;
<a name="13514"/>13514:                                {error, Reason} = ERROR -&gt;
<a name="13515"/>13515:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13516"/>13516: 					       [Reason]),
<a name="13517"/>13517:                                    ERROR
<a name="13518"/>13518:                            end
<a name="13519"/>13519:                    end},
<a name="13520"/>13520:          #{desc =&gt; &quot;[socket 3] verify UDP socket broadcast allowed&quot;,
<a name="13521"/>13521:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="13522"/>13522:                            case Get(Sock) of
<a name="13523"/>13523:                                {ok, true} -&gt;
<a name="13524"/>13524:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13525"/>13525:                                                &quot;broadcast allowed&quot;),
<a name="13526"/>13526:                                    ok;
<a name="13527"/>13527:                                {ok, false} -&gt;
<a name="13528"/>13528:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="13529"/>13529:                                                &quot;broadcast *not* allowed&quot;),
<a name="13530"/>13530:                                    ok;
<a name="13531"/>13531:                                {error, Reason} = ERROR -&gt;
<a name="13532"/>13532:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13533"/>13533: 					       [Reason]),
<a name="13534"/>13534:                                    ERROR
<a name="13535"/>13535:                            end
<a name="13536"/>13536:                    end},
<a name="13537"/>13537:          #{desc =&gt; &quot;[socket 3] Bind UDP socket (to local address)&quot;,
<a name="13538"/>13538:            cmd  =&gt; fun(#{sock3 := Sock, lsa := LSA} = State) -&gt;
<a name="13539"/>13539:                            ?SEV_IPRINT(&quot;Try bind (socket 2) to: &quot;
<a name="13540"/>13540:                                        &quot;~n   ~p&quot;, [LSA]),
<a name="13541"/>13541:                            case socket:bind(Sock, LSA) of
<a name="13542"/>13542:                                ok -&gt;
<a name="13543"/>13543:                                    Port = sock_port(Sock),
<a name="13544"/>13544:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="13545"/>13545:                                                [Port]),
<a name="13546"/>13546:                                    {ok, State#{sa3 =&gt; LSA#{port =&gt; Port}}};
<a name="13547"/>13547:                                {error, Reason} = ERROR -&gt;
<a name="13548"/>13548:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13549"/>13549: 					       [Reason]),
<a name="13550"/>13550:                                    ERROR
<a name="13551"/>13551:                            end
<a name="13552"/>13552:                    end},
<a name="13553"/>13553:          #{desc =&gt; &quot;[socket 3] verify UDP socket (after set)&quot;,
<a name="13554"/>13554:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="13555"/>13555:                            case Get(Sock) of
<a name="13556"/>13556:                                {ok, true} -&gt;
<a name="13557"/>13557:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13558"/>13558:                                                &quot;broadcast allowed&quot;),
<a name="13559"/>13559:                                    ok;
<a name="13560"/>13560:                                {ok, false} -&gt;
<a name="13561"/>13561:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="13562"/>13562:                                                &quot;broadcast not allowed&quot;),
<a name="13563"/>13563:                                    {error, not_allowed};
<a name="13564"/>13564:                                {error, Reason} = ERROR -&gt;
<a name="13565"/>13565:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13566"/>13566: 					       [Reason]),
<a name="13567"/>13567:                                    ERROR
<a name="13568"/>13568:                            end
<a name="13569"/>13569:                    end},
<a name="13570"/>13570: 
<a name="13571"/>13571: 	 ?SEV_SLEEP(?SECS(1)),
<a name="13572"/>13572: 
<a name="13573"/>13573:          #{desc =&gt; &quot;[socket 3] try send to limited broadcast address&quot;,
<a name="13574"/>13574:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="13575"/>13575:                            ?SEV_IPRINT(&quot;SKIP limited broadcast test (send)&quot;),
<a name="13576"/>13576: 			   ok;
<a name="13577"/>13577: 		      (#{sock3 := Sock,
<a name="13578"/>13578: 			 sa1   := Dest} = _State) -&gt;
<a name="13579"/>13579: 			   Data = list_to_binary(&quot;hejsan&quot;),
<a name="13580"/>13580: 			   ?SEV_IPRINT(&quot;try send to broadcast address: &quot;
<a name="13581"/>13581: 				       &quot;~n   ~p&quot;, [Dest]),
<a name="13582"/>13582: 			   case socket:sendto(Sock, Data, Dest) of
<a name="13583"/>13583: 			       ok -&gt;
<a name="13584"/>13584: 				   ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13585"/>13585: 					       &quot;broadcast message sent&quot;),
<a name="13586"/>13586: 				   ok;
<a name="13587"/>13587: 			       {error, Reason} = ERROR -&gt;
<a name="13588"/>13588: 				   ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13589"/>13589: 					       [Reason]),
<a name="13590"/>13590: 				   ERROR
<a name="13591"/>13591: 			   end
<a name="13592"/>13592: 		   end},
<a name="13593"/>13593:          #{desc =&gt; &quot;[socket 1] try recv&quot;,
<a name="13594"/>13594:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="13595"/>13595: 			   ?SEV_IPRINT(&quot;SKIP limited broadcast test (recv)&quot;),
<a name="13596"/>13596: 			   ok;
<a name="13597"/>13597: 		      (#{sock1 := Sock} = State) -&gt;
<a name="13598"/>13598:                            case socket:recvfrom(Sock, 0, 5000) of
<a name="13599"/>13599:                                {ok, _} -&gt;
<a name="13600"/>13600:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13601"/>13601:                                                &quot;received message&quot;),
<a name="13602"/>13602:                                    ok;
<a name="13603"/>13603:                                {error, timeout = Reason} -&gt;
<a name="13604"/>13604:                                    %% Some platforms seem to balk at this.
<a name="13605"/>13605:                                    %% It spossible to bind to this, and
<a name="13606"/>13606:                                    %% send to it, but no data is received.
<a name="13607"/>13607:                                    %% At some point we should investigate...
<a name="13608"/>13608:                                    %% For now, we just skip this part of
<a name="13609"/>13609:                                    %% the test...
<a name="13610"/>13610:                                    ?SEV_IPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13611"/>13611: 					       [Reason]),
<a name="13612"/>13612:                                    {ok, State#{sa1 =&gt; skip}};
<a name="13613"/>13613:                                {error, Reason} = ERROR -&gt;
<a name="13614"/>13614:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13615"/>13615: 					       [Reason]),
<a name="13616"/>13616:                                    ERROR
<a name="13617"/>13617:                            end
<a name="13618"/>13618:                    end},
<a name="13619"/>13619: 
<a name="13620"/>13620: 	 ?SEV_SLEEP(?SECS(1)),
<a name="13621"/>13621: 
<a name="13622"/>13622:          #{desc =&gt; &quot;[socket 2] try send to subnet-directed broadcast address&quot;,
<a name="13623"/>13623:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="13624"/>13624: 			   ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test &quot;
<a name="13625"/>13625:                                        &quot;(send)&quot;),
<a name="13626"/>13626: 			   ok;
<a name="13627"/>13627: 		      (#{sock2 := Sock,
<a name="13628"/>13628:                          sa2   := Dest} = _State) -&gt;
<a name="13629"/>13629:                            Data = list_to_binary(&quot;hejsan&quot;),
<a name="13630"/>13630:                            ?SEV_IPRINT(&quot;try send to broadcast address: &quot;
<a name="13631"/>13631:                                        &quot;~n   ~p&quot;, [Dest]),
<a name="13632"/>13632:                            case socket:sendto(Sock, Data, Dest) of
<a name="13633"/>13633:                                ok -&gt;
<a name="13634"/>13634:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13635"/>13635:                                                &quot;broadcast message sent&quot;),
<a name="13636"/>13636:                                    ok;
<a name="13637"/>13637:                                {error, eaddrnotavail = Reason} -&gt;
<a name="13638"/>13638:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="13639"/>13639:                                                [Reason]),
<a name="13640"/>13640:                                    {skip, Reason};
<a name="13641"/>13641:                                {error, eacces = Reason} -&gt;
<a name="13642"/>13642:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="13643"/>13643: 					       [Reason]),
<a name="13644"/>13644:                                    {skip, Reason};
<a name="13645"/>13645:                                {error, Reason} = ERROR -&gt;
<a name="13646"/>13646:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13647"/>13647: 					       [Reason]),
<a name="13648"/>13648:                                    ERROR
<a name="13649"/>13649:                            end
<a name="13650"/>13650:                    end},
<a name="13651"/>13651:          #{desc =&gt; &quot;[socket 2] try recv&quot;,
<a name="13652"/>13652:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="13653"/>13653: 			   ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test &quot;
<a name="13654"/>13654:                                          &quot;(recv)&quot;),
<a name="13655"/>13655: 			   ok;
<a name="13656"/>13656: 		      (#{sock2 := Sock, sa2 := SA2} = _State) -&gt;
<a name="13657"/>13657:                            case socket:recvfrom(Sock, 0, 5000) of
<a name="13658"/>13658:                                {ok, _} -&gt;
<a name="13659"/>13659:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13660"/>13660:                                                &quot;received message&quot;),
<a name="13661"/>13661:                                    ok;
<a name="13662"/>13662:                                {error, timeout = Reason} when (SA2 =:= skip) -&gt;
<a name="13663"/>13663:                                    ?SEV_IPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13664"/>13664: 					       [Reason]),
<a name="13665"/>13665:                                    {skip, &quot;receive timeout&quot;};
<a name="13666"/>13666:                                {error, Reason} = ERROR -&gt;
<a name="13667"/>13667:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13668"/>13668: 					       [Reason]),
<a name="13669"/>13669:                                    ERROR
<a name="13670"/>13670:                            end
<a name="13671"/>13671:                    end},
<a name="13672"/>13672: 
<a name="13673"/>13673:          %% *** Termination ***
<a name="13674"/>13674:          #{desc =&gt; &quot;[socket 3] close UDP socket (sender)&quot;,
<a name="13675"/>13675:            cmd  =&gt; fun(#{sock3 := Sock} = State0) -&gt;
<a name="13676"/>13676:                            socket:close(Sock),
<a name="13677"/>13677: 			   State1 = maps:remove(sock3, State0),
<a name="13678"/>13678: 			   State2 = maps:remove(sa3,   State1),
<a name="13679"/>13679: 			   {ok, State2}
<a name="13680"/>13680:                    end},
<a name="13681"/>13681:          #{desc =&gt; &quot;[socket 2] close UDP socket (listener 2)&quot;,
<a name="13682"/>13682:            cmd  =&gt; fun(#{sock2 := Sock} = State0) -&gt;
<a name="13683"/>13683:                            socket:close(Sock),
<a name="13684"/>13684: 			   State1 = maps:remove(sock2, State0),
<a name="13685"/>13685: 			   State2 = maps:remove(sa2,   State1),
<a name="13686"/>13686:                            {ok, State2}
<a name="13687"/>13687:                    end},
<a name="13688"/>13688:          #{desc =&gt; &quot;[socket 1] close UDP socket (listener 1)&quot;,
<a name="13689"/>13689:            cmd  =&gt; fun(#{sock1 := Sock} = State0) -&gt;
<a name="13690"/>13690:                            socket:close(Sock),
<a name="13691"/>13691: 			   State1 = maps:remove(sock1, State0),
<a name="13692"/>13692: 			   State2 = maps:remove(sa1,   State1),
<a name="13693"/>13693:                            {ok, State2}
<a name="13694"/>13694:                    end},
<a name="13695"/>13695: 
<a name="13696"/>13696:          %% *** We are done ***
<a name="13697"/>13697:          ?SEV_FINISH_NORMAL
<a name="13698"/>13698:         ],
<a name="13699"/>13699: 
<a name="13700"/>13700:     Domain = inet_or_inet6(),
<a name="13701"/>13701: 
<a name="13702"/>13702:     i(&quot;start tester evaluator&quot;),
<a name="13703"/>13703:     InitState = #{domain =&gt; Domain},
<a name="13704"/>13704:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13705"/>13705: 
<a name="13706"/>13706:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_broadcast-last_expr"/><a name="13707"/>13707: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13708"/>13708: 
<a name="13709"/>13709: 
<a name="13710"/>13710: 
<a name="13711"/>13711: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13712"/>13712: 
<a name="13713"/>13713: <i>%% Tests the socket option debug.</i>
<a name="13714"/>13714: <i>%% On linux, this test requires that the user running the test to have</i>
<a name="13715"/>13715: <i>%% CAP_NET_ADMIN capabilities or be root (effective user ID of 0), </i>
<a name="13716"/>13716: <i>%% therefore we explicitly test for the result eacces when attempting to</i>
<a name="13717"/>13717: <i>%% set, and skip if we get it.</i>
<a name="13718"/>13718: 
<a name="api_opt_sock_debug-1"/><a name="13719"/>13719: <b>api_opt_sock_debug</b>(_Config) when is_list(_Config) -&gt;
<a name="13720"/>13720:     ?TT(?SECS(10)),
<a name="api_opt_sock_debug-last_expr"/><a name="13721"/>13721: <b>    tc_try</b>(api_opt_sock_debug,
<a name="13722"/>13722:            fun() -&gt; has_support_sock_debug() end,
<a name="13723"/>13723:            fun() -&gt; api_opt_sock_debug() end).
<a name="13724"/>13724: 
<a name="13725"/>13725: 
<a name="api_opt_sock_debug-0"/><a name="13726"/>13726: <b>api_opt_sock_debug</b>() -&gt;
<a name="13727"/>13727:     Opt    = debug,
<a name="13728"/>13728:     Set    = fun(S, Val) when is_integer(Val) -&gt;
<a name="13729"/>13729:                      socket:setopt(S, socket, Opt, Val)
<a name="13730"/>13730:              end,
<a name="13731"/>13731:     Get    = fun(S) -&gt;
<a name="13732"/>13732:                      socket:getopt(S, socket, Opt)
<a name="13733"/>13733:              end,
<a name="13734"/>13734: 
<a name="13735"/>13735:     TesterSeq =
<a name="13736"/>13736:         [
<a name="13737"/>13737:          #{desc =&gt; &quot;which local address&quot;,
<a name="13738"/>13738:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13739"/>13739:                            case which_local_host_info(Domain) of
<a name="13740"/>13740:                                {ok, #{name      := Name,
<a name="13741"/>13741:                                       addr      := Addr}} -&gt;
<a name="13742"/>13742:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="13743"/>13743:                                                &quot;~n   Name:           ~p&quot;
<a name="13744"/>13744:                                                &quot;~n   Addr:           ~p&quot;,
<a name="13745"/>13745:                                                [Name, Addr]),
<a name="13746"/>13746:                                    LSA = #{family =&gt; Domain,
<a name="13747"/>13747:                                            addr   =&gt; Addr},
<a name="13748"/>13748:                                    {ok, State#{lsa =&gt; LSA}};
<a name="13749"/>13749:                                {error, _} = ERROR -&gt;
<a name="13750"/>13750:                                    ERROR
<a name="13751"/>13751:                            end
<a name="13752"/>13752:                    end},
<a name="13753"/>13753: 
<a name="13754"/>13754:          #{desc =&gt; &quot;create UDP socket&quot;,
<a name="13755"/>13755:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13756"/>13756:                            case socket:open(Domain, dgram, udp) of
<a name="13757"/>13757:                                {ok, Sock} -&gt;
<a name="13758"/>13758:                                    {ok, State#{sock =&gt; Sock}};
<a name="13759"/>13759:                                {error, _} = ERROR -&gt;
<a name="13760"/>13760:                                    ERROR
<a name="13761"/>13761:                            end
<a name="13762"/>13762:                    end},
<a name="13763"/>13763:          #{desc =&gt; &quot;Get current debug value&quot;,
<a name="13764"/>13764:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="13765"/>13765:                            case Get(Sock) of
<a name="13766"/>13766:                                {ok, Debug} when is_integer(Debug) -&gt;
<a name="13767"/>13767:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Debug]),
<a name="13768"/>13768:                                    {ok, State#{debug =&gt; Debug}};
<a name="13769"/>13769:                                {error, Reason} = ERROR -&gt;
<a name="13770"/>13770:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="13771"/>13771:                                                [Reason]),
<a name="13772"/>13772:                                    ERROR
<a name="13773"/>13773:                            end
<a name="13774"/>13774:                    end},
<a name="13775"/>13775:          #{desc =&gt; &quot;Try enable socket debug&quot;,
<a name="13776"/>13776:            cmd  =&gt; fun(#{sock := Sock, debug := Debug} = State) -&gt;
<a name="13777"/>13777: 			   NewDebug = Debug + 1,
<a name="13778"/>13778:                            case Set(Sock, NewDebug) of
<a name="13779"/>13779:                                ok -&gt;
<a name="13780"/>13780:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13781"/>13781:                                    {ok, State#{debug =&gt; NewDebug}};
<a name="13782"/>13782:                                {error, eacces = Reason} -&gt;
<a name="13783"/>13783:                                    ?SEV_EPRINT(&quot;NO ACCESS =&gt; SKIP&quot;),
<a name="13784"/>13784:                                    {skip, Reason};
<a name="13785"/>13785:                                {error, Reason} = ERROR -&gt;
<a name="13786"/>13786:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13787"/>13787: 					       [Reason]),
<a name="13788"/>13788:                                    ERROR
<a name="13789"/>13789:                            end
<a name="13790"/>13790:                    end},
<a name="13791"/>13791:          #{desc =&gt; &quot;Get current (new) debug value&quot;,
<a name="13792"/>13792:            cmd  =&gt; fun(#{sock := Sock, debug := Debug} = _State) -&gt;
<a name="13793"/>13793:                            case Get(Sock) of
<a name="13794"/>13794:                                {ok, Debug} when is_integer(Debug) -&gt;
<a name="13795"/>13795:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Debug]),
<a name="13796"/>13796:                                    ok;
<a name="13797"/>13797:                                {error, Reason} = ERROR -&gt;
<a name="13798"/>13798:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="13799"/>13799:                                                [Reason]),
<a name="13800"/>13800:                                    ERROR
<a name="13801"/>13801:                            end
<a name="13802"/>13802:                    end},
<a name="13803"/>13803: 
<a name="13804"/>13804:          %% *** Termination ***
<a name="13805"/>13805:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="13806"/>13806:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="13807"/>13807:                            socket:close(Sock),
<a name="13808"/>13808: 			   State1 = maps:remove(sock, State0),
<a name="13809"/>13809:                            {ok, State1}
<a name="13810"/>13810:                    end},
<a name="13811"/>13811: 
<a name="13812"/>13812:          %% *** We are done ***
<a name="13813"/>13813:          ?SEV_FINISH_NORMAL
<a name="13814"/>13814:         ],
<a name="13815"/>13815: 
<a name="13816"/>13816:     Domain = inet_or_inet6(),
<a name="13817"/>13817: 
<a name="13818"/>13818:     i(&quot;start tester evaluator&quot;),
<a name="13819"/>13819:     InitState = #{domain =&gt; Domain},
<a name="13820"/>13820:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13821"/>13821: 
<a name="13822"/>13822:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_debug-last_expr"/><a name="13823"/>13823: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13824"/>13824: 
<a name="13825"/>13825: 
<a name="13826"/>13826: 
<a name="13827"/>13827: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13828"/>13828: 
<a name="13829"/>13829: <i>%% Tests the socket option domain.</i>
<a name="13830"/>13830: <i>%% This is a read only option. Also not available on all platforms.</i>
<a name="13831"/>13831: 
<a name="api_opt_sock_domain-1"/><a name="13832"/>13832: <b>api_opt_sock_domain</b>(_Config) when is_list(_Config) -&gt;
<a name="13833"/>13833:     ?TT(?SECS(10)),
<a name="api_opt_sock_domain-last_expr"/><a name="13834"/>13834: <b>    tc_try</b>(api_opt_sock_domain,
<a name="13835"/>13835:            fun() -&gt; has_support_sock_domain() end,
<a name="13836"/>13836:            fun() -&gt; api_opt_sock_domain() end).
<a name="13837"/>13837: 
<a name="13838"/>13838: 
<a name="api_opt_sock_domain-0"/><a name="13839"/>13839: <b>api_opt_sock_domain</b>() -&gt;
<a name="13840"/>13840:     Opt = domain,
<a name="13841"/>13841:     Get = fun(S) -&gt;
<a name="13842"/>13842:                   socket:getopt(S, socket, Opt)
<a name="13843"/>13843:           end,
<a name="13844"/>13844: 
<a name="13845"/>13845:     TesterSeq =
<a name="13846"/>13846:         [
<a name="13847"/>13847:          #{desc =&gt; &quot;which local address&quot;,
<a name="13848"/>13848:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13849"/>13849:                            case which_local_host_info(Domain) of
<a name="13850"/>13850:                                {ok, #{name := Name,
<a name="13851"/>13851:                                       addr := Addr}} -&gt;
<a name="13852"/>13852:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="13853"/>13853:                                                &quot;~n   Name: ~p&quot;
<a name="13854"/>13854:                                                &quot;~n   Addr: ~p&quot;,
<a name="13855"/>13855:                                                [Name, Addr]),
<a name="13856"/>13856:                                    LSA = #{family =&gt; Domain,
<a name="13857"/>13857:                                            addr   =&gt; Addr},
<a name="13858"/>13858:                                    {ok, State#{lsa =&gt; LSA}};
<a name="13859"/>13859:                                {error, _} = ERROR -&gt;
<a name="13860"/>13860:                                    ERROR
<a name="13861"/>13861:                            end
<a name="13862"/>13862:                    end},
<a name="13863"/>13863: 
<a name="13864"/>13864:          #{desc =&gt; &quot;create IPv4 UDP socket&quot;,
<a name="13865"/>13865:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13866"/>13866:                            case socket:open(Domain, dgram, udp) of
<a name="13867"/>13867:                                {ok, Sock} -&gt;
<a name="13868"/>13868:                                    {ok, State#{usock =&gt; Sock}};
<a name="13869"/>13869:                                {error, _} = ERROR -&gt;
<a name="13870"/>13870:                                    ERROR
<a name="13871"/>13871:                            end
<a name="13872"/>13872:                    end},
<a name="13873"/>13873:          #{desc =&gt; &quot;Get domain for the UDP socket&quot;,
<a name="13874"/>13874:            cmd  =&gt; fun(#{domain := Domain, usock := Sock} = _State) -&gt;
<a name="13875"/>13875:                            case Get(Sock) of
<a name="13876"/>13876:                                {ok, Domain} -&gt;
<a name="13877"/>13877:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Domain]),
<a name="13878"/>13878:                                    ok;
<a name="13879"/>13879:                                {error, Reason} = ERROR -&gt;
<a name="13880"/>13880:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="13881"/>13881:                                                [Reason]),
<a name="13882"/>13882:                                    ERROR
<a name="13883"/>13883:                            end
<a name="13884"/>13884:                    end},
<a name="13885"/>13885:          #{desc =&gt; &quot;create TCP socket&quot;,
<a name="13886"/>13886:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13887"/>13887:                            case socket:open(Domain, stream, tcp) of
<a name="13888"/>13888:                                {ok, Sock} -&gt;
<a name="13889"/>13889:                                    {ok, State#{tsock =&gt; Sock}};
<a name="13890"/>13890:                                {error, _} = ERROR -&gt;
<a name="13891"/>13891:                                    ERROR
<a name="13892"/>13892:                            end
<a name="13893"/>13893:                    end},
<a name="13894"/>13894:          #{desc =&gt; &quot;Get domain for the TCP socket&quot;,
<a name="13895"/>13895:            cmd  =&gt; fun(#{domain := Domain, tsock := Sock} = _State) -&gt;
<a name="13896"/>13896:                            case Get(Sock) of
<a name="13897"/>13897:                                {ok, Domain} -&gt;
<a name="13898"/>13898:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Domain]),
<a name="13899"/>13899:                                    ok;
<a name="13900"/>13900:                                {error, Reason} = ERROR -&gt;
<a name="13901"/>13901:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="13902"/>13902:                                                [Reason]),
<a name="13903"/>13903:                                    ERROR
<a name="13904"/>13904:                            end
<a name="13905"/>13905:                    end},
<a name="13906"/>13906: 
<a name="13907"/>13907:          %% *** Termination ***
<a name="13908"/>13908:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="13909"/>13909:            cmd  =&gt; fun(#{usock := Sock} = State0) -&gt;
<a name="13910"/>13910:                            socket:close(Sock),
<a name="13911"/>13911: 			   State1 = maps:remove(usock, State0),
<a name="13912"/>13912:                            {ok, State1}
<a name="13913"/>13913:                    end},
<a name="13914"/>13914:          #{desc =&gt; &quot;close TCP socket&quot;,
<a name="13915"/>13915:            cmd  =&gt; fun(#{tsock := Sock} = State0) -&gt;
<a name="13916"/>13916:                            socket:close(Sock),
<a name="13917"/>13917: 			   State1 = maps:remove(tsock, State0),
<a name="13918"/>13918:                            {ok, State1}
<a name="13919"/>13919:                    end},
<a name="13920"/>13920: 
<a name="13921"/>13921:          %% *** We are done ***
<a name="13922"/>13922:          ?SEV_FINISH_NORMAL
<a name="13923"/>13923:         ],
<a name="13924"/>13924: 
<a name="13925"/>13925:     Domain = inet_or_inet6(),
<a name="13926"/>13926: 
<a name="13927"/>13927:     i(&quot;start tester evaluator&quot;),
<a name="13928"/>13928:     InitState = #{domain =&gt; Domain},
<a name="13929"/>13929:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13930"/>13930: 
<a name="13931"/>13931:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_domain-last_expr"/><a name="13932"/>13932: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13933"/>13933: 
<a name="13934"/>13934: 
<a name="13935"/>13935: 
<a name="13936"/>13936: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13937"/>13937: 
<a name="13938"/>13938: <i>%% Tests the socket option dontroute.</i>
<a name="13939"/>13939: <i>%% The man page has the following to say:</i>
<a name="13940"/>13940: <i>%% &quot;Don't send via a gateway, send only to directly connected hosts.</i>
<a name="13941"/>13941: <i>%%  The same effect can be achieved by setting the MSG_DONTROUTE</i>
<a name="13942"/>13942: <i>%%  flag on a socket send(2) operation.&quot;</i>
<a name="13943"/>13943: <i>%% Since its &quot;kind of&quot; difficult to check if it actually takes an </i>
<a name="13944"/>13944: <i>%% effect (you would need a gateway for that and a machine &quot;on the</i>
<a name="13945"/>13945: <i>%% other side&quot;), we only test if we can set and get the value.</i>
<a name="13946"/>13946: <i>%% Better then nothing.</i>
<a name="13947"/>13947: 
<a name="api_opt_sock_dontroute-1"/><a name="13948"/>13948: <b>api_opt_sock_dontroute</b>(_Config) when is_list(_Config) -&gt;
<a name="13949"/>13949:     ?TT(?SECS(10)),
<a name="api_opt_sock_dontroute-last_expr"/><a name="13950"/>13950: <b>    tc_try</b>(api_opt_sock_dontroute,
<a name="13951"/>13951:            fun() -&gt; has_support_sock_dontroute() end,
<a name="13952"/>13952:            fun() -&gt; api_opt_sock_dontroute() end).
<a name="13953"/>13953: 
<a name="13954"/>13954: 
<a name="api_opt_sock_dontroute-0"/><a name="13955"/>13955: <b>api_opt_sock_dontroute</b>() -&gt;
<a name="13956"/>13956:     Opt    = dontroute,
<a name="13957"/>13957:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="13958"/>13958:                      socket:setopt(S, socket, Opt, Val)
<a name="13959"/>13959:              end,
<a name="13960"/>13960:     Get    = fun(S) -&gt;
<a name="13961"/>13961:                      socket:getopt(S, socket, Opt)
<a name="13962"/>13962:              end,
<a name="13963"/>13963: 
<a name="13964"/>13964:     TesterSeq =
<a name="13965"/>13965:         [
<a name="13966"/>13966:          #{desc =&gt; &quot;which local address&quot;,
<a name="13967"/>13967:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13968"/>13968:                            case which_local_host_info(Domain) of
<a name="13969"/>13969:                                {ok, #{name := Name,
<a name="13970"/>13970:                                       addr := Addr}} -&gt;
<a name="13971"/>13971:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="13972"/>13972:                                                &quot;~n   Name: ~p&quot;
<a name="13973"/>13973:                                                &quot;~n   Addr: ~p&quot;,
<a name="13974"/>13974:                                                [Name, Addr]),
<a name="13975"/>13975:                                    LSA = #{family =&gt; Domain,
<a name="13976"/>13976:                                            addr   =&gt; Addr},
<a name="13977"/>13977:                                    {ok, State#{lsa =&gt; LSA}};
<a name="13978"/>13978:                                {error, _} = ERROR -&gt;
<a name="13979"/>13979:                                    ERROR
<a name="13980"/>13980:                            end
<a name="13981"/>13981:                    end},
<a name="13982"/>13982: 
<a name="13983"/>13983:          #{desc =&gt; &quot;create UDP socket&quot;,
<a name="13984"/>13984:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13985"/>13985:                            case socket:open(Domain, dgram, udp) of
<a name="13986"/>13986:                                {ok, Sock} -&gt;
<a name="13987"/>13987:                                    {ok, State#{sock =&gt; Sock}};
<a name="13988"/>13988:                                {error, _} = ERROR -&gt;
<a name="13989"/>13989:                                    ERROR
<a name="13990"/>13990:                            end
<a name="13991"/>13991:                    end},
<a name="13992"/>13992:          #{desc =&gt; &quot;Get current value&quot;,
<a name="13993"/>13993:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="13994"/>13994:                            case Get(Sock) of
<a name="13995"/>13995:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="13996"/>13996:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="13997"/>13997:                                    {ok, State#{dontroute =&gt; Val}};
<a name="13998"/>13998:                                {error, Reason} = ERROR -&gt;
<a name="13999"/>13999:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14000"/>14000:                                                [Reason]),
<a name="14001"/>14001:                                    ERROR
<a name="14002"/>14002:                            end
<a name="14003"/>14003:                    end},
<a name="14004"/>14004:          #{desc =&gt; &quot;Try change value&quot;,
<a name="14005"/>14005:            cmd  =&gt; fun(#{sock := Sock, dontroute := Current} = State) -&gt;
<a name="14006"/>14006: 			   New = not Current,
<a name="14007"/>14007:                            ?SEV_IPRINT(&quot;Change from ~p to ~p&quot;, [Current, New]),
<a name="14008"/>14008:                            case Set(Sock, New) of
<a name="14009"/>14009:                                ok -&gt;
<a name="14010"/>14010:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14011"/>14011:                                    {ok, State#{dontroute =&gt; New}};
<a name="14012"/>14012:                                {error, eopnotsupp = Reason} -&gt;
<a name="14013"/>14013:                                    ?SEV_EPRINT(&quot;Expected Failure: ~p&quot;,
<a name="14014"/>14014: 					       [Reason]),
<a name="14015"/>14015:                                    {skip, Reason};
<a name="14016"/>14016:                                {error, Reason} = ERROR -&gt;
<a name="14017"/>14017:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14018"/>14018: 					       [Reason]),
<a name="14019"/>14019:                                    ERROR
<a name="14020"/>14020:                            end
<a name="14021"/>14021:                    end},
<a name="14022"/>14022:          #{desc =&gt; &quot;Verify changed value&quot;,
<a name="14023"/>14023:            cmd  =&gt; fun(#{sock := Sock, dontroute := Val} = _State) -&gt;
<a name="14024"/>14024:                            case Get(Sock) of
<a name="14025"/>14025:                                {ok, Val} -&gt;
<a name="14026"/>14026:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14027"/>14027:                                    ok;
<a name="14028"/>14028:                                {error, Reason} = ERROR -&gt;
<a name="14029"/>14029:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14030"/>14030:                                                [Reason]),
<a name="14031"/>14031:                                    ERROR
<a name="14032"/>14032:                            end
<a name="14033"/>14033:                    end},
<a name="14034"/>14034: 
<a name="14035"/>14035:          %% *** Termination ***
<a name="14036"/>14036:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="14037"/>14037:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="14038"/>14038:                            socket:close(Sock),
<a name="14039"/>14039: 			   State1 = maps:remove(sock, State0),
<a name="14040"/>14040:                            {ok, State1}
<a name="14041"/>14041:                    end},
<a name="14042"/>14042: 
<a name="14043"/>14043:          %% *** We are done ***
<a name="14044"/>14044:          ?SEV_FINISH_NORMAL
<a name="14045"/>14045:         ],
<a name="14046"/>14046: 
<a name="14047"/>14047:     Domain = inet_or_inet6(),
<a name="14048"/>14048: 
<a name="14049"/>14049:     i(&quot;start tester evaluator&quot;),
<a name="14050"/>14050:     InitState = #{domain =&gt; Domain},
<a name="14051"/>14051:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14052"/>14052: 
<a name="14053"/>14053:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_dontroute-last_expr"/><a name="14054"/>14054: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14055"/>14055: 
<a name="14056"/>14056: 
<a name="14057"/>14057: 
<a name="14058"/>14058: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14059"/>14059: 
<a name="14060"/>14060: <i>%% Tests the socket option error. PLACEHOLDER!</i>
<a name="14061"/>14061: 
<a name="api_opt_sock_error-1"/><a name="14062"/>14062: <b>api_opt_sock_error</b>(_Config) when is_list(_Config) -&gt;
<a name="14063"/>14063:     ?TT(?SECS(10)),
<a name="api_opt_sock_error-last_expr"/><a name="14064"/>14064: <b>    tc_try</b>(api_opt_sock_error,
<a name="14065"/>14065:            fun() -&gt; not_yet_implemented() end,
<a name="14066"/>14066:            fun() -&gt; ok end).
<a name="14067"/>14067: 
<a name="14068"/>14068: 
<a name="14069"/>14069: 
<a name="14070"/>14070: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14071"/>14071: 
<a name="14072"/>14072: <i>%% Tests the socket option keepalive.</i>
<a name="14073"/>14073: <i>%% This is bit tricky to test, partly because we have no control over</i>
<a name="14074"/>14074: <i>%% the underlying TCP timeouts. So, for now, we just test that we can</i>
<a name="14075"/>14075: <i>%% change the value.</i>
<a name="14076"/>14076: 
<a name="api_opt_sock_keepalive-1"/><a name="14077"/>14077: <b>api_opt_sock_keepalive</b>(_Config) when is_list(_Config) -&gt;
<a name="14078"/>14078:     ?TT(?SECS(10)),
<a name="api_opt_sock_keepalive-last_expr"/><a name="14079"/>14079: <b>    tc_try</b>(api_opt_sock_keepalive,
<a name="14080"/>14080:            fun() -&gt; has_support_sock_keepalive() end,
<a name="14081"/>14081:            fun() -&gt; api_opt_sock_keepalive() end).
<a name="14082"/>14082: 
<a name="14083"/>14083: 
<a name="api_opt_sock_keepalive-0"/><a name="14084"/>14084: <b>api_opt_sock_keepalive</b>() -&gt;
<a name="14085"/>14085:     Opt    = keepalive,
<a name="14086"/>14086:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="14087"/>14087:                      socket:setopt(S, socket, Opt, Val)
<a name="14088"/>14088:              end,
<a name="14089"/>14089:     Get    = fun(S) -&gt;
<a name="14090"/>14090:                      socket:getopt(S, socket, Opt)
<a name="14091"/>14091:              end,
<a name="14092"/>14092: 
<a name="14093"/>14093:     TesterSeq =
<a name="14094"/>14094:         [
<a name="14095"/>14095:          #{desc =&gt; &quot;which local address&quot;,
<a name="14096"/>14096:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14097"/>14097:                            case which_local_host_info(Domain) of
<a name="14098"/>14098:                                {ok, #{name      := Name,
<a name="14099"/>14099:                                       addr      := Addr}} -&gt;
<a name="14100"/>14100:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="14101"/>14101:                                                &quot;~n   Name: ~p&quot;
<a name="14102"/>14102:                                                &quot;~n   Addr: ~p&quot;,
<a name="14103"/>14103:                                                [Name, Addr]),
<a name="14104"/>14104:                                    LSA = #{family =&gt; Domain,
<a name="14105"/>14105:                                            addr   =&gt; Addr},
<a name="14106"/>14106:                                    {ok, State#{lsa =&gt; LSA}};
<a name="14107"/>14107:                                {error, _} = ERROR -&gt;
<a name="14108"/>14108:                                    ERROR
<a name="14109"/>14109:                            end
<a name="14110"/>14110:                    end},
<a name="14111"/>14111: 
<a name="14112"/>14112:          #{desc =&gt; &quot;create TCP socket&quot;,
<a name="14113"/>14113:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14114"/>14114:                            case socket:open(Domain, stream, tcp) of
<a name="14115"/>14115:                                {ok, Sock} -&gt;
<a name="14116"/>14116:                                    {ok, State#{sock =&gt; Sock}};
<a name="14117"/>14117:                                {error, _} = ERROR -&gt;
<a name="14118"/>14118:                                    ERROR
<a name="14119"/>14119:                            end
<a name="14120"/>14120:                    end},
<a name="14121"/>14121:          #{desc =&gt; &quot;Get current value&quot;,
<a name="14122"/>14122:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14123"/>14123:                            case Get(Sock) of
<a name="14124"/>14124:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="14125"/>14125:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="14126"/>14126:                                    {ok, State#{keepalive =&gt; Val}};
<a name="14127"/>14127:                                {error, Reason} = ERROR -&gt;
<a name="14128"/>14128:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14129"/>14129:                                                [Reason]),
<a name="14130"/>14130:                                    ERROR
<a name="14131"/>14131:                            end
<a name="14132"/>14132:                    end},
<a name="14133"/>14133:          #{desc =&gt; &quot;Try change the value&quot;,
<a name="14134"/>14134:            cmd  =&gt; fun(#{sock := Sock, keepalive := Current} = State) -&gt;
<a name="14135"/>14135: 			   New = not Current,
<a name="14136"/>14136:                            ?SEV_IPRINT(&quot;Try change value from ~p to ~p&quot;, 
<a name="14137"/>14137:                                        [Current, New]),
<a name="14138"/>14138:                            case Set(Sock, New) of
<a name="14139"/>14139:                                ok -&gt;
<a name="14140"/>14140:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14141"/>14141:                                    {ok, State#{keepalive =&gt; New}};
<a name="14142"/>14142:                                {error, Reason} = ERROR -&gt;
<a name="14143"/>14143:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14144"/>14144: 					       [Reason]),
<a name="14145"/>14145:                                    ERROR
<a name="14146"/>14146:                            end
<a name="14147"/>14147:                    end},
<a name="14148"/>14148:          #{desc =&gt; &quot;Verify (new) current value&quot;,
<a name="14149"/>14149:            cmd  =&gt; fun(#{sock := Sock, keepalive := Val} = _State) -&gt;
<a name="14150"/>14150:                            case Get(Sock) of
<a name="14151"/>14151:                                {ok, Val} -&gt;
<a name="14152"/>14152:                                    ?SEV_IPRINT(&quot;Expected Success (~p)&quot;, [Val]),
<a name="14153"/>14153:                                    ok;
<a name="14154"/>14154:                                {ok, OtherVal} -&gt;
<a name="14155"/>14155:                                    ?SEV_IPRINT(&quot;Unexpected Success: ~p&quot;,
<a name="14156"/>14156:                                                [OtherVal]),
<a name="14157"/>14157:                                    {error, {unexpected_success_value,
<a name="14158"/>14158:                                             Val, OtherVal}};
<a name="14159"/>14159:                                {error, Reason} = ERROR -&gt;
<a name="14160"/>14160:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14161"/>14161:                                                [Reason]),
<a name="14162"/>14162:                                    ERROR
<a name="14163"/>14163:                            end
<a name="14164"/>14164:                    end},
<a name="14165"/>14165: 
<a name="14166"/>14166:          %% *** Termination ***
<a name="14167"/>14167:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="14168"/>14168:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="14169"/>14169:                            socket:close(Sock),
<a name="14170"/>14170: 			   State1 = maps:remove(sock, State0),
<a name="14171"/>14171:                            {ok, State1}
<a name="14172"/>14172:                    end},
<a name="14173"/>14173: 
<a name="14174"/>14174:          %% *** We are done ***
<a name="14175"/>14175:          ?SEV_FINISH_NORMAL
<a name="14176"/>14176:         ],
<a name="14177"/>14177: 
<a name="14178"/>14178:     Domain = inet_or_inet6(),
<a name="14179"/>14179: 
<a name="14180"/>14180:     i(&quot;start tester evaluator&quot;),
<a name="14181"/>14181:     InitState = #{domain =&gt; Domain},
<a name="14182"/>14182:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14183"/>14183: 
<a name="14184"/>14184:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_keepalive-last_expr"/><a name="14185"/>14185: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14186"/>14186: 
<a name="14187"/>14187: 
<a name="14188"/>14188: 
<a name="14189"/>14189: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14190"/>14190: 
<a name="14191"/>14191: <i>%% Tests the socket option reuseaddr.</i>
<a name="14192"/>14192: <i>%% This is the most basic of tests. We only test that we can set the</i>
<a name="14193"/>14193: <i>%% option and then read back.</i>
<a name="14194"/>14194: 
<a name="api_opt_sock_reuseaddr-1"/><a name="14195"/>14195: <b>api_opt_sock_reuseaddr</b>(_Config) when is_list(_Config) -&gt;
<a name="14196"/>14196:     ?TT(?SECS(10)),
<a name="api_opt_sock_reuseaddr-last_expr"/><a name="14197"/>14197: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14198"/>14198:            fun() -&gt;
<a name="14199"/>14199:                    %% [IPv4] Nothing to do with the option,
<a name="14200"/>14200:                    %% [IPv4] but we use it the test so make
<a name="14201"/>14201:                    %% [IPv4] use we have it.
<a name="14202"/>14202:                    has_support_ipv4(),
<a name="14203"/>14203:                    has_support_sock_reuseaddr()
<a name="14204"/>14204:            end,
<a name="14205"/>14205:            fun() -&gt; api_opt_sock_reuseaddr() end).
<a name="14206"/>14206: 
<a name="14207"/>14207: 
<a name="api_opt_sock_reuseaddr-0"/><a name="14208"/>14208: <b>api_opt_sock_reuseaddr</b>() -&gt;
<a name="api_opt_sock_reuseaddr-last_expr"/><a name="14209"/>14209: <b>    api_opt_simple_bool</b>(inet, socket, stream, reuseaddr,
<a name="14210"/>14210:                        #{bind =&gt; false}).
<a name="14211"/>14211: 
<a name="14212"/>14212: 
<a name="14213"/>14213: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14214"/>14214: 
<a name="14215"/>14215: <i>%% Tests the socket option exclusiveaddruse.</i>
<a name="14216"/>14216: <i>%% This is the most basic of tests. We only test that we can set the</i>
<a name="14217"/>14217: <i>%% option and then read back.</i>
<a name="14218"/>14218: 
<a name="api_opt_sock_exclusiveaddruse-1"/><a name="14219"/>14219: <b>api_opt_sock_exclusiveaddruse</b>(_Config) when is_list(_Config) -&gt;
<a name="14220"/>14220:     ?TT(?SECS(10)),
<a name="api_opt_sock_exclusiveaddruse-last_expr"/><a name="14221"/>14221: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14222"/>14222:            fun() -&gt;
<a name="14223"/>14223:                    %% [IPv4] Nothing to do with the option,
<a name="14224"/>14224:                    %% [IPv4] but we use it the test so make
<a name="14225"/>14225:                    %% [IPv4] use we have it.
<a name="14226"/>14226:                    has_support_ipv4(),
<a name="14227"/>14227:                    has_support_sock_exclusiveaddruse()
<a name="14228"/>14228:            end,
<a name="14229"/>14229:            fun() -&gt; api_opt_sock_exclusiveaddruse() end).
<a name="14230"/>14230: 
<a name="14231"/>14231: 
<a name="api_opt_sock_exclusiveaddruse-0"/><a name="14232"/>14232: <b>api_opt_sock_exclusiveaddruse</b>() -&gt;
<a name="api_opt_sock_exclusiveaddruse-last_expr"/><a name="14233"/>14233: <b>    api_opt_simple_bool</b>(inet, socket, stream, exclusiveaddruse,
<a name="14234"/>14234: 			#{bind =&gt; false}).
<a name="14235"/>14235: 
<a name="14236"/>14236: 
<a name="14237"/>14237: 
<a name="14238"/>14238: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14239"/>14239: 
<a name="14240"/>14240: <i>%% *Simple* test for a bool option.</i>
<a name="14241"/>14241: <i>%% This basically just tests that we can set and get the option.</i>
<a name="14242"/>14242: <i>%% This assumes that the option is supported.</i>
<a name="14243"/>14243: <i>%% What if its required that the socket is bound before set/get?</i>
<a name="14244"/>14244: <i>%% What if its required that set/get is done before bind?</i>
<a name="14245"/>14245: 
<a name="api_opt_simple_bool-5"/><a name="14246"/>14246: <b>api_opt_simple_bool</b>(Domain, Level, Type, Option, InitState) -&gt;
<a name="14247"/>14247: 
<a name="14248"/>14248:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="14249"/>14249:                      socket:setopt(S, Level, Option, Val)
<a name="14250"/>14250:              end,
<a name="14251"/>14251:     Get    = fun(S) -&gt;
<a name="14252"/>14252:                      socket:getopt(S, Level, Option)
<a name="14253"/>14253:              end,
<a name="14254"/>14254: 
<a name="14255"/>14255:     TesterSeq =
<a name="14256"/>14256:         [
<a name="14257"/>14257:          #{desc =&gt; &quot;(maybe) which local address&quot;,
<a name="14258"/>14258:            cmd  =&gt; fun(#{bind := true} = State) -&gt;
<a name="14259"/>14259:                            case ?SLIB:which_local_host_info(Domain) of
<a name="14260"/>14260:                                {ok, #{name      := Name,
<a name="14261"/>14261:                                       addr      := Addr}} -&gt;
<a name="14262"/>14262:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="14263"/>14263:                                                &quot;~n   Name: ~p&quot;
<a name="14264"/>14264:                                                &quot;~n   Addr: ~p&quot;,
<a name="14265"/>14265:                                                [Name, Addr]),
<a name="14266"/>14266:                                    LSA = #{family =&gt; Domain,
<a name="14267"/>14267:                                            addr   =&gt; Addr},
<a name="14268"/>14268:                                    {ok, State#{lsa =&gt; LSA}};
<a name="14269"/>14269:                                {error, _} = ERROR -&gt;
<a name="14270"/>14270:                                    ERROR
<a name="14271"/>14271:                            end;
<a name="14272"/>14272:                       (_State) -&gt;
<a name="14273"/>14273:                            ?SEV_IPRINT(&quot;ignore get local address&quot;),
<a name="14274"/>14274:                            ok
<a name="14275"/>14275:                    end},
<a name="14276"/>14276: 
<a name="14277"/>14277:          #{desc =&gt; &quot;create socket&quot;,
<a name="14278"/>14278:            cmd  =&gt; fun(State) -&gt;
<a name="14279"/>14279:                            case socket:open(Domain, Type) of
<a name="14280"/>14280:                                {ok, Sock} -&gt;
<a name="14281"/>14281:                                    {ok, State#{sock =&gt; Sock}};
<a name="14282"/>14282:                                {error, _} = ERROR -&gt;
<a name="14283"/>14283:                                    ERROR
<a name="14284"/>14284:                            end
<a name="14285"/>14285:                    end},
<a name="14286"/>14286: 
<a name="14287"/>14287:          #{desc =&gt; &quot;(maybe) bind&quot;,
<a name="14288"/>14288:            cmd  =&gt; fun(#{bind := true, lsa := LSA, sock := Sock} = _State) -&gt;
<a name="14289"/>14289:                            ?SEV_IPRINT(&quot;try binding&quot;),
<a name="14290"/>14290:                            socket:bind(Sock, LSA);
<a name="14291"/>14291:                       (_State) -&gt;
<a name="14292"/>14292:                            ?SEV_IPRINT(&quot;ignore binding&quot;),
<a name="14293"/>14293:                            ok
<a name="14294"/>14294:                    end},
<a name="14295"/>14295: 
<a name="14296"/>14296:          #{desc =&gt; &quot;Get current value&quot;,
<a name="14297"/>14297:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14298"/>14298:                            case Get(Sock) of
<a name="14299"/>14299:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="14300"/>14300:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="14301"/>14301:                                    {ok, State#{Option =&gt; Val}};
<a name="14302"/>14302:                                {error, Reason} = ERROR -&gt;
<a name="14303"/>14303:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14304"/>14304:                                                [Reason]),
<a name="14305"/>14305:                                    ERROR
<a name="14306"/>14306:                            end
<a name="14307"/>14307:                    end},
<a name="14308"/>14308:          #{desc =&gt; &quot;Try change the value&quot;,
<a name="14309"/>14309:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14310"/>14310:                            Current = maps:get(Option, State),
<a name="14311"/>14311: 			   New     = not Current,
<a name="14312"/>14312:                            ?SEV_IPRINT(&quot;Try change value from ~p to ~p&quot;, 
<a name="14313"/>14313:                                        [Current, New]),
<a name="14314"/>14314:                            case Set(Sock, New) of
<a name="14315"/>14315:                                ok -&gt;
<a name="14316"/>14316:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14317"/>14317:                                    {ok, State#{Option =&gt; New}};
<a name="14318"/>14318:                                {error, Reason} = ERROR -&gt;
<a name="14319"/>14319:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14320"/>14320: 					       [Reason]),
<a name="14321"/>14321:                                    ERROR
<a name="14322"/>14322:                            end
<a name="14323"/>14323:                    end},
<a name="14324"/>14324:          #{desc =&gt; &quot;Verify (new) current value&quot;,
<a name="14325"/>14325:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14326"/>14326:                            Val = maps:get(Option, State),
<a name="14327"/>14327:                            case Get(Sock) of
<a name="14328"/>14328:                                {ok, Val} -&gt;
<a name="14329"/>14329:                                    ?SEV_IPRINT(&quot;Expected Success (~p)&quot;, [Val]),
<a name="14330"/>14330:                                    ok;
<a name="14331"/>14331:                                {ok, OtherVal} -&gt;
<a name="14332"/>14332:                                    ?SEV_IPRINT(&quot;Unexpected Success: ~p&quot;,
<a name="14333"/>14333:                                                [OtherVal]),
<a name="14334"/>14334:                                    {error, {unexpected_success_value,
<a name="14335"/>14335:                                             Val, OtherVal}};
<a name="14336"/>14336:                                {error, Reason} = ERROR -&gt;
<a name="14337"/>14337:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14338"/>14338:                                                [Reason]),
<a name="14339"/>14339:                                    ERROR
<a name="14340"/>14340:                            end
<a name="14341"/>14341:                    end},
<a name="14342"/>14342: 
<a name="14343"/>14343:          %% *** Termination ***
<a name="14344"/>14344:          #{desc =&gt; &quot;close socket&quot;,
<a name="14345"/>14345:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="14346"/>14346:                            socket:close(Sock),
<a name="14347"/>14347: 			   State1 = maps:remove(sock, State0),
<a name="14348"/>14348:                            {ok, State1}
<a name="14349"/>14349:                    end},
<a name="14350"/>14350: 
<a name="14351"/>14351:          %% *** We are done ***
<a name="14352"/>14352:          ?SEV_FINISH_NORMAL
<a name="14353"/>14353:         ],
<a name="14354"/>14354: 
<a name="14355"/>14355:     i(&quot;start tester evaluator&quot;),
<a name="14356"/>14356:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14357"/>14357: 
<a name="14358"/>14358:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_simple_bool-last_expr"/><a name="14359"/>14359: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14360"/>14360: 
<a name="14361"/>14361: 
<a name="14362"/>14362: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14363"/>14363: 
<a name="14364"/>14364: <i>%% Tests the socket option bsp_state.</i>
<a name="14365"/>14365: <i>%% This is the most basic of tests. We test that we can,</i>
<a name="14366"/>14366: <i>%% create sockets, bind and connect and extract bsp-state</i>
<a name="14367"/>14367: <i>%% in the various state(s) of the socket.</i>
<a name="14368"/>14368: <i>%% For both dgram and stream sockets.</i>
<a name="14369"/>14369: 
<a name="api_opt_sock_bsp_state-1"/><a name="14370"/>14370: <b>api_opt_sock_bsp_state</b>(_Config) when is_list(_Config) -&gt;
<a name="14371"/>14371:     ?TT(?SECS(10)),
<a name="api_opt_sock_bsp_state-last_expr"/><a name="14372"/>14372: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14373"/>14373:            fun() -&gt;
<a name="14374"/>14374: 		   %% This is not a 'IPv4' option,
<a name="14375"/>14375: 		   %% but since we used it in the test...
<a name="14376"/>14376:                    has_support_ipv4(),
<a name="14377"/>14377:                    has_support_sock_bsp_state()
<a name="14378"/>14378:            end,
<a name="14379"/>14379:            fun() -&gt; api_opt_sock_bsp_state() end).
<a name="14380"/>14380: 
<a name="14381"/>14381: 
<a name="api_opt_sock_bsp_state-0"/><a name="14382"/>14382: <b>api_opt_sock_bsp_state</b>() -&gt;
<a name="14383"/>14383:     LSA        = which_local_socket_addr(inet),
<a name="14384"/>14384:     BspState   = fun(S) -&gt;
<a name="14385"/>14385: 			 case socket:getopt(S, socket, bsp_state) of
<a name="14386"/>14386: 			     {ok, BS} -&gt;
<a name="14387"/>14387: 				 BS;
<a name="14388"/>14388: 			     {error, Reason} -&gt;
<a name="14389"/>14389: 				 ?FAIL({getopt_bsp_state, Reason})
<a name="14390"/>14390: 			 end
<a name="14391"/>14391: 		 end,
<a name="14392"/>14392:     CreateSock = fun(T, P) -&gt;
<a name="14393"/>14393: 			 case socket:open(inet, T, P) of
<a name="14394"/>14394: 			     {ok, Sock}      -&gt;
<a name="14395"/>14395: 				 Sock;
<a name="14396"/>14396: 			     {error, Reason} -&gt;
<a name="14397"/>14397: 				 skip({socket_create_fail, Reason})
<a name="14398"/>14398: 			 end
<a name="14399"/>14399: 		 end,
<a name="14400"/>14400:     CloseSock = fun(S) -&gt;
<a name="14401"/>14401: 			socket:close(S)
<a name="14402"/>14402: 		end,
<a name="14403"/>14403:     BindSock   = fun(S, SA) -&gt;
<a name="14404"/>14404: 			 case socket:bind(S, SA) of
<a name="14405"/>14405: 			     ok -&gt;
<a name="14406"/>14406: 				 ok;
<a name="14407"/>14407: 			     {error, Reason} -&gt;
<a name="14408"/>14408: 				 ?FAIL({bind, Reason})
<a name="14409"/>14409: 			 end
<a name="14410"/>14410: 		 end,
<a name="14411"/>14411:     Sockname   = fun(S) -&gt;
<a name="14412"/>14412: 			 case socket:sockname(S) of
<a name="14413"/>14413: 			     {ok, SA} -&gt;
<a name="14414"/>14414: 				 SA;
<a name="14415"/>14415: 			     {error, Reason} -&gt;
<a name="14416"/>14416: 				 ?FAIL({sockname, Reason})
<a name="14417"/>14417: 			 end
<a name="14418"/>14418: 		 end,
<a name="14419"/>14419:     %% Setopt      = fun(S, L, O, V) -&gt;
<a name="14420"/>14420:     %% 			  socket:setopt(S, L, O, V)
<a name="14421"/>14421:     %% 		  end,
<a name="14422"/>14422:     %% SetOtpOpt = fun(S, O, V) -&gt; Setopt(S, otp, O, V) end,
<a name="14423"/>14423:     %% SetDebug  = fun(S, D) when is_boolean(D) -&gt; SetOptOpt(S, debug, D) end,
<a name="14424"/>14424:     %% EnableDebug = fun(S) -&gt; SetDebug(S, true) end,
<a name="14425"/>14425:     ConnectSock = fun(S, SA) -&gt;
<a name="14426"/>14426: 			  case socket:connect(S, SA) of
<a name="14427"/>14427: 			      ok -&gt;
<a name="14428"/>14428: 				  ok;
<a name="14429"/>14429: 			      {error, Reason} -&gt;
<a name="14430"/>14430: 				  ?FAIL({connect, Reason})
<a name="14431"/>14431: 			  end
<a name="14432"/>14432: 		  end,
<a name="14433"/>14433:     ListenSock = fun(S) -&gt;
<a name="14434"/>14434: 			 case socket:listen(S) of
<a name="14435"/>14435: 			     ok -&gt;
<a name="14436"/>14436: 				 ok;
<a name="14437"/>14437: 			     {error, Reason} -&gt;
<a name="14438"/>14438: 				 ?FAIL({listen, Reason})
<a name="14439"/>14439: 			 end
<a name="14440"/>14440: 		 end,
<a name="14441"/>14441:     AcceptSock = fun(S) -&gt;
<a name="14442"/>14442: 			 case socket:accept(S) of
<a name="14443"/>14443: 			     {ok, A} -&gt;
<a name="14444"/>14444: 				 A;
<a name="14445"/>14445: 			     {error, Reason} -&gt;
<a name="14446"/>14446: 				 ?FAIL({accept, Reason})
<a name="14447"/>14447: 			 end
<a name="14448"/>14448: 		 end,
<a name="14449"/>14449: 
<a name="14450"/>14450:     VerifyBspState = fun(S, Type, Proto,
<a name="14451"/>14451: 			 Bound, Connected) -&gt;
<a name="14452"/>14452: 			     verify_bsp_state(S, Type, Proto,
<a name="14453"/>14453: 					      Bound, Connected)
<a name="14454"/>14454: 		     end,
<a name="14455"/>14455: 
<a name="14456"/>14456:     ?P(&quot;Create UDP socket 1:&quot;),
<a name="14457"/>14457:     US1 = CreateSock(dgram, udp),
<a name="14458"/>14458:     ?P(&quot;UDP[1] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(US1)]),
<a name="14459"/>14459:     VerifyBspState(BspState(US1), dgram, udp, false, false),
<a name="14460"/>14460: 
<a name="14461"/>14461:     ?P(&quot;Create UDP socket 2:&quot;),
<a name="14462"/>14462:     US2 = CreateSock(dgram, udp),
<a name="14463"/>14463:     ?P(&quot;UDP[2] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(US2)]),
<a name="14464"/>14464:     VerifyBspState(BspState(US2), dgram, udp, false, false),
<a name="14465"/>14465: 
<a name="14466"/>14466:     ?P(&quot;Bind UDP socket 1&quot;),
<a name="14467"/>14467:     BindSock(US1, LSA),
<a name="14468"/>14468:     ?P(&quot;UDP[1] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(US1)]),
<a name="14469"/>14469:     VerifyBspState(BspState(US1), dgram, udp, true, false),
<a name="14470"/>14470: 
<a name="14471"/>14471:     ?P(&quot;Bind UDP socket 2&quot;),
<a name="14472"/>14472:     BindSock(US2, LSA),
<a name="14473"/>14473:     ?P(&quot;UDP[2] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(US2)]),
<a name="14474"/>14474:     VerifyBspState(BspState(US2), dgram, udp, true, false),
<a name="14475"/>14475: 
<a name="14476"/>14476:     %% We have not yet implemented 'connect' for UDP on Windows,
<a name="14477"/>14477:     %% so we leave this commented for now:
<a name="14478"/>14478: 
<a name="14479"/>14479:     %% ?P(&quot;socknames&quot;),
<a name="14480"/>14480:     %% USN1 = Sockname(US1),
<a name="14481"/>14481:     %% USN2 = Sockname(US2),
<a name="14482"/>14482: 
<a name="14483"/>14483:     %% ?P(&quot;enable debug for US1&quot;),
<a name="14484"/>14484:     %% EnableDebug(US1),
<a name="14485"/>14485: 
<a name="14486"/>14486:     %% ?P(&quot;Connect UDP socket 1 to&quot;
<a name="14487"/>14487:     %%    &quot;~n   ~p&quot;, [USN2]),
<a name="14488"/>14488:     %% ConnectSock(US1, USN2),
<a name="14489"/>14489:     %% ?P(&quot;UDP[1] [Bound | Connected]     =&gt; ~p&quot;, [BspState(US1)]),
<a name="14490"/>14490: 
<a name="14491"/>14491:     %% ?P(&quot;Connect UDP socket 2 to&quot;
<a name="14492"/>14492:     %%    &quot;~n   ~p&quot;, [USN1]),
<a name="14493"/>14493:     %% ConnectSock(US2, USN1),
<a name="14494"/>14494:     %% ?P(&quot;UDP[2] [Bound | Connected]     =&gt; ~p&quot;, [BspState(US2)]),
<a name="14495"/>14495: 
<a name="14496"/>14496: 
<a name="14497"/>14497:     ?P(&quot;Create TCP socket 1:&quot;),
<a name="14498"/>14498:     TS1 = CreateSock(stream, tcp),
<a name="14499"/>14499:     ?P(&quot;TCP[1] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(TS1)]),
<a name="14500"/>14500:     VerifyBspState(BspState(TS1), stream, tcp, false, false),
<a name="14501"/>14501: 
<a name="14502"/>14502:     ?P(&quot;Create TCP socket 2 (listen):&quot;),
<a name="14503"/>14503:     TS2 = CreateSock(stream, tcp),
<a name="14504"/>14504:     ?P(&quot;TCP[2] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(TS2)]),
<a name="14505"/>14505:     VerifyBspState(BspState(TS2), stream, tcp, false, false),
<a name="14506"/>14506: 
<a name="14507"/>14507:     ?P(&quot;Bind TCP socket 1&quot;),
<a name="14508"/>14508:     BindSock(TS1, LSA),
<a name="14509"/>14509:     ?P(&quot;TCP[1] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(TS1)]),
<a name="14510"/>14510:     VerifyBspState(BspState(TS1), stream, tcp, true, false),
<a name="14511"/>14511: 
<a name="14512"/>14512:     ?P(&quot;Bind TCP socket 2&quot;),
<a name="14513"/>14513:     BindSock(TS2, LSA),
<a name="14514"/>14514:     ?P(&quot;TCP[2] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(TS2)]),
<a name="14515"/>14515:     VerifyBspState(BspState(TS2), stream, tcp, true, false),
<a name="14516"/>14516: 
<a name="14517"/>14517:     ?P(&quot;Make TCP socket 2 listen&quot;),
<a name="14518"/>14518:     ListenSock(TS2),
<a name="14519"/>14519: 
<a name="14520"/>14520:     ?P(&quot;socknames&quot;),
<a name="14521"/>14521:     TSN2 = Sockname(TS2),
<a name="14522"/>14522: 
<a name="14523"/>14523:     ?P(&quot;Connect TCP socket 1 to&quot;
<a name="14524"/>14524:        &quot;~n   ~p&quot;, [TSN2]),
<a name="14525"/>14525:     ConnectSock(TS1, TSN2),
<a name="14526"/>14526:     ?P(&quot;TCP[1] [Bound | Connected]   =&gt; ~p&quot;, [BspState(TS1)]),
<a name="14527"/>14527:     VerifyBspState(BspState(TS1), stream, tcp, true, true),
<a name="14528"/>14528: 
<a name="14529"/>14529:     ?P(&quot;Accept TCP socket 3&quot;),
<a name="14530"/>14530:     TS3 = AcceptSock(TS2),
<a name="14531"/>14531:     ?P(&quot;TCP[3] [Bound | Connected]   =&gt; ~p&quot;, [BspState(TS3)]),
<a name="14532"/>14532:     VerifyBspState(BspState(TS3), stream, tcp, true, true),
<a name="14533"/>14533: 
<a name="14534"/>14534:     ?P(&quot;Close socket(s)&quot;),
<a name="14535"/>14535:     CloseSock(TS3),
<a name="14536"/>14536:     CloseSock(TS2),
<a name="14537"/>14537:     CloseSock(TS1),
<a name="14538"/>14538: 
<a name="14539"/>14539:     ?P(&quot;done&quot;),
<a name="api_opt_sock_bsp_state-last_expr"/><a name="14540"/>14540:     ok.
<a name="14541"/>14541: 
<a name="14542"/>14542: 
<a name="verify_bsp_state-5"/><a name="14543"/>14543: <b>verify_bsp_state</b>(#{type        := T,
<a name="14544"/>14544: 		   protocol    := P,
<a name="14545"/>14545: 		   local_addr  := LA,
<a name="14546"/>14546: 		   remote_addr := RA},
<a name="14547"/>14547: 		 Type, Proto,
<a name="14548"/>14548: 		 Bound, Connected) when (T =:= Type) andalso (P =:= Proto) -&gt;
<a name="14549"/>14549:     case {Bound, LA} of
<a name="14550"/>14550: 	{false, undefined} -&gt;
<a name="14551"/>14551: 	    ok;
<a name="14552"/>14552: 	{true, _} when (LA =/= undefined) -&gt;
<a name="14553"/>14553: 	    ok;
<a name="14554"/>14554: 	_ -&gt;
<a name="14555"/>14555: 	    ?FAIL({invalid_bound_la, Bound, LA})
<a name="14556"/>14556:     end,
<a name="14557"/>14557:     case {Connected, RA} of
<a name="14558"/>14558: 	{false, undefined} -&gt;
<a name="14559"/>14559: 	    ok;
<a name="14560"/>14560: 	{true, _} when (RA =/= undefined) -&gt;
<a name="14561"/>14561: 	    ok;
<a name="14562"/>14562: 	_ -&gt;
<a name="14563"/>14563: 	    ?FAIL({invalid_connected_ra, Connected, RA})
<a name="14564"/>14564:     end,
<a name="14565"/>14565:     ok;
<a name="14566"/>14566: <b>verify_bsp_state</b>(#{type     := T,
<a name="14567"/>14567: 		   protocol := P},
<a name="14568"/>14568: 		 Type, Proto,
<a name="14569"/>14569: 		 _Bound, _Connected) -&gt;
<a name="verify_bsp_state-last_expr"/><a name="14570"/>14570: <b>    ?FAIL</b>({invalid_type_or_proto, {T, Type}, {P, Proto}}).
<a name="14571"/>14571: 
<a name="14572"/>14572: 
<a name="14573"/>14573:     
<a name="14574"/>14574: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14575"/>14575: 
<a name="14576"/>14576: <i>%% Tests the socket option linger. PLACEHOLDER!</i>
<a name="14577"/>14577: 
<a name="api_opt_sock_linger-1"/><a name="14578"/>14578: <b>api_opt_sock_linger</b>(_Config) when is_list(_Config) -&gt;
<a name="14579"/>14579:     ?TT(?SECS(10)),
<a name="api_opt_sock_linger-last_expr"/><a name="14580"/>14580: <b>    tc_try</b>(api_opt_sock_linger,
<a name="14581"/>14581:            fun() -&gt; not_yet_implemented() end,
<a name="14582"/>14582:            fun() -&gt; ok end).
<a name="14583"/>14583: 
<a name="14584"/>14584: 
<a name="14585"/>14585: 
<a name="14586"/>14586: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14587"/>14587: 
<a name="14588"/>14588: <i>%% Tests the socket option mark. PLACEHOLDER!</i>
<a name="14589"/>14589: 
<a name="api_opt_sock_mark-1"/><a name="14590"/>14590: <b>api_opt_sock_mark</b>(_Config) when is_list(_Config) -&gt;
<a name="14591"/>14591:     ?TT(?SECS(10)),
<a name="api_opt_sock_mark-last_expr"/><a name="14592"/>14592: <b>    tc_try</b>(api_opt_sock_mark,
<a name="14593"/>14593:            fun() -&gt; not_yet_implemented() end,
<a name="14594"/>14594:            fun() -&gt; ok end).
<a name="14595"/>14595: 
<a name="14596"/>14596: 
<a name="14597"/>14597: 
<a name="14598"/>14598: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14599"/>14599: 
<a name="14600"/>14600: <i>%% Tests the socket option maxdg.</i>
<a name="14601"/>14601: 
<a name="api_opt_sock_maxdg-1"/><a name="14602"/>14602: <b>api_opt_sock_maxdg</b>(_Config) when is_list(_Config) -&gt;
<a name="14603"/>14603:     ?TT(?SECS(10)),
<a name="api_opt_sock_maxdg-last_expr"/><a name="14604"/>14604: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14605"/>14605: 	   fun() -&gt;
<a name="14606"/>14606: 		   %% This is not a 'IPv4' option,
<a name="14607"/>14607: 		   %% but since we used it in the test...
<a name="14608"/>14608:                    has_support_ipv4(),
<a name="14609"/>14609:                    has_support_sock_maxdg()
<a name="14610"/>14610:            end,
<a name="14611"/>14611:            fun() -&gt; do_api_opt_sock_maxdg() end).
<a name="14612"/>14612: 
<a name="do_api_opt_sock_maxdg-0"/><a name="14613"/>14613: <b>do_api_opt_sock_maxdg</b>() -&gt;
<a name="14614"/>14614:     ?P(&quot;create DGRAM socket&quot;),
<a name="14615"/>14615:     {ok, S} = socket:open(inet, dgram),
<a name="14616"/>14616:     ?P(&quot;get maxdg&quot;),
<a name="do_api_opt_sock_maxdg-last_expr"/><a name="14617"/>14617: <b>    case socket:getopt</b>(S, socket, maxdg) of
<a name="14618"/>14618: 	{ok, Sz} -&gt;
<a name="14619"/>14619: 	    ?P(&quot;success: Sz = ~p&quot;, [Sz]),
<a name="14620"/>14620: 	    ok;
<a name="14621"/>14621: 	{error, Reason} -&gt;
<a name="14622"/>14622: 	    ?FAIL({failed_get_maxdg, Reason})
<a name="14623"/>14623:     end.
<a name="14624"/>14624: 
<a name="14625"/>14625: 
<a name="14626"/>14626: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14627"/>14627: 
<a name="14628"/>14628: <i>%% Tests the socket option max_msg_size.</i>
<a name="14629"/>14629: 
<a name="api_opt_sock_max_msg_size-1"/><a name="14630"/>14630: <b>api_opt_sock_max_msg_size</b>(_Config) when is_list(_Config) -&gt;
<a name="14631"/>14631:     ?TT(?SECS(10)),
<a name="api_opt_sock_max_msg_size-last_expr"/><a name="14632"/>14632: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14633"/>14633: 	   fun() -&gt;
<a name="14634"/>14634: 		   %% This is not a 'IPv4' option,
<a name="14635"/>14635: 		   %% but since we used it in the test...
<a name="14636"/>14636:                    has_support_ipv4(),
<a name="14637"/>14637:                    has_support_sock_max_msg_size()
<a name="14638"/>14638:            end,
<a name="14639"/>14639:            fun() -&gt; do_api_opt_sock_max_msg_size() end).
<a name="14640"/>14640: 
<a name="do_api_opt_sock_max_msg_size-0"/><a name="14641"/>14641: <b>do_api_opt_sock_max_msg_size</b>() -&gt;
<a name="14642"/>14642:     {ok, S} = socket:open(inet, dgram),
<a name="do_api_opt_sock_max_msg_size-last_expr"/><a name="14643"/>14643: <b>    case socket:getopt</b>(S, socket, max_msg_size) of
<a name="14644"/>14644: 	{ok, Sz} -&gt;
<a name="14645"/>14645: 	    ?P(&quot;success: Sz = ~p&quot;, [Sz]),
<a name="14646"/>14646: 	    ok;
<a name="14647"/>14647: 	{error, Reason} -&gt;
<a name="14648"/>14648: 	    ?FAIL({failed_get_max_msg_size, Reason})
<a name="14649"/>14649:     end.
<a name="14650"/>14650: 
<a name="14651"/>14651: 
<a name="14652"/>14652: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14653"/>14653: 
<a name="14654"/>14654: <i>%% This test case tries to test that the oobinline socket 'socket' option</i>
<a name="14655"/>14655: <i>%% works.</i>
<a name="14656"/>14656: <i>%% So, this is done on the receiving side: </i>
<a name="14657"/>14657: <i>%%</i>
<a name="14658"/>14658: <i>%%               socket:setopt(Sock, socket, oobinline, boolean()).</i>
<a name="14659"/>14659: <i>%%</i>
<a name="14660"/>14660: <i>%% This works on linux of some version (at least linux kernel 4.15.0),</i>
<a name="14661"/>14661: <i>%% but not on FreeBSD (12) for some reason. Until we have figured out</i>
<a name="14662"/>14662: <i>%% exctly why, we skip a bunch of OSs...</i>
<a name="14663"/>14663: <i>%%</i>
<a name="14664"/>14664: <i>%% Do we need to make sure the two entities does not run in the same</i>
<a name="14665"/>14665: <i>%% process? This test case does not currently do that (which works in'</i>
<a name="14666"/>14666: <i>%% linux but maybe not in, say, FreeBSD).</i>
<a name="14667"/>14667: <i>%%</i>
<a name="14668"/>14668: 
<a name="api_opt_sock_oobinline-1"/><a name="14669"/>14669: <b>api_opt_sock_oobinline</b>(_Config) when is_list(_Config) -&gt;
<a name="14670"/>14670:     ?TT(?SECS(5)),
<a name="api_opt_sock_oobinline-last_expr"/><a name="14671"/>14671: <b>    tc_try</b>(api_opt_sock_ooinline,
<a name="14672"/>14672:            fun() -&gt;
<a name="14673"/>14673:                    has_support_sock_oobinline(),
<a name="14674"/>14674:                    has_support_msg_flag(oob),
<a name="14675"/>14675:                    is_valid_oobinline_platform()
<a name="14676"/>14676:            end,
<a name="14677"/>14677:            fun() -&gt;
<a name="14678"/>14678:                    Set  = fun(Sock, Value) -&gt;
<a name="14679"/>14679:                                   socket:setopt(Sock, socket, oobinline, Value)
<a name="14680"/>14680:                           end,
<a name="14681"/>14681:                    Get  = fun(Sock) -&gt;
<a name="14682"/>14682:                                   socket:getopt(Sock, socket, oobinline)
<a name="14683"/>14683:                           end,
<a name="14684"/>14684:                    Send = fun(Sock, Data, true) -&gt;
<a name="14685"/>14685:                                   socket:send(Sock, Data, [oob]);
<a name="14686"/>14686:                              (Sock, Data, false) -&gt;
<a name="14687"/>14687:                                      socket:send(Sock, Data)
<a name="14688"/>14688:                           end,
<a name="14689"/>14689:                    Recv = fun(Sock, true) -&gt;
<a name="14690"/>14690:                                   socket:recv(Sock, 0, [oob]);
<a name="14691"/>14691:                              (Sock, false) -&gt;
<a name="14692"/>14692:                                   socket:recv(Sock)
<a name="14693"/>14693:                           end,
<a name="14694"/>14694:                    InitState = #{domain =&gt; inet_or_inet6(),
<a name="14695"/>14695:                                  proto  =&gt; tcp,
<a name="14696"/>14696:                                  send   =&gt; Send,
<a name="14697"/>14697:                                  recv   =&gt; Recv,
<a name="14698"/>14698:                                  set    =&gt; Set,
<a name="14699"/>14699:                                  get    =&gt; Get},
<a name="14700"/>14700:                    ok = do_api_opt_sock_oobinline(InitState)
<a name="14701"/>14701:            end).
<a name="14702"/>14702: 
<a name="14703"/>14703: <i>%% Hopefully this is a temporary solution...</i>
<a name="is_valid_oobinline_platform-0"/><a name="14704"/>14704: <b>is_valid_oobinline_platform</b>() -&gt;
<a name="is_valid_oobinline_platform-last_expr"/><a name="14705"/>14705: <b>    case os:type</b>() of
<a name="14706"/>14706:         {unix, linux} -&gt;
<a name="14707"/>14707:             ok;
<a name="14708"/>14708: 
<a name="14709"/>14709:         Type -&gt;
<a name="14710"/>14710:             %% Actually, all we know is that the
<a name="14711"/>14711:             %% test case only work for linux, but
<a name="14712"/>14712:             %% it *should* for FreeBSD and Solaris
<a name="14713"/>14713:             %% also...
<a name="14714"/>14714:             not_supported(Type)
<a name="14715"/>14715:     end.
<a name="14716"/>14716:     
<a name="14717"/>14717: 
<a name="14718"/>14718: 
<a name="14719"/>14719: 
<a name="14720"/>14720: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14721"/>14721: 
<a name="do_api_opt_sock_oobinline-1"/><a name="14722"/>14722: <b>do_api_opt_sock_oobinline</b>(InitState) -&gt;
<a name="14723"/>14723:     process_flag(trap_exit, true),
<a name="14724"/>14724:     ServerSeq =
<a name="14725"/>14725:         [
<a name="14726"/>14726:          %% *** Wait for start order ***
<a name="14727"/>14727:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="14728"/>14728:            cmd  =&gt; fun(State) -&gt;
<a name="14729"/>14729:                            Tester = ?SEV_AWAIT_START(),
<a name="14730"/>14730:                            {ok, State#{tester =&gt; Tester}}
<a name="14731"/>14731:                    end},
<a name="14732"/>14732:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="14733"/>14733:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14734"/>14734:                            _MRef = erlang:monitor(process, Tester),
<a name="14735"/>14735:                            ok
<a name="14736"/>14736:                    end},
<a name="14737"/>14737: 
<a name="14738"/>14738:          %% *** Init part ***
<a name="14739"/>14739:          #{desc =&gt; &quot;which local address&quot;,
<a name="14740"/>14740:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14741"/>14741:                            LSA = which_local_socket_addr(Domain),
<a name="14742"/>14742:                            {ok, State#{lsa =&gt; LSA}}
<a name="14743"/>14743:                    end},
<a name="14744"/>14744:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="14745"/>14745:            cmd  =&gt; fun(#{domain := Domain,
<a name="14746"/>14746:                          proto  := Proto} = State) -&gt;
<a name="14747"/>14747:                            case socket:open(Domain, stream, Proto) of
<a name="14748"/>14748:                                {ok, Sock} -&gt;
<a name="14749"/>14749:                                    {ok, State#{lsock =&gt; Sock}};
<a name="14750"/>14750:                                {error, _} = ERROR -&gt;
<a name="14751"/>14751:                                    ERROR
<a name="14752"/>14752:                            end
<a name="14753"/>14753:                    end},
<a name="14754"/>14754:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="14755"/>14755:            cmd  =&gt; fun(#{domain := local,
<a name="14756"/>14756:                          lsock  := LSock,
<a name="14757"/>14757:                          lsa    := LSA} = _State) -&gt;
<a name="14758"/>14758:                            case socket:bind(LSock, LSA) of
<a name="14759"/>14759:                                ok -&gt;
<a name="14760"/>14760:                                    ok; % We do not care about the port for local
<a name="14761"/>14761:                                {error, _} = ERROR -&gt;
<a name="14762"/>14762:                                    ERROR
<a name="14763"/>14763:                            end;
<a name="14764"/>14764:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="14765"/>14765:                            case sock_bind(LSock, LSA) of
<a name="14766"/>14766:                                ok -&gt;
<a name="14767"/>14767:                                    Port = sock_port(LSock),
<a name="14768"/>14768:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="14769"/>14769:                                    {ok, State#{lport =&gt; Port}};
<a name="14770"/>14770:                                {error, _} = ERROR -&gt;
<a name="14771"/>14771:                                    ERROR
<a name="14772"/>14772:                            end
<a name="14773"/>14773:                    end},
<a name="14774"/>14774:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="14775"/>14775:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="14776"/>14776:                            socket:listen(LSock)
<a name="14777"/>14777:                    end},
<a name="14778"/>14778:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="14779"/>14779:            cmd  =&gt; fun(#{domain := local,
<a name="14780"/>14780:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="14781"/>14781:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="14782"/>14782:                            ok;
<a name="14783"/>14783:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="14784"/>14784:                            %% This is actually not used for unix domain socket
<a name="14785"/>14785:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="14786"/>14786:                            ok
<a name="14787"/>14787:                    end},
<a name="14788"/>14788: 
<a name="14789"/>14789: 
<a name="14790"/>14790:          %% The actual test
<a name="14791"/>14791:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="14792"/>14792:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14793"/>14793:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="14794"/>14794:                    end},
<a name="14795"/>14795:          #{desc =&gt; &quot;await connection&quot;,
<a name="14796"/>14796:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="14797"/>14797:                            case socket:accept(LSock) of
<a name="14798"/>14798:                                {ok, Sock} -&gt;
<a name="14799"/>14799:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="14800"/>14800:                                    {ok, State#{csock =&gt; Sock}};
<a name="14801"/>14801:                                {error, _} = ERROR -&gt;
<a name="14802"/>14802:                                    ERROR
<a name="14803"/>14803:                            end
<a name="14804"/>14804:                    end},
<a name="14805"/>14805:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="14806"/>14806:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14807"/>14807:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="14808"/>14808:                            ok
<a name="14809"/>14809:                    end},
<a name="14810"/>14810: 
<a name="14811"/>14811:          %% *** no oobinline ***
<a name="14812"/>14812: 
<a name="14813"/>14813:          #{desc =&gt; &quot;await continue (verify no oobinline)&quot;,
<a name="14814"/>14814:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="14815"/>14815:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_oobinline)
<a name="14816"/>14816:                    end},
<a name="14817"/>14817:          #{desc =&gt; &quot;verify no oobinline&quot;,
<a name="14818"/>14818:            cmd  =&gt; fun(#{csock := Sock, get := Get} = _State) -&gt;
<a name="14819"/>14819:                            case Get(Sock) of
<a name="14820"/>14820:                                {ok, false = _Value} -&gt;
<a name="14821"/>14821:                                    ?SEV_IPRINT(&quot;oobinline: ~p&quot;, [_Value]),
<a name="14822"/>14822:                                    ok;
<a name="14823"/>14823:                                {ok, Unexpected} -&gt;
<a name="14824"/>14824:                                    ?SEV_EPRINT(&quot;Unexpected oobinline: ~p&quot;,
<a name="14825"/>14825:                                                [Unexpected]),
<a name="14826"/>14826:                                    {error, {unexpected_oobinline, Unexpected}};
<a name="14827"/>14827:                                {error, Reason} = ERROR -&gt;
<a name="14828"/>14828:                                    ?SEV_EPRINT(&quot;Failed getting oobinline:&quot;
<a name="14829"/>14829:                                                &quot;   ~p&quot;, [Reason]),
<a name="14830"/>14830:                                    ERROR
<a name="14831"/>14831:                            end                                   
<a name="14832"/>14832:                    end},
<a name="14833"/>14833:          #{desc =&gt; &quot;announce ready (no oobinline)&quot;,
<a name="14834"/>14834:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14835"/>14835:                            ?SEV_ANNOUNCE_READY(Tester, no_oobinline),
<a name="14836"/>14836:                            ok
<a name="14837"/>14837:                    end},
<a name="14838"/>14838: 
<a name="14839"/>14839:          #{desc =&gt; &quot;await continue (recv no oobinline)&quot;,
<a name="14840"/>14840:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14841"/>14841:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="14842"/>14842:                    end},
<a name="14843"/>14843:          #{desc =&gt; &quot;await plain data&quot;,
<a name="14844"/>14844:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="14845"/>14845:                            case Recv(Sock, false) of
<a name="14846"/>14846:                                {ok, &lt;&lt;&quot;a&quot;&gt;&gt;} -&gt;
<a name="14847"/>14847:                                    ?SEV_IPRINT(&quot;received plain data&quot;),
<a name="14848"/>14848:                                    ok;
<a name="14849"/>14849:                                {error, _} = ERROR -&gt;
<a name="14850"/>14850:                                    ERROR
<a name="14851"/>14851:                            end
<a name="14852"/>14852:                    end},
<a name="14853"/>14853:          #{desc =&gt; &quot;announce ready (plain data)&quot;,
<a name="14854"/>14854:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14855"/>14855:                            ?SEV_ANNOUNCE_READY(Tester, recv_plain),
<a name="14856"/>14856:                            ok
<a name="14857"/>14857:                    end},
<a name="14858"/>14858:          #{desc =&gt; &quot;await oob data&quot;,
<a name="14859"/>14859:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="14860"/>14860:                            case Recv(Sock, true) of
<a name="14861"/>14861:                                {ok, &lt;&lt;&quot;b&quot;&gt;&gt;} -&gt;
<a name="14862"/>14862:                                    ?SEV_IPRINT(&quot;received oob data&quot;),
<a name="14863"/>14863:                                    ok;
<a name="14864"/>14864:                                {error, _} = ERROR -&gt;
<a name="14865"/>14865:                                    ERROR
<a name="14866"/>14866:                            end
<a name="14867"/>14867:                    end},
<a name="14868"/>14868:          #{desc =&gt; &quot;announce ready (oob data)&quot;,
<a name="14869"/>14869:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14870"/>14870:                            ?SEV_ANNOUNCE_READY(Tester, recv_oob),
<a name="14871"/>14871:                            ok
<a name="14872"/>14872:                    end},
<a name="14873"/>14873: 
<a name="14874"/>14874:          %% *** oobinline ***
<a name="14875"/>14875: 
<a name="14876"/>14876:           #{desc =&gt; &quot;await continue (enable oobinline)&quot;,
<a name="14877"/>14877:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="14878"/>14878:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_oobinline)
<a name="14879"/>14879:                    end},
<a name="14880"/>14880:          #{desc =&gt; &quot;enable oobinline&quot;,
<a name="14881"/>14881:            cmd  =&gt; fun(#{csock := Sock, set := Set} = _State) -&gt;
<a name="14882"/>14882:                            case Set(Sock, true) of
<a name="14883"/>14883:                                ok -&gt;
<a name="14884"/>14884:                                    ?SEV_IPRINT(&quot;oobinline enabled&quot;),
<a name="14885"/>14885:                                    ok;
<a name="14886"/>14886:                                {error, Reason} = ERROR -&gt;
<a name="14887"/>14887:                                    ?SEV_EPRINT(&quot;Failed enable oobinline:&quot;
<a name="14888"/>14888:                                                &quot;   ~p&quot;, [Reason]),
<a name="14889"/>14889:                                    ERROR
<a name="14890"/>14890:                            end                                   
<a name="14891"/>14891:                    end},
<a name="14892"/>14892:          #{desc =&gt; &quot;announce ready (oobinline)&quot;,
<a name="14893"/>14893:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14894"/>14894:                            ?SEV_ANNOUNCE_READY(Tester, oobinline),
<a name="14895"/>14895:                            ok
<a name="14896"/>14896:                    end},
<a name="14897"/>14897: 
<a name="14898"/>14898:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="14899"/>14899:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="14900"/>14900:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="14901"/>14901:                    end},
<a name="14902"/>14902:        #{desc =&gt; &quot;await (recv) data&quot;,
<a name="14903"/>14903:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="14904"/>14904:                            case Recv(Sock, false) of
<a name="14905"/>14905:                                {ok, &lt;&lt;&quot;ba&quot;&gt;&gt;} -&gt;
<a name="14906"/>14906:                                    ?SEV_IPRINT(&quot;received expected message: &quot;
<a name="14907"/>14907:                                                &quot;both plain and oob data&quot;),
<a name="14908"/>14908:                                    ok;
<a name="14909"/>14909:                                {ok, BadMsg} -&gt;
<a name="14910"/>14910:                                    ?SEV_EPRINT(&quot;received unexpected message: ~p&quot;,
<a name="14911"/>14911:                                                [BadMsg]),
<a name="14912"/>14912:                                    {error, {unexpected_msg, BadMsg}};
<a name="14913"/>14913:                                {error, _} = ERROR -&gt;
<a name="14914"/>14914:                                    ERROR
<a name="14915"/>14915:                            end
<a name="14916"/>14916:                    end},
<a name="14917"/>14917:          #{desc =&gt; &quot;announce ready (recv)&quot;,
<a name="14918"/>14918:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14919"/>14919:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="14920"/>14920:                            ok
<a name="14921"/>14921:                    end},
<a name="14922"/>14922: 
<a name="14923"/>14923:          %% *** Termination ***
<a name="14924"/>14924:          #{desc =&gt; &quot;await terminate&quot;,
<a name="14925"/>14925:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="14926"/>14926:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="14927"/>14927:                                ok -&gt;
<a name="14928"/>14928:                                    {ok, maps:remove(tester, State)};
<a name="14929"/>14929:                                {error, _} = ERROR -&gt;
<a name="14930"/>14930:                                    ERROR
<a name="14931"/>14931:                            end
<a name="14932"/>14932:                    end},
<a name="14933"/>14933:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="14934"/>14934:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="14935"/>14935:                            ok = socket:close(Sock),
<a name="14936"/>14936:                            {ok, maps:remove(csock, State)}
<a name="14937"/>14937:                    end},
<a name="14938"/>14938:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="14939"/>14939:            cmd  =&gt; fun(#{domain   := local,
<a name="14940"/>14940:                          lsock    := Sock,
<a name="14941"/>14941:                          local_sa := #{path := Path}} = State) -&gt;
<a name="14942"/>14942:                            ok = socket:close(Sock),
<a name="14943"/>14943:                            State1 =
<a name="14944"/>14944:                                unlink_path(Path,
<a name="14945"/>14945:                                            fun() -&gt;
<a name="14946"/>14946:                                                    maps:remove(local_sa, State)
<a name="14947"/>14947:                                            end,
<a name="14948"/>14948:                                            fun() -&gt; State end),
<a name="14949"/>14949:                            {ok, maps:remove(lsock, State1)};
<a name="14950"/>14950:                       (#{lsock := LSock} = State) -&gt;
<a name="14951"/>14951:                            case socket:close(LSock) of
<a name="14952"/>14952:                                ok -&gt;
<a name="14953"/>14953:                                    {ok, maps:remove(lsock, State)};
<a name="14954"/>14954:                                {error, _} = ERROR -&gt;
<a name="14955"/>14955:                                    ERROR
<a name="14956"/>14956:                            end
<a name="14957"/>14957:                    end},
<a name="14958"/>14958: 
<a name="14959"/>14959:          %% *** We are done ***
<a name="14960"/>14960:          ?SEV_FINISH_NORMAL
<a name="14961"/>14961:         ],
<a name="14962"/>14962: 
<a name="14963"/>14963: 
<a name="14964"/>14964:     ClientSeq =
<a name="14965"/>14965:         [
<a name="14966"/>14966:          %% *** Wait for start order ***
<a name="14967"/>14967:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="14968"/>14968:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="14969"/>14969:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="14970"/>14970:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="14971"/>14971:                       (State) -&gt;
<a name="14972"/>14972:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="14973"/>14973:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="14974"/>14974:                    end},
<a name="14975"/>14975:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="14976"/>14976:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14977"/>14977:                            _MRef = erlang:monitor(process, Tester),
<a name="14978"/>14978:                            ok
<a name="14979"/>14979:                    end},
<a name="14980"/>14980: 
<a name="14981"/>14981:          %% *** The init part ***
<a name="14982"/>14982:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="14983"/>14983:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="14984"/>14984:                          server_path := Path} = State) -&gt;
<a name="14985"/>14985:                            LSA = which_local_socket_addr(Domain),
<a name="14986"/>14986:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="14987"/>14987:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="14988"/>14988:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="14989"/>14989:                            LSA = which_local_socket_addr(Domain),
<a name="14990"/>14990:                            SSA = LSA#{port =&gt; Port},
<a name="14991"/>14991:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="14992"/>14992:                    end},
<a name="14993"/>14993:          #{desc =&gt; &quot;create socket&quot;,
<a name="14994"/>14994:            cmd  =&gt; fun(#{domain := Domain,
<a name="14995"/>14995:                          proto  := Proto} = State) -&gt;
<a name="14996"/>14996:                            case socket:open(Domain, stream, Proto) of
<a name="14997"/>14997:                                {ok, Sock} -&gt;
<a name="14998"/>14998:                                    {ok, State#{sock =&gt; Sock}};
<a name="14999"/>14999:                                {error, _} = ERROR -&gt;
<a name="15000"/>15000:                                    ERROR
<a name="15001"/>15001:                            end
<a name="15002"/>15002:                    end},
<a name="15003"/>15003:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="15004"/>15004:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="15005"/>15005:                            case sock_bind(Sock, LSA) of
<a name="15006"/>15006:                                ok -&gt;
<a name="15007"/>15007:                                    ok;
<a name="15008"/>15008:                                {error, _} = ERROR -&gt;
<a name="15009"/>15009:                                    ERROR
<a name="15010"/>15010:                            end
<a name="15011"/>15011:                    end},
<a name="15012"/>15012:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="15013"/>15013:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15014"/>15014:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="15015"/>15015:                            ok
<a name="15016"/>15016:                    end},
<a name="15017"/>15017: 
<a name="15018"/>15018:          %% *** The actual test ***
<a name="15019"/>15019:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="15020"/>15020:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15021"/>15021:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="15022"/>15022:                    end},
<a name="15023"/>15023:          #{desc =&gt; &quot;connect to server&quot;,
<a name="15024"/>15024:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="15025"/>15025:                            socket:connect(Sock, SSA)
<a name="15026"/>15026:                    end},
<a name="15027"/>15027:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="15028"/>15028:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15029"/>15029:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="15030"/>15030:                            ok
<a name="15031"/>15031:                    end},
<a name="15032"/>15032: 
<a name="15033"/>15033:          %% *** First batch of data (no oobinline) ***
<a name="15034"/>15034: 
<a name="15035"/>15035:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="15036"/>15036:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15037"/>15037:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="15038"/>15038:                    end},
<a name="15039"/>15039:          #{desc =&gt; &quot;send plain data&quot;,
<a name="15040"/>15040:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15041"/>15041:                            Send(Sock, &lt;&lt;&quot;a&quot;&gt;&gt;, false)
<a name="15042"/>15042:                    end},
<a name="15043"/>15043:          %% #{desc =&gt; &quot;enable (socket &amp; global) debug&quot;,
<a name="15044"/>15044:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="15045"/>15045:          %%                   ok = socket:setopt(Sock, otp, debug, true),
<a name="15046"/>15046:          %%                   ok = socket:debug(true)
<a name="15047"/>15047:          %%           end},
<a name="15048"/>15048:          #{desc =&gt; &quot;send oob data&quot;,
<a name="15049"/>15049:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15050"/>15050:                            Send(Sock, &lt;&lt;&quot;b&quot;&gt;&gt;, true)
<a name="15051"/>15051:                    end},
<a name="15052"/>15052:          %% #{desc =&gt; &quot;disable (socket) debug&quot;,
<a name="15053"/>15053:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="15054"/>15054:          %%                   ok = socket:debug(true),
<a name="15055"/>15055:          %%                   ok = socket:setopt(Sock, otp, debug, false)
<a name="15056"/>15056:          %%           end},
<a name="15057"/>15057:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="15058"/>15058:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15059"/>15059:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="15060"/>15060:                            ok
<a name="15061"/>15061:                    end},
<a name="15062"/>15062: 
<a name="15063"/>15063:          %% *** Second batch of data (oobinline) ***
<a name="15064"/>15064: 
<a name="15065"/>15065:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="15066"/>15066:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15067"/>15067:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="15068"/>15068:                    end},
<a name="15069"/>15069:          #{desc =&gt; &quot;send plain data&quot;,
<a name="15070"/>15070:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15071"/>15071:                            Send(Sock, &lt;&lt;&quot;a&quot;&gt;&gt;, false)
<a name="15072"/>15072:                    end},
<a name="15073"/>15073:          #{desc =&gt; &quot;send oob data&quot;,
<a name="15074"/>15074:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15075"/>15075:                            Send(Sock, &lt;&lt;&quot;b&quot;&gt;&gt;, true)
<a name="15076"/>15076:                    end},
<a name="15077"/>15077:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="15078"/>15078:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15079"/>15079:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="15080"/>15080:                            ok
<a name="15081"/>15081:                    end},
<a name="15082"/>15082: 
<a name="15083"/>15083:          %% *** Termination ***
<a name="15084"/>15084:          #{desc =&gt; &quot;await terminate&quot;,
<a name="15085"/>15085:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="15086"/>15086:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="15087"/>15087:                                ok -&gt;
<a name="15088"/>15088:                                    {ok, maps:remove(tester, State)};
<a name="15089"/>15089:                                {error, _} = ERROR -&gt;
<a name="15090"/>15090:                                    ERROR
<a name="15091"/>15091:                            end
<a name="15092"/>15092:                    end},
<a name="15093"/>15093:          #{desc =&gt; &quot;close socket&quot;,
<a name="15094"/>15094:            cmd  =&gt; fun(#{domain   := local,
<a name="15095"/>15095:                          sock     := Sock,
<a name="15096"/>15096:                          local_sa := #{path := Path}} = State) -&gt;
<a name="15097"/>15097:                            ok = socket:close(Sock),
<a name="15098"/>15098:                            State1 =
<a name="15099"/>15099:                                unlink_path(Path,
<a name="15100"/>15100:                                            fun() -&gt;
<a name="15101"/>15101:                                                    maps:remove(local_sa, State)
<a name="15102"/>15102:                                            end,
<a name="15103"/>15103:                                            fun() -&gt; State end),
<a name="15104"/>15104:                            {ok, maps:remove(sock, State1)};
<a name="15105"/>15105:                       (#{sock := Sock} = State) -&gt;
<a name="15106"/>15106:                            ok = socket:close(Sock),
<a name="15107"/>15107:                            {ok, maps:remove(sock, State)}
<a name="15108"/>15108:                    end},
<a name="15109"/>15109: 
<a name="15110"/>15110:          %% *** We are done ***
<a name="15111"/>15111:          ?SEV_FINISH_NORMAL
<a name="15112"/>15112:         ],
<a name="15113"/>15113: 
<a name="15114"/>15114: 
<a name="15115"/>15115:     TesterSeq =
<a name="15116"/>15116:         [
<a name="15117"/>15117:          %% *** Init part ***
<a name="15118"/>15118:          #{desc =&gt; &quot;monitor server&quot;,
<a name="15119"/>15119:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="15120"/>15120:                            _MRef = erlang:monitor(process, Pid),
<a name="15121"/>15121:                            ok
<a name="15122"/>15122:                    end},
<a name="15123"/>15123:          #{desc =&gt; &quot;monitor client&quot;,
<a name="15124"/>15124:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="15125"/>15125:                            _MRef = erlang:monitor(process, Pid),
<a name="15126"/>15126:                            ok
<a name="15127"/>15127:                    end},
<a name="15128"/>15128: 
<a name="15129"/>15129:          %% Start the server
<a name="15130"/>15130:          #{desc =&gt; &quot;order server start&quot;,
<a name="15131"/>15131:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="15132"/>15132:                            ?SEV_ANNOUNCE_START(Pid),
<a name="15133"/>15133:                            ok
<a name="15134"/>15134:                    end},
<a name="15135"/>15135:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="15136"/>15136:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="15137"/>15137:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="15138"/>15138:                            {ok, State#{server_port =&gt; Port}}
<a name="15139"/>15139:                    end},
<a name="15140"/>15140: 
<a name="15141"/>15141:          %% Start the client
<a name="15142"/>15142:          #{desc =&gt; &quot;order client start&quot;,
<a name="15143"/>15143:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="15144"/>15144:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="15145"/>15145:                            ok
<a name="15146"/>15146:                    end},
<a name="15147"/>15147:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="15148"/>15148:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="15149"/>15149:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="15150"/>15150:                    end},
<a name="15151"/>15151: 
<a name="15152"/>15152:          %% *** The actual test ***
<a name="15153"/>15153:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="15154"/>15154:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15155"/>15155:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="15156"/>15156:                            ok
<a name="15157"/>15157:                    end},
<a name="15158"/>15158:          ?SEV_SLEEP(?SECS(1)),
<a name="15159"/>15159:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="15160"/>15160:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15161"/>15161:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="15162"/>15162:                            ok
<a name="15163"/>15163:                    end},
<a name="15164"/>15164:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="15165"/>15165:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15166"/>15166:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="15167"/>15167:                    end},
<a name="15168"/>15168:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="15169"/>15169:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15170"/>15170:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="15171"/>15171:                    end},
<a name="15172"/>15172: 
<a name="15173"/>15173:          %% *** First batch of data (no oobinline) ***
<a name="15174"/>15174: 
<a name="15175"/>15175:          #{desc =&gt; &quot;order server to continue (with verify no oobinline)&quot;,
<a name="15176"/>15176:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15177"/>15177:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_oobinline),
<a name="15178"/>15178:                            ok
<a name="15179"/>15179:                    end},
<a name="15180"/>15180:          #{desc =&gt; &quot;await server ready (no oobinline)&quot;,
<a name="15181"/>15181:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15182"/>15182:                            ?SEV_AWAIT_READY(Server, server, no_oobinline)
<a name="15183"/>15183:                    end},
<a name="15184"/>15184: 
<a name="15185"/>15185:          #{desc =&gt; &quot;order client to continue (with send)&quot;,
<a name="15186"/>15186:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15187"/>15187:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="15188"/>15188:                            ok
<a name="15189"/>15189:                    end},
<a name="15190"/>15190:          #{desc =&gt; &quot;await client ready (with send)&quot;,
<a name="15191"/>15191:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15192"/>15192:                            ?SEV_AWAIT_READY(Client, client, send)
<a name="15193"/>15193:                    end},
<a name="15194"/>15194:          #{desc =&gt; &quot;order server to continue (with recv plain)&quot;,
<a name="15195"/>15195:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15196"/>15196:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv),
<a name="15197"/>15197:                            ok
<a name="15198"/>15198:                    end},
<a name="15199"/>15199:          #{desc =&gt; &quot;await server ready (recv plain)&quot;,
<a name="15200"/>15200:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15201"/>15201:                            ?SEV_AWAIT_READY(Server, server, recv_plain)
<a name="15202"/>15202:                    end},
<a name="15203"/>15203:          #{desc =&gt; &quot;await server ready (recv oob)&quot;,
<a name="15204"/>15204:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15205"/>15205:                            ?SEV_AWAIT_READY(Server, server, recv_oob)
<a name="15206"/>15206:                    end},
<a name="15207"/>15207: 
<a name="15208"/>15208:          %% Second message (w timestamp)
<a name="15209"/>15209: 
<a name="15210"/>15210:          #{desc =&gt; &quot;order server to continue (with enable oobinline)&quot;,
<a name="15211"/>15211:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15212"/>15212:                            ?SEV_ANNOUNCE_CONTINUE(Server, enable_oobinline),
<a name="15213"/>15213:                            ok
<a name="15214"/>15214:                    end},
<a name="15215"/>15215:          #{desc =&gt; &quot;await server ready (oobinline)&quot;,
<a name="15216"/>15216:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15217"/>15217:                            ?SEV_AWAIT_READY(Server, server, oobinline)
<a name="15218"/>15218:                    end},
<a name="15219"/>15219: 
<a name="15220"/>15220:          #{desc =&gt; &quot;order client to continue (with send)&quot;,
<a name="15221"/>15221:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15222"/>15222:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="15223"/>15223:                            ok
<a name="15224"/>15224:                    end},
<a name="15225"/>15225:          #{desc =&gt; &quot;await client ready (with send)&quot;,
<a name="15226"/>15226:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15227"/>15227:                            ?SEV_AWAIT_READY(Client, client, send)
<a name="15228"/>15228:                    end},
<a name="15229"/>15229:          #{desc =&gt; &quot;order server to continue (with recv)&quot;,
<a name="15230"/>15230:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15231"/>15231:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv),
<a name="15232"/>15232:                            ok
<a name="15233"/>15233:                    end},
<a name="15234"/>15234:          #{desc =&gt; &quot;await server ready (recv plain)&quot;,
<a name="15235"/>15235:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15236"/>15236:                            ?SEV_AWAIT_READY(Server, server, recv)
<a name="15237"/>15237:                    end},
<a name="15238"/>15238: 
<a name="15239"/>15239: 
<a name="15240"/>15240:          %% *** Termination ***
<a name="15241"/>15241:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="15242"/>15242:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15243"/>15243:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="15244"/>15244:                            ok
<a name="15245"/>15245:                    end},
<a name="15246"/>15246:          #{desc =&gt; &quot;await client termination&quot;,
<a name="15247"/>15247:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="15248"/>15248:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="15249"/>15249:                            State1 = maps:remove(client, State),
<a name="15250"/>15250:                            {ok, State1}
<a name="15251"/>15251:                    end},
<a name="15252"/>15252:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="15253"/>15253:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15254"/>15254:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="15255"/>15255:                            ok
<a name="15256"/>15256:                    end},
<a name="15257"/>15257:          #{desc =&gt; &quot;await server termination&quot;,
<a name="15258"/>15258:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="15259"/>15259:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="15260"/>15260:                            State1 = maps:remove(server, State),
<a name="15261"/>15261:                            {ok, State1}
<a name="15262"/>15262:                    end},
<a name="15263"/>15263: 
<a name="15264"/>15264:          %% *** We are done ***
<a name="15265"/>15265:          ?SEV_FINISH_NORMAL
<a name="15266"/>15266:         ],
<a name="15267"/>15267: 
<a name="15268"/>15268: 
<a name="15269"/>15269:     i(&quot;start server evaluator&quot;),
<a name="15270"/>15270:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="15271"/>15271: 
<a name="15272"/>15272:     i(&quot;start client evaluator&quot;),
<a name="15273"/>15273:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="15274"/>15274: 
<a name="15275"/>15275:     i(&quot;start tester evaluator&quot;),
<a name="15276"/>15276:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="15277"/>15277:                         client =&gt; Client#ev.pid},
<a name="15278"/>15278:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="15279"/>15279: 
<a name="do_api_opt_sock_oobinline-last_expr"/><a name="15280"/>15280: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="15281"/>15281: 
<a name="15282"/>15282: 
<a name="15283"/>15283: 
<a name="15284"/>15284: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15285"/>15285: 
<a name="15286"/>15286: <i>%% Tests that the credentials control message header is received when</i>
<a name="15287"/>15287: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="15288"/>15288: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="15289"/>15289: <i>%% So, this is done on the receiving side: </i>
<a name="15290"/>15290: <i>%%</i>
<a name="15291"/>15291: <i>%%               socket:setopt(Sock, socket, passcred, boolean()).</i>
<a name="15292"/>15292: <i>%%</i>
<a name="15293"/>15293: <i>%% We *may* need to run the different entities (server and client) in </i>
<a name="15294"/>15294: <i>%% separate VM (os processes) for this to actually work.</i>
<a name="15295"/>15295: <i>%% As it is now, the client does *not* get any credentials!</i>
<a name="15296"/>15296: <i>%% Until this has been done, this case is skipped!.</i>
<a name="15297"/>15297: 
<a name="api_opt_sock_passcred_tcp4-1"/><a name="15298"/>15298: <b>api_opt_sock_passcred_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="15299"/>15299:     ?TT(?SECS(5)),
<a name="api_opt_sock_passcred_tcp4-last_expr"/><a name="15300"/>15300: <b>    tc_try</b>(api_opt_sock_passcred_tcp4,
<a name="15301"/>15301:            fun() -&gt; has_support_sock_passcred(),
<a name="15302"/>15302:                     not_yet_implemented()
<a name="15303"/>15303:            end,
<a name="15304"/>15304:            fun() -&gt;
<a name="15305"/>15305:                    Set  = fun(Sock, Value) -&gt;
<a name="15306"/>15306:                                   socket:setopt(Sock, socket, passcred, Value)
<a name="15307"/>15307:                           end,
<a name="15308"/>15308:                    Get  = fun(Sock) -&gt;
<a name="15309"/>15309:                                   socket:getopt(Sock, socket, passcred)
<a name="15310"/>15310:                           end,
<a name="15311"/>15311:                    Send = fun(Sock, Data) -&gt;
<a name="15312"/>15312:                                   Msg = #{iov  =&gt; [Data]},
<a name="15313"/>15313:                                   socket:sendmsg(Sock, Msg)
<a name="15314"/>15314:                           end,
<a name="15315"/>15315:                    Recv = fun(Sock) -&gt;
<a name="15316"/>15316:                                   case socket:recvmsg(Sock) of
<a name="15317"/>15317:                                       {ok, #{ctrl := CMsgs,
<a name="15318"/>15318:                                              iov  := [Data]}} -&gt;
<a name="15319"/>15319:                                           {ok, {CMsgs, Data}};
<a name="15320"/>15320:                                       {error, _} = ERROR -&gt;
<a name="15321"/>15321:                                           ERROR
<a name="15322"/>15322:                                   end
<a name="15323"/>15323:                           end,
<a name="15324"/>15324:                    InitState = #{domain =&gt; inet,
<a name="15325"/>15325:                                  proto  =&gt; tcp,
<a name="15326"/>15326:                                  send   =&gt; Send,
<a name="15327"/>15327:                                  recv   =&gt; Recv,
<a name="15328"/>15328:                                  set    =&gt; Set,
<a name="15329"/>15329:                                  get    =&gt; Get},
<a name="15330"/>15330:                    ok = api_opt_sock_passcred_tcp(InitState)
<a name="15331"/>15331:            end).
<a name="15332"/>15332: 
<a name="15333"/>15333: 
<a name="15334"/>15334: 
<a name="15335"/>15335: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15336"/>15336: 
<a name="api_opt_sock_passcred_tcp-1"/><a name="15337"/>15337: <b>api_opt_sock_passcred_tcp</b>(InitState) -&gt;
<a name="15338"/>15338:     process_flag(trap_exit, true),
<a name="15339"/>15339:     ServerSeq =
<a name="15340"/>15340:         [
<a name="15341"/>15341:          %% *** Wait for start order ***
<a name="15342"/>15342:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="15343"/>15343:            cmd  =&gt; fun(State) -&gt;
<a name="15344"/>15344:                            Tester = ?SEV_AWAIT_START(),
<a name="15345"/>15345:                            {ok, State#{tester =&gt; Tester}}
<a name="15346"/>15346:                    end},
<a name="15347"/>15347:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="15348"/>15348:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15349"/>15349:                            _MRef = erlang:monitor(process, Tester),
<a name="15350"/>15350:                            ok
<a name="15351"/>15351:                    end},
<a name="15352"/>15352: 
<a name="15353"/>15353:          %% *** Init part ***
<a name="15354"/>15354:          #{desc =&gt; &quot;which local address&quot;,
<a name="15355"/>15355:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="15356"/>15356:                            LSA = which_local_socket_addr(Domain),
<a name="15357"/>15357:                            {ok, State#{lsa =&gt; LSA}}
<a name="15358"/>15358:                    end},
<a name="15359"/>15359:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="15360"/>15360:            cmd  =&gt; fun(#{domain := Domain,
<a name="15361"/>15361:                          proto  := Proto} = State) -&gt;
<a name="15362"/>15362:                            case socket:open(Domain, stream, Proto) of
<a name="15363"/>15363:                                {ok, Sock} -&gt;
<a name="15364"/>15364:                                    {ok, State#{lsock =&gt; Sock}};
<a name="15365"/>15365:                                {error, _} = ERROR -&gt;
<a name="15366"/>15366:                                    ERROR
<a name="15367"/>15367:                            end
<a name="15368"/>15368:                    end},
<a name="15369"/>15369:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="15370"/>15370:            cmd  =&gt; fun(#{domain := local,
<a name="15371"/>15371:                          lsock  := LSock,
<a name="15372"/>15372:                          lsa    := LSA} = _State) -&gt;
<a name="15373"/>15373:                            case socket:bind(LSock, LSA) of
<a name="15374"/>15374:                                ok -&gt;
<a name="15375"/>15375:                                    ok; % We do not care about the port for local
<a name="15376"/>15376:                                {error, _} = ERROR -&gt;
<a name="15377"/>15377:                                    ERROR
<a name="15378"/>15378:                            end;
<a name="15379"/>15379:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="15380"/>15380:                            case sock_bind(LSock, LSA) of
<a name="15381"/>15381:                                ok -&gt;
<a name="15382"/>15382:                                    Port = sock_port(LSock),
<a name="15383"/>15383:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="15384"/>15384:                                    {ok, State#{lport =&gt; Port}};
<a name="15385"/>15385:                                {error, _} = ERROR -&gt;
<a name="15386"/>15386:                                    ERROR
<a name="15387"/>15387:                            end
<a name="15388"/>15388:                    end},
<a name="15389"/>15389:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="15390"/>15390:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="15391"/>15391:                            socket:listen(LSock)
<a name="15392"/>15392:                    end},
<a name="15393"/>15393:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="15394"/>15394:            cmd  =&gt; fun(#{domain := local,
<a name="15395"/>15395:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="15396"/>15396:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="15397"/>15397:                            ok;
<a name="15398"/>15398:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="15399"/>15399:                            %% This is actually not used for unix domain socket
<a name="15400"/>15400:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="15401"/>15401:                            ok
<a name="15402"/>15402:                    end},
<a name="15403"/>15403: 
<a name="15404"/>15404: 
<a name="15405"/>15405:          %% The actual test
<a name="15406"/>15406:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="15407"/>15407:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15408"/>15408:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="15409"/>15409:                    end},
<a name="15410"/>15410:          #{desc =&gt; &quot;await connection&quot;,
<a name="15411"/>15411:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="15412"/>15412:                            case socket:accept(LSock) of
<a name="15413"/>15413:                                {ok, Sock} -&gt;
<a name="15414"/>15414:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="15415"/>15415:                                    {ok, State#{csock =&gt; Sock}};
<a name="15416"/>15416:                                {error, _} = ERROR -&gt;
<a name="15417"/>15417:                                    ERROR
<a name="15418"/>15418:                            end
<a name="15419"/>15419:                    end},
<a name="15420"/>15420:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="15421"/>15421:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15422"/>15422:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="15423"/>15423:                            ok
<a name="15424"/>15424:                    end},
<a name="15425"/>15425: 
<a name="15426"/>15426:          %% *** First message ***
<a name="15427"/>15427: 
<a name="15428"/>15428:          #{desc =&gt; &quot;await (recv) request 1&quot;,
<a name="15429"/>15429:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15430"/>15430:                            case Recv(Sock) of
<a name="15431"/>15431:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="15432"/>15432:                                    ok;
<a name="15433"/>15433:                                {error, _} = ERROR -&gt;
<a name="15434"/>15434:                                    ERROR
<a name="15435"/>15435:                            end
<a name="15436"/>15436:                    end},
<a name="15437"/>15437:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="15438"/>15438:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15439"/>15439:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="15440"/>15440:                            ok
<a name="15441"/>15441:                    end},
<a name="15442"/>15442:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="15443"/>15443:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15444"/>15444:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="15445"/>15445:                    end},
<a name="15446"/>15446:          #{desc =&gt; &quot;send reply&quot;,
<a name="15447"/>15447:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="15448"/>15448:                            Send(Sock, ?BASIC_REP)
<a name="15449"/>15449:                    end},
<a name="15450"/>15450:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="15451"/>15451:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15452"/>15452:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="15453"/>15453:                            ok
<a name="15454"/>15454:                    end},
<a name="15455"/>15455: 
<a name="15456"/>15456:          %% *** Second message ***
<a name="15457"/>15457: 
<a name="15458"/>15458:          #{desc =&gt; &quot;await (recv) request 2&quot;,
<a name="15459"/>15459:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15460"/>15460:                            case Recv(Sock) of
<a name="15461"/>15461:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="15462"/>15462:                                    ok;
<a name="15463"/>15463:                                {error, _} = ERROR -&gt;
<a name="15464"/>15464:                                    ERROR
<a name="15465"/>15465:                            end
<a name="15466"/>15466:                    end},
<a name="15467"/>15467:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="15468"/>15468:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15469"/>15469:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="15470"/>15470:                            ok
<a name="15471"/>15471:                    end},
<a name="15472"/>15472:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="15473"/>15473:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15474"/>15474:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="15475"/>15475:                    end},
<a name="15476"/>15476:          #{desc =&gt; &quot;send reply&quot;,
<a name="15477"/>15477:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="15478"/>15478:                            Send(Sock, ?BASIC_REP)
<a name="15479"/>15479:                    end},
<a name="15480"/>15480:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="15481"/>15481:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15482"/>15482:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="15483"/>15483:                            ok
<a name="15484"/>15484:                    end},
<a name="15485"/>15485: 
<a name="15486"/>15486:          %% *** Third message ***
<a name="15487"/>15487: 
<a name="15488"/>15488:          #{desc =&gt; &quot;await (recv) request 3&quot;,
<a name="15489"/>15489:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15490"/>15490:                            case Recv(Sock) of
<a name="15491"/>15491:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="15492"/>15492:                                    ok;
<a name="15493"/>15493:                                {error, _} = ERROR -&gt;
<a name="15494"/>15494:                                    ERROR
<a name="15495"/>15495:                            end
<a name="15496"/>15496:                    end},
<a name="15497"/>15497:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="15498"/>15498:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15499"/>15499:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="15500"/>15500:                            ok
<a name="15501"/>15501:                    end},
<a name="15502"/>15502:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="15503"/>15503:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15504"/>15504:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="15505"/>15505:                    end},
<a name="15506"/>15506:          #{desc =&gt; &quot;send reply&quot;,
<a name="15507"/>15507:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="15508"/>15508:                            Send(Sock, ?BASIC_REP)
<a name="15509"/>15509:                    end},
<a name="15510"/>15510:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="15511"/>15511:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15512"/>15512:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="15513"/>15513:                            ok
<a name="15514"/>15514:                    end},
<a name="15515"/>15515: 
<a name="15516"/>15516:          %% *** Termination ***
<a name="15517"/>15517:          #{desc =&gt; &quot;await terminate&quot;,
<a name="15518"/>15518:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="15519"/>15519:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="15520"/>15520:                                ok -&gt;
<a name="15521"/>15521:                                    {ok, maps:remove(tester, State)};
<a name="15522"/>15522:                                {error, _} = ERROR -&gt;
<a name="15523"/>15523:                                    ERROR
<a name="15524"/>15524:                            end
<a name="15525"/>15525:                    end},
<a name="15526"/>15526:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="15527"/>15527:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="15528"/>15528:                            ok = socket:close(Sock),
<a name="15529"/>15529:                            {ok, maps:remove(csock, State)}
<a name="15530"/>15530:                    end},
<a name="15531"/>15531:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="15532"/>15532:            cmd  =&gt; fun(#{domain   := local,
<a name="15533"/>15533:                          lsock    := Sock,
<a name="15534"/>15534:                          local_sa := #{path := Path}} = State) -&gt;
<a name="15535"/>15535:                            ok = socket:close(Sock),
<a name="15536"/>15536:                            State1 =
<a name="15537"/>15537:                                unlink_path(Path,
<a name="15538"/>15538:                                            fun() -&gt;
<a name="15539"/>15539:                                                    maps:remove(local_sa, State)
<a name="15540"/>15540:                                            end,
<a name="15541"/>15541:                                            fun() -&gt; State end),
<a name="15542"/>15542:                            {ok, maps:remove(lsock, State1)};
<a name="15543"/>15543:                       (#{lsock := LSock} = State) -&gt;
<a name="15544"/>15544:                            case socket:close(LSock) of
<a name="15545"/>15545:                                ok -&gt;
<a name="15546"/>15546:                                    {ok, maps:remove(lsock, State)};
<a name="15547"/>15547:                                {error, _} = ERROR -&gt;
<a name="15548"/>15548:                                    ERROR
<a name="15549"/>15549:                            end
<a name="15550"/>15550:                    end},
<a name="15551"/>15551: 
<a name="15552"/>15552:          %% *** We are done ***
<a name="15553"/>15553:          ?SEV_FINISH_NORMAL
<a name="15554"/>15554:         ],
<a name="15555"/>15555: 
<a name="15556"/>15556: 
<a name="15557"/>15557:     ClientSeq =
<a name="15558"/>15558:         [
<a name="15559"/>15559:          %% *** Wait for start order ***
<a name="15560"/>15560:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="15561"/>15561:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="15562"/>15562:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="15563"/>15563:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="15564"/>15564:                       (State) -&gt;
<a name="15565"/>15565:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="15566"/>15566:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="15567"/>15567:                    end},
<a name="15568"/>15568:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="15569"/>15569:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15570"/>15570:                            _MRef = erlang:monitor(process, Tester),
<a name="15571"/>15571:                            ok
<a name="15572"/>15572:                    end},
<a name="15573"/>15573: 
<a name="15574"/>15574:          %% *** The init part ***
<a name="15575"/>15575:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="15576"/>15576:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="15577"/>15577:                          server_path := Path} = State) -&gt;
<a name="15578"/>15578:                            LSA = which_local_socket_addr(Domain),
<a name="15579"/>15579:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="15580"/>15580:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="15581"/>15581:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="15582"/>15582:                            LSA = which_local_socket_addr(Domain),
<a name="15583"/>15583:                            SSA = LSA#{port =&gt; Port},
<a name="15584"/>15584:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="15585"/>15585:                    end},
<a name="15586"/>15586:          #{desc =&gt; &quot;create socket&quot;,
<a name="15587"/>15587:            cmd  =&gt; fun(#{domain := Domain,
<a name="15588"/>15588:                          proto  := Proto} = State) -&gt;
<a name="15589"/>15589:                            case socket:open(Domain, stream, Proto) of
<a name="15590"/>15590:                                {ok, Sock} -&gt;
<a name="15591"/>15591:                                    {ok, State#{sock =&gt; Sock}};
<a name="15592"/>15592:                                {error, _} = ERROR -&gt;
<a name="15593"/>15593:                                    ERROR
<a name="15594"/>15594:                            end
<a name="15595"/>15595:                    end},
<a name="15596"/>15596:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="15597"/>15597:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="15598"/>15598:                            case sock_bind(Sock, LSA) of
<a name="15599"/>15599:                                ok -&gt;
<a name="15600"/>15600:                                    ok;
<a name="15601"/>15601:                                {error, _} = ERROR -&gt;
<a name="15602"/>15602:                                    ERROR
<a name="15603"/>15603:                            end
<a name="15604"/>15604:                    end},
<a name="15605"/>15605:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="15606"/>15606:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15607"/>15607:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="15608"/>15608:                            ok
<a name="15609"/>15609:                    end},
<a name="15610"/>15610: 
<a name="15611"/>15611:          %% *** The actual test ***
<a name="15612"/>15612:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="15613"/>15613:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15614"/>15614:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="15615"/>15615:                    end},
<a name="15616"/>15616:          #{desc =&gt; &quot;connect to server&quot;,
<a name="15617"/>15617:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="15618"/>15618:                            socket:connect(Sock, SSA)
<a name="15619"/>15619:                    end},
<a name="15620"/>15620:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="15621"/>15621:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15622"/>15622:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="15623"/>15623:                            ok
<a name="15624"/>15624:                    end},
<a name="15625"/>15625: 
<a name="15626"/>15626:          %% *** First message (default=wo passcred) ***
<a name="15627"/>15627: 
<a name="15628"/>15628:          #{desc =&gt; &quot;await continue (verify timestamp off)&quot;,
<a name="15629"/>15629:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15630"/>15630:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_passcred)
<a name="15631"/>15631:                    end},
<a name="15632"/>15632:          #{desc =&gt; &quot;verify passcred off&quot;,
<a name="15633"/>15633:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="15634"/>15634:                            case Get(Sock) of
<a name="15635"/>15635:                                {ok, false = _Value} -&gt;
<a name="15636"/>15636:                                    ?SEV_IPRINT(&quot;passcred: ~p&quot;, [_Value]),
<a name="15637"/>15637:                                    ok;
<a name="15638"/>15638:                                {ok, Unexpected} -&gt;
<a name="15639"/>15639:                                    ?SEV_EPRINT(&quot;Unexpected passcred: ~p&quot;,
<a name="15640"/>15640:                                                [Unexpected]),
<a name="15641"/>15641:                                    {error, {unexpected_passcred, Unexpected}};
<a name="15642"/>15642:                                {error, Reason} = ERROR -&gt;
<a name="15643"/>15643:                                    ?SEV_EPRINT(&quot;Failed getting passcred:&quot;
<a name="15644"/>15644:                                                &quot;   ~p&quot;, [Reason]),
<a name="15645"/>15645:                                    ERROR
<a name="15646"/>15646:                            end                                   
<a name="15647"/>15647:                    end},
<a name="15648"/>15648:          #{desc =&gt; &quot;announce ready (passcred off)&quot;,
<a name="15649"/>15649:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15650"/>15650:                            ?SEV_ANNOUNCE_READY(Tester, passcred_off),
<a name="15651"/>15651:                            ok
<a name="15652"/>15652:                    end},
<a name="15653"/>15653: 
<a name="15654"/>15654:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="15655"/>15655:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15656"/>15656:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="15657"/>15657:                    end},
<a name="15658"/>15658:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="15659"/>15659:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15660"/>15660:                            Send(Sock, ?BASIC_REQ)
<a name="15661"/>15661:                    end},
<a name="15662"/>15662:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="15663"/>15663:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15664"/>15664:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="15665"/>15665:                            ok
<a name="15666"/>15666:                    end},
<a name="15667"/>15667:          #{desc =&gt; &quot;await recv reply 1 (from server, wo passcred)&quot;,
<a name="15668"/>15668:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="15669"/>15669:                            case Recv(Sock) of
<a name="15670"/>15670:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="15671"/>15671:                                    ok;
<a name="15672"/>15672:                                {ok, {[], UnexpData}} -&gt;
<a name="15673"/>15673:                                    {error, {unexpected_reply_data, UnexpData}};
<a name="15674"/>15674:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="15675"/>15675:                                    {error, {unexpected_reply_cmsgs,
<a name="15676"/>15676:                                             BadCMsgs}};
<a name="15677"/>15677:                                {ok, BadReply} -&gt;
<a name="15678"/>15678:                                    {error, {unexpected_reply, BadReply}};
<a name="15679"/>15679:                                {error, _} = ERROR -&gt;
<a name="15680"/>15680:                                    ERROR
<a name="15681"/>15681:                            end
<a name="15682"/>15682:                    end},
<a name="15683"/>15683:          #{desc =&gt; &quot;announce ready 1 (recv reply)&quot;,
<a name="15684"/>15684:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15685"/>15685:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="15686"/>15686:                            ok
<a name="15687"/>15687:                    end},
<a name="15688"/>15688: 
<a name="15689"/>15689:          %% *** Second message (w passcred) ***
<a name="15690"/>15690: 
<a name="15691"/>15691:          #{desc =&gt; &quot;await continue (enable passcred)&quot;,
<a name="15692"/>15692:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15693"/>15693:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_passcred)
<a name="15694"/>15694:                    end},
<a name="15695"/>15695:          #{desc =&gt; &quot;enable passcred&quot;,
<a name="15696"/>15696:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="15697"/>15697:                            case Set(Sock, true) of
<a name="15698"/>15698:                                ok -&gt;
<a name="15699"/>15699:                                    ?SEV_IPRINT(&quot;passcred enabled&quot;),
<a name="15700"/>15700:                                    ok;
<a name="15701"/>15701:                                {error, Reason} = ERROR -&gt;
<a name="15702"/>15702:                                    ?SEV_EPRINT(&quot;Failed enable passcred:&quot;
<a name="15703"/>15703:                                                &quot;   ~p&quot;, [Reason]),
<a name="15704"/>15704:                                    ERROR
<a name="15705"/>15705:                            end                                   
<a name="15706"/>15706:                    end},
<a name="15707"/>15707:          #{desc =&gt; &quot;announce ready (passcred on)&quot;,
<a name="15708"/>15708:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15709"/>15709:                            ?SEV_ANNOUNCE_READY(Tester, passcred_on),
<a name="15710"/>15710:                            ok
<a name="15711"/>15711:                    end},
<a name="15712"/>15712: 
<a name="15713"/>15713:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="15714"/>15714:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15715"/>15715:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="15716"/>15716:                    end},
<a name="15717"/>15717:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="15718"/>15718:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15719"/>15719:                            Send(Sock, ?BASIC_REQ)
<a name="15720"/>15720:                    end},
<a name="15721"/>15721:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="15722"/>15722:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15723"/>15723:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="15724"/>15724:                            ok
<a name="15725"/>15725:                    end},
<a name="15726"/>15726:          #{desc =&gt; &quot;await recv reply 2 (from server, w passcred)&quot;,
<a name="15727"/>15727:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="15728"/>15728:                            %% socket:setopt(Sock, otp, debug, true),
<a name="15729"/>15729:                            case Recv(Sock) of
<a name="15730"/>15730:                                {ok, {[#{level := socket,
<a name="15731"/>15731:                                         type  := passcred,
<a name="15732"/>15732:                                         value := Cred}], ?BASIC_REP}} -&gt;
<a name="15733"/>15733:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15734"/>15734:                                    ?SEV_IPRINT(&quot;received reply *with* &quot;
<a name="15735"/>15735:                                                &quot;expected passcred: &quot;
<a name="15736"/>15736:                                                &quot;~n   ~p&quot;, [Cred]),
<a name="15737"/>15737:                                    ok;
<a name="15738"/>15738:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="15739"/>15739:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15740"/>15740:                                    {error, {unexpected_reply_cmsgs,
<a name="15741"/>15741:                                             BadCMsgs}};
<a name="15742"/>15742:                                {ok, {[#{level := socket,
<a name="15743"/>15743:                                         type  := passcred,
<a name="15744"/>15744:                                         value := _Cred}], BadData}} -&gt;
<a name="15745"/>15745:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15746"/>15746:                                    {error, {unexpected_reply_data,
<a name="15747"/>15747:                                             BadData}};
<a name="15748"/>15748:                                {ok, BadReply} -&gt;
<a name="15749"/>15749:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15750"/>15750:                                    {error, {unexpected_reply, BadReply}};
<a name="15751"/>15751:                                {error, _} = ERROR -&gt;
<a name="15752"/>15752:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15753"/>15753:                                    ERROR
<a name="15754"/>15754:                            end
<a name="15755"/>15755:                    end},
<a name="15756"/>15756:          #{desc =&gt; &quot;announce ready 2 (recv reply)&quot;,
<a name="15757"/>15757:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15758"/>15758:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="15759"/>15759:                            ok
<a name="15760"/>15760:                    end},
<a name="15761"/>15761: 
<a name="15762"/>15762:          %% *** Third message (wo passcred) ***
<a name="15763"/>15763: 
<a name="15764"/>15764:          #{desc =&gt; &quot;await continue (disable passcred)&quot;,
<a name="15765"/>15765:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15766"/>15766:                            ?SEV_AWAIT_CONTINUE(Tester, tester, disable_passcred)
<a name="15767"/>15767:                    end},
<a name="15768"/>15768:          #{desc =&gt; &quot;disable passcred&quot;,
<a name="15769"/>15769:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="15770"/>15770:                            case Set(Sock, false) of
<a name="15771"/>15771:                                ok -&gt;
<a name="15772"/>15772:                                    ?SEV_IPRINT(&quot;passcred disabled&quot;),
<a name="15773"/>15773:                                    ok;
<a name="15774"/>15774:                                {error, Reason} = ERROR -&gt;
<a name="15775"/>15775:                                    ?SEV_EPRINT(&quot;Failed disable timestamp:&quot;
<a name="15776"/>15776:                                                &quot;   ~p&quot;, [Reason]),
<a name="15777"/>15777:                                    ERROR
<a name="15778"/>15778:                            end                                   
<a name="15779"/>15779:                    end},
<a name="15780"/>15780:          #{desc =&gt; &quot;announce ready (passcred off)&quot;,
<a name="15781"/>15781:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15782"/>15782:                            ?SEV_ANNOUNCE_READY(Tester, passcred_off),
<a name="15783"/>15783:                            ok
<a name="15784"/>15784:                    end},
<a name="15785"/>15785: 
<a name="15786"/>15786:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="15787"/>15787:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15788"/>15788:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="15789"/>15789:                    end},
<a name="15790"/>15790:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="15791"/>15791:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15792"/>15792:                            Send(Sock, ?BASIC_REQ)
<a name="15793"/>15793:                    end},
<a name="15794"/>15794:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="15795"/>15795:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15796"/>15796:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="15797"/>15797:                            ok
<a name="15798"/>15798:                    end},
<a name="15799"/>15799:          #{desc =&gt; &quot;await recv reply 3 (from server, wo passcred)&quot;,
<a name="15800"/>15800:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="15801"/>15801:                            case Recv(Sock) of
<a name="15802"/>15802:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="15803"/>15803:                                    ?SEV_IPRINT(&quot;received reply *without* &quot;
<a name="15804"/>15804:                                                &quot;passcred&quot;),
<a name="15805"/>15805:                                    ok;
<a name="15806"/>15806:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="15807"/>15807:                                    {error, {unexpected_reply_cmsgs,
<a name="15808"/>15808:                                             BadCMsgs}};
<a name="15809"/>15809:                                {ok, {[], BadData}} -&gt;
<a name="15810"/>15810:                                    {error, {unexpected_reply_data,
<a name="15811"/>15811:                                             BadData}};
<a name="15812"/>15812:                                {ok, BadReply} -&gt;
<a name="15813"/>15813:                                    {error, {unexpected_reply, BadReply}};
<a name="15814"/>15814:                                {error, _} = ERROR -&gt;
<a name="15815"/>15815:                                    ERROR
<a name="15816"/>15816:                            end
<a name="15817"/>15817:                    end},
<a name="15818"/>15818:          #{desc =&gt; &quot;announce ready 3 (recv reply)&quot;,
<a name="15819"/>15819:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15820"/>15820:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="15821"/>15821:                            ok
<a name="15822"/>15822:                    end},
<a name="15823"/>15823: 
<a name="15824"/>15824:          %% *** Termination ***
<a name="15825"/>15825:          #{desc =&gt; &quot;await terminate&quot;,
<a name="15826"/>15826:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="15827"/>15827:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="15828"/>15828:                                ok -&gt;
<a name="15829"/>15829:                                    {ok, maps:remove(tester, State)};
<a name="15830"/>15830:                                {error, _} = ERROR -&gt;
<a name="15831"/>15831:                                    ERROR
<a name="15832"/>15832:                            end
<a name="15833"/>15833:                    end},
<a name="15834"/>15834:          #{desc =&gt; &quot;close socket&quot;,
<a name="15835"/>15835:            cmd  =&gt; fun(#{domain   := local,
<a name="15836"/>15836:                          sock     := Sock,
<a name="15837"/>15837:                          local_sa := #{path := Path}} = State) -&gt;
<a name="15838"/>15838:                            ok = socket:close(Sock),
<a name="15839"/>15839:                            State1 =
<a name="15840"/>15840:                                unlink_path(Path,
<a name="15841"/>15841:                                            fun() -&gt;
<a name="15842"/>15842:                                                    maps:remove(local_sa, State)
<a name="15843"/>15843:                                            end,
<a name="15844"/>15844:                                            fun() -&gt; State end),
<a name="15845"/>15845:                            {ok, maps:remove(sock, State1)};
<a name="15846"/>15846:                       (#{sock := Sock} = State) -&gt;
<a name="15847"/>15847:                            ok = socket:close(Sock),
<a name="15848"/>15848:                            {ok, maps:remove(sock, State)}
<a name="15849"/>15849:                    end},
<a name="15850"/>15850: 
<a name="15851"/>15851:          %% *** We are done ***
<a name="15852"/>15852:          ?SEV_FINISH_NORMAL
<a name="15853"/>15853:         ],
<a name="15854"/>15854: 
<a name="15855"/>15855: 
<a name="15856"/>15856:     TesterSeq =
<a name="15857"/>15857:         [
<a name="15858"/>15858:          %% *** Init part ***
<a name="15859"/>15859:          #{desc =&gt; &quot;monitor server&quot;,
<a name="15860"/>15860:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="15861"/>15861:                            _MRef = erlang:monitor(process, Pid),
<a name="15862"/>15862:                            ok
<a name="15863"/>15863:                    end},
<a name="15864"/>15864:          #{desc =&gt; &quot;monitor client&quot;,
<a name="15865"/>15865:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="15866"/>15866:                            _MRef = erlang:monitor(process, Pid),
<a name="15867"/>15867:                            ok
<a name="15868"/>15868:                    end},
<a name="15869"/>15869: 
<a name="15870"/>15870:          %% Start the server
<a name="15871"/>15871:          #{desc =&gt; &quot;order server start&quot;,
<a name="15872"/>15872:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="15873"/>15873:                            ?SEV_ANNOUNCE_START(Pid),
<a name="15874"/>15874:                            ok
<a name="15875"/>15875:                    end},
<a name="15876"/>15876:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="15877"/>15877:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="15878"/>15878:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="15879"/>15879:                            {ok, State#{server_port =&gt; Port}}
<a name="15880"/>15880:                    end},
<a name="15881"/>15881: 
<a name="15882"/>15882:          %% Start the client
<a name="15883"/>15883:          #{desc =&gt; &quot;order client start&quot;,
<a name="15884"/>15884:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="15885"/>15885:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="15886"/>15886:                            ok
<a name="15887"/>15887:                    end},
<a name="15888"/>15888:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="15889"/>15889:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="15890"/>15890:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="15891"/>15891:                    end},
<a name="15892"/>15892: 
<a name="15893"/>15893:          %% *** The actual test ***
<a name="15894"/>15894:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="15895"/>15895:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15896"/>15896:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="15897"/>15897:                            ok
<a name="15898"/>15898:                    end},
<a name="15899"/>15899:          ?SEV_SLEEP(?SECS(1)),
<a name="15900"/>15900:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="15901"/>15901:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15902"/>15902:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="15903"/>15903:                            ok
<a name="15904"/>15904:                    end},
<a name="15905"/>15905:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="15906"/>15906:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15907"/>15907:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="15908"/>15908:                    end},
<a name="15909"/>15909:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="15910"/>15910:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15911"/>15911:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="15912"/>15912:                    end},
<a name="15913"/>15913: 
<a name="15914"/>15914:          %% *** First message (default=wo passcred) ***
<a name="15915"/>15915: 
<a name="15916"/>15916:          #{desc =&gt; &quot;order client to continue (with verify timestamp off)&quot;,
<a name="15917"/>15917:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15918"/>15918:                            ?SEV_ANNOUNCE_CONTINUE(Client, verify_passcred),
<a name="15919"/>15919:                            ok
<a name="15920"/>15920:                    end},
<a name="15921"/>15921:          #{desc =&gt; &quot;await client ready (passcred off)&quot;,
<a name="15922"/>15922:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15923"/>15923:                            ?SEV_AWAIT_READY(Client, client, passcred_off)
<a name="15924"/>15924:                    end},
<a name="15925"/>15925: 
<a name="15926"/>15926:          #{desc =&gt; &quot;order client to continue (with send request 1)&quot;,
<a name="15927"/>15927:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15928"/>15928:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="15929"/>15929:                            ok
<a name="15930"/>15930:                    end},
<a name="15931"/>15931:          #{desc =&gt; &quot;await client ready (with send request 1)&quot;,
<a name="15932"/>15932:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15933"/>15933:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="15934"/>15934:                    end},
<a name="15935"/>15935:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="15936"/>15936:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15937"/>15937:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="15938"/>15938:                    end},
<a name="15939"/>15939:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="15940"/>15940:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15941"/>15941:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="15942"/>15942:                            ok
<a name="15943"/>15943:                    end},
<a name="15944"/>15944:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="15945"/>15945:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15946"/>15946:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="15947"/>15947:                    end},
<a name="15948"/>15948:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="15949"/>15949:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15950"/>15950:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="15951"/>15951:                    end},
<a name="15952"/>15952: 
<a name="15953"/>15953:          %% Second message (w passcred)
<a name="15954"/>15954: 
<a name="15955"/>15955:          #{desc =&gt; &quot;order client to continue (with enable passcred)&quot;,
<a name="15956"/>15956:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15957"/>15957:                            ?SEV_ANNOUNCE_CONTINUE(Client, enable_passcred),
<a name="15958"/>15958:                            ok
<a name="15959"/>15959:                    end},
<a name="15960"/>15960:          #{desc =&gt; &quot;await client ready (passcred on)&quot;,
<a name="15961"/>15961:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15962"/>15962:                            ?SEV_AWAIT_READY(Client, client, passcred_on)
<a name="15963"/>15963:                    end},
<a name="15964"/>15964: 
<a name="15965"/>15965:          #{desc =&gt; &quot;order client to continue (with send request 2)&quot;,
<a name="15966"/>15966:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15967"/>15967:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="15968"/>15968:                            ok
<a name="15969"/>15969:                    end},
<a name="15970"/>15970:          #{desc =&gt; &quot;await client ready (with send request 2)&quot;,
<a name="15971"/>15971:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15972"/>15972:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="15973"/>15973:                    end},
<a name="15974"/>15974:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="15975"/>15975:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15976"/>15976:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="15977"/>15977:                    end},
<a name="15978"/>15978:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="15979"/>15979:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15980"/>15980:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="15981"/>15981:                            ok
<a name="15982"/>15982:                    end},
<a name="15983"/>15983:          #{desc =&gt; &quot;await server ready (with reply sent 2)&quot;,
<a name="15984"/>15984:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15985"/>15985:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="15986"/>15986:                    end},
<a name="15987"/>15987:          #{desc =&gt; &quot;await client ready (reply recv 2)&quot;,
<a name="15988"/>15988:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15989"/>15989:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="15990"/>15990:                    end},
<a name="15991"/>15991: 
<a name="15992"/>15992:          %% Third message (wo passcred)
<a name="15993"/>15993: 
<a name="15994"/>15994:          #{desc =&gt; &quot;order client to continue (with disable passcred)&quot;,
<a name="15995"/>15995:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15996"/>15996:                            ?SEV_ANNOUNCE_CONTINUE(Client, disable_passcred),
<a name="15997"/>15997:                            ok
<a name="15998"/>15998:                    end},
<a name="15999"/>15999:          #{desc =&gt; &quot;await client ready (passcred off)&quot;,
<a name="16000"/>16000:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16001"/>16001:                            ?SEV_AWAIT_READY(Client, client, passcred_off)
<a name="16002"/>16002:                    end},
<a name="16003"/>16003: 
<a name="16004"/>16004:          #{desc =&gt; &quot;order client to continue (with send request 3)&quot;,
<a name="16005"/>16005:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16006"/>16006:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="16007"/>16007:                            ok
<a name="16008"/>16008:                    end},
<a name="16009"/>16009:          #{desc =&gt; &quot;await client ready (with send request 3)&quot;,
<a name="16010"/>16010:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16011"/>16011:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="16012"/>16012:                    end},
<a name="16013"/>16013:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="16014"/>16014:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16015"/>16015:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="16016"/>16016:                    end},
<a name="16017"/>16017:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="16018"/>16018:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16019"/>16019:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="16020"/>16020:                            ok
<a name="16021"/>16021:                    end},
<a name="16022"/>16022:          #{desc =&gt; &quot;await server ready (with reply sent 3)&quot;,
<a name="16023"/>16023:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16024"/>16024:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="16025"/>16025:                    end},
<a name="16026"/>16026:          #{desc =&gt; &quot;await client ready (reply recv 3)&quot;,
<a name="16027"/>16027:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16028"/>16028:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="16029"/>16029:                    end},
<a name="16030"/>16030: 
<a name="16031"/>16031: 
<a name="16032"/>16032:          %% *** Termination ***
<a name="16033"/>16033:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="16034"/>16034:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16035"/>16035:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="16036"/>16036:                            ok
<a name="16037"/>16037:                    end},
<a name="16038"/>16038:          #{desc =&gt; &quot;await client termination&quot;,
<a name="16039"/>16039:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="16040"/>16040:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="16041"/>16041:                            State1 = maps:remove(client, State),
<a name="16042"/>16042:                            {ok, State1}
<a name="16043"/>16043:                    end},
<a name="16044"/>16044:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="16045"/>16045:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16046"/>16046:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="16047"/>16047:                            ok
<a name="16048"/>16048:                    end},
<a name="16049"/>16049:          #{desc =&gt; &quot;await server termination&quot;,
<a name="16050"/>16050:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="16051"/>16051:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="16052"/>16052:                            State1 = maps:remove(server, State),
<a name="16053"/>16053:                            {ok, State1}
<a name="16054"/>16054:                    end},
<a name="16055"/>16055: 
<a name="16056"/>16056:          %% *** We are done ***
<a name="16057"/>16057:          ?SEV_FINISH_NORMAL
<a name="16058"/>16058:         ],
<a name="16059"/>16059: 
<a name="16060"/>16060: 
<a name="16061"/>16061:     i(&quot;start server evaluator&quot;),
<a name="16062"/>16062:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="16063"/>16063: 
<a name="16064"/>16064:     i(&quot;start client evaluator&quot;),
<a name="16065"/>16065:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="16066"/>16066: 
<a name="16067"/>16067:     i(&quot;start tester evaluator&quot;),
<a name="16068"/>16068:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="16069"/>16069:                         client =&gt; Client#ev.pid},
<a name="16070"/>16070:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="16071"/>16071: 
<a name="api_opt_sock_passcred_tcp-last_expr"/><a name="16072"/>16072: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="16073"/>16073: 
<a name="16074"/>16074: 
<a name="16075"/>16075: 
<a name="16076"/>16076: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="16077"/>16077: 
<a name="16078"/>16078: <i>%% Tests the the peek-off socket option for a unix domain socket</i>
<a name="16079"/>16079: <i>%% (stream TCP in this case).</i>
<a name="16080"/>16080: <i>%%</i>
<a name="16081"/>16081: <i>%% THIS IS A PLACEHOLDER!!</i>
<a name="16082"/>16082: <i>%%</i>
<a name="16083"/>16083: <i>%%</i>
<a name="16084"/>16084: 
<a name="api_opt_sock_peek_off_tcpL-1"/><a name="16085"/>16085: <b>api_opt_sock_peek_off_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="16086"/>16086:     ?TT(?SECS(5)),
<a name="api_opt_sock_peek_off_tcpL-last_expr"/><a name="16087"/>16087: <b>    tc_try</b>(api_opt_sock_peek_off_tcpL,
<a name="16088"/>16088:            fun() -&gt;
<a name="16089"/>16089:                    has_support_unix_domain_socket(),
<a name="16090"/>16090:                    has_support_sock_peek_off(),
<a name="16091"/>16091:                    has_support_msg_flag(peek)
<a name="16092"/>16092:            end,
<a name="16093"/>16093:            fun() -&gt;
<a name="16094"/>16094:                    Set  = fun(Sock, Val) when is_integer(Val) -&gt;
<a name="16095"/>16095:                                   socket:setopt(Sock, socket, peek_off, Val)
<a name="16096"/>16096:                           end,
<a name="16097"/>16097:                    Get  = fun(Sock) -&gt;
<a name="16098"/>16098:                                   socket:getopt(Sock, socket, peek_off)
<a name="16099"/>16099:                           end,
<a name="16100"/>16100:                    Send = fun(Sock, Data) -&gt;
<a name="16101"/>16101:                                   socket:send(Sock, Data)
<a name="16102"/>16102:                           end,
<a name="16103"/>16103:                    Recv = fun(Sock, L, false) -&gt;
<a name="16104"/>16104:                                   socket:recv(Sock, L);
<a name="16105"/>16105:                              (Sock, L, true) -&gt;
<a name="16106"/>16106:                                   socket:recv(Sock, L, [peek])
<a name="16107"/>16107:                           end,
<a name="16108"/>16108:                    InitState = #{domain =&gt; local,
<a name="16109"/>16109:                                  proto  =&gt; default, % Type = stream =&gt; tcp
<a name="16110"/>16110:                                  set    =&gt; Set,
<a name="16111"/>16111:                                  get    =&gt; Get,
<a name="16112"/>16112:                                  send   =&gt; Send,
<a name="16113"/>16113:                                  recv   =&gt; Recv},
<a name="16114"/>16114:                    ok = api_opt_sock_peek_off(InitState)
<a name="16115"/>16115:            end).
<a name="16116"/>16116: 
<a name="api_opt_sock_peek_off-1"/><a name="16117"/>16117: <b>api_opt_sock_peek_off</b>(InitState) -&gt;
<a name="16118"/>16118:     process_flag(trap_exit, true),
<a name="16119"/>16119:     ServerSeq = 
<a name="16120"/>16120:         [
<a name="16121"/>16121:          %% *** Wait for start order ***
<a name="16122"/>16122:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="16123"/>16123:            cmd  =&gt; fun(State) -&gt;
<a name="16124"/>16124:                            Tester = ?SEV_AWAIT_START(),
<a name="16125"/>16125:                            {ok, State#{tester =&gt; Tester}}
<a name="16126"/>16126:                    end},
<a name="16127"/>16127:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="16128"/>16128:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16129"/>16129:                            _MRef = erlang:monitor(process, Tester),
<a name="16130"/>16130:                            ok
<a name="16131"/>16131:                    end},
<a name="16132"/>16132: 
<a name="16133"/>16133:          %% *** Init part ***
<a name="16134"/>16134:          #{desc =&gt; &quot;which local address&quot;,
<a name="16135"/>16135:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="16136"/>16136:                            LSA = which_local_socket_addr(Domain),
<a name="16137"/>16137:                            {ok, State#{lsa =&gt; LSA}}
<a name="16138"/>16138:                    end},
<a name="16139"/>16139:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="16140"/>16140:            cmd  =&gt; fun(#{domain := Domain,
<a name="16141"/>16141:                          proto  := Proto} = State) -&gt;
<a name="16142"/>16142:                            case socket:open(Domain, stream, Proto) of
<a name="16143"/>16143:                                {ok, Sock} -&gt;
<a name="16144"/>16144:                                    {ok, State#{lsock =&gt; Sock}};
<a name="16145"/>16145:                                {error, _} = ERROR -&gt;
<a name="16146"/>16146:                                    ERROR
<a name="16147"/>16147:                            end
<a name="16148"/>16148:                    end},
<a name="16149"/>16149:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="16150"/>16150:            cmd  =&gt; fun(#{lsock := LSock,
<a name="16151"/>16151:                          lsa   := LSA} = _State) -&gt;
<a name="16152"/>16152:                            case sock_bind(LSock, LSA) of
<a name="16153"/>16153:                                ok -&gt;
<a name="16154"/>16154:                                    %% We do not care about the port for local
<a name="16155"/>16155:                                    ok;
<a name="16156"/>16156:                                {error, _} = ERROR -&gt;
<a name="16157"/>16157:                                    ERROR
<a name="16158"/>16158:                            end
<a name="16159"/>16159:                    end},
<a name="16160"/>16160:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="16161"/>16161:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="16162"/>16162:                            socket:listen(LSock)
<a name="16163"/>16163:                    end},
<a name="16164"/>16164:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="16165"/>16165:            cmd  =&gt; fun(#{tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="16166"/>16166:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="16167"/>16167:                            ok
<a name="16168"/>16168:                    end},
<a name="16169"/>16169: 
<a name="16170"/>16170:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="16171"/>16171:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16172"/>16172:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="16173"/>16173:                    end},
<a name="16174"/>16174:          #{desc =&gt; &quot;await connection&quot;,
<a name="16175"/>16175:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="16176"/>16176:                            case socket:accept(LSock) of
<a name="16177"/>16177:                                {ok, Sock} -&gt;
<a name="16178"/>16178:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="16179"/>16179:                                    {ok, State#{csock =&gt; Sock}};
<a name="16180"/>16180:                                {error, _} = ERROR -&gt;
<a name="16181"/>16181:                                    ERROR
<a name="16182"/>16182:                            end
<a name="16183"/>16183:                    end},
<a name="16184"/>16184:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="16185"/>16185:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16186"/>16186:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="16187"/>16187:                            ok
<a name="16188"/>16188:                    end},
<a name="16189"/>16189: 
<a name="16190"/>16190: 
<a name="16191"/>16191:          %% The actual test
<a name="16192"/>16192: 
<a name="16193"/>16193:          %% 1) peek (0 = everything: 1,2,3,4,5,6,7,8)
<a name="16194"/>16194:          #{desc =&gt; &quot;1a: await continue (peek)&quot;,
<a name="16195"/>16195:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16196"/>16196:                            ?SEV_AWAIT_CONTINUE(Tester, tester, peek)
<a name="16197"/>16197:                    end},
<a name="16198"/>16198:          #{desc =&gt; &quot;1a: peek read&quot;,
<a name="16199"/>16199:            cmd  =&gt; fun(#{csock := Sock,
<a name="16200"/>16200:                          recv  := Recv} = _State) -&gt;
<a name="16201"/>16201:                            case Recv(Sock, 0, true) of
<a name="16202"/>16202:                                {ok, &lt;&lt;1,2,3,4,5,6,7,8&gt;&gt;} -&gt;
<a name="16203"/>16203:                                    ?SEV_IPRINT(&quot;peek'ed expected data&quot;),
<a name="16204"/>16204:                                    ok;
<a name="16205"/>16205:                                {error, _} = ERROR -&gt;
<a name="16206"/>16206:                                    ERROR
<a name="16207"/>16207:                            end
<a name="16208"/>16208:                    end},
<a name="16209"/>16209:          #{desc =&gt; &quot;1a: announce ready (peek)&quot;,
<a name="16210"/>16210:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16211"/>16211:                            ?SEV_ANNOUNCE_READY(Tester, peek),
<a name="16212"/>16212:                            ok
<a name="16213"/>16213:                    end},
<a name="16214"/>16214: 
<a name="16215"/>16215:          #{desc =&gt; &quot;1b: await continue (verify peek-off)&quot;,
<a name="16216"/>16216:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16217"/>16217:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16218"/>16218:                    end},
<a name="16219"/>16219:          #{desc =&gt; &quot;1b: verify peek-off&quot;,
<a name="16220"/>16220:            cmd  =&gt; fun(#{csock := Sock,
<a name="16221"/>16221:                          get   := Get} = _State) -&gt;
<a name="16222"/>16222:                            case Get(Sock) of
<a name="16223"/>16223:                                {ok, DefaultPeekOff} -&gt;
<a name="16224"/>16224:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;,
<a name="16225"/>16225:                                                [DefaultPeekOff]),
<a name="16226"/>16226:                                    ok;
<a name="16227"/>16227:                                {error, {not_supported, {socket, peek_off}}} -&gt;
<a name="16228"/>16228:                                    {skip, &quot;Not supported&quot;};
<a name="16229"/>16229:                                {error, _} = ERROR -&gt;
<a name="16230"/>16230:                                    ERROR
<a name="16231"/>16231:                            end
<a name="16232"/>16232:                    end},
<a name="16233"/>16233:          #{desc =&gt; &quot;1b: announce ready (verify peek-off)&quot;,
<a name="16234"/>16234:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16235"/>16235:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16236"/>16236:                            ok
<a name="16237"/>16237:                    end},
<a name="16238"/>16238: 
<a name="16239"/>16239: 
<a name="16240"/>16240:          %% 2) set peek-off to 4
<a name="16241"/>16241:          #{desc =&gt; &quot;2a: await continue (set peek-off: 4)&quot;,
<a name="16242"/>16242:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16243"/>16243:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_peek_off)
<a name="16244"/>16244:                    end},
<a name="16245"/>16245:          #{desc =&gt; &quot;2a: set peek-off: 4&quot;,
<a name="16246"/>16246:            cmd  =&gt; fun(#{csock := Sock,
<a name="16247"/>16247:                          set   := Set} = _State) -&gt;
<a name="16248"/>16248:                            case Set(Sock, 4) of
<a name="16249"/>16249:                                ok -&gt;
<a name="16250"/>16250:                                    ok;
<a name="16251"/>16251:                                {error, _} = ERROR -&gt;
<a name="16252"/>16252:                                    ERROR
<a name="16253"/>16253:                            end
<a name="16254"/>16254:                    end},
<a name="16255"/>16255:          #{desc =&gt; &quot;2a: announce ready (set peek-off: 4)&quot;,
<a name="16256"/>16256:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16257"/>16257:                            ?SEV_ANNOUNCE_READY(Tester, set_peek_off),
<a name="16258"/>16258:                            ok
<a name="16259"/>16259:                    end},
<a name="16260"/>16260: 
<a name="16261"/>16261:          #{desc =&gt; &quot;2b: await continue (verify peek-off)&quot;,
<a name="16262"/>16262:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16263"/>16263:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16264"/>16264:                    end},
<a name="16265"/>16265:          #{desc =&gt; &quot;2b: verify peek-off&quot;,
<a name="16266"/>16266:            cmd  =&gt; fun(#{csock := Sock,
<a name="16267"/>16267:                          get   := Get} = _State) -&gt;
<a name="16268"/>16268:                            case Get(Sock) of
<a name="16269"/>16269:                                {ok, 4 = PeekOff} -&gt;
<a name="16270"/>16270:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="16271"/>16271:                                    ok;
<a name="16272"/>16272:                                {error, _} = ERROR -&gt;
<a name="16273"/>16273:                                    ERROR
<a name="16274"/>16274:                            end
<a name="16275"/>16275:                    end},
<a name="16276"/>16276:          #{desc =&gt; &quot;2b: announce ready (verify peek-off)&quot;,
<a name="16277"/>16277:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16278"/>16278:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16279"/>16279:                            ok
<a name="16280"/>16280:                    end},
<a name="16281"/>16281: 
<a name="16282"/>16282: 
<a name="16283"/>16283:          %% 3) peek (0 = everything: 5,6,7,8)
<a name="16284"/>16284:          %%    NOTE THAT THIS WILL MOVE THE PEEK-OFF &quot;POINTER&quot; TO THE END OF 
<a name="16285"/>16285:          %%    THE *CURRENT* DATA POSITION IN THE BUFFER (READY FOR NEXT BATCH
<a name="16286"/>16286:          %%    OF DATA).
<a name="16287"/>16287:          #{desc =&gt; &quot;3a: await continue (peek)&quot;,
<a name="16288"/>16288:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16289"/>16289:                            ?SEV_AWAIT_CONTINUE(Tester, tester, peek)
<a name="16290"/>16290:                    end},
<a name="16291"/>16291:          #{desc =&gt; &quot;3a: peek read&quot;,
<a name="16292"/>16292:            cmd  =&gt; fun(#{csock := Sock,
<a name="16293"/>16293:                          recv  := Recv} = _State) -&gt;
<a name="16294"/>16294:                            case Recv(Sock, 0, true) of
<a name="16295"/>16295:                                {ok, &lt;&lt;5,6,7,8&gt;&gt;} -&gt;
<a name="16296"/>16296:                                    ?SEV_IPRINT(&quot;peek'ed expected data&quot;),
<a name="16297"/>16297:                                    ok;
<a name="16298"/>16298:                                {error, _} = ERROR -&gt;
<a name="16299"/>16299:                                    ERROR
<a name="16300"/>16300:                            end
<a name="16301"/>16301:                    end},
<a name="16302"/>16302:          #{desc =&gt; &quot;3a: announce ready (peek)&quot;,
<a name="16303"/>16303:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16304"/>16304:                            ?SEV_ANNOUNCE_READY(Tester, peek),
<a name="16305"/>16305:                            ok
<a name="16306"/>16306:                    end},
<a name="16307"/>16307: 
<a name="16308"/>16308:          #{desc =&gt; &quot;3b: await continue (verify peek-off)&quot;,
<a name="16309"/>16309:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16310"/>16310:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16311"/>16311:                    end},
<a name="16312"/>16312:          #{desc =&gt; &quot;3b: verify peek-off&quot;,
<a name="16313"/>16313:            cmd  =&gt; fun(#{csock := Sock,
<a name="16314"/>16314:                          get   := Get} = _State) -&gt;
<a name="16315"/>16315:                            case Get(Sock) of
<a name="16316"/>16316:                                {ok, 8 = PeekOff} -&gt;
<a name="16317"/>16317:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="16318"/>16318:                                    ok;
<a name="16319"/>16319:                                {error, _} = ERROR -&gt;
<a name="16320"/>16320:                                    ERROR
<a name="16321"/>16321:                            end
<a name="16322"/>16322:                    end},
<a name="16323"/>16323:          #{desc =&gt; &quot;3b: announce ready (verify peek-off)&quot;,
<a name="16324"/>16324:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16325"/>16325:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16326"/>16326:                            ok
<a name="16327"/>16327:                    end},
<a name="16328"/>16328: 
<a name="16329"/>16329: 
<a name="16330"/>16330:          %% 4) read two byte(s): 1,2
<a name="16331"/>16331:          #{desc =&gt; &quot;4a: await continue (read 2 byte)&quot;,
<a name="16332"/>16332:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16333"/>16333:                            ?SEV_AWAIT_CONTINUE(Tester, tester, read)
<a name="16334"/>16334:                    end},
<a name="16335"/>16335:          #{desc =&gt; &quot;4a: read (2 bytes)&quot;,
<a name="16336"/>16336:            cmd  =&gt; fun(#{csock := Sock,
<a name="16337"/>16337:                          recv  := Recv} = _State) -&gt;
<a name="16338"/>16338:                            case Recv(Sock, 2, false) of
<a name="16339"/>16339:                                {ok, &lt;&lt;1,2&gt;&gt;} -&gt;
<a name="16340"/>16340:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="16341"/>16341:                                    ok;
<a name="16342"/>16342:                                {error, _} = ERROR -&gt;
<a name="16343"/>16343:                                    ERROR
<a name="16344"/>16344:                            end
<a name="16345"/>16345:                    end},
<a name="16346"/>16346:          #{desc =&gt; &quot;4a: announce ready (read)&quot;,
<a name="16347"/>16347:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16348"/>16348:                            ?SEV_ANNOUNCE_READY(Tester, read),
<a name="16349"/>16349:                            ok
<a name="16350"/>16350:                    end},
<a name="16351"/>16351: 
<a name="16352"/>16352:          #{desc =&gt; &quot;4b: await continue (verify peek-off)&quot;,
<a name="16353"/>16353:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16354"/>16354:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16355"/>16355:                    end},
<a name="16356"/>16356:          #{desc =&gt; &quot;4b: verify peek-off&quot;,
<a name="16357"/>16357:            cmd  =&gt; fun(#{csock := Sock,
<a name="16358"/>16358:                          get   := Get} = _State) -&gt;
<a name="16359"/>16359:                            case Get(Sock) of
<a name="16360"/>16360:                                {ok, 6 = PeekOff} -&gt;
<a name="16361"/>16361:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="16362"/>16362:                                    ok;
<a name="16363"/>16363:                                {error, _} = ERROR -&gt;
<a name="16364"/>16364:                                    ERROR
<a name="16365"/>16365:                            end
<a name="16366"/>16366:                    end},
<a name="16367"/>16367:          #{desc =&gt; &quot;4b: announce ready (verify peek-off)&quot;,
<a name="16368"/>16368:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16369"/>16369:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16370"/>16370:                            ok
<a name="16371"/>16371:                    end},
<a name="16372"/>16372: 
<a name="16373"/>16373: 
<a name="16374"/>16374:          %% 5) read the rest: 3,4,5,6,7,8)
<a name="16375"/>16375:          #{desc =&gt; &quot;5a: await continue (read the rest)&quot;,
<a name="16376"/>16376:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16377"/>16377:                            ?SEV_AWAIT_CONTINUE(Tester, tester, read)
<a name="16378"/>16378:                    end},
<a name="16379"/>16379:          #{desc =&gt; &quot;5a: read (the rest)&quot;,
<a name="16380"/>16380:            cmd  =&gt; fun(#{csock := Sock,
<a name="16381"/>16381:                          recv  := Recv} = _State) -&gt;
<a name="16382"/>16382:                            case Recv(Sock, 0, false) of
<a name="16383"/>16383:                                {ok, &lt;&lt;3,4,5,6,7,8&gt;&gt;} -&gt;
<a name="16384"/>16384:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="16385"/>16385:                                    ok;
<a name="16386"/>16386:                                {error, _} = ERROR -&gt;
<a name="16387"/>16387:                                    ERROR
<a name="16388"/>16388:                            end
<a name="16389"/>16389:                    end},
<a name="16390"/>16390:          #{desc =&gt; &quot;5a: announce ready (read)&quot;,
<a name="16391"/>16391:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16392"/>16392:                            ?SEV_ANNOUNCE_READY(Tester, read),
<a name="16393"/>16393:                            ok
<a name="16394"/>16394:                    end},
<a name="16395"/>16395: 
<a name="16396"/>16396:          #{desc =&gt; &quot;5b: await continue (verify peek-off)&quot;,
<a name="16397"/>16397:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16398"/>16398:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16399"/>16399:                    end},
<a name="16400"/>16400:          #{desc =&gt; &quot;5b: verify peek-off&quot;,
<a name="16401"/>16401:            cmd  =&gt; fun(#{csock := Sock,
<a name="16402"/>16402:                          get   := Get} = _State) -&gt;
<a name="16403"/>16403:                            case Get(Sock) of
<a name="16404"/>16404:                                {ok, PeekOff} -&gt;
<a name="16405"/>16405:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="16406"/>16406:                                    ok;
<a name="16407"/>16407:                                {error, _} = ERROR -&gt;
<a name="16408"/>16408:                                    ERROR
<a name="16409"/>16409:                            end
<a name="16410"/>16410:                    end},
<a name="16411"/>16411:          #{desc =&gt; &quot;5b: announce ready (verify peek-off)&quot;,
<a name="16412"/>16412:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16413"/>16413:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16414"/>16414:                            ok
<a name="16415"/>16415:                    end},
<a name="16416"/>16416: 
<a name="16417"/>16417: 
<a name="16418"/>16418:          %% *** Termination ***
<a name="16419"/>16419:          #{desc =&gt; &quot;await terminate&quot;,
<a name="16420"/>16420:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16421"/>16421:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16422"/>16422:                                ok -&gt;
<a name="16423"/>16423:                                    {ok, maps:remove(tester, State)};
<a name="16424"/>16424:                                {error, _} = ERROR -&gt;
<a name="16425"/>16425:                                    ERROR
<a name="16426"/>16426:                            end
<a name="16427"/>16427:                    end},
<a name="16428"/>16428:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="16429"/>16429:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="16430"/>16430:                            ok = socket:close(Sock),
<a name="16431"/>16431:                            {ok, maps:remove(csock, State)}
<a name="16432"/>16432:                    end},
<a name="16433"/>16433:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="16434"/>16434:            cmd  =&gt; fun(#{lsock := Sock,
<a name="16435"/>16435:                          lsa   := #{path := Path}} = State) -&gt;
<a name="16436"/>16436:                            ok = socket:close(Sock),
<a name="16437"/>16437:                            State1 =
<a name="16438"/>16438:                                unlink_path(Path,
<a name="16439"/>16439:                                            fun() -&gt;
<a name="16440"/>16440:                                                    maps:remove(local_sa, State)
<a name="16441"/>16441:                                            end,
<a name="16442"/>16442:                                            fun() -&gt; State end),
<a name="16443"/>16443:                            {ok, maps:remove(lsock, State1)}
<a name="16444"/>16444:                    end},
<a name="16445"/>16445: 
<a name="16446"/>16446:          %% *** We are done ***
<a name="16447"/>16447:          ?SEV_FINISH_NORMAL
<a name="16448"/>16448:         ],
<a name="16449"/>16449: 
<a name="16450"/>16450:     ClientSeq = 
<a name="16451"/>16451:         [
<a name="16452"/>16452:          %% *** Wait for start order ***
<a name="16453"/>16453:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="16454"/>16454:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="16455"/>16455:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="16456"/>16456:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}}
<a name="16457"/>16457:                    end},
<a name="16458"/>16458:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="16459"/>16459:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16460"/>16460:                            _MRef = erlang:monitor(process, Tester),
<a name="16461"/>16461:                            ok
<a name="16462"/>16462:                    end},
<a name="16463"/>16463: 
<a name="16464"/>16464:          %% *** The init part ***
<a name="16465"/>16465:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="16466"/>16466:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="16467"/>16467:                          server_path := Path} = State) -&gt;
<a name="16468"/>16468:                            LSA = which_local_socket_addr(Domain),
<a name="16469"/>16469:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="16470"/>16470:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="16471"/>16471:                    end},
<a name="16472"/>16472:          #{desc =&gt; &quot;create socket&quot;,
<a name="16473"/>16473:            cmd  =&gt; fun(#{domain := Domain,
<a name="16474"/>16474:                          proto  := Proto} = State) -&gt;
<a name="16475"/>16475:                            case socket:open(Domain, stream, Proto) of
<a name="16476"/>16476:                                {ok, Sock} -&gt;
<a name="16477"/>16477:                                    {ok, State#{sock =&gt; Sock}};
<a name="16478"/>16478:                                {error, _} = ERROR -&gt;
<a name="16479"/>16479:                                    ERROR
<a name="16480"/>16480:                            end
<a name="16481"/>16481:                    end},
<a name="16482"/>16482:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="16483"/>16483:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="16484"/>16484:                            case sock_bind(Sock, LSA) of
<a name="16485"/>16485:                                ok -&gt;
<a name="16486"/>16486:                                    ok;
<a name="16487"/>16487:                                {error, _} = ERROR -&gt;
<a name="16488"/>16488:                                    ERROR
<a name="16489"/>16489:                            end
<a name="16490"/>16490:                    end},
<a name="16491"/>16491:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="16492"/>16492:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16493"/>16493:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="16494"/>16494:                            ok
<a name="16495"/>16495:                    end},
<a name="16496"/>16496: 
<a name="16497"/>16497:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="16498"/>16498:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16499"/>16499:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="16500"/>16500:                    end},
<a name="16501"/>16501:          #{desc =&gt; &quot;connect to server&quot;,
<a name="16502"/>16502:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="16503"/>16503:                            socket:connect(Sock, SSA)
<a name="16504"/>16504:                    end},
<a name="16505"/>16505:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="16506"/>16506:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16507"/>16507:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="16508"/>16508:                            ok
<a name="16509"/>16509:                    end},
<a name="16510"/>16510: 
<a name="16511"/>16511: 
<a name="16512"/>16512:          %% *** The actual test ***
<a name="16513"/>16513:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="16514"/>16514:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16515"/>16515:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_data)
<a name="16516"/>16516:                    end},
<a name="16517"/>16517:          #{desc =&gt; &quot;send data (to server)&quot;,
<a name="16518"/>16518:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16519"/>16519:                            Send(Sock, &lt;&lt;1:8/integer,
<a name="16520"/>16520:                                         2:8/integer,
<a name="16521"/>16521:                                         3:8/integer,
<a name="16522"/>16522:                                         4:8/integer,
<a name="16523"/>16523:                                         5:8/integer,
<a name="16524"/>16524:                                         6:8/integer,
<a name="16525"/>16525:                                         7:8/integer,
<a name="16526"/>16526:                                         8:8/integer&gt;&gt;)
<a name="16527"/>16527:                    end},
<a name="16528"/>16528:          #{desc =&gt; &quot;announce ready (send data)&quot;,
<a name="16529"/>16529:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16530"/>16530:                            ?SEV_ANNOUNCE_READY(Tester, send_data),
<a name="16531"/>16531:                            ok
<a name="16532"/>16532:                    end},
<a name="16533"/>16533: 
<a name="16534"/>16534:          %% *** Termination ***
<a name="16535"/>16535:          #{desc =&gt; &quot;await terminate&quot;,
<a name="16536"/>16536:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16537"/>16537:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16538"/>16538:                                ok -&gt;
<a name="16539"/>16539:                                    {ok, maps:remove(tester, State)};
<a name="16540"/>16540:                                {error, _} = ERROR -&gt;
<a name="16541"/>16541:                                    ERROR
<a name="16542"/>16542:                            end
<a name="16543"/>16543:                    end},
<a name="16544"/>16544:          #{desc =&gt; &quot;close socket&quot;,
<a name="16545"/>16545:            cmd  =&gt; fun(#{sock     := Sock,
<a name="16546"/>16546:                          local_sa := #{path := Path}} = State) -&gt;
<a name="16547"/>16547:                            ok = socket:close(Sock),
<a name="16548"/>16548:                            State1 =
<a name="16549"/>16549:                                unlink_path(Path,
<a name="16550"/>16550:                                            fun() -&gt;
<a name="16551"/>16551:                                                    maps:remove(local_sa, State)
<a name="16552"/>16552:                                            end,
<a name="16553"/>16553:                                            fun() -&gt; State end),
<a name="16554"/>16554:                            {ok, maps:remove(sock, State1)}
<a name="16555"/>16555:                    end},
<a name="16556"/>16556: 
<a name="16557"/>16557:          %% *** We are done ***
<a name="16558"/>16558:          ?SEV_FINISH_NORMAL
<a name="16559"/>16559:         ],
<a name="16560"/>16560: 
<a name="16561"/>16561:     TesterSeq =
<a name="16562"/>16562:         [
<a name="16563"/>16563:          %% *** Init part ***
<a name="16564"/>16564:          #{desc =&gt; &quot;monitor server&quot;,
<a name="16565"/>16565:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="16566"/>16566:                            _MRef = erlang:monitor(process, Pid),
<a name="16567"/>16567:                            ok
<a name="16568"/>16568:                    end},
<a name="16569"/>16569:          #{desc =&gt; &quot;monitor client&quot;,
<a name="16570"/>16570:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="16571"/>16571:                            _MRef = erlang:monitor(process, Pid),
<a name="16572"/>16572:                            ok
<a name="16573"/>16573:                    end},
<a name="16574"/>16574: 
<a name="16575"/>16575:          %% Start the server
<a name="16576"/>16576:          #{desc =&gt; &quot;order server start&quot;,
<a name="16577"/>16577:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="16578"/>16578:                            ?SEV_ANNOUNCE_START(Pid),
<a name="16579"/>16579:                            ok
<a name="16580"/>16580:                    end},
<a name="16581"/>16581:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="16582"/>16582:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="16583"/>16583:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="16584"/>16584:                            {ok, State#{server_port =&gt; Port}}
<a name="16585"/>16585:                    end},
<a name="16586"/>16586: 
<a name="16587"/>16587:          %% Start the client
<a name="16588"/>16588:          #{desc =&gt; &quot;order client start&quot;,
<a name="16589"/>16589:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="16590"/>16590:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="16591"/>16591:                            ok
<a name="16592"/>16592:                    end},
<a name="16593"/>16593:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="16594"/>16594:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="16595"/>16595:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="16596"/>16596:                    end},
<a name="16597"/>16597: 
<a name="16598"/>16598:          %% Establish the connection
<a name="16599"/>16599:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="16600"/>16600:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16601"/>16601:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="16602"/>16602:                            ok
<a name="16603"/>16603:                    end},
<a name="16604"/>16604:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="16605"/>16605:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16606"/>16606:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="16607"/>16607:                            ok
<a name="16608"/>16608:                    end},
<a name="16609"/>16609:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="16610"/>16610:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16611"/>16611:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="16612"/>16612:                    end},
<a name="16613"/>16613:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="16614"/>16614:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16615"/>16615:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="16616"/>16616:                    end},
<a name="16617"/>16617: 
<a name="16618"/>16618: 
<a name="16619"/>16619:          %% *** The actual test ***
<a name="16620"/>16620:          #{desc =&gt; &quot;order client to continue (with send data)&quot;,
<a name="16621"/>16621:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16622"/>16622:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_data),
<a name="16623"/>16623:                            ok
<a name="16624"/>16624:                    end},
<a name="16625"/>16625:          #{desc =&gt; &quot;await client ready (with send data)&quot;,
<a name="16626"/>16626:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16627"/>16627:                            ?SEV_AWAIT_READY(Client, client, send_data)
<a name="16628"/>16628:                    end},
<a name="16629"/>16629: 
<a name="16630"/>16630:          %% There is no way to be sure that the data has actually arrived,
<a name="16631"/>16631:          %% and with no data on the server side, the peek will fail.
<a name="16632"/>16632:          %% Hopefully a sleep will take care of this...
<a name="16633"/>16633:          ?SEV_SLEEP(?SECS(1)),
<a name="16634"/>16634: 
<a name="16635"/>16635:          %% 1) peek
<a name="16636"/>16636:          #{desc =&gt; &quot;1a: order server to continue (peek)&quot;,
<a name="16637"/>16637:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16638"/>16638:                            ?SEV_ANNOUNCE_CONTINUE(Server, peek),
<a name="16639"/>16639:                            ok
<a name="16640"/>16640:                    end},
<a name="16641"/>16641:          #{desc =&gt; &quot;1a: await server ready (peek)&quot;,
<a name="16642"/>16642:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16643"/>16643:                            ?SEV_AWAIT_READY(Server, server, peek)
<a name="16644"/>16644:                    end},
<a name="16645"/>16645: 
<a name="16646"/>16646:          #{desc =&gt; &quot;1b: order server to continue (verify peek-off)&quot;,
<a name="16647"/>16647:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16648"/>16648:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16649"/>16649:                            ok
<a name="16650"/>16650:                    end},
<a name="16651"/>16651:          #{desc =&gt; &quot;1b: await server ready (verify peek-off)&quot;,
<a name="16652"/>16652:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16653"/>16653:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16654"/>16654:                    end},
<a name="16655"/>16655: 
<a name="16656"/>16656: 
<a name="16657"/>16657:          %% 2) set peek-off
<a name="16658"/>16658:          #{desc =&gt; &quot;2a: order server to continue (set peek-off)&quot;,
<a name="16659"/>16659:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16660"/>16660:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_peek_off),
<a name="16661"/>16661:                            ok
<a name="16662"/>16662:                    end},
<a name="16663"/>16663:          #{desc =&gt; &quot;2a: await server ready (set peek-off)&quot;,
<a name="16664"/>16664:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16665"/>16665:                            ?SEV_AWAIT_READY(Server, server, set_peek_off)
<a name="16666"/>16666:                    end},
<a name="16667"/>16667: 
<a name="16668"/>16668:          #{desc =&gt; &quot;2b: order server to continue (verify peek-off)&quot;,
<a name="16669"/>16669:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16670"/>16670:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16671"/>16671:                            ok
<a name="16672"/>16672:                    end},
<a name="16673"/>16673:          #{desc =&gt; &quot;2b: await server ready (verify peek-off)&quot;,
<a name="16674"/>16674:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16675"/>16675:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16676"/>16676:                    end},
<a name="16677"/>16677: 
<a name="16678"/>16678: 
<a name="16679"/>16679: 
<a name="16680"/>16680:          %% 3) peek
<a name="16681"/>16681:          #{desc =&gt; &quot;3a: order server to continue (peek)&quot;,
<a name="16682"/>16682:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16683"/>16683:                            ?SEV_ANNOUNCE_CONTINUE(Server, peek),
<a name="16684"/>16684:                            ok
<a name="16685"/>16685:                    end},
<a name="16686"/>16686:          #{desc =&gt; &quot;3a: await server ready (peek)&quot;,
<a name="16687"/>16687:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16688"/>16688:                            ?SEV_AWAIT_READY(Server, server, peek)
<a name="16689"/>16689:                    end},
<a name="16690"/>16690: 
<a name="16691"/>16691:          #{desc =&gt; &quot;3b: order server to continue (verify peek-off)&quot;,
<a name="16692"/>16692:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16693"/>16693:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16694"/>16694:                            ok
<a name="16695"/>16695:                    end},
<a name="16696"/>16696:          #{desc =&gt; &quot;3b: await server ready (verify peek-off)&quot;,
<a name="16697"/>16697:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16698"/>16698:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16699"/>16699:                    end},
<a name="16700"/>16700: 
<a name="16701"/>16701: 
<a name="16702"/>16702: 
<a name="16703"/>16703:          %% 4) read part
<a name="16704"/>16704:          #{desc =&gt; &quot;4a: order server to continue (read part)&quot;,
<a name="16705"/>16705:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16706"/>16706:                            ?SEV_ANNOUNCE_CONTINUE(Server, read),
<a name="16707"/>16707:                            ok
<a name="16708"/>16708:                    end},
<a name="16709"/>16709:          #{desc =&gt; &quot;4a: await server ready (peek)&quot;,
<a name="16710"/>16710:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16711"/>16711:                            ?SEV_AWAIT_READY(Server, server, read)
<a name="16712"/>16712:                    end},
<a name="16713"/>16713: 
<a name="16714"/>16714:          #{desc =&gt; &quot;4b: order server to continue (verify peek-off)&quot;,
<a name="16715"/>16715:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16716"/>16716:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16717"/>16717:                            ok
<a name="16718"/>16718:                    end},
<a name="16719"/>16719:          #{desc =&gt; &quot;4b: await server ready (verify peek-off)&quot;,
<a name="16720"/>16720:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16721"/>16721:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16722"/>16722:                    end},
<a name="16723"/>16723: 
<a name="16724"/>16724: 
<a name="16725"/>16725:          %% 5) read (the rest)
<a name="16726"/>16726:          #{desc =&gt; &quot;5a: order server to continue (read the rest)&quot;,
<a name="16727"/>16727:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16728"/>16728:                            ?SEV_ANNOUNCE_CONTINUE(Server, read),
<a name="16729"/>16729:                            ok
<a name="16730"/>16730:                    end},
<a name="16731"/>16731:          #{desc =&gt; &quot;5a: await server ready (peek)&quot;,
<a name="16732"/>16732:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16733"/>16733:                            ?SEV_AWAIT_READY(Server, server, read)
<a name="16734"/>16734:                    end},
<a name="16735"/>16735: 
<a name="16736"/>16736:          #{desc =&gt; &quot;5b: order server to continue (verify peek-off)&quot;,
<a name="16737"/>16737:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16738"/>16738:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16739"/>16739:                            ok
<a name="16740"/>16740:                    end},
<a name="16741"/>16741:          #{desc =&gt; &quot;5b: await server ready (verify peek-off)&quot;,
<a name="16742"/>16742:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16743"/>16743:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16744"/>16744:                    end},
<a name="16745"/>16745: 
<a name="16746"/>16746: 
<a name="16747"/>16747:          %% *** Termination ***
<a name="16748"/>16748:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="16749"/>16749:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16750"/>16750:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="16751"/>16751:                            ok
<a name="16752"/>16752:                    end},
<a name="16753"/>16753:          #{desc =&gt; &quot;await client termination&quot;,
<a name="16754"/>16754:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="16755"/>16755:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="16756"/>16756:                            State1 = maps:remove(client, State),
<a name="16757"/>16757:                            {ok, State1}
<a name="16758"/>16758:                    end},
<a name="16759"/>16759:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="16760"/>16760:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16761"/>16761:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="16762"/>16762:                            ok
<a name="16763"/>16763:                    end},
<a name="16764"/>16764:          #{desc =&gt; &quot;await server termination&quot;,
<a name="16765"/>16765:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="16766"/>16766:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="16767"/>16767:                            State1 = maps:remove(server, State),
<a name="16768"/>16768:                            {ok, State1}
<a name="16769"/>16769:                    end},
<a name="16770"/>16770: 
<a name="16771"/>16771:          %% *** We are done ***
<a name="16772"/>16772:          ?SEV_FINISH_NORMAL
<a name="16773"/>16773:         ],
<a name="16774"/>16774: 
<a name="16775"/>16775:     i(&quot;start server evaluator&quot;),
<a name="16776"/>16776:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="16777"/>16777: 
<a name="16778"/>16778:     i(&quot;start client evaluator&quot;),
<a name="16779"/>16779:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="16780"/>16780:     i(&quot;await evaluator(s)&quot;),
<a name="16781"/>16781: 
<a name="16782"/>16782:     i(&quot;start tester evaluator&quot;),
<a name="16783"/>16783:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="16784"/>16784:                         client =&gt; Client#ev.pid},
<a name="16785"/>16785:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="16786"/>16786: 
<a name="api_opt_sock_peek_off-last_expr"/><a name="16787"/>16787: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="16788"/>16788: 
<a name="16789"/>16789: 
<a name="16790"/>16790: 
<a name="16791"/>16791: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="16792"/>16792: 
<a name="16793"/>16793: <i>%% Tests that we get the peer credentials for a connected unix domain</i>
<a name="16794"/>16794: <i>%% TCP (stream) socket.</i>
<a name="16795"/>16795: <i>%% That is, all we need to do is to create a node, and have </i>
<a name="16796"/>16796: <i>%% process connect from that to a local (unix domain socket) socket.</i>
<a name="16797"/>16797: <i>%%</i>
<a name="16798"/>16798: <i>%% THIS IS A PLACEHOLDER!!</i>
<a name="16799"/>16799: <i>%%</i>
<a name="16800"/>16800: <i>%% We need to figure out what the ucred structure looks like,</i>
<a name="16801"/>16801: <i>%% and decode it...</i>
<a name="16802"/>16802: <i>%%</i>
<a name="16803"/>16803: 
<a name="api_opt_sock_peercred_tcpL-1"/><a name="16804"/>16804: <b>api_opt_sock_peercred_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="16805"/>16805:     ?TT(?SECS(5)),
<a name="api_opt_sock_peercred_tcpL-last_expr"/><a name="16806"/>16806: <b>    tc_try</b>(api_opt_sock_peercred_tcpL,
<a name="16807"/>16807:            fun() -&gt;
<a name="16808"/>16808:                    has_support_unix_domain_socket(),
<a name="16809"/>16809:                    has_support_sock_peercred(),
<a name="16810"/>16810:                    not_yet_implemented()
<a name="16811"/>16811:            end,
<a name="16812"/>16812:            fun() -&gt;
<a name="16813"/>16813:                    Get  = fun(Sock) -&gt;
<a name="16814"/>16814:                                   socket:getopt(Sock, socket, peercred)
<a name="16815"/>16815:                           end,
<a name="16816"/>16816:                    InitState = #{domain =&gt; local,
<a name="16817"/>16817:                                  proto  =&gt; default, % Type = stream =&gt; tcp
<a name="16818"/>16818:                                  get    =&gt; Get},
<a name="16819"/>16819:                    ok = api_opt_sock_peercred_tcp(InitState)
<a name="16820"/>16820:            end).
<a name="16821"/>16821: 
<a name="16822"/>16822: 
<a name="api_opt_sock_peercred_tcp-1"/><a name="16823"/>16823: <b>api_opt_sock_peercred_tcp</b>(_InitState) -&gt;
<a name="16824"/>16824:     %% ServerSeq =
<a name="16825"/>16825:     %%     [
<a name="16826"/>16826:     %%      %% *** Wait for start order part ***
<a name="16827"/>16827:     %%      #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="16828"/>16828:     %%        cmd  =&gt; fun(State) -&gt;
<a name="16829"/>16829:     %%                        {Tester, Backlog} = ?SEV_AWAIT_START(),
<a name="16830"/>16830:     %%                        {ok, State#{tester  =&gt; Tester,
<a name="16831"/>16831:     %%                                    backlog =&gt; Backlog}}
<a name="16832"/>16832:     %%                end},
<a name="16833"/>16833:     %%      #{desc =&gt; &quot;monitor tester&quot;,
<a name="16834"/>16834:     %%        cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16835"/>16835:     %%                        _MRef = erlang:monitor(process, Tester),
<a name="16836"/>16836:     %%                        ok
<a name="16837"/>16837:     %%                end},
<a name="16838"/>16838: 
<a name="16839"/>16839:     %%      %% *** Init part ***
<a name="16840"/>16840:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="16841"/>16841:     %%        cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="16842"/>16842:     %%                        LSA = which_local_socket_addr(Domain),
<a name="16843"/>16843:     %%                        {ok, State#{lsa =&gt; LSA}}
<a name="16844"/>16844:     %%                end},
<a name="16845"/>16845:     %%      #{desc =&gt; &quot;create listen socket&quot;,
<a name="16846"/>16846:     %%        cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="16847"/>16847:     %%                        case socket:open(Domain, stream, Proto) of
<a name="16848"/>16848:     %%                            {ok, Sock} -&gt;
<a name="16849"/>16849:     %%                                {ok, State#{lsock =&gt; Sock}};
<a name="16850"/>16850:     %%                            {error, _} = ERROR -&gt;
<a name="16851"/>16851:     %%                                ERROR
<a name="16852"/>16852:     %%                        end
<a name="16853"/>16853:     %%                end},
<a name="16854"/>16854:     %%      #{desc =&gt; &quot;bind to local address&quot;,
<a name="16855"/>16855:     %%        cmd  =&gt; fun(#{domain := local,
<a name="16856"/>16856:     %%                      lsock  := LSock,
<a name="16857"/>16857:     %%                      lsa    := LSA} = _State) -&gt;
<a name="16858"/>16858:     %%                        case socket:bind(LSock, LSA) of
<a name="16859"/>16859:     %%                            ok -&gt;
<a name="16860"/>16860:     %%                                ok;
<a name="16861"/>16861:     %%                            {error, _} = ERROR -&gt;
<a name="16862"/>16862:     %%                                ERROR
<a name="16863"/>16863:     %%                        end
<a name="16864"/>16864:     %%                end},
<a name="16865"/>16865:     %%      #{desc =&gt; &quot;make listen socket&quot;,
<a name="16866"/>16866:     %%        cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="16867"/>16867:     %%                        socket:listen(LSock)
<a name="16868"/>16868:     %%                end},
<a name="16869"/>16869:     %%      #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="16870"/>16870:     %%        cmd  =&gt; fun(#{domain := local,
<a name="16871"/>16871:     %%                      tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="16872"/>16872:     %%                        ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="16873"/>16873:     %%                        ok
<a name="16874"/>16874:     %%                end},
<a name="16875"/>16875: 
<a name="16876"/>16876: 
<a name="16877"/>16877:     %%      %% The actual test
<a name="16878"/>16878:     %%      #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="16879"/>16879:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16880"/>16880:     %%                        ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="16881"/>16881:     %%                end},
<a name="16882"/>16882:     %%      #{desc =&gt; &quot;await connection&quot;,
<a name="16883"/>16883:     %%        cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="16884"/>16884:     %%                        case socket:accept(LSock) of
<a name="16885"/>16885:     %%                            {ok, Sock} -&gt;
<a name="16886"/>16886:     %%                                ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="16887"/>16887:     %%                                {ok, State#{csock =&gt; Sock}};
<a name="16888"/>16888:     %%                            {error, _} = ERROR -&gt;
<a name="16889"/>16889:     %%                                ERROR
<a name="16890"/>16890:     %%                        end
<a name="16891"/>16891:     %%                end},
<a name="16892"/>16892:     %%      #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="16893"/>16893:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16894"/>16894:     %%                        ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="16895"/>16895:     %%                        ok
<a name="16896"/>16896:     %%                end},
<a name="16897"/>16897: 
<a name="16898"/>16898:     %%      #{desc =&gt; &quot;await continue (peercred)&quot;,
<a name="16899"/>16899:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16900"/>16900:     %%                        ?SEV_AWAIT_CONTINUE(Tester, tester, peercred)
<a name="16901"/>16901:     %%                end},
<a name="16902"/>16902:     %%      #{desc =&gt; &quot;get peercred&quot;,
<a name="16903"/>16903:     %%        cmd  =&gt; fun(#{csock := Sock, get := Get} = _State) -&gt;
<a name="16904"/>16904:     %%                        case Get(Sock) of
<a name="16905"/>16905:     %%                            {ok, PeerCred} -&gt;
<a name="16906"/>16906:     %%                                ?SEV_IPRINT(&quot;PeerCred: ~n   ~p&quot;, [PeerCred]),
<a name="16907"/>16907:     %%                                ok;
<a name="16908"/>16908:     %%                            {error, _} = ERROR -&gt;
<a name="16909"/>16909:     %%                                ERROR
<a name="16910"/>16910:     %%                        end
<a name="16911"/>16911:     %%                end},
<a name="16912"/>16912:     %%      #{desc =&gt; &quot;announce ready (peercred)&quot;,
<a name="16913"/>16913:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16914"/>16914:     %%                        ?SEV_ANNOUNCE_READY(Tester, peercred),
<a name="16915"/>16915:     %%                        ok
<a name="16916"/>16916:     %%                end},
<a name="16917"/>16917: 
<a name="16918"/>16918: 
<a name="16919"/>16919:     %%      %% Termination
<a name="16920"/>16920:     %%      #{desc =&gt; &quot;await terminate&quot;,
<a name="16921"/>16921:     %%        cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16922"/>16922:     %%                        case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16923"/>16923:     %%                            ok -&gt;
<a name="16924"/>16924:     %%                                {ok, maps:remove(tester, State)};
<a name="16925"/>16925:     %%                            {error, _} = ERROR -&gt;
<a name="16926"/>16926:     %%                                ERROR
<a name="16927"/>16927:     %%                        end
<a name="16928"/>16928:     %%                end},
<a name="16929"/>16929:     %%      #{desc =&gt; &quot;close connection socket&quot;,
<a name="16930"/>16930:     %%        cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="16931"/>16931:     %%                        ok = socket:close(Sock),
<a name="16932"/>16932:     %%                        {ok, maps:remove(csock, State)}
<a name="16933"/>16933:     %%                end},
<a name="16934"/>16934:     %%      #{desc =&gt; &quot;close listen socket&quot;,
<a name="16935"/>16935:     %%        cmd  =&gt; fun(#{domain := local,
<a name="16936"/>16936:     %%                      lsock  := Sock,
<a name="16937"/>16937:     %%                      lsa    := #{path := Path}} = State) -&gt;
<a name="16938"/>16938:     %%                        ok = socket:close(Sock),
<a name="16939"/>16939:     %%                        State1 =
<a name="16940"/>16940:     %%                            unlink_path(Path,
<a name="16941"/>16941:     %%                                        fun() -&gt;
<a name="16942"/>16942:     %%                                                maps:remove(lsa, State)
<a name="16943"/>16943:     %%                                        end,
<a name="16944"/>16944:     %%                                        fun() -&gt; State end),
<a name="16945"/>16945:     %%                        {ok, maps:remove(lsock, State1)}
<a name="16946"/>16946:     %%                end},
<a name="16947"/>16947: 
<a name="16948"/>16948:     %%      %% *** We are done ***
<a name="16949"/>16949:     %%      ?SEV_FINISH_NORMAL
<a name="16950"/>16950:     %%     ],
<a name="16951"/>16951: 
<a name="16952"/>16952: 
<a name="16953"/>16953:     %% ClientSeq =
<a name="16954"/>16954:     %%     [
<a name="16955"/>16955:     %%      %% *** Wait for start order part ***
<a name="16956"/>16956:     %%      #{desc =&gt; &quot;await start&quot;,
<a name="16957"/>16957:     %%        cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="16958"/>16958:     %%                        {Tester, Path} = ?SEV_AWAIT_START(),
<a name="16959"/>16959:     %%                        {ok, State#{tester    =&gt; Tester,
<a name="16960"/>16960:     %%                                    server_path =&gt; Path}}
<a name="16961"/>16961:     %%                end},
<a name="16962"/>16962:     %%      #{desc =&gt; &quot;monitor tester&quot;,
<a name="16963"/>16963:     %%        cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16964"/>16964:     %%                        _MRef = erlang:monitor(process, Tester),
<a name="16965"/>16965:     %%                        ok
<a name="16966"/>16966:     %%                end},
<a name="16967"/>16967: 
<a name="16968"/>16968: 
<a name="16969"/>16969:     %%      %% *** Init part ***
<a name="16970"/>16970:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="16971"/>16971:     %%        cmd  =&gt; fun(#{domain      := local = Domain,
<a name="16972"/>16972:     %%                      server_path := Path} = State) -&gt;
<a name="16973"/>16973:     %%                        LSA = which_local_socket_addr(Domain),
<a name="16974"/>16974:     %%                        SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="16975"/>16975:     %%                        {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="16976"/>16976:     %%                end},
<a name="16977"/>16977:     %%      #{desc =&gt; &quot;create node&quot;,
<a name="16978"/>16978:     %%        cmd  =&gt; fun(#{host := Host} = State) -&gt;
<a name="16979"/>16979:     %%     		   ?SEV_IPRINT(&quot;try create node on ~p&quot;, [Host]),
<a name="16980"/>16980:     %%                        case ?CT_PEER() of
<a name="16981"/>16981:     %%                            {ok, Peer, Node} -&gt;
<a name="16982"/>16982:     %%                                ?SEV_IPRINT(&quot;client node ~p started&quot;,
<a name="16983"/>16983:     %%                                            [Node]),
<a name="16984"/>16984:     %%                                {ok, State#{node =&gt; Node, peer =&gt; Peer}};
<a name="16985"/>16985:     %%                            {error, Reason} -&gt;
<a name="16986"/>16986:     %%                                {skip, Reason}
<a name="16987"/>16987:     %%                        end
<a name="16988"/>16988:     %%                end},
<a name="16989"/>16989:     %%       #{desc =&gt; &quot;monitor client node&quot;,
<a name="16990"/>16990:     %%        cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="16991"/>16991:     %%                        true = erlang:monitor_node(Node, true),
<a name="16992"/>16992:     %%                        ok
<a name="16993"/>16993:     %%                end},
<a name="16994"/>16994:     %%      #{desc =&gt; &quot;start remote client on client node&quot;,
<a name="16995"/>16995:     %%        cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="16996"/>16996:     %%                        Pid = api_opt_sock_peercred_tcp_client_start(Node),
<a name="16997"/>16997:     %%                        ?SEV_IPRINT(&quot;remote client ~p started&quot;, [Pid]),
<a name="16998"/>16998:     %%                        {ok, State#{rclient =&gt; Pid}}
<a name="16999"/>16999:     %%                end},
<a name="17000"/>17000:     %%      #{desc =&gt; &quot;monitor remote client&quot;,
<a name="17001"/>17001:     %%        cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="17002"/>17002:     %%                        _MRef = erlang:monitor(process, Pid),
<a name="17003"/>17003:     %%                        ok
<a name="17004"/>17004:     %%                end},
<a name="17005"/>17005:     %%      #{desc =&gt; &quot;order remote client to start&quot;,
<a name="17006"/>17006:     %%        cmd  =&gt; fun(#{rclient   := Client,
<a name="17007"/>17007:     %%                     proto      := Proto,
<a name="17008"/>17008:     %%                      server_sa := ServerSA}) -&gt;
<a name="17009"/>17009:     %%                        ?SEV_ANNOUNCE_START(Client, {Proto, ServerSA}),
<a name="17010"/>17010:     %%                        ok
<a name="17011"/>17011:     %%                end},
<a name="17012"/>17012:     %%      #{desc =&gt; &quot;await remote client ready&quot;,
<a name="17013"/>17013:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17014"/>17014:     %%                      rclient := Client} = _State) -&gt;
<a name="17015"/>17015:     %%                        ?SEV_AWAIT_READY(Client, rclient, init,
<a name="17016"/>17016:     %%                                         [{tester, Tester}])
<a name="17017"/>17017:     %%                end},
<a name="17018"/>17018:     %%      #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="17019"/>17019:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17020"/>17020:     %%                        ?SEV_ANNOUNCE_READY(Tester, init),
<a name="17021"/>17021:     %%                        ok
<a name="17022"/>17022:     %%                end},
<a name="17023"/>17023: 
<a name="17024"/>17024: 
<a name="17025"/>17025:     %%      %% The actual test
<a name="17026"/>17026:     %%      #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="17027"/>17027:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17028"/>17028:     %%                      rclient := Client} = State) -&gt;
<a name="17029"/>17029:     %%                        case ?SEV_AWAIT_CONTINUE(Tester, tester, connect,
<a name="17030"/>17030:     %%                                                 [{rclient, Client}]) of
<a name="17031"/>17031:     %%                            {ok, {ConTimeout, ConLimit}} -&gt;
<a name="17032"/>17032:     %%                                {ok, State#{connect_timeout =&gt; ConTimeout,
<a name="17033"/>17033:     %%                                            connect_limit   =&gt; ConLimit}};
<a name="17034"/>17034:     %%                            {error, _} = ERROR -&gt;
<a name="17035"/>17035:     %%                                ERROR
<a name="17036"/>17036:     %%                        end
<a name="17037"/>17037:     %%                end},
<a name="17038"/>17038:     %%      #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="17039"/>17039:     %%        cmd  =&gt; fun(#{rclient         := RClient,
<a name="17040"/>17040:     %%                      connect_timeout := ConTimeout,
<a name="17041"/>17041:     %%                      connect_limit   := ConLimit}) -&gt;
<a name="17042"/>17042:     %%                        ?SEV_ANNOUNCE_CONTINUE(RClient, connect,
<a name="17043"/>17043:     %%                                               {ConTimeout, ConLimit}),
<a name="17044"/>17044:     %%                        ok
<a name="17045"/>17045:     %%                end},
<a name="17046"/>17046:     %%      #{desc =&gt; &quot;await remote client ready (connect)&quot;,
<a name="17047"/>17047:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17048"/>17048:     %%                      rclient := RClient} = State) -&gt;
<a name="17049"/>17049:     %%                        case ?SEV_AWAIT_READY(RClient, rclient, connect,
<a name="17050"/>17050:     %%                                              [{tester, Tester}]) of
<a name="17051"/>17051:     %%                            {ok, ok = _Result} -&gt;
<a name="17052"/>17052:     %%                                {ok, maps:remove(connect_limit, State)};
<a name="17053"/>17053:     %%                            {ok, {error, {connect_limit_reached,R,L}}} -&gt;
<a name="17054"/>17054:     %%                                {skip,
<a name="17055"/>17055:     %%                                 ?SLIB:f(&quot;Connect limit reached ~w: ~w&quot;,
<a name="17056"/>17056:     %%                                        [L, R])};
<a name="17057"/>17057:     %%                            {ok, Result} -&gt;
<a name="17058"/>17058:     %%                                Result;
<a name="17059"/>17059:     %%                            {error, _} = ERROR -&gt;
<a name="17060"/>17060:     %%                                ERROR
<a name="17061"/>17061:     %%                        end
<a name="17062"/>17062:     %%                end},
<a name="17063"/>17063:     %%      #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="17064"/>17064:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17065"/>17065:     %%                        ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="17066"/>17066:     %%                        ok
<a name="17067"/>17067:     %%                end},
<a name="17068"/>17068: 
<a name="17069"/>17069:     %%      %% Termination
<a name="17070"/>17070:     %%      #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="17071"/>17071:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17072"/>17072:     %%                      rclient := RClient} = State) -&gt;
<a name="17073"/>17073:     %%                        case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="17074"/>17074:     %%                                                  [{rclient, RClient}]) of
<a name="17075"/>17075:     %%                            ok -&gt;
<a name="17076"/>17076:     %%                                {ok, maps:remove(tester, State)};
<a name="17077"/>17077:     %%                            {error, _} = ERROR -&gt;
<a name="17078"/>17078:     %%                                ERROR
<a name="17079"/>17079:     %%                        end
<a name="17080"/>17080:     %%                end},
<a name="17081"/>17081:     %%      #{desc =&gt; &quot;kill remote client&quot;,
<a name="17082"/>17082:     %%        cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="17083"/>17083:     %%                        ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="17084"/>17084:     %%                        ok
<a name="17085"/>17085:     %%                end},
<a name="17086"/>17086:     %%      #{desc =&gt; &quot;await remote client termination&quot;,
<a name="17087"/>17087:     %%        cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="17088"/>17088:     %%                        ?SEV_AWAIT_TERMINATION(Client),
<a name="17089"/>17089:     %%                        State1 = maps:remove(rclient, State),
<a name="17090"/>17090:     %%                        {ok, State1}
<a name="17091"/>17091:     %%                end},
<a name="17092"/>17092:     %%      #{desc =&gt; &quot;stop client node&quot;,
<a name="17093"/>17093:     %%        cmd  =&gt; fun(#{peer := Peer} = _State) -&gt;
<a name="17094"/>17094:     %%                        peer:stop(Peer)
<a name="17095"/>17095:     %%                end},
<a name="17096"/>17096:     %%      #{desc =&gt; &quot;await client node termination&quot;,
<a name="17097"/>17097:     %%        cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="17098"/>17098:     %%                        receive
<a name="17099"/>17099:     %%                            {nodedown, Node} -&gt;
<a name="17100"/>17100:     %%                                State1 = maps:remove(node_id, State),
<a name="17101"/>17101:     %%                                State2 = maps:remove(node,    State1),
<a name="17102"/>17102:     %%                                {ok, State2}
<a name="17103"/>17103:     %%                        end
<a name="17104"/>17104:     %%                end},
<a name="17105"/>17105: 
<a name="17106"/>17106:     %%      %% *** We are done ***
<a name="17107"/>17107:     %%      ?SEV_FINISH_NORMAL
<a name="17108"/>17108:     %%    ],
<a name="17109"/>17109: 
<a name="17110"/>17110:     %% TesterSeq =
<a name="17111"/>17111:     %%     [
<a name="17112"/>17112:     %%      %% *** Init part ***
<a name="17113"/>17113:     %%      #{desc =&gt; &quot;monitor server&quot;,
<a name="17114"/>17114:     %%        cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17115"/>17115:     %%                        _MRef = erlang:monitor(process, Server),
<a name="17116"/>17116:     %%                        ok
<a name="17117"/>17117:     %%                end},
<a name="17118"/>17118:     %%      #{desc =&gt; &quot;monitor client&quot;,
<a name="17119"/>17119:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17120"/>17120:     %%                        _MRef = erlang:monitor(process, Client),
<a name="17121"/>17121:     %%                        ok
<a name="17122"/>17122:     %%                end},
<a name="17123"/>17123:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="17124"/>17124:     %%        cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17125"/>17125:     %%                        LSA = which_local_socket_addr(Domain),
<a name="17126"/>17126:     %%                        {ok, State#{local_sa =&gt; LSA}}
<a name="17127"/>17127:     %%                end},
<a name="17128"/>17128:     %%      #{desc =&gt; &quot;order server start&quot;,
<a name="17129"/>17129:     %%        cmd  =&gt; fun(#{server  := Server,
<a name="17130"/>17130:     %%                      backlog := Backlog}) -&gt;
<a name="17131"/>17131:     %%                        ?SEV_ANNOUNCE_START(Server, Backlog),
<a name="17132"/>17132:     %%                        ok
<a name="17133"/>17133:     %%                end},
<a name="17134"/>17134:     %%      #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="17135"/>17135:     %%        cmd  =&gt; fun(#{server := Server, local_sa := LSA} = State) -&gt;
<a name="17136"/>17136:     %%                        {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="17137"/>17137:     %%                        ServerSA = LSA#{port =&gt; Port},
<a name="17138"/>17138:     %%                        {ok, State#{server_sa =&gt; ServerSA}}
<a name="17139"/>17139:     %%                end},
<a name="17140"/>17140:     %%      #{desc =&gt; &quot;order client start&quot;,
<a name="17141"/>17141:     %%        cmd  =&gt; fun(#{client    := Client,
<a name="17142"/>17142:     %%                      server_sa := ServerSA}) -&gt;
<a name="17143"/>17143:     %%                        ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="17144"/>17144:     %%                        ok
<a name="17145"/>17145:     %%                end},
<a name="17146"/>17146:     %%      #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="17147"/>17147:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17148"/>17148:     %%                        ?SEV_AWAIT_READY(Client, client, init),
<a name="17149"/>17149:     %%                        ok
<a name="17150"/>17150:     %%                end},
<a name="17151"/>17151: 
<a name="17152"/>17152: 
<a name="17153"/>17153:     %%      %% The actual test
<a name="17154"/>17154:     %%      %% The server accepts the connect from the client, announces
<a name="17155"/>17155:     %%      %% this to us (accept) and then attempts to get peercred.
<a name="17156"/>17156:     %%      #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="17157"/>17157:     %%        cmd  =&gt; fun(#{client        := Client,
<a name="17158"/>17158:     %%                      timeout       := Timeout,
<a name="17159"/>17159:     %%                      connect_limit := ConLimit} = _State) -&gt;
<a name="17160"/>17160:     %%                        ?SEV_ANNOUNCE_CONTINUE(Client, connect,
<a name="17161"/>17161:     %%                                               {Timeout, ConLimit}),
<a name="17162"/>17162:     %%                        ok
<a name="17163"/>17163:     %%                end},
<a name="17164"/>17164:     %%      #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="17165"/>17165:     %%        cmd  =&gt; fun(#{server := Server,
<a name="17166"/>17166:     %%                      client := Client} = _State) -&gt;
<a name="17167"/>17167:     %%                        case ?SEV_AWAIT_READY(Client, client, connect,
<a name="17168"/>17168:     %%                                              [{server, Server}]) of
<a name="17169"/>17169:     %%                            ok -&gt;
<a name="17170"/>17170:     %%                                ok;
<a name="17171"/>17171:     %%                            {error, _} = ERROR -&gt;
<a name="17172"/>17172:     %%                                ERROR
<a name="17173"/>17173:     %%                        end
<a name="17174"/>17174:     %%                end},
<a name="17175"/>17175:     %%      #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="17176"/>17176:     %%        cmd  =&gt; fun(#{server := Server,
<a name="17177"/>17177:     %%                      client := Client} = _State) -&gt;
<a name="17178"/>17178:     %%                        case ?SEV_AWAIT_READY(Server, server, accept,
<a name="17179"/>17179:     %%                                              [{client, Client}]) of
<a name="17180"/>17180:     %%                            ok -&gt;
<a name="17181"/>17181:     %%                                ok;
<a name="17182"/>17182:     %%                            {error, _} = ERROR -&gt;
<a name="17183"/>17183:     %%                                ERROR
<a name="17184"/>17184:     %%                        end
<a name="17185"/>17185:     %%                end},
<a name="17186"/>17186:     %%      #{desc =&gt; &quot;await server ready (peercred)&quot;,
<a name="17187"/>17187:     %%        cmd  =&gt; fun(#{server := Server,
<a name="17188"/>17188:     %%                      client := Client} = _State) -&gt;
<a name="17189"/>17189:     %%                        case ?SEV_AWAIT_READY(Server, server, peercred,
<a name="17190"/>17190:     %%                                              [{client, Client}]) of
<a name="17191"/>17191:     %%                            ok -&gt;
<a name="17192"/>17192:     %%                                ok;
<a name="17193"/>17193:     %%                            {error, _} = ERROR -&gt;
<a name="17194"/>17194:     %%                                ERROR
<a name="17195"/>17195:     %%                        end
<a name="17196"/>17196:     %%                end},
<a name="17197"/>17197: 
<a name="17198"/>17198: 
<a name="17199"/>17199:     %%      %% *** Terminate server ***
<a name="17200"/>17200:     %%      #{desc =&gt; &quot;order client terminate&quot;,
<a name="17201"/>17201:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17202"/>17202:     %%                        ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="17203"/>17203:     %%                        ok
<a name="17204"/>17204:     %%                end},
<a name="17205"/>17205:     %%      #{desc =&gt; &quot;await client down&quot;,
<a name="17206"/>17206:     %%        cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="17207"/>17207:     %%                        ?SEV_AWAIT_TERMINATION(Client),
<a name="17208"/>17208:     %%                        State1 = maps:remove(client,    State),
<a name="17209"/>17209:     %%                        {ok, State1}
<a name="17210"/>17210:     %%                end},
<a name="17211"/>17211:     %%      #{desc =&gt; &quot;order server terminate&quot;,
<a name="17212"/>17212:     %%        cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17213"/>17213:     %%                        ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="17214"/>17214:     %%                        ok
<a name="17215"/>17215:     %%                end},
<a name="17216"/>17216:     %%      #{desc =&gt; &quot;await server down&quot;,
<a name="17217"/>17217:     %%        cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="17218"/>17218:     %%                        ?SEV_AWAIT_TERMINATION(Server),
<a name="17219"/>17219:     %%                        State1 = maps:remove(server,    State),
<a name="17220"/>17220:     %%                        State2 = maps:remove(server_sa, State1),
<a name="17221"/>17221:     %%                        {ok, State2}
<a name="17222"/>17222:     %%                end},
<a name="17223"/>17223: 
<a name="17224"/>17224:     %%      %% *** We are done ***
<a name="17225"/>17225:     %%      ?SEV_FINISH_NORMAL
<a name="17226"/>17226:     %%     ],
<a name="17227"/>17227: 
<a name="17228"/>17228:     %% i(&quot;create server evaluator&quot;),
<a name="17229"/>17229:     %% ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="17230"/>17230:     %% Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="17231"/>17231: 
<a name="17232"/>17232:     %% i(&quot;create client evaluator&quot;),
<a name="17233"/>17233:     %% ClientInitState = #{host   =&gt; local_host(),
<a name="17234"/>17234:     %%                     domain =&gt; maps:get(domain, InitState)},
<a name="17235"/>17235:     %% Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="17236"/>17236: 
<a name="17237"/>17237:     %% i(&quot;create tester evaluator&quot;),
<a name="17238"/>17238:     %% TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="17239"/>17239:     %%                              client =&gt; Client#ev.pid},
<a name="17240"/>17240:     %% Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="17241"/>17241: 
<a name="17242"/>17242:     %% i(&quot;await evaluator(s)&quot;),
<a name="17243"/>17243:     %% ok = ?SEV_AWAIT_FINISH([Server, Client, Tester]).
<a name="17244"/>17244: 
<a name="17245"/>17245: 
<a name="17246"/>17246:     %% This should actually never be called (the conditions should cause a skip),
<a name="17247"/>17247:     %% but just to be on the safe side...
<a name="api_opt_sock_peercred_tcp-last_expr"/><a name="17248"/>17248:     skip.
<a name="17249"/>17249: 
<a name="17250"/>17250: 
<a name="17251"/>17251: <i>%% api_opt_sock_peercred_tcp_client_start(Node) -&gt;</i>
<a name="17252"/>17252: <i>%%     Self = self(),</i>
<a name="17253"/>17253: <i>%%     Fun  = fun() -&gt; api_opt_sock_peercred_tcp_client(Self) end,</i>
<a name="17254"/>17254: <i>%%     erlang:spawn(Node, Fun).</i>
<a name="17255"/>17255: 
<a name="17256"/>17256: <i>%% api_opt_sock_peercred_tcp_client(Parent) -&gt;</i>
<a name="17257"/>17257: <i>%%     api_opt_sock_peercred_tcp_client_init(Parent),</i>
<a name="17258"/>17258: <i>%%     {Proto, ServerSA} = api_opt_sock_peercred_tcp_client_await_start(Parent),</i>
<a name="17259"/>17259: <i>%%     Domain   = maps:get(family, ServerSA),</i>
<a name="17260"/>17260: <i>%%     api_opt_sock_peercred_tcp_client_announce_ready(Parent, init),</i>
<a name="17261"/>17261: <i>%%     api_opt_sock_peercred_tcp_client_await_continue(Parent, connect),</i>
<a name="17262"/>17262: <i>%%     Result = api_opt_sock_peercred_tcp_client_connect(Domain, Proto, ServerSA),</i>
<a name="17263"/>17263: <i>%%     ?SEV_IPRINT(&quot;result: ~p&quot;, [Result]),</i>
<a name="17264"/>17264: <i>%%     api_opt_sock_peercred_tcp_client_announce_ready(Parent, connect, Result),</i>
<a name="17265"/>17265: <i>%%     Reason = api_opt_sock_peercred_tcp_client_await_terminate(Parent),</i>
<a name="17266"/>17266: <i>%%     api_opt_sock_peercred_tcp_client_close(Result),</i>
<a name="17267"/>17267: <i>%%     exit(Reason).</i>
<a name="17268"/>17268: 
<a name="17269"/>17269: <i>%% api_opt_sock_peercred_tcp_client_init(Parent) -&gt;</i>
<a name="17270"/>17270: <i>%%     put(sname, &quot;rclient&quot;),</i>
<a name="17271"/>17271: <i>%%     _MRef = erlang:monitor(process, Parent),</i>
<a name="17272"/>17272: <i>%%     ok.</i>
<a name="17273"/>17273: 
<a name="17274"/>17274: <i>%% api_opt_sock_peercred_tcp_client_await_start(Parent) -&gt;</i>
<a name="17275"/>17275: <i>%%     ?SEV_AWAIT_START(Parent).</i>
<a name="17276"/>17276: 
<a name="17277"/>17277: <i>%% api_opt_sock_peercred_tcp_client_announce_ready(Parent, Slogan) -&gt;</i>
<a name="17278"/>17278: <i>%%     ?SEV_ANNOUNCE_READY(Parent, Slogan).</i>
<a name="17279"/>17279: <i>%% api_opt_sock_peercred_tcp_client_announce_ready(Parent, Slogan, Result) -&gt;</i>
<a name="17280"/>17280: <i>%%     ?SEV_ANNOUNCE_READY(Parent, Slogan, Result).</i>
<a name="17281"/>17281: 
<a name="17282"/>17282: <i>%% api_opt_sock_peercred_tcp_client_await_continue(Parent, Slogan) -&gt;</i>
<a name="17283"/>17283: <i>%%     case ?SEV_AWAIT_CONTINUE(Parent, parent, Slogan) of</i>
<a name="17284"/>17284: <i>%%         ok -&gt;</i>
<a name="17285"/>17285: <i>%%             ok;</i>
<a name="17286"/>17286: <i>%%         {ok, Extra} -&gt;</i>
<a name="17287"/>17287: <i>%%             Extra;</i>
<a name="17288"/>17288: <i>%%         {error, Reason} -&gt;</i>
<a name="17289"/>17289: <i>%%             exit({await_continue, Slogan, Reason})</i>
<a name="17290"/>17290: <i>%%     end.</i>
<a name="17291"/>17291: 
<a name="17292"/>17292: <i>%% api_opt_sock_peercred_tcp_client_await_terminate(Parent) -&gt;</i>
<a name="17293"/>17293: <i>%%     case ?SEV_AWAIT_TERMINATE(Parent, parent) of</i>
<a name="17294"/>17294: <i>%%         ok -&gt;</i>
<a name="17295"/>17295: <i>%%             ok;</i>
<a name="17296"/>17296: <i>%%         {error, Reason} -&gt;</i>
<a name="17297"/>17297: <i>%%             Reason</i>
<a name="17298"/>17298: <i>%%     end.</i>
<a name="17299"/>17299: 
<a name="17300"/>17300: <i>%% api_opt_sock_peercred_tcp_client_connect(Domain, Proto, ServerSA) -&gt;</i>
<a name="17301"/>17301: <i>%%     LSA  = which_local_socket_addr(Domain),</i>
<a name="17302"/>17302: <i>%%     Sock = case socket:open(Domain, stream, Proto) of</i>
<a name="17303"/>17303: <i>%%                {ok, S} -&gt;</i>
<a name="17304"/>17304: <i>%%                    S;</i>
<a name="17305"/>17305: <i>%%                {error, OReason} -&gt;</i>
<a name="17306"/>17306: <i>%%                    ?FAIL({open, OReason})</i>
<a name="17307"/>17307: <i>%%            end,</i>
<a name="17308"/>17308: <i>%%     case socket:bind(Sock, LSA) of</i>
<a name="17309"/>17309: <i>%%         ok -&gt;</i>
<a name="17310"/>17310: <i>%%             ok;</i>
<a name="17311"/>17311: <i>%%         {error, BReason} -&gt;</i>
<a name="17312"/>17312: <i>%%             (catch socket:close(Sock)),</i>
<a name="17313"/>17313: <i>%%             ?FAIL({bind, BReason})</i>
<a name="17314"/>17314: <i>%%     end,</i>
<a name="17315"/>17315: <i>%%     case socket:connect(Sock, ServerSA) of</i>
<a name="17316"/>17316: <i>%%         ok -&gt;</i>
<a name="17317"/>17317: <i>%%             {ok, Sock};</i>
<a name="17318"/>17318: <i>%%         {error, Reason} -&gt;</i>
<a name="17319"/>17319: <i>%%             (catch socket:close(Sock)),</i>
<a name="17320"/>17320: <i>%%             ?FAIL({connect, Reason})</i>
<a name="17321"/>17321: <i>%%     end.</i>
<a name="17322"/>17322: 
<a name="17323"/>17323: <i>%% api_opt_sock_peercred_tcp_client_close({ok, Sock}) -&gt;</i>
<a name="17324"/>17324: <i>%%     (catch socket:close(Sock));</i>
<a name="17325"/>17325: <i>%% api_opt_sock_peercred_tcp_client_close(_) -&gt;</i>
<a name="17326"/>17326: <i>%%     ok.</i>
<a name="17327"/>17327: 
<a name="17328"/>17328: 
<a name="17329"/>17329: 
<a name="17330"/>17330: 
<a name="17331"/>17331: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17332"/>17332: 
<a name="17333"/>17333: <i>%% Tests the 'PRIORITY' socket 'socket' option with IPv4 UDP:</i>
<a name="17334"/>17334: <i>%%</i>
<a name="17335"/>17335: <i>%%               socket:setopt(Sock, socket, priority, integer()).</i>
<a name="17336"/>17336: <i>%%</i>
<a name="17337"/>17337: <i>%%</i>
<a name="17338"/>17338: 
<a name="api_opt_sock_priority_udp4-1"/><a name="17339"/>17339: <b>api_opt_sock_priority_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17340"/>17340:     ?TT(?SECS(5)),
<a name="api_opt_sock_priority_udp4-last_expr"/><a name="17341"/>17341: <b>    tc_try</b>(api_opt_sock_priority_udp4,
<a name="17342"/>17342:            fun() -&gt; has_support_ipv4(), has_support_sock_priority() end,
<a name="17343"/>17343:            fun() -&gt;
<a name="17344"/>17344:                    Set  = fun(Sock, Value) -&gt;
<a name="17345"/>17345:                                   socket:setopt(Sock, socket, priority, Value)
<a name="17346"/>17346:                           end,
<a name="17347"/>17347:                    Get  = fun(Sock) -&gt;
<a name="17348"/>17348:                                   socket:getopt(Sock, socket, priority)
<a name="17349"/>17349:                           end,
<a name="17350"/>17350:                    InitState = #{domain =&gt; inet,
<a name="17351"/>17351:                                  type   =&gt; dgram,
<a name="17352"/>17352:                                  proto  =&gt; udp,
<a name="17353"/>17353:                                  set    =&gt; Set,
<a name="17354"/>17354:                                  get    =&gt; Get},
<a name="17355"/>17355:                    ok = api_opt_sock_priority(InitState)
<a name="17356"/>17356:            end).
<a name="17357"/>17357: 
<a name="17358"/>17358: 
<a name="17359"/>17359: 
<a name="17360"/>17360: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17361"/>17361: 
<a name="17362"/>17362: <i>%% Tests the 'PRIORITY' socket 'socket' option with IPv4 TCP:</i>
<a name="17363"/>17363: <i>%%</i>
<a name="17364"/>17364: <i>%%               socket:setopt(Sock, socket, priority, integer()).</i>
<a name="17365"/>17365: <i>%%</i>
<a name="17366"/>17366: <i>%%</i>
<a name="17367"/>17367: 
<a name="api_opt_sock_priority_tcp4-1"/><a name="17368"/>17368: <b>api_opt_sock_priority_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17369"/>17369:     ?TT(?SECS(5)),
<a name="api_opt_sock_priority_tcp4-last_expr"/><a name="17370"/>17370: <b>    tc_try</b>(api_opt_sock_priority_tcp4,
<a name="17371"/>17371:            fun() -&gt; has_support_ipv4(), has_support_sock_priority() end,
<a name="17372"/>17372:            fun() -&gt;
<a name="17373"/>17373:                    Set  = fun(Sock, Value) -&gt;
<a name="17374"/>17374:                                   socket:setopt(Sock, socket, priority, Value)
<a name="17375"/>17375:                           end,
<a name="17376"/>17376:                    Get  = fun(Sock) -&gt;
<a name="17377"/>17377:                                   socket:getopt(Sock, socket, priority)
<a name="17378"/>17378:                           end,
<a name="17379"/>17379:                    InitState = #{domain =&gt; inet,
<a name="17380"/>17380:                                  type   =&gt; stream,
<a name="17381"/>17381:                                  proto  =&gt; tcp,
<a name="17382"/>17382:                                  set    =&gt; Set,
<a name="17383"/>17383:                                  get    =&gt; Get},
<a name="17384"/>17384:                    ok = api_opt_sock_priority(InitState)
<a name="17385"/>17385:            end).
<a name="17386"/>17386: 
<a name="17387"/>17387: 
<a name="17388"/>17388: 
<a name="17389"/>17389: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17390"/>17390: 
<a name="api_opt_sock_priority-1"/><a name="17391"/>17391: <b>api_opt_sock_priority</b>(InitState) -&gt;
<a name="17392"/>17392:     Seq = 
<a name="17393"/>17393:         [
<a name="17394"/>17394:          #{desc =&gt; &quot;local address&quot;,
<a name="17395"/>17395:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17396"/>17396:                            LSA = which_local_socket_addr(Domain),
<a name="17397"/>17397:                            {ok, State#{lsa =&gt; LSA}}
<a name="17398"/>17398:                    end},
<a name="17399"/>17399: 
<a name="17400"/>17400:          #{desc =&gt; &quot;open socket&quot;,
<a name="17401"/>17401:            cmd  =&gt; fun(#{domain := Domain,
<a name="17402"/>17402:                          type   := Type,
<a name="17403"/>17403:                          proto  := Proto} = State) -&gt;
<a name="17404"/>17404:                            Sock = sock_open(Domain, Type, Proto),
<a name="17405"/>17405:                            {ok, State#{sock =&gt; Sock}}
<a name="17406"/>17406:                    end},
<a name="17407"/>17407:          #{desc =&gt; &quot;bind&quot;,
<a name="17408"/>17408:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="17409"/>17409:                            case sock_bind(Sock, LSA) of
<a name="17410"/>17410:                                ok -&gt;
<a name="17411"/>17411:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="17412"/>17412:                                    ok;
<a name="17413"/>17413:                                {error, Reason} = ERROR -&gt;
<a name="17414"/>17414:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="17415"/>17415:                                    ERROR
<a name="17416"/>17416:                            end
<a name="17417"/>17417:                    end},
<a name="17418"/>17418:          #{desc =&gt; &quot;get current (default) priority&quot;,
<a name="17419"/>17419:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="17420"/>17420:                            case Get(Sock) of
<a name="17421"/>17421:                                {ok, Prio} -&gt;
<a name="17422"/>17422:                                    ?SEV_IPRINT(&quot;(default) priority: ~p&quot;,
<a name="17423"/>17423:                                                [Prio]),
<a name="17424"/>17424:                                    {ok, State#{default =&gt; Prio}};
<a name="17425"/>17425:                                {error, Reason} = ERROR -&gt;
<a name="17426"/>17426:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="17427"/>17427:                                                &quot;priority:&quot;
<a name="17428"/>17428:                                                &quot;   ~p&quot;, [Reason]),
<a name="17429"/>17429:                                    ERROR
<a name="17430"/>17430:                            end
<a name="17431"/>17431:                    end},
<a name="17432"/>17432: 
<a name="17433"/>17433:          #{desc =&gt; &quot;change priority (to within non-root range)&quot;,
<a name="17434"/>17434:            cmd  =&gt; fun(#{sock    := Sock,
<a name="17435"/>17435:                          default := DefaultPrio,
<a name="17436"/>17436:                          set     := Set} = _State) -&gt;
<a name="17437"/>17437:                            NewPrio =
<a name="17438"/>17438:                                if
<a name="17439"/>17439:                                    (DefaultPrio =&lt; 0) andalso
<a name="17440"/>17440:                                    (DefaultPrio &lt; 6) -&gt;
<a name="17441"/>17441:                                        DefaultPrio+1;
<a name="17442"/>17442:                                    (DefaultPrio =:= 6) -&gt;
<a name="17443"/>17443:                                        DefaultPrio-1;
<a name="17444"/>17444:                                    true -&gt;
<a name="17445"/>17445:                                        3 % ...
<a name="17446"/>17446:                                end,
<a name="17447"/>17447:                            ?SEV_IPRINT(&quot;try set new priority (to ~p)&quot;,
<a name="17448"/>17448:                                        [NewPrio]),
<a name="17449"/>17449:                            case Set(Sock, NewPrio) of
<a name="17450"/>17450:                                ok -&gt;
<a name="17451"/>17451:                                    ?SEV_IPRINT(&quot;priority changed (to ~p)&quot;,
<a name="17452"/>17452:                                                [NewPrio]),
<a name="17453"/>17453:                                    ok;
<a name="17454"/>17454:                                {error, Reason} = ERROR -&gt;
<a name="17455"/>17455:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="17456"/>17456:                                                &quot;   ~p&quot;, [Reason]),
<a name="17457"/>17457:                                    ERROR
<a name="17458"/>17458:                            end
<a name="17459"/>17459:                    end},
<a name="17460"/>17460: 
<a name="17461"/>17461:          #{desc =&gt; &quot;change priority (to outside root-range)&quot;,
<a name="17462"/>17462:            cmd  =&gt; fun(#{sock := Sock,
<a name="17463"/>17463:                          set  := Set} = _State) -&gt;
<a name="17464"/>17464:                            NewPrio = 42,
<a name="17465"/>17465:                            ?SEV_IPRINT(&quot;try set new priority (to ~p)&quot;,
<a name="17466"/>17466:                                        [NewPrio]),
<a name="17467"/>17467:                            case Set(Sock, NewPrio) of
<a name="17468"/>17468:                                ok -&gt;
<a name="17469"/>17469:                                    ?SEV_IPRINT(&quot;priority changed (to ~p)&quot;,
<a name="17470"/>17470:                                                [NewPrio]),
<a name="17471"/>17471:                                    ok;
<a name="17472"/>17472:                                {error, eperm} -&gt;
<a name="17473"/>17473:                                    ?SEV_IPRINT(&quot;priority change not allowed&quot;),
<a name="17474"/>17474:                                    ok;
<a name="17475"/>17475:                                {error, Reason} = ERROR -&gt;
<a name="17476"/>17476:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="17477"/>17477:                                                &quot;   ~p&quot;, [Reason]),
<a name="17478"/>17478:                                    ERROR
<a name="17479"/>17479:                            end
<a name="17480"/>17480:                    end},
<a name="17481"/>17481: 
<a name="17482"/>17482:          #{desc =&gt; &quot;close socket&quot;,
<a name="17483"/>17483:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="17484"/>17484:                            ok = socket:close(Sock),
<a name="17485"/>17485:                            {ok, maps:remove(sock, State)}
<a name="17486"/>17486:                    end},
<a name="17487"/>17487: 
<a name="17488"/>17488:          %% *** We are done ***
<a name="17489"/>17489:          ?SEV_FINISH_NORMAL
<a name="17490"/>17490:         ],
<a name="17491"/>17491:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_priority-last_expr"/><a name="17492"/>17492: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="17493"/>17493: 
<a name="17494"/>17494: 
<a name="17495"/>17495: 
<a name="17496"/>17496: 
<a name="17497"/>17497: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17498"/>17498: 
<a name="17499"/>17499: <i>%% Tests the 'SNDBUF' socket 'socket' option with IPv4 UDP:</i>
<a name="17500"/>17500: <i>%%</i>
<a name="17501"/>17501: <i>%%               socket:setopt(Sock, socket, sndbuf, integer()).</i>
<a name="17502"/>17502: <i>%%</i>
<a name="17503"/>17503: <i>%%</i>
<a name="17504"/>17504: 
<a name="api_opt_sock_rcvbuf_udp4-1"/><a name="17505"/>17505: <b>api_opt_sock_rcvbuf_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17506"/>17506:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvbuf_udp4-last_expr"/><a name="17507"/>17507: <b>    tc_try</b>(api_opt_sock_rcvbuf_udp4,
<a name="17508"/>17508:            fun() -&gt; has_support_ipv4(), has_support_sock_rcvbuf() end,
<a name="17509"/>17509:            fun() -&gt;
<a name="17510"/>17510:                    ok = api_opt_sock_buf_udp4(rcvbuf)
<a name="17511"/>17511:            end).
<a name="17512"/>17512: 
<a name="17513"/>17513: 
<a name="17514"/>17514: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17515"/>17515: 
<a name="17516"/>17516: <i>%% Tests the 'RCVBUF' socket 'socket' option with IPv4 UDP:</i>
<a name="17517"/>17517: <i>%%</i>
<a name="17518"/>17518: <i>%%               socket:setopt(Sock, socket, rcvbuf, integer()).</i>
<a name="17519"/>17519: <i>%%</i>
<a name="17520"/>17520: <i>%%</i>
<a name="17521"/>17521: 
<a name="api_opt_sock_sndbuf_udp4-1"/><a name="17522"/>17522: <b>api_opt_sock_sndbuf_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17523"/>17523:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndbuf_udp4-last_expr"/><a name="17524"/>17524: <b>    tc_try</b>(api_opt_sock_sndbuf_udp4,
<a name="17525"/>17525:            fun() -&gt; has_support_ipv4(), has_support_sock_sndbuf() end,
<a name="17526"/>17526:            fun() -&gt;
<a name="17527"/>17527:                    ok = api_opt_sock_buf_udp4(sndbuf)
<a name="17528"/>17528:            end).
<a name="17529"/>17529: 
<a name="17530"/>17530: 
<a name="17531"/>17531: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17532"/>17532: 
<a name="api_opt_sock_buf_udp4-1"/><a name="17533"/>17533: <b>api_opt_sock_buf_udp4</b>(Opt) -&gt;
<a name="17534"/>17534:     Set  = fun(Sock, Value) -&gt;
<a name="17535"/>17535:                    socket:setopt(Sock, socket, Opt, Value)
<a name="17536"/>17536:            end,
<a name="17537"/>17537:     Get  = fun(Sock) -&gt;
<a name="17538"/>17538:                    socket:getopt(Sock, socket, Opt)
<a name="17539"/>17539:            end,
<a name="17540"/>17540:     InitState = #{domain =&gt; inet,
<a name="17541"/>17541:                   type   =&gt; dgram,
<a name="17542"/>17542:                   proto  =&gt; udp,
<a name="17543"/>17543:                   set    =&gt; Set,
<a name="17544"/>17544:                   get    =&gt; Get},
<a name="api_opt_sock_buf_udp4-last_expr"/><a name="17545"/>17545: <b>    ok = api_opt_sock_buf</b>(InitState).
<a name="17546"/>17546: 
<a name="17547"/>17547: 
<a name="api_opt_sock_buf-1"/><a name="17548"/>17548: <b>api_opt_sock_buf</b>(InitState) -&gt;
<a name="17549"/>17549:     Seq = 
<a name="17550"/>17550:         [
<a name="17551"/>17551:          #{desc =&gt; &quot;local address&quot;,
<a name="17552"/>17552:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17553"/>17553:                            LSA = which_local_socket_addr(Domain),
<a name="17554"/>17554:                            {ok, State#{lsa =&gt; LSA}}
<a name="17555"/>17555:                    end},
<a name="17556"/>17556: 
<a name="17557"/>17557:          #{desc =&gt; &quot;open socket&quot;,
<a name="17558"/>17558:            cmd  =&gt; fun(#{domain := Domain,
<a name="17559"/>17559:                          type   := Type,
<a name="17560"/>17560:                          proto  := Proto} = State) -&gt;
<a name="17561"/>17561:                            Sock = sock_open(Domain, Type, Proto),
<a name="17562"/>17562:                            {ok, State#{sock =&gt; Sock}}
<a name="17563"/>17563:                    end},
<a name="17564"/>17564:          #{desc =&gt; &quot;bind&quot;,
<a name="17565"/>17565:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="17566"/>17566:                            case sock_bind(Sock, LSA) of
<a name="17567"/>17567:                                ok -&gt;
<a name="17568"/>17568:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="17569"/>17569:                                    ok;
<a name="17570"/>17570:                                {error, Reason} = ERROR -&gt;
<a name="17571"/>17571:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="17572"/>17572:                                    ERROR
<a name="17573"/>17573:                            end
<a name="17574"/>17574:                    end},
<a name="17575"/>17575:          #{desc =&gt; &quot;get current (default) buffer size&quot;,
<a name="17576"/>17576:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="17577"/>17577:                            case Get(Sock) of
<a name="17578"/>17578:                                {ok, Sz} -&gt;
<a name="17579"/>17579:                                    ?SEV_IPRINT(&quot;(default) buffer: ~p&quot;,
<a name="17580"/>17580:                                                [Sz]),
<a name="17581"/>17581:                                    {ok, State#{default_sz =&gt; Sz}};
<a name="17582"/>17582:                                {error, Reason} = ERROR -&gt;
<a name="17583"/>17583:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="17584"/>17584:                                                &quot;buffer size:&quot;
<a name="17585"/>17585:                                                &quot;   ~p&quot;, [Reason]),
<a name="17586"/>17586:                                    ERROR
<a name="17587"/>17587:                            end
<a name="17588"/>17588:                    end},
<a name="17589"/>17589: 
<a name="17590"/>17590:          #{desc =&gt; &quot;change buffer size (default + 1024)&quot;,
<a name="17591"/>17591:            cmd  =&gt; fun(#{sock       := Sock,
<a name="17592"/>17592:                          default_sz := DefaultSz,
<a name="17593"/>17593:                          set        := Set} = State) -&gt;
<a name="17594"/>17594:                            NewSz = DefaultSz + 1024,
<a name="17595"/>17595:                            ?SEV_IPRINT(&quot;try set new buffer size to ~w&quot;, [NewSz]),
<a name="17596"/>17596:                            case Set(Sock, NewSz) of
<a name="17597"/>17597:                                ok -&gt;
<a name="17598"/>17598:                                    ?SEV_IPRINT(&quot;Buffer size change success&quot;, []),
<a name="17599"/>17599:                                    {ok, State#{new_sz =&gt; NewSz}};
<a name="17600"/>17600:                                {error, Reason} = ERROR -&gt;
<a name="17601"/>17601:                                    ?SEV_EPRINT(&quot;Failed changing buffer size:&quot;
<a name="17602"/>17602:                                                &quot;   ~p&quot;, [Reason]),
<a name="17603"/>17603:                                    ERROR
<a name="17604"/>17604:                            end
<a name="17605"/>17605:                    end},
<a name="17606"/>17606: 
<a name="17607"/>17607:          #{desc =&gt; &quot;validate buffer change&quot;,
<a name="17608"/>17608:            cmd  =&gt; fun(#{sock   := Sock,
<a name="17609"/>17609:                          get    := Get,
<a name="17610"/>17610:                          new_sz := ExpSz} = _State) -&gt;
<a name="17611"/>17611:                            ?SEV_IPRINT(&quot;try validate buffer size (~w)&quot;, [ExpSz]),
<a name="17612"/>17612:                            case Get(Sock) of
<a name="17613"/>17613:                                {ok, Sz} when (Sz &gt;= ExpSz) -&gt;
<a name="17614"/>17614:                                    ?SEV_IPRINT(&quot;buffer size validated:&quot;
<a name="17615"/>17615:                                                &quot;~n   Sz: ~w (~w)&quot;, [Sz, ExpSz]),
<a name="17616"/>17616:                                    ok;
<a name="17617"/>17617:                                {ok, Sz} -&gt;
<a name="17618"/>17618:                                    ?SEV_EPRINT(&quot;buffer size invalid:&quot;
<a name="17619"/>17619:                                                &quot;~n   Sz:          ~w&quot;
<a name="17620"/>17620:                                                &quot;~n   Expected Sz: ~w&quot;, [Sz, ExpSz]),
<a name="17621"/>17621:                                    {error, {invalid_size, Sz, ExpSz}};
<a name="17622"/>17622:                                {error, Reason} = ERROR -&gt;
<a name="17623"/>17623:                                    ?SEV_EPRINT(&quot;Failed get buffer size:&quot;
<a name="17624"/>17624:                                                &quot;   ~p&quot;, [Reason]),
<a name="17625"/>17625:                                    ERROR
<a name="17626"/>17626:                            end
<a name="17627"/>17627:                    end},
<a name="17628"/>17628: 
<a name="17629"/>17629:          #{desc =&gt; &quot;close socket&quot;,
<a name="17630"/>17630:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="17631"/>17631:                            ok = socket:close(Sock),
<a name="17632"/>17632:                            {ok, maps:remove(sock, State)}
<a name="17633"/>17633:                    end},
<a name="17634"/>17634: 
<a name="17635"/>17635:          %% *** We are done ***
<a name="17636"/>17636:          ?SEV_FINISH_NORMAL
<a name="17637"/>17637:         ],
<a name="17638"/>17638:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_buf-last_expr"/><a name="17639"/>17639: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="17640"/>17640: 
<a name="17641"/>17641: 
<a name="17642"/>17642: 
<a name="17643"/>17643: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17644"/>17644: 
<a name="17645"/>17645: <i>%% Tests the 'RCVTIMEO' socket 'socket' option with IPv4 UDP:</i>
<a name="17646"/>17646: <i>%%</i>
<a name="17647"/>17647: <i>%%               socket:setopt(Sock, socket, rcvtimeo, #{sec  =&gt; integer(),</i>
<a name="17648"/>17648: <i>%%                                                       usec =&gt; integer()}).</i>
<a name="17649"/>17649: <i>%%</i>
<a name="17650"/>17650: <i>%% We should really test that the receive behaves as expected,</i>
<a name="17651"/>17651: <i>%% but we don't (we just set the value and read it back...)</i>
<a name="17652"/>17652: <i>%%</i>
<a name="17653"/>17653: 
<a name="api_opt_sock_rcvtimeo_udp4-1"/><a name="17654"/>17654: <b>api_opt_sock_rcvtimeo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17655"/>17655:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvtimeo_udp4-last_expr"/><a name="17656"/>17656: <b>    tc_try</b>(api_opt_sock_rcvtimeo_udp4,
<a name="17657"/>17657:            fun() -&gt; has_support_ipv4(), has_support_sock_rcvtimeo() end,
<a name="17658"/>17658:            fun() -&gt;
<a name="17659"/>17659:                    ok = api_opt_sock_timeo_udp4(rcvtimeo)
<a name="17660"/>17660:            end).
<a name="17661"/>17661: 
<a name="17662"/>17662: 
<a name="17663"/>17663: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17664"/>17664: 
<a name="17665"/>17665: <i>%% Tests the 'SNDTIMEO' socket 'socket' option with IPv4 UDP:</i>
<a name="17666"/>17666: <i>%%</i>
<a name="17667"/>17667: <i>%%               socket:setopt(Sock, socket, sndtimeo, integer()).</i>
<a name="17668"/>17668: <i>%%</i>
<a name="17669"/>17669: <i>%%</i>
<a name="17670"/>17670: 
<a name="api_opt_sock_sndtimeo_udp4-1"/><a name="17671"/>17671: <b>api_opt_sock_sndtimeo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17672"/>17672:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndtimeo_udp4-last_expr"/><a name="17673"/>17673: <b>    tc_try</b>(api_opt_sock_sndtimeo_udp4,
<a name="17674"/>17674:            fun() -&gt; has_support_ipv4(), has_support_sock_sndtimeo() end,
<a name="17675"/>17675:            fun() -&gt;
<a name="17676"/>17676:                    ok = api_opt_sock_timeo_udp4(sndtimeo)
<a name="17677"/>17677:            end).
<a name="17678"/>17678: 
<a name="17679"/>17679: 
<a name="17680"/>17680: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17681"/>17681: 
<a name="api_opt_sock_timeo_udp4-1"/><a name="17682"/>17682: <b>api_opt_sock_timeo_udp4</b>(Opt) -&gt;
<a name="17683"/>17683:     Set  = fun(Sock, Value) -&gt;
<a name="17684"/>17684:                    socket:setopt(Sock, socket, Opt, Value)
<a name="17685"/>17685:            end,
<a name="17686"/>17686:     Get  = fun(Sock) -&gt;
<a name="17687"/>17687:                    socket:getopt(Sock, socket, Opt)
<a name="17688"/>17688:            end,
<a name="17689"/>17689:     InitState = #{domain =&gt; inet,
<a name="17690"/>17690:                   type   =&gt; dgram,
<a name="17691"/>17691:                   proto  =&gt; udp,
<a name="17692"/>17692: 		  opt   =&gt; Opt,
<a name="17693"/>17693:                   set    =&gt; Set,
<a name="17694"/>17694:                   get    =&gt; Get},
<a name="api_opt_sock_timeo_udp4-last_expr"/><a name="17695"/>17695: <b>    ok = api_opt_sock_timeo</b>(InitState).
<a name="17696"/>17696: 
<a name="17697"/>17697: 
<a name="api_opt_sock_timeo-1"/><a name="17698"/>17698: <b>api_opt_sock_timeo</b>(InitState) -&gt;
<a name="17699"/>17699:     Seq = 
<a name="17700"/>17700:         [
<a name="17701"/>17701:          #{desc =&gt; &quot;local address&quot;,
<a name="17702"/>17702:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17703"/>17703:                            LSA = which_local_socket_addr(Domain),
<a name="17704"/>17704:                            {ok, State#{lsa =&gt; LSA}}
<a name="17705"/>17705:                    end},
<a name="17706"/>17706: 
<a name="17707"/>17707:          #{desc =&gt; &quot;open socket&quot;,
<a name="17708"/>17708:            cmd  =&gt; fun(#{domain := Domain,
<a name="17709"/>17709:                          type   := Type,
<a name="17710"/>17710:                          proto  := Proto} = State) -&gt;
<a name="17711"/>17711:                            Sock = sock_open(Domain, Type, Proto),
<a name="17712"/>17712:                            {ok, State#{sock =&gt; Sock}}
<a name="17713"/>17713:                    end},
<a name="17714"/>17714:          #{desc =&gt; &quot;bind&quot;,
<a name="17715"/>17715:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="17716"/>17716:                            case sock_bind(Sock, LSA) of
<a name="17717"/>17717:                                ok -&gt;
<a name="17718"/>17718:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="17719"/>17719:                                    ok;
<a name="17720"/>17720:                                {error, Reason} = ERROR -&gt;
<a name="17721"/>17721:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="17722"/>17722:                                    ERROR
<a name="17723"/>17723:                            end
<a name="17724"/>17724:                    end},
<a name="17725"/>17725:          #{desc =&gt; &quot;get current (default) timeout&quot;,
<a name="17726"/>17726:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="17727"/>17727:                            case Get(Sock) of
<a name="17728"/>17728:                                {ok, #{sec := _, usec := _} = TO} -&gt;
<a name="17729"/>17729:                                    ?SEV_IPRINT(&quot;(default) timeout: ~p&quot;, [TO]),
<a name="17730"/>17730:                                    {ok, State#{default_timeo =&gt; TO}};
<a name="17731"/>17731:                                {error, enoprotoopt = Reason} -&gt;
<a name="17732"/>17732:                                    ?SEV_IPRINT(&quot;Failed getting (default) timeout:&quot;
<a name="17733"/>17733:                                                &quot;   ~p&quot;, [Reason]),
<a name="17734"/>17734:                                    {skip, Reason};
<a name="17735"/>17735:                                {error, Reason} = ERROR -&gt;
<a name="17736"/>17736:                                    ?SEV_EPRINT(&quot;Failed getting (default) timeout:&quot;
<a name="17737"/>17737:                                                &quot;   ~p&quot;, [Reason]),
<a name="17738"/>17738:                                    ERROR
<a name="17739"/>17739:                            end
<a name="17740"/>17740:                    end},
<a name="17741"/>17741: 
<a name="17742"/>17742:          #{desc =&gt; &quot;change timeout&quot;,
<a name="17743"/>17743:            cmd  =&gt; fun(#{sock          := Sock,
<a name="17744"/>17744:                          default_timeo := #{sec := DefaultSec} = DefaultTO,
<a name="17745"/>17745:                          set           := Set} = State) -&gt;
<a name="17746"/>17746:                            NewTO = DefaultTO#{sec =&gt; DefaultSec + 100},
<a name="17747"/>17747:                            ?SEV_IPRINT(&quot;try set new timeout to ~w&quot;, [NewTO]),
<a name="17748"/>17748:                            case Set(Sock, NewTO) of
<a name="17749"/>17749:                                ok -&gt;
<a name="17750"/>17750:                                    ?SEV_IPRINT(&quot;Timeout change success&quot;, []),
<a name="17751"/>17751:                                    {ok, State#{new_timeo =&gt; NewTO}};
<a name="17752"/>17752:                                {error, Reason} = ERROR -&gt;
<a name="17753"/>17753:                                    ?SEV_EPRINT(&quot;Failed changing timeout:&quot;
<a name="17754"/>17754:                                                &quot;   ~p&quot;, [Reason]),
<a name="17755"/>17755:                                    ERROR
<a name="17756"/>17756:                            end
<a name="17757"/>17757:                    end},
<a name="17758"/>17758: 
<a name="17759"/>17759:          #{desc =&gt; &quot;validate timeout change&quot;,
<a name="17760"/>17760:            cmd  =&gt; fun(#{sock      := Sock,
<a name="17761"/>17761:                          get       := Get,
<a name="17762"/>17762:                          new_timeo := #{sec := ExpSec} = ExpTO} = _State) -&gt;
<a name="17763"/>17763:                            ?SEV_IPRINT(&quot;try validate timeout (~w)&quot;, [ExpTO]),
<a name="17764"/>17764:                            case Get(Sock) of
<a name="17765"/>17765:                                {ok, ExpTO} -&gt;
<a name="17766"/>17766:                                    ?SEV_IPRINT(&quot;timeout (exactly) validated&quot;),
<a name="17767"/>17767:                                    ok;
<a name="17768"/>17768:                                {ok, #{sec := Sec}} when (ExpSec =:= Sec) -&gt;
<a name="17769"/>17769: 				   %% For some reason OpenBSD &quot;adjusts&quot; the timeout,
<a name="17770"/>17770: 				   %% so that usec does not (always match)
<a name="17771"/>17771:                                    ?SEV_IPRINT(&quot;timeout (approx) validated&quot;),
<a name="17772"/>17772:                                    ok;
<a name="17773"/>17773:                                {ok, TO} -&gt;
<a name="17774"/>17774:                                    ?SEV_EPRINT(&quot;timeout invalid:&quot;
<a name="17775"/>17775:                                                &quot;~n   Timeout:          ~w&quot;
<a name="17776"/>17776:                                                &quot;~n   Expected Timeout: ~w&quot;,
<a name="17777"/>17777:                                                [TO, ExpTO]),
<a name="17778"/>17778:                                    {error, {invalid_timeo, TO, ExpTO}};
<a name="17779"/>17779:                                {error, edom = Reason} -&gt;
<a name="17780"/>17780: 				   %% On OpenBSD (at least) its possible that if the value
<a name="17781"/>17781: 				   %% is too far &quot;out of bounds&quot;, this will be the result:
<a name="17782"/>17782: 				   %%
<a name="17783"/>17783: 				   %%     &quot;Numerical argument out of domain&quot;
<a name="17784"/>17784: 				   %%
<a name="17785"/>17785:                                    ?SEV_IPRINT(&quot;Failed get timeout:&quot;
<a name="17786"/>17786:                                                &quot;   ~p&quot;, [Reason]),
<a name="17787"/>17787:                                    {skip, Reason};
<a name="17788"/>17788:                                {error, Reason} = ERROR -&gt;
<a name="17789"/>17789:                                    ?SEV_EPRINT(&quot;Failed get timeout:&quot;
<a name="17790"/>17790:                                                &quot;   ~p&quot;, [Reason]),
<a name="17791"/>17791:                                    ERROR
<a name="17792"/>17792:                            end
<a name="17793"/>17793:                    end},
<a name="17794"/>17794: 
<a name="17795"/>17795:          #{desc =&gt; &quot;close socket&quot;,
<a name="17796"/>17796:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="17797"/>17797:                            ok = socket:close(Sock),
<a name="17798"/>17798:                            {ok, maps:remove(sock, State)}
<a name="17799"/>17799:                    end},
<a name="17800"/>17800: 
<a name="17801"/>17801:          %% *** We are done ***
<a name="17802"/>17802:          ?SEV_FINISH_NORMAL
<a name="17803"/>17803:         ],
<a name="17804"/>17804:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_timeo-last_expr"/><a name="17805"/>17805: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="17806"/>17806: 
<a name="17807"/>17807: 
<a name="17808"/>17808: 
<a name="17809"/>17809: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17810"/>17810: 
<a name="17811"/>17811: <i>%% Tests the 'RCVLOWAT' socket 'socket' option with IPv4 UDP:</i>
<a name="17812"/>17812: <i>%%</i>
<a name="17813"/>17813: <i>%%               socket:setopt(Sock, socket, rcvlowat, integer()).</i>
<a name="17814"/>17814: <i>%%</i>
<a name="17815"/>17815: <i>%%</i>
<a name="17816"/>17816: 
<a name="api_opt_sock_rcvlowat_udp4-1"/><a name="17817"/>17817: <b>api_opt_sock_rcvlowat_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17818"/>17818:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvlowat_udp4-last_expr"/><a name="17819"/>17819: <b>    tc_try</b>(api_opt_sock_rcvlowat_udp4,
<a name="17820"/>17820:            fun() -&gt;
<a name="17821"/>17821:                    is_not_windows(), % einval on Windows
<a name="17822"/>17822:                    has_support_ipv4(),
<a name="17823"/>17823:                    has_support_sock_rcvlowat()
<a name="17824"/>17824:            end,
<a name="17825"/>17825:            fun() -&gt;
<a name="17826"/>17826:                    ok = api_opt_sock_lowat_udp4(rcvlowat)
<a name="17827"/>17827:            end).
<a name="17828"/>17828: 
<a name="17829"/>17829: 
<a name="17830"/>17830: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17831"/>17831: 
<a name="17832"/>17832: <i>%% Tests the 'SNDLOWAT' socket 'socket' option with IPv4 UDP:</i>
<a name="17833"/>17833: <i>%%</i>
<a name="17834"/>17834: <i>%%               socket:setopt(Sock, socket, sndlowat, integer()).</i>
<a name="17835"/>17835: <i>%%</i>
<a name="17836"/>17836: <i>%% This is (currently) not changeable on linux (among others),</i>
<a name="17837"/>17837: <i>%% so we skip if we get ENOPROTOOPT when attempting a change.</i>
<a name="17838"/>17838: <i>%%</i>
<a name="17839"/>17839: 
<a name="api_opt_sock_sndlowat_udp4-1"/><a name="17840"/>17840: <b>api_opt_sock_sndlowat_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17841"/>17841:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndlowat_udp4-last_expr"/><a name="17842"/>17842: <b>    tc_try</b>(api_opt_sock_sndlowat_udp4,
<a name="17843"/>17843:            fun() -&gt;
<a name="17844"/>17844:                    is_not_windows(), % einval on Windows
<a name="17845"/>17845:                    has_support_ipv4(),
<a name="17846"/>17846:                    has_support_sock_sndlowat()
<a name="17847"/>17847:            end,
<a name="17848"/>17848:            fun() -&gt;
<a name="17849"/>17849:                    ok = api_opt_sock_lowat_udp4(sndlowat)
<a name="17850"/>17850:            end).
<a name="17851"/>17851: 
<a name="17852"/>17852: 
<a name="17853"/>17853: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17854"/>17854: 
<a name="api_opt_sock_lowat_udp4-1"/><a name="17855"/>17855: <b>api_opt_sock_lowat_udp4</b>(Opt) -&gt;
<a name="17856"/>17856:     Set  = fun(Sock, Value) -&gt;
<a name="17857"/>17857:                    socket:setopt(Sock, socket, Opt, Value)
<a name="17858"/>17858:            end,
<a name="17859"/>17859:     Get  = fun(Sock) -&gt;
<a name="17860"/>17860:                    socket:getopt(Sock, socket, Opt)
<a name="17861"/>17861:            end,
<a name="17862"/>17862:     InitState = #{domain =&gt; inet,
<a name="17863"/>17863:                   type   =&gt; dgram,
<a name="17864"/>17864:                   proto  =&gt; udp,
<a name="17865"/>17865:                   set    =&gt; Set,
<a name="17866"/>17866:                   get    =&gt; Get},
<a name="api_opt_sock_lowat_udp4-last_expr"/><a name="17867"/>17867: <b>    ok = api_opt_sock_lowat</b>(InitState).
<a name="17868"/>17868: 
<a name="17869"/>17869: 
<a name="api_opt_sock_lowat-1"/><a name="17870"/>17870: <b>api_opt_sock_lowat</b>(InitState) -&gt;
<a name="17871"/>17871:     Seq = 
<a name="17872"/>17872:         [
<a name="17873"/>17873:          #{desc =&gt; &quot;local address&quot;,
<a name="17874"/>17874:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17875"/>17875:                            LSA = which_local_socket_addr(Domain),
<a name="17876"/>17876:                            {ok, State#{lsa =&gt; LSA}}
<a name="17877"/>17877:                    end},
<a name="17878"/>17878: 
<a name="17879"/>17879:          #{desc =&gt; &quot;open socket&quot;,
<a name="17880"/>17880:            cmd  =&gt; fun(#{domain := Domain,
<a name="17881"/>17881:                          type   := Type,
<a name="17882"/>17882:                          proto  := Proto} = State) -&gt;
<a name="17883"/>17883:                            Sock = sock_open(Domain, Type, Proto),
<a name="17884"/>17884:                            {ok, State#{sock =&gt; Sock}}
<a name="17885"/>17885:                    end},
<a name="17886"/>17886:          #{desc =&gt; &quot;bind&quot;,
<a name="17887"/>17887:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="17888"/>17888:                            case sock_bind(Sock, LSA) of
<a name="17889"/>17889:                                ok -&gt;
<a name="17890"/>17890:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="17891"/>17891:                                    ok;
<a name="17892"/>17892:                                {error, Reason} = ERROR -&gt;
<a name="17893"/>17893:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="17894"/>17894:                                    ERROR
<a name="17895"/>17895:                            end
<a name="17896"/>17896:                    end},
<a name="17897"/>17897:          #{desc =&gt; &quot;get current (default) lowat&quot;,
<a name="17898"/>17898:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="17899"/>17899:                            case Get(Sock) of
<a name="17900"/>17900:                                {ok, LOWAT} -&gt;
<a name="17901"/>17901:                                    ?SEV_IPRINT(&quot;(default) lowat: ~p&quot;,
<a name="17902"/>17902:                                                [LOWAT]),
<a name="17903"/>17903:                                    {ok, State#{default_lowat =&gt; LOWAT}};
<a name="17904"/>17904:                                {error, enoprotoopt = Reason} -&gt;
<a name="17905"/>17905:                                    ?SEV_IPRINT(&quot;Failed getting (default) lowat:&quot;
<a name="17906"/>17906:                                                &quot;   ~p&quot;, [Reason]),
<a name="17907"/>17907:                                    {skip, Reason};
<a name="17908"/>17908:                                {error, Reason} = ERROR -&gt;
<a name="17909"/>17909:                                    ?SEV_EPRINT(&quot;Failed getting (default) lowat:&quot;
<a name="17910"/>17910:                                                &quot;   ~p&quot;, [Reason]),
<a name="17911"/>17911:                                    ERROR
<a name="17912"/>17912:                            end
<a name="17913"/>17913:                    end},
<a name="17914"/>17914: 
<a name="17915"/>17915:          #{desc =&gt; &quot;change lowat ( + 1 )&quot;,
<a name="17916"/>17916:            cmd  =&gt; fun(#{sock          := Sock,
<a name="17917"/>17917:                          default_lowat := DefaultLOWAT,
<a name="17918"/>17918:                          set           := Set} = State) -&gt;
<a name="17919"/>17919:                            NewLOWAT = DefaultLOWAT + 1,
<a name="17920"/>17920:                            ?SEV_IPRINT(&quot;try set new lowat to ~w&quot;, [NewLOWAT]),
<a name="17921"/>17921:                            case Set(Sock, NewLOWAT) of
<a name="17922"/>17922:                                ok -&gt;
<a name="17923"/>17923:                                    ?SEV_IPRINT(&quot;LOWAT change success&quot;, []),
<a name="17924"/>17924:                                    {ok, State#{new_lowat =&gt; NewLOWAT}};
<a name="17925"/>17925:                                {error, enoprotoopt} -&gt;
<a name="17926"/>17926:                                    ?SEV_IPRINT(&quot;LOWAT not changeable&quot;, []),
<a name="17927"/>17927:                                    {skip, &quot;Not changeable&quot;};
<a name="17928"/>17928:                                {error, Reason} = ERROR -&gt;
<a name="17929"/>17929:                                    ?SEV_EPRINT(&quot;Failed changing buffer size:&quot;
<a name="17930"/>17930:                                                &quot;   ~p&quot;, [Reason]),
<a name="17931"/>17931:                                    ERROR
<a name="17932"/>17932:                            end
<a name="17933"/>17933:                    end},
<a name="17934"/>17934: 
<a name="17935"/>17935:          #{desc =&gt; &quot;validate lowat&quot;,
<a name="17936"/>17936:            cmd  =&gt; fun(#{sock      := Sock,
<a name="17937"/>17937:                          get       := Get,
<a name="17938"/>17938:                          new_lowat := ExpLOWAT} = _State) -&gt;
<a name="17939"/>17939:                            ?SEV_IPRINT(&quot;try validate lowat (~w)&quot;, [ExpLOWAT]),
<a name="17940"/>17940:                            case Get(Sock) of
<a name="17941"/>17941:                                {ok, ExpLOWAT} -&gt;
<a name="17942"/>17942:                                    ?SEV_IPRINT(&quot;lowat validated:&quot;
<a name="17943"/>17943:                                                &quot;~n   LOWAT: ~w&quot;, [ExpLOWAT]),
<a name="17944"/>17944:                                    ok;
<a name="17945"/>17945:                                {ok, LOWAT} -&gt;
<a name="17946"/>17946:                                    ?SEV_EPRINT(&quot;lowat invalid:&quot;
<a name="17947"/>17947:                                                &quot;~n   LOWAT:          ~w&quot;
<a name="17948"/>17948:                                                &quot;~n   Expected LOWAT: ~w&quot;,
<a name="17949"/>17949:                                                [LOWAT, ExpLOWAT]),
<a name="17950"/>17950:                                    {error, {invalid_lowat, LOWAT, ExpLOWAT}};
<a name="17951"/>17951:                                {error, Reason} = ERROR -&gt;
<a name="17952"/>17952:                                    ?SEV_EPRINT(&quot;Failed get lowat:&quot;
<a name="17953"/>17953:                                                &quot;   ~p&quot;, [Reason]),
<a name="17954"/>17954:                                    ERROR
<a name="17955"/>17955:                            end
<a name="17956"/>17956:                    end},
<a name="17957"/>17957: 
<a name="17958"/>17958:          #{desc =&gt; &quot;close socket&quot;,
<a name="17959"/>17959:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="17960"/>17960:                            ok = socket:close(Sock),
<a name="17961"/>17961:                            {ok, maps:remove(sock, State)}
<a name="17962"/>17962:                    end},
<a name="17963"/>17963: 
<a name="17964"/>17964:          %% *** We are done ***
<a name="17965"/>17965:          ?SEV_FINISH_NORMAL
<a name="17966"/>17966:         ],
<a name="17967"/>17967:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_lowat-last_expr"/><a name="17968"/>17968: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="17969"/>17969: 
<a name="17970"/>17970: 
<a name="17971"/>17971: 
<a name="17972"/>17972: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17973"/>17973: 
<a name="17974"/>17974: <i>%% Tests that the timestamp control message header is received when</i>
<a name="17975"/>17975: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="17976"/>17976: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="17977"/>17977: <i>%% So, this is done on the receiving side: </i>
<a name="17978"/>17978: <i>%%</i>
<a name="17979"/>17979: <i>%%               socket:setopt(Sock, socket, timestamp, boolean()).</i>
<a name="17980"/>17980: <i>%%</i>
<a name="17981"/>17981: <i>%% All subsequent *received* messages will be timestamped.</i>
<a name="17982"/>17982: <i>%%</i>
<a name="17983"/>17983: 
<a name="api_opt_sock_timestamp_udp4-1"/><a name="17984"/>17984: <b>api_opt_sock_timestamp_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17985"/>17985:     ?TT(?SECS(5)),
<a name="api_opt_sock_timestamp_udp4-last_expr"/><a name="17986"/>17986: <b>    tc_try</b>(api_opt_sock_timestamp_udp4,
<a name="17987"/>17987:            fun() -&gt; has_support_ipv4(), has_support_sock_timestamp() end,
<a name="17988"/>17988:            fun() -&gt;
<a name="17989"/>17989:                    Set  = fun(Sock, Value) -&gt;
<a name="17990"/>17990:                                   socket:setopt(Sock, socket, timestamp, Value)
<a name="17991"/>17991:                           end,
<a name="17992"/>17992:                    Get  = fun(Sock) -&gt;
<a name="17993"/>17993:                                   socket:getopt(Sock, socket, timestamp)
<a name="17994"/>17994:                           end,
<a name="17995"/>17995:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="17996"/>17996:                                   Msg = #{addr =&gt; Dest,
<a name="17997"/>17997:                                              iov  =&gt; [Data]},
<a name="17998"/>17998:                                   socket:sendmsg(Sock, Msg)
<a name="17999"/>17999:                           end,
<a name="18000"/>18000:                    Recv = fun(Sock) -&gt;
<a name="18001"/>18001:                                   case socket:recvmsg(Sock) of
<a name="18002"/>18002:                                       {ok, #{addr := Source,
<a name="18003"/>18003:                                              ctrl := CMsgs,
<a name="18004"/>18004:                                              iov  := [Data]}} -&gt;
<a name="18005"/>18005:                                           {ok, {Source, CMsgs, Data}};
<a name="18006"/>18006:                                       {error, _} = ERROR -&gt;
<a name="18007"/>18007:                                           ERROR
<a name="18008"/>18008:                                   end
<a name="18009"/>18009:                           end,
<a name="18010"/>18010:                    InitState = #{domain =&gt; inet,
<a name="18011"/>18011:                                  proto  =&gt; udp,
<a name="18012"/>18012:                                  send   =&gt; Send,
<a name="18013"/>18013:                                  recv   =&gt; Recv,
<a name="18014"/>18014:                                  set    =&gt; Set,
<a name="18015"/>18015:                                  get    =&gt; Get},
<a name="18016"/>18016:                    ok = api_opt_sock_timestamp_udp(InitState)
<a name="18017"/>18017:            end).
<a name="18018"/>18018: 
<a name="18019"/>18019: 
<a name="18020"/>18020: 
<a name="18021"/>18021: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18022"/>18022: 
<a name="api_opt_sock_timestamp_udp-1"/><a name="18023"/>18023: <b>api_opt_sock_timestamp_udp</b>(InitState) -&gt;
<a name="18024"/>18024:     Seq = 
<a name="18025"/>18025:         [
<a name="18026"/>18026:          #{desc =&gt; &quot;local address&quot;,
<a name="18027"/>18027:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="18028"/>18028:                            LSASrc = which_local_socket_addr(Domain),
<a name="18029"/>18029:                            LSADst = which_local_socket_addr(Domain),
<a name="18030"/>18030:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="18031"/>18031:                                        lsa_dst =&gt; LSADst}};
<a name="18032"/>18032:                       (#{domain := Domain} = State) -&gt;
<a name="18033"/>18033:                            LSA = which_local_socket_addr(Domain),
<a name="18034"/>18034:                            {ok, State#{lsa_src =&gt; LSA,
<a name="18035"/>18035:                                        lsa_dst =&gt; LSA}}
<a name="18036"/>18036:                    end},
<a name="18037"/>18037: 
<a name="18038"/>18038:          #{desc =&gt; &quot;open src socket&quot;,
<a name="18039"/>18039:            cmd  =&gt; fun(#{domain := Domain,
<a name="18040"/>18040:                          proto  := Proto} = State) -&gt;
<a name="18041"/>18041:                            Sock = sock_open(Domain, dgram, Proto),
<a name="18042"/>18042:                            {ok, State#{sock_src =&gt; Sock}}
<a name="18043"/>18043:                    end},
<a name="18044"/>18044:          #{desc =&gt; &quot;bind src&quot;,
<a name="18045"/>18045:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="18046"/>18046:                            case sock_bind(Sock, LSA) of
<a name="18047"/>18047:                                ok -&gt;
<a name="18048"/>18048:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="18049"/>18049:                                    ok;
<a name="18050"/>18050:                                {error, Reason} = ERROR -&gt;
<a name="18051"/>18051:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="18052"/>18052:                                    ERROR
<a name="18053"/>18053:                            end
<a name="18054"/>18054:                    end},
<a name="18055"/>18055:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="18056"/>18056:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="18057"/>18057:                            SASrc = sock_sockname(Sock),
<a name="18058"/>18058:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="18059"/>18059:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="18060"/>18060:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="18061"/>18061:                    end},
<a name="18062"/>18062:          #{desc =&gt; &quot;get current (default) timestamp for src socket&quot;,
<a name="18063"/>18063:            cmd  =&gt; fun(#{sock_src := Sock, get := Get} = _State) -&gt;
<a name="18064"/>18064:                            case Get(Sock) of
<a name="18065"/>18065:                                {ok, false = Value} -&gt;
<a name="18066"/>18066:                                    ?SEV_IPRINT(&quot;src timestamp: ~p&quot;, [Value]),
<a name="18067"/>18067:                                    ok;
<a name="18068"/>18068:                                {ok, Unexpected} -&gt;
<a name="18069"/>18069:                                    ?SEV_EPRINT(&quot;Unexpected src timestamp: ~p&quot;,
<a name="18070"/>18070:                                                [Unexpected]),
<a name="18071"/>18071:                                    {error, {unexpected, Unexpected}};
<a name="18072"/>18072:                                {error, Reason} = ERROR -&gt;
<a name="18073"/>18073:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="18074"/>18074:                                                &quot;   ~p&quot;, [Reason]),
<a name="18075"/>18075:                                    ERROR
<a name="18076"/>18076:                            end
<a name="18077"/>18077:                    end},
<a name="18078"/>18078: 
<a name="18079"/>18079:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="18080"/>18080:            cmd  =&gt; fun(#{domain := Domain,
<a name="18081"/>18081:                          proto  := Proto} = State) -&gt;
<a name="18082"/>18082:                            Sock = sock_open(Domain, dgram, Proto),
<a name="18083"/>18083:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="18084"/>18084:                    end},
<a name="18085"/>18085:          #{desc =&gt; &quot;bind dst&quot;,
<a name="18086"/>18086:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="18087"/>18087:                            case sock_bind(Sock, LSA) of
<a name="18088"/>18088:                                ok -&gt;
<a name="18089"/>18089:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="18090"/>18090:                                    ok;
<a name="18091"/>18091:                                {error, Reason} = ERROR -&gt;
<a name="18092"/>18092:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="18093"/>18093:                                    ERROR
<a name="18094"/>18094:                            end
<a name="18095"/>18095:                    end},
<a name="18096"/>18096:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="18097"/>18097:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="18098"/>18098:                            SADst = sock_sockname(Sock),
<a name="18099"/>18099:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="18100"/>18100:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="18101"/>18101:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="18102"/>18102:                    end},
<a name="18103"/>18103: 
<a name="18104"/>18104:          #{desc =&gt; &quot;send req (to dst) (WO TIMESTAMP)&quot;,
<a name="18105"/>18105:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="18106"/>18106:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="18107"/>18107:                    end},
<a name="18108"/>18108:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="18109"/>18109:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="18110"/>18110:                            case Recv(Sock) of
<a name="18111"/>18111:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="18112"/>18112:                                    ok;
<a name="18113"/>18113:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="18114"/>18114:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="18115"/>18115:                                                &quot;~n   Expect Source: ~p&quot;
<a name="18116"/>18116:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="18117"/>18117:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="18118"/>18118:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="18119"/>18119:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="18120"/>18120:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="18121"/>18121:                                                [Src, BadSrc,
<a name="18122"/>18122:                                                 [], BadCHdrs,
<a name="18123"/>18123:                                                 ?BASIC_REQ, BadReq]),
<a name="18124"/>18124:                                    {error, {unexpected_data, UnexpData}};
<a name="18125"/>18125:                                {ok, UnexpData} -&gt;
<a name="18126"/>18126:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="18127"/>18127:                                                &quot;~n   Expect Source: ~p&quot;
<a name="18128"/>18128:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="18129"/>18129:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="18130"/>18130:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="18131"/>18131:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="18132"/>18132:                                    {error, {unexpected_data, UnexpData}};
<a name="18133"/>18133:                                {error, _} = ERROR -&gt;
<a name="18134"/>18134:                                    %% At the moment there is no way to get
<a name="18135"/>18135:                                    %% status or state for the socket...
<a name="18136"/>18136:                                    ERROR
<a name="18137"/>18137:                            end
<a name="18138"/>18138:                    end},
<a name="18139"/>18139:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="18140"/>18140:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="18141"/>18141:                            Send(Sock, ?BASIC_REP, Src)
<a name="18142"/>18142:                    end},
<a name="18143"/>18143:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="18144"/>18144:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="18145"/>18145:                            case Recv(Sock) of
<a name="18146"/>18146:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="18147"/>18147:                                    ok;
<a name="18148"/>18148:                                {ok, UnexpData} -&gt;
<a name="18149"/>18149:                                    {error, {unexpected_data, UnexpData}};
<a name="18150"/>18150:                                {error, _} = ERROR -&gt;
<a name="18151"/>18151:                                    %% At the moment there is no way to get
<a name="18152"/>18152:                                    %% status or state for the socket...
<a name="18153"/>18153:                                    ERROR
<a name="18154"/>18154:                            end
<a name="18155"/>18155:                    end},
<a name="18156"/>18156: 
<a name="18157"/>18157: 
<a name="18158"/>18158:          #{desc =&gt; &quot;enable timestamp on dst socket&quot;,
<a name="18159"/>18159:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="18160"/>18160:                            case Set(Sock, true) of
<a name="18161"/>18161:                                ok -&gt;
<a name="18162"/>18162:                                    ?SEV_IPRINT(&quot;dst timestamp enabled&quot;),
<a name="18163"/>18163:                                    ok;
<a name="18164"/>18164:                                {error, Reason} = ERROR -&gt;
<a name="18165"/>18165:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="18166"/>18166:                                                &quot;   ~p&quot;, [Reason]),
<a name="18167"/>18167:                                    ERROR
<a name="18168"/>18168:                            end
<a name="18169"/>18169:                    end},
<a name="18170"/>18170: 
<a name="18171"/>18171: 
<a name="18172"/>18172:          #{desc =&gt; &quot;send req 1 (to dst) (W TIMESTAMP)&quot;,
<a name="18173"/>18173:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="18174"/>18174:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="18175"/>18175:                    end},
<a name="18176"/>18176:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="18177"/>18177:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="18178"/>18178:                            case Recv(Sock) of
<a name="18179"/>18179:                                {ok, {Src, [#{level := socket,
<a name="18180"/>18180:                                              type  := timestamp,
<a name="18181"/>18181:                                              value := TS}], ?BASIC_REQ}} -&gt;
<a name="18182"/>18182:                                    ?SEV_IPRINT(&quot;received req *with* &quot;
<a name="18183"/>18183:                                                &quot;expected timestamp: &quot;
<a name="18184"/>18184:                                                &quot;~n   ~p&quot;, [TS]),
<a name="18185"/>18185:                                    ok;
<a name="18186"/>18186:                                {ok, {Src, CMsgs, ?BASIC_REQ}} -&gt;
<a name="18187"/>18187:                                    ?SEV_EPRINT(&quot;Unexpected control message(s):&quot;
<a name="18188"/>18188:                                                &quot;~n   CMsgs: ~p&quot;,
<a name="18189"/>18189:                                                [CMsgs]),
<a name="18190"/>18190:                                    {error, {unexpected_cmsgs, CMsgs}};
<a name="18191"/>18191:                                {ok, UnexpData} -&gt;
<a name="18192"/>18192:                                    {error, {unexpected_data, UnexpData}};
<a name="18193"/>18193:                                {error, _} = ERROR -&gt;
<a name="18194"/>18194:                                    %% At the moment there is no way to get
<a name="18195"/>18195:                                    %% status or state for the socket...
<a name="18196"/>18196:                                    ERROR
<a name="18197"/>18197:                            end
<a name="18198"/>18198:                    end},
<a name="18199"/>18199:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="18200"/>18200:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="18201"/>18201:                            Send(Sock, ?BASIC_REP, Src)
<a name="18202"/>18202:                    end},
<a name="18203"/>18203:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="18204"/>18204:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="18205"/>18205:                            case Recv(Sock) of
<a name="18206"/>18206:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="18207"/>18207:                                    ok;
<a name="18208"/>18208:                                {ok, UnexpData} -&gt;
<a name="18209"/>18209:                                    {error, {unexpected_data, UnexpData}};
<a name="18210"/>18210:                                {error, _} = ERROR -&gt;
<a name="18211"/>18211:                                    %% At the moment there is no way to get
<a name="18212"/>18212:                                    %% status or state for the socket...
<a name="18213"/>18213:                                    ERROR
<a name="18214"/>18214:                            end
<a name="18215"/>18215:                    end},
<a name="18216"/>18216: 
<a name="18217"/>18217: 
<a name="18218"/>18218:          #{desc =&gt; &quot;send req 2 (to dst) (W TIMESTAMP)&quot;,
<a name="18219"/>18219:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="18220"/>18220:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="18221"/>18221:                    end},
<a name="18222"/>18222:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="18223"/>18223:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="18224"/>18224:                            case Recv(Sock) of
<a name="18225"/>18225:                                {ok, {Src, [#{level := socket,
<a name="18226"/>18226:                                              type  := timestamp,
<a name="18227"/>18227:                                              value := TS}], ?BASIC_REQ}} -&gt;
<a name="18228"/>18228:                                    ?SEV_IPRINT(&quot;received req *with* &quot;
<a name="18229"/>18229:                                                &quot;expected timestamp: &quot;
<a name="18230"/>18230:                                                &quot;~n   ~p&quot;, [TS]),
<a name="18231"/>18231:                                    ok;
<a name="18232"/>18232:                                {ok, UnexpData} -&gt;
<a name="18233"/>18233:                                    {error, {unexpected_data, UnexpData}};
<a name="18234"/>18234:                                {error, _} = ERROR -&gt;
<a name="18235"/>18235:                                    %% At the moment there is no way to get
<a name="18236"/>18236:                                    %% status or state for the socket...
<a name="18237"/>18237:                                    ERROR
<a name="18238"/>18238:                            end
<a name="18239"/>18239:                    end},
<a name="18240"/>18240:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="18241"/>18241:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="18242"/>18242:                            Send(Sock, ?BASIC_REP, Src)
<a name="18243"/>18243:                    end},
<a name="18244"/>18244:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="18245"/>18245:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="18246"/>18246:                            case Recv(Sock) of
<a name="18247"/>18247:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="18248"/>18248:                                    ok;
<a name="18249"/>18249:                                {ok, UnexpData} -&gt;
<a name="18250"/>18250:                                    {error, {unexpected_data, UnexpData}};
<a name="18251"/>18251:                                {error, _} = ERROR -&gt;
<a name="18252"/>18252:                                    %% At the moment there is no way to get
<a name="18253"/>18253:                                    %% status or state for the socket...
<a name="18254"/>18254:                                    ERROR
<a name="18255"/>18255:                            end
<a name="18256"/>18256:                    end},
<a name="18257"/>18257: 
<a name="18258"/>18258: 
<a name="18259"/>18259:          #{desc =&gt; &quot;disable timestamps on dst socket&quot;,
<a name="18260"/>18260:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="18261"/>18261:                            case Set(Sock, false) of
<a name="18262"/>18262:                                ok -&gt;
<a name="18263"/>18263:                                    ?SEV_IPRINT(&quot;dst timestamp disabled&quot;),
<a name="18264"/>18264:                                    ok;
<a name="18265"/>18265:                                {error, Reason} = ERROR -&gt;
<a name="18266"/>18266:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="18267"/>18267:                                                &quot;   ~p&quot;, [Reason]),
<a name="18268"/>18268:                                    ERROR
<a name="18269"/>18269:                            end
<a name="18270"/>18270:                    end},
<a name="18271"/>18271: 
<a name="18272"/>18272: 
<a name="18273"/>18273:          #{desc =&gt; &quot;send req (to dst) (WO TIMESTAMP)&quot;,
<a name="18274"/>18274:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="18275"/>18275:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="18276"/>18276:                    end},
<a name="18277"/>18277:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="18278"/>18278:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="18279"/>18279:                            case Recv(Sock) of
<a name="18280"/>18280:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="18281"/>18281:                                    ?SEV_IPRINT(&quot;received req *without* timestamp&quot;),
<a name="18282"/>18282:                                    ok;
<a name="18283"/>18283:                                {ok, UnexpData} -&gt;
<a name="18284"/>18284:                                    {error, {unexpected_data, UnexpData}};
<a name="18285"/>18285:                                {error, _} = ERROR -&gt;
<a name="18286"/>18286:                                    %% At the moment there is no way to get
<a name="18287"/>18287:                                    %% status or state for the socket...
<a name="18288"/>18288:                                    ERROR
<a name="18289"/>18289:                            end
<a name="18290"/>18290:                    end},
<a name="18291"/>18291:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="18292"/>18292:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="18293"/>18293:                            Send(Sock, ?BASIC_REP, Src)
<a name="18294"/>18294:                    end},
<a name="18295"/>18295:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="18296"/>18296:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="18297"/>18297:                            case Recv(Sock) of
<a name="18298"/>18298:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="18299"/>18299:                                    ok;
<a name="18300"/>18300:                                {ok, UnexpData} -&gt;
<a name="18301"/>18301:                                    {error, {unexpected_data, UnexpData}};
<a name="18302"/>18302:                                {error, _} = ERROR -&gt;
<a name="18303"/>18303:                                    %% At the moment there is no way to get
<a name="18304"/>18304:                                    %% status or state for the socket...
<a name="18305"/>18305:                                    ERROR
<a name="18306"/>18306:                            end
<a name="18307"/>18307:                    end},
<a name="18308"/>18308: 
<a name="18309"/>18309: 
<a name="18310"/>18310:          #{desc =&gt; &quot;close src socket&quot;,
<a name="18311"/>18311:            cmd  =&gt; fun(#{domain   := local,
<a name="18312"/>18312:                          sock_src := Sock,
<a name="18313"/>18313:                          lsa_src  := #{path := Path}} = State) -&gt;
<a name="18314"/>18314:                            ok = socket:close(Sock),
<a name="18315"/>18315:                            State1 =
<a name="18316"/>18316:                                unlink_path(Path,
<a name="18317"/>18317:                                            fun() -&gt; maps:remove(lsa_src, State) end,
<a name="18318"/>18318:                                            fun() -&gt; State end),
<a name="18319"/>18319:                            {ok, maps:remove(sock_src, State1)};
<a name="18320"/>18320:                       (#{sock_src := Sock} = State) -&gt;
<a name="18321"/>18321:                            ok = socket:close(Sock),
<a name="18322"/>18322:                            {ok, maps:remove(sock_src, State)}
<a name="18323"/>18323:                    end},
<a name="18324"/>18324:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="18325"/>18325:            cmd  =&gt; fun(#{domain   := local,
<a name="18326"/>18326:                          sock_dst := Sock,
<a name="18327"/>18327:                          lsa_dst  := #{path := Path}} = State) -&gt;
<a name="18328"/>18328:                            ok = socket:close(Sock),
<a name="18329"/>18329:                            State1 =
<a name="18330"/>18330:                                unlink_path(Path,
<a name="18331"/>18331:                                            fun() -&gt; maps:remove(lsa_dst, State) end,
<a name="18332"/>18332:                                            fun() -&gt; State end),
<a name="18333"/>18333:                            {ok, maps:remove(sock_dst, State1)};
<a name="18334"/>18334:                       (#{sock_dst := Sock} = State) -&gt;
<a name="18335"/>18335:                            ok = socket:close(Sock),
<a name="18336"/>18336:                            {ok, maps:remove(sock_dst, State)}
<a name="18337"/>18337:                    end},
<a name="18338"/>18338: 
<a name="18339"/>18339:          %% *** We are done ***
<a name="18340"/>18340:          ?SEV_FINISH_NORMAL
<a name="18341"/>18341:         ],
<a name="18342"/>18342:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_timestamp_udp-last_expr"/><a name="18343"/>18343: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="18344"/>18344: 
<a name="18345"/>18345: 
<a name="18346"/>18346: 
<a name="18347"/>18347: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18348"/>18348: 
<a name="18349"/>18349: <i>%% Tests that the timestamp control message header is received when</i>
<a name="18350"/>18350: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="18351"/>18351: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="18352"/>18352: <i>%% So, this is done on the receiving side: </i>
<a name="18353"/>18353: <i>%%</i>
<a name="18354"/>18354: <i>%%               socket:setopt(Sock, socket, timestamp, boolean()).</i>
<a name="18355"/>18355: <i>%%</i>
<a name="18356"/>18356: <i>%% All subsequent *received* messages will be timestamped.</i>
<a name="18357"/>18357: <i>%%</i>
<a name="18358"/>18358: <i>%% There is no mention of this not working for TCP in the man page</i>
<a name="18359"/>18359: <i>%% on a SLES 11 SP4 machine (=&gt; 3.0.101-108.87), but it does not</i>
<a name="18360"/>18360: <i>%% (we don't get a timestamp control message header when its enabled).</i>
<a name="18361"/>18361: <i>%% It also does not work on SLES 12 SP2 (=&gt; 4.4.120-92.70), </i>
<a name="18362"/>18362: <i>%% so we start by skipping from that version (4.4.120) or older!</i>
<a name="18363"/>18363: <i>%% Don't actually know if its the distro or the (kernel) version...</i>
<a name="18364"/>18364: <i>%%</i>
<a name="18365"/>18365: 
<a name="api_opt_sock_timestamp_tcp4-1"/><a name="18366"/>18366: <b>api_opt_sock_timestamp_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18367"/>18367:     ?TT(?SECS(5)),
<a name="api_opt_sock_timestamp_tcp4-last_expr"/><a name="18368"/>18368: <b>    tc_try</b>(api_opt_sock_timestamp_tcp4,
<a name="18369"/>18369:            fun() -&gt;
<a name="18370"/>18370:                    has_support_ipv4(),
<a name="18371"/>18371:                    has_support_sock_timestamp(),
<a name="18372"/>18372:                    is_good_enough_linux({4,4,120}),
<a name="18373"/>18373:                    is_not_freebsd(),
<a name="18374"/>18374:                    is_not_openbsd(),
<a name="18375"/>18375:                    is_not_netbsd(),
<a name="18376"/>18376:                    is_not_darwin()
<a name="18377"/>18377:            end,
<a name="18378"/>18378:            fun() -&gt;
<a name="18379"/>18379:                    Set  = fun(Sock, Value) -&gt;
<a name="18380"/>18380:                                   socket:setopt(Sock, socket, timestamp, Value)
<a name="18381"/>18381:                           end,
<a name="18382"/>18382:                    Get  = fun(Sock) -&gt;
<a name="18383"/>18383:                                   socket:getopt(Sock, socket, timestamp)
<a name="18384"/>18384:                           end,
<a name="18385"/>18385:                    Send = fun(Sock, Data) -&gt;
<a name="18386"/>18386:                                   Msg = #{iov  =&gt; [Data]},
<a name="18387"/>18387:                                   socket:sendmsg(Sock, Msg)
<a name="18388"/>18388:                           end,
<a name="18389"/>18389:                    Recv = fun(Sock) -&gt;
<a name="18390"/>18390:                                   case socket:recvmsg(Sock) of
<a name="18391"/>18391:                                       {ok, #{ctrl := CMsgs,
<a name="18392"/>18392:                                              iov  := [Data]}} -&gt;
<a name="18393"/>18393:                                           {ok, {CMsgs, Data}};
<a name="18394"/>18394:                                       {error, _} = ERROR -&gt;
<a name="18395"/>18395:                                           ERROR
<a name="18396"/>18396:                                   end
<a name="18397"/>18397:                           end,
<a name="18398"/>18398:                    InitState = #{domain =&gt; inet,
<a name="18399"/>18399:                                  proto  =&gt; tcp,
<a name="18400"/>18400:                                  send   =&gt; Send,
<a name="18401"/>18401:                                  recv   =&gt; Recv,
<a name="18402"/>18402:                                  set    =&gt; Set,
<a name="18403"/>18403:                                  get    =&gt; Get},
<a name="18404"/>18404:                    ok = api_opt_sock_timestamp_tcp(InitState)
<a name="18405"/>18405:            end).
<a name="18406"/>18406: 
<a name="18407"/>18407: 
<a name="18408"/>18408: 
<a name="18409"/>18409: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18410"/>18410: 
<a name="api_opt_sock_timestamp_tcp-1"/><a name="18411"/>18411: <b>api_opt_sock_timestamp_tcp</b>(InitState) -&gt;
<a name="18412"/>18412:     process_flag(trap_exit, true),
<a name="18413"/>18413:     ServerSeq =
<a name="18414"/>18414:         [
<a name="18415"/>18415:          %% *** Wait for start order ***
<a name="18416"/>18416:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="18417"/>18417:            cmd  =&gt; fun(State) -&gt;
<a name="18418"/>18418:                            Tester = ?SEV_AWAIT_START(),
<a name="18419"/>18419:                            {ok, State#{tester =&gt; Tester}}
<a name="18420"/>18420:                    end},
<a name="18421"/>18421:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="18422"/>18422:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18423"/>18423:                            _MRef = erlang:monitor(process, Tester),
<a name="18424"/>18424:                            ok
<a name="18425"/>18425:                    end},
<a name="18426"/>18426: 
<a name="18427"/>18427:          %% *** Init part ***
<a name="18428"/>18428:          #{desc =&gt; &quot;which local address&quot;,
<a name="18429"/>18429:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="18430"/>18430:                            LSA = which_local_socket_addr(Domain),
<a name="18431"/>18431:                            {ok, State#{lsa =&gt; LSA}}
<a name="18432"/>18432:                    end},
<a name="18433"/>18433:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="18434"/>18434:            cmd  =&gt; fun(#{domain := Domain,
<a name="18435"/>18435:                          proto  := Proto} = State) -&gt;
<a name="18436"/>18436:                            case socket:open(Domain, stream, Proto) of
<a name="18437"/>18437:                                {ok, Sock} -&gt;
<a name="18438"/>18438:                                    {ok, State#{lsock =&gt; Sock}};
<a name="18439"/>18439:                                {error, _} = ERROR -&gt;
<a name="18440"/>18440:                                    ERROR
<a name="18441"/>18441:                            end
<a name="18442"/>18442:                    end},
<a name="18443"/>18443:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="18444"/>18444:            cmd  =&gt; fun(#{domain := local,
<a name="18445"/>18445:                          lsock  := LSock,
<a name="18446"/>18446:                          lsa    := LSA} = _State) -&gt;
<a name="18447"/>18447:                            case socket:bind(LSock, LSA) of
<a name="18448"/>18448:                                ok -&gt;
<a name="18449"/>18449:                                    ok; % We do not care about the port for local
<a name="18450"/>18450:                                {error, _} = ERROR -&gt;
<a name="18451"/>18451:                                    ERROR
<a name="18452"/>18452:                            end;
<a name="18453"/>18453:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="18454"/>18454:                            case sock_bind(LSock, LSA) of
<a name="18455"/>18455:                                ok -&gt;
<a name="18456"/>18456:                                    Port = sock_port(LSock),
<a name="18457"/>18457:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="18458"/>18458:                                    {ok, State#{lport =&gt; Port}};
<a name="18459"/>18459:                                {error, _} = ERROR -&gt;
<a name="18460"/>18460:                                    ERROR
<a name="18461"/>18461:                            end
<a name="18462"/>18462:                    end},
<a name="18463"/>18463:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="18464"/>18464:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="18465"/>18465:                            socket:listen(LSock)
<a name="18466"/>18466:                    end},
<a name="18467"/>18467:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="18468"/>18468:            cmd  =&gt; fun(#{domain := local,
<a name="18469"/>18469:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="18470"/>18470:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="18471"/>18471:                            ok;
<a name="18472"/>18472:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="18473"/>18473:                            %% This is actually not used for unix domain socket
<a name="18474"/>18474:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="18475"/>18475:                            ok
<a name="18476"/>18476:                    end},
<a name="18477"/>18477: 
<a name="18478"/>18478: 
<a name="18479"/>18479:          %% The actual test
<a name="18480"/>18480:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="18481"/>18481:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18482"/>18482:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="18483"/>18483:                    end},
<a name="18484"/>18484:          #{desc =&gt; &quot;await connection&quot;,
<a name="18485"/>18485:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="18486"/>18486:                            case socket:accept(LSock) of
<a name="18487"/>18487:                                {ok, Sock} -&gt;
<a name="18488"/>18488:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="18489"/>18489:                                    {ok, State#{csock =&gt; Sock}};
<a name="18490"/>18490:                                {error, _} = ERROR -&gt;
<a name="18491"/>18491:                                    ERROR
<a name="18492"/>18492:                            end
<a name="18493"/>18493:                    end},
<a name="18494"/>18494:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="18495"/>18495:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18496"/>18496:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="18497"/>18497:                            ok
<a name="18498"/>18498:                    end},
<a name="18499"/>18499: 
<a name="18500"/>18500:          %% *** First message ***
<a name="18501"/>18501: 
<a name="18502"/>18502:          #{desc =&gt; &quot;await (recv) request 1&quot;,
<a name="18503"/>18503:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="18504"/>18504:                            case Recv(Sock) of
<a name="18505"/>18505:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="18506"/>18506:                                    ok;
<a name="18507"/>18507:                                {error, _} = ERROR -&gt;
<a name="18508"/>18508:                                    ERROR
<a name="18509"/>18509:                            end
<a name="18510"/>18510:                    end},
<a name="18511"/>18511:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="18512"/>18512:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18513"/>18513:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="18514"/>18514:                            ok
<a name="18515"/>18515:                    end},
<a name="18516"/>18516:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="18517"/>18517:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18518"/>18518:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="18519"/>18519:                    end},
<a name="18520"/>18520:          #{desc =&gt; &quot;send reply&quot;,
<a name="18521"/>18521:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="18522"/>18522:                            Send(Sock, ?BASIC_REP)
<a name="18523"/>18523:                    end},
<a name="18524"/>18524:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="18525"/>18525:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18526"/>18526:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="18527"/>18527:                            ok
<a name="18528"/>18528:                    end},
<a name="18529"/>18529: 
<a name="18530"/>18530:          %% *** Second message ***
<a name="18531"/>18531: 
<a name="18532"/>18532:          #{desc =&gt; &quot;await (recv) request 2&quot;,
<a name="18533"/>18533:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="18534"/>18534:                            case Recv(Sock) of
<a name="18535"/>18535:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="18536"/>18536:                                    ok;
<a name="18537"/>18537:                                {error, _} = ERROR -&gt;
<a name="18538"/>18538:                                    ERROR
<a name="18539"/>18539:                            end
<a name="18540"/>18540:                    end},
<a name="18541"/>18541:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="18542"/>18542:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18543"/>18543:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="18544"/>18544:                            ok
<a name="18545"/>18545:                    end},
<a name="18546"/>18546:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="18547"/>18547:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18548"/>18548:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="18549"/>18549:                    end},
<a name="18550"/>18550:          #{desc =&gt; &quot;send reply&quot;,
<a name="18551"/>18551:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="18552"/>18552:                            Send(Sock, ?BASIC_REP)
<a name="18553"/>18553:                    end},
<a name="18554"/>18554:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="18555"/>18555:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18556"/>18556:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="18557"/>18557:                            ok
<a name="18558"/>18558:                    end},
<a name="18559"/>18559: 
<a name="18560"/>18560:          %% *** Third message ***
<a name="18561"/>18561: 
<a name="18562"/>18562:          #{desc =&gt; &quot;await (recv) request 3&quot;,
<a name="18563"/>18563:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="18564"/>18564:                            case Recv(Sock) of
<a name="18565"/>18565:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="18566"/>18566:                                    ok;
<a name="18567"/>18567:                                {error, _} = ERROR -&gt;
<a name="18568"/>18568:                                    ERROR
<a name="18569"/>18569:                            end
<a name="18570"/>18570:                    end},
<a name="18571"/>18571:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="18572"/>18572:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18573"/>18573:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="18574"/>18574:                            ok
<a name="18575"/>18575:                    end},
<a name="18576"/>18576:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="18577"/>18577:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18578"/>18578:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="18579"/>18579:                    end},
<a name="18580"/>18580:          #{desc =&gt; &quot;send reply&quot;,
<a name="18581"/>18581:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="18582"/>18582:                            Send(Sock, ?BASIC_REP)
<a name="18583"/>18583:                    end},
<a name="18584"/>18584:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="18585"/>18585:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18586"/>18586:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="18587"/>18587:                            ok
<a name="18588"/>18588:                    end},
<a name="18589"/>18589: 
<a name="18590"/>18590:          %% *** Termination ***
<a name="18591"/>18591:          #{desc =&gt; &quot;await terminate&quot;,
<a name="18592"/>18592:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="18593"/>18593:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="18594"/>18594:                                ok -&gt;
<a name="18595"/>18595:                                    {ok, maps:remove(tester, State)};
<a name="18596"/>18596:                                {error, _} = ERROR -&gt;
<a name="18597"/>18597:                                    ERROR
<a name="18598"/>18598:                            end
<a name="18599"/>18599:                    end},
<a name="18600"/>18600:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="18601"/>18601:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="18602"/>18602:                            ok = socket:close(Sock),
<a name="18603"/>18603:                            {ok, maps:remove(csock, State)}
<a name="18604"/>18604:                    end},
<a name="18605"/>18605:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="18606"/>18606:            cmd  =&gt; fun(#{domain   := local,
<a name="18607"/>18607:                          lsock    := Sock,
<a name="18608"/>18608:                          local_sa := #{path := Path}} = State) -&gt;
<a name="18609"/>18609:                            ok = socket:close(Sock),
<a name="18610"/>18610:                            State1 =
<a name="18611"/>18611:                                unlink_path(Path,
<a name="18612"/>18612:                                            fun() -&gt;
<a name="18613"/>18613:                                                    maps:remove(local_sa, State)
<a name="18614"/>18614:                                            end,
<a name="18615"/>18615:                                            fun() -&gt; State end),
<a name="18616"/>18616:                            {ok, maps:remove(lsock, State1)};
<a name="18617"/>18617:                       (#{lsock := LSock} = State) -&gt;
<a name="18618"/>18618:                            case socket:close(LSock) of
<a name="18619"/>18619:                                ok -&gt;
<a name="18620"/>18620:                                    {ok, maps:remove(lsock, State)};
<a name="18621"/>18621:                                {error, _} = ERROR -&gt;
<a name="18622"/>18622:                                    ERROR
<a name="18623"/>18623:                            end
<a name="18624"/>18624:                    end},
<a name="18625"/>18625: 
<a name="18626"/>18626:          %% *** We are done ***
<a name="18627"/>18627:          ?SEV_FINISH_NORMAL
<a name="18628"/>18628:         ],
<a name="18629"/>18629: 
<a name="18630"/>18630: 
<a name="18631"/>18631:     ClientSeq =
<a name="18632"/>18632:         [
<a name="18633"/>18633:          %% *** Wait for start order ***
<a name="18634"/>18634:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="18635"/>18635:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="18636"/>18636:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="18637"/>18637:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="18638"/>18638:                       (State) -&gt;
<a name="18639"/>18639:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="18640"/>18640:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="18641"/>18641:                    end},
<a name="18642"/>18642:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="18643"/>18643:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18644"/>18644:                            _MRef = erlang:monitor(process, Tester),
<a name="18645"/>18645:                            ok
<a name="18646"/>18646:                    end},
<a name="18647"/>18647: 
<a name="18648"/>18648:          %% *** The init part ***
<a name="18649"/>18649:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="18650"/>18650:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="18651"/>18651:                          server_path := Path} = State) -&gt;
<a name="18652"/>18652:                            LSA = which_local_socket_addr(Domain),
<a name="18653"/>18653:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="18654"/>18654:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="18655"/>18655:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="18656"/>18656:                            LSA = which_local_socket_addr(Domain),
<a name="18657"/>18657:                            SSA = LSA#{port =&gt; Port},
<a name="18658"/>18658:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="18659"/>18659:                    end},
<a name="18660"/>18660:          #{desc =&gt; &quot;create socket&quot;,
<a name="18661"/>18661:            cmd  =&gt; fun(#{domain := Domain,
<a name="18662"/>18662:                          proto  := Proto} = State) -&gt;
<a name="18663"/>18663:                            case socket:open(Domain, stream, Proto) of
<a name="18664"/>18664:                                {ok, Sock} -&gt;
<a name="18665"/>18665:                                    {ok, State#{sock =&gt; Sock}};
<a name="18666"/>18666:                                {error, _} = ERROR -&gt;
<a name="18667"/>18667:                                    ERROR
<a name="18668"/>18668:                            end
<a name="18669"/>18669:                    end},
<a name="18670"/>18670:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="18671"/>18671:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="18672"/>18672:                            case sock_bind(Sock, LSA) of
<a name="18673"/>18673:                                ok -&gt;
<a name="18674"/>18674:                                    ok;
<a name="18675"/>18675:                                {error, _} = ERROR -&gt;
<a name="18676"/>18676:                                    ERROR
<a name="18677"/>18677:                            end
<a name="18678"/>18678:                    end},
<a name="18679"/>18679:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="18680"/>18680:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18681"/>18681:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="18682"/>18682:                            ok
<a name="18683"/>18683:                    end},
<a name="18684"/>18684: 
<a name="18685"/>18685:          %% *** The actual test ***
<a name="18686"/>18686:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="18687"/>18687:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18688"/>18688:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="18689"/>18689:                    end},
<a name="18690"/>18690:          #{desc =&gt; &quot;connect to server&quot;,
<a name="18691"/>18691:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="18692"/>18692:                            socket:connect(Sock, SSA)
<a name="18693"/>18693:                    end},
<a name="18694"/>18694:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="18695"/>18695:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18696"/>18696:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="18697"/>18697:                            ok
<a name="18698"/>18698:                    end},
<a name="18699"/>18699: 
<a name="18700"/>18700:          %% *** First message (default=wo timestamp) ***
<a name="18701"/>18701: 
<a name="18702"/>18702:          #{desc =&gt; &quot;await continue (verify timestamp off)&quot;,
<a name="18703"/>18703:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18704"/>18704:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_timestamp)
<a name="18705"/>18705:                    end},
<a name="18706"/>18706:          #{desc =&gt; &quot;verify timestamp off&quot;,
<a name="18707"/>18707:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="18708"/>18708:                            case Get(Sock) of
<a name="18709"/>18709:                                {ok, false = _Value} -&gt;
<a name="18710"/>18710:                                    ?SEV_IPRINT(&quot;timestamp: ~p&quot;, [_Value]),
<a name="18711"/>18711:                                    ok;
<a name="18712"/>18712:                                {ok, Unexpected} -&gt;
<a name="18713"/>18713:                                    ?SEV_EPRINT(&quot;Unexpected timestamp: ~p&quot;,
<a name="18714"/>18714:                                                [Unexpected]),
<a name="18715"/>18715:                                    {error, {unexpected_timestamp, Unexpected}};
<a name="18716"/>18716:                                {error, enoprotoopt = Reason} -&gt;
<a name="18717"/>18717:                                    {skip, Reason};
<a name="18718"/>18718:                                {error, Reason} = ERROR -&gt;
<a name="18719"/>18719:                                    ?SEV_EPRINT(&quot;Failed getting timestamp:&quot;
<a name="18720"/>18720:                                                &quot;   ~p&quot;, [Reason]),
<a name="18721"/>18721:                                    ERROR
<a name="18722"/>18722:                            end                                   
<a name="18723"/>18723:                    end},
<a name="18724"/>18724:          #{desc =&gt; &quot;announce ready (timestamp off)&quot;,
<a name="18725"/>18725:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18726"/>18726:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_off),
<a name="18727"/>18727:                            ok
<a name="18728"/>18728:                    end},
<a name="18729"/>18729: 
<a name="18730"/>18730:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="18731"/>18731:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18732"/>18732:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="18733"/>18733:                    end},
<a name="18734"/>18734:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="18735"/>18735:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="18736"/>18736:                            Send(Sock, ?BASIC_REQ)
<a name="18737"/>18737:                    end},
<a name="18738"/>18738:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="18739"/>18739:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18740"/>18740:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="18741"/>18741:                            ok
<a name="18742"/>18742:                    end},
<a name="18743"/>18743:          #{desc =&gt; &quot;await recv reply 1 (from server, wo timestamp)&quot;,
<a name="18744"/>18744:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="18745"/>18745:                            case Recv(Sock) of
<a name="18746"/>18746:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="18747"/>18747:                                    ok;
<a name="18748"/>18748:                                {ok, {[], UnexpData}} -&gt;
<a name="18749"/>18749:                                    {error, {unexpected_reply_data, UnexpData}};
<a name="18750"/>18750:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="18751"/>18751:                                    {error, {unexpected_reply_cmsgs,
<a name="18752"/>18752:                                             BadCMsgs}};
<a name="18753"/>18753:                                {ok, BadReply} -&gt;
<a name="18754"/>18754:                                    {error, {unexpected_reply, BadReply}};
<a name="18755"/>18755:                                {error, _} = ERROR -&gt;
<a name="18756"/>18756:                                    ERROR
<a name="18757"/>18757:                            end
<a name="18758"/>18758:                    end},
<a name="18759"/>18759:          #{desc =&gt; &quot;announce ready 1 (recv reply)&quot;,
<a name="18760"/>18760:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18761"/>18761:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="18762"/>18762:                            ok
<a name="18763"/>18763:                    end},
<a name="18764"/>18764: 
<a name="18765"/>18765:          %% *** Second message (w timestamp) ***
<a name="18766"/>18766: 
<a name="18767"/>18767:          #{desc =&gt; &quot;await continue (enable timestamp)&quot;,
<a name="18768"/>18768:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18769"/>18769:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_timestamp)
<a name="18770"/>18770:                    end},
<a name="18771"/>18771:          #{desc =&gt; &quot;enable timestamp&quot;,
<a name="18772"/>18772:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="18773"/>18773:                            case Set(Sock, true) of
<a name="18774"/>18774:                                ok -&gt;
<a name="18775"/>18775:                                    ?SEV_IPRINT(&quot;timestamp enabled&quot;),
<a name="18776"/>18776:                                    ok;
<a name="18777"/>18777:                                {error, Reason} = ERROR -&gt;
<a name="18778"/>18778:                                    ?SEV_EPRINT(&quot;Failed enable timestamp:&quot;
<a name="18779"/>18779:                                                &quot;   ~p&quot;, [Reason]),
<a name="18780"/>18780:                                    ERROR
<a name="18781"/>18781:                            end                                   
<a name="18782"/>18782:                    end},
<a name="18783"/>18783:          %% Linux peculiarity observed here...
<a name="18784"/>18784:          %% Detected on Kernel 4.15.0-72 x96_64.
<a name="18785"/>18785:          %% The option set to enable receiving timestamps just above
<a name="18786"/>18786:          %% has failed to be effective down in &quot;await recv reply 2
<a name="18787"/>18787:          %% (from server, w timestamp)&quot; below, unless we put the
<a name="18788"/>18788:          %% sleep between setting the option and informing
<a name="18789"/>18789:          %% the writer that it shall write to the other socket end.
<a name="18790"/>18790:          %% A sleep 1 ms improves a lot but does not remove
<a name="18791"/>18791:          %% problem completely. Believe it or not.
<a name="18792"/>18792:          ?SEV_SLEEP(100),
<a name="18793"/>18793:          #{desc =&gt; &quot;announce ready (timestamp on)&quot;,
<a name="18794"/>18794:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18795"/>18795:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_on),
<a name="18796"/>18796:                            ok
<a name="18797"/>18797:                    end},
<a name="18798"/>18798: 
<a name="18799"/>18799:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="18800"/>18800:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18801"/>18801:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="18802"/>18802:                    end},
<a name="18803"/>18803:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="18804"/>18804:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="18805"/>18805:                            Send(Sock, ?BASIC_REQ)
<a name="18806"/>18806:                    end},
<a name="18807"/>18807:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="18808"/>18808:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18809"/>18809:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="18810"/>18810:                            ok
<a name="18811"/>18811:                    end},
<a name="18812"/>18812:          #{desc =&gt; &quot;await recv reply 2 (from server, w timestamp)&quot;,
<a name="18813"/>18813:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, get := Get}) -&gt;
<a name="18814"/>18814:                            case Recv(Sock) of
<a name="18815"/>18815:                                {ok, {[#{level := socket,
<a name="18816"/>18816:                                         type  := timestamp,
<a name="18817"/>18817:                                         value := TS}], ?BASIC_REP}} -&gt;
<a name="18818"/>18818:                                    ?SEV_IPRINT(&quot;received reply *with* &quot;
<a name="18819"/>18819:                                                &quot;expected timestamp: &quot;
<a name="18820"/>18820:                                                &quot;~n   ~p&quot;, [TS]),
<a name="18821"/>18821:                                    ok;
<a name="18822"/>18822:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="18823"/>18823:                                    ?SEV_EPRINT(&quot;received reply *with* &quot;
<a name="18824"/>18824:                                                &quot;unexpected cmsg headers:&quot;
<a name="18825"/>18825:                                                &quot;~n   ~p&quot;
<a name="18826"/>18826:                                                &quot;Current timestamp value: &quot;
<a name="18827"/>18827:                                                &quot;~n   ~p&quot;,
<a name="18828"/>18828:                                                [BadCMsgs, Get(Sock)]),
<a name="18829"/>18829:                                    {error, {unexpected_reply_cmsgs,
<a name="18830"/>18830:                                             BadCMsgs}};
<a name="18831"/>18831:                                {ok, BadReply} -&gt;
<a name="18832"/>18832:                                    {error, {unexpected_reply, BadReply}};
<a name="18833"/>18833:                                {error, _} = ERROR -&gt;
<a name="18834"/>18834:                                    ERROR
<a name="18835"/>18835:                            end
<a name="18836"/>18836:                    end},
<a name="18837"/>18837:          #{desc =&gt; &quot;announce ready 2 (recv reply)&quot;,
<a name="18838"/>18838:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18839"/>18839:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="18840"/>18840:                            ok
<a name="18841"/>18841:                    end},
<a name="18842"/>18842: 
<a name="18843"/>18843:          %% *** Third message (wo timestamp) ***
<a name="18844"/>18844: 
<a name="18845"/>18845:          #{desc =&gt; &quot;await continue (disable timestamp)&quot;,
<a name="18846"/>18846:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18847"/>18847:                            ?SEV_AWAIT_CONTINUE(Tester, tester, disable_timestamp)
<a name="18848"/>18848:                    end},
<a name="18849"/>18849:          #{desc =&gt; &quot;disable timestamp&quot;,
<a name="18850"/>18850:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="18851"/>18851:                            case Set(Sock, false) of
<a name="18852"/>18852:                                ok -&gt;
<a name="18853"/>18853:                                    ?SEV_IPRINT(&quot;timestamp disabled&quot;),
<a name="18854"/>18854:                                    ok;
<a name="18855"/>18855:                                {error, Reason} = ERROR -&gt;
<a name="18856"/>18856:                                    ?SEV_EPRINT(&quot;Failed disable timestamp:&quot;
<a name="18857"/>18857:                                                &quot;   ~p&quot;, [Reason]),
<a name="18858"/>18858:                                    ERROR
<a name="18859"/>18859:                            end                                   
<a name="18860"/>18860:                    end},
<a name="18861"/>18861:          #{desc =&gt; &quot;announce ready (timestamp off)&quot;,
<a name="18862"/>18862:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18863"/>18863:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_off),
<a name="18864"/>18864:                            ok
<a name="18865"/>18865:                    end},
<a name="18866"/>18866: 
<a name="18867"/>18867:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="18868"/>18868:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18869"/>18869:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="18870"/>18870:                    end},
<a name="18871"/>18871:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="18872"/>18872:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="18873"/>18873:                            Send(Sock, ?BASIC_REQ)
<a name="18874"/>18874:                    end},
<a name="18875"/>18875:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="18876"/>18876:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18877"/>18877:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="18878"/>18878:                            ok
<a name="18879"/>18879:                    end},
<a name="18880"/>18880:          #{desc =&gt; &quot;await recv reply 3 (from server, wo timestamp)&quot;,
<a name="18881"/>18881:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="18882"/>18882:                            case Recv(Sock) of
<a name="18883"/>18883:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="18884"/>18884:                                    ?SEV_IPRINT(&quot;received reply *without* &quot;
<a name="18885"/>18885:                                                &quot;timestamp&quot;),
<a name="18886"/>18886:                                    ok;
<a name="18887"/>18887:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="18888"/>18888:                                    {error, {unexpected_reply_cmsgs,
<a name="18889"/>18889:                                             BadCMsgs}};
<a name="18890"/>18890:                                {ok, {[], BadData}} -&gt;
<a name="18891"/>18891:                                    {error, {unexpected_reply_data,
<a name="18892"/>18892:                                             BadData}};
<a name="18893"/>18893:                                {ok, BadReply} -&gt;
<a name="18894"/>18894:                                    {error, {unexpected_reply, BadReply}};
<a name="18895"/>18895:                                {error, _} = ERROR -&gt;
<a name="18896"/>18896:                                    ERROR
<a name="18897"/>18897:                            end
<a name="18898"/>18898:                    end},
<a name="18899"/>18899:          #{desc =&gt; &quot;announce ready 3 (recv reply)&quot;,
<a name="18900"/>18900:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18901"/>18901:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="18902"/>18902:                            ok
<a name="18903"/>18903:                    end},
<a name="18904"/>18904: 
<a name="18905"/>18905:          %% *** Termination ***
<a name="18906"/>18906:          #{desc =&gt; &quot;await terminate&quot;,
<a name="18907"/>18907:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="18908"/>18908:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="18909"/>18909:                                ok -&gt;
<a name="18910"/>18910:                                    {ok, maps:remove(tester, State)};
<a name="18911"/>18911:                                {error, _} = ERROR -&gt;
<a name="18912"/>18912:                                    ERROR
<a name="18913"/>18913:                            end
<a name="18914"/>18914:                    end},
<a name="18915"/>18915:          #{desc =&gt; &quot;close socket&quot;,
<a name="18916"/>18916:            cmd  =&gt; fun(#{domain   := local,
<a name="18917"/>18917:                          sock     := Sock,
<a name="18918"/>18918:                          local_sa := #{path := Path}} = State) -&gt;
<a name="18919"/>18919:                            ok = socket:close(Sock),
<a name="18920"/>18920:                            State1 =
<a name="18921"/>18921:                                unlink_path(Path,
<a name="18922"/>18922:                                            fun() -&gt;
<a name="18923"/>18923:                                                    maps:remove(local_sa, State)
<a name="18924"/>18924:                                            end,
<a name="18925"/>18925:                                            fun() -&gt; State end),
<a name="18926"/>18926:                            {ok, maps:remove(sock, State1)};
<a name="18927"/>18927:                       (#{sock := Sock} = State) -&gt;
<a name="18928"/>18928:                            ok = socket:close(Sock),
<a name="18929"/>18929:                            {ok, maps:remove(sock, State)}
<a name="18930"/>18930:                    end},
<a name="18931"/>18931: 
<a name="18932"/>18932:          %% *** We are done ***
<a name="18933"/>18933:          ?SEV_FINISH_NORMAL
<a name="18934"/>18934:         ],
<a name="18935"/>18935: 
<a name="18936"/>18936: 
<a name="18937"/>18937:     TesterSeq =
<a name="18938"/>18938:         [
<a name="18939"/>18939:          %% *** Init part ***
<a name="18940"/>18940:          #{desc =&gt; &quot;monitor server&quot;,
<a name="18941"/>18941:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="18942"/>18942:                            _MRef = erlang:monitor(process, Pid),
<a name="18943"/>18943:                            ok
<a name="18944"/>18944:                    end},
<a name="18945"/>18945:          #{desc =&gt; &quot;monitor client&quot;,
<a name="18946"/>18946:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="18947"/>18947:                            _MRef = erlang:monitor(process, Pid),
<a name="18948"/>18948:                            ok
<a name="18949"/>18949:                    end},
<a name="18950"/>18950: 
<a name="18951"/>18951:          %% Start the server
<a name="18952"/>18952:          #{desc =&gt; &quot;order server start&quot;,
<a name="18953"/>18953:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="18954"/>18954:                            ?SEV_ANNOUNCE_START(Pid),
<a name="18955"/>18955:                            ok
<a name="18956"/>18956:                    end},
<a name="18957"/>18957:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="18958"/>18958:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="18959"/>18959:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="18960"/>18960:                            {ok, State#{server_port =&gt; Port}}
<a name="18961"/>18961:                    end},
<a name="18962"/>18962: 
<a name="18963"/>18963:          %% Start the client
<a name="18964"/>18964:          #{desc =&gt; &quot;order client start&quot;,
<a name="18965"/>18965:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="18966"/>18966:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="18967"/>18967:                            ok
<a name="18968"/>18968:                    end},
<a name="18969"/>18969:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="18970"/>18970:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="18971"/>18971:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="18972"/>18972:                    end},
<a name="18973"/>18973: 
<a name="18974"/>18974:          %% *** The actual test ***
<a name="18975"/>18975:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="18976"/>18976:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="18977"/>18977:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="18978"/>18978:                            ok
<a name="18979"/>18979:                    end},
<a name="18980"/>18980: <i>%%%         ?SEV_SLEEP(?SECS(1)),</i>
<a name="18981"/>18981:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="18982"/>18982:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="18983"/>18983:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="18984"/>18984:                            ok
<a name="18985"/>18985:                    end},
<a name="18986"/>18986:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="18987"/>18987:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="18988"/>18988:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="18989"/>18989:                    end},
<a name="18990"/>18990:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="18991"/>18991:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="18992"/>18992:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="18993"/>18993:                    end},
<a name="18994"/>18994: 
<a name="18995"/>18995:          %% *** First message (default=wo timestamp) ***
<a name="18996"/>18996: 
<a name="18997"/>18997:          #{desc =&gt; &quot;order client to continue (with verify timestamp off)&quot;,
<a name="18998"/>18998:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="18999"/>18999:                            ?SEV_ANNOUNCE_CONTINUE(Client, verify_timestamp),
<a name="19000"/>19000:                            ok
<a name="19001"/>19001:                    end},
<a name="19002"/>19002:          #{desc =&gt; &quot;await client ready (timestamp off)&quot;,
<a name="19003"/>19003:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19004"/>19004:                            ?SEV_AWAIT_READY(Client, client, timestamp_off)
<a name="19005"/>19005:                    end},
<a name="19006"/>19006: 
<a name="19007"/>19007:          #{desc =&gt; &quot;order client to continue (with send request 1)&quot;,
<a name="19008"/>19008:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19009"/>19009:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="19010"/>19010:                            ok
<a name="19011"/>19011:                    end},
<a name="19012"/>19012:          #{desc =&gt; &quot;await client ready (with send request 1)&quot;,
<a name="19013"/>19013:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19014"/>19014:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="19015"/>19015:                    end},
<a name="19016"/>19016:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="19017"/>19017:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19018"/>19018:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="19019"/>19019:                    end},
<a name="19020"/>19020:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="19021"/>19021:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19022"/>19022:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="19023"/>19023:                            ok
<a name="19024"/>19024:                    end},
<a name="19025"/>19025:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="19026"/>19026:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19027"/>19027:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="19028"/>19028:                    end},
<a name="19029"/>19029:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="19030"/>19030:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19031"/>19031:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="19032"/>19032:                    end},
<a name="19033"/>19033: 
<a name="19034"/>19034:          %% Second message (w timestamp)
<a name="19035"/>19035: 
<a name="19036"/>19036:          #{desc =&gt; &quot;order client to continue (with enable timestamp)&quot;,
<a name="19037"/>19037:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19038"/>19038:                            ?SEV_ANNOUNCE_CONTINUE(Client, enable_timestamp),
<a name="19039"/>19039:                            ok
<a name="19040"/>19040:                    end},
<a name="19041"/>19041:          #{desc =&gt; &quot;await client ready (timestamp on)&quot;,
<a name="19042"/>19042:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19043"/>19043:                            ?SEV_AWAIT_READY(Client, client, timestamp_on)
<a name="19044"/>19044:                    end},
<a name="19045"/>19045: 
<a name="19046"/>19046:          #{desc =&gt; &quot;order client to continue (with send request 2)&quot;,
<a name="19047"/>19047:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19048"/>19048:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="19049"/>19049:                            ok
<a name="19050"/>19050:                    end},
<a name="19051"/>19051:          #{desc =&gt; &quot;await client ready (with send request 2)&quot;,
<a name="19052"/>19052:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19053"/>19053:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="19054"/>19054:                    end},
<a name="19055"/>19055:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="19056"/>19056:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19057"/>19057:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="19058"/>19058:                    end},
<a name="19059"/>19059:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="19060"/>19060:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19061"/>19061:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="19062"/>19062:                            ok
<a name="19063"/>19063:                    end},
<a name="19064"/>19064:          #{desc =&gt; &quot;await server ready (with reply sent 2)&quot;,
<a name="19065"/>19065:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19066"/>19066:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="19067"/>19067:                    end},
<a name="19068"/>19068:          #{desc =&gt; &quot;await client ready (reply recv 2)&quot;,
<a name="19069"/>19069:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19070"/>19070:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="19071"/>19071:                    end},
<a name="19072"/>19072: 
<a name="19073"/>19073:          %% Third message (wo timestamp)
<a name="19074"/>19074: 
<a name="19075"/>19075:          #{desc =&gt; &quot;order client to continue (with disable timestamp)&quot;,
<a name="19076"/>19076:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19077"/>19077:                            ?SEV_ANNOUNCE_CONTINUE(Client, disable_timestamp),
<a name="19078"/>19078:                            ok
<a name="19079"/>19079:                    end},
<a name="19080"/>19080:          #{desc =&gt; &quot;await client ready (timestamp off)&quot;,
<a name="19081"/>19081:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19082"/>19082:                            ?SEV_AWAIT_READY(Client, client, timestamp_off)
<a name="19083"/>19083:                    end},
<a name="19084"/>19084: 
<a name="19085"/>19085:          #{desc =&gt; &quot;order client to continue (with send request 3)&quot;,
<a name="19086"/>19086:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19087"/>19087:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="19088"/>19088:                            ok
<a name="19089"/>19089:                    end},
<a name="19090"/>19090:          #{desc =&gt; &quot;await client ready (with send request 3)&quot;,
<a name="19091"/>19091:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19092"/>19092:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="19093"/>19093:                    end},
<a name="19094"/>19094:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="19095"/>19095:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19096"/>19096:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="19097"/>19097:                    end},
<a name="19098"/>19098:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="19099"/>19099:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19100"/>19100:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="19101"/>19101:                            ok
<a name="19102"/>19102:                    end},
<a name="19103"/>19103:          #{desc =&gt; &quot;await server ready (with reply sent 3)&quot;,
<a name="19104"/>19104:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19105"/>19105:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="19106"/>19106:                    end},
<a name="19107"/>19107:          #{desc =&gt; &quot;await client ready (reply recv 3)&quot;,
<a name="19108"/>19108:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19109"/>19109:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="19110"/>19110:                    end},
<a name="19111"/>19111: 
<a name="19112"/>19112: 
<a name="19113"/>19113:          %% *** Termination ***
<a name="19114"/>19114:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="19115"/>19115:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19116"/>19116:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="19117"/>19117:                            ok
<a name="19118"/>19118:                    end},
<a name="19119"/>19119:          #{desc =&gt; &quot;await client termination&quot;,
<a name="19120"/>19120:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="19121"/>19121:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="19122"/>19122:                            State1 = maps:remove(client, State),
<a name="19123"/>19123:                            {ok, State1}
<a name="19124"/>19124:                    end},
<a name="19125"/>19125:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="19126"/>19126:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19127"/>19127:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="19128"/>19128:                            ok
<a name="19129"/>19129:                    end},
<a name="19130"/>19130:          #{desc =&gt; &quot;await server termination&quot;,
<a name="19131"/>19131:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="19132"/>19132:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="19133"/>19133:                            State1 = maps:remove(server, State),
<a name="19134"/>19134:                            {ok, State1}
<a name="19135"/>19135:                    end},
<a name="19136"/>19136: 
<a name="19137"/>19137:          %% *** We are done ***
<a name="19138"/>19138:          ?SEV_FINISH_NORMAL
<a name="19139"/>19139:         ],
<a name="19140"/>19140: 
<a name="19141"/>19141: 
<a name="19142"/>19142:     i(&quot;start server evaluator&quot;),
<a name="19143"/>19143:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="19144"/>19144: 
<a name="19145"/>19145:     i(&quot;start client evaluator&quot;),
<a name="19146"/>19146:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="19147"/>19147: 
<a name="19148"/>19148:     i(&quot;start tester evaluator&quot;),
<a name="19149"/>19149:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="19150"/>19150:                         client =&gt; Client#ev.pid},
<a name="19151"/>19151:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="19152"/>19152: 
<a name="api_opt_sock_timestamp_tcp-last_expr"/><a name="19153"/>19153: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="19154"/>19154: 
<a name="19155"/>19155: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19156"/>19156: 
<a name="19157"/>19157: <i>%% Tests that the add_mambership and drop_membership ip options work.</i>
<a name="19158"/>19158: <i>%% We create one server and two clients. The server only send messages,</i>
<a name="19159"/>19159: <i>%% the clients only receives messages.</i>
<a name="19160"/>19160: <i>%% An UDP datagram is forbidden (RFC 1122) from having a source address</i>
<a name="19161"/>19161: <i>%% that is a multicast address (or a broadcast address).</i>
<a name="19162"/>19162: <i>%% So, the server create a socket &quot;for sending&quot; and the clients sockets</i>
<a name="19163"/>19163: <i>%% &quot;for receiving&quot;.</i>
<a name="19164"/>19164: <i>%% Sending socket:   Bound to the local address (and any port).</i>
<a name="19165"/>19165: <i>%%                   When sending, the dest will be the multicast address</i>
<a name="19166"/>19166: <i>%%                   and port of the receiving socket.</i>
<a name="19167"/>19167: <i>%% Receiving socket: Bound to the multicast address and port.</i>
<a name="api_opt_ip_add_drop_membership-0"/><a name="19168"/>19168: <b>api_opt_ip_add_drop_membership</b>() -&gt;
<a name="api_opt_ip_add_drop_membership-last_expr"/><a name="19169"/>19169: <b>    [{doc, &quot;OTP-15908 </b>(ERL-980)&quot;}].
<a name="19170"/>19170: 
<a name="api_opt_ip_add_drop_membership-1"/><a name="19171"/>19171: <b>api_opt_ip_add_drop_membership</b>(_Config) when is_list(_Config) -&gt;
<a name="19172"/>19172:     ?TT(?SECS(30)),
<a name="api_opt_ip_add_drop_membership-last_expr"/><a name="19173"/>19173: <b>    tc_try</b>(api_opt_ip_add_drop_membership,
<a name="19174"/>19174:            fun() -&gt;
<a name="19175"/>19175:                    has_support_ip_add_membership(),
<a name="19176"/>19176:                    has_support_ip_drop_membership(),
<a name="19177"/>19177:                    has_support_ip_multicast()
<a name="19178"/>19178:            end,
<a name="19179"/>19179:            fun() -&gt; api_opt_ip_add_drop_membership_do() end).
<a name="19180"/>19180: 
<a name="19181"/>19181: 
<a name="api_opt_ip_add_drop_membership_do-0"/><a name="19182"/>19182: <b>api_opt_ip_add_drop_membership_do</b>() -&gt;
<a name="19183"/>19183:     Set = fun(S, Key, Val) -&gt;
<a name="19184"/>19184:                   socket:setopt(S, ip, Key, Val)
<a name="19185"/>19185:           end,
<a name="19186"/>19186:     AddMembership  = fun(S, Val) -&gt; Set(S, add_membership,  Val) end,
<a name="19187"/>19187:     DropMembership = fun(S, Val) -&gt; Set(S, drop_membership, Val) end,
<a name="19188"/>19188: 
<a name="19189"/>19189:     ServerSeq =
<a name="19190"/>19190:         [
<a name="19191"/>19191:          %% *** Wait for start order part ***
<a name="19192"/>19192:          #{desc =&gt; &quot;await start&quot;,
<a name="19193"/>19193:            cmd  =&gt; fun(State) -&gt;
<a name="19194"/>19194:                            {Tester, MSA} = ?SEV_AWAIT_START(),
<a name="19195"/>19195:                            {ok, State#{tester =&gt; Tester, msa =&gt; MSA}}
<a name="19196"/>19196:                    end},
<a name="19197"/>19197:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="19198"/>19198:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19199"/>19199:                            _MRef = erlang:monitor(process, Tester),
<a name="19200"/>19200:                            ok
<a name="19201"/>19201:                    end},
<a name="19202"/>19202: 
<a name="19203"/>19203:          %% *** Init part ***
<a name="19204"/>19204:          #{desc =&gt; &quot;which local address&quot;,
<a name="19205"/>19205:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="19206"/>19206:                            LSA = which_local_socket_addr(Domain),
<a name="19207"/>19207:                            {ok, State#{local_sa =&gt; LSA}}
<a name="19208"/>19208:                    end},
<a name="19209"/>19209:          #{desc =&gt; &quot;create socket&quot;,
<a name="19210"/>19210:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="19211"/>19211:                            case socket:open(Domain, dgram, udp) of
<a name="19212"/>19212:                                {ok, Sock} -&gt;
<a name="19213"/>19213:                                    {ok, State#{sock =&gt; Sock}};
<a name="19214"/>19214:                                {error, _} = ERROR -&gt;
<a name="19215"/>19215:                                    ERROR
<a name="19216"/>19216:                            end
<a name="19217"/>19217:                    end},
<a name="19218"/>19218:          #{desc =&gt; &quot;make recv socket reuse addr&quot;,
<a name="19219"/>19219:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="19220"/>19220:                            case socket:setopt(Sock, socket, reuseaddr, true) of
<a name="19221"/>19221:                                ok -&gt;
<a name="19222"/>19222:                                    ok;
<a name="19223"/>19223:                                {error, Reason} = ERROR -&gt;
<a name="19224"/>19224:                                    ?SEV_EPRINT(&quot;Failed set reuseaddr: &quot;
<a name="19225"/>19225:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="19226"/>19226:                                    ERROR
<a name="19227"/>19227:                            end
<a name="19228"/>19228:                    end},
<a name="19229"/>19229:          #{desc =&gt; &quot;bind recv socket to multicast address&quot;,
<a name="19230"/>19230:            cmd  =&gt; fun(#{sock := Sock, msa := MSA} = State) -&gt;
<a name="19231"/>19231:                            case sock_bind(Sock, MSA) of
<a name="19232"/>19232:                                ok -&gt;
<a name="19233"/>19233:                                    Port = sock_port(Sock),
<a name="19234"/>19234:                                    ?SEV_IPRINT(&quot;bound to:&quot;
<a name="19235"/>19235:                                                &quot;~n   ~p&quot;, [Port]),
<a name="19236"/>19236:                                    {ok, State#{msa =&gt; MSA#{port =&gt; Port}}};
<a name="19237"/>19237:                                {error, _} = ERROR -&gt;
<a name="19238"/>19238:                                    ERROR
<a name="19239"/>19239:                            end
<a name="19240"/>19240:                    end},
<a name="19241"/>19241:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="19242"/>19242:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19243"/>19243:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="19244"/>19244:                            ok
<a name="19245"/>19245:                    end},
<a name="19246"/>19246: 
<a name="19247"/>19247:          %% The actual test
<a name="19248"/>19248:          #{desc =&gt; &quot;await continue (add_membership)&quot;,
<a name="19249"/>19249:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19250"/>19250:                            ?SEV_AWAIT_CONTINUE(Tester, tester, add_membership)
<a name="19251"/>19251:                    end},
<a name="19252"/>19252:          #{desc =&gt; &quot;add membership&quot;,
<a name="19253"/>19253:            cmd  =&gt; fun(#{sock     := Sock,
<a name="19254"/>19254:                          msa      := #{addr := MAddr},
<a name="19255"/>19255:                          local_sa := #{addr := Addr}} = State) -&gt;
<a name="19256"/>19256:                            MReq = #{multiaddr =&gt; MAddr,
<a name="19257"/>19257:                                     interface =&gt; Addr},
<a name="19258"/>19258:                            ?SEV_IPRINT(&quot;try add membership to:&quot;
<a name="19259"/>19259:                                        &quot;~n   ~p&quot;, [MReq]),
<a name="19260"/>19260:                            case AddMembership(Sock, MReq) of
<a name="19261"/>19261:                                ok -&gt;
<a name="19262"/>19262:                                    ?SEV_IPRINT(&quot;membership added&quot;),
<a name="19263"/>19263:                                    {ok, State#{mreq =&gt; MReq}};
<a name="19264"/>19264:                                {error, Reason} = ERROR -&gt;
<a name="19265"/>19265:                                    ?SEV_EPRINT(&quot;Failed adding membership to: &quot;
<a name="19266"/>19266:                                                &quot;~n   ~p&quot;
<a name="19267"/>19267:                                                &quot;~n   Reason:  ~p&quot;,
<a name="19268"/>19268:                                                [MReq, Reason]),
<a name="19269"/>19269:                                    ERROR
<a name="19270"/>19270:                            end
<a name="19271"/>19271:                    end},
<a name="19272"/>19272:          #{desc =&gt; &quot;announce ready (add-membership)&quot;,
<a name="19273"/>19273:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19274"/>19274:                            ?SEV_ANNOUNCE_READY(Tester, add_membership),
<a name="19275"/>19275:                            ok
<a name="19276"/>19276:                    end},
<a name="19277"/>19277: 
<a name="19278"/>19278:          #{desc =&gt; &quot;await continue (drop_membership)&quot;,
<a name="19279"/>19279:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19280"/>19280:                            ?SEV_AWAIT_CONTINUE(Tester, tester, drop_membership)
<a name="19281"/>19281:                    end},
<a name="19282"/>19282:          #{desc =&gt; &quot;drop membership&quot;,
<a name="19283"/>19283:            cmd  =&gt; fun(#{sock := Sock,
<a name="19284"/>19284:                          mreq := MReq} = State) -&gt;
<a name="19285"/>19285:                            ?SEV_IPRINT(&quot;try drop membership from:&quot;
<a name="19286"/>19286:                                        &quot;~n   ~p&quot;, [MReq]),
<a name="19287"/>19287:                            case DropMembership(Sock, MReq) of
<a name="19288"/>19288:                                ok -&gt;
<a name="19289"/>19289:                                    ?SEV_IPRINT(&quot;membership dropped&quot;),
<a name="19290"/>19290:                                    {ok, maps:remove(mreq, State)};
<a name="19291"/>19291:                                {error, Reason} = ERROR -&gt;
<a name="19292"/>19292:                                    ?SEV_EPRINT(&quot;Failed drop membership from: &quot;
<a name="19293"/>19293:                                                &quot;~n   ~p&quot;
<a name="19294"/>19294:                                                &quot;~n   Reason:  ~p&quot;,
<a name="19295"/>19295:                                                [MReq, Reason]),
<a name="19296"/>19296:                                    ERROR
<a name="19297"/>19297:                            end
<a name="19298"/>19298:                    end},
<a name="19299"/>19299:          #{desc =&gt; &quot;announce ready (drop-membership)&quot;,
<a name="19300"/>19300:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19301"/>19301:                            ?SEV_ANNOUNCE_READY(Tester, drop_membership),
<a name="19302"/>19302:                            ok
<a name="19303"/>19303:                    end},
<a name="19304"/>19304: 
<a name="19305"/>19305: 
<a name="19306"/>19306:          %% Termination
<a name="19307"/>19307:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="19308"/>19308:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="19309"/>19309:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="19310"/>19310:                                ok -&gt;
<a name="19311"/>19311:                                    {ok, maps:remove(tester, State)};
<a name="19312"/>19312:                                {error, _} = ERROR -&gt;
<a name="19313"/>19313:                                    ERROR
<a name="19314"/>19314:                            end
<a name="19315"/>19315:                    end},
<a name="19316"/>19316:          #{desc =&gt; &quot;close socket&quot;,
<a name="19317"/>19317:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="19318"/>19318:                            socket:close(Sock),
<a name="19319"/>19319:                            {ok, maps:remove(sock, State)}
<a name="19320"/>19320:                    end},
<a name="19321"/>19321: 
<a name="19322"/>19322:          %% *** We are done ***
<a name="19323"/>19323:          ?SEV_FINISH_NORMAL
<a name="19324"/>19324:         ],
<a name="19325"/>19325: 
<a name="19326"/>19326: 
<a name="19327"/>19327:     TesterSeq =
<a name="19328"/>19328:         [
<a name="19329"/>19329:          %% *** Init part ***
<a name="19330"/>19330:          #{desc =&gt; &quot;monitor server&quot;,
<a name="19331"/>19331:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19332"/>19332:                            _MRef = erlang:monitor(process, Server),
<a name="19333"/>19333:                            ok
<a name="19334"/>19334:                    end},
<a name="19335"/>19335: 
<a name="19336"/>19336:          %% Start the server
<a name="19337"/>19337:          #{desc =&gt; &quot;order server start&quot;,
<a name="19338"/>19338:            cmd  =&gt; fun(#{server := Pid, msa := MSA} = _State) -&gt;
<a name="19339"/>19339:                            ?SEV_ANNOUNCE_START(Pid, MSA),
<a name="19340"/>19340:                            ok
<a name="19341"/>19341:                    end},
<a name="19342"/>19342:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="19343"/>19343:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="19344"/>19344:                            case ?SEV_AWAIT_READY(Pid, server, init) of
<a name="19345"/>19345:                                ok -&gt;
<a name="19346"/>19346:                                    ok;
<a name="19347"/>19347:                                {error, Reason} = ERROR -&gt;
<a name="19348"/>19348:                                    ?SEV_EPRINT(&quot;Start of server failed: &quot;
<a name="19349"/>19349:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="19350"/>19350:                                    ERROR
<a name="19351"/>19351:                            end
<a name="19352"/>19352:                    end},
<a name="19353"/>19353: 
<a name="19354"/>19354: 
<a name="19355"/>19355:          %% *** The actual test ***
<a name="19356"/>19356:          #{desc =&gt; &quot;order server to continue (add-membership)&quot;,
<a name="19357"/>19357:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19358"/>19358:                            ?SEV_ANNOUNCE_CONTINUE(Server, add_membership),
<a name="19359"/>19359:                            ok
<a name="19360"/>19360:                    end},
<a name="19361"/>19361:          #{desc =&gt; &quot;await server ready (add-membership)&quot;,
<a name="19362"/>19362:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19363"/>19363:                            ?SEV_AWAIT_READY(Server, server, add_membership)
<a name="19364"/>19364:                    end},
<a name="19365"/>19365: 
<a name="19366"/>19366:          #{desc =&gt; &quot;order server to continue (drop-membership)&quot;,
<a name="19367"/>19367:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19368"/>19368:                            ?SEV_ANNOUNCE_CONTINUE(Server, drop_membership),
<a name="19369"/>19369:                            ok
<a name="19370"/>19370:                    end},
<a name="19371"/>19371:          #{desc =&gt; &quot;await server ready (drop-membership)&quot;,
<a name="19372"/>19372:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19373"/>19373:                            ?SEV_AWAIT_READY(Server, server, drop_membership)
<a name="19374"/>19374:                    end},
<a name="19375"/>19375: 
<a name="19376"/>19376:          ?SEV_SLEEP(?SECS(1)),
<a name="19377"/>19377: 
<a name="19378"/>19378:          %% *** Termination ***
<a name="19379"/>19379:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="19380"/>19380:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19381"/>19381:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="19382"/>19382:                            ok
<a name="19383"/>19383:                    end},
<a name="19384"/>19384:          #{desc =&gt; &quot;await server termination&quot;,
<a name="19385"/>19385:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="19386"/>19386:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="19387"/>19387:                            {ok, maps:remove(server, State)}
<a name="19388"/>19388:                    end},
<a name="19389"/>19389: 
<a name="19390"/>19390:          %% *** We are done ***
<a name="19391"/>19391:          ?SEV_FINISH_NORMAL
<a name="19392"/>19392:         ],
<a name="19393"/>19393: 
<a name="19394"/>19394: 
<a name="19395"/>19395:     Domain = inet,
<a name="19396"/>19396:     i(&quot;get multicast address&quot;),
<a name="19397"/>19397:     MAddr  = which_ip_multicast_address(),
<a name="19398"/>19398:     MSA    = #{family =&gt; Domain, addr =&gt; MAddr},
<a name="19399"/>19399: 
<a name="19400"/>19400:     i(&quot;start server evaluator&quot;),
<a name="19401"/>19401:     ServerInitState = #{domain =&gt; Domain},
<a name="19402"/>19402:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="19403"/>19403: 
<a name="19404"/>19404:     i(&quot;start tester evaluator&quot;),
<a name="19405"/>19405:     TesterInitState = #{domain  =&gt; Domain,
<a name="19406"/>19406:                         msa     =&gt; MSA,
<a name="19407"/>19407:                         server  =&gt; Server#ev.pid},
<a name="19408"/>19408:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="19409"/>19409: 
<a name="19410"/>19410:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_ip_add_drop_membership_do-last_expr"/><a name="19411"/>19411: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester, Server]).
<a name="19412"/>19412: 
<a name="19413"/>19413: 
<a name="19414"/>19414: 
<a name="which_ip_multicast_address-0"/><a name="19415"/>19415: <b>which_ip_multicast_address</b>() -&gt;
<a name="which_ip_multicast_address-last_expr"/><a name="19416"/>19416: <b>    which_multicast_address</b>(inet).
<a name="19417"/>19417: 
<a name="which_multicast_address-1"/><a name="19418"/>19418: <b>which_multicast_address</b>(Domain) -&gt;
<a name="which_multicast_address-last_expr"/><a name="19419"/>19419: <b>    case os:type</b>() of
<a name="19420"/>19420:         {unix, linux} -&gt;
<a name="19421"/>19421:             WhichMAddr = fun([_, _, MAddr]) -&gt; MAddr end,
<a name="19422"/>19422:             which_multicast_address2(Domain, WhichMAddr);
<a name="19423"/>19423: 
<a name="19424"/>19424:         {unix, sunos} -&gt;
<a name="19425"/>19425:             WhichMAddr = fun([_, MAddr, _]) -&gt; MAddr end,
<a name="19426"/>19426:             which_multicast_address2(Domain, WhichMAddr);
<a name="19427"/>19427: 
<a name="19428"/>19428:         Type -&gt;
<a name="19429"/>19429:             %% Actually, what is &quot;not supported&quot;. is netstat!
<a name="19430"/>19430:             not_supported({multicast, Type})
<a name="19431"/>19431:     end.
<a name="19432"/>19432: 
<a name="19433"/>19433: <i>%% Note that the 'netstat -g' table looks different on linux and SunOS</i>
<a name="19434"/>19434: <i>%% Linux: IfName - RefCnt - Group</i>
<a name="19435"/>19435: <i>%% SunOS: IfName - Group  - RefCnt</i>
<a name="19436"/>19436: 
<a name="which_multicast_address2-2"/><a name="19437"/>19437: <b>which_multicast_address2</b>(Domain, WhichMAddr) -&gt;
<a name="19438"/>19438:     IfName = which_local_host_ifname(Domain),
<a name="19439"/>19439:     %% On some platforms the netstat barfs out some crap on stderr
<a name="19440"/>19440:     %% before the actual info...
<a name="19441"/>19441:     %% ...without the 'n' (that is; just '-g') this command can take a
<a name="19442"/>19442:     %% *long* time. *With* the 'n' its much better. But just to be on
<a name="19443"/>19443:     %% the safe side, we add a timeout of 10 seconds.
<a name="which_multicast_address2-last_expr"/><a name="19444"/>19444: <b>    case ?SLIB:os_cmd</b>(&quot;netstat -gn 2&gt;/dev/null | grep &quot; ++ IfName, ?SECS(10)) of
<a name="19445"/>19445:         {error, timeout} -&gt;
<a name="19446"/>19446:             skip({netstat, timeout});
<a name="19447"/>19447:         {ok, []} -&gt;
<a name="19448"/>19448:             %% Can't figure out if we support multicast or not...
<a name="19449"/>19449:             not_supported(no_netstat);
<a name="19450"/>19450:         {ok, NetstatGroupsStr} -&gt;
<a name="19451"/>19451:             try
<a name="19452"/>19452:                 begin
<a name="19453"/>19453:                     NetstatGroups0   = string:tokens(NetstatGroupsStr, [$\n]),
<a name="19454"/>19454:                     NetstatGroups    = [string:tokens(G, [$ ]) || 
<a name="19455"/>19455:                                            G &lt;- NetstatGroups0],
<a name="19456"/>19456:                     MAddrs           = [WhichMAddr(NetstatGroup) || 
<a name="19457"/>19457:                                            NetstatGroup &lt;- NetstatGroups],
<a name="19458"/>19458:                     which_multicast_address3(Domain, MAddrs)
<a name="19459"/>19459:                 end
<a name="19460"/>19460:             catch
<a name="19461"/>19461:                 throw:E:_ -&gt;
<a name="19462"/>19462:                     throw(E);
<a name="19463"/>19463:                 C:E:S -&gt;
<a name="19464"/>19464:                     not_supported({multicast, {C,E,S}})
<a name="19465"/>19465:             end
<a name="19466"/>19466:     end.
<a name="19467"/>19467: 
<a name="which_multicast_address3-2"/><a name="19468"/>19468: <b>which_multicast_address3</b>(_Domain, []) -&gt;
<a name="19469"/>19469:     not_supported({multicast, no_valid_addrs});
<a name="19470"/>19470: <b>which_multicast_address3</b>(Domain, [MAddrStr|MAddrs]) -&gt;
<a name="19471"/>19471:     %% Even on linux some of these are not actually addresses, but
<a name="19472"/>19472:     %% &quot;host names&quot;, such as all-systems.mcast.net. But both
<a name="19473"/>19473:     %% address strings, such as &quot;224.0.0.251&quot; and host name strings
<a name="19474"/>19474:     %% gets translated into an address by the inet:inet:getaddr/2.
<a name="which_multicast_address3-last_expr"/><a name="19475"/>19475: <b>    case inet:getaddr</b>(MAddrStr, Domain) of
<a name="19476"/>19476:         {ok, MAddr} -&gt;
<a name="19477"/>19477:             MAddr;
<a name="19478"/>19478:         {error, _} -&gt;
<a name="19479"/>19479:             which_multicast_address3(Domain, MAddrs)
<a name="19480"/>19480:     end.
<a name="19481"/>19481:     
<a name="which_local_host_ifname-1"/><a name="19482"/>19482: <b>which_local_host_ifname</b>(Domain) -&gt;
<a name="which_local_host_ifname-last_expr"/><a name="19483"/>19483: <b>    case ?SLIB:which_local_host_info</b>(Domain) of
<a name="19484"/>19484:         {ok, #{name := Name}} -&gt;
<a name="19485"/>19485:             Name;
<a name="19486"/>19486:         {error, Reason} -&gt;
<a name="19487"/>19487:             not_supported({multicast, Reason})
<a name="19488"/>19488:     end.
<a name="19489"/>19489: 
<a name="19490"/>19490:     
<a name="19491"/>19491: 
<a name="19492"/>19492: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19493"/>19493: 
<a name="19494"/>19494: <i>%% Tests that the pktinfo control message header is received when</i>
<a name="19495"/>19495: <i>%% setting the socket 'ip' option pktinfo is set to true when using</i>
<a name="19496"/>19496: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="19497"/>19497: <i>%% So, this is done on the receiving side: </i>
<a name="19498"/>19498: <i>%%</i>
<a name="19499"/>19499: <i>%%               socket:setopt(Sock, ip, pktinfo, boolean()).</i>
<a name="19500"/>19500: <i>%%</i>
<a name="19501"/>19501: <i>%% For all subsequent *received* messages, the pktinfo control message</i>
<a name="19502"/>19502: <i>%% header will be with the message.</i>
<a name="19503"/>19503: <i>%%</i>
<a name="19504"/>19504: <i>%% Note that it *should* be possible to explicitly send pktinfo also,</i>
<a name="19505"/>19505: <i>%% but this have not yet been implemented (in socket), so that part</i>
<a name="19506"/>19506: <i>%% we do not test!!</i>
<a name="19507"/>19507: <i>%%</i>
<a name="19508"/>19508: 
<a name="api_opt_ip_pktinfo_udp4-1"/><a name="19509"/>19509: <b>api_opt_ip_pktinfo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="19510"/>19510:     ?TT(?SECS(5)),
<a name="api_opt_ip_pktinfo_udp4-last_expr"/><a name="19511"/>19511: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="19512"/>19512:            fun() -&gt; has_support_ipv4(), has_support_ip_pktinfo() end,
<a name="19513"/>19513:            fun() -&gt;
<a name="19514"/>19514:                    Set  = fun(Sock, Value) -&gt;
<a name="19515"/>19515:                                   socket:setopt(Sock, ip, pktinfo, Value)
<a name="19516"/>19516:                           end,
<a name="19517"/>19517:                    Get  = fun(Sock) -&gt;
<a name="19518"/>19518:                                   socket:getopt(Sock, ip, pktinfo)
<a name="19519"/>19519:                           end,
<a name="19520"/>19520:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="19521"/>19521:                                   Msg = #{addr =&gt; Dest,
<a name="19522"/>19522:                                           iov  =&gt; [Data]},
<a name="19523"/>19523:                                   socket:sendmsg(Sock, Msg);
<a name="19524"/>19524:                              (Sock, Data, Dest, Info) -&gt;
<a name="19525"/>19525:                                   %% We do not support this at the moment!!!
<a name="19526"/>19526:                                   CMsg = #{level =&gt; ip,
<a name="19527"/>19527:                                            type  =&gt; pktinfo,
<a name="19528"/>19528:                                            data  =&gt; Info},
<a name="19529"/>19529:                                   Msg  = #{addr =&gt; Dest,
<a name="19530"/>19530:                                            ctrl =&gt; [CMsg],
<a name="19531"/>19531:                                            iov  =&gt; [Data]},
<a name="19532"/>19532:                                   socket:sendmsg(Sock, Msg)
<a name="19533"/>19533:                           end,
<a name="19534"/>19534:                    Recv = fun(Sock) -&gt;
<a name="19535"/>19535:                                   case socket:recvmsg(Sock) of
<a name="19536"/>19536:                                       {ok, #{addr := Source,
<a name="19537"/>19537:                                              ctrl := CMsgs,
<a name="19538"/>19538:                                              iov  := [Data]}} -&gt;
<a name="19539"/>19539:                                           {ok, {Source, CMsgs, Data}};
<a name="19540"/>19540:                                       {error, _} = ERROR -&gt;
<a name="19541"/>19541:                                           ERROR
<a name="19542"/>19542:                                   end
<a name="19543"/>19543:                           end,
<a name="19544"/>19544:                    InitState = #{domain =&gt; inet,
<a name="19545"/>19545:                                  proto  =&gt; udp,
<a name="19546"/>19546:                                  send   =&gt; Send,
<a name="19547"/>19547:                                  recv   =&gt; Recv,
<a name="19548"/>19548:                                  set    =&gt; Set,
<a name="19549"/>19549:                                  get    =&gt; Get},
<a name="19550"/>19550:                    ok = api_opt_ip_pktinfo_udp(InitState)
<a name="19551"/>19551:            end).
<a name="19552"/>19552: 
<a name="19553"/>19553: 
<a name="19554"/>19554: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19555"/>19555: 
<a name="api_opt_ip_pktinfo_udp-1"/><a name="19556"/>19556: <b>api_opt_ip_pktinfo_udp</b>(InitState) -&gt;
<a name="19557"/>19557:     Seq = 
<a name="19558"/>19558:         [
<a name="19559"/>19559:          #{desc =&gt; &quot;local address&quot;,
<a name="19560"/>19560:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="19561"/>19561:                            LSASrc = which_local_socket_addr(Domain),
<a name="19562"/>19562:                            LSADst = which_local_socket_addr(Domain),
<a name="19563"/>19563:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="19564"/>19564:                                        lsa_dst =&gt; LSADst}};
<a name="19565"/>19565:                       (#{domain := Domain} = State) -&gt;
<a name="19566"/>19566:                            LSA = which_local_socket_addr(Domain),
<a name="19567"/>19567:                            {ok, State#{lsa_src =&gt; LSA,
<a name="19568"/>19568:                                        lsa_dst =&gt; LSA}}
<a name="19569"/>19569:                    end},
<a name="19570"/>19570: 
<a name="19571"/>19571:          #{desc =&gt; &quot;open src socket&quot;,
<a name="19572"/>19572:            cmd  =&gt; fun(#{domain := Domain,
<a name="19573"/>19573:                          proto  := Proto} = State) -&gt;
<a name="19574"/>19574:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19575"/>19575:                            {ok, State#{sock_src =&gt; Sock}}
<a name="19576"/>19576:                    end},
<a name="19577"/>19577:          #{desc =&gt; &quot;bind src&quot;,
<a name="19578"/>19578:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="19579"/>19579:                            case sock_bind(Sock, LSA) of
<a name="19580"/>19580:                                ok -&gt;
<a name="19581"/>19581:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19582"/>19582:                                    ok;
<a name="19583"/>19583:                                {error, Reason} = ERROR -&gt;
<a name="19584"/>19584:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19585"/>19585:                                    ERROR
<a name="19586"/>19586:                            end
<a name="19587"/>19587:                    end},
<a name="19588"/>19588:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="19589"/>19589:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="19590"/>19590:                            SASrc = sock_sockname(Sock),
<a name="19591"/>19591:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="19592"/>19592:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="19593"/>19593:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="19594"/>19594:                    end},
<a name="19595"/>19595: 
<a name="19596"/>19596:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="19597"/>19597:            cmd  =&gt; fun(#{domain := Domain,
<a name="19598"/>19598:                          proto  := Proto} = State) -&gt;
<a name="19599"/>19599:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19600"/>19600:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="19601"/>19601:                    end},
<a name="19602"/>19602:          #{desc =&gt; &quot;bind dst&quot;,
<a name="19603"/>19603:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="19604"/>19604:                            case sock_bind(Sock, LSA) of
<a name="19605"/>19605:                                ok -&gt;
<a name="19606"/>19606:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19607"/>19607:                                    ok;
<a name="19608"/>19608:                                {error, Reason} = ERROR -&gt;
<a name="19609"/>19609:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19610"/>19610:                                    ERROR
<a name="19611"/>19611:                            end
<a name="19612"/>19612:                    end},
<a name="19613"/>19613:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="19614"/>19614:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="19615"/>19615:                            SADst = sock_sockname(Sock),
<a name="19616"/>19616:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="19617"/>19617:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="19618"/>19618:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="19619"/>19619:                    end},
<a name="19620"/>19620:          #{desc =&gt; &quot;get default pktinfo for dst socket&quot;,
<a name="19621"/>19621:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="19622"/>19622:                            case Get(Sock) of
<a name="19623"/>19623:                                {ok, false = Value} -&gt;
<a name="19624"/>19624:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="19625"/>19625:                                    ok;
<a name="19626"/>19626:                                {ok, Unexpected} -&gt;
<a name="19627"/>19627:                                    ?SEV_EPRINT(&quot;Unexpected src pktinfo: ~p&quot;,
<a name="19628"/>19628:                                                [Unexpected]),
<a name="19629"/>19629:                                    {error, {unexpected, Unexpected}};
<a name="19630"/>19630:                                {error, Reason} = ERROR -&gt;
<a name="19631"/>19631:                                    ?SEV_EPRINT(&quot;Failed getting (default) pktinfo:&quot;
<a name="19632"/>19632:                                                &quot;   ~p&quot;, [Reason]),
<a name="19633"/>19633:                                    ERROR
<a name="19634"/>19634:                            end
<a name="19635"/>19635:                    end},
<a name="19636"/>19636: 
<a name="19637"/>19637:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) pktinfo)&quot;,
<a name="19638"/>19638:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19639"/>19639:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="19640"/>19640:                    end},
<a name="19641"/>19641:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="19642"/>19642:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19643"/>19643:                            case Recv(Sock) of
<a name="19644"/>19644:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="19645"/>19645:                                    ok;
<a name="19646"/>19646:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19647"/>19647:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19648"/>19648:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19649"/>19649:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="19650"/>19650:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19651"/>19651:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19652"/>19652:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19653"/>19653:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="19654"/>19654:                                                [Src, BadSrc,
<a name="19655"/>19655:                                                 [], BadCHdrs,
<a name="19656"/>19656:                                                 ?BASIC_REQ, BadReq]),
<a name="19657"/>19657:                                    {error, {unexpected_data, UnexpData}};
<a name="19658"/>19658:                                {ok, UnexpData} -&gt;
<a name="19659"/>19659:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19660"/>19660:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19661"/>19661:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19662"/>19662:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19663"/>19663:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="19664"/>19664:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19665"/>19665:                                    {error, {unexpected_data, UnexpData}};
<a name="19666"/>19666:                                {error, _} = ERROR -&gt;
<a name="19667"/>19667:                                    %% At the moment there is no way to get
<a name="19668"/>19668:                                    %% status or state for the socket...
<a name="19669"/>19669:                                    ERROR
<a name="19670"/>19670:                            end
<a name="19671"/>19671:                    end},
<a name="19672"/>19672: 
<a name="19673"/>19673: 
<a name="19674"/>19674:          %% *** We do not *yet* support sending pktinfo ***
<a name="19675"/>19675: 
<a name="19676"/>19676:          %% #{desc =&gt; &quot;send req (to dst) (w explicit pktinfo)&quot;,
<a name="19677"/>19677:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19678"/>19678:          %%                   Send(Sock, ?BASIC_REQ, Dst, PktInfo)
<a name="19679"/>19679:          %%           end},
<a name="19680"/>19680:          %% #{desc =&gt; &quot;recv req (from src) - wo pktinfo&quot;,
<a name="19681"/>19681:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19682"/>19682:          %%                   case Recv(Sock) of
<a name="19683"/>19683:          %%                       {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="19684"/>19684:          %%                           ok;
<a name="19685"/>19685:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19686"/>19686:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19687"/>19687:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="19688"/>19688:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="19689"/>19689:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19690"/>19690:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19691"/>19691:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="19692"/>19692:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="19693"/>19693:          %%                                       [Src, BadSrc,
<a name="19694"/>19694:          %%                                        [], BadCHdrs,
<a name="19695"/>19695:          %%                                        ?BASIC_REQ, BadReq]),
<a name="19696"/>19696:          %%                           {error, {unexpected_data, UnexpData}};
<a name="19697"/>19697:          %%                       {ok, UnexpData} -&gt;
<a name="19698"/>19698:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19699"/>19699:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="19700"/>19700:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19701"/>19701:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="19702"/>19702:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="19703"/>19703:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19704"/>19704:          %%                           {error, {unexpected_data, UnexpData}};
<a name="19705"/>19705:          %%                       {error, _} = ERROR -&gt;
<a name="19706"/>19706:          %%                           %% At the moment there is no way to get
<a name="19707"/>19707:          %%                           %% status or state for the socket...
<a name="19708"/>19708:          %%                           ERROR
<a name="19709"/>19709:          %%                   end
<a name="19710"/>19710:          %%           end},
<a name="19711"/>19711: 
<a name="19712"/>19712:          #{desc =&gt; &quot;enable pktinfo on dst socket&quot;,
<a name="19713"/>19713:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="19714"/>19714:                            case Set(Sock, true) of
<a name="19715"/>19715:                                ok -&gt;
<a name="19716"/>19716:                                    ?SEV_IPRINT(&quot;dst pktinfo enabled&quot;),
<a name="19717"/>19717:                                    ok;
<a name="19718"/>19718:                                {error, Reason} = ERROR -&gt;
<a name="19719"/>19719:                                    ?SEV_EPRINT(&quot;Failed setting pktinfo:&quot;
<a name="19720"/>19720:                                                &quot;   ~p&quot;, [Reason]),
<a name="19721"/>19721:                                    ERROR
<a name="19722"/>19722:                            end
<a name="19723"/>19723:                    end},
<a name="19724"/>19724: 
<a name="19725"/>19725:          #{desc =&gt; &quot;send req (to dst) (wo explicit pktinfo)&quot;,
<a name="19726"/>19726:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19727"/>19727:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="19728"/>19728:                    end},
<a name="19729"/>19729:          #{desc =&gt; &quot;recv req (from src) - w default pktinfo&quot;,
<a name="19730"/>19730:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19731"/>19731:                            case Recv(Sock) of
<a name="19732"/>19732:                                {ok, {Src, [#{level := ip,
<a name="19733"/>19733:                                              type  := pktinfo,
<a name="19734"/>19734:                                              value := #{addr     := Addr,
<a name="19735"/>19735:                                                         ifindex  := IfIdx,
<a name="19736"/>19736:                                                         spec_dst := SpecDst}}],
<a name="19737"/>19737:                                      ?BASIC_REQ}} -&gt;
<a name="19738"/>19738:                                    ?SEV_IPRINT(&quot;Got (default) Pkt Info: &quot;
<a name="19739"/>19739:                                                &quot;~n   Addr:      ~p&quot;
<a name="19740"/>19740:                                                &quot;~n   If Index:  ~p&quot;
<a name="19741"/>19741:                                                &quot;~n   Spec Dst:  ~p&quot;,
<a name="19742"/>19742:                                                [Addr, IfIdx, SpecDst]),
<a name="19743"/>19743:                                    ok;
<a name="19744"/>19744:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19745"/>19745:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19746"/>19746:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19747"/>19747:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="19748"/>19748:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19749"/>19749:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19750"/>19750:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19751"/>19751:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="19752"/>19752:                                                [Src, BadSrc,
<a name="19753"/>19753:                                                 [], BadCHdrs,
<a name="19754"/>19754:                                                 ?BASIC_REQ, BadReq]),
<a name="19755"/>19755:                                    {error, {unexpected_data, UnexpData}};
<a name="19756"/>19756:                                {ok, UnexpData} -&gt;
<a name="19757"/>19757:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19758"/>19758:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19759"/>19759:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19760"/>19760:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19761"/>19761:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="19762"/>19762:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19763"/>19763:                                    {error, {unexpected_data, UnexpData}};
<a name="19764"/>19764:                                {error, _} = ERROR -&gt;
<a name="19765"/>19765:                                    %% At the moment there is no way to get
<a name="19766"/>19766:                                    %% status or state for the socket...
<a name="19767"/>19767:                                    ERROR
<a name="19768"/>19768:                            end
<a name="19769"/>19769:                    end},
<a name="19770"/>19770: 
<a name="19771"/>19771: 
<a name="19772"/>19772:          %% *** We do not *yet* support sending pktinfo ***
<a name="19773"/>19773: 
<a name="19774"/>19774:          %% #{desc =&gt; &quot;send req (to dst) (w explicit pktinfo)&quot;,
<a name="19775"/>19775:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19776"/>19776:          %%                   Send(Sock, ?BASIC_REQ, Dst, PktInfo)
<a name="19777"/>19777:          %%           end},
<a name="19778"/>19778:          %% #{desc =&gt; &quot;recv req (from src) - w ttl = 100&quot;,
<a name="19779"/>19779:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19780"/>19780:          %%                   case Recv(Sock) of
<a name="19781"/>19781:          %%                       {ok, {Src, [#{level := ip,
<a name="19782"/>19782:          %%                                     type  := ttl,
<a name="19783"/>19783:          %%                                     data  := PktInfo}], ?BASIC_REQ}} -&gt;
<a name="19784"/>19784:          %%                           ?SEV_IPRINT(&quot;Got Pkt Info: &quot;
<a name="19785"/>19785:          %%                                       &quot;~n   ~p&quot;, [Info]),
<a name="19786"/>19786:          %%                           ok;
<a name="19787"/>19787:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19788"/>19788:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19789"/>19789:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="19790"/>19790:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="19791"/>19791:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19792"/>19792:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19793"/>19793:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="19794"/>19794:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="19795"/>19795:          %%                                       [Src, BadSrc,
<a name="19796"/>19796:          %%                                        [], BadCHdrs,
<a name="19797"/>19797:          %%                                        ?BASIC_REQ, BadReq]),
<a name="19798"/>19798:          %%                           {error, {unexpected_data, UnexpData}};
<a name="19799"/>19799:          %%                       {ok, UnexpData} -&gt;
<a name="19800"/>19800:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19801"/>19801:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="19802"/>19802:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19803"/>19803:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="19804"/>19804:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="19805"/>19805:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19806"/>19806:          %%                           {error, {unexpected_data, UnexpData}};
<a name="19807"/>19807:          %%                       {error, _} = ERROR -&gt;
<a name="19808"/>19808:          %%                           %% At the moment there is no way to get
<a name="19809"/>19809:          %%                           %% status or state for the socket...
<a name="19810"/>19810:          %%                           ERROR
<a name="19811"/>19811:          %%                   end
<a name="19812"/>19812:          %%           end},
<a name="19813"/>19813: 
<a name="19814"/>19814:          #{desc =&gt; &quot;close src socket&quot;,
<a name="19815"/>19815:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="19816"/>19816:                            ok = socket:close(Sock),
<a name="19817"/>19817:                            {ok, maps:remove(sock_src, State)}
<a name="19818"/>19818:                    end},
<a name="19819"/>19819:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="19820"/>19820:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="19821"/>19821:                            ok = socket:close(Sock),
<a name="19822"/>19822:                            {ok, maps:remove(sock_dst, State)}
<a name="19823"/>19823:                    end},
<a name="19824"/>19824: 
<a name="19825"/>19825:          %% *** We are done ***
<a name="19826"/>19826:          ?SEV_FINISH_NORMAL
<a name="19827"/>19827:         ],
<a name="19828"/>19828:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_pktinfo_udp-last_expr"/><a name="19829"/>19829: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="19830"/>19830: 
<a name="19831"/>19831: 
<a name="19832"/>19832: 
<a name="19833"/>19833: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19834"/>19834: 
<a name="19835"/>19835: <i>%% Tests that the options control message header is received when</i>
<a name="19836"/>19836: <i>%% setting the socket 'ip' option recvopts is set to true when using</i>
<a name="19837"/>19837: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="19838"/>19838: <i>%% So, this is done on the receiving side: </i>
<a name="19839"/>19839: <i>%%</i>
<a name="19840"/>19840: <i>%%               socket:setopt(Sock, ip, recvopts, boolean()).</i>
<a name="19841"/>19841: <i>%%</i>
<a name="19842"/>19842: <i>%% For all subsequent *received* messages, the options control message</i>
<a name="19843"/>19843: <i>%% header will be with the message.</i>
<a name="19844"/>19844: <i>%%</i>
<a name="19845"/>19845: <i>%% Note that it *should* be possible to explicitly send options also,</i>
<a name="19846"/>19846: <i>%% but this have not yet been implemented (in socket), so that part</i>
<a name="19847"/>19847: <i>%% we do not test!!</i>
<a name="19848"/>19848: <i>%%</i>
<a name="19849"/>19849: <i>%%</i>
<a name="19850"/>19850: <i>%% &lt;NOTE&gt;</i>
<a name="19851"/>19851: <i>%%</i>
<a name="19852"/>19852: <i>%% This test does not currently work. The recvopts is supposed to</i>
<a name="19853"/>19853: <i>%% result in a IP_OPTIONS control message header but does not!</i>
<a name="19854"/>19854: <i>%% So, exactly how we are suppose to use this option is unknown.</i>
<a name="19855"/>19855: <i>%% So, let the test code remain, but skip until we have figured out</i>
<a name="19856"/>19856: <i>%% how to test this.</i>
<a name="19857"/>19857: <i>%%</i>
<a name="19858"/>19858: <i>%% &lt;/NOTE&gt;</i>
<a name="19859"/>19859: <i>%%</i>
<a name="19860"/>19860: 
<a name="api_opt_ip_recvopts_udp4-1"/><a name="19861"/>19861: <b>api_opt_ip_recvopts_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="19862"/>19862:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvopts_udp4-last_expr"/><a name="19863"/>19863: <b>    tc_try</b>(api_opt_ip_recvopts_udp4,
<a name="19864"/>19864:            fun() -&gt;
<a name="19865"/>19865:                    has_support_ipv4(),
<a name="19866"/>19866:                    has_support_ip_recvopts(),
<a name="19867"/>19867:                    %% We also use the recvtos and timestamp options
<a name="19868"/>19868:                    %% in this test, so at least one of them must
<a name="19869"/>19869:                    %% be supported
<a name="19870"/>19870:                    has_support_ip_recvtos_and_or_sock_timestamp(),
<a name="19871"/>19871:                    not_yet_implemented()
<a name="19872"/>19872: 
<a name="19873"/>19873:            end,
<a name="19874"/>19874:            fun() -&gt;
<a name="19875"/>19875:                    Set  = fun(Sock, Value) -&gt;
<a name="19876"/>19876:                                   socket:setopt(Sock, ip, recvopts, Value)
<a name="19877"/>19877:                           end,
<a name="19878"/>19878:                    Get  = fun(Sock) -&gt;
<a name="19879"/>19879:                                   socket:getopt(Sock, ip, recvopts)
<a name="19880"/>19880:                           end,
<a name="19881"/>19881:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="19882"/>19882:                                   Msg = #{addr =&gt; Dest,
<a name="19883"/>19883:                                              iov  =&gt; [Data]},
<a name="19884"/>19884:                                   socket:sendmsg(Sock, Msg);
<a name="19885"/>19885:                              (Sock, Data, Dest, Info) -&gt;
<a name="19886"/>19886:                                   %% We do not support this at the moment!!!
<a name="19887"/>19887:                                   CMsg = #{level =&gt; ip,
<a name="19888"/>19888:                                               type  =&gt; options,
<a name="19889"/>19889:                                               data  =&gt; Info},
<a name="19890"/>19890:                                   Msg  = #{addr =&gt; Dest,
<a name="19891"/>19891:                                               ctrl =&gt; [CMsg],
<a name="19892"/>19892:                                               iov  =&gt; [Data]},
<a name="19893"/>19893:                                   socket:sendmsg(Sock, Msg)
<a name="19894"/>19894:                           end,
<a name="19895"/>19895:                    Recv = fun(Sock) -&gt;
<a name="19896"/>19896:                                   case socket:recvmsg(Sock) of
<a name="19897"/>19897:                                       {ok, #{addr := Source,
<a name="19898"/>19898:                                              ctrl := CMsgs,
<a name="19899"/>19899:                                              iov  := [Data]}} -&gt;
<a name="19900"/>19900:                                           {ok, {Source, CMsgs, Data}};
<a name="19901"/>19901:                                       {error, _} = ERROR -&gt;
<a name="19902"/>19902:                                           ERROR
<a name="19903"/>19903:                                   end
<a name="19904"/>19904:                           end,
<a name="19905"/>19905:                    InitState = #{domain =&gt; inet,
<a name="19906"/>19906:                                  proto  =&gt; udp,
<a name="19907"/>19907:                                  send   =&gt; Send,
<a name="19908"/>19908:                                  recv   =&gt; Recv,
<a name="19909"/>19909:                                  set    =&gt; Set,
<a name="19910"/>19910:                                  get    =&gt; Get},
<a name="19911"/>19911:                    ok = api_opt_ip_recvopts_udp(InitState)
<a name="19912"/>19912:            end).
<a name="19913"/>19913: 
<a name="19914"/>19914: 
<a name="19915"/>19915: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19916"/>19916: 
<a name="api_opt_ip_recvopts_udp-1"/><a name="19917"/>19917: <b>api_opt_ip_recvopts_udp</b>(InitState) -&gt;
<a name="19918"/>19918:     Seq = 
<a name="19919"/>19919:         [
<a name="19920"/>19920:          %% Start by figure out which of the ip:recvtos and/or socket:timestamp
<a name="19921"/>19921:          %% options we can use.
<a name="19922"/>19922:          #{desc =&gt; &quot;test for ip:recvtos&quot;,
<a name="19923"/>19923:            cmd  =&gt; fun(State) -&gt;
<a name="19924"/>19924:                            ?SEV_IPRINT(&quot;test for ip:recvtos&quot;),
<a name="19925"/>19925:                            case socket:is_supported(options, ip, recvtos) of
<a name="19926"/>19926:                                true -&gt;
<a name="19927"/>19927:                                    ?SEV_IPRINT(&quot;use ip:recvtos&quot;),
<a name="19928"/>19928:                                    {ok, State#{recvtos =&gt; true}};
<a name="19929"/>19929:                                false -&gt; 
<a name="19930"/>19930:                                    ?SEV_IPRINT(&quot;do *not* use ip:recvtos&quot;),
<a name="19931"/>19931:                                    {ok, State#{recvtos =&gt; false}}
<a name="19932"/>19932:                            end
<a name="19933"/>19933:                    end},
<a name="19934"/>19934:          #{desc =&gt; &quot;test for socket:timestamp&quot;,
<a name="19935"/>19935:            cmd  =&gt; fun(State) -&gt;
<a name="19936"/>19936:                            ?SEV_IPRINT(&quot;test for socket:timestamp&quot;),
<a name="19937"/>19937:                            case socket:is_supported(options, socket, timestamp) of
<a name="19938"/>19938:                                true -&gt;
<a name="19939"/>19939:                                    ?SEV_IPRINT(&quot;use socket:timestamp&quot;),
<a name="19940"/>19940:                                    {ok, State#{timestamp =&gt; true}};
<a name="19941"/>19941:                                false -&gt; 
<a name="19942"/>19942:                                    ?SEV_IPRINT(&quot;do *not* use socket:timestamp&quot;),
<a name="19943"/>19943:                                    {ok, State#{timestamp =&gt; false}}
<a name="19944"/>19944:                            end
<a name="19945"/>19945:                    end},
<a name="19946"/>19946: 
<a name="19947"/>19947:          #{desc =&gt; &quot;local address&quot;,
<a name="19948"/>19948:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="19949"/>19949:                            LSASrc = which_local_socket_addr(Domain),
<a name="19950"/>19950:                            LSADst = which_local_socket_addr(Domain),
<a name="19951"/>19951:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="19952"/>19952:                                        lsa_dst =&gt; LSADst}};
<a name="19953"/>19953:                       (#{domain := Domain} = State) -&gt;
<a name="19954"/>19954:                            LSA = which_local_socket_addr(Domain),
<a name="19955"/>19955:                            {ok, State#{lsa_src =&gt; LSA,
<a name="19956"/>19956:                                        lsa_dst =&gt; LSA}}
<a name="19957"/>19957:                    end},
<a name="19958"/>19958: 
<a name="19959"/>19959:          #{desc =&gt; &quot;open src socket&quot;,
<a name="19960"/>19960:            cmd  =&gt; fun(#{domain := Domain,
<a name="19961"/>19961:                          proto  := Proto} = State) -&gt;
<a name="19962"/>19962:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19963"/>19963:                            {ok, State#{sock_src =&gt; Sock}}
<a name="19964"/>19964:                    end},
<a name="19965"/>19965:          #{desc =&gt; &quot;bind src&quot;,
<a name="19966"/>19966:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="19967"/>19967:                            case sock_bind(Sock, LSA) of
<a name="19968"/>19968:                                ok -&gt;
<a name="19969"/>19969:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19970"/>19970:                                    ok;
<a name="19971"/>19971:                                {error, Reason} = ERROR -&gt;
<a name="19972"/>19972:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19973"/>19973:                                    ERROR
<a name="19974"/>19974:                            end
<a name="19975"/>19975:                    end},
<a name="19976"/>19976:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="19977"/>19977:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="19978"/>19978:                            SASrc = sock_sockname(Sock),
<a name="19979"/>19979:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="19980"/>19980:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="19981"/>19981:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="19982"/>19982:                    end},
<a name="19983"/>19983: 
<a name="19984"/>19984:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="19985"/>19985:            cmd  =&gt; fun(#{domain := Domain,
<a name="19986"/>19986:                          proto  := Proto} = State) -&gt;
<a name="19987"/>19987:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19988"/>19988:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="19989"/>19989:                    end},
<a name="19990"/>19990:          #{desc =&gt; &quot;bind dst&quot;,
<a name="19991"/>19991:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="19992"/>19992:                            case sock_bind(Sock, LSA) of
<a name="19993"/>19993:                                ok -&gt;
<a name="19994"/>19994:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19995"/>19995:                                    ok;
<a name="19996"/>19996:                                {error, Reason} = ERROR -&gt;
<a name="19997"/>19997:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19998"/>19998:                                    ERROR
<a name="19999"/>19999:                            end
<a name="20000"/>20000:                    end},
<a name="20001"/>20001:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="20002"/>20002:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20003"/>20003:                            SADst = sock_sockname(Sock),
<a name="20004"/>20004:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="20005"/>20005:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="20006"/>20006:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="20007"/>20007:                    end},
<a name="20008"/>20008:          #{desc =&gt; &quot;default recvopts for dst socket&quot;,
<a name="20009"/>20009:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="20010"/>20010:                            case Get(Sock) of
<a name="20011"/>20011:                                {ok, false = Value} -&gt;
<a name="20012"/>20012:                                    ?SEV_IPRINT(&quot;dst recvopts: ~p&quot;, [Value]),
<a name="20013"/>20013:                                    ok;
<a name="20014"/>20014:                                {ok, Unexpected} -&gt;
<a name="20015"/>20015:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="20016"/>20016:                                                [Unexpected]),
<a name="20017"/>20017:                                    {error, {unexpected, Unexpected}};
<a name="20018"/>20018:                                {error, Reason} = ERROR -&gt;
<a name="20019"/>20019:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="20020"/>20020:                                                &quot;   ~p&quot;, [Reason]),
<a name="20021"/>20021:                                    ERROR
<a name="20022"/>20022:                            end
<a name="20023"/>20023:                    end},
<a name="20024"/>20024: 
<a name="20025"/>20025:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) options)&quot;,
<a name="20026"/>20026:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20027"/>20027:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20028"/>20028:                    end},
<a name="20029"/>20029:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="20030"/>20030:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20031"/>20031:                            case Recv(Sock) of
<a name="20032"/>20032:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20033"/>20033:                                    ok;
<a name="20034"/>20034:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20035"/>20035:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20036"/>20036:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20037"/>20037:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20038"/>20038:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20039"/>20039:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20040"/>20040:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20041"/>20041:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20042"/>20042:                                                [Src, BadSrc,
<a name="20043"/>20043:                                                 [], BadCHdrs,
<a name="20044"/>20044:                                                 ?BASIC_REQ, BadReq]),
<a name="20045"/>20045:                                    {error, {unexpected_data, UnexpData}};
<a name="20046"/>20046:                                {ok, UnexpData} -&gt;
<a name="20047"/>20047:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20048"/>20048:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20049"/>20049:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20050"/>20050:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20051"/>20051:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20052"/>20052:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20053"/>20053:                                    {error, {unexpected_data, UnexpData}};
<a name="20054"/>20054:                                {error, _} = ERROR -&gt;
<a name="20055"/>20055:                                    %% At the moment there is no way to get
<a name="20056"/>20056:                                    %% status or state for the socket...
<a name="20057"/>20057:                                    ERROR
<a name="20058"/>20058:                            end
<a name="20059"/>20059:                    end},
<a name="20060"/>20060: 
<a name="20061"/>20061: 
<a name="20062"/>20062:          %% *** We do not *yet* support sending options ***
<a name="20063"/>20063: 
<a name="20064"/>20064:          %% #{desc =&gt; &quot;send req (to dst) (w explicit options)&quot;,
<a name="20065"/>20065:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20066"/>20066:          %%                   Send(Sock, ?BASIC_REQ, Dst, Opts)
<a name="20067"/>20067:          %%           end},
<a name="20068"/>20068:          %% #{desc =&gt; &quot;recv req (from src) - wo options&quot;,
<a name="20069"/>20069:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20070"/>20070:          %%                   case Recv(Sock) of
<a name="20071"/>20071:          %%                       {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20072"/>20072:          %%                           ok;
<a name="20073"/>20073:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20074"/>20074:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20075"/>20075:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20076"/>20076:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="20077"/>20077:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20078"/>20078:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20079"/>20079:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20080"/>20080:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="20081"/>20081:          %%                                       [Src, BadSrc,
<a name="20082"/>20082:          %%                                        [], BadCHdrs,
<a name="20083"/>20083:          %%                                        ?BASIC_REQ, BadReq]),
<a name="20084"/>20084:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20085"/>20085:          %%                       {ok, UnexpData} -&gt;
<a name="20086"/>20086:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20087"/>20087:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20088"/>20088:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20089"/>20089:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20090"/>20090:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="20091"/>20091:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20092"/>20092:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20093"/>20093:          %%                       {error, _} = ERROR -&gt;
<a name="20094"/>20094:          %%                           %% At the moment there is no way to get
<a name="20095"/>20095:          %%                           %% status or state for the socket...
<a name="20096"/>20096:          %%                           ERROR
<a name="20097"/>20097:          %%                   end
<a name="20098"/>20098:          %%           end},
<a name="20099"/>20099: 
<a name="20100"/>20100:          #{desc =&gt; &quot;enable recvopts on dst socket&quot;,
<a name="20101"/>20101:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20102"/>20102:                            case Set(Sock, true) of
<a name="20103"/>20103:                                ok -&gt;
<a name="20104"/>20104:                                    ?SEV_IPRINT(&quot;dst recvopts enabled&quot;),
<a name="20105"/>20105:                                    ok;
<a name="20106"/>20106:                                {error, Reason} = ERROR -&gt;
<a name="20107"/>20107:                                    ?SEV_EPRINT(&quot;Failed setting recvopts:&quot;
<a name="20108"/>20108:                                                &quot;   ~p&quot;, [Reason]),
<a name="20109"/>20109:                                    ERROR
<a name="20110"/>20110:                            end
<a name="20111"/>20111:                    end},
<a name="20112"/>20112: 
<a name="20113"/>20113:          %% This specific option, recvtos, is tested in another test case
<a name="20114"/>20114:          %% Note that this may not actually be supported here!!
<a name="20115"/>20115:          #{desc =&gt; &quot;maybe enable ip:recvtos on dst socket&quot;,
<a name="20116"/>20116:            cmd  =&gt; fun(#{recvtos := true, sock_dst := Sock} = _State) -&gt;
<a name="20117"/>20117:                            ?SEV_IPRINT(&quot;enable ip:recvtos&quot;),
<a name="20118"/>20118:                            ok = socket:setopt(Sock, ip, recvtos, true);
<a name="20119"/>20119:                       (#{recvtos := false} = _State) -&gt;
<a name="20120"/>20120:                            ok
<a name="20121"/>20121:                    end},
<a name="20122"/>20122:          %% This specific option, timestamp, is tested in another test case
<a name="20123"/>20123:          #{desc =&gt; &quot;maybe enable socket:timestamp on dst socket&quot;,
<a name="20124"/>20124:            cmd  =&gt; fun(#{timestamp := true, sock_dst := Sock} = _State) -&gt;
<a name="20125"/>20125:                            ?SEV_IPRINT(&quot;enable socket:timestamp&quot;),
<a name="20126"/>20126:                            ok = socket:setopt(Sock, socket, timestamp, true);
<a name="20127"/>20127:                       (#{timestamp := false} = _State) -&gt;
<a name="20128"/>20128:                            ok
<a name="20129"/>20129:                    end},
<a name="20130"/>20130: 
<a name="20131"/>20131:          #{desc =&gt; &quot;send req (to dst) (wo explicit options)&quot;,
<a name="20132"/>20132:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20133"/>20133:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20134"/>20134:                    end},
<a name="20135"/>20135:          #{desc =&gt; &quot;recv req (from src) - w default options&quot;,
<a name="20136"/>20136:            cmd  =&gt; fun(#{recvtos := true, timestamp := true,
<a name="20137"/>20137:                          sock_dst := Sock,
<a name="20138"/>20138:                          sa_src   := Src,
<a name="20139"/>20139:                          recv     := Recv}) -&gt;
<a name="20140"/>20140:                            case Recv(Sock) of
<a name="20141"/>20141:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="20142"/>20142:                                  when (length(Opts) =:= 2) -&gt;
<a name="20143"/>20143:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="20144"/>20144:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="20145"/>20145:                                    ok;
<a name="20146"/>20146:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20147"/>20147:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20148"/>20148:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20149"/>20149:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20150"/>20150:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20151"/>20151:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20152"/>20152:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20153"/>20153:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20154"/>20154:                                                [Src, BadSrc,
<a name="20155"/>20155:                                                 [], BadCHdrs,
<a name="20156"/>20156:                                                 ?BASIC_REQ, BadReq]),
<a name="20157"/>20157:                                    {error, {unexpected_data, UnexpData}};
<a name="20158"/>20158:                                {ok, UnexpData} -&gt;
<a name="20159"/>20159:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20160"/>20160:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20161"/>20161:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20162"/>20162:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20163"/>20163:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20164"/>20164:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20165"/>20165:                                    {error, {unexpected_data, UnexpData}};
<a name="20166"/>20166:                                {error, _} = ERROR -&gt;
<a name="20167"/>20167:                                    %% At the moment there is no way to get
<a name="20168"/>20168:                                    %% status or state for the socket...
<a name="20169"/>20169:                                    ERROR
<a name="20170"/>20170:                            end;
<a name="20171"/>20171:                       (#{timestamp := true,
<a name="20172"/>20172:                          sock_dst := Sock,
<a name="20173"/>20173:                          sa_src   := Src,
<a name="20174"/>20174:                          recv     := Recv}) -&gt;
<a name="20175"/>20175:                            case Recv(Sock) of
<a name="20176"/>20176:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="20177"/>20177:                                  when (length(Opts) =:= 1) -&gt;
<a name="20178"/>20178:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="20179"/>20179:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="20180"/>20180:                                    ok;
<a name="20181"/>20181:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20182"/>20182:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20183"/>20183:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20184"/>20184:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20185"/>20185:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20186"/>20186:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20187"/>20187:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20188"/>20188:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20189"/>20189:                                                [Src, BadSrc,
<a name="20190"/>20190:                                                 [], BadCHdrs,
<a name="20191"/>20191:                                                 ?BASIC_REQ, BadReq]),
<a name="20192"/>20192:                                    {error, {unexpected_data, UnexpData}};
<a name="20193"/>20193:                                {ok, UnexpData} -&gt;
<a name="20194"/>20194:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20195"/>20195:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20196"/>20196:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20197"/>20197:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20198"/>20198:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20199"/>20199:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20200"/>20200:                                    {error, {unexpected_data, UnexpData}};
<a name="20201"/>20201:                                {error, _} = ERROR -&gt;
<a name="20202"/>20202:                                    %% At the moment there is no way to get
<a name="20203"/>20203:                                    %% status or state for the socket...
<a name="20204"/>20204:                                    ERROR
<a name="20205"/>20205:                            end;
<a name="20206"/>20206:                       (#{recvtos := true,
<a name="20207"/>20207:                          sock_dst := Sock,
<a name="20208"/>20208:                          sa_src   := Src,
<a name="20209"/>20209:                          recv     := Recv}) -&gt;
<a name="20210"/>20210:                            case Recv(Sock) of
<a name="20211"/>20211:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="20212"/>20212:                                  when (length(Opts) =:= 1) -&gt;
<a name="20213"/>20213:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="20214"/>20214:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="20215"/>20215:                                    ok;
<a name="20216"/>20216:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20217"/>20217:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20218"/>20218:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20219"/>20219:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20220"/>20220:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20221"/>20221:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20222"/>20222:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20223"/>20223:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20224"/>20224:                                                [Src, BadSrc,
<a name="20225"/>20225:                                                 [], BadCHdrs,
<a name="20226"/>20226:                                                 ?BASIC_REQ, BadReq]),
<a name="20227"/>20227:                                    {error, {unexpected_data, UnexpData}};
<a name="20228"/>20228:                                {ok, UnexpData} -&gt;
<a name="20229"/>20229:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20230"/>20230:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20231"/>20231:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20232"/>20232:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20233"/>20233:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20234"/>20234:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20235"/>20235:                                    {error, {unexpected_data, UnexpData}};
<a name="20236"/>20236:                                {error, _} = ERROR -&gt;
<a name="20237"/>20237:                                    %% At the moment there is no way to get
<a name="20238"/>20238:                                    %% status or state for the socket...
<a name="20239"/>20239:                                    ERROR
<a name="20240"/>20240:                            end
<a name="20241"/>20241:                    end},
<a name="20242"/>20242: 
<a name="20243"/>20243: 
<a name="20244"/>20244:          %% *** We do not *yet* support sending options ***
<a name="20245"/>20245: 
<a name="20246"/>20246:          %% #{desc =&gt; &quot;send req (to dst) (w explicit options)&quot;,
<a name="20247"/>20247:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20248"/>20248:          %%                   Send(Sock, ?BASIC_REQ, Dst, Opts)
<a name="20249"/>20249:          %%           end},
<a name="20250"/>20250:          %% #{desc =&gt; &quot;recv req (from src) - w options&quot;,
<a name="20251"/>20251:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20252"/>20252:          %%                   case Recv(Sock) of
<a name="20253"/>20253:          %%                       {ok, {Src, Opts, ?BASIC_REQ}} -&gt;
<a name="20254"/>20254:          %%                           ?SEV_IPRINT(&quot;Got Options: &quot;
<a name="20255"/>20255:          %%                                       &quot;~n   ~p&quot;, [Opts]),
<a name="20256"/>20256:          %%                           ok;
<a name="20257"/>20257:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20258"/>20258:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20259"/>20259:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20260"/>20260:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="20261"/>20261:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20262"/>20262:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20263"/>20263:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20264"/>20264:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="20265"/>20265:          %%                                       [Src, BadSrc,
<a name="20266"/>20266:          %%                                        [], BadCHdrs,
<a name="20267"/>20267:          %%                                        ?BASIC_REQ, BadReq]),
<a name="20268"/>20268:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20269"/>20269:          %%                       {ok, UnexpData} -&gt;
<a name="20270"/>20270:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20271"/>20271:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20272"/>20272:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20273"/>20273:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20274"/>20274:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="20275"/>20275:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20276"/>20276:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20277"/>20277:          %%                       {error, _} = ERROR -&gt;
<a name="20278"/>20278:          %%                           %% At the moment there is no way to get
<a name="20279"/>20279:          %%                           %% status or state for the socket...
<a name="20280"/>20280:          %%                           ERROR
<a name="20281"/>20281:          %%                   end
<a name="20282"/>20282:          %%           end},
<a name="20283"/>20283: 
<a name="20284"/>20284:          #{desc =&gt; &quot;close src socket&quot;,
<a name="20285"/>20285:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20286"/>20286:                            ok = socket:close(Sock),
<a name="20287"/>20287:                            {ok, maps:remove(sock_src, State)}
<a name="20288"/>20288:                    end},
<a name="20289"/>20289:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="20290"/>20290:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20291"/>20291:                            ok = socket:close(Sock),
<a name="20292"/>20292:                            {ok, maps:remove(sock_dst, State)}
<a name="20293"/>20293:                    end},
<a name="20294"/>20294: 
<a name="20295"/>20295:          %% *** We are done ***
<a name="20296"/>20296:          ?SEV_FINISH_NORMAL
<a name="20297"/>20297:         ],
<a name="20298"/>20298:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvopts_udp-last_expr"/><a name="20299"/>20299: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="20300"/>20300: 
<a name="20301"/>20301: 
<a name="20302"/>20302: 
<a name="20303"/>20303: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20304"/>20304: 
<a name="20305"/>20305: <i>%% Tests that the origdstaddr control message header is received when</i>
<a name="20306"/>20306: <i>%% setting the socket 'ip' option recvorigdstaddr is set to true when</i>
<a name="20307"/>20307: <i>%% using sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="20308"/>20308: <i>%% So, this is done on the receiving side: </i>
<a name="20309"/>20309: <i>%%</i>
<a name="20310"/>20310: <i>%%               socket:setopt(Sock, ip, recvorigdstaddr, boolean()).</i>
<a name="20311"/>20311: <i>%%</i>
<a name="20312"/>20312: <i>%% For all subsequent *received* messages, the origdstaddr control</i>
<a name="20313"/>20313: <i>%% message header will be with the message.</i>
<a name="20314"/>20314: <i>%%</i>
<a name="20315"/>20315: <i>%%</i>
<a name="20316"/>20316: 
<a name="api_opt_ip_recvorigdstaddr_udp4-1"/><a name="20317"/>20317: <b>api_opt_ip_recvorigdstaddr_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="20318"/>20318:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvorigdstaddr_udp4-last_expr"/><a name="20319"/>20319: <b>    tc_try</b>(api_opt_ip_recvorigdstaddr_udp4,
<a name="20320"/>20320:            fun() -&gt; has_support_ipv4(), has_support_ip_recvorigdstaddr() end,
<a name="20321"/>20321:            fun() -&gt;
<a name="20322"/>20322:                    Set  = fun(Sock, Value) -&gt;
<a name="20323"/>20323:                                   socket:setopt(Sock, ip, recvorigdstaddr, Value)
<a name="20324"/>20324:                           end,
<a name="20325"/>20325:                    Get  = fun(Sock) -&gt;
<a name="20326"/>20326:                                   socket:getopt(Sock, ip, recvorigdstaddr)
<a name="20327"/>20327:                           end,
<a name="20328"/>20328:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="20329"/>20329:                                   Msg = #{addr =&gt; Dest,
<a name="20330"/>20330:                                              iov  =&gt; [Data]},
<a name="20331"/>20331:                                   socket:sendmsg(Sock, Msg)
<a name="20332"/>20332:                           end,
<a name="20333"/>20333:                    Recv = fun(Sock) -&gt;
<a name="20334"/>20334:                                   case socket:recvmsg(Sock) of
<a name="20335"/>20335:                                       {ok, #{addr := Source,
<a name="20336"/>20336:                                              ctrl := CMsgs,
<a name="20337"/>20337:                                              iov  := [Data]}} -&gt;
<a name="20338"/>20338:                                           {ok, {Source, CMsgs, Data}};
<a name="20339"/>20339:                                       {error, _} = ERROR -&gt;
<a name="20340"/>20340:                                           ERROR
<a name="20341"/>20341:                                   end
<a name="20342"/>20342:                           end,
<a name="20343"/>20343:                    InitState = #{domain =&gt; inet,
<a name="20344"/>20344:                                  proto  =&gt; udp,
<a name="20345"/>20345:                                  send   =&gt; Send,
<a name="20346"/>20346:                                  recv   =&gt; Recv,
<a name="20347"/>20347:                                  set    =&gt; Set,
<a name="20348"/>20348:                                  get    =&gt; Get},
<a name="20349"/>20349:                    ok = api_opt_ip_recvorigdstaddr_udp(InitState)
<a name="20350"/>20350:            end).
<a name="20351"/>20351: 
<a name="20352"/>20352: 
<a name="20353"/>20353: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20354"/>20354: 
<a name="api_opt_ip_recvorigdstaddr_udp-1"/><a name="20355"/>20355: <b>api_opt_ip_recvorigdstaddr_udp</b>(InitState) -&gt;
<a name="20356"/>20356:     Seq = 
<a name="20357"/>20357:         [
<a name="20358"/>20358:          #{desc =&gt; &quot;local address&quot;,
<a name="20359"/>20359:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="20360"/>20360:                            LSASrc = which_local_socket_addr(Domain),
<a name="20361"/>20361:                            LSADst = which_local_socket_addr(Domain),
<a name="20362"/>20362:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="20363"/>20363:                                        lsa_dst =&gt; LSADst}};
<a name="20364"/>20364:                       (#{domain := Domain} = State) -&gt;
<a name="20365"/>20365:                            LSA = which_local_socket_addr(Domain),
<a name="20366"/>20366:                            {ok, State#{lsa_src =&gt; LSA,
<a name="20367"/>20367:                                        lsa_dst =&gt; LSA}}
<a name="20368"/>20368:                    end},
<a name="20369"/>20369: 
<a name="20370"/>20370:          #{desc =&gt; &quot;open src socket&quot;,
<a name="20371"/>20371:            cmd  =&gt; fun(#{domain := Domain,
<a name="20372"/>20372:                          proto  := Proto} = State) -&gt;
<a name="20373"/>20373:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20374"/>20374:                            {ok, State#{sock_src =&gt; Sock}}
<a name="20375"/>20375:                    end},
<a name="20376"/>20376:          #{desc =&gt; &quot;bind src&quot;,
<a name="20377"/>20377:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="20378"/>20378:                            case sock_bind(Sock, LSA) of
<a name="20379"/>20379:                                ok -&gt;
<a name="20380"/>20380:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20381"/>20381:                                    ok;
<a name="20382"/>20382:                                {error, Reason} = ERROR -&gt;
<a name="20383"/>20383:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20384"/>20384:                                    ERROR
<a name="20385"/>20385:                            end
<a name="20386"/>20386:                    end},
<a name="20387"/>20387:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="20388"/>20388:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20389"/>20389:                            SASrc = sock_sockname(Sock),
<a name="20390"/>20390:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="20391"/>20391:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="20392"/>20392:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="20393"/>20393:                    end},
<a name="20394"/>20394: 
<a name="20395"/>20395:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="20396"/>20396:            cmd  =&gt; fun(#{domain := Domain,
<a name="20397"/>20397:                          proto  := Proto} = State) -&gt;
<a name="20398"/>20398:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20399"/>20399:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="20400"/>20400:                    end},
<a name="20401"/>20401:          #{desc =&gt; &quot;bind dst&quot;,
<a name="20402"/>20402:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="20403"/>20403:                            case sock_bind(Sock, LSA) of
<a name="20404"/>20404:                                ok -&gt;
<a name="20405"/>20405:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20406"/>20406:                                    ok;
<a name="20407"/>20407:                                {error, Reason} = ERROR -&gt;
<a name="20408"/>20408:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20409"/>20409:                                    ERROR
<a name="20410"/>20410:                            end
<a name="20411"/>20411:                    end},
<a name="20412"/>20412:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="20413"/>20413:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20414"/>20414:                            SADst = sock_sockname(Sock),
<a name="20415"/>20415:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="20416"/>20416:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="20417"/>20417:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="20418"/>20418:                    end},
<a name="20419"/>20419:          #{desc =&gt; &quot;get default recvorigdstaddr for dst socket&quot;,
<a name="20420"/>20420:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="20421"/>20421:                            case Get(Sock) of
<a name="20422"/>20422:                                {ok, false = Value} -&gt;
<a name="20423"/>20423:                                    ?SEV_IPRINT(&quot;dst recvorigdstaddr: ~p&quot;, [Value]),
<a name="20424"/>20424:                                    ok;
<a name="20425"/>20425:                                {ok, Unexpected} -&gt;
<a name="20426"/>20426:                                    ?SEV_EPRINT(&quot;Unexpected src recvorigdstaddr: ~p&quot;,
<a name="20427"/>20427:                                                [Unexpected]),
<a name="20428"/>20428:                                    {error, {unexpected, Unexpected}};
<a name="20429"/>20429:                                {error, Reason} = ERROR -&gt;
<a name="20430"/>20430:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="20431"/>20431:                                                &quot;recvorigdstaddr:&quot;
<a name="20432"/>20432:                                                &quot;   ~p&quot;, [Reason]),
<a name="20433"/>20433:                                    ERROR
<a name="20434"/>20434:                            end
<a name="20435"/>20435:                    end},
<a name="20436"/>20436: 
<a name="20437"/>20437:          #{desc =&gt; &quot;send req (to dst) (when recvorigdstaddr disabled)&quot;,
<a name="20438"/>20438:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20439"/>20439:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="20440"/>20440:                    end},
<a name="20441"/>20441:          #{desc =&gt; &quot;recv req (from src) - wo origdstaddr&quot;,
<a name="20442"/>20442:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20443"/>20443:                            case Recv(Sock) of
<a name="20444"/>20444:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20445"/>20445:                                    ok;
<a name="20446"/>20446:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20447"/>20447:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20448"/>20448:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20449"/>20449:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20450"/>20450:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20451"/>20451:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20452"/>20452:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20453"/>20453:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20454"/>20454:                                                [Src, BadSrc,
<a name="20455"/>20455:                                                 [], BadCHdrs,
<a name="20456"/>20456:                                                 ?BASIC_REQ, BadReq]),
<a name="20457"/>20457:                                    {error, {unexpected_data, UnexpData}};
<a name="20458"/>20458:                                {ok, UnexpData} -&gt;
<a name="20459"/>20459:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20460"/>20460:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20461"/>20461:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20462"/>20462:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20463"/>20463:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20464"/>20464:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20465"/>20465:                                    {error, {unexpected_data, UnexpData}};
<a name="20466"/>20466:                                {error, _} = ERROR -&gt;
<a name="20467"/>20467:                                    %% At the moment there is no way to get
<a name="20468"/>20468:                                    %% status or state for the socket...
<a name="20469"/>20469:                                    ERROR
<a name="20470"/>20470:                            end
<a name="20471"/>20471:                    end},
<a name="20472"/>20472: 
<a name="20473"/>20473:          #{desc =&gt; &quot;enable recvorigdstaddr on dst socket&quot;,
<a name="20474"/>20474:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20475"/>20475:                            case Set(Sock, true) of
<a name="20476"/>20476:                                ok -&gt;
<a name="20477"/>20477:                                    ?SEV_IPRINT(&quot;dst recvorigdstaddr enabled&quot;),
<a name="20478"/>20478:                                    ok;
<a name="20479"/>20479:                                {error, Reason} = ERROR -&gt;
<a name="20480"/>20480:                                    ?SEV_EPRINT(&quot;Failed enable recvorigdstaddr:&quot;
<a name="20481"/>20481:                                                &quot;   ~p&quot;, [Reason]),
<a name="20482"/>20482:                                    ERROR
<a name="20483"/>20483:                            end
<a name="20484"/>20484:                    end},
<a name="20485"/>20485: 
<a name="20486"/>20486:          #{desc =&gt; &quot;send req (to dst) (when recvorigdstaddr enabled)&quot;,
<a name="20487"/>20487:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20488"/>20488:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="20489"/>20489:                    end},
<a name="20490"/>20490:          #{desc =&gt; &quot;recv req (from src) - w origdstaddr&quot;,
<a name="20491"/>20491:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20492"/>20492:                            case Recv(Sock) of
<a name="20493"/>20493:                                {ok, {Src, [#{level := ip,
<a name="20494"/>20494:                                              type  := origdstaddr,
<a name="20495"/>20495:                                              value := Addr}], ?BASIC_REQ}} -&gt;
<a name="20496"/>20496:                                    ?SEV_IPRINT(&quot;got origdstaddr &quot;
<a name="20497"/>20497:                                                &quot;control message header: &quot;
<a name="20498"/>20498:                                                &quot;~n   ~p&quot;, [Addr]),
<a name="20499"/>20499:                                    ok;
<a name="20500"/>20500:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20501"/>20501:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20502"/>20502:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20503"/>20503:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20504"/>20504:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20505"/>20505:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20506"/>20506:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20507"/>20507:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20508"/>20508:                                                [Src, BadSrc,
<a name="20509"/>20509:                                                 [#{level =&gt; ip,
<a name="20510"/>20510:                                                    type  =&gt; origdstaddr,
<a name="20511"/>20511:                                                    data  =&gt; &quot;something&quot;}], BadCHdrs,
<a name="20512"/>20512:                                                 ?BASIC_REQ, BadReq]),
<a name="20513"/>20513:                                    {error, {unexpected_data, UnexpData}};
<a name="20514"/>20514:                                {ok, UnexpData} -&gt;
<a name="20515"/>20515:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20516"/>20516:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20517"/>20517:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20518"/>20518:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20519"/>20519:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20520"/>20520:                                                [Src,
<a name="20521"/>20521:                                                 [#{level =&gt; ip,
<a name="20522"/>20522:                                                    type  =&gt; origdstaddr,
<a name="20523"/>20523:                                                    data  =&gt; &quot;something&quot;}],
<a name="20524"/>20524:                                                 ?BASIC_REQ, UnexpData]),
<a name="20525"/>20525:                                    {error, {unexpected_data, UnexpData}};
<a name="20526"/>20526:                                {error, _} = ERROR -&gt;
<a name="20527"/>20527:                                    %% At the moment there is no way to get
<a name="20528"/>20528:                                    %% status or state for the socket...
<a name="20529"/>20529:                                    ERROR
<a name="20530"/>20530:                            end
<a name="20531"/>20531:                    end},
<a name="20532"/>20532: 
<a name="20533"/>20533:          #{desc =&gt; &quot;close src socket&quot;,
<a name="20534"/>20534:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20535"/>20535:                            ok = socket:close(Sock),
<a name="20536"/>20536:                            {ok, maps:remove(sock_src, State)}
<a name="20537"/>20537:                    end},
<a name="20538"/>20538:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="20539"/>20539:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20540"/>20540:                            ok = socket:close(Sock),
<a name="20541"/>20541:                            {ok, maps:remove(sock_dst, State)}
<a name="20542"/>20542:                    end},
<a name="20543"/>20543: 
<a name="20544"/>20544:          %% *** We are done ***
<a name="20545"/>20545:          ?SEV_FINISH_NORMAL
<a name="20546"/>20546:         ],
<a name="20547"/>20547:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvorigdstaddr_udp-last_expr"/><a name="20548"/>20548: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="20549"/>20549: 
<a name="20550"/>20550: 
<a name="20551"/>20551: 
<a name="20552"/>20552: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20553"/>20553: 
<a name="20554"/>20554: <i>%% Tests that the tos control message header is received when</i>
<a name="20555"/>20555: <i>%% setting the socket 'ip' option recvtos is set to true when using</i>
<a name="20556"/>20556: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="20557"/>20557: <i>%% So, this is done on the receiving side: </i>
<a name="20558"/>20558: <i>%%</i>
<a name="20559"/>20559: <i>%%               socket:setopt(Sock, ip, recvtos, boolean()).</i>
<a name="20560"/>20560: <i>%%</i>
<a name="20561"/>20561: <i>%% For all subsequent *received* messages, the tos control message</i>
<a name="20562"/>20562: <i>%% header will be with the message.</i>
<a name="20563"/>20563: <i>%%</i>
<a name="20564"/>20564: <i>%% On some platforms it works sending TOS with the message (sendmsg with </i>
<a name="20565"/>20565: <i>%% a control message header), but since its not universal, we can't use</i>
<a name="20566"/>20566: <i>%% that method. Instead, set tos (true) on the sending socket.</i>
<a name="20567"/>20567: <i>%%</i>
<a name="20568"/>20568: 
<a name="api_opt_ip_recvtos_udp4-1"/><a name="20569"/>20569: <b>api_opt_ip_recvtos_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="20570"/>20570:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvtos_udp4-last_expr"/><a name="20571"/>20571: <b>    tc_try</b>(api_opt_ip_recvtos_udp4,
<a name="20572"/>20572:            fun() -&gt;
<a name="20573"/>20573:                    is_not_windows(), % IP_TOS on windows
<a name="20574"/>20574:                    has_support_ipv4(),
<a name="20575"/>20575:                    has_support_ip_recvtos(),
<a name="20576"/>20576:                    has_support_ip_tos() % Used in the test
<a name="20577"/>20577:            end,
<a name="20578"/>20578:            fun() -&gt;
<a name="20579"/>20579:                    Set  = fun(Sock, Value) -&gt;
<a name="20580"/>20580:                                   socket:setopt(Sock, ip, recvtos, Value)
<a name="20581"/>20581:                           end,
<a name="20582"/>20582:                    Get  = fun(Sock) -&gt;
<a name="20583"/>20583:                                   socket:getopt(Sock, ip, recvtos)
<a name="20584"/>20584:                           end,
<a name="20585"/>20585:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="20586"/>20586:                                   Msg = #{addr =&gt; Dest,
<a name="20587"/>20587:                                           iov  =&gt; [Data]},
<a name="20588"/>20588:                                   socket:sendmsg(Sock, Msg);
<a name="20589"/>20589:                              (Sock, Data, Dest, TOS) -&gt;
<a name="20590"/>20590:                                   CMsg = #{level =&gt; ip,
<a name="20591"/>20591:                                            type  =&gt; tos,
<a name="20592"/>20592:                                            data  =&gt; TOS},
<a name="20593"/>20593:                                   Msg  = #{addr =&gt; Dest,
<a name="20594"/>20594:                                            ctrl =&gt; [CMsg],
<a name="20595"/>20595:                                            iov  =&gt; [Data]},
<a name="20596"/>20596:                                   socket:sendmsg(Sock, Msg)
<a name="20597"/>20597:                           end,
<a name="20598"/>20598:                    Recv = fun(Sock) -&gt;
<a name="20599"/>20599:                                   case socket:recvmsg(Sock) of
<a name="20600"/>20600:                                       {ok, #{addr := Source,
<a name="20601"/>20601:                                              ctrl := CMsgs,
<a name="20602"/>20602:                                              iov  := [Data]}} -&gt;
<a name="20603"/>20603:                                           {ok, {Source, CMsgs, Data}};
<a name="20604"/>20604:                                       {error, _} = ERROR -&gt;
<a name="20605"/>20605:                                           ERROR
<a name="20606"/>20606:                                   end
<a name="20607"/>20607:                           end,
<a name="20608"/>20608:                    InitState = #{domain =&gt; inet,
<a name="20609"/>20609:                                  proto  =&gt; udp,
<a name="20610"/>20610:                                  send   =&gt; Send,
<a name="20611"/>20611:                                  recv   =&gt; Recv,
<a name="20612"/>20612:                                  set    =&gt; Set,
<a name="20613"/>20613:                                  get    =&gt; Get},
<a name="20614"/>20614:                    ok = api_opt_ip_recvtos_udp(InitState)
<a name="20615"/>20615:            end).
<a name="20616"/>20616: 
<a name="20617"/>20617: 
<a name="20618"/>20618: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20619"/>20619: 
<a name="api_opt_ip_recvtos_udp-1"/><a name="20620"/>20620: <b>api_opt_ip_recvtos_udp</b>(InitState) -&gt;
<a name="20621"/>20621:     Seq = 
<a name="20622"/>20622:         [
<a name="20623"/>20623:          #{desc =&gt; &quot;local address&quot;,
<a name="20624"/>20624:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="20625"/>20625:                            LSASrc = which_local_socket_addr(Domain),
<a name="20626"/>20626:                            LSADst = which_local_socket_addr(Domain),
<a name="20627"/>20627:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="20628"/>20628:                                        lsa_dst =&gt; LSADst}};
<a name="20629"/>20629:                       (#{domain := Domain} = State) -&gt;
<a name="20630"/>20630:                            LSA = which_local_socket_addr(Domain),
<a name="20631"/>20631:                            {ok, State#{lsa_src =&gt; LSA,
<a name="20632"/>20632:                                        lsa_dst =&gt; LSA}}
<a name="20633"/>20633:                    end},
<a name="20634"/>20634: 
<a name="20635"/>20635:          #{desc =&gt; &quot;open src socket&quot;,
<a name="20636"/>20636:            cmd  =&gt; fun(#{domain := Domain,
<a name="20637"/>20637:                          proto  := Proto} = State) -&gt;
<a name="20638"/>20638:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20639"/>20639:                            {ok, State#{sock_src =&gt; Sock}}
<a name="20640"/>20640:                    end},
<a name="20641"/>20641:          #{desc =&gt; &quot;bind src&quot;,
<a name="20642"/>20642:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="20643"/>20643:                            case sock_bind(Sock, LSA) of
<a name="20644"/>20644:                                ok -&gt;
<a name="20645"/>20645:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20646"/>20646:                                    ok;
<a name="20647"/>20647:                                {error, Reason} = ERROR -&gt;
<a name="20648"/>20648:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20649"/>20649:                                    ERROR
<a name="20650"/>20650:                            end
<a name="20651"/>20651:                    end},
<a name="20652"/>20652:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="20653"/>20653:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20654"/>20654:                            SASrc = sock_sockname(Sock),
<a name="20655"/>20655:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="20656"/>20656:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="20657"/>20657:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="20658"/>20658:                    end},
<a name="20659"/>20659: 
<a name="20660"/>20660:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="20661"/>20661:            cmd  =&gt; fun(#{domain := Domain,
<a name="20662"/>20662:                          proto  := Proto} = State) -&gt;
<a name="20663"/>20663:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20664"/>20664:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="20665"/>20665:                    end},
<a name="20666"/>20666:          #{desc =&gt; &quot;bind dst&quot;,
<a name="20667"/>20667:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="20668"/>20668:                            case sock_bind(Sock, LSA) of
<a name="20669"/>20669:                                ok -&gt;
<a name="20670"/>20670:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20671"/>20671:                                    ok;
<a name="20672"/>20672:                                {error, Reason} = ERROR -&gt;
<a name="20673"/>20673:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20674"/>20674:                                    ERROR
<a name="20675"/>20675:                            end
<a name="20676"/>20676:                    end},
<a name="20677"/>20677:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="20678"/>20678:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20679"/>20679:                            SADst = sock_sockname(Sock),
<a name="20680"/>20680:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="20681"/>20681:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="20682"/>20682:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="20683"/>20683:                    end},
<a name="20684"/>20684:          #{desc =&gt; &quot;default recvtos for dst socket&quot;,
<a name="20685"/>20685:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="20686"/>20686:                            case Get(Sock) of
<a name="20687"/>20687:                                {ok, false = Value} -&gt;
<a name="20688"/>20688:                                    ?SEV_IPRINT(&quot;dst recvtos: ~p&quot;, [Value]),
<a name="20689"/>20689:                                    ok;
<a name="20690"/>20690:                                {ok, Unexpected} -&gt;
<a name="20691"/>20691:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="20692"/>20692:                                                [Unexpected]),
<a name="20693"/>20693:                                    {error, {unexpected, Unexpected}};
<a name="20694"/>20694:                                {error, Reason} = ERROR -&gt;
<a name="20695"/>20695:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="20696"/>20696:                                                &quot;   ~p&quot;, [Reason]),
<a name="20697"/>20697:                                    ERROR
<a name="20698"/>20698:                            end
<a name="20699"/>20699:                    end},
<a name="20700"/>20700: 
<a name="20701"/>20701:          #{desc =&gt; &quot;send req (to dst) (wo explicit tos)&quot;,
<a name="20702"/>20702:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20703"/>20703:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20704"/>20704:                    end},
<a name="20705"/>20705:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="20706"/>20706:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20707"/>20707:                            case Recv(Sock) of
<a name="20708"/>20708:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20709"/>20709:                                    ok;
<a name="20710"/>20710:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20711"/>20711:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20712"/>20712:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20713"/>20713:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20714"/>20714:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20715"/>20715:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20716"/>20716:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20717"/>20717:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20718"/>20718:                                                [Src, BadSrc,
<a name="20719"/>20719:                                                 [], BadCHdrs,
<a name="20720"/>20720:                                                 ?BASIC_REQ, BadReq]),
<a name="20721"/>20721:                                    {error, {unexpected_data, UnexpData}};
<a name="20722"/>20722:                                {ok, UnexpData} -&gt;
<a name="20723"/>20723:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20724"/>20724:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20725"/>20725:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20726"/>20726:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20727"/>20727:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20728"/>20728:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20729"/>20729:                                    {error, {unexpected_data, UnexpData}};
<a name="20730"/>20730:                                {error, _} = ERROR -&gt;
<a name="20731"/>20731:                                    %% At the moment there is no way to get
<a name="20732"/>20732:                                    %% status or state for the socket...
<a name="20733"/>20733:                                    ERROR
<a name="20734"/>20734:                            end
<a name="20735"/>20735:                    end},
<a name="20736"/>20736: 
<a name="20737"/>20737:          #{desc =&gt; &quot;set tos = reliability on src sock&quot;,
<a name="20738"/>20738:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="20739"/>20739:                            ok = socket:setopt(Sock, ip, tos, reliability)
<a name="20740"/>20740:                    end},
<a name="20741"/>20741:          #{desc =&gt; &quot;send req (to dst) (w tos = reliability)&quot;,
<a name="20742"/>20742:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="20743"/>20743:                          sa_dst   := Dst,
<a name="20744"/>20744:                          send     := Send}) -&gt;
<a name="20745"/>20745:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20746"/>20746:                    end},
<a name="20747"/>20747: 
<a name="20748"/>20748:          %% #{desc =&gt; &quot;send req (to dst) (w explicit tos = reliability)&quot;,
<a name="20749"/>20749:          %%   cmd  =&gt; fun(#{sock_src := Sock,
<a name="20750"/>20750:          %%                 sa_dst   := Dst,
<a name="20751"/>20751:          %%                 send     := Send}) -&gt;
<a name="20752"/>20752:          %%                   socket:setopt(Sock, otp, debug, true),
<a name="20753"/>20753:          %%                   case Send(Sock, ?BASIC_REQ, Dst, reliability) of
<a name="20754"/>20754:          %%                       ok -&gt;
<a name="20755"/>20755:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="20756"/>20756:          %%                           ok;
<a name="20757"/>20757:          %%                       {error, Reason} -&gt;
<a name="20758"/>20758:          %%                           ?SEV_EPRINT(&quot;Failed sending message with tos: &quot;
<a name="20759"/>20759:          %%                                       &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="20760"/>20760:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="20761"/>20761:          %%                           {skip, &quot;Failed sending message with TOS&quot;}
<a name="20762"/>20762:          %%                   end
<a name="20763"/>20763:          %%           end},
<a name="20764"/>20764: 
<a name="20765"/>20765:          #{desc =&gt; &quot;recv req (from src) - wo explicit tos&quot;,
<a name="20766"/>20766:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20767"/>20767:                            case Recv(Sock) of
<a name="20768"/>20768:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20769"/>20769:                                    ok;
<a name="20770"/>20770:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20771"/>20771:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20772"/>20772:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20773"/>20773:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20774"/>20774:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20775"/>20775:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20776"/>20776:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20777"/>20777:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20778"/>20778:                                                [Src, BadSrc,
<a name="20779"/>20779:                                                 [], BadCHdrs,
<a name="20780"/>20780:                                                 ?BASIC_REQ, BadReq]),
<a name="20781"/>20781:                                    {error, {unexpected_data, UnexpData}};
<a name="20782"/>20782:                                {ok, UnexpData} -&gt;
<a name="20783"/>20783:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20784"/>20784:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20785"/>20785:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20786"/>20786:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20787"/>20787:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20788"/>20788:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20789"/>20789:                                    {error, {unexpected_data, UnexpData}};
<a name="20790"/>20790:                                {error, _} = ERROR -&gt;
<a name="20791"/>20791:                                    %% At the moment there is no way to get
<a name="20792"/>20792:                                    %% status or state for the socket...
<a name="20793"/>20793:                                    ERROR
<a name="20794"/>20794:                            end
<a name="20795"/>20795:                    end},
<a name="20796"/>20796: 
<a name="20797"/>20797:          #{desc =&gt; &quot;set tos = 0 on src sock (\&quot;disabled\&quot;)&quot;,
<a name="20798"/>20798:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="20799"/>20799:                            ok = socket:setopt(Sock, ip, tos, 0)
<a name="20800"/>20800:                    end},
<a name="20801"/>20801: 
<a name="20802"/>20802:          #{desc =&gt; &quot;enable recvtos on dst socket&quot;,
<a name="20803"/>20803:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20804"/>20804:                            case Set(Sock, true) of
<a name="20805"/>20805:                                ok -&gt;
<a name="20806"/>20806:                                    ?SEV_IPRINT(&quot;dst recvtos enabled&quot;),
<a name="20807"/>20807:                                    ok;
<a name="20808"/>20808:                                {error, Reason} = ERROR -&gt;
<a name="20809"/>20809:                                    ?SEV_EPRINT(&quot;Failed setting recvtos:&quot;
<a name="20810"/>20810:                                                &quot;   ~p&quot;, [Reason]),
<a name="20811"/>20811:                                    ERROR
<a name="20812"/>20812:                            end
<a name="20813"/>20813:                    end},
<a name="20814"/>20814: 
<a name="20815"/>20815:          #{desc =&gt; &quot;enable recvtos on dst socket&quot;,
<a name="20816"/>20816:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20817"/>20817:                            case Set(Sock, true) of
<a name="20818"/>20818:                                ok -&gt;
<a name="20819"/>20819:                                    ?SEV_IPRINT(&quot;dst recvtos enabled&quot;),
<a name="20820"/>20820:                                    ok;
<a name="20821"/>20821:                                {error, Reason} = ERROR -&gt;
<a name="20822"/>20822:                                    ?SEV_EPRINT(&quot;Failed setting recvtos:&quot;
<a name="20823"/>20823:                                                &quot;   ~p&quot;, [Reason]),
<a name="20824"/>20824:                                    ERROR
<a name="20825"/>20825:                            end
<a name="20826"/>20826:                    end},
<a name="20827"/>20827: 
<a name="20828"/>20828:          #{desc =&gt; &quot;extract the (expected) recvtos \&quot;default\&quot; value&quot;,
<a name="20829"/>20829:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20830"/>20830:                            {ok, DefValue} = socket:getopt(Sock, ip, tos),
<a name="20831"/>20831:                            ?SEV_IPRINT(&quot;(expected) recvtos def value: ~w&quot;,
<a name="20832"/>20832:                                        [DefValue]),
<a name="20833"/>20833:                            {ok, State#{dst_def_value =&gt; DefValue}}
<a name="20834"/>20834:                    end},
<a name="20835"/>20835: 
<a name="20836"/>20836:          #{desc =&gt; &quot;send req (to dst) (wo explicit tos)&quot;,
<a name="20837"/>20837:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20838"/>20838:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20839"/>20839:                    end},
<a name="20840"/>20840:          #{desc =&gt; &quot;recv req (from src) - w default tos&quot;,
<a name="20841"/>20841:            cmd  =&gt; fun(#{sock_dst      := Sock,
<a name="20842"/>20842:                          dst_def_value := DefValue,
<a name="20843"/>20843:                          sa_src        := Src,
<a name="20844"/>20844:                          recv          := Recv}) -&gt;
<a name="20845"/>20845:                            ExpCHdr1 = #{level =&gt; ip,
<a name="20846"/>20846:                                         type  =&gt; tos,
<a name="20847"/>20847:                                         value =&gt; DefValue,
<a name="20848"/>20848:                                         data  =&gt; any},
<a name="20849"/>20849:                            ExpCHdr2 = #{level =&gt; ip,
<a name="20850"/>20850:                                         type  =&gt; recvtos,
<a name="20851"/>20851:                                         value =&gt; DefValue,
<a name="20852"/>20852:                                         data  =&gt; any},
<a name="20853"/>20853:                            case Recv(Sock) of
<a name="20854"/>20854:                                {ok, {Src, [#{level := ip,
<a name="20855"/>20855:                                              type  := TOS,
<a name="20856"/>20856:                                              value := DefValue}], ?BASIC_REQ}}
<a name="20857"/>20857:                                  when (TOS =:= tos) orelse
<a name="20858"/>20858:                                       (TOS =:= recvtos) -&gt;
<a name="20859"/>20859:                                    ?SEV_IPRINT(&quot;got default TOS (~w) &quot;
<a name="20860"/>20860:                                                &quot;control message header&quot;, [TOS]),
<a name="20861"/>20861:                                    ok;
<a name="20862"/>20862:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20863"/>20863:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20864"/>20864:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20865"/>20865:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20866"/>20866:                                                &quot;~n   Expect CHdrs:&quot;
<a name="20867"/>20867:                                                &quot;~n     Alt 1:  ~p&quot;
<a name="20868"/>20868:                                                &quot;~n     Alt 2:  ~p&quot;
<a name="20869"/>20869:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20870"/>20870:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20871"/>20871:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20872"/>20872:                                                [Src, BadSrc,
<a name="20873"/>20873:                                                 ExpCHdr1, ExpCHdr2, BadCHdrs,
<a name="20874"/>20874:                                                 ?BASIC_REQ, BadReq]),
<a name="20875"/>20875:                                    {error, {unexpected_data, UnexpData}};
<a name="20876"/>20876:                                {ok, UnexpData} -&gt;
<a name="20877"/>20877:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20878"/>20878:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20879"/>20879:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20880"/>20880:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20881"/>20881:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20882"/>20882:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20883"/>20883:                                    {error, {unexpected_data, UnexpData}};
<a name="20884"/>20884:                                {error, _} = ERROR -&gt;
<a name="20885"/>20885:                                    %% At the moment there is no way to get
<a name="20886"/>20886:                                    %% status or state for the socket...
<a name="20887"/>20887:                                    ERROR
<a name="20888"/>20888:                            end
<a name="20889"/>20889:                    end},
<a name="20890"/>20890: 
<a name="20891"/>20891:          #{desc =&gt; &quot;set tos = reliability on src sock&quot;,
<a name="20892"/>20892:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="20893"/>20893:                            ok = socket:setopt(Sock, ip, tos, reliability)
<a name="20894"/>20894:                    end},
<a name="20895"/>20895: 
<a name="20896"/>20896:          #{desc =&gt; &quot;send req (to dst) (w tos = mincost)&quot;,
<a name="20897"/>20897:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20898"/>20898:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20899"/>20899:                    end},
<a name="20900"/>20900:          #{desc =&gt; &quot;recv req (from src) - w tos = reliability&quot;,
<a name="20901"/>20901:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20902"/>20902:                            case Recv(Sock) of
<a name="20903"/>20903:                                {ok, {Src, [#{level := ip,
<a name="20904"/>20904:                                              type  := TOS,
<a name="20905"/>20905:                                              value := reliability = TOSData}],
<a name="20906"/>20906:                                      ?BASIC_REQ}} 
<a name="20907"/>20907:                                  when ((TOS =:= tos) orelse (TOS =:= recvtos)) -&gt;
<a name="20908"/>20908:                                    ?SEV_IPRINT(&quot;got expected TOS (~w) = ~w &quot;
<a name="20909"/>20909:                                                &quot;control message header&quot;, 
<a name="20910"/>20910:                                                [TOS, TOSData]),
<a name="20911"/>20911:                                    ok;
<a name="20912"/>20912:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20913"/>20913:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20914"/>20914:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20915"/>20915:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20916"/>20916:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20917"/>20917:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20918"/>20918:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20919"/>20919:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20920"/>20920:                                                [Src, BadSrc,
<a name="20921"/>20921:                                                 [], BadCHdrs,
<a name="20922"/>20922:                                                 ?BASIC_REQ, BadReq]),
<a name="20923"/>20923:                                    {error, {unexpected_data, UnexpData}};
<a name="20924"/>20924:                                {ok, UnexpData} -&gt;
<a name="20925"/>20925:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20926"/>20926:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20927"/>20927:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20928"/>20928:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20929"/>20929:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20930"/>20930:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20931"/>20931:                                    {error, {unexpected_data, UnexpData}};
<a name="20932"/>20932:                                {error, _} = ERROR -&gt;
<a name="20933"/>20933:                                    %% At the moment there is no way to get
<a name="20934"/>20934:                                    %% status or state for the socket...
<a name="20935"/>20935:                                    ERROR
<a name="20936"/>20936:                            end
<a name="20937"/>20937:                    end},
<a name="20938"/>20938: 
<a name="20939"/>20939:          #{desc =&gt; &quot;close src socket&quot;,
<a name="20940"/>20940:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20941"/>20941:                            ok = socket:close(Sock),
<a name="20942"/>20942:                            {ok, maps:remove(sock_src, State)}
<a name="20943"/>20943:                    end},
<a name="20944"/>20944:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="20945"/>20945:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20946"/>20946:                            ok = socket:close(Sock),
<a name="20947"/>20947:                            {ok, maps:remove(sock_dst, State)}
<a name="20948"/>20948:                    end},
<a name="20949"/>20949: 
<a name="20950"/>20950:          %% *** We are done ***
<a name="20951"/>20951:          ?SEV_FINISH_NORMAL
<a name="20952"/>20952:         ],
<a name="20953"/>20953:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvtos_udp-last_expr"/><a name="20954"/>20954: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="20955"/>20955: 
<a name="20956"/>20956: 
<a name="20957"/>20957: 
<a name="20958"/>20958: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20959"/>20959: 
<a name="20960"/>20960: <i>%% Tests that the ttl control message header is received when</i>
<a name="20961"/>20961: <i>%% setting the socket 'ip' option recvttl is set to true when using</i>
<a name="20962"/>20962: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="20963"/>20963: <i>%% So, this is done on the receiving side: </i>
<a name="20964"/>20964: <i>%%</i>
<a name="20965"/>20965: <i>%%               socket:setopt(Sock, ip, recvttl, boolean()).</i>
<a name="20966"/>20966: <i>%%</i>
<a name="20967"/>20967: <i>%% For all subsequent *received* messages, the ttl control message</i>
<a name="20968"/>20968: <i>%% header will be with the message.</i>
<a name="20969"/>20969: <i>%%</i>
<a name="20970"/>20970: <i>%% On darwin we don't actually get the TTL we send even after we have</i>
<a name="20971"/>20971: <i>%% enabled TTL. Instead we get the default value (which was 64).</i>
<a name="20972"/>20972: <i>%% Possibly this is because we run the test in the same OS process and</i>
<a name="20973"/>20973: <i>%% even the same erlang process....</i>
<a name="20974"/>20974: <i>%% The same issue on OpenBSD (6.6).</i>
<a name="20975"/>20975: <i>%% Maybe we should send and receive from different VMs, until then</i>
<a name="20976"/>20976: <i>%% skip darwin and OpenBSD.</i>
<a name="20977"/>20977: <i>%%</i>
<a name="20978"/>20978: <i>%% Windows:</i>
<a name="20979"/>20979: <i>%% It seems like its possible to set and get the recvttl option,</i>
<a name="20980"/>20980: <i>%% but not to use the ttl control message header when sending.</i>
<a name="20981"/>20981: <i>%% The following is the list of types (for level ip) which are listed</i>
<a name="20982"/>20982: <i>%% as supported: IP_ORIGINAL_ARRIVAL_IF, IP_PKTINFO and IP_ECN</i>
<a name="20983"/>20983: 
<a name="api_opt_ip_recvttl_udp4-1"/><a name="20984"/>20984: <b>api_opt_ip_recvttl_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="20985"/>20985:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvttl_udp4-last_expr"/><a name="20986"/>20986: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="20987"/>20987:            fun() -&gt;
<a name="20988"/>20988:                    has_support_ipv4(),
<a name="20989"/>20989: 		   has_support_ip_recvttl(),
<a name="20990"/>20990: 		   is_not_openbsd(),
<a name="20991"/>20991: 		   is_not_darwin()
<a name="20992"/>20992: 	   end,
<a name="20993"/>20993:            fun() -&gt;
<a name="20994"/>20994:                    Set  = fun(Sock, Value) -&gt;
<a name="20995"/>20995:                                   socket:setopt(Sock, ip, recvttl, Value)
<a name="20996"/>20996:                           end,
<a name="20997"/>20997:                    Get  = fun(Sock) -&gt;
<a name="20998"/>20998:                                   socket:getopt(Sock, ip, recvttl)
<a name="20999"/>20999:                           end,
<a name="21000"/>21000:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="21001"/>21001:                                   Msg = #{addr =&gt; Dest,
<a name="21002"/>21002:                                           iov  =&gt; [Data]},
<a name="21003"/>21003:                                   socket:sendmsg(Sock, Msg);
<a name="21004"/>21004:                              (Sock, Data, Dest, TTL) -&gt;
<a name="21005"/>21005:                                   CMsg = #{level =&gt; ip,
<a name="21006"/>21006:                                            type  =&gt; ttl,
<a name="21007"/>21007:                                            value =&gt; TTL},
<a name="21008"/>21008:                                   Msg  = #{addr =&gt; Dest,
<a name="21009"/>21009:                                            ctrl =&gt; [CMsg],
<a name="21010"/>21010:                                            iov  =&gt; [Data]},
<a name="21011"/>21011:                                   socket:sendmsg(Sock, Msg)
<a name="21012"/>21012:                           end,
<a name="21013"/>21013:                    Recv = fun(Sock) -&gt;
<a name="21014"/>21014:                                   case socket:recvmsg(Sock) of
<a name="21015"/>21015:                                       {ok, #{addr := Source,
<a name="21016"/>21016:                                              ctrl := CMsgs,
<a name="21017"/>21017:                                              iov  := [Data]}} -&gt;
<a name="21018"/>21018:                                           {ok, {Source, CMsgs, Data}};
<a name="21019"/>21019:                                       {error, _} = ERROR -&gt;
<a name="21020"/>21020:                                           ERROR
<a name="21021"/>21021:                                   end
<a name="21022"/>21022:                           end,
<a name="21023"/>21023:                    InitState = #{domain =&gt; inet,
<a name="21024"/>21024:                                  proto  =&gt; udp,
<a name="21025"/>21025:                                  send   =&gt; Send,
<a name="21026"/>21026:                                  recv   =&gt; Recv,
<a name="21027"/>21027:                                  set    =&gt; Set,
<a name="21028"/>21028:                                  get    =&gt; Get},
<a name="21029"/>21029:                    ok = api_opt_ip_recvttl_udp(InitState)
<a name="21030"/>21030:            end).
<a name="21031"/>21031: 
<a name="21032"/>21032: 
<a name="21033"/>21033: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21034"/>21034: 
<a name="api_opt_ip_recvttl_udp-1"/><a name="21035"/>21035: <b>api_opt_ip_recvttl_udp</b>(InitState) -&gt;
<a name="21036"/>21036:     Seq = 
<a name="21037"/>21037:         [
<a name="21038"/>21038:          #{desc =&gt; &quot;local address&quot;,
<a name="21039"/>21039:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="21040"/>21040:                            LSASrc = which_local_socket_addr(Domain),
<a name="21041"/>21041:                            LSADst = which_local_socket_addr(Domain),
<a name="21042"/>21042:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="21043"/>21043:                                        lsa_dst =&gt; LSADst}};
<a name="21044"/>21044:                       (#{domain := Domain} = State) -&gt;
<a name="21045"/>21045:                            LSA = which_local_socket_addr(Domain),
<a name="21046"/>21046:                            {ok, State#{lsa_src =&gt; LSA,
<a name="21047"/>21047:                                        lsa_dst =&gt; LSA}}
<a name="21048"/>21048:                    end},
<a name="21049"/>21049: 
<a name="21050"/>21050:          #{desc =&gt; &quot;open src socket&quot;,
<a name="21051"/>21051:            cmd  =&gt; fun(#{domain := Domain,
<a name="21052"/>21052:                          proto  := Proto} = State) -&gt;
<a name="21053"/>21053:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21054"/>21054:                            {ok, State#{sock_src =&gt; Sock}}
<a name="21055"/>21055:                    end},
<a name="21056"/>21056:          #{desc =&gt; &quot;bind src&quot;,
<a name="21057"/>21057:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="21058"/>21058:                            case sock_bind(Sock, LSA) of
<a name="21059"/>21059:                                ok -&gt;
<a name="21060"/>21060:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="21061"/>21061:                                    ok;
<a name="21062"/>21062:                                {error, Reason} = ERROR -&gt;
<a name="21063"/>21063:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="21064"/>21064:                                    ERROR
<a name="21065"/>21065:                            end
<a name="21066"/>21066:                    end},
<a name="21067"/>21067:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="21068"/>21068:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21069"/>21069:                            SASrc = sock_sockname(Sock),
<a name="21070"/>21070:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="21071"/>21071:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="21072"/>21072:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="21073"/>21073:                    end},
<a name="21074"/>21074: 
<a name="21075"/>21075:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="21076"/>21076:            cmd  =&gt; fun(#{domain := Domain,
<a name="21077"/>21077:                          proto  := Proto} = State) -&gt;
<a name="21078"/>21078:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21079"/>21079:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="21080"/>21080:                    end},
<a name="21081"/>21081:          #{desc =&gt; &quot;bind dst&quot;,
<a name="21082"/>21082:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="21083"/>21083:                            case sock_bind(Sock, LSA) of
<a name="21084"/>21084:                                ok -&gt;
<a name="21085"/>21085:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="21086"/>21086:                                    ok;
<a name="21087"/>21087:                                {error, Reason} = ERROR -&gt;
<a name="21088"/>21088:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="21089"/>21089:                                    ERROR
<a name="21090"/>21090:                            end
<a name="21091"/>21091:                    end},
<a name="21092"/>21092:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="21093"/>21093:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21094"/>21094:                            SADst = sock_sockname(Sock),
<a name="21095"/>21095:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="21096"/>21096:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="21097"/>21097:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="21098"/>21098:                    end},
<a name="21099"/>21099:          #{desc =&gt; &quot;default recvttl for dst socket&quot;,
<a name="21100"/>21100:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="21101"/>21101:                            case Get(Sock) of
<a name="21102"/>21102:                                {ok, false = Value} -&gt;
<a name="21103"/>21103:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="21104"/>21104:                                    ok;
<a name="21105"/>21105:                                {ok, Unexpected} -&gt;
<a name="21106"/>21106:                                    ?SEV_EPRINT(&quot;Unexpected src recvttl: ~p&quot;,
<a name="21107"/>21107:                                                [Unexpected]),
<a name="21108"/>21108:                                    {error, {unexpected, Unexpected}};
<a name="21109"/>21109:                                {error, Reason} = ERROR -&gt;
<a name="21110"/>21110:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="21111"/>21111:                                                &quot;   ~p&quot;, [Reason]),
<a name="21112"/>21112:                                    ERROR
<a name="21113"/>21113:                            end
<a name="21114"/>21114:                    end},
<a name="21115"/>21115: 
<a name="21116"/>21116:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="21117"/>21117:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21118"/>21118:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21119"/>21119:                    end},
<a name="21120"/>21120:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="21121"/>21121:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21122"/>21122:                            case Recv(Sock) of
<a name="21123"/>21123:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21124"/>21124:                                    ok;
<a name="21125"/>21125:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21126"/>21126:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21127"/>21127:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21128"/>21128:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21129"/>21129:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21130"/>21130:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21131"/>21131:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21132"/>21132:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21133"/>21133:                                                [Src, BadSrc,
<a name="21134"/>21134:                                                 [], BadCHdrs,
<a name="21135"/>21135:                                                 ?BASIC_REQ, BadReq]),
<a name="21136"/>21136:                                    {error, {unexpected_data, UnexpData}};
<a name="21137"/>21137:                                {ok, UnexpData} -&gt;
<a name="21138"/>21138:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21139"/>21139:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21140"/>21140:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21141"/>21141:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21142"/>21142:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21143"/>21143:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21144"/>21144:                                    {error, {unexpected_data, UnexpData}};
<a name="21145"/>21145:                                {error, _} = ERROR -&gt;
<a name="21146"/>21146:                                    %% At the moment there is no way to get
<a name="21147"/>21147:                                    %% status or state for the socket...
<a name="21148"/>21148:                                    ERROR
<a name="21149"/>21149:                            end
<a name="21150"/>21150:                    end},
<a name="21151"/>21151: 
<a name="21152"/>21152:          #{desc =&gt; &quot;send req (to dst) (w explicit ttl = 100)&quot;,
<a name="21153"/>21153:            cmd  =&gt; fun(#{sock_src := SSock,
<a name="21154"/>21154:                          sock_dst := DSock, sa_dst := Dst,
<a name="21155"/>21155:                          send     := Send}) -&gt;
<a name="21156"/>21156:                            case Send(SSock, ?BASIC_REQ, Dst, 100) of
<a name="21157"/>21157:                                ok -&gt;
<a name="21158"/>21158:                                    ok;
<a name="21159"/>21159:                                {error, einval = Reason} -&gt;
<a name="21160"/>21160:                                    %% IF we can't send it the test will not work
<a name="21161"/>21161:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21162"/>21162:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="21163"/>21163:                                    (catch socket:close(SSock)),
<a name="21164"/>21164:                                    (catch socket:close(DSock)),
<a name="21165"/>21165:                                    {skip,
<a name="21166"/>21166: 				    ?F(&quot;Cannot send with TTL: ~p&quot;, [Reason])};
<a name="21167"/>21167:                                {error, enoprotoopt = Reason} -&gt;
<a name="21168"/>21168:                                    %% On some platforms this is not
<a name="21169"/>21169:                                    %% accepted (FreeBSD), so skip.
<a name="21170"/>21170:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="21171"/>21171:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="21172"/>21172:                                    (catch socket:close(SSock)),
<a name="21173"/>21173:                                    (catch socket:close(DSock)),
<a name="21174"/>21174:                                    {skip, Reason};
<a name="21175"/>21175: 
<a name="21176"/>21176:                                {error,
<a name="21177"/>21177:                                 {get_overlapped_result,
<a name="21178"/>21178:                                  #{file     := File,
<a name="21179"/>21179:                                    function := Function,
<a name="21180"/>21180:                                    line     := Line,
<a name="21181"/>21181:                                    raw_info := RawInfo,
<a name="21182"/>21182:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="21183"/>21183:                                    %% IF we can't send it the test will not work
<a name="21184"/>21184:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21185"/>21185:                                                &quot;~p =&gt; SKIP: &quot;
<a name="21186"/>21186:                                                &quot;~n   File:     ~s&quot;
<a name="21187"/>21187:                                                &quot;~n   Function: ~s&quot;
<a name="21188"/>21188:                                                &quot;~n   Line:     ~p&quot;
<a name="21189"/>21189:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="21190"/>21190:                                                [Info,
<a name="21191"/>21191:                                                 File, Function, Line,
<a name="21192"/>21192:                                                 RawInfo]),
<a name="21193"/>21193:                                    (catch socket:close(SSock)),
<a name="21194"/>21194:                                    (catch socket:close(DSock)),
<a name="21195"/>21195:                                    {skip,
<a name="21196"/>21196:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="21197"/>21197:                                {error, {get_overlapped_result,
<a name="21198"/>21198:                                         invalid_parameter = Info}} -&gt;
<a name="21199"/>21199:                                    %% IF we can't send it the test will not work
<a name="21200"/>21200:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21201"/>21201:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="21202"/>21202:                                    (catch socket:close(SSock)),
<a name="21203"/>21203:                                    (catch socket:close(DSock)),
<a name="21204"/>21204:                                    {skip,
<a name="21205"/>21205:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="21206"/>21206: 
<a name="21207"/>21207:                                {error,
<a name="21208"/>21208:                                 {completion_status,
<a name="21209"/>21209:                                  #{file     := File,
<a name="21210"/>21210:                                    function := Function,
<a name="21211"/>21211:                                    line     := Line,
<a name="21212"/>21212:                                    raw_info := RawInfo,
<a name="21213"/>21213:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="21214"/>21214:                                    %% IF we can't send it the test will not work
<a name="21215"/>21215:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21216"/>21216:                                                &quot;~p =&gt; SKIP: &quot;
<a name="21217"/>21217:                                                &quot;~n   File:     ~s&quot;
<a name="21218"/>21218:                                                &quot;~n   Function: ~s&quot;
<a name="21219"/>21219:                                                &quot;~n   Line:     ~p&quot;
<a name="21220"/>21220:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="21221"/>21221:                                                [Info,
<a name="21222"/>21222:                                                 File, Function, Line,
<a name="21223"/>21223:                                                 RawInfo]),
<a name="21224"/>21224:                                    (catch socket:close(SSock)),
<a name="21225"/>21225:                                    (catch socket:close(DSock)),
<a name="21226"/>21226:                                    {skip,
<a name="21227"/>21227:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="21228"/>21228:                                {error, {completion_status,
<a name="21229"/>21229:                                         invalid_parameter = Info}} -&gt;
<a name="21230"/>21230:                                    %% IF we can't send it the test will not work
<a name="21231"/>21231:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21232"/>21232:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="21233"/>21233:                                    (catch socket:close(SSock)),
<a name="21234"/>21234:                                    (catch socket:close(DSock)),
<a name="21235"/>21235:                                    {skip,
<a name="21236"/>21236:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="21237"/>21237: 
<a name="21238"/>21238:                                {error, _Reason} = ERROR -&gt;
<a name="21239"/>21239:                                    ERROR
<a name="21240"/>21240:                            end
<a name="21241"/>21241:                    end},
<a name="21242"/>21242:          #{desc =&gt; &quot;recv req (from src) - wo ttl&quot;,
<a name="21243"/>21243:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21244"/>21244:                            case Recv(Sock) of
<a name="21245"/>21245:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21246"/>21246:                                    ok;
<a name="21247"/>21247:                                {ok, {Src, [#{level := ip,
<a name="21248"/>21248:                                              type  := TTLType,
<a name="21249"/>21249:                                              value := TTL}], ?BASIC_REQ}}
<a name="21250"/>21250:                                when ((TTLType =:= recvttl) andalso
<a name="21251"/>21251:                                      (TTL =:= 255)) -&gt;
<a name="21252"/>21252:                                    %% This is the behaviopur on Solaris (11)
<a name="21253"/>21253:                                    %% and maybe on other platforms...
<a name="21254"/>21254:                                    ?SEV_IPRINT(&quot;Got (default) TTL (~w): ~p&quot;,
<a name="21255"/>21255:                                                [TTLType, TTL]),
<a name="21256"/>21256:                                    ok;
<a name="21257"/>21257:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21258"/>21258:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21259"/>21259:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21260"/>21260:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21261"/>21261:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21262"/>21262:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21263"/>21263:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21264"/>21264:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21265"/>21265:                                                [Src, BadSrc,
<a name="21266"/>21266:                                                 [], BadCHdrs,
<a name="21267"/>21267:                                                 ?BASIC_REQ, BadReq]),
<a name="21268"/>21268:                                    {error, {unexpected_data, UnexpData}};
<a name="21269"/>21269:                                {ok, UnexpData} -&gt;
<a name="21270"/>21270:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21271"/>21271:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21272"/>21272:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21273"/>21273:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21274"/>21274:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21275"/>21275:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21276"/>21276:                                    {error, {unexpected_data, UnexpData}};
<a name="21277"/>21277:                                {error, _} = ERROR -&gt;
<a name="21278"/>21278:                                    %% At the moment there is no way to get
<a name="21279"/>21279:                                    %% status or state for the socket...
<a name="21280"/>21280:                                    ERROR
<a name="21281"/>21281:                            end
<a name="21282"/>21282:                    end},
<a name="21283"/>21283: 
<a name="21284"/>21284:          #{desc =&gt; &quot;enable recvttl on dst socket&quot;,
<a name="21285"/>21285:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="21286"/>21286:                            case Set(Sock, true) of
<a name="21287"/>21287:                                ok -&gt;
<a name="21288"/>21288:                                    ?SEV_IPRINT(&quot;dst recvttl enabled&quot;),
<a name="21289"/>21289:                                    ok;
<a name="21290"/>21290:                                {error, Reason} = ERROR -&gt;
<a name="21291"/>21291:                                    ?SEV_EPRINT(&quot;Failed enabling recvttl:&quot;
<a name="21292"/>21292:                                                &quot;   ~p&quot;, [Reason]),
<a name="21293"/>21293:                                    ERROR
<a name="21294"/>21294:                            end
<a name="21295"/>21295:                    end},
<a name="21296"/>21296: 
<a name="21297"/>21297:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="21298"/>21298:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21299"/>21299:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21300"/>21300:                    end},
<a name="21301"/>21301:          #{desc =&gt; &quot;recv req (from src) - w default ttl&quot;,
<a name="21302"/>21302:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21303"/>21303:                            case Recv(Sock) of
<a name="21304"/>21304:                                {ok, {Src, [#{level := ip,
<a name="21305"/>21305:                                              type  := TTLType,
<a name="21306"/>21306:                                              value := TTL}], ?BASIC_REQ}}
<a name="21307"/>21307:                                when ((TTLType =:= ttl) orelse 
<a name="21308"/>21308:                                      (TTLType =:= recvttl)) -&gt;
<a name="21309"/>21309:                                    ?SEV_IPRINT(&quot;Got (default) TTL (~w): ~p&quot;,
<a name="21310"/>21310:                                                [TTLType, TTL]),
<a name="21311"/>21311:                                    ok;
<a name="21312"/>21312:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21313"/>21313:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21314"/>21314:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21315"/>21315:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21316"/>21316:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21317"/>21317:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21318"/>21318:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21319"/>21319:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21320"/>21320:                                                [Src, BadSrc,
<a name="21321"/>21321:                                                 [#{level =&gt; ip,
<a name="21322"/>21322: 						   type  =&gt; ttl,
<a name="21323"/>21323: 						   value =&gt; &quot;something&quot;}],
<a name="21324"/>21324: 						BadCHdrs,
<a name="21325"/>21325:                                                 ?BASIC_REQ, BadReq]),
<a name="21326"/>21326:                                    {error, {unexpected_data, UnexpData}};
<a name="21327"/>21327:                                {ok, UnexpData} -&gt;
<a name="21328"/>21328:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21329"/>21329:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21330"/>21330:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21331"/>21331:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21332"/>21332:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21333"/>21333:                                                [Src, [#{level =&gt; ip,
<a name="21334"/>21334: 							type  =&gt; ttl,
<a name="21335"/>21335: 							value =&gt; &quot;something&quot;}],
<a name="21336"/>21336: 						?BASIC_REQ, UnexpData]),
<a name="21337"/>21337:                                    {error, {unexpected_data, UnexpData}};
<a name="21338"/>21338:                                {error, _} = ERROR -&gt;
<a name="21339"/>21339:                                    %% At the moment there is no way to get
<a name="21340"/>21340:                                    %% status or state for the socket...
<a name="21341"/>21341:                                    ERROR
<a name="21342"/>21342:                            end
<a name="21343"/>21343:                    end},
<a name="21344"/>21344: 
<a name="21345"/>21345:          #{desc =&gt; &quot;send req (to dst) (w explicit ttl = 100)&quot;,
<a name="21346"/>21346:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21347"/>21347:                            Send(Sock, ?BASIC_REQ, Dst, 100)
<a name="21348"/>21348:                    end},
<a name="21349"/>21349:          #{desc =&gt; &quot;recv req (from src) - w ttl = 100&quot;,
<a name="21350"/>21350:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21351"/>21351:                            case Recv(Sock) of
<a name="21352"/>21352:                                {ok, {Src, [#{level := ip,
<a name="21353"/>21353:                                              type  := TTLType,
<a name="21354"/>21354:                                              value := 100 = TTL}], ?BASIC_REQ}}
<a name="21355"/>21355:                                when ((TTLType =:= ttl) orelse
<a name="21356"/>21356:                                      (TTLType =:= recvttl)) -&gt;
<a name="21357"/>21357:                                    ?SEV_IPRINT(&quot;Got TTL (~w): ~p&quot;,
<a name="21358"/>21358:                                                [TTLType, TTL]),
<a name="21359"/>21359:                                    ok;
<a name="21360"/>21360:                                {ok, {Src, [#{level := ip,
<a name="21361"/>21361:                                              type  := TTLType,
<a name="21362"/>21362:                                              value := BadTTL}], ?BASIC_REQ}}
<a name="21363"/>21363:                                when ((TTLType =:= ttl) orelse
<a name="21364"/>21364:                                      (TTLType =:= recvttl)) -&gt;
<a name="21365"/>21365:                                    ?SEV_EPRINT(&quot;Unexpected TTL: &quot;
<a name="21366"/>21366:                                                &quot;~n   Expect TTL: ~p&quot;
<a name="21367"/>21367:                                                &quot;~n   Recv TTL:   ~p&quot;,
<a name="21368"/>21368:                                                [100, BadTTL]),
<a name="21369"/>21369:                                    {error, {unexpected_ttl, {100, BadTTL}}};
<a name="21370"/>21370:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21371"/>21371:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21372"/>21372:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21373"/>21373:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21374"/>21374:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21375"/>21375:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21376"/>21376:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21377"/>21377:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21378"/>21378:                                                [Src, BadSrc,
<a name="21379"/>21379:                                                 [#{level =&gt; ip,
<a name="21380"/>21380: 						   type  =&gt; ttl,
<a name="21381"/>21381: 						   value =&gt; 100}], BadCHdrs,
<a name="21382"/>21382:                                                 ?BASIC_REQ, BadReq]),
<a name="21383"/>21383:                                    {error, {unexpected_data, UnexpData}};
<a name="21384"/>21384:                                {ok, UnexpData} -&gt;
<a name="21385"/>21385:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21386"/>21386:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21387"/>21387:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21388"/>21388:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21389"/>21389:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21390"/>21390:                                                [Src, [#{level =&gt; ip,
<a name="21391"/>21391: 							type  =&gt; ttl,
<a name="21392"/>21392: 							value =&gt; 100}],
<a name="21393"/>21393: 						?BASIC_REQ, UnexpData]),
<a name="21394"/>21394:                                    {error, {unexpected_data, UnexpData}};
<a name="21395"/>21395:                                {error, _} = ERROR -&gt;
<a name="21396"/>21396:                                    %% At the moment there is no way to get
<a name="21397"/>21397:                                    %% status or state for the socket...
<a name="21398"/>21398:                                    ERROR
<a name="21399"/>21399:                            end
<a name="21400"/>21400:                    end},
<a name="21401"/>21401: 
<a name="21402"/>21402:          #{desc =&gt; &quot;close src socket&quot;,
<a name="21403"/>21403:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21404"/>21404:                            ok = socket:close(Sock),
<a name="21405"/>21405:                            {ok, maps:remove(sock_src, State)}
<a name="21406"/>21406:                    end},
<a name="21407"/>21407:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="21408"/>21408:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21409"/>21409:                            ok = socket:close(Sock),
<a name="21410"/>21410:                            {ok, maps:remove(sock_dst, State)}
<a name="21411"/>21411:                    end},
<a name="21412"/>21412: 
<a name="21413"/>21413:          %% *** We are done ***
<a name="21414"/>21414:          ?SEV_FINISH_NORMAL
<a name="21415"/>21415:         ],
<a name="21416"/>21416:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvttl_udp-last_expr"/><a name="21417"/>21417: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="21418"/>21418: 
<a name="21419"/>21419: 
<a name="21420"/>21420: 
<a name="21421"/>21421: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21422"/>21422: 
<a name="21423"/>21423: <i>%% Tests the ip socket option 'tos' can be set and retrieved from a</i>
<a name="21424"/>21424: <i>%% the socket its set on. It sets the type-of-server field in the IP</i>
<a name="21425"/>21425: <i>%% header for a TCP or UDP socket.</i>
<a name="21426"/>21426: <i>%% There is no way to fetch the value a received IP datagram.</i>
<a name="21427"/>21427: <i>%% Default value is supposed to be '0'.</i>
<a name="21428"/>21428: <i>%% </i>
<a name="21429"/>21429: 
<a name="api_opt_ip_tos_udp4-1"/><a name="21430"/>21430: <b>api_opt_ip_tos_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="21431"/>21431:     ?TT(?SECS(5)),
<a name="api_opt_ip_tos_udp4-last_expr"/><a name="21432"/>21432: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="21433"/>21433:            fun() -&gt;
<a name="21434"/>21434:                    is_not_windows(), % IP_TOS on windows
<a name="21435"/>21435:                    has_support_ipv4(),
<a name="21436"/>21436:                    has_support_ip_tos()
<a name="21437"/>21437:            end,
<a name="21438"/>21438:            fun() -&gt;
<a name="21439"/>21439:                    Set  = fun(Sock, Value) -&gt;
<a name="21440"/>21440:                                   socket:setopt(Sock, ip, tos, Value)
<a name="21441"/>21441:                           end,
<a name="21442"/>21442:                    Get  = fun(Sock) -&gt;
<a name="21443"/>21443:                                   socket:getopt(Sock, ip, tos)
<a name="21444"/>21444:                           end,
<a name="21445"/>21445:                    InitState = #{set =&gt; Set,
<a name="21446"/>21446:                                  get =&gt; Get},
<a name="21447"/>21447:                    ok = api_opt_ip_tos_udp(InitState)
<a name="21448"/>21448:            end).
<a name="21449"/>21449: 
<a name="21450"/>21450: 
<a name="21451"/>21451: 
<a name="21452"/>21452: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21453"/>21453: 
<a name="api_opt_ip_tos_udp-1"/><a name="21454"/>21454: <b>api_opt_ip_tos_udp</b>(InitState) -&gt;
<a name="21455"/>21455:     process_flag(trap_exit, true),
<a name="21456"/>21456:     %% mincost is not supported on all platforms.
<a name="21457"/>21457:     %% For instance, Solaris 10, does not have that constant.
<a name="21458"/>21458:     %% Instead it has two others with, what appears to be,
<a name="21459"/>21459:     %% completely different meanings...
<a name="21460"/>21460:     %% So, avoid the complication by not using this value...
<a name="21461"/>21461:     %% TOS1 = mincost,     TOS1Str = atom_to_list(TOS1),
<a name="21462"/>21462:     TOS2 = throughput,  TOS2Str = atom_to_list(TOS2),
<a name="21463"/>21463:     TOS3 = reliability, TOS3Str = atom_to_list(TOS3),
<a name="21464"/>21464:     TOS4 = lowdelay,    TOS4Str = atom_to_list(TOS4),
<a name="21465"/>21465:     TOS5 = 42,          TOS5Str = integer_to_list(TOS5),
<a name="21466"/>21466:     Seq =
<a name="21467"/>21467:         [
<a name="21468"/>21468:          #{desc =&gt; &quot;local address&quot;,
<a name="21469"/>21469:            cmd  =&gt; fun(State) -&gt;
<a name="21470"/>21470:                            LSA = which_local_socket_addr(inet),
<a name="21471"/>21471:                            {ok, State#{lsa =&gt; LSA}}
<a name="21472"/>21472:                    end},
<a name="21473"/>21473: 
<a name="21474"/>21474:          #{desc =&gt; &quot;open socket&quot;,
<a name="21475"/>21475:            cmd  =&gt; fun(State) -&gt;
<a name="21476"/>21476:                            Sock = sock_open(inet, dgram, udp),
<a name="21477"/>21477:                            {ok, State#{sock =&gt; Sock}}
<a name="21478"/>21478:                    end},
<a name="21479"/>21479:          #{desc =&gt; &quot;bind&quot;,
<a name="21480"/>21480:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="21481"/>21481:                            case sock_bind(Sock, LSA) of
<a name="21482"/>21482:                                ok -&gt;
<a name="21483"/>21483:                                    ?SEV_IPRINT(&quot;socket bound&quot;),
<a name="21484"/>21484:                                    ok;
<a name="21485"/>21485:                                {error, Reason} = ERROR -&gt;
<a name="21486"/>21486:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="21487"/>21487:                                    ERROR
<a name="21488"/>21488:                            end
<a name="21489"/>21489:                    end},
<a name="21490"/>21490: 
<a name="21491"/>21491:          #{desc =&gt; &quot;get default tos&quot;,
<a name="21492"/>21492:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21493"/>21493:                            case Get(Sock) of
<a name="21494"/>21494:                                {ok, 0 = Value} -&gt;
<a name="21495"/>21495:                                    ?SEV_IPRINT(&quot;expected default tos: ~p&quot;, [Value]),
<a name="21496"/>21496:                                    ok;
<a name="21497"/>21497:                                {ok, Value} -&gt;
<a name="21498"/>21498:                                    %% On FreeBSD 14 default value is not 0!
<a name="21499"/>21499:                                    case os:type() of
<a name="21500"/>21500:                                        {unix, freebsd} -&gt;
<a name="21501"/>21501:                                            case os:version() of
<a name="21502"/>21502:                                                {14, _, _}
<a name="21503"/>21503:                                                  when (Value =:= mincost) -&gt;
<a name="21504"/>21504:                                                    ok;
<a name="21505"/>21505:                                                _ -&gt;
<a name="21506"/>21506:                                                    ?SEV_EPRINT(&quot;Unexpected &quot;
<a name="21507"/>21507:                                                                &quot;default &quot;
<a name="21508"/>21508:                                                                &quot;tos: ~p&quot;,
<a name="21509"/>21509:                                                                [Value]),
<a name="21510"/>21510:                                                    {error, {unexpected, Value}}
<a name="21511"/>21511:                                            end;
<a name="21512"/>21512:                                        _ -&gt;
<a name="21513"/>21513:                                            ?SEV_EPRINT(&quot;Unexpected &quot;
<a name="21514"/>21514:                                                        &quot;default &quot;
<a name="21515"/>21515:                                                        &quot;tos: ~p&quot;,
<a name="21516"/>21516:                                                        [Value]),
<a name="21517"/>21517:                                            {error, {unexpected, Value}}
<a name="21518"/>21518:                                    end;
<a name="21519"/>21519:                                {error, Reason} = ERROR -&gt;
<a name="21520"/>21520:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21521"/>21521:                                                &quot;   ~p&quot;, [Reason]),
<a name="21522"/>21522:                                    ERROR
<a name="21523"/>21523:                            end
<a name="21524"/>21524:                    end},
<a name="21525"/>21525: 
<a name="21526"/>21526:          %% #{desc =&gt; &quot;set tos &quot; ++ TOS1Str,
<a name="21527"/>21527:          %%   cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21528"/>21528:          %%                   socket:setopt(Sock, otp, debug, true),
<a name="21529"/>21529:          %%                   case Set(Sock, TOS1) of
<a name="21530"/>21530:          %%                       ok -&gt;
<a name="21531"/>21531:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="21532"/>21532:          %%                           ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS1]),
<a name="21533"/>21533:          %%                           ok;
<a name="21534"/>21534:          %%                       {error, Reason} = ERROR -&gt;
<a name="21535"/>21535:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="21536"/>21536:          %%                           ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21537"/>21537:          %%                                       &quot;   ~p&quot;, [Reason]),
<a name="21538"/>21538:          %%                           ERROR
<a name="21539"/>21539:          %%                   end
<a name="21540"/>21540:          %%           end},
<a name="21541"/>21541:          %% #{desc =&gt; &quot;get tos (expect &quot; ++ TOS1Str ++ &quot;)&quot;,
<a name="21542"/>21542:          %%   cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21543"/>21543:          %%                   case Get(Sock) of
<a name="21544"/>21544:          %%                       {ok, TOS1 = Value} -&gt;
<a name="21545"/>21545:          %%                           ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21546"/>21546:          %%                           ok;
<a name="21547"/>21547:          %%                       {ok, Unexpected} -&gt;
<a name="21548"/>21548:          %%                           ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21549"/>21549:          %%                                       [Unexpected]),
<a name="21550"/>21550:          %%                           {error, {unexpected, Unexpected}};
<a name="21551"/>21551:          %%                       {error, Reason} = ERROR -&gt;
<a name="21552"/>21552:          %%                           ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21553"/>21553:          %%                                       &quot;   ~p&quot;, [Reason]),
<a name="21554"/>21554:          %%                           ERROR
<a name="21555"/>21555:          %%                   end
<a name="21556"/>21556:          %%           end},
<a name="21557"/>21557: 
<a name="21558"/>21558:          #{desc =&gt; &quot;set tos &quot; ++ TOS2Str,
<a name="21559"/>21559:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21560"/>21560:                            case Set(Sock, TOS2) of
<a name="21561"/>21561:                                ok -&gt;
<a name="21562"/>21562:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS2]),
<a name="21563"/>21563:                                    ok;
<a name="21564"/>21564:                                {error, Reason} = ERROR -&gt;
<a name="21565"/>21565:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21566"/>21566:                                                &quot;   ~p&quot;, [Reason]),
<a name="21567"/>21567:                                    ERROR
<a name="21568"/>21568:                            end
<a name="21569"/>21569:                    end},
<a name="21570"/>21570:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS2Str ++ &quot;)&quot;,
<a name="21571"/>21571:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21572"/>21572:                            case Get(Sock) of
<a name="21573"/>21573:                                {ok, TOS2 = Value} -&gt;
<a name="21574"/>21574:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21575"/>21575:                                    ok;
<a name="21576"/>21576:                                {ok, Unexpected} -&gt;
<a name="21577"/>21577:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21578"/>21578:                                                [Unexpected]),
<a name="21579"/>21579:                                    {error, {unexpected, Unexpected}};
<a name="21580"/>21580:                                {error, Reason} = ERROR -&gt;
<a name="21581"/>21581:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21582"/>21582:                                                &quot;   ~p&quot;, [Reason]),
<a name="21583"/>21583:                                    ERROR
<a name="21584"/>21584:                            end
<a name="21585"/>21585:                    end},
<a name="21586"/>21586: 
<a name="21587"/>21587:          #{desc =&gt; &quot;set tos &quot; ++ TOS3Str,
<a name="21588"/>21588:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21589"/>21589:                            case Set(Sock, TOS3) of
<a name="21590"/>21590:                                ok -&gt;
<a name="21591"/>21591:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS3]),
<a name="21592"/>21592:                                    ok;
<a name="21593"/>21593:                                {error, Reason} = ERROR -&gt;
<a name="21594"/>21594:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21595"/>21595:                                                &quot;   ~p&quot;, [Reason]),
<a name="21596"/>21596:                                    ERROR
<a name="21597"/>21597:                            end
<a name="21598"/>21598:                    end},
<a name="21599"/>21599:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS3Str ++ &quot;)&quot;,
<a name="21600"/>21600:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21601"/>21601:                            case Get(Sock) of
<a name="21602"/>21602:                                {ok, TOS3 = Value} -&gt;
<a name="21603"/>21603:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21604"/>21604:                                    ok;
<a name="21605"/>21605:                                {ok, Unexpected} -&gt;
<a name="21606"/>21606:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21607"/>21607:                                                [Unexpected]),
<a name="21608"/>21608:                                    {error, {unexpected, Unexpected}};
<a name="21609"/>21609:                                {error, Reason} = ERROR -&gt;
<a name="21610"/>21610:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21611"/>21611:                                                &quot;   ~p&quot;, [Reason]),
<a name="21612"/>21612:                                    ERROR
<a name="21613"/>21613:                            end
<a name="21614"/>21614:                    end},
<a name="21615"/>21615: 
<a name="21616"/>21616:          #{desc =&gt; &quot;set tos &quot; ++ TOS4Str,
<a name="21617"/>21617:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21618"/>21618:                            case Set(Sock, TOS4) of
<a name="21619"/>21619:                                ok -&gt;
<a name="21620"/>21620:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS4]),
<a name="21621"/>21621:                                    ok;
<a name="21622"/>21622:                                {error, Reason} = ERROR -&gt;
<a name="21623"/>21623:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21624"/>21624:                                                &quot;   ~p&quot;, [Reason]),
<a name="21625"/>21625:                                    ERROR
<a name="21626"/>21626:                            end
<a name="21627"/>21627:                    end},
<a name="21628"/>21628:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS4Str ++ &quot;)&quot;,
<a name="21629"/>21629:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21630"/>21630:                            case Get(Sock) of
<a name="21631"/>21631:                                {ok, TOS4 = Value} -&gt;
<a name="21632"/>21632:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21633"/>21633:                                    ok;
<a name="21634"/>21634:                                {ok, Unexpected} -&gt;
<a name="21635"/>21635:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21636"/>21636:                                                [Unexpected]),
<a name="21637"/>21637:                                    {error, {unexpected, Unexpected}};
<a name="21638"/>21638:                                {error, Reason} = ERROR -&gt;
<a name="21639"/>21639:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21640"/>21640:                                                &quot;   ~p&quot;, [Reason]),
<a name="21641"/>21641:                                    ERROR
<a name="21642"/>21642:                            end
<a name="21643"/>21643:                    end},
<a name="21644"/>21644: 
<a name="21645"/>21645:          #{desc =&gt; &quot;set tos &quot; ++ TOS5Str,
<a name="21646"/>21646:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21647"/>21647:                            case Set(Sock, TOS5) of
<a name="21648"/>21648:                                ok -&gt;
<a name="21649"/>21649:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS5]),
<a name="21650"/>21650:                                    ok;
<a name="21651"/>21651:                                {error, Reason} = ERROR -&gt;
<a name="21652"/>21652:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21653"/>21653:                                                &quot;   ~p&quot;, [Reason]),
<a name="21654"/>21654:                                    ERROR
<a name="21655"/>21655:                            end
<a name="21656"/>21656:                    end},
<a name="21657"/>21657:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS5Str ++ &quot;)&quot;,
<a name="21658"/>21658:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21659"/>21659:                            case Get(Sock) of
<a name="21660"/>21660:                                {ok, TOS5 = Value} -&gt;
<a name="21661"/>21661:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21662"/>21662:                                    ok;
<a name="21663"/>21663:                                {ok, Unexpected} -&gt;
<a name="21664"/>21664:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21665"/>21665:                                                [Unexpected]),
<a name="21666"/>21666:                                    {error, {unexpected, Unexpected}};
<a name="21667"/>21667:                                {error, Reason} = ERROR -&gt;
<a name="21668"/>21668:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21669"/>21669:                                                &quot;   ~p&quot;, [Reason]),
<a name="21670"/>21670:                                    ERROR
<a name="21671"/>21671:                            end
<a name="21672"/>21672:                    end},
<a name="21673"/>21673: 
<a name="21674"/>21674:          #{desc =&gt; &quot;close socket&quot;,
<a name="21675"/>21675:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="21676"/>21676:                            ok = socket:close(Sock),
<a name="21677"/>21677:                            {ok, maps:remove(sock, State)}
<a name="21678"/>21678:                    end},
<a name="21679"/>21679: 
<a name="21680"/>21680:          %% *** We are done ***
<a name="21681"/>21681:          ?SEV_FINISH_NORMAL
<a name="21682"/>21682:         ],
<a name="21683"/>21683:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_tos_udp-last_expr"/><a name="21684"/>21684: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="21685"/>21685: 
<a name="21686"/>21686: 
<a name="21687"/>21687: 
<a name="21688"/>21688: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21689"/>21689: 
<a name="21690"/>21690: <i>%% Tests the ip socket option 'recverr' can be set and that the error</i>
<a name="21691"/>21691: <i>%% queue can be read.</i>
<a name="21692"/>21692: <i>%% </i>
<a name="21693"/>21693: 
<a name="api_opt_ip_recverr_udp4-1"/><a name="21694"/>21694: <b>api_opt_ip_recverr_udp4</b>(Config) when is_list(Config) -&gt;
<a name="21695"/>21695:     ?TT(?SECS(5)),
<a name="api_opt_ip_recverr_udp4-last_expr"/><a name="21696"/>21696: <b>    tc_try</b>(api_opt_ip_recverr_udp4,
<a name="21697"/>21697:            fun() -&gt;
<a name="21698"/>21698:                    has_support_ipv4(),
<a name="21699"/>21699:                    has_support_ip_recverr()
<a name="21700"/>21700:            end,
<a name="21701"/>21701:            fun() -&gt;
<a name="21702"/>21702:                    Set  = fun(Sock, Key, Value) -&gt;
<a name="21703"/>21703:                                   socket:setopt(Sock, ip, Key, Value)
<a name="21704"/>21704:                           end,
<a name="21705"/>21705:                    Get  = fun(Sock, Key) -&gt;
<a name="21706"/>21706:                                   socket:getopt(Sock, ip, Key)
<a name="21707"/>21707:                           end,
<a name="21708"/>21708:                    Send = fun(Sock, Data, Dest, Tmo) -&gt;
<a name="21709"/>21709:                                   socket:sendto(Sock, Data, Dest, [], Tmo)
<a name="21710"/>21710:                           end,
<a name="21711"/>21711:                    Recv = fun(Sock, Tmo) -&gt;
<a name="21712"/>21712:                                   socket:recvfrom(Sock, 0, [], Tmo)
<a name="21713"/>21713:                           end,
<a name="21714"/>21714:                    InitState = #{domain =&gt; inet,
<a name="21715"/>21715:                                  proto  =&gt; udp,
<a name="21716"/>21716:                                  send   =&gt; Send,
<a name="21717"/>21717:                                  recv   =&gt; Recv,
<a name="21718"/>21718:                                  set    =&gt; Set,
<a name="21719"/>21719:                                  get    =&gt; Get},
<a name="21720"/>21720:                    ok = api_opt_recverr_udp(Config, InitState)
<a name="21721"/>21721:            end).
<a name="21722"/>21722: 
<a name="21723"/>21723: 
<a name="21724"/>21724: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21725"/>21725: 
<a name="21726"/>21726: <i>%% Tests the ipv6 socket option 'recverr' can be set and that the error</i>
<a name="21727"/>21727: <i>%% queue can be read.</i>
<a name="21728"/>21728: <i>%% </i>
<a name="21729"/>21729: 
<a name="api_opt_ipv6_recverr_udp6-1"/><a name="21730"/>21730: <b>api_opt_ipv6_recverr_udp6</b>(Config) when is_list(Config) -&gt;
<a name="21731"/>21731:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_recverr_udp6-last_expr"/><a name="21732"/>21732: <b>    tc_try</b>(api_opt_ipv6_recverr_udp6,
<a name="21733"/>21733:            fun() -&gt;
<a name="21734"/>21734:                    has_support_ipv6(),
<a name="21735"/>21735:                    has_support_ipv6_recverr()
<a name="21736"/>21736:            end,
<a name="21737"/>21737:            fun() -&gt;
<a name="21738"/>21738:                    Set  = fun(Sock, Key, Value) -&gt;
<a name="21739"/>21739:                                   socket:setopt(Sock, ipv6, Key, Value)
<a name="21740"/>21740:                           end,
<a name="21741"/>21741:                    Get  = fun(Sock, Key) -&gt;
<a name="21742"/>21742:                                   socket:getopt(Sock, ipv6, Key)
<a name="21743"/>21743:                           end,
<a name="21744"/>21744:                    Send = fun(Sock, Data, Dest, Tmo) -&gt;
<a name="21745"/>21745:                                   socket:sendto(Sock, Data, Dest, [], Tmo)
<a name="21746"/>21746:                           end,
<a name="21747"/>21747:                    Recv = fun(Sock, Tmo) -&gt;
<a name="21748"/>21748:                                   socket:recvfrom(Sock, 0, [], Tmo)
<a name="21749"/>21749:                           end,
<a name="21750"/>21750:                    InitState = #{domain =&gt; inet6,
<a name="21751"/>21751:                                  proto  =&gt; udp,
<a name="21752"/>21752:                                  send   =&gt; Send,
<a name="21753"/>21753:                                  recv   =&gt; Recv,
<a name="21754"/>21754:                                  set    =&gt; Set,
<a name="21755"/>21755:                                  get    =&gt; Get},
<a name="21756"/>21756:                    ok = api_opt_recverr_udp(Config, InitState)
<a name="21757"/>21757:            end).
<a name="21758"/>21758: 
<a name="21759"/>21759: 
<a name="21760"/>21760: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21761"/>21761: 
<a name="api_opt_recverr_udp-2"/><a name="21762"/>21762: <b>api_opt_recverr_udp</b>(Config, InitState) -&gt;
<a name="21763"/>21763:     Seq = 
<a name="21764"/>21764:         [
<a name="21765"/>21765:          #{desc =&gt; &quot;create socket&quot;,
<a name="21766"/>21766:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="21767"/>21767:                            ?SEV_IPRINT(&quot;test for ip:recvtos&quot;),
<a name="21768"/>21768:                            case socket:open(Domain, dgram, udp) of
<a name="21769"/>21769:                                {ok, Sock} -&gt;
<a name="21770"/>21770:                                    {ok, State#{sock =&gt; Sock}};
<a name="21771"/>21771:                                {error, _} = ERROR -&gt; 
<a name="21772"/>21772:                                    ERROR
<a name="21773"/>21773:                            end
<a name="21774"/>21774:                    end},
<a name="21775"/>21775:          #{desc =&gt; &quot;bind (to loopback)&quot;,
<a name="21776"/>21776:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="21777"/>21777:                            case socket:bind(Sock, loopback) of
<a name="21778"/>21778:                                ok -&gt;
<a name="21779"/>21779:                                    case socket:sockname(Sock) of
<a name="21780"/>21780:                                        {ok, Addr} -&gt;
<a name="21781"/>21781:                                            ?SEV_IPRINT(
<a name="21782"/>21782:                                               &quot;bound to ~p&quot;, [Addr]),
<a name="21783"/>21783:                                            {ok, State#{addr =&gt; Addr}};
<a name="21784"/>21784:                                        {error, _} = ERROR_1 -&gt;
<a name="21785"/>21785:                                            ERROR_1
<a name="21786"/>21786:                                    end;
<a name="21787"/>21787:                                {error, _} = ERROR_2 -&gt;
<a name="21788"/>21788:                                    ERROR_2
<a name="21789"/>21789:                            end
<a name="21790"/>21790:                    end},
<a name="21791"/>21791: 
<a name="21792"/>21792:          #{desc =&gt; &quot;enable recverr&quot;,
<a name="21793"/>21793:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21794"/>21794:                            Set(Sock, recverr, true)
<a name="21795"/>21795:                    end},
<a name="21796"/>21796: 
<a name="21797"/>21797:          #{desc =&gt; &quot;disable mtu_discover&quot;,
<a name="21798"/>21798:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21799"/>21799:                            Set(Sock, mtu_discover, dont)
<a name="21800"/>21800:                    end},
<a name="21801"/>21801: 
<a name="21802"/>21802:          #{desc =&gt; &quot;try (async) read (=&gt; select)&quot;,
<a name="21803"/>21803:            cmd  =&gt; fun(#{sock := Sock,
<a name="21804"/>21804:                          recv := Recv} = State) -&gt;
<a name="21805"/>21805:                            RecvRef = nowait(Config),
<a name="21806"/>21806:                            case Recv(Sock, RecvRef) of
<a name="21807"/>21807:                                {select, SelectInfo} when RecvRef =:= nowait -&gt;
<a name="21808"/>21808:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="21809"/>21809: 					       &quot;~n   ~p&quot;, [SelectInfo]),
<a name="21810"/>21810:                                    {ok, State#{async_tag =&gt; select,
<a name="21811"/>21811:                                                rselect   =&gt; SelectInfo}};
<a name="21812"/>21812:                                {select,
<a name="21813"/>21813:                                 {select_info, _Tag, RecvRef} = SelectInfo}
<a name="21814"/>21814:                                  when is_reference(RecvRef) -&gt;
<a name="21815"/>21815:                                    ?SEV_IPRINT(&quot;expected select ref: &quot;
<a name="21816"/>21816: 					       &quot;~n   ~p&quot;, [SelectInfo]),
<a name="21817"/>21817:                                    {ok, State#{async_tag =&gt; select,
<a name="21818"/>21818:                                                rselect   =&gt; SelectInfo}};
<a name="21819"/>21819: 
<a name="21820"/>21820:                                {completion, CI} when RecvRef =:= nowait -&gt;
<a name="21821"/>21821:                                    ?SEV_IPRINT(&quot;expected completion nowait: &quot;
<a name="21822"/>21822: 					       &quot;~n   ~p&quot;, [CI]),
<a name="21823"/>21823:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="21824"/>21824:                                                rcompletion =&gt; CI}};
<a name="21825"/>21825:                                {completion,
<a name="21826"/>21826:                                 {completion_info, _Tag, RecvRef} = CI}
<a name="21827"/>21827:                                  when is_reference(RecvRef) -&gt;
<a name="21828"/>21828:                                    ?SEV_IPRINT(&quot;expected completion ref: &quot;
<a name="21829"/>21829: 					       &quot;~n   ~p&quot;, [CI]),
<a name="21830"/>21830:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="21831"/>21831:                                                rcompletion =&gt; CI}};
<a name="21832"/>21832: 
<a name="21833"/>21833:                                {ok, _} -&gt;
<a name="21834"/>21834:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="21835"/>21835:                                    {error, unexpected_success};
<a name="21836"/>21836: 
<a name="21837"/>21837:                                {error, Reason} = ERROR -&gt;
<a name="21838"/>21838:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;, [Reason]),
<a name="21839"/>21839:                                    ERROR
<a name="21840"/>21840:                            end
<a name="21841"/>21841:                    end},
<a name="21842"/>21842: 
<a name="21843"/>21843:          #{desc =&gt; &quot;try send to nowhere&quot;,
<a name="21844"/>21844:            cmd  =&gt; fun(#{domain := Domain,
<a name="21845"/>21845:                          sock   := Sock,
<a name="21846"/>21846:                          send   := Send} = State) -&gt;
<a name="21847"/>21847:                            SendRef = nowait(Config),
<a name="21848"/>21848:                            Dest = #{family =&gt; Domain,
<a name="21849"/>21849:                                     addr   =&gt; if
<a name="21850"/>21850:                                                   (Domain =:= inet) -&gt;
<a name="21851"/>21851:                                                       {127,0,0,1};
<a name="21852"/>21852:                                                   (Domain =:= inet6) -&gt;
<a name="21853"/>21853:                                                       {0,0,0,0,0,0,0,1}
<a name="21854"/>21854:                                               end,
<a name="21855"/>21855:                                     port   =&gt; 44444},
<a name="21856"/>21856:                            case Send(Sock, &lt;&lt;&quot;ping&quot;&gt;&gt;, Dest, SendRef) of
<a name="21857"/>21857:                                ok -&gt;
<a name="21858"/>21858:                                    ?SEV_IPRINT(&quot;sent&quot;),
<a name="21859"/>21859:                                    {ok, State#{sent =&gt; true}};
<a name="21860"/>21860: 
<a name="21861"/>21861:                                {select, SelectInfo}
<a name="21862"/>21862:                                  when SendRef =:= nowait -&gt;
<a name="21863"/>21863:                                    ?SEV_IPRINT(&quot;expected select nowait: ~p&quot;,
<a name="21864"/>21864: 					       [SelectInfo]),
<a name="21865"/>21865:                                    {ok, State#{sent       =&gt; false,
<a name="21866"/>21866:                                                asynch_tag =&gt; select,
<a name="21867"/>21867:                                                sselect    =&gt; SelectInfo}};
<a name="21868"/>21868:                                {select,
<a name="21869"/>21869:                                 {select_info, _Tag, SendRef} = SelectInfo}
<a name="21870"/>21870:                                  when is_reference(SendRef) -&gt;
<a name="21871"/>21871:                                    ?SEV_IPRINT(&quot;expected select ref: ~p&quot;,
<a name="21872"/>21872: 					       [SelectInfo]),
<a name="21873"/>21873:                                    {ok, State#{sent       =&gt; false,
<a name="21874"/>21874:                                                asynch_tag =&gt; select,
<a name="21875"/>21875:                                                sselect    =&gt; SelectInfo}};
<a name="21876"/>21876: 
<a name="21877"/>21877:                                {completion, CI}
<a name="21878"/>21878:                                  when SendRef =:= nowait -&gt;
<a name="21879"/>21879:                                    ?SEV_IPRINT(&quot;expected completion nowait: ~p&quot;,
<a name="21880"/>21880: 					       [CI]),
<a name="21881"/>21881:                                    {ok, State#{sent       =&gt; false,
<a name="21882"/>21882:                                                asynch_tag  =&gt; completion,
<a name="21883"/>21883:                                                scompletion =&gt; CI}};
<a name="21884"/>21884:                                {completion,
<a name="21885"/>21885:                                 {completion_info, _Tag, SendRef} = CI}
<a name="21886"/>21886:                                  when is_reference(SendRef) -&gt;
<a name="21887"/>21887:                                    ?SEV_IPRINT(&quot;expected completion ref: ~p&quot;,
<a name="21888"/>21888: 					       [CI]),
<a name="21889"/>21889:                                    {ok, State#{sent       =&gt; false,
<a name="21890"/>21890:                                                asynch_tag  =&gt; completion,
<a name="21891"/>21891:                                                scompletion =&gt; CI}};
<a name="21892"/>21892: 
<a name="21893"/>21893:                                {error, Reason} = ERROR -&gt;
<a name="21894"/>21894:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="21895"/>21895: 					       [Reason]),
<a name="21896"/>21896:                                    ERROR
<a name="21897"/>21897:                            end
<a name="21898"/>21898:                    end},
<a name="21899"/>21899: 
<a name="21900"/>21900:          #{desc =&gt; &quot;await receive select|completion message&quot;,
<a name="21901"/>21901:            cmd  =&gt; fun(#{sent       := false,
<a name="21902"/>21902:                          asynch_tag := select,
<a name="21903"/>21903:                          sock       := Sock,
<a name="21904"/>21904:                          rselect    := {select_info, _, Ref}} = _State) -&gt;
<a name="21905"/>21905:                            receive
<a name="21906"/>21906:                                {'$socket', Sock, select, Ref} -&gt;
<a name="21907"/>21907:                                    ?SEV_IPRINT(&quot;received expected (read) &quot;
<a name="21908"/>21908:                                                &quot;select message: &quot;
<a name="21909"/>21909:                                                &quot;~n   ~p&quot;, [Ref]),
<a name="21910"/>21910:                                    ok
<a name="21911"/>21911:                            end;
<a name="21912"/>21912:                       (#{sent        := false,
<a name="21913"/>21913:                          asynch_tag  := completion,
<a name="21914"/>21914:                          sock        := Sock,
<a name="21915"/>21915:                          rcompletion := {completion_info, _, Ref}} = _State) -&gt;
<a name="21916"/>21916:                            receive
<a name="21917"/>21917:                                {'$socket', Sock, completion,
<a name="21918"/>21918:                                 {Ref, {error, econnrefused = Reason}}} -&gt;
<a name="21919"/>21919:                                    ?SEV_IPRINT(&quot;expected failure: ~p&quot;,
<a name="21920"/>21920:                                                [Reason]),
<a name="21921"/>21921:                                    ok;
<a name="21922"/>21922: 
<a name="21923"/>21923:                                {'$socket', Sock, completion,
<a name="21924"/>21924:                                 {Ref, {ok, _}}} -&gt;
<a name="21925"/>21925:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="21926"/>21926:                                    {error, unexpected_success};
<a name="21927"/>21927:                                {'$socket', Sock, completion,
<a name="21928"/>21928:                                 {Ref, {error, Reason} = ERROR}} -&gt;
<a name="21929"/>21929:                                    ?SEV_IPRINT(&quot;unexpected failure: ~p&quot;,
<a name="21930"/>21930:                                                [Reason]),
<a name="21931"/>21931:                                    ERROR
<a name="21932"/>21932: 
<a name="21933"/>21933:                            end;
<a name="21934"/>21934:                       (#{sent := true} = _State) -&gt;
<a name="21935"/>21935:                            ?SEV_IPRINT(&quot;no action needed&quot;),
<a name="21936"/>21936:                            ok
<a name="21937"/>21937:                    end},
<a name="21938"/>21938: 
<a name="21939"/>21939:          #{desc =&gt; &quot;try recv - expect econnrefused&quot;,
<a name="21940"/>21940:            cmd  =&gt; fun(#{asynch_tag := completion} = _State) -&gt;
<a name="21941"/>21941:                            ?SEV_IPRINT(&quot;already processed&quot;),
<a name="21942"/>21942:                            ok;
<a name="21943"/>21943:                       (#{sock := Sock,
<a name="21944"/>21944:                          recv := Recv} = _State) -&gt;
<a name="21945"/>21945:                            case Recv(Sock, infinity) of
<a name="21946"/>21946:                                {error, econnrefused = Reason} -&gt;
<a name="21947"/>21947:                                    ?SEV_IPRINT(&quot;expected failure: ~p&quot;,
<a name="21948"/>21948:                                                [Reason]),
<a name="21949"/>21949:                                    ok;
<a name="21950"/>21950:                                {ok, _} -&gt;
<a name="21951"/>21951:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="21952"/>21952:                                    {error, unexpected_success};
<a name="21953"/>21953:                                {select, SelectInfo} -&gt;
<a name="21954"/>21954:                                    ?SEV_EPRINT(&quot;unexpected select: ~p&quot;,
<a name="21955"/>21955:                                                [SelectInfo]),
<a name="21956"/>21956:                                    {error, unexpected_success};
<a name="21957"/>21957:                                {error, Reason} = ERROR -&gt;
<a name="21958"/>21958:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="21959"/>21959:                                                [Reason]),
<a name="21960"/>21960:                                    ERROR
<a name="21961"/>21961:                            end
<a name="21962"/>21962:                    end},
<a name="21963"/>21963: 
<a name="21964"/>21964:          #{desc =&gt; &quot;send to self&quot;,
<a name="21965"/>21965:            cmd  =&gt;
<a name="21966"/>21966:                fun(#{sock := Sock,
<a name="21967"/>21967:                      send := Send,
<a name="21968"/>21968:                      addr := Addr} = _State) -&gt;
<a name="21969"/>21969:                        case Send(Sock, &lt;&lt;&quot;ring&quot;&gt;&gt;, Addr, infinity) of
<a name="21970"/>21970:                            ok -&gt;
<a name="21971"/>21971:                                ?SEV_IPRINT(&quot;sent to self&quot;),
<a name="21972"/>21972:                                ok;
<a name="21973"/>21973:                            {error, _} = Error -&gt;
<a name="21974"/>21974:                                Error
<a name="21975"/>21975:                        end
<a name="21976"/>21976:                end},
<a name="21977"/>21977: 
<a name="21978"/>21978:          #{desc =&gt; &quot;try recv - expect data sent to self&quot;,
<a name="21979"/>21979:            cmd  =&gt; fun(#{sock := Sock,
<a name="21980"/>21980:                          addr := Addr,
<a name="21981"/>21981:                          recv := Recv} = _State) -&gt;
<a name="21982"/>21982:                            case Recv(Sock, infinity) of
<a name="21983"/>21983:                                {ok, {Addr, &lt;&lt;&quot;ring&quot;&gt;&gt;}} -&gt;
<a name="21984"/>21984:                                    ?SEV_IPRINT(&quot;receive expected&quot;),
<a name="21985"/>21985:                                    ok;
<a name="21986"/>21986: 
<a name="21987"/>21987:                                {select, SelectInfo} -&gt;
<a name="21988"/>21988:                                    ?SEV_EPRINT(&quot;unexpected select: ~p&quot;,
<a name="21989"/>21989:                                                [SelectInfo]),
<a name="21990"/>21990:                                    {error, unexpected_success};
<a name="21991"/>21991: 
<a name="21992"/>21992:                                {completion, CompletionInfo} -&gt;
<a name="21993"/>21993:                                    ?SEV_EPRINT(&quot;unexpected completion: ~p&quot;,
<a name="21994"/>21994:                                                [CompletionInfo]),
<a name="21995"/>21995:                                    {error, unexpected_success};
<a name="21996"/>21996: 
<a name="21997"/>21997:                                {error, Reason} = ERROR -&gt;
<a name="21998"/>21998:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="21999"/>21999:                                                [Reason]),
<a name="22000"/>22000:                                    ERROR
<a name="22001"/>22001:                            end
<a name="22002"/>22002:                    end},
<a name="22003"/>22003: 
<a name="22004"/>22004:          #{desc =&gt; &quot;try recv error queue&quot;,
<a name="22005"/>22005:            cmd  =&gt; fun(#{domain := Domain, sock := Sock} = State) -&gt;
<a name="22006"/>22006:                            %% Note that not all platforms that support
<a name="22007"/>22007:                            %% recverr, actually supports &quot;encoding&quot; the data
<a name="22008"/>22008:                            %% part, so we need to adjust for that.
<a name="22009"/>22009: 			   Origin = 
<a name="22010"/>22010: 			       if (Domain =:= inet)  -&gt; icmp;
<a name="22011"/>22011: 				  (Domain =:= inet6) -&gt; icmp6
<a name="22012"/>22012: 			       end,
<a name="22013"/>22013: 			   Level =
<a name="22014"/>22014: 			       if (Domain =:= inet)  -&gt; ip;
<a name="22015"/>22015: 				  (Domain =:= inet6) -&gt; ipv6
<a name="22016"/>22016: 			       end,
<a name="22017"/>22017:                            case socket:recvmsg(Sock, [errqueue], 0) of
<a name="22018"/>22018:                                {ok, #{addr  := #{family := Domain,
<a name="22019"/>22019: 						 addr   := Addr},
<a name="22020"/>22020:                                       flags := [errqueue],
<a name="22021"/>22021:                                       iov   := [&lt;&lt;&quot;ping&quot;&gt;&gt;],
<a name="22022"/>22022:                                       ctrl  := [#{level := Level,
<a name="22023"/>22023:                                                   type  := recverr,
<a name="22024"/>22024:                                                   value :=
<a name="22025"/>22025:                                                       #{code     := port_unreach,
<a name="22026"/>22026:                                                         data     := 0,
<a name="22027"/>22027:                                                         error    := econnrefused,
<a name="22028"/>22028:                                                         info     := 0,
<a name="22029"/>22029:                                                         offender := #{family := Domain,
<a name="22030"/>22030: 								      addr   := Addr},
<a name="22031"/>22031:                                                         origin   := Origin,
<a name="22032"/>22032:                                                         type     := dest_unreach}
<a name="22033"/>22033:                                                  }]} = Msg} -&gt;
<a name="22034"/>22034:                                    ?SEV_IPRINT(&quot;expected error queue (decoded): &quot;
<a name="22035"/>22035:                                                &quot;~n   ~p&quot;, [Msg]),
<a name="22036"/>22036:                                    {ok, State#{asynch_tag =&gt; none}};
<a name="22037"/>22037:                                {ok, #{addr  := #{family := Domain,
<a name="22038"/>22038: 						 addr   := _Addr},
<a name="22039"/>22039:                                       flags := [errqueue],
<a name="22040"/>22040:                                       iov   := [&lt;&lt;&quot;ping&quot;&gt;&gt;],
<a name="22041"/>22041:                                       value := [#{level := Level,
<a name="22042"/>22042:                                                   type  := recverr}]} = _Msg} -&gt;
<a name="22043"/>22043:                                    ?SEV_IPRINT(&quot;expected error queue&quot;),
<a name="22044"/>22044:                                    {ok, State#{asynch_tag =&gt; none}};
<a name="22045"/>22045: 
<a name="22046"/>22046:                                {completion, CI} -&gt;
<a name="22047"/>22047:                                    ?SEV_IPRINT(&quot;completion: &quot;
<a name="22048"/>22048:                                                &quot;~n   ~p&quot;, [CI]),
<a name="22049"/>22049:                                    {ok, State#{asynch_tag =&gt; completion,
<a name="22050"/>22050:                                                completion =&gt; CI}};
<a name="22051"/>22051: 
<a name="22052"/>22052:                                {error, timeout = Reason} = ERROR -&gt;
<a name="22053"/>22053:                                    case os:type() of
<a name="22054"/>22054:                                        {win32, nt} -&gt;
<a name="22055"/>22055:                                            ?SEV_IPRINT(&quot;failed reading &quot;
<a name="22056"/>22056:                                                        &quot;error queue: &quot;
<a name="22057"/>22057:                                                        &quot;~n   ~p&quot;, [Reason]),
<a name="22058"/>22058:                                            {skip,
<a name="22059"/>22059:                                             &quot;Test case does not &quot;
<a name="22060"/>22060:                                             &quot;work on Windows&quot;};
<a name="22061"/>22061:                                        _ -&gt;
<a name="22062"/>22062:                                            ?SEV_EPRINT(&quot;failed reading &quot;
<a name="22063"/>22063:                                                        &quot;error queue: &quot;
<a name="22064"/>22064:                                                        &quot;~n   ~p&quot;, [Reason]),
<a name="22065"/>22065:                                            ERROR
<a name="22066"/>22066:                                    end;
<a name="22067"/>22067: 
<a name="22068"/>22068:                                {error, Reason} = ERROR -&gt;
<a name="22069"/>22069:                                    ?SEV_EPRINT(&quot;failed reading error queue: &quot;
<a name="22070"/>22070:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="22071"/>22071:                                    ERROR
<a name="22072"/>22072:                            end
<a name="22073"/>22073:                    end},
<a name="22074"/>22074: 
<a name="22075"/>22075:          #{desc =&gt; &quot;await receive select message&quot;,
<a name="22076"/>22076:            cmd  =&gt; fun(#{asynch_tag := completion,
<a name="22077"/>22077:                          sock       := Sock,
<a name="22078"/>22078:                          completion := {completion_info, _, Ref}} = _State) -&gt;
<a name="22079"/>22079:                            receive
<a name="22080"/>22080:                                {'$socket', Sock, completion,
<a name="22081"/>22081:                                 {Ref, {ok, Info}}} -&gt;
<a name="22082"/>22082:                                    ?SEV_EPRINT(&quot;expected success: &quot;
<a name="22083"/>22083:                                                &quot;~n   ~p&quot;, [Info]),
<a name="22084"/>22084:                                    ok;
<a name="22085"/>22085: 
<a name="22086"/>22086:                                {'$socket', Sock, completion,
<a name="22087"/>22087:                                 {Ref, {error, Reason} = ERROR}} -&gt;
<a name="22088"/>22088:                                    ?SEV_IPRINT(&quot;unexpected failure: ~p&quot;,
<a name="22089"/>22089:                                                [Reason]),
<a name="22090"/>22090:                                    ERROR
<a name="22091"/>22091: 
<a name="22092"/>22092:                            end;
<a name="22093"/>22093:                       (#{asynch_tag := none} = _State) -&gt;
<a name="22094"/>22094:                            ?SEV_IPRINT(&quot;no action needed&quot;),
<a name="22095"/>22095:                            ok
<a name="22096"/>22096:                    end},
<a name="22097"/>22097: 
<a name="22098"/>22098:          #{desc =&gt; &quot;close socket&quot;,
<a name="22099"/>22099:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="22100"/>22100:                            ok = socket:close(Sock),
<a name="22101"/>22101:                            {ok, maps:remove(sock, State)}
<a name="22102"/>22102:                    end},
<a name="22103"/>22103: 
<a name="22104"/>22104:          %% *** We are done ***
<a name="22105"/>22105:          ?SEV_FINISH_NORMAL
<a name="22106"/>22106:         ],
<a name="22107"/>22107:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_recverr_udp-last_expr"/><a name="22108"/>22108: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22109"/>22109: 
<a name="22110"/>22110: 
<a name="22111"/>22111: 
<a name="22112"/>22112: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22113"/>22113: 
<a name="22114"/>22114: <i>%% This intended to test &quot;all&quot; of the (currently) supported IPv4</i>
<a name="22115"/>22115: <i>%% options that results in control message header(s).</i>
<a name="22116"/>22116: <i>%% So, this is done on the receiving side:</i>
<a name="22117"/>22117: <i>%%</i>
<a name="22118"/>22118: <i>%%      socket:setopt(Sock, ip, Flag, boolean()).</i>
<a name="22119"/>22119: <i>%%</i>
<a name="22120"/>22120: <i>%% For all subsequent *received* messages, a control message header</i>
<a name="22121"/>22121: <i>%% for each of the enabled options will be received with the message.</i>
<a name="22122"/>22122: <i>%%</i>
<a name="22123"/>22123: <i>%% Only allowed for dgram and raw,</i>
<a name="22124"/>22124: <i>%% although we only test this with dgram.</i>
<a name="22125"/>22125: <i>%%</i>
<a name="22126"/>22126: <i>%% Currently we *try* to use the following opts:</i>
<a name="22127"/>22127: <i>%%</i>
<a name="22128"/>22128: <i>%%      pktinfo         =&gt; pktinfo</i>
<a name="22129"/>22129: <i>%%      recvorigdstaddr =&gt; origdstaddr</i>
<a name="22130"/>22130: <i>%%      recvtos         =&gt; tos</i>
<a name="22131"/>22131: <i>%%      recvttl         =&gt; ttl</i>
<a name="22132"/>22132: <i>%%</i>
<a name="22133"/>22133: <i>%%</i>
<a name="22134"/>22134: <i>%% Every time we add a test case for a new option (that results in</i>
<a name="22135"/>22135: <i>%% a control message hedare), we should also add it here.</i>
<a name="22136"/>22136: <i>%%</i>
<a name="22137"/>22137: <i>%% Even though this is a IPv4 test case, we add the 'socket' timestamp</i>
<a name="22138"/>22138: <i>%% option (just to fill up), but in the test to see if we should run</i>
<a name="22139"/>22139: <i>%% the test (since its a IPv4 test case).</i>
<a name="22140"/>22140: <i>%%</i>
<a name="22141"/>22141: 
<a name="api_opt_ip_mopts_udp4-1"/><a name="22142"/>22142: <b>api_opt_ip_mopts_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="22143"/>22143:     ?TT(?SECS(5)),
<a name="api_opt_ip_mopts_udp4-last_expr"/><a name="22144"/>22144: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="22145"/>22145:            fun() -&gt;
<a name="22146"/>22146:                    has_support_ipv4(),
<a name="22147"/>22147:                    Opts =
<a name="22148"/>22148:                        [{ip, pktinfo},
<a name="22149"/>22149:                         {ip, recvorigdstaddr}] ++
<a name="22150"/>22150:                        case os:type() of
<a name="22151"/>22151:                            {win32, nt} -&gt;
<a name="22152"/>22152:                                [];
<a name="22153"/>22153:                            _ -&gt;
<a name="22154"/>22154:                                [{ip, recvtos},
<a name="22155"/>22155:                                 {ip, recvttl}]
<a name="22156"/>22156:                        end,
<a name="22157"/>22157: 		   case is_any_options_supported(Opts) of
<a name="22158"/>22158: 		       true -&gt;
<a name="22159"/>22159: 			   ok;
<a name="22160"/>22160: 		       false -&gt;
<a name="22161"/>22161: 			   skip(&quot;None of the needed options are supported&quot;)
<a name="22162"/>22162: 		   end
<a name="22163"/>22163:            end,
<a name="22164"/>22164:            fun() -&gt;
<a name="22165"/>22165: 		   %% If we get this far, we *know* that at least one of the
<a name="22166"/>22166: 		   %% options are available.
<a name="22167"/>22167: 
<a name="22168"/>22168: 		   %% This is list of all the options and there resulting
<a name="22169"/>22169: 		   %% control message header type(s):
<a name="22170"/>22170: 		   %%   [{level,
<a name="22171"/>22171: 		   %%     'ipv6 socket option',
<a name="22172"/>22172:                    %%     'control message header type',
<a name="22173"/>22173: 		   %%     default | value()}]
<a name="22174"/>22174: 		   Opts =
<a name="22175"/>22175: 		       case socket:is_supported(options, socket, timestamp) of
<a name="22176"/>22176: 			   true -&gt;
<a name="22177"/>22177: 			       [{socket, timestamp, timestamp, default}];
<a name="22178"/>22178: 			   false -&gt;
<a name="22179"/>22179: 			       []
<a name="22180"/>22180: 		       end ++
<a name="22181"/>22181: 		       case socket:is_supported(options, ip, pktinfo) of
<a name="22182"/>22182: 			   true -&gt;
<a name="22183"/>22183: 			       [{ip, pktinfo, pktinfo, default}];
<a name="22184"/>22184: 			   false -&gt;
<a name="22185"/>22185: 			       []
<a name="22186"/>22186: 		       end ++
<a name="22187"/>22187: 		       case socket:is_supported(options, ip, recvorigdstaddr) of
<a name="22188"/>22188: 			   true -&gt;
<a name="22189"/>22189: 			       [{ip, recvorigdstaddr, origdstaddr, default}];
<a name="22190"/>22190: 			   false -&gt;
<a name="22191"/>22191: 			       []
<a name="22192"/>22192: 		       end ++
<a name="22193"/>22193:                        case os:type() of
<a name="22194"/>22194:                            {win32, nt} -&gt;
<a name="22195"/>22195:                                [];
<a name="22196"/>22196:                            _ -&gt;
<a name="22197"/>22197:                                case socket:is_supported(options, ip, recvtos) of
<a name="22198"/>22198:                                    true -&gt;
<a name="22199"/>22199:                                        %% It seems that sending any of the
<a name="22200"/>22200:                                        %% TOS or TTL values will fail on: 
<a name="22201"/>22201:                                        %%    FreeBSD
<a name="22202"/>22202:                                        %%    Linux when
<a name="22203"/>22203:                                        %%      version =&lt; 3.12.60 (at least)
<a name="22204"/>22204:                                        %%      Don't know when this starts
<a name="22205"/>22205:                                        %%      working, but it works on: 
<a name="22206"/>22206:                                        %%         Ubunto 16.04.6 =&gt; 4.15.0-65
<a name="22207"/>22207:                                        %%         SLES 12 SP2 =&gt; 4.4.120-92.70
<a name="22208"/>22208:                                        %% so don't!
<a name="22209"/>22209:                                        %%
<a name="22210"/>22210:                                        %% The latest we know it not to work
<a name="22211"/>22211:                                        %% was a SLES 12 (plain) at 3.12.50-52.54
<a name="22212"/>22212:                                        %%
<a name="22213"/>22213:                                        [{ip, recvtos, tos, 
<a name="22214"/>22214:                                          case os:type() of
<a name="22215"/>22215:                                              {unix, freebsd} -&gt;
<a name="22216"/>22216:                                                  default;
<a name="22217"/>22217:                                              {unix, linux} -&gt;
<a name="22218"/>22218:                                                  case os:version() of
<a name="22219"/>22219:                                                      Vsn when Vsn &gt; {3,12,60} -&gt;
<a name="22220"/>22220:                                                          42;
<a name="22221"/>22221:                                                      _ -&gt;
<a name="22222"/>22222:                                                          default
<a name="22223"/>22223:                                                  end;
<a name="22224"/>22224:                                              _ -&gt; 
<a name="22225"/>22225:                                                  42
<a name="22226"/>22226:                                          end}];
<a name="22227"/>22227:                                    false -&gt;
<a name="22228"/>22228:                                        []
<a name="22229"/>22229:                                end
<a name="22230"/>22230: 		       end ++
<a name="22231"/>22231:                        case os:type() of
<a name="22232"/>22232:                            {unix, darwin} -&gt;
<a name="22233"/>22233:                                [];
<a name="22234"/>22234:                            {win32, nt} -&gt;
<a name="22235"/>22235:                                [];
<a name="22236"/>22236:                            _ -&gt;
<a name="22237"/>22237:                                case socket:is_supported(options, ip, recvttl) of
<a name="22238"/>22238:                                    true -&gt;
<a name="22239"/>22239: 				       %% It seems that sending any of the
<a name="22240"/>22240: 				       %% TOS or TTL values will fail on: 
<a name="22241"/>22241: 				       %%    FreeBSD and NetBSD
<a name="22242"/>22242: 				       %%    Linux when
<a name="22243"/>22243: 				       %%      version =&lt; 3.12.60 (at least)
<a name="22244"/>22244: 				       %% so don't!
<a name="22245"/>22245:                                        %% See recvtos above for more info.
<a name="22246"/>22246:                                        [{ip, recvttl, ttl,
<a name="22247"/>22247:                                          case os:type() of
<a name="22248"/>22248:                                              {unix, BSD} 
<a name="22249"/>22249:                                                when (BSD =:= freebsd) orelse
<a name="22250"/>22250:                                                     (BSD =:= netbsd) -&gt;
<a name="22251"/>22251:                                                  default;
<a name="22252"/>22252:                                              {unix, netbsd} -&gt;
<a name="22253"/>22253:                                                  default;
<a name="22254"/>22254: 					     {unix, linux} -&gt;
<a name="22255"/>22255: 						 case os:version() of
<a name="22256"/>22256: 						     Vsn when Vsn &gt; {3,12,60} -&gt;
<a name="22257"/>22257: 							 42;
<a name="22258"/>22258: 						     _ -&gt;
<a name="22259"/>22259: 							 default
<a name="22260"/>22260: 						 end;
<a name="22261"/>22261:                                              _ -&gt; 
<a name="22262"/>22262:                                                  42
<a name="22263"/>22263:                                          end}];
<a name="22264"/>22264:                                    false -&gt;
<a name="22265"/>22265:                                        []
<a name="22266"/>22266:                                end
<a name="22267"/>22267: 		       end,
<a name="22268"/>22268: 
<a name="22269"/>22269:                    Enable = fun(Sock, Level, Opt) -&gt;
<a name="22270"/>22270: 				    ?SEV_IPRINT(&quot;try enable [~w] ~p&quot;,
<a name="22271"/>22271:                                                 [Level, Opt]),
<a name="22272"/>22272: 				    socket:setopt(Sock, Level, Opt, true)
<a name="22273"/>22273:                             end,
<a name="22274"/>22274:                    Send = fun(Sock, Data, Dest, []) -&gt;
<a name="22275"/>22275:                                   Msg = #{addr =&gt; Dest,
<a name="22276"/>22276:                                           iov  =&gt; [Data]},
<a name="22277"/>22277:                                   socket:sendmsg(Sock, Msg);
<a name="22278"/>22278: 			     (Sock, Data, Dest, Hdrs) when is_list(Hdrs) -&gt;
<a name="22279"/>22279: 				  CMsgs = [#{level =&gt; Level,
<a name="22280"/>22280:                                              type  =&gt; Type,
<a name="22281"/>22281:                                              value =&gt; Val} ||
<a name="22282"/>22282:                                               {Level, Type, Val} &lt;- Hdrs],
<a name="22283"/>22283:                                   Msg   = #{addr =&gt; Dest,
<a name="22284"/>22284:                                             ctrl =&gt; CMsgs,
<a name="22285"/>22285:                                             iov  =&gt; [Data]},
<a name="22286"/>22286:                                   socket:sendmsg(Sock, Msg)
<a name="22287"/>22287:                           end,
<a name="22288"/>22288:                    Recv = fun(Sock) -&gt;
<a name="22289"/>22289:                                   case socket:recvmsg(Sock) of
<a name="22290"/>22290:                                       {ok, #{addr := Source,
<a name="22291"/>22291:                                              ctrl := CMsgs,
<a name="22292"/>22292:                                              iov  := [Data]}} -&gt;
<a name="22293"/>22293:                                           {ok, {Source, CMsgs, Data}};
<a name="22294"/>22294:                                       {error, _} = ERROR -&gt;
<a name="22295"/>22295:                                           ERROR
<a name="22296"/>22296:                                   end
<a name="22297"/>22297:                           end,
<a name="22298"/>22298:                    InitState = #{domain =&gt; inet,
<a name="22299"/>22299:                                  proto  =&gt; udp,
<a name="22300"/>22300: 				 opts   =&gt; Opts,
<a name="22301"/>22301:                                  send   =&gt; Send,
<a name="22302"/>22302:                                  recv   =&gt; Recv,
<a name="22303"/>22303:                                  enable =&gt; Enable},
<a name="22304"/>22304:                    ok = api_opt_ip_mopts_udp(InitState)
<a name="22305"/>22305:            end).
<a name="22306"/>22306: 
<a name="22307"/>22307: 
<a name="22308"/>22308: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22309"/>22309: 
<a name="api_opt_ip_mopts_udp-1"/><a name="22310"/>22310: <b>api_opt_ip_mopts_udp</b>(InitState) -&gt;
<a name="22311"/>22311:     Seq = 
<a name="22312"/>22312:         [
<a name="22313"/>22313:          #{desc =&gt; &quot;local address&quot;,
<a name="22314"/>22314:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="22315"/>22315:                            LSA = which_local_socket_addr(Domain),
<a name="22316"/>22316:                            {ok, State#{lsa_src =&gt; LSA,
<a name="22317"/>22317:                                        lsa_dst =&gt; LSA}}
<a name="22318"/>22318:                    end},
<a name="22319"/>22319: 
<a name="22320"/>22320:          #{desc =&gt; &quot;open src socket&quot;,
<a name="22321"/>22321:            cmd  =&gt; fun(#{domain := Domain,
<a name="22322"/>22322:                          proto  := Proto} = State) -&gt;
<a name="22323"/>22323:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22324"/>22324:                            {ok, State#{sock_src =&gt; Sock}}
<a name="22325"/>22325:                    end},
<a name="22326"/>22326:          #{desc =&gt; &quot;bind src&quot;,
<a name="22327"/>22327:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="22328"/>22328:                            case sock_bind(Sock, LSA) of
<a name="22329"/>22329:                                ok -&gt;
<a name="22330"/>22330:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22331"/>22331:                                    ok;
<a name="22332"/>22332:                                {error, Reason} = ERROR -&gt;
<a name="22333"/>22333:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22334"/>22334:                                    ERROR
<a name="22335"/>22335:                            end
<a name="22336"/>22336:                    end},
<a name="22337"/>22337:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="22338"/>22338:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22339"/>22339:                            SASrc = sock_sockname(Sock),
<a name="22340"/>22340:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="22341"/>22341:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="22342"/>22342:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="22343"/>22343:                    end},
<a name="22344"/>22344: 
<a name="22345"/>22345:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="22346"/>22346:            cmd  =&gt; fun(#{domain := Domain,
<a name="22347"/>22347:                          proto  := Proto} = State) -&gt;
<a name="22348"/>22348:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22349"/>22349:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="22350"/>22350:                    end},
<a name="22351"/>22351:          #{desc =&gt; &quot;bind dst&quot;,
<a name="22352"/>22352:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="22353"/>22353:                            case sock_bind(Sock, LSA) of
<a name="22354"/>22354:                                ok -&gt;
<a name="22355"/>22355:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22356"/>22356:                                    ok;
<a name="22357"/>22357:                                {error, Reason} = ERROR -&gt;
<a name="22358"/>22358:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22359"/>22359:                                    ERROR
<a name="22360"/>22360:                            end
<a name="22361"/>22361:                    end},
<a name="22362"/>22362:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="22363"/>22363:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22364"/>22364:                            SADst = sock_sockname(Sock),
<a name="22365"/>22365:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="22366"/>22366:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="22367"/>22367:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="22368"/>22368:                    end},
<a name="22369"/>22369: 
<a name="22370"/>22370:          #{desc =&gt; &quot;enable options on dst socket&quot;,
<a name="22371"/>22371:            cmd  =&gt; fun(#{sock_dst := DSock,
<a name="22372"/>22372: 			 sock_src := SSock,
<a name="22373"/>22373: 			 opts     := Opts,
<a name="22374"/>22374: 			 enable   := Enable} = _State) -&gt;
<a name="22375"/>22375: 			   %% If we fail to enable *any* of the options,
<a name="22376"/>22376: 			   %% we give up.
<a name="22377"/>22377: 			   E = fun({Level, Opt, _, _}) -&gt; 
<a name="22378"/>22378:                                        case Enable(DSock, Level, Opt) of
<a name="22379"/>22379:                                            ok -&gt;
<a name="22380"/>22380:                                                ?SEV_IPRINT(&quot;dst [~w] ~w enabled&quot;,
<a name="22381"/>22381:                                                            [Level, Opt]),
<a name="22382"/>22382:                                                ok;
<a name="22383"/>22383:                                            {error, enoprotoopt = Reason} -&gt;
<a name="22384"/>22384:                                                ?SEV_EPRINT(&quot;Expected &quot;
<a name="22385"/>22385:                                                            &quot;Failure: &quot;
<a name="22386"/>22386:                                                            &quot;~p =&gt; SKIP&quot;,
<a name="22387"/>22387:                                                            [Reason]),
<a name="22388"/>22388:                                                (catch socket:close(DSock)),
<a name="22389"/>22389:                                                (catch socket:close(SSock)),
<a name="22390"/>22390:                                                {skip, Reason};
<a name="22391"/>22391:                                            {error, Reason} = ERROR -&gt;
<a name="22392"/>22392:                                                ?SEV_EPRINT(&quot;Failed &quot;
<a name="22393"/>22393:                                                            &quot;setting ~w:&quot;
<a name="22394"/>22394:                                                            &quot;   ~p&quot;,
<a name="22395"/>22395:                                                            [Opt, Reason]),
<a name="22396"/>22396:                                                throw(ERROR)
<a name="22397"/>22397:                                        end
<a name="22398"/>22398: 			       end,
<a name="22399"/>22399: 			   lists:foreach(E, Opts),
<a name="22400"/>22400: 			   ok
<a name="22401"/>22401:                    end},
<a name="22402"/>22402: 
<a name="22403"/>22403:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="22404"/>22404:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="22405"/>22405: 			 sa_dst   := Dst,
<a name="22406"/>22406: 			 opts     := Opts,
<a name="22407"/>22407: 			 send     := Send}) -&gt;
<a name="22408"/>22408: 			   Hdrs = [{Level, Type, Data} ||
<a name="22409"/>22409: 				      {Level, _, Type, Data} &lt;- 
<a name="22410"/>22410: 					  Opts, (Data =/= default)],
<a name="22411"/>22411:                            Send(Sock, ?BASIC_REQ, Dst, Hdrs)
<a name="22412"/>22412:                    end},
<a name="22413"/>22413:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22414"/>22414:            cmd  =&gt; fun(#{sock_dst := Sock,
<a name="22415"/>22415: 			 sa_src   := Src,
<a name="22416"/>22416: 			 recv     := Recv,
<a name="22417"/>22417: 			 opts     := Opts}) -&gt;
<a name="22418"/>22418:                            case Recv(Sock) of
<a name="22419"/>22419:                                {ok, {Src, CMsgs, ?BASIC_REQ}}
<a name="22420"/>22420:                                  when length(CMsgs) =:= length(Opts)  -&gt;
<a name="22421"/>22421:                                    ?SEV_IPRINT(&quot;Got (expected) cmsg headers: &quot;
<a name="22422"/>22422: 					       &quot;~n   ~p&quot;, [CMsgs]),
<a name="22423"/>22423: 				   %% We should really verify the headers:
<a name="22424"/>22424: 				   %% values, types and so on...
<a name="22425"/>22425:                                    ok;
<a name="22426"/>22426:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22427"/>22427:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22428"/>22428:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22429"/>22429:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22430"/>22430:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22431"/>22431:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22432"/>22432:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22433"/>22433:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22434"/>22434:                                                [Src, BadSrc,
<a name="22435"/>22435:                                                 [{Level, Type} ||
<a name="22436"/>22436:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="22437"/>22437: 						BadCHdrs,
<a name="22438"/>22438: 						?BASIC_REQ, BadReq]),
<a name="22439"/>22439:                                    {error, {unexpected_data, UnexpData}};
<a name="22440"/>22440:                                {ok, UnexpData} -&gt;
<a name="22441"/>22441:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22442"/>22442:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22443"/>22443:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22444"/>22444:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22445"/>22445:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22446"/>22446:                                                [Src,
<a name="22447"/>22447:                                                 [{Level, Type} ||
<a name="22448"/>22448:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="22449"/>22449: 						?BASIC_REQ,
<a name="22450"/>22450:                                                 UnexpData]),
<a name="22451"/>22451:                                    {error, {unexpected_data, UnexpData}};
<a name="22452"/>22452:                                {error, _} = ERROR -&gt;
<a name="22453"/>22453:                                    %% At the moment there is no way to get
<a name="22454"/>22454:                                    %% status or state for the socket...
<a name="22455"/>22455:                                    ERROR
<a name="22456"/>22456:                            end
<a name="22457"/>22457:                    end},
<a name="22458"/>22458: 
<a name="22459"/>22459:          #{desc =&gt; &quot;close src socket&quot;,
<a name="22460"/>22460:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22461"/>22461:                            ok = socket:close(Sock),
<a name="22462"/>22462:                            {ok, maps:remove(sock_src, State)}
<a name="22463"/>22463:                    end},
<a name="22464"/>22464:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="22465"/>22465:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22466"/>22466:                            ok = socket:close(Sock),
<a name="22467"/>22467:                            {ok, maps:remove(sock_dst, State)}
<a name="22468"/>22468:                    end},
<a name="22469"/>22469: 
<a name="22470"/>22470:          %% *** We are done ***
<a name="22471"/>22471:          ?SEV_FINISH_NORMAL
<a name="22472"/>22472:         ],
<a name="22473"/>22473:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_mopts_udp-last_expr"/><a name="22474"/>22474: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22475"/>22475: 
<a name="22476"/>22476: 
<a name="22477"/>22477: 
<a name="22478"/>22478: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22479"/>22479: 
<a name="22480"/>22480: <i>%% Tests that the IPv6 pktinfo control message header is received on</i>
<a name="22481"/>22481: <i>%% incoming datagrams (UDP and RAW) when setting the socket 'ipv6'</i>
<a name="22482"/>22482: <i>%% option recvpktinfo is set to true when using.</i>
<a name="22483"/>22483: <i>%% So, this is done on the receiving side: </i>
<a name="22484"/>22484: <i>%%</i>
<a name="22485"/>22485: <i>%%               socket:setopt(Sock, ipv6, recvpktinfo, boolean()).</i>
<a name="22486"/>22486: <i>%%</i>
<a name="22487"/>22487: <i>%% For all subsequent *received* messages, the pktinfo control message</i>
<a name="22488"/>22488: <i>%% header will be with the message.</i>
<a name="22489"/>22489: <i>%%</i>
<a name="22490"/>22490: <i>%% Only allowed for dgram and raw,</i>
<a name="22491"/>22491: <i>%% although we only test this with dgram.</i>
<a name="22492"/>22492: <i>%%</i>
<a name="22493"/>22493: 
<a name="api_opt_ipv6_recvpktinfo_udp6-1"/><a name="22494"/>22494: <b>api_opt_ipv6_recvpktinfo_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="22495"/>22495:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_recvpktinfo_udp6-last_expr"/><a name="22496"/>22496: <b>    tc_try</b>(api_opt_ipv6_recvpktinfo_udp6,
<a name="22497"/>22497:            fun() -&gt;
<a name="22498"/>22498:                    has_support_ipv6(),
<a name="22499"/>22499:                    has_support_ipv6_recvpktinfo()
<a name="22500"/>22500:            end,
<a name="22501"/>22501:            fun() -&gt;
<a name="22502"/>22502:                    Set  = fun(Sock, Value) -&gt;
<a name="22503"/>22503:                                   socket:setopt(Sock, ipv6, recvpktinfo, Value)
<a name="22504"/>22504:                           end,
<a name="22505"/>22505:                    Get  = fun(Sock) -&gt;
<a name="22506"/>22506:                                   socket:getopt(Sock, ipv6, recvpktinfo)
<a name="22507"/>22507:                           end,
<a name="22508"/>22508:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="22509"/>22509:                                   Msg = #{addr =&gt; Dest,
<a name="22510"/>22510:                                              iov  =&gt; [Data]},
<a name="22511"/>22511:                                   socket:sendmsg(Sock, Msg);
<a name="22512"/>22512:                              (Sock, Data, Dest, Info) -&gt;
<a name="22513"/>22513:                                   %% We do not support this at the moment!!!
<a name="22514"/>22514:                                   CMsg = #{level =&gt; ipv6,
<a name="22515"/>22515:                                               type  =&gt; pktinfo,
<a name="22516"/>22516:                                               data  =&gt; Info},
<a name="22517"/>22517:                                   Msg  = #{addr =&gt; Dest,
<a name="22518"/>22518:                                               ctrl =&gt; [CMsg],
<a name="22519"/>22519:                                               iov  =&gt; [Data]},
<a name="22520"/>22520:                                   socket:sendmsg(Sock, Msg)
<a name="22521"/>22521:                           end,
<a name="22522"/>22522:                    Recv = fun(Sock) -&gt;
<a name="22523"/>22523:                                   case socket:recvmsg(Sock) of
<a name="22524"/>22524:                                       {ok, #{addr := Source,
<a name="22525"/>22525:                                              ctrl := CMsgs,
<a name="22526"/>22526:                                              iov  := [Data]}} -&gt;
<a name="22527"/>22527:                                           {ok, {Source, CMsgs, Data}};
<a name="22528"/>22528:                                       {error, _} = ERROR -&gt;
<a name="22529"/>22529:                                           ERROR
<a name="22530"/>22530:                                   end
<a name="22531"/>22531:                           end,
<a name="22532"/>22532:                    InitState = #{domain =&gt; inet6,
<a name="22533"/>22533:                                  proto  =&gt; udp,
<a name="22534"/>22534:                                  send   =&gt; Send,
<a name="22535"/>22535:                                  recv   =&gt; Recv,
<a name="22536"/>22536:                                  set    =&gt; Set,
<a name="22537"/>22537:                                  get    =&gt; Get},
<a name="22538"/>22538:                    ok = api_opt_ipv6_recvpktinfo_udp(InitState)
<a name="22539"/>22539:            end).
<a name="22540"/>22540: 
<a name="22541"/>22541: 
<a name="22542"/>22542: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22543"/>22543: 
<a name="api_opt_ipv6_recvpktinfo_udp-1"/><a name="22544"/>22544: <b>api_opt_ipv6_recvpktinfo_udp</b>(InitState) -&gt;
<a name="22545"/>22545:     Seq = 
<a name="22546"/>22546:         [
<a name="22547"/>22547:          #{desc =&gt; &quot;local address&quot;,
<a name="22548"/>22548:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="22549"/>22549:                            LSA = which_local_socket_addr(Domain),
<a name="22550"/>22550:                            {ok, State#{lsa_src =&gt; LSA,
<a name="22551"/>22551:                                        lsa_dst =&gt; LSA}}
<a name="22552"/>22552:                    end},
<a name="22553"/>22553: 
<a name="22554"/>22554:          #{desc =&gt; &quot;open src socket&quot;,
<a name="22555"/>22555:            cmd  =&gt; fun(#{domain := Domain,
<a name="22556"/>22556:                          proto  := Proto} = State) -&gt;
<a name="22557"/>22557:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22558"/>22558:                            {ok, State#{sock_src =&gt; Sock}}
<a name="22559"/>22559:                    end},
<a name="22560"/>22560:          #{desc =&gt; &quot;bind src&quot;,
<a name="22561"/>22561:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="22562"/>22562:                            case sock_bind(Sock, LSA) of
<a name="22563"/>22563:                                ok -&gt;
<a name="22564"/>22564:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22565"/>22565:                                    ok;
<a name="22566"/>22566:                                {error, Reason} = ERROR -&gt;
<a name="22567"/>22567:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22568"/>22568:                                    ERROR
<a name="22569"/>22569:                            end
<a name="22570"/>22570:                    end},
<a name="22571"/>22571:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="22572"/>22572:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22573"/>22573:                            SASrc = sock_sockname(Sock),
<a name="22574"/>22574:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="22575"/>22575:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="22576"/>22576:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="22577"/>22577:                    end},
<a name="22578"/>22578: 
<a name="22579"/>22579:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="22580"/>22580:            cmd  =&gt; fun(#{domain := Domain,
<a name="22581"/>22581:                          proto  := Proto} = State) -&gt;
<a name="22582"/>22582:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22583"/>22583:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="22584"/>22584:                    end},
<a name="22585"/>22585:          #{desc =&gt; &quot;bind dst&quot;,
<a name="22586"/>22586:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="22587"/>22587:                            case sock_bind(Sock, LSA) of
<a name="22588"/>22588:                                ok -&gt;
<a name="22589"/>22589:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22590"/>22590:                                    ok;
<a name="22591"/>22591:                                {error, Reason} = ERROR -&gt;
<a name="22592"/>22592:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22593"/>22593:                                    ERROR
<a name="22594"/>22594:                            end
<a name="22595"/>22595:                    end},
<a name="22596"/>22596:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="22597"/>22597:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22598"/>22598:                            SADst = sock_sockname(Sock),
<a name="22599"/>22599:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="22600"/>22600:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="22601"/>22601:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="22602"/>22602:                    end},
<a name="22603"/>22603:          #{desc =&gt; &quot;default pktinfo for dst socket&quot;,
<a name="22604"/>22604:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="22605"/>22605:                            case Get(Sock) of
<a name="22606"/>22606:                                {ok, false = Value} -&gt;
<a name="22607"/>22607:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="22608"/>22608:                                    ok;
<a name="22609"/>22609:                                {ok, Unexpected} -&gt;
<a name="22610"/>22610:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="22611"/>22611:                                                [Unexpected]),
<a name="22612"/>22612:                                    {error, {unexpected, Unexpected}};
<a name="22613"/>22613:                                {error, Reason} = ERROR -&gt;
<a name="22614"/>22614:                                    ?SEV_EPRINT(&quot;Failed getting (default) recvtos:&quot;
<a name="22615"/>22615:                                                &quot;   ~p&quot;, [Reason]),
<a name="22616"/>22616:                                    ERROR
<a name="22617"/>22617:                            end
<a name="22618"/>22618:                    end},
<a name="22619"/>22619: 
<a name="22620"/>22620:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) pktinfo)&quot;,
<a name="22621"/>22621:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22622"/>22622:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="22623"/>22623:                    end},
<a name="22624"/>22624:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22625"/>22625:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22626"/>22626:                            case Recv(Sock) of
<a name="22627"/>22627:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="22628"/>22628:                                    ok;
<a name="22629"/>22629:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22630"/>22630:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22631"/>22631:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22632"/>22632:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22633"/>22633:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22634"/>22634:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22635"/>22635:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22636"/>22636:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22637"/>22637:                                                [Src, BadSrc,
<a name="22638"/>22638:                                                 [], BadCHdrs,
<a name="22639"/>22639:                                                 ?BASIC_REQ, BadReq]),
<a name="22640"/>22640:                                    {error, {unexpected_data, UnexpData}};
<a name="22641"/>22641:                                {ok, UnexpData} -&gt;
<a name="22642"/>22642:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22643"/>22643:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22644"/>22644:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22645"/>22645:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22646"/>22646:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22647"/>22647:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22648"/>22648:                                    {error, {unexpected_data, UnexpData}};
<a name="22649"/>22649:                                {error, _} = ERROR -&gt;
<a name="22650"/>22650:                                    %% At the moment there is no way to get
<a name="22651"/>22651:                                    %% status or state for the socket...
<a name="22652"/>22652:                                    ERROR
<a name="22653"/>22653:                            end
<a name="22654"/>22654:                    end},
<a name="22655"/>22655: 
<a name="22656"/>22656:          #{desc =&gt; &quot;enable pktinfo on dst socket&quot;,
<a name="22657"/>22657:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="22658"/>22658:                            case Set(Sock, true) of
<a name="22659"/>22659:                                ok -&gt;
<a name="22660"/>22660:                                    ?SEV_IPRINT(&quot;dst pktinfo enabled&quot;),
<a name="22661"/>22661:                                    ok;
<a name="22662"/>22662:                                {error, Reason} = ERROR -&gt;
<a name="22663"/>22663:                                    ?SEV_EPRINT(&quot;Failed setting pktinfo:&quot;
<a name="22664"/>22664:                                                &quot;   ~p&quot;, [Reason]),
<a name="22665"/>22665:                                    ERROR
<a name="22666"/>22666:                            end
<a name="22667"/>22667:                    end},
<a name="22668"/>22668: 
<a name="22669"/>22669:          #{desc =&gt; &quot;send req (to dst) (wo explicit pktinfo)&quot;,
<a name="22670"/>22670:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22671"/>22671:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="22672"/>22672:                    end},
<a name="22673"/>22673:          #{desc =&gt; &quot;recv req (from src) - w default pktinfo&quot;,
<a name="22674"/>22674:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22675"/>22675:                            case Recv(Sock) of
<a name="22676"/>22676:                                {ok, {Src, [#{level := ipv6,
<a name="22677"/>22677:                                              type  := pktinfo,
<a name="22678"/>22678:                                              value := #{addr    := Addr,
<a name="22679"/>22679:                                                         ifindex := IfIdx}}],
<a name="22680"/>22680:                                      ?BASIC_REQ}} -&gt;
<a name="22681"/>22681:                                    ?SEV_IPRINT(&quot;Got (default) Pkt Info: &quot;
<a name="22682"/>22682:                                                &quot;~n   Addr:      ~p&quot;
<a name="22683"/>22683:                                                &quot;~n   If Index:  ~p&quot;,
<a name="22684"/>22684:                                                [Addr, IfIdx]),
<a name="22685"/>22685:                                    ok;
<a name="22686"/>22686:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22687"/>22687:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22688"/>22688:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22689"/>22689:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22690"/>22690:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22691"/>22691:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22692"/>22692:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22693"/>22693:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22694"/>22694:                                                [Src, BadSrc,
<a name="22695"/>22695:                                                 #{level =&gt; ipv6,
<a name="22696"/>22696:                                                   type  =&gt; pktinfo,
<a name="22697"/>22697:                                                   value =&gt; &quot;something&quot;} , BadCHdrs,
<a name="22698"/>22698:                                                 ?BASIC_REQ, BadReq]),
<a name="22699"/>22699:                                    {error, {unexpected_data, UnexpData}};
<a name="22700"/>22700:                                {ok, UnexpData} -&gt;
<a name="22701"/>22701:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22702"/>22702:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22703"/>22703:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22704"/>22704:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22705"/>22705:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22706"/>22706:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22707"/>22707:                                    {error, {unexpected_data, UnexpData}};
<a name="22708"/>22708:                                {error, _} = ERROR -&gt;
<a name="22709"/>22709:                                    %% At the moment there is no way to get
<a name="22710"/>22710:                                    %% status or state for the socket...
<a name="22711"/>22711:                                    ERROR
<a name="22712"/>22712:                            end
<a name="22713"/>22713:                    end},
<a name="22714"/>22714: 
<a name="22715"/>22715: 
<a name="22716"/>22716:          #{desc =&gt; &quot;close src socket&quot;,
<a name="22717"/>22717:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22718"/>22718:                            ok = socket:close(Sock),
<a name="22719"/>22719:                            {ok, maps:remove(sock_src, State)}
<a name="22720"/>22720:                    end},
<a name="22721"/>22721:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="22722"/>22722:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22723"/>22723:                            ok = socket:close(Sock),
<a name="22724"/>22724:                            {ok, maps:remove(sock_dst, State)}
<a name="22725"/>22725:                    end},
<a name="22726"/>22726: 
<a name="22727"/>22727:          %% *** We are done ***
<a name="22728"/>22728:          ?SEV_FINISH_NORMAL
<a name="22729"/>22729:         ],
<a name="22730"/>22730:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_recvpktinfo_udp-last_expr"/><a name="22731"/>22731: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22732"/>22732: 
<a name="22733"/>22733: 
<a name="22734"/>22734: 
<a name="22735"/>22735: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22736"/>22736: 
<a name="22737"/>22737: <i>%% Tests that the 'flow info' control message header is received when</i>
<a name="22738"/>22738: <i>%% setting the socket 'ipv6' option flowinfo  is set to true when using</i>
<a name="22739"/>22739: <i>%% sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="22740"/>22740: <i>%% So, this is done on the receiving side: </i>
<a name="22741"/>22741: <i>%%</i>
<a name="22742"/>22742: <i>%%               socket:setopt(Sock, ipv6, flowinfo, boolean()).</i>
<a name="22743"/>22743: <i>%%</i>
<a name="22744"/>22744: <i>%% For all subsequent *received* messages, the 'flow info' control message</i>
<a name="22745"/>22745: <i>%% header will be with the message.</i>
<a name="22746"/>22746: <i>%%</i>
<a name="22747"/>22747: <i>%% Only allowed for dgram and raw,</i>
<a name="22748"/>22748: <i>%% although we only test this with dgram.</i>
<a name="22749"/>22749: <i>%%</i>
<a name="22750"/>22750: <i>%% There seem to be some weirdness with the definition of this</i>
<a name="22751"/>22751: <i>%% option, so its defined in an include file we don't include</i>
<a name="22752"/>22752: <i>%% (directly or indirectly). And since some of the defines</i>
<a name="22753"/>22753: <i>%% occur in a file we *do* include (via netinet/in.h), we</i>
<a name="22754"/>22754: <i>%% leave it as is for now...</i>
<a name="22755"/>22755: <i>%%</i>
<a name="22756"/>22756: 
<a name="api_opt_ipv6_flowinfo_udp6-1"/><a name="22757"/>22757: <b>api_opt_ipv6_flowinfo_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="22758"/>22758:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_flowinfo_udp6-last_expr"/><a name="22759"/>22759: <b>    tc_try</b>(api_opt_ipv6_flowinfo_udp6,
<a name="22760"/>22760:            fun() -&gt;
<a name="22761"/>22761:                    has_support_ipv6(),
<a name="22762"/>22762:                    has_support_ipv6_flowinfo()
<a name="22763"/>22763:            end,
<a name="22764"/>22764:            fun() -&gt;
<a name="22765"/>22765:                    Set  = fun(Sock, Value) -&gt;
<a name="22766"/>22766:                                   socket:setopt(Sock, ipv6, flowinfo, Value)
<a name="22767"/>22767:                           end,
<a name="22768"/>22768:                    Get  = fun(Sock) -&gt;
<a name="22769"/>22769:                                   socket:getopt(Sock, ipv6, flowinfo)
<a name="22770"/>22770:                           end,
<a name="22771"/>22771:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="22772"/>22772:                                   Msg = #{addr =&gt; Dest,
<a name="22773"/>22773:                                              iov  =&gt; [Data]},
<a name="22774"/>22774:                                   socket:sendmsg(Sock, Msg)
<a name="22775"/>22775:                           end,
<a name="22776"/>22776:                    Recv = fun(Sock) -&gt;
<a name="22777"/>22777:                                   case socket:recvmsg(Sock) of
<a name="22778"/>22778:                                       {ok, #{addr := Source,
<a name="22779"/>22779:                                              ctrl := CMsgs,
<a name="22780"/>22780:                                              iov  := [Data]}} -&gt;
<a name="22781"/>22781:                                           {ok, {Source, CMsgs, Data}};
<a name="22782"/>22782:                                       {error, _} = ERROR -&gt;
<a name="22783"/>22783:                                           ERROR
<a name="22784"/>22784:                                   end
<a name="22785"/>22785:                           end,
<a name="22786"/>22786:                    InitState = #{domain =&gt; inet6,
<a name="22787"/>22787:                                  proto  =&gt; udp,
<a name="22788"/>22788:                                  send   =&gt; Send,
<a name="22789"/>22789:                                  recv   =&gt; Recv,
<a name="22790"/>22790:                                  set    =&gt; Set,
<a name="22791"/>22791:                                  get    =&gt; Get},
<a name="22792"/>22792:                    ok = api_opt_ipv6_flowinfo_udp(InitState)
<a name="22793"/>22793:            end).
<a name="22794"/>22794: 
<a name="22795"/>22795: 
<a name="22796"/>22796: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22797"/>22797: 
<a name="api_opt_ipv6_flowinfo_udp-1"/><a name="22798"/>22798: <b>api_opt_ipv6_flowinfo_udp</b>(InitState) -&gt;
<a name="22799"/>22799:     Seq = 
<a name="22800"/>22800:         [
<a name="22801"/>22801:          #{desc =&gt; &quot;local address&quot;,
<a name="22802"/>22802:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="22803"/>22803:                            LSA = which_local_socket_addr(Domain),
<a name="22804"/>22804:                            {ok, State#{lsa_src =&gt; LSA,
<a name="22805"/>22805:                                        lsa_dst =&gt; LSA}}
<a name="22806"/>22806:                    end},
<a name="22807"/>22807: 
<a name="22808"/>22808:          #{desc =&gt; &quot;open src socket&quot;,
<a name="22809"/>22809:            cmd  =&gt; fun(#{domain := Domain,
<a name="22810"/>22810:                          proto  := Proto} = State) -&gt;
<a name="22811"/>22811:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22812"/>22812:                            {ok, State#{sock_src =&gt; Sock}}
<a name="22813"/>22813:                    end},
<a name="22814"/>22814:          #{desc =&gt; &quot;bind src&quot;,
<a name="22815"/>22815:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="22816"/>22816:                            case sock_bind(Sock, LSA) of
<a name="22817"/>22817:                                ok -&gt;
<a name="22818"/>22818:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22819"/>22819:                                    ok;
<a name="22820"/>22820:                                {error, Reason} = ERROR -&gt;
<a name="22821"/>22821:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22822"/>22822:                                    ERROR
<a name="22823"/>22823:                            end
<a name="22824"/>22824:                    end},
<a name="22825"/>22825:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="22826"/>22826:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22827"/>22827:                            SASrc = sock_sockname(Sock),
<a name="22828"/>22828:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="22829"/>22829:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="22830"/>22830:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="22831"/>22831:                    end},
<a name="22832"/>22832: 
<a name="22833"/>22833:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="22834"/>22834:            cmd  =&gt; fun(#{domain := Domain,
<a name="22835"/>22835:                          proto  := Proto} = State) -&gt;
<a name="22836"/>22836:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22837"/>22837:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="22838"/>22838:                    end},
<a name="22839"/>22839:          #{desc =&gt; &quot;bind dst&quot;,
<a name="22840"/>22840:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="22841"/>22841:                            case sock_bind(Sock, LSA) of
<a name="22842"/>22842:                                ok -&gt;
<a name="22843"/>22843:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22844"/>22844:                                    ok;
<a name="22845"/>22845:                                {error, Reason} = ERROR -&gt;
<a name="22846"/>22846:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22847"/>22847:                                    ERROR
<a name="22848"/>22848:                            end
<a name="22849"/>22849:                    end},
<a name="22850"/>22850:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="22851"/>22851:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22852"/>22852:                            SADst = sock_sockname(Sock),
<a name="22853"/>22853:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="22854"/>22854:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="22855"/>22855:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="22856"/>22856:                    end},
<a name="22857"/>22857:          #{desc =&gt; &quot;default flowinfo for dst socket&quot;,
<a name="22858"/>22858:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="22859"/>22859:                            case Get(Sock) of
<a name="22860"/>22860:                                {ok, false = Value} -&gt;
<a name="22861"/>22861:                                    ?SEV_IPRINT(&quot;dst flowinfo: ~p&quot;, [Value]),
<a name="22862"/>22862:                                    ok;
<a name="22863"/>22863:                                {ok, Unexpected} -&gt;
<a name="22864"/>22864:                                    ?SEV_EPRINT(&quot;Unexpected src flowinfo: ~p&quot;,
<a name="22865"/>22865:                                                [Unexpected]),
<a name="22866"/>22866:                                    {error, {unexpected, Unexpected}};
<a name="22867"/>22867:                                {error, Reason} = ERROR -&gt;
<a name="22868"/>22868:                                    ?SEV_EPRINT(&quot;Failed getting (default) flowinfo:&quot;
<a name="22869"/>22869:                                                &quot;   ~p&quot;, [Reason]),
<a name="22870"/>22870:                                    ERROR
<a name="22871"/>22871:                            end
<a name="22872"/>22872:                    end},
<a name="22873"/>22873: 
<a name="22874"/>22874:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="22875"/>22875:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22876"/>22876:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="22877"/>22877:                    end},
<a name="22878"/>22878:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22879"/>22879:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22880"/>22880:                            case Recv(Sock) of
<a name="22881"/>22881:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="22882"/>22882:                                    ok;
<a name="22883"/>22883:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22884"/>22884:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22885"/>22885:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22886"/>22886:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22887"/>22887:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22888"/>22888:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22889"/>22889:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22890"/>22890:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22891"/>22891:                                                [Src, BadSrc,
<a name="22892"/>22892:                                                 [], BadCHdrs,
<a name="22893"/>22893:                                                 ?BASIC_REQ, BadReq]),
<a name="22894"/>22894:                                    {error, {unexpected_data, UnexpData}};
<a name="22895"/>22895:                                {ok, UnexpData} -&gt;
<a name="22896"/>22896:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22897"/>22897:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22898"/>22898:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22899"/>22899:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22900"/>22900:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22901"/>22901:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22902"/>22902:                                    {error, {unexpected_data, UnexpData}};
<a name="22903"/>22903:                                {error, _} = ERROR -&gt;
<a name="22904"/>22904:                                    %% At the moment there is no way to get
<a name="22905"/>22905:                                    %% status or state for the socket...
<a name="22906"/>22906:                                    ERROR
<a name="22907"/>22907:                            end
<a name="22908"/>22908:                    end},
<a name="22909"/>22909: 
<a name="22910"/>22910:          #{desc =&gt; &quot;enable flowinfo on dst socket&quot;,
<a name="22911"/>22911:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="22912"/>22912:                            case Set(Sock, true) of
<a name="22913"/>22913:                                ok -&gt;
<a name="22914"/>22914:                                    ?SEV_IPRINT(&quot;dst flowinfo enabled&quot;),
<a name="22915"/>22915:                                    ok;
<a name="22916"/>22916:                                {error, Reason} = ERROR -&gt;
<a name="22917"/>22917:                                    ?SEV_EPRINT(&quot;Failed setting flowinfo:&quot;
<a name="22918"/>22918:                                                &quot;   ~p&quot;, [Reason]),
<a name="22919"/>22919:                                    ERROR
<a name="22920"/>22920:                            end
<a name="22921"/>22921:                    end},
<a name="22922"/>22922: 
<a name="22923"/>22923:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="22924"/>22924:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22925"/>22925:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="22926"/>22926:                    end},
<a name="22927"/>22927:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22928"/>22928:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22929"/>22929:                            case Recv(Sock) of
<a name="22930"/>22930:                                {ok, {Src, [#{level := ipv6,
<a name="22931"/>22931:                                              type  := flowinfo,
<a name="22932"/>22932:                                              value := FlowID}], ?BASIC_REQ}} -&gt;
<a name="22933"/>22933:                                    ?SEV_IPRINT(&quot;Got flow info: &quot;
<a name="22934"/>22934: 					       &quot;~n   Flow ID: ~p&quot;, [FlowID]),
<a name="22935"/>22935:                                    ok;
<a name="22936"/>22936:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22937"/>22937:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22938"/>22938:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22939"/>22939:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22940"/>22940:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22941"/>22941:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22942"/>22942:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22943"/>22943:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22944"/>22944:                                                [Src, BadSrc,
<a name="22945"/>22945:                                                 #{level =&gt; ipv6,
<a name="22946"/>22946: 						  type  =&gt; flowinfo,
<a name="22947"/>22947: 						  value =&gt; &quot;something&quot;},
<a name="22948"/>22948: 						BadCHdrs,
<a name="22949"/>22949: 						?BASIC_REQ, BadReq]),
<a name="22950"/>22950:                                    {error, {unexpected_data, UnexpData}};
<a name="22951"/>22951:                                {ok, UnexpData} -&gt;
<a name="22952"/>22952:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22953"/>22953:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22954"/>22954:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22955"/>22955:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22956"/>22956:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22957"/>22957:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22958"/>22958:                                    {error, {unexpected_data, UnexpData}};
<a name="22959"/>22959:                                {error, _} = ERROR -&gt;
<a name="22960"/>22960:                                    %% At the moment there is no way to get
<a name="22961"/>22961:                                    %% status or state for the socket...
<a name="22962"/>22962:                                    ERROR
<a name="22963"/>22963:                            end
<a name="22964"/>22964:                    end},
<a name="22965"/>22965: 
<a name="22966"/>22966:          #{desc =&gt; &quot;close src socket&quot;,
<a name="22967"/>22967:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22968"/>22968:                            ok = socket:close(Sock),
<a name="22969"/>22969:                            {ok, maps:remove(sock_src, State)}
<a name="22970"/>22970:                    end},
<a name="22971"/>22971:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="22972"/>22972:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22973"/>22973:                            ok = socket:close(Sock),
<a name="22974"/>22974:                            {ok, maps:remove(sock_dst, State)}
<a name="22975"/>22975:                    end},
<a name="22976"/>22976: 
<a name="22977"/>22977:          %% *** We are done ***
<a name="22978"/>22978:          ?SEV_FINISH_NORMAL
<a name="22979"/>22979:         ],
<a name="22980"/>22980:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_flowinfo_udp-last_expr"/><a name="22981"/>22981: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22982"/>22982: 
<a name="22983"/>22983: 
<a name="22984"/>22984: 
<a name="22985"/>22985: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22986"/>22986: 
<a name="22987"/>22987: <i>%% Tests that the 'hop limit' control message header is received when</i>
<a name="22988"/>22988: <i>%% setting the socket 'ipv6' hoplimit or recvhoplimit option is set to </i>
<a name="22989"/>22989: <i>%% true when using sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="22990"/>22990: <i>%% So, this is done on the receiving side: </i>
<a name="22991"/>22991: <i>%%</i>
<a name="22992"/>22992: <i>%%      socket:setopt(Sock, ipv6, recvhoplimit | hoplimit, boolean()).</i>
<a name="22993"/>22993: <i>%%</i>
<a name="22994"/>22994: <i>%% For all subsequent *received* messages, the 'hop limit' control message</i>
<a name="22995"/>22995: <i>%% header will be with the message.</i>
<a name="22996"/>22996: <i>%% We make the assumption, that if 'recvhoplimit' is supported, then</i>
<a name="22997"/>22997: <i>%% that option is used to order the hoplimit control message, otherwise</i>
<a name="22998"/>22998: <i>%% hoplimit is used.</i>
<a name="22999"/>22999: <i>%%</i>
<a name="23000"/>23000: <i>%% Only allowed for dgram and raw,</i>
<a name="23001"/>23001: <i>%% although we only test this with dgram.</i>
<a name="23002"/>23002: <i>%%</i>
<a name="23003"/>23003: <i>%% &lt;Note&gt;</i>
<a name="23004"/>23004: <i>%%</i>
<a name="23005"/>23005: <i>%% There is also an IPV6_RECVHOPLIMIT option defined in the header</i>
<a name="23006"/>23006: <i>%% file (bits/in.h) with a different value. This is not mentioned</i>
<a name="23007"/>23007: <i>%% in the man page. Deprecated? More testing needed...</i>
<a name="23008"/>23008: <i>%%</i>
<a name="23009"/>23009: <i>%% &lt;/Note&gt;</i>
<a name="23010"/>23010: <i>%%</i>
<a name="23011"/>23011: 
<a name="api_opt_ipv6_hoplimit_udp6-1"/><a name="23012"/>23012: <b>api_opt_ipv6_hoplimit_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23013"/>23013:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_hoplimit_udp6-last_expr"/><a name="23014"/>23014: <b>    tc_try</b>(api_opt_ipv6_hoplimit_udp6,
<a name="23015"/>23015:            fun() -&gt;
<a name="23016"/>23016:                    has_support_ipv6(),
<a name="23017"/>23017:                    has_support_ipv6_hoplimit_or_recvhoplimit(),
<a name="23018"/>23018: 		   is_good_enough_darwin({9,8,0}),
<a name="23019"/>23019:                    is_good_enough_montavista(&quot;4.0.1&quot;)
<a name="23020"/>23020:            end,
<a name="23021"/>23021:            fun() -&gt;
<a name="23022"/>23022: 		   %% Begin by choosing which of the options we shall use
<a name="23023"/>23023: 		   Opt = case socket:is_supported(options, ipv6, recvhoplimit) of
<a name="23024"/>23024: 			     true  -&gt; recvhoplimit;
<a name="23025"/>23025: 			     false -&gt; hoplimit
<a name="23026"/>23026: 			 end,
<a name="23027"/>23027:                    Set  = fun(Sock, Value) -&gt;
<a name="23028"/>23028: 				  ?SEV_IPRINT(&quot;try set ~p: ~p&quot;, [Opt, Value]),
<a name="23029"/>23029:                                   socket:setopt(Sock, ipv6, Opt, Value)
<a name="23030"/>23030:                           end,
<a name="23031"/>23031:                    Get  = fun(Sock) -&gt;
<a name="23032"/>23032: 				  ?SEV_IPRINT(&quot;try get ~p&quot;, [Opt]),
<a name="23033"/>23033:                                   socket:getopt(Sock, ipv6, Opt)
<a name="23034"/>23034:                           end,
<a name="23035"/>23035:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="23036"/>23036:                                   Msg = #{addr =&gt; Dest,
<a name="23037"/>23037:                                              iov  =&gt; [Data]},
<a name="23038"/>23038:                                   socket:sendmsg(Sock, Msg)
<a name="23039"/>23039:                           end,
<a name="23040"/>23040:                    Recv = fun(Sock) -&gt;
<a name="23041"/>23041:                                   case socket:recvmsg(Sock) of
<a name="23042"/>23042:                                       {ok, #{addr := Source,
<a name="23043"/>23043:                                              ctrl := CMsgs,
<a name="23044"/>23044:                                              iov  := [Data]}} -&gt;
<a name="23045"/>23045:                                           {ok, {Source, CMsgs, Data}};
<a name="23046"/>23046:                                       {error, _} = ERROR -&gt;
<a name="23047"/>23047:                                           ERROR
<a name="23048"/>23048:                                   end
<a name="23049"/>23049:                           end,
<a name="23050"/>23050:                    InitState = #{domain =&gt; inet6,
<a name="23051"/>23051:                                  proto  =&gt; udp,
<a name="23052"/>23052:                                  send   =&gt; Send,
<a name="23053"/>23053:                                  recv   =&gt; Recv,
<a name="23054"/>23054:                                  set    =&gt; Set,
<a name="23055"/>23055:                                  get    =&gt; Get},
<a name="23056"/>23056:                    ok = api_opt_ipv6_hoplimit_udp(InitState)
<a name="23057"/>23057:            end).
<a name="23058"/>23058: 
<a name="23059"/>23059: 
<a name="23060"/>23060: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23061"/>23061: 
<a name="api_opt_ipv6_hoplimit_udp-1"/><a name="23062"/>23062: <b>api_opt_ipv6_hoplimit_udp</b>(InitState) -&gt;
<a name="23063"/>23063:     Seq = 
<a name="23064"/>23064:         [
<a name="23065"/>23065:          #{desc =&gt; &quot;local address&quot;,
<a name="23066"/>23066:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23067"/>23067:                            LSA = which_local_socket_addr(Domain),
<a name="23068"/>23068:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23069"/>23069:                                        lsa_dst =&gt; LSA}}
<a name="23070"/>23070:                    end},
<a name="23071"/>23071: 
<a name="23072"/>23072:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23073"/>23073:            cmd  =&gt; fun(#{domain := Domain,
<a name="23074"/>23074:                          proto  := Proto} = State) -&gt;
<a name="23075"/>23075:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23076"/>23076:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23077"/>23077:                    end},
<a name="23078"/>23078:          #{desc =&gt; &quot;bind src&quot;,
<a name="23079"/>23079:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23080"/>23080:                            case sock_bind(Sock, LSA) of
<a name="23081"/>23081:                                ok -&gt;
<a name="23082"/>23082:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23083"/>23083:                                    ok;
<a name="23084"/>23084:                                {error, Reason} = ERROR -&gt;
<a name="23085"/>23085:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23086"/>23086:                                    ERROR
<a name="23087"/>23087:                            end
<a name="23088"/>23088:                    end},
<a name="23089"/>23089:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23090"/>23090:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23091"/>23091:                            SASrc = sock_sockname(Sock),
<a name="23092"/>23092:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23093"/>23093:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23094"/>23094:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23095"/>23095:                    end},
<a name="23096"/>23096: 
<a name="23097"/>23097:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23098"/>23098:            cmd  =&gt; fun(#{domain := Domain,
<a name="23099"/>23099:                          proto  := Proto} = State) -&gt;
<a name="23100"/>23100:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23101"/>23101:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23102"/>23102:                    end},
<a name="23103"/>23103:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23104"/>23104:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23105"/>23105:                            case sock_bind(Sock, LSA) of
<a name="23106"/>23106:                                ok -&gt;
<a name="23107"/>23107:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23108"/>23108:                                    ok;
<a name="23109"/>23109:                                {error, Reason} = ERROR -&gt;
<a name="23110"/>23110:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23111"/>23111:                                    ERROR
<a name="23112"/>23112:                            end
<a name="23113"/>23113:                    end},
<a name="23114"/>23114:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23115"/>23115:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23116"/>23116:                            SADst = sock_sockname(Sock),
<a name="23117"/>23117:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23118"/>23118:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23119"/>23119:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23120"/>23120:                    end},
<a name="23121"/>23121:          #{desc =&gt; &quot;default [recv]hoplimit for dst socket&quot;,
<a name="23122"/>23122:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = State) -&gt;
<a name="23123"/>23123:                            case Get(Sock) of
<a name="23124"/>23124:                                {ok, false = Value} -&gt;
<a name="23125"/>23125:                                    ?SEV_IPRINT(&quot;dst [recv]hoplimit: ~p&quot;,
<a name="23126"/>23126: 					       [Value]),
<a name="23127"/>23127:                                    ok;
<a name="23128"/>23128:                                {ok, Unexpected} -&gt;
<a name="23129"/>23129:                                    ?SEV_EPRINT(&quot;Unexpected src [recv]hoplimit: ~p&quot;,
<a name="23130"/>23130:                                                [Unexpected]),
<a name="23131"/>23131:                                    {error, {unexpected, Unexpected}};
<a name="23132"/>23132:                                {error, enoprotoopt = Reason} -&gt;
<a name="23133"/>23133:                                    %% On some platforms this is not accepted
<a name="23134"/>23134:                                    %% for UDP, so skip this part (UDP).
<a name="23135"/>23135:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="23136"/>23136:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="23137"/>23137:                                    (catch socket:close(Sock)),
<a name="23138"/>23138:                                    (catch socket:close(maps:get_value(sock_src,
<a name="23139"/>23139: 								      State))),
<a name="23140"/>23140:                                    {skip, Reason};
<a name="23141"/>23141:                                {error, Reason} = ERROR -&gt;
<a name="23142"/>23142:                                    ?SEV_EPRINT(&quot;Failed getting (default) hoplimit:&quot;
<a name="23143"/>23143:                                                &quot;   ~p&quot;, [Reason]),
<a name="23144"/>23144:                                    ERROR
<a name="23145"/>23145:                            end
<a name="23146"/>23146:                    end},
<a name="23147"/>23147: 
<a name="23148"/>23148:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23149"/>23149:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23150"/>23150:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="23151"/>23151:                    end},
<a name="23152"/>23152:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23153"/>23153:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23154"/>23154:                            case Recv(Sock) of
<a name="23155"/>23155:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="23156"/>23156:                                    ok;
<a name="23157"/>23157:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23158"/>23158:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23159"/>23159:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23160"/>23160:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23161"/>23161:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23162"/>23162:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23163"/>23163:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23164"/>23164:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23165"/>23165:                                                [Src, BadSrc,
<a name="23166"/>23166:                                                 [], BadCHdrs,
<a name="23167"/>23167:                                                 ?BASIC_REQ, BadReq]),
<a name="23168"/>23168:                                    {error, {unexpected_data, UnexpData}};
<a name="23169"/>23169:                                {ok, UnexpData} -&gt;
<a name="23170"/>23170:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23171"/>23171:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23172"/>23172:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23173"/>23173:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23174"/>23174:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23175"/>23175:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="23176"/>23176:                                    {error, {unexpected_data, UnexpData}};
<a name="23177"/>23177:                                {error, _} = ERROR -&gt;
<a name="23178"/>23178:                                    %% At the moment there is no way to get
<a name="23179"/>23179:                                    %% status or state for the socket...
<a name="23180"/>23180:                                    ERROR
<a name="23181"/>23181:                            end
<a name="23182"/>23182:                    end},
<a name="23183"/>23183: 
<a name="23184"/>23184:          #{desc =&gt; &quot;enable [recv]hoplimit on dst socket&quot;,
<a name="23185"/>23185:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = State) -&gt;
<a name="23186"/>23186:                            case Set(Sock, true) of
<a name="23187"/>23187:                                ok -&gt;
<a name="23188"/>23188:                                    ?SEV_IPRINT(&quot;dst [recv]hoplimit enabled&quot;),
<a name="23189"/>23189:                                    ok;
<a name="23190"/>23190:                                {error, enoprotoopt = Reason} -&gt;
<a name="23191"/>23191:                                    %% On some platforms this is not accepted
<a name="23192"/>23192:                                    %% for UDP, so skip this part (UDP).
<a name="23193"/>23193:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="23194"/>23194:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="23195"/>23195:                                    (catch socket:close(Sock)),
<a name="23196"/>23196:                                    (catch socket:close(maps:get_value(sock_src,
<a name="23197"/>23197: 								      State))),
<a name="23198"/>23198:                                    {skip, Reason};
<a name="23199"/>23199:                                {error, Reason} = ERROR -&gt;
<a name="23200"/>23200:                                    ?SEV_EPRINT(&quot;Failed setting hoplimit:&quot;
<a name="23201"/>23201:                                                &quot;   ~p&quot;, [Reason]),
<a name="23202"/>23202:                                    ERROR
<a name="23203"/>23203:                            end
<a name="23204"/>23204:                    end},
<a name="23205"/>23205: 
<a name="23206"/>23206:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="23207"/>23207:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23208"/>23208:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="23209"/>23209:                    end},
<a name="23210"/>23210:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23211"/>23211:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23212"/>23212:                            case Recv(Sock) of
<a name="23213"/>23213:                                {ok, {Src, [#{level := ipv6,
<a name="23214"/>23214:                                              type  := hoplimit,
<a name="23215"/>23215:                                              value := HL}], ?BASIC_REQ}}
<a name="23216"/>23216:                                  when is_integer(HL) -&gt;
<a name="23217"/>23217:                                    ?SEV_IPRINT(&quot;Got hop limit: &quot;
<a name="23218"/>23218: 					       &quot;~n   Hop Limit: ~p&quot;, [HL]),
<a name="23219"/>23219:                                    ok;
<a name="23220"/>23220:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23221"/>23221:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23222"/>23222:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23223"/>23223:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23224"/>23224:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23225"/>23225:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23226"/>23226:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23227"/>23227:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23228"/>23228:                                                [Src, BadSrc,
<a name="23229"/>23229:                                                 #{level =&gt; ipv6,
<a name="23230"/>23230: 						  type  =&gt; hoplimit,
<a name="23231"/>23231: 						  value =&gt; &quot;something&quot;},
<a name="23232"/>23232: 						BadCHdrs,
<a name="23233"/>23233: 						?BASIC_REQ, BadReq]),
<a name="23234"/>23234:                                    {error, {unexpected_data, UnexpData}};
<a name="23235"/>23235:                                {ok, UnexpData} -&gt;
<a name="23236"/>23236:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23237"/>23237:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23238"/>23238:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23239"/>23239:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23240"/>23240:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23241"/>23241:                                                [Src, #{level =&gt; ipv6,
<a name="23242"/>23242: 						       type  =&gt; hoplimit,
<a name="23243"/>23243: 						       value =&gt; &quot;something&quot;},
<a name="23244"/>23244: 						?BASIC_REQ, UnexpData]),
<a name="23245"/>23245:                                    {error, {unexpected_data, UnexpData}};
<a name="23246"/>23246:                                {error, _} = ERROR -&gt;
<a name="23247"/>23247:                                    %% At the moment there is no way to get
<a name="23248"/>23248:                                    %% status or state for the socket...
<a name="23249"/>23249:                                    ERROR
<a name="23250"/>23250:                            end
<a name="23251"/>23251:                    end},
<a name="23252"/>23252: 
<a name="23253"/>23253:          #{desc =&gt; &quot;close src socket&quot;,
<a name="23254"/>23254:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23255"/>23255:                            ok = socket:close(Sock),
<a name="23256"/>23256:                            {ok, maps:remove(sock_src, State)}
<a name="23257"/>23257:                    end},
<a name="23258"/>23258:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="23259"/>23259:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23260"/>23260:                            ok = socket:close(Sock),
<a name="23261"/>23261:                            {ok, maps:remove(sock_dst, State)}
<a name="23262"/>23262:                    end},
<a name="23263"/>23263: 
<a name="23264"/>23264:          %% *** We are done ***
<a name="23265"/>23265:          ?SEV_FINISH_NORMAL
<a name="23266"/>23266:         ],
<a name="23267"/>23267:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_hoplimit_udp-last_expr"/><a name="23268"/>23268: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23269"/>23269: 
<a name="23270"/>23270: 
<a name="23271"/>23271: 
<a name="23272"/>23272: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23273"/>23273: 
<a name="23274"/>23274: <i>%% Tests that the 'tclass' control message header is received when</i>
<a name="23275"/>23275: <i>%% setting the socket 'ipv6' tclass or recvtclass option is set to </i>
<a name="23276"/>23276: <i>%% true when using sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="23277"/>23277: <i>%% So, this is done on the receiving side: </i>
<a name="23278"/>23278: <i>%%</i>
<a name="23279"/>23279: <i>%%      socket:setopt(Sock, ipv6, recvtclass | tclass, boolean()).</i>
<a name="23280"/>23280: <i>%%</i>
<a name="23281"/>23281: <i>%% For all subsequent *received* messages, the 'tclass' control message</i>
<a name="23282"/>23282: <i>%% header will be with the message.</i>
<a name="23283"/>23283: <i>%% We make the assumption, that if 'recvtclass' is supported, then</i>
<a name="23284"/>23284: <i>%% that option is used to order the tclass control message, otherwise</i>
<a name="23285"/>23285: <i>%% tclass is used.</i>
<a name="23286"/>23286: <i>%%</i>
<a name="23287"/>23287: <i>%% Only allowed for dgram and raw,</i>
<a name="23288"/>23288: <i>%% although we only test this with dgram.</i>
<a name="23289"/>23289: <i>%%</i>
<a name="23290"/>23290: <i>%% &lt;Note&gt;</i>
<a name="23291"/>23291: <i>%%</i>
<a name="23292"/>23292: <i>%% There is also an IPV6_RECVTCLASS option defined in the header</i>
<a name="23293"/>23293: <i>%% file (bits/in.h) with a different value. This is not mentioned</i>
<a name="23294"/>23294: <i>%% in the man page. Deprecated? More testing needed...</i>
<a name="23295"/>23295: <i>%%</i>
<a name="23296"/>23296: <i>%% &lt;/Note&gt;</i>
<a name="23297"/>23297: <i>%%</i>
<a name="23298"/>23298: 
<a name="api_opt_ipv6_tclass_udp6-1"/><a name="23299"/>23299: <b>api_opt_ipv6_tclass_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23300"/>23300:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_tclass_udp6-last_expr"/><a name="23301"/>23301: <b>    tc_try</b>(api_opt_ipv6_tclass_udp6,
<a name="23302"/>23302:            fun() -&gt;
<a name="23303"/>23303:                    has_support_ipv6(),
<a name="23304"/>23304:                    has_support_ipv6_tclass_or_recvtclass()
<a name="23305"/>23305:            end,
<a name="23306"/>23306:            fun() -&gt;
<a name="23307"/>23307: 		   %% Begin by choosing which of the options we shall use
<a name="23308"/>23308: 		   Opt = case socket:is_supported(options, ipv6, recvtclass) of
<a name="23309"/>23309: 			     true  -&gt; recvtclass;
<a name="23310"/>23310: 			     false -&gt; tclass
<a name="23311"/>23311: 			 end,
<a name="23312"/>23312:                    Set  = fun(Sock, Value) -&gt;
<a name="23313"/>23313: 				  ?SEV_IPRINT(&quot;try set ~p: ~p&quot;, [Opt, Value]),
<a name="23314"/>23314:                                   socket:setopt(Sock, ipv6, Opt, Value)
<a name="23315"/>23315:                           end,
<a name="23316"/>23316:                    Get  = fun(Sock) -&gt;
<a name="23317"/>23317: 				  ?SEV_IPRINT(&quot;try get ~p&quot;, [Opt]),
<a name="23318"/>23318:                                   socket:getopt(Sock, ipv6, Opt)
<a name="23319"/>23319:                           end,
<a name="23320"/>23320:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="23321"/>23321:                                   Msg = #{addr =&gt; Dest,
<a name="23322"/>23322:                                              iov  =&gt; [Data]},
<a name="23323"/>23323:                                   socket:sendmsg(Sock, Msg);
<a name="23324"/>23324: 			     (Sock, Data, Dest, TC) -&gt;
<a name="23325"/>23325:                                   TCHdr    = #{level =&gt; ipv6,
<a name="23326"/>23326: 					       type  =&gt; tclass,
<a name="23327"/>23327: 					       data  =&gt; TC},
<a name="23328"/>23328: 				  CMsgs = [TCHdr],
<a name="23329"/>23329:                                   Msg   = #{addr =&gt; Dest,
<a name="23330"/>23330: 					       ctrl =&gt; CMsgs,
<a name="23331"/>23331: 					       iov  =&gt; [Data]},
<a name="23332"/>23332:                                   socket:sendmsg(Sock, Msg)
<a name="23333"/>23333:                           end,
<a name="23334"/>23334:                    Recv = fun(Sock) -&gt;
<a name="23335"/>23335:                                   case socket:recvmsg(Sock) of
<a name="23336"/>23336:                                       {ok, #{addr := Source,
<a name="23337"/>23337:                                              ctrl := CMsgs,
<a name="23338"/>23338:                                              iov  := [Data]}} -&gt;
<a name="23339"/>23339:                                           {ok, {Source, CMsgs, Data}};
<a name="23340"/>23340:                                       {error, _} = ERROR -&gt;
<a name="23341"/>23341:                                           ERROR
<a name="23342"/>23342:                                   end
<a name="23343"/>23343:                           end,
<a name="23344"/>23344:                    InitState = #{domain =&gt; inet6,
<a name="23345"/>23345:                                  proto  =&gt; udp,
<a name="23346"/>23346:                                  send   =&gt; Send,
<a name="23347"/>23347:                                  recv   =&gt; Recv,
<a name="23348"/>23348:                                  set    =&gt; Set,
<a name="23349"/>23349:                                  get    =&gt; Get},
<a name="23350"/>23350:                    ok = api_opt_ipv6_tclass_udp(InitState)
<a name="23351"/>23351:            end).
<a name="23352"/>23352: 
<a name="23353"/>23353: 
<a name="23354"/>23354: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23355"/>23355: 
<a name="api_opt_ipv6_tclass_udp-1"/><a name="23356"/>23356: <b>api_opt_ipv6_tclass_udp</b>(InitState) -&gt;
<a name="23357"/>23357:     Seq = 
<a name="23358"/>23358:         [
<a name="23359"/>23359:          #{desc =&gt; &quot;local address&quot;,
<a name="23360"/>23360:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23361"/>23361:                            LSA = which_local_socket_addr(Domain),
<a name="23362"/>23362:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23363"/>23363:                                        lsa_dst =&gt; LSA}}
<a name="23364"/>23364:                    end},
<a name="23365"/>23365: 
<a name="23366"/>23366:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23367"/>23367:            cmd  =&gt; fun(#{domain := Domain,
<a name="23368"/>23368:                          proto  := Proto} = State) -&gt;
<a name="23369"/>23369:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23370"/>23370:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23371"/>23371:                    end},
<a name="23372"/>23372:          #{desc =&gt; &quot;bind src&quot;,
<a name="23373"/>23373:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23374"/>23374:                            case sock_bind(Sock, LSA) of
<a name="23375"/>23375:                                ok -&gt;
<a name="23376"/>23376:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23377"/>23377:                                    ok;
<a name="23378"/>23378:                                {error, Reason} = ERROR -&gt;
<a name="23379"/>23379:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23380"/>23380:                                    ERROR
<a name="23381"/>23381:                            end
<a name="23382"/>23382:                    end},
<a name="23383"/>23383:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23384"/>23384:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23385"/>23385:                            SASrc = sock_sockname(Sock),
<a name="23386"/>23386:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23387"/>23387:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23388"/>23388:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23389"/>23389:                    end},
<a name="23390"/>23390: 
<a name="23391"/>23391:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23392"/>23392:            cmd  =&gt; fun(#{domain := Domain,
<a name="23393"/>23393:                          proto  := Proto} = State) -&gt;
<a name="23394"/>23394:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23395"/>23395:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23396"/>23396:                    end},
<a name="23397"/>23397:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23398"/>23398:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23399"/>23399:                            case sock_bind(Sock, LSA) of
<a name="23400"/>23400:                                ok -&gt;
<a name="23401"/>23401:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23402"/>23402:                                    ok;
<a name="23403"/>23403:                                {error, Reason} = ERROR -&gt;
<a name="23404"/>23404:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23405"/>23405:                                    ERROR
<a name="23406"/>23406:                            end
<a name="23407"/>23407:                    end},
<a name="23408"/>23408:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23409"/>23409:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23410"/>23410:                            SADst = sock_sockname(Sock),
<a name="23411"/>23411:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23412"/>23412:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23413"/>23413:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23414"/>23414:                    end},
<a name="23415"/>23415:          #{desc =&gt; &quot;default [recv]tclass for dst socket&quot;,
<a name="23416"/>23416:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = State) -&gt;
<a name="23417"/>23417:                            case Get(Sock) of
<a name="23418"/>23418:                                {ok, false = Value} -&gt;
<a name="23419"/>23419:                                    ?SEV_IPRINT(&quot;dst [recv]tclass: ~p&quot;,
<a name="23420"/>23420: 					       [Value]),
<a name="23421"/>23421:                                    ok;
<a name="23422"/>23422:                                {ok, Unexpected} -&gt;
<a name="23423"/>23423:                                    ?SEV_EPRINT(&quot;Unexpected src [recv]tclass: ~p&quot;,
<a name="23424"/>23424:                                                [Unexpected]),
<a name="23425"/>23425:                                    {error, {unexpected, Unexpected}};
<a name="23426"/>23426:                                {error, enoprotoopt = Reason} -&gt;
<a name="23427"/>23427:                                    %% On some platforms this is not accepted
<a name="23428"/>23428:                                    %% for UDP, so skip this part (UDP).
<a name="23429"/>23429:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="23430"/>23430:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="23431"/>23431:                                    (catch socket:close(Sock)),
<a name="23432"/>23432:                                    (catch socket:close(maps:get_value(sock_src,
<a name="23433"/>23433: 								      State))),
<a name="23434"/>23434:                                    {skip, Reason};
<a name="23435"/>23435:                                {error, Reason} = ERROR -&gt;
<a name="23436"/>23436:                                    ?SEV_EPRINT(&quot;Failed getting (default) tclass:&quot;
<a name="23437"/>23437:                                                &quot;   ~p&quot;, [Reason]),
<a name="23438"/>23438:                                    ERROR
<a name="23439"/>23439:                            end
<a name="23440"/>23440:                    end},
<a name="23441"/>23441: 
<a name="23442"/>23442:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23443"/>23443:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23444"/>23444:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="23445"/>23445:                    end},
<a name="23446"/>23446:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23447"/>23447:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23448"/>23448:                            case Recv(Sock) of
<a name="23449"/>23449:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="23450"/>23450:                                    ok;
<a name="23451"/>23451:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23452"/>23452:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23453"/>23453:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23454"/>23454:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23455"/>23455:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23456"/>23456:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23457"/>23457:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23458"/>23458:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23459"/>23459:                                                [Src, BadSrc,
<a name="23460"/>23460:                                                 [], BadCHdrs,
<a name="23461"/>23461:                                                 ?BASIC_REQ, BadReq]),
<a name="23462"/>23462:                                    {error, {unexpected_data, UnexpData}};
<a name="23463"/>23463:                                {ok, UnexpData} -&gt;
<a name="23464"/>23464:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23465"/>23465:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23466"/>23466:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23467"/>23467:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23468"/>23468:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23469"/>23469:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="23470"/>23470:                                    {error, {unexpected_data, UnexpData}};
<a name="23471"/>23471:                                {error, _} = ERROR -&gt;
<a name="23472"/>23472:                                    %% At the moment there is no way to get
<a name="23473"/>23473:                                    %% status or state for the socket...
<a name="23474"/>23474:                                    ERROR
<a name="23475"/>23475:                            end
<a name="23476"/>23476:                    end},
<a name="23477"/>23477: 
<a name="23478"/>23478:          #{desc =&gt; &quot;enable [recv]tclass on dst socket&quot;,
<a name="23479"/>23479:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = State) -&gt;
<a name="23480"/>23480:                            case Set(Sock, true) of
<a name="23481"/>23481:                                ok -&gt;
<a name="23482"/>23482:                                    ?SEV_IPRINT(&quot;dst [recv]tclass enabled&quot;),
<a name="23483"/>23483:                                    ok;
<a name="23484"/>23484:                                {error, enoprotoopt = Reason} -&gt;
<a name="23485"/>23485:                                    %% On some platforms this is not accepted
<a name="23486"/>23486:                                    %% for UDP, so skip this part (UDP).
<a name="23487"/>23487:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="23488"/>23488:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="23489"/>23489:                                    (catch socket:close(Sock)),
<a name="23490"/>23490:                                    (catch socket:close(maps:get_value(sock_src,
<a name="23491"/>23491: 								      State))),
<a name="23492"/>23492:                                    {skip, Reason};
<a name="23493"/>23493:                                {error, Reason} = ERROR -&gt;
<a name="23494"/>23494:                                    ?SEV_EPRINT(&quot;Failed setting tclass:&quot;
<a name="23495"/>23495:                                                &quot;   ~p&quot;, [Reason]),
<a name="23496"/>23496:                                    ERROR
<a name="23497"/>23497:                            end
<a name="23498"/>23498:                    end},
<a name="23499"/>23499: 
<a name="23500"/>23500:          #{desc =&gt; &quot;send req (to dst) (wo explicit tc)&quot;,
<a name="23501"/>23501:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23502"/>23502:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="23503"/>23503:                    end},
<a name="23504"/>23504:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23505"/>23505:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23506"/>23506:                            case Recv(Sock) of
<a name="23507"/>23507:                                {ok, {Src, [#{level := ipv6,
<a name="23508"/>23508:                                              type  := tclass,
<a name="23509"/>23509:                                              value := TClass}], ?BASIC_REQ}}
<a name="23510"/>23510: 			       when is_integer(TClass) -&gt;
<a name="23511"/>23511:                                    ?SEV_IPRINT(&quot;Got tclass: &quot;
<a name="23512"/>23512: 					       &quot;~n   TClass: ~p&quot;, [TClass]),
<a name="23513"/>23513:                                    ok;
<a name="23514"/>23514:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23515"/>23515:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23516"/>23516:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23517"/>23517:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23518"/>23518:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23519"/>23519:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23520"/>23520:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23521"/>23521:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23522"/>23522:                                                [Src, BadSrc,
<a name="23523"/>23523:                                                 #{level =&gt; ipv6,
<a name="23524"/>23524: 						  type  =&gt; tclass,
<a name="23525"/>23525: 						  value =&gt; &quot;something&quot;},
<a name="23526"/>23526: 						BadCHdrs,
<a name="23527"/>23527: 						?BASIC_REQ, BadReq]),
<a name="23528"/>23528:                                    {error, {unexpected_data, UnexpData}};
<a name="23529"/>23529:                                {ok, UnexpData} -&gt;
<a name="23530"/>23530:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23531"/>23531:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23532"/>23532:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23533"/>23533:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23534"/>23534:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23535"/>23535:                                                [Src, #{level =&gt; ipv6,
<a name="23536"/>23536: 						       type  =&gt; tclass,
<a name="23537"/>23537: 						       value =&gt; &quot;something&quot;},
<a name="23538"/>23538: 						?BASIC_REQ, UnexpData]),
<a name="23539"/>23539:                                    {error, {unexpected_data, UnexpData}};
<a name="23540"/>23540:                                {error, _} = ERROR -&gt;
<a name="23541"/>23541:                                    %% At the moment there is no way to get
<a name="23542"/>23542:                                    %% status or state for the socket...
<a name="23543"/>23543:                                    ERROR
<a name="23544"/>23544:                            end
<a name="23545"/>23545:                    end},
<a name="23546"/>23546: 
<a name="23547"/>23547:          #{desc =&gt; &quot;send req (to dst) (w explicit tc = 1)&quot;,
<a name="23548"/>23548:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23549"/>23549:                            case Send(Sock, ?BASIC_REQ, Dst, 1) of
<a name="23550"/>23550:                                {error,
<a name="23551"/>23551:                                 {get_overlapped_result,
<a name="23552"/>23552:                                  #{file     := File,
<a name="23553"/>23553:                                    function := Function,
<a name="23554"/>23554:                                    line     := Line,
<a name="23555"/>23555:                                    raw_info := RawInfo,
<a name="23556"/>23556:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="23557"/>23557:                                    %% IF we can't send it the test will not work
<a name="23558"/>23558:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="23559"/>23559:                                                &quot;~p =&gt; SKIP: &quot;
<a name="23560"/>23560:                                                &quot;~n   File:     ~s&quot;
<a name="23561"/>23561:                                                &quot;~n   Function: ~s&quot;
<a name="23562"/>23562:                                                &quot;~n   Line:     ~p&quot;
<a name="23563"/>23563:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="23564"/>23564:                                                [Info,
<a name="23565"/>23565:                                                 File, Function, Line,
<a name="23566"/>23566:                                                 RawInfo]),
<a name="23567"/>23567:                                    (catch socket:close(Sock)),
<a name="23568"/>23568:                                    {skip,
<a name="23569"/>23569:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="23570"/>23570:                                {error, {get_overlapped_result,
<a name="23571"/>23571:                                         invalid_parameter = Info}} -&gt;
<a name="23572"/>23572:                                    %% IF we can't send it the test will not work
<a name="23573"/>23573:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="23574"/>23574:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="23575"/>23575:                                    (catch socket:close(Sock)),
<a name="23576"/>23576:                                    {skip,
<a name="23577"/>23577:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="23578"/>23578: 
<a name="23579"/>23579:                                {error,
<a name="23580"/>23580:                                 {completion_status,
<a name="23581"/>23581:                                  #{file     := File,
<a name="23582"/>23582:                                    function := Function,
<a name="23583"/>23583:                                    line     := Line,
<a name="23584"/>23584:                                    raw_info := RawInfo,
<a name="23585"/>23585:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="23586"/>23586:                                    %% IF we can't send it the test will not work
<a name="23587"/>23587:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="23588"/>23588:                                                &quot;~p =&gt; SKIP: &quot;
<a name="23589"/>23589:                                                &quot;~n   File:     ~s&quot;
<a name="23590"/>23590:                                                &quot;~n   Function: ~s&quot;
<a name="23591"/>23591:                                                &quot;~n   Line:     ~p&quot;
<a name="23592"/>23592:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="23593"/>23593:                                                [Info,
<a name="23594"/>23594:                                                 File, Function, Line,
<a name="23595"/>23595:                                                 RawInfo]),
<a name="23596"/>23596:                                    (catch socket:close(Sock)),
<a name="23597"/>23597:                                    {skip,
<a name="23598"/>23598:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="23599"/>23599:                                {error, {completion_status,
<a name="23600"/>23600:                                         invalid_parameter = Info}} -&gt;
<a name="23601"/>23601:                                    %% IF we can't send it the test will not work
<a name="23602"/>23602:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="23603"/>23603:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="23604"/>23604:                                    (catch socket:close(Sock)),
<a name="23605"/>23605:                                    {skip,
<a name="23606"/>23606:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="23607"/>23607: 
<a name="23608"/>23608:                                Other -&gt;
<a name="23609"/>23609:                                    Other
<a name="23610"/>23610:                            end
<a name="23611"/>23611:                    end},
<a name="23612"/>23612:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23613"/>23613:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23614"/>23614:                            case Recv(Sock) of
<a name="23615"/>23615:                                {ok, {Src, [#{level := ipv6,
<a name="23616"/>23616:                                              type  := tclass,
<a name="23617"/>23617:                                              value := 1 = TClass}], ?BASIC_REQ}}
<a name="23618"/>23618: 			       when is_integer(TClass) -&gt;
<a name="23619"/>23619:                                    ?SEV_IPRINT(&quot;Got (expected) tclass: &quot;
<a name="23620"/>23620: 					       &quot;~n   TClass: ~p&quot;, [TClass]),
<a name="23621"/>23621:                                    ok;
<a name="23622"/>23622:                                {ok, {_Src, [#{level := ipv6,
<a name="23623"/>23623: 					      type  := tclass,
<a name="23624"/>23624: 					      value := TClass}], ?BASIC_REQ}}
<a name="23625"/>23625: 			       when is_integer(TClass) -&gt;
<a name="23626"/>23626:                                    ?SEV_EPRINT(&quot;Unexpected tclass: &quot;
<a name="23627"/>23627:                                                &quot;~n   Expect TClass: ~p&quot;
<a name="23628"/>23628:                                                &quot;~n   Recv TClass:   ~p&quot;,
<a name="23629"/>23629:                                                [1, TClass]),
<a name="23630"/>23630:                                    {error, {unexpected_tclass, TClass}};
<a name="23631"/>23631:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23632"/>23632:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23633"/>23633:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23634"/>23634:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23635"/>23635:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23636"/>23636:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23637"/>23637:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23638"/>23638:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23639"/>23639:                                                [Src, BadSrc,
<a name="23640"/>23640:                                                 #{level =&gt; ipv6,
<a name="23641"/>23641: 						  type  =&gt; tclass,
<a name="23642"/>23642: 						  value =&gt; &quot;something&quot;},
<a name="23643"/>23643: 						BadCHdrs,
<a name="23644"/>23644: 						?BASIC_REQ, BadReq]),
<a name="23645"/>23645:                                    {error, {unexpected_data, UnexpData}};
<a name="23646"/>23646:                                {ok, UnexpData} -&gt;
<a name="23647"/>23647:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23648"/>23648:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23649"/>23649:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23650"/>23650:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23651"/>23651:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23652"/>23652:                                                [Src, #{level =&gt; ipv6,
<a name="23653"/>23653: 						       type  =&gt; tclass,
<a name="23654"/>23654: 						       value =&gt; &quot;something&quot;},
<a name="23655"/>23655: 						?BASIC_REQ, UnexpData]),
<a name="23656"/>23656:                                    {error, {unexpected_data, UnexpData}};
<a name="23657"/>23657: 
<a name="23658"/>23658:                                 {error, _} = ERROR -&gt;
<a name="23659"/>23659:                                    %% At the moment there is no way to get
<a name="23660"/>23660:                                    %% status or state for the socket...
<a name="23661"/>23661:                                    ERROR
<a name="23662"/>23662:                            end
<a name="23663"/>23663:                    end},
<a name="23664"/>23664: 
<a name="23665"/>23665:          #{desc =&gt; &quot;close src socket&quot;,
<a name="23666"/>23666:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23667"/>23667:                            ok = socket:close(Sock),
<a name="23668"/>23668:                            {ok, maps:remove(sock_src, State)}
<a name="23669"/>23669:                    end},
<a name="23670"/>23670:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="23671"/>23671:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23672"/>23672:                            ok = socket:close(Sock),
<a name="23673"/>23673:                            {ok, maps:remove(sock_dst, State)}
<a name="23674"/>23674:                    end},
<a name="23675"/>23675: 
<a name="23676"/>23676:          %% *** We are done ***
<a name="23677"/>23677:          ?SEV_FINISH_NORMAL
<a name="23678"/>23678:         ],
<a name="23679"/>23679:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_tclass_udp-last_expr"/><a name="23680"/>23680: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23681"/>23681: 
<a name="23682"/>23682: 
<a name="23683"/>23683: 
<a name="23684"/>23684: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23685"/>23685: 
<a name="23686"/>23686: <i>%% This intended to test &quot;all&quot; of the (currently) supported IPv6</i>
<a name="23687"/>23687: <i>%% options that results in control message header(s).</i>
<a name="23688"/>23688: <i>%% So, this is done on the receiving side: </i>
<a name="23689"/>23689: <i>%%</i>
<a name="23690"/>23690: <i>%%      socket:setopt(Sock, ipv6, Flag, boolean()).</i>
<a name="23691"/>23691: <i>%%</i>
<a name="23692"/>23692: <i>%% For all subsequent *received* messages, a control message header</i>
<a name="23693"/>23693: <i>%% for each of the enabled options will be received with the message.</i>
<a name="23694"/>23694: <i>%%</i>
<a name="23695"/>23695: <i>%% Only allowed for dgram and raw,</i>
<a name="23696"/>23696: <i>%% although we only test this with dgram.</i>
<a name="23697"/>23697: <i>%%</i>
<a name="23698"/>23698: <i>%% Currently we *try* to use the following opts:</i>
<a name="23699"/>23699: <i>%%</i>
<a name="23700"/>23700: <i>%%      recvpktinfo | pktinfo   =&gt; pktinfo</i>
<a name="23701"/>23701: <i>%%      flowinfo                =&gt; flowinfo</i>
<a name="23702"/>23702: <i>%%      recvhoplimit | hoplimit =&gt; hoplimit</i>
<a name="23703"/>23703: <i>%%      recvtclass | tclass     =&gt; tclass</i>
<a name="23704"/>23704: <i>%%</i>
<a name="23705"/>23705: <i>%%</i>
<a name="23706"/>23706: <i>%% Every time we add a test case for a new option (that results in</i>
<a name="23707"/>23707: <i>%% a control message hedare), we should also add it here.</i>
<a name="23708"/>23708: <i>%%</i>
<a name="23709"/>23709: <i>%% Even though this is a IPv6 test case, we add the 'socket' timestamp</i>
<a name="23710"/>23710: <i>%% option (just to fill up), but in the test to see if we should run</i>
<a name="23711"/>23711: <i>%% the test (since its a IPv6 test case).</i>
<a name="23712"/>23712: <i>%%</i>
<a name="23713"/>23713: 
<a name="api_opt_ipv6_mopts_udp6-1"/><a name="23714"/>23714: <b>api_opt_ipv6_mopts_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23715"/>23715:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_mopts_udp6-last_expr"/><a name="23716"/>23716: <b>    tc_try</b>(api_opt_ipv6_mopts_udp6,
<a name="23717"/>23717:            fun() -&gt;
<a name="23718"/>23718:                    has_support_ipv6(),
<a name="23719"/>23719:                    Opts =
<a name="23720"/>23720:                        [{ipv6, recvpktinfo},
<a name="23721"/>23721:                         {ipv6, flowinfo},
<a name="23722"/>23722:                         {ipv6, recvhoplimit},
<a name="23723"/>23723:                         {ipv6, hoplimit}] ++
<a name="23724"/>23724:                        case os:type() of
<a name="23725"/>23725:                            {win32, nt} -&gt;
<a name="23726"/>23726:                                [];
<a name="23727"/>23727:                            _ -&gt;
<a name="23728"/>23728:                                [{ipv6, recvtclass},
<a name="23729"/>23729:                                 {ipv6, tclass}]
<a name="23730"/>23730:                        end,
<a name="23731"/>23731: 		   case is_any_options_supported(Opts) of
<a name="23732"/>23732: 		       true -&gt;
<a name="23733"/>23733: 			   ok;
<a name="23734"/>23734: 		       false -&gt;
<a name="23735"/>23735: 			   skip(&quot;None of the needed options are supported&quot;)
<a name="23736"/>23736: 		   end,
<a name="23737"/>23737: 		   %% The problem here is hoplimit on darwin 9.8.0,
<a name="23738"/>23738: 		   %% but I can't be bothered to adjust the test case,
<a name="23739"/>23739: 		   %% just skip on that machine (there is only one)...
<a name="23740"/>23740: 		   is_good_enough_darwin({9,8,0}),
<a name="23741"/>23741:                    is_good_enough_montavista(&quot;4.0.1&quot;)
<a name="23742"/>23742:            end,
<a name="23743"/>23743:            fun() -&gt;
<a name="23744"/>23744: 		   %% If we get this far, we *know* that at least one of the
<a name="23745"/>23745: 		   %% options are available.
<a name="23746"/>23746: 
<a name="23747"/>23747: 		   %% This is list of all the options and there resulting
<a name="23748"/>23748: 		   %% control message header type(s):
<a name="23749"/>23749: 		   %%   [{'ipv6 socket option', 'control message header type'}]
<a name="23750"/>23750: 		   Opts =
<a name="23751"/>23751: 		       case socket:is_supported(options, socket, timestamp) of
<a name="23752"/>23752: 			   true -&gt;
<a name="23753"/>23753: 			       [{socket, timestamp, timestamp, default}];
<a name="23754"/>23754: 			   false -&gt;
<a name="23755"/>23755: 			       []
<a name="23756"/>23756: 		       end ++
<a name="23757"/>23757: 		       case socket:is_supported(options, ipv6, recvpktinfo) of
<a name="23758"/>23758: 			   true -&gt;
<a name="23759"/>23759: 			       [{ipv6, recvpktinfo, pktinfo, default}];
<a name="23760"/>23760: 			   false -&gt;
<a name="23761"/>23761: 			       []
<a name="23762"/>23762: 		       end ++
<a name="23763"/>23763: 		       case socket:is_supported(options, ipv6, flowinfo) of
<a name="23764"/>23764: 			   true -&gt;
<a name="23765"/>23765: 			       [{ipv6, flowinfo, flowinfo, default}];
<a name="23766"/>23766: 			   false -&gt;
<a name="23767"/>23767: 			       []
<a name="23768"/>23768: 		       end ++
<a name="23769"/>23769: 		       case socket:is_supported(options, ipv6, recvhoplimit) of
<a name="23770"/>23770: 			   true -&gt;
<a name="23771"/>23771: 			       [{ipv6, recvhoplimit, hoplimit, default}];
<a name="23772"/>23772: 			   false -&gt;
<a name="23773"/>23773: 			       case socket:is_supported(options, ipv6, hoplimit) of
<a name="23774"/>23774: 				   true -&gt;
<a name="23775"/>23775: 				       [{ipv6, hoplimit, hoplimit, default}];
<a name="23776"/>23776: 				   false -&gt;
<a name="23777"/>23777: 				       []
<a name="23778"/>23778: 			       end
<a name="23779"/>23779: 		       end ++
<a name="23780"/>23780:                        case os:type() of
<a name="23781"/>23781:                            {win32, nt} -&gt;
<a name="23782"/>23782:                                [];
<a name="23783"/>23783:                            _ -&gt;
<a name="23784"/>23784:                                case socket:is_supported(options,
<a name="23785"/>23785:                                                         ipv6, recvtclass) of
<a name="23786"/>23786:                                    true -&gt;
<a name="23787"/>23787:                                        [{ipv6, recvtclass, tclass, 42}];
<a name="23788"/>23788:                                    false -&gt;
<a name="23789"/>23789:                                        case socket:is_supported(options,
<a name="23790"/>23790:                                                                 ipv6, tclass) of
<a name="23791"/>23791:                                            true -&gt;
<a name="23792"/>23792:                                                [{ipv6, tclass, tclass, 42}];
<a name="23793"/>23793:                                            false -&gt;
<a name="23794"/>23794:                                                []
<a name="23795"/>23795:                                        end
<a name="23796"/>23796:                                end
<a name="23797"/>23797: 		       end,
<a name="23798"/>23798: 
<a name="23799"/>23799:                    Enable = fun(Sock, Level, Opt) -&gt;
<a name="23800"/>23800: 				    ?SEV_IPRINT(&quot;try enable [~w] ~p&quot;,
<a name="23801"/>23801:                                                 [Level, Opt]),
<a name="23802"/>23802: 				    socket:setopt(Sock, Level, Opt, true)
<a name="23803"/>23803:                             end,
<a name="23804"/>23804:                    Send = fun(Sock, Data, Dest, []) -&gt;
<a name="23805"/>23805:                                   Msg = #{addr =&gt; Dest,
<a name="23806"/>23806:                                              iov  =&gt; [Data]},
<a name="23807"/>23807:                                   socket:sendmsg(Sock, Msg);
<a name="23808"/>23808: 			     (Sock, Data, Dest, Hdrs) when is_list(Hdrs) -&gt;
<a name="23809"/>23809: 				  CMsgs = [#{level =&gt; Level,
<a name="23810"/>23810:                                              type  =&gt; Type,
<a name="23811"/>23811:                                              data  =&gt; Val} ||
<a name="23812"/>23812:                                               {Level, Type, Val} &lt;- Hdrs],
<a name="23813"/>23813:                                   Msg   = #{addr =&gt; Dest,
<a name="23814"/>23814:                                             ctrl =&gt; CMsgs,
<a name="23815"/>23815:                                             iov  =&gt; [Data]},
<a name="23816"/>23816:                                   socket:sendmsg(Sock, Msg)
<a name="23817"/>23817:                           end,
<a name="23818"/>23818:                    Recv = fun(Sock) -&gt;
<a name="23819"/>23819:                                   case socket:recvmsg(Sock) of
<a name="23820"/>23820:                                       {ok, #{addr := Source,
<a name="23821"/>23821:                                              ctrl := CMsgs,
<a name="23822"/>23822:                                              iov  := [Data]}} -&gt;
<a name="23823"/>23823:                                           {ok, {Source, CMsgs, Data}};
<a name="23824"/>23824:                                       {error, _} = ERROR -&gt;
<a name="23825"/>23825:                                           ERROR
<a name="23826"/>23826:                                   end
<a name="23827"/>23827:                           end,
<a name="23828"/>23828:                    InitState = #{domain =&gt; inet6,
<a name="23829"/>23829:                                  proto  =&gt; udp,
<a name="23830"/>23830: 				 opts   =&gt; Opts,
<a name="23831"/>23831:                                  send   =&gt; Send,
<a name="23832"/>23832:                                  recv   =&gt; Recv,
<a name="23833"/>23833:                                  enable =&gt; Enable},
<a name="23834"/>23834:                    ok = api_opt_ipv6_mopts_udp(InitState)
<a name="23835"/>23835:            end).
<a name="23836"/>23836: 
<a name="23837"/>23837: 
<a name="23838"/>23838: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23839"/>23839: 
<a name="api_opt_ipv6_mopts_udp-1"/><a name="23840"/>23840: <b>api_opt_ipv6_mopts_udp</b>(InitState) -&gt;
<a name="23841"/>23841:     Seq = 
<a name="23842"/>23842:         [
<a name="23843"/>23843:          #{desc =&gt; &quot;local address&quot;,
<a name="23844"/>23844:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23845"/>23845:                            LSA = which_local_socket_addr(Domain),
<a name="23846"/>23846:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23847"/>23847:                                        lsa_dst =&gt; LSA}}
<a name="23848"/>23848:                    end},
<a name="23849"/>23849: 
<a name="23850"/>23850:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23851"/>23851:            cmd  =&gt; fun(#{domain := Domain,
<a name="23852"/>23852:                          proto  := Proto} = State) -&gt;
<a name="23853"/>23853:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23854"/>23854:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23855"/>23855:                    end},
<a name="23856"/>23856:          #{desc =&gt; &quot;bind src&quot;,
<a name="23857"/>23857:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23858"/>23858:                            case sock_bind(Sock, LSA) of
<a name="23859"/>23859:                                ok -&gt;
<a name="23860"/>23860:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23861"/>23861:                                    ok;
<a name="23862"/>23862:                                {error, Reason} = ERROR -&gt;
<a name="23863"/>23863:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23864"/>23864:                                    ERROR
<a name="23865"/>23865:                            end
<a name="23866"/>23866:                    end},
<a name="23867"/>23867:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23868"/>23868:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23869"/>23869:                            SASrc = sock_sockname(Sock),
<a name="23870"/>23870:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23871"/>23871:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23872"/>23872:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23873"/>23873:                    end},
<a name="23874"/>23874: 
<a name="23875"/>23875:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23876"/>23876:            cmd  =&gt; fun(#{domain := Domain,
<a name="23877"/>23877:                          proto  := Proto} = State) -&gt;
<a name="23878"/>23878:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23879"/>23879:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23880"/>23880:                    end},
<a name="23881"/>23881:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23882"/>23882:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23883"/>23883:                            case sock_bind(Sock, LSA) of
<a name="23884"/>23884:                                ok -&gt;
<a name="23885"/>23885:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23886"/>23886:                                    ok;
<a name="23887"/>23887:                                {error, Reason} = ERROR -&gt;
<a name="23888"/>23888:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23889"/>23889:                                    ERROR
<a name="23890"/>23890:                            end
<a name="23891"/>23891:                    end},
<a name="23892"/>23892:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23893"/>23893:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23894"/>23894:                            SADst = sock_sockname(Sock),
<a name="23895"/>23895:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23896"/>23896:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23897"/>23897:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23898"/>23898:                    end},
<a name="23899"/>23899: 
<a name="23900"/>23900:          #{desc =&gt; &quot;enable options on dst socket&quot;,
<a name="23901"/>23901:            cmd  =&gt; fun(#{sock_dst := DSock,
<a name="23902"/>23902: 			 sock_src := SSock,
<a name="23903"/>23903: 			 opts     := Opts,
<a name="23904"/>23904: 			 enable   := Enable} = _State) -&gt;
<a name="23905"/>23905: 			   %% If we fail to enable *any* of the options,
<a name="23906"/>23906: 			   %% we give up.
<a name="23907"/>23907: 			   E = fun({Level, Opt, _, _}) -&gt; 
<a name="23908"/>23908:                                        case Enable(DSock, Level, Opt) of
<a name="23909"/>23909:                                            ok -&gt;
<a name="23910"/>23910:                                                ?SEV_IPRINT(&quot;dst [~w] ~w enabled&quot;,
<a name="23911"/>23911:                                                            [Level, Opt]),
<a name="23912"/>23912:                                                ok;
<a name="23913"/>23913:                                            {error, enoprotoopt = Reason} -&gt;
<a name="23914"/>23914:                                                ?SEV_EPRINT(&quot;Expected &quot;
<a name="23915"/>23915:                                                            &quot;Failure: &quot;
<a name="23916"/>23916:                                                            &quot;~p =&gt; SKIP&quot;,
<a name="23917"/>23917:                                                            [Reason]),
<a name="23918"/>23918:                                                (catch socket:close(DSock)),
<a name="23919"/>23919:                                                (catch socket:close(SSock)),
<a name="23920"/>23920:                                                {skip, Reason};
<a name="23921"/>23921:                                            {error, Reason} = ERROR -&gt;
<a name="23922"/>23922:                                                ?SEV_EPRINT(&quot;Failed &quot;
<a name="23923"/>23923:                                                            &quot;setting ~w:&quot;
<a name="23924"/>23924:                                                            &quot;   ~p&quot;,
<a name="23925"/>23925:                                                            [Opt, Reason]),
<a name="23926"/>23926:                                                throw(ERROR)
<a name="23927"/>23927:                                        end
<a name="23928"/>23928: 			       end,
<a name="23929"/>23929: 			   lists:foreach(E, Opts),
<a name="23930"/>23930: 			   ok
<a name="23931"/>23931:                    end},
<a name="23932"/>23932: 
<a name="23933"/>23933:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23934"/>23934:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="23935"/>23935: 			 sa_dst   := Dst,
<a name="23936"/>23936: 			 opts     := Opts,
<a name="23937"/>23937: 			 send     := Send}) -&gt;
<a name="23938"/>23938: 			   Hdrs = [{Level, Type, Data} ||
<a name="23939"/>23939: 				      {Level, _, Type, Data} &lt;- 
<a name="23940"/>23940: 					  Opts, (Data =/= default)],
<a name="23941"/>23941:                            Send(Sock, ?BASIC_REQ, Dst, Hdrs)
<a name="23942"/>23942:                    end},
<a name="23943"/>23943:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23944"/>23944:            cmd  =&gt; fun(#{sock_dst := Sock,
<a name="23945"/>23945: 			 sa_src   := Src,
<a name="23946"/>23946: 			 recv     := Recv,
<a name="23947"/>23947: 			 opts     := Opts}) -&gt;
<a name="23948"/>23948:                            case Recv(Sock) of
<a name="23949"/>23949:                                {ok, {Src, CMsgs, ?BASIC_REQ}}
<a name="23950"/>23950:                                  when length(CMsgs) =:= length(Opts)  -&gt;
<a name="23951"/>23951:                                    ?SEV_IPRINT(&quot;Got (expected) cmsg headers: &quot;
<a name="23952"/>23952: 					       &quot;~n   ~p&quot;, [CMsgs]),
<a name="23953"/>23953: 				   %% We should really verify the headers:
<a name="23954"/>23954: 				   %% values, types and so on...
<a name="23955"/>23955:                                    ok;
<a name="23956"/>23956:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23957"/>23957:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23958"/>23958:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23959"/>23959:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23960"/>23960:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23961"/>23961:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23962"/>23962:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23963"/>23963:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23964"/>23964:                                                [Src, BadSrc,
<a name="23965"/>23965:                                                 [{Level, Type} ||
<a name="23966"/>23966:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="23967"/>23967: 						BadCHdrs,
<a name="23968"/>23968: 						?BASIC_REQ, BadReq]),
<a name="23969"/>23969:                                    {error, {unexpected_data, UnexpData}};
<a name="23970"/>23970:                                {ok, UnexpData} -&gt;
<a name="23971"/>23971:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23972"/>23972:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23973"/>23973:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23974"/>23974:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23975"/>23975:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23976"/>23976:                                                [Src,
<a name="23977"/>23977:                                                 [{Level, Type} ||
<a name="23978"/>23978:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="23979"/>23979: 						?BASIC_REQ,
<a name="23980"/>23980:                                                 UnexpData]),
<a name="23981"/>23981:                                    {error, {unexpected_data, UnexpData}};
<a name="23982"/>23982:                                {error, _} = ERROR -&gt;
<a name="23983"/>23983:                                    %% At the moment there is no way to get
<a name="23984"/>23984:                                    %% status or state for the socket...
<a name="23985"/>23985:                                    ERROR
<a name="23986"/>23986:                            end
<a name="23987"/>23987:                    end},
<a name="23988"/>23988: 
<a name="23989"/>23989:          #{desc =&gt; &quot;close src socket&quot;,
<a name="23990"/>23990:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23991"/>23991:                            ok = socket:close(Sock),
<a name="23992"/>23992:                            {ok, maps:remove(sock_src, State)}
<a name="23993"/>23993:                    end},
<a name="23994"/>23994:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="23995"/>23995:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23996"/>23996:                            ok = socket:close(Sock),
<a name="23997"/>23997:                            {ok, maps:remove(sock_dst, State)}
<a name="23998"/>23998:                    end},
<a name="23999"/>23999: 
<a name="24000"/>24000:          %% *** We are done ***
<a name="24001"/>24001:          ?SEV_FINISH_NORMAL
<a name="24002"/>24002:         ],
<a name="24003"/>24003:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_mopts_udp-last_expr"/><a name="24004"/>24004: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="24005"/>24005: 
<a name="24006"/>24006: 
<a name="24007"/>24007: 
<a name="24008"/>24008: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24009"/>24009: 
<a name="24010"/>24010: <i>%% Tests that the congestion tcp socket option.</i>
<a name="24011"/>24011: <i>%%</i>
<a name="24012"/>24012: <i>%% According to the man page (on linux) for this option it *should* be</i>
<a name="24013"/>24013: <i>%% possible to both get and set *allowed* algorithms. But when we attempt</i>
<a name="24014"/>24014: <i>%% to set, we get 'enoent'.</i>
<a name="24015"/>24015: <i>%% According to /proc/sys/net/ipv4/tcp_allowed_congestion_control that</i>
<a name="24016"/>24016: <i>%% allgorithm was allowed, so...</i>
<a name="24017"/>24017: <i>%% For now, we only test that we can get (it could be a bug in our code)</i>
<a name="24018"/>24018: 
<a name="api_opt_tcp_congestion_tcp4-1"/><a name="24019"/>24019: <b>api_opt_tcp_congestion_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24020"/>24020:     ?TT(?SECS(5)),
<a name="api_opt_tcp_congestion_tcp4-last_expr"/><a name="24021"/>24021: <b>    tc_try</b>(api_opt_tcp_congestion_tcp4,
<a name="24022"/>24022:            fun() -&gt; has_support_ipv4(), has_support_tcp_congestion() end,
<a name="24023"/>24023:            fun() -&gt;
<a name="24024"/>24024:                    Set  = fun(Sock, Value) when is_list(Value) -&gt;
<a name="24025"/>24025:                                   socket:setopt(Sock, tcp, congestion, Value)
<a name="24026"/>24026:                           end,
<a name="24027"/>24027:                    Get  = fun(Sock) -&gt;
<a name="24028"/>24028:                                   socket:getopt(Sock, tcp, congestion)
<a name="24029"/>24029:                           end,
<a name="24030"/>24030:                    InitState = #{domain =&gt; inet,
<a name="24031"/>24031:                                  proto  =&gt; tcp,
<a name="24032"/>24032:                                  set    =&gt; Set,
<a name="24033"/>24033:                                  get    =&gt; Get},
<a name="24034"/>24034:                    ok = api_opt_tcp_congestion_tcp(InitState)
<a name="24035"/>24035:            end).
<a name="24036"/>24036: 
<a name="24037"/>24037: 
<a name="24038"/>24038: 
<a name="24039"/>24039: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24040"/>24040: 
<a name="api_opt_tcp_congestion_tcp-1"/><a name="24041"/>24041: <b>api_opt_tcp_congestion_tcp</b>(InitState) -&gt;
<a name="24042"/>24042:     process_flag(trap_exit, true),
<a name="24043"/>24043:     ServerSeq =
<a name="24044"/>24044:         [
<a name="24045"/>24045:          %% *** Wait for start order ***
<a name="24046"/>24046:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="24047"/>24047:            cmd  =&gt; fun(State) -&gt;
<a name="24048"/>24048:                            Tester = ?SEV_AWAIT_START(),
<a name="24049"/>24049:                            {ok, State#{tester =&gt; Tester}}
<a name="24050"/>24050:                    end},
<a name="24051"/>24051:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="24052"/>24052:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24053"/>24053:                            _MRef = erlang:monitor(process, Tester),
<a name="24054"/>24054:                            ok
<a name="24055"/>24055:                    end},
<a name="24056"/>24056: 
<a name="24057"/>24057:          %% *** Init part ***
<a name="24058"/>24058:          #{desc =&gt; &quot;which local address&quot;,
<a name="24059"/>24059:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24060"/>24060:                            LSA = which_local_socket_addr(Domain),
<a name="24061"/>24061:                            {ok, State#{lsa =&gt; LSA}}
<a name="24062"/>24062:                    end},
<a name="24063"/>24063:          #{desc =&gt; &quot;create socket&quot;,
<a name="24064"/>24064:            cmd  =&gt; fun(#{domain := Domain,
<a name="24065"/>24065:                          proto  := Proto} = State) -&gt;
<a name="24066"/>24066:                            case socket:open(Domain, stream, Proto) of
<a name="24067"/>24067:                                {ok, Sock} -&gt;
<a name="24068"/>24068:                                    {ok, State#{sock =&gt; Sock}};
<a name="24069"/>24069:                                {error, _} = ERROR -&gt;
<a name="24070"/>24070:                                    ERROR
<a name="24071"/>24071:                            end
<a name="24072"/>24072:                    end},
<a name="24073"/>24073:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24074"/>24074:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24075"/>24075:                            case sock_bind(LSock, LSA) of
<a name="24076"/>24076:                                ok -&gt;
<a name="24077"/>24077:                                    Port = sock_port(LSock),
<a name="24078"/>24078:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24079"/>24079:                                    ok;
<a name="24080"/>24080:                                {error, _} = ERROR -&gt;
<a name="24081"/>24081:                                    ERROR
<a name="24082"/>24082:                            end
<a name="24083"/>24083:                    end},
<a name="24084"/>24084:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="24085"/>24085:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24086"/>24086:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="24087"/>24087:                            ok
<a name="24088"/>24088:                    end},
<a name="24089"/>24089: 
<a name="24090"/>24090: 
<a name="24091"/>24091:          %% The actual test
<a name="24092"/>24092:          #{desc =&gt; &quot;await continue (get congestion)&quot;,
<a name="24093"/>24093:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24094"/>24094:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_congestion)
<a name="24095"/>24095:                    end},
<a name="24096"/>24096:          #{desc =&gt; &quot;get congestion&quot;,
<a name="24097"/>24097:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="24098"/>24098:                            case Get(Sock) of
<a name="24099"/>24099:                                {ok, Algorithm} -&gt;
<a name="24100"/>24100:                                    ?SEV_IPRINT(&quot;algorithm: ~s&quot;, [Algorithm]),
<a name="24101"/>24101:                                    {ok, State#{alg =&gt; Algorithm}};
<a name="24102"/>24102:                                {error, _} = ERROR -&gt;
<a name="24103"/>24103:                                    ERROR
<a name="24104"/>24104:                            end
<a name="24105"/>24105:                    end},
<a name="24106"/>24106:          #{desc =&gt; &quot;announce ready (get congestion)&quot;,
<a name="24107"/>24107:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24108"/>24108:                            ?SEV_ANNOUNCE_READY(Tester, get_congestion),
<a name="24109"/>24109:                            ok
<a name="24110"/>24110:                    end},
<a name="24111"/>24111: 
<a name="24112"/>24112: 
<a name="24113"/>24113:          %% *** Termination ***
<a name="24114"/>24114:          #{desc =&gt; &quot;await terminate&quot;,
<a name="24115"/>24115:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="24116"/>24116:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="24117"/>24117:                                ok -&gt;
<a name="24118"/>24118:                                    {ok, maps:remove(tester, State)};
<a name="24119"/>24119:                                {error, _} = ERROR -&gt;
<a name="24120"/>24120:                                    ERROR
<a name="24121"/>24121:                            end
<a name="24122"/>24122:                    end},
<a name="24123"/>24123:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24124"/>24124:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24125"/>24125:                            ok = socket:close(Sock),
<a name="24126"/>24126:                            {ok, maps:remove(sock, State)}
<a name="24127"/>24127:                    end},
<a name="24128"/>24128: 
<a name="24129"/>24129:          %% *** We are done ***
<a name="24130"/>24130:          ?SEV_FINISH_NORMAL
<a name="24131"/>24131:         ],
<a name="24132"/>24132: 
<a name="24133"/>24133: 
<a name="24134"/>24134:     TesterSeq =
<a name="24135"/>24135:         [
<a name="24136"/>24136:          %% *** Init part ***
<a name="24137"/>24137:          #{desc =&gt; &quot;monitor server&quot;,
<a name="24138"/>24138:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24139"/>24139:                            _MRef = erlang:monitor(process, Pid),
<a name="24140"/>24140:                            ok
<a name="24141"/>24141:                    end},
<a name="24142"/>24142: 
<a name="24143"/>24143:          %% Start the server
<a name="24144"/>24144:          #{desc =&gt; &quot;order server start&quot;,
<a name="24145"/>24145:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24146"/>24146:                            ?SEV_ANNOUNCE_START(Pid),
<a name="24147"/>24147:                            ok
<a name="24148"/>24148:                    end},
<a name="24149"/>24149:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="24150"/>24150:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24151"/>24151:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="24152"/>24152:                            ok
<a name="24153"/>24153:                    end},
<a name="24154"/>24154: 
<a name="24155"/>24155:          %% *** The actual test ***
<a name="24156"/>24156:          #{desc =&gt; &quot;order server to continue (with get-congestion)&quot;,
<a name="24157"/>24157:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24158"/>24158:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_congestion),
<a name="24159"/>24159:                            ok
<a name="24160"/>24160:                    end},
<a name="24161"/>24161:          #{desc =&gt; &quot;await server ready (get-congestion)&quot;,
<a name="24162"/>24162:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24163"/>24163:                            ?SEV_AWAIT_READY(Server, server, get_congestion)
<a name="24164"/>24164:                    end},
<a name="24165"/>24165: 
<a name="24166"/>24166: 
<a name="24167"/>24167:          %% *** Termination ***
<a name="24168"/>24168:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="24169"/>24169:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24170"/>24170:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="24171"/>24171:                            ok
<a name="24172"/>24172:                    end},
<a name="24173"/>24173:          #{desc =&gt; &quot;await server termination&quot;,
<a name="24174"/>24174:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="24175"/>24175:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="24176"/>24176:                            State1 = maps:remove(server, State),
<a name="24177"/>24177:                            {ok, State1}
<a name="24178"/>24178:                    end},
<a name="24179"/>24179: 
<a name="24180"/>24180:          %% *** We are done ***
<a name="24181"/>24181:          ?SEV_FINISH_NORMAL
<a name="24182"/>24182:         ],
<a name="24183"/>24183: 
<a name="24184"/>24184: 
<a name="24185"/>24185:     i(&quot;start server evaluator&quot;),
<a name="24186"/>24186:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="24187"/>24187: 
<a name="24188"/>24188:     i(&quot;start tester evaluator&quot;),
<a name="24189"/>24189:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="24190"/>24190:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="24191"/>24191: 
<a name="api_opt_tcp_congestion_tcp-last_expr"/><a name="24192"/>24192: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="24193"/>24193: 
<a name="24194"/>24194: 
<a name="24195"/>24195: 
<a name="24196"/>24196: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24197"/>24197: 
<a name="24198"/>24198: <i>%% Tests that the cork tcp socket option.</i>
<a name="24199"/>24199: <i>%%</i>
<a name="24200"/>24200: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="24201"/>24201: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="24202"/>24202: <i>%%</i>
<a name="24203"/>24203: <i>%% Reading the man page it seems like (on linux) that the</i>
<a name="24204"/>24204: <i>%% value resets itself after some (short) time...</i>
<a name="24205"/>24205: 
<a name="api_opt_tcp_cork_tcp4-1"/><a name="24206"/>24206: <b>api_opt_tcp_cork_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24207"/>24207:     ?TT(?SECS(5)),
<a name="api_opt_tcp_cork_tcp4-last_expr"/><a name="24208"/>24208: <b>    tc_try</b>(api_opt_tcp_cork_tcp4,
<a name="24209"/>24209:            fun() -&gt; has_support_ipv4(), has_support_tcp_cork() end,
<a name="24210"/>24210:            fun() -&gt;
<a name="24211"/>24211:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="24212"/>24212:                                   socket:setopt(Sock, tcp, cork, Value)
<a name="24213"/>24213:                           end,
<a name="24214"/>24214:                    Get  = fun(Sock) -&gt;
<a name="24215"/>24215:                                   socket:getopt(Sock, tcp, cork)
<a name="24216"/>24216:                           end,
<a name="24217"/>24217:                    InitState = #{domain =&gt; inet,
<a name="24218"/>24218:                                  proto  =&gt; tcp,
<a name="24219"/>24219:                                  set    =&gt; Set,
<a name="24220"/>24220:                                  get    =&gt; Get},
<a name="24221"/>24221:                    ok = api_opt_tcp_cork_tcp(InitState)
<a name="24222"/>24222:            end).
<a name="24223"/>24223: 
<a name="24224"/>24224: 
<a name="24225"/>24225: 
<a name="24226"/>24226: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24227"/>24227: 
<a name="api_opt_tcp_cork_tcp-1"/><a name="24228"/>24228: <b>api_opt_tcp_cork_tcp</b>(InitState) -&gt;
<a name="24229"/>24229:     process_flag(trap_exit, true),
<a name="24230"/>24230:     TesterSeq =
<a name="24231"/>24231:         [
<a name="24232"/>24232:          %% *** Init part ***
<a name="24233"/>24233:          #{desc =&gt; &quot;which local address&quot;,
<a name="24234"/>24234:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24235"/>24235:                            LSA = which_local_socket_addr(Domain),
<a name="24236"/>24236:                            {ok, State#{lsa =&gt; LSA}}
<a name="24237"/>24237:                    end},
<a name="24238"/>24238:          #{desc =&gt; &quot;create socket&quot;,
<a name="24239"/>24239:            cmd  =&gt; fun(#{domain := Domain,
<a name="24240"/>24240:                          proto  := Proto} = State) -&gt;
<a name="24241"/>24241:                            case socket:open(Domain, stream, Proto) of
<a name="24242"/>24242:                                {ok, Sock} -&gt;
<a name="24243"/>24243:                                    {ok, State#{sock =&gt; Sock}};
<a name="24244"/>24244:                                {error, _} = ERROR -&gt;
<a name="24245"/>24245:                                    ERROR
<a name="24246"/>24246:                            end
<a name="24247"/>24247:                    end},
<a name="24248"/>24248:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24249"/>24249:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24250"/>24250:                            case sock_bind(LSock, LSA) of
<a name="24251"/>24251:                                ok -&gt;
<a name="24252"/>24252:                                    Port = sock_port(LSock),
<a name="24253"/>24253:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24254"/>24254:                                    ok;
<a name="24255"/>24255:                                {error, _} = ERROR -&gt;
<a name="24256"/>24256:                                    ERROR
<a name="24257"/>24257:                            end
<a name="24258"/>24258:                    end},
<a name="24259"/>24259: 
<a name="24260"/>24260: 
<a name="24261"/>24261:          %% The actual test
<a name="24262"/>24262:          #{desc =&gt; &quot;get (default) cork (= false)&quot;,
<a name="24263"/>24263:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="24264"/>24264:                            case Get(Sock) of
<a name="24265"/>24265:                                {ok, false = Value} -&gt;
<a name="24266"/>24266:                                    ?SEV_IPRINT(&quot;cork default: ~p&quot;, [Value]),
<a name="24267"/>24267:                                    ok;
<a name="24268"/>24268:                                {error, _} = ERROR -&gt;
<a name="24269"/>24269:                                    ERROR
<a name="24270"/>24270:                            end
<a name="24271"/>24271:                    end},
<a name="24272"/>24272:          #{desc =&gt; &quot;enable cork (=&gt; true)&quot;,
<a name="24273"/>24273:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="24274"/>24274:                            case Set(Sock, true) of
<a name="24275"/>24275:                                ok -&gt;
<a name="24276"/>24276:                                    ?SEV_IPRINT(&quot;cork enabled&quot;),
<a name="24277"/>24277:                                    ok;
<a name="24278"/>24278:                                {error, _} = ERROR -&gt;
<a name="24279"/>24279:                                    ERROR
<a name="24280"/>24280:                            end
<a name="24281"/>24281:                    end},
<a name="24282"/>24282:          #{desc =&gt; &quot;get cork (= true)&quot;,
<a name="24283"/>24283:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="24284"/>24284:                            case Get(Sock) of
<a name="24285"/>24285:                                {ok, true = Value} -&gt;
<a name="24286"/>24286:                                    ?SEV_IPRINT(&quot;cork: ~p&quot;, [Value]),
<a name="24287"/>24287:                                    ok;
<a name="24288"/>24288:                                {error, _} = ERROR -&gt;
<a name="24289"/>24289:                                    ERROR
<a name="24290"/>24290:                            end
<a name="24291"/>24291:                    end},
<a name="24292"/>24292: 
<a name="24293"/>24293: 
<a name="24294"/>24294:          %% *** Termination ***
<a name="24295"/>24295:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24296"/>24296:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24297"/>24297:                            ok = socket:close(Sock),
<a name="24298"/>24298:                            {ok, maps:remove(sock, State)}
<a name="24299"/>24299:                    end},
<a name="24300"/>24300: 
<a name="24301"/>24301:          %% *** We are done ***
<a name="24302"/>24302:          ?SEV_FINISH_NORMAL
<a name="24303"/>24303:         ],
<a name="24304"/>24304: 
<a name="24305"/>24305:     i(&quot;start tester evaluator&quot;),
<a name="24306"/>24306:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="24307"/>24307: 
<a name="api_opt_tcp_cork_tcp-last_expr"/><a name="24308"/>24308: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="24309"/>24309: 
<a name="24310"/>24310: 
<a name="24311"/>24311: 
<a name="24312"/>24312: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24313"/>24313: 
<a name="24314"/>24314: <i>%% Tests that the maxseg tcp socket option.</i>
<a name="24315"/>24315: <i>%%</i>
<a name="24316"/>24316: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="24317"/>24317: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="24318"/>24318: <i>%%</i>
<a name="24319"/>24319: <i>%% Note that there is no point in reading this value back,</i>
<a name="24320"/>24320: <i>%% since the kernel imposes its own rules with regard</i>
<a name="24321"/>24321: <i>%% to what is an acceptable value.</i>
<a name="24322"/>24322: <i>%%</i>
<a name="24323"/>24323: 
<a name="api_opt_tcp_maxseg_tcp4-1"/><a name="24324"/>24324: <b>api_opt_tcp_maxseg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24325"/>24325:     ?TT(?SECS(5)),
<a name="api_opt_tcp_maxseg_tcp4-last_expr"/><a name="24326"/>24326: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="24327"/>24327:            fun() -&gt;
<a name="24328"/>24328:                    has_support_ipv4(),
<a name="24329"/>24329:                    has_support_tcp_maxseg()
<a name="24330"/>24330:            end,
<a name="24331"/>24331:            fun() -&gt;
<a name="24332"/>24332:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="24333"/>24333:                                   socket:setopt(Sock, tcp, maxseg, Value)
<a name="24334"/>24334:                           end,
<a name="24335"/>24335:                    Get  = fun(Sock) -&gt;
<a name="24336"/>24336:                                   socket:getopt(Sock, tcp, maxseg)
<a name="24337"/>24337:                           end,
<a name="24338"/>24338:                    InitState = #{domain =&gt; inet,
<a name="24339"/>24339:                                  proto  =&gt; tcp,
<a name="24340"/>24340:                                  set    =&gt; Set,
<a name="24341"/>24341:                                  get    =&gt; Get},
<a name="24342"/>24342:                    ok = api_opt_tcp_maxseg_tcp(InitState)
<a name="24343"/>24343:            end).
<a name="24344"/>24344: 
<a name="24345"/>24345: 
<a name="24346"/>24346: 
<a name="24347"/>24347: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24348"/>24348: 
<a name="api_opt_tcp_maxseg_tcp-1"/><a name="24349"/>24349: <b>api_opt_tcp_maxseg_tcp</b>(InitState) -&gt;
<a name="24350"/>24350:     process_flag(trap_exit, true),
<a name="24351"/>24351:     TesterSeq =
<a name="24352"/>24352:         [
<a name="24353"/>24353:          %% *** Init part ***
<a name="24354"/>24354:          #{desc =&gt; &quot;which local address&quot;,
<a name="24355"/>24355:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24356"/>24356:                            LSA = which_local_socket_addr(Domain),
<a name="24357"/>24357:                            {ok, State#{lsa =&gt; LSA}}
<a name="24358"/>24358:                    end},
<a name="24359"/>24359:          #{desc =&gt; &quot;create socket&quot;,
<a name="24360"/>24360:            cmd  =&gt; fun(#{domain := Domain,
<a name="24361"/>24361:                          proto  := Proto} = State) -&gt;
<a name="24362"/>24362:                            case socket:open(Domain, stream, Proto) of
<a name="24363"/>24363:                                {ok, Sock} -&gt;
<a name="24364"/>24364:                                    {ok, State#{sock =&gt; Sock}};
<a name="24365"/>24365:                                {error, _} = ERROR -&gt;
<a name="24366"/>24366:                                    ERROR
<a name="24367"/>24367:                            end
<a name="24368"/>24368:                    end},
<a name="24369"/>24369:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24370"/>24370:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24371"/>24371:                            case sock_bind(LSock, LSA) of
<a name="24372"/>24372:                                ok -&gt;
<a name="24373"/>24373:                                    Port = sock_port(LSock),
<a name="24374"/>24374:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24375"/>24375:                                    ok;
<a name="24376"/>24376:                                {error, _} = ERROR -&gt;
<a name="24377"/>24377:                                    ERROR
<a name="24378"/>24378:                            end
<a name="24379"/>24379:                    end},
<a name="24380"/>24380: 
<a name="24381"/>24381: 
<a name="24382"/>24382:          %% The actual test
<a name="24383"/>24383:          #{desc =&gt; &quot;get (default) maxseg&quot;,
<a name="24384"/>24384:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="24385"/>24385:                            case Get(Sock) of
<a name="24386"/>24386:                                {ok, DefMaxSeg} -&gt;
<a name="24387"/>24387:                                    ?SEV_IPRINT(&quot;maxseg default: ~p&quot;, [DefMaxSeg]),
<a name="24388"/>24388:                                    {ok, State#{def_maxseg =&gt; DefMaxSeg}};
<a name="24389"/>24389:                                {error, enoprotoopt = Reason} -&gt;
<a name="24390"/>24390:                                    {skip, Reason};
<a name="24391"/>24391:                                {error, _} = ERROR -&gt;
<a name="24392"/>24392:                                    ERROR
<a name="24393"/>24393:                            end
<a name="24394"/>24394:                    end},
<a name="24395"/>24395:          
<a name="24396"/>24396:          %% Note that there is no point in reading this value back,
<a name="24397"/>24397:          %% since the kernel imposes its own rules with regard
<a name="24398"/>24398:          %% to what is an acceptable value.
<a name="24399"/>24399:          %% So, even if the set operation is a success, the value
<a name="24400"/>24400:          %% still might not have changed.
<a name="24401"/>24401:          %%
<a name="24402"/>24402:          %% Note that not all platforms allow this to be set!
<a name="24403"/>24403:          %% Since this is the *last* operation in the test sequence
<a name="24404"/>24404:          %% (before termination) we also accept error reason = einval
<a name="24405"/>24405:          %% as success (rather then skip).
<a name="24406"/>24406:          %% The same goes for the error reason = enoprotoopt (Solaris).
<a name="24407"/>24407:          #{desc =&gt; &quot;(maybe) change maxseg (default + 16)&quot;,
<a name="24408"/>24408:            cmd  =&gt; fun(#{sock       := Sock,
<a name="24409"/>24409:                          set        := Set,
<a name="24410"/>24410:                          def_maxseg := DefMaxSeg} = _State) -&gt;
<a name="24411"/>24411:                            NewMaxSeg = DefMaxSeg + 16,
<a name="24412"/>24412:                            case Set(Sock, NewMaxSeg) of
<a name="24413"/>24413:                                ok -&gt;
<a name="24414"/>24414:                                    ?SEV_IPRINT(&quot;maxseg (maybe) changed (to ~w)&quot;,
<a name="24415"/>24415:                                                [NewMaxSeg]),
<a name="24416"/>24416:                                    ok;
<a name="24417"/>24417:                                {error, Reason} when (Reason =:= einval) orelse
<a name="24418"/>24418:                                                     (Reason =:= enoprotoopt) -&gt;
<a name="24419"/>24419:                                    ?SEV_IPRINT(&quot;change not allowed (~w)&quot;,
<a name="24420"/>24420:                                                [Reason]),
<a name="24421"/>24421:                                    ok;
<a name="24422"/>24422:                                {error, _} = ERROR -&gt;
<a name="24423"/>24423:                                    ERROR
<a name="24424"/>24424:                            end
<a name="24425"/>24425:                    end},
<a name="24426"/>24426: 
<a name="24427"/>24427:          %% *** Termination ***
<a name="24428"/>24428:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24429"/>24429:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24430"/>24430:                            ok = socket:close(Sock),
<a name="24431"/>24431:                            {ok, maps:remove(sock, State)}
<a name="24432"/>24432:                    end},
<a name="24433"/>24433: 
<a name="24434"/>24434:          %% *** We are done ***
<a name="24435"/>24435:          ?SEV_FINISH_NORMAL
<a name="24436"/>24436:         ],
<a name="24437"/>24437: 
<a name="24438"/>24438:     i(&quot;start tester evaluator&quot;),
<a name="24439"/>24439:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="24440"/>24440: 
<a name="api_opt_tcp_maxseg_tcp-last_expr"/><a name="24441"/>24441: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="24442"/>24442: 
<a name="24443"/>24443: 
<a name="24444"/>24444: 
<a name="24445"/>24445: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24446"/>24446: 
<a name="24447"/>24447: <i>%% Tests that the nodelay tcp socket option.</i>
<a name="24448"/>24448: <i>%%</i>
<a name="24449"/>24449: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="24450"/>24450: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="24451"/>24451: 
<a name="api_opt_tcp_nodelay_tcp4-1"/><a name="24452"/>24452: <b>api_opt_tcp_nodelay_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24453"/>24453:     ?TT(?SECS(5)),
<a name="api_opt_tcp_nodelay_tcp4-last_expr"/><a name="24454"/>24454: <b>    tc_try</b>(api_opt_tcp_nodelay_tcp4,
<a name="24455"/>24455:            fun() -&gt; has_support_ipv4(), has_support_tcp_nodelay() end,
<a name="24456"/>24456:            fun() -&gt;
<a name="24457"/>24457:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="24458"/>24458:                                   socket:setopt(Sock, tcp, nodelay, Value)
<a name="24459"/>24459:                           end,
<a name="24460"/>24460:                    Get  = fun(Sock) -&gt;
<a name="24461"/>24461:                                   socket:getopt(Sock, tcp, nodelay)
<a name="24462"/>24462:                           end,
<a name="24463"/>24463:                    InitState = #{domain =&gt; inet,
<a name="24464"/>24464:                                  proto  =&gt; tcp,
<a name="24465"/>24465:                                  set    =&gt; Set,
<a name="24466"/>24466:                                  get    =&gt; Get},
<a name="24467"/>24467:                    ok = api_opt_tcp_nodelay_tcp(InitState)
<a name="24468"/>24468:            end).
<a name="24469"/>24469: 
<a name="24470"/>24470: 
<a name="24471"/>24471: 
<a name="24472"/>24472: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24473"/>24473: 
<a name="api_opt_tcp_nodelay_tcp-1"/><a name="24474"/>24474: <b>api_opt_tcp_nodelay_tcp</b>(InitState) -&gt;
<a name="24475"/>24475:     process_flag(trap_exit, true),
<a name="24476"/>24476:     TesterSeq =
<a name="24477"/>24477:         [
<a name="24478"/>24478:          %% *** Init part ***
<a name="24479"/>24479:          #{desc =&gt; &quot;which local address&quot;,
<a name="24480"/>24480:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24481"/>24481:                            LSA = which_local_socket_addr(Domain),
<a name="24482"/>24482:                            {ok, State#{lsa =&gt; LSA}}
<a name="24483"/>24483:                    end},
<a name="24484"/>24484:          #{desc =&gt; &quot;create socket&quot;,
<a name="24485"/>24485:            cmd  =&gt; fun(#{domain := Domain,
<a name="24486"/>24486:                          proto  := Proto} = State) -&gt;
<a name="24487"/>24487:                            case socket:open(Domain, stream, Proto) of
<a name="24488"/>24488:                                {ok, Sock} -&gt;
<a name="24489"/>24489:                                    {ok, State#{sock =&gt; Sock}};
<a name="24490"/>24490:                                {error, _} = ERROR -&gt;
<a name="24491"/>24491:                                    ERROR
<a name="24492"/>24492:                            end
<a name="24493"/>24493:                    end},
<a name="24494"/>24494:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24495"/>24495:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="24496"/>24496:                            case sock_bind(Sock, LSA) of
<a name="24497"/>24497:                                ok -&gt;
<a name="24498"/>24498:                                    Port = sock_port(Sock),
<a name="24499"/>24499:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24500"/>24500:                                    ok;
<a name="24501"/>24501:                                {error, _} = ERROR -&gt;
<a name="24502"/>24502:                                    ERROR
<a name="24503"/>24503:                            end
<a name="24504"/>24504:                    end},
<a name="24505"/>24505: 
<a name="24506"/>24506: 
<a name="24507"/>24507:          %% The actual test
<a name="24508"/>24508:          #{desc =&gt; &quot;get (default) nodelay (= false)&quot;,
<a name="24509"/>24509:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="24510"/>24510:                            case Get(Sock) of
<a name="24511"/>24511:                                {ok, false = Value} -&gt;
<a name="24512"/>24512:                                    ?SEV_IPRINT(&quot;nodelay default: ~p&quot;, [Value]),
<a name="24513"/>24513:                                    ok;
<a name="24514"/>24514:                                {error, _} = ERROR -&gt;
<a name="24515"/>24515:                                    ERROR
<a name="24516"/>24516:                            end
<a name="24517"/>24517:                    end},
<a name="24518"/>24518:          #{desc =&gt; &quot;enable nodelay (=&gt; true)&quot;,
<a name="24519"/>24519:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="24520"/>24520:                            case Set(Sock, true) of
<a name="24521"/>24521:                                ok -&gt;
<a name="24522"/>24522:                                    ?SEV_IPRINT(&quot;nodelay enabled&quot;),
<a name="24523"/>24523:                                    ok;
<a name="24524"/>24524:                                {error, _} = ERROR -&gt;
<a name="24525"/>24525:                                    ERROR
<a name="24526"/>24526:                            end
<a name="24527"/>24527:                    end},
<a name="24528"/>24528:          #{desc =&gt; &quot;get nodelay (= true)&quot;,
<a name="24529"/>24529:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="24530"/>24530:                            case Get(Sock) of
<a name="24531"/>24531:                                {ok, true = Value} -&gt;
<a name="24532"/>24532:                                    ?SEV_IPRINT(&quot;nodelay: ~p&quot;, [Value]),
<a name="24533"/>24533:                                    ok;
<a name="24534"/>24534:                                {error, _} = ERROR -&gt;
<a name="24535"/>24535:                                    ERROR
<a name="24536"/>24536:                            end
<a name="24537"/>24537:                    end},
<a name="24538"/>24538: 
<a name="24539"/>24539: 
<a name="24540"/>24540:          %% *** Termination ***
<a name="24541"/>24541:          #{desc =&gt; &quot;close socket&quot;,
<a name="24542"/>24542:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24543"/>24543:                            ok = socket:close(Sock),
<a name="24544"/>24544:                            {ok, maps:remove(sock, State)}
<a name="24545"/>24545:                    end},
<a name="24546"/>24546: 
<a name="24547"/>24547:          %% *** We are done ***
<a name="24548"/>24548:          ?SEV_FINISH_NORMAL
<a name="24549"/>24549:         ],
<a name="24550"/>24550: 
<a name="24551"/>24551:     i(&quot;start tester evaluator&quot;),
<a name="24552"/>24552:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="24553"/>24553: 
<a name="api_opt_tcp_nodelay_tcp-last_expr"/><a name="24554"/>24554: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="24555"/>24555: 
<a name="24556"/>24556: 
<a name="24557"/>24557: 
<a name="24558"/>24558: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24559"/>24559: 
<a name="24560"/>24560: <i>%% Tests that the keepcnt tcp socket option.</i>
<a name="24561"/>24561: <i>%%</i>
<a name="24562"/>24562: <i>%% &quot;The maximum number of keepalive probes TCP should send before</i>
<a name="24563"/>24563: <i>%%  dropping the connection&quot;</i>
<a name="24564"/>24564: <i>%%</i>
<a name="24565"/>24565: 
<a name="api_opt_tcp_keepcnt_tcp4-1"/><a name="24566"/>24566: <b>api_opt_tcp_keepcnt_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24567"/>24567:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepcnt_tcp4-last_expr"/><a name="24568"/>24568: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="24569"/>24569:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepcnt() end,
<a name="24570"/>24570:            fun() -&gt;
<a name="24571"/>24571:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="24572"/>24572:                                   socket:setopt(Sock, tcp, keepcnt, Value)
<a name="24573"/>24573:                           end,
<a name="24574"/>24574:                    Get  = fun(Sock) -&gt;
<a name="24575"/>24575:                                   socket:getopt(Sock, tcp, keepcnt)
<a name="24576"/>24576:                           end,
<a name="24577"/>24577:                    InitState = #{domain =&gt; inet,
<a name="24578"/>24578:                                  proto  =&gt; tcp,
<a name="24579"/>24579:                                  set    =&gt; Set,
<a name="24580"/>24580:                                  get    =&gt; Get},
<a name="24581"/>24581:                    ok = api_opt_tcp_keepcnt_tcp(InitState)
<a name="24582"/>24582:            end).
<a name="24583"/>24583: 
<a name="24584"/>24584: 
<a name="24585"/>24585: 
<a name="24586"/>24586: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24587"/>24587: 
<a name="api_opt_tcp_keepcnt_tcp-1"/><a name="24588"/>24588: <b>api_opt_tcp_keepcnt_tcp</b>(InitState) -&gt;
<a name="24589"/>24589:     process_flag(trap_exit, true),
<a name="24590"/>24590:     ServerSeq =
<a name="24591"/>24591:         [
<a name="24592"/>24592:          %% *** Wait for start order ***
<a name="24593"/>24593:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="24594"/>24594:            cmd  =&gt; fun(State) -&gt;
<a name="24595"/>24595:                            Tester = ?SEV_AWAIT_START(),
<a name="24596"/>24596:                            {ok, State#{tester =&gt; Tester}}
<a name="24597"/>24597:                    end},
<a name="24598"/>24598:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="24599"/>24599:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24600"/>24600:                            _MRef = erlang:monitor(process, Tester),
<a name="24601"/>24601:                            ok
<a name="24602"/>24602:                    end},
<a name="24603"/>24603: 
<a name="24604"/>24604:          %% *** Init part ***
<a name="24605"/>24605:          #{desc =&gt; &quot;which local address&quot;,
<a name="24606"/>24606:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24607"/>24607:                            LSA = which_local_socket_addr(Domain),
<a name="24608"/>24608:                            {ok, State#{lsa =&gt; LSA}}
<a name="24609"/>24609:                    end},
<a name="24610"/>24610:          #{desc =&gt; &quot;create socket&quot;,
<a name="24611"/>24611:            cmd  =&gt; fun(#{domain := Domain,
<a name="24612"/>24612:                          proto  := Proto} = State) -&gt;
<a name="24613"/>24613:                            case socket:open(Domain, stream, Proto) of
<a name="24614"/>24614:                                {ok, Sock} -&gt;
<a name="24615"/>24615:                                    {ok, State#{sock =&gt; Sock}};
<a name="24616"/>24616:                                {error, _} = ERROR -&gt;
<a name="24617"/>24617:                                    ERROR
<a name="24618"/>24618:                            end
<a name="24619"/>24619:                    end},
<a name="24620"/>24620:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24621"/>24621:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24622"/>24622:                            case sock_bind(LSock, LSA) of
<a name="24623"/>24623:                                ok -&gt;
<a name="24624"/>24624:                                    Port = sock_port(LSock),
<a name="24625"/>24625:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24626"/>24626:                                    ok;
<a name="24627"/>24627:                                {error, _} = ERROR -&gt;
<a name="24628"/>24628:                                    ERROR
<a name="24629"/>24629:                            end
<a name="24630"/>24630:                    end},
<a name="24631"/>24631:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="24632"/>24632:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24633"/>24633:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="24634"/>24634:                            ok
<a name="24635"/>24635:                    end},
<a name="24636"/>24636: 
<a name="24637"/>24637: 
<a name="24638"/>24638:          %% The actual test
<a name="24639"/>24639:          #{desc =&gt; &quot;await continue (get keepcnt(1))&quot;,
<a name="24640"/>24640:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24641"/>24641:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepcnt)
<a name="24642"/>24642:                    end},
<a name="24643"/>24643:          #{desc =&gt; &quot;get keepcnt&quot;,
<a name="24644"/>24644:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="24645"/>24645:                            case Get(Sock) of
<a name="24646"/>24646:                                {ok, KeepCnt} -&gt;
<a name="24647"/>24647:                                    ?SEV_IPRINT(&quot;keepcnt: ~p&quot;, [KeepCnt]),
<a name="24648"/>24648:                                    {ok, State#{keepcnt =&gt; KeepCnt}};
<a name="24649"/>24649:                                {error, _} = ERROR -&gt;
<a name="24650"/>24650:                                    ERROR
<a name="24651"/>24651:                            end
<a name="24652"/>24652:                    end},
<a name="24653"/>24653:          #{desc =&gt; &quot;announce ready (get keepcnt(1))&quot;,
<a name="24654"/>24654:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24655"/>24655:                            ?SEV_ANNOUNCE_READY(Tester, get_keepcnt),
<a name="24656"/>24656:                            ok
<a name="24657"/>24657:                    end},
<a name="24658"/>24658: 
<a name="24659"/>24659: 
<a name="24660"/>24660:          #{desc =&gt; &quot;await continue (set keepcnt)&quot;,
<a name="24661"/>24661:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24662"/>24662:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepcnt)
<a name="24663"/>24663:                    end},
<a name="24664"/>24664:          #{desc =&gt; &quot;set keepcnt&quot;,
<a name="24665"/>24665:            cmd  =&gt; fun(#{sock    := Sock,
<a name="24666"/>24666:                          set     := Set,
<a name="24667"/>24667:                          keepcnt := KeepCnt} = State) -&gt;
<a name="24668"/>24668:                            NewKeepCnt =
<a name="24669"/>24669:                                if
<a name="24670"/>24670:                                    (KeepCnt &gt;= 255) -&gt;
<a name="24671"/>24671:                                        KeepCnt - 1;
<a name="24672"/>24672:                                    true -&gt;
<a name="24673"/>24673:                                        KeepCnt + 1
<a name="24674"/>24674:                                end,
<a name="24675"/>24675:                            case Set(Sock, NewKeepCnt) of
<a name="24676"/>24676:                                ok -&gt;
<a name="24677"/>24677:                                    ?SEV_IPRINT(&quot;keepcnt updated (to ~p)&quot;,
<a name="24678"/>24678:                                                [NewKeepCnt]),
<a name="24679"/>24679:                                    {ok, State#{keepcnt =&gt; NewKeepCnt}};
<a name="24680"/>24680:                                {error, _} = ERROR -&gt;
<a name="24681"/>24681:                                    ERROR
<a name="24682"/>24682:                            end
<a name="24683"/>24683:                    end},
<a name="24684"/>24684:          #{desc =&gt; &quot;announce ready (set keepcnt)&quot;,
<a name="24685"/>24685:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24686"/>24686:                            ?SEV_ANNOUNCE_READY(Tester, set_keepcnt),
<a name="24687"/>24687:                            ok
<a name="24688"/>24688:                    end},
<a name="24689"/>24689: 
<a name="24690"/>24690: 
<a name="24691"/>24691:          #{desc =&gt; &quot;await continue (get keepcnt(2))&quot;,
<a name="24692"/>24692:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24693"/>24693:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepcnt)
<a name="24694"/>24694:                    end},
<a name="24695"/>24695:          #{desc =&gt; &quot;get keepcnt(2)&quot;,
<a name="24696"/>24696:            cmd  =&gt; fun(#{sock    := Sock,
<a name="24697"/>24697:                          get     := Get,
<a name="24698"/>24698:                          keepcnt := ExpKeepCnt} = _State) -&gt;
<a name="24699"/>24699:                            case Get(Sock) of
<a name="24700"/>24700:                                {ok, KeepCnt} when (ExpKeepCnt =:= KeepCnt) -&gt;
<a name="24701"/>24701:                                    ?SEV_IPRINT(&quot;expected keepcnt (~p)&quot;,
<a name="24702"/>24702:                                                [ExpKeepCnt]),
<a name="24703"/>24703:                                    ok;
<a name="24704"/>24704:                                {ok, KeepCnt} -&gt;
<a name="24705"/>24705:                                    ?SEV_EPRINT(&quot;unexpected keepcnt:&quot;
<a name="24706"/>24706:                                                &quot;~n   Expected KeepCnt: ~p&quot;
<a name="24707"/>24707:                                                &quot;~n   Actual KeepCnt:   ~p&quot;,
<a name="24708"/>24708:                                                [ExpKeepCnt, KeepCnt]),
<a name="24709"/>24709:                                    {error,
<a name="24710"/>24710:                                     {unexpected_keepcnt, ExpKeepCnt, KeepCnt}};
<a name="24711"/>24711:                                {error, Reason} = ERROR -&gt;
<a name="24712"/>24712:                                    ?SEV_EPRINT(&quot;failed get keepcnt: &quot;
<a name="24713"/>24713:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="24714"/>24714:                                    ERROR
<a name="24715"/>24715:                            end
<a name="24716"/>24716:                    end},
<a name="24717"/>24717:          #{desc =&gt; &quot;announce ready (get keepcnt)&quot;,
<a name="24718"/>24718:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24719"/>24719:                            ?SEV_ANNOUNCE_READY(Tester, get_keepcnt),
<a name="24720"/>24720:                            ok
<a name="24721"/>24721:                    end},
<a name="24722"/>24722: 
<a name="24723"/>24723: 
<a name="24724"/>24724:          %% *** Termination ***
<a name="24725"/>24725:          #{desc =&gt; &quot;await terminate&quot;,
<a name="24726"/>24726:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="24727"/>24727:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="24728"/>24728:                                ok -&gt;
<a name="24729"/>24729:                                    {ok, maps:remove(tester, State)};
<a name="24730"/>24730:                                {error, _} = ERROR -&gt;
<a name="24731"/>24731:                                    ERROR
<a name="24732"/>24732:                            end
<a name="24733"/>24733:                    end},
<a name="24734"/>24734:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24735"/>24735:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24736"/>24736:                            ok = socket:close(Sock),
<a name="24737"/>24737:                            {ok, maps:remove(sock, State)}
<a name="24738"/>24738:                    end},
<a name="24739"/>24739: 
<a name="24740"/>24740:          %% *** We are done ***
<a name="24741"/>24741:          ?SEV_FINISH_NORMAL
<a name="24742"/>24742:         ],
<a name="24743"/>24743: 
<a name="24744"/>24744: 
<a name="24745"/>24745:     TesterSeq =
<a name="24746"/>24746:         [
<a name="24747"/>24747:          %% *** Init part ***
<a name="24748"/>24748:          #{desc =&gt; &quot;monitor server&quot;,
<a name="24749"/>24749:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24750"/>24750:                            _MRef = erlang:monitor(process, Pid),
<a name="24751"/>24751:                            ok
<a name="24752"/>24752:                    end},
<a name="24753"/>24753: 
<a name="24754"/>24754:          %% Start the server
<a name="24755"/>24755:          #{desc =&gt; &quot;order server start&quot;,
<a name="24756"/>24756:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24757"/>24757:                            ?SEV_ANNOUNCE_START(Pid),
<a name="24758"/>24758:                            ok
<a name="24759"/>24759:                    end},
<a name="24760"/>24760:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="24761"/>24761:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24762"/>24762:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="24763"/>24763:                            ok
<a name="24764"/>24764:                    end},
<a name="24765"/>24765: 
<a name="24766"/>24766:          %% *** The actual test ***
<a name="24767"/>24767:          #{desc =&gt; &quot;order server to continue (with get-keepcnt(1))&quot;,
<a name="24768"/>24768:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24769"/>24769:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepcnt),
<a name="24770"/>24770:                            ok
<a name="24771"/>24771:                    end},
<a name="24772"/>24772:          #{desc =&gt; &quot;await server ready (get-keepcnt(1))&quot;,
<a name="24773"/>24773:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24774"/>24774:                            ?SEV_AWAIT_READY(Server, server, get_keepcnt)
<a name="24775"/>24775:                    end},
<a name="24776"/>24776: 
<a name="24777"/>24777:          #{desc =&gt; &quot;order server to continue (with set-keepcnt)&quot;,
<a name="24778"/>24778:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24779"/>24779:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepcnt),
<a name="24780"/>24780:                            ok
<a name="24781"/>24781:                    end},
<a name="24782"/>24782:          #{desc =&gt; &quot;await server ready (set-keepcnt)&quot;,
<a name="24783"/>24783:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24784"/>24784:                            ?SEV_AWAIT_READY(Server, server, set_keepcnt)
<a name="24785"/>24785:                    end},
<a name="24786"/>24786: 
<a name="24787"/>24787:          #{desc =&gt; &quot;order server to continue (with get-keepcnt(2))&quot;,
<a name="24788"/>24788:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24789"/>24789:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepcnt),
<a name="24790"/>24790:                            ok
<a name="24791"/>24791:                    end},
<a name="24792"/>24792:          #{desc =&gt; &quot;await server ready (get-keepcnt(2))&quot;,
<a name="24793"/>24793:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24794"/>24794:                            ?SEV_AWAIT_READY(Server, server, get_keepcnt)
<a name="24795"/>24795:                    end},
<a name="24796"/>24796: 
<a name="24797"/>24797: 
<a name="24798"/>24798:          %% *** Termination ***
<a name="24799"/>24799:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="24800"/>24800:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24801"/>24801:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="24802"/>24802:                            ok
<a name="24803"/>24803:                    end},
<a name="24804"/>24804:          #{desc =&gt; &quot;await server termination&quot;,
<a name="24805"/>24805:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="24806"/>24806:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="24807"/>24807:                            State1 = maps:remove(server, State),
<a name="24808"/>24808:                            {ok, State1}
<a name="24809"/>24809:                    end},
<a name="24810"/>24810: 
<a name="24811"/>24811:          %% *** We are done ***
<a name="24812"/>24812:          ?SEV_FINISH_NORMAL
<a name="24813"/>24813:         ],
<a name="24814"/>24814: 
<a name="24815"/>24815: 
<a name="24816"/>24816:     i(&quot;start server evaluator&quot;),
<a name="24817"/>24817:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="24818"/>24818: 
<a name="24819"/>24819:     i(&quot;start tester evaluator&quot;),
<a name="24820"/>24820:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="24821"/>24821:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="24822"/>24822: 
<a name="api_opt_tcp_keepcnt_tcp-last_expr"/><a name="24823"/>24823: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="24824"/>24824: 
<a name="24825"/>24825: 
<a name="24826"/>24826: 
<a name="24827"/>24827: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24828"/>24828: 
<a name="24829"/>24829: <i>%% Tests that the keepidle tcp socket option.</i>
<a name="24830"/>24830: <i>%%</i>
<a name="24831"/>24831: <i>%% &quot;Gets or sets the number of seconds a TCP connection will remain</i>
<a name="24832"/>24832: <i>%%  idle before keepalive probes are sent to the remote.&quot;</i>
<a name="24833"/>24833: <i>%%</i>
<a name="24834"/>24834: 
<a name="api_opt_tcp_keepidle_tcp4-1"/><a name="24835"/>24835: <b>api_opt_tcp_keepidle_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24836"/>24836:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepidle_tcp4-last_expr"/><a name="24837"/>24837: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="24838"/>24838:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepidle() end,
<a name="24839"/>24839:            fun() -&gt;
<a name="24840"/>24840:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="24841"/>24841:                                   socket:setopt(Sock, tcp, keepidle, Value)
<a name="24842"/>24842:                           end,
<a name="24843"/>24843:                    Get  = fun(Sock) -&gt;
<a name="24844"/>24844:                                   socket:getopt(Sock, tcp, keepidle)
<a name="24845"/>24845:                           end,
<a name="24846"/>24846:                    InitState = #{domain =&gt; inet,
<a name="24847"/>24847:                                  proto  =&gt; tcp,
<a name="24848"/>24848:                                  set    =&gt; Set,
<a name="24849"/>24849:                                  get    =&gt; Get},
<a name="24850"/>24850:                    ok = api_opt_tcp_keepidle_tcp(InitState)
<a name="24851"/>24851:            end).
<a name="24852"/>24852: 
<a name="24853"/>24853: 
<a name="24854"/>24854: 
<a name="24855"/>24855: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24856"/>24856: 
<a name="api_opt_tcp_keepidle_tcp-1"/><a name="24857"/>24857: <b>api_opt_tcp_keepidle_tcp</b>(InitState) -&gt;
<a name="24858"/>24858:     process_flag(trap_exit, true),
<a name="24859"/>24859:     ServerSeq =
<a name="24860"/>24860:         [
<a name="24861"/>24861:          %% *** Wait for start order ***
<a name="24862"/>24862:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="24863"/>24863:            cmd  =&gt; fun(State) -&gt;
<a name="24864"/>24864:                            Tester = ?SEV_AWAIT_START(),
<a name="24865"/>24865:                            {ok, State#{tester =&gt; Tester}}
<a name="24866"/>24866:                    end},
<a name="24867"/>24867:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="24868"/>24868:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24869"/>24869:                            _MRef = erlang:monitor(process, Tester),
<a name="24870"/>24870:                            ok
<a name="24871"/>24871:                    end},
<a name="24872"/>24872: 
<a name="24873"/>24873:          %% *** Init part ***
<a name="24874"/>24874:          #{desc =&gt; &quot;which local address&quot;,
<a name="24875"/>24875:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24876"/>24876:                            LSA = which_local_socket_addr(Domain),
<a name="24877"/>24877:                            {ok, State#{lsa =&gt; LSA}}
<a name="24878"/>24878:                    end},
<a name="24879"/>24879:          #{desc =&gt; &quot;create socket&quot;,
<a name="24880"/>24880:            cmd  =&gt; fun(#{domain := Domain,
<a name="24881"/>24881:                          proto  := Proto} = State) -&gt;
<a name="24882"/>24882:                            case socket:open(Domain, stream, Proto) of
<a name="24883"/>24883:                                {ok, Sock} -&gt;
<a name="24884"/>24884:                                    {ok, State#{sock =&gt; Sock}};
<a name="24885"/>24885:                                {error, _} = ERROR -&gt;
<a name="24886"/>24886:                                    ERROR
<a name="24887"/>24887:                            end
<a name="24888"/>24888:                    end},
<a name="24889"/>24889:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24890"/>24890:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24891"/>24891:                            case sock_bind(LSock, LSA) of
<a name="24892"/>24892:                                ok -&gt;
<a name="24893"/>24893:                                    Port = sock_port(LSock),
<a name="24894"/>24894:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24895"/>24895:                                    ok;
<a name="24896"/>24896:                                {error, _} = ERROR -&gt;
<a name="24897"/>24897:                                    ERROR
<a name="24898"/>24898:                            end
<a name="24899"/>24899:                    end},
<a name="24900"/>24900:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="24901"/>24901:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24902"/>24902:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="24903"/>24903:                            ok
<a name="24904"/>24904:                    end},
<a name="24905"/>24905: 
<a name="24906"/>24906: 
<a name="24907"/>24907:          %% The actual test
<a name="24908"/>24908:          #{desc =&gt; &quot;await continue (get keepidle(1))&quot;,
<a name="24909"/>24909:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24910"/>24910:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepidle)
<a name="24911"/>24911:                    end},
<a name="24912"/>24912:          #{desc =&gt; &quot;get keepidle&quot;,
<a name="24913"/>24913:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="24914"/>24914:                            case Get(Sock) of
<a name="24915"/>24915:                                {ok, KeepIdle} -&gt;
<a name="24916"/>24916:                                    ?SEV_IPRINT(&quot;keepidle: ~p&quot;, [KeepIdle]),
<a name="24917"/>24917:                                    {ok, State#{keepidle =&gt; KeepIdle}};
<a name="24918"/>24918:                                {error, _} = ERROR -&gt;
<a name="24919"/>24919:                                    ERROR
<a name="24920"/>24920:                            end
<a name="24921"/>24921:                    end},
<a name="24922"/>24922:          #{desc =&gt; &quot;announce ready (get keepidle(1))&quot;,
<a name="24923"/>24923:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24924"/>24924:                            ?SEV_ANNOUNCE_READY(Tester, get_keepidle),
<a name="24925"/>24925:                            ok
<a name="24926"/>24926:                    end},
<a name="24927"/>24927: 
<a name="24928"/>24928: 
<a name="24929"/>24929:          #{desc =&gt; &quot;await continue (set keepidle)&quot;,
<a name="24930"/>24930:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24931"/>24931:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepidle)
<a name="24932"/>24932:                    end},
<a name="24933"/>24933:          #{desc =&gt; &quot;set keepidle&quot;,
<a name="24934"/>24934:            cmd  =&gt; fun(#{sock     := Sock,
<a name="24935"/>24935:                          set      := Set,
<a name="24936"/>24936:                          keepidle := KeepIdle} = State) -&gt;
<a name="24937"/>24937:                            NewKeepIdle = KeepIdle + 1,
<a name="24938"/>24938:                            case Set(Sock, NewKeepIdle) of
<a name="24939"/>24939:                                ok -&gt;
<a name="24940"/>24940:                                    ?SEV_IPRINT(&quot;keepidle updated (to ~p)&quot;,
<a name="24941"/>24941:                                                [NewKeepIdle]),
<a name="24942"/>24942:                                    {ok, State#{keepidle =&gt; NewKeepIdle}};
<a name="24943"/>24943:                                {error, _} = ERROR -&gt;
<a name="24944"/>24944:                                    ERROR
<a name="24945"/>24945:                            end
<a name="24946"/>24946:                    end},
<a name="24947"/>24947:          #{desc =&gt; &quot;announce ready (set keepidle)&quot;,
<a name="24948"/>24948:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24949"/>24949:                            ?SEV_ANNOUNCE_READY(Tester, set_keepidle),
<a name="24950"/>24950:                            ok
<a name="24951"/>24951:                    end},
<a name="24952"/>24952: 
<a name="24953"/>24953: 
<a name="24954"/>24954:          #{desc =&gt; &quot;await continue (get keepidle(2))&quot;,
<a name="24955"/>24955:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24956"/>24956:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepidle)
<a name="24957"/>24957:                    end},
<a name="24958"/>24958:          #{desc =&gt; &quot;get keepidle(2)&quot;,
<a name="24959"/>24959:            cmd  =&gt; fun(#{sock     := Sock,
<a name="24960"/>24960:                          get      := Get,
<a name="24961"/>24961:                          keepidle := ExpKeepIdle} = _State) -&gt;
<a name="24962"/>24962:                            case Get(Sock) of
<a name="24963"/>24963:                                {ok, KeepIdle} when (ExpKeepIdle =:= KeepIdle) -&gt;
<a name="24964"/>24964:                                    ?SEV_IPRINT(&quot;expected keepidle (~p)&quot;,
<a name="24965"/>24965:                                                [ExpKeepIdle]),
<a name="24966"/>24966:                                    ok;
<a name="24967"/>24967:                                {ok, KeepIdle} -&gt;
<a name="24968"/>24968:                                    ?SEV_EPRINT(&quot;unexpected keepidle:&quot;
<a name="24969"/>24969:                                                &quot;~n   Expected KeepIdle: ~p&quot;
<a name="24970"/>24970:                                                &quot;~n   Actual KeepIdle:   ~p&quot;,
<a name="24971"/>24971:                                                [ExpKeepIdle, KeepIdle]),
<a name="24972"/>24972:                                    {error,
<a name="24973"/>24973:                                     {unexpected_keepidle,
<a name="24974"/>24974:                                      ExpKeepIdle, KeepIdle}};
<a name="24975"/>24975:                                {error, Reason} = ERROR -&gt;
<a name="24976"/>24976:                                    ?SEV_EPRINT(&quot;failed get keepidle: &quot;
<a name="24977"/>24977:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="24978"/>24978:                                    ERROR
<a name="24979"/>24979:                            end
<a name="24980"/>24980:                    end},
<a name="24981"/>24981:          #{desc =&gt; &quot;announce ready (get keepidle(2))&quot;,
<a name="24982"/>24982:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24983"/>24983:                            ?SEV_ANNOUNCE_READY(Tester, get_keepidle),
<a name="24984"/>24984:                            ok
<a name="24985"/>24985:                    end},
<a name="24986"/>24986: 
<a name="24987"/>24987: 
<a name="24988"/>24988:          %% *** Termination ***
<a name="24989"/>24989:          #{desc =&gt; &quot;await terminate&quot;,
<a name="24990"/>24990:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="24991"/>24991:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="24992"/>24992:                                ok -&gt;
<a name="24993"/>24993:                                    {ok, maps:remove(tester, State)};
<a name="24994"/>24994:                                {error, _} = ERROR -&gt;
<a name="24995"/>24995:                                    ERROR
<a name="24996"/>24996:                            end
<a name="24997"/>24997:                    end},
<a name="24998"/>24998:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24999"/>24999:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25000"/>25000:                            ok = socket:close(Sock),
<a name="25001"/>25001:                            {ok, maps:remove(sock, State)}
<a name="25002"/>25002:                    end},
<a name="25003"/>25003: 
<a name="25004"/>25004:          %% *** We are done ***
<a name="25005"/>25005:          ?SEV_FINISH_NORMAL
<a name="25006"/>25006:         ],
<a name="25007"/>25007: 
<a name="25008"/>25008: 
<a name="25009"/>25009:     TesterSeq =
<a name="25010"/>25010:         [
<a name="25011"/>25011:          %% *** Init part ***
<a name="25012"/>25012:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25013"/>25013:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25014"/>25014:                            _MRef = erlang:monitor(process, Pid),
<a name="25015"/>25015:                            ok
<a name="25016"/>25016:                    end},
<a name="25017"/>25017: 
<a name="25018"/>25018:          %% Start the server
<a name="25019"/>25019:          #{desc =&gt; &quot;order server start&quot;,
<a name="25020"/>25020:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25021"/>25021:                            ?SEV_ANNOUNCE_START(Pid),
<a name="25022"/>25022:                            ok
<a name="25023"/>25023:                    end},
<a name="25024"/>25024:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25025"/>25025:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25026"/>25026:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="25027"/>25027:                            ok
<a name="25028"/>25028:                    end},
<a name="25029"/>25029: 
<a name="25030"/>25030:          %% *** The actual test ***
<a name="25031"/>25031:          #{desc =&gt; &quot;order server to continue (with get-keepidle(1))&quot;,
<a name="25032"/>25032:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25033"/>25033:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepidle),
<a name="25034"/>25034:                            ok
<a name="25035"/>25035:                    end},
<a name="25036"/>25036:          #{desc =&gt; &quot;await server ready (get-keepidle(1))&quot;,
<a name="25037"/>25037:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25038"/>25038:                            ?SEV_AWAIT_READY(Server, server, get_keepidle)
<a name="25039"/>25039:                    end},
<a name="25040"/>25040: 
<a name="25041"/>25041:          #{desc =&gt; &quot;order server to continue (with set-keepidle)&quot;,
<a name="25042"/>25042:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25043"/>25043:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepidle),
<a name="25044"/>25044:                            ok
<a name="25045"/>25045:                    end},
<a name="25046"/>25046:          #{desc =&gt; &quot;await server ready (set-keepidle)&quot;,
<a name="25047"/>25047:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25048"/>25048:                            ?SEV_AWAIT_READY(Server, server, set_keepidle)
<a name="25049"/>25049:                    end},
<a name="25050"/>25050: 
<a name="25051"/>25051:          #{desc =&gt; &quot;order server to continue (with get-keepidle(2))&quot;,
<a name="25052"/>25052:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25053"/>25053:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepidle),
<a name="25054"/>25054:                            ok
<a name="25055"/>25055:                    end},
<a name="25056"/>25056:          #{desc =&gt; &quot;await server ready (get-keepidle(2))&quot;,
<a name="25057"/>25057:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25058"/>25058:                            ?SEV_AWAIT_READY(Server, server, get_keepidle)
<a name="25059"/>25059:                    end},
<a name="25060"/>25060: 
<a name="25061"/>25061: 
<a name="25062"/>25062:          %% *** Termination ***
<a name="25063"/>25063:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="25064"/>25064:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25065"/>25065:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25066"/>25066:                            ok
<a name="25067"/>25067:                    end},
<a name="25068"/>25068:          #{desc =&gt; &quot;await server termination&quot;,
<a name="25069"/>25069:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25070"/>25070:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25071"/>25071:                            State1 = maps:remove(server, State),
<a name="25072"/>25072:                            {ok, State1}
<a name="25073"/>25073:                    end},
<a name="25074"/>25074: 
<a name="25075"/>25075:          %% *** We are done ***
<a name="25076"/>25076:          ?SEV_FINISH_NORMAL
<a name="25077"/>25077:         ],
<a name="25078"/>25078: 
<a name="25079"/>25079: 
<a name="25080"/>25080:     i(&quot;start server evaluator&quot;),
<a name="25081"/>25081:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="25082"/>25082: 
<a name="25083"/>25083:     i(&quot;start tester evaluator&quot;),
<a name="25084"/>25084:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="25085"/>25085:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="25086"/>25086: 
<a name="api_opt_tcp_keepidle_tcp-last_expr"/><a name="25087"/>25087: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="25088"/>25088: 
<a name="25089"/>25089: 
<a name="25090"/>25090: 
<a name="25091"/>25091: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25092"/>25092: 
<a name="25093"/>25093: <i>%% Tests that the keepintvl tcp socket option.</i>
<a name="25094"/>25094: <i>%%</i>
<a name="25095"/>25095: <i>%% &quot;Gets or sets the number of seconds a TCP connection will wait for</i>
<a name="25096"/>25096: <i>%%  a keepalive response before sending another keepalive probe.&quot;</i>
<a name="25097"/>25097: <i>%%</i>
<a name="25098"/>25098: 
<a name="api_opt_tcp_keepintvl_tcp4-1"/><a name="25099"/>25099: <b>api_opt_tcp_keepintvl_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25100"/>25100:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepintvl_tcp4-last_expr"/><a name="25101"/>25101: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="25102"/>25102:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepintvl() end,
<a name="25103"/>25103:            fun() -&gt;
<a name="25104"/>25104:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="25105"/>25105:                                   socket:setopt(Sock, tcp, keepintvl, Value)
<a name="25106"/>25106:                           end,
<a name="25107"/>25107:                    Get  = fun(Sock) -&gt;
<a name="25108"/>25108:                                   socket:getopt(Sock, tcp, keepintvl)
<a name="25109"/>25109:                           end,
<a name="25110"/>25110:                    InitState = #{domain =&gt; inet,
<a name="25111"/>25111:                                  proto  =&gt; tcp,
<a name="25112"/>25112:                                  set    =&gt; Set,
<a name="25113"/>25113:                                  get    =&gt; Get},
<a name="25114"/>25114:                    ok = api_opt_tcp_keepintvl_tcp(InitState)
<a name="25115"/>25115:            end).
<a name="25116"/>25116: 
<a name="25117"/>25117: 
<a name="25118"/>25118: 
<a name="25119"/>25119: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25120"/>25120: 
<a name="api_opt_tcp_keepintvl_tcp-1"/><a name="25121"/>25121: <b>api_opt_tcp_keepintvl_tcp</b>(InitState) -&gt;
<a name="25122"/>25122:     process_flag(trap_exit, true),
<a name="25123"/>25123:     ServerSeq =
<a name="25124"/>25124:         [
<a name="25125"/>25125:          %% *** Wait for start order ***
<a name="25126"/>25126:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="25127"/>25127:            cmd  =&gt; fun(State) -&gt;
<a name="25128"/>25128:                            Tester = ?SEV_AWAIT_START(),
<a name="25129"/>25129:                            {ok, State#{tester =&gt; Tester}}
<a name="25130"/>25130:                    end},
<a name="25131"/>25131:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="25132"/>25132:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25133"/>25133:                            _MRef = erlang:monitor(process, Tester),
<a name="25134"/>25134:                            ok
<a name="25135"/>25135:                    end},
<a name="25136"/>25136: 
<a name="25137"/>25137:          %% *** Init part ***
<a name="25138"/>25138:          #{desc =&gt; &quot;which local address&quot;,
<a name="25139"/>25139:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25140"/>25140:                            LSA = which_local_socket_addr(Domain),
<a name="25141"/>25141:                            {ok, State#{lsa =&gt; LSA}}
<a name="25142"/>25142:                    end},
<a name="25143"/>25143:          #{desc =&gt; &quot;create socket&quot;,
<a name="25144"/>25144:            cmd  =&gt; fun(#{domain := Domain,
<a name="25145"/>25145:                          proto  := Proto} = State) -&gt;
<a name="25146"/>25146:                            case socket:open(Domain, stream, Proto) of
<a name="25147"/>25147:                                {ok, Sock} -&gt;
<a name="25148"/>25148:                                    {ok, State#{sock =&gt; Sock}};
<a name="25149"/>25149:                                {error, _} = ERROR -&gt;
<a name="25150"/>25150:                                    ERROR
<a name="25151"/>25151:                            end
<a name="25152"/>25152:                    end},
<a name="25153"/>25153:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25154"/>25154:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="25155"/>25155:                            case sock_bind(LSock, LSA) of
<a name="25156"/>25156:                                ok -&gt;
<a name="25157"/>25157:                                    Port = sock_port(LSock),
<a name="25158"/>25158:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25159"/>25159:                                    ok;
<a name="25160"/>25160:                                {error, _} = ERROR -&gt;
<a name="25161"/>25161:                                    ERROR
<a name="25162"/>25162:                            end
<a name="25163"/>25163:                    end},
<a name="25164"/>25164:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25165"/>25165:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25166"/>25166:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="25167"/>25167:                            ok
<a name="25168"/>25168:                    end},
<a name="25169"/>25169: 
<a name="25170"/>25170: 
<a name="25171"/>25171:          %% The actual test
<a name="25172"/>25172:          #{desc =&gt; &quot;await continue (get keepintvl(1))&quot;,
<a name="25173"/>25173:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25174"/>25174:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepintvl)
<a name="25175"/>25175:                    end},
<a name="25176"/>25176:          #{desc =&gt; &quot;get keepintvl&quot;,
<a name="25177"/>25177:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="25178"/>25178:                            case Get(Sock) of
<a name="25179"/>25179:                                {ok, KeepIntVl} -&gt;
<a name="25180"/>25180:                                    ?SEV_IPRINT(&quot;keepintvl: ~p&quot;, [KeepIntVl]),
<a name="25181"/>25181:                                    {ok, State#{keepintvl =&gt; KeepIntVl}};
<a name="25182"/>25182:                                {error, _} = ERROR -&gt;
<a name="25183"/>25183:                                    ERROR
<a name="25184"/>25184:                            end
<a name="25185"/>25185:                    end},
<a name="25186"/>25186:          #{desc =&gt; &quot;announce ready (get keepintvl(1))&quot;,
<a name="25187"/>25187:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25188"/>25188:                            ?SEV_ANNOUNCE_READY(Tester, get_keepintvl),
<a name="25189"/>25189:                            ok
<a name="25190"/>25190:                    end},
<a name="25191"/>25191: 
<a name="25192"/>25192: 
<a name="25193"/>25193:          #{desc =&gt; &quot;await continue (set keepintvl)&quot;,
<a name="25194"/>25194:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25195"/>25195:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepintvl)
<a name="25196"/>25196:                    end},
<a name="25197"/>25197:          #{desc =&gt; &quot;set keepintvl&quot;,
<a name="25198"/>25198:            cmd  =&gt; fun(#{sock     := Sock,
<a name="25199"/>25199:                          set      := Set,
<a name="25200"/>25200:                          keepintvl := KeepIntVl} = State) -&gt;
<a name="25201"/>25201:                            NewKeepIntVl = KeepIntVl + 1,
<a name="25202"/>25202:                            case Set(Sock, NewKeepIntVl) of
<a name="25203"/>25203:                                ok -&gt;
<a name="25204"/>25204:                                    ?SEV_IPRINT(&quot;keepIntVl updated (to ~p)&quot;,
<a name="25205"/>25205:                                                [NewKeepIntVl]),
<a name="25206"/>25206:                                    {ok, State#{keepintvl =&gt; NewKeepIntVl}};
<a name="25207"/>25207:                                {error, _} = ERROR -&gt;
<a name="25208"/>25208:                                    ERROR
<a name="25209"/>25209:                            end
<a name="25210"/>25210:                    end},
<a name="25211"/>25211:          #{desc =&gt; &quot;announce ready (set keepintvl)&quot;,
<a name="25212"/>25212:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25213"/>25213:                            ?SEV_ANNOUNCE_READY(Tester, set_keepintvl),
<a name="25214"/>25214:                            ok
<a name="25215"/>25215:                    end},
<a name="25216"/>25216: 
<a name="25217"/>25217: 
<a name="25218"/>25218:          #{desc =&gt; &quot;await continue (get keepintvl(2))&quot;,
<a name="25219"/>25219:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25220"/>25220:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepintvl)
<a name="25221"/>25221:                    end},
<a name="25222"/>25222:          #{desc =&gt; &quot;get keepintvl(2)&quot;,
<a name="25223"/>25223:            cmd  =&gt; fun(#{sock      := Sock,
<a name="25224"/>25224:                          get       := Get,
<a name="25225"/>25225:                          keepintvl := ExpKeepIntVl} = _State) -&gt;
<a name="25226"/>25226:                            case Get(Sock) of
<a name="25227"/>25227:                                {ok, KeepIntVl}
<a name="25228"/>25228:                                  when (ExpKeepIntVl =:= KeepIntVl) -&gt;
<a name="25229"/>25229:                                    ?SEV_IPRINT(&quot;expected keepintvl (~p)&quot;,
<a name="25230"/>25230:                                                [ExpKeepIntVl]),
<a name="25231"/>25231:                                    ok;
<a name="25232"/>25232:                                {ok, KeepIntVl} -&gt;
<a name="25233"/>25233:                                    ?SEV_EPRINT(&quot;unexpected keepintvl:&quot;
<a name="25234"/>25234:                                                &quot;~n   Expected KeepIntVl: ~p&quot;
<a name="25235"/>25235:                                                &quot;~n   Actual KeepIntVl:   ~p&quot;,
<a name="25236"/>25236:                                                [ExpKeepIntVl, KeepIntVl]),
<a name="25237"/>25237:                                    {error,
<a name="25238"/>25238:                                     {unexpected_keepintvl,
<a name="25239"/>25239:                                      ExpKeepIntVl, KeepIntVl}};
<a name="25240"/>25240:                                {error, Reason} = ERROR -&gt;
<a name="25241"/>25241:                                    ?SEV_EPRINT(&quot;failed get keepintvl: &quot;
<a name="25242"/>25242:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="25243"/>25243:                                    ERROR
<a name="25244"/>25244:                            end
<a name="25245"/>25245:                    end},
<a name="25246"/>25246:          #{desc =&gt; &quot;announce ready (get keepintvl(2))&quot;,
<a name="25247"/>25247:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25248"/>25248:                            ?SEV_ANNOUNCE_READY(Tester, get_keepintvl),
<a name="25249"/>25249:                            ok
<a name="25250"/>25250:                    end},
<a name="25251"/>25251: 
<a name="25252"/>25252: 
<a name="25253"/>25253:          %% *** Termination ***
<a name="25254"/>25254:          #{desc =&gt; &quot;await terminate&quot;,
<a name="25255"/>25255:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="25256"/>25256:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="25257"/>25257:                                ok -&gt;
<a name="25258"/>25258:                                    {ok, maps:remove(tester, State)};
<a name="25259"/>25259:                                {error, _} = ERROR -&gt;
<a name="25260"/>25260:                                    ERROR
<a name="25261"/>25261:                            end
<a name="25262"/>25262:                    end},
<a name="25263"/>25263:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="25264"/>25264:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25265"/>25265:                            ok = socket:close(Sock),
<a name="25266"/>25266:                            {ok, maps:remove(sock, State)}
<a name="25267"/>25267:                    end},
<a name="25268"/>25268: 
<a name="25269"/>25269:          %% *** We are done ***
<a name="25270"/>25270:          ?SEV_FINISH_NORMAL
<a name="25271"/>25271:         ],
<a name="25272"/>25272: 
<a name="25273"/>25273: 
<a name="25274"/>25274:     TesterSeq =
<a name="25275"/>25275:         [
<a name="25276"/>25276:          %% *** Init part ***
<a name="25277"/>25277:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25278"/>25278:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25279"/>25279:                            _MRef = erlang:monitor(process, Pid),
<a name="25280"/>25280:                            ok
<a name="25281"/>25281:                    end},
<a name="25282"/>25282: 
<a name="25283"/>25283:          %% Start the server
<a name="25284"/>25284:          #{desc =&gt; &quot;order server start&quot;,
<a name="25285"/>25285:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25286"/>25286:                            ?SEV_ANNOUNCE_START(Pid),
<a name="25287"/>25287:                            ok
<a name="25288"/>25288:                    end},
<a name="25289"/>25289:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25290"/>25290:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25291"/>25291:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="25292"/>25292:                            ok
<a name="25293"/>25293:                    end},
<a name="25294"/>25294: 
<a name="25295"/>25295:          %% *** The actual test ***
<a name="25296"/>25296:          #{desc =&gt; &quot;order server to continue (with get-keepintvl(1))&quot;,
<a name="25297"/>25297:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25298"/>25298:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepintvl),
<a name="25299"/>25299:                            ok
<a name="25300"/>25300:                    end},
<a name="25301"/>25301:          #{desc =&gt; &quot;await server ready (get-keepintvl(1))&quot;,
<a name="25302"/>25302:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25303"/>25303:                            ?SEV_AWAIT_READY(Server, server, get_keepintvl)
<a name="25304"/>25304:                    end},
<a name="25305"/>25305: 
<a name="25306"/>25306:          #{desc =&gt; &quot;order server to continue (with set-keepintvl)&quot;,
<a name="25307"/>25307:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25308"/>25308:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepintvl),
<a name="25309"/>25309:                            ok
<a name="25310"/>25310:                    end},
<a name="25311"/>25311:          #{desc =&gt; &quot;await server ready (set-keepintvl)&quot;,
<a name="25312"/>25312:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25313"/>25313:                            ?SEV_AWAIT_READY(Server, server, set_keepintvl)
<a name="25314"/>25314:                    end},
<a name="25315"/>25315: 
<a name="25316"/>25316:          #{desc =&gt; &quot;order server to continue (with get-keepintvl(2))&quot;,
<a name="25317"/>25317:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25318"/>25318:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepintvl),
<a name="25319"/>25319:                            ok
<a name="25320"/>25320:                    end},
<a name="25321"/>25321:          #{desc =&gt; &quot;await server ready (get-keepintvl(2))&quot;,
<a name="25322"/>25322:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25323"/>25323:                            ?SEV_AWAIT_READY(Server, server, get_keepintvl)
<a name="25324"/>25324:                    end},
<a name="25325"/>25325: 
<a name="25326"/>25326: 
<a name="25327"/>25327:          %% *** Termination ***
<a name="25328"/>25328:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="25329"/>25329:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25330"/>25330:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25331"/>25331:                            ok
<a name="25332"/>25332:                    end},
<a name="25333"/>25333:          #{desc =&gt; &quot;await server termination&quot;,
<a name="25334"/>25334:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25335"/>25335:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25336"/>25336:                            State1 = maps:remove(server, State),
<a name="25337"/>25337:                            {ok, State1}
<a name="25338"/>25338:                    end},
<a name="25339"/>25339: 
<a name="25340"/>25340:          %% *** We are done ***
<a name="25341"/>25341:          ?SEV_FINISH_NORMAL
<a name="25342"/>25342:         ],
<a name="25343"/>25343: 
<a name="25344"/>25344: 
<a name="25345"/>25345:     i(&quot;start server evaluator&quot;),
<a name="25346"/>25346:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="25347"/>25347: 
<a name="25348"/>25348:     i(&quot;start tester evaluator&quot;),
<a name="25349"/>25349:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="25350"/>25350:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="25351"/>25351: 
<a name="api_opt_tcp_keepintvl_tcp-last_expr"/><a name="25352"/>25352: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="25353"/>25353: 
<a name="25354"/>25354: 
<a name="25355"/>25355: 
<a name="25356"/>25356: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25357"/>25357: 
<a name="25358"/>25358: <i>%% Tests that the cork udp socket option.</i>
<a name="25359"/>25359: <i>%%</i>
<a name="25360"/>25360: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="25361"/>25361: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="25362"/>25362: <i>%%</i>
<a name="25363"/>25363: 
<a name="api_opt_udp_cork_udp4-1"/><a name="25364"/>25364: <b>api_opt_udp_cork_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25365"/>25365:     ?TT(?SECS(5)),
<a name="api_opt_udp_cork_udp4-last_expr"/><a name="25366"/>25366: <b>    tc_try</b>(api_opt_udp_cork_udp4,
<a name="25367"/>25367:            fun() -&gt; has_support_ipv4(), has_support_udp_cork() end,
<a name="25368"/>25368:            fun() -&gt;
<a name="25369"/>25369:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="25370"/>25370:                                   socket:setopt(Sock, udp, cork, Value)
<a name="25371"/>25371:                           end,
<a name="25372"/>25372:                    Get  = fun(Sock) -&gt;
<a name="25373"/>25373:                                   socket:getopt(Sock, udp, cork)
<a name="25374"/>25374:                           end,
<a name="25375"/>25375:                    InitState = #{domain =&gt; inet,
<a name="25376"/>25376:                                  proto  =&gt; udp,
<a name="25377"/>25377:                                  set    =&gt; Set,
<a name="25378"/>25378:                                  get    =&gt; Get},
<a name="25379"/>25379:                    ok = api_opt_udp_cork_udp(InitState)
<a name="25380"/>25380:            end).
<a name="25381"/>25381: 
<a name="25382"/>25382: 
<a name="25383"/>25383: 
<a name="25384"/>25384: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25385"/>25385: 
<a name="api_opt_udp_cork_udp-1"/><a name="25386"/>25386: <b>api_opt_udp_cork_udp</b>(InitState) -&gt;
<a name="25387"/>25387:     process_flag(trap_exit, true),
<a name="25388"/>25388:     TesterSeq =
<a name="25389"/>25389:         [
<a name="25390"/>25390:          %% *** Init part ***
<a name="25391"/>25391:          #{desc =&gt; &quot;which local address&quot;,
<a name="25392"/>25392:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25393"/>25393:                            LSA = which_local_socket_addr(Domain),
<a name="25394"/>25394:                            {ok, State#{lsa =&gt; LSA}}
<a name="25395"/>25395:                    end},
<a name="25396"/>25396:          #{desc =&gt; &quot;create socket&quot;,
<a name="25397"/>25397:            cmd  =&gt; fun(#{domain := Domain,
<a name="25398"/>25398:                          proto  := Proto} = State) -&gt;
<a name="25399"/>25399:                            case socket:open(Domain, dgram, Proto) of
<a name="25400"/>25400:                                {ok, Sock} -&gt;
<a name="25401"/>25401:                                    {ok, State#{sock =&gt; Sock}};
<a name="25402"/>25402:                                {error, _} = ERROR -&gt;
<a name="25403"/>25403:                                    ERROR
<a name="25404"/>25404:                            end
<a name="25405"/>25405:                    end},
<a name="25406"/>25406:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25407"/>25407:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="25408"/>25408:                            case sock_bind(Sock, LSA) of
<a name="25409"/>25409:                                ok -&gt;
<a name="25410"/>25410:                                    Port = sock_port(Sock),
<a name="25411"/>25411:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25412"/>25412:                                    ok;
<a name="25413"/>25413:                                {error, _} = ERROR -&gt;
<a name="25414"/>25414:                                    ERROR
<a name="25415"/>25415:                            end
<a name="25416"/>25416:                    end},
<a name="25417"/>25417: 
<a name="25418"/>25418: 
<a name="25419"/>25419:          %% The actual test
<a name="25420"/>25420:          #{desc =&gt; &quot;get (default) cork (= false)&quot;,
<a name="25421"/>25421:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="25422"/>25422:                            case Get(Sock) of
<a name="25423"/>25423:                                {ok, false = Value} -&gt;
<a name="25424"/>25424:                                    ?SEV_IPRINT(&quot;cork default: ~p&quot;, [Value]),
<a name="25425"/>25425:                                    ok;
<a name="25426"/>25426:                                {error, _} = ERROR -&gt;
<a name="25427"/>25427:                                    ERROR
<a name="25428"/>25428:                            end
<a name="25429"/>25429:                    end},
<a name="25430"/>25430:          #{desc =&gt; &quot;enable cork (=&gt; true)&quot;,
<a name="25431"/>25431:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="25432"/>25432:                            case Set(Sock, true) of
<a name="25433"/>25433:                                ok -&gt;
<a name="25434"/>25434:                                    ?SEV_IPRINT(&quot;cork enabled&quot;),
<a name="25435"/>25435:                                    ok;
<a name="25436"/>25436:                                {error, _} = ERROR -&gt;
<a name="25437"/>25437:                                    ERROR
<a name="25438"/>25438:                            end
<a name="25439"/>25439:                    end},
<a name="25440"/>25440:          #{desc =&gt; &quot;get cork (= true)&quot;,
<a name="25441"/>25441:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="25442"/>25442:                            case Get(Sock) of
<a name="25443"/>25443:                                {ok, true = Value} -&gt;
<a name="25444"/>25444:                                    ?SEV_IPRINT(&quot;cork: ~p&quot;, [Value]),
<a name="25445"/>25445:                                    ok;
<a name="25446"/>25446:                                {error, _} = ERROR -&gt;
<a name="25447"/>25447:                                    ERROR
<a name="25448"/>25448:                            end
<a name="25449"/>25449:                    end},
<a name="25450"/>25450: 
<a name="25451"/>25451: 
<a name="25452"/>25452:          %% *** Termination ***
<a name="25453"/>25453:          #{desc =&gt; &quot;close socket&quot;,
<a name="25454"/>25454:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25455"/>25455:                            ok = socket:close(Sock),
<a name="25456"/>25456:                            {ok, maps:remove(sock, State)}
<a name="25457"/>25457:                    end},
<a name="25458"/>25458: 
<a name="25459"/>25459:          %% *** We are done ***
<a name="25460"/>25460:          ?SEV_FINISH_NORMAL
<a name="25461"/>25461:         ],
<a name="25462"/>25462: 
<a name="25463"/>25463:     i(&quot;start tester evaluator&quot;),
<a name="25464"/>25464:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="25465"/>25465: 
<a name="api_opt_udp_cork_udp-last_expr"/><a name="25466"/>25466: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="25467"/>25467: 
<a name="25468"/>25468: 
<a name="25469"/>25469: 
<a name="25470"/>25470: 
<a name="25471"/>25471: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25472"/>25472: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25473"/>25473: <i>%%                                                                     %%</i>
<a name="25474"/>25474: <i>%%                  API OPERATIONS WITH TIMEOUT                        %%</i>
<a name="25475"/>25475: <i>%%                                                                     %%</i>
<a name="25476"/>25476: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25477"/>25477: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25478"/>25478: 
<a name="25479"/>25479: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25480"/>25480: 
<a name="25481"/>25481: <i>%% This test case is intended to test the connect timeout option</i>
<a name="25482"/>25482: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_connect_tcp4-1"/><a name="25483"/>25483: <b>api_to_connect_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25484"/>25484:     ?TT(?SECS(10)),
<a name="25485"/>25485:     Cond = fun() -&gt; has_support_ipv4(), api_to_connect_cond() end,
<a name="api_to_connect_tcp4-last_expr"/><a name="25486"/>25486: <b>    tc_try</b>(api_to_connect_tcp4,
<a name="25487"/>25487:            Cond,
<a name="25488"/>25488:            fun() -&gt;
<a name="25489"/>25489:                    InitState = #{domain        =&gt; inet,
<a name="25490"/>25490:                                  backlog       =&gt; 1,
<a name="25491"/>25491:                                  timeout       =&gt; 5000,
<a name="25492"/>25492:                                  connect_limit =&gt; 3},
<a name="25493"/>25493:                    ok = api_to_connect_tcp(InitState)
<a name="25494"/>25494:            end).
<a name="25495"/>25495: 
<a name="api_to_connect_cond-0"/><a name="25496"/>25496: <b>api_to_connect_cond</b>() -&gt;
<a name="api_to_connect_cond-last_expr"/><a name="25497"/>25497: <b>    api_to_connect_cond</b>(os:type(), os:version()).
<a name="25498"/>25498: 
<a name="25499"/>25499: <i>%% I don't know exactly at which version this starts to work.</i>
<a name="25500"/>25500: <i>%% I know it does not work for 4.4.*, but is does for 4.15.</i>
<a name="25501"/>25501: <i>%% So, just to simplify, we require at least 4.15</i>
<a name="api_to_connect_cond-2"/><a name="25502"/>25502: <b>api_to_connect_cond</b>({unix, linux}, {Maj, Min, _Rev}) -&gt;
<a name="25503"/>25503:     if
<a name="25504"/>25504:         (Maj &gt; 4) -&gt;
<a name="25505"/>25505:             ok;
<a name="25506"/>25506:         ((Maj =:= 4) andalso (Min &gt;= 15)) -&gt;
<a name="25507"/>25507:             ok;
<a name="25508"/>25508:         true -&gt;
<a name="25509"/>25509:             skip(&quot;TC does not work&quot;)
<a name="25510"/>25510:     end;
<a name="25511"/>25511: <i>%% Only test on one machine, which has version 6.3, and there it does</i>
<a name="25512"/>25512: <i>%% not work, so disable for all.</i>
<a name="25513"/>25513: <b>api_to_connect_cond</b>({unix, openbsd}, _) -&gt;
<a name="25514"/>25514:     skip(&quot;TC does not work&quot;);
<a name="25515"/>25515: <b>api_to_connect_cond</b>({unix, freebsd}, {Maj, Min, _Rev}) -&gt;
<a name="25516"/>25516:     if
<a name="25517"/>25517:         ((Maj &gt;= 10) andalso (Min &gt;= 4)) -&gt;
<a name="25518"/>25518:             ok;
<a name="25519"/>25519:         true -&gt;
<a name="25520"/>25520:             skip(&quot;TC may not work&quot;)
<a name="25521"/>25521:     end;
<a name="25522"/>25522: <b>api_to_connect_cond</b>({unix, sunos}, {Maj, Min, _Rev}) -&gt;
<a name="25523"/>25523:     if
<a name="25524"/>25524:         ((Maj &gt;= 5) andalso (Min &gt;= 10)) -&gt;
<a name="25525"/>25525:             ok;
<a name="25526"/>25526:         true -&gt;
<a name="25527"/>25527:             skip(&quot;TC may not work&quot;)
<a name="25528"/>25528:     end;
<a name="25529"/>25529: <b>api_to_connect_cond</b>(_, _) -&gt;
<a name="api_to_connect_cond-last_expr"/><a name="25530"/>25530: <b>    skip</b>(&quot;TC may not work&quot;).
<a name="25531"/>25531: 
<a name="25532"/>25532: 
<a name="25533"/>25533: 
<a name="25534"/>25534: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25535"/>25535: 
<a name="25536"/>25536: <i>%% This test case is intended to test the connect timeout option</i>
<a name="25537"/>25537: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_connect_tcp6-1"/><a name="25538"/>25538: <b>api_to_connect_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="25539"/>25539:     ?TT(?SECS(10)),
<a name="api_to_connect_tcp6-last_expr"/><a name="25540"/>25540: <b>    tc_try</b>(api_to_connect_tcp6,
<a name="25541"/>25541:            fun() -&gt; has_support_ipv6(), api_to_connect_cond() end,
<a name="25542"/>25542:            fun() -&gt;
<a name="25543"/>25543:                    InitState = #{domain        =&gt; inet6,
<a name="25544"/>25544:                                  backlog       =&gt; 1,
<a name="25545"/>25545:                                  timeout       =&gt; 5000,
<a name="25546"/>25546:                                  connect_limit =&gt; 3},
<a name="25547"/>25547:                    ok = api_to_connect_tcp(InitState)
<a name="25548"/>25548:            end).
<a name="25549"/>25549: 
<a name="25550"/>25550: 
<a name="25551"/>25551: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25552"/>25552: <i>%% We use the backlog (listen) argument to test this.</i>
<a name="25553"/>25553: <i>%% Note that the behaviour of the TCP &quot;server side&quot; can vary when </i>
<a name="25554"/>25554: <i>%% a client connect to a &quot;busy&quot; server (full backlog).</i>
<a name="25555"/>25555: <i>%% For instance, on FreeBSD (11.2) the response when the backlog is full</i>
<a name="25556"/>25556: <i>%% is a econreset.</i>
<a name="25557"/>25557: 
<a name="api_to_connect_tcp-1"/><a name="25558"/>25558: <b>api_to_connect_tcp</b>(InitState) -&gt;
<a name="25559"/>25559:     process_flag(trap_exit, true),
<a name="25560"/>25560: 
<a name="25561"/>25561:     ServerSeq = 
<a name="25562"/>25562:         [
<a name="25563"/>25563:          %% *** Wait for start order part ***
<a name="25564"/>25564:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="25565"/>25565:            cmd  =&gt; fun(State) -&gt;
<a name="25566"/>25566:                            {Tester, Backlog} = ?SEV_AWAIT_START(),
<a name="25567"/>25567:                            {ok, State#{tester  =&gt; Tester,
<a name="25568"/>25568:                                        backlog =&gt; Backlog}}
<a name="25569"/>25569:                    end},
<a name="25570"/>25570:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="25571"/>25571:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="25572"/>25572:                            _MRef = erlang:monitor(process, Tester),
<a name="25573"/>25573:                            ok
<a name="25574"/>25574:                    end},
<a name="25575"/>25575: 
<a name="25576"/>25576:          %% *** Init part ***
<a name="25577"/>25577:          #{desc =&gt; &quot;which local address&quot;,
<a name="25578"/>25578:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25579"/>25579:                            LSA = which_local_socket_addr(Domain),
<a name="25580"/>25580:                            {ok, State#{local_sa =&gt; LSA}}
<a name="25581"/>25581:                    end},
<a name="25582"/>25582:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="25583"/>25583:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25584"/>25584:                            case socket:open(Domain, stream, tcp) of
<a name="25585"/>25585:                                {ok, Sock} -&gt;
<a name="25586"/>25586:                                    {ok, State#{lsock =&gt; Sock}};
<a name="25587"/>25587:                                {error, _} = ERROR -&gt;
<a name="25588"/>25588:                                    ERROR
<a name="25589"/>25589:                            end
<a name="25590"/>25590:                    end},
<a name="25591"/>25591:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25592"/>25592:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="25593"/>25593:                            case sock_bind(LSock, LSA) of
<a name="25594"/>25594:                                ok -&gt;
<a name="25595"/>25595:                                    Port = sock_port(LSock),
<a name="25596"/>25596:                                    {ok, State#{lport =&gt; Port}};
<a name="25597"/>25597:                                {error, _} = ERROR -&gt;
<a name="25598"/>25598:                                    ERROR
<a name="25599"/>25599:                            end
<a name="25600"/>25600:                    end},
<a name="25601"/>25601:          #{desc =&gt; &quot;make listen socket (with backlog = 1)&quot;,
<a name="25602"/>25602:            cmd  =&gt; fun(#{lsock := LSock, backlog := Backlog}) -&gt;
<a name="25603"/>25603:                            socket:listen(LSock, Backlog)
<a name="25604"/>25604:                    end},
<a name="25605"/>25605:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25606"/>25606:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="25607"/>25607:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="25608"/>25608:                            ok
<a name="25609"/>25609:                    end},
<a name="25610"/>25610: 
<a name="25611"/>25611:          %% Termination
<a name="25612"/>25612:          #{desc =&gt; &quot;await terminate&quot;,
<a name="25613"/>25613:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="25614"/>25614:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="25615"/>25615:                                ok -&gt;
<a name="25616"/>25616:                                    {ok, maps:remove(tester, State)};
<a name="25617"/>25617:                                {error, _} = ERROR -&gt;
<a name="25618"/>25618:                                    ERROR
<a name="25619"/>25619:                            end
<a name="25620"/>25620:                    end},
<a name="25621"/>25621:          #{desc =&gt; &quot;close socket&quot;,
<a name="25622"/>25622:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="25623"/>25623:                            sock_close(Sock),
<a name="25624"/>25624:                            State1 = maps:remove(lport, State),
<a name="25625"/>25625:                            State2 = maps:remove(sock,  State1),
<a name="25626"/>25626:                            {ok, State2}
<a name="25627"/>25627:                    end},
<a name="25628"/>25628: 
<a name="25629"/>25629:          %% *** We are done ***
<a name="25630"/>25630:          ?SEV_FINISH_NORMAL
<a name="25631"/>25631:         ],
<a name="25632"/>25632: 
<a name="25633"/>25633:     ClientSeq =
<a name="25634"/>25634:         [
<a name="25635"/>25635:          %% *** Wait for start order part ***
<a name="25636"/>25636:          #{desc =&gt; &quot;await start&quot;,
<a name="25637"/>25637:            cmd  =&gt; fun(State) -&gt;
<a name="25638"/>25638:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="25639"/>25639:                            {ok, State#{tester    =&gt; Tester,
<a name="25640"/>25640:                                        server_sa =&gt; ServerSA}}
<a name="25641"/>25641:                    end},
<a name="25642"/>25642:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="25643"/>25643:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="25644"/>25644:                            _MRef = erlang:monitor(process, Tester),
<a name="25645"/>25645:                            ok
<a name="25646"/>25646:                    end},
<a name="25647"/>25647: 
<a name="25648"/>25648:          %% *** Init part ***
<a name="25649"/>25649:          #{desc =&gt; &quot;which local address&quot;,
<a name="25650"/>25650:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25651"/>25651:                            LSA = which_local_socket_addr(Domain),
<a name="25652"/>25652:                            {ok, State#{local_sa =&gt; LSA}}
<a name="25653"/>25653:                    end},
<a name="25654"/>25654:          #{desc =&gt; &quot;create node&quot;,
<a name="25655"/>25655:            cmd  =&gt; fun(#{host := _Host} = State) -&gt;
<a name="25656"/>25656:                            {Peer, Node} = start_node(&quot;client&quot;),
<a name="25657"/>25657:                            {ok, State#{node =&gt; Node, peer =&gt; Peer}}
<a name="25658"/>25658:                    end},
<a name="25659"/>25659:          #{desc =&gt; &quot;monitor client node&quot;,
<a name="25660"/>25660:            cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="25661"/>25661:                            true = erlang:monitor_node(Node, true),
<a name="25662"/>25662:                            ok
<a name="25663"/>25663:                    end},
<a name="25664"/>25664:          #{desc =&gt; &quot;start remote client on client node&quot;,
<a name="25665"/>25665:            cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="25666"/>25666:                            Pid = api_toc_tcp_client_start(Node),
<a name="25667"/>25667:                            ?SEV_IPRINT(&quot;remote client ~p started&quot;, [Pid]),
<a name="25668"/>25668:                            {ok, State#{rclient =&gt; Pid}}
<a name="25669"/>25669:                    end},
<a name="25670"/>25670:          %% #{desc =&gt; &quot;monitor remote client&quot;,
<a name="25671"/>25671:          %%   cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="25672"/>25672:          %%                   _MRef = erlang:monitor(process, Pid),
<a name="25673"/>25673:          %%                   ok
<a name="25674"/>25674:          %%           end},
<a name="25675"/>25675:          #{desc =&gt; &quot;order remote client to start&quot;,
<a name="25676"/>25676:            cmd  =&gt; fun(#{rclient   := Client,
<a name="25677"/>25677:                          server_sa := ServerSA}) -&gt;
<a name="25678"/>25678:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="25679"/>25679:                            ok
<a name="25680"/>25680:                    end},
<a name="25681"/>25681:          #{desc =&gt; &quot;await remote client ready&quot;,
<a name="25682"/>25682:            cmd  =&gt; fun(#{tester  := Tester,
<a name="25683"/>25683:                          rclient := Client} = _State) -&gt;
<a name="25684"/>25684:                            ?SEV_AWAIT_READY(Client, rclient, init,
<a name="25685"/>25685:                                             [{tester, Tester}])
<a name="25686"/>25686:                    end},
<a name="25687"/>25687:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25688"/>25688:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25689"/>25689:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="25690"/>25690:                            ok
<a name="25691"/>25691:                    end},
<a name="25692"/>25692: 
<a name="25693"/>25693:          %% The actual test
<a name="25694"/>25694:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="25695"/>25695:            cmd  =&gt; fun(#{tester  := Tester,
<a name="25696"/>25696:                          rclient := Client} = State) -&gt;
<a name="25697"/>25697:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, connect,
<a name="25698"/>25698:                                                     [{rclient, Client}]) of
<a name="25699"/>25699:                                {ok, {ConTimeout, ConLimit}} -&gt;
<a name="25700"/>25700:                                    {ok, State#{connect_timeout =&gt; ConTimeout,
<a name="25701"/>25701:                                                connect_limit   =&gt; ConLimit}};
<a name="25702"/>25702:                                {error, _} = ERROR -&gt;
<a name="25703"/>25703:                                    ERROR
<a name="25704"/>25704:                            end
<a name="25705"/>25705:                    end},
<a name="25706"/>25706:          #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="25707"/>25707:            cmd  =&gt; fun(#{rclient         := RClient,
<a name="25708"/>25708:                          connect_timeout := ConTimeout,
<a name="25709"/>25709:                          connect_limit   := ConLimit}) -&gt;
<a name="25710"/>25710:                            ?SEV_ANNOUNCE_CONTINUE(RClient, connect,
<a name="25711"/>25711:                                                   {ConTimeout, ConLimit}),
<a name="25712"/>25712:                            ok
<a name="25713"/>25713:                    end},
<a name="25714"/>25714:          #{desc =&gt; &quot;await remote client ready (connect)&quot;,
<a name="25715"/>25715:            cmd  =&gt; fun(#{tester  := Tester,
<a name="25716"/>25716:                          rclient := RClient} = State) -&gt;
<a name="25717"/>25717:                            case ?SEV_AWAIT_READY(RClient, rclient, connect,
<a name="25718"/>25718:                                                  [{tester, Tester}]) of
<a name="25719"/>25719:                                {ok, ok = _Result} -&gt;
<a name="25720"/>25720:                                    ?SEV_IPRINT(&quot;ok =&gt; success&quot;),
<a name="25721"/>25721:                                    {ok, maps:remove(connect_limit, State)};
<a name="25722"/>25722:                                {ok, {error, {connect_limit_reached,R,L}}} -&gt;
<a name="25723"/>25723:                                    ?SEV_IPRINT(&quot;limit reached - skip: &quot;
<a name="25724"/>25724:                                                &quot;~n   R: ~p&quot;
<a name="25725"/>25725:                                                &quot;~n   L: ~p&quot;, [R, L]),
<a name="25726"/>25726:                                    {skip,
<a name="25727"/>25727:                                     ?SLIB:f(&quot;Connect limit reached ~w: ~w&quot;,
<a name="25728"/>25728:                                            [L, R])};
<a name="25729"/>25729:                                {ok, Result} -&gt;
<a name="25730"/>25730:                                    ?SEV_IPRINT(&quot;result: &quot;
<a name="25731"/>25731:                                                &quot;~n   ~p&quot;, [Result]),
<a name="25732"/>25732:                                    Result;
<a name="25733"/>25733:                                {error, _Reason} = ERROR -&gt;
<a name="25734"/>25734:                                    ?SEV_IPRINT(&quot;error: &quot;
<a name="25735"/>25735:                                                &quot;~n   ~p&quot;, [_Reason]),
<a name="25736"/>25736:                                    ERROR
<a name="25737"/>25737:                            end
<a name="25738"/>25738:                    end},
<a name="25739"/>25739: 
<a name="25740"/>25740:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="25741"/>25741:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25742"/>25742:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="25743"/>25743:                            ok
<a name="25744"/>25744:                    end},
<a name="25745"/>25745: 
<a name="25746"/>25746:          %% Termination
<a name="25747"/>25747:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="25748"/>25748:            cmd  =&gt; fun(#{tester  := Tester,
<a name="25749"/>25749:                          rclient := RClient} = State) -&gt;
<a name="25750"/>25750:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="25751"/>25751:                                                      [{rclient, RClient}]) of
<a name="25752"/>25752:                                ok -&gt;
<a name="25753"/>25753:                                    {ok, maps:remove(tester, State)};
<a name="25754"/>25754:                                {error, _} = ERROR -&gt;
<a name="25755"/>25755:                                    ERROR
<a name="25756"/>25756:                            end
<a name="25757"/>25757:                    end},
<a name="25758"/>25758:          #{desc =&gt; &quot;kill remote client&quot;,
<a name="25759"/>25759:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="25760"/>25760:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="25761"/>25761:                            ok
<a name="25762"/>25762:                    end},
<a name="25763"/>25763:          #{desc =&gt; &quot;await remote client termination&quot;,
<a name="25764"/>25764:            cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="25765"/>25765:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="25766"/>25766:                            State1 = maps:remove(rclient, State),
<a name="25767"/>25767:                            {ok, State1}
<a name="25768"/>25768:                    end},
<a name="25769"/>25769:          #{desc =&gt; &quot;stop client node&quot;,
<a name="25770"/>25770:            cmd  =&gt; fun(#{peer := Peer} = State) -&gt;
<a name="25771"/>25771:                            {ok,
<a name="25772"/>25772:                             try peer:stop(Peer) of
<a name="25773"/>25773:                                 ok -&gt;
<a name="25774"/>25774:                                     State#{node_stop =&gt; ok};
<a name="25775"/>25775:                                 {error, Reason} -&gt;
<a name="25776"/>25776:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="25777"/>25777:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="25778"/>25778:                                     State#{node_stop =&gt; error}
<a name="25779"/>25779:                             catch
<a name="25780"/>25780:                                 C:E:S -&gt;
<a name="25781"/>25781:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="25782"/>25782:                                                 &quot;~n   Class: ~p&quot;
<a name="25783"/>25783:                                                 &quot;~n   Error: ~p&quot;
<a name="25784"/>25784:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="25785"/>25785:                                     State#{node_stop =&gt; error}
<a name="25786"/>25786:                             end}
<a name="25787"/>25787:                    end},
<a name="25788"/>25788:          #{desc =&gt; &quot;await client node termination&quot;,
<a name="25789"/>25789:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State) -&gt;
<a name="25790"/>25790:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="25791"/>25791:                            receive
<a name="25792"/>25792:                                {nodedown, Node} -&gt;
<a name="25793"/>25793:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="25794"/>25794:                                    State1 = maps:remove(peer, State),
<a name="25795"/>25795:                                    State2 = maps:remove(node, State1),
<a name="25796"/>25796:                                    {ok, State2}
<a name="25797"/>25797:                            end;
<a name="25798"/>25798:                       (#{node_stop := error} = State) -&gt;
<a name="25799"/>25799:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="25800"/>25800:                            State1 = maps:remove(peer, State),
<a name="25801"/>25801:                            State2 = maps:remove(node, State1),
<a name="25802"/>25802:                            {ok, State2}
<a name="25803"/>25803:                    end},
<a name="25804"/>25804: 
<a name="25805"/>25805:          %% *** We are done ***
<a name="25806"/>25806:          ?SEV_FINISH_NORMAL
<a name="25807"/>25807:         ],
<a name="25808"/>25808: 
<a name="25809"/>25809:     TesterSeq =
<a name="25810"/>25810:         [
<a name="25811"/>25811:          %% *** Init part ***
<a name="25812"/>25812:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25813"/>25813:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25814"/>25814:                            _MRef = erlang:monitor(process, Server),
<a name="25815"/>25815:                            ok
<a name="25816"/>25816:                    end},
<a name="25817"/>25817:          #{desc =&gt; &quot;monitor client&quot;,
<a name="25818"/>25818:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="25819"/>25819:                            _MRef = erlang:monitor(process, Client),
<a name="25820"/>25820:                            ok
<a name="25821"/>25821:                    end},
<a name="25822"/>25822:          #{desc =&gt; &quot;which local address&quot;,
<a name="25823"/>25823:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25824"/>25824:                            LSA = which_local_socket_addr(Domain),
<a name="25825"/>25825:                            {ok, State#{local_sa =&gt; LSA}}
<a name="25826"/>25826:                    end},
<a name="25827"/>25827:          #{desc =&gt; &quot;order server start&quot;,
<a name="25828"/>25828:            cmd  =&gt; fun(#{server  := Server,
<a name="25829"/>25829:                          backlog := Backlog}) -&gt;
<a name="25830"/>25830:                            ?SEV_ANNOUNCE_START(Server, Backlog),
<a name="25831"/>25831:                            ok
<a name="25832"/>25832:                    end},
<a name="25833"/>25833:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25834"/>25834:            cmd  =&gt; fun(#{server := Server, local_sa := LSA} = State) -&gt;
<a name="25835"/>25835:                            {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="25836"/>25836:                            ServerSA = LSA#{port =&gt; Port},
<a name="25837"/>25837:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="25838"/>25838:                    end},
<a name="25839"/>25839:          #{desc =&gt; &quot;order client start&quot;,
<a name="25840"/>25840:            cmd  =&gt; fun(#{client    := Client,
<a name="25841"/>25841:                          server_sa := ServerSA}) -&gt;
<a name="25842"/>25842:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="25843"/>25843:                            ok
<a name="25844"/>25844:                    end},
<a name="25845"/>25845:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="25846"/>25846:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="25847"/>25847:                            ?SEV_AWAIT_READY(Client, client, init),
<a name="25848"/>25848:                            ok
<a name="25849"/>25849:                    end},
<a name="25850"/>25850: 
<a name="25851"/>25851:          %% The actual test
<a name="25852"/>25852:          %% The server does nothing (this is the point), no accept,
<a name="25853"/>25853:          %% the client tries to connect.
<a name="25854"/>25854:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="25855"/>25855:            cmd  =&gt; fun(#{client        := Client,
<a name="25856"/>25856:                          timeout       := Timeout,
<a name="25857"/>25857:                          connect_limit := ConLimit} = _State) -&gt;
<a name="25858"/>25858:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect,
<a name="25859"/>25859:                                                   {Timeout, ConLimit}),
<a name="25860"/>25860:                            ok
<a name="25861"/>25861:                    end},
<a name="25862"/>25862:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="25863"/>25863:            cmd  =&gt; fun(#{server := Server,
<a name="25864"/>25864:                          client := Client} = _State) -&gt;
<a name="25865"/>25865:                            case ?SEV_AWAIT_READY(Client, client, connect,
<a name="25866"/>25866:                                                  [{server, Server}]) of
<a name="25867"/>25867:                                ok -&gt;
<a name="25868"/>25868:                                    ok;
<a name="25869"/>25869:                                {error, _} = ERROR -&gt;
<a name="25870"/>25870:                                    ERROR
<a name="25871"/>25871:                            end
<a name="25872"/>25872:                    end},
<a name="25873"/>25873: 
<a name="25874"/>25874: 
<a name="25875"/>25875:          %% *** Terminate server ***
<a name="25876"/>25876:          #{desc =&gt; &quot;order client terminate&quot;,
<a name="25877"/>25877:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="25878"/>25878:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="25879"/>25879:                            ok
<a name="25880"/>25880:                    end},
<a name="25881"/>25881:          #{desc =&gt; &quot;await client down&quot;,
<a name="25882"/>25882:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="25883"/>25883:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="25884"/>25884:                            State1 = maps:remove(client,    State),
<a name="25885"/>25885:                            {ok, State1}
<a name="25886"/>25886:                    end},
<a name="25887"/>25887:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="25888"/>25888:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25889"/>25889:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25890"/>25890:                            ok
<a name="25891"/>25891:                    end},
<a name="25892"/>25892:          #{desc =&gt; &quot;await server down&quot;,
<a name="25893"/>25893:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25894"/>25894:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25895"/>25895:                            State1 = maps:remove(server,    State),
<a name="25896"/>25896:                            State2 = maps:remove(server_sa, State1),
<a name="25897"/>25897:                            {ok, State2}
<a name="25898"/>25898:                    end},
<a name="25899"/>25899: 
<a name="25900"/>25900:          %% *** We are done ***
<a name="25901"/>25901:          ?SEV_FINISH_NORMAL
<a name="25902"/>25902:         ],
<a name="25903"/>25903: 
<a name="25904"/>25904:     i(&quot;create server evaluator&quot;),
<a name="25905"/>25905:     ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="25906"/>25906:     Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="25907"/>25907: 
<a name="25908"/>25908:     i(&quot;create client evaluator&quot;),
<a name="25909"/>25909:     ClientInitState = #{host   =&gt; local_host(),
<a name="25910"/>25910:                         domain =&gt; maps:get(domain, InitState)},
<a name="25911"/>25911:     Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="25912"/>25912: 
<a name="25913"/>25913:     i(&quot;create tester evaluator&quot;),
<a name="25914"/>25914:     TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="25915"/>25915:                                  client =&gt; Client#ev.pid},
<a name="25916"/>25916:     Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="25917"/>25917: 
<a name="25918"/>25918:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_connect_tcp-last_expr"/><a name="25919"/>25919: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="25920"/>25920: 
<a name="25921"/>25921: 
<a name="api_toc_tcp_client_start-1"/><a name="25922"/>25922: <b>api_toc_tcp_client_start</b>(Node) -&gt;
<a name="api_toc_tcp_client_start-last_expr"/><a name="25923"/>25923: <b>    api_toc_tcp_client_start</b>(Node, 5000).
<a name="api_toc_tcp_client_start-2"/><a name="25924"/>25924: <b>api_toc_tcp_client_start</b>(Node, Timeout) -&gt;
<a name="25925"/>25925:     Self = self(),
<a name="25926"/>25926:     Fun  = fun() -&gt; api_toc_tcp_client(Self) end,
<a name="25927"/>25927:     {Pid, MRef} = erlang:spawn_monitor(Node, Fun),
<a name="api_toc_tcp_client_start-last_expr"/><a name="25928"/>25928:     receive
<a name="25929"/>25929:         {Pid, started} -&gt;
<a name="25930"/>25930:             Pid;
<a name="25931"/>25931:         {'DOWN', MRef, process, Pid, Reason} -&gt;
<a name="25932"/>25932:             {error, Reason};
<a name="25933"/>25933:         {nodedown, Node} = NODEDOWN -&gt;
<a name="25934"/>25934:             {error, NODEDOWN}
<a name="25935"/>25935:     after Timeout -&gt;
<a name="25936"/>25936:             {error, timeout}
<a name="25937"/>25937:     end.
<a name="25938"/>25938: 
<a name="api_toc_tcp_client-1"/><a name="25939"/>25939: <b>api_toc_tcp_client</b>(Parent) -&gt;
<a name="25940"/>25940:     api_toc_tcp_client_init(Parent),
<a name="25941"/>25941:     ServerSA = api_toc_tcp_client_await_start(Parent),
<a name="25942"/>25942:     Domain   = maps:get(family, ServerSA),
<a name="25943"/>25943:     api_toc_tcp_client_announce_ready(Parent, init),
<a name="25944"/>25944:     {To, ConLimit} = api_toc_tcp_client_await_continue(Parent, connect),
<a name="25945"/>25945:     Result = api_to_connect_tcp_await_timeout(To, ServerSA, Domain, ConLimit),
<a name="25946"/>25946:     ?SEV_IPRINT(&quot;(client) connect result: ~p&quot;, [Result]),
<a name="25947"/>25947:     api_toc_tcp_client_announce_ready(Parent, connect, Result),
<a name="25948"/>25948:     Reason = api_toc_tcp_client_await_terminate(Parent),
<a name="api_toc_tcp_client-last_expr"/><a name="25949"/>25949: <b>    exit</b>(Reason).
<a name="25950"/>25950: 
<a name="api_toc_tcp_client_init-1"/><a name="25951"/>25951: <b>api_toc_tcp_client_init</b>(Parent) -&gt;
<a name="25952"/>25952:     put(sname, &quot;rclient&quot;),
<a name="25953"/>25953:     %% i(&quot;api_toc_tcp_client_init -&gt; entry&quot;),
<a name="25954"/>25954:     _MRef = erlang:monitor(process, Parent),
<a name="25955"/>25955:     Parent ! {self(), started},
<a name="api_toc_tcp_client_init-last_expr"/><a name="25956"/>25956:     ok.
<a name="25957"/>25957: 
<a name="api_toc_tcp_client_await_start-1"/><a name="25958"/>25958: <b>api_toc_tcp_client_await_start</b>(Parent) -&gt;
<a name="25959"/>25959:     %% i(&quot;api_toc_tcp_client_await_start -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_start-last_expr"/><a name="25960"/>25960: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="25961"/>25961: 
<a name="api_toc_tcp_client_announce_ready-2"/><a name="25962"/>25962: <b>api_toc_tcp_client_announce_ready</b>(Parent, Slogan) -&gt;
<a name="api_toc_tcp_client_announce_ready-last_expr"/><a name="25963"/>25963: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="api_toc_tcp_client_announce_ready-3"/><a name="25964"/>25964: <b>api_toc_tcp_client_announce_ready</b>(Parent, Slogan, Result) -&gt;
<a name="api_toc_tcp_client_announce_ready-last_expr"/><a name="25965"/>25965: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan, Result).
<a name="25966"/>25966: 
<a name="api_toc_tcp_client_await_continue-2"/><a name="25967"/>25967: <b>api_toc_tcp_client_await_continue</b>(Parent, Slogan) -&gt;
<a name="25968"/>25968:     %% i(&quot;api_toc_tcp_client_await_continue -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_continue-last_expr"/><a name="25969"/>25969: <b>    case ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan) of
<a name="25970"/>25970:         ok -&gt;
<a name="25971"/>25971:             ok;
<a name="25972"/>25972:         {ok, Extra} -&gt;
<a name="25973"/>25973:             Extra;
<a name="25974"/>25974:         {error, Reason} -&gt;
<a name="25975"/>25975:             exit({await_continue, Slogan, Reason})
<a name="25976"/>25976:     end.
<a name="25977"/>25977: 
<a name="api_toc_tcp_client_await_terminate-1"/><a name="25978"/>25978: <b>api_toc_tcp_client_await_terminate</b>(Parent) -&gt;
<a name="25979"/>25979:     %% i(&quot;api_toc_tcp_client_await_terminate -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_terminate-last_expr"/><a name="25980"/>25980: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="25981"/>25981:         ok -&gt;
<a name="25982"/>25982:             ok;
<a name="25983"/>25983:         {error, Reason} -&gt;
<a name="25984"/>25984:             Reason
<a name="25985"/>25985:     end.
<a name="25986"/>25986: 
<a name="api_to_connect_tcp_await_timeout-4"/><a name="25987"/>25987: <b>api_to_connect_tcp_await_timeout</b>(To, ServerSA, Domain, ConLimit) -&gt;
<a name="25988"/>25988:     LSA = which_local_socket_addr(Domain),
<a name="25989"/>25989:     NewSock = fun() -&gt;
<a name="25990"/>25990:                       S = case socket:open(Domain, stream, tcp) of
<a name="25991"/>25991:                               {ok, Sock} -&gt;
<a name="25992"/>25992:                                   Sock;
<a name="25993"/>25993:                               {error, OReason} -&gt;
<a name="25994"/>25994:                                   ?FAIL({open, OReason})
<a name="25995"/>25995:                           end,
<a name="25996"/>25996:                       case socket:bind(S, LSA) of
<a name="25997"/>25997:                           ok -&gt;
<a name="25998"/>25998:                               S;
<a name="25999"/>25999:                           {error, BReason} -&gt;
<a name="26000"/>26000:                               ?FAIL({bind, BReason})
<a name="26001"/>26001:                       end
<a name="26002"/>26002:               end,
<a name="api_to_connect_tcp_await_timeout-last_expr"/><a name="26003"/>26003: <b>    api_to_connect_tcp_await_timeout</b>(1, ConLimit, To, ServerSA, NewSock, []).
<a name="26004"/>26004: 
<a name="api_to_connect_tcp_await_timeout-6"/><a name="26005"/>26005: <b>api_to_connect_tcp_await_timeout</b>(ID, ConLimit, _To, _ServerSA, _NewSock, Acc)
<a name="26006"/>26006:   when (ID &gt; ConLimit) -&gt;
<a name="26007"/>26007:     api_to_connect_tcp_await_timeout3(Acc),
<a name="26008"/>26008:     {error, {connect_limit_reached, ID, ConLimit}};
<a name="26009"/>26009: <b>api_to_connect_tcp_await_timeout</b>(ID, ConLimit, To, ServerSA, NewSock, Acc) -&gt;
<a name="api_to_connect_tcp_await_timeout-last_expr"/><a name="26010"/>26010: <b>    case api_to_connect_tcp_await_timeout2</b>(ID, To, ServerSA, NewSock) of
<a name="26011"/>26011:         ok -&gt;
<a name="26012"/>26012:             %% ?SEV_IPRINT(&quot;success when number of socks: ~w&quot;, [length(Acc)]),
<a name="26013"/>26013:             api_to_connect_tcp_await_timeout3(Acc),
<a name="26014"/>26014:             ok;
<a name="26015"/>26015:         {ok, Sock} -&gt;
<a name="26016"/>26016:             %% ?SEV_IPRINT(&quot;~w: unexpected success (connect)&quot;, [ID]),
<a name="26017"/>26017:             api_to_connect_tcp_await_timeout(ID+1, ConLimit,
<a name="26018"/>26018:                                              To, ServerSA, NewSock,
<a name="26019"/>26019:                                              [Sock|Acc]);
<a name="26020"/>26020:         {error, _} = ERROR -&gt;
<a name="26021"/>26021:             ERROR
<a name="26022"/>26022:     end.
<a name="26023"/>26023: 
<a name="api_to_connect_tcp_await_timeout2-4"/><a name="26024"/>26024: <b>api_to_connect_tcp_await_timeout2</b>(_ID, To, ServerSA, NewSock) -&gt;
<a name="26025"/>26025:     Sock = NewSock(),
<a name="26026"/>26026:     %% ?SEV_IPRINT(&quot;~w: try connect&quot;, [ID]),
<a name="26027"/>26027:     Start = ?TS(),
<a name="api_to_connect_tcp_await_timeout2-last_expr"/><a name="26028"/>26028: <b>    case socket:connect</b>(Sock, ServerSA, To) of
<a name="26029"/>26029:         {error, timeout} -&gt;
<a name="26030"/>26030:             Stop  = ?TS(),
<a name="26031"/>26031:             TDiff = Stop - Start,
<a name="26032"/>26032:             if
<a name="26033"/>26033:                 (TDiff &gt;= To) -&gt;
<a name="26034"/>26034:                     (catch socket:close(Sock)),
<a name="26035"/>26035:                     ok;
<a name="26036"/>26036:                 true -&gt;
<a name="26037"/>26037:                     (catch socket:close(Sock)),
<a name="26038"/>26038:                     ?FAIL({unexpected_timeout, TDiff, To})
<a name="26039"/>26039:             end;
<a name="26040"/>26040:         {error, econnreset = _Reason} -&gt;
<a name="26041"/>26041:             (catch socket:close(Sock)),
<a name="26042"/>26042:             ok;
<a name="26043"/>26043:         {error, Reason} -&gt;
<a name="26044"/>26044:             (catch socket:close(Sock)),
<a name="26045"/>26045:             ?FAIL({connect, Reason});
<a name="26046"/>26046:         ok -&gt;
<a name="26047"/>26047:             {ok, Sock}
<a name="26048"/>26048:     end.
<a name="26049"/>26049: 
<a name="api_to_connect_tcp_await_timeout3-1"/><a name="26050"/>26050: <b>api_to_connect_tcp_await_timeout3</b>([]) -&gt;
<a name="26051"/>26051:     ok;
<a name="26052"/>26052: <b>api_to_connect_tcp_await_timeout3</b>([Sock|Socka]) -&gt;
<a name="26053"/>26053:     (catch socket:close(Sock)),
<a name="api_to_connect_tcp_await_timeout3-last_expr"/><a name="26054"/>26054: <b>    api_to_connect_tcp_await_timeout3</b>(Socka).
<a name="26055"/>26055: 
<a name="26056"/>26056: 
<a name="26057"/>26057: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26058"/>26058: 
<a name="26059"/>26059: <i>%% This test case is intended to test the accept timeout option</i>
<a name="26060"/>26060: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_accept_tcp4-1"/><a name="26061"/>26061: <b>api_to_accept_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26062"/>26062:     ?TT(?SECS(10)),
<a name="api_to_accept_tcp4-last_expr"/><a name="26063"/>26063: <b>    tc_try</b>(api_to_accept_tcp4,
<a name="26064"/>26064:            fun() -&gt; has_support_ipv4() end,
<a name="26065"/>26065:            fun() -&gt;
<a name="26066"/>26066:                    InitState = #{domain =&gt; inet, timeout =&gt; 5000},
<a name="26067"/>26067:                    ok = api_to_accept_tcp(InitState)
<a name="26068"/>26068:            end).
<a name="26069"/>26069: 
<a name="26070"/>26070: 
<a name="26071"/>26071: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26072"/>26072: 
<a name="26073"/>26073: <i>%% This test case is intended to test the accept timeout option</i>
<a name="26074"/>26074: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_accept_tcp6-1"/><a name="26075"/>26075: <b>api_to_accept_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="26076"/>26076:     ?TT(?SECS(10)),
<a name="api_to_accept_tcp6-last_expr"/><a name="26077"/>26077: <b>    tc_try</b>(api_to_accept_tcp6,
<a name="26078"/>26078:            fun() -&gt; has_support_ipv6() end,
<a name="26079"/>26079:            fun() -&gt;
<a name="26080"/>26080:                    InitState = #{domain =&gt; inet6, timeout =&gt; 5000},
<a name="26081"/>26081:                    ok = api_to_accept_tcp(InitState)
<a name="26082"/>26082:            end).
<a name="26083"/>26083: 
<a name="26084"/>26084: 
<a name="26085"/>26085: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26086"/>26086: 
<a name="api_to_accept_tcp-1"/><a name="26087"/>26087: <b>api_to_accept_tcp</b>(InitState) -&gt;
<a name="26088"/>26088:     TesterSeq =
<a name="26089"/>26089:         [
<a name="26090"/>26090:          %% *** Init part ***
<a name="26091"/>26091:          #{desc =&gt; &quot;which local address&quot;,
<a name="26092"/>26092:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26093"/>26093:                            LSA = which_local_socket_addr(Domain),
<a name="26094"/>26094:                            {ok, State#{lsa =&gt; LSA}}
<a name="26095"/>26095:                    end},
<a name="26096"/>26096:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="26097"/>26097:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26098"/>26098:                            case socket:open(Domain, stream, tcp) of
<a name="26099"/>26099:                                {ok, Sock} -&gt;
<a name="26100"/>26100:                                    {ok, State#{lsock =&gt; Sock}};
<a name="26101"/>26101:                                {error, _} = ERROR -&gt;
<a name="26102"/>26102:                                    ERROR
<a name="26103"/>26103:                            end
<a name="26104"/>26104:                    end},
<a name="26105"/>26105:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26106"/>26106:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = _State) -&gt;
<a name="26107"/>26107:                            case sock_bind(LSock, LSA) of
<a name="26108"/>26108:                                ok -&gt;
<a name="26109"/>26109:                                    ok;
<a name="26110"/>26110:                                {error, _} = ERROR -&gt;
<a name="26111"/>26111:                                    ERROR
<a name="26112"/>26112:                            end
<a name="26113"/>26113:                    end},
<a name="26114"/>26114:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="26115"/>26115:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="26116"/>26116:                            socket:listen(LSock)
<a name="26117"/>26117:                    end},
<a name="26118"/>26118: 
<a name="26119"/>26119:          %% *** The actual test part ***
<a name="26120"/>26120:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="26121"/>26121:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="26122"/>26122:                            Start = ?TS(),
<a name="26123"/>26123:                            case socket:accept(LSock, To) of
<a name="26124"/>26124:                                {error, timeout} -&gt;
<a name="26125"/>26125:                                    {ok, State#{start =&gt; Start, stop =&gt; ?TS()}};
<a name="26126"/>26126:                                {ok, Sock} -&gt;
<a name="26127"/>26127:                                    (catch socket:close(Sock)),
<a name="26128"/>26128:                                    {error, unexpected_success};
<a name="26129"/>26129:                                {error, _} = ERROR -&gt;
<a name="26130"/>26130:                                    ERROR
<a name="26131"/>26131:                            end
<a name="26132"/>26132:                    end},
<a name="26133"/>26133:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="26134"/>26134:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="26135"/>26135:                            TDiff  = Stop - Start,
<a name="26136"/>26136:                            if
<a name="26137"/>26137:                                (TDiff &gt;= To) -&gt;
<a name="26138"/>26138:                                    ok;
<a name="26139"/>26139:                                true -&gt;
<a name="26140"/>26140:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="26141"/>26141:                            end
<a name="26142"/>26142:                    end},
<a name="26143"/>26143: 
<a name="26144"/>26144:          %% *** Close (listen) socket ***
<a name="26145"/>26145:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="26146"/>26146:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="26147"/>26147:                            sock_close(LSock),
<a name="26148"/>26148:                            {ok, maps:remove(sock3, State)}
<a name="26149"/>26149:                    end},
<a name="26150"/>26150: 
<a name="26151"/>26151:          %% *** We are done ***
<a name="26152"/>26152:          ?SEV_FINISH_NORMAL
<a name="26153"/>26153:         ],
<a name="26154"/>26154: 
<a name="26155"/>26155:     i(&quot;create tester evaluator&quot;),
<a name="26156"/>26156:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="26157"/>26157: 
<a name="26158"/>26158:     i(&quot;await evaluator&quot;),
<a name="api_to_accept_tcp-last_expr"/><a name="26159"/>26159: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="26160"/>26160: 
<a name="26161"/>26161: 
<a name="26162"/>26162: 
<a name="26163"/>26163: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26164"/>26164: 
<a name="26165"/>26165: <i>%% This test case is intended to test the multi accept timeout option</i>
<a name="26166"/>26166: <i>%% on an IPv4 TCP (stream) socket with multiple acceptor processes </i>
<a name="26167"/>26167: <i>%% (three in this case).</i>
<a name="api_to_maccept_tcp4-1"/><a name="26168"/>26168: <b>api_to_maccept_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26169"/>26169:     ?TT(?SECS(20)),
<a name="api_to_maccept_tcp4-last_expr"/><a name="26170"/>26170: <b>    tc_try</b>(api_to_maccept_tcp4,
<a name="26171"/>26171:            fun() -&gt; has_support_ipv4() end,
<a name="26172"/>26172:            fun() -&gt;
<a name="26173"/>26173:                    InitState = #{domain =&gt; inet, timeout =&gt; 5000},
<a name="26174"/>26174:                    ok = api_to_maccept_tcp(InitState)
<a name="26175"/>26175:            end).
<a name="26176"/>26176: 
<a name="26177"/>26177: 
<a name="26178"/>26178: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26179"/>26179: 
<a name="26180"/>26180: <i>%% This test case is intended to test the accept timeout option</i>
<a name="26181"/>26181: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_maccept_tcp6-1"/><a name="26182"/>26182: <b>api_to_maccept_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="26183"/>26183:     ?TT(?SECS(20)),
<a name="api_to_maccept_tcp6-last_expr"/><a name="26184"/>26184: <b>    tc_try</b>(api_to_maccept_tcp6,
<a name="26185"/>26185:            fun() -&gt; has_support_ipv6() end,
<a name="26186"/>26186:            fun() -&gt;
<a name="26187"/>26187:                    InitState = #{domain =&gt; inet6, timeout =&gt; 5000},
<a name="26188"/>26188:                    ok = api_to_maccept_tcp(InitState)
<a name="26189"/>26189:            end).
<a name="26190"/>26190: 
<a name="26191"/>26191: 
<a name="26192"/>26192: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26193"/>26193: 
<a name="api_to_maccept_tcp-1"/><a name="26194"/>26194: <b>api_to_maccept_tcp</b>(InitState) -&gt;
<a name="26195"/>26195:     PrimAcceptorSeq =
<a name="26196"/>26196:         [
<a name="26197"/>26197:          %% *** Init part ***
<a name="26198"/>26198:          #{desc =&gt; &quot;await start&quot;,
<a name="26199"/>26199:            cmd  =&gt; fun(State) -&gt;
<a name="26200"/>26200:                            Tester = ?SEV_AWAIT_START(),
<a name="26201"/>26201:                            {ok, State#{tester =&gt; Tester}}
<a name="26202"/>26202:                    end},
<a name="26203"/>26203:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26204"/>26204:            cmd  =&gt; fun(#{tester := Pid} = _State) -&gt;
<a name="26205"/>26205:                            _MRef = erlang:monitor(process, Pid),
<a name="26206"/>26206:                            ok
<a name="26207"/>26207:                    end},
<a name="26208"/>26208:          #{desc =&gt; &quot;which local address&quot;,
<a name="26209"/>26209:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26210"/>26210:                            LSA = which_local_socket_addr(Domain),
<a name="26211"/>26211:                            {ok, State#{lsa =&gt; LSA}}
<a name="26212"/>26212:                    end},
<a name="26213"/>26213:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="26214"/>26214:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26215"/>26215:                            case socket:open(Domain, stream, tcp) of
<a name="26216"/>26216:                                {ok, Sock} -&gt;
<a name="26217"/>26217:                                    {ok, State#{lsock =&gt; Sock}};
<a name="26218"/>26218:                                {error, _} = ERROR -&gt;
<a name="26219"/>26219:                                    ERROR
<a name="26220"/>26220:                            end
<a name="26221"/>26221:                    end},
<a name="26222"/>26222:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26223"/>26223:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = _State) -&gt;
<a name="26224"/>26224:                            case sock_bind(LSock, LSA) of
<a name="26225"/>26225:                                ok -&gt;
<a name="26226"/>26226:                                    ok;
<a name="26227"/>26227:                                {error, _} = ERROR -&gt;
<a name="26228"/>26228:                                    ERROR
<a name="26229"/>26229:                            end
<a name="26230"/>26230:                    end},
<a name="26231"/>26231:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="26232"/>26232:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="26233"/>26233:                            socket:listen(LSock)
<a name="26234"/>26234:                    end},
<a name="26235"/>26235:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26236"/>26236:            cmd  =&gt; fun(#{lsock := LSock, tester := Tester}) -&gt;
<a name="26237"/>26237:                            ?SEV_ANNOUNCE_READY(Tester, init, LSock),
<a name="26238"/>26238:                            ok
<a name="26239"/>26239:                    end},
<a name="26240"/>26240: 
<a name="26241"/>26241:          %% *** The actual test ***
<a name="26242"/>26242:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="26243"/>26243:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26244"/>26244:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="26245"/>26245:                    end},
<a name="26246"/>26246:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="26247"/>26247:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="26248"/>26248:                            Start = ?TS(),
<a name="26249"/>26249:                            case socket:accept(LSock, To) of
<a name="26250"/>26250:                                {error, timeout} -&gt;
<a name="26251"/>26251:                                    {ok, State#{start =&gt; Start, stop =&gt; ?TS()}};
<a name="26252"/>26252:                                {ok, Sock} -&gt;
<a name="26253"/>26253:                                    ?SEV_EPRINT(&quot;Unexpected accept success: &quot;
<a name="26254"/>26254:                                                &quot;~n   ~p&quot;, [Sock]),
<a name="26255"/>26255:                                    (catch socket:close(Sock)),
<a name="26256"/>26256:                                    {error, unexpected_success};
<a name="26257"/>26257:                                {error, _} = ERROR -&gt;
<a name="26258"/>26258:                                    ERROR
<a name="26259"/>26259:                            end
<a name="26260"/>26260:                    end},
<a name="26261"/>26261:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="26262"/>26262:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="26263"/>26263:                            TDiff  = Stop - Start,
<a name="26264"/>26264:                            if
<a name="26265"/>26265:                                (TDiff &gt;= To) -&gt;
<a name="26266"/>26266:                                    ok;
<a name="26267"/>26267:                                true -&gt;
<a name="26268"/>26268:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="26269"/>26269:                            end
<a name="26270"/>26270:                    end},
<a name="26271"/>26271:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="26272"/>26272:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26273"/>26273:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="26274"/>26274:                            ok
<a name="26275"/>26275:                    end},
<a name="26276"/>26276: 
<a name="26277"/>26277:          %% *** Terminate ***
<a name="26278"/>26278:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26279"/>26279:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26280"/>26280:                            ?SEV_AWAIT_TERMINATE(Tester, tester),
<a name="26281"/>26281:                            ok
<a name="26282"/>26282:                    end},
<a name="26283"/>26283:          %% *** Close (listen) socket ***
<a name="26284"/>26284:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="26285"/>26285:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="26286"/>26286:                            sock_close(LSock),
<a name="26287"/>26287:                            {ok, maps:remove(lsock, State)}
<a name="26288"/>26288:                    end},
<a name="26289"/>26289: 
<a name="26290"/>26290:          %% *** We are done ***
<a name="26291"/>26291:          ?SEV_FINISH_NORMAL
<a name="26292"/>26292:         ],
<a name="26293"/>26293: 
<a name="26294"/>26294: 
<a name="26295"/>26295:     SecAcceptorSeq =
<a name="26296"/>26296:         [
<a name="26297"/>26297:          %% *** Init part ***
<a name="26298"/>26298:          #{desc =&gt; &quot;await start&quot;,
<a name="26299"/>26299:            cmd  =&gt; fun(State) -&gt;
<a name="26300"/>26300:                            {Tester, LSock} = ?SEV_AWAIT_START(),
<a name="26301"/>26301:                            {ok, State#{tester =&gt; Tester,
<a name="26302"/>26302:                                        lsock  =&gt; LSock}}
<a name="26303"/>26303:                            
<a name="26304"/>26304:                    end},
<a name="26305"/>26305:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26306"/>26306:            cmd  =&gt; fun(#{tester := Pid} = _State) -&gt;
<a name="26307"/>26307:                            _MRef = erlang:monitor(process, Pid),
<a name="26308"/>26308:                            ok
<a name="26309"/>26309:                    end},
<a name="26310"/>26310:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26311"/>26311:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26312"/>26312:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="26313"/>26313:                            ok
<a name="26314"/>26314:                    end},
<a name="26315"/>26315: 
<a name="26316"/>26316:          %% *** The actual test part ***
<a name="26317"/>26317:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="26318"/>26318:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26319"/>26319:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="26320"/>26320:                    end},
<a name="26321"/>26321:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="26322"/>26322:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="26323"/>26323:                            Start = ?TS(),
<a name="26324"/>26324:                            case socket:accept(LSock, To) of
<a name="26325"/>26325:                                {error, timeout} -&gt;
<a name="26326"/>26326:                                    {ok, State#{start =&gt; Start, stop =&gt; ?TS()}};
<a name="26327"/>26327:                                {ok, Sock} -&gt;
<a name="26328"/>26328:                                    (catch socket:close(Sock)),
<a name="26329"/>26329:                                    {error, unexpected_success};
<a name="26330"/>26330:                                {error, _} = ERROR -&gt;
<a name="26331"/>26331:                                    ERROR
<a name="26332"/>26332:                            end
<a name="26333"/>26333:                    end},
<a name="26334"/>26334:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="26335"/>26335:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = State) -&gt;
<a name="26336"/>26336:                            TDiff  = Stop - Start,
<a name="26337"/>26337:                            if
<a name="26338"/>26338:                                (TDiff &gt;= To) -&gt;
<a name="26339"/>26339:                                    State1 = maps:remove(start, State),
<a name="26340"/>26340:                                    State2 = maps:remove(stop,  State1),
<a name="26341"/>26341:                                    {ok, State2};
<a name="26342"/>26342:                                true -&gt;
<a name="26343"/>26343:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="26344"/>26344:                            end
<a name="26345"/>26345:                    end},
<a name="26346"/>26346:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="26347"/>26347:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26348"/>26348:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="26349"/>26349:                            ok
<a name="26350"/>26350:                    end},
<a name="26351"/>26351: 
<a name="26352"/>26352:          %% *** Terminate ***
<a name="26353"/>26353:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26354"/>26354:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="26355"/>26355:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="26356"/>26356:                                ok -&gt;
<a name="26357"/>26357:                                    {ok, maps:remove(tester, State)};
<a name="26358"/>26358:                                {error, _} = ERROR -&gt;
<a name="26359"/>26359:                                    ERROR
<a name="26360"/>26360:                            end
<a name="26361"/>26361:                    end},
<a name="26362"/>26362: 
<a name="26363"/>26363:          %% *** We are done ***
<a name="26364"/>26364:          ?SEV_FINISH_NORMAL
<a name="26365"/>26365:         ],
<a name="26366"/>26366: 
<a name="26367"/>26367: 
<a name="26368"/>26368:     TesterSeq =
<a name="26369"/>26369:         [
<a name="26370"/>26370:          %% Init part
<a name="26371"/>26371:          #{desc =&gt; &quot;monitor prim-acceptor&quot;,
<a name="26372"/>26372:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26373"/>26373:                            _MRef = erlang:monitor(process, Pid),
<a name="26374"/>26374:                            ok
<a name="26375"/>26375:                    end},
<a name="26376"/>26376:          #{desc =&gt; &quot;monitor sec-acceptor 1&quot;,
<a name="26377"/>26377:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26378"/>26378:                            _MRef = erlang:monitor(process, Pid),
<a name="26379"/>26379:                            ok
<a name="26380"/>26380:                    end},
<a name="26381"/>26381:          #{desc =&gt; &quot;monitor sec-acceptor 2&quot;,
<a name="26382"/>26382:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26383"/>26383:                            _MRef = erlang:monitor(process, Pid),
<a name="26384"/>26384:                            ok
<a name="26385"/>26385:                    end},
<a name="26386"/>26386: 
<a name="26387"/>26387: 
<a name="26388"/>26388:          %% Start the prim-acceptor
<a name="26389"/>26389:          #{desc =&gt; &quot;start prim-acceptor&quot;,
<a name="26390"/>26390:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26391"/>26391:                            ?SEV_ANNOUNCE_START(Pid),
<a name="26392"/>26392:                            ok
<a name="26393"/>26393:                    end},
<a name="26394"/>26394:          #{desc =&gt; &quot;await prim-acceptor ready (init)&quot;,
<a name="26395"/>26395:            cmd  =&gt; fun(#{prim_acceptor := Pid} = State) -&gt;
<a name="26396"/>26396:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, prim_acceptor, init),
<a name="26397"/>26397:                            {ok, State#{lsock =&gt; Sock}}
<a name="26398"/>26398:                    end},
<a name="26399"/>26399: 
<a name="26400"/>26400:          %% Start sec-acceptor-1
<a name="26401"/>26401:          #{desc =&gt; &quot;start sec-acceptor 1&quot;,
<a name="26402"/>26402:            cmd  =&gt; fun(#{sec_acceptor1 := Pid, lsock := LSock} = _State) -&gt;
<a name="26403"/>26403:                            ?SEV_ANNOUNCE_START(Pid, LSock),
<a name="26404"/>26404:                            ok
<a name="26405"/>26405:                    end},
<a name="26406"/>26406:          #{desc =&gt; &quot;await sec-acceptor 1 ready (init)&quot;,
<a name="26407"/>26407:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26408"/>26408:                            ?SEV_AWAIT_READY(Pid, sec_acceptor1, init)
<a name="26409"/>26409:                    end},
<a name="26410"/>26410: 
<a name="26411"/>26411:          %% Start sec-acceptor-2
<a name="26412"/>26412:          #{desc =&gt; &quot;start sec-acceptor 2&quot;,
<a name="26413"/>26413:            cmd  =&gt; fun(#{sec_acceptor2 := Pid, lsock := LSock} = _State) -&gt;
<a name="26414"/>26414:                            ?SEV_ANNOUNCE_START(Pid, LSock),
<a name="26415"/>26415:                            ok
<a name="26416"/>26416:                    end},
<a name="26417"/>26417:          #{desc =&gt; &quot;await sec-acceptor 2 ready (init)&quot;,
<a name="26418"/>26418:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26419"/>26419:                            ?SEV_AWAIT_READY(Pid, sec_acceptor2, init)
<a name="26420"/>26420:                    end},
<a name="26421"/>26421: 
<a name="26422"/>26422:          %% Activate the acceptor(s)
<a name="26423"/>26423:          #{desc =&gt; &quot;active prim-acceptor&quot;,
<a name="26424"/>26424:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26425"/>26425:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="26426"/>26426:                            ok
<a name="26427"/>26427:                    end},
<a name="26428"/>26428:          #{desc =&gt; &quot;active sec-acceptor 1&quot;,
<a name="26429"/>26429:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26430"/>26430:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="26431"/>26431:                            ok
<a name="26432"/>26432:                    end},
<a name="26433"/>26433:          #{desc =&gt; &quot;active sec-acceptor 2&quot;,
<a name="26434"/>26434:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26435"/>26435:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="26436"/>26436:                            ok
<a name="26437"/>26437:                    end},
<a name="26438"/>26438: 
<a name="26439"/>26439:          %% Await acceptor(s) completions
<a name="26440"/>26440:          #{desc =&gt; &quot;await prim-acceptor ready (accept)&quot;,
<a name="26441"/>26441:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26442"/>26442:                            ?SEV_AWAIT_READY(Pid, prim_acceptor, accept)
<a name="26443"/>26443:                    end},
<a name="26444"/>26444:          #{desc =&gt; &quot;await sec-acceptor 1 ready (accept)&quot;,
<a name="26445"/>26445:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26446"/>26446:                            ?SEV_AWAIT_READY(Pid, sec_acceptor1, accept)
<a name="26447"/>26447:                    end},
<a name="26448"/>26448:          #{desc =&gt; &quot;await sec-acceptor 2 ready (accept)&quot;,
<a name="26449"/>26449:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26450"/>26450:                            ?SEV_AWAIT_READY(Pid, sec_acceptor2, accept)
<a name="26451"/>26451:                    end},
<a name="26452"/>26452: 
<a name="26453"/>26453:          %% Terminate
<a name="26454"/>26454:          #{desc =&gt; &quot;order prim-acceptor to terminate&quot;,
<a name="26455"/>26455:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26456"/>26456:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="26457"/>26457:                            ok
<a name="26458"/>26458:                    end},
<a name="26459"/>26459:          #{desc =&gt; &quot;await prim-acceptor termination&quot;,
<a name="26460"/>26460:            cmd  =&gt; fun(#{prim_acceptor := Pid} = State) -&gt;
<a name="26461"/>26461:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="26462"/>26462:                                ok -&gt;
<a name="26463"/>26463:                                    State1 = maps:remove(prim_acceptor, State),
<a name="26464"/>26464:                                    {ok, State1};
<a name="26465"/>26465:                                {error, _} = ERROR -&gt;
<a name="26466"/>26466:                                    ERROR
<a name="26467"/>26467:                            end
<a name="26468"/>26468:                    end},
<a name="26469"/>26469:          #{desc =&gt; &quot;order sec-acceptor 1 to terminate&quot;,
<a name="26470"/>26470:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26471"/>26471:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="26472"/>26472:                            ok
<a name="26473"/>26473:                    end},
<a name="26474"/>26474:          #{desc =&gt; &quot;await sec-acceptor 1 termination&quot;,
<a name="26475"/>26475:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = State) -&gt;
<a name="26476"/>26476:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="26477"/>26477:                                ok -&gt;
<a name="26478"/>26478:                                    State1 = maps:remove(sec_acceptor1, State),
<a name="26479"/>26479:                                    {ok, State1};
<a name="26480"/>26480:                                {error, _} = ERROR -&gt;
<a name="26481"/>26481:                                    ERROR
<a name="26482"/>26482:                            end
<a name="26483"/>26483:                    end},
<a name="26484"/>26484:          #{desc =&gt; &quot;order sec-acceptor 2 to terminate&quot;,
<a name="26485"/>26485:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26486"/>26486:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="26487"/>26487:                            ok
<a name="26488"/>26488:                    end},
<a name="26489"/>26489:          #{desc =&gt; &quot;await sec-acceptor 2 termination&quot;,
<a name="26490"/>26490:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = State) -&gt;
<a name="26491"/>26491:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="26492"/>26492:                                ok -&gt;
<a name="26493"/>26493:                                    State1 = maps:remove(sec_acceptor2, State),
<a name="26494"/>26494:                                    {ok, State1};
<a name="26495"/>26495:                                {error, _} = ERROR -&gt;
<a name="26496"/>26496:                                    ERROR
<a name="26497"/>26497:                            end
<a name="26498"/>26498:                    end},
<a name="26499"/>26499:          
<a name="26500"/>26500:          %% *** We are done ***
<a name="26501"/>26501:          ?SEV_FINISH_NORMAL
<a name="26502"/>26502:         ],
<a name="26503"/>26503: 
<a name="26504"/>26504:     i(&quot;create prim-acceptor evaluator&quot;),
<a name="26505"/>26505:     PrimAInitState = InitState,
<a name="26506"/>26506:     PrimAcceptor = ?SEV_START(&quot;prim-acceptor&quot;, PrimAcceptorSeq, PrimAInitState),
<a name="26507"/>26507: 
<a name="26508"/>26508:     i(&quot;create sec-acceptor 1 evaluator&quot;),
<a name="26509"/>26509:     SecAInitState1 = maps:remove(domain, InitState),
<a name="26510"/>26510:     SecAcceptor1 = ?SEV_START(&quot;sec-acceptor-1&quot;, SecAcceptorSeq, SecAInitState1),
<a name="26511"/>26511:     
<a name="26512"/>26512:     i(&quot;create sec-acceptor 2 evaluator&quot;),
<a name="26513"/>26513:     SecAInitState2 = SecAInitState1,
<a name="26514"/>26514:     SecAcceptor2 = ?SEV_START(&quot;sec-acceptor-2&quot;, SecAcceptorSeq, SecAInitState2),
<a name="26515"/>26515: 
<a name="26516"/>26516:     i(&quot;create tester evaluator&quot;),
<a name="26517"/>26517:     TesterInitState = #{prim_acceptor =&gt; PrimAcceptor#ev.pid,
<a name="26518"/>26518:                         sec_acceptor1 =&gt; SecAcceptor1#ev.pid,
<a name="26519"/>26519:                         sec_acceptor2 =&gt; SecAcceptor2#ev.pid},
<a name="26520"/>26520:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="26521"/>26521: 
<a name="26522"/>26522:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_maccept_tcp-last_expr"/><a name="26523"/>26523: <b>    ok = ?SEV_AWAIT_FINISH</b>([PrimAcceptor, SecAcceptor1, SecAcceptor2, Tester]).
<a name="26524"/>26524: 
<a name="26525"/>26525: 
<a name="26526"/>26526: 
<a name="26527"/>26527: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26528"/>26528: 
<a name="26529"/>26529: <i>%% This test case is intended to test the send timeout option</i>
<a name="26530"/>26530: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_send_tcp4-1"/><a name="26531"/>26531: <b>api_to_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_send_tcp4-last_expr"/><a name="26532"/>26532: <b>    tc_try</b>(api_to_send_tcp4,
<a name="26533"/>26533:            fun() -&gt; has_support_ipv4() end,
<a name="26534"/>26534:            fun() -&gt;
<a name="26535"/>26535:                    not_yet_implemented()%% ,
<a name="26536"/>26536:                    %% ok = api_to_send_tcp(inet)
<a name="26537"/>26537:            end).
<a name="26538"/>26538: 
<a name="26539"/>26539: 
<a name="26540"/>26540: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26541"/>26541: 
<a name="26542"/>26542: <i>%% This test case is intended to test the send timeout option</i>
<a name="26543"/>26543: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_send_tcp6-1"/><a name="26544"/>26544: <b>api_to_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_send_tcp6-last_expr"/><a name="26545"/>26545: <b>    tc_try</b>(api_to_send_tcp6,
<a name="26546"/>26546:            fun() -&gt; has_support_ipv6() end,
<a name="26547"/>26547:            fun() -&gt;
<a name="26548"/>26548:                    not_yet_implemented()%% ,
<a name="26549"/>26549:                    %% ok = api_to_send_tcp(inet6)
<a name="26550"/>26550:            end).
<a name="26551"/>26551: 
<a name="26552"/>26552: 
<a name="26553"/>26553: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26554"/>26554: 
<a name="26555"/>26555: <i>%% This test case is intended to test the sendto timeout option</i>
<a name="26556"/>26556: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_sendto_udp4-1"/><a name="26557"/>26557: <b>api_to_sendto_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendto_udp4-last_expr"/><a name="26558"/>26558: <b>    tc_try</b>(api_to_sendto_udp4,
<a name="26559"/>26559:            fun () -&gt; has_support_ipv4() end,
<a name="26560"/>26560:            fun() -&gt;
<a name="26561"/>26561:                    not_yet_implemented()%% ,
<a name="26562"/>26562:                    %% ok = api_to_sendto_to_udp(inet)
<a name="26563"/>26563:            end).
<a name="26564"/>26564: 
<a name="26565"/>26565: 
<a name="26566"/>26566: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26567"/>26567: 
<a name="26568"/>26568: <i>%% This test case is intended to test the sendto timeout option</i>
<a name="26569"/>26569: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_sendto_udp6-1"/><a name="26570"/>26570: <b>api_to_sendto_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendto_udp6-last_expr"/><a name="26571"/>26571: <b>    tc_try</b>(api_to_sendto_udp6,
<a name="26572"/>26572:            fun() -&gt; has_support_ipv6() end,
<a name="26573"/>26573:            fun() -&gt;
<a name="26574"/>26574:                    not_yet_implemented()%% ,
<a name="26575"/>26575:                    %% ok = api_to_sendto_to_udp(inet6)
<a name="26576"/>26576:            end).
<a name="26577"/>26577: 
<a name="26578"/>26578: 
<a name="26579"/>26579: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26580"/>26580: 
<a name="26581"/>26581: <i>%% This test case is intended to test the sendmsg timeout option</i>
<a name="26582"/>26582: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_sendmsg_tcp4-1"/><a name="26583"/>26583: <b>api_to_sendmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendmsg_tcp4-last_expr"/><a name="26584"/>26584: <b>    tc_try</b>(api_to_sendmsg_tcp4,
<a name="26585"/>26585:            fun() -&gt; has_support_ipv4() end,
<a name="26586"/>26586:            fun() -&gt;
<a name="26587"/>26587:                    not_yet_implemented()%% ,
<a name="26588"/>26588:                    %% ok = api_to_sendmsg_tcp(inet)
<a name="26589"/>26589:            end).
<a name="26590"/>26590: 
<a name="26591"/>26591: 
<a name="26592"/>26592: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26593"/>26593: 
<a name="26594"/>26594: <i>%% This test case is intended to test the sendmsg timeout option</i>
<a name="26595"/>26595: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_sendmsg_tcp6-1"/><a name="26596"/>26596: <b>api_to_sendmsg_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendmsg_tcp6-last_expr"/><a name="26597"/>26597: <b>    tc_try</b>(api_to_sendmsg_tcp6,
<a name="26598"/>26598:            fun() -&gt; has_support_ipv6() end,
<a name="26599"/>26599:            fun() -&gt;
<a name="26600"/>26600:                    not_yet_implemented()%% ,
<a name="26601"/>26601:                    %% ok = api_to_sendmsg_tcp(inet6)
<a name="26602"/>26602:            end).
<a name="26603"/>26603: 
<a name="26604"/>26604: 
<a name="26605"/>26605: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26606"/>26606: 
<a name="26607"/>26607: <i>%% This test case is intended to test the recv timeout option</i>
<a name="26608"/>26608: <i>%% on an IPv4 UDP (dgram) socket. To test this we must connect</i>
<a name="26609"/>26609: <i>%% the socket.</i>
<a name="api_to_recv_udp4-1"/><a name="26610"/>26610: <b>api_to_recv_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_recv_udp4-last_expr"/><a name="26611"/>26611: <b>    tc_try</b>(api_to_recv_udp4,
<a name="26612"/>26612:            fun() -&gt; has_support_ipv4() end,
<a name="26613"/>26613:            fun() -&gt;
<a name="26614"/>26614:                    not_yet_implemented()%%,
<a name="26615"/>26615:                    %%ok = api_to_recv_udp(inet)
<a name="26616"/>26616:            end).
<a name="26617"/>26617: 
<a name="26618"/>26618: 
<a name="26619"/>26619: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26620"/>26620: 
<a name="26621"/>26621: <i>%% This test case is intended to test the recv timeout option</i>
<a name="26622"/>26622: <i>%% on an IPv6 UDP (dgram) socket. To test this we must connect</i>
<a name="26623"/>26623: <i>%% the socket.</i>
<a name="api_to_recv_udp6-1"/><a name="26624"/>26624: <b>api_to_recv_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_recv_udp6-last_expr"/><a name="26625"/>26625: <b>    tc_try</b>(api_to_recv_udp6,
<a name="26626"/>26626:            fun() -&gt; has_support_ipv6() end,
<a name="26627"/>26627:            fun() -&gt;
<a name="26628"/>26628:                    not_yet_implemented()%% ,
<a name="26629"/>26629:                    %% ok = api_to_recv_udp(inet6)
<a name="26630"/>26630:            end).
<a name="26631"/>26631: 
<a name="26632"/>26632: 
<a name="26633"/>26633: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26634"/>26634: 
<a name="26635"/>26635: <i>%% This test case is intended to test the recv timeout option</i>
<a name="26636"/>26636: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_recv_tcp4-1"/><a name="26637"/>26637: <b>api_to_recv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26638"/>26638:     ?TT(?SECS(10)),
<a name="api_to_recv_tcp4-last_expr"/><a name="26639"/>26639: <b>    tc_try</b>(api_to_recv_tcp4,
<a name="26640"/>26640:            fun() -&gt; has_support_ipv4() end,
<a name="26641"/>26641:            fun() -&gt;
<a name="26642"/>26642:                    Recv = fun(Sock, To) -&gt; socket:recv(Sock, 0, To) end,
<a name="26643"/>26643:                    InitState = #{domain  =&gt; inet,
<a name="26644"/>26644:                                  recv    =&gt; Recv,
<a name="26645"/>26645:                                  timeout =&gt; 2000},
<a name="26646"/>26646:                    ok = api_to_receive_tcp(InitState)
<a name="26647"/>26647:            end).
<a name="26648"/>26648: 
<a name="26649"/>26649: 
<a name="26650"/>26650: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26651"/>26651: 
<a name="26652"/>26652: <i>%% This test case is intended to test the recv timeout option</i>
<a name="26653"/>26653: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_recv_tcp6-1"/><a name="26654"/>26654: <b>api_to_recv_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="26655"/>26655:     ?TT(?SECS(10)),
<a name="api_to_recv_tcp6-last_expr"/><a name="26656"/>26656: <b>    tc_try</b>(api_to_recv_tcp6,
<a name="26657"/>26657:            fun() -&gt; has_support_ipv6() end,
<a name="26658"/>26658:            fun() -&gt;
<a name="26659"/>26659:                    case socket:is_supported(ipv6) of
<a name="26660"/>26660:                        true -&gt;
<a name="26661"/>26661:                            Recv = fun(Sock, To) -&gt; 
<a name="26662"/>26662:                                           socket:recv(Sock, 0, To)
<a name="26663"/>26663:                                   end,
<a name="26664"/>26664:                            InitState = #{domain  =&gt; inet6,
<a name="26665"/>26665:                                          recv    =&gt; Recv,
<a name="26666"/>26666:                                          timeout =&gt; 2000},
<a name="26667"/>26667:                            ok = api_to_receive_tcp(InitState);
<a name="26668"/>26668:                        false -&gt;
<a name="26669"/>26669:                            skip(&quot;ipv6 not supported&quot;)
<a name="26670"/>26670:                    end
<a name="26671"/>26671:            end).
<a name="26672"/>26672: 
<a name="26673"/>26673: 
<a name="26674"/>26674: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26675"/>26675: 
<a name="api_to_receive_tcp-1"/><a name="26676"/>26676: <b>api_to_receive_tcp</b>(InitState) -&gt;
<a name="26677"/>26677:     process_flag(trap_exit, true),
<a name="26678"/>26678: 
<a name="26679"/>26679:     ServerSeq = 
<a name="26680"/>26680:         [
<a name="26681"/>26681:          %% *** Wait for start order ***
<a name="26682"/>26682:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="26683"/>26683:            cmd  =&gt; fun(State) -&gt;
<a name="26684"/>26684:                            Tester = ?SEV_AWAIT_START(),
<a name="26685"/>26685:                            {ok, State#{tester =&gt; Tester}}
<a name="26686"/>26686:                    end},
<a name="26687"/>26687:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26688"/>26688:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26689"/>26689:                            _MRef = erlang:monitor(process, Tester),
<a name="26690"/>26690:                            ok
<a name="26691"/>26691:                    end},
<a name="26692"/>26692: 
<a name="26693"/>26693:          %% *** Init part ***
<a name="26694"/>26694:          #{desc =&gt; &quot;which local address&quot;,
<a name="26695"/>26695:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26696"/>26696:                            LSA = which_local_socket_addr(Domain),
<a name="26697"/>26697:                            {ok, State#{local_sa =&gt; LSA}}
<a name="26698"/>26698:                    end},
<a name="26699"/>26699:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="26700"/>26700:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26701"/>26701:                            case socket:open(Domain, stream, tcp) of
<a name="26702"/>26702:                                {ok, Sock} -&gt;
<a name="26703"/>26703:                                    {ok, State#{lsock =&gt; Sock}};
<a name="26704"/>26704:                                {error, _} = ERROR -&gt;
<a name="26705"/>26705:                                    ERROR
<a name="26706"/>26706:                            end
<a name="26707"/>26707:                    end},
<a name="26708"/>26708:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26709"/>26709:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="26710"/>26710:                            case sock_bind(LSock, LSA) of
<a name="26711"/>26711:                                ok -&gt;
<a name="26712"/>26712:                                    Port = sock_port(LSock),
<a name="26713"/>26713:                                    {ok, State#{lport =&gt; Port}};
<a name="26714"/>26714:                                {error, _} = ERROR -&gt;
<a name="26715"/>26715:                                    ERROR
<a name="26716"/>26716:                            end
<a name="26717"/>26717:                    end},
<a name="26718"/>26718:          #{desc =&gt; &quot;make listen socket (with backlog = 1)&quot;,
<a name="26719"/>26719:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="26720"/>26720:                            socket:listen(LSock, 1)
<a name="26721"/>26721:                    end},
<a name="26722"/>26722:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26723"/>26723:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="26724"/>26724:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="26725"/>26725:                            ok
<a name="26726"/>26726:                    end},
<a name="26727"/>26727: 
<a name="26728"/>26728:          %% *** The actual test ***
<a name="26729"/>26729:          #{desc =&gt; &quot;await continue (accept and recv)&quot;,
<a name="26730"/>26730:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26731"/>26731:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept_recv)
<a name="26732"/>26732:                    end},
<a name="26733"/>26733:          #{desc =&gt; &quot;attempt accept&quot;,
<a name="26734"/>26734:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="26735"/>26735:                            case socket:accept(LSock) of
<a name="26736"/>26736:                                {ok, Sock} -&gt;
<a name="26737"/>26737:                                    {ok, State#{sock =&gt; Sock}};
<a name="26738"/>26738:                                {error, _} = ERROR -&gt;
<a name="26739"/>26739:                                    ERROR
<a name="26740"/>26740:                            end
<a name="26741"/>26741:                    end},
<a name="26742"/>26742:          #{desc =&gt; &quot;attempt to recv (without success)&quot;,
<a name="26743"/>26743:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, timeout := To} = State) -&gt;
<a name="26744"/>26744:                            Start = ?TS(),
<a name="26745"/>26745:                            case Recv(Sock, To) of
<a name="26746"/>26746:                                {error, timeout} -&gt;
<a name="26747"/>26747:                                    {ok, State#{start =&gt; Start, stop =&gt; ?TS()}};
<a name="26748"/>26748:                                {ok, _Data} -&gt;
<a name="26749"/>26749:                                    {error, unexpected_success};
<a name="26750"/>26750:                                {error, _} = ERROR -&gt;
<a name="26751"/>26751:                                    ERROR
<a name="26752"/>26752:                            end
<a name="26753"/>26753:                    end},
<a name="26754"/>26754:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="26755"/>26755:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = State) -&gt;
<a name="26756"/>26756:                            TDiff  = Stop - Start,
<a name="26757"/>26757:                            if
<a name="26758"/>26758:                                (TDiff &gt;= To) -&gt;
<a name="26759"/>26759:                                    State1 = maps:remove(start, State),
<a name="26760"/>26760:                                    State2 = maps:remove(stop,  State1),
<a name="26761"/>26761:                                    {ok, State2};
<a name="26762"/>26762:                                true -&gt;
<a name="26763"/>26763:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="26764"/>26764:                            end
<a name="26765"/>26765:                    end},
<a name="26766"/>26766:          #{desc =&gt; &quot;announce ready (recv timeout success)&quot;,
<a name="26767"/>26767:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26768"/>26768:                            ?SEV_ANNOUNCE_READY(Tester, accept_recv),
<a name="26769"/>26769:                            ok
<a name="26770"/>26770:                    end},
<a name="26771"/>26771: 
<a name="26772"/>26772:          %% *** Termination ***
<a name="26773"/>26773:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26774"/>26774:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="26775"/>26775:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="26776"/>26776:                                ok -&gt;
<a name="26777"/>26777:                                    {ok, maps:remove(tester, State)};
<a name="26778"/>26778:                                {error, _} = ERROR -&gt;
<a name="26779"/>26779:                                    ERROR
<a name="26780"/>26780:                            end
<a name="26781"/>26781:                    end},
<a name="26782"/>26782:          #{desc =&gt; &quot;close (traffic) socket&quot;,
<a name="26783"/>26783:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="26784"/>26784:                            sock_close(Sock),
<a name="26785"/>26785:                            {ok, maps:remove(sock, State)}
<a name="26786"/>26786:                    end},
<a name="26787"/>26787:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="26788"/>26788:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="26789"/>26789:                            sock_close(LSock),
<a name="26790"/>26790:                            {ok, maps:remove(lsock, State)}
<a name="26791"/>26791:                    end},
<a name="26792"/>26792: 
<a name="26793"/>26793:          %% *** We are done ***
<a name="26794"/>26794:          ?SEV_FINISH_NORMAL
<a name="26795"/>26795:         ],
<a name="26796"/>26796: 
<a name="26797"/>26797:     ClientSeq =
<a name="26798"/>26798:         [
<a name="26799"/>26799:          %% *** Wait for start order part ***
<a name="26800"/>26800:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="26801"/>26801:            cmd  =&gt; fun(State) -&gt;
<a name="26802"/>26802:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="26803"/>26803:                            {ok, State#{tester      =&gt; Tester,
<a name="26804"/>26804:                                        server_port =&gt; Port}}
<a name="26805"/>26805:                    end},
<a name="26806"/>26806:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26807"/>26807:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26808"/>26808:                            _MRef = erlang:monitor(process, Tester),
<a name="26809"/>26809:                            ok
<a name="26810"/>26810:                    end},
<a name="26811"/>26811: 
<a name="26812"/>26812:          %% *** Init part ***
<a name="26813"/>26813:          #{desc =&gt; &quot;which local address&quot;,
<a name="26814"/>26814:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="26815"/>26815:                            LSA = which_local_socket_addr(Domain),
<a name="26816"/>26816:                            SSA = LSA#{port =&gt; Port},
<a name="26817"/>26817:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="26818"/>26818:                    end},
<a name="26819"/>26819:          #{desc =&gt; &quot;create socket&quot;,
<a name="26820"/>26820:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26821"/>26821:                            case socket:open(Domain, stream, tcp) of
<a name="26822"/>26822:                                {ok, Sock} -&gt;
<a name="26823"/>26823:                                    {ok, State#{sock =&gt; Sock}};
<a name="26824"/>26824:                                {error, _} = ERROR -&gt;
<a name="26825"/>26825:                                    ERROR
<a name="26826"/>26826:                            end
<a name="26827"/>26827:                    end},
<a name="26828"/>26828:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26829"/>26829:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="26830"/>26830:                            case sock_bind(Sock, LSA) of
<a name="26831"/>26831:                                ok -&gt;
<a name="26832"/>26832:                                    ok;
<a name="26833"/>26833:                                {error, _} = ERROR -&gt;
<a name="26834"/>26834:                                    ERROR
<a name="26835"/>26835:                            end
<a name="26836"/>26836:                    end},
<a name="26837"/>26837:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26838"/>26838:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26839"/>26839:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="26840"/>26840:                            ok
<a name="26841"/>26841:                    end},
<a name="26842"/>26842: 
<a name="26843"/>26843:          %% *** The actual test ***
<a name="26844"/>26844:          #{desc =&gt; &quot;await continue (with connect)&quot;,
<a name="26845"/>26845:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26846"/>26846:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="26847"/>26847:                    end},
<a name="26848"/>26848:          #{desc =&gt; &quot;connect&quot;,
<a name="26849"/>26849:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="26850"/>26850:                            sock_connect(Sock, SSA),
<a name="26851"/>26851:                            ok
<a name="26852"/>26852:                    end},
<a name="26853"/>26853: 
<a name="26854"/>26854:          %% *** Termination ***
<a name="26855"/>26855:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26856"/>26856:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="26857"/>26857:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="26858"/>26858:                                ok -&gt;
<a name="26859"/>26859:                                    {ok, maps:remove(tester, State)};
<a name="26860"/>26860:                                {error, _} = ERROR -&gt;
<a name="26861"/>26861:                                    ERROR
<a name="26862"/>26862:                            end
<a name="26863"/>26863:                    end},
<a name="26864"/>26864:          #{desc =&gt; &quot;close socket&quot;,
<a name="26865"/>26865:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="26866"/>26866:                            sock_close(Sock),
<a name="26867"/>26867:                            {ok, maps:remove(sock, State)}
<a name="26868"/>26868:                    end},
<a name="26869"/>26869: 
<a name="26870"/>26870:          %% *** We are done ***
<a name="26871"/>26871:          ?SEV_FINISH_NORMAL
<a name="26872"/>26872:         ],
<a name="26873"/>26873: 
<a name="26874"/>26874:     TesterSeq =
<a name="26875"/>26875:         [
<a name="26876"/>26876:          %% *** Init part ***
<a name="26877"/>26877:          #{desc =&gt; &quot;monitor server&quot;,
<a name="26878"/>26878:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26879"/>26879:                            _MRef = erlang:monitor(process, Server),
<a name="26880"/>26880:                            ok
<a name="26881"/>26881:                    end},
<a name="26882"/>26882:          #{desc =&gt; &quot;monitor client&quot;,
<a name="26883"/>26883:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26884"/>26884:                            _MRef = erlang:monitor(process, Client),
<a name="26885"/>26885:                            ok
<a name="26886"/>26886:                    end},
<a name="26887"/>26887: 
<a name="26888"/>26888:          %% *** Activate server ***
<a name="26889"/>26889:          #{desc =&gt; &quot;start server&quot;,
<a name="26890"/>26890:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26891"/>26891:                            ?SEV_ANNOUNCE_START(Server),
<a name="26892"/>26892:                            ok
<a name="26893"/>26893:                    end},
<a name="26894"/>26894:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="26895"/>26895:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="26896"/>26896:                            {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="26897"/>26897:                            {ok, State#{server_port =&gt; Port}}
<a name="26898"/>26898:                    end},
<a name="26899"/>26899:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="26900"/>26900:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26901"/>26901:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept_recv),
<a name="26902"/>26902:                            ok
<a name="26903"/>26903:                    end},
<a name="26904"/>26904: 
<a name="26905"/>26905:          %% *** Activate client ***
<a name="26906"/>26906:          #{desc =&gt; &quot;start client&quot;,
<a name="26907"/>26907:            cmd  =&gt; fun(#{client := Client, server_port := Port} = _State) -&gt;
<a name="26908"/>26908:                            ?SEV_ANNOUNCE_START(Client, Port),
<a name="26909"/>26909:                            ok
<a name="26910"/>26910:                    end},
<a name="26911"/>26911:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="26912"/>26912:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26913"/>26913:                            ?SEV_AWAIT_READY(Client, client, init)
<a name="26914"/>26914:                    end},
<a name="26915"/>26915: 
<a name="26916"/>26916:          %% *** The actual test ***
<a name="26917"/>26917:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="26918"/>26918:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26919"/>26919:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="26920"/>26920:                            ok
<a name="26921"/>26921:                    end},
<a name="26922"/>26922:          #{desc =&gt; &quot;await server ready (accept/recv)&quot;,
<a name="26923"/>26923:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26924"/>26924:                            ?SEV_AWAIT_READY(Server, server, accept_recv)
<a name="26925"/>26925:                    end},
<a name="26926"/>26926: 
<a name="26927"/>26927:          %% *** Termination ***
<a name="26928"/>26928:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="26929"/>26929:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26930"/>26930:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="26931"/>26931:                            ok
<a name="26932"/>26932:                    end},
<a name="26933"/>26933:          #{desc =&gt; &quot;await client termination&quot;,
<a name="26934"/>26934:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="26935"/>26935:                            case ?SEV_AWAIT_TERMINATION(Client) of
<a name="26936"/>26936:                                ok -&gt;
<a name="26937"/>26937:                                    State1 = maps:remove(client, State),
<a name="26938"/>26938:                                    {ok, State1};
<a name="26939"/>26939:                                {error, _} = ERROR -&gt;
<a name="26940"/>26940:                                    ERROR
<a name="26941"/>26941:                            end
<a name="26942"/>26942:                    end},
<a name="26943"/>26943:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="26944"/>26944:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26945"/>26945:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="26946"/>26946:                            ok
<a name="26947"/>26947:                    end},
<a name="26948"/>26948:          #{desc =&gt; &quot;await server termination&quot;,
<a name="26949"/>26949:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="26950"/>26950:                            case ?SEV_AWAIT_TERMINATION(Server) of
<a name="26951"/>26951:                                ok -&gt;
<a name="26952"/>26952:                                    State1 = maps:remove(server, State),
<a name="26953"/>26953:                                    State2 = maps:remove(server_port, State1),
<a name="26954"/>26954:                                    {ok, State2};
<a name="26955"/>26955:                                {error, _} = ERROR -&gt;
<a name="26956"/>26956:                                    ERROR
<a name="26957"/>26957:                            end
<a name="26958"/>26958:                    end},
<a name="26959"/>26959: 
<a name="26960"/>26960:          %% *** We are done ***
<a name="26961"/>26961:          ?SEV_FINISH_NORMAL
<a name="26962"/>26962:         ],
<a name="26963"/>26963: 
<a name="26964"/>26964:     
<a name="26965"/>26965:     i(&quot;start server evaluator&quot;),
<a name="26966"/>26966:     ServerInitState = InitState,
<a name="26967"/>26967:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="26968"/>26968: 
<a name="26969"/>26969:     i(&quot;start client evaluator&quot;),
<a name="26970"/>26970:     ClientInitState = InitState,
<a name="26971"/>26971:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="26972"/>26972: 
<a name="26973"/>26973:     i(&quot;start tester evaluator&quot;),
<a name="26974"/>26974:     TesterInitState = #{server =&gt; Server#ev.pid, 
<a name="26975"/>26975:                         client =&gt; Client#ev.pid},
<a name="26976"/>26976:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="26977"/>26977: 
<a name="26978"/>26978:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_receive_tcp-last_expr"/><a name="26979"/>26979: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="26980"/>26980: 
<a name="26981"/>26981: 
<a name="26982"/>26982: 
<a name="26983"/>26983: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26984"/>26984: 
<a name="26985"/>26985: <i>%% This test case is intended to test the recvfrom timeout option</i>
<a name="26986"/>26986: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_recvfrom_udp4-1"/><a name="26987"/>26987: <b>api_to_recvfrom_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26988"/>26988:     ?TT(?SECS(10)),
<a name="api_to_recvfrom_udp4-last_expr"/><a name="26989"/>26989: <b>    tc_try</b>(api_to_recvfrom_udp4,
<a name="26990"/>26990:            fun() -&gt; has_support_ipv4() end,
<a name="26991"/>26991:            fun() -&gt;
<a name="26992"/>26992:                    Recv = fun(Sock, To) -&gt; socket:recvfrom(Sock, 0, To) end,
<a name="26993"/>26993:                    InitState = #{domain  =&gt; inet,
<a name="26994"/>26994:                                  recv    =&gt; Recv,
<a name="26995"/>26995:                                  timeout =&gt; 2000},
<a name="26996"/>26996:                    ok = api_to_receive_udp(InitState)
<a name="26997"/>26997:            end).
<a name="26998"/>26998: 
<a name="26999"/>26999: 
<a name="27000"/>27000: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27001"/>27001: 
<a name="27002"/>27002: <i>%% This test case is intended to test the recvfrom timeout option</i>
<a name="27003"/>27003: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_recvfrom_udp6-1"/><a name="27004"/>27004: <b>api_to_recvfrom_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27005"/>27005:     ?TT(?SECS(10)),
<a name="api_to_recvfrom_udp6-last_expr"/><a name="27006"/>27006: <b>    tc_try</b>(api_to_recvfrom_udp6,
<a name="27007"/>27007:            fun() -&gt; has_support_ipv6() end,
<a name="27008"/>27008:            fun() -&gt;
<a name="27009"/>27009:                    Recv = fun(Sock, To) -&gt; socket:recvfrom(Sock, 0, To) end,
<a name="27010"/>27010:                    InitState = #{domain  =&gt; inet6,
<a name="27011"/>27011:                                  recv    =&gt; Recv,
<a name="27012"/>27012:                                  timeout =&gt; 2000},
<a name="27013"/>27013:                    ok = api_to_receive_udp(InitState)
<a name="27014"/>27014:            end).
<a name="27015"/>27015: 
<a name="27016"/>27016: 
<a name="27017"/>27017: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27018"/>27018: 
<a name="api_to_receive_udp-1"/><a name="27019"/>27019: <b>api_to_receive_udp</b>(InitState) -&gt;
<a name="27020"/>27020:     TesterSeq =
<a name="27021"/>27021:         [
<a name="27022"/>27022:          %% *** Init part ***
<a name="27023"/>27023:          #{desc =&gt; &quot;which local address&quot;,
<a name="27024"/>27024:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27025"/>27025:                            LSA = which_local_socket_addr(Domain),
<a name="27026"/>27026:                            {ok, State#{lsa =&gt; LSA}}
<a name="27027"/>27027:                    end},
<a name="27028"/>27028:          #{desc =&gt; &quot;create socket&quot;,
<a name="27029"/>27029:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27030"/>27030:                            case socket:open(Domain, dgram, udp) of
<a name="27031"/>27031:                                {ok, Sock} -&gt;
<a name="27032"/>27032:                                    {ok, State#{sock =&gt; Sock}};
<a name="27033"/>27033:                                {error, _} = ERROR -&gt;
<a name="27034"/>27034:                                    ERROR
<a name="27035"/>27035:                            end
<a name="27036"/>27036:                    end},
<a name="27037"/>27037:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="27038"/>27038:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="27039"/>27039:                            case sock_bind(Sock, LSA) of
<a name="27040"/>27040:                                ok -&gt;
<a name="27041"/>27041:                                    ok;
<a name="27042"/>27042:                                {error, _} = ERROR -&gt;
<a name="27043"/>27043:                                    ERROR
<a name="27044"/>27044:                            end
<a name="27045"/>27045:                    end},
<a name="27046"/>27046: 
<a name="27047"/>27047:          %% *** The actual test ***
<a name="27048"/>27048:          #{desc =&gt; &quot;attempt to read (without success)&quot;,
<a name="27049"/>27049:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, timeout := To} = State) -&gt;
<a name="27050"/>27050:                            Start = ?TS(),
<a name="27051"/>27051:                            case Recv(Sock, To) of
<a name="27052"/>27052:                                {error, timeout} -&gt;
<a name="27053"/>27053:                                    {ok, State#{start =&gt; Start,
<a name="27054"/>27054:                                                stop =&gt; ?TS()}};
<a name="27055"/>27055:                                {ok, _} -&gt;
<a name="27056"/>27056:                                    {error, unexpected_success};
<a name="27057"/>27057:                                {error, _} = ERROR -&gt;
<a name="27058"/>27058:                                    ERROR
<a name="27059"/>27059:                            end
<a name="27060"/>27060:                    end},
<a name="27061"/>27061:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="27062"/>27062:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="27063"/>27063:                            TDiff  = Stop - Start,
<a name="27064"/>27064:                            if
<a name="27065"/>27065:                                (TDiff &gt;= To) -&gt;
<a name="27066"/>27066:                                    ok;
<a name="27067"/>27067:                                true -&gt;
<a name="27068"/>27068:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="27069"/>27069:                            end
<a name="27070"/>27070:                    end},
<a name="27071"/>27071:          
<a name="27072"/>27072:          %% *** Termination ***
<a name="27073"/>27073:          #{desc =&gt; &quot;close socket&quot;,
<a name="27074"/>27074:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="27075"/>27075:                            %% socket:setopt(Sock, otp, debug, true),
<a name="27076"/>27076:                            sock_close(Sock),
<a name="27077"/>27077:                            ok
<a name="27078"/>27078:                    end},
<a name="27079"/>27079: 
<a name="27080"/>27080:          %% *** We are done ***
<a name="27081"/>27081:          ?SEV_FINISH_NORMAL
<a name="27082"/>27082:         ],
<a name="27083"/>27083: 
<a name="27084"/>27084:     i(&quot;start tester evaluator&quot;),
<a name="27085"/>27085:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="27086"/>27086:     
<a name="27087"/>27087:     i(&quot;await evaluator&quot;),
<a name="api_to_receive_udp-last_expr"/><a name="27088"/>27088: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="27089"/>27089: 
<a name="27090"/>27090: 
<a name="27091"/>27091: 
<a name="27092"/>27092: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27093"/>27093: 
<a name="27094"/>27094: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="27095"/>27095: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_recvmsg_udp4-1"/><a name="27096"/>27096: <b>api_to_recvmsg_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="27097"/>27097:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_udp4-last_expr"/><a name="27098"/>27098: <b>    tc_try</b>(api_to_recvmsg_udp4,
<a name="27099"/>27099:            fun() -&gt; has_support_ipv4() end,
<a name="27100"/>27100:            fun() -&gt;
<a name="27101"/>27101:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="27102"/>27102:                    InitState = #{domain  =&gt; inet,
<a name="27103"/>27103:                                  recv    =&gt; Recv,
<a name="27104"/>27104:                                  timeout =&gt; 2000},
<a name="27105"/>27105:                    ok = api_to_receive_udp(InitState)
<a name="27106"/>27106:            end).
<a name="27107"/>27107: 
<a name="27108"/>27108: 
<a name="27109"/>27109: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27110"/>27110: 
<a name="27111"/>27111: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="27112"/>27112: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_recvmsg_udp6-1"/><a name="27113"/>27113: <b>api_to_recvmsg_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27114"/>27114:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_udp6-last_expr"/><a name="27115"/>27115: <b>    tc_try</b>(api_to_recvmsg_udp6,
<a name="27116"/>27116:            fun() -&gt; has_support_ipv6() end,
<a name="27117"/>27117:            fun() -&gt;
<a name="27118"/>27118:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="27119"/>27119:                    InitState = #{domain  =&gt; inet6,
<a name="27120"/>27120:                                  recv    =&gt; Recv,
<a name="27121"/>27121:                                  timeout =&gt; 2000},
<a name="27122"/>27122:                    ok = api_to_receive_udp(InitState)
<a name="27123"/>27123:            end).
<a name="27124"/>27124: 
<a name="27125"/>27125: 
<a name="27126"/>27126: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27127"/>27127: 
<a name="27128"/>27128: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="27129"/>27129: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_recvmsg_tcp4-1"/><a name="27130"/>27130: <b>api_to_recvmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="27131"/>27131:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_tcp4-last_expr"/><a name="27132"/>27132: <b>    tc_try</b>(api_to_recvmsg_tcp4,
<a name="27133"/>27133:            fun() -&gt; has_support_ipv4() end,
<a name="27134"/>27134:            fun() -&gt;
<a name="27135"/>27135:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="27136"/>27136:                    InitState = #{domain  =&gt; inet,
<a name="27137"/>27137:                                  recv    =&gt; Recv,
<a name="27138"/>27138:                                  timeout =&gt; 2000},
<a name="27139"/>27139:                    ok = api_to_receive_tcp(InitState)
<a name="27140"/>27140:            end).
<a name="27141"/>27141: 
<a name="27142"/>27142: 
<a name="27143"/>27143: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27144"/>27144: 
<a name="27145"/>27145: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="27146"/>27146: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_recvmsg_tcp6-1"/><a name="27147"/>27147: <b>api_to_recvmsg_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27148"/>27148:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_tcp6-last_expr"/><a name="27149"/>27149: <b>    tc_try</b>(api_to_recvmsg_tcp6,
<a name="27150"/>27150:            fun() -&gt; has_support_ipv6() end,
<a name="27151"/>27151:            fun() -&gt;
<a name="27152"/>27152:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="27153"/>27153:                    InitState = #{domain  =&gt; inet6,
<a name="27154"/>27154:                                  recv    =&gt; Recv,
<a name="27155"/>27155:                                  timeout =&gt; 2000},
<a name="27156"/>27156:                    ok = api_to_receive_tcp(InitState)
<a name="27157"/>27157:            end).
<a name="27158"/>27158: 
<a name="27159"/>27159: 
<a name="27160"/>27160: 
<a name="27161"/>27161: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27162"/>27162: 
<a name="sock_open-3"/><a name="27163"/>27163: <b>sock_open</b>(Domain, Type, Proto) -&gt;
<a name="sock_open-last_expr"/><a name="27164"/>27164: <b>    try socket:open</b>(Domain, Type, Proto) of
<a name="27165"/>27165:         {ok, Socket} -&gt;
<a name="27166"/>27166:             Socket;
<a name="27167"/>27167:         {error, Reason} -&gt;
<a name="27168"/>27168:             ?FAIL({open, Reason})
<a name="27169"/>27169:     catch
<a name="27170"/>27170:         C:E:S -&gt;
<a name="27171"/>27171:             ?FAIL({open, C, E, S})
<a name="27172"/>27172:     end.
<a name="27173"/>27173: 
<a name="27174"/>27174: 
<a name="sock_bind-2"/><a name="27175"/>27175: <b>sock_bind</b>(Sock, LSA) -&gt;
<a name="sock_bind-last_expr"/><a name="27176"/>27176: <b>    try socket:bind</b>(Sock, LSA) of
<a name="27177"/>27177:         ok = OK -&gt;
<a name="27178"/>27178:             OK;
<a name="27179"/>27179:         {error, eaddrnotavail = Reason} -&gt;
<a name="27180"/>27180:             ?SEV_IPRINT(&quot;Address not available&quot;),
<a name="27181"/>27181:             throw({skip, Reason});
<a name="27182"/>27182:         {error, _} = ERROR -&gt;
<a name="27183"/>27183:             ERROR
<a name="27184"/>27184:     catch
<a name="27185"/>27185:         C:E:S -&gt;
<a name="27186"/>27186:             ?FAIL({bind, C, E, S})
<a name="27187"/>27187:     end.
<a name="27188"/>27188: 
<a name="sock_connect-2"/><a name="27189"/>27189: <b>sock_connect</b>(Sock, SockAddr) -&gt;
<a name="sock_connect-last_expr"/><a name="27190"/>27190: <b>    try socket:connect</b>(Sock, SockAddr) of
<a name="27191"/>27191:         ok -&gt;
<a name="27192"/>27192:             ok;
<a name="27193"/>27193:         {error, Reason} -&gt;
<a name="27194"/>27194:             ?FAIL({connect, Reason})
<a name="27195"/>27195:     catch
<a name="27196"/>27196:         C:E:S -&gt;
<a name="27197"/>27197:             ?FAIL({connect, C, E, S})
<a name="27198"/>27198:     end.
<a name="27199"/>27199:     
<a name="sock_sockname-1"/><a name="27200"/>27200: <b>sock_sockname</b>(Sock) -&gt;
<a name="sock_sockname-last_expr"/><a name="27201"/>27201: <b>    try socket:sockname</b>(Sock) of
<a name="27202"/>27202:         {ok, SockAddr} -&gt;
<a name="27203"/>27203:             SockAddr;
<a name="27204"/>27204:         {error, Reason} -&gt;
<a name="27205"/>27205:             ?FAIL({sockname, Reason})
<a name="27206"/>27206:     catch
<a name="27207"/>27207:         C:E:S -&gt;
<a name="27208"/>27208:             ?FAIL({sockname, C, E, S})
<a name="27209"/>27209:     end.
<a name="27210"/>27210:     
<a name="sock_port-1"/><a name="27211"/>27211: <b>sock_port</b>(S) -&gt;
<a name="sock_port-last_expr"/><a name="27212"/>27212: <b>    case sock_sockname</b>(S) of
<a name="27213"/>27213:         #{port := Port} -&gt; Port;
<a name="27214"/>27214:         _               -&gt; undefined
<a name="27215"/>27215:     end.
<a name="27216"/>27216: 
<a name="sock_close-1"/><a name="27217"/>27217: <b>sock_close</b>(Sock) -&gt;
<a name="sock_close-last_expr"/><a name="27218"/>27218: <b>    try socket:close</b>(Sock) of
<a name="27219"/>27219:         ok -&gt;
<a name="27220"/>27220:             ok;
<a name="27221"/>27221:         {error, Reason} -&gt;
<a name="27222"/>27222:             i(&quot;sock_close -&gt; error: ~p&quot;, [Reason]),
<a name="27223"/>27223:             ?FAIL({close, Reason})
<a name="27224"/>27224:     catch
<a name="27225"/>27225:         C:E:S -&gt;
<a name="27226"/>27226:             i(&quot;sock_close -&gt; failed: ~p, ~p, ~p&quot;, [C, E, S]),
<a name="27227"/>27227:             ?FAIL({close, C, E, S})
<a name="27228"/>27228:     end.
<a name="27229"/>27229: 
<a name="27230"/>27230: 
<a name="27231"/>27231: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27232"/>27232: 
<a name="local_host-0"/><a name="27233"/>27233: <b>local_host</b>() -&gt;
<a name="local_host-last_expr"/><a name="27234"/>27234: <b>    try net_adm:localhost</b>() of
<a name="27235"/>27235:         Host when is_list(Host) -&gt;
<a name="27236"/>27236: 	    %% Convert to shortname if long
<a name="27237"/>27237: 	    case string:tokens(Host, [$.]) of
<a name="27238"/>27238: 		[H|_] -&gt;
<a name="27239"/>27239: 		    list_to_atom(H)
<a name="27240"/>27240: 	    end
<a name="27241"/>27241:     catch
<a name="27242"/>27242:         C:E:S -&gt;
<a name="27243"/>27243:             erlang:raise(C, E, S)
<a name="27244"/>27244:     end.
<a name="27245"/>27245: 
<a name="27246"/>27246: 
<a name="27247"/>27247: <i>%% The point of this is to &quot;ensure&quot; that paths from different test runs</i>
<a name="27248"/>27248: <i>%% don't clash.</i>
<a name="27249"/>27249: 
<a name="mk_unique_path-0"/><a name="27250"/>27250: <b>mk_unique_path</b>() -&gt;
<a name="mk_unique_path-last_expr"/><a name="27251"/>27251: <b>    ?SLIB:mk_unique_path</b>().
<a name="27252"/>27252: 
<a name="27253"/>27253: 
<a name="which_local_socket_addr-1"/><a name="27254"/>27254: <b>which_local_socket_addr</b>(local = Domain) -&gt;
<a name="27255"/>27255:     #{family =&gt; Domain,
<a name="27256"/>27256:       path   =&gt; mk_unique_path()};
<a name="27257"/>27257: 
<a name="27258"/>27258: <i>%% This gets the local socket address (not 127.0...)</i>
<a name="27259"/>27259: <i>%% We should really implement this using the (new) net module,</i>
<a name="27260"/>27260: <i>%% but until that gets the necessary functionality...</i>
<a name="27261"/>27261: <b>which_local_socket_addr</b>(Domain) -&gt;
<a name="which_local_socket_addr-last_expr"/><a name="27262"/>27262: <b>    case ?KLIB:which_local_host_info</b>(Domain) of
<a name="27263"/>27263:         {ok, [#{addr := Addr}|_]} -&gt;
<a name="27264"/>27264:             #{family =&gt; Domain,
<a name="27265"/>27265:               addr   =&gt; Addr};
<a name="27266"/>27266:         {error, Reason} -&gt;
<a name="27267"/>27267:             ?FAIL(Reason)
<a name="27268"/>27268:     end.
<a name="27269"/>27269: 
<a name="which_local_host_info-1"/><a name="27270"/>27270: <b>which_local_host_info</b>(Domain) -&gt;
<a name="which_local_host_info-last_expr"/><a name="27271"/>27271: <b>    case ?KLIB:which_local_host_info</b>(Domain) of
<a name="27272"/>27272:         {ok, [Info|_]} -&gt;
<a name="27273"/>27273:             {ok, Info#{family =&gt; Domain}};
<a name="27274"/>27274:         {error, Reason} -&gt;
<a name="27275"/>27275:             ?FAIL(Reason)
<a name="27276"/>27276:     end.
<a name="27277"/>27277: 
<a name="27278"/>27278: 
<a name="27279"/>27279: 
<a name="27280"/>27280: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27281"/>27281: 
<a name="27282"/>27282: <i>%% monitored_by() -&gt;</i>
<a name="27283"/>27283: <i>%%     monitored_by(self()).</i>
<a name="27284"/>27284: <i>%% monitored_by(Pid) -&gt;	</i>
<a name="27285"/>27285: <i>%%     {monitored_by, Refs} = erlang:process_info(Pid, monitored_by),</i>
<a name="27286"/>27286: <i>%%     Refs.</i>
<a name="27287"/>27287: 
<a name="27288"/>27288: 
<a name="27289"/>27289: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27290"/>27290: 
<a name="27291"/>27291: <i>%% Here are all the *general* test case condition functions.</i>
<a name="27292"/>27292: 
<a name="27293"/>27293: <i>%% We also need to (be able to) figure out the multicast address,</i>
<a name="27294"/>27294: <i>%% which we only support for some platforms (linux and sunos).</i>
<a name="27295"/>27295: <i>%% We don't do that here, but since we can only do that (find a</i>
<a name="27296"/>27296: <i>%% multicast address) for specific platforms, we check that we are</i>
<a name="27297"/>27297: <i>%% on of those platforms here.</i>
<a name="has_support_ip_multicast-0"/><a name="27298"/>27298: <b>has_support_ip_multicast</b>() -&gt;
<a name="has_support_ip_multicast-last_expr"/><a name="27299"/>27299: <b>    case os:type</b>() of
<a name="27300"/>27300:         {unix, OsName} when (OsName =:= linux) orelse
<a name="27301"/>27301:                             (OsName =:= sunos) -&gt;
<a name="27302"/>27302:             case ?SLIB:which_local_host_info(inet) of
<a name="27303"/>27303:                 {ok, #{flags := Flags}} -&gt;
<a name="27304"/>27304:                     case lists:member(multicast, Flags) of
<a name="27305"/>27305:                         true -&gt;
<a name="27306"/>27306:                             ok;
<a name="27307"/>27307:                         false -&gt;
<a name="27308"/>27308:                             not_supported(multicast)
<a name="27309"/>27309:                     end;
<a name="27310"/>27310:                 {error, Reason} -&gt;
<a name="27311"/>27311:                     not_supported({multicast, Reason})
<a name="27312"/>27312:             end;
<a name="27313"/>27313:         {unix, OsName} -&gt;
<a name="27314"/>27314:             skip(?F(&quot;Not Supported: platform ~w&quot;, [OsName]));
<a name="27315"/>27315:         Type -&gt;
<a name="27316"/>27316:             skip(?F(&quot;Not Supported: platform ~p&quot;, [Type]))
<a name="27317"/>27317:     end.
<a name="27318"/>27318: 
<a name="27319"/>27319: 
<a name="27320"/>27320: <i>%% --- SOCK socket option test functions ---</i>
<a name="27321"/>27321: 
<a name="has_support_sock_acceptconn-0"/><a name="27322"/>27322: <b>has_support_sock_acceptconn</b>() -&gt;
<a name="has_support_sock_acceptconn-last_expr"/><a name="27323"/>27323: <b>    has_support_socket_option_sock</b>(acceptconn).
<a name="27324"/>27324: 
<a name="has_support_sock_bindtodevice-0"/><a name="27325"/>27325: <b>has_support_sock_bindtodevice</b>() -&gt;
<a name="has_support_sock_bindtodevice-last_expr"/><a name="27326"/>27326: <b>    has_support_socket_option_sock</b>(bindtodevice).
<a name="27327"/>27327: 
<a name="has_support_sock_broadcast-0"/><a name="27328"/>27328: <b>has_support_sock_broadcast</b>() -&gt;
<a name="27329"/>27329:     has_support_ipv4(),
<a name="27330"/>27330:     has_support_socket_option_sock(broadcast),
<a name="has_support_sock_broadcast-last_expr"/><a name="27331"/>27331: <b>    case ?SLIB:which_local_host_info</b>(inet) of
<a name="27332"/>27332:         {ok, #{flags := Flags}} -&gt;
<a name="27333"/>27333:             case lists:member(broadcast, Flags) of
<a name="27334"/>27334:                 true -&gt;
<a name="27335"/>27335:                     ok;
<a name="27336"/>27336:                 false -&gt;
<a name="27337"/>27337:                     not_supported({broadcast, Flags})
<a name="27338"/>27338:             end;
<a name="27339"/>27339:         {error, Reason} -&gt;
<a name="27340"/>27340:             not_supported({broadcast, Reason})
<a name="27341"/>27341:     end.
<a name="27342"/>27342: 
<a name="has_support_sock_debug-0"/><a name="27343"/>27343: <b>has_support_sock_debug</b>() -&gt;
<a name="has_support_sock_debug-last_expr"/><a name="27344"/>27344: <b>    has_support_socket_option_sock</b>(debug).
<a name="27345"/>27345: 
<a name="has_support_sock_domain-0"/><a name="27346"/>27346: <b>has_support_sock_domain</b>() -&gt;
<a name="has_support_sock_domain-last_expr"/><a name="27347"/>27347: <b>    has_support_socket_option_sock</b>(domain).
<a name="27348"/>27348: 
<a name="has_support_sock_dontroute-0"/><a name="27349"/>27349: <b>has_support_sock_dontroute</b>() -&gt;
<a name="has_support_sock_dontroute-last_expr"/><a name="27350"/>27350: <b>    has_support_socket_option_sock</b>(dontroute).
<a name="27351"/>27351: 
<a name="has_support_sock_keepalive-0"/><a name="27352"/>27352: <b>has_support_sock_keepalive</b>() -&gt;
<a name="has_support_sock_keepalive-last_expr"/><a name="27353"/>27353: <b>    has_support_socket_option_sock</b>(keepalive).
<a name="27354"/>27354: 
<a name="has_support_sock_reuseaddr-0"/><a name="27355"/>27355: <b>has_support_sock_reuseaddr</b>() -&gt;
<a name="has_support_sock_reuseaddr-last_expr"/><a name="27356"/>27356: <b>    has_support_socket_option_sock</b>(reuseaddr).
<a name="27357"/>27357: 
<a name="has_support_sock_bsp_state-0"/><a name="27358"/>27358: <b>has_support_sock_bsp_state</b>() -&gt;
<a name="has_support_sock_bsp_state-last_expr"/><a name="27359"/>27359: <b>    has_support_socket_option_sock</b>(bsp_state).
<a name="27360"/>27360: 
<a name="has_support_sock_exclusiveaddruse-0"/><a name="27361"/>27361: <b>has_support_sock_exclusiveaddruse</b>() -&gt;
<a name="has_support_sock_exclusiveaddruse-last_expr"/><a name="27362"/>27362: <b>    has_support_socket_option_sock</b>(exclusiveaddruse).
<a name="27363"/>27363: 
<a name="has_support_sock_maxdg-0"/><a name="27364"/>27364: <b>has_support_sock_maxdg</b>() -&gt;
<a name="has_support_sock_maxdg-last_expr"/><a name="27365"/>27365: <b>    has_support_socket_option_sock</b>(maxdg).
<a name="27366"/>27366: 
<a name="has_support_sock_max_msg_size-0"/><a name="27367"/>27367: <b>has_support_sock_max_msg_size</b>() -&gt;
<a name="has_support_sock_max_msg_size-last_expr"/><a name="27368"/>27368: <b>    has_support_socket_option_sock</b>(max_msg_size).
<a name="27369"/>27369: 
<a name="has_support_sock_oobinline-0"/><a name="27370"/>27370: <b>has_support_sock_oobinline</b>() -&gt;
<a name="has_support_sock_oobinline-last_expr"/><a name="27371"/>27371: <b>    has_support_socket_option_sock</b>(oobinline).
<a name="27372"/>27372: 
<a name="has_support_sock_passcred-0"/><a name="27373"/>27373: <b>has_support_sock_passcred</b>() -&gt;
<a name="has_support_sock_passcred-last_expr"/><a name="27374"/>27374: <b>    has_support_socket_option_sock</b>(passcred).
<a name="27375"/>27375: 
<a name="has_support_sock_peek_off-0"/><a name="27376"/>27376: <b>has_support_sock_peek_off</b>() -&gt;
<a name="has_support_sock_peek_off-last_expr"/><a name="27377"/>27377: <b>    has_support_socket_option_sock</b>(peek_off).
<a name="27378"/>27378: 
<a name="has_support_sock_peercred-0"/><a name="27379"/>27379: <b>has_support_sock_peercred</b>() -&gt;
<a name="has_support_sock_peercred-last_expr"/><a name="27380"/>27380: <b>    has_support_socket_option_sock</b>(peercred).
<a name="27381"/>27381: 
<a name="has_support_sock_priority-0"/><a name="27382"/>27382: <b>has_support_sock_priority</b>() -&gt;
<a name="has_support_sock_priority-last_expr"/><a name="27383"/>27383: <b>    has_support_socket_option_sock</b>(priority).
<a name="27384"/>27384: 
<a name="has_support_sock_rcvbuf-0"/><a name="27385"/>27385: <b>has_support_sock_rcvbuf</b>() -&gt;
<a name="has_support_sock_rcvbuf-last_expr"/><a name="27386"/>27386: <b>    has_support_socket_option_sock</b>(rcvbuf).
<a name="27387"/>27387: 
<a name="has_support_sock_rcvlowat-0"/><a name="27388"/>27388: <b>has_support_sock_rcvlowat</b>() -&gt;
<a name="has_support_sock_rcvlowat-last_expr"/><a name="27389"/>27389: <b>    has_support_socket_option_sock</b>(rcvlowat).
<a name="27390"/>27390: 
<a name="has_support_sock_rcvtimeo-0"/><a name="27391"/>27391: <b>has_support_sock_rcvtimeo</b>() -&gt;
<a name="has_support_sock_rcvtimeo-last_expr"/><a name="27392"/>27392: <b>    has_support_socket_option_sock</b>(rcvtimeo).
<a name="27393"/>27393: 
<a name="has_support_sock_sndbuf-0"/><a name="27394"/>27394: <b>has_support_sock_sndbuf</b>() -&gt;
<a name="has_support_sock_sndbuf-last_expr"/><a name="27395"/>27395: <b>    has_support_socket_option_sock</b>(sndbuf).
<a name="27396"/>27396: 
<a name="has_support_sock_sndlowat-0"/><a name="27397"/>27397: <b>has_support_sock_sndlowat</b>() -&gt;
<a name="has_support_sock_sndlowat-last_expr"/><a name="27398"/>27398: <b>    has_support_socket_option_sock</b>(sndlowat).
<a name="27399"/>27399: 
<a name="has_support_sock_sndtimeo-0"/><a name="27400"/>27400: <b>has_support_sock_sndtimeo</b>() -&gt;
<a name="has_support_sock_sndtimeo-last_expr"/><a name="27401"/>27401: <b>    has_support_socket_option_sock</b>(sndtimeo).
<a name="27402"/>27402: 
<a name="has_support_sock_timestamp-0"/><a name="27403"/>27403: <b>has_support_sock_timestamp</b>() -&gt;
<a name="has_support_sock_timestamp-last_expr"/><a name="27404"/>27404: <b>    has_support_socket_option_sock</b>(timestamp).
<a name="27405"/>27405: 
<a name="27406"/>27406: 
<a name="27407"/>27407: <i>%% --- IP socket option test functions ---</i>
<a name="27408"/>27408: 
<a name="has_support_ip_add_membership-0"/><a name="27409"/>27409: <b>has_support_ip_add_membership</b>() -&gt;
<a name="has_support_ip_add_membership-last_expr"/><a name="27410"/>27410: <b>    has_support_socket_option_ip</b>(add_membership).
<a name="27411"/>27411: 
<a name="has_support_ip_drop_membership-0"/><a name="27412"/>27412: <b>has_support_ip_drop_membership</b>() -&gt;
<a name="has_support_ip_drop_membership-last_expr"/><a name="27413"/>27413: <b>    has_support_socket_option_ip</b>(drop_membership).
<a name="27414"/>27414: 
<a name="has_support_ip_pktinfo-0"/><a name="27415"/>27415: <b>has_support_ip_pktinfo</b>() -&gt;
<a name="has_support_ip_pktinfo-last_expr"/><a name="27416"/>27416: <b>    has_support_socket_option_ip</b>(pktinfo).
<a name="27417"/>27417: 
<a name="has_support_ip_recvopts-0"/><a name="27418"/>27418: <b>has_support_ip_recvopts</b>() -&gt;
<a name="has_support_ip_recvopts-last_expr"/><a name="27419"/>27419: <b>    has_support_socket_option_ip</b>(recvopts).
<a name="27420"/>27420: 
<a name="has_support_ip_recvorigdstaddr-0"/><a name="27421"/>27421: <b>has_support_ip_recvorigdstaddr</b>() -&gt;
<a name="has_support_ip_recvorigdstaddr-last_expr"/><a name="27422"/>27422: <b>    has_support_socket_option_ip</b>(recvorigdstaddr).
<a name="27423"/>27423: 
<a name="has_support_ip_recvtos-0"/><a name="27424"/>27424: <b>has_support_ip_recvtos</b>() -&gt;
<a name="has_support_ip_recvtos-last_expr"/><a name="27425"/>27425: <b>    has_support_socket_option_ip</b>(recvtos).
<a name="27426"/>27426: 
<a name="has_support_ip_recvtos_and_or_sock_timestamp-0"/><a name="27427"/>27427: <b>has_support_ip_recvtos_and_or_sock_timestamp</b>() -&gt;
<a name="has_support_ip_recvtos_and_or_sock_timestamp-last_expr"/><a name="27428"/>27428: <b>    case </b>(socket:is_supported(options, ip, recvtos) orelse 
<a name="27429"/>27429:           socket:is_supported(options, socket, timestamp)) of
<a name="27430"/>27430:         true -&gt;
<a name="27431"/>27431:             ok;
<a name="27432"/>27432:         false -&gt;
<a name="27433"/>27433:             skip(?F(&quot;Neither needed opts &quot;
<a name="27434"/>27434:                     &quot;ip:recvtos or socket:timestamp supported&quot;, []))
<a name="27435"/>27435:     end.
<a name="27436"/>27436: 
<a name="has_support_ip_recvttl-0"/><a name="27437"/>27437: <b>has_support_ip_recvttl</b>() -&gt;
<a name="has_support_ip_recvttl-last_expr"/><a name="27438"/>27438: <b>    has_support_socket_option_ip</b>(recvttl).
<a name="27439"/>27439: 
<a name="has_support_ip_tos-0"/><a name="27440"/>27440: <b>has_support_ip_tos</b>() -&gt;
<a name="has_support_ip_tos-last_expr"/><a name="27441"/>27441: <b>    has_support_socket_option_ip</b>(tos).
<a name="27442"/>27442: 
<a name="has_support_ip_recverr-0"/><a name="27443"/>27443: <b>has_support_ip_recverr</b>() -&gt;
<a name="has_support_ip_recverr-last_expr"/><a name="27444"/>27444: <b>    has_support_socket_option_ip</b>(recverr).
<a name="27445"/>27445: 
<a name="27446"/>27446: 
<a name="27447"/>27447: <i>%% --- IPv6 socket option test functions ---</i>
<a name="27448"/>27448: 
<a name="has_support_ipv6_flowinfo-0"/><a name="27449"/>27449: <b>has_support_ipv6_flowinfo</b>() -&gt;
<a name="has_support_ipv6_flowinfo-last_expr"/><a name="27450"/>27450: <b>    has_support_socket_option_ipv6</b>(flowinfo).
<a name="27451"/>27451: 
<a name="has_support_ipv6_hoplimit_or_recvhoplimit-0"/><a name="27452"/>27452: <b>has_support_ipv6_hoplimit_or_recvhoplimit</b>() -&gt;
<a name="27453"/>27453:     %% case (socket:is_supported(options, ipv6, recvhoplimit) orelse
<a name="27454"/>27454:     %%       socket:is_supported(options, ipv6, hoplimit)) of
<a name="has_support_ipv6_hoplimit_or_recvhoplimit-last_expr"/><a name="27455"/>27455: <b>    case is_any_options_supported</b>([{ipv6, recvhoplimit}, {ipv6, hoplimit}]) of
<a name="27456"/>27456: 	true -&gt;
<a name="27457"/>27457: 	    ok;
<a name="27458"/>27458: 	false -&gt;
<a name="27459"/>27459: 	    skip(?F(&quot;Neither recvhoplimit or hoplimit supported&quot;, []))
<a name="27460"/>27460:     end.
<a name="27461"/>27461: 
<a name="has_support_ipv6_recvpktinfo-0"/><a name="27462"/>27462: <b>has_support_ipv6_recvpktinfo</b>() -&gt;
<a name="has_support_ipv6_recvpktinfo-last_expr"/><a name="27463"/>27463: <b>    has_support_socket_option_ipv6</b>(recvpktinfo).
<a name="27464"/>27464: 
<a name="27465"/>27465: 
<a name="has_support_ipv6_tclass_or_recvtclass-0"/><a name="27466"/>27466: <b>has_support_ipv6_tclass_or_recvtclass</b>() -&gt;
<a name="has_support_ipv6_tclass_or_recvtclass-last_expr"/><a name="27467"/>27467: <b>    case is_any_options_supported</b>([{ipv6, recvtclass}, {ipv6, tclass}]) of
<a name="27468"/>27468: 	true -&gt;
<a name="27469"/>27469: 	    ok;
<a name="27470"/>27470: 	false -&gt;
<a name="27471"/>27471: 	    skip(?F(&quot;Neither recvtclass or tclass supported&quot;, []))
<a name="27472"/>27472:     end.
<a name="27473"/>27473: 
<a name="27474"/>27474: 
<a name="has_support_ipv6_recverr-0"/><a name="27475"/>27475: <b>has_support_ipv6_recverr</b>() -&gt;
<a name="has_support_ipv6_recverr-last_expr"/><a name="27476"/>27476: <b>    has_support_socket_option_ipv6</b>(recverr).
<a name="27477"/>27477: 
<a name="27478"/>27478: 
<a name="27479"/>27479: <i>%% --- TCP socket option test functions ---</i>
<a name="27480"/>27480: 
<a name="has_support_tcp_congestion-0"/><a name="27481"/>27481: <b>has_support_tcp_congestion</b>() -&gt;
<a name="has_support_tcp_congestion-last_expr"/><a name="27482"/>27482: <b>    has_support_socket_option_tcp</b>(congestion).
<a name="27483"/>27483: 
<a name="has_support_tcp_cork-0"/><a name="27484"/>27484: <b>has_support_tcp_cork</b>() -&gt;
<a name="has_support_tcp_cork-last_expr"/><a name="27485"/>27485: <b>    has_support_socket_option_tcp</b>(cork).
<a name="27486"/>27486: 
<a name="has_support_tcp_maxseg-0"/><a name="27487"/>27487: <b>has_support_tcp_maxseg</b>() -&gt;
<a name="has_support_tcp_maxseg-last_expr"/><a name="27488"/>27488: <b>    has_support_socket_option_tcp</b>(maxseg).
<a name="27489"/>27489: 
<a name="has_support_tcp_nodelay-0"/><a name="27490"/>27490: <b>has_support_tcp_nodelay</b>() -&gt;
<a name="has_support_tcp_nodelay-last_expr"/><a name="27491"/>27491: <b>    has_support_socket_option_tcp</b>(nodelay).
<a name="27492"/>27492: 
<a name="has_support_tcp_keepcnt-0"/><a name="27493"/>27493: <b>has_support_tcp_keepcnt</b>() -&gt;
<a name="has_support_tcp_keepcnt-last_expr"/><a name="27494"/>27494: <b>    has_support_socket_option_tcp</b>(keepcnt).
<a name="27495"/>27495: 
<a name="has_support_tcp_keepidle-0"/><a name="27496"/>27496: <b>has_support_tcp_keepidle</b>() -&gt;
<a name="has_support_tcp_keepidle-last_expr"/><a name="27497"/>27497: <b>    has_support_socket_option_tcp</b>(keepidle).
<a name="27498"/>27498: 
<a name="has_support_tcp_keepintvl-0"/><a name="27499"/>27499: <b>has_support_tcp_keepintvl</b>() -&gt;
<a name="has_support_tcp_keepintvl-last_expr"/><a name="27500"/>27500: <b>    has_support_socket_option_tcp</b>(keepintvl).
<a name="27501"/>27501: 
<a name="27502"/>27502: 
<a name="27503"/>27503: <i>%% --- UDP socket option test functions ---</i>
<a name="27504"/>27504: 
<a name="has_support_udp_cork-0"/><a name="27505"/>27505: <b>has_support_udp_cork</b>() -&gt;
<a name="has_support_udp_cork-last_expr"/><a name="27506"/>27506: <b>    has_support_socket_option_udp</b>(cork).
<a name="27507"/>27507: 
<a name="27508"/>27508: 
<a name="27509"/>27509: <i>%% --- General purpose socket option test functions ---</i>
<a name="27510"/>27510: 
<a name="has_support_socket_option_sock-1"/><a name="27511"/>27511: <b>has_support_socket_option_sock</b>(Opt) -&gt;
<a name="has_support_socket_option_sock-last_expr"/><a name="27512"/>27512: <b>    has_support_socket_option</b>(socket, Opt).
<a name="27513"/>27513: 
<a name="has_support_socket_option_ip-1"/><a name="27514"/>27514: <b>has_support_socket_option_ip</b>(Opt) -&gt;
<a name="has_support_socket_option_ip-last_expr"/><a name="27515"/>27515: <b>    has_support_socket_option</b>(ip, Opt).
<a name="27516"/>27516: 
<a name="has_support_socket_option_ipv6-1"/><a name="27517"/>27517: <b>has_support_socket_option_ipv6</b>(Opt) -&gt;
<a name="has_support_socket_option_ipv6-last_expr"/><a name="27518"/>27518: <b>    has_support_socket_option</b>(ipv6, Opt).
<a name="27519"/>27519: 
<a name="has_support_socket_option_tcp-1"/><a name="27520"/>27520: <b>has_support_socket_option_tcp</b>(Opt) -&gt;
<a name="has_support_socket_option_tcp-last_expr"/><a name="27521"/>27521: <b>    has_support_socket_option</b>(tcp, Opt).
<a name="27522"/>27522: 
<a name="has_support_socket_option_udp-1"/><a name="27523"/>27523: <b>has_support_socket_option_udp</b>(Opt) -&gt;
<a name="has_support_socket_option_udp-last_expr"/><a name="27524"/>27524: <b>    has_support_socket_option</b>(udp, Opt).
<a name="27525"/>27525: 
<a name="27526"/>27526: 
<a name="has_support_socket_option-2"/><a name="27527"/>27527: <b>has_support_socket_option</b>(Level, Option) -&gt;
<a name="has_support_socket_option-last_expr"/><a name="27528"/>27528: <b>    case socket:is_supported</b>(options, Level, Option) of
<a name="27529"/>27529:         true -&gt;
<a name="27530"/>27530:             ok;
<a name="27531"/>27531:         false -&gt;
<a name="27532"/>27532:             skip(?F(&quot;Not Supported: ~w option ~w&quot;, [Level, Option]))
<a name="27533"/>27533:     end.
<a name="27534"/>27534: 
<a name="is_any_options_supported-1"/><a name="27535"/>27535: <b>is_any_options_supported</b>(Options) -&gt;
<a name="27536"/>27536:     Pred = fun({Level, Option}) -&gt; socket:is_supported(options, Level, Option) end,
<a name="is_any_options_supported-last_expr"/><a name="27537"/>27537: <b>    lists:any</b>(Pred, Options).
<a name="27538"/>27538: 
<a name="27539"/>27539: 
<a name="27540"/>27540: <i>%% --- Send flag test functions ---</i>
<a name="27541"/>27541: 
<a name="has_support_msg_flag-1"/><a name="27542"/>27542: <b>has_support_msg_flag</b>(Flag) -&gt;
<a name="has_support_msg_flag-last_expr"/><a name="27543"/>27543: <b>    case socket:is_supported</b>(msg_flags, Flag) of
<a name="27544"/>27544:         true -&gt;
<a name="27545"/>27545:             ok;
<a name="27546"/>27546:         false -&gt;
<a name="27547"/>27547:             skip(?F(&quot;Message flag ~w *Not* Supported&quot;, [Flag]))
<a name="27548"/>27548:     end.
<a name="27549"/>27549: 
<a name="27550"/>27550: 
<a name="27551"/>27551: <i>%% Checks that the version is &quot;good enough&quot; (of the specified platform).</i>
<a name="27552"/>27552: 
<a name="is_good_enough_linux-1"/><a name="27553"/>27553: <b>is_good_enough_linux</b>(CondVsn) -&gt;
<a name="is_good_enough_linux-last_expr"/><a name="27554"/>27554: <b>    is_good_enough_platform</b>(unix, linux, CondVsn).
<a name="27555"/>27555: 
<a name="is_good_enough_darwin-1"/><a name="27556"/>27556: <b>is_good_enough_darwin</b>(CondVsn) -&gt;
<a name="is_good_enough_darwin-last_expr"/><a name="27557"/>27557: <b>    is_good_enough_platform</b>(unix, darwin, CondVsn).
<a name="27558"/>27558: 
<a name="is_good_enough_montavista-1"/><a name="27559"/>27559: <b>is_good_enough_montavista</b>(_Vsn) -&gt;
<a name="27560"/>27560:     %% We have *one* old M, which have kernel version 2.6.10.
<a name="27561"/>27561:     %% So if its that kernel version, we only need to check
<a name="27562"/>27562:     %% if its M (no need to figure out the version of M).
<a name="is_good_enough_montavista-last_expr"/><a name="27563"/>27563: <b>    case os:type</b>() of
<a name="27564"/>27564:         {unix, linux} -&gt;
<a name="27565"/>27565:             case os:version() of
<a name="27566"/>27566:                 {2,6,10} -&gt;
<a name="27567"/>27567:                     case etc_issue() of
<a name="27568"/>27568:                         &quot;MontaVista&quot; ++ _ = V -&gt; % Stone age MontaVista =&gt; Skip
<a name="27569"/>27569:                             skip(V);
<a name="27570"/>27570:                         _ -&gt;
<a name="27571"/>27571:                             ok
<a name="27572"/>27572:                     end;
<a name="27573"/>27573:                 _ -&gt;
<a name="27574"/>27574:                     ok
<a name="27575"/>27575:             end;
<a name="27576"/>27576:         _ -&gt;
<a name="27577"/>27577:             ok
<a name="27578"/>27578:     end.
<a name="27579"/>27579:                     
<a name="27580"/>27580: 
<a name="is_good_enough_platform-3"/><a name="27581"/>27581: <b>is_good_enough_platform</b>(Family, Name, CondVsn) -&gt;
<a name="is_good_enough_platform-last_expr"/><a name="27582"/>27582: <b>    case os:type</b>() of
<a name="27583"/>27583: 	{Family, Name} -&gt;
<a name="27584"/>27584: 	    ID = fun() -&gt; ?F(&quot;~w:~w&quot;, [Family, Name]) end,
<a name="27585"/>27585: 	    is_good_enough_platform2(os:version(), CondVsn, ID);
<a name="27586"/>27586: 	_ -&gt;
<a name="27587"/>27587: 	    ok
<a name="27588"/>27588:     end.
<a name="27589"/>27589: 
<a name="is_good_enough_platform2-3"/><a name="27590"/>27590: <b>is_good_enough_platform2</b>(Vsn, CondVsn, _) when (Vsn &gt; CondVsn) -&gt;
<a name="27591"/>27591:     ok;
<a name="27592"/>27592: <b>is_good_enough_platform2</b>(Vsn, CondVsn, ID) -&gt;
<a name="is_good_enough_platform2-last_expr"/><a name="27593"/>27593: <b>    skip</b>(?F(&quot;Not 'good enough' ~s (~p &lt;= ~p)&quot;, [ID(), Vsn, CondVsn])).
<a name="27594"/>27594: 
<a name="is_not_freebsd-0"/><a name="27595"/>27595: <b>is_not_freebsd</b>() -&gt;
<a name="is_not_freebsd-last_expr"/><a name="27596"/>27596: <b>    is_not_platform</b>(freebsd, &quot;FreeBSD&quot;).
<a name="27597"/>27597: 
<a name="is_not_openbsd-0"/><a name="27598"/>27598: <b>is_not_openbsd</b>() -&gt;
<a name="is_not_openbsd-last_expr"/><a name="27599"/>27599: <b>    is_not_platform</b>(openbsd, &quot;OpenBSD&quot;).
<a name="27600"/>27600: 
<a name="is_not_netbsd-0"/><a name="27601"/>27601: <b>is_not_netbsd</b>() -&gt;
<a name="is_not_netbsd-last_expr"/><a name="27602"/>27602: <b>    is_not_platform</b>(netbsd, &quot;NetBSD&quot;).
<a name="27603"/>27603: 
<a name="is_not_darwin-0"/><a name="27604"/>27604: <b>is_not_darwin</b>() -&gt;
<a name="is_not_darwin-last_expr"/><a name="27605"/>27605: <b>    is_not_platform</b>(darwin, &quot;Darwin&quot;).
<a name="27606"/>27606: 
<a name="etc_issue-0"/><a name="27607"/>27607: <b>etc_issue</b>() -&gt;
<a name="etc_issue-last_expr"/><a name="27608"/>27608: <b>    string:trim</b>(os:cmd(&quot;cat /etc/issue&quot;)).
<a name="27609"/>27609: 
<a name="is_not_windows-0"/><a name="27610"/>27610: <b>is_not_windows</b>() -&gt;
<a name="is_not_windows-last_expr"/><a name="27611"/>27611: <b>    case os:type</b>() of
<a name="27612"/>27612:         {win32, nt} -&gt;
<a name="27613"/>27613:             skip(&quot;This does not work on Windows&quot;);
<a name="27614"/>27614:         _ -&gt;
<a name="27615"/>27615:             ok
<a name="27616"/>27616:     end.
<a name="27617"/>27617: 
<a name="27618"/>27618: 
<a name="is_not_platform-2"/><a name="27619"/>27619: <b>is_not_platform</b>(Platform, PlatformStr)
<a name="27620"/>27620:   when is_atom(Platform) andalso is_list(PlatformStr) -&gt;
<a name="is_not_platform-last_expr"/><a name="27621"/>27621: <b>      case os:type</b>() of
<a name="27622"/>27622:           {unix, Platform} -&gt;
<a name="27623"/>27623:               skip(&quot;This does not work on &quot; ++ PlatformStr);
<a name="27624"/>27624:         _ -&gt;
<a name="27625"/>27625:             ok
<a name="27626"/>27626:     end.
<a name="27627"/>27627:   
<a name="27628"/>27628: 
<a name="unix_domain_socket_host_cond-0"/><a name="27629"/>27629: <b>unix_domain_socket_host_cond</b>() -&gt;
<a name="unix_domain_socket_host_cond-last_expr"/><a name="27630"/>27630: <b>    unix_domain_socket_host_cond</b>(os:type(), os:version()).
<a name="27631"/>27631: 
<a name="unix_domain_socket_host_cond-2"/><a name="27632"/>27632: <b>unix_domain_socket_host_cond</b>({unix, linux}, {M, _, _}) when (M &lt; 3) -&gt;
<a name="27633"/>27633:     skip(&quot;TC may not work on this version&quot;);
<a name="27634"/>27634: <b>unix_domain_socket_host_cond</b>(_, _) -&gt;
<a name="unix_domain_socket_host_cond-last_expr"/><a name="27635"/>27635:     ok.
<a name="27636"/>27636: 
<a name="has_support_unix_domain_socket-0"/><a name="27637"/>27637: <b>has_support_unix_domain_socket</b>() -&gt;
<a name="has_support_unix_domain_socket-last_expr"/><a name="27638"/>27638: <b>    case socket:is_supported</b>(local) of
<a name="27639"/>27639: 	true -&gt;
<a name="27640"/>27640: 	    ok;
<a name="27641"/>27641: 	false -&gt;
<a name="27642"/>27642: 	    skip(&quot;Not supported&quot;)
<a name="27643"/>27643:     end.
<a name="27644"/>27644: 
<a name="has_support_sctp-0"/><a name="27645"/>27645: <b>has_support_sctp</b>() -&gt;
<a name="has_support_sctp-last_expr"/><a name="27646"/>27646: <b>    case os:type</b>() of
<a name="27647"/>27647:         {win32, _} -&gt;
<a name="27648"/>27648:             skip(&quot;Not supported&quot;);
<a name="27649"/>27649:         {unix, netbsd} -&gt;
<a name="27650"/>27650:             %% XXX We will have to investigate this later...
<a name="27651"/>27651:             skip(&quot;Not supported&quot;);
<a name="27652"/>27652:         _ -&gt;
<a name="27653"/>27653:             case socket:is_supported(sctp) of
<a name="27654"/>27654:                 true -&gt;
<a name="27655"/>27655:                     ok;
<a name="27656"/>27656:                 false -&gt;
<a name="27657"/>27657:                     skip(&quot;Not supported&quot;)
<a name="27658"/>27658:             end
<a name="27659"/>27659:     end.
<a name="27660"/>27660: 
<a name="27661"/>27661: 
<a name="27662"/>27662: <i>%% The idea is that this function shall test if the test host has </i>
<a name="27663"/>27663: <i>%% support for IPv4 or IPv6. If not, there is no point in running corresponding tests.</i>
<a name="27664"/>27664: <i>%% Currently we just skip.</i>
<a name="has_support_ipv4-0"/><a name="27665"/>27665: <b>has_support_ipv4</b>() -&gt;
<a name="has_support_ipv4-last_expr"/><a name="27666"/>27666: <b>    ?KLIB:has_support_ipv4</b>().
<a name="27667"/>27667: 
<a name="has_support_ipv6-0"/><a name="27668"/>27668: <b>has_support_ipv6</b>() -&gt;
<a name="has_support_ipv6-last_expr"/><a name="27669"/>27669: <b>    ?KLIB:has_support_ipv6</b>().
<a name="27670"/>27670: 
<a name="inet_or_inet6-0"/><a name="27671"/>27671: <b>inet_or_inet6</b>() -&gt;
<a name="inet_or_inet6-last_expr"/><a name="27672"/>27672:     try
<a name="27673"/>27673:         has_support_ipv4(),
<a name="27674"/>27674:         inet
<a name="27675"/>27675:     catch
<a name="27676"/>27676:         throw:{skip, _Reason} -&gt;
<a name="27677"/>27677:             has_support_ipv6(),
<a name="27678"/>27678:             inet6
<a name="27679"/>27679:     end.
<a name="27680"/>27680: 
<a name="has_support_sendfile-0"/><a name="27681"/>27681: <b>has_support_sendfile</b>() -&gt;
<a name="has_support_sendfile-last_expr"/><a name="27682"/>27682: <b>    try socket:is_supported</b>(sendfile) of
<a name="27683"/>27683:         true -&gt;
<a name="27684"/>27684:             ok;
<a name="27685"/>27685:         false -&gt;
<a name="27686"/>27686:             skip(&quot;Not supported: sendfile&quot;)
<a name="27687"/>27687:     catch
<a name="27688"/>27688:         error : notsup -&gt;
<a name="27689"/>27689:             skip(&quot;Not supported: socket&quot;)
<a name="27690"/>27690:     end.
<a name="27691"/>27691: 
<a name="27692"/>27692: 
<a name="27693"/>27693: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27694"/>27694: 
<a name="unlink_path-1"/><a name="27695"/>27695: <b>unlink_path</b>(Path) -&gt;
<a name="unlink_path-last_expr"/><a name="27696"/>27696: <b>    unlink_path</b>(Path, fun() -&gt; ok end, fun() -&gt; ok end).
<a name="27697"/>27697: 
<a name="unlink_path-3"/><a name="27698"/>27698: <b>unlink_path</b>(Path, Success, Failure)
<a name="27699"/>27699:   when is_function(Success, 0), is_function(Failure, 0) -&gt;
<a name="unlink_path-last_expr"/><a name="27700"/>27700:     case Path of
<a name="27701"/>27701:         undefined -&gt;
<a name="27702"/>27702:             ?SEV_IPRINT(&quot;not a path to unlink&quot;),
<a name="27703"/>27703:                     Success();
<a name="27704"/>27704:         _ -&gt;
<a name="27705"/>27705:             ?SEV_IPRINT(&quot;try unlink path: &quot;
<a name="27706"/>27706:                         &quot;~n   ~s&quot;, [Path]),
<a name="27707"/>27707:             case file:delete(Path) of
<a name="27708"/>27708:                 ok -&gt;
<a name="27709"/>27709:                     ?SEV_IPRINT(&quot;path unlinked: &quot;
<a name="27710"/>27710:                                 &quot;~n   Path: ~s&quot;, [Path]),
<a name="27711"/>27711:                     Success();
<a name="27712"/>27712:                 Error -&gt;
<a name="27713"/>27713:                     ?SEV_EPRINT(&quot;unlink failed: &quot;
<a name="27714"/>27714:                                 &quot;~n   Path: ~s&quot;
<a name="27715"/>27715:                                 &quot;~n   Res:  ~p&quot;, [Path, Error]),
<a name="27716"/>27716:                     Failure()
<a name="27717"/>27717:             end
<a name="27718"/>27718:     end.
<a name="27719"/>27719: 
<a name="27720"/>27720: 
<a name="27721"/>27721: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27722"/>27722: 
<a name="not_supported-1"/><a name="27723"/>27723: <b>not_supported</b>(What) -&gt;
<a name="not_supported-last_expr"/><a name="27724"/>27724: <b>    skip</b>({not_supported, What}).
<a name="27725"/>27725: 
<a name="not_yet_implemented-0"/><a name="27726"/>27726: <b>not_yet_implemented</b>() -&gt;
<a name="not_yet_implemented-last_expr"/><a name="27727"/>27727: <b>    skip</b>(&quot;not yet implemented&quot;).
<a name="27728"/>27728: 
<a name="skip-1"/><a name="27729"/>27729: <b>skip</b>(Reason) -&gt;
<a name="skip-last_expr"/><a name="27730"/>27730: <b>    throw</b>({skip, Reason}).
<a name="27731"/>27731: 
<a name="27732"/>27732: 
<a name="27733"/>27733: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27734"/>27734: 
<a name="27735"/>27735: <i>%% *** tc_try/2,3 ***</i>
<a name="27736"/>27736: <i>%% Case:      Basically the test case name</i>
<a name="27737"/>27737: <i>%% TCCondFun: A fun that is evaluated before the actual test case</i>
<a name="27738"/>27738: <i>%%            The point of this is that it can performs checks to</i>
<a name="27739"/>27739: <i>%%            see if we shall run the test case at all.</i>
<a name="27740"/>27740: <i>%%            For instance, the test case may only work in specific</i>
<a name="27741"/>27741: <i>%%            conditions.</i>
<a name="27742"/>27742: <i>%% FCFun:     The test case fun</i>
<a name="tc_try-2"/><a name="27743"/>27743: <b>tc_try</b>(Case, TCFun) -&gt;
<a name="tc_try-last_expr"/><a name="27744"/>27744: <b>    ?TC_TRY</b>(Case, TCFun).
<a name="27745"/>27745: 
<a name="tc_try-3"/><a name="27746"/>27746: <b>tc_try</b>(Case, TCCondFun, TCFun) -&gt;
<a name="tc_try-last_expr"/><a name="27747"/>27747: <b>    ?TC_TRY</b>(Case, TCCondFun, TCFun).
<a name="27748"/>27748:    
<a name="27749"/>27749: 
<a name="27750"/>27750: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27751"/>27751: 
<a name="start_node-1"/><a name="27752"/>27752: <b>start_node</b>(Name) -&gt;
<a name="start_node-last_expr"/><a name="27753"/>27753: <b>    start_node</b>(Name, 5000).
<a name="27754"/>27754: 
<a name="start_node-2"/><a name="27755"/>27755: <b>start_node</b>(Name, Timeout) when is_integer(Timeout) andalso (Timeout &gt; 0) -&gt;
<a name="27756"/>27756:     Pa   = filename:dirname(code:which(?MODULE)),
<a name="27757"/>27757:     Args = [&quot;-pa&quot;, Pa,
<a name="27758"/>27758:             &quot;-s&quot;, atom_to_list(?PROXY), &quot;start&quot;, atom_to_list(node()),
<a name="27759"/>27759:             &quot;-s&quot;, &quot;global&quot;, &quot;sync&quot;],
<a name="start_node-last_expr"/><a name="27760"/>27760: <b>    try ?CT_PEER</b>(#{name      =&gt; Name,
<a name="27761"/>27761:                    wait_boot =&gt; Timeout,
<a name="27762"/>27762:                    args      =&gt; Args}) of
<a name="27763"/>27763:         {ok, Peer, Node} -&gt;
<a name="27764"/>27764:             ?SEV_IPRINT(&quot;Started node ~p - now (global) sync&quot;, [Name]),
<a name="27765"/>27765:             global:sync(), % Again, just in case...
<a name="27766"/>27766:             ?SEV_IPRINT(&quot;ping proxy&quot;),
<a name="27767"/>27767:             pong = ?PPING(Node),
<a name="27768"/>27768:             {Peer, Node};
<a name="27769"/>27769:         {error, Reason} -&gt;
<a name="27770"/>27770:             ?SEV_EPRINT(&quot;failed starting node ~p (=&gt; SKIP):&quot;
<a name="27771"/>27771:                         &quot;~n   ~p&quot;, [Name, Reason]),
<a name="27772"/>27772:             skip(Reason)
<a name="27773"/>27773:     catch
<a name="27774"/>27774:         Class:Reason:Stack -&gt;
<a name="27775"/>27775:             ?SEV_EPRINT(&quot;Failed starting node: &quot;
<a name="27776"/>27776:                         &quot;~n   Class:  ~p&quot;
<a name="27777"/>27777:                         &quot;~n   Reason: ~p&quot;
<a name="27778"/>27778:                         &quot;~n   Stack:  ~p&quot;,
<a name="27779"/>27779:                         [Class, Reason, Stack]),
<a name="27780"/>27780:             skip({node_start, Class, Reason})
<a name="27781"/>27781:     end.
<a name="27782"/>27782: 
<a name="27783"/>27783:             
<a name="27784"/>27784: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27785"/>27785: 
<a name="nowait-1"/><a name="27786"/>27786: <b>nowait</b>(Config) -&gt;
<a name="nowait-last_expr"/><a name="27787"/>27787: <b>    case lists:member</b>({select_handle, true}, Config) of
<a name="27788"/>27788:         true -&gt;
<a name="27789"/>27789:             make_ref();
<a name="27790"/>27790:         false -&gt;
<a name="27791"/>27791:             nowait
<a name="27792"/>27792:     end.
<a name="27793"/>27793: 
<a name="i-1"/><a name="27794"/>27794: <b>i</b>(F) -&gt;
<a name="i-last_expr"/><a name="27795"/>27795: <b>    i</b>(F, []).
<a name="27796"/>27796: 
<a name="i-2"/><a name="27797"/>27797: <b>i</b>(F, A) -&gt;
<a name="27798"/>27798:     FStr = ?F(&quot;[~s] &quot; ++ F, [?FTS()|A]),
<a name="27799"/>27799:     io:format(user, FStr ++ &quot;~n&quot;, []),
<a name="i-last_expr"/><a name="27800"/>27800: <b>    io:format</b>(FStr, []).
<a name="27801"/>27801: 
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
