<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/mnesia/make_test_dir/mnesia_test/mnesia_dirty_access_test.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1996-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <b>-module</b>(mnesia_dirty_access_test).
<a name="23"/>   23: <b>-author</b>('hakan@erix.ericsson.se').
<a name="24"/>   24: <b>-include</b>(&quot;mnesia_test_lib.hrl&quot;).
<a name="25"/>   25: 
<a name="26"/>   26: <b>-export</b>([init_per_testcase/2, end_per_testcase/2,
<a name="27"/>   27:          init_per_group/2, end_per_group/2,
<a name="28"/>   28:          all/0, groups/0]).
<a name="29"/>   29: 
<a name="30"/>   30: <b>-export</b>([dirty_write_ram/1, dirty_write_disc/1, dirty_write_disc_only/1, dirty_write_xets/1,
<a name="31"/>   31:          dirty_read_ram/1, dirty_read_disc/1, dirty_read_disc_only/1, dirty_read_xets/1,
<a name="32"/>   32:          dirty_update_counter_ram/1, dirty_update_counter_disc/1,
<a name="33"/>   33:          dirty_update_counter_disc_only/1, dirty_update_counter_xets/1,
<a name="34"/>   34:          dirty_delete_ram/1, dirty_delete_disc/1, dirty_delete_disc_only/1, dirty_delete_xets/1,
<a name="35"/>   35:          dirty_delete_object_ram/1, dirty_delete_object_disc/1,
<a name="36"/>   36:          dirty_delete_object_disc_only/1, dirty_delete_object_xets/1,
<a name="37"/>   37:          dirty_match_object_ram/1, dirty_match_object_disc/1,
<a name="38"/>   38:          dirty_match_object_disc_only/1, dirty_match_object_xets/1,
<a name="39"/>   39:          dirty_index_match_object_ram/1, dirty_index_match_object_disc/1,
<a name="40"/>   40:          dirty_index_match_object_disc_only/1, dirty_index_match_object_xets/1,
<a name="41"/>   41:          dirty_index_read_ram/1, dirty_index_read_disc/1,
<a name="42"/>   42:          dirty_index_read_disc_only/1, dirty_index_read_xets/1,
<a name="43"/>   43:          dirty_index_update_set_ram/1,  dirty_index_update_set_disc/1,
<a name="44"/>   44:          dirty_index_update_set_disc_only/1,  dirty_index_update_set_xets/1,
<a name="45"/>   45:          dirty_index_update_bag_ram/1, dirty_index_update_bag_disc/1,
<a name="46"/>   46:          dirty_index_update_bag_disc_only/1, dirty_index_update_bag_xets/1,
<a name="47"/>   47:          dirty_iter_ram/1, dirty_iter_disc/1, dirty_iter_disc_only/1,dirty_iter_xets/1,
<a name="48"/>   48:          del_table_copy_1/1, del_table_copy_2/1, del_table_copy_3/1,
<a name="49"/>   49:          add_table_copy_1/1, add_table_copy_2/1, add_table_copy_3/1,
<a name="50"/>   50:          add_table_copy_4/1, move_table_copy_1/1, move_table_copy_2/1,
<a name="51"/>   51:          move_table_copy_3/1, move_table_copy_4/1, dirty_error_stacktrace/1]).
<a name="52"/>   52: 
<a name="53"/>   53: <b>-export</b>([update_trans/3]).
<a name="54"/>   54: 
<a name="init_per_testcase-2"/><a name="55"/>   55: <b>init_per_testcase</b>(Func, Conf) -&gt;
<a name="init_per_testcase-last_expr"/><a name="56"/>   56: <b>    mnesia_test_lib:init_per_testcase</b>(Func, Conf).
<a name="57"/>   57: 
<a name="end_per_testcase-2"/><a name="58"/>   58: <b>end_per_testcase</b>(Func, Conf) -&gt;
<a name="end_per_testcase-last_expr"/><a name="59"/>   59: <b>    mnesia_test_lib:end_per_testcase</b>(Func, Conf).
<a name="60"/>   60: 
<a name="61"/>   61: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="all-0"/><a name="62"/>   62: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="63"/>   63:     [{group, dirty_write}, {group, dirty_read},
<a name="64"/>   64:      {group, dirty_update_counter}, {group, dirty_delete},
<a name="65"/>   65:      {group, dirty_delete_object},
<a name="66"/>   66:      {group, dirty_match_object}, {group, dirty_index},
<a name="67"/>   67:      {group, dirty_iter}, {group, admin_tests}, dirty_error_stacktrace].
<a name="68"/>   68: 
<a name="groups-0"/><a name="69"/>   69: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="70"/>   70:     [{dirty_write, [],
<a name="71"/>   71:       [dirty_write_ram, dirty_write_disc, dirty_write_disc_only,
<a name="72"/>   72:        dirty_write_xets]},
<a name="73"/>   73:      {dirty_read, [],
<a name="74"/>   74:       [dirty_read_ram, dirty_read_disc, dirty_read_disc_only, dirty_read_xets]},
<a name="75"/>   75:      {dirty_update_counter, [],
<a name="76"/>   76:       [dirty_update_counter_ram, dirty_update_counter_disc,
<a name="77"/>   77:        dirty_update_counter_disc_only, dirty_update_counter_xets]},
<a name="78"/>   78:      {dirty_delete, [],
<a name="79"/>   79:       [dirty_delete_ram, dirty_delete_disc,
<a name="80"/>   80:        dirty_delete_disc_only, dirty_delete_xets]},
<a name="81"/>   81:      {dirty_delete_object, [],
<a name="82"/>   82:       [dirty_delete_object_ram, dirty_delete_object_disc,
<a name="83"/>   83:        dirty_delete_object_disc_only, dirty_delete_object_xets]},
<a name="84"/>   84:      {dirty_match_object, [],
<a name="85"/>   85:       [dirty_match_object_ram, dirty_match_object_disc,
<a name="86"/>   86:        dirty_match_object_disc_only, dirty_match_object_xets]},
<a name="87"/>   87:      {dirty_index, [],
<a name="88"/>   88:       [{group, dirty_index_match_object},
<a name="89"/>   89:        {group, dirty_index_read},
<a name="90"/>   90:        {group, dirty_index_update}]},
<a name="91"/>   91:      {dirty_index_match_object, [],
<a name="92"/>   92:       [dirty_index_match_object_ram, dirty_index_match_object_disc,
<a name="93"/>   93:        dirty_index_match_object_disc_only, dirty_index_match_object_xets]},
<a name="94"/>   94:      {dirty_index_read, [],
<a name="95"/>   95:       [dirty_index_read_ram, dirty_index_read_disc,
<a name="96"/>   96:        dirty_index_read_disc_only, dirty_index_read_xets]},
<a name="97"/>   97:      {dirty_index_update, [],
<a name="98"/>   98:       [dirty_index_update_set_ram,  dirty_index_update_set_disc,
<a name="99"/>   99:        dirty_index_update_set_disc_only,  dirty_index_update_set_xets,
<a name="100"/>  100:        dirty_index_update_bag_ram, dirty_index_update_bag_disc,
<a name="101"/>  101:        dirty_index_update_bag_disc_only, dirty_index_update_bag_xets]},
<a name="102"/>  102:      {dirty_iter, [],
<a name="103"/>  103:       [dirty_iter_ram, dirty_iter_disc, dirty_iter_disc_only,
<a name="104"/>  104:        dirty_iter_xets]},
<a name="105"/>  105:      {admin_tests, [],
<a name="106"/>  106:       [del_table_copy_1, del_table_copy_2, del_table_copy_3,
<a name="107"/>  107:        add_table_copy_1, add_table_copy_2, add_table_copy_3,
<a name="108"/>  108:        add_table_copy_4, move_table_copy_1, move_table_copy_2,
<a name="109"/>  109:        move_table_copy_3, move_table_copy_4]}].
<a name="110"/>  110: 
<a name="init_per_group-2"/><a name="111"/>  111: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="112"/>  112:     Config.
<a name="113"/>  113: 
<a name="end_per_group-2"/><a name="114"/>  114: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="115"/>  115:     Config.
<a name="116"/>  116: 
<a name="117"/>  117: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="118"/>  118: <i>%% Errors in dirty activity should have stacktrace</i>
<a name="dirty_error_stacktrace-1"/><a name="119"/>  119: <b>dirty_error_stacktrace</b>(_Config) -&gt;
<a name="120"/>  120:     %% Custom errors should have stacktrace
<a name="121"/>  121:     try
<a name="122"/>  122:         mnesia:async_dirty(fun() -&gt; error(custom_error) end)
<a name="123"/>  123:     catch
<a name="124"/>  124:         exit:{custom_error, _} -&gt; ok
<a name="125"/>  125:     end,
<a name="126"/>  126: 
<a name="127"/>  127:     %% Undef error should have unknown module and function in the stacktrace
<a name="128"/>  128:     try
<a name="129"/>  129:         mnesia:async_dirty(fun() -&gt; unknown_module:unknown_fun(arg) end)
<a name="130"/>  130:     catch
<a name="131"/>  131:         exit:{undef, [{unknown_module, unknown_fun, [arg], []} | _]} -&gt; ok
<a name="132"/>  132:     end,
<a name="133"/>  133: 
<a name="134"/>  134:     %% Exists don't have stacktrace
<a name="135"/>  135:     try
<a name="136"/>  136:         mnesia:async_dirty(fun() -&gt; exit(custom_error) end)
<a name="137"/>  137:     catch
<a name="138"/>  138:         exit:custom_error -&gt; ok
<a name="139"/>  139:     end,
<a name="140"/>  140: 
<a name="141"/>  141:     %% Aborts don't have a stacktrace (unfortunately)
<a name="dirty_error_stacktrace-last_expr"/><a name="142"/>  142:     try
<a name="143"/>  143:         mnesia:async_dirty(fun() -&gt; mnesia:abort(custom_abort) end)
<a name="144"/>  144:     catch
<a name="145"/>  145:         exit:{aborted, custom_abort} -&gt; ok
<a name="146"/>  146:     end.
<a name="147"/>  147: 
<a name="148"/>  148: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="149"/>  149: <i>%% Write records dirty</i>
<a name="150"/>  150: 
<a name="151"/>  151: 
<a name="dirty_write_ram-1"/><a name="152"/>  152: <b>dirty_write_ram</b>(suite) -&gt; [];
<a name="153"/>  153: <b>dirty_write_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_write_ram-last_expr"/><a name="154"/>  154: <b>    dirty_write</b>(Config, ram_copies).
<a name="155"/>  155: 
<a name="dirty_write_disc-1"/><a name="156"/>  156: <b>dirty_write_disc</b>(suite) -&gt; [];
<a name="157"/>  157: <b>dirty_write_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_write_disc-last_expr"/><a name="158"/>  158: <b>    dirty_write</b>(Config, disc_copies).
<a name="159"/>  159: 
<a name="dirty_write_disc_only-1"/><a name="160"/>  160: <b>dirty_write_disc_only</b>(suite) -&gt; [];
<a name="161"/>  161: <b>dirty_write_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_write_disc_only-last_expr"/><a name="162"/>  162: <b>    dirty_write</b>(Config, disc_only_copies).
<a name="163"/>  163: 
<a name="dirty_write_xets-1"/><a name="164"/>  164: <b>dirty_write_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_write_xets-last_expr"/><a name="165"/>  165: <b>    dirty_write</b>(Config, ext_ets).
<a name="166"/>  166: 
<a name="dirty_write-2"/><a name="167"/>  167: <b>dirty_write</b>(Config, Storage) -&gt;
<a name="168"/>  168:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="169"/>  169:     Tab = dirty_write, 
<a name="170"/>  170:     Def = [{attributes, [k, v]}, {Storage, [Node1]}], 
<a name="171"/>  171:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="172"/>  172:     
<a name="173"/>  173:     ?match({'EXIT', _},  mnesia:dirty_write([])), 
<a name="174"/>  174:     ?match({'EXIT', _},  mnesia:dirty_write({Tab, 2})), 
<a name="175"/>  175:     ?match({'EXIT', _},  mnesia:dirty_write({foo, 2})), 
<a name="176"/>  176:     ?match(ok,  mnesia:dirty_write({Tab, 1, 2})), 
<a name="177"/>  177: 
<a name="178"/>  178:     ?match({atomic, ok},   mnesia:transaction(fun() -&gt; 
<a name="179"/>  179: 	    mnesia:dirty_write({Tab, 1, 2}) end)), 
<a name="dirty_write-last_expr"/><a name="180"/>  180: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="181"/>  181: 
<a name="182"/>  182: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="183"/>  183: <i>%% Read records dirty</i>
<a name="184"/>  184: 
<a name="185"/>  185: 
<a name="dirty_read_ram-1"/><a name="186"/>  186: <b>dirty_read_ram</b>(suite) -&gt; [];
<a name="187"/>  187: <b>dirty_read_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_read_ram-last_expr"/><a name="188"/>  188: <b>    dirty_read</b>(Config, ram_copies).
<a name="189"/>  189: 
<a name="dirty_read_disc-1"/><a name="190"/>  190: <b>dirty_read_disc</b>(suite) -&gt; [];
<a name="191"/>  191: <b>dirty_read_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_read_disc-last_expr"/><a name="192"/>  192: <b>    dirty_read</b>(Config, disc_copies).
<a name="193"/>  193: 
<a name="dirty_read_disc_only-1"/><a name="194"/>  194: <b>dirty_read_disc_only</b>(suite) -&gt; [];
<a name="195"/>  195: <b>dirty_read_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_read_disc_only-last_expr"/><a name="196"/>  196: <b>    dirty_read</b>(Config, disc_only_copies).
<a name="197"/>  197: 
<a name="dirty_read_xets-1"/><a name="198"/>  198: <b>dirty_read_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_read_xets-last_expr"/><a name="199"/>  199: <b>    dirty_read</b>(Config, ext_ets).
<a name="200"/>  200: 
<a name="dirty_read-2"/><a name="201"/>  201: <b>dirty_read</b>(Config, Storage) -&gt;
<a name="202"/>  202:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="203"/>  203:     Tab = dirty_read, 
<a name="204"/>  204:     Def = [{type, bag}, {attributes, [k, v]}, {Storage, [Node1]}], 
<a name="205"/>  205:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="206"/>  206:     
<a name="207"/>  207:     ?match({'EXIT', _},  mnesia:dirty_read([])), 
<a name="208"/>  208:     ?match({'EXIT', _},  mnesia:dirty_read({Tab})), 
<a name="209"/>  209:     ?match({'EXIT', _},   mnesia:dirty_read({Tab, 1, 2})), 
<a name="210"/>  210:     ?match([],  mnesia:dirty_read({Tab, 1})), 
<a name="211"/>  211:     ?match(ok,  mnesia:dirty_write({Tab, 1, 2})), 
<a name="212"/>  212:     ?match([{Tab, 1, 2}],  mnesia:dirty_read({Tab, 1})), 
<a name="213"/>  213:     ?match(ok,  mnesia:dirty_write({Tab, 1, 3})), 
<a name="214"/>  214:     ?match([{Tab, 1, 2}, {Tab, 1, 3}],  mnesia:dirty_read({Tab, 1})), 
<a name="215"/>  215: 
<a name="216"/>  216:     ?match({atomic, [{Tab, 1, 2}, {Tab, 1, 3}]},  
<a name="217"/>  217: 	   mnesia:transaction(fun() -&gt; mnesia:dirty_read({Tab, 1}) end)), 
<a name="218"/>  218: 
<a name="219"/>  219:     ?match(false, mnesia:async_dirty(fun() -&gt; mnesia:is_transaction() end)),
<a name="220"/>  220:     ?match(false, mnesia:sync_dirty(fun() -&gt; mnesia:is_transaction() end)),
<a name="221"/>  221:     ?match(false, mnesia:ets(fun() -&gt; mnesia:is_transaction() end)),
<a name="222"/>  222:     ?match(false, mnesia:activity(async_dirty, fun() -&gt; mnesia:is_transaction() end)),
<a name="223"/>  223:     ?match(false, mnesia:activity(sync_dirty,  fun() -&gt; mnesia:is_transaction() end)),
<a name="224"/>  224:     ?match(false, mnesia:activity(ets,         fun() -&gt; mnesia:is_transaction() end)),
<a name="225"/>  225: 
<a name="dirty_read-last_expr"/><a name="226"/>  226: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="227"/>  227: 
<a name="228"/>  228: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="229"/>  229: <i>%% Update counter record dirty</i>
<a name="230"/>  230: 
<a name="231"/>  231: 
<a name="dirty_update_counter_ram-1"/><a name="232"/>  232: <b>dirty_update_counter_ram</b>(suite) -&gt; [];
<a name="233"/>  233: <b>dirty_update_counter_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_update_counter_ram-last_expr"/><a name="234"/>  234: <b>    dirty_update_counter</b>(Config, ram_copies).
<a name="235"/>  235: 
<a name="dirty_update_counter_disc-1"/><a name="236"/>  236: <b>dirty_update_counter_disc</b>(suite) -&gt; [];
<a name="237"/>  237: <b>dirty_update_counter_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_update_counter_disc-last_expr"/><a name="238"/>  238: <b>    dirty_update_counter</b>(Config, disc_copies).
<a name="239"/>  239: 
<a name="dirty_update_counter_disc_only-1"/><a name="240"/>  240: <b>dirty_update_counter_disc_only</b>(suite) -&gt; [];
<a name="241"/>  241: <b>dirty_update_counter_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_update_counter_disc_only-last_expr"/><a name="242"/>  242: <b>    dirty_update_counter</b>(Config, disc_only_copies).
<a name="243"/>  243: 
<a name="dirty_update_counter_xets-1"/><a name="244"/>  244: <b>dirty_update_counter_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_update_counter_xets-last_expr"/><a name="245"/>  245: <b>    dirty_update_counter</b>(Config, ext_ets).
<a name="246"/>  246: 
<a name="dirty_update_counter-2"/><a name="247"/>  247: <b>dirty_update_counter</b>(Config, Storage) -&gt;
<a name="248"/>  248:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="249"/>  249:     Tab = dirty_update_counter, 
<a name="250"/>  250:     Def = [{attributes, [k, v]}, {Storage, [Node1]}], 
<a name="251"/>  251:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="252"/>  252:     ?match(ok,  mnesia:dirty_write({Tab, 1, 2})), 
<a name="253"/>  253:         
<a name="254"/>  254:     ?match({'EXIT', _},  mnesia:dirty_update_counter({Tab, 1}, [])), 
<a name="255"/>  255:     ?match({'EXIT', _},  mnesia:dirty_update_counter({Tab}, 3)), 
<a name="256"/>  256:     ?match({'EXIT', _},  mnesia:dirty_update_counter({foo, 1}, 3)), 
<a name="257"/>  257:     ?match(5,  mnesia:dirty_update_counter({Tab, 1}, 3)), 
<a name="258"/>  258:     ?match([{Tab, 1, 5}],  mnesia:dirty_read({Tab, 1})), 
<a name="259"/>  259: 
<a name="260"/>  260:     ?match({atomic, 8},  mnesia:transaction(fun() -&gt;
<a name="261"/>  261: 	   mnesia:dirty_update_counter({Tab, 1}, 3) end)), 
<a name="262"/>  262:  
<a name="263"/>  263:     ?match(1,  mnesia:dirty_update_counter({Tab, foo}, 1)),
<a name="264"/>  264:     ?match([{Tab, foo,1}], mnesia:dirty_read({Tab,foo})),
<a name="265"/>  265: 
<a name="266"/>  266:     ?match({ok,_}, mnesia:subscribe({table, Tab, detailed})),
<a name="267"/>  267: 
<a name="268"/>  268:     ?match(2, mnesia:dirty_update_counter({Tab, foo}, 1)),
<a name="269"/>  269:     ?match([{Tab, foo,2}], mnesia:dirty_read({Tab,foo})),
<a name="270"/>  270: 
<a name="dirty_update_counter-last_expr"/><a name="271"/>  271: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="272"/>  272: 
<a name="273"/>  273: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="274"/>  274: <i>%% Delete record dirty</i>
<a name="275"/>  275: 
<a name="276"/>  276: 
<a name="dirty_delete_ram-1"/><a name="277"/>  277: <b>dirty_delete_ram</b>(suite) -&gt; [];
<a name="278"/>  278: <b>dirty_delete_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_delete_ram-last_expr"/><a name="279"/>  279: <b>    dirty_delete</b>(Config, ram_copies).
<a name="280"/>  280: 
<a name="dirty_delete_disc-1"/><a name="281"/>  281: <b>dirty_delete_disc</b>(suite) -&gt; [];
<a name="282"/>  282: <b>dirty_delete_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_delete_disc-last_expr"/><a name="283"/>  283: <b>    dirty_delete</b>(Config, disc_copies).
<a name="284"/>  284: 
<a name="dirty_delete_disc_only-1"/><a name="285"/>  285: <b>dirty_delete_disc_only</b>(suite) -&gt; [];
<a name="286"/>  286: <b>dirty_delete_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_delete_disc_only-last_expr"/><a name="287"/>  287: <b>    dirty_delete</b>(Config, disc_only_copies).
<a name="288"/>  288: 
<a name="dirty_delete_xets-1"/><a name="289"/>  289: <b>dirty_delete_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_delete_xets-last_expr"/><a name="290"/>  290: <b>    dirty_delete</b>(Config, ext_ets).
<a name="291"/>  291: 
<a name="dirty_delete-2"/><a name="292"/>  292: <b>dirty_delete</b>(Config, Storage) -&gt;
<a name="293"/>  293:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="294"/>  294:     Tab = dirty_delete, 
<a name="295"/>  295:     Def = [{type, bag}, {attributes, [k, v]}, {Storage, [Node1]}], 
<a name="296"/>  296:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="297"/>  297:     
<a name="298"/>  298:     ?match({'EXIT', _},  mnesia:dirty_delete([])), 
<a name="299"/>  299:     ?match({'EXIT', _},  mnesia:dirty_delete({Tab})), 
<a name="300"/>  300:     ?match({'EXIT', _},  mnesia:dirty_delete({Tab, 1, 2})), 
<a name="301"/>  301:     ?match(ok,  mnesia:dirty_delete({Tab, 1})), 
<a name="302"/>  302:     ?match(ok,  mnesia:dirty_write({Tab, 1, 2})), 
<a name="303"/>  303:     ?match(ok,  mnesia:dirty_delete({Tab, 1})), 
<a name="304"/>  304:     ?match(ok,  mnesia:dirty_write({Tab, 1, 2})), 
<a name="305"/>  305:     ?match(ok,  mnesia:dirty_write({Tab, 1, 2})), 
<a name="306"/>  306:     ?match(ok,  mnesia:dirty_delete({Tab, 1})), 
<a name="307"/>  307: 
<a name="308"/>  308:     ?match(ok,  mnesia:dirty_write({Tab, 1, 2})), 
<a name="309"/>  309:     ?match({atomic, ok},  mnesia:transaction(fun() -&gt;
<a name="310"/>  310: 	   mnesia:dirty_delete({Tab, 1}) end)), 
<a name="dirty_delete-last_expr"/><a name="311"/>  311: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="312"/>  312: 
<a name="313"/>  313: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="314"/>  314: <i>%% Delete matching record dirty</i>
<a name="315"/>  315: 
<a name="316"/>  316: 
<a name="dirty_delete_object_ram-1"/><a name="317"/>  317: <b>dirty_delete_object_ram</b>(suite) -&gt; [];
<a name="318"/>  318: <b>dirty_delete_object_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_delete_object_ram-last_expr"/><a name="319"/>  319: <b>    dirty_delete_object</b>(Config, ram_copies).
<a name="320"/>  320: 
<a name="dirty_delete_object_disc-1"/><a name="321"/>  321: <b>dirty_delete_object_disc</b>(suite) -&gt; [];
<a name="322"/>  322: <b>dirty_delete_object_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_delete_object_disc-last_expr"/><a name="323"/>  323: <b>    dirty_delete_object</b>(Config, disc_copies).
<a name="324"/>  324: 
<a name="dirty_delete_object_disc_only-1"/><a name="325"/>  325: <b>dirty_delete_object_disc_only</b>(suite) -&gt; [];
<a name="326"/>  326: <b>dirty_delete_object_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_delete_object_disc_only-last_expr"/><a name="327"/>  327: <b>    dirty_delete_object</b>(Config, disc_only_copies).
<a name="328"/>  328: 
<a name="dirty_delete_object_xets-1"/><a name="329"/>  329: <b>dirty_delete_object_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_delete_object_xets-last_expr"/><a name="330"/>  330: <b>    dirty_delete_object</b>(Config, ext_ets).
<a name="331"/>  331: 
<a name="dirty_delete_object-2"/><a name="332"/>  332: <b>dirty_delete_object</b>(Config, Storage) -&gt;
<a name="333"/>  333:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="334"/>  334:     Tab = dirty_delete_object, 
<a name="335"/>  335:     Def = [{type, bag}, {attributes, [k, v]}, {Storage, [Node1]}], 
<a name="336"/>  336:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="337"/>  337: 
<a name="338"/>  338:     OneRec = {Tab, 1, 2}, 
<a name="339"/>  339:     ?match({'EXIT', _},  mnesia:dirty_delete_object([])), 
<a name="340"/>  340:     ?match({'EXIT', _},  mnesia:dirty_delete_object({Tab})), 
<a name="341"/>  341:     ?match({'EXIT', _},  mnesia:dirty_delete_object({Tab, 1})), 
<a name="342"/>  342:     ?match(ok,  mnesia:dirty_delete_object(OneRec)), 
<a name="343"/>  343:     ?match(ok,  mnesia:dirty_write(OneRec)), 
<a name="344"/>  344:     ?match(ok,  mnesia:dirty_delete_object(OneRec)), 
<a name="345"/>  345:     ?match(ok,  mnesia:dirty_write(OneRec)), 
<a name="346"/>  346:     ?match(ok,  mnesia:dirty_write(OneRec)), 
<a name="347"/>  347:     ?match(ok,  mnesia:dirty_delete_object(OneRec)), 
<a name="348"/>  348: 
<a name="349"/>  349:     ?match(ok,  mnesia:dirty_write(OneRec)), 
<a name="350"/>  350:     ?match({atomic, ok},  mnesia:transaction(fun() -&gt;
<a name="351"/>  351: 	   mnesia:dirty_delete_object(OneRec) end)), 
<a name="352"/>  352: 
<a name="353"/>  353:     ?match({'EXIT', {aborted, {bad_type, Tab, _}}}, mnesia:dirty_delete_object(Tab, {Tab, {['_']}, 21})),
<a name="354"/>  354:     ?match({'EXIT', {aborted, {bad_type, Tab, _}}}, mnesia:dirty_delete_object(Tab, {Tab, {['$5']}, 21})),
<a name="355"/>  355: 
<a name="dirty_delete_object-last_expr"/><a name="356"/>  356: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="357"/>  357: 
<a name="358"/>  358: 
<a name="359"/>  359: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="360"/>  360: <i>%% Read matching records dirty</i>
<a name="361"/>  361: 
<a name="362"/>  362: 
<a name="dirty_match_object_ram-1"/><a name="363"/>  363: <b>dirty_match_object_ram</b>(suite) -&gt; [];
<a name="364"/>  364: <b>dirty_match_object_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_match_object_ram-last_expr"/><a name="365"/>  365: <b>    dirty_match_object</b>(Config, ram_copies).
<a name="366"/>  366: 
<a name="dirty_match_object_disc-1"/><a name="367"/>  367: <b>dirty_match_object_disc</b>(suite) -&gt; [];
<a name="368"/>  368: <b>dirty_match_object_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_match_object_disc-last_expr"/><a name="369"/>  369: <b>    dirty_match_object</b>(Config, disc_copies).
<a name="370"/>  370: 
<a name="dirty_match_object_disc_only-1"/><a name="371"/>  371: <b>dirty_match_object_disc_only</b>(suite) -&gt; [];
<a name="372"/>  372: <b>dirty_match_object_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_match_object_disc_only-last_expr"/><a name="373"/>  373: <b>    dirty_match_object</b>(Config, disc_only_copies).
<a name="374"/>  374: 
<a name="dirty_match_object_xets-1"/><a name="375"/>  375: <b>dirty_match_object_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_match_object_xets-last_expr"/><a name="376"/>  376: <b>    dirty_match_object</b>(Config, ext_ets).
<a name="377"/>  377: 
<a name="dirty_match_object-2"/><a name="378"/>  378: <b>dirty_match_object</b>(Config, Storage) -&gt;
<a name="379"/>  379:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="380"/>  380:     Tab = dirty_match, 
<a name="381"/>  381:     Def = [{attributes, [k, v]}, {Storage, [Node1]}], 
<a name="382"/>  382:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="383"/>  383: 
<a name="384"/>  384:     OneRec = {Tab, 1, 2}, 
<a name="385"/>  385:     OnePat = {Tab, '$1', 2}, 
<a name="386"/>  386:     ?match([], mnesia:dirty_match_object(OnePat)), 
<a name="387"/>  387:     ?match(ok,  mnesia:dirty_write(OneRec)), 
<a name="388"/>  388:     ?match([OneRec],  mnesia:dirty_match_object(OnePat)), 
<a name="389"/>  389:     ?match({atomic, [OneRec]},  mnesia:transaction(fun() -&gt;
<a name="390"/>  390: 	 mnesia:dirty_match_object(OnePat) end)), 
<a name="391"/>  391:     
<a name="392"/>  392:     ?match({'EXIT', _},  mnesia:dirty_match_object({foo, '$1', 2})), 
<a name="393"/>  393:     ?match({'EXIT', _},  mnesia:dirty_match_object({[], '$1', 2})), 
<a name="dirty_match_object-last_expr"/><a name="394"/>  394: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="395"/>  395: 
<a name="396"/>  396: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="397"/>  397: 
<a name="398"/>  398: 
<a name="399"/>  399: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="400"/>  400: <i>%% Dirty read matching records by using an index</i>
<a name="401"/>  401: 
<a name="dirty_index_match_object_ram-1"/><a name="402"/>  402: <b>dirty_index_match_object_ram</b>(suite) -&gt; [];
<a name="403"/>  403: <b>dirty_index_match_object_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_match_object_ram-last_expr"/><a name="404"/>  404: <b>    dirty_index_match_object</b>(Config, ram_copies).
<a name="405"/>  405: 
<a name="dirty_index_match_object_disc-1"/><a name="406"/>  406: <b>dirty_index_match_object_disc</b>(suite) -&gt; [];
<a name="407"/>  407: <b>dirty_index_match_object_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_match_object_disc-last_expr"/><a name="408"/>  408: <b>    dirty_index_match_object</b>(Config, disc_copies).
<a name="409"/>  409: 
<a name="dirty_index_match_object_disc_only-1"/><a name="410"/>  410: <b>dirty_index_match_object_disc_only</b>(suite) -&gt; [];
<a name="411"/>  411: <b>dirty_index_match_object_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_match_object_disc_only-last_expr"/><a name="412"/>  412: <b>    dirty_index_match_object</b>(Config, disc_only_copies).
<a name="413"/>  413: 
<a name="dirty_index_match_object_xets-1"/><a name="414"/>  414: <b>dirty_index_match_object_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_match_object_xets-last_expr"/><a name="415"/>  415: <b>    dirty_index_match_object</b>(Config, ext_ets).
<a name="416"/>  416: 
<a name="dirty_index_match_object-2"/><a name="417"/>  417: <b>dirty_index_match_object</b>(Config, Storage) -&gt;
<a name="418"/>  418:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="419"/>  419:     Tab = dirty_index_match_object, 
<a name="420"/>  420:     ValPos = 3, 
<a name="421"/>  421:     BadValPos = ValPos + 1, 
<a name="422"/>  422:     Def = [{attributes, [k, v]}, {Storage, [Node1]}, {index, [ValPos]}], 
<a name="423"/>  423:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="424"/>  424:     
<a name="425"/>  425:     ?match([],  mnesia:dirty_index_match_object({Tab, '$1', 2}, ValPos)), 
<a name="426"/>  426:     OneRec = {Tab, 1, 2}, 
<a name="427"/>  427:     ?match(ok,  mnesia:dirty_write(OneRec)), 
<a name="428"/>  428:     
<a name="429"/>  429:     ?match([OneRec],  mnesia:dirty_index_match_object({Tab, '$1', 2}, ValPos)), 
<a name="430"/>  430:     ?match({'EXIT', _},  mnesia:dirty_index_match_object({Tab, '$1', 2}, BadValPos)), 
<a name="431"/>  431:     ?match({'EXIT', _},  mnesia:dirty_index_match_object({foo, '$1', 2}, ValPos)), 
<a name="432"/>  432:     ?match({'EXIT', _},  mnesia:dirty_index_match_object({[], '$1', 2}, ValPos)), 
<a name="433"/>  433:     ?match({atomic, [OneRec]},  mnesia:transaction(fun() -&gt;
<a name="434"/>  434:            mnesia:dirty_index_match_object({Tab, '$1', 2}, ValPos) end)),     
<a name="435"/>  435:     
<a name="dirty_index_match_object-last_expr"/><a name="436"/>  436: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="437"/>  437: 
<a name="438"/>  438: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="439"/>  439: <i>%% Read records by using an index</i>
<a name="440"/>  440: 
<a name="441"/>  441: 
<a name="dirty_index_read_ram-1"/><a name="442"/>  442: <b>dirty_index_read_ram</b>(suite) -&gt; [];
<a name="443"/>  443: <b>dirty_index_read_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_read_ram-last_expr"/><a name="444"/>  444: <b>    dirty_index_read</b>(Config, ram_copies).
<a name="445"/>  445: 
<a name="dirty_index_read_disc-1"/><a name="446"/>  446: <b>dirty_index_read_disc</b>(suite) -&gt; [];
<a name="447"/>  447: <b>dirty_index_read_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_read_disc-last_expr"/><a name="448"/>  448: <b>    dirty_index_read</b>(Config, disc_copies).
<a name="449"/>  449: 
<a name="dirty_index_read_disc_only-1"/><a name="450"/>  450: <b>dirty_index_read_disc_only</b>(suite) -&gt; [];
<a name="451"/>  451: <b>dirty_index_read_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_read_disc_only-last_expr"/><a name="452"/>  452: <b>    dirty_index_read</b>(Config, disc_only_copies).
<a name="453"/>  453: 
<a name="dirty_index_read_xets-1"/><a name="454"/>  454: <b>dirty_index_read_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_read_xets-last_expr"/><a name="455"/>  455: <b>    dirty_index_read</b>(Config, ext_ets).
<a name="456"/>  456: 
<a name="dirty_index_read-2"/><a name="457"/>  457: <b>dirty_index_read</b>(Config, Storage) -&gt;
<a name="458"/>  458:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="459"/>  459:     Tab = dirty_index_read, 
<a name="460"/>  460:     ValPos = 3, 
<a name="461"/>  461:     BadValPos = ValPos + 1, 
<a name="462"/>  462:     Def = [{type, set},
<a name="463"/>  463: 	   {attributes, [k, v]},
<a name="464"/>  464: 	   {Storage, [Node1]},
<a name="465"/>  465: 	   {index, [ValPos]}], 
<a name="466"/>  466:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="467"/>  467: 
<a name="468"/>  468:     OneRec = {Tab, 1, 2}, 
<a name="469"/>  469:     ?match([],  mnesia:dirty_index_read(Tab, 2, ValPos)), 
<a name="470"/>  470:     ?match(ok,  mnesia:dirty_write(OneRec)), 
<a name="471"/>  471:     ?match([OneRec],  mnesia:dirty_index_read(Tab, 2, ValPos)), 
<a name="472"/>  472:     ?match({atomic, [OneRec]},  
<a name="473"/>  473: 	   mnesia:transaction(fun() -&gt; mnesia:dirty_index_read(Tab, 2, ValPos) end)),
<a name="474"/>  474:     ?match(42, mnesia:dirty_update_counter({Tab, 1}, 40)),
<a name="475"/>  475:     ?match([{Tab,1,42}], mnesia:dirty_read({Tab, 1})), 
<a name="476"/>  476:     ?match([],  mnesia:dirty_index_read(Tab, 2, ValPos)), 
<a name="477"/>  477:     ?match([{Tab, 1, 42}],  mnesia:dirty_index_read(Tab, 42, ValPos)),
<a name="478"/>  478: 
<a name="479"/>  479:     ?match({'EXIT', _},  mnesia:dirty_index_read(Tab, 2, BadValPos)), 
<a name="480"/>  480:     ?match({'EXIT', _},  mnesia:dirty_index_read(foo, 2, ValPos)), 
<a name="481"/>  481:     ?match({'EXIT', _},  mnesia:dirty_index_read([], 2, ValPos)), 
<a name="482"/>  482: 
<a name="483"/>  483:     mnesia:dirty_write({Tab, 5, 1}),
<a name="484"/>  484:     ?match(ok, index_read_loop(Tab, 0)),
<a name="485"/>  485: 
<a name="dirty_index_read-last_expr"/><a name="486"/>  486: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="487"/>  487: 
<a name="488"/>  488: 
<a name="index_read_loop-2"/><a name="489"/>  489: <b>index_read_loop</b>(Tab, N) when N =&lt; 1000 -&gt;
<a name="490"/>  490:     spawn_link(fun() -&gt;
<a name="491"/>  491: 		       mnesia:transaction(fun() -&gt; mnesia:write({Tab, 5, 1}) end)
<a name="492"/>  492: 	       end),
<a name="493"/>  493:     case mnesia:dirty_match_object({Tab, '_', 1}) of
<a name="494"/>  494: 	[{Tab, 5, 1}] -&gt;
<a name="495"/>  495: 	    index_read_loop(Tab, N+1);
<a name="496"/>  496: 	Other -&gt; {N, Other}
<a name="497"/>  497:     end;
<a name="498"/>  498: <b>index_read_loop</b>(_, _) -&gt;
<a name="index_read_loop-last_expr"/><a name="499"/>  499:     ok.
<a name="500"/>  500: 
<a name="501"/>  501: 
<a name="502"/>  502: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="503"/>  503: 
<a name="504"/>  504: 
<a name="505"/>  505: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="dirty_index_update_set_ram-1"/><a name="506"/>  506: <b>dirty_index_update_set_ram</b>(suite) -&gt; [];
<a name="507"/>  507: <b>dirty_index_update_set_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_update_set_ram-last_expr"/><a name="508"/>  508: <b>    dirty_index_update_set</b>(Config, ram_copies).
<a name="509"/>  509: 
<a name="dirty_index_update_set_disc-1"/><a name="510"/>  510: <b>dirty_index_update_set_disc</b>(suite) -&gt; [];
<a name="511"/>  511: <b>dirty_index_update_set_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_update_set_disc-last_expr"/><a name="512"/>  512: <b>    dirty_index_update_set</b>(Config, disc_copies).
<a name="513"/>  513: 
<a name="dirty_index_update_set_disc_only-1"/><a name="514"/>  514: <b>dirty_index_update_set_disc_only</b>(suite) -&gt; [];
<a name="515"/>  515: <b>dirty_index_update_set_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_update_set_disc_only-last_expr"/><a name="516"/>  516: <b>    dirty_index_update_set</b>(Config, disc_only_copies).
<a name="517"/>  517: 
<a name="dirty_index_update_set_xets-1"/><a name="518"/>  518: <b>dirty_index_update_set_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_update_set_xets-last_expr"/><a name="519"/>  519: <b>    dirty_index_update_set</b>(Config, ext_ets).
<a name="520"/>  520: 
<a name="dirty_index_update_set-2"/><a name="521"/>  521: <b>dirty_index_update_set</b>(Config, Storage) -&gt;
<a name="522"/>  522:     [Node1] = Nodes = ?acquire_nodes(1, Config),
<a name="523"/>  523:     Tab = index_test,
<a name="524"/>  524:     ValPos = v1,
<a name="525"/>  525:     ValPos2 = v3,
<a name="526"/>  526:     Def = [{attributes, [k, v1, v2, v3]},
<a name="527"/>  527: 	   {Storage, [Node1]},
<a name="528"/>  528: 	   {index, [ValPos]}],
<a name="529"/>  529:     ?match({atomic, ok}, mnesia:create_table(Tab, Def)),
<a name="530"/>  530: 
<a name="531"/>  531:     Pat1 = {Tab, '$1',  2,   '$2', '$3'},
<a name="532"/>  532:     Pat2 = {Tab, '$1', '$2', '$3', '$4'},
<a name="533"/>  533:     Pat3 = {Tab, '_', '_', '_', {4, 14}},
<a name="534"/>  534: 
<a name="535"/>  535:     Rec1 = {Tab, 1, 2, 3, {4, 14}},
<a name="536"/>  536:     Rec2 = {Tab, 2, 2, 13, 14},
<a name="537"/>  537:     Rec3 = {Tab, 1, 12, 13, 14},
<a name="538"/>  538:     Rec4 = {Tab, 4, 2, 13, 14},
<a name="539"/>  539: 
<a name="540"/>  540:     ?match([], mnesia:dirty_index_read(Tab, 2, ValPos)),
<a name="541"/>  541:     ?match(ok, mnesia:dirty_write(Rec1)),
<a name="542"/>  542:     ?match([Rec1], mnesia:dirty_index_read(Tab, 2, ValPos)),
<a name="543"/>  543: 
<a name="544"/>  544:     ?match(ok, mnesia:dirty_write(Rec2)),
<a name="545"/>  545:     R1 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="546"/>  546:     ?match([Rec1, Rec2], lists:sort(R1)),
<a name="547"/>  547: 
<a name="548"/>  548:     ?match(ok, mnesia:dirty_write(Rec3)),
<a name="549"/>  549:     R2 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="550"/>  550:     ?match([Rec2], lists:sort(R2)),
<a name="551"/>  551:     ?match([Rec2], mnesia:dirty_index_match_object(Pat1, ValPos)),
<a name="552"/>  552: 
<a name="553"/>  553:     {atomic, R3} = mnesia:transaction(fun() -&gt; mnesia:match_object(Pat2) end),
<a name="554"/>  554:     ?match([Rec3, Rec2], lists:sort(R3)),
<a name="555"/>  555: 
<a name="556"/>  556:     ?match(ok, mnesia:dirty_write(Rec4)),
<a name="557"/>  557:     R4 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="558"/>  558:     ?match([Rec2, Rec4], lists:sort(R4)),
<a name="559"/>  559: 
<a name="560"/>  560:     ?match(ok, mnesia:dirty_delete({Tab, 4})),
<a name="561"/>  561:     ?match([Rec2], mnesia:dirty_index_read(Tab, 2, ValPos)),
<a name="562"/>  562: 
<a name="563"/>  563:     ?match({atomic, ok}, mnesia:del_table_index(Tab, ValPos)),
<a name="564"/>  564:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:write(Rec4) end)),
<a name="565"/>  565:     ?match({atomic, ok}, mnesia:add_table_index(Tab, ValPos)),
<a name="566"/>  566:     ?match({atomic, ok}, mnesia:add_table_index(Tab, ValPos2)),
<a name="567"/>  567: 
<a name="568"/>  568:     R5 = mnesia:dirty_match_object(Pat2),
<a name="569"/>  569:     ?match([Rec3, Rec2, Rec4], lists:sort(R5)),
<a name="570"/>  570: 
<a name="571"/>  571:     R6 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="572"/>  572:     ?match([Rec2, Rec4], lists:sort(R6)),
<a name="573"/>  573:     ?match([], mnesia:dirty_index_read(Tab, {4,14}, ValPos2)),
<a name="574"/>  574:     R7 = mnesia:dirty_index_read(Tab, 14, ValPos2),
<a name="575"/>  575:     ?match([Rec3, Rec2, Rec4], lists:sort(R7)),
<a name="576"/>  576: 
<a name="577"/>  577:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:write(Rec1) end)),
<a name="578"/>  578:     R8 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="579"/>  579:     ?match([Rec1, Rec2, Rec4], lists:sort(R8)),
<a name="580"/>  580:     ?match([Rec1], mnesia:dirty_index_read(Tab, {4,14}, ValPos2)),
<a name="581"/>  581:     ?match([Rec1], mnesia:dirty_match_object(Pat3)),
<a name="582"/>  582:     ?match([Rec1], mnesia:dirty_index_match_object(Pat3, ValPos2)),
<a name="583"/>  583: 
<a name="584"/>  584:     R9 = mnesia:dirty_index_read(Tab, 14, ValPos2),
<a name="585"/>  585:     ?match([Rec2, Rec4], lists:sort(R9)),
<a name="586"/>  586: 
<a name="587"/>  587:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:delete_object(Rec2) end)),
<a name="588"/>  588:     R10 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="589"/>  589:     ?match([Rec1, Rec4], lists:sort(R10)),
<a name="590"/>  590:     ?match([Rec1], mnesia:dirty_index_read(Tab, {4,14}, ValPos2)),
<a name="591"/>  591:     ?match([Rec4], mnesia:dirty_index_read(Tab, 14, ValPos2)),
<a name="592"/>  592: 
<a name="593"/>  593:     ?match(ok, mnesia:dirty_delete({Tab, 4})),
<a name="594"/>  594:     R11 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="595"/>  595:     ?match([Rec1], lists:sort(R11)),
<a name="596"/>  596:     ?match([Rec1], mnesia:dirty_index_read(Tab, {4,14}, ValPos2)),
<a name="597"/>  597:     ?match([], mnesia:dirty_index_read(Tab, 14, ValPos2)),
<a name="598"/>  598:     
<a name="dirty_index_update_set-last_expr"/><a name="599"/>  599: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="600"/>  600: 
<a name="dirty_index_update_bag_ram-1"/><a name="601"/>  601: <b>dirty_index_update_bag_ram</b>(suite) -&gt; [];
<a name="602"/>  602: <b>dirty_index_update_bag_ram</b>(Config)when is_list(Config) -&gt;
<a name="dirty_index_update_bag_ram-last_expr"/><a name="603"/>  603: <b>    dirty_index_update_bag</b>(Config, ram_copies).
<a name="604"/>  604: 
<a name="dirty_index_update_bag_disc-1"/><a name="605"/>  605: <b>dirty_index_update_bag_disc</b>(suite) -&gt; [];
<a name="606"/>  606: <b>dirty_index_update_bag_disc</b>(Config)when is_list(Config) -&gt;
<a name="dirty_index_update_bag_disc-last_expr"/><a name="607"/>  607: <b>    dirty_index_update_bag</b>(Config, disc_copies).
<a name="608"/>  608: 
<a name="dirty_index_update_bag_disc_only-1"/><a name="609"/>  609: <b>dirty_index_update_bag_disc_only</b>(suite) -&gt; [];
<a name="610"/>  610: <b>dirty_index_update_bag_disc_only</b>(Config)when is_list(Config) -&gt;
<a name="dirty_index_update_bag_disc_only-last_expr"/><a name="611"/>  611: <b>    dirty_index_update_bag</b>(Config, disc_only_copies).
<a name="612"/>  612: 
<a name="dirty_index_update_bag_xets-1"/><a name="613"/>  613: <b>dirty_index_update_bag_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_index_update_bag_xets-last_expr"/><a name="614"/>  614: <b>    dirty_index_update_bag</b>(Config, ext_ets).
<a name="615"/>  615: 
<a name="dirty_index_update_bag-2"/><a name="616"/>  616: <b>dirty_index_update_bag</b>(Config, Storage) -&gt;
<a name="617"/>  617:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="618"/>  618:     Tab = index_test, 
<a name="619"/>  619:     ValPos = v1, 
<a name="620"/>  620:     ValPos2 = v3,
<a name="621"/>  621:     Def = [{type, bag},
<a name="622"/>  622: 	   {attributes, [k, v1, v2, v3]}, 
<a name="623"/>  623: 	   {Storage, [Node1]},
<a name="624"/>  624: 	   {index, [ValPos]}], 
<a name="625"/>  625:     ?match({atomic, ok}, mnesia:create_table(Tab, Def)), 
<a name="626"/>  626: 
<a name="627"/>  627:     Pat1 = {Tab, '$1',  2,   '$2', '$3'},
<a name="628"/>  628:     Pat2 = {Tab, '$1', '$2', '$3', '$4'}, 
<a name="629"/>  629: 
<a name="630"/>  630:     Rec1 = {Tab, 1, 2, 3, 4},    
<a name="631"/>  631:     Rec2 = {Tab, 2, 2, 13, 14},  
<a name="632"/>  632:     Rec3 = {Tab, 1, 12, 13, 14}, 
<a name="633"/>  633:     Rec4 = {Tab, 4, 2, 13, 4}, 
<a name="634"/>  634:     Rec5 = {Tab, 1, 2, 234, 14},
<a name="635"/>  635: 
<a name="636"/>  636:     %% Simple Index
<a name="637"/>  637:     ?match([], mnesia:dirty_index_read(Tab, 2, ValPos)),
<a name="638"/>  638:     ?match(ok, mnesia:dirty_write(Rec1)),
<a name="639"/>  639:     ?match([Rec1], mnesia:dirty_index_read(Tab, 2, ValPos)),
<a name="640"/>  640: 
<a name="641"/>  641:     ?match(ok, mnesia:dirty_delete_object(Rec5)),
<a name="642"/>  642:     ?match([Rec1], mnesia:dirty_index_read(Tab, 2, ValPos)),
<a name="643"/>  643: 
<a name="644"/>  644:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:write(Rec2) end)), 
<a name="645"/>  645:     R1 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="646"/>  646:     ?match([Rec1, Rec2], lists:sort(R1)),
<a name="647"/>  647: 
<a name="648"/>  648:     ?match(ok, mnesia:dirty_write(Rec3)),
<a name="649"/>  649:     R2 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="650"/>  650:     ?match([Rec1, Rec2], lists:sort(R2)),
<a name="651"/>  651: 
<a name="652"/>  652:     R3 = mnesia:dirty_index_match_object(Pat1, ValPos),
<a name="653"/>  653:     ?match([Rec1, Rec2], lists:sort(R3)),
<a name="654"/>  654:  
<a name="655"/>  655:     R4 = mnesia:dirty_match_object(Pat2),
<a name="656"/>  656:     ?match([Rec1, Rec3, Rec2], lists:sort(R4)),
<a name="657"/>  657:  
<a name="658"/>  658:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:write(Rec4) end)), 
<a name="659"/>  659:     R5 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="660"/>  660:     ?match([Rec1, Rec2, Rec4], lists:sort(R5)),
<a name="661"/>  661: 
<a name="662"/>  662:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:delete({Tab, 4}) end)), 
<a name="663"/>  663:     R6 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="664"/>  664:     ?match([Rec1, Rec2], lists:sort(R6)),
<a name="665"/>  665: 
<a name="666"/>  666:     ?match(ok, mnesia:dirty_delete_object(Rec1)),
<a name="667"/>  667:     ?match([Rec2], mnesia:dirty_index_read(Tab, 2, ValPos)),
<a name="668"/>  668:     R7 = mnesia:dirty_match_object(Pat2),
<a name="669"/>  669:     ?match([Rec3, Rec2], lists:sort(R7)),
<a name="670"/>  670:     
<a name="671"/>  671:     %% Two indexies
<a name="672"/>  672:     ?match({atomic, ok}, mnesia:del_table_index(Tab, ValPos)),
<a name="673"/>  673:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:write(Rec1) end)),
<a name="674"/>  674:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:write(Rec4) end)),
<a name="675"/>  675:     ?match({atomic, ok}, mnesia:add_table_index(Tab, ValPos)),
<a name="676"/>  676:     ?match({atomic, ok}, mnesia:add_table_index(Tab, ValPos2)),
<a name="677"/>  677:     
<a name="678"/>  678:     R8 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="679"/>  679:     ?match([Rec1, Rec2, Rec4], lists:sort(R8)),
<a name="680"/>  680: 
<a name="681"/>  681:     R9 = mnesia:dirty_index_read(Tab, 4, ValPos2),
<a name="682"/>  682:     ?match([Rec1, Rec4], lists:sort(R9)),
<a name="683"/>  683:     R10 = mnesia:dirty_index_read(Tab, 14, ValPos2),
<a name="684"/>  684:     ?match([Rec3, Rec2], lists:sort(R10)),
<a name="685"/>  685: 
<a name="686"/>  686:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:write(Rec5) end)),
<a name="687"/>  687:     R11 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="688"/>  688:     ?match([Rec1, Rec5, Rec2, Rec4], lists:sort(R11)),
<a name="689"/>  689:     R12 = mnesia:dirty_index_read(Tab, 4, ValPos2),
<a name="690"/>  690:     ?match([Rec1, Rec4], lists:sort(R12)),
<a name="691"/>  691:     R13 = mnesia:dirty_index_read(Tab, 14, ValPos2),
<a name="692"/>  692:     ?match([Rec5, Rec3, Rec2], lists:sort(R13)),
<a name="693"/>  693: 
<a name="694"/>  694:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:delete_object(Rec1) end)),
<a name="695"/>  695:     R14 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="696"/>  696:     ?match([Rec5, Rec2, Rec4], lists:sort(R14)),
<a name="697"/>  697:     ?match([Rec4], mnesia:dirty_index_read(Tab, 4, ValPos2)),
<a name="698"/>  698:     R15 = mnesia:dirty_index_read(Tab, 14, ValPos2),
<a name="699"/>  699:     ?match([Rec5, Rec3, Rec2], lists:sort(R15)),
<a name="700"/>  700: 
<a name="701"/>  701:     ?match(ok, mnesia:dirty_delete_object(Rec5)),
<a name="702"/>  702:     R16 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="703"/>  703:     ?match([Rec2, Rec4], lists:sort(R16)),
<a name="704"/>  704:     ?match([Rec4], mnesia:dirty_index_read(Tab, 4, ValPos2)),
<a name="705"/>  705:     R17 = mnesia:dirty_index_read(Tab, 14, ValPos2),
<a name="706"/>  706:     ?match([Rec3, Rec2], lists:sort(R17)),
<a name="707"/>  707: 
<a name="708"/>  708:     ?match(ok, mnesia:dirty_write(Rec1)),
<a name="709"/>  709:     ?match(ok, mnesia:dirty_delete({Tab, 1})),
<a name="710"/>  710:     R18 = mnesia:dirty_index_read(Tab, 2, ValPos),
<a name="711"/>  711:     ?match([Rec2, Rec4], lists:sort(R18)),
<a name="712"/>  712:     ?match([Rec4], mnesia:dirty_index_read(Tab, 4, ValPos2)),
<a name="713"/>  713:     R19 = mnesia:dirty_index_read(Tab, 14, ValPos2),
<a name="714"/>  714:     ?match([Rec2], lists:sort(R19)),
<a name="715"/>  715: 
<a name="dirty_index_update_bag-last_expr"/><a name="716"/>  716: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="717"/>  717: 
<a name="718"/>  718: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="719"/>  719: <i>%% Dirty iteration</i>
<a name="720"/>  720: <i>%% dirty_slot,  dirty_first,  dirty_next</i>
<a name="721"/>  721: 
<a name="dirty_iter_ram-1"/><a name="722"/>  722: <b>dirty_iter_ram</b>(suite) -&gt; [];
<a name="723"/>  723: <b>dirty_iter_ram</b>(Config) when is_list(Config) -&gt;
<a name="dirty_iter_ram-last_expr"/><a name="724"/>  724: <b>    dirty_iter</b>(Config, ram_copies).
<a name="725"/>  725: 
<a name="dirty_iter_disc-1"/><a name="726"/>  726: <b>dirty_iter_disc</b>(suite) -&gt; [];
<a name="727"/>  727: <b>dirty_iter_disc</b>(Config) when is_list(Config) -&gt;
<a name="dirty_iter_disc-last_expr"/><a name="728"/>  728: <b>    dirty_iter</b>(Config, disc_copies).
<a name="729"/>  729: 
<a name="dirty_iter_disc_only-1"/><a name="730"/>  730: <b>dirty_iter_disc_only</b>(suite) -&gt; [];
<a name="731"/>  731: <b>dirty_iter_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="dirty_iter_disc_only-last_expr"/><a name="732"/>  732: <b>    dirty_iter</b>(Config, disc_only_copies).
<a name="733"/>  733: 
<a name="dirty_iter_xets-1"/><a name="734"/>  734: <b>dirty_iter_xets</b>(Config) when is_list(Config) -&gt;
<a name="dirty_iter_xets-last_expr"/><a name="735"/>  735: <b>    dirty_iter</b>(Config, ext_ets).
<a name="736"/>  736: 
<a name="dirty_iter-2"/><a name="737"/>  737: <b>dirty_iter</b>(Config, Storage) -&gt;
<a name="738"/>  738:     [Node1] = Nodes = ?acquire_nodes(1, Config), 
<a name="739"/>  739:     Tab = dirty_iter, 
<a name="740"/>  740:     Def = [{type, bag}, {attributes, [k, v]}, {Storage, [Node1]}], 
<a name="741"/>  741:     ?match({atomic, ok},  mnesia:create_table(Tab, Def)), 
<a name="742"/>  742: 
<a name="743"/>  743:     ?match([], all_slots(Tab)), 
<a name="744"/>  744:     ?match([], all_nexts(Tab)), 
<a name="745"/>  745: 
<a name="746"/>  746:     Keys = lists:seq(1, 5), 
<a name="747"/>  747:     Records = [{Tab, A, B} || A &lt;- Keys,  B &lt;- lists:seq(1, 2)], 
<a name="748"/>  748:     lists:foreach(fun(Rec) -&gt; ?match(ok, mnesia:dirty_write(Rec)) end, Records), 
<a name="749"/>  749: 
<a name="750"/>  750:     SortedRecords = lists:sort(Records), 
<a name="751"/>  751:     ?match(SortedRecords, lists:sort(all_slots(Tab))), 
<a name="752"/>  752:     ?match(Keys, lists:sort(all_nexts(Tab))), 
<a name="753"/>  753: 
<a name="754"/>  754:     ?match({'EXIT', _}, mnesia:dirty_first(foo)), 
<a name="755"/>  755:     ?match({'EXIT', _}, mnesia:dirty_next(foo, foo)), 
<a name="756"/>  756:     ?match({'EXIT', _}, mnesia:dirty_slot(foo, 0)), 
<a name="757"/>  757:     ?match({'EXIT', _}, mnesia:dirty_slot(foo, [])), 
<a name="758"/>  758:     ?match({atomic, Keys},
<a name="759"/>  759: 	   mnesia:transaction(fun() -&gt; lists:sort(all_nexts(Tab)) end)),     
<a name="dirty_iter-last_expr"/><a name="760"/>  760: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="761"/>  761: 
<a name="762"/>  762: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="763"/>  763: 
<a name="764"/>  764: <i>%% Returns a list of all keys in table</i>
<a name="all_slots-1"/><a name="765"/>  765: <b>all_slots</b>(Tab) -&gt;
<a name="all_slots-last_expr"/><a name="766"/>  766: <b>    all_slots</b>(Tab, [], 0).
<a name="767"/>  767: 
<a name="all_slots-3"/><a name="768"/>  768: <b>all_slots</b>(_Tab, '$end_of_table', _) -&gt;
<a name="769"/>  769:     [];
<a name="770"/>  770: <b>all_slots</b>(Tab, PrevRecords, PrevSlot) -&gt;
<a name="771"/>  771:     Records = mnesia:dirty_slot(Tab, PrevSlot), 
<a name="all_slots-last_expr"/><a name="772"/>  772: <b>    PrevRecords ++ all_slots</b>(Tab, Records, PrevSlot + 1).
<a name="773"/>  773: 
<a name="774"/>  774: <i>%% Returns a list of all keys in table</i>
<a name="775"/>  775: 
<a name="all_nexts-1"/><a name="776"/>  776: <b>all_nexts</b>(Tab) -&gt;
<a name="777"/>  777:     FirstKey = mnesia:dirty_first(Tab), 
<a name="all_nexts-last_expr"/><a name="778"/>  778: <b>    all_nexts</b>(Tab, FirstKey).
<a name="779"/>  779: 
<a name="all_nexts-2"/><a name="780"/>  780: <b>all_nexts</b>(_Tab, '$end_of_table') -&gt;
<a name="781"/>  781:     [];
<a name="782"/>  782: <b>all_nexts</b>(Tab, PrevKey) -&gt;
<a name="783"/>  783:     Key = mnesia:dirty_next(Tab, PrevKey), 
<a name="all_nexts-last_expr"/><a name="784"/>  784: <b>    [PrevKey] ++ all_nexts</b>(Tab, Key).
<a name="785"/>  785: 
<a name="786"/>  786: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="787"/>  787: 
<a name="update_trans-3"/><a name="788"/>  788: <b>update_trans</b>(Tab, Key, Acc) -&gt;
<a name="789"/>  789:     Update = 
<a name="790"/>  790: 	fun() -&gt; 
<a name="791"/>  791: 		Res = (catch mnesia:read({Tab, Key})),
<a name="792"/>  792: 		case Res of 
<a name="793"/>  793: 		    [{Tab, Key, Extra, Acc}] -&gt;
<a name="794"/>  794:                         Meta = {mnesia:table_info(Tab, where_to_commit),
<a name="795"/>  795:                                 mnesia:table_info(Tab, commit_work)},
<a name="796"/>  796: 			mnesia:write({Tab, Key, [Meta|Extra], Acc+1});
<a name="797"/>  797: 		    Val -&gt;
<a name="798"/>  798: 			{read, Val, {acc, Acc}}
<a name="799"/>  799: 		end
<a name="800"/>  800: 	end,
<a name="update_trans-last_expr"/><a name="801"/>  801:     receive 
<a name="802"/>  802: 	{Pid, quit} -&gt; Pid ! {self(), Acc}
<a name="803"/>  803:     after
<a name="804"/>  804: 	3 -&gt; 
<a name="805"/>  805: 	    case catch mnesia:sync_dirty(Update) of
<a name="806"/>  806: 		ok -&gt; 	    
<a name="807"/>  807: 		    update_trans(Tab, Key, Acc+1);
<a name="808"/>  808: 		Else -&gt; 
<a name="809"/>  809: 		    ?error(&quot;Dirty Operation failed on ~p (update no ~p) with ~p~n&quot;
<a name="810"/>  810: 			   &quot;Info w2read ~p w2write ~p w2commit ~p storage ~p ~n&quot;, 
<a name="811"/>  811: 			   [node(), 
<a name="812"/>  812: 			    Acc,
<a name="813"/>  813: 			    Else,
<a name="814"/>  814: 			    mnesia:table_info(Tab, where_to_read),
<a name="815"/>  815: 			    mnesia:table_info(Tab, where_to_write),
<a name="816"/>  816: 			    mnesia:table_info(Tab, where_to_commit),
<a name="817"/>  817: 			    mnesia:table_info(Tab, storage_type)])
<a name="818"/>  818: 	    end
<a name="819"/>  819:     end.
<a name="820"/>  820: 
<a name="del_table_copy_1-1"/><a name="821"/>  821: <b>del_table_copy_1</b>(suite) -&gt; [];
<a name="822"/>  822: <b>del_table_copy_1</b>(Config) when is_list(Config) -&gt;
<a name="823"/>  823:     [_Node1, Node2, _Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="del_table_copy_1-last_expr"/><a name="824"/>  824: <b>    del_table</b>(Node2, Node2, Nodes). %Called on same Node as deleted
<a name="del_table_copy_2-1"/><a name="825"/>  825: <b>del_table_copy_2</b>(suite) -&gt; [];
<a name="826"/>  826: <b>del_table_copy_2</b>(Config) when is_list(Config) -&gt;
<a name="827"/>  827:     [Node1, Node2, _Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="del_table_copy_2-last_expr"/><a name="828"/>  828: <b>    del_table</b>(Node1, Node2, Nodes). %Called from other Node 
<a name="del_table_copy_3-1"/><a name="829"/>  829: <b>del_table_copy_3</b>(suite) -&gt; [];
<a name="830"/>  830: <b>del_table_copy_3</b>(Config) when is_list(Config) -&gt;
<a name="831"/>  831:     [_Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="del_table_copy_3-last_expr"/><a name="832"/>  832: <b>    del_table</b>(Node3, Node2, Nodes). %Called from Node w.o. table
<a name="833"/>  833: 
<a name="del_table-3"/><a name="834"/>  834: <b>del_table</b>(CallFrom, DelNode, [Node1, Node2, Node3]) -&gt;
<a name="835"/>  835:     Tab = schema_ops,
<a name="836"/>  836:     Def = [{disc_only_copies, [Node1]}, {ram_copies, [Node2]}, 
<a name="837"/>  837: 	   {attributes, [key, attr1, attr2]}],
<a name="838"/>  838:     ?log(&quot;Test case removing table from ~w, with ~w~n&quot;, [DelNode, Def]),
<a name="839"/>  839:     ?match({atomic, ok}, mnesia:create_table(Tab, Def)),
<a name="840"/>  840:     insert(Tab, 1000),
<a name="841"/>  841:     
<a name="842"/>  842:     Pid1 = spawn_link(Node1, ?MODULE, update_trans, [Tab, 1, 0]),
<a name="843"/>  843:     Pid2 = spawn_link(Node2, ?MODULE, update_trans, [Tab, 2, 0]),
<a name="844"/>  844:     Pid3 = spawn_link(Node3, ?MODULE, update_trans, [Tab, 3, 0]),
<a name="845"/>  845: 
<a name="846"/>  846: 
<a name="847"/>  847:     %% dbg:tracer(process, {fun(Msg,_) -&gt; tracer(Msg) end, void}),
<a name="848"/>  848:     %%    dbg:n(Node2),
<a name="849"/>  849:     %%    dbg:n(Node3),
<a name="850"/>  850:     %% dbg:tp('_', []),     
<a name="851"/>  851:     %% dbg:tpl(dets, [timestamp]), 
<a name="852"/>  852:     %% dbg:p(Pid1, [m,c,timestamp]),  
<a name="853"/>  853:     
<a name="854"/>  854:     ?match({atomic, ok}, 
<a name="855"/>  855: 	   rpc:call(CallFrom, mnesia, del_table_copy, [Tab, DelNode])),
<a name="856"/>  856: 
<a name="857"/>  857:     Pid1 ! {self(), quit}, R1 = 
<a name="858"/>  858: 	receive {Pid1, Res1} -&gt; Res1
<a name="859"/>  859: 	after 
<a name="860"/>  860: 	    5000 -&gt; io:format(&quot;~p~n&quot;,[process_info(Pid1)]),error 
<a name="861"/>  861: 	end,
<a name="862"/>  862:     Pid2 ! {self(), quit}, R2 = 
<a name="863"/>  863: 	receive {Pid2, Res2} -&gt; Res2 
<a name="864"/>  864: 	after 
<a name="865"/>  865: 	    5000 -&gt; error 
<a name="866"/>  866: 	end,
<a name="867"/>  867:     Pid3 ! {self(), quit}, R3 = 
<a name="868"/>  868: 	receive {Pid3, Res3} -&gt; Res3 
<a name="869"/>  869: 	after 
<a name="870"/>  870: 	    5000 -&gt; error 
<a name="871"/>  871: 	end,
<a name="872"/>  872:     verify_oids(Tab, Node1, Node2, Node3, R1, R2, R3),
<a name="del_table-last_expr"/><a name="873"/>  873: <b>    ?verify_mnesia</b>([Node1, Node2, Node3], []).
<a name="874"/>  874:     
<a name="875"/>  875: 
<a name="add_table_copy_1-1"/><a name="876"/>  876: <b>add_table_copy_1</b>(suite) -&gt; [];
<a name="877"/>  877: <b>add_table_copy_1</b>(Config) when is_list(Config) -&gt;
<a name="878"/>  878:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="879"/>  879:     Def = [{ram_copies, [Node1, Node2]}, 
<a name="880"/>  880: 	   {attributes, [key, attr1, attr2]}], 
<a name="add_table_copy_1-last_expr"/><a name="881"/>  881: <b>    add_table</b>(Node1, Node3, Nodes, Def).
<a name="882"/>  882: <i>%% Not so much diff from 1 but I got a feeling of a bug</i>
<a name="883"/>  883: <i>%% should behave exactly the same but just checking the internal ordering </i>
<a name="add_table_copy_2-1"/><a name="884"/>  884: <b>add_table_copy_2</b>(suite) -&gt; [];
<a name="885"/>  885: <b>add_table_copy_2</b>(Config) when is_list(Config) -&gt;
<a name="886"/>  886:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="887"/>  887:     Def = [{ram_copies, [Node1, Node2]}, 
<a name="888"/>  888: 	   {attributes, [key, attr1, attr2]}], 
<a name="add_table_copy_2-last_expr"/><a name="889"/>  889: <b>    add_table</b>(Node2, Node3, Nodes, Def).
<a name="add_table_copy_3-1"/><a name="890"/>  890: <b>add_table_copy_3</b>(suite) -&gt; [];
<a name="891"/>  891: <b>add_table_copy_3</b>(Config) when is_list(Config) -&gt;
<a name="892"/>  892:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="893"/>  893:     Def = [{ram_copies, [Node1, Node2]},
<a name="894"/>  894: 	   {attributes, [key, attr1, attr2]}], 
<a name="add_table_copy_3-last_expr"/><a name="895"/>  895: <b>    add_table</b>(Node3, Node3, Nodes, Def).
<a name="add_table_copy_4-1"/><a name="896"/>  896: <b>add_table_copy_4</b>(suite) -&gt; [];
<a name="897"/>  897: <b>add_table_copy_4</b>(Config) when is_list(Config) -&gt;
<a name="898"/>  898:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="899"/>  899:     Def = [{disc_only_copies, [Node1]}, 
<a name="900"/>  900: 	   {attributes, [key, attr1, attr2]}], 
<a name="add_table_copy_4-last_expr"/><a name="901"/>  901: <b>    add_table</b>(Node2, Node3, Nodes, Def).
<a name="902"/>  902: 
<a name="add_table-4"/><a name="903"/>  903: <b>add_table</b>(CallFrom, AddNode, [Node1, Node2, Node3], Def) -&gt;
<a name="904"/>  904:     ?log(&quot;Test case adding table at ~w, with ~w~n&quot;, [AddNode, Def]),
<a name="905"/>  905:     Tab = schema_ops,
<a name="906"/>  906:     ?match({atomic, ok}, mnesia:create_table(Tab, Def)),
<a name="907"/>  907:     insert(Tab, 1002),
<a name="908"/>  908:     
<a name="909"/>  909:     Pid1 = spawn_link(Node1, ?MODULE, update_trans, [Tab, 1, 0]),
<a name="910"/>  910:     Pid2 = spawn_link(Node2, ?MODULE, update_trans, [Tab, 2, 0]),
<a name="911"/>  911:     Pid3 = spawn_link(Node3, ?MODULE, update_trans, [Tab, 3, 0]),
<a name="912"/>  912:     
<a name="913"/>  913:     ?match({atomic, ok}, rpc:call(CallFrom, mnesia, add_table_copy, 
<a name="914"/>  914: 				  [Tab, AddNode, ram_copies])),
<a name="915"/>  915:     Pid1 ! {self(), quit}, R1 = receive {Pid1, Res1} -&gt; Res1 after 5000 -&gt; error end,
<a name="916"/>  916:     Pid2 ! {self(), quit}, R2 = receive {Pid2, Res2} -&gt; Res2 after 5000 -&gt; error end,
<a name="917"/>  917:     Pid3 ! {self(), quit}, R3 = receive {Pid3, Res3} -&gt; Res3 after 5000 -&gt; error end,
<a name="918"/>  918:     verify_oids(Tab, Node1, Node2, Node3, R1, R2, R3),
<a name="add_table-last_expr"/><a name="919"/>  919: <b>    ?verify_mnesia</b>([Node1, Node2, Node3], []).
<a name="920"/>  920: 
<a name="921"/>  921: 
<a name="tracer-1"/><a name="922"/>  922: <b>tracer</b>({trace_ts, From, send, Msg, To, {_,S,Ms}}) -&gt;
<a name="923"/>  923:     io:format(&quot;~p:~p ~p(~p) &gt;&gt;~p ~w ~n&quot;,[S,Ms,From,node(From),To,Msg]);
<a name="924"/>  924: <b>tracer</b>({trace_ts, Pid, 'receive', Msg, {_,S,Ms}}) -&gt;
<a name="925"/>  925:     io:format(&quot;~p:~p ~p(~p) &lt;&lt; ~w ~n&quot;,[S,Ms,Pid,node(Pid),Msg]);
<a name="926"/>  926: 
<a name="927"/>  927: <b>tracer</b>({trace_ts, Pid, call, MFA, ST, {_,S,Ms}}) -&gt;
<a name="928"/>  928:     io:format(&quot;~p:~p ~p(~p) ~w ~w ~n&quot;,[S,Ms,Pid,node(Pid),MFA, ST]);
<a name="929"/>  929: <b>tracer</b>({trace_ts, Pid, return_from, MFA, Ret, {_,S,Ms}}) -&gt;
<a name="930"/>  930:     io:format(&quot;~p:~p ~p(~p) ~w =&gt; ~w ~n&quot;,[S,Ms,Pid,node(Pid),MFA,Ret]);
<a name="931"/>  931: 
<a name="932"/>  932: <b>tracer</b>(Msg) -&gt;
<a name="933"/>  933:     io:format(&quot;UMsg ~p ~n&quot;,[Msg]),
<a name="tracer-last_expr"/><a name="934"/>  934:     ok.
<a name="935"/>  935: 
<a name="936"/>  936: 
<a name="move_table_copy_1-1"/><a name="937"/>  937: <b>move_table_copy_1</b>(suite) -&gt; [];
<a name="938"/>  938: <b>move_table_copy_1</b>(Config) when is_list(Config) -&gt;
<a name="939"/>  939:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="940"/>  940:     Def = [{ram_copies, [Node1, Node2]},
<a name="941"/>  941: 	   {attributes, [key, attr1, attr2]}], 
<a name="move_table_copy_1-last_expr"/><a name="942"/>  942: <b>    move_table</b>(Node1, Node1, Node3, Nodes, Def).
<a name="move_table_copy_2-1"/><a name="943"/>  943: <b>move_table_copy_2</b>(suite) -&gt; [];
<a name="944"/>  944: <b>move_table_copy_2</b>(Config) when is_list(Config) -&gt;
<a name="945"/>  945:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="946"/>  946:     Def = [{ram_copies, [Node1, Node2]},
<a name="947"/>  947: 	   {attributes, [key, attr1, attr2]}], 
<a name="move_table_copy_2-last_expr"/><a name="948"/>  948: <b>    move_table</b>(Node2, Node1, Node3, Nodes, Def).
<a name="move_table_copy_3-1"/><a name="949"/>  949: <b>move_table_copy_3</b>(suite) -&gt; [];
<a name="950"/>  950: <b>move_table_copy_3</b>(Config) when is_list(Config) -&gt;
<a name="951"/>  951:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="952"/>  952:     Def = [{ram_copies, [Node1, Node2]},
<a name="953"/>  953: 	   {attributes, [key, attr1, attr2]}], 
<a name="move_table_copy_3-last_expr"/><a name="954"/>  954: <b>    move_table</b>(Node3, Node1, Node3, Nodes, Def).
<a name="move_table_copy_4-1"/><a name="955"/>  955: <b>move_table_copy_4</b>(suite) -&gt; [];
<a name="956"/>  956: <b>move_table_copy_4</b>(Config) when is_list(Config) -&gt;
<a name="957"/>  957:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="958"/>  958:     Def = [{ram_copies, [Node1]},
<a name="959"/>  959: 	   {attributes, [key, attr1, attr2]}], 
<a name="move_table_copy_4-last_expr"/><a name="960"/>  960: <b>    move_table</b>(Node2, Node1, Node3, Nodes, Def).
<a name="961"/>  961: 
<a name="move_table-5"/><a name="962"/>  962: <b>move_table</b>(CallFrom, FromNode, ToNode, [Node1, Node2, Node3], Def) -&gt;
<a name="963"/>  963:     ?log(&quot;Test case move table from ~w to ~w, with ~w~n&quot;, [FromNode, ToNode, Def]),
<a name="964"/>  964:     Tab = schema_ops,
<a name="965"/>  965:     ?match({atomic, ok}, mnesia:create_table(Tab, Def)),
<a name="966"/>  966:     insert(Tab, 1002),
<a name="967"/>  967:     
<a name="968"/>  968:     Pid1 = spawn_link(Node1, ?MODULE, update_trans, [Tab, 1, 0]),
<a name="969"/>  969:     Pid2 = spawn_link(Node2, ?MODULE, update_trans, [Tab, 2, 0]),
<a name="970"/>  970:     Pid3 = spawn_link(Node3, ?MODULE, update_trans, [Tab, 3, 0]),
<a name="971"/>  971:     
<a name="972"/>  972:     ?match({atomic, ok}, rpc:call(CallFrom, mnesia, move_table_copy, 
<a name="973"/>  973: 				  [Tab, FromNode, ToNode])),
<a name="974"/>  974:     Pid1 ! {self(), quit}, 
<a name="975"/>  975:     R1 = receive {Pid1, Res1} -&gt; Res1 after 5000 -&gt; ?error(&quot;timeout pid1~n&quot;, []) end,
<a name="976"/>  976:     Pid2 ! {self(), quit}, 
<a name="977"/>  977:     R2 = receive {Pid2, Res2} -&gt; Res2 after 5000 -&gt; ?error(&quot;timeout pid2~n&quot;, []) end,
<a name="978"/>  978:     Pid3 ! {self(), quit}, 
<a name="979"/>  979:     R3 = receive {Pid3, Res3} -&gt; Res3 after 5000 -&gt; ?error(&quot;timeout pid3~n&quot;, []) end,
<a name="980"/>  980:     verify_oids(Tab, Node1, Node2, Node3, R1, R2, R3),
<a name="move_table-last_expr"/><a name="981"/>  981: <b>    ?verify_mnesia</b>([Node1, Node2, Node3], []).
<a name="982"/>  982: 
<a name="983"/>  983: <i>% Verify consistency between different nodes</i>
<a name="984"/>  984: <i>% Due to limitations in the current dirty_ops this can wrong from time to time!</i>
<a name="verify_oids-7"/><a name="985"/>  985: <b>verify_oids</b>(Tab, N1, N2, N3, R1, R2, R3) -&gt;
<a name="986"/>  986:     io:format(&quot;DEBUG 1=&gt;~p 2=&gt;~p 3=&gt;~p~n&quot;, [R1,R2,R3]),
<a name="987"/>  987:     {info,_,_} = rpc:call(N1, mnesia_tm, get_info, [2000]),
<a name="988"/>  988:     {info,_,_} = rpc:call(N2, mnesia_tm, get_info, [2000]),
<a name="989"/>  989:     {info,_,_} = rpc:call(N3, mnesia_tm, get_info, [2000]),
<a name="990"/>  990: 
<a name="991"/>  991:     ?match([{_, _, _, R1}], rpc:call(N1, mnesia, dirty_read, [{Tab, 1}])),
<a name="992"/>  992:     ?match([{_, _, _, R1}], rpc:call(N2, mnesia, dirty_read, [{Tab, 1}])),
<a name="993"/>  993:     ?match([{_, _, _, R1}], rpc:call(N3, mnesia, dirty_read, [{Tab, 1}])),
<a name="994"/>  994:     ?match([{_, _, _, R2}], rpc:call(N1, mnesia, dirty_read, [{Tab, 2}])),
<a name="995"/>  995:     ?match([{_, _, _, R2}], rpc:call(N2, mnesia, dirty_read, [{Tab, 2}])),
<a name="996"/>  996:     ?match([{_, _, _, R2}], rpc:call(N3, mnesia, dirty_read, [{Tab, 2}])),
<a name="997"/>  997:     ?match([{_, _, _, R3}], rpc:call(N1, mnesia, dirty_read, [{Tab, 3}])),
<a name="998"/>  998:     ?match([{_, _, _, R3}], rpc:call(N2, mnesia, dirty_read, [{Tab, 3}])),
<a name="verify_oids-last_expr"/><a name="999"/>  999: <b>    ?match</b>([{_, _, _, R3}], rpc:call(N3, mnesia, dirty_read, [{Tab, 3}])).
<a name="1000"/> 1000: 
<a name="insert-2"/><a name="1001"/> 1001: <b>insert</b>(_Tab, 0) -&gt; ok;
<a name="1002"/> 1002: <b>insert</b>(Tab, N) when N &gt; 0 -&gt;
<a name="1003"/> 1003:     ok = mnesia:sync_dirty(fun() -&gt; false = mnesia:is_transaction(), mnesia:write({Tab, N, [], 0}) end),
<a name="insert-last_expr"/><a name="1004"/> 1004: <b>    insert</b>(Tab, N-1).
<a name="1005"/> 1005: 
<a name="1006"/> 1006: 
<a name="1007"/> 1007: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
