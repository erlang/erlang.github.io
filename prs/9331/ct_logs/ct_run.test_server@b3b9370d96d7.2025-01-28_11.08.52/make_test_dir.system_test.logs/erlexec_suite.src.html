<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/make_test_dir/system_test/erlexec_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2007-2022. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%%-------------------------------------------------------------------</i>
<a name="22"/>   22: <i>%%% File    : erlexec_SUITE.erl</i>
<a name="23"/>   23: <i>%%% Author  : Rickard Green &lt;rickard.s.green@ericsson.com&gt;</i>
<a name="24"/>   24: <i>%%% Description : Test erlexec's command line parsing</i>
<a name="25"/>   25: <i>%%%</i>
<a name="26"/>   26: <i>%%% Created : 22 May 2007 by Rickard Green &lt;rickard.s.green@ericsson.com&gt;</i>
<a name="27"/>   27: <i>%%%-------------------------------------------------------------------</i>
<a name="28"/>   28: <b>-module</b>(erlexec_SUITE).
<a name="29"/>   29: 
<a name="30"/>   30: <b>-export</b>([all/0, suite/0, init_per_suite/1, end_per_suite/1,
<a name="31"/>   31:          init_per_testcase/2, end_per_testcase/2]).
<a name="32"/>   32: 
<a name="33"/>   33: <b>-export</b>([args_file/1, evil_args_file/1, missing_args_file/1, env/1, args_file_env/1,
<a name="34"/>   34:          otp_7461/1, otp_7461_remote/1, argument_separation/1, argument_with_option/1,
<a name="35"/>   35:          zdbbl_dist_buf_busy_limit/1, long_path_env/1, long_path_env_when_rootdir_not_present/1]).
<a name="36"/>   36: 
<a name="37"/>   37: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="38"/>   38: <b>-include_lib</b>(&quot;eunit/include/eunit.hrl&quot;).
<a name="39"/>   39: 
<a name="suite-0"/><a name="40"/>   40: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="41"/>   41:     [{ct_hooks,[ts_install_cth]},
<a name="42"/>   42:      {timetrap, {minutes, 1}}].
<a name="43"/>   43: 
<a name="all-0"/><a name="44"/>   44: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="45"/>   45:     [args_file, evil_args_file, missing_args_file, env, args_file_env,
<a name="46"/>   46:      otp_7461, argument_separation, argument_with_option, zdbbl_dist_buf_busy_limit,
<a name="47"/>   47:      long_path_env, long_path_env_when_rootdir_not_present].
<a name="48"/>   48: 
<a name="init_per_suite-1"/><a name="49"/>   49: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="50"/>   50: <b>    [{suite_erl_flags, save_env</b>()} | Config].
<a name="51"/>   51: 
<a name="end_per_suite-1"/><a name="52"/>   52: <b>end_per_suite</b>(Config) -&gt;
<a name="53"/>   53:     SavedEnv = proplists:get_value(suite_erl_flags, Config),
<a name="end_per_suite-last_expr"/><a name="54"/>   54: <b>    restore_env</b>(SavedEnv).
<a name="55"/>   55: 
<a name="init_per_testcase-2"/><a name="56"/>   56: <b>init_per_testcase</b>(Case, Config) -&gt;
<a name="57"/>   57:     SavedEnv = save_env(),
<a name="init_per_testcase-last_expr"/><a name="58"/>   58:     [{testcase, Case},{erl_flags_env, SavedEnv}|Config].
<a name="59"/>   59: 
<a name="end_per_testcase-2"/><a name="60"/>   60: <b>end_per_testcase</b>(_Case, Config) -&gt;
<a name="61"/>   61:     SavedEnv = proplists:get_value(erl_flags_env, Config),
<a name="62"/>   62:     restore_env(SavedEnv),
<a name="63"/>   63:     cleanup_nodes(),
<a name="end_per_testcase-last_expr"/><a name="64"/>   64:     ok.
<a name="65"/>   65: 
<a name="66"/>   66: <i>%% Test that plain first argument does not</i>
<a name="67"/>   67: <i>%% destroy -home switch [OTP-8209] or interact with environments</i>
<a name="argument_separation-1"/><a name="68"/>   68: <b>argument_separation</b>(Config) when is_list(Config) -&gt;
<a name="69"/>   69:     {ok,[[FullPName]]} = init:get_argument(progname),
<a name="70"/>   70:      %% progname can be either &quot;erl&quot; or &quot;cerl -asan&quot;, so we remove anything after the first space.
<a name="71"/>   71:      %% This will break if tests are run with an erlang that has a space in the path...
<a name="72"/>   72:     [PName | _ ] = string:lexemes(FullPName,&quot; &quot;),
<a name="73"/>   73:     SNameS = &quot;erlexec_test_01&quot;,
<a name="74"/>   74:     SName = list_to_atom(SNameS++&quot;@&quot;++
<a name="75"/>   75: 			 hd(tl(string:lexemes(atom_to_list(node()),&quot;@&quot;)))),
<a name="76"/>   76:     Cmd = PName ++ &quot; cmd_param -sname &quot;++SNameS++&quot; -setcookie &quot;++
<a name="77"/>   77: 	atom_to_list(erlang:get_cookie()) ++ &quot; -cmd_test&quot;,
<a name="78"/>   78:     open_port({spawn,Cmd},[{env,[{&quot;ERL_AFLAGS&quot;,&quot;-atest&quot;},
<a name="79"/>   79:                                  {&quot;ERL_FLAGS&quot;,&quot;env_param -test&quot;},
<a name="80"/>   80:                                  {&quot;ERL_ZFLAGS&quot;,&quot;zenv_param&quot;}]}]),
<a name="81"/>   81:     pong = loop_ping(SName,40),
<a name="82"/>   82:     ct:log(&quot;emu_args: ~p&quot;,[rpc:call(SName,erlang,system_info,[emu_args])]),
<a name="83"/>   83:     {ok,[[_]]} = rpc:call(SName,init,get_argument,[home]),
<a name="84"/>   84:     {ok,[[]]} = rpc:call(SName,init,get_argument,[atest]),
<a name="85"/>   85:     {ok,[[]]} = rpc:call(SName,init,get_argument,[cmd_test]),
<a name="86"/>   86:     {ok,[[]]} = rpc:call(SName,init,get_argument,[test]),
<a name="87"/>   87:     error = rpc:call(SName,init,get_argument,[unknown]),
<a name="88"/>   88:     [&quot;cmd_param&quot;,&quot;env_param&quot;,&quot;zenv_param&quot;] = rpc:call(SName,init,get_plain_arguments,[]),
<a name="89"/>   89:     ok = cleanup_nodes(),
<a name="argument_separation-last_expr"/><a name="90"/>   90:     ok.
<a name="91"/>   91: 
<a name="cleanup_nodes-0"/><a name="92"/>   92: <b>cleanup_nodes</b>() -&gt;
<a name="cleanup_nodes-last_expr"/><a name="93"/>   93: <b>    cleanup_node</b>(&quot;erlexec_test_01&quot;,20).
<a name="cleanup_node-2"/><a name="94"/>   94: <b>cleanup_node</b>(SNameS,0) -&gt;
<a name="95"/>   95:     {error, {would_not_die,list_to_atom(SNameS)}};
<a name="96"/>   96: <b>cleanup_node</b>(SNameS,N) -&gt;
<a name="97"/>   97:     SName = list_to_atom(SNameS++&quot;@&quot;++
<a name="98"/>   98: 			 hd(tl(string:lexemes(atom_to_list(node()),&quot;@&quot;)))),
<a name="cleanup_node-last_expr"/><a name="99"/>   99: <b>    case rpc:call</b>(SName,init,stop,[]) of
<a name="100"/>  100: 	{badrpc,_} -&gt;
<a name="101"/>  101: 	    ok;
<a name="102"/>  102: 	ok -&gt;
<a name="103"/>  103: 	    receive after 500 -&gt; ok end,
<a name="104"/>  104: 	    cleanup_node(SNameS,N-1)
<a name="105"/>  105:     end.
<a name="106"/>  106: 
<a name="loop_ping-2"/><a name="107"/>  107: <b>loop_ping</b>(_,0) -&gt;
<a name="108"/>  108:     flush(),
<a name="109"/>  109:     pang;
<a name="110"/>  110: <b>loop_ping</b>(Node,N) -&gt;
<a name="loop_ping-last_expr"/><a name="111"/>  111: <b>    case net_adm:ping</b>(Node) of
<a name="112"/>  112: 	pang -&gt;
<a name="113"/>  113: 	    receive
<a name="114"/>  114: 	    after 500 -&gt;
<a name="115"/>  115: 		    ok
<a name="116"/>  116: 	    end,
<a name="117"/>  117: 	    loop_ping(Node, N-1);
<a name="118"/>  118: 	pong -&gt;
<a name="119"/>  119: 	    pong
<a name="120"/>  120:     end.
<a name="121"/>  121: 
<a name="flush-0"/><a name="122"/>  122: <b>flush</b>() -&gt;
<a name="flush-last_expr"/><a name="123"/>  123:     receive M -&gt;
<a name="124"/>  124:             ct:pal(&quot;~p&quot;,[M]),
<a name="125"/>  125:             flush()
<a name="126"/>  126:     after 10 -&gt;
<a name="127"/>  127:             ok
<a name="128"/>  128:     end.
<a name="129"/>  129: 
<a name="130"/>  130: <i>%% Test that giving an invalid argument to an option that needs</i>
<a name="131"/>  131: <i>%% an argument will always fail.</i>
<a name="argument_with_option-1"/><a name="132"/>  132: <b>argument_with_option</b>(Config) when is_list(Config) -&gt;
<a name="133"/>  133:     ErlSingle = [&quot;emu_flavor&quot;, &quot;emu_type&quot;, &quot;configfd&quot;, &quot;epmd&quot;,
<a name="134"/>  134:                  &quot;name&quot;, &quot;sname&quot;, &quot;start_epmd&quot;] ++
<a name="135"/>  135:         case os:type() of
<a name="136"/>  136:             {win32,_} -&gt; [&quot;boot&quot;,&quot;config&quot;,&quot;service_event&quot;];
<a name="137"/>  137:             _ -&gt; []
<a name="138"/>  138:         end,
<a name="139"/>  139: 
<a name="140"/>  140:     MissingCheck =
<a name="141"/>  141:         fun(CmdLine, Prefix, Postfix) -&gt;
<a name="142"/>  142:                 InvalidArg = emu_args(&quot;-s init stop &quot; ++ Prefix ++ CmdLine ++ Postfix,
<a name="143"/>  143:                                       [return_output]),
<a name="144"/>  144:                 case re:run(InvalidArg, &quot;Missing argument\\(s\\) for '\\&quot; ++ Prefix ++ CmdLine ++ &quot;'.&quot;) of
<a name="145"/>  145:                     nomatch -&gt;
<a name="146"/>  146:                         ct:log(&quot;Output: ~ts&quot;,[InvalidArg]),
<a name="147"/>  147:                         ct:fail(&quot;Failed to fail on ~ts&quot;,[Prefix ++ CmdLine ++ Postfix]);
<a name="148"/>  148:                     {match,_} -&gt;
<a name="149"/>  149:                         ok
<a name="150"/>  150:                 end
<a name="151"/>  151:         end,
<a name="152"/>  152: 
<a name="153"/>  153:     [begin
<a name="154"/>  154:          MissingCheck(CmdLine,&quot;-&quot;,&quot;&quot;),
<a name="155"/>  155: 
<a name="156"/>  156:          %% We test what happens when ERL_FLAGS is set
<a name="157"/>  157:          os:putenv(&quot;ERL_FLAGS&quot;,&quot;-test&quot;),
<a name="158"/>  158:          MissingCheck(CmdLine,&quot;-&quot;, &quot;&quot;),
<a name="159"/>  159:          os:unsetenv(&quot;ERL_FLAGS&quot;)
<a name="160"/>  160:      end || CmdLine &lt;- ErlSingle],
<a name="161"/>  161: 
<a name="162"/>  162:     EmuSingle = [&quot;a&quot;, &quot;A&quot;, &quot;C&quot;, &quot;e&quot;, &quot;i&quot;, &quot;n&quot;, &quot;P&quot;, &quot;Q&quot;, &quot;t&quot;,
<a name="163"/>  163:                  &quot;T&quot;, &quot;R&quot;, &quot;W&quot;, &quot;K&quot;, &quot;IOt&quot;, &quot;IOp&quot;, &quot;IOPt&quot;, &quot;IOPp&quot;,
<a name="164"/>  164:                  &quot;J&quot;, &quot;SP&quot;, &quot;SDcpu&quot;, &quot;SDPcpu&quot;, &quot;SDio&quot;,
<a name="165"/>  165:                  &quot;hms&quot;, &quot;rg&quot;, &quot;sbt&quot;, &quot;zdbbl&quot;],
<a name="166"/>  166: 
<a name="167"/>  167:     [begin
<a name="168"/>  168:          MissingCheck(CmdLine,&quot;+&quot;,&quot;&quot;),
<a name="169"/>  169: 
<a name="170"/>  170:          %% We test what happens when ERL_FLAGS is set
<a name="171"/>  171:          os:putenv(&quot;ERL_FLAGS&quot;,&quot;-test&quot;),
<a name="172"/>  172:          MissingCheck(CmdLine,&quot;+&quot;, &quot;&quot;),
<a name="173"/>  173:          os:unsetenv(&quot;ERL_FLAGS&quot;)
<a name="174"/>  174:      end || CmdLine &lt;- EmuSingle],
<a name="175"/>  175: 
<a name="176"/>  176:     ErlDouble = [&quot;env&quot;],
<a name="177"/>  177: 
<a name="178"/>  178:     [begin
<a name="179"/>  179:          MissingCheck(CmdLine,&quot;-&quot;,&quot;&quot;),
<a name="180"/>  180:          MissingCheck(CmdLine,&quot;-&quot;,&quot; a&quot;),
<a name="181"/>  181: 
<a name="182"/>  182:          %% We test what happens when ERL_FLAGS is set
<a name="183"/>  183:          os:putenv(&quot;ERL_FLAGS&quot;,&quot;-test&quot;),
<a name="184"/>  184:          MissingCheck(CmdLine,&quot;-&quot;, &quot;&quot;),
<a name="185"/>  185:          MissingCheck(CmdLine,&quot;-&quot;, &quot; a&quot;),
<a name="186"/>  186:          os:unsetenv(&quot;ERL_FLAGS&quot;)
<a name="187"/>  187:      end || CmdLine &lt;- ErlDouble],
<a name="argument_with_option-last_expr"/><a name="188"/>  188:     ok.
<a name="189"/>  189: 
<a name="args_file-1"/><a name="190"/>  190: <b>args_file</b>(Config) when is_list(Config) -&gt;
<a name="191"/>  191:     AFN1 = privfile(&quot;1&quot;, Config),
<a name="192"/>  192:     AFN2 = privfile(&quot;2&quot;, Config),
<a name="193"/>  193:     AFN3 = privfile(&quot;3&quot;, Config),
<a name="194"/>  194:     AFN4 = privfile(&quot;4&quot;, Config),
<a name="195"/>  195:     AFN5 = privfile(&quot;5&quot;, Config),
<a name="196"/>  196:     AFN6 = privfile(&quot;6&quot;, Config),
<a name="197"/>  197:     write_file(AFN1, &quot;-MiscArg2~n&quot;
<a name="198"/>  198: 		     &quot;# a comment +\\#1000~n&quot;
<a name="199"/>  199: 		     &quot;+\\#200 # another comment~n&quot;
<a name="200"/>  200: 		     &quot;~n&quot;
<a name="201"/>  201: 		     &quot;# another config file to read~n&quot;
<a name="202"/>  202: 		     &quot; -args_file ~s#acomment~n&quot;
<a name="203"/>  203: 		     &quot;~n&quot;
<a name="204"/>  204: 		     &quot;-MiscArg7~n&quot;
<a name="205"/>  205: 		     &quot;-MiscArg8 'val  with  double   space'~n&quot;
<a name="206"/>  206: 		     &quot;-MiscArg9 '~n'~n&quot;
<a name="207"/>  207: 		     &quot;-MiscArg10 \\~n\\\t~n&quot;
<a name="208"/>  208: 		     &quot;#~n&quot;
<a name="209"/>  209: 		     &quot;+\\#700~n&quot;
<a name="210"/>  210:                      &quot;#~s~n&quot;
<a name="211"/>  211: 		     &quot;-extra +XtraArg6~n&quot;,
<a name="212"/>  212: 	       [AFN2,lists:duplicate(1024*1024, $a)]),
<a name="213"/>  213:     write_file(AFN2,
<a name="214"/>  214: 		     &quot;-MiscArg3 \t\v\f\r\n   ~n&quot;
<a name="215"/>  215: 		     &quot;+\\#300~n&quot;
<a name="216"/>  216: 		     &quot;-args_file ~s~n&quot;
<a name="217"/>  217: 		     &quot;-MiscArg5 ' '~n&quot;
<a name="218"/>  218: 		     &quot;+\\#500#anothercomment -MiscArg11~n&quot;
<a name="219"/>  219: 		     &quot;-args_file ~s~n&quot;
<a name="220"/>  220: 		     &quot;-args_file ~s~n&quot;
<a name="221"/>  221: 		     &quot;-args_file ~s~n&quot;
<a name="222"/>  222:                      &quot;# ~s~n&quot;
<a name="223"/>  223: 		     &quot;-extra +XtraArg5~n&quot;,
<a name="224"/>  224: 		     [AFN3, AFN4, AFN5, AFN6,lists:duplicate(1758, $a)]),
<a name="225"/>  225:     write_file(AFN3,
<a name="226"/>  226: 		     &quot;# comment again~n&quot;
<a name="227"/>  227: 		     &quot; -MiscArg4 +\\#400 -extra +XtraArg1&quot;),
<a name="228"/>  228:     write_file(AFN4,
<a name="229"/>  229: 		     &quot; -MiscArg6 +\\#600 -extra +XtraArg2~n&quot;
<a name="230"/>  230: 		     &quot;+XtraArg3~n&quot;
<a name="231"/>  231: 		     &quot;+XtraArg4~n&quot;
<a name="232"/>  232: 		     &quot;# comment again~n&quot;),
<a name="233"/>  233:     write_file(AFN5, &quot;&quot;),
<a name="234"/>  234:     write_file(AFN6, &quot;-extra # +XtraArg10~n&quot;),
<a name="235"/>  235:     CmdLine = &quot;+#100 -MiscArg1 &quot;
<a name="236"/>  236: 	++ &quot;-args_file &quot; ++ AFN1
<a name="237"/>  237: 	++ &quot; +#800 -MiscArgCLI \\\t -extra +XtraArg7 +XtraArg8&quot;,
<a name="238"/>  238:     {Emu, Misc, Extra} = emu_args(CmdLine),
<a name="239"/>  239:     verify_args([&quot;-#100&quot;, &quot;-#200&quot;, &quot;-#300&quot;, &quot;-#400&quot;,
<a name="240"/>  240: 		       &quot;-#500&quot;, &quot;-#600&quot;, &quot;-#700&quot;, &quot;-#800&quot;], Emu),
<a name="241"/>  241:     verify_args([&quot;-MiscArg1&quot;, &quot;-MiscArg2&quot;, &quot;-MiscArg3&quot;, &quot;-MiscArg4&quot;,
<a name="242"/>  242:                  &quot;-MiscArg5&quot;, &quot; &quot;, &quot;-MiscArg6&quot;, &quot;-MiscArg7&quot;, &quot;-MiscArg8&quot;,
<a name="243"/>  243:                  &quot;val  with  double   space&quot;,
<a name="244"/>  244:                  &quot;-MiscArg9&quot;,&quot;\n&quot;,&quot;-MiscArg10&quot;,&quot;\n\t&quot;,&quot;-MiscArgCLI&quot;],
<a name="245"/>  245: 		      Misc),
<a name="246"/>  246:     verify_args([&quot;+XtraArg1&quot;, &quot;+XtraArg2&quot;, &quot;+XtraArg3&quot;, &quot;+XtraArg4&quot;,
<a name="247"/>  247: 		       &quot;+XtraArg5&quot;, &quot;+XtraArg6&quot;, &quot;+XtraArg7&quot;, &quot;+XtraArg8&quot;],
<a name="248"/>  248: 		      Extra),
<a name="249"/>  249:     verify_not_args([&quot;&quot;,&quot;-MiscArg11&quot;, &quot;-#1000&quot;, &quot;+XtraArg10&quot;,
<a name="250"/>  250: 			   &quot;-MiscArg1&quot;, &quot;-MiscArg2&quot;, &quot;-MiscArg3&quot;, &quot;-MiscArg4&quot;,
<a name="251"/>  251: 			   &quot;-MiscArg5&quot;, &quot;-MiscArg6&quot;, &quot;-MiscArg7&quot;, &quot;-MiscArg8&quot;,
<a name="252"/>  252:                            &quot;-MiscArg9&quot;, &quot;-MiscArg10&quot;,&quot;-MiscArgCLI&quot;,
<a name="253"/>  253: 			   &quot;+XtraArg1&quot;, &quot;+XtraArg2&quot;, &quot;+XtraArg3&quot;, &quot;+XtraArg4&quot;,
<a name="254"/>  254: 			   &quot;+XtraArg5&quot;, &quot;+XtraArg6&quot;, &quot;+XtraArg7&quot;, &quot;+XtraArg8&quot;],
<a name="255"/>  255: 			  Emu),
<a name="256"/>  256:     verify_not_args([&quot;&quot;,&quot;-MiscArg11&quot;, &quot;-#1000&quot;, &quot;+XtraArg10&quot;,
<a name="257"/>  257: 			   &quot;-#100&quot;, &quot;-#200&quot;, &quot;-#300&quot;, &quot;-#400&quot;,
<a name="258"/>  258: 			   &quot;-#500&quot;, &quot;-#600&quot;, &quot;-#700&quot;, &quot;-#800&quot;,
<a name="259"/>  259: 			   &quot;+XtraArg1&quot;, &quot;+XtraArg2&quot;, &quot;+XtraArg3&quot;, &quot;+XtraArg4&quot;,
<a name="260"/>  260: 			   &quot;+XtraArg5&quot;, &quot;+XtraArg6&quot;, &quot;+XtraArg7&quot;, &quot;+XtraArg8&quot;],
<a name="261"/>  261: 			  Misc),
<a name="262"/>  262:     verify_not_args([&quot;&quot;,&quot;-MiscArg11&quot;, &quot;-#1000&quot;, &quot;+XtraArg10&quot;,
<a name="263"/>  263: 			   &quot;-#100&quot;, &quot;-#200&quot;, &quot;-#300&quot;, &quot;-#400&quot;,
<a name="264"/>  264: 			   &quot;-#500&quot;, &quot;-#600&quot;, &quot;-#700&quot;, &quot;-#800&quot;,
<a name="265"/>  265: 			   &quot;-MiscArg1&quot;, &quot;-MiscArg2&quot;, &quot;-MiscArg3&quot;, &quot;-MiscArg4&quot;,
<a name="266"/>  266: 			   &quot;-MiscArg5&quot;, &quot;-MiscArg6&quot;, &quot;-MiscArg7&quot;, &quot;-MiscArg8&quot;,
<a name="267"/>  267:                            &quot;-MiscArg9&quot;,&quot;-MiscArg10&quot;,&quot;-MiscArgCLI&quot;],
<a name="268"/>  268: 			  Extra),
<a name="args_file-last_expr"/><a name="269"/>  269:     ok.
<a name="270"/>  270: 
<a name="evil_args_file-1"/><a name="271"/>  271: <b>evil_args_file</b>(Config) when is_list(Config) -&gt;
<a name="272"/>  272:     Lim = 300,
<a name="273"/>  273:     FNums = lists:seq(1, Lim),
<a name="274"/>  274:     lists:foreach(fun (End) when End == Lim -&gt;
<a name="275"/>  275: 			  AFN = privfile(integer_to_list(End), Config),
<a name="276"/>  276: 			  write_file(AFN,
<a name="277"/>  277: 					   &quot;-MiscArg~p &quot;,
<a name="278"/>  278: 					   [End]);
<a name="279"/>  279: 		      (I) -&gt;
<a name="280"/>  280: 			  AFNX = privfile(integer_to_list(I), Config),
<a name="281"/>  281: 			  AFNY = privfile(integer_to_list(I+1), Config),
<a name="282"/>  282: 			  {Frmt, Args} =
<a name="283"/>  283: 			      case I rem 2 of
<a name="284"/>  284: 				  0 -&gt;
<a name="285"/>  285: 				      {&quot;-MiscArg~p -args_file ~s -MiscArg~p&quot;,
<a name="286"/>  286: 				       [I, AFNY, I]};
<a name="287"/>  287: 				  _ -&gt;
<a name="288"/>  288: 				      {&quot;-MiscArg~p -args_file ~s&quot;,
<a name="289"/>  289: 				       [I, AFNY]}
<a name="290"/>  290: 			      end,
<a name="291"/>  291: 			  write_file(AFNX, Frmt, Args)
<a name="292"/>  292: 		  end,
<a name="293"/>  293: 		  FNums),
<a name="294"/>  294:     {_Emu, Misc, _Extra} = emu_args(&quot;-args_file &quot;
<a name="295"/>  295: 					  ++ privfile(&quot;1&quot;, Config)),
<a name="296"/>  296:     ANums = FNums
<a name="297"/>  297: 	++ lists:reverse(lists:filter(fun (I) when I == Lim -&gt; false;
<a name="298"/>  298: 					  (I) when I rem 2 == 0 -&gt; true;
<a name="299"/>  299: 					  (_) -&gt; false
<a name="300"/>  300: 				      end, FNums)),
<a name="301"/>  301:     verify_args(lists:map(fun (I) -&gt; &quot;-MiscArg&quot;++integer_to_list(I) end,
<a name="302"/>  302: 				ANums),
<a name="303"/>  303: 		      Misc),
<a name="evil_args_file-last_expr"/><a name="304"/>  304:     ok.
<a name="305"/>  305: 
<a name="missing_args_file-1"/><a name="306"/>  306: <b>missing_args_file</b>(Config) when is_list(Config) -&gt;
<a name="307"/>  307:     % supply an unexisting args file as parameter
<a name="308"/>  308:     CmdLine = &quot;-args_file &quot;++ &quot;missing_vm_args_file&quot;,
<a name="309"/>  309:     % we're expecting a failure, capture the output
<a name="310"/>  310:     % and check for the correct error message
<a name="311"/>  311:     Output = emu_args(CmdLine, [return_output]),
<a name="312"/>  312:     % the output message format in case of failure can be consulted
<a name="313"/>  313:     % at read_args_file@erts/etc/common/erlexec.c
<a name="missing_args_file-last_expr"/><a name="314"/>  314: <b>    case re:run</b>(Output, &quot;Failed to open arguments file [^ ]+ at [^ ]+: No such file or directory.*&quot;) of
<a name="315"/>  315:         {match,[{0, MatchEnd}]} when MatchEnd &gt; 0 -&gt;
<a name="316"/>  316:             % a simple match on the regex is sufficient to decide
<a name="317"/>  317:             % that the output is properly formatted
<a name="318"/>  318:             ok;
<a name="319"/>  319:         Error -&gt;
<a name="320"/>  320:             exit({unexpected_args_output, Output, Error})
<a name="321"/>  321:     end.
<a name="322"/>  322: 
<a name="env-1"/><a name="323"/>  323: <b>env</b>(Config) when is_list(Config) -&gt;
<a name="324"/>  324:     os:putenv(&quot;ERL_AFLAGS&quot;, &quot;-MiscArg1 +#100 -extra +XtraArg1 +XtraArg2&quot;),
<a name="325"/>  325:     CmdLine = &quot;+#200 -MiscArg2 -extra +XtraArg3 +XtraArg4&quot;,
<a name="326"/>  326:     os:putenv(&quot;ERL_FLAGS&quot;, &quot;-MiscArg3 +#300 -extra +XtraArg5&quot;),
<a name="327"/>  327:     os:putenv(&quot;ERL_ZFLAGS&quot;, &quot;-MiscArg4 +#400 -extra +XtraArg6&quot;),
<a name="328"/>  328:     {Emu, Misc, Extra} = emu_args(CmdLine),
<a name="329"/>  329:     verify_args([&quot;-#100&quot;, &quot;-#200&quot;, &quot;-#300&quot;, &quot;-#400&quot;], Emu),
<a name="330"/>  330:     verify_args([&quot;-MiscArg1&quot;, &quot;-MiscArg2&quot;, &quot;-MiscArg3&quot;, &quot;-MiscArg4&quot;],
<a name="331"/>  331: 		      Misc),
<a name="332"/>  332:     verify_args([&quot;+XtraArg1&quot;, &quot;+XtraArg2&quot;, &quot;+XtraArg3&quot;, &quot;+XtraArg4&quot;,
<a name="333"/>  333: 		       &quot;+XtraArg5&quot;, &quot;+XtraArg6&quot;],
<a name="334"/>  334: 		      Extra),
<a name="env-last_expr"/><a name="335"/>  335:     ok.
<a name="336"/>  336: 
<a name="args_file_env-1"/><a name="337"/>  337: <b>args_file_env</b>(Config) when is_list(Config) -&gt;
<a name="338"/>  338:     AFN1 = privfile(&quot;1&quot;, Config),
<a name="339"/>  339:     AFN2 = privfile(&quot;2&quot;, Config),
<a name="340"/>  340:     write_file(AFN1, &quot;-MiscArg2 +\\#200 -extra +XtraArg1&quot;),
<a name="341"/>  341:     write_file(AFN2, &quot;-MiscArg3 +\\#400 -extra +XtraArg3&quot;),
<a name="342"/>  342:     os:putenv(&quot;ERL_AFLAGS&quot;,
<a name="343"/>  343: 		    &quot;-MiscArg1 +#100 -args_file &quot;++AFN1++ &quot; -extra +XtraArg2&quot;),
<a name="344"/>  344:     CmdLine = &quot;+#300 -args_file &quot;++AFN2++&quot; -MiscArg4 -extra +XtraArg4&quot;,
<a name="345"/>  345:     os:putenv(&quot;ERL_FLAGS&quot;, &quot;-MiscArg5 +#500 -extra +XtraArg5&quot;),
<a name="346"/>  346:     os:putenv(&quot;ERL_ZFLAGS&quot;, &quot;-MiscArg6 +#600 -extra +XtraArg6&quot;),
<a name="347"/>  347:     {Emu, Misc, Extra} = emu_args(CmdLine),
<a name="348"/>  348:     verify_args([&quot;-#100&quot;, &quot;-#200&quot;, &quot;-#300&quot;, &quot;-#400&quot;,
<a name="349"/>  349: 		       &quot;-#500&quot;, &quot;-#600&quot;], Emu),
<a name="350"/>  350:     verify_args([&quot;-MiscArg1&quot;, &quot;-MiscArg2&quot;, &quot;-MiscArg3&quot;, &quot;-MiscArg4&quot;,
<a name="351"/>  351: 		       &quot;-MiscArg5&quot;, &quot;-MiscArg6&quot;],
<a name="352"/>  352: 		      Misc),
<a name="353"/>  353:     verify_args([&quot;+XtraArg1&quot;, &quot;+XtraArg2&quot;, &quot;+XtraArg3&quot;, &quot;+XtraArg4&quot;,
<a name="354"/>  354: 		       &quot;+XtraArg5&quot;, &quot;+XtraArg6&quot;],
<a name="355"/>  355: 		      Extra),
<a name="args_file_env-last_expr"/><a name="356"/>  356:     ok.
<a name="357"/>  357: 
<a name="358"/>  358: <i>%% Make sure &quot;erl -detached&quot; survives when parent process group gets killed</i>
<a name="otp_7461-1"/><a name="359"/>  359: <b>otp_7461</b>(Config) when is_list(Config) -&gt;
<a name="otp_7461-last_expr"/><a name="360"/>  360: <b>    case os:type</b>() of
<a name="361"/>  361:     	{unix,_} -&gt;
<a name="362"/>  362: 	    {NetStarted, _} = net_kernel:start([test_server, shortnames]),
<a name="363"/>  363: 	    try
<a name="364"/>  364: 		net_kernel:monitor_nodes(true),
<a name="365"/>  365: 		register(otp_7461, self()),
<a name="366"/>  366: 
<a name="367"/>  367: 		otp_7461_do(Config)
<a name="368"/>  368: 	    after
<a name="369"/>  369: 		catch unregister(otp_7461),
<a name="370"/>  370: 	        catch net_kernel:monitor_nodes(false),
<a name="371"/>  371: 	        case NetStarted of
<a name="372"/>  372: 		    ok -&gt; net_kernel:stop();
<a name="373"/>  373: 		    _ -&gt; ok
<a name="374"/>  374: 		end
<a name="375"/>  375: 	    end;
<a name="376"/>  376: 	_ -&gt;
<a name="377"/>  377: 	    {skip,&quot;Only on Unix.&quot;}
<a name="378"/>  378:     end.
<a name="379"/>  379: 
<a name="otp_7461_do-1"/><a name="380"/>  380: <b>otp_7461_do</b>(Config) -&gt;
<a name="381"/>  381:     io:format(&quot;alive=~p node=~p\n&quot;,[is_alive(), node()]),
<a name="382"/>  382:     TestProg = filename:join([proplists:get_value(data_dir, Config), &quot;erlexec_tests&quot;]),
<a name="383"/>  383:     {ok, [[ErlProg]]} = init:get_argument(progname),
<a name="384"/>  384:     Cmd = TestProg ++ &quot; &quot; ++ ErlProg ++
<a name="385"/>  385: 	&quot; -detached -sname &quot; ++ get_nodename(otp_7461) ++
<a name="386"/>  386: 	&quot; -setcookie &quot; ++ atom_to_list(erlang:get_cookie()) ++
<a name="387"/>  387: 	&quot; -pa &quot; ++ filename:dirname(code:which(?MODULE)) ++
<a name="388"/>  388: 	&quot; -s erlexec_SUITE otp_7461_remote init &quot; ++ atom_to_list(node()),
<a name="389"/>  389: 
<a name="390"/>  390:     %% otp_7461 --------&gt; erlexec_tests.c --------&gt; cerl -detached
<a name="391"/>  391:     %%          open_port                 fork+exec
<a name="392"/>  392: 
<a name="393"/>  393:     io:format(&quot;spawn port prog ~p\n&quot;,[Cmd]),
<a name="394"/>  394:     Port = open_port({spawn, Cmd}, [eof]),
<a name="395"/>  395: 
<a name="396"/>  396:     io:format(&quot;Wait for node to connect...\n&quot;,[]),
<a name="397"/>  397:     {nodeup, Slave} = receive Msg -&gt; Msg
<a name="398"/>  398: 			    after 20*1000 -&gt; timeout end,
<a name="399"/>  399:     io:format(&quot;Node alive: ~p\n&quot;, [Slave]),
<a name="400"/>  400: 
<a name="401"/>  401:     pong = net_adm:ping(Slave),
<a name="402"/>  402:     io:format(&quot;Ping ok towards ~p\n&quot;, [Slave]),
<a name="403"/>  403: 
<a name="404"/>  404:     Port ! { self(), {command, &quot;K&quot;}}, % Kill child process group
<a name="405"/>  405:     {Port, {data, &quot;K&quot;}} = receive Msg2 -&gt; Msg2 end,
<a name="406"/>  406:     port_close(Port),
<a name="407"/>  407: 
<a name="408"/>  408:     %% Now the actual test. Detached node should still be alive.
<a name="409"/>  409:     pong = net_adm:ping(Slave),
<a name="410"/>  410:     io:format(&quot;Ping still ok towards ~p\n&quot;, [Slave]),
<a name="411"/>  411: 
<a name="412"/>  412:     %% Halt node
<a name="413"/>  413:     rpc:cast(Slave, ?MODULE, otp_7461_remote, [[halt, self()]]),
<a name="414"/>  414: 
<a name="415"/>  415:     {nodedown, Slave} = receive
<a name="416"/>  416:                             Msg3 -&gt; Msg3
<a name="417"/>  417:                         after 20*1000 -&gt; timeout
<a name="418"/>  418:                         end,
<a name="419"/>  419:     io:format(&quot;Node dead: ~p\n&quot;, [Slave]),
<a name="otp_7461_do-last_expr"/><a name="420"/>  420:     ok.
<a name="421"/>  421: 
<a name="422"/>  422: 
<a name="423"/>  423: <i>%% Executed on slave node</i>
<a name="otp_7461_remote-1"/><a name="424"/>  424: <b>otp_7461_remote</b>([init, Master]) -&gt;
<a name="425"/>  425:     io:format(&quot;otp_7461_remote(init,~p) at ~p\n&quot;,[Master, node()]),
<a name="426"/>  426:     net_kernel:connect_node(Master);
<a name="427"/>  427: <b>otp_7461_remote</b>([halt, Pid]) -&gt;
<a name="428"/>  428:     io:format(&quot;halt order from ~p to node ~p\n&quot;,[Pid,node()]),
<a name="otp_7461_remote-last_expr"/><a name="429"/>  429: <b>    halt</b>().
<a name="430"/>  430: 
<a name="431"/>  431: <i>%% Check +zdbbl flag</i>
<a name="zdbbl_dist_buf_busy_limit-1"/><a name="432"/>  432: <b>zdbbl_dist_buf_busy_limit</b>(Config) when is_list(Config) -&gt;
<a name="433"/>  433:     LimKB = 1122233,
<a name="434"/>  434:     LimB = LimKB*1024,
<a name="435"/>  435:     {ok,[[PName]]} = init:get_argument(progname),
<a name="436"/>  436:     SNameS = &quot;erlexec_test_02&quot;,
<a name="437"/>  437:     SName = list_to_atom(SNameS++&quot;@&quot;++
<a name="438"/>  438:                          hd(tl(string:lexemes(atom_to_list(node()),&quot;@&quot;)))),
<a name="439"/>  439:     Cmd = PName ++ &quot; -sname &quot;++SNameS++&quot; -setcookie &quot;++
<a name="440"/>  440:         atom_to_list(erlang:get_cookie()) ++
<a name="441"/>  441: 	&quot; +zdbbl &quot; ++ integer_to_list(LimKB),
<a name="442"/>  442:     open_port({spawn,Cmd},[]),
<a name="443"/>  443:     pong = loop_ping(SName,40),
<a name="444"/>  444:     LimB = rpc:call(SName,erlang,system_info,[dist_buf_busy_limit]),
<a name="445"/>  445:     ok = cleanup_node(SNameS, 10),
<a name="zdbbl_dist_buf_busy_limit-last_expr"/><a name="446"/>  446:     ok.
<a name="447"/>  447: 
<a name="long_path_env-1"/><a name="448"/>  448: <b>long_path_env</b>(Config) when is_list(Config) -&gt;
<a name="449"/>  449:     BinPath = os:getenv(&quot;BINDIR&quot;),
<a name="450"/>  450:     ActualPath = os:getenv(&quot;PATH&quot;),
<a name="451"/>  451:     ct:log(&quot;BINDIR: ~ts&quot;, [BinPath]),
<a name="452"/>  452:     ct:log(&quot;PATH: ~ts&quot;, [ActualPath]),
<a name="453"/>  453: 
<a name="454"/>  454:     LongPath = lists:duplicate(10240, &quot;x&quot;),
<a name="455"/>  455:     {ok, [[PName]]} = init:get_argument(progname),
<a name="456"/>  456:     Cmd = PName ++ &quot; -noshell -eval 'io:format(\&quot;~ts\&quot;, [os:getenv(\&quot;PATH\&quot;)]),erlang:halt()'&quot;,
<a name="457"/>  457: 
<a name="458"/>  458:     compare_erl_path(Cmd, BinPath, ActualPath),
<a name="459"/>  459:     compare_erl_path(Cmd, BinPath, path_var_join([ActualPath, LongPath])),
<a name="460"/>  460:     compare_erl_path(Cmd, BinPath, path_var_join([ActualPath, LongPath, BinPath])),
<a name="461"/>  461:     compare_erl_path(Cmd, BinPath, path_var_join([BinPath, ActualPath, LongPath])),
<a name="462"/>  462:     compare_erl_path(Cmd, BinPath, path_var_join([BinPath, ActualPath, LongPath, BinPath])),
<a name="long_path_env-last_expr"/><a name="463"/>  463:     ok.
<a name="464"/>  464: 
<a name="long_path_env_when_rootdir_not_present-1"/><a name="465"/>  465: <b>long_path_env_when_rootdir_not_present</b>(Config) when is_list(Config) -&gt;
<a name="466"/>  466:     BinPath = os:getenv(&quot;BINDIR&quot;),
<a name="467"/>  467:     RootPath = os:getenv(&quot;ROOTDIR&quot;),
<a name="468"/>  468:     RootPathWithBin = filename:join(RootPath, &quot;bin&quot;),
<a name="469"/>  469:     ActualPath = os:getenv(&quot;PATH&quot;),
<a name="470"/>  470:     LongPathLength = 10240,
<a name="471"/>  471: 
<a name="472"/>  472:     LongPath = lists:duplicate(LongPathLength, &quot;x&quot;),
<a name="473"/>  473:     {ok, [[PName]]} = init:get_argument(progname),
<a name="474"/>  474:     Cmd = &quot;\&quot;&quot; ++ filename:join(RootPathWithBin, PName) ++ &quot;\&quot;&quot; ++ &quot; -noshell -eval 'io:format(\&quot;~ts\&quot;, [os:getenv(\&quot;PATH\&quot;)]),erlang:halt()'&quot;,
<a name="475"/>  475: 
<a name="476"/>  476:     PathComponents = string:split(ActualPath, pathsep(), all),
<a name="477"/>  477:     ActualPathNoRoot = path_var_join(lists:filter(fun (Path) -&gt;
<a name="478"/>  478:         (Path =/= RootPathWithBin) and (Path =/= (RootPathWithBin ++ &quot;/&quot;)) and (Path =/= BinPath)
<a name="479"/>  479:     end, PathComponents)),
<a name="480"/>  480: 
<a name="481"/>  481:     os:putenv(&quot;PATH&quot;, path_var_join([ActualPathNoRoot, LongPath, LongPath])),
<a name="482"/>  482:     Output = os:cmd(Cmd),
<a name="483"/>  483: 
<a name="484"/>  484:     ?assertEqual(string:length(string:find(Output, LongPath ++ &quot;:&quot; ++ LongPath)), (LongPathLength * 2) + 1),
<a name="long_path_env_when_rootdir_not_present-last_expr"/><a name="485"/>  485:     ok.
<a name="486"/>  486: 
<a name="compare_erl_path-3"/><a name="487"/>  487: <b>compare_erl_path</b>(Cmd, BinPath, Path) -&gt;
<a name="488"/>  488:     os:putenv(&quot;PATH&quot;, Path),
<a name="489"/>  489:     Output = os:cmd(Cmd),
<a name="490"/>  490:     % BinPath is at the front of PATH and nowhere else
<a name="491"/>  491:     ?assertEqual(string:find(Output, BinPath ++ &quot;:&quot;), Output),
<a name="compare_erl_path-last_expr"/><a name="492"/>  492: <b>    ?assertEqual</b>(string:find(Output, &quot;:&quot; ++ BinPath), nomatch).
<a name="493"/>  493: 
<a name="pathsep-0"/><a name="494"/>  494: <b>pathsep</b>() -&gt;
<a name="pathsep-last_expr"/><a name="495"/>  495: <b>    case os:type</b>() of
<a name="496"/>  496:         {win32, _} -&gt; &quot;;&quot;;
<a name="497"/>  497:         _ -&gt; &quot;:&quot;
<a name="498"/>  498:     end.
<a name="499"/>  499: 
<a name="path_var_join-1"/><a name="500"/>  500: <b>path_var_join</b>(Paths) -&gt;
<a name="path_var_join-last_expr"/><a name="501"/>  501: <b>    lists:concat</b>(lists:join(pathsep(), Paths)).
<a name="502"/>  502: 
<a name="503"/>  503: 
<a name="504"/>  504: <i>%%</i>
<a name="505"/>  505: <i>%% Utils</i>
<a name="506"/>  506: <i>%%</i>
<a name="507"/>  507: 
<a name="save_env-0"/><a name="508"/>  508: <b>save_env</b>() -&gt;
<a name="save_env-last_expr"/><a name="509"/>  509:     {erl_flags,
<a name="510"/>  510:      os:getenv(&quot;ERL_AFLAGS&quot;),
<a name="511"/>  511:      os:getenv(&quot;ERL_FLAGS&quot;),
<a name="512"/>  512:      os:getenv(&quot;ERL_&quot; ++ erlang:system_info(otp_release) ++ &quot;_FLAGS&quot;),
<a name="513"/>  513:      os:getenv(&quot;ERL_ZFLAGS&quot;),
<a name="514"/>  514:      os:getenv(&quot;PATH&quot;)}.
<a name="515"/>  515: 
<a name="restore_env-2"/><a name="516"/>  516: <b>restore_env</b>(EVar, false) when is_list(EVar) -&gt;
<a name="517"/>  517:     restore_env(EVar, &quot;&quot;);
<a name="518"/>  518: <b>restore_env</b>(EVar, &quot;&quot;) when is_list(EVar) -&gt;
<a name="519"/>  519:     case os:getenv(EVar) of
<a name="520"/>  520:     false -&gt; ok;
<a name="521"/>  521:     &quot;&quot; -&gt; ok;
<a name="522"/>  522:     &quot; &quot; -&gt; ok;
<a name="523"/>  523:     _ -&gt; os:putenv(EVar, &quot; &quot;)
<a name="524"/>  524:     end;
<a name="525"/>  525: <b>restore_env</b>(EVar, Value) when is_list(EVar), is_list(Value) -&gt;
<a name="restore_env-last_expr"/><a name="526"/>  526: <b>    case os:getenv</b>(EVar) of
<a name="527"/>  527:     Value -&gt; ok;
<a name="528"/>  528:     _ -&gt; os:putenv(EVar, Value)
<a name="529"/>  529:     end.
<a name="530"/>  530: 
<a name="restore_env-1"/><a name="531"/>  531: <b>restore_env</b>({erl_flags, AFlgs, Flgs, RFlgs, ZFlgs, Path}) -&gt;
<a name="532"/>  532:     restore_env(&quot;ERL_AFLAGS&quot;, AFlgs),
<a name="533"/>  533:     restore_env(&quot;ERL_FLAGS&quot;, Flgs),
<a name="534"/>  534:     restore_env(&quot;ERL_&quot;++erlang:system_info(otp_release) ++ &quot;_FLAGS&quot;, RFlgs),
<a name="535"/>  535:     restore_env(&quot;ERL_ZFLAGS&quot;, ZFlgs),
<a name="536"/>  536:     restore_env(&quot;PATH&quot;, Path),
<a name="restore_env-last_expr"/><a name="537"/>  537:     ok.
<a name="538"/>  538: 
<a name="privfile-2"/><a name="539"/>  539: <b>privfile</b>(Name, Config) -&gt;
<a name="privfile-last_expr"/><a name="540"/>  540: <b>    filename:join</b>([proplists:get_value(priv_dir, Config),
<a name="541"/>  541: 		   atom_to_list(proplists:get_value(testcase, Config)) ++ &quot;.&quot; ++ Name]).
<a name="542"/>  542: 
<a name="write_file-2"/><a name="543"/>  543: <b>write_file</b>(FileName, Frmt) -&gt;
<a name="write_file-last_expr"/><a name="544"/>  544: <b>    write_file</b>(FileName, Frmt, []).
<a name="545"/>  545: 
<a name="write_file-3"/><a name="546"/>  546: <b>write_file</b>(FileName, Frmt, Args) -&gt;
<a name="547"/>  547:     {ok, File} = file:open(FileName, [write]),
<a name="548"/>  548:     io:format(File, Frmt, Args),
<a name="write_file-last_expr"/><a name="549"/>  549: <b>    ok = file:close</b>(File).
<a name="550"/>  550: 
<a name="verify_args-2"/><a name="551"/>  551: <b>verify_args</b>([], _Ys) -&gt;
<a name="552"/>  552:     ok;
<a name="553"/>  553: <b>verify_args</b>(Xs, []) -&gt;
<a name="554"/>  554:     exit({args_not_found_in_order, Xs});
<a name="555"/>  555: <b>verify_args</b>([X|Xs], [Y|Ys]) -&gt;
<a name="verify_args-last_expr"/><a name="556"/>  556: <b>    case string:equal</b>(string:replace(X,&quot;\r\n&quot;,&quot;\n&quot;),string:replace(Y,&quot;\r\n&quot;,&quot;\n&quot;)) of
<a name="557"/>  557:         true -&gt;
<a name="558"/>  558:             verify_args(Xs,Ys);
<a name="559"/>  559:         false -&gt;
<a name="560"/>  560:             verify_args(Xs,[Y|Ys])
<a name="561"/>  561:     end.
<a name="562"/>  562: 
<a name="verify_not_args-2"/><a name="563"/>  563: <b>verify_not_args</b>(Xs, Ys) -&gt;
<a name="verify_not_args-last_expr"/><a name="564"/>  564: <b>    lists:foreach</b>(fun (X) -&gt;
<a name="565"/>  565: 			  case lists:member(X, Ys) of
<a name="566"/>  566: 			      true -&gt; exit({arg_present, X});
<a name="567"/>  567: 			      false -&gt; ok
<a name="568"/>  568: 			  end
<a name="569"/>  569: 		  end, Xs).
<a name="570"/>  570: 
<a name="emu_args-1"/><a name="571"/>  571: <b>emu_args</b>(CmdLineArgs) -&gt;
<a name="emu_args-last_expr"/><a name="572"/>  572: <b>    emu_args</b>(CmdLineArgs, []).
<a name="573"/>  573: 
<a name="emu_args-2"/><a name="574"/>  574: <b>emu_args</b>(CmdLineArgs, Opts) -&gt;
<a name="575"/>  575:     io:format(&quot;CmdLineArgs = ~ts, Opts = ~p~n&quot;, [CmdLineArgs, Opts]),
<a name="576"/>  576:     {ok,[[Erl]]} = init:get_argument(progname),
<a name="577"/>  577:     EmuCL = os:cmd(Erl ++ &quot; -emu_qouted_cmd_exit &quot; ++ CmdLineArgs),
<a name="578"/>  578: <i>%    ct:pal(&quot;EmuCL = ~ts&quot;, [EmuCL]),</i>
<a name="emu_args-last_expr"/><a name="579"/>  579: <b>    case lists:member</b>(return_output, Opts) of
<a name="580"/>  580:         true -&gt;
<a name="581"/>  581:             EmuCL;
<a name="582"/>  582:         false -&gt;
<a name="583"/>  583:             split_emu_clt(string:split(string:trim(EmuCL,both,&quot;\n \&quot;&quot;), &quot;\&quot; \&quot;&quot;, all))
<a name="584"/>  584:     end.
<a name="585"/>  585: 
<a name="split_emu_clt-1"/><a name="586"/>  586: <b>split_emu_clt</b>(EmuCLT) -&gt;
<a name="split_emu_clt-last_expr"/><a name="587"/>  587: <b>    split_emu_clt</b>(EmuCLT, [], [], [], emu).
<a name="588"/>  588: 
<a name="split_emu_clt-5"/><a name="589"/>  589: <b>split_emu_clt</b>([], _Emu, _Misc, _Extra, emu) -&gt;
<a name="590"/>  590:     exit(bad_cmd_line);
<a name="591"/>  591: <b>split_emu_clt</b>([], Emu, Misc, Extra, _Type) -&gt;
<a name="592"/>  592:     {lists:reverse(Emu), lists:reverse(Misc), lists:reverse(Extra)};
<a name="593"/>  593: 
<a name="594"/>  594: <b>split_emu_clt</b>([&quot;--&quot;|As], Emu, Misc, Extra, emu) -&gt;
<a name="595"/>  595:     split_emu_clt(As, Emu, Misc, Extra, misc);
<a name="596"/>  596: <b>split_emu_clt</b>([A|As], Emu, Misc, Extra, emu = Type) -&gt;
<a name="597"/>  597:     split_emu_clt(As, [A|Emu], Misc, Extra, Type);
<a name="598"/>  598: 
<a name="599"/>  599: <b>split_emu_clt</b>([&quot;-extra&quot;|As], Emu, Misc, Extra, misc) -&gt;
<a name="600"/>  600:     split_emu_clt(As, Emu, Misc, Extra, extra);
<a name="601"/>  601: <b>split_emu_clt</b>([A|As], Emu, Misc, Extra, misc = Type) -&gt;
<a name="602"/>  602:     split_emu_clt(As, Emu, [A|Misc], Extra, Type);
<a name="603"/>  603: 
<a name="604"/>  604: <b>split_emu_clt</b>([A|As], Emu, Misc, Extra, extra = Type) -&gt;
<a name="split_emu_clt-last_expr"/><a name="605"/>  605: <b>    split_emu_clt</b>(As, Emu, Misc, [A|Extra], Type).
<a name="606"/>  606: 
<a name="607"/>  607: 
<a name="get_nodename-1"/><a name="608"/>  608: <b>get_nodename</b>(T) -&gt;
<a name="609"/>  609:     atom_to_list(T)
<a name="get_nodename-last_expr"/><a name="610"/>  610: 	++ &quot;-&quot;
<a name="611"/>  611: 	++ atom_to_list(?MODULE)
<a name="612"/>  612: 	++ &quot;-&quot;
<a name="613"/>  613: 	++ integer_to_list(erlang:system_time(seconds))
<a name="614"/>  614: 	++ &quot;-&quot;
<a name="615"/>  615: 	++ integer_to_list(erlang:unique_integer([positive])).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
