<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/code_parallel_load_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2012-2016. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(code_parallel_load_SUITE).
<a name="22"/>   22: <b>-export</b>([all/0,
<a name="23"/>   23:          suite/0,
<a name="24"/>   24:          init_per_testcase/2,
<a name="25"/>   25:          end_per_testcase/2]).
<a name="26"/>   26: 
<a name="27"/>   27: <b>-export</b>([multiple_load_check_purge_repeat/1,
<a name="28"/>   28:          many_load_distributed_only_once/1]).
<a name="29"/>   29: 
<a name="30"/>   30: <b>-define</b>(model,       code_parallel_load_SUITE_model).
<a name="31"/>   31: <b>-define</b>(interval,    50).
<a name="32"/>   32: <b>-define</b>(number_of_processes, 160).
<a name="33"/>   33: <b>-define</b>(passes, 4).
<a name="34"/>   34: 
<a name="35"/>   35: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="36"/>   36: 
<a name="suite-0"/><a name="37"/>   37: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="38"/>   38:     [{ct_hooks,[ts_install_cth]},
<a name="39"/>   39:      {timetrap, {minutes, 4}}].
<a name="40"/>   40: 
<a name="all-0"/><a name="41"/>   41: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="42"/>   42:     [ multiple_load_check_purge_repeat,
<a name="43"/>   43:       many_load_distributed_only_once ].
<a name="44"/>   44: 
<a name="init_per_testcase-2"/><a name="45"/>   45: <b>init_per_testcase</b>(Func, Config) when is_atom(Func), is_list(Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="46"/>   46:     Config.
<a name="47"/>   47: 
<a name="end_per_testcase-2"/><a name="48"/>   48: <b>end_per_testcase</b>(_Func, Config) -&gt;
<a name="49"/>   49:     SConf = proplists:get_value(save_config, Config),
<a name="50"/>   50:     Pids  = proplists:get_value(purge_pids, SConf),
<a name="51"/>   51: 
<a name="52"/>   52:     case check_old_code(?model) of
<a name="53"/>   53: 	true -&gt; check_and_purge_processes_code(Pids, ?model);
<a name="54"/>   54: 	_ -&gt;    ok
<a name="55"/>   55:     end,
<a name="56"/>   56:     case erlang:delete_module(?model) of
<a name="57"/>   57: 	true -&gt; check_and_purge_processes_code(Pids, ?model);
<a name="58"/>   58: 	_ -&gt;    ok
<a name="59"/>   59:     end,
<a name="end_per_testcase-last_expr"/><a name="60"/>   60:     ok.
<a name="61"/>   61: 
<a name="multiple_load_check_purge_repeat-1"/><a name="62"/>   62: <b>multiple_load_check_purge_repeat</b>(_Conf) -&gt;
<a name="63"/>   63:     Ts    = [v1,v2,v3,v4,v5,v6],
<a name="64"/>   64: 
<a name="65"/>   65:     %% generate code that receives a token, code switches to new code
<a name="66"/>   66:     %% then matches this token against a literal code token
<a name="67"/>   67:     %% should be identical
<a name="68"/>   68:     %% (smoke test for parallel code loading
<a name="69"/>   69:     Codes = [{T, generate(?model, [], [
<a name="70"/>   70: 	    format(&quot;check(T) -&gt; receive {_Pid, change, T1} -&gt; &quot;
<a name="71"/>   71: 		&quot; ~w:check(T1)\n&quot;
<a name="72"/>   72: 		&quot; after 0 -&gt; T = f(), check(T) end.\n&quot;, [?model]),
<a name="73"/>   73: 	    format(&quot;f() -&gt; ~w.~n&quot;, [T])
<a name="74"/>   74: 	])} || T &lt;- Ts],
<a name="75"/>   75: 
<a name="76"/>   76:     Pids = setup_code_changer(Codes),
<a name="multiple_load_check_purge_repeat-last_expr"/><a name="77"/>   77:     {save_config, [{purge_pids,Pids}]}.
<a name="78"/>   78: 
<a name="setup_code_changer-1"/><a name="79"/>   79: <b>setup_code_changer</b>([{Token,Code}|Cs] = Codes) -&gt;
<a name="80"/>   80:     {module, ?model} = erlang:load_module(?model,Code),
<a name="81"/>   81:     Pids = setup_checkers(Token,?number_of_processes),
<a name="82"/>   82:     code_changer(Cs, Codes, ?interval,Pids,?passes),
<a name="setup_code_changer-last_expr"/><a name="83"/>   83:     Pids.
<a name="84"/>   84: 
<a name="code_changer-5"/><a name="85"/>   85: <b>code_changer</b>(_, _, _, Pids, 0) -&gt;
<a name="86"/>   86:     [unlink(Pid) || Pid &lt;- Pids],
<a name="87"/>   87:     [exit(Pid, die) || Pid &lt;- Pids],
<a name="88"/>   88:     io:format(&quot;done~n&quot;),
<a name="89"/>   89:     ok;
<a name="90"/>   90: <b>code_changer</b>([], Codes, T, Pids, Ps) -&gt;
<a name="91"/>   91:     code_changer(Codes, Codes, T, Pids, Ps - 1);
<a name="92"/>   92: <b>code_changer</b>([{Token,Code}|Cs], Codes, T, Pids, Ps) -&gt;
<a name="code_changer-last_expr"/><a name="93"/>   93:     receive after T -&gt;
<a name="94"/>   94: 	    io:format(&quot;load code with token ~4w : pass ~4w~n&quot;, [Token, Ps]),
<a name="95"/>   95: 	    {module, ?model} = erlang:load_module(?model, Code),
<a name="96"/>   96: 	    % this is second time we call load_module for this module
<a name="97"/>   97: 	    % so it should have old code
<a name="98"/>   98: 	    [Pid ! {self(), change, Token} || Pid &lt;- Pids],
<a name="99"/>   99: 	    % should we wait a moment or just blantantly try to check and purge repeatadly?
<a name="100"/>  100: 	    receive after 1 -&gt; ok end,
<a name="101"/>  101: 	    ok = check_and_purge_processes_code(Pids, ?model),
<a name="102"/>  102: 	    code_changer(Cs, Codes, T, Pids, Ps)
<a name="103"/>  103:     end.
<a name="104"/>  104: 
<a name="105"/>  105: 
<a name="106"/>  106: 
<a name="many_load_distributed_only_once-1"/><a name="107"/>  107: <b>many_load_distributed_only_once</b>(_Conf) -&gt;
<a name="108"/>  108:     Ts = [&lt;&lt;&quot;first version&quot;&gt;&gt;, &lt;&lt;&quot;second version&quot;&gt;&gt;],
<a name="109"/>  109: 
<a name="110"/>  110:     [{Token1,Code1},{Token2, Code2}] = [{T, generate(?model, [], [
<a name="111"/>  111: 	    &quot;check({&lt;&lt;\&quot;second version\&quot;&gt;&gt; = V, Pid}) -&gt; V = f(), Pid ! {self(), completed, V}, ok;\n&quot; ++
<a name="112"/>  112: 	    format(&quot;check(T) -&gt; receive {Pid, change, T1, B} -&gt; &quot;
<a name="113"/>  113: 		&quot; Res = erlang:load_module(~w, B), Pid ! {self(), change, Res},\n&quot;
<a name="114"/>  114: 		&quot; ~w:check({T1, Pid})\n&quot;
<a name="115"/>  115: 		&quot; after 0 -&gt; T = f(), check(T) end.\n&quot;, [?model, ?model]),
<a name="116"/>  116: 	    format(&quot;f() -&gt; ~w.~n&quot;, [T])
<a name="117"/>  117: 	])} || T &lt;- Ts],
<a name="118"/>  118: 
<a name="119"/>  119: 
<a name="120"/>  120:     {module, ?model} = erlang:load_module(?model, Code1),
<a name="121"/>  121:     Pids = setup_checkers(Token1,?number_of_processes),
<a name="122"/>  122: 
<a name="123"/>  123:     receive after 1000 -&gt; ok end, % give 'em some time to spin up
<a name="124"/>  124:     [Pid ! {self(), change, Token2, Code2} || Pid &lt;- Pids],
<a name="125"/>  125:     Loads = [receive {Pid, change, Res} -&gt; Res end || Pid &lt;- Pids],
<a name="126"/>  126:     [receive {Pid, completed, Token2} -&gt; ok end || Pid &lt;- Pids],
<a name="127"/>  127: 
<a name="128"/>  128:     ok = ensure_only_one_load(Loads, 0),
<a name="many_load_distributed_only_once-last_expr"/><a name="129"/>  129:     {save_config, [{purge_pids,Pids}]}.
<a name="130"/>  130: 
<a name="ensure_only_one_load-2"/><a name="131"/>  131: <b>ensure_only_one_load</b>([], 1) -&gt; ok;
<a name="132"/>  132: <b>ensure_only_one_load</b>([], _) -&gt; too_many_loads;
<a name="133"/>  133: <b>ensure_only_one_load</b>([{module, ?model}|Loads], N) -&gt;
<a name="134"/>  134:     ensure_only_one_load(Loads, N + 1);
<a name="135"/>  135: <b>ensure_only_one_load</b>([{error, not_purged}|Loads], N) -&gt;
<a name="ensure_only_one_load-last_expr"/><a name="136"/>  136: <b>    ensure_only_one_load</b>(Loads, N).
<a name="137"/>  137: <i>% no other return values are allowed from load_module</i>
<a name="138"/>  138: 
<a name="139"/>  139: 
<a name="140"/>  140: <i>%% aux</i>
<a name="141"/>  141: 
<a name="setup_checkers-2"/><a name="142"/>  142: <b>setup_checkers</b>(_,0) -&gt; [];
<a name="setup_checkers-last_expr"/><a name="143"/>  143: <b>setup_checkers</b>(T,N) -&gt; [spawn_link(fun() -&gt; ?model:check(T) end) | setup_checkers(T, N-1)].
<a name="144"/>  144: 
<a name="check_and_purge_processes_code-2"/><a name="145"/>  145: <b>check_and_purge_processes_code</b>(Pids, M) -&gt;
<a name="146"/>  146:     Tag = make_ref(),
<a name="147"/>  147:     N = request_cpc(Pids, M, Tag),
<a name="148"/>  148:     ok = handle_cpc_responses(N, Tag, M),
<a name="149"/>  149:     erlang:purge_module(M),
<a name="check_and_purge_processes_code-last_expr"/><a name="150"/>  150:     ok.
<a name="151"/>  151: 
<a name="request_cpc-3"/><a name="152"/>  152: <b>request_cpc</b>(Pid, M, Tag) when is_pid(Pid) -&gt;
<a name="153"/>  153:     erlang:check_process_code(Pid, M, [{async, {Tag, Pid}}]),
<a name="154"/>  154:     1;
<a name="155"/>  155: <b>request_cpc</b>(Pids, M, Tag) when is_list(Pids) -&gt;
<a name="request_cpc-last_expr"/><a name="156"/>  156: <b>    request_cpc</b>(Pids, M, Tag, 0).
<a name="157"/>  157: 
<a name="request_cpc-4"/><a name="158"/>  158: <b>request_cpc</b>([], _M, _Tag, N) -&gt;
<a name="159"/>  159:     N;
<a name="160"/>  160: <b>request_cpc</b>([Pid|Pids], M, Tag, N) -&gt;
<a name="request_cpc-last_expr"/><a name="161"/>  161: <b>    request_cpc</b>(Pids, M, Tag, N + request_cpc(Pid, M, Tag)).
<a name="162"/>  162: 
<a name="handle_cpc_responses-3"/><a name="163"/>  163: <b>handle_cpc_responses</b>(0, _Tag, _Module) -&gt;
<a name="164"/>  164:     ok;
<a name="165"/>  165: <b>handle_cpc_responses</b>(N, Tag, Module) -&gt;
<a name="handle_cpc_responses-last_expr"/><a name="166"/>  166:     receive
<a name="167"/>  167: 	{check_process_code, {Tag, _Pid}, false} -&gt;
<a name="168"/>  168: 	    handle_cpc_responses(N-1, Tag, Module);
<a name="169"/>  169: 	{check_process_code, {Tag, Pid}, true} -&gt;
<a name="170"/>  170: 	    1 = request_cpc(Pid, Module, Tag),
<a name="171"/>  171: 	    handle_cpc_responses(N, Tag, Module)
<a name="172"/>  172:     end.
<a name="173"/>  173: 
<a name="generate-3"/><a name="174"/>  174: <b>generate</b>(Module, Attributes, FunStrings) -&gt;
<a name="175"/>  175:     FunForms = function_forms(FunStrings),
<a name="176"/>  176:     Forms    = [
<a name="177"/>  177: 	{attribute,a(1),module,Module},
<a name="178"/>  178: 	{attribute,a(2),export,[FA || {FA,_} &lt;- FunForms]}
<a name="179"/>  179:     ] ++ [{attribute, a(3), A, V}|| {A, V} &lt;- Attributes] ++
<a name="180"/>  180:     [ Function || {_, Function} &lt;- FunForms],
<a name="181"/>  181:     {ok, Module, Bin} = compile:forms(Forms),
<a name="generate-last_expr"/><a name="182"/>  182:     Bin.
<a name="183"/>  183: 
<a name="a-1"/><a name="184"/>  184: <b>a</b>(L) -&gt;
<a name="a-last_expr"/><a name="185"/>  185: <b>    erl_anno:new</b>(L).
<a name="186"/>  186: 
<a name="function_forms-1"/><a name="187"/>  187: <b>function_forms</b>([]) -&gt; [];
<a name="188"/>  188: <b>function_forms</b>([S|Ss]) -&gt;
<a name="189"/>  189:     {ok, Ts,_} = erl_scan:string(S),
<a name="190"/>  190:     {ok, Form} = erl_parse:parse_form(Ts),
<a name="191"/>  191:     Fun   = element(3, Form),
<a name="192"/>  192:     Arity = element(4, Form),
<a name="function_forms-last_expr"/><a name="193"/>  193: <b>    [{{Fun,Arity}, Form}|function_forms</b>(Ss)].
<a name="194"/>  194: 
<a name="format-2"/><a name="format-last_expr"/><a name="195"/>  195: <b>format</b>(F,Ts) -&gt; lists:flatten(io_lib:format(F, Ts)).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
