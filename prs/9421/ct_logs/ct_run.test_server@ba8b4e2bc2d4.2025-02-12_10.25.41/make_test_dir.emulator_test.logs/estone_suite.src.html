<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/estone_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2002-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: 
<a name="20"/>   20: <b>-module</b>(estone_SUITE).
<a name="21"/>   21: <i>%% Test functions</i>
<a name="22"/>   22: <b>-export</b>([all/0, suite/0, groups/0,
<a name="23"/>   23: 	 estone/1, estone_bench/1, pgo/0]).
<a name="24"/>   24: 
<a name="25"/>   25: <i>%% Internal exports for EStone tests</i>
<a name="26"/>   26: <b>-export</b>([lists/1,
<a name="27"/>   27: 	 msgp/1,
<a name="28"/>   28: 	 msgp_medium/1,
<a name="29"/>   29: 	 msgp_huge/1,
<a name="30"/>   30: 	 pattern/1,
<a name="31"/>   31: 	 trav/1,
<a name="32"/>   32: 	 port_io/1,
<a name="33"/>   33: 	 large_dataset_work/1,
<a name="34"/>   34: 	 large_local_dataset_work/1,mk_big_procs/1,big_proc/0, very_big/1,
<a name="35"/>   35: 	 alloc/1,
<a name="36"/>   36: 	 bif_dispatch/1,
<a name="37"/>   37: 	 binary_h/1,echo/1,
<a name="38"/>   38: 	 ets/1,
<a name="39"/>   39: 	 generic/1,req/2,gserv/4,handle_call/3,
<a name="40"/>   40: 	 int_arith/1,
<a name="41"/>   41: 	 float_arith/1,
<a name="42"/>   42: 	 fcalls/1,remote0/1,remote1/1,app0/1,app1/1,
<a name="43"/>   43: 	 timer/1,
<a name="44"/>   44: 	 links/1,lproc/1,
<a name="45"/>   45: 	 run_micro/3,p1/1,ppp/3,macro/2,micros/0]).
<a name="46"/>   46: 
<a name="47"/>   47: <b>-ifndef</b>(PGO).
<a name="48"/>   48: <b>-include_lib</b>(&quot;common_test/include/ct_event.hrl&quot;).
<a name="49"/>   49: -endif.
<a name="50"/>   50: 
<a name="51"/>   51: <i>%% EStone defines</i>
<a name="52"/>   52: <b>-define</b>(TOTAL, (3000 * 1000 * 100)).   %% 300 secs
<a name="53"/>   53: <b>-define</b>(BIGPROCS, 2).
<a name="54"/>   54: <b>-define</b>(BIGPROC_SIZE, 50).
<a name="55"/>   55: <b>-define</b>(STONEFACTOR, 31000000).   %% Factor to make the reference
<a name="56"/>   56:                              %% implementation to make 1000 TS_ESTONES.
<a name="57"/>   57: <b>-record</b>(micro,
<a name="58"/>   58: 	{function, %% The name of the function implementing the micro
<a name="59"/>   59: 	 weight,   %% How important is this in typical applications ??
<a name="60"/>   60: 	 loops = 100,%% initial data
<a name="61"/>   61: 	 tt1,      %% time to do one round
<a name="62"/>   62: 	 str}).    %% Header string
<a name="63"/>   63: 
<a name="64"/>   64: 
<a name="suite-0"/><a name="65"/>   65: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="66"/>   66:     [{ct_hooks,[ts_install_cth]},
<a name="67"/>   67:      {timetrap, {minutes, 4}}].
<a name="68"/>   68: 
<a name="all-0"/><a name="69"/>   69: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="70"/>   70:     [estone].
<a name="71"/>   71: 
<a name="groups-0"/><a name="72"/>   72: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="73"/>   73:     [{estone_bench, [{repeat,50}],[estone_bench]}].
<a name="74"/>   74: 
<a name="75"/>   75: 
<a name="76"/>   76: <i>%% EStone Test</i>
<a name="estone-1"/><a name="77"/>   77: <b>estone</b>(Config) when is_list(Config) -&gt;
<a name="78"/>   78:     DataDir = proplists:get_value(data_dir,Config),
<a name="79"/>   79:     Mhz=get_cpu_speed(os:type(),DataDir),
<a name="80"/>   80:     L = ?MODULE:macro(?MODULE:micros(),DataDir),
<a name="81"/>   81:     {Total, Stones} = sum_micros(L, 0, 0),
<a name="82"/>   82:     pp(Mhz,Total,Stones,L),
<a name="estone-last_expr"/><a name="83"/>   83: <b>    {comment,Mhz ++ &quot; MHz, &quot; ++ integer_to_list</b>(Stones) ++ &quot; ESTONES&quot;}.
<a name="84"/>   84: 
<a name="estone_bench-1"/><a name="85"/>   85: <b>estone_bench</b>(Config) -&gt;
<a name="86"/>   86:     DataDir = proplists:get_value(data_dir,Config),
<a name="87"/>   87:     L = ?MODULE:macro(?MODULE:micros(),DataDir),
<a name="88"/>   88:     {Total, Stones} = sum_micros(L, 0, 0),
<a name="89"/>   89:     notify([[{title,&quot;ESTONES&quot;}, {estones, Stones}] | L]),
<a name="estone_bench-last_expr"/><a name="90"/>   90:     L.
<a name="91"/>   91: 
<a name="92"/>   92: <b>-ifndef</b>(PGO).
<a name="notify-1"/><a name="93"/>   93: <b>notify</b>(Marks) -&gt;
<a name="notify-last_expr"/><a name="94"/>   94: <b>    [ct_event:notify</b>(
<a name="95"/>   95:        #event{name = benchmark_data,
<a name="96"/>   96: 	      data = [{name,proplists:get_value(title, Mark)},
<a name="97"/>   97: 		      {value,proplists:get_value(estones, Mark)}]})
<a name="98"/>   98:      || Mark &lt;- Marks].
<a name="99"/>   99: -else.
<a name="100"/>  100: notify(_) -&gt;
<a name="101"/>  101:     ok.
<a name="102"/>  102: -endif.
<a name="103"/>  103: 
<a name="104"/>  104: <i>%% The benchmarks to run in order to guide PGO (profile guided optimisation)</i>
<a name="pgo-0"/><a name="105"/>  105: <b>pgo</b>() -&gt;
<a name="106"/>  106:     %% We run all benchmarks except the port_io as we don't want to
<a name="107"/>  107:     %% have to build a custom port.
<a name="108"/>  108:     Micros = ?MODULE:micros() -- [micro(port_io)],
<a name="109"/>  109:     L = ?MODULE:macro(Micros,[]),
<a name="110"/>  110:     {Total, Stones} = sum_micros(L, 0, 0),
<a name="111"/>  111:     pp(&quot;UNKNOWN&quot;,Total,Stones,L),
<a name="pgo-last_expr"/><a name="112"/>  112: <b>    {comment,&quot;UNKNOWN&quot; ++ &quot; MHz, &quot; ++ integer_to_list</b>(Stones) ++ &quot; ESTONES&quot;}.
<a name="113"/>  113: 
<a name="114"/>  114: <i>%%</i>
<a name="115"/>  115: <i>%% Calculate CPU speed</i>
<a name="116"/>  116: <i>%%</i>
<a name="117"/>  117: <i>%% get_cpu_speed() now returns a string. For multiprocessor</i>
<a name="118"/>  118: <i>%% machines (at least on Solaris) the format is: &lt;F1&gt;+&lt;F2&gt;[+...]</i>
<a name="119"/>  119: <i>%%</i>
<a name="get_cpu_speed-2"/><a name="120"/>  120: <b>get_cpu_speed</b>({win32, _},_DataDir) -&gt;
<a name="121"/>  121:     RegH =
<a name="122"/>  122: 	case catch win32reg:open([read]) of
<a name="123"/>  123: 	    {ok, Handle} -&gt;
<a name="124"/>  124: 		Handle;
<a name="125"/>  125: 	    _ -&gt;
<a name="126"/>  126: 		io:format(&quot;Error.~nCannot determine CPU clock&quot;
<a name="127"/>  127: 			  &quot;frequency.~n&quot;
<a name="128"/>  128: 			  &quot;Please set the environment variable&quot;
<a name="129"/>  129: 			  &quot;\&quot;CPU_SPEED\&quot;~n&quot;),
<a name="130"/>  130: 		exit(self(), {error, no_cpu_speed})
<a name="131"/>  131: 	end,
<a name="132"/>  132:     case win32reg:change_key(RegH,&quot;\\hkey_local_machine\\hardware\\&quot;
<a name="133"/>  133: 			     &quot;description\\system\\centralprocessor&quot;
<a name="134"/>  134: 			     &quot;\\0&quot;) of
<a name="135"/>  135: 	ok -&gt;
<a name="136"/>  136: 	    ok;
<a name="137"/>  137: 	_ -&gt;
<a name="138"/>  138: 	    io:format(&quot;Error.~nRegistry seems to be damaged or&quot;
<a name="139"/>  139: 		      &quot;unavailable.~n&quot;
<a name="140"/>  140: 		      &quot;Please set the environment variable&quot;
<a name="141"/>  141: 		      &quot;\&quot;CPU_SPEED\&quot;,~nor correct your registry&quot;
<a name="142"/>  142: 		      &quot;if possible.~n&quot;),
<a name="143"/>  143: 	    win32reg:close(RegH),
<a name="144"/>  144: 	    exit(self(), {error, no_cpu_speed})
<a name="145"/>  145:     end,
<a name="146"/>  146:     case win32reg:value(RegH, &quot;~MHZ&quot;) of
<a name="147"/>  147: 	{ok, Speed} -&gt;
<a name="148"/>  148: 	    win32reg:close(RegH),
<a name="149"/>  149: 	    integer_to_list(Speed);
<a name="150"/>  150: 	_ -&gt;
<a name="151"/>  151: 	    io:format(&quot;Error.~nRegistry seems to be damaged or &quot;
<a name="152"/>  152: 		      &quot;unavailable.~n&quot;),
<a name="153"/>  153: 	    io:format(&quot;Please set the environment variable&quot;
<a name="154"/>  154: 		      &quot;\&quot;CPU_SPEED\&quot;~n&quot;),
<a name="155"/>  155: 	    win32reg:close(RegH),
<a name="156"/>  156: 	    exit(self(), {error, no_cpu_speed})
<a name="157"/>  157:     end;
<a name="158"/>  158: <b>get_cpu_speed</b>({unix, sunos},DataDir) -&gt;
<a name="159"/>  159:     os:cmd(filename:join(DataDir,&quot;sunspeed.sh&quot;)) -- &quot;\n&quot;;
<a name="160"/>  160: <b>get_cpu_speed</b>(_Other,_DataDir) -&gt;
<a name="161"/>  161:     %% Cannot determine CPU speed
<a name="get_cpu_speed-last_expr"/><a name="162"/>  162:     &quot;UNKNOWN&quot;.
<a name="163"/>  163: 
<a name="164"/>  164: 
<a name="165"/>  165: <i>%%</i>
<a name="166"/>  166: <i>%% Pretty Print EStone Result</i>
<a name="167"/>  167: <i>%%</i>
<a name="pp-4"/><a name="168"/>  168: <b>pp</b>(Mhz,Total,Stones,Ms) -&gt;
<a name="169"/>  169:     io:format(&quot;EStone test completed~n&quot;,[]),
<a name="170"/>  170:     io:format(&quot;**** CPU speed ~s MHz ****~n&quot;,[Mhz]),
<a name="171"/>  171:     io:format(&quot;**** Total time ~w seconds ****~n&quot;, [Total / 1000000]),
<a name="172"/>  172:     io:format(&quot;**** ESTONES = ~w ****~n~n&quot;, [Stones]),
<a name="173"/>  173:     io:format(&quot;~-31s      ~-12s  ~-10s   %    ~-10s ~n~n&quot;,
<a name="174"/>  174: 	      [&quot;    Title&quot;, &quot;Millis&quot;, &quot;Estone&quot;, &quot;Loops&quot;]),
<a name="175"/>  175:     erlang:display({'ESTONES', Stones}),
<a name="pp-last_expr"/><a name="176"/>  176: <b>    pp2</b>(Ms).
<a name="177"/>  177: 
<a name="sum_micros-3"/><a name="178"/>  178: <b>sum_micros</b>([], Tot, Stones) -&gt; {Tot, Stones};
<a name="179"/>  179: <b>sum_micros</b>([H|T], Tot, Sto) -&gt; 
<a name="sum_micros-last_expr"/><a name="180"/>  180: <b>    sum_micros</b>(T, ks(microsecs, H) + Tot, ks(estones, H) + Sto).
<a name="181"/>  181: 
<a name="pp2-1"/><a name="182"/>  182: <b>pp2</b>([]) -&gt;   ok;
<a name="183"/>  183: <b>pp2</b>([R|Tail]) -&gt;
<a name="184"/>  184:     io:format(&quot;~-35s  ~-12w    ~-10w   ~-2w    ~-10w ~n&quot;,
<a name="185"/>  185: 	      [ks(title,R), 
<a name="186"/>  186: 	       round(ks(microsecs, R) / 1000), 
<a name="187"/>  187: 	       ks(estones, R),
<a name="188"/>  188: 	       ks(weight_percentage, R),
<a name="189"/>  189: 	       ks(loops, R)]),
<a name="pp2-last_expr"/><a name="190"/>  190: <b>    pp2</b>(Tail).
<a name="191"/>  191: 
<a name="ks-2"/><a name="192"/>  192: <b>ks</b>(K, L) -&gt;
<a name="193"/>  193:     {value, {_, V}} = lists:keysearch(K, 1, L),
<a name="ks-last_expr"/><a name="194"/>  194:     V.
<a name="195"/>  195: 
<a name="196"/>  196: 
<a name="197"/>  197: 
<a name="198"/>  198: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="199"/>  199: <i>%%% EStone test</i>
<a name="micro-1"/><a name="200"/>  200: <b>micro</b>(lists) -&gt; 
<a name="201"/>  201:      #micro{function = lists,
<a name="202"/>  202: 	    weight = 7, 
<a name="203"/>  203: 	    loops = 6400,
<a name="204"/>  204: 	    str = &quot;list manipulation&quot;};
<a name="205"/>  205: <b>micro</b>(msgp) -&gt;
<a name="206"/>  206:     #micro{function = msgp,
<a name="207"/>  207: 	    weight = 10,
<a name="208"/>  208: 	    loops = 1515,
<a name="209"/>  209: 	    str = &quot;small messages&quot;};
<a name="210"/>  210: <b>micro</b>(msgp_medium) -&gt;
<a name="211"/>  211:     #micro{function = msgp_medium,
<a name="212"/>  212: 	    weight = 14,
<a name="213"/>  213: 	    loops = 1527,
<a name="214"/>  214: 	    str = &quot;medium messages&quot;};
<a name="215"/>  215: <b>micro</b>(msgp_huge) -&gt;
<a name="216"/>  216:     #micro{function = msgp_huge,
<a name="217"/>  217: 	    weight = 4,
<a name="218"/>  218: 	    loops = 52,
<a name="219"/>  219: 	    str = &quot;huge messages&quot;};
<a name="220"/>  220: 
<a name="221"/>  221: <b>micro</b>(pattern) -&gt;
<a name="222"/>  222:     #micro{function = pattern,
<a name="223"/>  223: 	    weight = 5,
<a name="224"/>  224: 	    loops = 1046,
<a name="225"/>  225: 	    str = &quot;pattern matching&quot;};
<a name="226"/>  226: 
<a name="227"/>  227: <b>micro</b>(trav) -&gt;
<a name="228"/>  228:     #micro{function = trav,
<a name="229"/>  229: 	    weight = 4,
<a name="230"/>  230: 	    loops = 2834,
<a name="231"/>  231: 	    str = &quot;traverse&quot;};
<a name="232"/>  232: 
<a name="233"/>  233: <b>micro</b>(port_io) -&gt;
<a name="234"/>  234:     #micro{function = port_io,
<a name="235"/>  235: 	   weight = 12,
<a name="236"/>  236: 	   loops = 4800,
<a name="237"/>  237: 	   str = &quot;Port i/o&quot;};
<a name="238"/>  238: 
<a name="239"/>  239: <b>micro</b>(large_dataset_work) -&gt;
<a name="240"/>  240:     #micro{function = large_dataset_work,
<a name="241"/>  241: 	   weight = 3,
<a name="242"/>  242: 	   loops = 1193,
<a name="243"/>  243: 	   str = &quot;Work with large dataset&quot;};
<a name="244"/>  244: 
<a name="245"/>  245: <b>micro</b>(large_local_dataset_work) -&gt;
<a name="246"/>  246:     #micro{function = large_local_dataset_work,
<a name="247"/>  247: 	   weight = 3,
<a name="248"/>  248: 	   loops = 1174,
<a name="249"/>  249: 	   str = &quot;Work with large local dataset&quot;};
<a name="250"/>  250: 
<a name="251"/>  251: <b>micro</b>(alloc) -&gt;
<a name="252"/>  252:     #micro{function = alloc,
<a name="253"/>  253: 	   weight = 2,
<a name="254"/>  254: 	   loops = 3710,
<a name="255"/>  255: 	   str = &quot;Alloc and dealloc&quot;};
<a name="256"/>  256: 
<a name="257"/>  257: <b>micro</b>(bif_dispatch) -&gt;
<a name="258"/>  258:     #micro{function = bif_dispatch,
<a name="259"/>  259: 	   weight = 8,
<a name="260"/>  260: 	   loops = 5623,
<a name="261"/>  261: 	   str = &quot;Bif dispatch&quot;};
<a name="262"/>  262: 
<a name="263"/>  263: <b>micro</b>(binary_h) -&gt;
<a name="264"/>  264:     #micro{function = binary_h,
<a name="265"/>  265: 	   weight = 4,
<a name="266"/>  266: 	   loops = 581,
<a name="267"/>  267: 	   str = &quot;Binary handling&quot;};
<a name="268"/>  268: <b>micro</b>(ets) -&gt;
<a name="269"/>  269:     #micro{function = ets,
<a name="270"/>  270: 	   weight = 6,
<a name="271"/>  271: 	   loops = 342,
<a name="272"/>  272: 	   str = &quot;ets datadictionary&quot;};
<a name="273"/>  273: <b>micro</b>(generic) -&gt;
<a name="274"/>  274:     #micro{function = generic,
<a name="275"/>  275: 	   weight = 9,
<a name="276"/>  276: 	   loops = 7977,
<a name="277"/>  277: 	   str = &quot;Generic server (with timeout)&quot;};
<a name="278"/>  278: <b>micro</b>(int_arith) -&gt;
<a name="279"/>  279:     #micro{function = int_arith,
<a name="280"/>  280: 	   weight = 3,
<a name="281"/>  281: 	   loops = 4157,
<a name="282"/>  282: 	   str = &quot;Small Integer arithmetic&quot;};
<a name="283"/>  283: <b>micro</b>(float_arith) -&gt;
<a name="284"/>  284:     #micro{function = float_arith,
<a name="285"/>  285: 	   weight = 1,
<a name="286"/>  286: 	   loops = 5526,
<a name="287"/>  287: 	   str = &quot;Float arithmetic&quot;};
<a name="288"/>  288: <b>micro</b>(fcalls) -&gt;
<a name="289"/>  289:     #micro{function = fcalls,
<a name="290"/>  290: 	   weight = 5,
<a name="291"/>  291: 	   loops = 882,
<a name="292"/>  292: 	   str = &quot;Function calls&quot;};
<a name="293"/>  293: 
<a name="294"/>  294: <b>micro</b>(timer) -&gt;
<a name="295"/>  295:     #micro{function = timer,
<a name="296"/>  296: 	   weight = 2,
<a name="297"/>  297: 	   loops = 2312,
<a name="298"/>  298: 	   str = &quot;Timers&quot;};
<a name="299"/>  299: 
<a name="300"/>  300: <b>micro</b>(links) -&gt;
<a name="micro-last_expr"/><a name="301"/>  301:     #micro{function = links,
<a name="302"/>  302: 	   weight = 1,
<a name="303"/>  303: 	   loops = 30,
<a name="304"/>  304: 	   str = &quot;Links&quot;}.
<a name="305"/>  305: 
<a name="306"/>  306: 
<a name="307"/>  307: 
<a name="308"/>  308: <i>%% Return a list of micro's</i>
<a name="micros-0"/><a name="309"/>  309: <b>micros</b>() -&gt;
<a name="micros-last_expr"/><a name="310"/>  310:     [
<a name="311"/>  311:      micro(lists),
<a name="312"/>  312:      micro(msgp),
<a name="313"/>  313:      micro(msgp_medium),
<a name="314"/>  314:      micro(msgp_huge),
<a name="315"/>  315:      micro(pattern),
<a name="316"/>  316:      micro(trav),
<a name="317"/>  317:      micro(port_io),
<a name="318"/>  318:      micro(large_dataset_work),
<a name="319"/>  319:      micro(large_local_dataset_work),
<a name="320"/>  320:      micro(alloc),
<a name="321"/>  321:      micro(bif_dispatch),
<a name="322"/>  322:      micro(binary_h),
<a name="323"/>  323:      micro(ets),
<a name="324"/>  324:      micro(generic),
<a name="325"/>  325:      micro(int_arith),
<a name="326"/>  326:      micro(float_arith),
<a name="327"/>  327:      micro(fcalls),
<a name="328"/>  328:      micro(timer),
<a name="329"/>  329:      micro(links)
<a name="330"/>  330:     ].
<a name="331"/>  331: 
<a name="macro-2"/><a name="332"/>  332: <b>macro</b>(Ms,DataDir) -&gt;
<a name="333"/>  333:     statistics(reductions),
<a name="334"/>  334:     statistics(runtime),
<a name="335"/>  335:     lists(500),  %% fixup cache on first round
<a name="macro-last_expr"/><a name="336"/>  336: <b>    run_micros</b>(Ms,DataDir).
<a name="337"/>  337: 
<a name="run_micros-2"/><a name="338"/>  338: <b>run_micros</b>([],_) -&gt; 
<a name="339"/>  339:     io:nl(),
<a name="340"/>  340:     [];
<a name="341"/>  341: <b>run_micros</b>([H|T],DataDir) -&gt;
<a name="342"/>  342:     R = run_micro(H,DataDir),
<a name="run_micros-last_expr"/><a name="343"/>  343: <b>    [R| run_micros</b>(T,DataDir)].
<a name="344"/>  344: 
<a name="run_micro-2"/><a name="345"/>  345: <b>run_micro</b>(M,DataDir) -&gt;
<a name="346"/>  346:     Pid = spawn(?MODULE, run_micro, [self(),M,DataDir]),
<a name="347"/>  347:     Res = receive {Pid, Reply} -&gt; Reply end,
<a name="348"/>  348:     {value,{title,Title}} = lists:keysearch(title,1,Reply),
<a name="349"/>  349:     {value,{estones,Estones}} = lists:keysearch(estones,1,Reply),
<a name="350"/>  350:     erlang:display({Title,Estones}),
<a name="run_micro-last_expr"/><a name="351"/>  351:     Res.
<a name="352"/>  352:     
<a name="353"/>  353: 
<a name="run_micro-3"/><a name="354"/>  354: <b>run_micro</b>(Top, M, DataDir) -&gt;
<a name="355"/>  355:     EstoneCat = filename:join(DataDir,&quot;estone_cat&quot;),
<a name="356"/>  356:     put(estone_cat,EstoneCat),
<a name="run_micro-last_expr"/><a name="357"/>  357: <b>    Top ! {self</b>(),  apply_micro(M)}.
<a name="358"/>  358: 
<a name="apply_micro-1"/><a name="359"/>  359: <b>apply_micro</b>(M) -&gt;
<a name="360"/>  360:     {GC0, Words0, _} = statistics(garbage_collection),
<a name="361"/>  361:     statistics(reductions),
<a name="362"/>  362:     Before = monotonic_time(),
<a name="363"/>  363:     Compensate = apply_micro(M#micro.function, M#micro.loops),
<a name="364"/>  364:     After = monotonic_time(),
<a name="365"/>  365:     {GC1, Words1, _} = statistics(garbage_collection),
<a name="366"/>  366:     {_, Reds} = statistics(reductions),
<a name="367"/>  367:     Elapsed = subtr(Before, After),
<a name="368"/>  368:     MicroSecs = Elapsed - Compensate,
<a name="apply_micro-last_expr"/><a name="369"/>  369:     [{title, M#micro.str},
<a name="370"/>  370:      {tt1, M#micro.tt1},
<a name="371"/>  371:      {function, M#micro.function},
<a name="372"/>  372:      {weight_percentage, M#micro.weight},
<a name="373"/>  373:      {loops, M#micro.loops},
<a name="374"/>  374:      {microsecs,MicroSecs},
<a name="375"/>  375:      {estones, (M#micro.weight * M#micro.weight * ?STONEFACTOR) div max(1,MicroSecs)},
<a name="376"/>  376:      {gcs, GC1 - GC0},
<a name="377"/>  377:      {kilo_word_reclaimed, (Words1 - Words0) div 1000},
<a name="378"/>  378:      {kilo_reductions, Reds div 1000},
<a name="379"/>  379:      {gc_intensity, gci(max(1,Elapsed), GC1 - GC0, Words1 - Words0)}].
<a name="380"/>  380: 
<a name="monotonic_time-0"/><a name="381"/>  381: <b>monotonic_time</b>() -&gt;
<a name="monotonic_time-last_expr"/><a name="382"/>  382: <b>    try erlang:monotonic_time</b>() catch error:undef -&gt; erlang:now() end.
<a name="383"/>  383: 
<a name="subtr-2"/><a name="384"/>  384: <b>subtr</b>(Before, After) when is_integer(Before), is_integer(After) -&gt;
<a name="385"/>  385:     erlang:convert_time_unit(After-Before, native, 1000000);
<a name="386"/>  386: <b>subtr</b>({_,_,_}=Before, {_,_,_}=After) -&gt;
<a name="subtr-last_expr"/><a name="387"/>  387: <b>    timer:now_diff</b>(After, Before).
<a name="388"/>  388: 
<a name="gci-3"/><a name="389"/>  389: <b>gci</b>(Micros, Words, Gcs) -&gt;
<a name="gci-last_expr"/><a name="390"/>  390: <b>    </b>((256 * Gcs) / Micros) + (Words / Micros).
<a name="391"/>  391: 
<a name="apply_micro-2"/><a name="392"/>  392: <b>apply_micro</b>(Name, Loops) -&gt;
<a name="393"/>  393:     io:format(&quot;~w(~w)~n&quot;, [Name, Loops]),
<a name="apply_micro-last_expr"/><a name="394"/>  394: <b>    apply</b>(?MODULE, Name, [Loops]).
<a name="395"/>  395: 
<a name="396"/>  396: <i>%%%%%%%%%%%% micro bench manipulating lists. %%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="lists-1"/><a name="397"/>  397: <b>lists</b>(I) -&gt;
<a name="398"/>  398:     L1 = &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;,
<a name="399"/>  399:     L2 = &quot;aaaaaaaaaa&quot;,
<a name="lists-last_expr"/><a name="400"/>  400: <b>    lists</b>(I, L1, L2).
<a name="401"/>  401: 
<a name="lists-3"/><a name="402"/>  402: <b>lists</b>(0, _,_) -&gt;
<a name="403"/>  403:     0;
<a name="404"/>  404: <b>lists</b>(I, L1, L2) -&gt;
<a name="405"/>  405:     revt(10, L1),
<a name="406"/>  406:     appt(10, L1, L2),
<a name="lists-last_expr"/><a name="407"/>  407: <b>    lists</b>(I-1, L1, L2).
<a name="408"/>  408: 
<a name="revt-2"/><a name="409"/>  409: <b>revt</b>(0, _) -&gt; 
<a name="410"/>  410:     done;
<a name="411"/>  411: <b>revt</b>(I, L) -&gt; 
<a name="412"/>  412:     reverse(L),
<a name="revt-last_expr"/><a name="413"/>  413: <b>    revt</b>(I-1, L).
<a name="414"/>  414: 
<a name="reverse-1"/><a name="415"/>  415: <b>reverse</b>(L) -&gt;
<a name="reverse-last_expr"/><a name="416"/>  416: <b>    reverse</b>(L, []).
<a name="reverse-2"/><a name="417"/>  417: <b>reverse</b>([H|T], Ack) -&gt; reverse(T, [H|Ack]);
<a name="reverse-last_expr"/><a name="418"/>  418: <b>reverse</b>([], Ack) -&gt; Ack.
<a name="419"/>  419: 
<a name="append-2"/><a name="420"/>  420: <b>append</b>([H|T], L) -&gt;
<a name="421"/>  421:     [H | append(T, L)];
<a name="422"/>  422: <b>append</b>([], L) -&gt;
<a name="append-last_expr"/><a name="423"/>  423:     L.
<a name="424"/>  424: 
<a name="appt-3"/><a name="425"/>  425: <b>appt</b>(0, _L1, _L2) -&gt; ok;
<a name="426"/>  426: <b>appt</b>(I, L1, L2) -&gt;
<a name="427"/>  427:     append(L1, L2),
<a name="appt-last_expr"/><a name="428"/>  428: <b>    appt</b>(I-1, L1, L2).
<a name="429"/>  429: 
<a name="430"/>  430: 
<a name="431"/>  431: <i>%%%%%%%%%%%%%%% small message passing and ctxt switching %%%%%%%</i>
<a name="msgp-1"/><a name="432"/>  432: <b>msgp</b>(I) -&gt;
<a name="msgp-last_expr"/><a name="433"/>  433: <b>    msgp</b>(I, small()).
<a name="434"/>  434: 
<a name="msgp-2"/><a name="435"/>  435: <b>msgp</b>(0, _) -&gt; 
<a name="436"/>  436:     0;
<a name="437"/>  437: <b>msgp</b>(I, Msg) -&gt;
<a name="438"/>  438:     P1 = spawn(?MODULE, p1, [self()]),
<a name="439"/>  439:     P2 = spawn(?MODULE, p1, [P1]),
<a name="440"/>  440:     P3 = spawn(?MODULE, p1, [P2]),
<a name="441"/>  441:     P4 = spawn(?MODULE, p1, [P3]),
<a name="442"/>  442:     msgp_loop(100, P4, Msg),
<a name="msgp-last_expr"/><a name="443"/>  443: <b>    msgp</b>(I-1, Msg).
<a name="444"/>  444: 
<a name="p1-1"/><a name="445"/>  445: <b>p1</b>(To) -&gt;
<a name="p1-last_expr"/><a name="446"/>  446:     receive
<a name="447"/>  447: 	{_From, {message, X}} -&gt;
<a name="448"/>  448: 	    To ! {self(), {message, X}},
<a name="449"/>  449: 	    p1(To);
<a name="450"/>  450: 	stop -&gt;
<a name="451"/>  451: 	    To ! stop,
<a name="452"/>  452: 	    exit(normal)
<a name="453"/>  453:     end.
<a name="454"/>  454: 
<a name="msgp_loop-3"/><a name="455"/>  455: <b>msgp_loop</b>(0, P, _) -&gt;
<a name="456"/>  456:     P ! stop,
<a name="457"/>  457:     receive 
<a name="458"/>  458: 	stop -&gt; ok
<a name="459"/>  459:     end;
<a name="460"/>  460: <b>msgp_loop</b>(I, P, Msg) -&gt;
<a name="461"/>  461:     P ! {self(), {message, Msg}},
<a name="msgp_loop-last_expr"/><a name="462"/>  462:     receive
<a name="463"/>  463: 	{_From, {message, _}} -&gt;
<a name="464"/>  464: 	    msgp_loop(I-1, P, Msg)
<a name="465"/>  465:     end.
<a name="466"/>  466: 
<a name="467"/>  467: <i>%%%%%%%%%%%% large massage passing and ctxt switching %%%%%%%</i>
<a name="msgp_medium-1"/><a name="468"/>  468: <b>msgp_medium</b>(I) -&gt;
<a name="msgp_medium-last_expr"/><a name="469"/>  469: <b>        msgp_medium</b>(I, big()).
<a name="470"/>  470: 
<a name="msgp_medium-2"/><a name="471"/>  471: <b>msgp_medium</b>(0, _) -&gt; 
<a name="472"/>  472:     0;
<a name="473"/>  473: <b>msgp_medium</b>(I, Msg) -&gt;
<a name="474"/>  474:     P1 = spawn(?MODULE , p1, [self()]),
<a name="475"/>  475:     P2 = spawn(?MODULE, p1, [P1]),
<a name="476"/>  476:     P3 = spawn(?MODULE, p1, [P2]),
<a name="477"/>  477:     P4 = spawn(?MODULE, p1, [P3]),
<a name="478"/>  478:     msgp_loop(100, P4, Msg),
<a name="msgp_medium-last_expr"/><a name="479"/>  479: <b>    msgp_medium</b>(I-1, Msg).
<a name="480"/>  480: 
<a name="481"/>  481: 
<a name="482"/>  482: 
<a name="483"/>  483: <i>%%%%%%%%%%%% huge massage passing and ctxt switching %%%%%%%</i>
<a name="msgp_huge-1"/><a name="484"/>  484: <b>msgp_huge</b>(I) -&gt;
<a name="msgp_huge-last_expr"/><a name="485"/>  485: <b>        msgp_huge</b>(I, very_big(15)).
<a name="486"/>  486: 
<a name="msgp_huge-2"/><a name="487"/>  487: <b>msgp_huge</b>(0, _) -&gt; 
<a name="488"/>  488:     0;
<a name="489"/>  489: <b>msgp_huge</b>(I, Msg) -&gt;
<a name="490"/>  490:     P1 = spawn(?MODULE , p1, [self()]),
<a name="491"/>  491:     P4 = spawn(?MODULE, p1, [P1]),
<a name="492"/>  492:     msgp_loop(100, P4, Msg),
<a name="msgp_huge-last_expr"/><a name="493"/>  493: <b>    msgp_huge</b>(I-1, Msg).
<a name="494"/>  494: 
<a name="495"/>  495:     
<a name="496"/>  496: <i>%%%%%% typical protocol pattern matching %%%%%%%</i>
<a name="pattern-1"/><a name="497"/>  497: <b>pattern</b>(0) -&gt;
<a name="498"/>  498:     0;
<a name="499"/>  499: <b>pattern</b>(I) -&gt;
<a name="500"/>  500:     Tail = &quot;aaabbaaababba&quot;,
<a name="501"/>  501:     P1 = [0, 1,2,3,4,5|Tail],
<a name="502"/>  502:     pat_loop1(100, P1),
<a name="503"/>  503:     pat_loop2(100, P1),
<a name="504"/>  504:     pat_loop3(100, P1),
<a name="505"/>  505:     pat_loop4(100, P1),
<a name="506"/>  506:     pat_loop5(100, P1),
<a name="pattern-last_expr"/><a name="507"/>  507: <b>    pattern</b>(I-1).
<a name="508"/>  508: 
<a name="pat_loop1-2"/><a name="509"/>  509: <b>pat_loop1</b>(0, _) -&gt; 
<a name="510"/>  510:     ok;
<a name="511"/>  511: <b>pat_loop1</b>(_I, [_, _X, _Y, 0 |_T])  -&gt;
<a name="512"/>  512:     ok;
<a name="513"/>  513: <b>pat_loop1</b>(_I, [_, _X, _Y, 1| _T]) -&gt;
<a name="514"/>  514:     ok;
<a name="515"/>  515: <b>pat_loop1</b>(_I, [_, _X, _Y, 2 | _T]) -&gt; 
<a name="516"/>  516:     ok;
<a name="517"/>  517: <b>pat_loop1</b>(I, [_, X, Y, 3 | T]) -&gt;
<a name="pat_loop1-last_expr"/><a name="518"/>  518: <b>    pat_loop1</b>(I-1, [0, X,Y,3|T]).
<a name="519"/>  519: 
<a name="pat_loop2-2"/><a name="520"/>  520: <b>pat_loop2</b>(0, _) -&gt;
<a name="521"/>  521:     ok;
<a name="522"/>  522: <b>pat_loop2</b>(_I, [_X, Y | _Tail]) when Y bsl 1 == 0 -&gt;
<a name="523"/>  523:     ok;
<a name="524"/>  524: <b>pat_loop2</b>(_I, [_X, Y | _Tail]) when Y bsl 2 == 0 -&gt;
<a name="525"/>  525:     ok;
<a name="526"/>  526: <b>pat_loop2</b>(I, [X, Y | Tail]) when Y bsl 2 == 4 -&gt;
<a name="pat_loop2-last_expr"/><a name="527"/>  527: <b>    pat_loop2</b>(I-1, [X, Y |Tail]).
<a name="528"/>  528: 
<a name="529"/>  529: 
<a name="pat_loop3-2"/><a name="530"/>  530: <b>pat_loop3</b>(0, _) -&gt;
<a name="531"/>  531:     ok;
<a name="532"/>  532: <b>pat_loop3</b>(_I, [{c, h} | _Tail]) -&gt; 
<a name="533"/>  533:     ok;
<a name="534"/>  534: <b>pat_loop3</b>(_I, [1, 0 |_T]) -&gt;
<a name="535"/>  535:     ok;
<a name="536"/>  536: <b>pat_loop3</b>(_I, [X, _Y |_Tail]) when is_binary(X), size(X) == 1 -&gt;
<a name="537"/>  537:     ok;
<a name="538"/>  538: <b>pat_loop3</b>(_I, [no, _Y|_Tail]) -&gt; 
<a name="539"/>  539:     ok;
<a name="540"/>  540: <b>pat_loop3</b>(_I, []) -&gt;
<a name="541"/>  541:     ok;
<a name="542"/>  542: <b>pat_loop3</b>(_I, [X,_Y|_T]) when X /= 0 -&gt;
<a name="543"/>  543:     ok;
<a name="544"/>  544: <b>pat_loop3</b>(_I, [2,3|_T]) -&gt;
<a name="545"/>  545:     ok;
<a name="546"/>  546: <b>pat_loop3</b>(_I, [1, 2]) -&gt;
<a name="547"/>  547:     ok;
<a name="548"/>  548: <b>pat_loop3</b>(I, [0, 1 |T]) -&gt;
<a name="pat_loop3-last_expr"/><a name="549"/>  549: <b>    pat_loop3</b>(I-1, [0,1|T]).
<a name="550"/>  550: 
<a name="551"/>  551: 
<a name="pat_loop4-2"/><a name="552"/>  552: <b>pat_loop4</b>(0, _) -&gt;  ok;
<a name="553"/>  553: <b>pat_loop4</b>(_I, [20|_T]) -&gt; ok;
<a name="554"/>  554: <b>pat_loop4</b>(_I, [219|_T]) -&gt; ok;
<a name="555"/>  555: <b>pat_loop4</b>(_I, [18|_T]) -&gt; ok;
<a name="556"/>  556: <b>pat_loop4</b>(_I, [17|_T]) -&gt; ok;
<a name="557"/>  557: <b>pat_loop4</b>(_I, [16|_T]) -&gt; ok;
<a name="558"/>  558: <b>pat_loop4</b>(_I, [15|_T]) -&gt; ok;
<a name="559"/>  559: <b>pat_loop4</b>(_I, [14|_T]) -&gt; ok;
<a name="560"/>  560: <b>pat_loop4</b>(_I, [13|_T]) -&gt; ok;
<a name="561"/>  561: <b>pat_loop4</b>(_I, [12|_T]) -&gt; ok;
<a name="562"/>  562: <b>pat_loop4</b>(_I, [11|_T]) -&gt; ok;
<a name="563"/>  563: <b>pat_loop4</b>(_I, [10|_T]) -&gt; ok;
<a name="564"/>  564: <b>pat_loop4</b>(_I, [9|_T]) -&gt; ok;
<a name="565"/>  565: <b>pat_loop4</b>(_I, [8|_T]) -&gt; ok;
<a name="566"/>  566: <b>pat_loop4</b>(_I, [7|_T]) -&gt; ok;
<a name="567"/>  567: <b>pat_loop4</b>(_I, [6|_T]) -&gt; ok;
<a name="568"/>  568: <b>pat_loop4</b>(_I, [5|_T]) -&gt; ok;
<a name="569"/>  569: <b>pat_loop4</b>(_I, [4|_T]) -&gt; ok;
<a name="570"/>  570: <b>pat_loop4</b>(_I, [3|_T]) -&gt; ok;
<a name="571"/>  571: <b>pat_loop4</b>(_I, [1|_T]) -&gt; ok;
<a name="572"/>  572: <b>pat_loop4</b>(_I, [21|_T]) -&gt; ok;
<a name="573"/>  573: <b>pat_loop4</b>(_I, [22|_T]) -&gt; ok;
<a name="574"/>  574: <b>pat_loop4</b>(_I, [23|_T]) -&gt; ok;
<a name="575"/>  575: <b>pat_loop4</b>(_I, [24|_T]) -&gt; ok;
<a name="576"/>  576: <b>pat_loop4</b>(_I, [25|_T]) -&gt; ok;
<a name="577"/>  577: <b>pat_loop4</b>(_I, [26|_T]) -&gt; ok;
<a name="578"/>  578: <b>pat_loop4</b>(_I, [27|_T]) -&gt; ok;
<a name="579"/>  579: <b>pat_loop4</b>(I, [0|T]) -&gt; 
<a name="pat_loop4-last_expr"/><a name="580"/>  580: <b>    pat_loop4</b>(I-1, [0|T]).
<a name="581"/>  581: 
<a name="pat_loop5-2"/><a name="582"/>  582: <b>pat_loop5</b>(0, _) -&gt; ok;
<a name="583"/>  583: <b>pat_loop5</b>(_I, [0, 20|_T]) -&gt; ok;
<a name="584"/>  584: <b>pat_loop5</b>(_I, [0, 19|_T]) -&gt; ok;
<a name="585"/>  585: <b>pat_loop5</b>(_I, [0, 18|_T]) -&gt; ok;
<a name="586"/>  586: <b>pat_loop5</b>(_I, [0, 17|_T]) -&gt; ok;
<a name="587"/>  587: <b>pat_loop5</b>(_I, [0, 16|_T]) -&gt; ok;
<a name="588"/>  588: <b>pat_loop5</b>(_I, [0, 15|_T]) -&gt; ok;
<a name="589"/>  589: <b>pat_loop5</b>(_I, [0, 14|_T]) -&gt; ok;
<a name="590"/>  590: <b>pat_loop5</b>(_I, [0, 13|_T]) -&gt; ok;
<a name="591"/>  591: <b>pat_loop5</b>(_I, [0, 12|_T]) -&gt; ok;
<a name="592"/>  592: <b>pat_loop5</b>(_I, [0, 11|_T]) -&gt; ok;
<a name="593"/>  593: <b>pat_loop5</b>(_I, [0, 10|_T]) -&gt; ok;
<a name="594"/>  594: <b>pat_loop5</b>(_I, [0, 9|_T]) -&gt; ok;
<a name="595"/>  595: <b>pat_loop5</b>(_I, [0, 8|_T]) -&gt; ok;
<a name="596"/>  596: <b>pat_loop5</b>(_I, [0, 7|_T]) -&gt; ok;
<a name="597"/>  597: <b>pat_loop5</b>(_I, [0, 6|_T]) -&gt; ok;
<a name="598"/>  598: <b>pat_loop5</b>(I, [0, 1|T]) -&gt; 
<a name="pat_loop5-last_expr"/><a name="599"/>  599: <b>    pat_loop5</b>(I-1, [0,1|T]).
<a name="600"/>  600: 
<a name="601"/>  601: <i>%%%%%%%%%% term traversal representing simple pattern matchhing %%%</i>
<a name="602"/>  602: <i>%%%%%%%%%                              + some arith</i>
<a name="trav-1"/><a name="603"/>  603: <b>trav</b>(I) -&gt;
<a name="604"/>  604:     X = very_big(10),
<a name="trav-last_expr"/><a name="605"/>  605: <b>    trav</b>(I, X).
<a name="606"/>  606: 
<a name="trav-2"/><a name="607"/>  607: <b>trav</b>(0, _) -&gt; 0;
<a name="608"/>  608: <b>trav</b>(I, T) -&gt;
<a name="609"/>  609:     do_trav(T),
<a name="trav-last_expr"/><a name="610"/>  610: <b>    trav</b>(I-1, T).
<a name="611"/>  611: 
<a name="do_trav-1"/><a name="612"/>  612: <b>do_trav</b>(T) when is_tuple(T) -&gt;
<a name="613"/>  613:     tup_trav(T, 1, 1 + size(T));
<a name="614"/>  614: <b>do_trav</b>([H|T]) -&gt;
<a name="615"/>  615:     do_trav(H) + do_trav(T);
<a name="616"/>  616: <b>do_trav</b>(X) when is_integer(X) -&gt; 1;
<a name="do_trav-last_expr"/><a name="617"/>  617: <b>do_trav</b>(_X) -&gt; 0.
<a name="tup_trav-3"/><a name="618"/>  618: <b>tup_trav</b>(_T, P, P) -&gt; 0;
<a name="619"/>  619: <b>tup_trav</b>(T, P, End) -&gt;
<a name="tup_trav-last_expr"/><a name="620"/>  620: <b>    do_trav</b>(element(P, T)) + tup_trav(T, P+1, End).
<a name="621"/>  621: 
<a name="622"/>  622: 
<a name="623"/>  623: <i>%% Port I/O</i>
<a name="port_io-1"/><a name="624"/>  624: <b>port_io</b>(I) -&gt;
<a name="625"/>  625:     EstoneCat = get(estone_cat),
<a name="626"/>  626:     Before = monotonic_time(),
<a name="627"/>  627:     Pps = make_port_pids(5, I, EstoneCat),  %% 5 ports
<a name="628"/>  628:     send_procs(Pps, go),
<a name="629"/>  629:     After = monotonic_time(),
<a name="630"/>  630:     wait_for_pids(Pps),
<a name="port_io-last_expr"/><a name="631"/>  631: <b>    subtr</b>(Before, After).
<a name="632"/>  632: 
<a name="make_port_pids-3"/><a name="633"/>  633: <b>make_port_pids</b>(0, _, _) -&gt; 
<a name="634"/>  634:     [];
<a name="635"/>  635: <b>make_port_pids</b>(NoPorts, J, EstoneCat) -&gt;
<a name="make_port_pids-last_expr"/><a name="636"/>  636: <b>    [spawn</b>(?MODULE, ppp, [self(),J,EstoneCat]) | make_port_pids(NoPorts-1, J, EstoneCat)].
<a name="ppp-3"/><a name="637"/>  637: <b>ppp</b>(Top, I, EstoneCat) -&gt;
<a name="638"/>  638:     P = open_port({spawn, EstoneCat}, []),%% cat sits at the other end
<a name="639"/>  639:     Str = lists:duplicate(200, 88), %% 200 X'es
<a name="640"/>  640:     Cmd = {self(), {command, Str}},
<a name="641"/>  641:     receive
<a name="642"/>  642: 	go -&gt; ok
<a name="643"/>  643:     end,
<a name="644"/>  644:     ppp_loop(P, I, Cmd),
<a name="645"/>  645:     Cmd2 = {self(), {command, &quot;abcde&quot;}},
<a name="646"/>  646:     Res = ppp_loop(P, I, Cmd2),
<a name="647"/>  647:     P ! {self(), close},
<a name="648"/>  648:     receive
<a name="649"/>  649: 	{P, closed} -&gt;
<a name="650"/>  650: 	    closed
<a name="651"/>  651:     end,
<a name="ppp-last_expr"/><a name="652"/>  652: <b>    Top ! {self</b>(), Res}.
<a name="653"/>  653:     
<a name="ppp_loop-3"/><a name="654"/>  654: <b>ppp_loop</b>(_P, 0, _) -&gt;
<a name="655"/>  655:     ok;
<a name="656"/>  656: <b>ppp_loop</b>(P, I, Cmd) -&gt;
<a name="657"/>  657:     P ! Cmd,
<a name="ppp_loop-last_expr"/><a name="658"/>  658:     receive
<a name="659"/>  659: 	{P, _} -&gt;  %% no match
<a name="660"/>  660: 	    ppp_loop(P, I-1, Cmd)
<a name="661"/>  661:     end.
<a name="662"/>  662: 
<a name="663"/>  663: <i>%% Working with a very large non-working data set</i>
<a name="664"/>  664: <i>%% where the passive data resides in remote processes</i>
<a name="large_dataset_work-1"/><a name="665"/>  665: <b>large_dataset_work</b>(I) -&gt;
<a name="666"/>  666:     {Minus, Ps} = timer:tc(?MODULE, mk_big_procs, [?BIGPROCS]),
<a name="667"/>  667:     trav(I),
<a name="668"/>  668:     lists(I),
<a name="669"/>  669:     send_procs(Ps, stop),
<a name="large_dataset_work-last_expr"/><a name="670"/>  670:     Minus. %% Don't count time to create the big procs.
<a name="671"/>  671: 
<a name="mk_big_procs-1"/><a name="672"/>  672: <b>mk_big_procs</b>(0) -&gt; [];
<a name="673"/>  673: <b>mk_big_procs</b>(I) -&gt;
<a name="mk_big_procs-last_expr"/><a name="674"/>  674: <b>    [ mk_big_proc</b>()| mk_big_procs(I-1)].
<a name="675"/>  675: 
<a name="mk_big_proc-0"/><a name="676"/>  676: <b>mk_big_proc</b>() -&gt;
<a name="677"/>  677:     P = spawn(?MODULE, big_proc, []),
<a name="678"/>  678:     P ! {self(), running},
<a name="mk_big_proc-last_expr"/><a name="679"/>  679:     receive
<a name="680"/>  680: 	{P, yes} -&gt; P
<a name="681"/>  681:     end.
<a name="682"/>  682: 
<a name="big_proc-0"/><a name="683"/>  683: <b>big_proc</b>() -&gt;
<a name="684"/>  684:     X = very_big(?BIGPROC_SIZE), %% creates a big heap
<a name="685"/>  685:     Y = very_big(?BIGPROC_SIZE),
<a name="686"/>  686:     Z = very_big(?BIGPROC_SIZE),
<a name="687"/>  687: 
<a name="688"/>  688:     receive
<a name="689"/>  689: 	{From, running} -&gt;
<a name="690"/>  690: 	    From ! {self(), yes}
<a name="691"/>  691:     end,
<a name="big_proc-last_expr"/><a name="692"/>  692:     receive
<a name="693"/>  693: 	stop -&gt;
<a name="694"/>  694: 	    {X, Y, Z}  %% Can't be garbed away now by very (not super)
<a name="695"/>  695:                        %% smart compiler
<a name="696"/>  696:     end.
<a name="697"/>  697: 
<a name="698"/>  698: <i>%% Working with a large non-working data set</i>
<a name="699"/>  699: <i>%% where the data resides in the local process.</i>
<a name="large_local_dataset_work-1"/><a name="700"/>  700: <b>large_local_dataset_work</b>(I) -&gt;
<a name="701"/>  701:     {Minus, _Data} = timer:tc(?MODULE, very_big, [?BIGPROC_SIZE]),
<a name="702"/>  702:     trav(I),
<a name="703"/>  703:     lists(I),
<a name="large_local_dataset_work-last_expr"/><a name="704"/>  704:     Minus.
<a name="705"/>  705: 
<a name="706"/>  706: 
<a name="707"/>  707: <i>%% Fast allocation and also deallocation that is gc test</i>
<a name="708"/>  708: <i>%% Important to not let variable linger on the stack un-necessarily</i>
<a name="alloc-1"/><a name="709"/>  709: <b>alloc</b>(0) -&gt; 0;
<a name="710"/>  710: <b>alloc</b>(I) -&gt;
<a name="711"/>  711:     _X11 = very_big(),
<a name="712"/>  712:     _X12 = very_big(),
<a name="713"/>  713:     _X13 = very_big(),
<a name="714"/>  714:     _Z = [_X14 = very_big(),
<a name="715"/>  715: 	  _X15 = very_big(),
<a name="716"/>  716: 	  _X16 = very_big()],
<a name="717"/>  717:     _X17 = very_big(),
<a name="718"/>  718:     _X18 = very_big(),
<a name="719"/>  719:     _X19 = very_big(),
<a name="720"/>  720:     _X20 = very_big(),
<a name="721"/>  721:     _X21 = very_big(),
<a name="722"/>  722:     _X22 = very_big(),
<a name="723"/>  723:     _X23 = very_big(),
<a name="724"/>  724:     _X24 = very_big(),
<a name="alloc-last_expr"/><a name="725"/>  725: <b>    alloc</b>(I-1).
<a name="726"/>  726: 
<a name="727"/>  727: <i>%% Time to call bif's</i>
<a name="728"/>  728: <i>%% This benchmark was updated in OTP-24. I've tried to keep the</i>
<a name="729"/>  729: <i>%% number of stones is creates the same, but that is impossible</i>
<a name="730"/>  730: <i>%% to achieve across all platforms.</i>
<a name="bif_dispatch-1"/><a name="731"/>  731: <b>bif_dispatch</b>(0) -&gt;
<a name="732"/>  732:     0;
<a name="733"/>  733: <b>bif_dispatch</b>(I) -&gt;
<a name="734"/>  734:     put(mon,erlang:monitor(process,self())),
<a name="735"/>  735:     disp(),    disp(),    disp(),    disp(),    disp(),    disp(),
<a name="736"/>  736:     disp(),    disp(),    disp(),    disp(),    disp(),    disp(),
<a name="bif_dispatch-last_expr"/><a name="737"/>  737: <b>    bif_dispatch</b>(I-1).
<a name="738"/>  738: 
<a name="disp-0"/><a name="739"/>  739: <b>disp</b>() -&gt;
<a name="740"/>  740:     erts_debug:flat_size(true),
<a name="741"/>  741:     erts_debug:size_shared(true),
<a name="742"/>  742:     demonitor(get(mon)),
<a name="743"/>  743:     erts_debug:flat_size(true),
<a name="744"/>  744:     demonitor(get(mon)),
<a name="745"/>  745:     erts_debug:size_shared(true),
<a name="746"/>  746:     demonitor(get(mon)),
<a name="747"/>  747:     erts_debug:flat_size(true),
<a name="748"/>  748:     demonitor(get(mon)),
<a name="749"/>  749:     erts_debug:size_shared(true),
<a name="750"/>  750:     demonitor(get(mon)),
<a name="751"/>  751:     erts_debug:flat_size(true),
<a name="752"/>  752:     demonitor(get(mon)),
<a name="753"/>  753:     erts_debug:size_shared(true),
<a name="754"/>  754:     demonitor(get(mon)),
<a name="755"/>  755:     erts_debug:flat_size(true),
<a name="756"/>  756:     demonitor(get(mon)),
<a name="757"/>  757:     erts_debug:size_shared(true),
<a name="758"/>  758:     demonitor(get(mon)),
<a name="759"/>  759:     erts_debug:flat_size(true),
<a name="760"/>  760:     demonitor(get(mon)),
<a name="disp-last_expr"/><a name="761"/>  761: <b>    erts_debug:size_shared</b>(true).
<a name="762"/>  762: 
<a name="763"/>  763: <i>%% Generic server like behaviour</i>
<a name="generic-1"/><a name="764"/>  764: <b>generic</b>(I) -&gt;
<a name="765"/>  765:     register(funky, spawn(?MODULE, gserv, [funky, ?MODULE, [], []])),
<a name="generic-last_expr"/><a name="766"/>  766: <b>    g_loop</b>(I).
<a name="767"/>  767: 
<a name="g_loop-1"/><a name="768"/>  768: <b>g_loop</b>(0) -&gt;
<a name="769"/>  769:     exit(whereis(funky), kill),
<a name="770"/>  770:     0;
<a name="771"/>  771: <b>g_loop</b>(I) -&gt;
<a name="772"/>  772:     ?MODULE:req(funky, {call, [abc]}),
<a name="773"/>  773:     ?MODULE:req(funky, {call, [abc]}),
<a name="774"/>  774:     ?MODULE:req(funky, {call, [abc]}),
<a name="775"/>  775:     ?MODULE:req(funky, {call, [abc]}),
<a name="776"/>  776:     ?MODULE:req(funky, {call, [xyz]}),
<a name="777"/>  777:     ?MODULE:req(funky, {call, [abc]}),
<a name="778"/>  778:     ?MODULE:req(funky, {call, [abc]}),
<a name="779"/>  779:     ?MODULE:req(funky, {call, [abc]}),
<a name="780"/>  780:     ?MODULE:req(funky, {call, [abc]}),
<a name="781"/>  781:     ?MODULE:req(funky, {call, [abc]}),
<a name="782"/>  782:     ?MODULE:req(funky, {call, [abc]}),
<a name="783"/>  783:     ?MODULE:req(funky, {call, [abc]}),
<a name="784"/>  784:     ?MODULE:req(funky, {call, [abc]}),
<a name="785"/>  785:     ?MODULE:req(funky, {call, [abc]}),
<a name="786"/>  786:     ?MODULE:req(funky, {call, [abc]}),
<a name="787"/>  787:     ?MODULE:req(funky, {call, [xyz]}),
<a name="788"/>  788:     ?MODULE:req(funky, {call, [abc]}),
<a name="789"/>  789:     ?MODULE:req(funky, {call, [abc]}),
<a name="790"/>  790:     ?MODULE:req(funky, {call, [abc]}),
<a name="791"/>  791:     ?MODULE:req(funky, {call, [abc]}),
<a name="792"/>  792:     ?MODULE:req(funky, {call, [abc]}),
<a name="793"/>  793:     ?MODULE:req(funky, {call, [abc]}),
<a name="g_loop-last_expr"/><a name="794"/>  794: <b>    g_loop</b>(I-1).
<a name="795"/>  795: 
<a name="req-2"/><a name="796"/>  796: <b>req</b>(Name, Req) -&gt;
<a name="797"/>  797:     R = make_ref(),
<a name="798"/>  798:     Name ! {self(), R, Req},
<a name="req-last_expr"/><a name="799"/>  799:     receive
<a name="800"/>  800: 	{Name, R, Reply} -&gt; Reply
<a name="801"/>  801:     after 2000 -&gt;
<a name="802"/>  802: 	    exit(timeout)
<a name="803"/>  803:     end.
<a name="804"/>  804: 
<a name="gserv-4"/><a name="805"/>  805: <b>gserv</b>(Name, Mod, State, Debug) -&gt;
<a name="gserv-last_expr"/><a name="806"/>  806:     receive
<a name="807"/>  807: 	{From, Ref, {call, Req}} when Debug == [] -&gt;
<a name="808"/>  808: 	    case catch apply(Mod, handle_call, [From, State, Req]) of
<a name="809"/>  809: 		{reply, Reply, State2} -&gt;
<a name="810"/>  810: 		    From ! {Name, Ref, Reply},
<a name="811"/>  811: 		    gserv(Name, Mod, State2, Debug);
<a name="812"/>  812: 		{noreply, State2} -&gt;
<a name="813"/>  813: 		    gserv(Name, Mod, State2, Debug);
<a name="814"/>  814: 		{'EXIT', Reason} -&gt;
<a name="815"/>  815: 		    exit(Reason)
<a name="816"/>  816: 	    end;
<a name="817"/>  817: 	{_From, _Ref, _Req} when Debug /= [] -&gt;
<a name="818"/>  818: 	    exit(nodebug)
<a name="819"/>  819:     end.
<a name="820"/>  820: 
<a name="handle_call-3"/><a name="821"/>  821: <b>handle_call</b>(_From, _State, [xyz]) -&gt;
<a name="822"/>  822:     R = atom_to_list(xyz),
<a name="823"/>  823:     {reply, R, []};
<a name="824"/>  824: <b>handle_call</b>(_From, State, [abc]) -&gt;
<a name="825"/>  825:     R = 1 + 3,
<a name="handle_call-last_expr"/><a name="826"/>  826:     {reply, R, [R | State]}.
<a name="827"/>  827: 
<a name="828"/>  828: 		    
<a name="829"/>  829: 
<a name="830"/>  830: <i>%% Binary handling, creating, manipulating and sending binaries</i>
<a name="binary_h-1"/><a name="831"/>  831: <b>binary_h</b>(I) -&gt;
<a name="832"/>  832:     Before = monotonic_time(),
<a name="833"/>  833:     P = spawn(?MODULE, echo, [self()]),
<a name="834"/>  834:     B = list_to_binary(lists:duplicate(2000, 5)),
<a name="835"/>  835:     After = monotonic_time(),
<a name="836"/>  836:     Compensate = subtr(Before, After),
<a name="837"/>  837:     binary_h_2(I, P, B),
<a name="binary_h-last_expr"/><a name="838"/>  838:     Compensate.
<a name="839"/>  839:     
<a name="binary_h_2-3"/><a name="840"/>  840: <b>binary_h_2</b>(0, P, _B) -&gt;
<a name="841"/>  841:     exit(P, kill);
<a name="842"/>  842: <b>binary_h_2</b>(I, P, B) -&gt;
<a name="843"/>  843:     echo_loop(P, 20, B),
<a name="844"/>  844:     split_loop(B, {abc,1,2222,self(),&quot;ancnd&quot;}, 100),
<a name="binary_h_2-last_expr"/><a name="845"/>  845: <b>    binary_h_2</b>(I-1, P, B).
<a name="846"/>  846: 
<a name="split_loop-3"/><a name="847"/>  847: <b>split_loop</b>(_B, _, 0) -&gt; 
<a name="848"/>  848:     ok;
<a name="849"/>  849: <b>split_loop</b>(B, Term, I) -&gt;
<a name="850"/>  850:     {X, Y} = split_binary(B, I),
<a name="851"/>  851:     size(X),
<a name="852"/>  852:     binary_to_list(Y, 1, 2),
<a name="853"/>  853:     binary_to_term(term_to_binary(Term)),
<a name="split_loop-last_expr"/><a name="854"/>  854: <b>    split_loop</b>(B, Term, I-1).
<a name="855"/>  855:     
<a name="856"/>  856: 
<a name="echo_loop-3"/><a name="857"/>  857: <b>echo_loop</b>(_P, 0, _B) -&gt; 
<a name="858"/>  858:     k;
<a name="859"/>  859: <b>echo_loop</b>(P, I, B) -&gt;
<a name="860"/>  860:     P ! B,
<a name="861"/>  861:     P ! B,
<a name="862"/>  862:     P ! B,
<a name="863"/>  863:     P ! B,
<a name="864"/>  864:     P ! B,
<a name="865"/>  865:     P ! B,
<a name="866"/>  866:     P ! B,
<a name="867"/>  867:     P ! B,
<a name="868"/>  868:     P ! B,
<a name="869"/>  869:     P ! B,
<a name="870"/>  870:     receive _ -&gt; ok end,
<a name="871"/>  871:     receive _ -&gt; ok end,
<a name="872"/>  872:     receive _ -&gt; ok end,
<a name="873"/>  873:     receive _ -&gt; ok end,
<a name="874"/>  874:     receive _ -&gt; ok end,
<a name="875"/>  875:     receive _ -&gt; ok end,
<a name="876"/>  876:     receive _ -&gt; ok end,
<a name="877"/>  877:     receive _ -&gt; ok end,
<a name="878"/>  878:     receive _ -&gt; ok end,
<a name="879"/>  879:     receive _ -&gt; ok end,
<a name="echo_loop-last_expr"/><a name="880"/>  880: <b>    echo_loop</b>(P, I-1, B).
<a name="881"/>  881:     
<a name="882"/>  882: 
<a name="ets-1"/><a name="883"/>  883: <b>ets</b>(0) -&gt; 
<a name="884"/>  884:     0;
<a name="885"/>  885: <b>ets</b>(I) -&gt;
<a name="886"/>  886:     T1 = ets:new(a, [set]),
<a name="887"/>  887:     T2 = ets:new(c, [bag, private]),
<a name="888"/>  888:     L = [T1, T2],
<a name="889"/>  889:     run_tabs(L, L, 1),
<a name="890"/>  890:     ets:delete(T1),
<a name="891"/>  891:     ets:delete(T2),
<a name="ets-last_expr"/><a name="892"/>  892: <b>    ets</b>(I-1).
<a name="893"/>  893: 
<a name="run_tabs-3"/><a name="894"/>  894: <b>run_tabs</b>(_, _, 0) -&gt;
<a name="895"/>  895:     ok;
<a name="896"/>  896: <b>run_tabs</b>([], L, I) -&gt;
<a name="897"/>  897:     run_tabs(L, L, I-1);
<a name="898"/>  898: <b>run_tabs</b>([Tab|Tail], L, I) -&gt;
<a name="899"/>  899:     Begin = I * 20,
<a name="900"/>  900:     End = (I+1) * 20,
<a name="901"/>  901:     run_tab(Tab, Begin, End, I),
<a name="run_tabs-last_expr"/><a name="902"/>  902: <b>    run_tabs</b>(Tail, L, I).
<a name="903"/>  903: 
<a name="run_tab-4"/><a name="904"/>  904: <b>run_tab</b>(_Tab, X, X, _) -&gt;
<a name="905"/>  905:     ok;
<a name="906"/>  906: <b>run_tab</b>(Tab, Beg, End, J) -&gt;
<a name="907"/>  907:     ets:insert(Tab, {Beg, J}),
<a name="908"/>  908:     ets:insert(Tab, {J, Beg}),
<a name="909"/>  909:     ets:insert(Tab, {{foo,Beg}, J}),
<a name="910"/>  910:     ets:insert(Tab, {{foo, J}, Beg}),
<a name="911"/>  911:     ets:delete(Tab, haha),
<a name="912"/>  912:     ets:match_delete(Tab, {k, j}),
<a name="913"/>  913:     ets:match(Tab, {Beg, '$1'}),
<a name="914"/>  914:     ets:match(Tab, {'$1', J}),
<a name="915"/>  915:     ets:delete(Tab, Beg),
<a name="916"/>  916:     K = ets:first(Tab),
<a name="917"/>  917:     _K2 = ets:next(Tab, K),
<a name="run_tab-last_expr"/><a name="918"/>  918: <b>    run_tab</b>(Tab, Beg+1, End, J).
<a name="919"/>  919:     
<a name="920"/>  920:     
<a name="921"/>  921: <i>%%%% Integer arith %%%%%</i>
<a name="int_arith-1"/><a name="922"/>  922: <b>int_arith</b>(0) -&gt; 
<a name="923"/>  923:     0;
<a name="924"/>  924: <b>int_arith</b>(I) -&gt;
<a name="925"/>  925:     do_arith(I) +
<a name="926"/>  926:     do_arith(I) +
<a name="927"/>  927:     do_arith(I) +
<a name="928"/>  928:     do_arith(I) +
<a name="929"/>  929:     do_arith(I) +
<a name="930"/>  930:     do_arith(I) +
<a name="931"/>  931:     do_arith(I) +
<a name="932"/>  932:     do_arith(I) +
<a name="933"/>  933:     do_arith(I) +
<a name="934"/>  934: 	66,
<a name="int_arith-last_expr"/><a name="935"/>  935: <b>    int_arith</b>(I-1).
<a name="936"/>  936: 
<a name="do_arith-1"/><a name="937"/>  937: <b>do_arith</b>(I) -&gt;    
<a name="938"/>  938:     do_arith2(I) -
<a name="939"/>  939:     do_arith2(I) -
<a name="940"/>  940:     do_arith2(I) -
<a name="941"/>  941:     do_arith2(I) -
<a name="942"/>  942:     do_arith2(I) -
<a name="943"/>  943:     do_arith2(I) -
<a name="do_arith-last_expr"/><a name="944"/>  944: <b>    do_arith2</b>(I) -
<a name="945"/>  945: 	99.
<a name="946"/>  946: 
<a name="do_arith2-1"/><a name="947"/>  947: <b>do_arith2</b>(I) -&gt;
<a name="948"/>  948:     X = 23,
<a name="949"/>  949:     _Y = 789 + I,
<a name="950"/>  950:     Z = I + 1,
<a name="951"/>  951:     U = (X bsl 1 bsr I) * X div 2 bsr 4,
<a name="952"/>  952:     U1 = Z + Z + Z + Z + X bsl 4 * 2 bsl 2,
<a name="do_arith2-last_expr"/><a name="953"/>  953:     Z - U + U1 div 2.
<a name="954"/>  954: 
<a name="955"/>  955:     
<a name="956"/>  956: <i>%%%% Float arith %%%%%</i>
<a name="float_arith-1"/><a name="957"/>  957: <b>float_arith</b>(0) -&gt; 
<a name="958"/>  958:     0;
<a name="959"/>  959: <b>float_arith</b>(I) -&gt;
<a name="960"/>  960:     f_do_arith(I) +
<a name="961"/>  961:     f_do_arith(I) +
<a name="962"/>  962:     f_do_arith(I) +
<a name="963"/>  963:     f_do_arith(I) +
<a name="964"/>  964:     f_do_arith(I) +
<a name="965"/>  965:     f_do_arith(I) +
<a name="966"/>  966:     f_do_arith(I) +
<a name="967"/>  967:     f_do_arith(I) +
<a name="968"/>  968:     f_do_arith(I) +
<a name="969"/>  969: 	66,
<a name="float_arith-last_expr"/><a name="970"/>  970: <b>    float_arith</b>(I-1).
<a name="971"/>  971: 
<a name="f_do_arith-1"/><a name="972"/>  972: <b>f_do_arith</b>(I) -&gt;    
<a name="973"/>  973:     X = 23.4,
<a name="974"/>  974:     _Y = 789.99 + I,
<a name="975"/>  975:     Z = I + 1.88,
<a name="976"/>  976:     U = (X * 1 / I) * X / 2 * 4,
<a name="977"/>  977:     U1 = Z + Z + Z + Z + X * 4 * 2 / 2,
<a name="f_do_arith-last_expr"/><a name="978"/>  978:     Z - U + U1 / 2.
<a name="979"/>  979: 
<a name="980"/>  980: <i>%%%% time to do various function calls</i>
<a name="fcalls-1"/><a name="981"/>  981: <b>fcalls</b>(0) -&gt; 
<a name="982"/>  982:     0;
<a name="983"/>  983: <b>fcalls</b>(I) -&gt;
<a name="984"/>  984:     local0(400),
<a name="985"/>  985:     remote0(400),
<a name="986"/>  986:     app0(400),
<a name="987"/>  987:     local1(400),
<a name="988"/>  988:     remote1(400),
<a name="989"/>  989:     app1(400),
<a name="fcalls-last_expr"/><a name="990"/>  990: <b>    fcalls</b>(I-1).
<a name="991"/>  991: 
<a name="992"/>  992: 
<a name="local0-1"/><a name="993"/>  993: <b>local0</b>(0) -&gt; 0;
<a name="994"/>  994: <b>local0</b>(N) -&gt;
<a name="local0-last_expr"/><a name="995"/>  995: <b>    local0</b>(N-1).
<a name="996"/>  996: 
<a name="local1-1"/><a name="997"/>  997: <b>local1</b>(0) -&gt; 0;
<a name="998"/>  998: <b>local1</b>(N) -&gt;
<a name="local1-last_expr"/><a name="999"/>  999: <b>    1+local1</b>(N-1).
<a name="1000"/> 1000: 
<a name="remote0-1"/><a name="1001"/> 1001: <b>remote0</b>(0) -&gt; 0;
<a name="1002"/> 1002: <b>remote0</b>(N) -&gt;
<a name="remote0-last_expr"/><a name="1003"/> 1003: <b>    ?MODULE:remote0</b>(N-1).
<a name="1004"/> 1004: 
<a name="remote1-1"/><a name="1005"/> 1005: <b>remote1</b>(0) -&gt; 0;
<a name="1006"/> 1006: <b>remote1</b>(N) -&gt;
<a name="remote1-last_expr"/><a name="1007"/> 1007: <b>    1+?MODULE:remote1</b>(N-1).
<a name="1008"/> 1008: 
<a name="app0-1"/><a name="1009"/> 1009: <b>app0</b>(0) -&gt; 0;
<a name="1010"/> 1010: <b>app0</b>(N) -&gt;
<a name="app0-last_expr"/><a name="1011"/> 1011: <b>    apply</b>(?MODULE, app0, [N-1]).
<a name="1012"/> 1012: 
<a name="app1-1"/><a name="1013"/> 1013: <b>app1</b>(0) -&gt; 0;
<a name="1014"/> 1014: <b>app1</b>(N) -&gt;
<a name="app1-last_expr"/><a name="1015"/> 1015: <b>    1 + apply</b>(?MODULE, app1, [N-1]).
<a name="1016"/> 1016: 
<a name="1017"/> 1017: <i>%%%%%% jog the time queue implementation</i>
<a name="timer-1"/><a name="1018"/> 1018: <b>timer</b>(I) -&gt;
<a name="1019"/> 1019:     L = [50, 50, 50, 100, 1000, 3000, 8000, 50000, 100000],
<a name="timer-last_expr"/><a name="1020"/> 1020: <b>    timer</b>(I, L).
<a name="1021"/> 1021: 
<a name="timer-2"/><a name="1022"/> 1022: <b>timer</b>(0, _) -&gt; 0;
<a name="1023"/> 1023: <b>timer</b>(N, L) -&gt;
<a name="1024"/> 1024:     send_self(100),
<a name="1025"/> 1025:     recv(100,L, L),
<a name="timer-last_expr"/><a name="1026"/> 1026: <b>    timer</b>(N-1).
<a name="1027"/> 1027: 
<a name="recv-3"/><a name="1028"/> 1028: <b>recv</b>(0, _, _) -&gt;
<a name="1029"/> 1029:     ok;
<a name="1030"/> 1030: <b>recv</b>(N, [], L) -&gt;
<a name="1031"/> 1031:     recv(N, L, L);
<a name="1032"/> 1032: <b>recv</b>(N, [Timeout|Tail], L) -&gt;
<a name="recv-last_expr"/><a name="1033"/> 1033:     receive
<a name="1034"/> 1034:         hi_dude -&gt;
<a name="1035"/> 1035:             recv(N-1, Tail, L)
<a name="1036"/> 1036:     after Timeout -&gt;
<a name="1037"/> 1037:             io:format(&quot;XXXXX this wasn't supposed to happen???~n&quot;, []),
<a name="1038"/> 1038:             ok
<a name="1039"/> 1039:     end.
<a name="1040"/> 1040: 
<a name="send_self-1"/><a name="1041"/> 1041: <b>send_self</b>(0) -&gt;
<a name="1042"/> 1042:     ok;
<a name="1043"/> 1043: <b>send_self</b>(N) -&gt;
<a name="1044"/> 1044:     self() ! hi_dude,
<a name="send_self-last_expr"/><a name="1045"/> 1045: <b>    send_self</b>(N-1).
<a name="1046"/> 1046: 
<a name="1047"/> 1047: 
<a name="1048"/> 1048: <i>%%%%%%%%%%%% managing many links %%%%%</i>
<a name="links-1"/><a name="1049"/> 1049: <b>links</b>(I) -&gt;
<a name="1050"/> 1050:     L = mk_link_procs(100),
<a name="1051"/> 1051:     send_procs(L, {procs, L, I}),
<a name="1052"/> 1052:     wait_for_pids(L),
<a name="links-last_expr"/><a name="1053"/> 1053:     0.
<a name="1054"/> 1054: 
<a name="mk_link_procs-1"/><a name="1055"/> 1055: <b>mk_link_procs</b>(0) -&gt; 
<a name="1056"/> 1056:     [];
<a name="1057"/> 1057: <b>mk_link_procs</b>(I) -&gt;
<a name="mk_link_procs-last_expr"/><a name="1058"/> 1058: <b>    [spawn_link</b>(?MODULE, lproc, [self()]) | mk_link_procs(I-1)].
<a name="1059"/> 1059: 
<a name="1060"/> 1060: 
<a name="lproc-1"/><a name="1061"/> 1061: <b>lproc</b>(Top) -&gt;
<a name="1062"/> 1062:     process_flag(trap_exit,true),
<a name="lproc-last_expr"/><a name="1063"/> 1063:     receive
<a name="1064"/> 1064: 	{procs, Procs, I} -&gt;
<a name="1065"/> 1065: 	    Top ! {self(), lproc(Procs, Procs, link, I)}
<a name="1066"/> 1066:     end.
<a name="1067"/> 1067: 
<a name="lproc-4"/><a name="1068"/> 1068: <b>lproc</b>(_, _, _, 0) -&gt;
<a name="1069"/> 1069:     done;
<a name="1070"/> 1070: <b>lproc</b>([], Procs, link, I) -&gt;
<a name="1071"/> 1071:     lproc(Procs, Procs, unlink, I-1);
<a name="1072"/> 1072: <b>lproc</b>([], Procs, unlink, I) -&gt;
<a name="1073"/> 1073:     lproc(Procs, Procs, link, I-1);
<a name="1074"/> 1074: <b>lproc</b>([Pid|Tail], Procs, unlink, I) -&gt;
<a name="1075"/> 1075:     unlink(Pid),
<a name="1076"/> 1076:     lproc(Tail, Procs, unlink, I);
<a name="1077"/> 1077: <b>lproc</b>([Pid|Tail], Procs, link, I) -&gt;
<a name="1078"/> 1078:     link(Pid),
<a name="lproc-last_expr"/><a name="1079"/> 1079: <b>    lproc</b>(Tail, Procs, unlink, I).
<a name="1080"/> 1080: 
<a name="1081"/> 1081: 
<a name="1082"/> 1082: 
<a name="1083"/> 1083: <i>%%%%%%%%%%% various utility functions %%%%%%%</i>
<a name="1084"/> 1084: 
<a name="echo-1"/><a name="1085"/> 1085: <b>echo</b>(Pid) -&gt;
<a name="echo-last_expr"/><a name="1086"/> 1086:     receive
<a name="1087"/> 1087: 	X -&gt; Pid ! X,
<a name="1088"/> 1088: 	     echo(Pid)
<a name="1089"/> 1089:     end.
<a name="1090"/> 1090: 
<a name="very_big-0"/><a name="1091"/> 1091: <b>very_big</b>() -&gt; 
<a name="very_big-last_expr"/><a name="1092"/> 1092: <b>    very_big</b>(2).
<a name="very_big-1"/><a name="1093"/> 1093: <b>very_big</b>(0) -&gt; [];
<a name="1094"/> 1094: <b>very_big</b>(I) -&gt;
<a name="very_big-last_expr"/><a name="1095"/> 1095: <b>    {1,2,3,a,v,f,r,t,y,u,self</b>(), self(), self(), 
<a name="1096"/> 1096:      &quot;22222222222222222&quot;, {{&quot;234&quot;, self()}}, 
<a name="1097"/> 1097:      [[very_big(I-1)]]}.
<a name="1098"/> 1098:  
<a name="big-0"/><a name="1099"/> 1099: <b>big</b>() -&gt;
<a name="big-last_expr"/><a name="1100"/> 1100: <b>    {self</b>(), funky_stuff, baby, {1, [123, true,[]], &quot;abcdef&quot;}}.
<a name="1101"/> 1101: 
<a name="small-0"/><a name="small-last_expr"/><a name="1102"/> 1102: <b>small</b>() -&gt; {self(), true}.    
<a name="1103"/> 1103:     
<a name="1104"/> 1104: <i>%% Wait for a list of children to respond    </i>
<a name="wait_for_pids-1"/><a name="1105"/> 1105: <b>wait_for_pids</b>([]) -&gt; 
<a name="1106"/> 1106:     ok;
<a name="1107"/> 1107: <b>wait_for_pids</b>([P|Tail]) -&gt;
<a name="wait_for_pids-last_expr"/><a name="1108"/> 1108:     receive 
<a name="1109"/> 1109: 	{P, _Res} -&gt; wait_for_pids(Tail)
<a name="1110"/> 1110:     end.
<a name="1111"/> 1111: 
<a name="send_procs-2"/><a name="1112"/> 1112: <b>send_procs</b>([P|Tail], Msg) -&gt; P ! Msg, send_procs(Tail, Msg);
<a name="send_procs-last_expr"/><a name="1113"/> 1113: <b>send_procs</b>([], _) -&gt; ok.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
