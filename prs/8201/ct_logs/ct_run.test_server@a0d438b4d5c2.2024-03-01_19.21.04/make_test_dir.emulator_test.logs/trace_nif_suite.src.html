<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/trace_nif_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2010-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(trace_nif_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="24"/>   24: 
<a name="25"/>   25: <b>-export</b>([all/0, suite/0]).
<a name="26"/>   26: <b>-export</b>([trace_nif/1,
<a name="27"/>   27: 	 trace_nif_timestamp/1,
<a name="28"/>   28: 	 trace_nif_local/1,
<a name="29"/>   29: 	 trace_nif_meta/1,
<a name="30"/>   30: 	 trace_nif_timestamp_local/1,
<a name="31"/>   31: 	 trace_nif_return/1]).
<a name="32"/>   32: 
<a name="33"/>   33: <b>-export</b>([nif_process/0, nif/0, nif/1]).
<a name="34"/>   34: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="35"/>   35: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="36"/>   36: 
<a name="all-0"/><a name="37"/>   37: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="38"/>   38:     [trace_nif, trace_nif_timestamp, trace_nif_local,
<a name="39"/>   39:      trace_nif_meta, trace_nif_timestamp_local,
<a name="40"/>   40:      trace_nif_return].
<a name="41"/>   41: 
<a name="42"/>   42: <i>%% Test tracing NIFs.</i>
<a name="trace_nif-1"/><a name="43"/>   43: <b>trace_nif</b>(Config) when is_list(Config) -&gt;
<a name="44"/>   44:     load_nif(Config),
<a name="45"/>   45: 
<a name="trace_nif-last_expr"/><a name="46"/>   46: <b>    do_trace_nif</b>([]).
<a name="47"/>   47: 
<a name="48"/>   48: <i>%% Test tracing NIFs with local flag.</i>
<a name="trace_nif_local-1"/><a name="49"/>   49: <b>trace_nif_local</b>(Config) when is_list(Config) -&gt;
<a name="50"/>   50:     load_nif(Config),
<a name="trace_nif_local-last_expr"/><a name="51"/>   51: <b>    do_trace_nif</b>([local]).
<a name="52"/>   52: 
<a name="53"/>   53: <i>%% Test tracing NIFs with meta flag.</i>
<a name="trace_nif_meta-1"/><a name="54"/>   54: <b>trace_nif_meta</b>(Config) when is_list(Config) -&gt;
<a name="55"/>   55:     load_nif(Config),
<a name="56"/>   56:     Pid=spawn_link(?MODULE, nif_process, []),
<a name="57"/>   57:     erlang:trace_pattern({?MODULE,nif,'_'}, [], [meta]),
<a name="58"/>   58: 
<a name="59"/>   59:     Pid ! {apply_nif, nif, []},
<a name="60"/>   60:     receive_trace_msg_ts({trace_ts,Pid,call,{?MODULE,nif,[]}}),
<a name="61"/>   61: 
<a name="62"/>   62:     Pid ! {apply_nif, nif, [&quot;Arg1&quot;]},
<a name="63"/>   63:     receive_trace_msg_ts({trace_ts,Pid,call,
<a name="64"/>   64:                           {?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="65"/>   65: 
<a name="66"/>   66:     Pid ! {call_nif, nif, []},
<a name="67"/>   67:     receive_trace_msg_ts({trace_ts,Pid,call,
<a name="68"/>   68:                           {?MODULE,nif, []}}),
<a name="69"/>   69: 
<a name="70"/>   70:     Pid ! {call_nif, nif, [&quot;Arg1&quot;]},
<a name="71"/>   71:     receive_trace_msg_ts({trace_ts,Pid,call,
<a name="72"/>   72:                           {?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="trace_nif_meta-last_expr"/><a name="73"/>   73:     ok.
<a name="do_trace_nif-1"/><a name="74"/>   74: <b>do_trace_nif</b>(Flags) -&gt;
<a name="75"/>   75:     Pid = spawn_link(?MODULE, nif_process, []),
<a name="76"/>   76:     1 = erlang:trace(Pid, true, [call]),
<a name="77"/>   77:     erlang:trace_pattern({?MODULE,nif,'_'}, [], Flags),
<a name="78"/>   78:     Pid ! {apply_nif, nif, []},
<a name="79"/>   79:     receive_trace_msg({trace,Pid,call,{?MODULE,nif, []}}),
<a name="80"/>   80:     Pid ! {apply_nif, nif, [&quot;Arg1&quot;]},
<a name="81"/>   81:     receive_trace_msg({trace,Pid,call,{?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="82"/>   82: 
<a name="83"/>   83:     Pid ! {call_nif, nif, []},
<a name="84"/>   84:     receive_trace_msg({trace, Pid, call, {?MODULE,nif, []}}),
<a name="85"/>   85: 
<a name="86"/>   86:     Pid ! {call_nif, nif, [&quot;Arg1&quot;]},
<a name="87"/>   87:     receive_trace_msg({trace, Pid, call, {?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="88"/>   88: 
<a name="89"/>   89: 
<a name="90"/>   90:     %% Switch off
<a name="91"/>   91:     1 = erlang:trace(Pid, false, [call]),
<a name="92"/>   92: 
<a name="93"/>   93:     Pid ! {apply_nif, nif, []},
<a name="94"/>   94:     receive_nothing(),
<a name="95"/>   95:     Pid ! {apply_nif, nif, [&quot;Arg1&quot;]},
<a name="96"/>   96:     receive_nothing(),
<a name="97"/>   97:     Pid ! {call_nif, nif, []},
<a name="98"/>   98:     receive_nothing(),
<a name="99"/>   99:     Pid ! {call_nif, nif, [&quot;Arg1&quot;]},
<a name="100"/>  100:     receive_nothing(),
<a name="101"/>  101: 
<a name="102"/>  102:     %% Switch on again
<a name="103"/>  103:     1 = erlang:trace(Pid, true, [call]),
<a name="104"/>  104:     erlang:trace_pattern({?MODULE,nif,'_'}, [], Flags),
<a name="105"/>  105:     Pid ! {apply_nif, nif, []},
<a name="106"/>  106:     receive_trace_msg({trace,Pid,call,{?MODULE,nif, []}}),
<a name="107"/>  107:     Pid ! {apply_nif, nif, [&quot;Arg1&quot;]},
<a name="108"/>  108:     receive_trace_msg({trace,Pid,call,{?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="109"/>  109: 
<a name="110"/>  110:     Pid ! {call_nif, nif, []},
<a name="111"/>  111:     receive_trace_msg({trace, Pid, call, {?MODULE,nif, []}}),
<a name="112"/>  112: 
<a name="113"/>  113:     Pid ! {call_nif, nif, [&quot;Arg1&quot;]},
<a name="114"/>  114:     receive_trace_msg({trace, Pid, call, {?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="115"/>  115: 
<a name="116"/>  116:     1 = erlang:trace(Pid, false, [call]),
<a name="117"/>  117:     erlang:trace_pattern({?MODULE,nif,'_'}, false, Flags),
<a name="118"/>  118: 
<a name="119"/>  119:     unlink(Pid),
<a name="120"/>  120:     exit(Pid, die),
<a name="do_trace_nif-last_expr"/><a name="121"/>  121:     ok.
<a name="122"/>  122: 
<a name="123"/>  123: <i>%% Test tracing NIFs with timestamps.</i>
<a name="trace_nif_timestamp-1"/><a name="124"/>  124: <b>trace_nif_timestamp</b>(Config) when is_list(Config) -&gt;
<a name="125"/>  125:     load_nif(Config),
<a name="trace_nif_timestamp-last_expr"/><a name="126"/>  126: <b>    do_trace_nif_timestamp</b>([]).
<a name="127"/>  127: 
<a name="128"/>  128: <i>%% Test tracing NIFs with timestamps and local flag.</i>
<a name="trace_nif_timestamp_local-1"/><a name="129"/>  129: <b>trace_nif_timestamp_local</b>(Config) when is_list(Config) -&gt;
<a name="130"/>  130:     load_nif(Config),
<a name="trace_nif_timestamp_local-last_expr"/><a name="131"/>  131: <b>    do_trace_nif_timestamp</b>([local]).
<a name="132"/>  132: 
<a name="do_trace_nif_timestamp-1"/><a name="133"/>  133: <b>do_trace_nif_timestamp</b>(Flags) -&gt;
<a name="134"/>  134:     Pid = spawn_link(?MODULE, nif_process, []),
<a name="135"/>  135:     1 = erlang:trace(Pid, true, [call,timestamp]),
<a name="136"/>  136:     erlang:trace_pattern({?MODULE,nif,'_'}, [], Flags),
<a name="137"/>  137: 
<a name="138"/>  138:     Pid ! {apply_nif, nif, []},
<a name="139"/>  139:     receive_trace_msg_ts({trace_ts,Pid,call,{?MODULE,nif,[]}}),
<a name="140"/>  140: 
<a name="141"/>  141:     Pid ! {apply_nif, nif, [&quot;Arg1&quot;]},
<a name="142"/>  142:     receive_trace_msg_ts({trace_ts,Pid,call,
<a name="143"/>  143:                           {?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="144"/>  144: 
<a name="145"/>  145:     Pid ! {call_nif, nif, []},
<a name="146"/>  146:     receive_trace_msg_ts({trace_ts,Pid,call,
<a name="147"/>  147:                           {?MODULE,nif, []}}),
<a name="148"/>  148: 
<a name="149"/>  149:     Pid ! {call_nif, nif, [&quot;Arg1&quot;]},
<a name="150"/>  150:     receive_trace_msg_ts({trace_ts,Pid,call,
<a name="151"/>  151:                           {?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="152"/>  152: 
<a name="153"/>  153:     %% We should be able to turn off the timestamp.
<a name="154"/>  154:     1 = erlang:trace(Pid, false, [timestamp]),
<a name="155"/>  155: 
<a name="156"/>  156:     Pid ! {call_nif, nif, []},
<a name="157"/>  157:     receive_trace_msg({trace,Pid,call,
<a name="158"/>  158:                        {?MODULE,nif, []}}),
<a name="159"/>  159: 
<a name="160"/>  160:     Pid ! {apply_nif, nif, [&quot;tjoho&quot;]},
<a name="161"/>  161:     receive_trace_msg({trace,Pid,call,
<a name="162"/>  162:                        {?MODULE,nif, [&quot;tjoho&quot;]}}),
<a name="163"/>  163: 
<a name="164"/>  164:     1 = erlang:trace(Pid, false, [call]),
<a name="165"/>  165:     erlang:trace_pattern({erlang,'_','_'}, false, Flags),
<a name="166"/>  166: 
<a name="167"/>  167:     unlink(Pid),
<a name="168"/>  168:     exit(Pid, die),
<a name="do_trace_nif_timestamp-last_expr"/><a name="169"/>  169:     ok.
<a name="170"/>  170: 
<a name="171"/>  171: <i>%% Test tracing NIF's with return/return_to trace.</i>
<a name="trace_nif_return-1"/><a name="172"/>  172: <b>trace_nif_return</b>(Config) when is_list(Config) -&gt;
<a name="173"/>  173:     load_nif(Config),
<a name="174"/>  174: 
<a name="175"/>  175:     Pid = spawn_link(?MODULE, nif_process, []),
<a name="176"/>  176:     1 = erlang:trace(Pid, true, [call,timestamp,return_to]),
<a name="177"/>  177:     erlang:trace_pattern({?MODULE,nif,'_'}, [{'_',[],[{return_trace}]}], 
<a name="178"/>  178:                          [local]),
<a name="179"/>  179: 
<a name="180"/>  180:     Pid ! {apply_nif, nif, []},
<a name="181"/>  181:     receive_trace_msg_ts({trace_ts,Pid,call,{?MODULE,nif,[]}}),
<a name="182"/>  182:     receive_trace_msg_ts_return_from({trace_ts,Pid,return_from,
<a name="183"/>  183:                                       {?MODULE,nif,0}}),
<a name="184"/>  184:     receive_trace_msg_ts_return_to({trace_ts,Pid,return_to, 
<a name="185"/>  185:                                     {?MODULE, nif_process,0}}),
<a name="186"/>  186: 
<a name="187"/>  187:     Pid ! {call_nif, nif, [&quot;Arg1&quot;]},
<a name="188"/>  188:     receive_trace_msg_ts({trace_ts,Pid,call,
<a name="189"/>  189:                           {?MODULE,nif, [&quot;Arg1&quot;]}}),
<a name="190"/>  190:     receive_trace_msg_ts_return_from({trace_ts,Pid,return_from,
<a name="191"/>  191:                                       {?MODULE,nif,1}}),
<a name="192"/>  192:     receive_trace_msg_ts_return_to({trace_ts,Pid,return_to, 
<a name="193"/>  193:                                     {?MODULE, nif_process,0}}),
<a name="trace_nif_return-last_expr"/><a name="194"/>  194:     ok.
<a name="195"/>  195: 
<a name="196"/>  196: 
<a name="receive_trace_msg-1"/><a name="197"/>  197: <b>receive_trace_msg</b>(Mess) -&gt;
<a name="receive_trace_msg-last_expr"/><a name="198"/>  198:     receive
<a name="199"/>  199:         Mess -&gt;
<a name="200"/>  200:             ok;
<a name="201"/>  201:         Other -&gt;
<a name="202"/>  202:             ct:fail(&quot;Expected: ~p,~nGot: ~p~n&quot;, [Mess, Other])
<a name="203"/>  203:     after 5000 -&gt;
<a name="204"/>  204:               ct:fail(&quot;Expected: ~p,~nGot: timeout~n&quot;, [Mess])
<a name="205"/>  205:     end.
<a name="206"/>  206: 
<a name="receive_nothing-0"/><a name="207"/>  207: <b>receive_nothing</b>() -&gt;
<a name="receive_nothing-last_expr"/><a name="208"/>  208:     timeout = receive M -&gt; M after 100 -&gt; timeout end.
<a name="209"/>  209: 
<a name="receive_trace_msg_ts-1"/><a name="210"/>  210: <b>receive_trace_msg_ts</b>({trace_ts, Pid, call, {M,F,A}}) -&gt;
<a name="receive_trace_msg_ts-last_expr"/><a name="211"/>  211:     receive
<a name="212"/>  212:         {trace_ts, Pid, call, {M, F, A}, _Ts} -&gt;
<a name="213"/>  213:             ok;
<a name="214"/>  214:         Other -&gt;
<a name="215"/>  215:             ct:fail(&quot;Expected: {trace, ~p, call, {~p, ~p, ~p}, TimeStamp}},~n&quot;
<a name="216"/>  216:                     &quot;Got: ~p~n&quot;, [Pid, M, F, A, Other])
<a name="217"/>  217:     after 5000 -&gt;
<a name="218"/>  218:               ct:fail(&quot;Got timeout~n&quot;, [])
<a name="219"/>  219:     end.
<a name="220"/>  220: 
<a name="receive_trace_msg_ts_return_from-1"/><a name="221"/>  221: <b>receive_trace_msg_ts_return_from</b>({trace_ts, Pid, return_from, {M,F,A}}) -&gt;
<a name="receive_trace_msg_ts_return_from-last_expr"/><a name="222"/>  222:     receive
<a name="223"/>  223:         {trace_ts, Pid, return_from, {M, F, A}, _Value, _Ts} -&gt;
<a name="224"/>  224:             ok;
<a name="225"/>  225:         Other -&gt;
<a name="226"/>  226:             ct:fail(&quot;Expected: {trace_ts, ~p, return_from, {~p, ~p, ~p}, Value, TimeStamp}},~n&quot;
<a name="227"/>  227:                     &quot;Got: ~p~n&quot;, [Pid, M, F, A, Other])
<a name="228"/>  228:     after 5000 -&gt;
<a name="229"/>  229:               ct:fail(&quot;Got timeout~n&quot;, [])
<a name="230"/>  230:     end.
<a name="231"/>  231: 
<a name="receive_trace_msg_ts_return_to-1"/><a name="232"/>  232: <b>receive_trace_msg_ts_return_to</b>({trace_ts, Pid, return_to, {M,F,A}}) -&gt;
<a name="receive_trace_msg_ts_return_to-last_expr"/><a name="233"/>  233:     receive
<a name="234"/>  234:         {trace_ts, Pid, return_to, {M, F, A}, _Ts} -&gt;
<a name="235"/>  235:             ok;
<a name="236"/>  236:         Other -&gt;
<a name="237"/>  237:             ct:fail(&quot;Expected: {trace_ts, ~p, return_to, {~p, ~p, ~p}, TimeStamp}},~n&quot;
<a name="238"/>  238:                     &quot;Got: ~p~n&quot;, [Pid, M, F, A, Other])
<a name="239"/>  239:     after 5000 -&gt;
<a name="240"/>  240:               ct:fail(&quot;Got timeout~n&quot;, [])
<a name="241"/>  241:     end.
<a name="242"/>  242: 
<a name="nif_process-0"/><a name="243"/>  243: <b>nif_process</b>() -&gt;
<a name="244"/>  244:     receive
<a name="245"/>  245:         {apply_nif, Name, Args} -&gt;
<a name="246"/>  246:             {ok,Args} = apply(?MODULE, Name, Args);
<a name="247"/>  247: 
<a name="248"/>  248:         {call_nif, Name, []} -&gt;
<a name="249"/>  249:             {ok, []} = ?MODULE:Name();
<a name="250"/>  250: 
<a name="251"/>  251:         {call_nif, Name, [A1]} -&gt;
<a name="252"/>  252:             {ok, [A1]} = ?MODULE:Name(A1);
<a name="253"/>  253: 
<a name="254"/>  254:         {call_nif, Name, [A1,A2]} -&gt;
<a name="255"/>  255:             {ok,[A1,A2]} = ?MODULE:Name(A1,A2);
<a name="256"/>  256: 
<a name="257"/>  257:         {call_nif, Name, [A1,A2,A3]} -&gt;
<a name="258"/>  258:             {ok,[A1,A2,A3]} = ?MODULE:Name(A1,A2,A3)    
<a name="259"/>  259:     end,
<a name="nif_process-last_expr"/><a name="260"/>  260: <b>    nif_process</b>().    
<a name="261"/>  261: 
<a name="load_nif-1"/><a name="262"/>  262: <b>load_nif</b>(Config) -&gt;    
<a name="load_nif-last_expr"/><a name="263"/>  263: <b>    case is_nif_loaded</b>() of
<a name="264"/>  264:         true -&gt;
<a name="265"/>  265:             ok;
<a name="266"/>  266:         false -&gt;
<a name="267"/>  267:             Path = proplists:get_value(data_dir, Config),
<a name="268"/>  268:             ok = erlang:load_nif(filename:join(Path,&quot;trace_nif&quot;), 0)
<a name="269"/>  269:     end.
<a name="270"/>  270: 
<a name="is_nif_loaded-0"/><a name="271"/>  271: <b>is_nif_loaded</b>() -&gt;
<a name="is_nif_loaded-last_expr"/><a name="272"/>  272:     false.
<a name="273"/>  273: 
<a name="nif-0"/><a name="274"/>  274: <b>nif</b>() -&gt;
<a name="nif-last_expr"/><a name="275"/>  275: <b>    {&quot;Stub0&quot;,[]}. %exit</b>(&quot;nif/0 stub called&quot;).
<a name="276"/>  276: 
<a name="nif-1"/><a name="277"/>  277: <b>nif</b>(A1) -&gt;
<a name="nif-last_expr"/><a name="278"/>  278: <b>    {&quot;Stub1&quot;,[A1]}. %exit</b>([&quot;nif/1 stub called&quot;,A1]).
</pre>
</body>
</html>
