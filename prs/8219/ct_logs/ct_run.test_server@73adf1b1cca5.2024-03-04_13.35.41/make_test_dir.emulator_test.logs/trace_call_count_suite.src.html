<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/trace_call_count_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2002-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22"/>   22: <i>%%%</i>
<a name="23"/>   23: <i>%%% Define to run outside of test server</i>
<a name="24"/>   24: <i>%%%</i>
<a name="25"/>   25: <i>%%% -define(STANDALONE,1).</i>
<a name="26"/>   26: <i>%%%</i>
<a name="27"/>   27: <i>%%%</i>
<a name="28"/>   28: <i>%%% Define for debug output</i>
<a name="29"/>   29: <i>%%%</i>
<a name="30"/>   30: <i>%%% -define(debug,1).</i>
<a name="31"/>   31: 
<a name="32"/>   32: <b>-module</b>(trace_call_count_SUITE).
<a name="33"/>   33: 
<a name="34"/>   34: <i>%% Exported end user tests</i>
<a name="35"/>   35: <b>-export</b>([basic_test/0, on_and_off_test/0, info_test/0, 
<a name="36"/>   36: 	 pause_and_restart_test/0, combo_test/0]).
<a name="37"/>   37: 
<a name="38"/>   38: <i>%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="39"/>   39: <i>%% Test server related stuff</i>
<a name="40"/>   40: <i>%%</i>
<a name="41"/>   41: 
<a name="42"/>   42: <b>-ifdef</b>(STANDALONE).
<a name="43"/>   43: <b>-define</b>(config(A,B),config(A,B)).
<a name="44"/>   44: <b>-export</b>([config/2]).
<a name="45"/>   45: -else.
<a name="46"/>   46: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="47"/>   47: -endif.
<a name="48"/>   48:  
<a name="49"/>   49: <b>-ifdef</b>(debug).
<a name="50"/>   50: <b>-ifdef</b>(STANDALONE).
<a name="51"/>   51: <b>-define</b>(line, erlang:display({?MODULE,?LINE}), ).
<a name="52"/>   52: -endif.
<a name="53"/>   53: <b>-define</b>(dbgformat(A,B),io:format(A,B)).
<a name="54"/>   54: -else.
<a name="55"/>   55: <b>-ifdef</b>(STANDALONE).
<a name="56"/>   56: <b>-define</b>(line, noop, ).
<a name="57"/>   57: -endif.
<a name="58"/>   58: <b>-define</b>(dbgformat(A,B),noop).
<a name="59"/>   59: -endif.
<a name="60"/>   60:  
<a name="61"/>   61: <b>-ifdef</b>(STANDALONE).
<a name="62"/>   62: config(priv_dir,_) -&gt;
<a name="63"/>   63:     &quot;.&quot;.
<a name="64"/>   64: -else.
<a name="65"/>   65: <i>%% When run in test server.</i>
<a name="66"/>   66: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1, 
<a name="67"/>   67: 	 init_per_group/2,end_per_group/2, 
<a name="68"/>   68: 	 init_per_testcase/2, end_per_testcase/2]).
<a name="69"/>   69: <b>-export</b>([basic/1, on_and_off/1, info/1, 
<a name="70"/>   70: 	 pause_and_restart/1, combo/1]).
<a name="71"/>   71: 	 
<a name="init_per_testcase-2"/><a name="72"/>   72: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="73"/>   73:     Config.
<a name="74"/>   74: 
<a name="end_per_testcase-2"/><a name="75"/>   75: <b>end_per_testcase</b>(_Case, _Config) -&gt;
<a name="76"/>   76:     erlang:trace_pattern({'_','_','_'}, false, [local,meta,call_count]),
<a name="77"/>   77:     erlang:trace_pattern(on_load, false, [local,meta,call_count]),
<a name="78"/>   78:     erlang:trace(all, false, [all]),
<a name="end_per_testcase-last_expr"/><a name="79"/>   79:     ok.
<a name="80"/>   80: 
<a name="suite-0"/><a name="81"/>   81: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="82"/>   82:     [{ct_hooks,[ts_install_cth]},
<a name="83"/>   83:      {timetrap, {minutes, 4}}].
<a name="84"/>   84: 
<a name="all-0"/><a name="85"/>   85: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="86"/>   86:     [basic, on_and_off, info, pause_and_restart, combo].
<a name="87"/>   87: 
<a name="groups-0"/><a name="88"/>   88: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="89"/>   89:     [].
<a name="90"/>   90: 
<a name="init_per_suite-1"/><a name="91"/>   91: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="92"/>   92:     Config.
<a name="93"/>   93: 
<a name="end_per_suite-1"/><a name="94"/>   94: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="95"/>   95:     ok.
<a name="96"/>   96: 
<a name="init_per_group-2"/><a name="97"/>   97: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="98"/>   98:     Config.
<a name="99"/>   99: 
<a name="end_per_group-2"/><a name="100"/>  100: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="101"/>  101:     Config.
<a name="102"/>  102: 
<a name="103"/>  103: 
<a name="104"/>  104: <i>%% Tests basic call count trace</i>
<a name="basic-1"/><a name="105"/>  105: <b>basic</b>(Config) when is_list(Config) -&gt;
<a name="basic-last_expr"/><a name="106"/>  106: <b>    basic_test</b>().
<a name="107"/>  107: 
<a name="108"/>  108: <i>%% Tests turning trace parameters on and off</i>
<a name="on_and_off-1"/><a name="109"/>  109: <b>on_and_off</b>(Config) when is_list(Config) -&gt;
<a name="on_and_off-last_expr"/><a name="110"/>  110: <b>    on_and_off_test</b>().
<a name="111"/>  111:  
<a name="112"/>  112: <i>%% Tests the trace_info BIF</i>
<a name="info-1"/><a name="113"/>  113: <b>info</b>(Config) when is_list(Config) -&gt;
<a name="info-last_expr"/><a name="114"/>  114: <b>    info_test</b>().
<a name="115"/>  115:  
<a name="116"/>  116: <i>%% Tests pausing and restarting call counters</i>
<a name="pause_and_restart-1"/><a name="117"/>  117: <b>pause_and_restart</b>(Config) when is_list(Config) -&gt;
<a name="pause_and_restart-last_expr"/><a name="118"/>  118: <b>    pause_and_restart_test</b>().
<a name="119"/>  119:  
<a name="120"/>  120: <i>%% Tests combining local call trace and meta trace with call count trace</i>
<a name="combo-1"/><a name="121"/>  121: <b>combo</b>(Config) when is_list(Config) -&gt;
<a name="combo-last_expr"/><a name="122"/>  122: <b>    combo_test</b>().
<a name="123"/>  123: 
<a name="124"/>  124: <b>-endif. %-ifdef</b>(STANDALONE). ... -else.
<a name="125"/>  125: 
<a name="126"/>  126: <i>%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="127"/>  127: <i>%% Result examination macros</i>
<a name="128"/>  128: 
<a name="129"/>  129: <b>-define</b>(CT(P,MFA),{trace,P,call,MFA}).
<a name="130"/>  130: <b>-define</b>(CTT(P, MFA),{trace_ts,P,call,MFA,{_,_,_}}).
<a name="131"/>  131: <b>-define</b>(RF(P,MFA,V),{trace,P,return_from,MFA,V}).
<a name="132"/>  132: <b>-define</b>(RFT(P,MFA,V),{trace_ts,P,return_from,MFA,V,{_,_,_}}).
<a name="133"/>  133: <b>-define</b>(RT(P,MFA),{trace,P,return_to,MFA}).
<a name="134"/>  134: <b>-define</b>(RTT(P,MFA),{trace_ts,P,return_to,MFA,{_,_,_}}).
<a name="135"/>  135: 
<a name="136"/>  136: <i>%%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="137"/>  137: <i>%%% The Tests</i>
<a name="138"/>  138: <i>%%%</i>
<a name="139"/>  139: 
<a name="basic_test-0"/><a name="140"/>  140: <b>basic_test</b>() -&gt;
<a name="141"/>  141:     P = erlang:trace_pattern({'_','_','_'}, false, [call_count]),
<a name="142"/>  142:     M = 1000,
<a name="143"/>  143:     %%
<a name="144"/>  144:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, true, [call_count]),
<a name="145"/>  145:     2 = erlang:trace_pattern({?MODULE,seq_r,'_'}, true, [call_count]),
<a name="146"/>  146:     L = seq(1, M, fun(X) -&gt; X+1 end),
<a name="147"/>  147:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="148"/>  148:     {call_count,0} = erlang:trace_info({?MODULE,seq_r,3}, call_count),
<a name="149"/>  149:     Lr = seq_r(1, M, fun(X) -&gt; X+1 end),
<a name="150"/>  150:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="151"/>  151:     {call_count,1} = erlang:trace_info({?MODULE,seq_r,3}, call_count),
<a name="152"/>  152:     {call_count,M} = erlang:trace_info({?MODULE,seq_r,4}, call_count),
<a name="153"/>  153:     L = lists:reverse(Lr),
<a name="154"/>  154:     %%
<a name="155"/>  155:     P = erlang:trace_pattern({'_','_','_'}, false, [call_count]),
<a name="basic_test-last_expr"/><a name="156"/>  156:     ok.
<a name="157"/>  157: 
<a name="158"/>  158: <i>%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="159"/>  159: 
<a name="on_and_off_test-0"/><a name="160"/>  160: <b>on_and_off_test</b>() -&gt;
<a name="161"/>  161:     P = erlang:trace_pattern({'_','_','_'}, false, [call_count]),
<a name="162"/>  162:     M = 100,
<a name="163"/>  163:     %%
<a name="164"/>  164:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, true, [call_count]),
<a name="165"/>  165:     L = seq(1, M, fun(X) -&gt; X+1 end),
<a name="166"/>  166:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="167"/>  167:     N = erlang:trace_pattern({?MODULE,'_','_'}, true, [call_count]),
<a name="168"/>  168:     L = seq(1, M, fun(X) -&gt; X+1 end),
<a name="169"/>  169:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="170"/>  170:     P = erlang:trace_pattern({'_','_','_'}, true, [call_count]),
<a name="171"/>  171:     L = seq(1, M, fun(X) -&gt; X+1 end),
<a name="172"/>  172:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="173"/>  173:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, false, [call_count]),
<a name="174"/>  174:     {call_count,false} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="175"/>  175:     L = seq(1, M, fun(X) -&gt; X+1 end),
<a name="176"/>  176:     {call_count,false} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="177"/>  177:     {call_count,0} = erlang:trace_info({?MODULE,seq_r,4}, call_count),
<a name="178"/>  178:     Lr = seq_r(1, M, fun(X) -&gt; X+1 end),
<a name="179"/>  179:     {call_count,M} = erlang:trace_info({?MODULE,seq_r,4}, call_count),
<a name="180"/>  180:     N = erlang:trace_pattern({?MODULE,'_','_'}, false, [call_count]),
<a name="181"/>  181:     {call_count,false} = erlang:trace_info({?MODULE,seq_r,4}, call_count),
<a name="182"/>  182:     Lr = seq_r(1, M, fun(X) -&gt; X+1 end),
<a name="183"/>  183:     {call_count,false} = erlang:trace_info({?MODULE,seq_r,4}, call_count),
<a name="184"/>  184:     L = lists:reverse(Lr),
<a name="185"/>  185:     %%
<a name="186"/>  186:     P = erlang:trace_pattern({'_','_','_'}, false, [call_count]),
<a name="on_and_off_test-last_expr"/><a name="187"/>  187:     ok.
<a name="188"/>  188: 
<a name="189"/>  189: <i>%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="190"/>  190: 
<a name="info_test-0"/><a name="191"/>  191: <b>info_test</b>() -&gt;
<a name="192"/>  192:     P = erlang:trace_pattern({'_','_','_'}, false, [call_count]),
<a name="193"/>  193:     %%
<a name="194"/>  194:     1 = erlang:trace_pattern({?MODULE,seq,3}, true, [call_count]),
<a name="195"/>  195:     {call_count,0} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="196"/>  196:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, pause, [call_count]),
<a name="197"/>  197:     {call_count,0} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="198"/>  198:     {all,[_|_]=L} = erlang:trace_info({?MODULE,seq,3}, all),
<a name="199"/>  199:     {value,{call_count,0}} = lists:keysearch(call_count, 1, L),
<a name="200"/>  200:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, restart, [call_count]),
<a name="201"/>  201:     {call_count,0} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="202"/>  202:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, false, [call_count]),
<a name="203"/>  203:     {call_count,false} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="204"/>  204:     {all,false} = erlang:trace_info({?MODULE,seq,3}, all),
<a name="205"/>  205:     %%
<a name="206"/>  206:     P = erlang:trace_pattern({'_','_','_'}, false, [call_count]),
<a name="info_test-last_expr"/><a name="207"/>  207:     ok.
<a name="208"/>  208: 
<a name="209"/>  209: <i>%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="210"/>  210: 
<a name="pause_and_restart_test-0"/><a name="211"/>  211: <b>pause_and_restart_test</b>() -&gt;
<a name="212"/>  212:     P = erlang:trace_pattern({'_','_','_'}, false, [call_count]),
<a name="213"/>  213:     M = 100,
<a name="214"/>  214:     %%
<a name="215"/>  215:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, true, [call_count]),
<a name="216"/>  216:     {call_count,0} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="217"/>  217:     L = seq(1, M, fun(X) -&gt; X+1 end),
<a name="218"/>  218:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="219"/>  219:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, pause, [call_count]),
<a name="220"/>  220:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="221"/>  221:     L = seq(1, M, fun(X) -&gt; X+1 end),
<a name="222"/>  222:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="223"/>  223:     1 = erlang:trace_pattern({?MODULE,seq,'_'}, restart, [call_count]),
<a name="224"/>  224:     {call_count,0} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="225"/>  225:     L = seq(1, M, fun(X) -&gt; X+1 end),
<a name="226"/>  226:     {call_count,M} = erlang:trace_info({?MODULE,seq,3}, call_count),
<a name="227"/>  227:     %%
<a name="228"/>  228:     P = erlang:trace_pattern({'_','_','_'}, false, [call_count]),
<a name="pause_and_restart_test-last_expr"/><a name="229"/>  229:     ok.
<a name="230"/>  230: 
<a name="231"/>  231: <i>%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="232"/>  232: 
<a name="combo_test-0"/><a name="233"/>  233: <b>combo_test</b>() -&gt;
<a name="234"/>  234:     Self = self(),
<a name="235"/>  235: 
<a name="236"/>  236:     MetaMatchSpec = [{'_',[],[{return_trace}]}],
<a name="237"/>  237:     Flags = lists:sort([call, return_to]),
<a name="238"/>  238:     LocalTracer = spawn_link(fun () -&gt; relay_n(5, Self) end),
<a name="239"/>  239:     MetaTracer = spawn_link(fun () -&gt; relay_n(9, Self) end),
<a name="240"/>  240:     2 = erlang:trace_pattern({?MODULE,seq_r,'_'}, [], [local]),
<a name="241"/>  241:     2 = erlang:trace_pattern({?MODULE,seq_r,'_'},
<a name="242"/>  242:                              MetaMatchSpec,
<a name="243"/>  243:                              [{meta,MetaTracer}, call_count]),
<a name="244"/>  244:     1 = erlang:trace(Self, true, [{tracer,LocalTracer} | Flags]),
<a name="245"/>  245:     %%
<a name="246"/>  246:     {traced,local} = 
<a name="247"/>  247:     erlang:trace_info({?MODULE,seq_r,3}, traced),
<a name="248"/>  248:     {match_spec,[]} = 
<a name="249"/>  249:     erlang:trace_info({?MODULE,seq_r,3}, match_spec),
<a name="250"/>  250:     {meta,MetaTracer} = 
<a name="251"/>  251:     erlang:trace_info({?MODULE,seq_r,3}, meta),
<a name="252"/>  252:     {meta_match_spec,MetaMatchSpec} = 
<a name="253"/>  253:     erlang:trace_info({?MODULE,seq_r,3}, meta_match_spec),
<a name="254"/>  254:     {call_count,0} = 
<a name="255"/>  255:     erlang:trace_info({?MODULE,seq_r,3}, call_count),
<a name="256"/>  256:     %%
<a name="257"/>  257:     {all,[_|_]=TraceInfo} = 
<a name="258"/>  258:     erlang:trace_info({?MODULE,seq_r,3}, all),
<a name="259"/>  259:     {value,{traced,local}} = 
<a name="260"/>  260:     lists:keysearch(traced, 1, TraceInfo),
<a name="261"/>  261:     {value,{match_spec,[]}} = 
<a name="262"/>  262:     lists:keysearch(match_spec, 1, TraceInfo),
<a name="263"/>  263:     {value,{meta,MetaTracer}} = 
<a name="264"/>  264:     lists:keysearch(meta, 1, TraceInfo),
<a name="265"/>  265:     {value,{meta_match_spec,MetaMatchSpec}} = 
<a name="266"/>  266:     lists:keysearch(meta_match_spec, 1, TraceInfo),
<a name="267"/>  267:     {value,{call_count,0}} = 
<a name="268"/>  268:     lists:keysearch(call_count, 1, TraceInfo),
<a name="269"/>  269:     %%
<a name="270"/>  270:     [3,2,1] = seq_r(1, 3, fun(X) -&gt; X+1 end),
<a name="271"/>  271:     %%
<a name="272"/>  272:     List = collect(100),
<a name="273"/>  273:     {MetaR, LocalR} = 
<a name="274"/>  274:     lists:foldl(
<a name="275"/>  275:       fun ({P,X}, {M,L}) when P == MetaTracer -&gt;
<a name="276"/>  276:               {[X|M],L};
<a name="277"/>  277:           ({P,X}, {M,L}) when P == LocalTracer -&gt;
<a name="278"/>  278:               {M,[X|L]}
<a name="279"/>  279:       end,
<a name="280"/>  280:       {[],[]},
<a name="281"/>  281:       List),
<a name="282"/>  282:     Meta = lists:reverse(MetaR),
<a name="283"/>  283:     Local = lists:reverse(LocalR),
<a name="284"/>  284:     [?CTT(Self,{?MODULE,seq_r,[1,3,_]}),
<a name="285"/>  285:      ?CTT(Self,{?MODULE,seq_r,[1,3,_,[]]}),
<a name="286"/>  286:      ?CTT(Self,{?MODULE,seq_r,[2,3,_,[1]]}),
<a name="287"/>  287:      ?CTT(Self,{?MODULE,seq_r,[3,3,_,[2,1]]}),
<a name="288"/>  288:      ?RFT(Self,{?MODULE,seq_r,4},[3,2,1]),
<a name="289"/>  289:      ?RFT(Self,{?MODULE,seq_r,4},[3,2,1]),
<a name="290"/>  290:      ?RFT(Self,{?MODULE,seq_r,4},[3,2,1]),
<a name="291"/>  291:      ?RFT(Self,{?MODULE,seq_r,3},[3,2,1])] = Meta,
<a name="292"/>  292:     [?CT(Self,{?MODULE,seq_r,[1,3,_]}),
<a name="293"/>  293:      ?CT(Self,{?MODULE,seq_r,[1,3,_,[]]}),
<a name="294"/>  294:      ?CT(Self,{?MODULE,seq_r,[2,3,_,[1]]}),
<a name="295"/>  295:      ?CT(Self,{?MODULE,seq_r,[3,3,_,[2,1]]}),
<a name="296"/>  296:      ?RT(Self,{?MODULE,combo_test,0})] = Local,
<a name="297"/>  297:     {call_count,1} = erlang:trace_info({?MODULE,seq_r,3}, call_count),
<a name="298"/>  298:     {call_count,3} = erlang:trace_info({?MODULE,seq_r,4}, call_count),
<a name="299"/>  299:     %%
<a name="300"/>  300:     erlang:trace_pattern({'_','_','_'}, false, [local,meta,call_count]),
<a name="301"/>  301:     erlang:trace_pattern(on_load, false, [local,meta,call_count]),
<a name="302"/>  302:     erlang:trace(all, false, [all]),
<a name="combo_test-last_expr"/><a name="303"/>  303:     ok.
<a name="304"/>  304: 
<a name="305"/>  305: <i>%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="306"/>  306: <i>%% Local helpers</i>
<a name="307"/>  307: 
<a name="308"/>  308: <i>%% Stack recursive seq</i>
<a name="seq-3"/><a name="309"/>  309: <b>seq</b>(Stop, Stop, Succ) when is_function(Succ) -&gt;
<a name="310"/>  310:     [Stop];
<a name="311"/>  311: <b>seq</b>(Start, Stop, Succ) when is_function(Succ) -&gt;
<a name="seq-last_expr"/><a name="312"/>  312: <b>    [Start | seq</b>(Succ(Start), Stop, Succ)].
<a name="313"/>  313: 
<a name="314"/>  314: 
<a name="315"/>  315: 
<a name="316"/>  316: <i>%% Tail recursive seq, result list is reversed</i>
<a name="seq_r-3"/><a name="317"/>  317: <b>seq_r</b>(Start, Stop, Succ) when is_function(Succ) -&gt;
<a name="seq_r-last_expr"/><a name="318"/>  318: <b>    seq_r</b>(Start, Stop, Succ, []).
<a name="319"/>  319: 
<a name="seq_r-4"/><a name="320"/>  320: <b>seq_r</b>(Stop, Stop, _, R) -&gt;
<a name="321"/>  321:     [Stop | R];
<a name="322"/>  322: <b>seq_r</b>(Start, Stop, Succ, R) -&gt;
<a name="seq_r-last_expr"/><a name="323"/>  323: <b>    seq_r</b>(Succ(Start), Stop, Succ, [Start | R]).
<a name="324"/>  324: 
<a name="325"/>  325: 
<a name="326"/>  326: 
<a name="327"/>  327: <i>%% Message relay process</i>
<a name="relay_n-2"/><a name="328"/>  328: <b>relay_n</b>(0, _) -&gt;
<a name="329"/>  329:     ok;
<a name="330"/>  330: <b>relay_n</b>(N, Dest) -&gt;
<a name="relay_n-last_expr"/><a name="331"/>  331:     receive Msg -&gt;
<a name="332"/>  332:                 Dest ! {self(), Msg},
<a name="333"/>  333:                 relay_n(N-1, Dest)
<a name="334"/>  334:     end.
<a name="335"/>  335: 
<a name="336"/>  336: 
<a name="337"/>  337: 
<a name="338"/>  338: <i>%% Collect received messages</i>
<a name="collect-1"/><a name="339"/>  339: <b>collect</b>(Time) -&gt;
<a name="340"/>  340:     Ref = erlang:start_timer(Time, self(), done),
<a name="341"/>  341:     L = lists:reverse(collect([], Ref)),
<a name="342"/>  342:     ?dbgformat(&quot;Got: ~p~n&quot;,[L]),
<a name="collect-last_expr"/><a name="343"/>  343:     L.
<a name="344"/>  344: 
<a name="collect-2"/><a name="345"/>  345: <b>collect</b>(A, 0) -&gt;
<a name="346"/>  346:     receive
<a name="347"/>  347:         Mess -&gt;
<a name="348"/>  348:             collect([Mess | A], 0)
<a name="349"/>  349:     after 0 -&gt;
<a name="350"/>  350:               A
<a name="351"/>  351:     end;
<a name="352"/>  352: <b>collect</b>(A, Ref) -&gt;
<a name="collect-last_expr"/><a name="353"/>  353:     receive
<a name="354"/>  354:         {timeout, Ref, done} -&gt;
<a name="355"/>  355:             collect(A, 0);
<a name="356"/>  356:         Mess -&gt;
<a name="357"/>  357:             collect([Mess | A], Ref)
<a name="358"/>  358:     end.
</pre>
</body>
</html>
