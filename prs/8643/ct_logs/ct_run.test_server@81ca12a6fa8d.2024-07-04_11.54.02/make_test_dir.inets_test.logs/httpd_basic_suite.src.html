<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/inets/make_test_dir/inets_test/httpd_basic_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2007-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <i>%%</i>
<a name="21"/>   21: <b>-module</b>(httpd_basic_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-include_lib</b>(&quot;kernel/include/file.hrl&quot;).
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="25"/>   25: <b>-include</b>(&quot;inets_test_lib.hrl&quot;).
<a name="26"/>   26: 
<a name="27"/>   27: 
<a name="28"/>   28: <i>%% Note: This directive should only be used in test suites.</i>
<a name="29"/>   29: <b>-compile</b>(export_all).
<a name="30"/>   30: 
<a name="31"/>   31: <b>-define</b>(URL_START, &quot;http://localhost:&quot;).
<a name="32"/>   32: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="33"/>   33: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]},
<a name="34"/>   34: 	    {timetrap, {seconds, 30}}].
<a name="35"/>   35: 
<a name="all-0"/><a name="36"/>   36: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="37"/>   37:     [{group, httpd_basic}].
<a name="38"/>   38: 
<a name="groups-0"/><a name="39"/>   39: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="40"/>   40:     [{httpd_basic, [parallel], [uri_too_long_414,
<a name="41"/>   41:                                 header_too_long_413,
<a name="42"/>   42:                                 entity_too_long,
<a name="43"/>   43:                                 http_0_9_not_supported,
<a name="44"/>   44:                                 erl_script_nocache_opt,
<a name="45"/>   45:                                 script_nocache,
<a name="46"/>   46:                                 escaped_url_in_error_body,
<a name="47"/>   47:                                 script_timeout,
<a name="48"/>   48:                                 slowdose,
<a name="49"/>   49:                                 keep_alive_timeout,
<a name="50"/>   50:                                 invalid_rfc1123_date]}].
<a name="51"/>   51: 
<a name="init_per_group-2"/><a name="52"/>   52: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="53"/>   53:     Config.
<a name="54"/>   54: 
<a name="end_per_group-2"/><a name="55"/>   55: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="56"/>   56:     Config.
<a name="57"/>   57: 
<a name="58"/>   58: 
<a name="59"/>   59: <i>%%--------------------------------------------------------------------</i>
<a name="60"/>   60: <i>%% Function: init_per_suite(Config) -&gt; Config</i>
<a name="61"/>   61: <i>%% Config - [tuple()]</i>
<a name="62"/>   62: <i>%%   A list of key/value pairs, holding the test case configuration.</i>
<a name="63"/>   63: <i>%% Description: Initiation before the whole suite</i>
<a name="64"/>   64: <i>%%</i>
<a name="65"/>   65: <i>%% Note: This function is free to add any key/value pairs to the Config</i>
<a name="66"/>   66: <i>%% variable, but should NOT alter/remove any existing entries.</i>
<a name="67"/>   67: <i>%%--------------------------------------------------------------------</i>
<a name="init_per_suite-1"/><a name="68"/>   68: <b>init_per_suite</b>(Config) -&gt;
<a name="69"/>   69:     inets_test_lib:stop_apps([inets]),
<a name="70"/>   70:     inets_test_lib:start_apps([inets]),
<a name="71"/>   71:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="72"/>   72:     DataDir = proplists:get_value(data_dir, Config), 
<a name="73"/>   73:     
<a name="74"/>   74:     Dummy = 
<a name="75"/>   75: 	&quot;&lt;HTML&gt;
<a name="76"/>   76: &lt;HEAD&gt;
<a name="77"/>   77: &lt;TITLE&gt;/index.html&lt;/TITLE&gt;
<a name="78"/>   78: &lt;/HEAD&gt;
<a name="79"/>   79: &lt;BODY&gt;
<a name="80"/>   80: DUMMY
<a name="81"/>   81: &lt;/BODY&gt;
<a name="82"/>   82: &lt;/HTML&gt;&quot;,
<a name="83"/>   83:     
<a name="84"/>   84:     DummyFile = filename:join([PrivDir,&quot;dummy.html&quot;]),
<a name="85"/>   85:     CgiDir =  filename:join(PrivDir, &quot;cgi-bin&quot;),
<a name="86"/>   86:     ok = file:make_dir(CgiDir),
<a name="87"/>   87:     {CgiPrintEnv, CgiSleep} = case os:type() of
<a name="88"/>   88: 				  {win32, _} -&gt;
<a name="89"/>   89: 				      {&quot;printenv.bat&quot;, &quot;cgi_sleep.exe&quot;};
<a name="90"/>   90: 				  _ -&gt;
<a name="91"/>   91: 				      {&quot;printenv.sh&quot;, &quot;cgi_sleep&quot;}
<a name="92"/>   92: 			      end,
<a name="93"/>   93:     lists:foreach(
<a name="94"/>   94:       fun(Cgi) -&gt;
<a name="95"/>   95: 	      inets_test_lib:copy_file(Cgi, DataDir, CgiDir),
<a name="96"/>   96: 	      AbsCgi = filename:join([CgiDir, Cgi]),
<a name="97"/>   97: 	      {ok, FileInfo} = file:read_file_info(AbsCgi),
<a name="98"/>   98: 	      ok = file:write_file_info(AbsCgi, FileInfo#file_info{mode = 8#00755})
<a name="99"/>   99:       end, [CgiPrintEnv, CgiSleep]),
<a name="100"/>  100:     {ok, Fd}  = file:open(DummyFile, [write]),
<a name="101"/>  101:     ok        = file:write(Fd, Dummy),
<a name="102"/>  102:     ok        = file:close(Fd), 
<a name="103"/>  103:     HttpdConf = [{port,          0}, 
<a name="104"/>  104: 		 {ipfamily,      inet}, 
<a name="105"/>  105: 		 {server_name,   &quot;httpd_test&quot;}, 
<a name="106"/>  106: 		 {server_root,   PrivDir},
<a name="107"/>  107: 		 {document_root, PrivDir}, 
<a name="108"/>  108: 		 {bind_address,  &quot;localhost&quot;}],
<a name="109"/>  109: 
<a name="init_per_suite-last_expr"/><a name="110"/>  110:     [{httpd_conf, HttpdConf}, {cgi_dir, CgiDir},
<a name="111"/>  111:      {cgi_printenv, CgiPrintEnv}, {cgi_sleep, CgiSleep} |  Config].
<a name="112"/>  112: 
<a name="113"/>  113: <i>%%--------------------------------------------------------------------</i>
<a name="114"/>  114: <i>%% Function: end_per_suite(Config) -&gt; _</i>
<a name="115"/>  115: <i>%% Config - [tuple()]</i>
<a name="116"/>  116: <i>%%   A list of key/value pairs, holding the test case configuration.</i>
<a name="117"/>  117: <i>%% Description: Cleanup after the whole suite</i>
<a name="118"/>  118: <i>%%--------------------------------------------------------------------</i>
<a name="end_per_suite-1"/><a name="119"/>  119: <b>end_per_suite</b>(_Config) -&gt;
<a name="120"/>  120:     inets:stop(),
<a name="end_per_suite-last_expr"/><a name="121"/>  121:     ok.
<a name="122"/>  122: 
<a name="123"/>  123: <i>%%--------------------------------------------------------------------</i>
<a name="124"/>  124: <i>%% Function: init_per_testcase(Case, Config) -&gt; Config</i>
<a name="125"/>  125: <i>% Case - atom()</i>
<a name="126"/>  126: <i>%%   Name of the test case that is about to be run.</i>
<a name="127"/>  127: <i>%% Config - [tuple()]</i>
<a name="128"/>  128: <i>%%   A list of key/value pairs, holding the test case configuration.</i>
<a name="129"/>  129: <i>%%</i>
<a name="130"/>  130: <i>%% Description: Initiation before each test case</i>
<a name="131"/>  131: <i>%%</i>
<a name="132"/>  132: <i>%% Note: This function is free to add any key/value pairs to the Config</i>
<a name="133"/>  133: <i>%% variable, but should NOT alter/remove any existing entries.</i>
<a name="134"/>  134: <i>%%--------------------------------------------------------------------</i>
<a name="init_per_testcase-2"/><a name="135"/>  135: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="136"/>  136:     Config.
<a name="137"/>  137: 
<a name="138"/>  138: 
<a name="139"/>  139: <i>%%--------------------------------------------------------------------</i>
<a name="140"/>  140: <i>%% Function: end_per_testcase(Case, Config) -&gt; _</i>
<a name="141"/>  141: <i>%% Case - atom()</i>
<a name="142"/>  142: <i>%%   Name of the test case that is about to be run.</i>
<a name="143"/>  143: <i>%% Config - [tuple()]</i>
<a name="144"/>  144: <i>%%   A list of key/value pairs, holding the test case configuration.</i>
<a name="145"/>  145: <i>%% Description: Cleanup after each test case</i>
<a name="146"/>  146: <i>%%--------------------------------------------------------------------</i>
<a name="end_per_testcase-2"/><a name="147"/>  147: <b>end_per_testcase</b>(_Case, Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="148"/>  148:     Config.
<a name="149"/>  149: 
<a name="150"/>  150: 
<a name="151"/>  151: <i>%%-------------------------------------------------------------------------</i>
<a name="152"/>  152: <i>%% Test cases starts here.</i>
<a name="153"/>  153: <i>%%-------------------------------------------------------------------------</i>
<a name="uri_too_long_414-0"/><a name="154"/>  154: <b>uri_too_long_414</b>() -&gt;
<a name="uri_too_long_414-last_expr"/><a name="155"/>  155:     [{doc, &quot;Test that too long uri's get 414 HTTP code&quot;}].
<a name="uri_too_long_414-1"/><a name="156"/>  156: <b>uri_too_long_414</b>(Config) when is_list(Config) -&gt;
<a name="157"/>  157:     HttpdConf =   proplists:get_value(httpd_conf, Config),    
<a name="158"/>  158:     {ok, Pid} = inets:start(httpd, [{max_uri_size, 10} 
<a name="159"/>  159: 				    | HttpdConf]),
<a name="160"/>  160:     Info = httpd:info(Pid),
<a name="161"/>  161:     Port = proplists:get_value(port, Info),
<a name="162"/>  162:     Address = proplists:get_value(bind_address, Info),
<a name="163"/>  163:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="164"/>  164:  				       &quot;GET /morethantenchars &quot;
<a name="165"/>  165:  				       &quot;HTTP/1.1\r\n\r\n&quot;,
<a name="166"/>  166:  				       [{statuscode, 414},                            
<a name="167"/>  167:        			        {version, &quot;HTTP/1.1&quot;}]),
<a name="uri_too_long_414-last_expr"/><a name="168"/>  168: <b>    inets:stop</b>(httpd, Pid).
<a name="169"/>  169: 
<a name="170"/>  170: <i>%%-------------------------------------------------------------------------</i>
<a name="header_too_long_413-0"/><a name="171"/>  171: <b>header_too_long_413</b>() -&gt;
<a name="header_too_long_413-last_expr"/><a name="172"/>  172:     [{doc,&quot;Test that too long headers's get 413 HTTP code&quot;}].
<a name="header_too_long_413-1"/><a name="173"/>  173: <b>header_too_long_413</b>(Config) when is_list(Config) -&gt;
<a name="174"/>  174:     HttpdConf = proplists:get_value(httpd_conf, Config), 
<a name="175"/>  175:     {ok, Pid} = inets:start(httpd, [{max_header_size, 10}
<a name="176"/>  176: 				    | HttpdConf]),
<a name="177"/>  177:     Info = httpd:info(Pid),
<a name="178"/>  178:     Port = proplists:get_value(port, Info),
<a name="179"/>  179:     Address = proplists:get_value(bind_address, Info),
<a name="180"/>  180:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="181"/>  181:  				       &quot;GET index.html &quot;
<a name="182"/>  182:  				       &quot;HTTP/1.1\r\n&quot;
<a name="183"/>  183: 				       &quot;Connection:close \r\n\r\n &quot;,
<a name="184"/>  184:  				       [{statuscode, 413},
<a name="185"/>  185:  				        {version, &quot;HTTP/1.1&quot;}]),
<a name="header_too_long_413-last_expr"/><a name="186"/>  186: <b>    inets:stop</b>(httpd, Pid).
<a name="187"/>  187: 
<a name="188"/>  188: <i>%%-------------------------------------------------------------------------</i>
<a name="189"/>  189: 
<a name="http_0_9_not_supported-0"/><a name="190"/>  190: <b>http_0_9_not_supported</b>() -&gt;
<a name="http_0_9_not_supported-last_expr"/><a name="191"/>  191:     [{doc, &quot;Test that HTTP 0.9 is not supported&quot;}].
<a name="http_0_9_not_supported-1"/><a name="192"/>  192: <b>http_0_9_not_supported</b>(Config) when is_list(Config) -&gt;
<a name="193"/>  193:     HttpdConf =   proplists:get_value(httpd_conf, Config),
<a name="194"/>  194:     {ok, Pid} = inets:start(httpd, HttpdConf),
<a name="195"/>  195:     Info = httpd:info(Pid),
<a name="196"/>  196:     Port = proplists:get_value(port, Info),
<a name="197"/>  197:     Address = proplists:get_value(bind_address, Info),
<a name="198"/>  198: 
<a name="199"/>  199:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(),
<a name="200"/>  200:      				       &quot;GET /\r\n\r\n&quot;,
<a name="201"/>  201:      				       [{statuscode, 505},
<a name="202"/>  202:      				        {version, &quot;HTTP/1.1&quot;}]),
<a name="http_0_9_not_supported-last_expr"/><a name="203"/>  203: <b>    inets:stop</b>(httpd, Pid).
<a name="204"/>  204: 
<a name="205"/>  205: <i>%%-------------------------------------------------------------------------</i>
<a name="206"/>  206: 
<a name="entity_too_long-0"/><a name="207"/>  207: <b>entity_too_long</b>() -&gt;
<a name="entity_too_long-last_expr"/><a name="208"/>  208:     [{doc, &quot;Test that too long versions and method strings are rejected&quot;}].
<a name="entity_too_long-1"/><a name="209"/>  209: <b>entity_too_long</b>(Config) when is_list(Config) -&gt;
<a name="210"/>  210:     HttpdConf =   proplists:get_value(httpd_conf, Config),    
<a name="211"/>  211:     {ok, Pid} = inets:start(httpd, HttpdConf),
<a name="212"/>  212:     Info = httpd:info(Pid),
<a name="213"/>  213:     Port = proplists:get_value(port, Info),
<a name="214"/>  214:     Address = proplists:get_value(bind_address, Info),
<a name="215"/>  215:     
<a name="216"/>  216:     %% Not so long but wrong
<a name="217"/>  217:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="218"/>  218:      				       &quot;GET / &quot; ++
<a name="219"/>  219: 					   lists:duplicate(5, $A) ++ &quot;\r\n\r\n&quot;,
<a name="220"/>  220:      				       [{statuscode, 400},
<a name="221"/>  221:      				        {version, &quot;HTTP/1.1&quot;}]),
<a name="222"/>  222: 
<a name="223"/>  223:     %% Too long
<a name="224"/>  224:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="225"/>  225:  				       &quot;GET / &quot; ++
<a name="226"/>  226: 					   lists:duplicate(100, $A) ++ &quot;\r\n\r\n&quot;,
<a name="227"/>  227:  				       [{statuscode, 413},
<a name="228"/>  228:  				        {version, &quot;HTTP/1.1&quot;}]),
<a name="229"/>  229:     %% Not so long but wrong
<a name="230"/>  230:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="231"/>  231: 				       lists:duplicate(5, $A) ++ &quot; / &quot;
<a name="232"/>  232: 				       &quot;HTTP/1.1\r\n\r\n&quot;,
<a name="233"/>  233:  				       [{statuscode, 501},
<a name="234"/>  234: 					%% Server will send lowest version
<a name="235"/>  235: 					%% as it will not get to the 
<a name="236"/>  236: 					%% client version
<a name="237"/>  237: 					%% before aborting
<a name="238"/>  238:  				        {version, &quot;HTTP/1.1&quot;}]),
<a name="239"/>  239:     %% Too long
<a name="240"/>  240:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="241"/>  241: 				       lists:duplicate(100, $A) ++ &quot; / &quot;
<a name="242"/>  242: 				       &quot;HTTP/1.1\r\n\r\n&quot;,
<a name="243"/>  243:  				       [{statuscode, 413},
<a name="244"/>  244: 					%% Server will send lowest version
<a name="245"/>  245: 					%% as it will not get to the 
<a name="246"/>  246: 					%% client version
<a name="247"/>  247: 					%% before aborting
<a name="248"/>  248:  				        {version, &quot;HTTP/1.1&quot;}]),   
<a name="entity_too_long-last_expr"/><a name="249"/>  249: <b>    inets:stop</b>(httpd, Pid).
<a name="250"/>  250:     
<a name="251"/>  251: <i>%%-------------------------------------------------------------------------</i>
<a name="252"/>  252: 
<a name="script_nocache-0"/><a name="253"/>  253: <b>script_nocache</b>() -&gt;
<a name="script_nocache-last_expr"/><a name="254"/>  254:     [{doc,&quot;Test nocache option for mod_cgi and mod_esi&quot;}].
<a name="script_nocache-1"/><a name="255"/>  255: <b>script_nocache</b>(Config) when is_list(Config) -&gt;
<a name="256"/>  256:     Normal = {no_header, &quot;cache-control&quot;},
<a name="257"/>  257:     NoCache = {header, &quot;cache-control&quot;, &quot;no-cache&quot;},
<a name="258"/>  258:     verify_script_nocache(Config, false, false, Normal, Normal),
<a name="259"/>  259:     verify_script_nocache(Config, true, false, NoCache, Normal),
<a name="260"/>  260:     verify_script_nocache(Config, false, true, Normal, NoCache),
<a name="script_nocache-last_expr"/><a name="261"/>  261: <b>    verify_script_nocache</b>(Config, true, true, NoCache, NoCache).
<a name="262"/>  262: 
<a name="263"/>  263: <i>%%-------------------------------------------------------------------------</i>
<a name="erl_script_nocache_opt-1"/><a name="264"/>  264: <b>erl_script_nocache_opt</b>(doc) -&gt;
<a name="265"/>  265:     [&quot;Test that too long headers's get 413 HTTP code&quot;];
<a name="266"/>  266: <b>erl_script_nocache_opt</b>(suite) -&gt;
<a name="267"/>  267:     [];
<a name="268"/>  268: <b>erl_script_nocache_opt</b>(Config) when is_list(Config) -&gt;
<a name="269"/>  269:     HttpdConf   = proplists:get_value(httpd_conf, Config),
<a name="270"/>  270:     {ok, Pid}   = inets:start(httpd, [{port, 0}, {erl_script_nocache, true} | HttpdConf]),
<a name="271"/>  271:     Info        = httpd:info(Pid),
<a name="272"/>  272:     Port        = proplists:get_value(port,         Info),
<a name="273"/>  273:     _Address    = proplists:get_value(bind_address, Info),
<a name="274"/>  274:     URL1        = ?URL_START ++ integer_to_list(Port),
<a name="275"/>  275:     case httpc:request(get, {URL1 ++ &quot;/dummy.html&quot;, []},
<a name="276"/>  276: 		       [{url_encode,  false}, 
<a name="277"/>  277: 			{version,     &quot;HTTP/1.0&quot;}],
<a name="278"/>  278: 		       [{full_result, false}]) of
<a name="279"/>  279: 	{ok, {200, _}} -&gt;
<a name="280"/>  280: 	    ok
<a name="281"/>  281:     end,
<a name="erl_script_nocache_opt-last_expr"/><a name="282"/>  282: <b>    inets:stop</b>(httpd, Pid).
<a name="283"/>  283: 
<a name="284"/>  284: <i>%%-------------------------------------------------------------------------</i>
<a name="285"/>  285: 
<a name="286"/>  286: 
<a name="287"/>  287: <i>%%-------------------------------------------------------------------------</i>
<a name="288"/>  288: 
<a name="escaped_url_in_error_body-0"/><a name="289"/>  289: <b>escaped_url_in_error_body</b>() -&gt;
<a name="escaped_url_in_error_body-last_expr"/><a name="290"/>  290:     [{doc, &quot;Test Url-encoding see OTP-8940&quot;}].
<a name="escaped_url_in_error_body-1"/><a name="291"/>  291: <b>escaped_url_in_error_body</b>(Config) when is_list(Config) -&gt; 
<a name="292"/>  292:     HttpdConf   = proplists:get_value(httpd_conf, Config),
<a name="293"/>  293:     {ok, Pid}   = inets:start(httpd, [{port, 0} | HttpdConf]),
<a name="294"/>  294:     Info        = httpd:info(Pid),
<a name="295"/>  295:     Port        = proplists:get_value(port,         Info),
<a name="296"/>  296:     URL1        = ?URL_START ++ integer_to_list(Port),
<a name="297"/>  297:    
<a name="298"/>  298:     %% Sanity check
<a name="299"/>  299:     {ok, {200, _}} = httpc:request(get, {URL1 ++ &quot;/dummy.html&quot;, []},
<a name="300"/>  300:      				   [{url_encode,  false}, 
<a name="301"/>  301:      				    {version,     &quot;HTTP/1.0&quot;}],
<a name="302"/>  302:      				   [{full_result, false}]),
<a name="303"/>  303:     {ok, {200, _}} = httpc:request(get, {URL1 ++ &quot;/dummy.html&quot;, []},
<a name="304"/>  304:      				   [{url_encode,  true}, 
<a name="305"/>  305:      				    {version,     &quot;HTTP/1.0&quot;}],
<a name="306"/>  306:      				   [{full_result, false}]),
<a name="307"/>  307:     
<a name="308"/>  308:     %% Ask for a non-existing page(1)
<a name="309"/>  309:     Path            = &quot;/&lt;b&gt;this_is_bold&lt;b&gt;&quot;,
<a name="310"/>  310:     URL2 = uri_string:recompose(#{scheme =&gt; &quot;http&quot;,
<a name="311"/>  311:                                   host =&gt; &quot;localhost&quot;,
<a name="312"/>  312:                                   port =&gt; Port,
<a name="313"/>  313:                                   path =&gt; Path}),
<a name="314"/>  314:     
<a name="315"/>  315:     #{path := EncodedPath} = uri_string:parse(URL2),
<a name="316"/>  316:     HTMLEncodedPath =  http_util:html_encode(EncodedPath),
<a name="317"/>  317:     {ok, {404, Body3}} = httpc:request(get, {URL2, []},
<a name="318"/>  318: 				       [{url_encode,  true}, 
<a name="319"/>  319: 					{version,     &quot;HTTP/1.0&quot;}],
<a name="320"/>  320: 				       [{full_result, false}]),
<a name="321"/>  321: 
<a name="322"/>  322:     HTMLEncodedPath = find_URL_path(string:tokens(Body3, &quot; &quot;)),
<a name="323"/>  323: 
<a name="324"/>  324:     {ok, {404, Body4}} = httpc:request(get, {URL2, []}, 
<a name="325"/>  325: 				       [{url_encode,  false}, 
<a name="326"/>  326: 					{version,     &quot;HTTP/1.0&quot;}],
<a name="327"/>  327: 				       [{full_result, false}]),
<a name="328"/>  328:     
<a name="329"/>  329:     HTMLEncodedPath = find_URL_path(string:tokens(Body4, &quot; &quot;)),
<a name="escaped_url_in_error_body-last_expr"/><a name="330"/>  330: <b>    inets:stop</b>(httpd, Pid).
<a name="331"/>  331: 
<a name="332"/>  332: <i>%%-------------------------------------------------------------------------</i>
<a name="333"/>  333: 
<a name="keep_alive_timeout-1"/><a name="334"/>  334: <b>keep_alive_timeout</b>(doc) -&gt;
<a name="335"/>  335:     [&quot;Test the keep_alive_timeout option&quot;];
<a name="336"/>  336: <b>keep_alive_timeout</b>(suite) -&gt;
<a name="337"/>  337:     [];
<a name="338"/>  338: <b>keep_alive_timeout</b>(Config) when is_list(Config) -&gt;
<a name="339"/>  339:     HttpdConf   = proplists:get_value(httpd_conf, Config),
<a name="340"/>  340:     {ok, Pid}   = inets:start(httpd, [{port, 0}, {keep_alive, true}, {keep_alive_timeout, 2} | HttpdConf]),
<a name="341"/>  341:     Info        = httpd:info(Pid),
<a name="342"/>  342:     Port        = proplists:get_value(port,         Info),
<a name="343"/>  343:     _Address    = proplists:get_value(bind_address, Info),
<a name="344"/>  344:     {ok, S} = gen_tcp:connect(&quot;localhost&quot;, Port, []),
<a name="345"/>  345:     receive
<a name="346"/>  346:     after 3000 -&gt;
<a name="347"/>  347: 	    {error, closed} = gen_tcp:send(S, &quot;hey&quot;)
<a name="348"/>  348:     end,
<a name="keep_alive_timeout-last_expr"/><a name="349"/>  349: <b>    inets:stop</b>(httpd, Pid).
<a name="350"/>  350: 
<a name="351"/>  351: <i>%%-------------------------------------------------------------------------</i>
<a name="352"/>  352: 
<a name="script_timeout-1"/><a name="353"/>  353: <b>script_timeout</b>(doc) -&gt;
<a name="354"/>  354:     [&quot;Test the httpd script_timeout option&quot;];
<a name="355"/>  355: <b>script_timeout</b>(suite) -&gt;
<a name="356"/>  356:     [];
<a name="357"/>  357: <b>script_timeout</b>(Config) when is_list(Config) -&gt;
<a name="358"/>  358:     verify_script_timeout(Config, 20, 200),
<a name="359"/>  359:     verify_script_timeout(Config, 5, 403),
<a name="script_timeout-last_expr"/><a name="360"/>  360:     ok.
<a name="361"/>  361: 
<a name="verify_script_timeout-3"/><a name="362"/>  362: <b>verify_script_timeout</b>(Config, ScriptTimeout, StatusCode) -&gt;
<a name="363"/>  363:     HttpdConf = proplists:get_value(httpd_conf, Config),
<a name="364"/>  364:     CgiScript = proplists:get_value(cgi_sleep, Config),
<a name="365"/>  365:     CgiDir = proplists:get_value(cgi_dir, Config),
<a name="366"/>  366:     {ok, Pid} = inets:start(httpd, [{port, 0},
<a name="367"/>  367: 				    {script_alias,
<a name="368"/>  368: 				     {&quot;/cgi-bin/&quot;, CgiDir ++ &quot;/&quot;}},
<a name="369"/>  369: 				    {script_timeout, ScriptTimeout}
<a name="370"/>  370: 				    | HttpdConf]),
<a name="371"/>  371:     Info = httpd:info(Pid),
<a name="372"/>  372:     Port = proplists:get_value(port, Info),
<a name="373"/>  373:     Address = proplists:get_value(bind_address, Info),
<a name="374"/>  374:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(),
<a name="375"/>  375: 				       &quot;GET /cgi-bin/&quot; ++ CgiScript ++
<a name="376"/>  376: 					   &quot; HTTP/1.0\r\n\r\n&quot;,
<a name="377"/>  377: 				       [{statuscode, StatusCode},
<a name="378"/>  378: 					{version, &quot;HTTP/1.0&quot;}]),
<a name="verify_script_timeout-last_expr"/><a name="379"/>  379: <b>    inets:stop</b>(httpd, Pid).
<a name="380"/>  380: 
<a name="381"/>  381: <i>%%-------------------------------------------------------------------------</i>
<a name="382"/>  382: 
<a name="slowdose-0"/><a name="383"/>  383: <b>slowdose</b>() -&gt;
<a name="slowdose-last_expr"/><a name="384"/>  384:     [{doc, &quot;Testing minimum bytes per second option&quot;}].
<a name="slowdose-1"/><a name="385"/>  385: <b>slowdose</b>(Config) when is_list(Config) -&gt;
<a name="386"/>  386:     HttpdConf =   proplists:get_value(httpd_conf, Config),
<a name="387"/>  387:     {ok, Pid} = inets:start(httpd, [{port, 0}, {minimum_bytes_per_second, 200}|HttpdConf]),
<a name="388"/>  388:     Info = httpd:info(Pid),
<a name="389"/>  389:     Port = proplists:get_value(port, Info),
<a name="390"/>  390:     {ok, Socket} = gen_tcp:connect(&quot;localhost&quot;, Port, []),
<a name="slowdose-last_expr"/><a name="391"/>  391:     receive
<a name="392"/>  392:     after 6000 -&gt;
<a name="393"/>  393: 	    {error, closed} = gen_tcp:send(Socket, &quot;Hey&quot;)
<a name="394"/>  394:     end.
<a name="395"/>  395: 
<a name="396"/>  396: <i>%%-------------------------------------------------------------------------</i>
<a name="397"/>  397: 
<a name="invalid_rfc1123_date-0"/><a name="398"/>  398: <b>invalid_rfc1123_date</b>() -&gt;
<a name="invalid_rfc1123_date-last_expr"/><a name="399"/>  399:     [{doc, &quot;Test that a non-DST date is handled correctly&quot;}].
<a name="invalid_rfc1123_date-1"/><a name="400"/>  400: <b>invalid_rfc1123_date</b>(Config) when is_list(Config) -&gt;
<a name="401"/>  401:     Rfc1123FormattedDate = &quot;Sun, 26 Mar 2017 01:00:00 GMT&quot;,
<a name="402"/>  402:     NonDSTDateTime = {{2017, 03, 26},{1, 0, 0}},
<a name="invalid_rfc1123_date-last_expr"/><a name="403"/>  403: <b>    Rfc1123FormattedDate =:= httpd_util:rfc1123_date</b>(NonDSTDateTime).
<a name="404"/>  404: 
<a name="405"/>  405: 
<a name="406"/>  406: <i>%%-------------------------------------------------------------------------</i>
<a name="407"/>  407: <i>%% Internal functions</i>
<a name="408"/>  408: <i>%%-------------------------------------------------------------------------</i>
<a name="409"/>  409: 
<a name="verify_script_nocache-5"/><a name="410"/>  410: <b>verify_script_nocache</b>(Config, CgiNoCache, EsiNoCache, CgiOption, EsiOption) -&gt;
<a name="411"/>  411:     HttpdConf = proplists:get_value(httpd_conf, Config),
<a name="412"/>  412:     CgiScript = proplists:get_value(cgi_printenv, Config),
<a name="413"/>  413:     CgiDir = proplists:get_value(cgi_dir, Config),
<a name="414"/>  414:     {ok, Pid} = inets:start(httpd, [{port, 0},
<a name="415"/>  415: 				    {script_alias,
<a name="416"/>  416: 				     {&quot;/cgi-bin/&quot;, CgiDir ++ &quot;/&quot;}},
<a name="417"/>  417: 				    {script_nocache, CgiNoCache},
<a name="418"/>  418: 				    {erl_script_alias,
<a name="419"/>  419: 				     {&quot;/cgi-bin/erl&quot;, [httpd_example,io]}},
<a name="420"/>  420: 				    {erl_script_nocache, EsiNoCache}
<a name="421"/>  421: 				    | HttpdConf]),
<a name="422"/>  422:     Info = httpd:info(Pid),
<a name="423"/>  423:     Port = proplists:get_value(port, Info),
<a name="424"/>  424:     Address = proplists:get_value(bind_address, Info),
<a name="425"/>  425:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(),
<a name="426"/>  426: 				       &quot;GET /cgi-bin/&quot; ++ CgiScript ++
<a name="427"/>  427: 					   &quot; HTTP/1.0\r\n\r\n&quot;,
<a name="428"/>  428: 				       [{statuscode, 200},
<a name="429"/>  429: 					CgiOption,
<a name="430"/>  430: 					{version, &quot;HTTP/1.0&quot;}]),
<a name="431"/>  431:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(),
<a name="432"/>  432: 				       &quot;GET /cgi-bin/erl/httpd_example:get &quot;
<a name="433"/>  433: 				       &quot;HTTP/1.0\r\n\r\n&quot;,
<a name="434"/>  434: 				       [{statuscode, 200},
<a name="435"/>  435: 					EsiOption,
<a name="436"/>  436: 					{version, &quot;HTTP/1.0&quot;}]),
<a name="verify_script_nocache-last_expr"/><a name="437"/>  437: <b>    inets:stop</b>(httpd, Pid).
<a name="438"/>  438: 
<a name="find_URL_path-1"/><a name="439"/>  439: <b>find_URL_path</b>([]) -&gt;
<a name="440"/>  440:     &quot;&quot;;
<a name="441"/>  441: <b>find_URL_path</b>([&quot;URL&quot;, URL | _]) -&gt;
<a name="442"/>  442:     URL;
<a name="443"/>  443: <b>find_URL_path</b>([_ | Rest]) -&gt;
<a name="find_URL_path-last_expr"/><a name="444"/>  444: <b>    find_URL_path</b>(Rest).
<a name="445"/>  445: 
<a name="skip-1"/><a name="446"/>  446: <b>skip</b>(Reason) -&gt;
<a name="skip-last_expr"/><a name="447"/>  447:     {skip, Reason}.
<a name="448"/>  448: 
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
