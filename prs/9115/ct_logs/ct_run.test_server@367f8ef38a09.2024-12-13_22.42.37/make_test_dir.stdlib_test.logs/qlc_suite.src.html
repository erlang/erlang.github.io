<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/qlc_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2004-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <i>%%%----------------------------------------------------------------</i>
<a name="21"/>   21: <i>%%% Purpose:Test Suite for the 'qlc' module.</i>
<a name="22"/>   22: <i>%%%-----------------------------------------------------------------</i>
<a name="23"/>   23: <b>-module</b>(qlc_SUITE).
<a name="24"/>   24: 
<a name="25"/>   25: <b>-define</b>(QLC, qlc).
<a name="26"/>   26: <b>-define</b>(QLCs, &quot;qlc&quot;).
<a name="27"/>   27: 
<a name="28"/>   28: <i>%%-define(debug, true).</i>
<a name="29"/>   29: 
<a name="30"/>   30: <i>%% There are often many tests per testcase. Most tests are copied to a</i>
<a name="31"/>   31: <i>%% module, a file. The file is compiled and the test run. Should the</i>
<a name="32"/>   32: <i>%% test fail, the module file is not removed from ?privdir, but is</i>
<a name="33"/>   33: <i>%% kept for inspection. The name of the file is</i>
<a name="34"/>   34: <i>%% ?privdir/qlc_test_CASE.erl.</i>
<a name="35"/>   35: <b>-define</b>(TESTMODULE, qlc_test).
<a name="36"/>   36: <b>-define</b>(TESTCASE, testcase_name).
<a name="37"/>   37: 
<a name="38"/>   38: <b>-ifdef</b>(debug).
<a name="39"/>   39: <b>-define</b>(line, put(line, ?LINE), ).
<a name="40"/>   40: <b>-define</b>(config(X,Y), foo).
<a name="41"/>   41: <b>-define</b>(datadir, ?QLCs ++  &quot;_SUITE_data&quot;).
<a name="42"/>   42: <b>-define</b>(privdir, ?QLCs ++ &quot;_SUITE_priv&quot;).
<a name="43"/>   43: <b>-define</b>(testcase, current_testcase). % don't know
<a name="44"/>   44: <b>-define</b>(t, test_server).
<a name="45"/>   45: -else.
<a name="46"/>   46: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="47"/>   47: <b>-define</b>(datadir, proplists:get_value(data_dir, Config)).
<a name="48"/>   48: <b>-define</b>(privdir, proplists:get_value(priv_dir, Config)).
<a name="49"/>   49: <b>-define</b>(testcase, proplists:get_value(?TESTCASE, Config)).
<a name="50"/>   50: -endif.
<a name="51"/>   51: 
<a name="52"/>   52: <b>-include_lib</b>(&quot;stdlib/include/ms_transform.hrl&quot;).
<a name="53"/>   53: 
<a name="54"/>   54: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1, 
<a name="55"/>   55: 	 init_per_group/2,end_per_group/2, 
<a name="56"/>   56: 	 init_per_testcase/2, end_per_testcase/2]).
<a name="57"/>   57: 
<a name="58"/>   58: <b>-export</b>([ 
<a name="59"/>   59: 	  badarg/1, nested_qlc/1, unused_var/1, lc/1, fun_clauses/1,
<a name="60"/>   60: 	  filter_var/1, single/1, exported_var/1, generator_vars/1,
<a name="61"/>   61: 	  nomatch/1, errors/1, pattern/1, overridden_bif/1,
<a name="62"/>   62: 
<a name="63"/>   63: 	  eval/1, cursor/1, fold/1, eval_unique/1, eval_cache/1, append/1, 
<a name="64"/>   64: 	  evaluator/1, string_to_handle/1, table/1, process_dies/1, 
<a name="65"/>   65: 	  sort/1, keysort/1, filesort/1, cache/1, cache_list/1, filter/1, 
<a name="66"/>   66: 	  info/1, nested_info/1, lookup1/1, lookup2/1, lookup_rec/1, 
<a name="67"/>   67: 	  indices/1, pre_fun/1, skip_filters/1,
<a name="68"/>   68: 
<a name="69"/>   69: 	  ets/1, dets/1,
<a name="70"/>   70: 
<a name="71"/>   71: 	  join_option/1, join_filter/1, join_lookup/1, join_merge/1,
<a name="72"/>   72: 	  join_sort/1, join_complex/1,
<a name="73"/>   73: 
<a name="74"/>   74: 	  otp_5644/1, otp_5195/1, otp_6038_bug/1, otp_6359/1, otp_6562/1,
<a name="75"/>   75: 	  otp_6590/1, otp_6673/1, otp_6964/1, otp_7114/1, otp_7238/1,
<a name="76"/>   76: 	  otp_7232/1, otp_7552/1, otp_6674/1, otp_7714/1, otp_11758/1,
<a name="77"/>   77:           otp_12946/1,
<a name="78"/>   78: 
<a name="79"/>   79: 	  manpage/1,
<a name="80"/>   80: 
<a name="81"/>   81: 	  backward/1, forward/1,
<a name="82"/>   82: 
<a name="83"/>   83: 	  eep37/1]).
<a name="84"/>   84: 
<a name="85"/>   85: <i>%% Internal exports.</i>
<a name="86"/>   86: <b>-export</b>([bad_table_throw/1, bad_table_exit/1, default_table/1, bad_table/1,
<a name="87"/>   87:          bad_table_format/1, bad_table_format_arity/1, bad_table_traverse/1,
<a name="88"/>   88:          bad_table_post/1, bad_table_lookup/1, bad_table_max_lookup/1,
<a name="89"/>   89:          bad_table_info_arity/1, bad_table_info_fun_n_objects/1,
<a name="90"/>   90:          bad_table_info_fun_indices/1, bad_table_info_fun_keypos/1,
<a name="91"/>   91:          bad_table_key_equality/1]).
<a name="92"/>   92: <b>-export</b>([evaluator_2/2]).
<a name="93"/>   93: <b>-export</b>([prep_scratchdir/1, truncate_tmpfile/2, crash/2, crash_tmpfile/2]).
<a name="94"/>   94: <b>-export</b>([etsc/2, etsc/3, create_ets/2, lookup_keys/1]).
<a name="95"/>   95: <b>-export</b>([strip_qlc_call/1, join_info/1, join_info_count/1]).
<a name="96"/>   96: <b>-export</b>([i/1, i/2, format_info/2]).
<a name="97"/>   97: 
<a name="98"/>   98: <b>-export</b>([table_kill_parent/2, table_parent_throws/2, 
<a name="99"/>   99:          table_parent_exits/2, table_bad_parent_fun/2]).
<a name="100"/>  100: <b>-export</b>([table/2, table/3, stop_list/2, table_error/2, table_error/3, 
<a name="101"/>  101:          table_lookup_error/1]).
<a name="102"/>  102: 
<a name="103"/>  103: <i>%% error_logger</i>
<a name="104"/>  104: <b>-export</b>([install_error_logger/0, uninstall_error_logger/0, 
<a name="105"/>  105:          read_error_logger/0]).
<a name="106"/>  106: <b>-export</b>([init/1,
<a name="107"/>  107: 	 handle_event/2, handle_call/2, handle_info/2,
<a name="108"/>  108: 	 terminate/2]).
<a name="109"/>  109: 
<a name="init_per_testcase-2"/><a name="110"/>  110: <b>init_per_testcase</b>(Case, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="111"/>  111:     [{?TESTCASE, Case} | Config].
<a name="112"/>  112: 
<a name="end_per_testcase-2"/><a name="113"/>  113: <b>end_per_testcase</b>(_Case, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="114"/>  114:     ok.
<a name="115"/>  115: 
<a name="suite-0"/><a name="116"/>  116: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="117"/>  117:     [{ct_hooks,[ts_install_cth]},
<a name="118"/>  118:      {timetrap,{minutes,5}}].
<a name="119"/>  119: 
<a name="all-0"/><a name="120"/>  120: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="121"/>  121:     [{group, parse_transform}, {group, evaluation},
<a name="122"/>  122:      {group, table_impls}, {group, join}, {group, tickets},
<a name="123"/>  123:      manpage, {group, compat}].
<a name="124"/>  124: 
<a name="groups-0"/><a name="125"/>  125: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="126"/>  126:     [{parse_transform, [],
<a name="127"/>  127:       [badarg, nested_qlc, unused_var, lc, fun_clauses,
<a name="128"/>  128:        filter_var, single, exported_var, generator_vars,
<a name="129"/>  129:        nomatch, errors, pattern, overridden_bif]},
<a name="130"/>  130:      {evaluation, [],
<a name="131"/>  131:       [eval, cursor, fold, eval_unique, eval_cache, append,
<a name="132"/>  132:        evaluator, string_to_handle, table, process_dies, sort,
<a name="133"/>  133:        keysort, filesort, cache, cache_list, filter, info,
<a name="134"/>  134:        nested_info, lookup1, lookup2, lookup_rec, indices,
<a name="135"/>  135:        pre_fun, skip_filters, eep37]},
<a name="136"/>  136:      {table_impls, [], [ets, dets]},
<a name="137"/>  137:      {join, [],
<a name="138"/>  138:       [join_option, join_filter, join_lookup, join_merge,
<a name="139"/>  139:        join_sort, join_complex]},
<a name="140"/>  140:      {tickets, [],
<a name="141"/>  141:       [otp_5644, otp_5195, otp_6038_bug, otp_6359, otp_6562,
<a name="142"/>  142:        otp_6590, otp_6673, otp_6964, otp_7114, otp_7232,
<a name="143"/>  143:        otp_7238, otp_7552, otp_6674, otp_7714, otp_11758, otp_12946]},
<a name="144"/>  144:      {compat, [], [backward, forward]}].
<a name="145"/>  145: 
<a name="init_per_suite-1"/><a name="146"/>  146: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="147"/>  147:     Config.
<a name="148"/>  148: 
<a name="end_per_suite-1"/><a name="149"/>  149: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="150"/>  150:     ok.
<a name="151"/>  151: 
<a name="init_per_group-2"/><a name="152"/>  152: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="153"/>  153:     Config.
<a name="154"/>  154: 
<a name="end_per_group-2"/><a name="155"/>  155: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="156"/>  156:     Config.
<a name="157"/>  157: 
<a name="badarg-1"/><a name="158"/>  158: <b>badarg</b>(Config) when is_list(Config) -&gt;
<a name="159"/>  159:     Ts =
<a name="160"/>  160: 	[{badarg,
<a name="161"/>  161: 	  &lt;&lt;&quot;-import(qlc, [q/1, q/2]).
<a name="162"/>  162:           q(_, _, _) -&gt; ok.
<a name="163"/>  163: 
<a name="164"/>  164: badarg() -&gt;
<a name="165"/>  165:     qlc:q(foo),
<a name="166"/>  166:     qlc:q(foo, cache_all),
<a name="167"/>  167:     qlc:q(foo, cache_all, extra),
<a name="168"/>  168:     q(bar),
<a name="169"/>  169:     q(bar, cache_all),
<a name="170"/>  170:     q(bar, cache_all, extra).
<a name="171"/>  171: &quot;&gt;&gt;,
<a name="172"/>  172:        [],
<a name="173"/>  173: {errors,[{{5,5},?QLC,not_a_query_list_comprehension},
<a name="174"/>  174: 	 {{6,5},?QLC,not_a_query_list_comprehension},
<a name="175"/>  175: 	 {{8,5},?QLC,not_a_query_list_comprehension},
<a name="176"/>  176: 	 {{9,5},?QLC,not_a_query_list_comprehension}],
<a name="177"/>  177:  []}}],
<a name="178"/>  178:     [] = compile(Config, Ts),
<a name="badarg-last_expr"/><a name="179"/>  179:     ok.
<a name="180"/>  180: 
<a name="181"/>  181: <i>%% Nested qlc expressions.</i>
<a name="nested_qlc-1"/><a name="182"/>  182: <b>nested_qlc</b>(Config) when is_list(Config) -&gt;
<a name="183"/>  183:     %% Nested QLC expressions. X is bound before the first one; Z and X
<a name="184"/>  184:     %% before the second one.
<a name="185"/>  185:     Ts = 
<a name="186"/>  186:      [{nested_qlc1,
<a name="187"/>  187:        &lt;&lt;&quot;nested_qlc() -&gt;
<a name="188"/>  188:               X = 3, % X unused
<a name="189"/>  189:               Q = qlc:q([Y || 
<a name="190"/>  190:                             X &lt;- % X shadowed
<a name="191"/>  191:                                 begin Z = 3, 
<a name="192"/>  192:                                       qlc:q([Y || 
<a name="193"/>  193:                                                 Y &lt;- [Z],
<a name="194"/>  194:                                                 X &lt;- [1,2,3], % X shadowed
<a name="195"/>  195:                                                 X &lt; Y])
<a name="196"/>  196:                                 end,
<a name="197"/>  197:                             Y &lt;- 
<a name="198"/>  198:                                 [y],
<a name="199"/>  199:                             Y &gt; X]),
<a name="200"/>  200:               [y, y] = qlc:e(Q),
<a name="201"/>  201:               ok.
<a name="202"/>  202:        &quot;&gt;&gt;,
<a name="203"/>  203:        [warn_unused_vars],
<a name="204"/>  204:        {warnings,[{{2,15},erl_lint,{unused_var,'X'}},
<a name="205"/>  205:                   {{4,29},erl_lint,{shadowed_var,'X',generate}},
<a name="206"/>  206:                   {{8,49},erl_lint,{shadowed_var,'X',generate}}]}},
<a name="207"/>  207: 
<a name="208"/>  208:       {nested_qlc2,
<a name="209"/>  209:       &lt;&lt;&quot;nested_qlc() -&gt;
<a name="210"/>  210:              H0 = qlc:append([a,b], [c,d]),
<a name="211"/>  211:              qlc:q([{X,Y} || 
<a name="212"/>  212:                        X &lt;- H0,
<a name="213"/>  213:                        Y &lt;- qlc:q([{X,Y} || 
<a name="214"/>  214:                                       X &lt;- H0, % X shadowed
<a name="215"/>  215:                                       Y &lt;- H0])]),
<a name="216"/>  216:              ok.
<a name="217"/>  217:        &quot;&gt;&gt;,
<a name="218"/>  218:        [warn_unused_vars],
<a name="219"/>  219:        {warnings,[{{6,39},erl_lint,{shadowed_var,'X',generate}}]}}
<a name="220"/>  220:     ],
<a name="221"/>  221:     [] = compile(Config, Ts),
<a name="nested_qlc-last_expr"/><a name="222"/>  222:     ok.
<a name="223"/>  223: 
<a name="224"/>  224: <i>%% Unused variable with a name that should not be introduced.</i>
<a name="unused_var-1"/><a name="225"/>  225: <b>unused_var</b>(Config) when is_list(Config) -&gt;
<a name="226"/>  226:     Ts = 
<a name="227"/>  227:      [{unused_var,
<a name="228"/>  228:        &lt;&lt;&quot;unused_var() -&gt;
<a name="229"/>  229:               qlc:q([X || begin Y1 = 3, true end, % Y1 unused
<a name="230"/>  230:                           Y &lt;- [1,2,3],
<a name="231"/>  231:                           X &lt;- [a,b,c],
<a name="232"/>  232:                           X &lt; Y]).
<a name="233"/>  233:        &quot;&gt;&gt;,
<a name="234"/>  234:        [warn_unused_vars],
<a name="235"/>  235:        {warnings,[{{2,33},erl_lint,{unused_var,'Y1'}}]}}],
<a name="236"/>  236:     [] = compile(Config, Ts),
<a name="unused_var-last_expr"/><a name="237"/>  237:     ok.
<a name="238"/>  238: 
<a name="239"/>  239: <i>%% Ordinary LC expression.</i>
<a name="lc-1"/><a name="240"/>  240: <b>lc</b>(Config) when is_list(Config) -&gt;
<a name="241"/>  241:     Ts = 
<a name="242"/>  242:      [{lc,
<a name="243"/>  243:        &lt;&lt;&quot;lc() -&gt;
<a name="244"/>  244:               [X || X &lt;- [], X &lt;- X]. % X shadowed
<a name="245"/>  245:         &quot;&gt;&gt;,
<a name="246"/>  246:        [],
<a name="247"/>  247:        {warnings,[{{2,30},erl_lint,{shadowed_var,'X',generate}}]}}],
<a name="248"/>  248:     [] = compile(Config, Ts),
<a name="lc-last_expr"/><a name="249"/>  249:     ok.
<a name="250"/>  250:            
<a name="251"/>  251: <i>%% Fun with several clauses.</i>
<a name="fun_clauses-1"/><a name="252"/>  252: <b>fun_clauses</b>(Config) when is_list(Config) -&gt;
<a name="253"/>  253:     Ts = 
<a name="254"/>  254:      [{fun_clauses,
<a name="255"/>  255:        &lt;&lt;&quot;fun_clauses() -&gt;
<a name="256"/>  256:             {X,X1,X2} = {1,2,3},
<a name="257"/>  257:             F = fun({X}) -&gt; qlc:q([X || X &lt;- X]); % X shadowed (fun, generate)
<a name="258"/>  258:                    ([X]) -&gt; qlc:q([X || X &lt;- X])  % X shadowed (fun, generate)
<a name="259"/>  259:                 end,
<a name="260"/>  260:             {F,X,X1,X2}.
<a name="261"/>  261:         &quot;&gt;&gt;,
<a name="262"/>  262:        [],
<a name="263"/>  263:        {warnings,[{{3,22},erl_lint,{shadowed_var,'X','fun'}},
<a name="264"/>  264:                   {{3,41},erl_lint,{shadowed_var,'X',generate}},
<a name="265"/>  265:                   {{4,22},erl_lint,{shadowed_var,'X','fun'}},
<a name="266"/>  266:                   {{4,41},erl_lint,{shadowed_var,'X',generate}}]}}],
<a name="267"/>  267:     [] = compile(Config, Ts),
<a name="fun_clauses-last_expr"/><a name="268"/>  268:     ok.
<a name="269"/>  269: 
<a name="270"/>  270: <i>%% Variable introduced in filter.</i>
<a name="filter_var-1"/><a name="271"/>  271: <b>filter_var</b>(Config) when is_list(Config) -&gt;
<a name="272"/>  272:     Ts = 
<a name="273"/>  273:      [{filter_var,
<a name="274"/>  274:        &lt;&lt;&quot;filter_var() -&gt;
<a name="275"/>  275:               qlc:q([X || 
<a name="276"/>  276:                   Y &lt;- [X || 
<a name="277"/>  277:                            X &lt;- [1,2,3]],
<a name="278"/>  278:                   begin X = Y, true end]).
<a name="279"/>  279:         &quot;&gt;&gt;,
<a name="280"/>  280:        [],
<a name="281"/>  281:        []},
<a name="282"/>  282: 
<a name="283"/>  283:       {unsafe_filter_var,
<a name="284"/>  284:        &lt;&lt;&quot;unsafe_filter_var() -&gt;
<a name="285"/>  285:               qlc:q([{X,V} || X &lt;- [1,2],
<a name="286"/>  286:                   case {a} of
<a name="287"/>  287:                       {_} -&gt;
<a name="288"/>  288:                           true;
<a name="289"/>  289:                       V -&gt;
<a name="290"/>  290:                           V
<a name="291"/>  291:                   end]).
<a name="292"/>  292:         &quot;&gt;&gt;,
<a name="293"/>  293:        [],
<a name="294"/>  294:        {errors,[{{2,25},erl_lint,{unsafe_var,'V',{'case',{3,19}}}}],[]}}],
<a name="295"/>  295:     [] = compile(Config, Ts),
<a name="filter_var-last_expr"/><a name="296"/>  296:     ok.
<a name="297"/>  297: 
<a name="298"/>  298: 
<a name="299"/>  299: <i>%% Unused pattern variable.</i>
<a name="single-1"/><a name="300"/>  300: <b>single</b>(Config) when is_list(Config) -&gt;
<a name="301"/>  301:     Ts = 
<a name="302"/>  302:      [{single,
<a name="303"/>  303:        &lt;&lt;&quot;single() -&gt;
<a name="304"/>  304:               qlc:q([X || {X,Y} &lt;- [{1,2}]]), % Y unused
<a name="305"/>  305:               qlc:q([[] || [] &lt;- [[]]]).
<a name="306"/>  306:         &quot;&gt;&gt;,
<a name="307"/>  307:        [warn_unused_vars],
<a name="308"/>  308:        {warnings,[{{2,30},erl_lint,{unused_var,'Y'}}]}}],
<a name="309"/>  309:     [] = compile(Config, Ts),
<a name="single-last_expr"/><a name="310"/>  310:     ok.
<a name="311"/>  311: 
<a name="312"/>  312: <i>%% Exported variable in list expression (rhs of generator).</i>
<a name="exported_var-1"/><a name="313"/>  313: <b>exported_var</b>(Config) when is_list(Config) -&gt;
<a name="314"/>  314:     Ts = 
<a name="315"/>  315:      [{exported_var,
<a name="316"/>  316:        &lt;&lt;&quot;exported() -&gt;
<a name="317"/>  317:               qlc:q([X || X &lt;- begin
<a name="318"/>  318:                                    case foo:bar() of
<a name="319"/>  319:                                        1 -&gt; Z = a;
<a name="320"/>  320:                                        2 -&gt; Z = b
<a name="321"/>  321:                                    end,
<a name="322"/>  322:                                    [Z = 3, Z = 3] % Z exported (twice...)
<a name="323"/>  323:                                end
<a name="324"/>  324:                          ]).
<a name="325"/>  325:        &quot;&gt;&gt;,
<a name="326"/>  326:        [warn_export_vars],
<a name="327"/>  327:        {warnings,[{{7,37},erl_lint,{exported_var,'Z',{'case',{3,36}}}},
<a name="328"/>  328:                   {{7,44},erl_lint,{exported_var,'Z',{'case',{3,36}}}}]}}],
<a name="329"/>  329:     [] = compile(Config, Ts),
<a name="exported_var-last_expr"/><a name="330"/>  330:     ok.
<a name="331"/>  331: 
<a name="332"/>  332: <i>%% Errors for generator variable used in list expression.</i>
<a name="generator_vars-1"/><a name="333"/>  333: <b>generator_vars</b>(Config) when is_list(Config) -&gt;
<a name="334"/>  334:     Ts = 
<a name="335"/>  335:       [{generator_vars,
<a name="336"/>  336:         &lt;&lt;&quot;generator_vars() -&gt;
<a name="337"/>  337:                qlc:q([X ||
<a name="338"/>  338:                       Z &lt;- [1,2],
<a name="339"/>  339:                       X &lt;- begin
<a name="340"/>  340:                                case 1 of
<a name="341"/>  341:                                    1 -&gt; Z = a; % used_generator_variable
<a name="342"/>  342:                                    2 -&gt; Z = b % used_generator_variable
<a name="343"/>  343:                                end,
<a name="344"/>  344:                                [Z = 3, Z = 3] % used_generator_variable (2)
<a name="345"/>  345:                            end
<a name="346"/>  346:                      ]).
<a name="347"/>  347:         &quot;&gt;&gt;,
<a name="348"/>  348:         [],
<a name="349"/>  349:         {errors,[{{6,41},?QLC,{used_generator_variable,'Z'}},
<a name="350"/>  350:                  {{7,41},?QLC,{used_generator_variable,'Z'}},
<a name="351"/>  351:                  {{9,33},?QLC,{used_generator_variable,'Z'}},
<a name="352"/>  352:                  {{9,40},?QLC,{used_generator_variable,'Z'}}],
<a name="353"/>  353:          []}}],
<a name="354"/>  354:     [] = compile(Config, Ts),
<a name="generator_vars-last_expr"/><a name="355"/>  355:     ok.
<a name="356"/>  356: 
<a name="357"/>  357: <i>%% Unreachable clauses also found when compiling.</i>
<a name="nomatch-1"/><a name="358"/>  358: <b>nomatch</b>(Config) when is_list(Config) -&gt;
<a name="359"/>  359:     Ts =
<a name="360"/>  360:       [{unreachable1,
<a name="361"/>  361:         &lt;&lt;&quot;unreachable1() -&gt;
<a name="362"/>  362:                qlc:q([X || X &lt;- [1,2],
<a name="363"/>  363:                    case X of
<a name="364"/>  364:                        true -&gt; false;
<a name="365"/>  365:                        true -&gt; true   % clause cannot match
<a name="366"/>  366:                     end]).
<a name="367"/>  367:         &quot;&gt;&gt;,
<a name="368"/>  368:         [],
<a name="369"/>  369:         {warnings,[{{5,24},beam_core_to_ssa,{nomatch,{shadow,4}}}]}},
<a name="370"/>  370: 
<a name="371"/>  371:        {nomatch1,
<a name="372"/>  372:         &lt;&lt;&quot;generator1() -&gt;
<a name="373"/>  373:               qlc:q([3 || {3=4} &lt;- []]).
<a name="374"/>  374:         &quot;&gt;&gt;,
<a name="375"/>  375:         [],
<a name="376"/>  376:         %% {warnings,[{{2,27},qlc,nomatch_pattern}]}},
<a name="377"/>  377:         {warnings,[{{2,21},v3_core,{nomatch,pattern}}]}},
<a name="378"/>  378: 
<a name="379"/>  379:        {nomatch2,
<a name="380"/>  380:         &lt;&lt;&quot;nomatch() -&gt;
<a name="381"/>  381:                 etsc(fun(E) -&gt;
<a name="382"/>  382:                 Q = qlc:q([3 || {3=4} &lt;- ets:table(E)]),
<a name="383"/>  383:                 [] = qlc:eval(Q),
<a name="384"/>  384:                 false = lookup_keys(Q) 
<a name="385"/>  385:           end, [{1},{2}]).
<a name="386"/>  386:         &quot;&gt;&gt;,
<a name="387"/>  387:         [],
<a name="388"/>  388:         %% {warnings,[{{3,33},qlc,nomatch_pattern}]}},
<a name="389"/>  389:         {warnings,[{{3,27},v3_core,{nomatch,pattern}}]}},
<a name="390"/>  390:  
<a name="391"/>  391:        {nomatch3,
<a name="392"/>  392:         &lt;&lt;&quot;nomatch() -&gt;
<a name="393"/>  393:               etsc(fun(E) -&gt;
<a name="394"/>  394:                           Q = qlc:q([{A,B,C,D} || A=B={C=D}={_,_} &lt;- 
<a name="395"/>  395:                                                     ets:table(E)]),
<a name="396"/>  396:                           [] = qlc:eval(Q),
<a name="397"/>  397:                           false = lookup_keys(Q)
<a name="398"/>  398:                     end, [{1,2},{2,3}]).
<a name="399"/>  399:         &quot;&gt;&gt;,
<a name="400"/>  400:         [],
<a name="401"/>  401:         %% {warnings,[{{3,52},qlc,nomatch_pattern}]}},
<a name="402"/>  402:         {warnings,[{{3,37},v3_core,{nomatch,pattern}}]}},
<a name="403"/>  403: 
<a name="404"/>  404:        %% No longer illegal in OTP 26.
<a name="405"/>  405:        {nomatch4,
<a name="406"/>  406:         &lt;&lt;&quot;nomatch() -&gt;
<a name="407"/>  407:               etsc(fun(E) -&gt;
<a name="408"/>  408:                           Q = qlc:q([{X,Y} || {&lt;&lt;X&gt;&gt;} = {&lt;&lt;Y&gt;&gt;} &lt;- 
<a name="409"/>  409:                                                     ets:table(E)]),
<a name="410"/>  410:                           [] = qlc:eval(Q),
<a name="411"/>  411:                           false = lookup_keys(Q)
<a name="412"/>  412:                     end, [{&lt;&lt;34&gt;&gt;},{&lt;&lt;40&gt;&gt;}]).
<a name="413"/>  413:         &quot;&gt;&gt;,
<a name="414"/>  414:         [],
<a name="415"/>  415:         []},
<a name="416"/>  416: 
<a name="417"/>  417:        {nomatch5,
<a name="418"/>  418:         &lt;&lt;&quot;nomatch() -&gt;
<a name="419"/>  419:                etsc(fun(E) -&gt;
<a name="420"/>  420:                            Q = qlc:q([t || {\&quot;a\&quot;++\&quot;b\&quot;} = {\&quot;ac\&quot;} &lt;- 
<a name="421"/>  421:                                                     ets:table(E)]),
<a name="422"/>  422:                            [t] = qlc:eval(Q),
<a name="423"/>  423:                            [\&quot;ab\&quot;] = lookup_keys(Q)
<a name="424"/>  424:                      end, [{\&quot;ab\&quot;}]).
<a name="425"/>  425:         &quot;&gt;&gt;,
<a name="426"/>  426:         [],
<a name="427"/>  427:         {warnings,[{{3,38},v3_core,{nomatch,pattern}}]}}
<a name="428"/>  428: 
<a name="429"/>  429:       ],
<a name="430"/>  430:     [] = compile(Config, Ts),
<a name="nomatch-last_expr"/><a name="431"/>  431:     ok.
<a name="432"/>  432:     
<a name="433"/>  433: 
<a name="434"/>  434: <i>%% Errors within qlc expressions also found when compiling.</i>
<a name="errors-1"/><a name="435"/>  435: <b>errors</b>(Config) when is_list(Config) -&gt;
<a name="436"/>  436:     Ts =
<a name="437"/>  437:       [{errors1,
<a name="438"/>  438:         &lt;&lt;&quot;errors1() -&gt;
<a name="439"/>  439:                qlc:q([X || X &lt;- A]). % A unbound
<a name="440"/>  440:         &quot;&gt;&gt;,
<a name="441"/>  441:         [],
<a name="442"/>  442:         {errors,[{{2,33},erl_lint,{unbound_var,'A'}}],[]}}],
<a name="443"/>  443:     [] = compile(Config, Ts),
<a name="errors-last_expr"/><a name="444"/>  444:     ok.
<a name="445"/>  445: 
<a name="446"/>  446: <i>%% Patterns.</i>
<a name="pattern-1"/><a name="447"/>  447: <b>pattern</b>(Config) when is_list(Config) -&gt;
<a name="448"/>  448:     Ts = [
<a name="449"/>  449:       &lt;&lt;&quot;%% Records in patterns. No lookup.
<a name="450"/>  450:          L = [#a{k=#k{v=91}}],
<a name="451"/>  451:          H = qlc:q([Q || Q = #a{k=#k{v=91}} &lt;- qlc_SUITE:table(L, 2, [])]),
<a name="452"/>  452:          {qlc,_,[{generate,_,{table,{call,_,_,_}}}], []} = i(H),
<a name="453"/>  453:          L = qlc:e(H),
<a name="454"/>  454:          {call, _, _q, [{lc,_,{var,_,'Q'}, 
<a name="455"/>  455:                          [{generate,_,
<a name="456"/>  456:                            {match,_,_,_},
<a name="457"/>  457:                            {call,_,_,_}}]}]}
<a name="458"/>  458:               = i(H, {format,abstract_code})&quot;&gt;&gt;,
<a name="459"/>  459: 
<a name="460"/>  460:       &lt;&lt;&quot;%% No matchspec since there is a binary in the pattern.
<a name="461"/>  461:          etsc(fun(E) -&gt;
<a name="462"/>  462:              Q = qlc:q([A || {&lt;&lt;A:3/unit:8&gt;&gt;} &lt;- ets:table(E)]),
<a name="463"/>  463:              [_] = qlc:eval(Q),
<a name="464"/>  464:              {qlc,_,[{generate,_,{table,_}}], []} = i(Q)
<a name="465"/>  465:          end, [{&lt;&lt;\&quot;hej\&quot;&gt;&gt;}])&quot;&gt;&gt;
<a name="466"/>  466: 
<a name="467"/>  467:        ],
<a name="468"/>  468:     run(Config, &lt;&lt;&quot;-record(a, {k,v}).
<a name="469"/>  469:                          -record(k, {t,v}).\n&quot;&gt;&gt;, Ts),
<a name="pattern-last_expr"/><a name="470"/>  470:     ok.
<a name="471"/>  471: 
<a name="472"/>  472: <i>%% Override a guard BIF with an imported or local function.</i>
<a name="overridden_bif-1"/><a name="473"/>  473: <b>overridden_bif</b>(Config) -&gt;
<a name="474"/>  474:     Ts = [
<a name="475"/>  475: 	  &lt;&lt;&quot;[2] = qlc:e(qlc:q([P || P &lt;- [1,2,3], port(P)])),
<a name="476"/>  476:              [10] = qlc:e(qlc:q([P || P &lt;- [0,9,10,11,12],
<a name="477"/>  477:                                       (is_reference(P) andalso P &gt; 5)])),
<a name="478"/>  478:              Empty = gb_sets:empty(), Single = gb_sets:singleton(42),
<a name="479"/>  479:              GbSets = [Empty,Single],
<a name="480"/>  480:              [Single] = qlc:e(qlc:q([S || S &lt;- GbSets, size(S) =/= 0]))
<a name="481"/>  481:             &quot;&gt;&gt;
<a name="482"/>  482: 	 ],
<a name="483"/>  483:     run(Config, &quot;-import(gb_sets, [size/1]).
<a name="484"/>  484:                  -compile({no_auto_import, [size/1, is_reference/1]}).
<a name="485"/>  485:                  port(N) -&gt; N rem 2 =:= 0.
<a name="486"/>  486:                  is_reference(N) -&gt; N rem 10 =:= 0.\n&quot;, Ts),
<a name="overridden_bif-last_expr"/><a name="487"/>  487:     ok.
<a name="488"/>  488: 
<a name="489"/>  489: 
<a name="490"/>  490: <i>%% eval/2</i>
<a name="eval-1"/><a name="491"/>  491: <b>eval</b>(Config) when is_list(Config) -&gt;
<a name="492"/>  492:     ScratchDir = filename:join([?privdir, &quot;scratch&quot;,&quot;.&quot;]),
<a name="493"/>  493: 
<a name="494"/>  494:     Ts = [&lt;&lt;&quot;{'EXIT',{badarg,_}} = (catch qlc:eval(not_a_qlc)),
<a name="495"/>  495:              H = qlc:q([X || X &lt;- [1,2]]),
<a name="496"/>  496:              {'EXIT',{{unsupported_qlc_handle,{qlc_handle,foo}},_}}=
<a name="497"/>  497:                        (catch qlc:e({qlc_handle,foo})),
<a name="498"/>  498:              {'EXIT',{badarg,_}} = (catch qlc:eval(H, [{unique_all,badarg}])),
<a name="499"/>  499:              {'EXIT',{badarg,_}} = 
<a name="500"/>  500:                       (catch qlc:eval(H, [{spawn_options,badarg}])),
<a name="501"/>  501:              {'EXIT',{badarg,_}} = 
<a name="502"/>  502:                       (catch qlc:eval(H, [{unique_all,true},{bad,arg}])),
<a name="503"/>  503:              {throw,t} = 
<a name="504"/>  504:                 (catch {any_term,qlc:e(qlc:q([X || X &lt;- throw({throw,t})]))}),
<a name="505"/>  505:              M = qlc,
<a name="506"/>  506:              {'EXIT',{badarg,_}} = (catch M:q(bad))&quot;&gt;&gt;,
<a name="507"/>  507: 
<a name="508"/>  508:           [&lt;&lt;&quot;Dir = \&quot;&quot;&gt;&gt;,ScratchDir,&lt;&lt;&quot;\&quot;,
<a name="509"/>  509:               qlc_SUITE:prep_scratchdir(Dir),
<a name="510"/>  510: 
<a name="511"/>  511:               E = ets:new(foo, []),
<a name="512"/>  512:               [true || I &lt;- lists:seq(1, 50000), not ets:insert(E, {I, I})],
<a name="513"/>  513:               H = qlc:q([{X,Y} || Y &lt;- [1,2], 
<a name="514"/>  514:                                   X &lt;- qlc:sort(ets:table(E),{tmpdir,Dir}),
<a name="515"/>  515:                                   qlc_SUITE:truncate_tmpfile(Dir, 0)]),
<a name="516"/>  516:               R = qlc:eval(H),
<a name="517"/>  517:               ets:delete(E),
<a name="518"/>  518:               {error,_,{bad_object,_}} = R,
<a name="519"/>  519:               \&quot;the tempo\&quot; ++ _ = lists:flatten(qlc:format_error(R))&quot;&gt;&gt;],
<a name="520"/>  520: 
<a name="521"/>  521:           [&lt;&lt;&quot;Dir = \&quot;&quot;&gt;&gt;,ScratchDir,&lt;&lt;&quot;\&quot;,
<a name="522"/>  522:               qlc_SUITE:prep_scratchdir(Dir),
<a name="523"/>  523: 
<a name="524"/>  524:               E = ets:new(foo, []),
<a name="525"/>  525:               Bin = term_to_binary(lists:seq(1,20000)),
<a name="526"/>  526:               [true || I &lt;- lists:seq(1, 10), not ets:insert(E, {I, I, Bin})],
<a name="527"/>  527:               H = qlc:q([{X,Y} || Y &lt;- [1,2], 
<a name="528"/>  528:                                   X &lt;- qlc:sort(ets:table(E),{tmpdir,Dir}),
<a name="529"/>  529:                                   qlc_SUITE:crash_tmpfile(Dir, 5)]),
<a name="530"/>  530:               R = qlc:eval(H),
<a name="531"/>  531:               ets:delete(E),
<a name="532"/>  532:               {error,_,{bad_object,_}} = R&quot;&gt;&gt;],
<a name="533"/>  533: 
<a name="534"/>  534:           &lt;&lt;&quot;E = ets:new(test, []),
<a name="535"/>  535:              H = qlc:q([{X,Y} || X &lt;- qlc_SUITE:bad_table_throw(E), 
<a name="536"/>  536:                                  Y &lt;- ets:table(E)]),
<a name="537"/>  537:              R1 = (catch {any_term,qlc:eval(H, {unique_all,false})}),
<a name="538"/>  538:              R2 = (catch {any_term,qlc:eval(H, {unique_all,true})}),
<a name="539"/>  539:              ets:delete(E),
<a name="540"/>  540:              true = {throw,bad_pre_fun} == R1,
<a name="541"/>  541:              true = {throw,bad_pre_fun} == R2&quot;&gt;&gt;,
<a name="542"/>  542: 
<a name="543"/>  543:           &lt;&lt;&quot;E = ets:new(test, []),
<a name="544"/>  544:              H = qlc:q([{X,Y} || X &lt;- qlc_SUITE:bad_table_exit(E), 
<a name="545"/>  545:                                  Y &lt;- ets:table(E)]),
<a name="546"/>  546:              R1 = (catch qlc:eval(H, {unique_all,false})),
<a name="547"/>  547:              R2 = (catch qlc:eval(H, {unique_all,true})),
<a name="548"/>  548:              ets:delete(E),
<a name="549"/>  549:              {'EXIT',{bad_pre_fun,_}} = R1,
<a name="550"/>  550:              {'EXIT',{bad_pre_fun,_}} = R2&quot;&gt;&gt;,
<a name="551"/>  551: 
<a name="552"/>  552:           &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [4,3,2,1,0,-1], begin 3/X &gt; 0 end]),
<a name="553"/>  553:              {'EXIT',{badarith,_}} = (catch qlc:eval(Q, {unique_all,false})),
<a name="554"/>  554:              {'EXIT',{badarith,_}} = (catch qlc:eval(Q, {unique_all,true}))
<a name="555"/>  555:             &quot;&gt;&gt;,
<a name="556"/>  556: 
<a name="557"/>  557:           &lt;&lt;&quot;[1,2] = qlc:eval(qlc:q([X || X &lt;- [1,2]])),
<a name="558"/>  558:              [1,2,3,4] = qlc:eval(qlc:append([1,2],[3,4])),
<a name="559"/>  559:              [1,2] = qlc:eval(qlc:sort([2,1])),
<a name="560"/>  560:              E = ets:new(foo, []),
<a name="561"/>  561:              ets:insert(E, [{1},{2}]),
<a name="562"/>  562:              [{1},{2}] = lists:sort(qlc:eval(ets:table(E))),
<a name="563"/>  563:              true = ets:delete(E)&quot;&gt;&gt;,
<a name="564"/>  564: 
<a name="565"/>  565:           &lt;&lt;&quot;H = qlc:q([X || X &lt;- [1,2], 
<a name="566"/>  566:                              begin F = fun() -&gt; 
<a name="567"/>  567:                                 qlc:e(qlc:q([Y || Y &lt;- [1,2]])) end, 
<a name="568"/>  568:                                 F() == (fun f/0)() end]),
<a name="569"/>  569:              [1,2] = qlc:e(H),
<a name="570"/>  570:              ok.
<a name="571"/>  571: 
<a name="572"/>  572:              f() -&gt; [1,2].
<a name="573"/>  573:              foo() -&gt; bar&quot;&gt;&gt;,
<a name="574"/>  574: 
<a name="575"/>  575:           &lt;&lt;&quot;C1_0_1 = [1,2],
<a name="576"/>  576:              %% The PT cannot rename C to C1_0_1; another name is chosen.
<a name="577"/>  577:              [1,2] = qlc:eval(qlc:q([C || C &lt;- C1_0_1]))&quot;&gt;&gt;,
<a name="578"/>  578: 
<a name="579"/>  579:           &lt;&lt;&quot;H = qlc:q([X || {X,X} &lt;- [{1,a},{2,2},{b,b},{3,4}]]),
<a name="580"/>  580:              [2,b] = qlc:e(H),
<a name="581"/>  581:              H1 = qlc:q([3 || {X,X} &lt;- [{1,a},{2,2},{b,b},{3,4}]]),
<a name="582"/>  582:              [3,3] = qlc:e(H1)&quot;&gt;&gt;,
<a name="583"/>  583: 
<a name="584"/>  584:           %% Just to cover a certain line in qlc.erl (avoids returning [])
<a name="585"/>  585:           &lt;&lt;&quot;E = ets:new(foo, []),
<a name="586"/>  586:              Bin = term_to_binary(lists:seq(1,20000)),
<a name="587"/>  587:              [true || I &lt;- lists:seq(1, 10), not ets:insert(E, {I, I, Bin})],
<a name="588"/>  588:              H = qlc:q([{X,Y} || Y &lt;- [1,2], X &lt;- qlc:sort(ets:table(E))]),
<a name="589"/>  589:              R = qlc:eval(H),
<a name="590"/>  590:              ets:delete(E),
<a name="591"/>  591:              20 = length(R)&quot;&gt;&gt;,
<a name="592"/>  592: 
<a name="593"/>  593:           &lt;&lt;&quot;H = qlc:q([{A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W} ||
<a name="594"/>  594:                  {A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W} &lt;- 
<a name="595"/>  595:                   [{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w}]]),
<a name="596"/>  596:              [_] = qlc:e(H)&quot;&gt;&gt;,
<a name="597"/>  597: 
<a name="598"/>  598:           &lt;&lt;&quot;H = qlc:q([Y || Y &lt;- [1,2]], 
<a name="599"/>  599:                        {unique, begin [T] = qlc:e(qlc:q([X || X &lt;- [true]],
<a name="600"/>  600:                                                         cache)), 
<a name="601"/>  601:                                       T end}),
<a name="602"/>  602:              [1,2] = qlc:e(H)&quot;&gt;&gt;
<a name="603"/>  603: 
<a name="604"/>  604:           ],
<a name="605"/>  605:     
<a name="606"/>  606:     run(Config, Ts),
<a name="eval-last_expr"/><a name="607"/>  607:     ok.
<a name="608"/>  608: 
<a name="609"/>  609: <i>%% cursor/2</i>
<a name="cursor-1"/><a name="610"/>  610: <b>cursor</b>(Config) when is_list(Config) -&gt;
<a name="611"/>  611:     ScratchDir = filename:join([?privdir, &quot;scratch&quot;,&quot;.&quot;]),
<a name="612"/>  612:     Ts = [&lt;&lt;&quot;{'EXIT',{badarg,_}} = 
<a name="613"/>  613:                    (catch qlc:cursor(fun() -&gt; not_a_cursor end)),
<a name="614"/>  614:              H0 = qlc:q([X || X &lt;- throw({throw,t})]),
<a name="615"/>  615:              {throw,t} = (catch {any_term,qlc:cursor(H0)}),
<a name="616"/>  616:              H = qlc:q([X || X &lt;- [1,2]]),
<a name="617"/>  617:              {'EXIT',{badarg,_}} = 
<a name="618"/>  618:                        (catch qlc:cursor(H,{spawn_options, [a|b]})),
<a name="619"/>  619:              {'EXIT',{badarg,_}} = 
<a name="620"/>  620:                        (catch qlc:cursor(H,{bad_option,true}))&quot;&gt;&gt;,
<a name="621"/>  621: 
<a name="622"/>  622:           &lt;&lt;&quot;{'EXIT',{badarg,_}} = (catch qlc:delete_cursor(not_a_cursor))&quot;&gt;&gt;,
<a name="623"/>  623: 
<a name="624"/>  624:           [&lt;&lt;&quot;Dir = \&quot;&quot;&gt;&gt;,ScratchDir,&lt;&lt;&quot;\&quot;,
<a name="625"/>  625:               qlc_SUITE:prep_scratchdir(Dir), % kludge
<a name="626"/>  626:               E = ets:new(foo, []),
<a name="627"/>  627:               [true || I &lt;- lists:seq(1, 50000), not ets:insert(E, {I, I})],
<a name="628"/>  628:               H = qlc:q([{X,Y} || begin put('$qlc_tmpdir', true), true end,
<a name="629"/>  629:                                   Y &lt;- [1,2], 
<a name="630"/>  630:                                   X &lt;- qlc:sort(ets:table(E),{tmpdir,Dir}),
<a name="631"/>  631:                                   qlc_SUITE:truncate_tmpfile(Dir, 0)]),
<a name="632"/>  632:               C = qlc:cursor(H),
<a name="633"/>  633:               R = qlc:next_answers(C, all_remaining),
<a name="634"/>  634:               qlc:delete_cursor(C),
<a name="635"/>  635:               erase('$qlc_tmpdir'),
<a name="636"/>  636:               ets:delete(E),
<a name="637"/>  637:               {error,_,{bad_object,_}} = R&quot;&gt;&gt;],
<a name="638"/>  638: 
<a name="639"/>  639:           &lt;&lt;&quot;H1 = qlc:q([X || X &lt;- [1,2]]),
<a name="640"/>  640:              C1 = qlc:cursor(H1),
<a name="641"/>  641:              [1,2] = qlc:next_answers(C1, all_remaining),
<a name="642"/>  642:              [] = qlc:next_answers(C1),
<a name="643"/>  643:              [] = qlc:next_answers(C1),
<a name="644"/>  644:              ok = qlc:delete_cursor(C1),
<a name="645"/>  645: 
<a name="646"/>  646:              H2 = qlc:append([1,2],[3,4]),
<a name="647"/>  647:              C2 = qlc:cursor(H2),
<a name="648"/>  648:              [1,2,3,4] = qlc:next_answers(C2, all_remaining),
<a name="649"/>  649:              ok = qlc:delete_cursor(C2),
<a name="650"/>  650: 
<a name="651"/>  651:              H3 = qlc:sort([2,1]),
<a name="652"/>  652:              C3 = qlc:cursor(H3),
<a name="653"/>  653:              [1,2] = qlc:next_answers(C3, all_remaining),
<a name="654"/>  654:              ok = qlc:delete_cursor(C3),
<a name="655"/>  655:              
<a name="656"/>  656:              E = ets:new(foo, []),
<a name="657"/>  657:              ets:insert(E, [{1},{2}]),
<a name="658"/>  658:              H4 = ets:table(E),
<a name="659"/>  659:              C4 = qlc:cursor(H4),
<a name="660"/>  660:              [{1},{2}] = lists:sort(qlc:next_answers(C4, all_remaining)),
<a name="661"/>  661:              ok = qlc:delete_cursor(C4),
<a name="662"/>  662:              true = ets:delete(E)&quot;&gt;&gt;,
<a name="663"/>  663: 
<a name="664"/>  664:           &lt;&lt;&quot;H = qlc:q([{X,Y} || X &lt;- [1,2], Y &lt;- [a,b]]),
<a name="665"/>  665:              C = qlc:cursor(H, []),
<a name="666"/>  666:              [{1,a},{1,b}] = qlc:next_answers(C, 2),
<a name="667"/>  667:              [{2,a}] = qlc:next_answers(C, 1),
<a name="668"/>  668:              [{2,b}] = qlc:next_answers(C, all_remaining),
<a name="669"/>  669:              {'EXIT',{badarg,_}} = (catch qlc:next_answers(C, -1)),
<a name="670"/>  670:              P = self(),
<a name="671"/>  671:              Pid1 = spawn_link(fun() -&gt; 
<a name="672"/>  672:                           {'EXIT',{not_cursor_owner,_}} = 
<a name="673"/>  673:                                 (catch qlc:delete_cursor(C)),
<a name="674"/>  674:                           P ! {self(), done} end),
<a name="675"/>  675:              Pid2 = spawn_link(fun() -&gt; 
<a name="676"/>  676:                           {'EXIT',{not_cursor_owner,_}} = 
<a name="677"/>  677:                                 (catch qlc:next_answers(C)),
<a name="678"/>  678:                           P ! {self(), done} end),
<a name="679"/>  679:              receive {Pid1, done} -&gt; ok end,
<a name="680"/>  680:              receive {Pid2, done} -&gt; ok end,
<a name="681"/>  681:              ok = qlc:delete_cursor(C),
<a name="682"/>  682:              {'EXIT',{badarg,_}} = (catch qlc:next_answers(not_a_cursor)),
<a name="683"/>  683:              ok = qlc:delete_cursor(C)&quot;&gt;&gt;,
<a name="684"/>  684: 
<a name="685"/>  685:           &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [1,2,1,2,1]]),
<a name="686"/>  686:              C1 = qlc:cursor(Q, [{unique_all,true}]),
<a name="687"/>  687:              [1,2] = qlc:next_answers(C1, all_remaining),
<a name="688"/>  688:              ok = qlc:delete_cursor(C1),
<a name="689"/>  689:              C2 = qlc:cursor(Q, [{unique_all,true}]),
<a name="690"/>  690:              [1,2] = qlc:next_answers(C2, all_remaining),
<a name="691"/>  691:              ok = qlc:delete_cursor(C2)&quot;&gt;&gt;,
<a name="692"/>  692: 
<a name="693"/>  693:           &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [1,2,1,2,1]]),
<a name="694"/>  694:              C1 = qlc:cursor(Q, [{unique_all,true},{spawn_options, []}]),
<a name="695"/>  695:              [1,2] = qlc:next_answers(C1, all_remaining),
<a name="696"/>  696:              ok = qlc:delete_cursor(C1),
<a name="697"/>  697:              C2 = qlc:cursor(Q, [{unique_all,true},{spawn_options, default}]),
<a name="698"/>  698:              [1,2] = qlc:next_answers(C2, all_remaining),
<a name="699"/>  699:              ok = qlc:delete_cursor(C2)&quot;&gt;&gt;,
<a name="700"/>  700: 
<a name="701"/>  701:           &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [1,2,1,2,1]]),
<a name="702"/>  702:              C1 = qlc:cursor(Q, [{unique_all,false},{spawn_options, []}]),
<a name="703"/>  703:              [1,2,1,2,1] = qlc:next_answers(C1, all_remaining),
<a name="704"/>  704:              ok = qlc:delete_cursor(C1),
<a name="705"/>  705:              C2 = qlc:cursor(Q, [{unique_all,false},{spawn_options, []}]),
<a name="706"/>  706:              [1,2,1,2,1] = qlc:next_answers(C2, all_remaining),
<a name="707"/>  707:              ok = qlc:delete_cursor(C2)&quot;&gt;&gt;,
<a name="708"/>  708: 
<a name="709"/>  709:           &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [1,2,1,2,1]]),
<a name="710"/>  710:              C1 = qlc:cursor(Q, [{unique_all,false}]),
<a name="711"/>  711:              [1,2,1,2,1] = qlc:next_answers(C1, all_remaining),
<a name="712"/>  712:              ok = qlc:delete_cursor(C1),
<a name="713"/>  713:              C2 = qlc:cursor(Q, [{unique_all,false}]),
<a name="714"/>  714:              [1,2,1,2,1] = qlc:next_answers(C2, all_remaining),
<a name="715"/>  715:              ok = qlc:delete_cursor(C2)&quot;&gt;&gt;
<a name="716"/>  716: 
<a name="717"/>  717:          ],
<a name="718"/>  718:     run(Config, Ts),
<a name="cursor-last_expr"/><a name="719"/>  719:     ok.
<a name="720"/>  720: 
<a name="721"/>  721: <i>%% fold/4</i>
<a name="fold-1"/><a name="722"/>  722: <b>fold</b>(Config) when is_list(Config) -&gt;
<a name="723"/>  723:     ScratchDir = filename:join([?privdir, &quot;scratch&quot;,&quot;.&quot;]),
<a name="724"/>  724:     Ts = [&lt;&lt;&quot;Q = qlc:q([X || X &lt;- [1,2,1,2,1]]),
<a name="725"/>  725:              F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="726"/>  726:              {'EXIT',{badarg,_}} = (catch qlc:fold(F, [], Q, {bad,arg})),
<a name="727"/>  727:              {'EXIT',{badarg,_}} = (catch qlc:fold(F, [], badarg)),
<a name="728"/>  728:              {'EXIT',{badarg,_}} = 
<a name="729"/>  729:                (catch qlc:fold(F, [], {spawn_options, [a|b]})),
<a name="730"/>  730:              H = qlc:q([X || X &lt;- throw({throw,t})]),
<a name="731"/>  731:              {throw,t} = (catch {any_term,qlc:fold(F, [], H)}),
<a name="732"/>  732:              [1,2] = qlc:fold(F, [], Q, {unique_all,true}),
<a name="733"/>  733:              {'EXIT',{badarg,_}} = 
<a name="734"/>  734:                (catch qlc:fold(F, [], Q, [{unique_all,bad}])),
<a name="735"/>  735:              [1,2,1,2,1] = 
<a name="736"/>  736:                   qlc:fold(F, [], Q, [{unique_all,false}])&quot;&gt;&gt;,
<a name="737"/>  737: 
<a name="738"/>  738:           [&lt;&lt;&quot;Dir = \&quot;&quot;&gt;&gt;,ScratchDir,&lt;&lt;&quot;\&quot;,
<a name="739"/>  739:               qlc_SUITE:prep_scratchdir(Dir),
<a name="740"/>  740: 
<a name="741"/>  741:               E = ets:new(foo, []),
<a name="742"/>  742:               [true || I &lt;- lists:seq(1, 50000), not ets:insert(E, {I, I})],
<a name="743"/>  743:               H = qlc:q([{X,Y} || Y &lt;- [1,2], 
<a name="744"/>  744:                                   X &lt;- qlc:sort(ets:table(E),{tmpdir,Dir}),
<a name="745"/>  745:                                   qlc_SUITE:truncate_tmpfile(Dir, 0)]),
<a name="746"/>  746:               F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="747"/>  747:               R = qlc:fold(F, [], H),
<a name="748"/>  748:               ets:delete(E),
<a name="749"/>  749:               {error,_,{bad_object,_}} = R&quot;&gt;&gt;],
<a name="750"/>  750: 
<a name="751"/>  751:           &lt;&lt;&quot;E = ets:new(test, []),
<a name="752"/>  752:              H = qlc:q([{X,Y} || X &lt;- qlc_SUITE:bad_table_throw(E), 
<a name="753"/>  753:                                  Y &lt;- ets:table(E)]),
<a name="754"/>  754:              F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="755"/>  755:              R1 = (catch {any_term,qlc:fold(F, [], H, {unique_all,false})}),
<a name="756"/>  756:              R2 = (catch {any_term,qlc:fold(F, [], H, {unique_all,true})}),
<a name="757"/>  757:              ets:delete(E),
<a name="758"/>  758:              true = {throw,bad_pre_fun} == R1,
<a name="759"/>  759:              true = {throw,bad_pre_fun} == R2&quot;&gt;&gt;,
<a name="760"/>  760: 
<a name="761"/>  761:           &lt;&lt;&quot;E = ets:new(test, []),
<a name="762"/>  762:              H = qlc:q([{X,Y} || X &lt;- qlc_SUITE:bad_table_exit(E), 
<a name="763"/>  763:                                  Y &lt;- ets:table(E)]),
<a name="764"/>  764:              F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="765"/>  765:              R1 = (catch qlc:fold(F, [], H, {unique_all,false})),
<a name="766"/>  766:              R2 = (catch qlc:fold(F, [], H, {unique_all,true})),
<a name="767"/>  767:              ets:delete(E),
<a name="768"/>  768:              {'EXIT',{bad_pre_fun,_}} = R1,
<a name="769"/>  769:              {'EXIT',{bad_pre_fun,_}} = R2&quot;&gt;&gt;,
<a name="770"/>  770: 
<a name="771"/>  771:           &lt;&lt;&quot;F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="772"/>  772:              Q = qlc:q([X || X &lt;- [1,2,1,2,1], throw({throw,wrong})]),
<a name="773"/>  773:              {throw,wrong} = 
<a name="774"/>  774:                  (catch {any_term,qlc:fold(F, [], Q, {unique_all,true})}),
<a name="775"/>  775:              {throw,wrong} = 
<a name="776"/>  776:                  (catch {any_term,qlc:fold(F, [], Q)})&quot;&gt;&gt;,
<a name="777"/>  777: 
<a name="778"/>  778:           &lt;&lt;&quot;F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="779"/>  779:              Q = qlc:q([X || X &lt;- [4,3,2,1,0,-1], begin 3/X &gt; 0 end]),
<a name="780"/>  780:              {'EXIT',{badarith,_}} = 
<a name="781"/>  781:                        (catch qlc:fold(F, [], Q, {unique_all,true})),
<a name="782"/>  782:              {'EXIT',{badarith,_}} = 
<a name="783"/>  783:                  (catch qlc:fold(F, [], Q, [{unique_all,false}]))
<a name="784"/>  784:             &quot;&gt;&gt;,
<a name="785"/>  785: 
<a name="786"/>  786:           &lt;&lt;&quot;F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="787"/>  787:              [1,2] = qlc:fold(F, [], qlc:q([X || X &lt;- [1,2]])),
<a name="788"/>  788:              [1,2,3,4] = qlc:fold(F, [], qlc:append([1,2],[3,4])),
<a name="789"/>  789:              [1,2] = qlc:fold(F, [], qlc:sort([2,1])),
<a name="790"/>  790:              E = ets:new(foo, []),
<a name="791"/>  791:              ets:insert(E, [{1},{2}]),
<a name="792"/>  792:              [{1},{2}] = lists:sort(qlc:fold(F, [], ets:table(E))),
<a name="793"/>  793:              true = ets:delete(E)&quot;&gt;&gt;,
<a name="794"/>  794: 
<a name="795"/>  795:           &lt;&lt;&quot;F = fun(_Obj, _A) -&gt; throw({throw,fatal}) end,
<a name="796"/>  796:              Q = qlc:q([X || X &lt;- [4,3,2]]),
<a name="797"/>  797:              {throw,fatal} = 
<a name="798"/>  798:               (catch {any_term,qlc:fold(F, [], Q, {unique_all,true})}),
<a name="799"/>  799:              {throw,fatal} = 
<a name="800"/>  800:                (catch {any_term,qlc:fold(F, [], Q, [{unique_all,false}])})&quot;&gt;&gt;,
<a name="801"/>  801: 
<a name="802"/>  802:           &lt;&lt;&quot;G = fun(_Obj, _A, D) -&gt; 17/D  end,
<a name="803"/>  803:              F = fun(Obj, A) -&gt; G(Obj, A, 0) end,
<a name="804"/>  804:              Q = qlc:q([X || X &lt;- [4,3,2]]),
<a name="805"/>  805:              {'EXIT',{badarith,_}} = 
<a name="806"/>  806:                     (catch qlc:fold(F, [], Q, {unique_all,true})),
<a name="807"/>  807:              {'EXIT',{badarith,_}} = 
<a name="808"/>  808:                (catch qlc:fold(F, [], Q, [{unique_all,false}]))
<a name="809"/>  809:             &quot;&gt;&gt;
<a name="810"/>  810:          ],
<a name="811"/>  811:     run(Config, Ts),
<a name="fold-last_expr"/><a name="812"/>  812:     ok.
<a name="813"/>  813: 
<a name="814"/>  814: <i>%% Test the unique_all option of eval.</i>
<a name="eval_unique-1"/><a name="815"/>  815: <b>eval_unique</b>(Config) when is_list(Config) -&gt;
<a name="816"/>  816:     Ts = [&lt;&lt;&quot;QLC1 = qlc:q([X || X &lt;- qlc:append([[1,1,2], [1,2,3,2,3]])]),
<a name="817"/>  817:              [1,2,3] = qlc:eval(QLC1, {unique_all,true}),
<a name="818"/>  818:              QLC2 = qlc:q([X || X &lt;- [1,2,1,2,1,2,1]]),
<a name="819"/>  819:              [1,2] = qlc:e(QLC2, {unique_all,true})&quot;&gt;&gt;,
<a name="820"/>  820: 
<a name="821"/>  821:           &lt;&lt;&quot;E = ets:new(test, []),
<a name="822"/>  822:              true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="823"/>  823:              H = qlc:q([X || X &lt;- qlc:append([ets:table(E), ets:table(E)])]),
<a name="824"/>  824:              R1 = qlc:e(H, {unique_all,false}),
<a name="825"/>  825:              R2 = qlc:e(H, {unique_all,true}),
<a name="826"/>  826:              ets:delete(E),
<a name="827"/>  827:              true = lists:sort(R1) == [{1,a},{1,a},{2,b},{2,b},{3,c},{3,c}],
<a name="828"/>  828:              true = lists:sort(R2) == [{1,a},{2,b},{3,c}]
<a name="829"/>  829:             &quot;&gt;&gt;,
<a name="830"/>  830: 
<a name="831"/>  831:           &lt;&lt;&quot;Q1 = qlc:q([{X,make_ref()} || X &lt;- [1,2,1,2]]),
<a name="832"/>  832:              [_,_] = qlc:e(Q1, {unique_all,true}),
<a name="833"/>  833:              [_,_,_,_] = qlc:e(Q1, {unique_all,false}),
<a name="834"/>  834:              [_,_] = qlc:e(Q1, [{unique_all,true}]),
<a name="835"/>  835:              Q2 = qlc:q([{X,make_ref()} || X &lt;- qlc:append([[1,2,1,2]])]),
<a name="836"/>  836:              [_,_] = qlc:e(Q2, {unique_all,true}),
<a name="837"/>  837:              [_,_,_,_] = qlc:e(Q2, {unique_all,false}),
<a name="838"/>  838:              [_,_] = qlc:e(Q2, [{unique_all,true}])
<a name="839"/>  839:             &quot;&gt;&gt;,
<a name="840"/>  840: 
<a name="841"/>  841:           &lt;&lt;&quot;Q = qlc:q([{X,make_ref()} || X &lt;- qlc:sort([1,2,1,2])]),
<a name="842"/>  842:              [_, _] = qlc:e(Q, {unique_all,true}),
<a name="843"/>  843:              Q1 = qlc:q([X || X &lt;- [1,2,1,2]]),
<a name="844"/>  844:              Q2 = qlc:q([{X,make_ref()} || X &lt;- qlc:sort(Q1)]),
<a name="845"/>  845:              [_, _] = qlc:e(Q2, {unique_all,true})
<a name="846"/>  846:             &quot;&gt;&gt;,
<a name="847"/>  847: 
<a name="848"/>  848:           &lt;&lt;&quot;E = ets:new(test, []),
<a name="849"/>  849:              true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="850"/>  850:              H = qlc:q([X || X &lt;- qlc:append([[1,2,1,2]])]),
<a name="851"/>  851:              [1,2,1,2] = qlc:e(H, {unique_all,false}),
<a name="852"/>  852:              [1,2] = qlc:e(H, {unique_all,true}),
<a name="853"/>  853:              ets:delete(E)&quot;&gt;&gt;,
<a name="854"/>  854: 
<a name="855"/>  855:           &lt;&lt;&quot;E = ets:new(foo, [duplicate_bag]),
<a name="856"/>  856:              true = ets:insert(E, [{1,a},{1,a},{2,b},{3,c},{4,c},{4,d}]),
<a name="857"/>  857:              Q1 = qlc:q([{X,make_ref()} || {_, X} &lt;- ets:table(E)]),
<a name="858"/>  858:              true = length(qlc:eval(Q1, {unique_all, true})) =:= 5,
<a name="859"/>  859:              Q2 = qlc:q([X || {_, X} &lt;- ets:table(E)]),
<a name="860"/>  860:              true = length(qlc:eval(Q2, {unique_all, true})) =:= 4,
<a name="861"/>  861:              Q3 = qlc:q([element(2, X) || X &lt;- ets:table(E)]),
<a name="862"/>  862:              true = length(qlc:eval(Q3, {unique_all, true})) =:= 4,
<a name="863"/>  863:              Q4 = qlc:q([1 || _X &lt;- ets:table(E)]),
<a name="864"/>  864:              true = length(qlc:eval(Q4, {unique_all, true})) =:= 1,
<a name="865"/>  865:              true = ets:delete(E)
<a name="866"/>  866:             &quot;&gt;&gt;,
<a name="867"/>  867: 
<a name="868"/>  868:           &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- qlc:append([[1], [2,1]])]),
<a name="869"/>  869:              Q2 = qlc:q([X || X &lt;- qlc:append([[2,1], [2]])]),
<a name="870"/>  870:              Q3 = qlc:q([{X,Y} || X &lt;- Q1, Y &lt;- Q2]),
<a name="871"/>  871:              [{1,2},{1,1},{2,2},{2,1}] = qlc:e(Q3, {unique_all,true}),
<a name="872"/>  872:              Q4 = qlc:q([{X,Y,make_ref()} || X &lt;- Q1, Y &lt;- Q2]),
<a name="873"/>  873:              [{1,2,_},{1,1,_},{2,2,_},{2,1,_}] = qlc:e(Q4, {unique_all,true})
<a name="874"/>  874:             &quot;&gt;&gt;,
<a name="875"/>  875: 
<a name="876"/>  876:           &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- [1,2,1]]),
<a name="877"/>  877:              Q2 = qlc:q([X || X &lt;- [2,1,2]]),
<a name="878"/>  878:              Q3 = qlc:q([{X,Y} || X &lt;- Q1, Y &lt;- Q2]),
<a name="879"/>  879:              [{1,2},{1,1},{2,2},{2,1}] = qlc:e(Q3,{unique_all,true}),
<a name="880"/>  880:              Q4 = qlc:q([{X,Y,make_ref()} || X &lt;- Q1, Y &lt;- Q2]),
<a name="881"/>  881:              [{1,2,_},{1,1,_},{2,2,_},{2,1,_}] = qlc:e(Q4, {unique_all,true})
<a name="882"/>  882:             &quot;&gt;&gt;,
<a name="883"/>  883: 
<a name="884"/>  884:           &lt;&lt;&quot;Q1 = qlc:q([X || {X,_} &lt;- [{1,a},{1,b}]]),
<a name="885"/>  885:              [1] = qlc:e(Q1, {unique_all, true}),
<a name="886"/>  886:              Q2 = qlc:q([a || _ &lt;- [{1,a},{1,b}]]),
<a name="887"/>  887:              [a] = qlc:e(Q2, {unique_all, true})
<a name="888"/>  888:             &quot;&gt;&gt;,
<a name="889"/>  889: 
<a name="890"/>  890:           &lt;&lt;&quot;Q = qlc:q([SQV || SQV &lt;- qlc:q([X || X &lt;- [1,2,1,#{a =&gt; 1}]],
<a name="891"/>  891:                                              unique)],
<a name="892"/>  892:                        unique),
<a name="893"/>  893:              {call,_,_,[{lc,_,{var,_,'X'},[{generate,_,{var,_,'X'},_}]},_]} =
<a name="894"/>  894:                  qlc:info(Q, [{format,abstract_code},unique_all]),
<a name="895"/>  895:              [1,2,#{a := 1}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="896"/>  896: 
<a name="897"/>  897:           &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [1,2,1]]),
<a name="898"/>  898:              {call,_,_,[{lc,_,{var,_,'X'},[{generate,_,{var,_,'X'},_}]},_]} =
<a name="899"/>  899:                  qlc:info(Q, [{format,abstract_code},unique_all]),
<a name="900"/>  900:              [1,2] = qlc:e(Q, unique_all)&quot;&gt;&gt;,
<a name="901"/>  901: 
<a name="902"/>  902:           &lt;&lt;&quot;Q1 = qlc:sort([{1},{2},{3},{1}], [{unique,true}]),
<a name="903"/>  903:              Q = qlc:sort(Q1,[{unique,true}]),
<a name="904"/>  904:              {sort,{sort,{list,_},[{unique,true}]},[]} = i(Q)&quot;&gt;&gt;
<a name="905"/>  905: 
<a name="906"/>  906:          ],
<a name="907"/>  907:     run(Config, Ts),
<a name="eval_unique-last_expr"/><a name="908"/>  908:     ok.
<a name="909"/>  909: 
<a name="910"/>  910: <i>%% Test the cache_all and unique_all options of eval.</i>
<a name="eval_cache-1"/><a name="911"/>  911: <b>eval_cache</b>(Config) when is_list(Config) -&gt;
<a name="912"/>  912:     Ts = [
<a name="913"/>  913:        &lt;&lt;&quot;E = ets:new(apa, [ordered_set]),
<a name="914"/>  914:           ets:insert(E, [{1},{2}]),
<a name="915"/>  915:           H = qlc:q([X || Y &lt;- [3,4], 
<a name="916"/>  916:                           ets:insert(E, {Y}),
<a name="917"/>  917:                           X &lt;- ets:table(E)]), % already unique, no cache...
<a name="918"/>  918:           {qlc, _,
<a name="919"/>  919:            [{generate, _, {qlc, _,
<a name="920"/>  920:                            [{generate, _, {list, [3,4]}}],
<a name="921"/>  921:                            [{unique,true}]}}, 
<a name="922"/>  922:             _,
<a name="923"/>  923:             {generate, _, {table,_}}],
<a name="924"/>  924:            [{unique,true}]} = i(H, [cache_all, unique_all]),
<a name="925"/>  925:           [{1},{2},{3},{4}] = qlc:e(H,  [cache_all, unique_all]),
<a name="926"/>  926:           ets:delete(E)&quot;&gt;&gt;,
<a name="927"/>  927: 
<a name="928"/>  928:        &lt;&lt;&quot;E = ets:new(apa, [ordered_set]),
<a name="929"/>  929:           ets:insert(E, [{1},{2}]),
<a name="930"/>  930:           H = qlc:q([X || Y &lt;- [3,4], 
<a name="931"/>  931:                           ets:insert(E, {Y}),
<a name="932"/>  932:                           X &lt;- ets:table(E)]), % no cache...
<a name="933"/>  933:           {qlc, _,
<a name="934"/>  934:            [{generate, _,{list, [3,4]}}, 
<a name="935"/>  935:             _,
<a name="936"/>  936:             {generate, _, {table,_}}],
<a name="937"/>  937:            []} = i(H, cache_all),
<a name="938"/>  938:           [{1},{2},{3},{1},{2},{3},{4}] = qlc:e(H,  [cache_all]),
<a name="939"/>  939:           ets:delete(E)&quot;&gt;&gt;,
<a name="940"/>  940: 
<a name="941"/>  941:        &lt;&lt;&quot;E = ets:new(apa, [ordered_set]),
<a name="942"/>  942:           ets:insert(E, [{1},{2}]),
<a name="943"/>  943:           H = qlc:q([X || Y &lt;- [3,4], 
<a name="944"/>  944:                           ets:insert(E, {Y}),
<a name="945"/>  945:                           X &lt;- qlc:q([X || X &lt;- ets:table(E)], cache)]),
<a name="946"/>  946:           {qlc, _,
<a name="947"/>  947:            [{generate, _, {list, [3,4]}}, 
<a name="948"/>  948:             _,
<a name="949"/>  949:             {generate, _, {qlc, _,
<a name="950"/>  950:                            [{generate, _, {table,_}}],
<a name="951"/>  951:                            [{cache,ets}]}}],
<a name="952"/>  952:            []} = i(H, cache_all),
<a name="953"/>  953:           [{1},{2},{3},{1},{2},{3}] = qlc:e(H,  [cache_all]),
<a name="954"/>  954:           ets:delete(E)&quot;&gt;&gt;,
<a name="955"/>  955: 
<a name="956"/>  956:        &lt;&lt;&quot;%% {cache_all,no} does not override {cache,true}.
<a name="957"/>  957:           E = ets:new(apa, [ordered_set]),
<a name="958"/>  958:           ets:insert(E, [{1},{2}]),
<a name="959"/>  959:           H = qlc:q([X || Y &lt;- [3,4], 
<a name="960"/>  960:                           ets:insert(E, {Y}),
<a name="961"/>  961:                           X &lt;- qlc:q([X || X &lt;- ets:table(E)], cache)]),
<a name="962"/>  962:           {qlc, _,
<a name="963"/>  963:            [{generate, _, {list, [3,4]}}, 
<a name="964"/>  964:             _,
<a name="965"/>  965:             {generate, _, {qlc, _,
<a name="966"/>  966:                            [{generate, _, {table,_}}],
<a name="967"/>  967:                            [{cache,ets}]}}],
<a name="968"/>  968:            []} = i(H, {cache_all,no}),
<a name="969"/>  969:           [{1},{2},{3},{1},{2},{3}] = qlc:e(H,  [cache_all]),
<a name="970"/>  970:           ets:delete(E)&quot;&gt;&gt;,
<a name="971"/>  971: 
<a name="972"/>  972:        &lt;&lt;&quot;E = ets:new(apa, [ordered_set]),
<a name="973"/>  973:           ets:insert(E, [{1},{2}]),
<a name="974"/>  974:           H = qlc:q([X || Y &lt;- [3,4], 
<a name="975"/>  975:                           ets:insert(E, {Y}),
<a name="976"/>  976:                           X &lt;- ets:table(E)]),
<a name="977"/>  977:           {qlc, _,
<a name="978"/>  978:            [{generate, _, {qlc, _, [{generate, _,{list, [3,4]}}],
<a name="979"/>  979:                            [{unique,true}]}}, 
<a name="980"/>  980:             _,
<a name="981"/>  981:             {generate, _,{table,_}}],
<a name="982"/>  982:            [{unique,true}]} = i(H, unique_all),
<a name="983"/>  983:           [{1},{2},{3},{4}] = qlc:e(H, [unique_all]),
<a name="984"/>  984:           ets:delete(E)&quot;&gt;&gt;,
<a name="985"/>  985: 
<a name="986"/>  986:           %% cache_all is ignored 
<a name="987"/>  987:        &lt;&lt;&quot;E = ets:new(apa, [ordered_set]),
<a name="988"/>  988:           ets:insert(E, [{1},{2},{0}]),
<a name="989"/>  989:           H = qlc:q([X || X &lt;- qlc:sort(ets:table(E))]),
<a name="990"/>  990:           {sort,_Table,[]} = i(H, cache_all),
<a name="991"/>  991:           [{0},{1},{2}] = qlc:e(H, cache_all),
<a name="992"/>  992:           ets:delete(E)&quot;&gt;&gt;,
<a name="993"/>  993: 
<a name="994"/>  994:        &lt;&lt;&quot;F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="995"/>  995:           E = ets:new(apa, [duplicate_bag]),
<a name="996"/>  996:           true = ets:insert(E, [{1,a},{2,b},{1,a}]),
<a name="997"/>  997:           Q = qlc:q([X || X &lt;- ets:table(E)], cache),
<a name="998"/>  998:           {table, _} = i(Q, []),
<a name="999"/>  999:           R = qlc:fold(F, [], Q, []),
<a name="1000"/> 1000:           ets:delete(E),
<a name="1001"/> 1001:           true = [{1,a},{1,a},{2,b}] == lists:sort(R)&quot;&gt;&gt;,
<a name="1002"/> 1002: 
<a name="1003"/> 1003:        &lt;&lt;&quot;E = ets:new(apa, [ordered_set]),
<a name="1004"/> 1004:           ets:insert(E, [{1},{2},{0}]),
<a name="1005"/> 1005:           H = qlc:q([X || X &lt;- ets:table(E)], cache),
<a name="1006"/> 1006:           {table, _} = i(H, cache_all),
<a name="1007"/> 1007:           [{0},{1},{2}]= qlc:e(H, cache_all),
<a name="1008"/> 1008:           ets:delete(E)&quot;&gt;&gt;,
<a name="1009"/> 1009: 
<a name="1010"/> 1010:        &lt;&lt;&quot;E = ets:new(foo, []),
<a name="1011"/> 1011:           true = ets:insert(E, [{1}, {2}]),
<a name="1012"/> 1012:           Q1 = qlc:q([{X} || X &lt;- ets:table(E)]),
<a name="1013"/> 1013:           Q2 = qlc:q([{X,Y} || {X} &lt;- Q1, {Y} &lt;- Q1]),
<a name="1014"/> 1014:           {qlc, _, [{generate, _, {table, _}},
<a name="1015"/> 1015:                     {generate, _, {qlc, _, [{generate, _, {table, _}}],
<a name="1016"/> 1016:                                    [{cache,ets}]}}],
<a name="1017"/> 1017:            []} = i(Q2, cache_all),
<a name="1018"/> 1018:           [{{1},{1}},{{1},{2}},{{2},{1}},{{2},{2}}] = 
<a name="1019"/> 1019:               lists:sort(qlc:e(Q2, cache_all)),
<a name="1020"/> 1020:           ets:delete(E)&quot;&gt;&gt;,
<a name="1021"/> 1021: 
<a name="1022"/> 1022:        &lt;&lt;&quot;L1 = [1,2,3], 
<a name="1023"/> 1023:           L2 = [4,5,6],
<a name="1024"/> 1024:           Q1 = qlc:append(L1, L2),
<a name="1025"/> 1025:           Q2 = qlc:q([{X} || X &lt;- Q1]),
<a name="1026"/> 1026:           {qlc, _,[{generate, _,{append, [{list, L1}, {list, L2}]}}], []} = 
<a name="1027"/> 1027:               i(Q2, [cache_all]),
<a name="1028"/> 1028:           [{1},{2},{3},{4},{5},{6}] = qlc:e(Q2, [cache_all])&quot;&gt;&gt;,
<a name="1029"/> 1029: 
<a name="1030"/> 1030:        &lt;&lt;&quot;H = qlc:sort(qlc:q([1 || _ &lt;- [a,b]])),
<a name="1031"/> 1031:           {sort, {qlc, _, [{generate, _, {qlc, _, [{generate, _, 
<a name="1032"/> 1032:                                                     {list, [a,b]}}],
<a name="1033"/> 1033:                                           [{unique,true}]}}],
<a name="1034"/> 1034:                   [{unique,true}]},
<a name="1035"/> 1035:                  []} = i(H, unique_all),
<a name="1036"/> 1036:           [1] = qlc:e(H, unique_all)&quot;&gt;&gt;
<a name="1037"/> 1037: 
<a name="1038"/> 1038:          ],
<a name="1039"/> 1039:     run(Config, Ts),
<a name="eval_cache-last_expr"/><a name="1040"/> 1040:     ok.
<a name="1041"/> 1041: 
<a name="1042"/> 1042: <i>%% Test the append function.</i>
<a name="append-1"/><a name="1043"/> 1043: <b>append</b>(Config) when is_list(Config) -&gt;
<a name="1044"/> 1044:     Ts = [&lt;&lt;&quot;C = qlc:cursor(qlc:q([X || X &lt;- [0,1,2,3], begin 10/X &gt; 0.0 end])),
<a name="1045"/> 1045:              R = (catch qlc:next_answers(C)),
<a name="1046"/> 1046:              {'EXIT',{badarith,_}} = R&quot;&gt;&gt;,
<a name="1047"/> 1047: 
<a name="1048"/> 1048:           &lt;&lt;&quot;C = qlc:cursor(qlc:q([X || X &lt;- [0 | fun() -&gt; exit(bad) end]])),
<a name="1049"/> 1049:              R = (catch qlc:next_answers(C)),
<a name="1050"/> 1050:              {'EXIT',bad} = R&quot;&gt;&gt;,
<a name="1051"/> 1051: 
<a name="1052"/> 1052:           &lt;&lt;&quot;{'EXIT',{badarg,_}} = (catch qlc:append([a], a)),
<a name="1053"/> 1053:              {'EXIT',{badarg,_}} = (catch qlc:append([[a],a]))&quot;&gt;&gt;,
<a name="1054"/> 1054: 
<a name="1055"/> 1055:           &lt;&lt;&quot;C = qlc:cursor(qlc:q([X || X &lt;- [0,1,2,3], 
<a name="1056"/> 1056:                                      begin throw({throw,wrong}), true end])),
<a name="1057"/> 1057:              {throw,wrong} = (catch {any_term,qlc:next_answers(C)})&quot;&gt;&gt;,
<a name="1058"/> 1058: 
<a name="1059"/> 1059:           &lt;&lt;&quot;QLC = qlc:q([X || X &lt;- [0,1,2,3], 
<a name="1060"/> 1060:                                begin throw({throw,wrong}), true end]),
<a name="1061"/> 1061:              {throw,wrong} = (catch {any_term,qlc:eval(QLC)}),
<a name="1062"/> 1062:              {throw,wrong} = 
<a name="1063"/> 1063:                  (catch {any_term,qlc:e(QLC, {unique_all,true})})&quot;&gt;&gt;,
<a name="1064"/> 1064: 
<a name="1065"/> 1065:           &lt;&lt;&quot;H1 = qlc:q([X || X &lt;- [1,2,3]]),
<a name="1066"/> 1066:              H2 = qlc:q([X || X &lt;- [4,5,6]]),
<a name="1067"/> 1067:              R = qlc:e(qlc:q([X || X &lt;- qlc:append([H1, H2])])),
<a name="1068"/> 1068:              true = R == [1,2,3,4,5,6]&quot;&gt;&gt;,
<a name="1069"/> 1069: 
<a name="1070"/> 1070:           &lt;&lt;&quot;H1 = [1,2,3],
<a name="1071"/> 1071:              H2 = qlc:q([X || X &lt;- [4,5,6]]),
<a name="1072"/> 1072:              R = qlc:e(qlc:q([X || X &lt;- qlc:append(H1, H2)])),
<a name="1073"/> 1073:              true = R == [1,2,3,4,5,6]&quot;&gt;&gt;,
<a name="1074"/> 1074: 
<a name="1075"/> 1075:           &lt;&lt;&quot;H1 = qlc:q([X || X &lt;- [1,2,3]]),
<a name="1076"/> 1076:              H2 = qlc:q([X || X &lt;- [4,5,6]]),
<a name="1077"/> 1077:              R = qlc:e(qlc:q([X || X &lt;- qlc:append(qlc:e(H1), H2)])),
<a name="1078"/> 1078:              true = R == [1,2,3,4,5,6]&quot;&gt;&gt;,
<a name="1079"/> 1079: 
<a name="1080"/> 1080:           &lt;&lt;&quot;H1 = qlc:q([X || X &lt;- [1,2,3]]),
<a name="1081"/> 1081:              H2 = [4,5,6],
<a name="1082"/> 1082:              R = qlc:e(qlc:q([X || X &lt;- qlc:append(H1, H2)])),
<a name="1083"/> 1083:              true = R == [1,2,3,4,5,6]&quot;&gt;&gt;,
<a name="1084"/> 1084: 
<a name="1085"/> 1085:           &lt;&lt;&quot;H1 = qlc:q([X || X &lt;- [1,2,3]]),
<a name="1086"/> 1086:              H2 = qlc:q([X || X &lt;- [4,5,6]]),
<a name="1087"/> 1087:              R = qlc:e(qlc:q([X || X &lt;- qlc:append([H1, H2, H1]), X &lt; 5])),
<a name="1088"/> 1088:              true = R == [1,2,3,4,1,2,3]&quot;&gt;&gt;,
<a name="1089"/> 1089: 
<a name="1090"/> 1090:           &lt;&lt;&quot;R = qlc:e(qlc:q([X || X &lt;- qlc:append([lista(), anrop()])])),
<a name="1091"/> 1091:              true = R == [a,b,1,2],
<a name="1092"/> 1092:              ok.
<a name="1093"/> 1093: 
<a name="1094"/> 1094:              lista() -&gt;
<a name="1095"/> 1095:                  [a,b].
<a name="1096"/> 1096: 
<a name="1097"/> 1097:              anrop() -&gt;
<a name="1098"/> 1098:                   qlc:q([X || X &lt;- [1,2]]).
<a name="1099"/> 1099:              foo() -&gt; bar&quot;&gt;&gt;,
<a name="1100"/> 1100: 
<a name="1101"/> 1101:           %% Used to work up to R11B.
<a name="1102"/> 1102:           %% &lt;&lt;&quot;apa = qlc:e(qlc:q([X || X &lt;- qlc:append([[1,2,3], ugly()])])),
<a name="1103"/> 1103:           %%   ok.
<a name="1104"/> 1104:           %%
<a name="1105"/> 1105:           %%   ugly() -&gt;
<a name="1106"/> 1106:           %%       [a | apa].
<a name="1107"/> 1107:           %%   foo() -&gt; bar&quot;&gt;&gt;,
<a name="1108"/> 1108: 
<a name="1109"/> 1109:           
<a name="1110"/> 1110:           %% Maybe this one should fail.
<a name="1111"/> 1111:           &lt;&lt;&quot;[a|b] = qlc:e(qlc:q([X || X &lt;- qlc:append([[a|b]])])),
<a name="1112"/> 1112:              ok&quot;&gt;&gt;,
<a name="1113"/> 1113: 
<a name="1114"/> 1114:           &lt;&lt;&quot;17 = qlc:e(qlc:q([X || X &lt;- qlc:append([[1,2,3],ugly2()])])),
<a name="1115"/> 1115:              ok.
<a name="1116"/> 1116: 
<a name="1117"/> 1117:              ugly2() -&gt;
<a name="1118"/> 1118:                  [a | fun() -&gt; 17 end].
<a name="1119"/> 1119:              foo() -&gt; bar&quot;&gt;&gt;,
<a name="1120"/> 1120: 
<a name="1121"/> 1121:           &lt;&lt;&quot;E = ets:new(test, []),
<a name="1122"/> 1122:              true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1123"/> 1123:              H = qlc:q([X || X &lt;- qlc:append([ets:table(E), apa])]),
<a name="1124"/> 1124:              {'EXIT',{badarg,_}} = (catch qlc:e(H)),
<a name="1125"/> 1125:              false = ets:info(E, safe_fixed),
<a name="1126"/> 1126:              {'EXIT',{badarg,_}} = (catch qlc:e(H)),
<a name="1127"/> 1127:              false = ets:info(E, safe_fixed),
<a name="1128"/> 1128:              {'EXIT',{badarg,_}} = (catch qlc:cursor(H)),
<a name="1129"/> 1129:              false = ets:info(E, safe_fixed),
<a name="1130"/> 1130:              F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="1131"/> 1131:              {'EXIT',{badarg,_}} = (catch qlc:fold(F, [], H)),
<a name="1132"/> 1132:              false = ets:info(E, safe_fixed),
<a name="1133"/> 1133:              ets:delete(E)&quot;&gt;&gt;,
<a name="1134"/> 1134: 
<a name="1135"/> 1135:           &lt;&lt;&quot;H1 = qlc:q([X || X &lt;- [1,2,3]]),
<a name="1136"/> 1136:              H2 = qlc:q([X || X &lt;- [a,b,c]]),
<a name="1137"/> 1137:              R = qlc:e(qlc:q([X || X &lt;- qlc:append(H1,qlc:append(H1,H2))])),
<a name="1138"/> 1138:              true = R == [1,2,3,1,2,3,a,b,c]&quot;&gt;&gt;,
<a name="1139"/> 1139: 
<a name="1140"/> 1140:           &lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:append([],qlc:append([[], []]))]),
<a name="1141"/> 1141:              [] = qlc:e(H)&quot;&gt;&gt;,
<a name="1142"/> 1142: 
<a name="1143"/> 1143:           &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- [3,4,4]]),
<a name="1144"/> 1144:              Q2 = qlc:q([X || X &lt;- qlc:sort(qlc:append([[1,2], Q1]))]),
<a name="1145"/> 1145:              [1,2,3,4,4] = qlc:e(Q2),
<a name="1146"/> 1146:              [1,2,3,4] = qlc:e(Q2, {unique_all,true})&quot;&gt;&gt;,
<a name="1147"/> 1147: 
<a name="1148"/> 1148:           &lt;&lt;&quot;[] = qlc:e(qlc:q([X || X &lt;- qlc:append([])]))&quot;&gt;&gt;,
<a name="1149"/> 1149: 
<a name="1150"/> 1150:           &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- [a,b]]),
<a name="1151"/> 1151:              Q2 = qlc:q([X || X &lt;- [1,2]]),
<a name="1152"/> 1152:              Q3 = qlc:append([Q1, Q2, qlc:sort([2,1])]),
<a name="1153"/> 1153:              Q = qlc:q([X || X &lt;- Q3]),
<a name="1154"/> 1154:              {append, [{list, [a,b]}, 
<a name="1155"/> 1155:                        {list, [1,2]}, 
<a name="1156"/> 1156:                        {sort,{list, [2,1]},[]}]} = i(Q),
<a name="1157"/> 1157:              [a,b,1,2,1,2] = qlc:e(Q)&quot;&gt;&gt;
<a name="1158"/> 1158: 
<a name="1159"/> 1159:           ],
<a name="1160"/> 1160:     run(Config, Ts),
<a name="append-last_expr"/><a name="1161"/> 1161:     ok.
<a name="1162"/> 1162: 
<a name="1163"/> 1163: <i>%% Simple call from evaluator.</i>
<a name="evaluator-1"/><a name="1164"/> 1164: <b>evaluator</b>(Config) when is_list(Config) -&gt;
<a name="1165"/> 1165:     true = is_alive(),
<a name="1166"/> 1166:     evaluator_2(Config, []),
<a name="1167"/> 1167:     {ok, Peer, Node} = ?CT_PEER(),
<a name="1168"/> 1168:     ok = rpc:call(Node, ?MODULE, evaluator_2, [Config, [compiler]]),
<a name="1169"/> 1169:     peer:stop(Peer),
<a name="evaluator-last_expr"/><a name="1170"/> 1170:     ok.
<a name="1171"/> 1171: 
<a name="evaluator_2-2"/><a name="1172"/> 1172: <b>evaluator_2</b>(Config, Apps) -&gt;
<a name="1173"/> 1173:     lists:foreach(fun(App) -&gt; true = code:del_path(App) end, Apps),
<a name="1174"/> 1174:     FileName = filename:join(?privdir, &quot;eval&quot;),
<a name="1175"/> 1175:     ok = file:write_file(FileName,
<a name="1176"/> 1176:                          &lt;&lt;&quot;H = qlc:q([X || X &lt;- L]),
<a name="1177"/> 1177:                             [1,2,3] = qlc:e(H).&quot;&gt;&gt;),
<a name="1178"/> 1178:     Bs = erl_eval:add_binding('L', [1,2,3], erl_eval:new_bindings()),
<a name="1179"/> 1179:     ok = file:eval(FileName, Bs),
<a name="1180"/> 1180: 
<a name="1181"/> 1181:     %% The error message is &quot;handled&quot; a bit too much... 
<a name="1182"/> 1182:     %% (no trace of erl_lint left)
<a name="1183"/> 1183:     ok = file:write_file(FileName,
<a name="1184"/> 1184:              &lt;&lt;&quot;H = qlc:q([X || X &lt;- L]), qlc:e(H).&quot;&gt;&gt;),
<a name="1185"/> 1185:     {error,_} = file:eval(FileName),
<a name="1186"/> 1186: 
<a name="1187"/> 1187:     %% Ugly error message; badarg is caught by file.erl.
<a name="1188"/> 1188:     ok = file:write_file(FileName,
<a name="1189"/> 1189:              &lt;&lt;&quot;H = qlc:q([Z || {X,Y} &lt;- [{a,2}], Z &lt;- [Y]]), qlc:e(H).&quot;&gt;&gt;),
<a name="1190"/> 1190:     {error,_} = file:eval(FileName),
<a name="1191"/> 1191: 
<a name="1192"/> 1192:     _ = file:delete(FileName),
<a name="evaluator_2-last_expr"/><a name="1193"/> 1193:     ok.
<a name="1194"/> 1194: 
<a name="1195"/> 1195: <i>%% string_to_handle/1,2.</i>
<a name="string_to_handle-1"/><a name="1196"/> 1196: <b>string_to_handle</b>(Config) when is_list(Config) -&gt;
<a name="1197"/> 1197:     {'EXIT',{badarg,_}} = (catch qlc:string_to_handle(14)),
<a name="1198"/> 1198:     {'EXIT',{badarg,_}} =
<a name="1199"/> 1199:         (catch qlc:string_to_handle(&quot;[X || X &lt;- [a].&quot;, unique_all)),
<a name="1200"/> 1200:     R1 = {error, _, {_,erl_scan,_}} = qlc:string_to_handle(&quot;'&quot;),
<a name="1201"/> 1201:     &quot;1: unterminated &quot; ++ _ = lists:flatten(qlc:format_error(R1)),
<a name="1202"/> 1202:     {error, _, {_,erl_parse,_}} = qlc:string_to_handle(&quot;foo&quot;),
<a name="1203"/> 1203:     {'EXIT',{badarg,_}} = (catch qlc:string_to_handle(&quot;foo, bar.&quot;)),
<a name="1204"/> 1204:     R3 = {error, _, {_,?QLC,not_a_query_list_comprehension}} =
<a name="1205"/> 1205:         qlc:string_to_handle(&quot;bad.&quot;),
<a name="1206"/> 1206:     &quot;1: argument is not&quot; ++ _ = lists:flatten(qlc:format_error(R3)),
<a name="1207"/> 1207:     R4 = {error, _, {_,?QLC,{used_generator_variable,'Y'}}} =
<a name="1208"/> 1208:         qlc:string_to_handle(&quot;[X || begin Y = [1,2], true end, X &lt;- Y].&quot;),
<a name="1209"/> 1209:     &quot;1: generated variable 'Y'&quot; ++ _ =
<a name="1210"/> 1210:         lists:flatten(qlc:format_error(R4)),
<a name="1211"/> 1211:     {error, _, {_,erl_lint,_}} = qlc:string_to_handle(&quot;[X || X &lt;- A].&quot;),
<a name="1212"/> 1212:     H1 = qlc:string_to_handle(&quot;[X || X &lt;- [1,2]].&quot;),
<a name="1213"/> 1213:     [1,2] = qlc:e(H1),
<a name="1214"/> 1214:     H2 = qlc:string_to_handle(&quot;[X || X &lt;- qlc:append([a,b],&quot;
<a name="1215"/> 1215:                                     &quot;qlc:e(qlc:q([X || X &lt;- [c,d,e]])))].&quot;),
<a name="1216"/> 1216:     [a,b,c,d,e] = qlc:e(H2),
<a name="1217"/> 1217:     %% The generated fun has many arguments (erl_eval has a maximum of 20).
<a name="1218"/> 1218:     H3 = qlc:string_to_handle(
<a name="1219"/> 1219:            &quot;[{A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W} ||&quot;
<a name="1220"/> 1220:            &quot; {A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W} &lt;- []].&quot;),
<a name="1221"/> 1221:     [] = qlc:e(H3),
<a name="1222"/> 1222:     Bs1 = erl_eval:add_binding('L', [1,2,3], erl_eval:new_bindings()),
<a name="1223"/> 1223:     H4 = qlc:string_to_handle(&quot;[X || X &lt;- L].&quot;, [], Bs1),
<a name="1224"/> 1224:     [1,2,3] = qlc:e(H4),
<a name="1225"/> 1225:     H5 = qlc:string_to_handle(&quot;[X || X &lt;- [1,2,1,2]].&quot;, [unique, cache]),
<a name="1226"/> 1226:     [1,2] = qlc:e(H5),
<a name="1227"/> 1227: 
<a name="1228"/> 1228:     Ets = ets:new(test, []),
<a name="1229"/> 1229:     true = ets:insert(Ets, [{1}]),
<a name="1230"/> 1230:     Bs2 = erl_eval:add_binding('E', Ets, erl_eval:new_bindings()),
<a name="1231"/> 1231:     Q = &quot;[X || {X} &lt;- ets:table(E)].&quot;,
<a name="1232"/> 1232:     [1] = qlc:e(qlc:string_to_handle(Q, [], Bs2)),
<a name="1233"/> 1233:     [1] = qlc:e(qlc:string_to_handle(Q, {max_lookup,1000}, Bs2)),
<a name="1234"/> 1234:     [1] = qlc:e(qlc:string_to_handle(Q, {max_lookup,infinity}, Bs2)),
<a name="1235"/> 1235:     {'EXIT',{badarg,_}} =
<a name="1236"/> 1236:         (catch qlc:string_to_handle(Q, {max_lookup,-1}, Bs2)),
<a name="1237"/> 1237:     {'EXIT', {no_lookup_to_carry_out, _}} =
<a name="1238"/> 1238:         (catch qlc:e(qlc:string_to_handle(Q, {lookup,true}, Bs2))),
<a name="1239"/> 1239:     ets:delete(Ets),
<a name="1240"/> 1240: 
<a name="1241"/> 1241:     %% References can be scanned and parsed.
<a name="1242"/> 1242:     E2 = ets:new(test, [bag]),
<a name="1243"/> 1243:     Ref = make_ref(),
<a name="1244"/> 1244:     true = ets:insert(E2, [{Ref,Ref}]),
<a name="1245"/> 1245:     S2 = &quot;[{Val1} || {Ref1, Val1} &lt;- ets:table(&quot;++io_lib:write(E2)++&quot;),&quot;
<a name="1246"/> 1246:          &quot;Ref1 =:= Ref].&quot;,
<a name="1247"/> 1247:     Bs = erl_eval:add_binding('Ref', Ref, erl_eval:new_bindings()),
<a name="1248"/> 1248:     [{Ref}] = qlc:e(qlc:string_to_handle(S2, [], Bs)),
<a name="1249"/> 1249:     ets:delete(E2),
<a name="1250"/> 1250: 
<a name="string_to_handle-last_expr"/><a name="1251"/> 1251:     ok.
<a name="1252"/> 1252: 
<a name="1253"/> 1253: <i>%% table</i>
<a name="table-1"/><a name="1254"/> 1254: <b>table</b>(Config) when is_list(Config) -&gt;
<a name="1255"/> 1255:     dets:start(),
<a name="1256"/> 1256:     Ts = [
<a name="1257"/> 1257:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1258"/> 1258:           {'EXIT',{badarg,_}} = 
<a name="1259"/> 1259:                (catch qlc:e(qlc:q([X || X &lt;- ets:table(E, [badarg])]))),
<a name="1260"/> 1260:           [] = qlc:e(qlc:q([X || X &lt;- ets:table(E)])),
<a name="1261"/> 1261:           ets:delete(E)&quot;&gt;&gt;,
<a name="1262"/> 1262: 
<a name="1263"/> 1263:        &lt;&lt;&quot;{'EXIT',{badarg,_}} = (catch qlc:table(not_a_fun, []))&quot;&gt;&gt;,
<a name="1264"/> 1264: 
<a name="1265"/> 1265:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1266"/> 1266:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1267"/> 1267:           H = qlc:q([{X,Y} || X &lt;- ets:table(E), Y &lt;- ets:table(E)]),
<a name="1268"/> 1268:           R = qlc:e(H),
<a name="1269"/> 1269:           ets:delete(E),
<a name="1270"/> 1270:           [{{1,a},{1,a}},{{1,a},{2,b}},{{1,a},{3,c}},
<a name="1271"/> 1271:            {{2,b},{1,a}},{{2,b},{2,b}},{{2,b},{3,c}},
<a name="1272"/> 1272: 
<a name="1273"/> 1273:            {{3,c},{1,a}},{{3,c},{2,b}},{{3,c},{3,c}}] = lists:sort(R)&quot;&gt;&gt;,
<a name="1274"/> 1274: 
<a name="1275"/> 1275:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1276"/> 1276:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1277"/> 1277:           H = qlc:q([X || X &lt;- qlc:append([ets:table(E), [a,b,c], 
<a name="1278"/> 1278:                                            ets:table(E)])]),
<a name="1279"/> 1279:           R = qlc:e(H),
<a name="1280"/> 1280:           ets:delete(E),
<a name="1281"/> 1281:           [a,b,c,{1,a},{1,a},{2,b},{2,b},{3,c},{3,c}] = lists:sort(R)&quot;&gt;&gt;,
<a name="1282"/> 1282: 
<a name="1283"/> 1283:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1284"/> 1284:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1285"/> 1285:           false = ets:info(E, safe_fixed),
<a name="1286"/> 1286:           H = qlc:q([{X,Y} || X &lt;- ets:table(E, {n_objects, default}), 
<a name="1287"/> 1287:                               Y &lt;- ets:table(E, {n_objects, 2}), 
<a name="1288"/> 1288:                               false =/= ets:info(E, safe_fixed), 
<a name="1289"/> 1289:                               throw({throw,apa})]),
<a name="1290"/> 1290:           {throw,apa} = (catch {any_term,qlc:e(H)}),
<a name="1291"/> 1291:           false = ets:info(E, safe_fixed),
<a name="1292"/> 1292:           ets:delete(E)&quot;&gt;&gt;,
<a name="1293"/> 1293: 
<a name="1294"/> 1294:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1295"/> 1295:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1296"/> 1296:           false = ets:info(E, safe_fixed),
<a name="1297"/> 1297:           H = qlc:q([{X,Y} || X &lt;- ets:table(E), Y &lt;- ets:table(E), 
<a name="1298"/> 1298:                               false =/= ets:info(E, safe_fixed), exit(apa)]),
<a name="1299"/> 1299:           {'EXIT',apa} = (catch {any_term,qlc:e(H)}),
<a name="1300"/> 1300:           false = ets:info(E, safe_fixed),
<a name="1301"/> 1301:           ets:delete(E)&quot;&gt;&gt;,
<a name="1302"/> 1302: 
<a name="1303"/> 1303:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1304"/> 1304:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1305"/> 1305:           H = qlc:q([{X,Y} || X &lt;- qlc_SUITE:bad_table_throw(E), 
<a name="1306"/> 1306:                               Y &lt;- ets:table(E)]),
<a name="1307"/> 1307:           R = (catch {any_term,qlc:cursor(H)}),
<a name="1308"/> 1308:           false = ets:info(E, safe_fixed),
<a name="1309"/> 1309:           ets:delete(E),
<a name="1310"/> 1310:           {throw,bad_pre_fun} = R&quot;&gt;&gt;,
<a name="1311"/> 1311: 
<a name="1312"/> 1312:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1313"/> 1313:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1314"/> 1314:           H = qlc:q([{X,Y} || X &lt;- qlc_SUITE:bad_table_exit(E), 
<a name="1315"/> 1315:                               Y &lt;- ets:table(E)]),
<a name="1316"/> 1316:           R = (catch {any_term,qlc:cursor(H)}),
<a name="1317"/> 1317:           false = ets:info(E, safe_fixed),
<a name="1318"/> 1318:           ets:delete(E),
<a name="1319"/> 1319:           {'EXIT',{bad_pre_fun,_}} = R&quot;&gt;&gt;,
<a name="1320"/> 1320: 
<a name="1321"/> 1321:        &lt;&lt;&quot;E = ets:new(test, [ordered_set]),
<a name="1322"/> 1322:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1323"/> 1323:           H = qlc:q([X || X &lt;- qlc_SUITE:default_table(E)]),
<a name="1324"/> 1324:           R = qlc:e(H),
<a name="1325"/> 1325:           ets:delete(E),
<a name="1326"/> 1326:           [{1,a},{2,b},{3,c}] = R&quot;&gt;&gt;,
<a name="1327"/> 1327: 
<a name="1328"/> 1328:        &lt;&lt;&quot;E = ets:new(test, [ordered_set]),
<a name="1329"/> 1329:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1330"/> 1330:           H = qlc:q([X || X &lt;- qlc_SUITE:bad_table(E)]),
<a name="1331"/> 1331:           {'EXIT', {badarg, _}} = (catch qlc:e(H)),
<a name="1332"/> 1332:           ets:delete(E)&quot;&gt;&gt;,
<a name="1333"/> 1333: 
<a name="1334"/> 1334:        %% The info tag num_of_objects is currently not used.
<a name="1335"/> 1335: <i>%%        &lt;&lt;&quot;E = ets:new(test, [ordered_set]),</i>
<a name="1336"/> 1336: <i>%%           true = ets:insert(E, [{1,a},{2,b},{3,c}]),</i>
<a name="1337"/> 1337: <i>%%           H = qlc:q([X || X &lt;- qlc_SUITE:bad_table_info_fun_n_objects(E)]),</i>
<a name="1338"/> 1338: <i>%%           {'EXIT', finito} = (catch {any_term,qlc:e(H)}),</i>
<a name="1339"/> 1339: <i>%%           ets:delete(E)&quot;&gt;&gt;,</i>
<a name="1340"/> 1340: 
<a name="1341"/> 1341:        &lt;&lt;&quot;E = ets:new(test, [ordered_set]),
<a name="1342"/> 1342:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1343"/> 1343:           H = qlc:q([Y || {X,Y} &lt;- qlc_SUITE:bad_table_info_fun_indices(E),
<a name="1344"/> 1344:                           X =:= a]),
<a name="1345"/> 1345:           %% This is due to lookup. If the table were traversed there
<a name="1346"/> 1346:           %% would be no failure.
<a name="1347"/> 1347:           {throw, apa} = (catch {any_term,qlc:e(H)}),
<a name="1348"/> 1348:           ets:delete(E)&quot;&gt;&gt;,
<a name="1349"/> 1349: 
<a name="1350"/> 1350:        &lt;&lt;&quot;E = ets:new(test, [ordered_set]),
<a name="1351"/> 1351:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1352"/> 1352:           H = qlc:q([Y || {X,Y} &lt;- qlc_SUITE:bad_table_info_fun_keypos(E),
<a name="1353"/> 1353:                           X =:= a]),
<a name="1354"/> 1354:           {'EXIT',{keypos,_}} = (catch {any_term,qlc:info(H)}),
<a name="1355"/> 1355:           {'EXIT',{keypos,_}} = (catch {any_term,qlc:e(H)}),
<a name="1356"/> 1356:           ets:delete(E)&quot;&gt;&gt;,
<a name="1357"/> 1357: 
<a name="1358"/> 1358:        begin
<a name="1359"/> 1359:        MS = ets:fun2ms(fun(X) when element(1, X) &gt; 1 -&gt; X end),
<a name="1360"/> 1360:        [&lt;&lt;&quot;E = ets:new(test, []),
<a name="1361"/> 1361:            true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1362"/> 1362:            MS = &quot;&gt;&gt;, io_lib:format(&quot;~w&quot;, [MS]), &lt;&lt;&quot;,
<a name="1363"/> 1363:            H = qlc:q([{X,Y} || X &lt;- ets:table(E,{traverse,{select, MS}}), 
<a name="1364"/> 1364:                                Y &lt;- ets:table(E)]),
<a name="1365"/> 1365:            R = qlc:e(H),
<a name="1366"/> 1366:            ets:delete(E),
<a name="1367"/> 1367:            [{{2,b},{1,a}},{{2,b},{2,b}},{{2,b},{3,c}},
<a name="1368"/> 1368:             {{3,c},{1,a}},{{3,c},{2,b}},{{3,c},{3,c}}] = lists:sort(R)&quot;&gt;&gt;]
<a name="1369"/> 1369:        end,
<a name="1370"/> 1370: 
<a name="1371"/> 1371:        begin % a short table
<a name="1372"/> 1372:        MS = ets:fun2ms(fun(X) when element(1, X) &gt; 1 -&gt; X end),
<a name="1373"/> 1373:        [&lt;&lt;&quot;E = ets:new(test, []),
<a name="1374"/> 1374:            true = ets:insert(E, [{0,b}]),
<a name="1375"/> 1375:            MS =  &quot;&gt;&gt;, io_lib:format(&quot;~w&quot;, [MS]), &lt;&lt;&quot;,
<a name="1376"/> 1376:            H1 = qlc:q([X || X &lt;- ets:table(E)]),
<a name="1377"/> 1377:            R1 = qlc:e(H1),
<a name="1378"/> 1378:            H2 = qlc:q([X || X &lt;- ets:table(E, {traverse, {select, MS}})]),
<a name="1379"/> 1379:            R2 = qlc:e(H2),
<a name="1380"/> 1380:            ets:delete(E),
<a name="1381"/> 1381:            [_] = R1,
<a name="1382"/> 1382:            [] = R2&quot;&gt;&gt;]
<a name="1383"/> 1383:        end,
<a name="1384"/> 1384: 
<a name="1385"/> 1385:        begin
<a name="1386"/> 1386:        File = filename:join(?privdir, &quot;detsfile&quot;),
<a name="1387"/> 1387:        _ = file:delete(File),
<a name="1388"/> 1388:        [&lt;&lt;&quot;{ok, Tab} = dets:open_file(apa, [{file,\&quot;&quot;&gt;&gt;, File, &lt;&lt;&quot;\&quot;}, 
<a name="1389"/> 1389:                                            {type,bag}]),
<a name="1390"/> 1390:            ok = dets:insert(Tab, [{1,a},{1,b}]),
<a name="1391"/> 1391:            R = qlc:e(qlc:q([X || X &lt;- dets:table(Tab)])),
<a name="1392"/> 1392:            dets:close(Tab),
<a name="1393"/> 1393:            file:delete(\&quot;&quot;&gt;&gt;, File, &lt;&lt;&quot;\&quot;),
<a name="1394"/> 1394:            R&quot;&gt;&gt;]
<a name="1395"/> 1395:        end,
<a name="1396"/> 1396: 
<a name="1397"/> 1397:        %% [T || P &lt;- Table, F] turned into a match spec.
<a name="1398"/> 1398:        &lt;&lt;&quot;E = ets:new(apa, [duplicate_bag]),
<a name="1399"/> 1399:           true = ets:insert(E, [{1,a},{2,b},{3,c},{4,d}]),
<a name="1400"/> 1400:           QH = qlc:q([X || {X,_} &lt;- ets:table(E), X &gt; 2], unique),
<a name="1401"/> 1401:           {qlc, _, [{generate, _, {table, _}}], [{unique,true}]} = i(QH),
<a name="1402"/> 1402:           [3,4] = lists:sort(qlc:e(QH)),
<a name="1403"/> 1403:           ets:delete(E)&quot;&gt;&gt;,
<a name="1404"/> 1404: 
<a name="1405"/> 1405:        &lt;&lt;&quot;E = ets:new(apa, []),
<a name="1406"/> 1406:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1407"/> 1407:           {'EXIT', {badarg, _}} = (catch qlc_SUITE:bad_table_format(E)),
<a name="1408"/> 1408:           ets:delete(E)&quot;&gt;&gt;,
<a name="1409"/> 1409: 
<a name="1410"/> 1410:        &lt;&lt;&quot;E = ets:new(apa, []),
<a name="1411"/> 1411:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1412"/> 1412:           {'EXIT', {badarg, _}} = (catch qlc_SUITE:bad_table_format_arity(E)),
<a name="1413"/> 1413:           ets:delete(E)&quot;&gt;&gt;,
<a name="1414"/> 1414: 
<a name="1415"/> 1415:        &lt;&lt;&quot;E = ets:new(apa, []),
<a name="1416"/> 1416:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1417"/> 1417:           {'EXIT', {badarg, _}} = (catch qlc_SUITE:bad_table_info_arity(E)),
<a name="1418"/> 1418:           ets:delete(E)&quot;&gt;&gt;,
<a name="1419"/> 1419: 
<a name="1420"/> 1420:        &lt;&lt;&quot;E = ets:new(apa, []),
<a name="1421"/> 1421:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1422"/> 1422:           {'EXIT', {badarg, _}} = (catch qlc_SUITE:bad_table_traverse(E)),
<a name="1423"/> 1423:           ets:delete(E)&quot;&gt;&gt;,
<a name="1424"/> 1424: 
<a name="1425"/> 1425:        &lt;&lt;&quot;E = ets:new(apa, []),
<a name="1426"/> 1426:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1427"/> 1427:           {'EXIT', {badarg, _}} = (catch qlc_SUITE:bad_table_post(E)),
<a name="1428"/> 1428:           ets:delete(E)&quot;&gt;&gt;,
<a name="1429"/> 1429: 
<a name="1430"/> 1430:        &lt;&lt;&quot;E = ets:new(apa, []),
<a name="1431"/> 1431:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1432"/> 1432:           {'EXIT', {badarg, _}} = (catch qlc_SUITE:bad_table_max_lookup(E)),
<a name="1433"/> 1433:           ets:delete(E)&quot;&gt;&gt;,
<a name="1434"/> 1434: 
<a name="1435"/> 1435:        &lt;&lt;&quot;E = ets:new(apa, []),
<a name="1436"/> 1436:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1437"/> 1437:           {'EXIT', {badarg, _}} = (catch qlc_SUITE:bad_table_lookup(E)),
<a name="1438"/> 1438:           ets:delete(E)&quot;&gt;&gt;,
<a name="1439"/> 1439: 
<a name="1440"/> 1440:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="1441"/> 1441:           QH = qlc:q([element(2, X) || X &lt;- qlc_SUITE:table(L, [2]),
<a name="1442"/> 1442:                                        (element(1, X) =:= 1)
<a name="1443"/> 1443:                                         or (2 =:= element(1, X))]),
<a name="1444"/> 1444:           [a,b] = lists:sort(qlc:e(QH))&quot;&gt;&gt;,
<a name="1445"/> 1445: 
<a name="1446"/> 1446:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="1447"/> 1447:               Q = qlc:q([{A,B} || {A,B} &lt;- 
<a name="1448"/> 1448:                                 qlc:q([{B,A} || {A,B} &lt;- ets:table(E), 
<a name="1449"/> 1449:                                                 (A =:= 1) or (A =:= 2),
<a name="1450"/> 1450:                                                 math:sqrt(B) &lt; A])]),
<a name="1451"/> 1451:               [{2,2}] = qlc:eval(Q),
<a name="1452"/> 1452:               [1,2] = lookup_keys(Q)
<a name="1453"/> 1453:            end, [{1,1},{2,2}])&quot;&gt;&gt;
<a name="1454"/> 1454:        ],
<a name="1455"/> 1455:     run(Config, Ts),
<a name="1456"/> 1456: 
<a name="1457"/> 1457:     Ts2 = [
<a name="1458"/> 1458:        %% [T || P &lt;- Table, F] turned into a match spec. Records needed.
<a name="1459"/> 1459:        &lt;&lt;&quot;E = ets:new(foo, [bag]),
<a name="1460"/> 1460:           ets:insert(E, [{a,1,2},#a{b=3,c=4},{a,3}]),
<a name="1461"/> 1461:           QH = qlc:q([X || X &lt;- ets:table(E), is_record(X, a)]),
<a name="1462"/> 1462:           {list,{table,_}, _} = i(QH),
<a name="1463"/> 1463:           [{a,1,2},{a,3,4}] = lists:sort(qlc:eval(QH)),
<a name="1464"/> 1464:           ets:delete(E)&quot;&gt;&gt;
<a name="1465"/> 1465:        ],
<a name="1466"/> 1466:     run(Config, &lt;&lt;&quot;-record(a, {b,c}).\n&quot;&gt;&gt;, Ts2),
<a name="1467"/> 1467: 
<a name="table-last_expr"/><a name="1468"/> 1468:     ok.
<a name="1469"/> 1469: 
<a name="1470"/> 1470: <i>%% Caller or cursor process dies.</i>
<a name="process_dies-1"/><a name="1471"/> 1471: <b>process_dies</b>(Config) when is_list(Config) -&gt;
<a name="1472"/> 1472:     Ts = [
<a name="1473"/> 1473:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1474"/> 1474:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1475"/> 1475:           false = ets:info(E, safe_fixed),
<a name="1476"/> 1476:           Parent = self(),
<a name="1477"/> 1477:           F = fun() -&gt; 
<a name="1478"/> 1478:                       H = qlc:q([X || X &lt;- ets:table(E)]),
<a name="1479"/> 1479:                       qlc:cursor(H),
<a name="1480"/> 1480:                       Parent ! {self(),ok}                
<a name="1481"/> 1481:               end,
<a name="1482"/> 1482:           Pid = spawn_link(F),
<a name="1483"/> 1483:           receive {Pid,ok} -&gt; ok end,
<a name="1484"/> 1484:           timer:sleep(10),
<a name="1485"/> 1485:           false = ets:info(E, safe_fixed),    
<a name="1486"/> 1486:           ets:delete(E)&quot;&gt;&gt;,
<a name="1487"/> 1487: 
<a name="1488"/> 1488:        &lt;&lt;&quot;%% This is not nice. The cursor's monitor kicks in.
<a name="1489"/> 1489:           E = ets:new(test, []),
<a name="1490"/> 1490:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="1491"/> 1491:           false = ets:info(E, safe_fixed),
<a name="1492"/> 1492:           Parent = self(),
<a name="1493"/> 1493:           F = fun() -&gt; 
<a name="1494"/> 1494:                       H = qlc:q([X || begin
<a name="1495"/> 1495:                                           process_flag(trap_exit, false),
<a name="1496"/> 1496:                                           {links, [Pid]} = 
<a name="1497"/> 1497:                                               process_info(self(), links),
<a name="1498"/> 1498:                                           unlink(Pid),
<a name="1499"/> 1499:                                           timer:sleep(1),
<a name="1500"/> 1500:                                           {links, []} =
<a name="1501"/> 1501:                                               process_info(self(), links),
<a name="1502"/> 1502:                                           true 
<a name="1503"/> 1503:                                       end, 
<a name="1504"/> 1504:                                       X &lt;- ets:table(E)]),
<a name="1505"/> 1505:                       C = qlc:cursor(H),
<a name="1506"/> 1506:                       qlc:next_answers(C),
<a name="1507"/> 1507:                       Parent ! {self(),ok}                
<a name="1508"/> 1508:               end,
<a name="1509"/> 1509:           Pid = spawn_link(F),
<a name="1510"/> 1510:           receive {Pid,ok} -&gt; ok end,
<a name="1511"/> 1511:           timer:sleep(10),
<a name="1512"/> 1512:           false = ets:info(E, safe_fixed),    
<a name="1513"/> 1513:           ets:delete(E)&quot;&gt;&gt;,
<a name="1514"/> 1514: 
<a name="1515"/> 1515:        &lt;&lt;&quot;H = qlc:q([X || X &lt;- [1,2]]),
<a name="1516"/> 1516:           {qlc_cursor, Term} = C = qlc:cursor(H),
<a name="1517"/> 1517:           PF = process_flag(trap_exit, true),
<a name="1518"/> 1518:           F = fun(T) -&gt; not is_pid(T) end,
<a name="1519"/> 1519:           [Pid|_] = lists:dropwhile(F, tuple_to_list(Term)),
<a name="1520"/> 1520:           exit(Pid, kill),
<a name="1521"/> 1521:           timer:sleep(1),
<a name="1522"/> 1522:           {'EXIT', {{qlc_cursor_pid_no_longer_exists, Pid}, _}} =
<a name="1523"/> 1523:                 (catch qlc:next_answers(C)),
<a name="1524"/> 1524:           process_flag(trap_exit, PF)&quot;&gt;&gt;,
<a name="1525"/> 1525:        &lt;&lt;&quot;H = qlc:q([X || begin process_flag(trap_exit, true), true end, 
<a name="1526"/> 1526:                           X &lt;- [1,2]]),
<a name="1527"/> 1527:           {qlc_cursor, Term} = C = qlc:cursor(H),
<a name="1528"/> 1528:           PF = process_flag(trap_exit, true),
<a name="1529"/> 1529:           F = fun(T) -&gt; not is_pid(T) end,
<a name="1530"/> 1530:           [Pid|_] = lists:dropwhile(F, tuple_to_list(Term)),
<a name="1531"/> 1531:           [1] = qlc:next_answers(C, 1),
<a name="1532"/> 1532:           exit(Pid, stop),
<a name="1533"/> 1533:           timer:sleep(1),
<a name="1534"/> 1534:           {'EXIT', {{qlc_cursor_pid_no_longer_exists, Pid}, _}} =
<a name="1535"/> 1535:               (catch qlc:next_answers(C)),
<a name="1536"/> 1536:           process_flag(trap_exit, PF)&quot;&gt;&gt;,
<a name="1537"/> 1537:        &lt;&lt;&quot;%% This is not nice. No cleanup is done...
<a name="1538"/> 1538:           H = qlc:q([X || begin process_flag(trap_exit, false), true end, 
<a name="1539"/> 1539:                      X &lt;- [1,2]]),
<a name="1540"/> 1540:           {qlc_cursor, Term} = C = qlc:cursor(H),
<a name="1541"/> 1541:           PF = process_flag(trap_exit, true),
<a name="1542"/> 1542:           F = fun(T) -&gt; not is_pid(T) end,
<a name="1543"/> 1543:           [Pid|_] = lists:dropwhile(F, tuple_to_list(Term)),
<a name="1544"/> 1544:           [1] = qlc:next_answers(C, 1),
<a name="1545"/> 1545:           exit(Pid, stop),
<a name="1546"/> 1546:           timer:sleep(1),
<a name="1547"/> 1547:           {'EXIT', {{qlc_cursor_pid_no_longer_exists, Pid}, _}} =
<a name="1548"/> 1548:               (catch qlc:next_answers(C)),
<a name="1549"/> 1549:           process_flag(trap_exit, PF)&quot;&gt;&gt;,
<a name="1550"/> 1550: 
<a name="1551"/> 1551:        &lt;&lt;&quot;PF = process_flag(trap_exit, true),
<a name="1552"/> 1552:           E = ets:new(test, []),
<a name="1553"/> 1553:           %% Hard kill. No cleanup will be done.
<a name="1554"/> 1554:           H = qlc:q([X || begin exit(self(), kill), true end, 
<a name="1555"/> 1555:                           X &lt;- ets:table(E)]),
<a name="1556"/> 1556:           C = qlc:cursor(H),
<a name="1557"/> 1557:           {'EXIT', {{qlc_cursor_pid_no_longer_exists, _}, _}} =
<a name="1558"/> 1558:                (catch qlc:next_answers(C)),
<a name="1559"/> 1559:           false = ets:info(E, safe_fixed), % - but Ets cleans up anyway.
<a name="1560"/> 1560:           true = ets:delete(E),
<a name="1561"/> 1561:           process_flag(trap_exit, PF)&quot;&gt;&gt;,
<a name="1562"/> 1562: 
<a name="1563"/> 1563:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1564"/> 1564:           true = ets:insert(E, [{1,a}]),
<a name="1565"/> 1565:           %% The signal is caught by trap_exit. No process dies...
<a name="1566"/> 1566:           H = qlc:q([X || begin exit(self(), normal), true end, 
<a name="1567"/> 1567:                           X &lt;- ets:table(E)]),
<a name="1568"/> 1568:           C = qlc:cursor(H, {spawn_options, []}),
<a name="1569"/> 1569:           [{1,a}] = qlc:next_answers(C),
<a name="1570"/> 1570:           qlc:delete_cursor(C),
<a name="1571"/> 1571:           false = ets:info(E, safe_fixed),
<a name="1572"/> 1572:           true = ets:delete(E)&quot;&gt;&gt;,
<a name="1573"/> 1573:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1574"/> 1574:           true = ets:insert(E, [{1,a}]),
<a name="1575"/> 1575:           %% The same as last example.
<a name="1576"/> 1576:           H = qlc:q([X || begin 
<a name="1577"/> 1577:                               process_flag(trap_exit, true), 
<a name="1578"/> 1578:                               exit(self(), normal), true 
<a name="1579"/> 1579:                           end, 
<a name="1580"/> 1580:                           X &lt;- ets:table(E)]),
<a name="1581"/> 1581:           C = qlc:cursor(H, {spawn_options, []}),
<a name="1582"/> 1582:           [{1,a}] = qlc:next_answers(C),
<a name="1583"/> 1583:           qlc:delete_cursor(C),
<a name="1584"/> 1584:           false = ets:info(E, safe_fixed),
<a name="1585"/> 1585:           true = ets:delete(E), ok&quot;&gt;&gt;,
<a name="1586"/> 1586:        &lt;&lt;&quot;E = ets:new(test, []),
<a name="1587"/> 1587:           true = ets:insert(E, [{1,a}]),
<a name="1588"/> 1588:           H = qlc:q([X || X &lt;- ets:table(E)]),
<a name="1589"/> 1589:           SpawnOpts = [link, monitor], % monitor is ignored
<a name="1590"/> 1590:           {qlc_cursor, Term} = C = qlc:cursor(H, {spawn_options, SpawnOpts}),
<a name="1591"/> 1591:           F = fun(T) -&gt; not is_pid(T) end,
<a name="1592"/> 1592:           [Pid|_] = lists:dropwhile(F, tuple_to_list(Term)),
<a name="1593"/> 1593:           Me = self(),
<a name="1594"/> 1594:           qlc_SUITE:install_error_logger(),
<a name="1595"/> 1595:           Tuple = {this, tuple, is, writton, onto, the, error_logger},
<a name="1596"/> 1596:           SP = spawn(fun() -&gt;
<a name="1597"/> 1597:                   Pid ! Tuple,
<a name="1598"/> 1598:                   Me ! {self(), done}
<a name="1599"/> 1599:                 end),
<a name="1600"/> 1600:           receive {SP, done} -&gt; ok end,
<a name="1601"/> 1601:           [{1,a}] = qlc:next_answers(C),
<a name="1602"/> 1602:           qlc:delete_cursor(C),
<a name="1603"/> 1603:           {error, _Pid, Tuple} = qlc_SUITE:read_error_logger(),
<a name="1604"/> 1604:           qlc_SUITE:uninstall_error_logger(),
<a name="1605"/> 1605:           false = ets:info(E, safe_fixed),
<a name="1606"/> 1606:           true = ets:delete(E), ok&quot;&gt;&gt;
<a name="1607"/> 1607: 
<a name="1608"/> 1608:         ],
<a name="1609"/> 1609:     run(Config, Ts),
<a name="process_dies-last_expr"/><a name="1610"/> 1610:     ok.
<a name="1611"/> 1611: 
<a name="1612"/> 1612: <i>%% The sort option.</i>
<a name="sort-1"/><a name="1613"/> 1613: <b>sort</b>(Config) when is_list(Config) -&gt;
<a name="1614"/> 1614:     Ts = [
<a name="1615"/> 1615:        &lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:sort([1,2,3,2], {unique,true})]),
<a name="1616"/> 1616:           [1,2,3] = qlc:e(H),
<a name="1617"/> 1617:           C1 = qlc:cursor(H),
<a name="1618"/> 1618:           [1,2,3] = qlc:next_answers(C1, all_remaining),
<a name="1619"/> 1619:           qlc:delete_cursor(C1)&quot;&gt;&gt;,
<a name="1620"/> 1620: 
<a name="1621"/> 1621:        &lt;&lt;&quot;H = qlc:q([{X,Y} || X &lt;- qlc:sort(qlc:q([X || X &lt;- [1,2,3,2]]), 
<a name="1622"/> 1622:                                             {unique,true}),
<a name="1623"/> 1623:                               Y &lt;- [a,b]]),
<a name="1624"/> 1624:           [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] = qlc:e(H),
<a name="1625"/> 1625:           C = qlc:cursor(H),
<a name="1626"/> 1626:           [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] = 
<a name="1627"/> 1627:               qlc:next_answers(C, all_remaining),
<a name="1628"/> 1628:           qlc:delete_cursor(C)&quot;&gt;&gt;,
<a name="1629"/> 1629: 
<a name="1630"/> 1630:        &lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:sort(qlc:q([X || X &lt;- apa]))]),
<a name="1631"/> 1631:           {'EXIT',{badarg,_}} = (catch qlc:e(H))&quot;&gt;&gt;,
<a name="1632"/> 1632: 
<a name="1633"/> 1633:           %% An example with a side effect. The result may vary...
<a name="1634"/> 1634:        &lt;&lt;&quot;E = ets:new(test, [duplicate_bag]),
<a name="1635"/> 1635:           true = ets:insert(E, [{1,17},{1,a}]),
<a name="1636"/> 1636:           H_1 = qlc:q([X || X &lt;- ets:table(E)]),
<a name="1637"/> 1637:           H = qlc:q([X || X &lt;- [1,2,3], ets:insert(E, {1,-X}), 
<a name="1638"/> 1638:                           {_,Y} &lt;- H_1, 
<a name="1639"/> 1639:                           X &gt; Y]),
<a name="1640"/> 1640:           true = lists:sort(qlc:e(H)) == [1,2,2,3,3,3],
<a name="1641"/> 1641:           true = ets:delete(E)&quot;&gt;&gt;,
<a name="1642"/> 1642: 
<a name="1643"/> 1643:        &lt;&lt;&quot;E = ets:new(test, [duplicate_bag]),
<a name="1644"/> 1644:           true = ets:insert(E, [{1,17}]),
<a name="1645"/> 1645:           H_1 = qlc:q([X || X &lt;- qlc:sort(ets:tab2list(E))]),
<a name="1646"/> 1646:           %% Note: side effect in filter!
<a name="1647"/> 1647:           H = qlc:q([X || X &lt;- [1,2,3], ets:insert(E, {1,-X}),
<a name="1648"/> 1648:                           {_,Y} &lt;- H_1, X &gt; Y]),
<a name="1649"/> 1649:           [] = qlc:e(H),
<a name="1650"/> 1650:           true = ets:delete(E)&quot;&gt;&gt;,
<a name="1651"/> 1651: 
<a name="1652"/> 1652:        &lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:sort([1,2,3], {fopp,la})]),
<a name="1653"/> 1653:           {'EXIT',{badarg,_}} = (catch qlc:e(H)),
<a name="1654"/> 1654:           {'EXIT',{badarg,_}} = (catch qlc:cursor(H)),
<a name="1655"/> 1655:           F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="1656"/> 1656:           {'EXIT',{badarg,_}} = (catch qlc:fold(F, [], H))&quot;&gt;&gt;,
<a name="1657"/> 1657: 
<a name="1658"/> 1658:        &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- [1,2]]),
<a name="1659"/> 1659:           AL = [Q1, [1,2,3]],
<a name="1660"/> 1660:           Q2 = qlc:q([X || X &lt;- qlc:sort(qlc:append(AL))]),
<a name="1661"/> 1661:           [1,1,2,2,3] = qlc:e(Q2)&quot;&gt;&gt;,
<a name="1662"/> 1662: 
<a name="1663"/> 1663:        &lt;&lt;&quot;H = qlc:q([{X,Y} || X &lt;- qlc:sort(qlc:q([X || X &lt;- [1,2,3,2]]), 
<a name="1664"/> 1664:                                             {unique,true}),
<a name="1665"/> 1665:                               Y &lt;- [a,b]]),
<a name="1666"/> 1666:           {qlc, _,
<a name="1667"/> 1667:            [{generate, _, {sort, {qlc, _, [{generate, _, {list, [1,2,3,2]}}],
<a name="1668"/> 1668:                                   [{unique,true}]},
<a name="1669"/> 1669:                            []}},
<a name="1670"/> 1670:             {generate, _, {qlc, _, [{generate, _, {list, [a,b]}}],
<a name="1671"/> 1671:                            [{unique,true}]}}],
<a name="1672"/> 1672:            [{unique,true}]} = i(H, unique_all),
<a name="1673"/> 1673:           [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] = qlc:e(H, unique_all)&quot;&gt;&gt;,
<a name="1674"/> 1674: 
<a name="1675"/> 1675:        &lt;&lt;&quot;L = [1,2,1,3,4,3,1],
<a name="1676"/> 1676:           true = lists:sort(L) == qlc:e(qlc:q([X || X &lt;- qlc:sort(L)])),
<a name="1677"/> 1677:           true = lists:usort(L) == 
<a name="1678"/> 1678:                  qlc:e(qlc:q([X || X &lt;- qlc:sort(L, {unique,true})])),
<a name="1679"/> 1679:           true = lists:reverse(lists:sort(L)) ==
<a name="1680"/> 1680:                  qlc:e(qlc:q([X || X &lt;- qlc:sort(L, {order, descending})])),
<a name="1681"/> 1681:           true = lists:reverse(lists:usort(L)) ==
<a name="1682"/> 1682:                  qlc:e(qlc:q([X || X &lt;- qlc:sort(L, [{order, descending}, 
<a name="1683"/> 1683:                                                      {unique, true}])])),
<a name="1684"/> 1684:           CF = fun(X, Y) -&gt; X =&lt; Y end,
<a name="1685"/> 1685:           true = lists:sort(L) == 
<a name="1686"/> 1686:                  qlc:e(qlc:q([X || X &lt;- qlc:sort(L, {order, CF})])),
<a name="1687"/> 1687:           true = lists:usort(L) ==
<a name="1688"/> 1688:                  qlc:e(qlc:q([X || X &lt;- qlc:sort(L, [{order, CF}, 
<a name="1689"/> 1689:                                                     {unique, true}])]))&quot;&gt;&gt;,
<a name="1690"/> 1690: 
<a name="1691"/> 1691:        &lt;&lt;&quot;E = ets:new(foo, []),
<a name="1692"/> 1692:           [true || I &lt;- lists:seq(1, 50000), not ets:insert(E, {I, I})],
<a name="1693"/> 1693:           H = qlc:q([{X,Y} || X &lt;- [a,b], Y &lt;- qlc:sort(ets:table(E))]),
<a name="1694"/> 1694:           100000 = length(qlc:e(H)),
<a name="1695"/> 1695:           ets:delete(E)&quot;&gt;&gt;
<a name="1696"/> 1696: 
<a name="1697"/> 1697:         ],
<a name="1698"/> 1698:     run(Config, Ts),
<a name="sort-last_expr"/><a name="1699"/> 1699:     ok.
<a name="1700"/> 1700: 
<a name="1701"/> 1701: <i>%% The sort option.</i>
<a name="keysort-1"/><a name="1702"/> 1702: <b>keysort</b>(Config) when is_list(Config) -&gt;
<a name="1703"/> 1703: 
<a name="1704"/> 1704:     Ts = [
<a name="1705"/> 1705:        &lt;&lt;&quot;OF = fun(X, Y) -&gt; X =&lt; Y end,
<a name="1706"/> 1706:           F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="1707"/> 1707:           H = qlc:q([X || X &lt;- qlc:keysort(1, [{2,a},{1,b}], {order,OF})]),
<a name="1708"/> 1708:           {'EXIT',{{badarg,order},_}} = (catch qlc:e(H)),
<a name="1709"/> 1709:           {'EXIT',{{badarg,order},_}} = (catch qlc:fold(F, [], H)),
<a name="1710"/> 1710:           {'EXIT',{{badarg,order},_}} = (catch qlc:cursor(H))&quot;&gt;&gt;,
<a name="1711"/> 1711: 
<a name="1712"/> 1712:        &lt;&lt;&quot;E = create_ets(1, 2),
<a name="1713"/> 1713:           H = qlc:q([X || X &lt;- qlc:keysort([1], ets:table(E), 
<a name="1714"/> 1714:                                            [{size,1},{tmpdir,\&quot;/a/b/c\&quot;}])]),
<a name="1715"/> 1715:           H1 = qlc:q([X || {X,_} &lt;- qlc:e(H), X &lt; 4]),
<a name="1716"/> 1716:           {error,_,{file_error,_,_}} = qlc:info(H1),
<a name="1717"/> 1717:           {error,_,{file_error,_,_}} = qlc:e(H1),
<a name="1718"/> 1718:           ets:delete(E)&quot;&gt;&gt;,
<a name="1719"/> 1719: 
<a name="1720"/> 1720:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c},{2,b}],
<a name="1721"/> 1721:           H = qlc:q([{X,Y} || {X,_} &lt;- qlc:keysort(1, qlc:q([X || X &lt;- L]), 
<a name="1722"/> 1722:                                                    {unique,true}),
<a name="1723"/> 1723:                               Y &lt;- [a,b]]),
<a name="1724"/> 1724:           [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] = qlc:e(H),
<a name="1725"/> 1725:           C = qlc:cursor(H),
<a name="1726"/> 1726:           [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] = 
<a name="1727"/> 1727:               qlc:next_answers(C, all_remaining),
<a name="1728"/> 1728:           qlc:delete_cursor(C)&quot;&gt;&gt;,
<a name="1729"/> 1729: 
<a name="1730"/> 1730:        &lt;&lt;&quot;H1 = qlc:q([X || X &lt;- qlc:keysort(0, [])]),
<a name="1731"/> 1731:           {'EXIT',{badarg,_}} = (catch qlc:e(H1)),
<a name="1732"/> 1732:           H2 = qlc:q([X || X &lt;- qlc:keysort(1, [], {bad,arg})]),
<a name="1733"/> 1733:           {'EXIT',{badarg,_}} = (catch qlc:e(H2)),
<a name="1734"/> 1734:           H3 = qlc:q([X || X &lt;- qlc:keysort([], [])]),
<a name="1735"/> 1735:           {'EXIT',{badarg,_}} = (catch qlc:e(H3))&quot;&gt;&gt;,
<a name="1736"/> 1736: 
<a name="1737"/> 1737:        &lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:keysort(1, [{1,a},{2,b}], 
<a name="1738"/> 1738:                                            [{order,descending},
<a name="1739"/> 1739:                                            {compressed,true}])]),
<a name="1740"/> 1740:           [{2,b},{1,a}] = qlc:e(H),
<a name="1741"/> 1741:           H2 = qlc:q([X || X &lt;- qlc:keysort(1, [{1},{2}], compressed)]),
<a name="1742"/> 1742:           {'EXIT', {badarg, _}} = (catch qlc:e(H2))&quot;&gt;&gt;,
<a name="1743"/> 1743: 
<a name="1744"/> 1744:        &lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:keysort(1, [{1,a},{2,b}], {compressed,false})]),
<a name="1745"/> 1745:           [{1,a},{2,b}] = qlc:e(H)&quot;&gt;&gt;,
<a name="1746"/> 1746: 
<a name="1747"/> 1747:        &lt;&lt;&quot;E = create_ets(1, 2),
<a name="1748"/> 1748:           H = qlc:q([X || X &lt;- qlc:keysort([1], ets:table(E), 
<a name="1749"/> 1749:                                            [{size,1},{tmpdir,\&quot;/a/b/c\&quot;}])]),
<a name="1750"/> 1750:           F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="1751"/> 1751:           {error,_,{file_error,_,_}} = qlc:e(H),
<a name="1752"/> 1752:           \&quot; \\\&quot;no such\&quot; ++ _ = lists:dropwhile(fun(A) -&gt; A =/= $\s end, 
<a name="1753"/> 1753:                                  lists:flatten(qlc:format_error(qlc:e(H)))),
<a name="1754"/> 1754:           {error,_,{file_error,_,_}} = qlc:e(H, {unique_all,true}),
<a name="1755"/> 1755:           {error,_,{file_error,_,_}} = qlc:cursor(H),
<a name="1756"/> 1756:           {error,_,{file_error,_,_}} = qlc:cursor(H, {unique_all,true}),
<a name="1757"/> 1757:           {error,_,{file_error,_,_}} = qlc:cursor(H, {spawn_options, []}),
<a name="1758"/> 1758:           {error,_,{file_error,_,_}} = qlc:cursor(H, {spawn_options,default}),
<a name="1759"/> 1759:           {error,_,{file_error,_,_}} = 
<a name="1760"/> 1760:                qlc:cursor(H, [{unique_all,true},{spawn_options, []}]),
<a name="1761"/> 1761:           {error,_,{file_error,_,_}} = qlc:fold(F, [], H),
<a name="1762"/> 1762:           {error,_,{file_error,_,_}} = qlc:fold(F, [],H, {unique_all,true}),
<a name="1763"/> 1763:           ets:delete(E)&quot;&gt;&gt;,
<a name="1764"/> 1764: 
<a name="1765"/> 1765:        &lt;&lt;&quot;L = [{1,b,a},{1,b,b},{1,a,a}],
<a name="1766"/> 1766:           H = qlc:q([X || X &lt;- qlc:keysort([4,1], L)]),
<a name="1767"/> 1767:           {error,_,bad_object} = qlc:e(H),
<a name="1768"/> 1768:           \&quot;the keys\&quot; ++ _ = qlc:format_error(qlc:e(H))&quot;&gt;&gt;,
<a name="1769"/> 1769: 
<a name="1770"/> 1770:        begin
<a name="1771"/> 1771:        File = filename:join(?privdir, &quot;afile&quot;),
<a name="1772"/> 1772:        ok = file:write_file(File, &lt;&lt;&gt;&gt;),
<a name="1773"/> 1773:        [&lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:keysort([1], [{1},{2},{1}],
<a name="1774"/> 1774:                                             [{tmpdir,\&quot;&quot;&gt;&gt;, File, &lt;&lt;&quot;\&quot;},
<a name="1775"/> 1775:                                              {size,1}])]),
<a name="1776"/> 1776:            {error,_,{file_error,_,_}} = qlc:e(H),
<a name="1777"/> 1777:            file:delete(\&quot;&quot;&gt;&gt;, File, &lt;&lt;&quot;\&quot;)&quot;&gt;&gt;]
<a name="1778"/> 1778:        end,
<a name="1779"/> 1779: 
<a name="1780"/> 1780:        &lt;&lt;&quot;H0 = qlc:q([X || X &lt;- [1,2,3]]),
<a name="1781"/> 1781:           H = qlc:q([X || X &lt;- qlc:sort(H0,{tmpdir,\&quot;.\&quot;})]),
<a name="1782"/> 1782:           [1,2,3] = qlc:e(H)&quot;&gt;&gt;,
<a name="1783"/> 1783: 
<a name="1784"/> 1784:        %% The global option 'tmpdir' takes precedence.
<a name="1785"/> 1785:        begin
<a name="1786"/> 1786:        PrivDir = ?privdir,
<a name="1787"/> 1787:        [&lt;&lt;&quot;L = [{1,a},{2,b}],
<a name="1788"/> 1788:            H = qlc:q([X || X &lt;- qlc:keysort([1], L, {tmpdir,\&quot;/a/b/c\&quot;})]),
<a name="1789"/> 1789:            H1 = qlc:q([X || X &lt;- H, X &gt; 3]),
<a name="1790"/> 1790:            Dir = \&quot;&quot;&gt;&gt;, PrivDir, &lt;&lt;&quot;\&quot;,
<a name="1791"/> 1791:            Options = [{tmpdir, Dir}],
<a name="1792"/> 1792:            {qlc,_,[{generate,_,{keysort,{list,L},[1],[{tmpdir,Dir}]}},_],[]} =
<a name="1793"/> 1793:                 i(H1, Options),
<a name="1794"/> 1794:            [{1,a},{2,b}] = qlc:e(H1, Options)&quot;&gt;&gt;] % no check of &quot;/a/b/c&quot;
<a name="1795"/> 1795:        end,
<a name="1796"/> 1796: 
<a name="1797"/> 1797:        &lt;&lt;&quot;L = [{2,c},{1,b},{1,a},{3,a},{1,c},{2,b}],
<a name="1798"/> 1798:           true = lists:sort(L) == 
<a name="1799"/> 1799:                  qlc:e(qlc:q([X || X &lt;- qlc:keysort([1,2], L)]))&quot;&gt;&gt;,
<a name="1800"/> 1800: 
<a name="1801"/> 1801:        &lt;&lt;&quot;L = [{1,b},{2,c},{1,a},{3,e},{4,f},{3,d}],
<a name="1802"/> 1802:           true = lists:keysort(1, L) ==
<a name="1803"/> 1803:                  qlc:e(qlc:q([X || X &lt;- qlc:keysort(1,L)])),
<a name="1804"/> 1804:           true = lists:ukeysort(1, L) ==
<a name="1805"/> 1805:                  qlc:e(qlc:q([X || X &lt;- qlc:keysort(1, L, {unique,true})])),
<a name="1806"/> 1806:           true = lists:reverse(lists:keysort(1, L)) ==
<a name="1807"/> 1807:                  qlc:e(qlc:q([X || X &lt;- qlc:keysort(1,L, 
<a name="1808"/> 1808:                                                     {order, descending})])),
<a name="1809"/> 1809:           true = lists:reverse(lists:ukeysort(1, L)) ==
<a name="1810"/> 1810:                  qlc:e(qlc:q([X || X &lt;- qlc:keysort(1, L, [{unique,true},
<a name="1811"/> 1811:                                                 {order, descending}])]))&quot;&gt;&gt;,
<a name="1812"/> 1812: 
<a name="1813"/> 1813:        &lt;&lt;&quot;L = [{X} || X &lt;- lists:seq(1,100000)],
<a name="1814"/> 1814:           H1 = qlc:append([L,[{1,2},{2,3},{3,4}]]),
<a name="1815"/> 1815:           H = qlc:keysort([1], qlc:keysort([1], H1, [{compressed,true}])),
<a name="1816"/> 1816:           R = qlc:e(H),
<a name="1817"/> 1817:           100003 = length(R)&quot;&gt;&gt;
<a name="1818"/> 1818: 
<a name="1819"/> 1819:         ],
<a name="1820"/> 1820:     run(Config, Ts),
<a name="1821"/> 1821: 
<a name="keysort-last_expr"/><a name="1822"/> 1822:     ok.
<a name="1823"/> 1823: 
<a name="1824"/> 1824: <i>%% keysort/1,2, using a file.</i>
<a name="filesort-1"/><a name="1825"/> 1825: <b>filesort</b>(Config) when is_list(Config) -&gt;
<a name="1826"/> 1826:     Ts = [
<a name="1827"/> 1827:        &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [{3},{1},{2}]]),
<a name="1828"/> 1828:           Opts = [{size,10},{no_files,3}],
<a name="1829"/> 1829:           Q2 = qlc:q([{X,Y} || Y &lt;- [1,2], X &lt;- qlc:keysort([1],Q,Opts)]),
<a name="1830"/> 1830:           [{{1},1},{{2},1},{{3},1},{{1},2},{{2},2},{{3},2}] = qlc:e(Q2)&quot;&gt;&gt;
<a name="1831"/> 1831:         ],
<a name="1832"/> 1832:     run(Config, Ts),
<a name="filesort-last_expr"/><a name="1833"/> 1833:     ok.
<a name="1834"/> 1834: 
<a name="1835"/> 1835: 
<a name="1836"/> 1836: <i>%% The cache option.</i>
<a name="cache-1"/><a name="1837"/> 1837: <b>cache</b>(Config) when is_list(Config) -&gt;
<a name="1838"/> 1838:     Ts = [
<a name="1839"/> 1839:        &lt;&lt;&quot;{'EXIT', {badarg, _}} = (catch qlc:q([X || X &lt;- [1,2]], badarg))&quot;&gt;&gt;,
<a name="1840"/> 1840: 
<a name="1841"/> 1841:        &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- [1,2,1,2,1]], {unique,true}),
<a name="1842"/> 1842:           [1,2] = qlc:e(Q1),
<a name="1843"/> 1843:           [1,2] = qlc:e(Q1, {unique_all,true}),
<a name="1844"/> 1844:           Q2 = qlc:q([X || X &lt;- qlc:q([X || X &lt;- [1,2,1,2,1]],
<a name="1845"/> 1845:                                       {unique,true})]),
<a name="1846"/> 1846:           [1,2] = qlc:e(Q2),
<a name="1847"/> 1847:           [1,2] = qlc:e(Q2, {unique_all,true}),
<a name="1848"/> 1848:           Q3 = qlc:q([X || X &lt;- qlc:append([[1,2,3], [4,5,6]])]),
<a name="1849"/> 1849:           [1,2,3,4,5,6] = qlc:e(Q3)&quot;&gt;&gt;,
<a name="1850"/> 1850: 
<a name="1851"/> 1851:        &lt;&lt;&quot;Q1 = qlc:q([X || {X,_} &lt;- [{1,a},{2,a},{1,b},{2,b}]]),
<a name="1852"/> 1852:           Q2 = qlc:q([{X,make_ref()} || X &lt;- Q1]),
<a name="1853"/> 1853:           [{1,_},{2,_},{1,_},{2,_}] = qlc:e(Q2, {unique_all,false}),
<a name="1854"/> 1854:           [{1,_},{2,_}] = qlc:e(Q2, {unique_all,true})&quot;&gt;&gt;,
<a name="1855"/> 1855: 
<a name="1856"/> 1856:        &lt;&lt;&quot;E = ets:new(test, [duplicate_bag]),
<a name="1857"/> 1857:           true = ets:insert(E, [{1,a},{2,a},{1,b},{2,b}]),
<a name="1858"/> 1858:           Q1 = qlc:q([X || {X,_} &lt;- ets:table(E)]),
<a name="1859"/> 1859:           Q2 = qlc:q([{X,make_ref()} || X &lt;- Q1]),
<a name="1860"/> 1860:           [{1,_},{1,_},{2,_},{2,_}] = lists:sort(qlc:e(Q2, {unique_all,false})),
<a name="1861"/> 1861:           [{1,_},{2,_}] = lists:sort(qlc:e(Q2, {unique_all,true})),
<a name="1862"/> 1862:           ets:delete(E)&quot;&gt;&gt;,
<a name="1863"/> 1863: 
<a name="1864"/> 1864:        &lt;&lt;&quot;Q1 = qlc:q([X || {X,_} &lt;- [{1,a},{2,a},{1,b},{2,b}]]),
<a name="1865"/> 1865:           Q2 = qlc:q([{X,make_ref()} || X &lt;- qlc:append([Q1, Q1])]),
<a name="1866"/> 1866:           [{1,_},{2,_},{1,_},{2,_},{1,_},{2,_},{1,_},{2,_}] = 
<a name="1867"/> 1867:                 qlc:e(Q2, {unique_all,false}),
<a name="1868"/> 1868:           [{1,_},{2,_}] = qlc:e(Q2, {unique_all,true})&quot;&gt;&gt;,
<a name="1869"/> 1869: 
<a name="1870"/> 1870:        &lt;&lt;&quot;[] = qlc:e(qlc:q([X || X &lt;- []], {unique, true})),
<a name="1871"/> 1871:           [] = qlc:e(qlc:q([X || X &lt;- qlc:q([X || X &lt;- qlc:append([])], 
<a name="1872"/> 1872:                                              {unique,true})]))&quot;&gt;&gt;,
<a name="1873"/> 1873: 
<a name="1874"/> 1874:        &lt;&lt;&quot;Q1 = qlc:q([{X,make_ref()} || {X,_} &lt;- [{1,a},{1,b}]]),
<a name="1875"/> 1875:           [{1,_},{1,_}] = qlc:e(Q1, {unique_all, true}),
<a name="1876"/> 1876:           Q2 = qlc:q([Y || {X,_} &lt;- [{1,a},{1,b}],
<a name="1877"/> 1877:                            begin Y = {X,make_ref()}, true end]),
<a name="1878"/> 1878:           [{1,_},{1,_}] = qlc:e(Q2, {unique_all,true}),
<a name="1879"/> 1879:           Q3 = qlc:q([Y || X &lt;- [{1,a},{2,a}], 
<a name="1880"/> 1880:                            begin {_,Z} = X, Y = {Z,make_ref()}, true end]),
<a name="1881"/> 1881:           [{a,_},{a,_}] = qlc:e(Q3, {unique_all, true})&quot;&gt;&gt;,
<a name="1882"/> 1882: 
<a name="1883"/> 1883:        &lt;&lt;&quot;E = ets:new(apa, [duplicate_bag]),
<a name="1884"/> 1884:           ets:insert(E, [{1,a},{2,a},{1,a}]),
<a name="1885"/> 1885:           H1 = qlc:q([X || X &lt;- qlc:append(ets:table(E),[7,3,5])], 
<a name="1886"/> 1886:                           {cache, true}),
<a name="1887"/> 1887:           [{_,a},{_,a},{_,a},7,3,5] = qlc:e(H1),
<a name="1888"/> 1888:           ets:delete(E)&quot;&gt;&gt;,
<a name="1889"/> 1889:           
<a name="1890"/> 1890:        &lt;&lt;&quot;F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="1891"/> 1891:           H = qlc:q([X || X &lt;- [1,3,2,4]], cache),
<a name="1892"/> 1892:           Q = qlc:q([X || X &lt;- H]),
<a name="1893"/> 1893:           [1,3,2,4] = qlc:fold(F, [], Q, [])&quot;&gt;&gt;,
<a name="1894"/> 1894: 
<a name="1895"/> 1895:        &lt;&lt;&quot;F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="1896"/> 1896:           E = ets:new(apa, [duplicate_bag]),
<a name="1897"/> 1897:           true = ets:insert(E, [{1,a},{2,b},{1,a}]),
<a name="1898"/> 1898:           Q1 = qlc:q([X || X &lt;- ets:table(E)], [cache, unique]),
<a name="1899"/> 1899:           Q = qlc:q([X || X &lt;- Q1], [cache, unique]),
<a name="1900"/> 1900:           {qlc, _, [{generate, _,{table,_}}], [{unique,true}]} = i(Q),
<a name="1901"/> 1901:           R = qlc:fold(F, [], Q, []),
<a name="1902"/> 1902:           ets:delete(E),
<a name="1903"/> 1903:           true = [{1,a},{2,b}] == lists:sort(R)&quot;&gt;&gt;,
<a name="1904"/> 1904: 
<a name="1905"/> 1905:        &lt;&lt;&quot;E = ets:new(apa, [duplicate_bag]),
<a name="1906"/> 1906:           ets:insert(E, [{1,a},{2,b},{1,a}]),
<a name="1907"/> 1907:           H1 = qlc:q([X || X &lt;- qlc:append(ets:table(E),[7,3])], cache),
<a name="1908"/> 1908:           H2 = qlc:q([{Y,X} || Y &lt;- [2,1,3], X &lt;- H1]),
<a name="1909"/> 1909:           [{2,_},{2,_},{2,_},{2,7},{2,3},
<a name="1910"/> 1910:            {1,_},{1,_},{1,_},{1,7},{1,3},
<a name="1911"/> 1911:            {3,_},{3,_},{3,_},{3,7},{3,3}] = qlc:e(H2),
<a name="1912"/> 1912:           ets:delete(E)&quot;&gt;&gt;,
<a name="1913"/> 1913: 
<a name="1914"/> 1914:           %% This case is not 100 percent determined. An Ets table
<a name="1915"/> 1915:           %% is updated in a filter and later used in a generator.
<a name="1916"/> 1916:        &lt;&lt;&quot;E = ets:new(apa, [bag]),
<a name="1917"/> 1917:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1918"/> 1918:           H1 = qlc:q([Y || Y &lt;- ets:table(E)], 
<a name="1919"/> 1919:                      [{cache, no}, {unique, true}]),
<a name="1920"/> 1920:           H = qlc:q([{X,Y} || X &lt;- [{1,a},{2,d},{3,e}],
<a name="1921"/> 1921:                               ets:insert(E, X),
<a name="1922"/> 1922:                               Y &lt;- H1]),
<a name="1923"/> 1923:           [{{1,a},_}, {{1,a},_}, {{2,d},_}, {{2,d},_}, {{2,d},_}, 
<a name="1924"/> 1924:            {{3,e},_}, {{3,e},_}, {{3,e},_}, {{3,e},_}] = qlc:e(H),
<a name="1925"/> 1925:           ets:delete(E)&quot;&gt;&gt;,
<a name="1926"/> 1926: 
<a name="1927"/> 1927:           %% This case is not 100 percent determined. An Ets table
<a name="1928"/> 1928:           %% is updated in a filter and later used in a generator.
<a name="1929"/> 1929:        &lt;&lt;&quot;E = ets:new(apa, [bag]),
<a name="1930"/> 1930:           true = ets:insert(E, [{1,a},{2,b}]),
<a name="1931"/> 1931:           H1 = qlc:q([Y || Y &lt;- ets:table(E)], 
<a name="1932"/> 1932:                      [{cache, true}, {unique, true}]),
<a name="1933"/> 1933:           H = qlc:q([{X,Y} || X &lt;- [{1,a},{2,d},{3,e}],
<a name="1934"/> 1934:                               ets:insert(E, X),
<a name="1935"/> 1935:                               Y &lt;- H1]),
<a name="1936"/> 1936:           [{{1,a},_}, {{1,a},_}, {{2,d},_}, {{2,d},_}, {{3,e},_}, {{3,e},_}] = 
<a name="1937"/> 1937:               qlc:e(H),
<a name="1938"/> 1938:           ets:delete(E)&quot;&gt;&gt;,
<a name="1939"/> 1939: 
<a name="1940"/> 1940:        &lt;&lt;&quot;%% {5979} and {5549} are both hashed to 28244 by phash2/1
<a name="1941"/> 1941:           E = ets:new(apa, [duplicate_bag]),
<a name="1942"/> 1942:           true = ets:insert(E, [{5979},{5549},{5979},{5549},{0}]),
<a name="1943"/> 1943:           H1 = qlc:q([X || X &lt;- ets:table(E)], 
<a name="1944"/> 1944:                      [{cache, true}, {unique, true}]),
<a name="1945"/> 1945:           H = qlc:q([Y || _ &lt;- [1,2], Y &lt;- H1]),
<a name="1946"/> 1946:           {qlc, _, [{generate, _, {list, [1,2]}},
<a name="1947"/> 1947:                     {generate, _, {qlc, _, [{generate, _, {table,_}}],
<a name="1948"/> 1948:                                    [{cache,ets},{unique,true}]}}],
<a name="1949"/> 1949:            []} = i(H),
<a name="1950"/> 1950:           [{0},{0},{5549},{5549},{5979},{5979}] = lists:sort(qlc:e(H)),
<a name="1951"/> 1951:           ets:delete(E)&quot;&gt;&gt;,
<a name="1952"/> 1952: 
<a name="1953"/> 1953:        &lt;&lt;&quot;E = ets:new(apa, [ordered_set]),
<a name="1954"/> 1954:           ets:insert(E, [{1},{2}]),
<a name="1955"/> 1955:           H1 = qlc:q([X || X &lt;- ets:table(E)], [cache, unique]),
<a name="1956"/> 1956:           H2 = qlc:q([X || Y &lt;- [3,4], ets:insert(E, {Y}), X &lt;- H1]),
<a name="1957"/> 1957:           {qlc, _, [{generate, _, {list, [3,4]}}, _, 
<a name="1958"/> 1958:                     {generate, _, {qlc, _, [{generate, _, 
<a name="1959"/> 1959:                                              {table, _}}], 
<a name="1960"/> 1960:                                    [{cache, ets}]}}], 
<a name="1961"/> 1961:            []} = i(H2),
<a name="1962"/> 1962:           [{1},{2},{3},{1},{2},{3}] = qlc:e(H2),
<a name="1963"/> 1963:           ets:delete(E)&quot;&gt;&gt;,
<a name="1964"/> 1964: 
<a name="1965"/> 1965:        &lt;&lt;&quot;E = ets:new(apa, [ordered_set]),
<a name="1966"/> 1966:           ets:insert(E, [{1},{2}]),
<a name="1967"/> 1967:           H1 = qlc:q([X || X &lt;- ets:table(E)], [unique]),
<a name="1968"/> 1968:           H2 = qlc:q([X || Y &lt;- [3,4], ets:insert(E, {Y}), X &lt;- H1]),
<a name="1969"/> 1969:           [{1},{2},{3},{1},{2},{3},{4}] = qlc:e(H2),
<a name="1970"/> 1970:           ets:delete(E)&quot;&gt;&gt;,
<a name="1971"/> 1971: 
<a name="1972"/> 1972:        &lt;&lt;&quot;H0 = qlc:append([a,b], [c,d]),
<a name="1973"/> 1973:           H = qlc:q([{X,Y} || 
<a name="1974"/> 1974:                         X &lt;- H0,
<a name="1975"/> 1975:                         Y &lt;- qlc:q([{X1,Y} || 
<a name="1976"/> 1976:                                        X1 &lt;- H0,
<a name="1977"/> 1977:                                        Y &lt;- qlc:q([{X2,Y} || 
<a name="1978"/> 1978:                                                       X2 &lt;- H0,
<a name="1979"/> 1979:                                                       Y &lt;- H0])])]),
<a name="1980"/> 1980:           {qlc, _,
<a name="1981"/> 1981:            [{generate, _,{append, [{list, [a,b]}, {list, [c,d]}]}},
<a name="1982"/> 1982:             {generate, _, 
<a name="1983"/> 1983:              {qlc, _,
<a name="1984"/> 1984:               [{generate, _, {append,[{list, [a,b]},{list, [c,d]}]}},
<a name="1985"/> 1985:                {generate, _, 
<a name="1986"/> 1986:                 {qlc, _,
<a name="1987"/> 1987:                  [{generate, _,{append,[{list, [a,b]}, {list, [c,d]}]}},
<a name="1988"/> 1988:                   {generate, _,{append,[{list, [a,b]}, {list, [c,d]}]}}],
<a name="1989"/> 1989:                  [{cache,ets}]}}],
<a name="1990"/> 1990:               [{cache,ets}]}}],
<a name="1991"/> 1991:            []} = i(H, cache_all)&quot;&gt;&gt;
<a name="1992"/> 1992:        
<a name="1993"/> 1993:        ],
<a name="1994"/> 1994:     run(Config, Ts),
<a name="cache-last_expr"/><a name="1995"/> 1995:     ok.
<a name="1996"/> 1996: 
<a name="1997"/> 1997: <i>%% OTP-6038. The {cache,list} option.</i>
<a name="cache_list-1"/><a name="1998"/> 1998: <b>cache_list</b>(Config) when is_list(Config) -&gt;
<a name="1999"/> 1999:     Ts = [
<a name="2000"/> 2000:        begin
<a name="2001"/> 2001:        PrivDir = ?privdir,
<a name="2002"/> 2002:        [&lt;&lt;&quot;%% unique, cache list. A simple qlc.
<a name="2003"/> 2003:           Options = [{cache,list}, unique],
<a name="2004"/> 2004:           L0 = [1,2,3,4,1,2,3,4],
<a name="2005"/> 2005:           L = qlc_SUITE:table(L0, []),
<a name="2006"/> 2006:           Q1 = qlc:q([X || X &lt;- L], Options),
<a name="2007"/> 2007:           Q = qlc:q([{X,Y} || X &lt;- [a,b], Y &lt;- Q1]),
<a name="2008"/> 2008:           GOptions = [{tmpdir,\&quot;&quot;&gt;&gt;, PrivDir, &lt;&lt;&quot;\&quot;}],
<a name="2009"/> 2009:           {qlc,_,[{generate,_,{list,[a,b]}},
<a name="2010"/> 2010:                   {generate,_,{qlc,_,
<a name="2011"/> 2011:                                [{generate,_,{table,_}}],
<a name="2012"/> 2012:                                [{cache,list},{unique,true}]}}],
<a name="2013"/> 2013:            []} = i(Q, GOptions),
<a name="2014"/> 2014:           true = [{X,Y} || X &lt;- [a,b], Y &lt;- [1,2,3,4]] =:= 
<a name="2015"/> 2015:                  qlc:e(Q, GOptions)&quot;&gt;&gt;]
<a name="2016"/> 2016:        end,
<a name="2017"/> 2017: 
<a name="2018"/> 2018:        begin
<a name="2019"/> 2019:        MS = ets:fun2ms(fun({X,_}) when X &gt; 1 -&gt; X end),
<a name="2020"/> 2020:        [&lt;&lt;&quot;%% No cache, even if explicit match specification.
<a name="2021"/> 2021:           etsc(fun(E) -&gt;
<a name="2022"/> 2022:                    MS =  &quot;&gt;&gt;, io_lib:format(&quot;~w&quot;, [MS]), &lt;&lt;&quot;,
<a name="2023"/> 2023:                    Options = [{cache,list}, unique],
<a name="2024"/> 2024:                    Q = qlc:q([{X,Y} || 
<a name="2025"/> 2025:                                  X &lt;- ets:table(E, {traverse, {select, MS}}),
<a name="2026"/> 2026:                                  Y &lt;- [1,2,3]], 
<a name="2027"/> 2027:                              Options),
<a name="2028"/> 2028:                    {qlc,_,[{generate,_,{table,{ets,table,_}}},
<a name="2029"/> 2029:                            {generate,_,{list,[1,2,3]}}],
<a name="2030"/> 2030:                     [{unique,true}]} = i(Q),
<a name="2031"/> 2031:                    true = [{X,Y} || X &lt;- lists:seq(2,10), Y &lt;- [1,2,3]] =:=
<a name="2032"/> 2032:                        lists:sort(qlc:e(Q))
<a name="2033"/> 2033:                end, [{keypos,1}], [{I,a} || I &lt;- lists:seq(1, 10)])&quot;&gt;&gt;]
<a name="2034"/> 2034:        end,
<a name="2035"/> 2035: 
<a name="2036"/> 2036:        &lt;&lt;&quot;%% Temporary files.
<a name="2037"/> 2037:           %% Remove list expression caches when possible. (no visible effect)
<a name="2038"/> 2038:           T = lists:seq(1, 100000), % Huge terms on file
<a name="2039"/> 2039:           F = fun(C) -&gt;
<a name="2040"/> 2040:                       Q0 = qlc:q([{X} || X &lt;- [T,T,T], begin X &gt; 0 end], 
<a name="2041"/> 2041:                                  {cache,C}),
<a name="2042"/> 2042:                       Q1 = qlc:q([{X,Y,Z} ||
<a name="2043"/> 2043:                                      X &lt;- Q0,
<a name="2044"/> 2044:                                      Y &lt;- Q0,
<a name="2045"/> 2045:                                      Z &lt;- Q0],
<a name="2046"/> 2046:                                  {cache,C}),
<a name="2047"/> 2047:                       qlc:q([{X, Y} || Y &lt;- [1], X &lt;- Q1])
<a name="2048"/> 2048:               end,
<a name="2049"/> 2049:           Ql = F(list),
<a name="2050"/> 2050:           Rl = qlc:e(Ql, {max_list_size, 64*1024}),
<a name="2051"/> 2051:           Qe = F(ets),
<a name="2052"/> 2052:           Re = qlc:e(Qe),
<a name="2053"/> 2053:           Qf = F(no),
<a name="2054"/> 2054:           Rf = qlc:e(Qf),
<a name="2055"/> 2055:           Ri = qlc:e(Ql, {max_list_size, 1 bsl 35}), % heavy
<a name="2056"/> 2056:           {27,27,27,27,true,true,true} = 
<a name="2057"/> 2057:               {length(Rl), length(Re), length(Rf), length(Ri),
<a name="2058"/> 2058:                Rl =:= Re, Re =:= Rf, Rf =:= Ri}&quot;&gt;&gt;,
<a name="2059"/> 2059: 
<a name="2060"/> 2060:        &lt;&lt;&quot;%% File sorter.
<a name="2061"/> 2061:           T = lists:seq(1, 10000),
<a name="2062"/> 2062:           F = fun(C) -&gt;
<a name="2063"/> 2063:                       Q0 = qlc:q([{X} || X &lt;- [T,T,T], begin X &gt; 0 end], 
<a name="2064"/> 2064:                                  [{cache,C},unique]),
<a name="2065"/> 2065:                       Q1 = qlc:q([{X,Y,Z} ||
<a name="2066"/> 2066:                                      X &lt;- Q0,
<a name="2067"/> 2067:                                      Y &lt;- Q0,
<a name="2068"/> 2068:                                      Z &lt;- Q0],
<a name="2069"/> 2069:                                  [{cache,C},unique]),
<a name="2070"/> 2070:                       qlc:q([{X, Y} || Y &lt;- [1], X &lt;- Q1])
<a name="2071"/> 2071:               end,
<a name="2072"/> 2072:           GOpt = [{max_list_size, 10000}],
<a name="2073"/> 2073:           Ql = F(list),
<a name="2074"/> 2074:           Rl = qlc:e(Ql, GOpt),
<a name="2075"/> 2075:           Qe = F(ets),
<a name="2076"/> 2076:           Re = qlc:e(Qe, GOpt),
<a name="2077"/> 2077:           Qf = F(no),
<a name="2078"/> 2078:           Rf = qlc:e(Qf, GOpt),
<a name="2079"/> 2079:           {1,1,1,true,true} = 
<a name="2080"/> 2080:               {length(Rl), length(Re), length(Rf), Rl =:= Re, Re =:= Rf}&quot;&gt;&gt;,
<a name="2081"/> 2081: 
<a name="2082"/> 2082:        &lt;&lt;&quot;%% Remove list expression caches when possible. (no visible effect)
<a name="2083"/> 2083:           Q0 = qlc:q([{X} || X &lt;- [1,2,3], begin X &gt; 0 end], {cache,list}),
<a name="2084"/> 2084:           Q1 = qlc:q([{X,Y,Z} ||
<a name="2085"/> 2085:                          X &lt;- Q0,
<a name="2086"/> 2086:                          Y &lt;- Q0,
<a name="2087"/> 2087:                          Z &lt;- Q0],
<a name="2088"/> 2088:                      {cache,list}),
<a name="2089"/> 2089:           Q = qlc:q([{X, Y} || Y &lt;- [1], X &lt;- Q1]),
<a name="2090"/> 2090:           R = qlc:e(Q),
<a name="2091"/> 2091:           L0 = [{X} || X &lt;- [1,2,3], begin X &gt; 0 end],
<a name="2092"/> 2092:           L1 = [{X,Y,Z} ||
<a name="2093"/> 2093:                    X &lt;- L0,
<a name="2094"/> 2094:                    Y &lt;- L0,
<a name="2095"/> 2095:                    Z &lt;- L0],
<a name="2096"/> 2096:           L = [{X, Y} || Y &lt;- [1], X &lt;- L1],
<a name="2097"/> 2097:           true = R =:= L&quot;&gt;&gt;,
<a name="2098"/> 2098: 
<a name="2099"/> 2099:        &lt;&lt;&quot;%% No temporary file.
<a name="2100"/> 2100:           L = [{I,a} || I &lt;- lists:seq(1, 10)],
<a name="2101"/> 2101:           Q0 = qlc:q([X || X &lt;- qlc_SUITE:table_error(L, 1, err),
<a name="2102"/> 2102:                            begin element(1, X) &gt; 5 end],
<a name="2103"/> 2103:                      {cache,list}),
<a name="2104"/> 2104:           Q = qlc:q([{X, element(1,Y)} || 
<a name="2105"/> 2105:                         X &lt;- lists:seq(1, 5),
<a name="2106"/> 2106:                         Y &lt;- Q0]),
<a name="2107"/> 2107:           err = qlc:e(Q)&quot;&gt;&gt;,
<a name="2108"/> 2108: 
<a name="2109"/> 2109:        &lt;&lt;&quot;%% Sort internally.
<a name="2110"/> 2110:           L = [{I,a} || I &lt;- lists:seq(1, 10)],
<a name="2111"/> 2111:           Q0 = qlc:q([X || X &lt;- qlc_SUITE:table_error(L, 1, err),
<a name="2112"/> 2112:                            begin element(1, X) &gt; 5 end],
<a name="2113"/> 2113:                      [unique,{cache,list}]),
<a name="2114"/> 2114:           Q = qlc:q([{X, element(1,Y)} || 
<a name="2115"/> 2115:                         X &lt;- lists:seq(1, 5),
<a name="2116"/> 2116:                         Y &lt;- Q0]),
<a name="2117"/> 2117:           err = qlc:e(Q, {max_list_size,0})&quot;&gt;&gt;,
<a name="2118"/> 2118: 
<a name="2119"/> 2119:        &lt;&lt;&quot;%% No temporary file.
<a name="2120"/> 2120:           etsc(fun(E) -&gt;
<a name="2121"/> 2121:                        Q0 = qlc:q([X || X &lt;- ets:table(E),
<a name="2122"/> 2122:                                         begin element(1, X) &gt; 5 end],
<a name="2123"/> 2123:                                   {cache,list}),
<a name="2124"/> 2124:                        Q = qlc:q([{X, element(1,Y)} || X &lt;- lists:seq(1, 5),
<a name="2125"/> 2125:                                                        Y &lt;- Q0]),
<a name="2126"/> 2126:                        R = [{X,Y} || X &lt;- lists:seq(1, 5), 
<a name="2127"/> 2127:                                      Y &lt;- lists:seq(6, 10)],
<a name="2128"/> 2128:                        R = lists:sort(qlc:e(Q))
<a name="2129"/> 2129:                end, [{keypos,1}], [{I,a} || I &lt;- lists:seq(1, 10)])&quot;&gt;&gt;,
<a name="2130"/> 2130: 
<a name="2131"/> 2131:        &lt;&lt;&quot;%% Sort internally
<a name="2132"/> 2132:           etsc(fun(E) -&gt;
<a name="2133"/> 2133:                        Q0 = qlc:q([X || X &lt;- ets:table(E),
<a name="2134"/> 2134:                                         begin element(1, X) &gt; 5 end],
<a name="2135"/> 2135:                                   [{cache,list},unique]),
<a name="2136"/> 2136:                        Q = qlc:q([{X, element(1,Y)} || X &lt;- lists:seq(1, 5),
<a name="2137"/> 2137:                                                        Y &lt;- Q0]),
<a name="2138"/> 2138:                        R = [{X,Y} || X &lt;- lists:seq(1, 5), 
<a name="2139"/> 2139:                                      Y &lt;- lists:seq(6, 10)],
<a name="2140"/> 2140:                        R = lists:sort(qlc:e(Q))
<a name="2141"/> 2141:                end, [{keypos,1}], [{I,a} || I &lt;- lists:seq(1, 10)])&quot;&gt;&gt;,
<a name="2142"/> 2142: 
<a name="2143"/> 2143:        &lt;&lt;&quot;%% A few more tests of unique and {cache,list}.
<a name="2144"/> 2144:           F = fun(CU) -&gt;
<a name="2145"/> 2145:                       H1 = qlc:q([{X,Y} || 
<a name="2146"/> 2146:                                      Y &lt;- [a,b], 
<a name="2147"/> 2147:                                      X &lt;- [1,2]],
<a name="2148"/> 2148:                                  CU),
<a name="2149"/> 2149:                       qlc:q([{X,Y,Z} || X &lt;- [3,4], {Y,Z} &lt;- H1])
<a name="2150"/> 2150:               end,
<a name="2151"/> 2151:           Q1 = F([]),
<a name="2152"/> 2152:           Q2 = F([{cache,list}, unique]),
<a name="2153"/> 2153:           R1 = qlc:e(Q1),
<a name="2154"/> 2154:           R2 = qlc:e(Q2),
<a name="2155"/> 2155:           R3 = qlc:e(Q2, {max_list_size, 0}), % still in RAM
<a name="2156"/> 2156:           true = R1 =:= R2,
<a name="2157"/> 2157:           true = R2 =:= R3&quot;&gt;&gt;,
<a name="2158"/> 2158: 
<a name="2159"/> 2159:        &lt;&lt;&quot;E = ets:new(t, [duplicate_bag]),
<a name="2160"/> 2160:           true = ets:insert(E, [{2},{1},{2}]),
<a name="2161"/> 2161:           H1 = qlc:q([{X,Y} || 
<a name="2162"/> 2162:                          Y &lt;- [a,b], 
<a name="2163"/> 2163:                          {X} &lt;- ets:table(E)], 
<a name="2164"/> 2164:                      [{cache,list}, unique]),
<a name="2165"/> 2165:           H2 = qlc:q([{X,Y,Z} || X &lt;- [3,4], {Y,Z} &lt;- H1]),
<a name="2166"/> 2166:           {qlc,_,[{generate,_,{list,[3,4]}},
<a name="2167"/> 2167:                   {generate,_,{qlc,_,
<a name="2168"/> 2168:                                [{generate,_,{list,[a,b]}},
<a name="2169"/> 2169:                                 {generate,_,
<a name="2170"/> 2170:                                  {qlc,_,[{generate,_,{table,{ets,table,_}}}],
<a name="2171"/> 2171:                                   [{cache,list},{unique,true}]}}],
<a name="2172"/> 2172:                                [{cache,list},{unique,true}]}}], []} = i(H2),
<a name="2173"/> 2173:           L1s = [[{X,Y} || Y &lt;- [a,b], X &lt;- Xs] || Xs &lt;- [[1,2], [2,1]]],
<a name="2174"/> 2174:           L2s = [[{X,Y,Z} || X &lt;- [3,4], {Y,Z} &lt;- L1] || L1 &lt;- L1s],
<a name="2175"/> 2175:           R1 = qlc:e(H2),
<a name="2176"/> 2176:           R2 = qlc:e(H2, {max_list_size, 0}), % on temporary file
<a name="2177"/> 2177:           ets:delete(E),
<a name="2178"/> 2178:           true = lists:member(R1, L2s),
<a name="2179"/> 2179:           true = R1 =:= R2&quot;&gt;&gt;,
<a name="2180"/> 2180: 
<a name="2181"/> 2181:        &lt;&lt;&quot;E = ets:new(t, [duplicate_bag]),
<a name="2182"/> 2182:           true = ets:insert(E, [{2},{1},{2}]),
<a name="2183"/> 2183:           H1 = qlc:q([{X,Y} || 
<a name="2184"/> 2184:                          Y &lt;- [a,b], 
<a name="2185"/> 2185:                          {X} &lt;- ets:table(E)], 
<a name="2186"/> 2186:                      [{cache,list}]),
<a name="2187"/> 2187:           H2 = qlc:q([{X,Y,Z} || X &lt;- [3,4], {Y,Z} &lt;- H1]),
<a name="2188"/> 2188:           L1s = [[{X,Y} || Y &lt;- [a,b], X &lt;- Xs] || Xs &lt;- [[1,2,2], [2,2,1]]],
<a name="2189"/> 2189:           L2s = [[{X,Y,Z} || X &lt;- [3,4], {Y,Z} &lt;- L1] || L1 &lt;- L1s],
<a name="2190"/> 2190:           R1 = qlc:e(H2),
<a name="2191"/> 2191:           R2 = qlc:e(H2, {max_list_size, 0}), % on temporary file
<a name="2192"/> 2192:           ets:delete(E),
<a name="2193"/> 2193:           true = lists:member(R1, L2s),
<a name="2194"/> 2194:           true = R1 =:= R2&quot;&gt;&gt;,
<a name="2195"/> 2195: 
<a name="2196"/> 2196:        &lt;&lt;&quot;Q1 = qlc:q([{X,Y} || 
<a name="2197"/> 2197:                          Y &lt;- [a,b], 
<a name="2198"/> 2198:                          {X,_} &lt;- qlc_SUITE:table_error([{a,1}], 2, err)],
<a name="2199"/> 2199:                      [{cache,list}, unique]),
<a name="2200"/> 2200:           Q = qlc:q([{X,Y,Z} || X &lt;- [3,4], {Y,Z} &lt;- Q1]),
<a name="2201"/> 2201:           {qlc,_,[{generate,_,{list,[3,4]}},
<a name="2202"/> 2202:                   {generate,_,{qlc,_,
<a name="2203"/> 2203:                                [{generate,_,{list,[a,b]}},
<a name="2204"/> 2204:                                 {generate,_,{table,_}}],
<a name="2205"/> 2205:                                [{cache,list},{unique,true}]}}],
<a name="2206"/> 2206:            []} = i(Q),
<a name="2207"/> 2207:           err = qlc:e(Q,{max_list_size,0})&quot;&gt;&gt;,
<a name="2208"/> 2208: 
<a name="2209"/> 2209:        begin
<a name="2210"/> 2210:        Privdir = ?privdir,
<a name="2211"/> 2211:        [&lt;&lt;&quot;
<a name="2212"/> 2212:           E = ets:new(t, [duplicate_bag]),
<a name="2213"/> 2213:           N = 17000,
<a name="2214"/> 2214:           true = ets:insert(E, [{X,X} || X &lt;- lists:seq(1, N)]),
<a name="2215"/> 2215:           N = ets:info(E, size),
<a name="2216"/> 2216:           RF = fun(GOpts) -&gt;
<a name="2217"/> 2217:                        F = fun(CU) -&gt;
<a name="2218"/> 2218:                                    H1 = qlc:q([{X,Y} || 
<a name="2219"/> 2219:                                                   Y &lt;- [a,b], 
<a name="2220"/> 2220:                                                   {X,_} &lt;- ets:table(E)], 
<a name="2221"/> 2221:                                               CU),
<a name="2222"/> 2222:                                    qlc:q([{X,Y,Z} || X &lt;- [3,4], {Y,Z} &lt;- H1])
<a name="2223"/> 2223:                            end,
<a name="2224"/> 2224:                        Q1 = F([{cache,list}, unique]),
<a name="2225"/> 2225:                        _ = qlc:info(Q1, GOpts),
<a name="2226"/> 2226:                        R1 = qlc:e(Q1, GOpts),
<a name="2227"/> 2227:                        Q2 = F([unique]),
<a name="2228"/> 2228:                        R2 = qlc:e(Q2, GOpts),
<a name="2229"/> 2229:                        true = lists:sort(R1) =:= lists:sort(R2)
<a name="2230"/> 2230:                end,
<a name="2231"/> 2231:           GOpts = [{tmpdir,\&quot;&quot;&gt;&gt;,Privdir,&lt;&lt;&quot;\&quot;}],
<a name="2232"/> 2232:           RF([{max_list_size, 1 bsl 35} | GOpts]),
<a name="2233"/> 2233:           RF(GOpts),
<a name="2234"/> 2234:           RF([{max_list_size, 40000} | GOpts]),
<a name="2235"/> 2235:           true = ets:insert(E, [{X,X} || X &lt;- lists:seq(1, N)]),
<a name="2236"/> 2236:           true = N+N =:= ets:info(E, size),
<a name="2237"/> 2237:           RF([{max_list_size, 1 bsl 30} | GOpts]),
<a name="2238"/> 2238:           RF(GOpts),
<a name="2239"/> 2239:           RF([{max_list_size, 40000} | GOpts]),
<a name="2240"/> 2240:           ets:delete(E)&quot;&gt;&gt;]
<a name="2241"/> 2241:        end,
<a name="2242"/> 2242: 
<a name="2243"/> 2243:        &lt;&lt;&quot;%% Temporary file employed.
<a name="2244"/> 2244:           etsc(fun(E) -&gt;
<a name="2245"/> 2245:                        Q0 = qlc:q([X || X &lt;- ets:table(E),
<a name="2246"/> 2246:                                         begin element(1, X) &gt; 5 end],
<a name="2247"/> 2247:                                   {cache,list}),
<a name="2248"/> 2248:                        Q = qlc:q([{X, element(1,Y)} || X &lt;- lists:seq(1, 5),
<a name="2249"/> 2249:                                                        Y &lt;- Q0]),
<a name="2250"/> 2250:                        R = [{X,Y} || X &lt;- lists:seq(1, 5), 
<a name="2251"/> 2251:                                      Y &lt;- lists:seq(6, 10)],
<a name="2252"/> 2252:                        R = lists:sort(qlc:e(Q, {max_list_size, 100*1024}))
<a name="2253"/> 2253:                end, [{keypos,1}], [{I,a,lists:duplicate(100000,1)} || 
<a name="2254"/> 2254:                                         I &lt;- lists:seq(1, 10)])&quot;&gt;&gt;,
<a name="2255"/> 2255: 
<a name="2256"/> 2256:        &lt;&lt;&quot;%% Temporary file employed. The file is removed after error.
<a name="2257"/> 2257:           L = [{I,a,lists:duplicate(100000,1)} || I &lt;- lists:seq(1, 10)],
<a name="2258"/> 2258:           Q0 = qlc:q([X || X &lt;- qlc_SUITE:table_error(L, 1, err),
<a name="2259"/> 2259:                            begin element(1, X) &gt; 5 end],
<a name="2260"/> 2260:                      {cache,list}),
<a name="2261"/> 2261:           Q = qlc:q([{X, element(1,Y)} || 
<a name="2262"/> 2262:                         X &lt;- lists:seq(1, 5),
<a name="2263"/> 2263:                         Y &lt;- Q0]),
<a name="2264"/> 2264:           err = qlc:e(Q)&quot;&gt;&gt;,
<a name="2265"/> 2265: 
<a name="2266"/> 2266:        &lt;&lt;&quot;%% Temporary file employed. The file is removed after error.
<a name="2267"/> 2267:           L = [{I,a,lists:duplicate(100000,1)} || I &lt;- lists:seq(1, 10)],
<a name="2268"/> 2268:           Q0 = qlc:q([X || X &lt;- qlc_SUITE:table(L, 1, []),
<a name="2269"/> 2269:                            begin element(1, X) &gt; 5 end],
<a name="2270"/> 2270:                      {cache,list}),
<a name="2271"/> 2271:           Q = qlc:q([{X, element(1,Y)} || 
<a name="2272"/> 2272:                         X &lt;- lists:seq(1, 5),
<a name="2273"/> 2273:                         Y &lt;- Q0]),
<a name="2274"/> 2274:           {error, _, {file_error,_,_}} = qlc:e(Q, {tmpdir, \&quot;/a/b/c\&quot;})&quot;&gt;&gt;,
<a name="2275"/> 2275: 
<a name="2276"/> 2276:        &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [1,2]]),
<a name="2277"/> 2277:           {'EXIT', {badarg, _}} = (catch qlc:e(Q, {max_list_size, -1}))&quot;&gt;&gt;,
<a name="2278"/> 2278: 
<a name="2279"/> 2279:        &lt;&lt;&quot;Q = qlc:q([X || X &lt;- [1,2]]),
<a name="2280"/> 2280:           {'EXIT', {badarg, _}} = (catch qlc:e(Q, {max_list_size, foo}))&quot;&gt;&gt;
<a name="2281"/> 2281: 
<a name="2282"/> 2282:        ],
<a name="2283"/> 2283:     run(Config, Ts),
<a name="cache_list-last_expr"/><a name="2284"/> 2284:     ok.
<a name="2285"/> 2285: 
<a name="2286"/> 2286: <i>%% Filters and match specs.</i>
<a name="filter-1"/><a name="2287"/> 2287: <b>filter</b>(Config) when is_list(Config) -&gt;
<a name="2288"/> 2288:     Ts = [
<a name="2289"/> 2289:        &lt;&lt;&quot;L = [1,2,3,4,5],
<a name="2290"/> 2290:           QH1 = qlc:q([X || X &lt;- L, X &gt; 1, X &lt; 4]),
<a name="2291"/> 2291:           [2,3] = qlc:e(QH1),
<a name="2292"/> 2292:           {list,{list,L},_MS} = i(QH1)
<a name="2293"/> 2293:          &quot;&gt;&gt;,
<a name="2294"/> 2294: 
<a name="2295"/> 2295:        &lt;&lt;&quot;L = [1,2,3,4,5],
<a name="2296"/> 2296:           QH2 = qlc:q([X || X &lt;- L, X &gt; 1, X &lt; 4, X &gt; 2]),
<a name="2297"/> 2297:           [3] = qlc:e(QH2),
<a name="2298"/> 2298:           {list,{list,L},_MS} = i(QH2)
<a name="2299"/> 2299:          &quot;&gt;&gt;,
<a name="2300"/> 2300: 
<a name="2301"/> 2301:           %% &quot;X &gt; 1&quot; is skipped since the matchspec does the job
<a name="2302"/> 2302:        &lt;&lt;&quot;QH3 = qlc:q([X || X &lt;- [1,2,3,4,5], X &gt; 1, begin X &lt; 4 end]),
<a name="2303"/> 2303:           [2,3] = qlc:e(QH3),
<a name="2304"/> 2304:           {qlc,_,[{generate,_,{list,{list,[1,2,3,4,5]},_MS}},_],[]} = i(QH3)
<a name="2305"/> 2305:          &quot;&gt;&gt;,
<a name="2306"/> 2306: 
<a name="2307"/> 2307:        &lt;&lt;&quot;QH4 = qlc:q([{X,Y} || X &lt;- [1,2], Y &lt;- [1,2]]),
<a name="2308"/> 2308:           [{1,1},{1,2},{2,1},{2,2}] = qlc:e(QH4),
<a name="2309"/> 2309:           {qlc,_,[{generate,_,{list,[1,2]}},{generate,_,{list,[1,2]}}],[]} =
<a name="2310"/> 2310:               i(QH4)&quot;&gt;&gt;,
<a name="2311"/> 2311: 
<a name="2312"/> 2312:           %% &quot;X &gt; 1&quot; is skipped since the matchspec does the job
<a name="2313"/> 2313:        &lt;&lt;&quot;QH5 = qlc:q([{X,Y} || X &lt;- [1,2], X &gt; 1, Y &lt;- [1,2]]),
<a name="2314"/> 2314:           [{2,1},{2,2}] = qlc:e(QH5),
<a name="2315"/> 2315:           {qlc,_,[{generate,_,{list,{list,[1,2]},_MS}},
<a name="2316"/> 2316:                   {generate,_,{list,[1,2]}}],[]} = 
<a name="2317"/> 2317:               i(QH5)&quot;&gt;&gt;,
<a name="2318"/> 2318: 
<a name="2319"/> 2319:        &lt;&lt;&quot;%% Binaries are not handled at all when trying to find lookup values
<a name="2320"/> 2320:           etsc(fun(E) -&gt;
<a name="2321"/> 2321:                       A = 2, 
<a name="2322"/> 2322:                       Q = qlc:q([X || {X} &lt;- ets:table(E), &lt;&lt;A&gt;&gt; =:= &lt;&lt;X&gt;&gt;]),
<a name="2323"/> 2323:                       [2] = lists:sort(qlc:e(Q)),
<a name="2324"/> 2324:                       false = lookup_keys(Q)
<a name="2325"/> 2325:               end, [{1},{2},{3}])&quot;&gt;&gt;,
<a name="2326"/> 2326: 
<a name="2327"/> 2327:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2328"/> 2328:                       Q = qlc:q([X || {X,_} &lt;- ets:table(E), 
<a name="2329"/> 2329:                                    qlc:e(qlc:q([Y || {Y,_} &lt;- ets:table(E), 
<a name="2330"/> 2330:                                                               Y &gt; X])) == []]),
<a name="2331"/> 2331:                       [3] = qlc:e(Q)
<a name="2332"/> 2332:               end, [{1,a},{2,b},{3,c}])&quot;&gt;&gt;,
<a name="2333"/> 2333: 
<a name="2334"/> 2334:        &lt;&lt;&quot;Q = qlc:q([X || {X} &lt;- [], (false or (X/0 &gt; 3))]),
<a name="2335"/> 2335:           \&quot;[]\&quot; = qlc:info(Q),
<a name="2336"/> 2336:           [] = qlc:e(Q)&quot;&gt;&gt;,
<a name="2337"/> 2337: 
<a name="2338"/> 2338:        &lt;&lt;&quot;%% match spec
<a name="2339"/> 2339:           [] = qlc:e(qlc:q([X || {X} &lt;- [{1},{2}], 
<a name="2340"/> 2340:                                  (false orelse (X/0 &gt; 3))])),
<a name="2341"/> 2341:           %% generated code
<a name="2342"/> 2342:           {'EXIT', {badarith, _}} = 
<a name="2343"/> 2343:             (catch qlc:e(qlc:q([X || {X} &lt;- [{1}], 
<a name="2344"/> 2344:                                      begin (false orelse (X/0 &gt; 3)) end])))&quot;&gt;&gt;,
<a name="2345"/> 2345: 
<a name="2346"/> 2346:        &lt;&lt;&quot;%% Partial evaluation in filter.
<a name="2347"/> 2347:           etsc(fun(E) -&gt;
<a name="2348"/> 2348:                      QH = qlc:q([{X+1,Y} || {X,Y} &lt;- ets:table(E), 
<a name="2349"/> 2349:                                             X =:= 1-1+1+(+1)]),
<a name="2350"/> 2350:                      [{3,2}] = qlc:e(QH),
<a name="2351"/> 2351:                      [2] = lookup_keys(QH)
<a name="2352"/> 2352:               end, [{1,1},{2,2},{3,3}])&quot;&gt;&gt;,
<a name="2353"/> 2353: 
<a name="2354"/> 2354:        &lt;&lt;&quot;%% =/2 in filters must not be recognized when 'badmatch' is
<a name="2355"/> 2355:           %% possible.
<a name="2356"/> 2356:           etsc(fun(E) -&gt;
<a name="2357"/> 2357:                      QH = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E),
<a name="2358"/> 2358:                                           ((Y = X) =:= 3)]),
<a name="2359"/> 2359:                      {'EXIT', {{badmatch,4},_}} = (catch qlc:e(QH)),
<a name="2360"/> 2360:                      false = lookup_keys(QH)
<a name="2361"/> 2361:                end, [{3,3},{4,true}])&quot;&gt;&gt;,
<a name="2362"/> 2362: 
<a name="2363"/> 2363:        &lt;&lt;&quot;%% One more of the same kind.
<a name="2364"/> 2364:           etsc(fun(E) -&gt;
<a name="2365"/> 2365:                       QH = qlc:q([{X,Y} || {X,_} &lt;- ets:table(E), 
<a name="2366"/> 2366:                                            (Y=X) =:= (Y=1+1)]),
<a name="2367"/> 2367:                       {'EXIT', {{badmatch,2},_}} = (catch qlc:e(QH)),
<a name="2368"/> 2368:                       false = lookup_keys(QH)
<a name="2369"/> 2369:               end, [{1,1},{2,2},{3,3}])&quot;&gt;&gt;,
<a name="2370"/> 2370: 
<a name="2371"/> 2371:        &lt;&lt;&quot;%% OTP-5195. Used to return a value, but badarith is correct.
<a name="2372"/> 2372:           etsc(fun(E) -&gt;
<a name="2373"/> 2373:                       QH = qlc:q([X || {X,_} &lt;- ets:table(E), 
<a name="2374"/> 2374:                                        (X =:= 1) and
<a name="2375"/> 2375:                                     if X =:= 1 -&gt; true;
<a name="2376"/> 2376:                                        true -&gt; X/0
<a name="2377"/> 2377:                                     end]),
<a name="2378"/> 2378:                       {'EXIT',{badarith,_}} = (catch qlc:e(QH)),
<a name="2379"/> 2379:                       false = lookup_keys(QH)
<a name="2380"/> 2380:               end, [{1,1},{2,2},{3,3}])&quot;&gt;&gt;,
<a name="2381"/> 2381: 
<a name="2382"/> 2382:        {cres,
<a name="2383"/> 2383:         &lt;&lt;&quot;fun(Z) -&gt;
<a name="2384"/> 2384:             Q = qlc:q([X || Z &lt; 2, X &lt;- [1,2,3]]),
<a name="2385"/> 2385:             [] = qlc:e(Q)
<a name="2386"/> 2386:            end(3)&quot;&gt;&gt;, [], {warnings,[{{2,31},sys_core_fold,{nomatch,guard}},
<a name="2387"/> 2387:                                      {{2,31},sys_core_fold,{nomatch,no_clause}}]}},
<a name="2388"/> 2388: 
<a name="2389"/> 2389:        &lt;&lt;&quot;H = qlc:q([{P1,A,P2,B,P3,C} ||
<a name="2390"/> 2390:                   P1={A,_} &lt;- [{1,a},{2,b}],
<a name="2391"/> 2391:                   {_,B}=P2 &lt;- [{1,a},{2,b}],
<a name="2392"/> 2392:                   C=P3 &lt;- [1],
<a name="2393"/> 2393:                   {[X,_],{_,X}} &lt;- [{[1,2],{3,1}}, {[a,b],{3,4}}],
<a name="2394"/> 2394:                   A &gt; 0,
<a name="2395"/> 2395:                   B =/= c,
<a name="2396"/> 2396:                   C &gt; 0]),
<a name="2397"/> 2397:           L = [{{1,a},1,{1,a},a,1,1}, {{1,a},1,{2,b},b,1,1},
<a name="2398"/> 2398:                {{2,b},2,{1,a},a,1,1}, {{2,b},2,{2,b},b,1,1}],
<a name="2399"/> 2399:           L = qlc:e(H)&quot;&gt;&gt;,
<a name="2400"/> 2400: 
<a name="2401"/> 2401:        &lt;&lt;&quot;H = qlc:q([{X,Y} ||
<a name="2402"/> 2402:                   X = _ &lt;- [1,2,3],
<a name="2403"/> 2403:                   _ = Y &lt;- [a,b,c],
<a name="2404"/> 2404:                   _ = _ &lt;- [foo],
<a name="2405"/> 2405:                   X &gt; 1,
<a name="2406"/> 2406:                   Y =/= a]),
<a name="2407"/> 2407:           [{2,b},{2,c},{3,b},{3,c}] = qlc:e(H)&quot;&gt;&gt;
<a name="2408"/> 2408: 
<a name="2409"/> 2409:        ],
<a name="2410"/> 2410:     run(Config, Ts),
<a name="filter-last_expr"/><a name="2411"/> 2411:     ok.
<a name="2412"/> 2412: 
<a name="2413"/> 2413: <i>%% info/2.</i>
<a name="info-1"/><a name="2414"/> 2414: <b>info</b>(Config) when is_list(Config) -&gt;
<a name="2415"/> 2415:     Ts = [
<a name="2416"/> 2416:        &lt;&lt;&quot;{list, [1,2]} = i(qlc:q([X || X &lt;- [1,2]])),
<a name="2417"/> 2417:           {append,[{list, [1,2]}, {list, [3,4]}]} = 
<a name="2418"/> 2418:                i(qlc:append([1,2],[3,4])),
<a name="2419"/> 2419:           {sort,{list, [1,2]},[]} = i(qlc:sort([1,2])),
<a name="2420"/> 2420:           E = ets:new(foo, []),
<a name="2421"/> 2421:           ets:insert(E, [{1},{2}]),
<a name="2422"/> 2422:           {table, _} = i(ets:table(E)),
<a name="2423"/> 2423:           true = ets:delete(E),
<a name="2424"/> 2424:           {list, [1,2]} = i([1,2]),
<a name="2425"/> 2425:           {append, [{list, [1,2]}, {list, [3,4]}]} =
<a name="2426"/> 2426:              i(qlc:q([X || X &lt;- qlc:append([1,2],[3,4])])),
<a name="2427"/> 2427:           
<a name="2428"/> 2428:           H0 = qlc:q([X || X &lt;- throw({throw,t})]),
<a name="2429"/> 2429:           {throw,t} = (catch {any_term,qlc:info(H0)}),
<a name="2430"/> 2430:           {'EXIT', {badarg, _}} = 
<a name="2431"/> 2431:                (catch qlc:info(foobar)),
<a name="2432"/> 2432:           {'EXIT', {badarg, _}} = 
<a name="2433"/> 2433:                (catch qlc:info(qlc:q([X || X &lt;- [1,2]]), badarg))&quot;&gt;&gt;,
<a name="2434"/> 2434: 
<a name="2435"/> 2435:        &lt;&lt;&quot;{'EXIT', {badarg, _}} = 
<a name="2436"/> 2436:                (catch qlc:info([X || {X} &lt;- []], {n_elements, 0})),
<a name="2437"/> 2437:           L = lists:seq(1, 1000),
<a name="2438"/> 2438:           \&quot;[1, 2, 3, 4, 5, 6, 7, 8, 9, 10 | '...']\&quot; = qlc:info(L, {n_elements, 10}),
<a name="2439"/> 2439:           {cons,A1,{integer,A2,1},{atom,A3,'...'}} =
<a name="2440"/> 2440:             qlc:info(L, [{n_elements, 1},{format,abstract_code}]),
<a name="2441"/> 2441:           1 = erl_anno:line(A1),
<a name="2442"/> 2442:           1 = erl_anno:line(A2),
<a name="2443"/> 2443:           1 = erl_anno:line(A3),
<a name="2444"/> 2444:           Q = qlc:q([{X} || X &lt;- [a,b,c,d,e,f]]),
<a name="2445"/> 2445:           {call,_,_,[{cons,_,{atom,_,a},{cons,_,{atom,_,b},{cons,_,{atom,_,c},
<a name="2446"/> 2446:                                                             {atom,_,'...'}}}},
<a name="2447"/> 2447:                      {call,_,_,_}]} = 
<a name="2448"/> 2448:           qlc:info(Q, [{n_elements, 3},{format,abstract_code}]),
<a name="2449"/> 2449:           \&quot;ets:match_spec_run([a, b, c, d, e, f],\n\&quot;
<a name="2450"/> 2450:           \&quot;                   ets:match_spec_compile([{'$1', [true], \&quot;
<a name="2451"/> 2451:           \&quot;[{{'$1'}}]}]))\&quot; = 
<a name="2452"/> 2452:              qlc:info(Q, [{n_elements, infinity}])&quot;&gt;&gt;,
<a name="2453"/> 2453: 
<a name="2454"/> 2454:        &lt;&lt;&quot;Q1 = qlc:q([{X} || X &lt;- qlc:q([X || X &lt;- [1,2]])]),
<a name="2455"/> 2455:           {qlc, _, [{generate, _, {list, [1,2]}}],[]} = i(Q1),
<a name="2456"/> 2456:           Q2 = qlc:q([X || X &lt;- qlc:q([{X} || X &lt;- [1,2]])]),
<a name="2457"/> 2457:           {list,{list,[1,2]},_} = i(Q2),
<a name="2458"/> 2458:           [{1},{2}] = qlc:eval(Q2),
<a name="2459"/> 2459:           Q3 = qlc:q([{X,Y} || X &lt;- qlc:q([X || X &lt;- [a,b]]),       
<a name="2460"/> 2460:                                Y &lt;- qlc:q([Z || Z &lt;- [a,b]])]),
<a name="2461"/> 2461:           {qlc, _, [{generate, _, {list, [a,b]}}, 
<a name="2462"/> 2462:                     {generate, _, {list, [a,b]}}], []} = i(Q3),
<a name="2463"/> 2463:           Q4 = qlc:q([X || X &lt;- [a]]),
<a name="2464"/> 2464:           {list, [a]} = i(Q4),
<a name="2465"/> 2465:           Q5 = qlc:q([X || X &lt;- qlc:q([Y || Y &lt;- [a,b]], unique)]),
<a name="2466"/> 2466:           {qlc, _, [{generate, _, {list, [a,b]}}], [{unique,true}]} = 
<a name="2467"/> 2467:              i(Q5)&quot;&gt;&gt;,
<a name="2468"/> 2468: 
<a name="2469"/> 2469:        &lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:append([qlc:q([X || X &lt;- [1,2]]),[1,2]])]),
<a name="2470"/> 2470:           {append, [{list, [1,2]},{list, [1,2]}]} = i(H),
<a name="2471"/> 2471:           [1,2,1,2] = qlc:e(H)&quot;&gt;&gt;,
<a name="2472"/> 2472: 
<a name="2473"/> 2473:        &lt;&lt;&quot;H = qlc:q([{X} || X &lt;- [], X &gt; 1]),
<a name="2474"/> 2474:           {list, []} = i(H),
<a name="2475"/> 2475:           [] = qlc:e(H)&quot;&gt;&gt;,
<a name="2476"/> 2476: 
<a name="2477"/> 2477:        &lt;&lt;&quot;H1 = qlc:q([{X} || X &lt;- [], X &gt; 1]),
<a name="2478"/> 2478:           H = qlc:q([{X} || X &lt;- H1, X &lt; 10]),
<a name="2479"/> 2479:           {list, []} = i(H),
<a name="2480"/> 2480:           [] = qlc:e(H)&quot;&gt;&gt;,
<a name="2481"/> 2481: 
<a name="2482"/> 2482:        &lt;&lt;&quot;L = [1,2,3],
<a name="2483"/> 2483:           QH1 = qlc:q([{X} || X &lt;- L, X &gt; 1]),
<a name="2484"/> 2484:           QH2 = qlc:q([{X} || X &lt;- QH1]),
<a name="2485"/> 2485:           [{{2}},{{3}}] = qlc:e(QH2),
<a name="2486"/> 2486:           {list,{list,{list,L},_},_} = i(QH2)&quot;&gt;&gt;,
<a name="2487"/> 2487: 
<a name="2488"/> 2488:        &lt;&lt;&quot;H = qlc:q([X || X &lt;- qlc:q([Y || Y &lt;- qlc:q([Z || Z &lt;-[1,2,1]])])]),
<a name="2489"/> 2489:           {list, [1,2,1]} = i(H),
<a name="2490"/> 2490:           [1,2,1] = qlc:eval(H)&quot;&gt;&gt;,
<a name="2491"/> 2491: 
<a name="2492"/> 2492:        &lt;&lt;&quot;%% Used to replace empty ETS tables with [], but that won't work.
<a name="2493"/> 2493:           E = ets:new(apa,[]),
<a name="2494"/> 2494:           QH1 = qlc:q([{X} || X &lt;- ets:table(E), X &gt; 1]),
<a name="2495"/> 2495:           QH2 = qlc:q([{X} || X &lt;- QH1], cache),
<a name="2496"/> 2496:           [] = qlc:e(QH2),
<a name="2497"/> 2497:           {qlc,_,[{generate,_,{table,{ets,table,_}}}],[]} = i(QH2),
<a name="2498"/> 2498:           ets:delete(E)&quot;&gt;&gt;,
<a name="2499"/> 2499: 
<a name="2500"/> 2500:        &lt;&lt;&quot;Q1 = qlc:q([W || W &lt;- [a,b]]),
<a name="2501"/> 2501:           Q2 = qlc:q([Z || Z &lt;- qlc:sort([55296,56296,57296])], unique),
<a name="2502"/> 2502:           Q3 = qlc:q([{X,Y} || X &lt;- qlc:keysort([2], [{1,a}]),
<a name="2503"/> 2503:                                Y &lt;- qlc:append([Q1, Q2]),
<a name="2504"/> 2504:                                X &gt; Y]),
<a name="2505"/> 2505:           {qlc, T1,
<a name="2506"/> 2506:            [{generate, P1, {list, [{1,a}]}},
<a name="2507"/> 2507:             {generate, P2, {append, [{list, [a,b]},
<a name="2508"/> 2508:                                     {qlc, T2, [{generate, P3,
<a name="2509"/> 2509:                                                 {sort, {list,[55296,56296,57296]},[]}}],
<a name="2510"/> 2510:                                      [{cache,ets},{unique,true}]}]}},F],
<a name="2511"/> 2511:            []} = i(Q3, cache_all),
<a name="2512"/> 2512:           {tuple, _, [{var,_,'X'}, {var,_,'Y'}]} = binary_to_term(T1),
<a name="2513"/> 2513:           {var, _, 'X'} = binary_to_term(P1),
<a name="2514"/> 2514:           {var, _, 'Y'} = binary_to_term(P2),
<a name="2515"/> 2515:           {var, _, 'Z'} = binary_to_term(P3),
<a name="2516"/> 2516:           {var, _, 'Z'} = binary_to_term(T2),
<a name="2517"/> 2517:           {op, _, '&gt;', {var, _, 'X'}, {var, _, 'Y'}} = binary_to_term(F),
<a name="2518"/> 2518:           true = binary_to_list(&lt;&lt;
<a name="2519"/> 2519:            \&quot;beginV1=qlc:q([Z||Z&lt;-qlc:sort([55296,56296,57296],[])],[{unique,true}]),\&quot;
<a name="2520"/> 2520:            \&quot;qlc:q([{X,Y}||X&lt;-[{1,a}],Y&lt;-qlc:append([[a,b],V1]),X&gt;Y])end\&quot;
<a name="2521"/> 2521:               &gt;&gt;) == format_info(Q3, true)&quot;&gt;&gt;,
<a name="2522"/> 2522: 
<a name="2523"/> 2523:        &lt;&lt;&quot;Q1 = qlc:q([{X} || X &lt;- qlc:q([X || X &lt;- [a,b]])]),
<a name="2524"/> 2524:           {qlc, _, [{generate, _, {list, [a,b]}}], []} = i(Q1),
<a name="2525"/> 2525:           Q2 = qlc:q([X || X &lt;- qlc:q([{X} || X &lt;- [a,b]])]),
<a name="2526"/> 2526:           {list,{list,[a,b]},_} = i(Q2),
<a name="2527"/> 2527:           [{a},{b}] = qlc:eval(Q2)&quot;&gt;&gt;,
<a name="2528"/> 2528: 
<a name="2529"/> 2529:        &lt;&lt;&quot;Q = qlc:keysort(2, [{1,a,b},{2,b,c},{3,4,c}]),
<a name="2530"/> 2530:           {keysort,{list,[{1,a,b},{2,b,c},{3,4,c}]},2,[]} = i(Q),
<a name="2531"/> 2531:           true = binary_to_list(&lt;&lt;
<a name="2532"/> 2532:              \&quot;qlc:keysort(2,[{1,a,b},{2,b,c},{3,4,c}],[])\&quot;&gt;&gt;) 
<a name="2533"/> 2533:               == format_info(Q, true),
<a name="2534"/> 2534:           [{3,4,c},{1,a,b},{2,b,c}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="2535"/> 2535: 
<a name="2536"/> 2536:        &lt;&lt;&quot;E = ets:new(foo, []),
<a name="2537"/> 2537:           ets:insert(E, [{1},{2}]),
<a name="2538"/> 2538:           Q = qlc_SUITE:default_table(E),
<a name="2539"/> 2539:           {table,{'$MOD','$FUN',[]}} = i(Q),
<a name="2540"/> 2540:           true = binary_to_list(&lt;&lt;\&quot;'$MOD':'$FUN'()\&quot;&gt;&gt;) 
<a name="2541"/> 2541:                 == format_info(Q, true),
<a name="2542"/> 2542:           true = ets:delete(E)&quot;&gt;&gt;,
<a name="2543"/> 2543: 
<a name="2544"/> 2544:        &lt;&lt;&quot;\&quot;[]\&quot; = qlc:info([], flat),
<a name="2545"/> 2545:           \&quot;[]\&quot; = qlc:info([]),
<a name="2546"/> 2546:           \&quot;[]\&quot; = qlc:info([], {flat, true})&quot;&gt;&gt;,
<a name="2547"/> 2547: 
<a name="2548"/> 2548:        &lt;&lt;&quot;H = qlc:q([{X} || X &lt;- [a,b]]),
<a name="2549"/> 2549:          \&quot;ets:match_spec_run([a,b],ets:match_spec_compile(\&quot; ++ _ =
<a name="2550"/> 2550:                 format_info(H, true),
<a name="2551"/> 2551:          \&quot;ets:match_spec_run([a,b],ets:match_spec_compile(\&quot; ++ _ =
<a name="2552"/> 2552:                 format_info(H, false)&quot;&gt;&gt;,
<a name="2553"/> 2553: 
<a name="2554"/> 2554:        &lt;&lt;&quot;H = qlc:q([{X} || X &lt;- [a,b], begin true end]),
<a name="2555"/> 2555:           true = binary_to_list(&lt;&lt;\&quot;qlc:q([{X}||X&lt;-[a,b],begintrueend])\&quot;&gt;&gt;) 
<a name="2556"/> 2556:              == format_info(H, true),
<a name="2557"/> 2557:           true = binary_to_list(&lt;&lt;\&quot;qlc:q([{X}||X&lt;-[a,b],begintrueend])\&quot;&gt;&gt;)
<a name="2558"/> 2558:              == format_info(H, false)&quot;&gt;&gt;,
<a name="2559"/> 2559: 
<a name="2560"/> 2560:        &lt;&lt;&quot;H = qlc:q([A || {A} &lt;- [{1},{2}], (A =:= 2) andalso true]),
<a name="2561"/> 2561:           {call,_,{remote,_,{atom,_,ets},{atom,_,match_spec_run}},_} = 
<a name="2562"/> 2562:              qlc:info(H, {format,abstract_code})&quot;&gt;&gt;,
<a name="2563"/> 2563: 
<a name="2564"/> 2564:        &lt;&lt;&quot;H = qlc:q([{X} || X &lt;- qlc:q([{X} || X &lt;- [a,b], begin true end],
<a name="2565"/> 2565:                                        unique), 
<a name="2566"/> 2566:                             begin true end]),
<a name="2567"/> 2567:           true = binary_to_list(&lt;&lt; 
<a name="2568"/> 2568:          \&quot;beginV1=qlc:q([{X}||X&lt;-[a,b],begintrueend],[{unique,true}]),\&quot;
<a name="2569"/> 2569:          \&quot;qlc:q([{X}||X&lt;-V1,begintrueend])end\&quot;&gt;&gt;) == 
<a name="2570"/> 2570:               format_info(H, true),
<a name="2571"/> 2571:           true = binary_to_list(&lt;&lt;
<a name="2572"/> 2572:          \&quot;qlc:q([{X}||X&lt;-qlc:q([{X}||X&lt;-[a,b],begintrueend],\&quot;
<a name="2573"/> 2573:          \&quot;[{unique,true}]),begintrueend])\&quot;&gt;&gt;) == format_info(H, false)&quot;&gt;&gt;,
<a name="2574"/> 2574: 
<a name="2575"/> 2575:        &lt;&lt;&quot;H0 = qlc:q([{V3} || V3 &lt;- qlc:q([{V1} || V1 &lt;- [a,b], 
<a name="2576"/> 2576:                                                    begin true end], unique), 
<a name="2577"/> 2577:                               begin true end]),
<a name="2578"/> 2578:           H = qlc:sort(H0),
<a name="2579"/> 2579:           true = binary_to_list(&lt;&lt;
<a name="2580"/> 2580:           \&quot;qlc:sort(qlc:q([{V3}||V3&lt;-qlc:q([{V1}||\&quot;
<a name="2581"/> 2581:           \&quot;V1&lt;-[a,b],begintrueend],[{unique,true}]),begintrueend]),[])\&quot;&gt;&gt;) 
<a name="2582"/> 2582:               == format_info(H, false),
<a name="2583"/> 2583:           true = binary_to_list(&lt;&lt;
<a name="2584"/> 2584:           \&quot;beginV2=qlc:q([{V1}||V1&lt;-[a,b],begintrueend],[{unique,true}]),\&quot;
<a name="2585"/> 2585:           \&quot;V4=qlc:q([{V3}||V3&lt;-V2,begintrueend]),qlc:sort(V4,[])end\&quot;&gt;&gt;) 
<a name="2586"/> 2586:               == format_info(H, true)&quot;&gt;&gt;,
<a name="2587"/> 2587: 
<a name="2588"/> 2588:        &lt;&lt;&quot;H0 = qlc:q([X || X &lt;- [true], begin true end]),
<a name="2589"/> 2589:           H1 = qlc:q([{X} || X &lt;- [a,b], begin true end], 
<a name="2590"/> 2590:                      [{unique,begin [T] = qlc:e(H0), T end}]),
<a name="2591"/> 2591:           {call,_,{remote,_,{atom,_,qlc},{atom,_,q}},
<a name="2592"/> 2592:                   [{lc,_,{tuple,_,[{var,_,'X'}]},
<a name="2593"/> 2593:                          [{generate,_,{var,_,'X'},
<a name="2594"/> 2594:                                       {cons,_,{atom,_,a},_}},
<a name="2595"/> 2595:                           {block, _, [{atom, _, true}]}]},
<a name="2596"/> 2596:                    {cons,_,_,_}]} = i(H1, {format, abstract_code})&quot;&gt;&gt;,
<a name="2597"/> 2597: 
<a name="2598"/> 2598:        &lt;&lt;&quot;E = ets:new(apa, [duplicate_bag]),
<a name="2599"/> 2599:           true = ets:insert(E, [{1,a},{2,b},{3,c},{4,d}]),
<a name="2600"/> 2600:           QH = qlc:q([X || {X,_} &lt;- ets:tab2list(E), X &gt; 2], unique),
<a name="2601"/> 2601:           {qlc, _, [{generate, _, {list, _, _MS}}], [{unique, true}]} = 
<a name="2602"/> 2602:                 i(QH),
<a name="2603"/> 2603:           [3,4] = lists:sort(qlc:e(QH)),
<a name="2604"/> 2604:           ets:delete(E)&quot;&gt;&gt;,
<a name="2605"/> 2605: 
<a name="2606"/> 2606:        %% &quot;Imported&quot; variable.
<a name="2607"/> 2607:        &lt;&lt;&quot;F = fun(U) -&gt; qlc:q([{X} || X &lt;- [1,2,3,4,5,6], X &gt; U]) end,
<a name="2608"/> 2608:           QH = F(4),
<a name="2609"/> 2609:           {call, _ ,
<a name="2610"/> 2610:                 {remote, _, {atom, _, ets},{atom, _, match_spec_run}},
<a name="2611"/> 2611:                 [{string, _, [1,2,3,4,5,6]},
<a name="2612"/> 2612:                  {call, _,
<a name="2613"/> 2613:                        _compile,
<a name="2614"/> 2614:                        [{cons, _,
<a name="2615"/> 2615:                               {tuple, _,
<a name="2616"/> 2616:                                      [{atom, _,'$1'},
<a name="2617"/> 2617:                                       {cons, _,
<a name="2618"/> 2618:                                             {tuple,
<a name="2619"/> 2619:                                                  _,
<a name="2620"/> 2620:                                                 [{atom, _,'&gt;'},
<a name="2621"/> 2621:                                                  {atom, _,'$1'},
<a name="2622"/> 2622:                                                  {tuple,
<a name="2623"/> 2623:                                                       _,
<a name="2624"/> 2624:                                                      [{atom, _,const},
<a name="2625"/> 2625:                                                       {integer, _,4}]}]},
<a name="2626"/> 2626:                                             _},
<a name="2627"/> 2627:                                       {cons, _, _, _}]},
<a name="2628"/> 2628:                               {nil,_}}]}]} = i(QH, {format, abstract_code}),
<a name="2629"/> 2629:           [{5},{6}] = qlc:e(QH),
<a name="2630"/> 2630:           [{4},{5},{6}] = qlc:e(F(3))&quot;&gt;&gt;,
<a name="2631"/> 2631: 
<a name="2632"/> 2632:           &lt;&lt;&quot;Fun = fun ?MODULE:i/2,
<a name="2633"/> 2633:              L = [{#{k =&gt; #{v =&gt; Fun}}, Fun}],
<a name="2634"/> 2634:              H = qlc:q([Q || Q &lt;- L, Q =:= {#{k =&gt; #{v =&gt; Fun}}, Fun}]),
<a name="2635"/> 2635:              L = qlc:e(H),
<a name="2636"/> 2636:              {call,_,{remote,_,{atom,_,ets},{atom,_,match_spec_run}},
<a name="2637"/> 2637:                 [_,
<a name="2638"/> 2638:                  {call,_,{remote,_,{atom,_,ets},{atom,_,match_spec_compile}},[_]}]} =
<a name="2639"/> 2639:                 qlc:info(H, [{format,abstract_code}])&quot;&gt;&gt;
<a name="2640"/> 2640: 
<a name="2641"/> 2641:        ],
<a name="2642"/> 2642:     run(Config, Ts),
<a name="info-last_expr"/><a name="2643"/> 2643:     ok.
<a name="2644"/> 2644: 
<a name="2645"/> 2645: <i>%% Nested QLC expressions. QLC expressions in filter and template.</i>
<a name="nested_info-1"/><a name="2646"/> 2646: <b>nested_info</b>(Config) when is_list(Config) -&gt;
<a name="2647"/> 2647:     Ts = [
<a name="2648"/> 2648:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="2649"/> 2649:           Q = qlc:q(
<a name="2650"/> 2650:                 [{X,R} || 
<a name="2651"/> 2651:                     {X,_} &lt;- qlc_SUITE:table(L, []),
<a name="2652"/> 2652:                     begin % X imported
<a name="2653"/> 2653:                         R = qlc:e(qlc:q([{X,Y} || {Y,_}
<a name="2654"/> 2654:                                                     &lt;- qlc_SUITE:table(L, []),
<a name="2655"/> 2655:                                                   Y &gt; X])),
<a name="2656"/> 2656:                         true
<a name="2657"/> 2657:                     end]),
<a name="2658"/> 2658:           true = binary_to_list(&lt;&lt;
<a name="2659"/> 2659:             \&quot;qlc:q([{X,R}||{X,_}&lt;-qlc_SUITE:the_list([{1,a},{2,b},{3,c}]),\&quot;
<a name="2660"/> 2660:             \&quot;beginR=qlc:e(qlc:q([{X,Y}||{Y,_}&lt;-qlc_SUITE:table(L,[]),Y&gt;X]))\&quot;
<a name="2661"/> 2661:             \&quot;,trueend])\&quot;&gt;&gt;) == format_info(Q, true),
<a name="2662"/> 2662:           [{1,[{1,2},{1,3}]},{2,[{2,3}]},{3,[]}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="2663"/> 2663: 
<a name="2664"/> 2664:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="2665"/> 2665:           Q = qlc:q( % X imported
<a name="2666"/> 2666:                 [{X,qlc:e(qlc:q([{X,Y} || {Y,_} &lt;- qlc_SUITE:table(L, []),
<a name="2667"/> 2667:                                           Y &gt; X]))} || 
<a name="2668"/> 2668:                     {X,_} &lt;- qlc_SUITE:table(L, [])]),
<a name="2669"/> 2669:           true = binary_to_list(&lt;&lt;
<a name="2670"/> 2670:             \&quot;qlc:q([{X,qlc:e(qlc:q([{X,Y}||{Y,_}&lt;-qlc_SUITE:table(L,[]),\&quot;
<a name="2671"/> 2671:             \&quot;Y&gt;X]))}||{X,_}&lt;-qlc_SUITE:the_list([{1,a},{2,b},{3,c}])])\&quot;&gt;&gt;)
<a name="2672"/> 2672:               == format_info(Q, true),
<a name="2673"/> 2673:           [{1,[{1,2},{1,3}]},{2,[{2,3}]},{3,[]}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="2674"/> 2674: 
<a name="2675"/> 2675:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="2676"/> 2676:           Q = qlc:q(
<a name="2677"/> 2677:                 [{X,R} || 
<a name="2678"/> 2678:                     {X,_} &lt;- qlc_SUITE:table(L, []),
<a name="2679"/> 2679:                     begin % X imported
<a name="2680"/> 2680:                         R = qlc:e(qlc:q([{X,Y} || {Y,_} 
<a name="2681"/> 2681:                                                     &lt;- qlc_SUITE:table(L, []),
<a name="2682"/> 2682:                                                   Y =:= X])),
<a name="2683"/> 2683:                         true
<a name="2684"/> 2684:                     end]),
<a name="2685"/> 2685:           true = binary_to_list(&lt;&lt;
<a name="2686"/> 2686:             \&quot;qlc:q([{X,R}||{X,_}&lt;-qlc_SUITE:the_list([{1,a},{2,b},{3,c}]),\&quot;
<a name="2687"/> 2687:             \&quot;beginR=qlc:e(qlc:q([{X,Y}||{Y,_}&lt;-qlc_SUITE:table(L,[]),\&quot;
<a name="2688"/> 2688:             \&quot;Y=:=X])),trueend])\&quot;&gt;&gt;) == format_info(Q, true),
<a name="2689"/> 2689:           [{1,[{1,1}]},{2,[{2,2}]},{3,[{3,3}]}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="2690"/> 2690: 
<a name="2691"/> 2691:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="2692"/> 2692:           Q = qlc:q(
<a name="2693"/> 2693:                 [{X, % X imported
<a name="2694"/> 2694:                   qlc:e(qlc:q([{X,Y} || {Y,_} &lt;- qlc_SUITE:table(L, []),
<a name="2695"/> 2695:                                         Y =:= X]))} || 
<a name="2696"/> 2696:                     {X,_} &lt;- qlc_SUITE:table(L, [])]),
<a name="2697"/> 2697:           true = binary_to_list(&lt;&lt;
<a name="2698"/> 2698:             \&quot;qlc:q([{X,qlc:e(qlc:q([{X,Y}||{Y,_}&lt;-qlc_SUITE:table(L,[]),\&quot;
<a name="2699"/> 2699:             \&quot;Y=:=X]))}||{X,_}&lt;-qlc_SUITE:the_list([{1,a},{2,b},{3,c}])])\&quot;&gt;&gt;)
<a name="2700"/> 2700:              == format_info(Q, true),
<a name="2701"/> 2701:           [{1,[{1,1}]},{2,[{2,2}]},{3,[{3,3}]}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="2702"/> 2702: 
<a name="2703"/> 2703:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="2704"/> 2704:           Q = qlc:q(
<a name="2705"/> 2705:                 [{X,R} || 
<a name="2706"/> 2706:                     {X,_} &lt;- qlc_SUITE:table(L, []),
<a name="2707"/> 2707:                     begin
<a name="2708"/> 2708:                         R = qlc:e(qlc:q([Y || Y &lt;- [X]])),
<a name="2709"/> 2709:                         true
<a name="2710"/> 2710:                     end]),
<a name="2711"/> 2711:           true = binary_to_list(&lt;&lt;
<a name="2712"/> 2712:             \&quot;qlc:q([{X,R}||{X,_}&lt;-qlc_SUITE:the_list([{1,a},{2,b},{3,c}]),\&quot;
<a name="2713"/> 2713:             \&quot;beginR=qlc:e(qlc:q([Y||Y&lt;-[X]])),trueend])\&quot;&gt;&gt;)
<a name="2714"/> 2714:              == format_info(Q, true),
<a name="2715"/> 2715:           [{1,[1]},{2,[2]},{3,[3]}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="2716"/> 2716: 
<a name="2717"/> 2717:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="2718"/> 2718:           Q = qlc:q(
<a name="2719"/> 2719:                 [{X,qlc:e(qlc:q([Y || Y &lt;- [X]]))} || 
<a name="2720"/> 2720:                     {X,_} &lt;- qlc_SUITE:table(L, [])]),
<a name="2721"/> 2721:           true = binary_to_list(&lt;&lt;
<a name="2722"/> 2722:             \&quot;qlc:q([{X,qlc:e(qlc:q([Y||Y&lt;-[X]]))}||{X,_}&lt;-qlc_SUITE:\&quot;
<a name="2723"/> 2723:             \&quot;the_list([{1,a},{2,b},{3,c}])])\&quot;&gt;&gt;) == format_info(Q, true),
<a name="2724"/> 2724:           [{1,[1]},{2,[2]},{3,[3]}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="2725"/> 2725:           
<a name="2726"/> 2726:        &lt;&lt;&quot;L = [{1,a},{2,b}],
<a name="2727"/> 2727:           Q = qlc:q(
<a name="2728"/> 2728:                 [{X,Y} ||
<a name="2729"/> 2729:                     {X,_} &lt;- qlc_SUITE:table(L, []),
<a name="2730"/> 2730:                     {Y,_} &lt;- qlc:q(
<a name="2731"/> 2731:                                [{Z,V} || 
<a name="2732"/> 2732:                                    {Z,_} &lt;- qlc_SUITE:table(L, []),
<a name="2733"/> 2733:                                    {V} &lt;- qlc:q(
<a name="2734"/> 2734:                                               [{W} || W 
<a name="2735"/> 2735:                                                   &lt;- qlc_SUITE:table(L, [])])
<a name="2736"/> 2736:                                       ])
<a name="2737"/> 2737:                        ]),
<a name="2738"/> 2738:           true = binary_to_list(&lt;&lt;
<a name="2739"/> 2739:            \&quot;beginV1=qlc:q([{W}||W&lt;-qlc_SUITE:the_list([{1,a},{2,b}])]),\&quot;
<a name="2740"/> 2740:            \&quot;V2=qlc:q([{Z,V}||{Z,_}&lt;-qlc_SUITE:the_list([{1,a},{2,b}]),\&quot;
<a name="2741"/> 2741:            \&quot;{V}&lt;-V1]),qlc:q([{X,Y}||{X,_}&lt;-qlc_SUITE:the_list([{1,a},\&quot;
<a name="2742"/> 2742:            \&quot;{2,b}]),{Y,_}&lt;-V2])end\&quot;&gt;&gt;) == format_info(Q, true),
<a name="2743"/> 2743:           [{1,1},{1,1},{1,2},{1,2},{2,1},{2,1},{2,2},{2,2}] = qlc:e(Q)&quot;&gt;&gt;
<a name="2744"/> 2744: 
<a name="2745"/> 2745:        ],
<a name="2746"/> 2746:     run(Config, Ts),
<a name="nested_info-last_expr"/><a name="2747"/> 2747:     ok.
<a name="2748"/> 2748: 
<a name="2749"/> 2749: 
<a name="2750"/> 2750: <i>%% Lookup keys. Mostly test of patterns.</i>
<a name="lookup1-1"/><a name="2751"/> 2751: <b>lookup1</b>(Config) when is_list(Config) -&gt;
<a name="2752"/> 2752:     Ts = [
<a name="2753"/> 2753:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2754"/> 2754:                 Q = qlc:q([A || {A=3} &lt;- ets:table(E)]),
<a name="2755"/> 2755:                 [3] = qlc:eval(Q),
<a name="2756"/> 2756:                 [3] = lookup_keys(Q) 
<a name="2757"/> 2757:           end, [{1},{2},{3},{4}])&quot;&gt;&gt;,
<a name="2758"/> 2758: 
<a name="2759"/> 2759:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2760"/> 2760:                 Q = qlc:q([A || {A=3} &lt;- ets:table(E)],{max_lookup,0}),
<a name="2761"/> 2761:                 [3] = qlc:eval(Q),
<a name="2762"/> 2762:                 false = lookup_keys(Q) 
<a name="2763"/> 2763:           end, [{1},{2},{3},{4}])&quot;&gt;&gt;,
<a name="2764"/> 2764: 
<a name="2765"/> 2765:        &lt;&lt;&quot;%% The lookup and max_lookup options interact.
<a name="2766"/> 2766:           etsc(fun(E) -&gt;
<a name="2767"/> 2767:                 Q = qlc:q([X || {X} &lt;- ets:table(E),
<a name="2768"/> 2768:                                 (X =:= 1) or (X =:= 2)],
<a name="2769"/> 2769:                           [{lookup,true},{max_lookup,1}]),
<a name="2770"/> 2770:                 {'EXIT', {no_lookup_to_carry_out, _}} = (catch qlc:e(Q))
<a name="2771"/> 2771:          end, [{1},{2}])&quot;&gt;&gt;,
<a name="2772"/> 2772: 
<a name="2773"/> 2773:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2774"/> 2774:                 Q = qlc:q([{A,B,C,D} || {A,B}={C,D} &lt;- ets:table(E)]),
<a name="2775"/> 2775:                 [{1,2,1,2},{3,4,3,4}] = lists:sort(qlc:eval(Q)),
<a name="2776"/> 2776:                 false = lookup_keys(Q)
<a name="2777"/> 2777:           end, [{1,2},{3,4}])&quot;&gt;&gt;,
<a name="2778"/> 2778: 
<a name="2779"/> 2779:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2780"/> 2780:                 Q = qlc:q([{A,B,D} || {A,B}={D,A} &lt;- ets:table(E)]),
<a name="2781"/> 2781:                 [{1,1,1},{2,2,2}] = lists:sort(qlc:eval(Q)),
<a name="2782"/> 2782:                 false = lookup_keys(Q)
<a name="2783"/> 2783:           end, [{1,2},{2,2},{1,1}])&quot;&gt;&gt;,
<a name="2784"/> 2784: 
<a name="2785"/> 2785:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2786"/> 2786:                 Q = qlc:q([{A,B,D} || {A,B}={D,A} &lt;- ets:table(E),
<a name="2787"/> 2787:                                       (D =:= 2) or (B =:= 1)],
<a name="2788"/> 2788:                           {max_lookup,infinity}),
<a name="2789"/> 2789:                 [{1,1,1},{2,2,2}] = qlc:eval(Q),
<a name="2790"/> 2790:                 [1,2] = lookup_keys(Q)
<a name="2791"/> 2791:          end, [{1,2},{2,2},{1,1}])&quot;&gt;&gt;,
<a name="2792"/> 2792: 
<a name="2793"/> 2793:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2794"/> 2794:                 Q = qlc:q([{A,B,D} || {A,B}={D,A} &lt;- ets:table(E),
<a name="2795"/> 2795:                                       (D =:= 2) xor (B =:= 1)]),
<a name="2796"/> 2796:                 [{1,1,1},{2,2,2}] = qlc:eval(Q),
<a name="2797"/> 2797:                 [1,2] = lookup_keys(Q)
<a name="2798"/> 2798:          end, [{1,2},{2,2},{1,1}])&quot;&gt;&gt;,
<a name="2799"/> 2799: 
<a name="2800"/> 2800:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2801"/> 2801:                 Q = qlc:q([3 || {{[3,4],apa}} &lt;- ets:table(E)]),
<a name="2802"/> 2802:                 [3] = qlc:e(Q),
<a name="2803"/> 2803:                 [{[3,4],apa}] = lookup_keys(Q)
<a name="2804"/> 2804:         end, [{{[4,3],foo}},{{[3,4],apa}}])&quot;&gt;&gt;,
<a name="2805"/> 2805: 
<a name="2806"/> 2806:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2807"/> 2807:                 Q = qlc:q([3 || {3} &lt;- ets:table(E)]),
<a name="2808"/> 2808:                 [3] = qlc:e(Q),
<a name="2809"/> 2809:                 [3] = lookup_keys(Q)
<a name="2810"/> 2810:         end, [{2},{3},{4}])&quot;&gt;&gt;,
<a name="2811"/> 2811: 
<a name="2812"/> 2812:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2813"/> 2813:                 Q = qlc:q([{X,Y,Z} || {{X,_},Y,Y={_,Z},X,Y} &lt;- ets:table(E)]),
<a name="2814"/> 2814:                 [] = qlc:e(Q),
<a name="2815"/> 2815:                 false = lookup_keys(Q)
<a name="2816"/> 2816:         end, [{{1,1},1,{1,1},1,1}])&quot;&gt;&gt;,
<a name="2817"/> 2817: 
<a name="2818"/> 2818:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2819"/> 2819:                 Q = qlc:q([X || {X,X=2} &lt;- ets:table(E)]),
<a name="2820"/> 2820:                 [2] = qlc:e(Q),
<a name="2821"/> 2821:                 [2] = lookup_keys(Q)
<a name="2822"/> 2822:         end, [{2,2},{3,3}])&quot;&gt;&gt;,
<a name="2823"/> 2823: 
<a name="2824"/> 2824:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2825"/> 2825:                 Q = qlc:q([X || {{_,3}={4,_}=X} &lt;- ets:table(E)]),
<a name="2826"/> 2826:                 [{4,3}] = qlc:e(Q),
<a name="2827"/> 2827:                 [{4,3}] = lookup_keys(Q)
<a name="2828"/> 2828:         end, [{{2,3}},{{4,3}}])&quot;&gt;&gt;,
<a name="2829"/> 2829: 
<a name="2830"/> 2830:        &lt;&lt;&quot;U = 17.0,
<a name="2831"/> 2831:           etsc(fun(E) -&gt;
<a name="2832"/> 2832:                 Q = qlc:q([X || {_=X=_} &lt;- ets:table(E)]),
<a name="2833"/> 2833:                 [U] = qlc:e(Q),
<a name="2834"/> 2834:                 false = lookup_keys(Q)
<a name="2835"/> 2835:         end, [{U},{U+U,U}])&quot;&gt;&gt;,
<a name="2836"/> 2836: 
<a name="2837"/> 2837:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2838"/> 2838:                 Q = qlc:q([{X,Y,Z,W} || {X=Y}=Z={V=W} &lt;- ets:table(E), 
<a name="2839"/> 2839:                                         V == {h,g}]),
<a name="2840"/> 2840:                 [{{h,g},{h,g},{{h,g}},{h,g}}] = qlc:e(Q),
<a name="2841"/> 2841:                 [{h,g}] = lookup_keys(Q)
<a name="2842"/> 2842:         end, [{h,g},{{h,g}}])&quot;&gt;&gt;,
<a name="2843"/> 2843: 
<a name="2844"/> 2844:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2845"/> 2845:                 Q = qlc:q([{C,Y,Z,X} || {{X=Y}=Z}={{A=B}=C} &lt;- ets:table(E), 
<a name="2846"/> 2846:                                         A == a, B =/= c]),
<a name="2847"/> 2847:                 [{{a},a,{a},a}] = qlc:e(Q),
<a name="2848"/> 2848:                 [{a}] = lookup_keys(Q)
<a name="2849"/> 2849:         end, [{{1}},{{a}}])&quot;&gt;&gt;,
<a name="2850"/> 2850: 
<a name="2851"/> 2851:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2852"/> 2852:                Q = qlc:q([{A,D,Y,X} || 
<a name="2853"/> 2853:                              {{A={B=C}},{D={C}}} = {X,Y} &lt;- ets:table(E),
<a name="2854"/> 2854:                              [] == B]),
<a name="2855"/> 2855:                 [{{[]},{[]},{{[]}},{{[]}}}] = qlc:e(Q),
<a name="2856"/> 2856:                 [{{[]}}] = lookup_keys(Q)
<a name="2857"/> 2857:         end, [{{{[]}},{{[]}}}])&quot;&gt;&gt;,
<a name="2858"/> 2858: 
<a name="2859"/> 2859:        {cres,
<a name="2860"/> 2860:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2861"/> 2861:                  Q = qlc:q([X || {X}=X &lt;- ets:table(E)]),
<a name="2862"/> 2862:                  [] = qlc:e(Q),
<a name="2863"/> 2863:                  false = lookup_keys(Q)
<a name="2864"/> 2864:          end, [{1},{a}])&quot;&gt;&gt;,
<a name="2865"/> 2865:         %% {warnings,[{{2,37},qlc,nomatch_pattern}]}},
<a name="2866"/> 2866:         []},
<a name="2867"/> 2867: 
<a name="2868"/> 2868:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2869"/> 2869:                 Q = qlc:q([X || {X=X,Y=Y}={Y=Y,X=X} &lt;- ets:table(E), 
<a name="2870"/> 2870:                                 {} == X]),
<a name="2871"/> 2871:                 [{}] = qlc:e(Q),
<a name="2872"/> 2872:                 [{}] = lookup_keys(Q)
<a name="2873"/> 2873:         end, [{{},{}},{[],[]}])&quot;&gt;&gt;,
<a name="2874"/> 2874: 
<a name="2875"/> 2875:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2876"/> 2876:                 Q = qlc:q([X || {3+4=7,X} &lt;- ets:table(E), 
<a name="2877"/> 2877:                                 X =:= 3+997]),
<a name="2878"/> 2878:                 [1000] = qlc:e(Q),
<a name="2879"/> 2879:                 [7] = lookup_keys(Q)
<a name="2880"/> 2880:         end, [{7,1000},{8,1000}])&quot;&gt;&gt;,
<a name="2881"/> 2881: 
<a name="2882"/> 2882:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2883"/> 2883:                 Q = qlc:q([{X, Y} || [X]=[Y] &lt;- ets:table(E)]),
<a name="2884"/> 2884:                 [] = qlc:eval(Q),
<a name="2885"/> 2885:                 false = lookup_keys(Q)
<a name="2886"/> 2886:         end, [{a}])&quot;&gt;&gt;,
<a name="2887"/> 2887: 
<a name="2888"/> 2888:        {cres,
<a name="2889"/> 2889:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2890"/> 2890:                  Q = qlc:q([X || X={1,2,3,X,5} &lt;- ets:table(E)]),
<a name="2891"/> 2891:                  [] = qlc:e(Q),
<a name="2892"/> 2892:                  false = lookup_keys(Q)
<a name="2893"/> 2893:          end, [{a},{b}])&quot;&gt;&gt;,
<a name="2894"/> 2894:         %% {warnings,[{{2,35},qlc,nomatch_pattern}]}},
<a name="2895"/> 2895:         []},
<a name="2896"/> 2896: 
<a name="2897"/> 2897:        {cres,
<a name="2898"/> 2898:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2899"/> 2899:                  Q = qlc:q([X || X=[1,2,3,X,5] &lt;- ets:table(E)]),
<a name="2900"/> 2900:                  [] = qlc:e(Q),
<a name="2901"/> 2901:                  false = lookup_keys(Q)
<a name="2902"/> 2902:          end, [{a},{b}])&quot;&gt;&gt;,
<a name="2903"/> 2903:         %% {warnings,[{{2,35},qlc,nomatch_pattern}]}},
<a name="2904"/> 2904:         []},
<a name="2905"/> 2905: 
<a name="2906"/> 2906:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2907"/> 2907:                 Q = qlc:q([X || X = &lt;&lt;X&gt;&gt; &lt;- ets:table(E)]),
<a name="2908"/> 2908:                 [] = qlc:e(Q),
<a name="2909"/> 2909:                 false = lookup_keys(Q)
<a name="2910"/> 2910:         end, [{a},{b}])&quot;&gt;&gt;,
<a name="2911"/> 2911: 
<a name="2912"/> 2912:        &lt;&lt;&quot;Tre = 3.0,
<a name="2913"/> 2913:           etsc(fun(E) -&gt;
<a name="2914"/> 2914:                 Q = qlc:q([{A,B} || {A,B}={{a,C},{a,C}} &lt;- ets:table(E), 
<a name="2915"/> 2915:                                     C =:= Tre]),
<a name="2916"/> 2916:                 [] = qlc:e(Q),
<a name="2917"/> 2917:                 [{a,Tre}] = lookup_keys(Q)
<a name="2918"/> 2918:         end, [{a,b}])&quot;&gt;&gt;,
<a name="2919"/> 2919: 
<a name="2920"/> 2920:        &lt;&lt;&quot;A = 3,
<a name="2921"/> 2921:           etsc(fun(E) -&gt;
<a name="2922"/> 2922:                 Q = qlc:q([X || X &lt;- ets:table(E), A =:= element(1, X)]),
<a name="2923"/> 2923:                 [{3,3}] = qlc:e(Q),
<a name="2924"/> 2924:                 [3] = lookup_keys(Q)
<a name="2925"/> 2925:         end, [{1,a},{3,3}])&quot;&gt;&gt;,
<a name="2926"/> 2926: 
<a name="2927"/> 2927:        &lt;&lt;&quot;A = 3,
<a name="2928"/> 2928:           etsc(fun(E) -&gt;
<a name="2929"/> 2929:                 Q = qlc:q([X || X &lt;- ets:table(E), A =:= erlang:element(1, X)]),
<a name="2930"/> 2930:                 [{3,3}] = qlc:e(Q),
<a name="2931"/> 2931:                 [3] = lookup_keys(Q)
<a name="2932"/> 2932:         end, [{1,a},{3,3}])&quot;&gt;&gt;,
<a name="2933"/> 2933: 
<a name="2934"/> 2934:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2935"/> 2935:                 A = 3,
<a name="2936"/> 2936:                 Q = qlc:q([X || X &lt;- ets:table(E), 
<a name="2937"/> 2937:                                 A == element(1,X), 
<a name="2938"/> 2938:                                 element(1,X) =:= a]),
<a name="2939"/> 2939:                 [] = qlc:e(Q),
<a name="2940"/> 2940:                 [a] = lookup_keys(Q)
<a name="2941"/> 2941:         end, [{a},{b},{c}])&quot;&gt;&gt;,
<a name="2942"/> 2942: 
<a name="2943"/> 2943:        {cres,
<a name="2944"/> 2944:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2945"/> 2945:                  Q = qlc:q([X || {X = {[a,Z]}, 
<a name="2946"/> 2946:                                   Z = [foo, {[Y]}], 
<a name="2947"/> 2947:                                   Y = {{foo,[X]}}} &lt;- ets:table(E)]),
<a name="2948"/> 2948:                  [] = qlc:e(Q),
<a name="2949"/> 2949:                  false = lookup_keys(Q)
<a name="2950"/> 2950:          end, [{a,b,c},{d,e,f}])&quot;&gt;&gt;,
<a name="2951"/> 2951:         %% {warnings,[{{2,34},qlc,nomatch_pattern}]}}
<a name="2952"/> 2952:         []}
<a name="2953"/> 2953: 
<a name="2954"/> 2954:        ],
<a name="2955"/> 2955:     run(Config, Ts),
<a name="lookup1-last_expr"/><a name="2956"/> 2956:     ok.
<a name="2957"/> 2957: 
<a name="2958"/> 2958: <i>%% Lookup keys. Mostly test of filters.</i>
<a name="lookup2-1"/><a name="2959"/> 2959: <b>lookup2</b>(Config) when is_list(Config) -&gt;
<a name="2960"/> 2960:     Ts = [
<a name="2961"/> 2961:        &lt;&lt;&quot;%% Only guards are inspected. No lookup.
<a name="2962"/> 2962:           etsc(fun(E) -&gt;
<a name="2963"/> 2963:                  Q = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E),
<a name="2964"/> 2964:                                      ((Y = X) =:= 3)]),
<a name="2965"/> 2965:                  {'EXIT', {{badmatch,4},_}} = (catch qlc:e(Q))
<a name="2966"/> 2966:          end, [{3,3},{4,true}])&quot;&gt;&gt;,
<a name="2967"/> 2967: 
<a name="2968"/> 2968:        &lt;&lt;&quot;%% Only guards are inspected. No lookup.
<a name="2969"/> 2969:           etsc(fun(E) -&gt;
<a name="2970"/> 2970:                  Q = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E),
<a name="2971"/> 2971:                                      Y = (X =:= 3)]),
<a name="2972"/> 2972:                  {'EXIT', {{badmatch,false},_}} = (catch qlc:e(Q))
<a name="2973"/> 2973:          end, [{false,3},{true,3}])&quot;&gt;&gt;,
<a name="2974"/> 2974: 
<a name="2975"/> 2975:        &lt;&lt;&quot;%% Only guards are inspected. No lookup.
<a name="2976"/> 2976:           etsc(fun(E) -&gt;
<a name="2977"/> 2977:                  Q = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E),
<a name="2978"/> 2978:                                      Y = (X =:= 3)]),
<a name="2979"/> 2979:                  {'EXIT', {{badmatch,false},_}} = (catch qlc:e(Q))
<a name="2980"/> 2980:          end, [{3,true},{4,true}])&quot;&gt;&gt;,
<a name="2981"/> 2981: 
<a name="2982"/> 2982:        &lt;&lt;&quot;%% Only guards are inspected. No lookup.
<a name="2983"/> 2983:           E1 = ets:new(e, [ordered_set]),
<a name="2984"/> 2984:           true = ets:insert(E1, [{1,1}, {2,2}, {3,3}, {4,4}, {5,5}]),
<a name="2985"/> 2985:           E2 = ets:new(join, [ordered_set]),
<a name="2986"/> 2986:           true = ets:insert(E2, [{true,1},{false,2}]),
<a name="2987"/> 2987:           Q = qlc:q([{X,Z} || {_,X} &lt;- ets:table(E1),
<a name="2988"/> 2988:                               {Y,Z} &lt;- ets:table(E2),
<a name="2989"/> 2989:                               Y = (X =:= 3)]),
<a name="2990"/> 2990:           {'EXIT', {{badmatch,false},_}} = (catch qlc:e(Q)),
<a name="2991"/> 2991:           ets:delete(E1),
<a name="2992"/> 2992:           ets:delete(E2)&quot;&gt;&gt;,
<a name="2993"/> 2993: 
<a name="2994"/> 2994:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="2995"/> 2995:                 Q = qlc:q([{A,B,D} || {A,B}={D,A} &lt;- ets:table(E), 
<a name="2996"/> 2996:                                       (A =:= 3) or (4 =:= D)]),
<a name="2997"/> 2997:                 [{3,3,3},{4,4,4}] = lists:sort(qlc:e(Q)),
<a name="2998"/> 2998:                 [3,4] = lookup_keys(Q)
<a name="2999"/> 2999:         end, [{2,2},{3,3},{4,4}])&quot;&gt;&gt;,
<a name="3000"/> 3000: 
<a name="3001"/> 3001:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3002"/> 3002:                Q = qlc:q([X || {X,U} &lt;- ets:table(E), X =:= U]),
<a name="3003"/> 3003:                [1] = qlc:e(Q),
<a name="3004"/> 3004:                false = lookup_keys(Q)
<a name="3005"/> 3005:        end, [{1,1}])&quot;&gt;&gt;,
<a name="3006"/> 3006: 
<a name="3007"/> 3007:        {cres,
<a name="3008"/> 3008:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3009"/> 3009:                  Q = qlc:q([{X,Y} || {X=Y} &lt;- ets:table(E), 
<a name="3010"/> 3010:                                      {[X],4} =:= {[3],X}]),
<a name="3011"/> 3011:                  [] = qlc:e(Q),
<a name="3012"/> 3012:                  false = lookup_keys(Q)
<a name="3013"/> 3013:          end, [{1}, {2}])&quot;&gt;&gt;,
<a name="3014"/> 3014:         %% {warnings,[{{3,46},qlc,nomatch_filter}]}},
<a name="3015"/> 3015:         []},
<a name="3016"/> 3016: 
<a name="3017"/> 3017:        {cres,
<a name="3018"/> 3018:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3019"/> 3019:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3020"/> 3020:                                 X == 1, X =:= 2]),
<a name="3021"/> 3021:                 [] = qlc:e(Q),
<a name="3022"/> 3022:                 false = lookup_keys(Q)
<a name="3023"/> 3023:         end, [{1}, {2}])&quot;&gt;&gt;,
<a name="3024"/> 3024:         %% {warnings,[{{3,43},qlc,nomatch_filter}]}},
<a name="3025"/> 3025:         []},
<a name="3026"/> 3026: 
<a name="3027"/> 3027:        {cres,
<a name="3028"/> 3028:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3029"/> 3029:                  Q = qlc:q([{X,Y} || {X=Y} &lt;- ets:table(E), 
<a name="3030"/> 3030:                                      {[X,Y],4} =:= {[3,X],X}]),
<a name="3031"/> 3031:                  [] = qlc:e(Q),
<a name="3032"/> 3032:                  false = lookup_keys(Q)
<a name="3033"/> 3033:          end, [{1}, {2}])&quot;&gt;&gt;,
<a name="3034"/> 3034:         %% {warnings,[{{3,48},qlc,nomatch_filter}]}},
<a name="3035"/> 3035:         []},
<a name="3036"/> 3036: 
<a name="3037"/> 3037:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3038"/> 3038:                 Q = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E), 
<a name="3039"/> 3039:                                     ({X,3} =:= {Y,Y}) or (X =:= 4)]),
<a name="3040"/> 3040:                 [{3,3},{4,4}] = lists:sort(qlc:e(Q)),
<a name="3041"/> 3041:                 [3,4] = lookup_keys(Q)
<a name="3042"/> 3042:         end, [{2,2},{3,3},{4,4},{5,5}])&quot;&gt;&gt;,
<a name="3043"/> 3043: 
<a name="3044"/> 3044:        {cres,
<a name="3045"/> 3045:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3046"/> 3046:                  Q = qlc:q([X || {X} &lt;- ets:table(E), {[X]} =:= {[3,4]}]),
<a name="3047"/> 3047:                  [] = qlc:e(Q),
<a name="3048"/> 3048:                  false = lookup_keys(Q)
<a name="3049"/> 3049:          end, [{[3]},{[3,4]}])&quot;&gt;&gt;,
<a name="3050"/> 3050:         %% {warnings,[{{2,61},qlc,nomatch_filter}]}},
<a name="3051"/> 3051:         []},
<a name="3052"/> 3052: 
<a name="3053"/> 3053:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3054"/> 3054:                 U = 18, 
<a name="3055"/> 3055:                 Q = qlc:q([{X,Y} || {X=Y} &lt;- ets:table(E), [X|a] =:= [3|U]]),
<a name="3056"/> 3056:                 [] = qlc:e(Q),
<a name="3057"/> 3057:                 [3] = lookup_keys(Q)
<a name="3058"/> 3058:         end, [{2}, {3}])&quot;&gt;&gt;,
<a name="3059"/> 3059: 
<a name="3060"/> 3060:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3061"/> 3061:                 U = 18, V = 19,
<a name="3062"/> 3062:                 Q = qlc:q([{X,Y} || {X=Y} &lt;- ets:table(E), 
<a name="3063"/> 3063:                                     [X|V] =:= [3|U+1]]),
<a name="3064"/> 3064:                 [{3,3}] = qlc:e(Q),
<a name="3065"/> 3065:                 [3] = lookup_keys(Q)
<a name="3066"/> 3066:         end, [{2},{3}])&quot;&gt;&gt;,
<a name="3067"/> 3067: 
<a name="3068"/> 3068:        &lt;&lt;&quot;%% Blocks are not handled.
<a name="3069"/> 3069:           etsc(fun(E) -&gt;
<a name="3070"/> 3070:                 Q = qlc:q([X || {X} &lt;- ets:table(E), begin X == a end]),
<a name="3071"/> 3071:                 [a] = qlc:e(Q),
<a name="3072"/> 3072:                 false = lookup_keys(Q)
<a name="3073"/> 3073:         end, [{a},{b}])&quot;&gt;&gt;,
<a name="3074"/> 3074: 
<a name="3075"/> 3075:        {cres,
<a name="3076"/> 3076:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3077"/> 3077:                  Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3078"/> 3078:                                  (3 =:= X) or (X =:= 12), 
<a name="3079"/> 3079:                                  (8 =:= X) or (X =:= 10)]),
<a name="3080"/> 3080:                  [] = lists:sort(qlc:e(Q)),
<a name="3081"/> 3081:                  false = lookup_keys(Q)
<a name="3082"/> 3082:          end, [{2},{3},{4},{8}])&quot;&gt;&gt;,
<a name="3083"/> 3083:         %% {warnings,[{{4,44},qlc,nomatch_filter}]}},
<a name="3084"/> 3084:         []},
<a name="3085"/> 3085: 
<a name="3086"/> 3086:        {cres,
<a name="3087"/> 3087:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3088"/> 3088:                  Q = qlc:q([X || {X} &lt;- ets:table(E),
<a name="3089"/> 3089:                                  ((3 =:= X) or (X =:= 12)) 
<a name="3090"/> 3090:                                   and ((8 =:= X) or (X =:= 10))]),
<a name="3091"/> 3091:                  [] = lists:sort(qlc:e(Q)),
<a name="3092"/> 3092:                  false = lookup_keys(Q)
<a name="3093"/> 3093:          end, [{2},{3},{4},{8}])&quot;&gt;&gt;,
<a name="3094"/> 3094:         %% {warnings,[{{4,35},qlc,nomatch_filter}]}},
<a name="3095"/> 3095:         []},
<a name="3096"/> 3096: 
<a name="3097"/> 3097:        {cres,
<a name="3098"/> 3098:         &lt;&lt;&quot;F = fun(U) -&gt;
<a name="3099"/> 3099:                 Q = qlc:q([X || {X} &lt;- [a,b,c], 
<a name="3100"/> 3100:                                  X =:= if U -&gt; true; true -&gt; false end]),
<a name="3101"/> 3101:                 [] = qlc:eval(Q),
<a name="3102"/> 3102:                 false = lookup_keys(Q)
<a name="3103"/> 3103:               end,
<a name="3104"/> 3104:            F(apa)&quot;&gt;&gt;, [], {warnings,[{{3,43},sys_core_fold,{nomatch,guard}}]}},
<a name="3105"/> 3105: 
<a name="3106"/> 3106:        {cres,
<a name="3107"/> 3107:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3108"/> 3108:                  Q = qlc:q([X || {X=1,X} &lt;- ets:table(E), X =:= 2]),
<a name="3109"/> 3109:                  [] = qlc:e(Q),
<a name="3110"/> 3110:                  false = lookup_keys(Q)
<a name="3111"/> 3111:            end, [{1,1},{2,1}])&quot;&gt;&gt;,
<a name="3112"/> 3112:         %% {warnings,[{{2,61},qlc,nomatch_filter}]}},
<a name="3113"/> 3113:         []},
<a name="3114"/> 3114: 
<a name="3115"/> 3115:        &lt;&lt;&quot;Two = 2.0,
<a name="3116"/> 3116:           etsc(fun(E) -&gt;
<a name="3117"/> 3117:                 Q = qlc:q([X || {X} &lt;- ets:table(E), X =:= Two]),
<a name="3118"/> 3118:                 [Two] = qlc:e(Q),
<a name="3119"/> 3119:                 [Two] = lookup_keys(Q)
<a name="3120"/> 3120:         end, [{2.0},{2}])&quot;&gt;&gt;,
<a name="3121"/> 3121: 
<a name="3122"/> 3122:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3123"/> 3123:                 %% This float is equal (==) to an integer. Not a constant!
<a name="3124"/> 3124:                 Q = qlc:q([X || {X} &lt;- ets:table(E), X == {a,b,c,[2.0]}]),
<a name="3125"/> 3125:                 [_,_] = qlc:e(Q),
<a name="3126"/> 3126:                 false = lookup_keys(Q)
<a name="3127"/> 3127:         end, [{{a,b,c,[2]}},{{a,b,c,[2.0]}}])&quot;&gt;&gt;,
<a name="3128"/> 3128: 
<a name="3129"/> 3129:        &lt;&lt;&quot;%% Must _not_ regard floats as constants. Check imported variables
<a name="3130"/> 3130:           %% in runtime.
<a name="3131"/> 3131:           etsc(fun(E) -&gt; 
<a name="3132"/> 3132:                 U = 3.0,
<a name="3133"/> 3133:                 QH = qlc:q([X || {X,_} &lt;- ets:table(E), X =:= U]),
<a name="3134"/> 3134:                 [] = qlc:e(QH),
<a name="3135"/> 3135:                 [U] = lookup_keys(QH)
<a name="3136"/> 3136:         end, [{1,a},{2,b},{3,c},{4,d}])&quot;&gt;&gt;,
<a name="3137"/> 3137: 
<a name="3138"/> 3138:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3139"/> 3139:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3140"/> 3140:                                 length(X) =:= 1]),
<a name="3141"/> 3141:                 [[1]] = qlc:e(Q),
<a name="3142"/> 3142:                 false = lookup_keys(Q)
<a name="3143"/> 3143:         end, [{[1]},{[2,3]}])&quot;&gt;&gt;,
<a name="3144"/> 3144: 
<a name="3145"/> 3145:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3146"/> 3146:                 A=3, 
<a name="3147"/> 3147:                 Q = qlc:q([X || {X,Y} &lt;- ets:table(E), X =:= A, Y =:= 3]),
<a name="3148"/> 3148:                 [3] = qlc:e(Q),
<a name="3149"/> 3149:                 [3] = lookup_keys(Q)
<a name="3150"/> 3150:         end, [{3,3},{4,3}])&quot;&gt;&gt;,
<a name="3151"/> 3151: 
<a name="3152"/> 3152:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3153"/> 3153:                 A = 1,
<a name="3154"/> 3154:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3155"/> 3155:                                 X =:= 1, &lt;&lt;X&gt;&gt; =:= &lt;&lt;A&gt;&gt;]),
<a name="3156"/> 3156:                 [1] = qlc:e(Q),
<a name="3157"/> 3157:                 [1] = lookup_keys(Q)
<a name="3158"/> 3158:         end, [{1},{2}])&quot;&gt;&gt;,
<a name="3159"/> 3159: 
<a name="3160"/> 3160:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3161"/> 3161:                 Q = qlc:q([X || {X} &lt;- ets:table(E), X == a]),
<a name="3162"/> 3162:                 [a] = qlc:e(Q),
<a name="3163"/> 3163:                 [a] = lookup_keys(Q)
<a name="3164"/> 3164:         end, [{a},{b},{c}])&quot;&gt;&gt;,
<a name="3165"/> 3165: 
<a name="3166"/> 3166:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3167"/> 3167:                  Q = qlc:q([X || {X}=Y &lt;- ets:table(E), 
<a name="3168"/> 3168:                                  element(2, Y) == b, 
<a name="3169"/> 3169:                                  X =:= 1]),
<a name="3170"/> 3170:                  [] = qlc:e(Q),
<a name="3171"/> 3171:                  false = lookup_keys(Q)
<a name="3172"/> 3172:         end, [{1,b},{2,3}])&quot;&gt;&gt;,
<a name="3173"/> 3173: 
<a name="3174"/> 3174:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3175"/> 3175:                 Q = qlc:q([X || {X} &lt;- ets:table(E), element(1,{X}) =:= 1]),
<a name="3176"/> 3176:                 [1] = qlc:e(Q),
<a name="3177"/> 3177:                 [1] = lookup_keys(Q)
<a name="3178"/> 3178:         end, [{1}, {2}])&quot;&gt;&gt;,
<a name="3179"/> 3179: 
<a name="3180"/> 3180:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3181"/> 3181:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 1 =:= element(1,{X})]),
<a name="3182"/> 3182:                 [1] = qlc:e(Q),
<a name="3183"/> 3183:                 [1] = lookup_keys(Q)
<a name="3184"/> 3184:         end, [{1}, {2}])&quot;&gt;&gt;,
<a name="3185"/> 3185: 
<a name="3186"/> 3186:        {cres,
<a name="3187"/> 3187:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3188"/> 3188:                  Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3189"/> 3189:                                  X =:= {1}, 
<a name="3190"/> 3190:                                  element(1,X) =:= 2]),
<a name="3191"/> 3191:                  [] = qlc:e(Q),
<a name="3192"/> 3192:                  false = lookup_keys(Q)
<a name="3193"/> 3193:          end, [{{1}},{{2}}])&quot;&gt;&gt;,
<a name="3194"/> 3194:         %% {warnings,[{{4,47},qlc,nomatch_filter}]}},
<a name="3195"/> 3195:         []},
<a name="3196"/> 3196: 
<a name="3197"/> 3197:        {cres,
<a name="3198"/> 3198:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3199"/> 3199:                  Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3200"/> 3200:                                  X =:= {1}, 
<a name="3201"/> 3201:                                  element(1,X) =:= element(1, {2})]),
<a name="3202"/> 3202:                  [] = qlc:e(Q),
<a name="3203"/> 3203:                  false = lookup_keys(Q)
<a name="3204"/> 3204:          end, [{{1}},{{2}}])&quot;&gt;&gt;,
<a name="3205"/> 3205:         %% {warnings,[{{4,47},qlc,nomatch_filter}]}},
<a name="3206"/> 3206:         []},
<a name="3207"/> 3207: 
<a name="3208"/> 3208:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3209"/> 3209:                 Q = qlc:q([X || {X} &lt;- ets:table(E),
<a name="3210"/> 3210:                                 element(1,X) =:= 1, X =:= {1}]),
<a name="3211"/> 3211:                 [{1}] = qlc:e(Q),
<a name="3212"/> 3212:                 [{1}] = lookup_keys(Q)
<a name="3213"/> 3213:         end, [{{1}},{{2}}])&quot;&gt;&gt;,
<a name="3214"/> 3214: 
<a name="3215"/> 3215:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3216"/> 3216:                 Q = qlc:q([X || {X} &lt;- ets:table(E),
<a name="3217"/> 3217:                                 {{element(1,element(1,{{1}}))}} =:= {X}]),
<a name="3218"/> 3218:                 [{1}] = qlc:e(Q),
<a name="3219"/> 3219:                 [{1}] = lookup_keys(Q)
<a name="3220"/> 3220:         end, [{{1}},{{2}}])&quot;&gt;&gt;,
<a name="3221"/> 3221: 
<a name="3222"/> 3222:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3223"/> 3223:                 Q = qlc:q([X || X &lt;- ets:table(E),
<a name="3224"/> 3224:                                 {element(1,element(1, {{1}}))} =:= 
<a name="3225"/> 3225:                                       {element(1,X)}]),
<a name="3226"/> 3226:                 [{1}] = qlc:e(Q),
<a name="3227"/> 3227:                 [1] = lookup_keys(Q)
<a name="3228"/> 3228:         end, [{1},{2}])&quot;&gt;&gt;,
<a name="3229"/> 3229: 
<a name="3230"/> 3230:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3231"/> 3231:                 Q = qlc:q([X || {{X,Y}} &lt;- ets:table(E), 
<a name="3232"/> 3232:                                 (X =:= 1) and (Y =:= 2) 
<a name="3233"/> 3233:                                     or (X =:= 3) and (Y =:= 4)]),
<a name="3234"/> 3234:                 [1,3] = lists:sort(qlc:e(Q)),
<a name="3235"/> 3235:                 [{1,2}, {3,4}] = lookup_keys(Q)
<a name="3236"/> 3236:         end, [{{1,2}}, {{3,4}}, {{2,3}}])&quot;&gt;&gt;,
<a name="3237"/> 3237: 
<a name="3238"/> 3238:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3239"/> 3239:                 Q = qlc:q([X || {{X,a}} &lt;- ets:table(E), X =:= 3]),
<a name="3240"/> 3240:                 [3] = qlc:e(Q),
<a name="3241"/> 3241:                 [{3,a}] = lookup_keys(Q)
<a name="3242"/> 3242:         end, [{{3,a}},{{3,b}}])&quot;&gt;&gt;,
<a name="3243"/> 3243: 
<a name="3244"/> 3244:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3245"/> 3245:                 Q = qlc:q([X || {{X,Y},_Z} &lt;- ets:table(E), 
<a name="3246"/> 3246:                                 X =:= 3, Y =:= a]),
<a name="3247"/> 3247:                 [3] = qlc:e(Q),
<a name="3248"/> 3248:                 [{3,a}] = lookup_keys(Q)
<a name="3249"/> 3249:         end, [{{3,a},3}, {{4,a},3}])&quot;&gt;&gt;,
<a name="3250"/> 3250: 
<a name="3251"/> 3251:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3252"/> 3252:                 Q = qlc:q([X || {{X,Y},_Z} &lt;- ets:table(E), 
<a name="3253"/> 3253:                                 (X =:= 3) and (Y =:= a)
<a name="3254"/> 3254:                                    or (X =:= 4) and (Y =:= a)]),
<a name="3255"/> 3255:                 [3,4] = qlc:e(Q),
<a name="3256"/> 3256:                 [{3,a}, {4,a}] = lookup_keys(Q)
<a name="3257"/> 3257:         end, [{{3,a},3}, {{4,a},3}])&quot;&gt;&gt;,
<a name="3258"/> 3258: 
<a name="3259"/> 3259:        {cres, 
<a name="3260"/> 3260:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3261"/> 3261:                  Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3262"/> 3262:                                  (X =:= 3) and (X =:= a)]),
<a name="3263"/> 3263:                  [] = qlc:e(Q),
<a name="3264"/> 3264:                  false = lookup_keys(Q)
<a name="3265"/> 3265:          end, [{3}, {4}])&quot;&gt;&gt;,
<a name="3266"/> 3266:         %% {warnings,[{{3,44},qlc,nomatch_filter}]}},
<a name="3267"/> 3267:         []},
<a name="3268"/> 3268: 
<a name="3269"/> 3269:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3270"/> 3270:                 Q = qlc:q([X || {{X,Y}} &lt;- ets:table(E), 
<a name="3271"/> 3271:                                 X =:= 3, ((Y =:= a) or (Y =:= b))]),
<a name="3272"/> 3272:                 [3,3] = qlc:e(Q),
<a name="3273"/> 3273:                 [{3,a},{3,b}] = lists:sort(lookup_keys(Q))
<a name="3274"/> 3274:         end, [{{3,a}},{{2,b}},{{3,b}}])&quot;&gt;&gt;,
<a name="3275"/> 3275: 
<a name="3276"/> 3276:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3277"/> 3277:                 Q = qlc:q([X || {X,Y} &lt;- ets:table(E), 
<a name="3278"/> 3278:                                 ((X =:= 3) or (Y =:= 4))  and (X == a)]),
<a name="3279"/> 3279:                 [a] = qlc:e(Q),
<a name="3280"/> 3280:                 [a] = lookup_keys(Q)
<a name="3281"/> 3281:         end, [{a,4},{3,3}])&quot;&gt;&gt;,
<a name="3282"/> 3282: 
<a name="3283"/> 3283:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3284"/> 3284:                 Q = qlc:q([X || {X,Y} &lt;- ets:table(E), 
<a name="3285"/> 3285:                                 (X =:= 3) or ((Y =:= 4)  and (X == a))]),
<a name="3286"/> 3286:                 [3,a] = lists:sort(qlc:e(Q)),
<a name="3287"/> 3287:                 [3,a] = lookup_keys(Q)
<a name="3288"/> 3288:         end, [{a,4},{3,3}])&quot;&gt;&gt;,
<a name="3289"/> 3289: 
<a name="3290"/> 3290:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3291"/> 3291:                 Q = qlc:q([X || {{X,Y}} &lt;- ets:table(E), 
<a name="3292"/> 3292:                                 (X =:= 3) or ((Y =:= 4)  and (X == a))]),
<a name="3293"/> 3293:                 [3,a] = lists:sort(qlc:e(Q)),
<a name="3294"/> 3294:                 false = lookup_keys(Q)
<a name="3295"/> 3295:         end, [{{3,a}},{{2,b}},{{a,4}}])&quot;&gt;&gt;,
<a name="3296"/> 3296: 
<a name="3297"/> 3297:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3298"/> 3298:                 Q = qlc:q([X || {{X,Y}} &lt;- ets:table(E), 
<a name="3299"/> 3299:                                 ((X =:= 3) or (Y =:= 4))  and (X == a)]),
<a name="3300"/> 3300:                 [a] = lists:sort(qlc:e(Q)),
<a name="3301"/> 3301:                 [{a,4}] = lookup_keys(Q)
<a name="3302"/> 3302:         end, [{{3,a}},{{2,b}},{{a,4}}])&quot;&gt;&gt;,
<a name="3303"/> 3303: 
<a name="3304"/> 3304:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3305"/> 3305:                 NoAnswers = 3*3*3+2*2*2,
<a name="3306"/> 3306:                 Q = qlc:q([{X,Y,Z} || 
<a name="3307"/> 3307:                               {{X,Y,Z}} &lt;- ets:table(E), 
<a name="3308"/> 3308:                               (((X =:= 4) or (X =:= 5)) and
<a name="3309"/> 3309:                                ((Y =:= 4) or (Y =:= 5)) and
<a name="3310"/> 3310:                                ((Z =:= 4) or (Z =:= 5))) or
<a name="3311"/> 3311:                               (((X =:= 1) or (X =:= 2) or (X =:= 3)) and
<a name="3312"/> 3312:                                ((Y =:= 1) or (Y =:= 2) or (Y =:= 3)) and
<a name="3313"/> 3313:                                ((Z =:= 1) or (Z =:= 2) or (Z =:= 3)))],
<a name="3314"/> 3314:                           {max_lookup, NoAnswers}),
<a name="3315"/> 3315:                  {list, {table, _}, _} = i(Q),
<a name="3316"/> 3316:                  [{1,1,1},{2,2,2},{3,3,3}] = lists:sort(qlc:e(Q)),
<a name="3317"/> 3317:                  true = NoAnswers =:= length(lookup_keys(Q))
<a name="3318"/> 3318:          end, [{{1,1,1}},{{2,2,2}},{{3,3,3}},{{3,3,4}},{{4,1,1}}])&quot;&gt;&gt;,
<a name="3319"/> 3319: 
<a name="3320"/> 3320:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3321"/> 3321:                 Q = qlc:q([{X,Y,Z} || 
<a name="3322"/> 3322:                               {{X,Y,Z}} &lt;- ets:table(E), 
<a name="3323"/> 3323:                               (((X =:= 4) or (X =:= 5)) and
<a name="3324"/> 3324:                                ((Y =:= 4) or (Y =:= 5)) and
<a name="3325"/> 3325:                                ((Z =:= 4) or (Z =:= 5))) or
<a name="3326"/> 3326:                               (((X =:= 1) or (X =:= 2) or (X =:= 3)) and
<a name="3327"/> 3327:                                ((Y =:= 1) or (Y =:= 2) or (Y =:= 3)) and
<a name="3328"/> 3328:                                ((Z =:= 1) or (Z =:= 2) or (Z =:= 3)))],
<a name="3329"/> 3329:                           {max_lookup, 10}),
<a name="3330"/> 3330:                  [{1,1,1},{2,2,2},{3,3,3}] = lists:sort(qlc:e(Q)),
<a name="3331"/> 3331:                  {table,{ets,table,[_,[{traverse,{select,_}}]]}} = i(Q)
<a name="3332"/> 3332:          end, [{{1,1,1}},{{2,2,2}},{{3,3,3}},{{3,3,4}},{{4,1,1}}])&quot;&gt;&gt;,
<a name="3333"/> 3333: 
<a name="3334"/> 3334:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3335"/> 3335:                 Q = qlc:q([X || X={_,_,_} &lt;- ets:table(E), 
<a name="3336"/> 3336:                                 element(1, X) =:= 3, element(2, X) == a]),
<a name="3337"/> 3337:                 [{3,a,s}] = qlc:e(Q),
<a name="3338"/> 3338:                 [3] = lookup_keys(Q)
<a name="3339"/> 3339:         end, [{1,c,q},{2,b,r},{3,a,s}])&quot;&gt;&gt;,
<a name="3340"/> 3340: 
<a name="3341"/> 3341:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3342"/> 3342:                 Q = qlc:q([X || X &lt;- ets:table(E), 
<a name="3343"/> 3343:                                 element(0, X) =:= 3]),
<a name="3344"/> 3344:                 [] = qlc:e(Q),
<a name="3345"/> 3345:                 false = lookup_keys(Q)
<a name="3346"/> 3346:         end, [{1},{2}])&quot;&gt;&gt;,
<a name="3347"/> 3347: 
<a name="3348"/> 3348:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3349"/> 3349:                 F = fun(_) -&gt; 3 end, 
<a name="3350"/> 3350:                 %% No occurs check; X =:= F(X) is ignored.
<a name="3351"/> 3351:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3352"/> 3352:                                 X =:= 3, X =:= F(X)]),
<a name="3353"/> 3353:                 {qlc,_,[{generate,_,{list,{table,_},_}},_],[]} = i(Q),
<a name="3354"/> 3354:                 [3] = lists:sort(qlc:e(Q)),
<a name="3355"/> 3355:                 [3] = lookup_keys(Q)
<a name="3356"/> 3356:         end, [{2},{3},{4}])&quot;&gt;&gt;,
<a name="3357"/> 3357: 
<a name="3358"/> 3358:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3359"/> 3359:                 A = a, B = a,
<a name="3360"/> 3360:                 Q = qlc:q([X || {{X,Y}} &lt;- ets:table(E), 
<a name="3361"/> 3361:                                 ((X =:= A) and (Y =:= B))
<a name="3362"/> 3362:                                  or ((X =:= B) and (Y =:= A))]),
<a name="3363"/> 3363:                 [a] = qlc:e(Q),
<a name="3364"/> 3364:                 %% keys are usorted, duplicate removed:
<a name="3365"/> 3365:                 [{a,a}] = lookup_keys(Q) 
<a name="3366"/> 3366:         end, [{{a,a}},{{b,b}}])&quot;&gt;&gt;,
<a name="3367"/> 3367: 
<a name="3368"/> 3368:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3369"/> 3369:                 A = a, B = b,
<a name="3370"/> 3370:                 Q = qlc:q([X || {{X,Y}} &lt;- ets:table(E), 
<a name="3371"/> 3371:                                 ((X =:= A) and (Y =:= B))
<a name="3372"/> 3372:                                  or ((X =:= B) and (Y =:= A))]),
<a name="3373"/> 3373:                 [a,b] = lists:sort(qlc:e(Q)),
<a name="3374"/> 3374:                 [{a,b},{b,a}] = lookup_keys(Q)
<a name="3375"/> 3375:         end, [{{a,b}},{{b,a}},{{c,a}},{{d,b}}])&quot;&gt;&gt;,
<a name="3376"/> 3376: 
<a name="3377"/> 3377:        %% The atom 'fail' is recognized - lookup.
<a name="3378"/> 3378:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3379"/> 3379:                 Q = qlc:q([A || {A} &lt;- ets:table(E), 
<a name="3380"/> 3380:                                 (A =:= 2) 
<a name="3381"/> 3381:                                     orelse fail
<a name="3382"/> 3382:                                    ]),
<a name="3383"/> 3383:                 [2] = lists:sort(qlc:e(Q)),
<a name="3384"/> 3384:                 [2] = lookup_keys(Q)
<a name="3385"/> 3385:            end, [{1},{2}])&quot;&gt;&gt;
<a name="3386"/> 3386: 
<a name="3387"/> 3387:        ],
<a name="3388"/> 3388: 
<a name="3389"/> 3389:     ok = run(Config, Ts),
<a name="3390"/> 3390: 
<a name="3391"/> 3391:     TsR = [
<a name="3392"/> 3392:        %% is_record/2,3:
<a name="3393"/> 3393:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3394"/> 3394:                 Q = qlc:q([element(1, X) || X &lt;- ets:table(E), 
<a name="3395"/> 3395:                                             erlang:is_record(X, r, 2)]),
<a name="3396"/> 3396:                  [r] = qlc:e(Q),
<a name="3397"/> 3397:                  [r] = lookup_keys(Q)
<a name="3398"/> 3398:          end, [{keypos,1}], [#r{}])&quot;&gt;&gt;,
<a name="3399"/> 3399:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3400"/> 3400:                 Q = qlc:q([element(1, X) || X &lt;- ets:table(E), 
<a name="3401"/> 3401:                                             is_record(X, r, 2)]),
<a name="3402"/> 3402:                  [r] = qlc:e(Q),
<a name="3403"/> 3403:                  [r] = lookup_keys(Q)
<a name="3404"/> 3404:          end, [{keypos,1}], [#r{}])&quot;&gt;&gt;,
<a name="3405"/> 3405:        {cres,
<a name="3406"/> 3406:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3407"/> 3407:                 Q = qlc:q([element(1, X) || X &lt;- ets:table(E), 
<a name="3408"/> 3408:                                             record(X, r)]),
<a name="3409"/> 3409:                  [r] = qlc:e(Q),
<a name="3410"/> 3410:                  [r] = lookup_keys(Q)
<a name="3411"/> 3411:          end, [{keypos,1}], [#r{}])&quot;&gt;&gt;,
<a name="3412"/> 3412:         {warnings,[{{4,45},erl_lint,{obsolete_guard,{record,2}}}]}},
<a name="3413"/> 3413:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3414"/> 3414:                 Q = qlc:q([element(1, X) || X &lt;- ets:table(E), 
<a name="3415"/> 3415:                                             erlang:is_record(X, r)]),
<a name="3416"/> 3416:                  [r] = qlc:e(Q),
<a name="3417"/> 3417:                  [r] = lookup_keys(Q)
<a name="3418"/> 3418:          end, [{keypos,1}], [#r{}])&quot;&gt;&gt;,
<a name="3419"/> 3419:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3420"/> 3420:                 Q = qlc:q([element(1, X) || X &lt;- ets:table(E), 
<a name="3421"/> 3421:                                             is_record(X, r)]),
<a name="3422"/> 3422:                  [r] = qlc:e(Q),
<a name="3423"/> 3423:                  [r] = lookup_keys(Q)
<a name="3424"/> 3424:          end, [{keypos,1}], [#r{}])&quot;&gt;&gt;
<a name="3425"/> 3425: 
<a name="3426"/> 3426:        ],
<a name="3427"/> 3427: 
<a name="3428"/> 3428:     ok = run(Config, &lt;&lt;&quot;-record(r, {a}).\n&quot;&gt;&gt;, TsR),
<a name="3429"/> 3429: 
<a name="3430"/> 3430:     Ts2 = [
<a name="3431"/> 3431:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3432"/> 3432:                  Q0 = qlc:q([X || 
<a name="3433"/> 3433:                                 X &lt;- ets:table(E),
<a name="3434"/> 3434:                                 (element(1, X) =:= 1) or 
<a name="3435"/> 3435:                                   (element(1, X) =:= 2)],
<a name="3436"/> 3436:                            {cache,ets}),
<a name="3437"/> 3437:                  Q = qlc:q([{X,Y} ||
<a name="3438"/> 3438:                                X &lt;- [1,2],
<a name="3439"/> 3439:                                Y &lt;- Q0]),
<a name="3440"/> 3440:                  {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3441"/> 3441:                          {generate,_,{table,_}}], []} = i(Q),
<a name="3442"/> 3442:                  [{1,{1}},{1,{2}},{2,{1}},{2,{2}}] = lists:sort(qlc:e(Q)),
<a name="3443"/> 3443:                  [1,2] = lookup_keys(Q) 
<a name="3444"/> 3444:           end, [{keypos,1}], [{1},{2}])&quot;&gt;&gt;,
<a name="3445"/> 3445: 
<a name="3446"/> 3446:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3447"/> 3447:                  Q0 = qlc:q([X || 
<a name="3448"/> 3448:                                 X &lt;- ets:table(E),
<a name="3449"/> 3449:                                 (element(1, X) =:= 1) or 
<a name="3450"/> 3450:                                   (element(1, X) =:= 2)]),
<a name="3451"/> 3451:                  Q = qlc:q([{X,Y} ||
<a name="3452"/> 3452:                                X &lt;- [1,2],
<a name="3453"/> 3453:                                Y &lt;- Q0],
<a name="3454"/> 3454:                            {cache,true}),
<a name="3455"/> 3455:                  {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3456"/> 3456:                          {generate,_,{table,_}}],[]} = i(Q),
<a name="3457"/> 3457:                  [1,2] = lookup_keys(Q) 
<a name="3458"/> 3458:           end, [{keypos,1}], [{1},{2}])&quot;&gt;&gt;,
<a name="3459"/> 3459: 
<a name="3460"/> 3460:        %% One introduced QLC expression (join, ms), and the cache option.
<a name="3461"/> 3461:        &lt;&lt;&quot;%% Match spec and lookup. The lookup is done twice, which might
<a name="3462"/> 3462:           %% be confusing...
<a name="3463"/> 3463:           etsc(fun(E) -&gt;
<a name="3464"/> 3464:                        Q = qlc:q([{X,Y} ||
<a name="3465"/> 3465:                                      X &lt;- [1,2],
<a name="3466"/> 3466:                                      {Y} &lt;- ets:table(E),
<a name="3467"/> 3467:                                      (Y =:= 1) or (Y =:= 2)],
<a name="3468"/> 3468:                                  []),
<a name="3469"/> 3469:                        [{1,1},{1,2},{2,1},{2,2}] = qlc:e(Q),
<a name="3470"/> 3470:                        {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3471"/> 3471:                                {generate,_,{list,{table,_},_}}],[]} = i(Q),
<a name="3472"/> 3472:                        [1,2] = lookup_keys(Q)
<a name="3473"/> 3473:                end, [{keypos,1}], [{1},{2},{3}])&quot;&gt;&gt;,
<a name="3474"/> 3474:        &lt;&lt;&quot;%% The same as last example, but with cache. 
<a name="3475"/> 3475:           %% No cache needed (always one lookup only).
<a name="3476"/> 3476:           etsc(fun(E) -&gt;
<a name="3477"/> 3477:                        Q = qlc:q([{X,Y} ||
<a name="3478"/> 3478:                                      X &lt;- [1,2],
<a name="3479"/> 3479:                                      {Y} &lt;- ets:table(E),
<a name="3480"/> 3480:                                      (Y =:= 1) or (Y =:= 2)],
<a name="3481"/> 3481:                                  [cache]),
<a name="3482"/> 3482:                        [{1,1},{1,2},{2,1},{2,2}] = qlc:e(Q),
<a name="3483"/> 3483:                        {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3484"/> 3484:                                {generate,_,{list,{table,_},_}}],[]} = i(Q),
<a name="3485"/> 3485:                        [1,2] = lookup_keys(Q)
<a name="3486"/> 3486:                end, [{keypos,1}], [{1},{2},{3}])&quot;&gt;&gt;,
<a name="3487"/> 3487: 
<a name="3488"/> 3488:        &lt;&lt;&quot;%% And again, this time only lookup, no mach spec.
<a name="3489"/> 3489:           etsc(fun(E) -&gt;
<a name="3490"/> 3490:                        Q = qlc:q([{X,Y} ||
<a name="3491"/> 3491:                                      X &lt;- [1,2],
<a name="3492"/> 3492:                                      Y &lt;- ets:table(E),
<a name="3493"/> 3493:                                      (element(1, Y) =:= 1) 
<a name="3494"/> 3494:                                       or (element(1, Y) =:= 2)],
<a name="3495"/> 3495:                                  []),
<a name="3496"/> 3496:                        [{1,{1}},{1,{2}},{2,{1}},{2,{2}}] = qlc:e(Q),
<a name="3497"/> 3497:                        {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3498"/> 3498:                                {generate,_,{table,_}}],[]} = i(Q),
<a name="3499"/> 3499:                        [1,2] = lookup_keys(Q)
<a name="3500"/> 3500:                end, [{keypos,1}], [{1},{2},{3}])&quot;&gt;&gt;,
<a name="3501"/> 3501:        &lt;&lt;&quot;%% As last one, but with cache.
<a name="3502"/> 3502:           %% No cache needed (always one lookup only).
<a name="3503"/> 3503:           etsc(fun(E) -&gt;
<a name="3504"/> 3504:                        Q = qlc:q([{X,Y} ||
<a name="3505"/> 3505:                                      X &lt;- [1,2],
<a name="3506"/> 3506:                                      Y &lt;- ets:table(E),
<a name="3507"/> 3507:                                      (element(1, Y) =:= 1) 
<a name="3508"/> 3508:                                       or (element(1, Y) =:= 2)],
<a name="3509"/> 3509:                                  [cache]),
<a name="3510"/> 3510:                        {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3511"/> 3511:                                {generate,_,{table,_}}],[]} = i(Q),
<a name="3512"/> 3512:                        [{1,{1}},{1,{2}},{2,{1}},{2,{2}}] = qlc:e(Q),
<a name="3513"/> 3513:                        [1,2] = lookup_keys(Q)
<a name="3514"/> 3514:                end, [{keypos,1}], [{1},{2},{3}])&quot;&gt;&gt;,
<a name="3515"/> 3515: 
<a name="3516"/> 3516:        &lt;&lt;&quot;%% Lookup only. No cache.
<a name="3517"/> 3517:           etsc(fun(E) -&gt;
<a name="3518"/> 3518:                        Q = qlc:q([{X,Y} ||
<a name="3519"/> 3519:                                      X &lt;- [1,2],
<a name="3520"/> 3520:                                      {Y=2} &lt;- ets:table(E)],
<a name="3521"/> 3521:                                  []),
<a name="3522"/> 3522:                        {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3523"/> 3523:                                {generate,_,{table,_}}],[]} = i(Q),
<a name="3524"/> 3524:                        [{1,2},{2,2}] = qlc:e(Q),
<a name="3525"/> 3525:                        [2] = lookup_keys(Q)
<a name="3526"/> 3526:                end, [{keypos,1}], [{1},{2},{3}])&quot;&gt;&gt;,
<a name="3527"/> 3527:        &lt;&lt;&quot;%% Lookup only. No cache.
<a name="3528"/> 3528:           etsc(fun(E) -&gt;
<a name="3529"/> 3529:                        Q = qlc:q([{X,Y} ||
<a name="3530"/> 3530:                                      X &lt;- [1,2],
<a name="3531"/> 3531:                                      {Y=2} &lt;- ets:table(E)],
<a name="3532"/> 3532:                                  [cache]),
<a name="3533"/> 3533:                        {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3534"/> 3534:                                {generate,_,{table,_}}],[]} = i(Q),
<a name="3535"/> 3535:                        [{1,2},{2,2}] = qlc:e(Q),
<a name="3536"/> 3536:                        [2] = lookup_keys(Q)
<a name="3537"/> 3537:                end, [{keypos,1}], [{1},{2},{3}])&quot;&gt;&gt;,
<a name="3538"/> 3538:        &lt;&lt;&quot;%% Matchspec only. No cache.
<a name="3539"/> 3539:           etsc(fun(E) -&gt;
<a name="3540"/> 3540:                        Q = qlc:q([{X,Y} ||
<a name="3541"/> 3541:                                      X &lt;- [1,2],
<a name="3542"/> 3542:                                      {Y} &lt;- ets:table(E),
<a name="3543"/> 3543:                                      Y &gt; 1],
<a name="3544"/> 3544:                                  []),
<a name="3545"/> 3545:                        {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3546"/> 3546:                                {generate,_,
<a name="3547"/> 3547:                                 {table,{ets,_,[_,[{traverse,_}]]}}}],[]} = 
<a name="3548"/> 3548:                                        i(Q),
<a name="3549"/> 3549:                        [{1,2},{1,3},{2,2},{2,3}] = lists:sort(qlc:e(Q)),
<a name="3550"/> 3550:                        false = lookup_keys(Q)
<a name="3551"/> 3551:                end, [{keypos,1}], [{1},{2},{3}])&quot;&gt;&gt;,
<a name="3552"/> 3552:        &lt;&lt;&quot;%% Matchspec only. Cache
<a name="3553"/> 3553:           etsc(fun(E) -&gt;
<a name="3554"/> 3554:                        Q = qlc:q([{X,Y} ||
<a name="3555"/> 3555:                                      X &lt;- [1,2],
<a name="3556"/> 3556:                                      {Y} &lt;- ets:table(E),
<a name="3557"/> 3557:                                      Y &gt; 1],
<a name="3558"/> 3558:                                  [cache]),
<a name="3559"/> 3559:                        {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3560"/> 3560:                             {generate,_,{qlc,_,
<a name="3561"/> 3561:                            [{generate,_,{table,{ets,_,[_,[{traverse,_}]]}}}],
<a name="3562"/> 3562:                           [{cache,ets}]}}],[]} = i(Q),
<a name="3563"/> 3563:                        [{1,2},{1,3},{2,2},{2,3}] = lists:sort(qlc:e(Q)),
<a name="3564"/> 3564:                        false = lookup_keys(Q)
<a name="3565"/> 3565:                end, [{keypos,1}], [{1},{2},{3}])&quot;&gt;&gt;,
<a name="3566"/> 3566:        &lt;&lt;&quot;%% An empty list. Always unique and cached.
<a name="3567"/> 3567:           Q = qlc:q([X || {X} &lt;- [], X =:= 1, begin X &gt; 0 end],
<a name="3568"/> 3568:                    [{cache,true},{unique,true}]),
<a name="3569"/> 3569:           {qlc,_,[{generate,_,{list,[]}},_],[{unique,true}]} = i(Q),
<a name="3570"/> 3570:           _ = qlc:info(Q),
<a name="3571"/> 3571:           [] = qlc:e(Q)&quot;&gt;&gt;,
<a name="3572"/> 3572:        &lt;&lt;&quot;%% A list is always cached.
<a name="3573"/> 3573:           Q = qlc:q([{X,Y} || Y &lt;- [1,2], X &lt;- [2,1,2]],
<a name="3574"/> 3574:                     [cache]),
<a name="3575"/> 3575:           {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3576"/> 3576:                   {generate,_,{list,[2,1,2]}}],[]} = i(Q),
<a name="3577"/> 3577:           [{2,1},{1,1},{2,1},{2,2},{1,2},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="3578"/> 3578:        &lt;&lt;&quot;%% But a processed list is never cached.
<a name="3579"/> 3579:           Q = qlc:q([{X,Y} || Y &lt;- [1,2], X &lt;- [2,1,2], X &gt; 1],
<a name="3580"/> 3580:                     [cache]),
<a name="3581"/> 3581:           {qlc,_,[{generate,_, {list,[1,2]}},
<a name="3582"/> 3582:                   {generate,_,{qlc,_,
<a name="3583"/> 3583:                                [{generate,_,{list,{list,[2,1,2]},_}}],
<a name="3584"/> 3584:                                [{cache,ets}]}}],[]} = i(Q),
<a name="3585"/> 3585:           [{2,1},{2,1},{2,2},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="3586"/> 3586:        &lt;&lt;&quot;%% A bug fixed in R11B-2: coalescing simple_qlc:s works now.
<a name="3587"/> 3587:           Q0 = qlc:q([X || {X} &lt;- [{1},{2},{3}]],  {cache, ets}),
<a name="3588"/> 3588:           Q1 = qlc:q([X || X &lt;- Q0], {cache, list}),
<a name="3589"/> 3589:           Q = qlc:q([{Y,X} || Y &lt;- [1,2], X &lt;- Q1, X &lt; 2], {cache, list}),
<a name="3590"/> 3590:           {qlc,_,[{generate,_,{list,_}},
<a name="3591"/> 3591:                   {generate,_,{qlc,_,[{generate,_,{list,{list,_},_}}],
<a name="3592"/> 3592:                                [{cache,ets}]}},_],[]} = i(Q),
<a name="3593"/> 3593:           [{1,1},{2,1}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="3594"/> 3594:        &lt;&lt;&quot;Q = qlc:q([{X,Y} || Y &lt;- [1,2], X &lt;- [1,2], X &gt; 1],
<a name="3595"/> 3595:                     [cache,unique]),
<a name="3596"/> 3596:           {qlc,_,[{generate,_,{list,[1,2]}},
<a name="3597"/> 3597:                   {generate,_,{qlc,_,
<a name="3598"/> 3598:                                [{generate,_,{list,{list,[1,2]},_}}],
<a name="3599"/> 3599:                                [{cache,ets},{unique,true}]}}],
<a name="3600"/> 3600:            [{unique,true}]} = i(Q),
<a name="3601"/> 3601:           [{2,1},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="3602"/> 3602:        &lt;&lt;&quot;L = [1,2,3],
<a name="3603"/> 3603:           QH1 = qlc:q([{X} || X &lt;- L, X &gt; 1]),
<a name="3604"/> 3604:           QH2 = qlc:q([{X} || X &lt;- QH1, X &gt; 0], [cache]),
<a name="3605"/> 3605:           [{{2}},{{3}}] = qlc:e(QH2),
<a name="3606"/> 3606:           {list,{list,{list,L},_},_} = i(QH2)&quot;&gt;&gt;,
<a name="3607"/> 3607:        &lt;&lt;&quot;L = [1,2,3,1,2,3],
<a name="3608"/> 3608:           QH1 = qlc:q([{X} || X &lt;- L, X &gt; 1]),
<a name="3609"/> 3609:           QH2 = qlc:q([{X} || X &lt;- QH1, X &gt; 0], [cache,unique]),
<a name="3610"/> 3610:           [{{2}},{{3}}] = qlc:e(QH2),
<a name="3611"/> 3611:           {qlc,_,[{generate,_,{list,{list,{list,L},_},_}}],
<a name="3612"/> 3612:            [{unique,true}]} = i(QH2)&quot;&gt;&gt;
<a name="3613"/> 3613: 
<a name="3614"/> 3614:       ],
<a name="3615"/> 3615: 
<a name="3616"/> 3616:     ok = run(Config, Ts2),
<a name="3617"/> 3617: 
<a name="3618"/> 3618:     LTs = [
<a name="3619"/> 3619:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3620"/> 3620:                        Q  = qlc:q([X || X &lt;- ets:table(E), 
<a name="3621"/> 3621:                                         element(1, X) =:= 1],
<a name="3622"/> 3622:                                   {lookup,true}),
<a name="3623"/> 3623:                        {table,L} = i(Q),
<a name="3624"/> 3624:                        true = is_list(L),
<a name="3625"/> 3625:                        [{1,a}] = qlc:e(Q),
<a name="3626"/> 3626:                        [1] = lookup_keys(Q)
<a name="3627"/> 3627:                end, [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="3628"/> 3628:        &lt;&lt;&quot;%% No lookup, use the match spec for traversal instead.
<a name="3629"/> 3629:           etsc(fun(E) -&gt;
<a name="3630"/> 3630:                        Q  = qlc:q([X || X &lt;- ets:table(E), 
<a name="3631"/> 3631:                                         element(1, X) =:= 1],
<a name="3632"/> 3632:                                   {lookup,false}),
<a name="3633"/> 3633:                        {table,{ets,table,_}} = i(Q),
<a name="3634"/> 3634:                        [{1,a}] = qlc:e(Q),
<a name="3635"/> 3635:                        false = lookup_keys(Q)
<a name="3636"/> 3636:                end, [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="3637"/> 3637:        &lt;&lt;&quot;%% As last one. {max_lookup,0} has the same effect.
<a name="3638"/> 3638:           etsc(fun(E) -&gt;
<a name="3639"/> 3639:                        Q  = qlc:q([X || X &lt;- ets:table(E), 
<a name="3640"/> 3640:                                         element(1, X) =:= 1],
<a name="3641"/> 3641:                                   {max_lookup,0}),
<a name="3642"/> 3642:                        {table,{ets,table,_}} = i(Q),
<a name="3643"/> 3643:                        [{1,a}] = qlc:e(Q),
<a name="3644"/> 3644:                        false = lookup_keys(Q)
<a name="3645"/> 3645:                end, [{1,a},{2,b}])&quot;&gt;&gt;
<a name="3646"/> 3646: 
<a name="3647"/> 3647:        ],
<a name="3648"/> 3648: 
<a name="3649"/> 3649:     ok = run(Config, LTs),
<a name="3650"/> 3650: 
<a name="lookup2-last_expr"/><a name="3651"/> 3651:     ok.
<a name="3652"/> 3652: 
<a name="3653"/> 3653: <i>%% Lookup keys. With records.</i>
<a name="lookup_rec-1"/><a name="3654"/> 3654: <b>lookup_rec</b>(Config) when is_list(Config) -&gt;
<a name="3655"/> 3655:     Ts = [
<a name="3656"/> 3656:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3657"/> 3657:                 Q = qlc:q([A || #r{a = A} &lt;- ets:table(E), 
<a name="3658"/> 3658:                                 (A =:= 3) or (4 =:= A)]),
<a name="3659"/> 3659:                 [3] = qlc:e(Q),
<a name="3660"/> 3660:                 [3,4] = lookup_keys(Q)
<a name="3661"/> 3661:             end, [{keypos,2}], [#r{a = a}, #r{a = 3}, #r{a = 5}])&quot;&gt;&gt;,
<a name="3662"/> 3662: 
<a name="3663"/> 3663:        {cres, 
<a name="3664"/> 3664:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3665"/> 3665:                  Q = qlc:q([A || #r{a = 17 = A} &lt;- ets:table(E),
<a name="3666"/> 3666:                                  (A =:= 3) or (4 =:= A)]),
<a name="3667"/> 3667:                  [] = qlc:e(Q),
<a name="3668"/> 3668:                  false = lookup_keys(Q)
<a name="3669"/> 3669:              end, [{keypos,2}], [#r{a = 17}, #r{a = 3}, #r{a = 5}])&quot;&gt;&gt;,
<a name="3670"/> 3670:         %% {warnings,[{{4,44},qlc,nomatch_filter}]}},
<a name="3671"/> 3671:         []},
<a name="3672"/> 3672: 
<a name="3673"/> 3673:       &lt;&lt;&quot;%% Compares an integer and a float.
<a name="3674"/> 3674:          etsc(fun(E) -&gt;
<a name="3675"/> 3675:                 Q = qlc:q([A || #r{a = 17 = A} &lt;- ets:table(E),
<a name="3676"/> 3676:                                 (A == 17) or (17.0 == A)]),
<a name="3677"/> 3677:                 [_] = qlc:e(Q),
<a name="3678"/> 3678:                 [_] = lookup_keys(Q)
<a name="3679"/> 3679:             end, [{keypos,2}], [#r{a = 17}, #r{a = 3}, #r{a = 5}])&quot;&gt;&gt;,
<a name="3680"/> 3680: 
<a name="3681"/> 3681:       &lt;&lt;&quot;%% Compares an integer and a float.
<a name="3682"/> 3682:          %% There is a test in qlc_pt.erl (Op =:= '=:=', C1 =:= C2), but
<a name="3683"/> 3683:          %% that case is handled in an earlier clause (unify ... E, E).
<a name="3684"/> 3684:          etsc(fun(E) -&gt;
<a name="3685"/> 3685:                 Q = qlc:q([A || #r{a = 17.0 = A} &lt;- ets:table(E),
<a name="3686"/> 3686:                                 (A =:= 17) or (17.0 =:= A)]),
<a name="3687"/> 3687:                 [_] = qlc:e(Q),
<a name="3688"/> 3688:                 [_] = lookup_keys(Q)
<a name="3689"/> 3689:             end, [{keypos,2}], [#r{a = 17.0}, #r{a = 3}, #r{a = 5}])&quot;&gt;&gt;,
<a name="3690"/> 3690: 
<a name="3691"/> 3691:       &lt;&lt;&quot;%% Matches an integer and a float.
<a name="3692"/> 3692:          etsc(fun(E) -&gt;
<a name="3693"/> 3693:                 Q = qlc:q([A || #r{a = 17 = A} &lt;- ets:table(E),
<a name="3694"/> 3694:                                 (A =:= 17) or (17.0 =:= A)]),
<a name="3695"/> 3695:                 [_] = qlc:e(Q),
<a name="3696"/> 3696:                 [_] = lookup_keys(Q)
<a name="3697"/> 3697:             end, [{keypos,2}], [#r{a = 17}, #r{a = 3}, #r{a = 5}])&quot;&gt;&gt;,
<a name="3698"/> 3698: 
<a name="3699"/> 3699:       &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3700"/> 3700:                 F = fun(_) -&gt; 17 end,
<a name="3701"/> 3701:                 Q = qlc:q([A || #r{a = A} &lt;- ets:table(E),
<a name="3702"/> 3702:                                 (F(A) =:= 3) and (A =:= 4)]),
<a name="3703"/> 3703:                 [] = qlc:e(Q),
<a name="3704"/> 3704:                 false = lookup_keys(Q) % F(A) could fail
<a name="3705"/> 3705:             end, [{keypos,2}], [#r{a = 4}, #r{a = 3}, #r{a = 5}])&quot;&gt;&gt;,
<a name="3706"/> 3706: 
<a name="3707"/> 3707:       &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3708"/> 3708:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3709"/> 3709:                                 #r{} == X]),
<a name="3710"/> 3710:                 [#r{}] = lists:sort(qlc:e(Q)),
<a name="3711"/> 3711:                 {call,_,_,[_,_]} = i(Q, {format, abstract_code}),
<a name="3712"/> 3712:                 [#r{}] = lookup_keys(Q)
<a name="3713"/> 3713:         end, [{#r{}},{#r{a=foo}}])&quot;&gt;&gt;,
<a name="3714"/> 3714: 
<a name="3715"/> 3715:       &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3716"/> 3716:                 Q = qlc:q([R#r.a || R &lt;- ets:table(E), R#r.a =:= foo]),
<a name="3717"/> 3717:                 [foo] = qlc:e(Q),
<a name="3718"/> 3718:                 [_] = lookup_keys(Q)
<a name="3719"/> 3719:         end, [{keypos,2}], [#r{a=foo}])&quot;&gt;&gt;
<a name="3720"/> 3720:        ],
<a name="3721"/> 3721:     run(Config, &lt;&lt;&quot;-record(r, {a}).\n&quot;&gt;&gt;, Ts),
<a name="lookup_rec-last_expr"/><a name="3722"/> 3722:     ok.
<a name="3723"/> 3723: 
<a name="3724"/> 3724: <i>%% Using indices for lookup.</i>
<a name="indices-1"/><a name="3725"/> 3725: <b>indices</b>(Config) when is_list(Config) -&gt;
<a name="3726"/> 3726:     Ts = [
<a name="3727"/> 3727:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="3728"/> 3728:           QH = qlc:q([element(1, X) || X &lt;- qlc_SUITE:table(L, [2]),
<a name="3729"/> 3729:                                        (element(2, X) =:= a)
<a name="3730"/> 3730:                                            or (b =:= element(2, X))]),
<a name="3731"/> 3731:           {list, {table,{qlc_SUITE,list_keys,[[a,b],2,L]}}, _MS} = i(QH),
<a name="3732"/> 3732:           [1,2] = qlc:eval(QH)&quot;&gt;&gt;,
<a name="3733"/> 3733: 
<a name="3734"/> 3734:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="3735"/> 3735:           QH = qlc:q([element(1, X) || X &lt;- qlc_SUITE:table(L, [2]),
<a name="3736"/> 3736:                                        begin (element(2, X) =:= a)
<a name="3737"/> 3737:                                            or (b =:= element(2, X)) end]),
<a name="3738"/> 3738:           {qlc,_,[{generate,_,{table,{call,_,
<a name="3739"/> 3739:                                {remote,_,_,{atom,_,the_list}},_}}},_],[]}
<a name="3740"/> 3740:                   = i(QH),
<a name="3741"/> 3741:           [1,2] = qlc:eval(QH)&quot;&gt;&gt;,
<a name="3742"/> 3742: 
<a name="3743"/> 3743:        &lt;&lt;&quot;L = [{1,a,q},{2,b,r},{3,c,s}],
<a name="3744"/> 3744:           QH = qlc:q([element(1, X) || X &lt;- qlc_SUITE:table(L, [2,3]),
<a name="3745"/> 3745:                                        (element(3, X) =:= q)
<a name="3746"/> 3746:                                            or (r =:= element(3, X))]),
<a name="3747"/> 3747:           {list, {table,{qlc_SUITE,list_keys, [[q,r],3,L]}}, _MS} = i(QH),
<a name="3748"/> 3748:           [1,2] = qlc:eval(QH)&quot;&gt;&gt;,
<a name="3749"/> 3749: 
<a name="3750"/> 3750:        &lt;&lt;&quot;L = [{1,a,q},{2,b,r},{3,c,s}],
<a name="3751"/> 3751:           QH = qlc:q([element(1, X) || X &lt;- qlc_SUITE:table(L, 1, [2]),
<a name="3752"/> 3752:                                        (element(3, X) =:= q)
<a name="3753"/> 3753:                                            or (r =:= element(3, X))]),
<a name="3754"/> 3754:           {qlc,_,[{generate,_,{table,{call,_,_,_}}},
<a name="3755"/> 3755:                   _],[]} = i(QH),
<a name="3756"/> 3756:           [1,2] = qlc:eval(QH)&quot;&gt;&gt;,
<a name="3757"/> 3757: 
<a name="3758"/> 3758:        &lt;&lt;&quot;L = [{a,1},{b,2},{c,3}],
<a name="3759"/> 3759:           QH = qlc:q([E || {K,I}=E &lt;- qlc_SUITE:table(L, 1, [2]),
<a name="3760"/> 3760:                            ((K =:= a) or (K =:= b) or (K =:= c))
<a name="3761"/> 3761:                                and ((I =:= 1) or (I =:= 2))],
<a name="3762"/> 3762:                      {max_lookup, 3}),
<a name="3763"/> 3763:           {list, {table,{qlc_SUITE,list_keys,[[a,b,c],1,L]}}, _MS} = i(QH),
<a name="3764"/> 3764:           [{a,1},{b,2}] = qlc:eval(QH)&quot;&gt;&gt;,
<a name="3765"/> 3765: 
<a name="3766"/> 3766:        &lt;&lt;&quot;L = [{a,1},{b,2},{c,3}],
<a name="3767"/> 3767:           QH = qlc:q([E || {K,I}=E &lt;- qlc_SUITE:table(L, 1, [2]),
<a name="3768"/> 3768:                            ((K =:= a) or (K =:= b) or (K =:= c))
<a name="3769"/> 3769:                                and ((I =:= 1) or (I =:= 2))],
<a name="3770"/> 3770:                      {max_lookup, 2}),
<a name="3771"/> 3771:           {list, {table,{qlc_SUITE,list_keys, [[1,2],2,L]}}, _MS} = i(QH),
<a name="3772"/> 3772:           [{a,1},{b,2}] = qlc:eval(QH)&quot;&gt;&gt;,
<a name="3773"/> 3773: 
<a name="3774"/> 3774:        &lt;&lt;&quot;L = [{a,1,x,u},{b,2,y,v},{c,3,z,w}],
<a name="3775"/> 3775:           QH = qlc:q([E || {K,I1,I2,I3}=E &lt;- qlc_SUITE:table(L, 1, [2,3,4]),
<a name="3776"/> 3776:                            ((K =/= a) or (K =/= b) or (K =/= c))
<a name="3777"/> 3777:                              and ((I1 =:= 1) or (I1 =:= 2) or 
<a name="3778"/> 3778:                                   (I1 =:= 3) or (I1 =:= 4))
<a name="3779"/> 3779:                              and ((I2 =:= x) or (I2 =:= z)) 
<a name="3780"/> 3780:                              and ((I3 =:= v) or (I3 =:= w))],
<a name="3781"/> 3781:                      {max_lookup, 5}),
<a name="3782"/> 3782:           {list, {table,{qlc_SUITE,list_keys, [[x,z],3,L]}}, _MS} = i(QH),
<a name="3783"/> 3783:           [{c,3,z,w}] = qlc:eval(QH)&quot;&gt;&gt;
<a name="3784"/> 3784: 
<a name="3785"/> 3785:        ],
<a name="3786"/> 3786:     run(Config, &lt;&lt;&quot;-record(r, {a}).\n&quot;&gt;&gt;, Ts),
<a name="indices-last_expr"/><a name="3787"/> 3787:     ok.
<a name="3788"/> 3788: 
<a name="3789"/> 3789: <i>%% Test the table/2 callback functions parent_fun and stop_fun.</i>
<a name="pre_fun-1"/><a name="3790"/> 3790: <b>pre_fun</b>(Config) when is_list(Config) -&gt;
<a name="3791"/> 3791:     Ts = [
<a name="3792"/> 3792:        &lt;&lt;&quot;PF = process_flag(trap_exit, true),
<a name="3793"/> 3793:           %% cursor: table killing parent
<a name="3794"/> 3794:           L = [{1,a},{2,b},{3,c}],
<a name="3795"/> 3795:           F1 = fun() -&gt;
<a name="3796"/> 3796:                    QH = qlc:q([element(1, X) || 
<a name="3797"/> 3797:                                 X &lt;- qlc_SUITE:table_kill_parent(L, [2]),
<a name="3798"/> 3798:                                 (element(2, X) =:= a)
<a name="3799"/> 3799:                                     or (b =:= element(2, X))]),
<a name="3800"/> 3800:                    _ = qlc:info(QH),
<a name="3801"/> 3801:                    _ = qlc:cursor(QH)
<a name="3802"/> 3802:                end,
<a name="3803"/> 3803:           Pid1 = spawn_link(F1),
<a name="3804"/> 3804:           receive {'EXIT', Pid1, killed} -&gt;
<a name="3805"/> 3805:               ok
<a name="3806"/> 3806:           end,
<a name="3807"/> 3807:           timer:sleep(1),
<a name="3808"/> 3808:           process_flag(trap_exit, PF)&quot;&gt;&gt;,
<a name="3809"/> 3809: 
<a name="3810"/> 3810:        &lt;&lt;&quot;PF = process_flag(trap_exit, true),
<a name="3811"/> 3811:           %% eval without cursor: table killing parent
<a name="3812"/> 3812:           L = [{1,a},{2,b},{3,c}],
<a name="3813"/> 3813:           F2 = fun() -&gt;
<a name="3814"/> 3814:                  QH = qlc:q([element(1, X) || 
<a name="3815"/> 3815:                                 X &lt;- qlc_SUITE:table_kill_parent(L, [2]),
<a name="3816"/> 3816:                                 (element(2, X) =:= a)
<a name="3817"/> 3817:                                     or (b =:= element(2, X))]),
<a name="3818"/> 3818:                  _ = qlc:eval(QH)
<a name="3819"/> 3819:                end,
<a name="3820"/> 3820:           Pid2 = spawn_link(F2),
<a name="3821"/> 3821:           receive {'EXIT', Pid2, killed} -&gt;
<a name="3822"/> 3822:               ok
<a name="3823"/> 3823:           end,
<a name="3824"/> 3824:           process_flag(trap_exit, PF)&quot;&gt;&gt;,
<a name="3825"/> 3825: 
<a name="3826"/> 3826:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="3827"/> 3827:           QH = qlc:q([element(1, X) || 
<a name="3828"/> 3828:                         X &lt;- qlc_SUITE:table_parent_throws(L, [2]),
<a name="3829"/> 3829:                         (element(2, X) =:= a)
<a name="3830"/> 3830:                             or (b =:= element(2, X))]),
<a name="3831"/> 3831:           _ = qlc:info(QH),
<a name="3832"/> 3832:           {throw,thrown} = (catch {any_term,qlc:cursor(QH)}),
<a name="3833"/> 3833:           {throw,thrown} = (catch {any_term,qlc:eval(QH)})&quot;&gt;&gt;,
<a name="3834"/> 3834: 
<a name="3835"/> 3835:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="3836"/> 3836:           QH = qlc:q([element(1, X) || 
<a name="3837"/> 3837:                         X &lt;- qlc_SUITE:table_parent_exits(L, [2]),
<a name="3838"/> 3838:                         (element(2, X) =:= a)
<a name="3839"/> 3839:                             or (b =:= element(2, X))]),
<a name="3840"/> 3840:           _ = qlc:info(QH),
<a name="3841"/> 3841:           {'EXIT', {badarith,_}} = (catch qlc:cursor(QH)),
<a name="3842"/> 3842:           {'EXIT', {badarith,_}} = (catch qlc:eval(QH))&quot;&gt;&gt;,
<a name="3843"/> 3843: 
<a name="3844"/> 3844:        &lt;&lt;&quot;L = [{1,a},{2,b},{3,c}],
<a name="3845"/> 3845:           QH = qlc:q([element(1, X) || 
<a name="3846"/> 3846:                         X &lt;- qlc_SUITE:table_bad_parent_fun(L, [2]),
<a name="3847"/> 3847:                         (element(2, X) =:= a)
<a name="3848"/> 3848:                             or (b =:= element(2, X))]),
<a name="3849"/> 3849:           {'EXIT', {badarg,_}} = (catch qlc:cursor(QH)),
<a name="3850"/> 3850:           {'EXIT', {badarg,_}} = (catch qlc:eval(QH))&quot;&gt;&gt;,
<a name="3851"/> 3851: 
<a name="3852"/> 3852:        &lt;&lt;&quot;%% Very simple test of stop_fun.
<a name="3853"/> 3853:           Ets = ets:new(apa, [public]),
<a name="3854"/> 3854:           L = [{1,a},{2,b},{3,c}],
<a name="3855"/> 3855:           H = qlc:q([X || {X,_} &lt;- qlc_SUITE:stop_list(L, Ets)]),
<a name="3856"/> 3856:           C = qlc:cursor(H),
<a name="3857"/> 3857:           [{stop_fun,StopFun}] = ets:lookup(Ets, stop_fun),
<a name="3858"/> 3858:           StopFun(),
<a name="3859"/> 3859:           {'EXIT', {{qlc_cursor_pid_no_longer_exists, _}, _}} =
<a name="3860"/> 3860:                   (catch qlc:next_answers(C, all_remaining)),
<a name="3861"/> 3861:           ets:delete(Ets)&quot;&gt;&gt;
<a name="3862"/> 3862: 
<a name="3863"/> 3863:        ],
<a name="3864"/> 3864:     
<a name="3865"/> 3865:     run(Config, Ts),
<a name="pre_fun-last_expr"/><a name="3866"/> 3866:     ok.
<a name="3867"/> 3867: 
<a name="3868"/> 3868: <i>%% Lookup keys. With records.</i>
<a name="skip_filters-1"/><a name="3869"/> 3869: <b>skip_filters</b>(Config) when is_list(Config) -&gt;
<a name="3870"/> 3870:     %% Skipped filters
<a name="3871"/> 3871:     TsS = [
<a name="3872"/> 3872:        %% Cannot skip the filter.
<a name="3873"/> 3873:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3874"/> 3874:                 H = qlc:q([X || X &lt;- ets:table(E), 
<a name="3875"/> 3875:                           (element(1, X) =:= 1) xor (element(1, X) =:= 1)]),
<a name="3876"/> 3876:                 [] = qlc:eval(H),
<a name="3877"/> 3877:                 [1] = lookup_keys(H)
<a name="3878"/> 3878:                end, [{keypos,1}], [{1},{2}])&quot;&gt;&gt;,
<a name="3879"/> 3879: 
<a name="3880"/> 3880:        %% The filter can be skipped. Just a lookup remains.
<a name="3881"/> 3881:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3882"/> 3882:                 H = qlc:q([X || X &lt;- ets:table(E), 
<a name="3883"/> 3883:                           (element(1, X) =:= 1) or (element(1, X) =:= 1)]),
<a name="3884"/> 3884:                 [{1}] = qlc:eval(H),
<a name="3885"/> 3885:                 {table, _} = i(H),
<a name="3886"/> 3886:                 [1] = lookup_keys(H)
<a name="3887"/> 3887:                end, [{keypos,1}], [{1},{2}])&quot;&gt;&gt;,
<a name="3888"/> 3888: 
<a name="3889"/> 3889:        %% safe_unify fails on 3 and &lt;&lt;X:32&gt;&gt;
<a name="3890"/> 3890:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3891"/> 3891:                 H = qlc:q([X || X &lt;- ets:table(E), 
<a name="3892"/> 3892:                      (element(1, X) =:= 1) and (3 =:= &lt;&lt;X:32&gt;&gt;)]),
<a name="3893"/> 3893:                 [] = qlc:eval(H),
<a name="3894"/> 3894:                 [1] = lookup_keys(H)
<a name="3895"/> 3895:                end, [{keypos,1}], [{1},{2}])&quot;&gt;&gt;,
<a name="3896"/> 3896: 
<a name="3897"/> 3897:        %% Two filters are skipped.
<a name="3898"/> 3898:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3899"/> 3899:                 Q = qlc:q([{B,C,D} || {A={C},B} &lt;- ets:table(E), 
<a name="3900"/> 3900:                                       (A =:= {1}) or (A =:= {2}),
<a name="3901"/> 3901:                                       (C =:= 1) or (C =:= 2),
<a name="3902"/> 3902:                                       D &lt;- [1,2]]),
<a name="3903"/> 3903:                 {qlc,_,[{generate,_,{table,_}},{generate,_,{list,[1,2]}}],[]}
<a name="3904"/> 3904:                   = i(Q),
<a name="3905"/> 3905:                 [{1,1,1},{1,1,2},{2,2,1},{2,2,2}] = lists:sort(qlc:eval(Q)),
<a name="3906"/> 3906:                 [{1},{2}] = lookup_keys(Q)
<a name="3907"/> 3907:          end, [{{1},1},{{2},2},{{3},3}])&quot;&gt;&gt;,
<a name="3908"/> 3908: 
<a name="3909"/> 3909:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3910"/> 3910:                 Q = qlc:q([{B,C} || {A={C},B} &lt;- ets:table(E), 
<a name="3911"/> 3911:                                     (A =:= {1}) or (A =:= {2}),
<a name="3912"/> 3912:                                     (C =:= 1) or (C =:= 2)]),
<a name="3913"/> 3913:                 {qlc,_,[{generate,_,{table,_}}],[]} = i(Q),
<a name="3914"/> 3914:                 [{1,1},{2,2}] = lists:sort(qlc:eval(Q)),
<a name="3915"/> 3915:                 [{1},{2}] = lookup_keys(Q)
<a name="3916"/> 3916:          end, [{{1},1},{{2},2},{{3},3}])&quot;&gt;&gt;,
<a name="3917"/> 3917: 
<a name="3918"/> 3918:        %% Lookup. No match spec, no filter.
<a name="3919"/> 3919:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3920"/> 3920:                 Q = qlc:q([X || X &lt;- ets:table(E), 
<a name="3921"/> 3921:                                element(1, X) =:= 1]),
<a name="3922"/> 3922:                 {table, _} = i(Q),
<a name="3923"/> 3923:                 [{1}] = qlc:e(Q),
<a name="3924"/> 3924:                 [1] = lookup_keys(Q)
<a name="3925"/> 3925:          end, [{1},{2}])&quot;&gt;&gt;,
<a name="3926"/> 3926: 
<a name="3927"/> 3927:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3928"/> 3928:                  Q = qlc:q([{X,Y} || X &lt;- ets:table(E), 
<a name="3929"/> 3929:                                      element(1, X) =:= 1,
<a name="3930"/> 3930:                                      Y &lt;- [1,2]]),
<a name="3931"/> 3931:                  {qlc,_,[{generate,_,{table,_}},{generate,_,{list,_}}],[]}
<a name="3932"/> 3932:                       = i(Q),
<a name="3933"/> 3933:                  [{{1},1},{{1},2}] = lists:sort(qlc:e(Q)),
<a name="3934"/> 3934:                  [1] = lookup_keys(Q)
<a name="3935"/> 3935:          end, [{1},{2}])&quot;&gt;&gt;,
<a name="3936"/> 3936: 
<a name="3937"/> 3937:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3938"/> 3938:                  Q = qlc:q([X || {X,Y} &lt;- ets:table(E), 
<a name="3939"/> 3939:                                  X =:= a, 
<a name="3940"/> 3940:                                  X =:= Y]),
<a name="3941"/> 3941:                  {list,{table,_},_} = i(Q),
<a name="3942"/> 3942:                  [a] = qlc:e(Q),
<a name="3943"/> 3943:                  [a] = lookup_keys(Q)
<a name="3944"/> 3944:           end, [{a,a},{b,c},{c,a}])&quot;&gt;&gt;,
<a name="3945"/> 3945: 
<a name="3946"/> 3946:        %% The imported variable (A) is never looked up in the current
<a name="3947"/> 3947:        %% implementation. This means that the first filter cannot be skipped;
<a name="3948"/> 3948:        %% the constant 'a' is looked up, and then the first filter evaluates
<a name="3949"/> 3949:        %% to false.
<a name="3950"/> 3950:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3951"/> 3951:                  A = 3,
<a name="3952"/> 3952:                  Q = qlc:q([X || X &lt;- ets:table(E), 
<a name="3953"/> 3953:                                  A == element(1,X),
<a name="3954"/> 3954:                                  element(1,X) =:= a]),
<a name="3955"/> 3955:                  [] = qlc:e(Q),
<a name="3956"/> 3956:                  [a] = lookup_keys(Q)
<a name="3957"/> 3957:           end, [{a},{b},{c}])&quot;&gt;&gt;,
<a name="3958"/> 3958: 
<a name="3959"/> 3959:        %% No lookup.
<a name="3960"/> 3960:        {cres, 
<a name="3961"/> 3961:         &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3962"/> 3962:                   Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="3963"/> 3963:                                   X =:= 1, 
<a name="3964"/> 3964:                                   X =:= 2]),
<a name="3965"/> 3965:                   {table, _} = i(Q),
<a name="3966"/> 3966:                   [] = qlc:e(Q),
<a name="3967"/> 3967:                   false = lookup_keys(Q)
<a name="3968"/> 3968:           end, [{1,1},{2,0}])&quot;&gt;&gt;,
<a name="3969"/> 3969:         %% {warnings,[{{4,37},qlc,nomatch_filter}]}},
<a name="3970"/> 3970:         []},
<a name="3971"/> 3971: 
<a name="3972"/> 3972:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3973"/> 3973:                  Q = qlc:q([{A,B,C} ||
<a name="3974"/> 3974:                                {A} &lt;- ets:table(E),
<a name="3975"/> 3975:                                A =:= 1,
<a name="3976"/> 3976:                                {B} &lt;- ets:table(E),
<a name="3977"/> 3977:                                B =:= 2,
<a name="3978"/> 3978:                                {C} &lt;- ets:table(E),
<a name="3979"/> 3979:                                C =:= 3]),
<a name="3980"/> 3980:                  {qlc,_,[{generate,_,{list,{table,_},_}},
<a name="3981"/> 3981:                          {generate,_,{list,{table,_},_}},
<a name="3982"/> 3982:                          {generate,_,{list,{table,_},_}}],[]} = i(Q),
<a name="3983"/> 3983:                  [{1,2,3}] = qlc:e(Q),
<a name="3984"/> 3984:                  [1,2,3] = lookup_keys(Q)
<a name="3985"/> 3985:           end, [{0},{1},{2},{3},{4}])&quot;&gt;&gt;
<a name="3986"/> 3986: 
<a name="3987"/> 3987:            ],
<a name="3988"/> 3988:     run(Config, TsS),
<a name="3989"/> 3989: 
<a name="3990"/> 3990:     Ts = [
<a name="3991"/> 3991:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3992"/> 3992:                  H = qlc:q([X || {X,_} &lt;- ets:table(E),
<a name="3993"/> 3993:                                  X =:= 2]),
<a name="3994"/> 3994:                  {list,{table,_},_} = i(H),
<a name="3995"/> 3995:                  [2] = qlc:e(H)
<a name="3996"/> 3996:          end, [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="3997"/> 3997: 
<a name="3998"/> 3998:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="3999"/> 3999:                  H = qlc:q([X || {X,_} &lt;- ets:table(E),
<a name="4000"/> 4000:                                  ((X =:= 2) or (X =:= 1)) and (X &gt; 1)]),
<a name="4001"/> 4001:                  {list,{table,_},_} = i(H),
<a name="4002"/> 4002:                  [2] = qlc:e(H)
<a name="4003"/> 4003:          end, [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="4004"/> 4004: 
<a name="4005"/> 4005:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4006"/> 4006:                  H = qlc:q([X || {X,Y} &lt;- ets:table(E),
<a name="4007"/> 4007:                                  (X =:= 2) and (Y =:= b)]),
<a name="4008"/> 4008:                  {list,{table,_},_} = i(H),
<a name="4009"/> 4009:                  [2] = qlc:e(H)
<a name="4010"/> 4010:          end, [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="4011"/> 4011: 
<a name="4012"/> 4012:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4013"/> 4013:                  H = qlc:q([X || X &lt;- ets:table(E),
<a name="4014"/> 4014:                                  (element(1,X) =:= 2) and (X =:= {2,b})]),
<a name="4015"/> 4015:                  {list,{table,_},_} = i(H),
<a name="4016"/> 4016:                  [{2,b}] = qlc:e(H)
<a name="4017"/> 4017:          end, [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="4018"/> 4018: 
<a name="4019"/> 4019:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4020"/> 4020:                  H = qlc:q([{X,Y,Z,W} || 
<a name="4021"/> 4021:                                {X,Y} &lt;- ets:table(E),
<a name="4022"/> 4022:                                {Z,W} &lt;- ets:table(E),
<a name="4023"/> 4023:                                (Y =:= 3) or (Y =:= 4)]),
<a name="4024"/> 4024:                  {qlc,_,[{generate,_,{table,{ets,table,_}}},
<a name="4025"/> 4025:                          {generate,_,{table,{ets,table,_}}}],[]} = i(H),
<a name="4026"/> 4026:                  [{a,3,a,3},{a,3,b,5}] = lists:sort(qlc:e(H))
<a name="4027"/> 4027:          end, [{a,3},{b,5}])&quot;&gt;&gt;,
<a name="4028"/> 4028: 
<a name="4029"/> 4029:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4030"/> 4030:                  H = qlc:q([{X,Y} || 
<a name="4031"/> 4031:                                {X,Y=3} &lt;- ets:table(E), % no matchspec
<a name="4032"/> 4032:                                %% Two columns restricted, but lookup anyway
<a name="4033"/> 4033:                                (X =:= a)]),
<a name="4034"/> 4034:                  {qlc,_,[{generate,_,{table,_}}],[]} = i(H),
<a name="4035"/> 4035:                  [{a,3}] = qlc:e(H)
<a name="4036"/> 4036:          end, [{a,3},{b,4}])&quot;&gt;&gt;,
<a name="4037"/> 4037: 
<a name="4038"/> 4038:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4039"/> 4039:                  V = 3,
<a name="4040"/> 4040:                  H = qlc:q([{X,Y} || 
<a name="4041"/> 4041:                                {X,Y} &lt;- ets:table(E),
<a name="4042"/> 4042:                                (Y =:= V)]), % imported variable, no lookup
<a name="4043"/> 4043:                  {table,{ets,table,_}} = i(H),
<a name="4044"/> 4044:                  [{a,3}] = qlc:e(H)
<a name="4045"/> 4045:          end, [{a,3},{b,4}])&quot;&gt;&gt;,
<a name="4046"/> 4046: 
<a name="4047"/> 4047:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4048"/> 4048:                  V = b,
<a name="4049"/> 4049:                  H = qlc:q([{X,Y} || 
<a name="4050"/> 4050:                                {X,Y} &lt;- ets:table(E),
<a name="4051"/> 4051:                                (X =:= V)]), % imported variable, lookup
<a name="4052"/> 4052:                  {list,{table,_},_} = i(H),
<a name="4053"/> 4053:                  [{b,4}] = qlc:e(H)
<a name="4054"/> 4054:          end, [{a,3},{b,4}])&quot;&gt;&gt;,
<a name="4055"/> 4055: 
<a name="4056"/> 4056:        &lt;&lt;&quot;H = qlc:q([{A,B} || {{A,B}} &lt;- [{{1,a}},{{2,b}}],
<a name="4057"/> 4057:                               A =:= 1,
<a name="4058"/> 4058:                               B =:= a]),
<a name="4059"/> 4059:               {list,{list,[_,_]},_} = i(H),
<a name="4060"/> 4060:               [{1,a}] = qlc:e(H)&quot;&gt;&gt;,
<a name="4061"/> 4061: 
<a name="4062"/> 4062:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4063"/> 4063:                  H = qlc:q([{A,B} || {{A,B}} &lt;- ets:table(E),
<a name="4064"/> 4064:                                      A =:= 1,
<a name="4065"/> 4065:                                      B =:= a]),
<a name="4066"/> 4066:                  {list,{table,_},_} = i(H),
<a name="4067"/> 4067:                  [{1,a}] = qlc:e(H)
<a name="4068"/> 4068:          end, [{{1,a}},{{2,b}}])&quot;&gt;&gt;,
<a name="4069"/> 4069: 
<a name="4070"/> 4070:        %% The filters are skipped, and the guards of the match specifications
<a name="4071"/> 4071:        %% are skipped as well. Only the transformations of the matchspecs
<a name="4072"/> 4072:        %% are kept.
<a name="4073"/> 4073:        &lt;&lt;&quot;etsc(fun(E1) -&gt;
<a name="4074"/> 4074:                  etsc(fun(E2) -&gt;
<a name="4075"/> 4075:                               H = qlc:q([{X,Y,Z,W} ||
<a name="4076"/> 4076:                                              {X,_}=Z &lt;- ets:table(E1),
<a name="4077"/> 4077:                                              W={Y} &lt;- ets:table(E2),
<a name="4078"/> 4078:                                              (X =:= 1) or (X =:= 2),
<a name="4079"/> 4079:                                              (Y =:= a) or (Y =:= b)]
<a name="4080"/> 4080:                                          ,{lookup,true}
<a name="4081"/> 4081:                                         ),
<a name="4082"/> 4082:                               {qlc,_,[{generate,_,{list,{table,_},
<a name="4083"/> 4083:                                                    [{{'$1','_'},[],['$_']}]}},
<a name="4084"/> 4084:                                       {generate,_,{list,{table,_},
<a name="4085"/> 4085:                                                    [{{'$1'},[],['$_']}]}}],[]}
<a name="4086"/> 4086:                               = i(H),
<a name="4087"/> 4087:                               [{1,a,{1,a},{a}},
<a name="4088"/> 4088:                                {1,b,{1,a},{b}},
<a name="4089"/> 4089:                                {2,a,{2,b},{a}},
<a name="4090"/> 4090:                                {2,b,{2,b},{b}}] = qlc:e(H)
<a name="4091"/> 4091:                       end, [{a},{b}])
<a name="4092"/> 4092:          end, [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="4093"/> 4093: 
<a name="4094"/> 4094:        %% The same example again, but this time no match specs are run.
<a name="4095"/> 4095:        &lt;&lt;&quot;fun(Z) -&gt; 
<a name="4096"/> 4096:               etsc(fun(E1) -&gt;
<a name="4097"/> 4097:                      etsc(fun(E2) -&gt;
<a name="4098"/> 4098:                                   H = qlc:q([{X,Y} ||
<a name="4099"/> 4099:                                                  Z &gt; 2,
<a name="4100"/> 4100:                                                  X &lt;- ets:table(E1),
<a name="4101"/> 4101:                                                  Y &lt;- ets:table(E2),
<a name="4102"/> 4102:                                                  (element(1, X) =:= 1) or
<a name="4103"/> 4103:                                                  (element(1, X) =:= 2),
<a name="4104"/> 4104:                                                  (element(1, Y) =:= a) or
<a name="4105"/> 4105:                                                  (element(1, Y) =:= b)]
<a name="4106"/> 4106:                                              ,{lookup,true}
<a name="4107"/> 4107:                                             ),
<a name="4108"/> 4108:                                   {qlc,_,[_,{generate,_,{table,_}},
<a name="4109"/> 4109:                                           {generate,_,{table,_}}],[]} = i(H),
<a name="4110"/> 4110:                                   [{{1,a},{a}},
<a name="4111"/> 4111:                                    {{1,a},{b}},
<a name="4112"/> 4112:                                    {{2,b},{a}},
<a name="4113"/> 4113:                                    {{2,b},{b}}] = qlc:e(H)
<a name="4114"/> 4114:                           end, [{a},{b}])
<a name="4115"/> 4115:              end, [{1,a},{2,b}])
<a name="4116"/> 4116:          end(4)&quot;&gt;&gt;,
<a name="4117"/> 4117: 
<a name="4118"/> 4118:        %% Once again, this time with a join.
<a name="4119"/> 4119:        &lt;&lt;&quot;etsc(fun(E1) -&gt;
<a name="4120"/> 4120:                  etsc(fun(E2) -&gt;
<a name="4121"/> 4121:                               H = qlc:q([{X,Y,Z,W} ||
<a name="4122"/> 4122:                                              {X,V}=Z &lt;- ets:table(E1),
<a name="4123"/> 4123:                                              W={Y} &lt;- ets:table(E2),
<a name="4124"/> 4124:                                              (X =:= 1) or (X =:= 2),
<a name="4125"/> 4125:                                              (Y =:= a) or (Y =:= b),
<a name="4126"/> 4126:                                              Y =:= V]
<a name="4127"/> 4127:                                          ,[{lookup,true},{join,merge}]
<a name="4128"/> 4128:                                         ),
<a name="4129"/> 4129:                               {qlc,_,[{generate,_,{qlc,_,
<a name="4130"/> 4130:                                 [{generate,_,{qlc,_,[{generate,_,
<a name="4131"/> 4131:                                     {keysort,{list,{table,_},_},2,[]}},
<a name="4132"/> 4132:                                  _C1,_C2],[]}},
<a name="4133"/> 4133:                                   {generate,_,
<a name="4134"/> 4134:                                       {qlc,_,[{generate, _,
<a name="4135"/> 4135:                                          {keysort,{list,{table,_},_},1,[]}},
<a name="4136"/> 4136:                                               _C3],
<a name="4137"/> 4137:                                        []}},
<a name="4138"/> 4138:                                  _],
<a name="4139"/> 4139:                                 [{join,merge}]}},_],[]} = i(H),
<a name="4140"/> 4140:                               [{1,a,{1,a},{a}},{2,b,{2,b},{b}}] = 
<a name="4141"/> 4141:                                   lists:sort(qlc:e(H))
<a name="4142"/> 4142:                       end, [{a},{b}])
<a name="4143"/> 4143:          end, [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="4144"/> 4144: 
<a name="4145"/> 4145:        %% Filters 2 and 3 are not skipped. 
<a name="4146"/> 4146:        %% (Only one filter at a time is tried by the parse transform.)
<a name="4147"/> 4147:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4148"/> 4148:                  H = qlc:q([X || {{A,B}=X,Y} &lt;- ets:table(E), % no matchspec
<a name="4149"/> 4149:                                      Y =:= 3,
<a name="4150"/> 4150:                                      A =:= 1,
<a name="4151"/> 4151:                                      B =:= a]),
<a name="4152"/> 4152: 
<a name="4153"/> 4153:                  {qlc,_,[{generate,_,{table,_}},_,_,_],[]}= i(H),
<a name="4154"/> 4154:                  [{1,a}] = qlc:e(H)
<a name="4155"/> 4155:          end, [{{1,a},3},{{2,b},4}])&quot;&gt;&gt;,
<a name="4156"/> 4156: 
<a name="4157"/> 4157:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4158"/> 4158:                  H = qlc:q([X || {X=_,_} &lt;- ets:table(E), % no matchspec
<a name="4159"/> 4159:                                   (X =:= 3) and (X &gt; 3)]),
<a name="4160"/> 4160:                  {qlc,_,[{generate,_,{table,_}},_],[]} = i(H),
<a name="4161"/> 4161:                  [] = qlc:e(H)
<a name="4162"/> 4162:          end, [{3,a},{4,b}])&quot;&gt;&gt;,
<a name="4163"/> 4163: 
<a name="4164"/> 4164:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4165"/> 4165:                  H = qlc:q([X || {X=_,_} &lt;- ets:table(E), % no matchspec
<a name="4166"/> 4166:                                  (X =:= 3) or true]),
<a name="4167"/> 4167:                  {qlc,_,[{generate,_,{table,{ets,table,_}}},_],[]} = i(H),
<a name="4168"/> 4168:                  [3,4] = lists:sort(qlc:e(H))
<a name="4169"/> 4169:          end, [{3,a},{4,b}])&quot;&gt;&gt;,
<a name="4170"/> 4170: 
<a name="4171"/> 4171:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4172"/> 4172:                  H = qlc:q([X || {X=_,_} &lt;- ets:table(E), % no matchspec
<a name="4173"/> 4173:                                  (X =:= 3) or false]),
<a name="4174"/> 4174:                  {qlc,_,[{generate,_,{table,_}}],[]} = i(H),
<a name="4175"/> 4175:                  [3] = lists:sort(qlc:e(H))
<a name="4176"/> 4176:          end, [{3,a},{4,b}])&quot;&gt;&gt;,
<a name="4177"/> 4177: 
<a name="4178"/> 4178:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4179"/> 4179:                  H = qlc:q([X || {X=_,_} &lt;- ets:table(E), % no matchspec
<a name="4180"/> 4180:                                  (X =:= X) and (X =:= 3)]),
<a name="4181"/> 4181:                  {qlc,_,[{generate,_,{table,_}}],[]} = i(H),
<a name="4182"/> 4182:                  [3] = lists:sort(qlc:e(H))
<a name="4183"/> 4183:          end, [{3,a},{4,b}])&quot;&gt;&gt;,
<a name="4184"/> 4184: 
<a name="4185"/> 4185:        %% The order of filters matters. A guard filter cannot be used
<a name="4186"/> 4186:        %% unless there are no non-guard filter placed before the guard
<a name="4187"/> 4187:        %% filter that uses the guard filter's generator. There is
<a name="4188"/> 4188:        %% more examples in join_filter().
<a name="4189"/> 4189:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4190"/> 4190:                  %% Lookup. 
<a name="4191"/> 4191:                  Q = qlc:q([{A,B,A} ||
<a name="4192"/> 4192:                                {A=_,B} &lt;- ets:table(E), % no match spec
<a name="4193"/> 4193:                                A =:= 1,
<a name="4194"/> 4194:                                begin 1/B &gt; 0 end]),
<a name="4195"/> 4195:                  [{1,1,1}] = lists:sort(qlc:e(Q))
<a name="4196"/> 4196:          end, [{1,1},{2,0}])&quot;&gt;&gt;,
<a name="4197"/> 4197:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4198"/> 4198:                  %% No lookup. 
<a name="4199"/> 4199:                  Q = qlc:q([{A,B,A} ||
<a name="4200"/> 4200:                                {A=_,B} &lt;- ets:table(E), % no match spec
<a name="4201"/> 4201:                                begin 1/B &gt; 0 end,
<a name="4202"/> 4202:                                A =:= 1]),
<a name="4203"/> 4203:                  {'EXIT', _} = (catch qlc:e(Q))
<a name="4204"/> 4204:          end, [{1,1},{2,0}])&quot;&gt;&gt;,
<a name="4205"/> 4205:        %% The same thing, with a match specification.
<a name="4206"/> 4206:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4207"/> 4207:                  Q = qlc:q([{A,B,A} ||
<a name="4208"/> 4208:                                {A,B} &lt;- ets:table(E), % match spec
<a name="4209"/> 4209:                                A &lt; 2,
<a name="4210"/> 4210:                                begin 1/B &gt; 0 end]),
<a name="4211"/> 4211:                  [{1,1,1}] = lists:sort(qlc:e(Q))
<a name="4212"/> 4212:          end, [{1,1},{2,0}])&quot;&gt;&gt;,
<a name="4213"/> 4213:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4214"/> 4214:                  Q = qlc:q([{A,B,A} ||
<a name="4215"/> 4215:                                {A,B} &lt;- ets:table(E), % match spec
<a name="4216"/> 4216:                                begin 1/B &gt; 0 end,
<a name="4217"/> 4217:                                A &lt; 2]),
<a name="4218"/> 4218:                  {'EXIT', _} = (catch qlc:e(Q))
<a name="4219"/> 4219:          end, [{1,1},{2,0}])&quot;&gt;&gt;,
<a name="4220"/> 4220:        %% More examples, this time two tables.
<a name="4221"/> 4221:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4222"/> 4222:                  Q = qlc:q([{A,B,C,D} ||
<a name="4223"/> 4223:                                {A,B} &lt;- ets:table(E), % match spec
<a name="4224"/> 4224:                                A &lt; 2,
<a name="4225"/> 4225:                                {C,D} &lt;- ets:table(E),
<a name="4226"/> 4226:                                begin 1/B &gt; 0 end, %\&quot;invalidates\&quot; next filter
<a name="4227"/> 4227:                                C =:= 1,
<a name="4228"/> 4228:                                begin 1/D &gt; 0 end]),
<a name="4229"/> 4229:                  {qlc,_,[{generate,_,{table,{ets,table,_}}},
<a name="4230"/> 4230:                          {generate,_,{table,{ets,table,_}}},
<a name="4231"/> 4231:                          _,_,_],[]} = i(Q),
<a name="4232"/> 4232:                  [{1,1,1,1}] = lists:sort(qlc:e(Q))
<a name="4233"/> 4233:          end, [{1,1},{2,0}])&quot;&gt;&gt;,
<a name="4234"/> 4234:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="4235"/> 4235:               Q = qlc:q([{A,B,C,D} ||
<a name="4236"/> 4236:                             {A,B} &lt;- ets:table(E),
<a name="4237"/> 4237:                             {C,D} &lt;- ets:table(E),
<a name="4238"/> 4238:                             begin 1/B &gt; 0 end, % \&quot;invalidates\&quot; two filters
<a name="4239"/> 4239:                             A &lt; 2,
<a name="4240"/> 4240:                             C =:= 1,
<a name="4241"/> 4241:                             begin 1/D &gt; 0 end]),
<a name="4242"/> 4242:               {qlc,_,[{generate,_,{table,{ets,table,_}}},
<a name="4243"/> 4243:                       {generate,_,{table,{ets,table,_}}},_,_,_,_],[]} = i(Q),
<a name="4244"/> 4244:               {'EXIT', _} = (catch qlc:e(Q))
<a name="4245"/> 4245:          end, [{1,1},{2,0}])&quot;&gt;&gt;,
<a name="4246"/> 4246:       &lt;&lt;&quot;%% There are objects in the ETS table, but none passes the filter.
<a name="4247"/> 4247:          %% F() would not be run if it did not \&quot;invalidate\&quot; the following
<a name="4248"/> 4248:          %% guards. 
<a name="4249"/> 4249:          etsc(fun(E) -&gt;
<a name="4250"/> 4250:                       F = fun() -&gt; [foo || A &lt;- [0], 1/A] end,
<a name="4251"/> 4251:                       Q1 = qlc:q([X || {X} &lt;- ets:table(E),
<a name="4252"/> 4252:                                        F(), % \&quot;invalidates\&quot; next guard
<a name="4253"/> 4253:                                        X =:= 17]),
<a name="4254"/> 4254:                       {'EXIT', _} = (catch qlc:e(Q1))
<a name="4255"/> 4255:               end, [{1},{2},{3}])&quot;&gt;&gt;,
<a name="4256"/> 4256:        &lt;&lt;&quot;%% The last example works just like this one:
<a name="4257"/> 4257:           etsc(fun(E) -&gt;
<a name="4258"/> 4258:                       F = fun() -&gt; [foo || A &lt;- [0], 1/A] end,
<a name="4259"/> 4259:                       Q1 = qlc:q([X || {X} &lt;- ets:table(E),
<a name="4260"/> 4260:                                        F(),
<a name="4261"/> 4261:                                        begin X =:= 17 end]),
<a name="4262"/> 4262:                       {'EXIT', _} = (catch qlc:e(Q1))
<a name="4263"/> 4263:               end, [{1},{2},{3}])&quot;&gt;&gt;
<a name="4264"/> 4264: 
<a name="4265"/> 4265:           ],
<a name="4266"/> 4266:     run(Config, Ts),
<a name="4267"/> 4267: 
<a name="skip_filters-last_expr"/><a name="4268"/> 4268:     ok.
<a name="4269"/> 4269: 
<a name="4270"/> 4270: 
<a name="4271"/> 4271: <i>%% ets:table/1,2.</i>
<a name="ets-1"/><a name="4272"/> 4272: <b>ets</b>(Config) when is_list(Config) -&gt;
<a name="4273"/> 4273:     Ts = [
<a name="4274"/> 4274:        &lt;&lt;&quot;E = ets:new(t, [ordered_set]),
<a name="4275"/> 4275:           true = ets:insert(E, [{1},{2}]),
<a name="4276"/> 4276:           {'EXIT', _} = 
<a name="4277"/> 4277:               (catch qlc:e(qlc:q([X || {X} &lt;- ets:table(E, bad_option)]))),
<a name="4278"/> 4278:           {'EXIT', _} = 
<a name="4279"/> 4279:               (catch qlc:e(qlc:q([X || {X} &lt;- ets:table(E,{traverse,bad})]))),
<a name="4280"/> 4280:           All = [{'$1',[],['$1']}],
<a name="4281"/> 4281:           TravAll = {traverse,{select,All}},
<a name="4282"/> 4282:           [_, _] = qlc:e(qlc:q([X || {X} &lt;- ets:table(E, TravAll)])),
<a name="4283"/> 4283:           [_, _] = qlc:e(qlc:q([X || {X} &lt;- ets:table(E,{traverse,select})])),
<a name="4284"/> 4284:           [1,2] = 
<a name="4285"/> 4285:              qlc:e(qlc:q([X || {X} &lt;- ets:table(E, {traverse, first_next})])),
<a name="4286"/> 4286:           [2,1] = 
<a name="4287"/> 4287:              qlc:e(qlc:q([X || {X} &lt;- ets:table(E, {traverse, last_prev})])),
<a name="4288"/> 4288:           {table,{ets,table,[_,[{traverse,{select,_}},{n_objects,1}]]}} = 
<a name="4289"/> 4289:               i(qlc:q([X || {X} &lt;- ets:table(E, {n_objects,1})])),
<a name="4290"/> 4290:           {qlc,_,[{generate,_,{table,{ets,table,[_,{n_objects,1}]}}},_],[]} =
<a name="4291"/> 4291:               i(qlc:q([X || {X} &lt;- ets:table(E,{n_objects,1}), 
<a name="4292"/> 4292:                                    begin (X &gt;= 1) or (X &lt; 1) end])),
<a name="4293"/> 4293:           {qlc,_,[{generate,_,{table,{ets,table,[_]}}},_],[]} = 
<a name="4294"/> 4294:               i(qlc:q([X || {X} &lt;- ets:table(E), 
<a name="4295"/> 4295:                                    begin (X &gt;= 1) or (X &lt; 1) end])),
<a name="4296"/> 4296:           ets:delete(E)&quot;&gt;&gt;,
<a name="4297"/> 4297: 
<a name="4298"/> 4298:        begin
<a name="4299"/> 4299:        MS = ets:fun2ms(fun({X,Y}) when X &gt; 1 -&gt; {X,Y} end),
<a name="4300"/> 4300:        [&lt;&lt;&quot;E = ets:new(apa,[]),
<a name="4301"/> 4301:            true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="4302"/> 4302:            MS =  &quot;&gt;&gt;, io_lib:format(&quot;~w&quot;, [MS]), &lt;&lt;&quot;,
<a name="4303"/> 4303:            Q = qlc:q([X || {X,_} &lt;- ets:table(E, {traverse, {select, MS}}), 
<a name="4304"/> 4304:                            X =:= 1]),
<a name="4305"/> 4305:            R = qlc:e(Q),
<a name="4306"/> 4306:            ets:delete(E),
<a name="4307"/> 4307:            [] = R&quot;&gt;&gt;]
<a name="4308"/> 4308:        end,
<a name="4309"/> 4309: 
<a name="4310"/> 4310:        &lt;&lt;&quot;E2 = ets:new(test, [bag]),
<a name="4311"/> 4311:           Ref = make_ref(),
<a name="4312"/> 4312:           true = ets:insert(E2, [{Ref,Ref}]),
<a name="4313"/> 4313:           Q2 = qlc:q([{Val1} ||
<a name="4314"/> 4314:                          {Ref1, Val1} &lt;- ets:table(E2),
<a name="4315"/> 4315:                          Ref1 =:= Ref]),
<a name="4316"/> 4316:           S = qlc:info(Q2),
<a name="4317"/> 4317:           true = is_list(S),
<a name="4318"/> 4318:           [{Ref}] = qlc:e(Q2),
<a name="4319"/> 4319:           ets:delete(E2)&quot;&gt;&gt;
<a name="4320"/> 4320: 
<a name="4321"/> 4321:        ],
<a name="4322"/> 4322:     
<a name="4323"/> 4323:     run(Config, Ts),
<a name="ets-last_expr"/><a name="4324"/> 4324:     ok.
<a name="4325"/> 4325: 
<a name="4326"/> 4326: <i>%% dets:table/1,2.</i>
<a name="dets-1"/><a name="4327"/> 4327: <b>dets</b>(Config) when is_list(Config) -&gt;
<a name="4328"/> 4328:     dets:start(),
<a name="4329"/> 4329:     T = t,
<a name="4330"/> 4330:     Fname = filename(T, Config),
<a name="4331"/> 4331:     Ts = [
<a name="4332"/> 4332:        [&lt;&lt;&quot;T = t, Fname = \&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;,
<a name="4333"/> 4333:            file:delete(Fname),
<a name="4334"/> 4334:            {ok, _} = dets:open_file(T, [{file,Fname}]),
<a name="4335"/> 4335:            ok = dets:insert(T, [{1},{2}]),
<a name="4336"/> 4336:            {'EXIT', _} = 
<a name="4337"/> 4337:               (catch qlc:e(qlc:q([X || {X} &lt;- dets:table(T, bad_option)]))),
<a name="4338"/> 4338:            {'EXIT', _} = 
<a name="4339"/> 4339:               (catch qlc:e(qlc:q([X || {X} &lt;- dets:table(T,{traverse,bad})]))),
<a name="4340"/> 4340:            {'EXIT', _} = 
<a name="4341"/> 4341:               (catch 
<a name="4342"/> 4342:                qlc:e(qlc:q([X || {X} &lt;- dets:table(T,{traverse,last_prev})]))),
<a name="4343"/> 4343:            All = [{'$1',[],['$1']}],
<a name="4344"/> 4344:            TravAll = {traverse,{select,All}},
<a name="4345"/> 4345:            [_,_] = qlc:e(qlc:q([X || {X} &lt;- dets:table(T, TravAll)])),
<a name="4346"/> 4346:            [_,_] = qlc:e(qlc:q([X || {X} &lt;- dets:table(T,{traverse,select})])),
<a name="4347"/> 4347:            [_,_] = 
<a name="4348"/> 4348:              qlc:e(qlc:q([X || {X} &lt;- dets:table(T, {traverse, first_next})])),
<a name="4349"/> 4349:            {table,{dets,table,[T,[{traverse,{select,_}},{n_objects,1}]]}} =
<a name="4350"/> 4350:                i(qlc:q([X || {X} &lt;- dets:table(T, {n_objects,1})])),
<a name="4351"/> 4351:            {qlc,_,[{generate,_,{table,{dets,table,[t,{n_objects,1}]}}},_],[]}=
<a name="4352"/> 4352:                i(qlc:q([X || {X} &lt;- dets:table(T,{n_objects,1}), 
<a name="4353"/> 4353:                              begin (X &gt;= 1) or (X &lt; 1) end])),
<a name="4354"/> 4354:            {qlc,_,[{generate,_,{table,{dets,table,[_]}}},_],[]} = 
<a name="4355"/> 4355:                i(qlc:q([X || {X} &lt;- dets:table(T), 
<a name="4356"/> 4356:                              begin (X &gt;= 1) or (X &lt; 1) end])),
<a name="4357"/> 4357:            H = qlc:q([X || {X} &lt;- dets:table(T, {n_objects, default}),
<a name="4358"/> 4358:                            begin (X =:= 1) or (X =:= 2) or (X =:= 3) end]),
<a name="4359"/> 4359:            [1,2] = lists:sort(qlc:e(H)),
<a name="4360"/> 4360:            {qlc,_,[{generate,_,{table,_}},_],[]} = i(H),
<a name="4361"/> 4361: 
<a name="4362"/> 4362:            H2 = qlc:q([X || {X} &lt;- dets:table(T), (X =:= 1) or (X =:= 2)]),
<a name="4363"/> 4363:            [1,2] = lists:sort(qlc:e(H2)),
<a name="4364"/> 4364:            {list,{table,_},_} = i(H2),
<a name="4365"/> 4365:            true = binary_to_list(&lt;&lt;
<a name="4366"/> 4366:             \&quot;ets:match_spec_run(lists:flatmap(fun(V)-&gt;dets:lookup(t,V)end,\&quot;
<a name="4367"/> 4367:             \&quot;[1,2]),ets:match_spec_compile([{{'$1'},[],['$1']}]))\&quot;&gt;&gt;)
<a name="4368"/> 4368:                    == format_info(H2, true),
<a name="4369"/> 4369: 
<a name="4370"/> 4370:            H3 = qlc:q([X || {X} &lt;- dets:table(T), (X =:= 1)]),
<a name="4371"/> 4371:            [1] = qlc:e(H3),
<a name="4372"/> 4372:            {list,{table,_},_} = i(H3),
<a name="4373"/> 4373: 
<a name="4374"/> 4374:            ok = dets:close(T),
<a name="4375"/> 4375:            file:delete(\&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;),
<a name="4376"/> 4376:            ok&quot;&gt;&gt;],
<a name="4377"/> 4377: 
<a name="4378"/> 4378:        begin
<a name="4379"/> 4379:        MS = ets:fun2ms(fun({X,Y}) when X &gt; 1 -&gt; {X,Y} end),
<a name="4380"/> 4380:        [&lt;&lt;&quot;T = t, Fname = \&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;,
<a name="4381"/> 4381:            {ok, _} = dets:open_file(T, [{file,Fname}]),
<a name="4382"/> 4382:            MS =  &quot;&gt;&gt;, io_lib:format(&quot;~w&quot;, [MS]), &lt;&lt;&quot;,
<a name="4383"/> 4383:            ok = dets:insert(T, [{1,a},{2,b},{3,c}]),
<a name="4384"/> 4384:            Q = qlc:q([X || {X,_} &lt;- dets:table(T, {traverse, {select, MS}}), 
<a name="4385"/> 4385:                            X =:= 1]),
<a name="4386"/> 4386:            R = qlc:e(Q),
<a name="4387"/> 4387:            ok = dets:close(T),
<a name="4388"/> 4388:            file:delete(\&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;),
<a name="4389"/> 4389:            [] = R&quot;&gt;&gt;]
<a name="4390"/> 4390:        end,
<a name="4391"/> 4391: 
<a name="4392"/> 4392:        [&lt;&lt;&quot;T = t, Fname = \&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;,
<a name="4393"/> 4393:            {ok, _} = dets:open_file(T, [{file,Fname}]),
<a name="4394"/> 4394:            Objs = [{X} || X &lt;- lists:seq(1,10)],
<a name="4395"/> 4395:            ok = dets:insert(T, Objs),
<a name="4396"/> 4396:            {ok, Where} = dets:where(T, {2}),
<a name="4397"/> 4397:            ok = dets:close(T),
<a name="4398"/> 4398:            qlc_SUITE:crash(Fname, Where),
<a name="4399"/> 4399: 
<a name="4400"/> 4400:            {ok, _} = dets:open_file(T, [{file,Fname}]),
<a name="4401"/> 4401:            HT = qlc:q([X || {X} &lt;- dets:table(T, {traverse, first_next})]),
<a name="4402"/> 4402:            {'EXIT',{error,{{bad_object,_},_}}} = (catch qlc:e(HT)),
<a name="4403"/> 4403:            _ = dets:close(T),
<a name="4404"/> 4404: 
<a name="4405"/> 4405:            {ok, _} = dets:open_file(T, [{file,Fname}]),
<a name="4406"/> 4406:            HMS = qlc:q([X || {X} &lt;- dets:table(T, {traverse, select})]),
<a name="4407"/> 4407:            {error,{{bad_object,_},_}} = qlc:e(HMS),
<a name="4408"/> 4408:            _ = dets:close(T),
<a name="4409"/> 4409: 
<a name="4410"/> 4410:            {ok, _} = dets:open_file(T, [{file,Fname}]),
<a name="4411"/> 4411:            HLU = qlc:q([X || {X} &lt;- dets:table(T), X =:= 2]),
<a name="4412"/> 4412:            {error,{{bad_object,_},_}} = qlc:e(HLU),
<a name="4413"/> 4413:            _ = dets:close(T),
<a name="4414"/> 4414: 
<a name="4415"/> 4415:            file:delete(Fname)&quot;&gt;&gt;]
<a name="4416"/> 4416: 
<a name="4417"/> 4417:        ],
<a name="4418"/> 4418:     
<a name="4419"/> 4419:     run(Config, Ts),
<a name="4420"/> 4420:     _ = file:delete(Fname),
<a name="dets-last_expr"/><a name="4421"/> 4421:     ok.
<a name="4422"/> 4422: 
<a name="4423"/> 4423: 
<a name="4424"/> 4424: <i>%% The 'join' option (any, lookup, merge, nested_loop). Also cache/unique.</i>
<a name="join_option-1"/><a name="4425"/> 4425: <b>join_option</b>(Config) when is_list(Config) -&gt;
<a name="4426"/> 4426:     Ts = [
<a name="4427"/> 4427:        &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- [1,2,3]],{join,merge}),
<a name="4428"/> 4428:           {'EXIT', {no_join_to_carry_out,_}} = (catch {foo, qlc:info(Q1)}),
<a name="4429"/> 4429:           {'EXIT', {no_join_to_carry_out,_}} = (catch {foo, qlc:e(Q1)}),
<a name="4430"/> 4430: 
<a name="4431"/> 4431:           Q2 = qlc:q([X || X &lt;- [1,2,3], X &gt; 1],{join,merge}),
<a name="4432"/> 4432:           {'EXIT', {no_join_to_carry_out,_}} = (catch {foo, qlc:info(Q2)}),
<a name="4433"/> 4433:           {'EXIT', {no_join_to_carry_out,_}} = (catch {foo, qlc:e(Q2)}),
<a name="4434"/> 4434: 
<a name="4435"/> 4435:           Q3 = qlc:q([{X,Y} ||
<a name="4436"/> 4436:                          {X} &lt;- [{1},{2},{3}],
<a name="4437"/> 4437:                          {Y} &lt;- [{a},{b},{c}],
<a name="4438"/> 4438:                          X =:= Y],
<a name="4439"/> 4439:                      {join, merge}),
<a name="4440"/> 4440: 
<a name="4441"/> 4441:           {1,0,0,2} = join_info(Q3),
<a name="4442"/> 4442:           [] = qlc:e(Q3),
<a name="4443"/> 4443: 
<a name="4444"/> 4444:           Q4 = qlc:q([{X,Y} ||
<a name="4445"/> 4445:                          {X} &lt;- [{1},{2},{3}],
<a name="4446"/> 4446:                          {Y} &lt;- [{a},{b},{c}],
<a name="4447"/> 4447:                          X &gt; Y],
<a name="4448"/> 4448:                      {join, lookup}),
<a name="4449"/> 4449:           {'EXIT', {no_join_to_carry_out, _}} = (catch {foo, qlc:info(Q4)}),
<a name="4450"/> 4450:           {'EXIT', {no_join_to_carry_out, _}} = (catch {foo, qlc:e(Q4)}),
<a name="4451"/> 4451: 
<a name="4452"/> 4452:           Q5 = qlc:q([{X,Y} ||
<a name="4453"/> 4453:                          {X} &lt;- [{1},{2},{3}],
<a name="4454"/> 4454:                          {Y} &lt;- [{3},{4},{5}],
<a name="4455"/> 4455:                          X == Y],
<a name="4456"/> 4456:                      {join, merge}),
<a name="4457"/> 4457:           [{3,3}] = qlc:e(Q5),
<a name="4458"/> 4458: 
<a name="4459"/> 4459:           Q6 = qlc:q([{X,Y} ||
<a name="4460"/> 4460:                          {X} &lt;- [{1},{2},{3}],
<a name="4461"/> 4461:                          {Y} &lt;- [{3},{4},{5}],
<a name="4462"/> 4462:                          X == Y],
<a name="4463"/> 4463:                      {join, lookup}),
<a name="4464"/> 4464:           {'EXIT', {cannot_carry_out_join, _}} = (catch {foo, qlc:info(Q6)}),
<a name="4465"/> 4465:           {'EXIT', {cannot_carry_out_join, _}} = (catch {foo, qlc:e(Q6)}),
<a name="4466"/> 4466: 
<a name="4467"/> 4467:           Q7 = qlc:q([{X,Y} ||
<a name="4468"/> 4468:                          {X} &lt;- [{1},{2},{3}],
<a name="4469"/> 4469:                          {Y} &lt;- [{3},{4},{5}],
<a name="4470"/> 4470:                          X == Y],
<a name="4471"/> 4471:                      {join, nested_loop}),
<a name="4472"/> 4472:           {0,0,1,0} = join_info(Q7),
<a name="4473"/> 4473:           [{3,3}] = qlc:e(Q7),
<a name="4474"/> 4474: 
<a name="4475"/> 4475:           Q8 = qlc:q([{X,Y} ||
<a name="4476"/> 4476:                          {X} &lt;- [{1},{2},{3}],
<a name="4477"/> 4477:                          {Y} &lt;- [{3},{4},{5}],
<a name="4478"/> 4478:                          X =:= Y],
<a name="4479"/> 4479:                      {join, nested_loop}),
<a name="4480"/> 4480:           {0,0,1,0} = join_info(Q8),
<a name="4481"/> 4481:           [{3,3}] = qlc:e(Q8),
<a name="4482"/> 4482: 
<a name="4483"/> 4483:           %% Only guards are inspected...
<a name="4484"/> 4484:           Q9 = qlc:q([{X,Y} ||
<a name="4485"/> 4485:                          {X} &lt;- [{1},{2},{3}],
<a name="4486"/> 4486:                          {Y} &lt;- [{3},{4},{5}],
<a name="4487"/> 4487:                          begin X =:= Y end],
<a name="4488"/> 4488:                      {join, nested_loop}),
<a name="4489"/> 4489:           {'EXIT', {no_join_to_carry_out, _}} = (catch {foo, qlc:info(Q9)}),
<a name="4490"/> 4490:           {'EXIT', {no_join_to_carry_out, _}} = (catch {foo, qlc:e(Q9)}),
<a name="4491"/> 4491: 
<a name="4492"/> 4492:           Q10 = qlc:q([{X,Y} ||
<a name="4493"/> 4493:                          {X} &lt;- [{1},{2},{3}],
<a name="4494"/> 4494:                          {Y} &lt;- [{3},{4},{5}],
<a name="4495"/> 4495:                          X &lt; Y],
<a name="4496"/> 4496:                      {join, nested_loop}),
<a name="4497"/> 4497:           {'EXIT', {no_join_to_carry_out, _}} = (catch {foo, qlc:info(Q10)}),
<a name="4498"/> 4498:           {'EXIT', {no_join_to_carry_out, _}} = (catch {foo, qlc:e(Q10)}),
<a name="4499"/> 4499: 
<a name="4500"/> 4500:           F = fun(J) -&gt; qlc:q([X || X &lt;- [1,2]], {join,J}) end,
<a name="4501"/> 4501:           {'EXIT', {no_join_to_carry_out, _}} = 
<a name="4502"/> 4502:                 (catch {foo, qlc:e(F(merge))}),
<a name="4503"/> 4503:           {'EXIT', {no_join_to_carry_out, _}} = 
<a name="4504"/> 4504:                 (catch {foo, qlc:e(F(lookup))}),
<a name="4505"/> 4505:           {'EXIT', {no_join_to_carry_out, _}} = 
<a name="4506"/> 4506:                 (catch {foo, qlc:e(F(nested_loop))}),
<a name="4507"/> 4507:           [1,2] = qlc:e(F(any)),
<a name="4508"/> 4508: 
<a name="4509"/> 4509:           %% No join of columns in the same table.
<a name="4510"/> 4510:           Q11 = qlc:q([{X,Y} || {a = X, X = Y} &lt;- [{a,1},{a,a},{a,3},{a,a}]],
<a name="4511"/> 4511:                       {join,merge}),
<a name="4512"/> 4512:           {'EXIT', {no_join_to_carry_out, _}} = (catch qlc:e(Q11)),
<a name="4513"/> 4513:           Q12 = qlc:q([{X,Y} || {X = a, X = Y} &lt;- [{a,1},{a,a},{a,3},{a,a}]],
<a name="4514"/> 4514:                       {join,merge}),
<a name="4515"/> 4515:           {'EXIT', {no_join_to_carry_out, _}} = (catch qlc:e(Q12)),
<a name="4516"/> 4516:           %% X and Y are \&quot;equal\&quot; (same constants), but must not be joined.
<a name="4517"/> 4517:           Q13 = qlc:q([{X,Y} || {X,_Z} &lt;- [{a,1},{a,2},{b,1},{b,2}],
<a name="4518"/> 4518:                                 {Y} &lt;- [{a}],
<a name="4519"/> 4519:                                 (X =:= a) and (Y =:= b) or 
<a name="4520"/> 4520:                                 (X =:= b) and (Y =:= a)],
<a name="4521"/> 4521:                      {join,merge}),
<a name="4522"/> 4522:           {'EXIT', {no_join_to_carry_out, _}} = (catch qlc:e(Q13))
<a name="4523"/> 4523: 
<a name="4524"/> 4524: &quot;&gt;&gt;,
<a name="4525"/> 4525: 
<a name="4526"/> 4526:        &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- [1,2,3]], {lookup,true}),
<a name="4527"/> 4527:           {'EXIT', {no_lookup_to_carry_out, _}} = (catch {foo, qlc:info(Q1)}),
<a name="4528"/> 4528:           {'EXIT', {no_lookup_to_carry_out, _}} = (catch {foo, qlc:e(Q1)}),
<a name="4529"/> 4529:           Q2 = qlc:q([{X,Y} || X &lt;- [1,2,3], Y &lt;- [x,y,z]], lookup),
<a name="4530"/> 4530:           {'EXIT', {no_lookup_to_carry_out, _}} = (catch {foo, qlc:info(Q2)}),
<a name="4531"/> 4531:           {'EXIT', {no_lookup_to_carry_out, _}} = (catch {foo, qlc:e(Q2)}),
<a name="4532"/> 4532:           Q3 = qlc:q([X || {X} &lt;- [{1},{2},{3}]], {lookup,true}),
<a name="4533"/> 4533:           {'EXIT', {no_lookup_to_carry_out, _}} = (catch {foo, qlc:e(Q3)}),
<a name="4534"/> 4534:           {'EXIT', {no_lookup_to_carry_out, _}} = (catch {foo, qlc:info(Q3)}),
<a name="4535"/> 4535: 
<a name="4536"/> 4536:           E1 = create_ets(1, 10),
<a name="4537"/> 4537:           Q4 = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E1), X =:= 3], lookup),
<a name="4538"/> 4538:           {match_spec, _} = strip_qlc_call(Q4),
<a name="4539"/> 4539:           [{3,3}] = qlc:e(Q4),
<a name="4540"/> 4540:           Q5 = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E1), X =:= 3], {lookup,false}),
<a name="4541"/> 4541:           {table, ets, _} = strip_qlc_call(Q5),
<a name="4542"/> 4542:           [{3,3}] = qlc:e(Q5),
<a name="4543"/> 4543:           Q6 = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E1), X =:= 3], {lookup,any}),
<a name="4544"/> 4544:           {match_spec, _} = strip_qlc_call(Q6),
<a name="4545"/> 4545:           [{3,3}] = qlc:e(Q6),
<a name="4546"/> 4546:           ets:delete(E1)&quot;&gt;&gt;
<a name="4547"/> 4547: 
<a name="4548"/> 4548:        ],
<a name="4549"/> 4549:     run(Config, Ts),
<a name="4550"/> 4550: 
<a name="4551"/> 4551:     %% The 'cache' and 'unique' options of qlc/2 affects join.
<a name="4552"/> 4552:     CUTs = [
<a name="4553"/> 4553:        &lt;&lt;&quot;L1 = [1,2],
<a name="4554"/> 4554:           L2 = [{1,a},{2,b}],
<a name="4555"/> 4555:           L3 = [{a,1},{b,2}],
<a name="4556"/> 4556:           Q = qlc:q([{X,Y,Z} ||
<a name="4557"/> 4557:                         Z &lt;- L1,
<a name="4558"/> 4558:                         {X,_} &lt;- L2,
<a name="4559"/> 4559:                         {_,Y} &lt;- L3,
<a name="4560"/> 4560:                         X =:= Y],
<a name="4561"/> 4561:                     [cache, unique]),
<a name="4562"/> 4562:           {qlc,_,
<a name="4563"/> 4563:               [{generate,_,{list,L1}},
<a name="4564"/> 4564:                {generate,_,{qlc,_,[{generate,_,
<a name="4565"/> 4565:                       {qlc,_,[{generate,_,{keysort,{list,L2},1,[]}}],[]}},
<a name="4566"/> 4566:                                 {generate,_,{qlc,_,
<a name="4567"/> 4567:                               [{generate,_,{keysort,{list,L3},2,[]}}],[]}},_],
<a name="4568"/> 4568:                             [{join,merge},{cache,ets},{unique,true}]}},_],
<a name="4569"/> 4569:               [{unique,true}]} = i(Q),
<a name="4570"/> 4570:           [{1,1,1},{2,2,1},{1,1,2},{2,2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4571"/> 4571:        &lt;&lt;&quot;L1 = [1,2],
<a name="4572"/> 4572:           L2 = [{1,a},{2,b}],
<a name="4573"/> 4573:           L3 = [{a,1},{b,2}],
<a name="4574"/> 4574:           Q = qlc:q([{X,Y,Z} ||
<a name="4575"/> 4575:                         Z &lt;- L1,
<a name="4576"/> 4576:                         {X,_} &lt;- L2,
<a name="4577"/> 4577:                         {_,Y} &lt;- L3,
<a name="4578"/> 4578:                         X =:= Y],
<a name="4579"/> 4579:                     []),
<a name="4580"/> 4580:           Options = [{cache_all,ets}, unique_all],
<a name="4581"/> 4581:           {qlc,_,[{generate,_,{qlc,_,[{generate,_,{list,L1}}],
<a name="4582"/> 4582:                                [{unique,true}]}},
<a name="4583"/> 4583:                   {generate,_,{qlc,_,
<a name="4584"/> 4584:                               [{generate,_,{qlc,_,[{generate,_,
<a name="4585"/> 4585:                                  {keysort,{qlc,_,[{generate,_,{list,L2}}],
<a name="4586"/> 4586:                                            [{cache,ets},{unique,true}]},
<a name="4587"/> 4587:                                           1,[]}}],[]}},
<a name="4588"/> 4588:                                {generate,_,{qlc,_,
<a name="4589"/> 4589:                                     [{generate,_,{keysort,
<a name="4590"/> 4590:                                       {qlc,_,[{generate,_,{list,L3}}],
<a name="4591"/> 4591:                                        [{cache,ets},{unique,true}]},
<a name="4592"/> 4592:                                                   2,[]}}],[]}},_],
<a name="4593"/> 4593:                               [{join,merge},{cache,ets},{unique,true}]}},
<a name="4594"/> 4594:                   _],[{unique,true}]} = i(Q, Options),
<a name="4595"/> 4595:           [{1,1,1},{2,2,1},{1,1,2},{2,2,2}] = qlc:e(Q, Options)&quot;&gt;&gt;
<a name="4596"/> 4596:        ],
<a name="4597"/> 4597:     run(Config, CUTs),
<a name="4598"/> 4598: 
<a name="join_option-last_expr"/><a name="4599"/> 4599:     ok.
<a name="4600"/> 4600: 
<a name="4601"/> 4601: <i>%% Various aspects of filters and join.</i>
<a name="join_filter-1"/><a name="4602"/> 4602: <b>join_filter</b>(Config) when is_list(Config) -&gt;
<a name="4603"/> 4603:     Ts = [
<a name="4604"/> 4604:       &lt;&lt;&quot;E1 = create_ets(1, 10),
<a name="4605"/> 4605:           Q = qlc:q([X || {X,_} &lt;- ets:table(E1),
<a name="4606"/> 4606:                           begin A = X * X end, % ej true (?)
<a name="4607"/> 4607:                           X &gt;= A]),
<a name="4608"/> 4608:           {'EXIT', _} = (catch qlc:e(Q)),
<a name="4609"/> 4609:           ets:delete(E1)&quot;&gt;&gt;,
<a name="4610"/> 4610: 
<a name="4611"/> 4611:       %% The order of filters matters. See also skip_filters().
<a name="4612"/> 4612:       &lt;&lt;&quot;Q = qlc:q([{X,Y} || {X,Y} &lt;- [{a,1},{b,2}], 
<a name="4613"/> 4613:          {Z,W} &lt;- [{a,1},{c,0}], 
<a name="4614"/> 4614:          X =:= Z,
<a name="4615"/> 4615:          begin Y/W &gt; 0 end]),
<a name="4616"/> 4616:          [{a,1}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4617"/> 4617:       &lt;&lt;&quot;Q = qlc:q([{X,Y} || {X,Y} &lt;- [{a,1},{b,2}], 
<a name="4618"/> 4618:          {Z,W} &lt;- [{a,1},{c,0}], 
<a name="4619"/> 4619:          begin Y/W &gt; 0 end,
<a name="4620"/> 4620:          X =:= Z]),
<a name="4621"/> 4621:          {'EXIT', _} = (catch qlc:e(Q))&quot;&gt;&gt;,
<a name="4622"/> 4622: 
<a name="4623"/> 4623:       &lt;&lt;&quot;etsc(fun(E1) -&gt;
<a name="4624"/> 4624:                    etsc(fun(E2) -&gt;
<a name="4625"/> 4625:                              F = fun() -&gt; [foo || A &lt;- [0], 1/A] end,
<a name="4626"/> 4626:                              Q1 = qlc:q([X || {X} &lt;- ets:table(E1),
<a name="4627"/> 4627:                                               {Y} &lt;- ets:table(E2),
<a name="4628"/> 4628:                                               F(), % invalidates next filter
<a name="4629"/> 4629:                                               X =:= Y]),
<a name="4630"/> 4630:                               {qlc,_,[{generate,_,{table,{ets,table,_}}},
<a name="4631"/> 4631:                                       {generate,_,{table,{ets,table,_}}},_,_],
<a name="4632"/> 4632:                               []} = i(Q1),
<a name="4633"/> 4633:                              {'EXIT', _} = (catch qlc:e(Q1))
<a name="4634"/> 4634:                         end, [{1},{2},{3}])
<a name="4635"/> 4635:               end, [{a},{b},{c}])&quot;&gt;&gt;
<a name="4636"/> 4636: 
<a name="4637"/> 4637:     ],
<a name="4638"/> 4638:     run(Config, Ts),
<a name="join_filter-last_expr"/><a name="4639"/> 4639:     ok.
<a name="4640"/> 4640: 
<a name="4641"/> 4641: <i>%% Lookup join.</i>
<a name="join_lookup-1"/><a name="4642"/> 4642: <b>join_lookup</b>(Config) when is_list(Config) -&gt;
<a name="4643"/> 4643:     Ts = [
<a name="4644"/> 4644:        &lt;&lt;&quot;E1 = create_ets(1, 10),
<a name="4645"/> 4645:           E2 = create_ets(5, 15),
<a name="4646"/> 4646:           Q = qlc:q([{X,Y} || {_,Y} &lt;- ets:table(E2),
<a name="4647"/> 4647:                               {X,_} &lt;- ets:table(E1),
<a name="4648"/> 4648:                               X =:= Y], [{join,lookup}]),
<a name="4649"/> 4649:           {0,1,0,0} = join_info_count(Q),
<a name="4650"/> 4650:           R = qlc:e(Q),
<a name="4651"/> 4651:           ets:delete(E1),
<a name="4652"/> 4652:           ets:delete(E2),
<a name="4653"/> 4653:           [{5,5},{6,6},{7,7},{8,8},{9,9},{10,10}] = lists:sort(R)&quot;&gt;&gt;,
<a name="4654"/> 4654: 
<a name="4655"/> 4655:        &lt;&lt;&quot;E1 = create_ets(1, 10),
<a name="4656"/> 4656:           E2 = create_ets(5, 15),
<a name="4657"/> 4657:           F = fun(J) -&gt; qlc:q([{X,Y} || {X,_} &lt;- ets:table(E1),
<a name="4658"/> 4658:                                         {_,Y} &lt;- ets:table(E2),
<a name="4659"/> 4659:                                         X =:= Y], {join, J})
<a name="4660"/> 4660:               end,
<a name="4661"/> 4661:           Q = F(lookup),
<a name="4662"/> 4662:           {0,1,0,0} = join_info_count(Q),
<a name="4663"/> 4663:           R = qlc:e(Q),
<a name="4664"/> 4664:           ets:delete(E1),
<a name="4665"/> 4665:           ets:delete(E2),
<a name="4666"/> 4666:           [{5,5},{6,6},{7,7},{8,8},{9,9},{10,10}] = lists:sort(R)&quot;&gt;&gt;,
<a name="4667"/> 4667: 
<a name="4668"/> 4668:        &lt;&lt;&quot;etsc(fun(E1) -&gt;
<a name="4669"/> 4669:                   E2 = qlc_SUITE:table([{1,a},{a},{1,b},{b}], 2, []),
<a name="4670"/> 4670:                   Q = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E1), % (1)
<a name="4671"/> 4671:                                       {_,Z} &lt;- E2,   % (2)
<a name="4672"/> 4672:                                       (Z =:= Y) and (X =:= a) 
<a name="4673"/> 4673:                                       or
<a name="4674"/> 4674:                                       (Z =:= Y) and (X =:= b)]),
<a name="4675"/> 4675:                   %% Cannot look up in (1) (X is keypos). Can look up (2).
<a name="4676"/> 4676:                   %% Lookup-join: traverse (1), look up in (2).
<a name="4677"/> 4677:                   {0,1,0,0} = join_info_count(Q),
<a name="4678"/> 4678:                   [{a,a},{b,a}] = qlc:e(Q)
<a name="4679"/> 4679:                end, [{a,a},{b,a},{c,3},{d,4}])&quot;&gt;&gt;,
<a name="4680"/> 4680: 
<a name="4681"/> 4681:        &lt;&lt;&quot;%% The pattern {X,_} is used to filter out looked up objects.
<a name="4682"/> 4682:           etsc(fun(E) -&gt;
<a name="4683"/> 4683:                        Q = qlc:q([X || {X,_} &lt;- ets:table(E), 
<a name="4684"/> 4684:                                        Y &lt;- [{a,b},{c,d},{1,2},{3,4}], 
<a name="4685"/> 4685:                                        X =:= element(1, Y)]),
<a name="4686"/> 4686:                        {0,1,0,0} = join_info_count(Q),
<a name="4687"/> 4687:                        [1] = qlc:e(Q)
<a name="4688"/> 4688:                end, [{1,2},{3}])&quot;&gt;&gt;,
<a name="4689"/> 4689: 
<a name="4690"/> 4690:        &lt;&lt;&quot;E = ets:new(e, [bag,{keypos,2}]),
<a name="4691"/> 4691:           L = lists:sort([{a,1},{b,1},{c,1},{d,1},
<a name="4692"/> 4692:                           {aa,2},{bb,2},{cc,2},{dd,2}]),
<a name="4693"/> 4693:           true = ets:insert(E, L ++ [{aaa,1,1},{bbb,2,2},{ccc,3,3}]),
<a name="4694"/> 4694:           Q = qlc:q([Z || {_,Y}=Z &lt;- ets:table(E),
<a name="4695"/> 4695:                           {X} &lt;- [{X} || X &lt;- lists:seq(0, 10)],
<a name="4696"/> 4696:                           X =:= Y]),
<a name="4697"/> 4697:           {0,1,0,0} = join_info_count(Q),
<a name="4698"/> 4698:           R = qlc:e(Q),
<a name="4699"/> 4699:           ets:delete(E),
<a name="4700"/> 4700:           L = lists:sort(R)&quot;&gt;&gt;,
<a name="4701"/> 4701: 
<a name="4702"/> 4702:        &lt;&lt;&quot;E = ets:new(e, [bag,{keypos,2}]),
<a name="4703"/> 4703:           L = lists:sort([{a,1},{b,1},{c,1},{d,1},
<a name="4704"/> 4704:                           {aa,2},{bb,2},{cc,2},{dd,2}]),
<a name="4705"/> 4705:           true = ets:insert(E, L ++ [{aaa,1,1},{bbb,2,2},{ccc,3,3}]),
<a name="4706"/> 4706:           Q = qlc:q([Z || {X} &lt;- [{X} || X &lt;- lists:seq(0, 10)],
<a name="4707"/> 4707:                           {_,Y}=Z &lt;- ets:table(E),
<a name="4708"/> 4708:                           X =:= Y]),
<a name="4709"/> 4709:           {0,1,0,0} = join_info_count(Q),
<a name="4710"/> 4710:           R = qlc:e(Q),
<a name="4711"/> 4711:           ets:delete(E),
<a name="4712"/> 4712:           L = lists:sort(R)&quot;&gt;&gt;,
<a name="4713"/> 4713: 
<a name="4714"/> 4714:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="4715"/> 4715:                             {XX,X} &lt;- [{b,1},{c,3}],
<a name="4716"/> 4716:                             {Y,YY} &lt;- qlc_SUITE:table_lookup_error([{1,a}]),
<a name="4717"/> 4717:                             X =:= Y],
<a name="4718"/> 4718:                         {join,lookup}),
<a name="4719"/> 4719:           {error, lookup, failed} = qlc:e(Q)&quot;&gt;&gt;,
<a name="4720"/> 4720: 
<a name="4721"/> 4721:        &lt;&lt;&quot;E = create_ets(1, 10),
<a name="4722"/> 4722:           Q = qlc:q([{X,Y} ||
<a name="4723"/> 4723:                         {X,_} &lt;- ets:table(E),
<a name="4724"/> 4724:                         {_,Y} &lt;- qlc_SUITE:table_error([{a,1}], 1, err),
<a name="4725"/> 4725:                         X =:= Y]),
<a name="4726"/> 4726:           {0,1,0,0} = join_info_count(Q),
<a name="4727"/> 4727:           err = qlc:e(Q),
<a name="4728"/> 4728:           ets:delete(E)&quot;&gt;&gt;
<a name="4729"/> 4729: 
<a name="4730"/> 4730:           ],
<a name="4731"/> 4731:     run(Config, Ts),
<a name="join_lookup-last_expr"/><a name="4732"/> 4732:     ok.
<a name="4733"/> 4733: 
<a name="4734"/> 4734: <i>%% Merge join.</i>
<a name="join_merge-1"/><a name="4735"/> 4735: <b>join_merge</b>(Config) when is_list(Config) -&gt;
<a name="4736"/> 4736:     Ts = [
<a name="4737"/> 4737:        &lt;&lt;&quot;Q = qlc:q([{X,Y} || {X} &lt;- [], {Y} &lt;- [{1}], X =:= Y], 
<a name="4738"/> 4738:                     {join,merge}),
<a name="4739"/> 4739:           [] = qlc:e(Q)
<a name="4740"/> 4740:        &quot;&gt;&gt;,
<a name="4741"/> 4741: 
<a name="4742"/> 4742:        &lt;&lt;&quot;Q = qlc:q([{X,Y} || {X} &lt;- [{1}], {Y} &lt;- [], X =:= Y], 
<a name="4743"/> 4743:                     {join,merge}),
<a name="4744"/> 4744:           [] = qlc:e(Q)
<a name="4745"/> 4745:        &quot;&gt;&gt;,
<a name="4746"/> 4746: 
<a name="4747"/> 4747:        &lt;&lt;&quot;Q = qlc:q([{X,Y} || {X} &lt;- [{1},{1},{1}], 
<a name="4748"/> 4748:                               {Y} &lt;- [{1},{1},{1}], X =:= Y], 
<a name="4749"/> 4749:                     {join,merge}),
<a name="4750"/> 4750:           9 = length(qlc:e(Q))
<a name="4751"/> 4751:        &quot;&gt;&gt;,
<a name="4752"/> 4752: 
<a name="4753"/> 4753:        &lt;&lt;&quot;%% Two merge joins possible.
<a name="4754"/> 4754:           Q = qlc:q([{X,Y,Z,W} || {X,Y} &lt;- [{1,a},{1,b},{1,c}], 
<a name="4755"/> 4755:                                   {Z,W} &lt;- [{1,a},{1,b},{1,c}], 
<a name="4756"/> 4756:                                   X =:= Z, 
<a name="4757"/> 4757:                                   Y =:= W]),
<a name="4758"/> 4758:           {qlc,_,[{generate,_,
<a name="4759"/> 4759:                    {qlc,_,
<a name="4760"/> 4760:                     [{generate,_,
<a name="4761"/> 4761:                       {qlc,_,[{generate,_,{keysort,{list,_},C,[]}}],[]}},
<a name="4762"/> 4762:                      {generate,_,
<a name="4763"/> 4763:                       {qlc,_,[{generate,_,{keysort,{list,_},C,[]}}],[]}},
<a name="4764"/> 4764:                      _],
<a name="4765"/> 4765:                     [{join,merge}]}},
<a name="4766"/> 4766:                   _,_],[]} = qlc:info(Q, {format,debug}),
<a name="4767"/> 4767:           [{1,a,1,a},{1,b,1,b},{1,c,1,c}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4768"/> 4768: 
<a name="4769"/> 4769:        &lt;&lt;&quot;%% As the last one, but comparison.
<a name="4770"/> 4770:           Q = qlc:q([{X,Y,Z,W} || {X,Y} &lt;- [{1,a},{1,b},{1,c}], 
<a name="4771"/> 4771:                                   {Z,W} &lt;- [{1,a},{1,b},{1,c}], 
<a name="4772"/> 4772:                                   X == Z, % skipped
<a name="4773"/> 4773:                                   Y =:= W]),
<a name="4774"/> 4774:           {qlc,_,[{generate,_,
<a name="4775"/> 4775:                    {qlc,_,
<a name="4776"/> 4776:                     [{generate,_,
<a name="4777"/> 4777:                       {qlc,_,[{generate,_,{keysort,{list,_},1,[]}}],[]}},
<a name="4778"/> 4778:                      {generate,_,
<a name="4779"/> 4779:                       {qlc,_,[{generate,_,{keysort,{list,_},1,[]}}],[]}},
<a name="4780"/> 4780:                      _],
<a name="4781"/> 4781:                     [{join,merge}]}},
<a name="4782"/> 4782:                   _],[]} = qlc:info(Q, {format,debug}),
<a name="4783"/> 4783:           [{1,a,1,a},{1,b,1,b},{1,c,1,c}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4784"/> 4784: 
<a name="4785"/> 4785:        &lt;&lt;&quot;%% This is no join.
<a name="4786"/> 4786:           Q = qlc:q([{X,Y,Z,W} || {X,Y} &lt;- [], {Z,W} &lt;- [], 
<a name="4787"/> 4787:                                   X =:= Y, Z =:= W]),
<a name="4788"/> 4788:           {0,0,0,0} = join_info_count(Q)&quot;&gt;&gt;,
<a name="4789"/> 4789: 
<a name="4790"/> 4790:        &lt;&lt;&quot;%% Used to replace empty ETS tables with [], but that won't work.
<a name="4791"/> 4791:           E1 = ets:new(e1, []),
<a name="4792"/> 4792:           E2 = ets:new(e2, []),
<a name="4793"/> 4793:           Q = qlc:q([{X,Z,W} ||
<a name="4794"/> 4794:                         {X, Z} &lt;- ets:table(E1),
<a name="4795"/> 4795:                         {W, Y} &lt;- ets:table(E2),
<a name="4796"/> 4796:                         X =:= Y],
<a name="4797"/> 4797:                     {join, lookup}),
<a name="4798"/> 4798:           [] = qlc:e(Q),
<a name="4799"/> 4799:           ets:delete(E1),
<a name="4800"/> 4800:           ets:delete(E2)&quot;&gt;&gt;,
<a name="4801"/> 4801: 
<a name="4802"/> 4802:        &lt;&lt;&quot;Q = qlc:q([{X,Y} || {X} &lt;- [{3},{1},{0}], 
<a name="4803"/> 4803:                               {Y} &lt;- [{1},{2},{3}], 
<a name="4804"/> 4804:                               X =:= Y]),
<a name="4805"/> 4805:           {1,0,0,2} = join_info_count(Q),
<a name="4806"/> 4806:           [{1,1},{3,3}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4807"/> 4807: 
<a name="4808"/> 4808:        &lt;&lt;&quot;QH = qlc:q([{X,Y,Z,W} || {X,Y} &lt;- [{3,c},{2,b},{1,a}],
<a name="4809"/> 4809:                                    {Z,W} &lt;- [{2,b},{4,d},{5,e},{3,c}], 
<a name="4810"/> 4810:                                    X =:= Z, 
<a name="4811"/> 4811:                                    Y =:= W]),
<a name="4812"/> 4812:           {1,0,0,2} = join_info_count(QH),
<a name="4813"/> 4813:           [{2,b,2,b},{3,c,3,c}] = qlc:e(QH)&quot;&gt;&gt;,
<a name="4814"/> 4814: 
<a name="4815"/> 4815:        &lt;&lt;&quot;%% QLC finds no join column at run time...
<a name="4816"/> 4816:           QH = qlc:q([1 || X &lt;- [{1,2,3},{4,5,6}], 
<a name="4817"/> 4817:                            Y &lt;- [{1,2},{3,4}], 
<a name="4818"/> 4818:                            X =:= Y]),
<a name="4819"/> 4819:           {0,0,0,0} = join_info_count(QH),
<a name="4820"/> 4820:           [] = qlc:e(QH)&quot;&gt;&gt;,
<a name="4821"/> 4821: 
<a name="4822"/> 4822:        &lt;&lt;&quot;QH = qlc:q([X || X &lt;- [{1,2,3},{4,5,6}], 
<a name="4823"/> 4823:                            Y &lt;- [{1,2},{3,4}], 
<a name="4824"/> 4824:                            element(1, X) =:= element(2, Y)]),
<a name="4825"/> 4825:           {1,0,0,2} = join_info_count(QH),
<a name="4826"/> 4826:           [{4,5,6}] = qlc:e(QH)&quot;&gt;&gt;,
<a name="4827"/> 4827: 
<a name="4828"/> 4828:        &lt;&lt;&quot;Q = qlc:q([{A,X,Z,W} ||
<a name="4829"/> 4829:                         A &lt;- [a,b,c],
<a name="4830"/> 4830:                         {X,Z} &lt;- [{a,1},{b,4},{c,6}],
<a name="4831"/> 4831:                         {W,Y} &lt;- [{2,a},{3,b},{4,c}],
<a name="4832"/> 4832:                         X =:= Y],
<a name="4833"/> 4833:                    {cache, list}),
<a name="4834"/> 4834:           _ = qlc:info(Q),
<a name="4835"/> 4835:          [{a,a,1,2},{a,b,4,3},{a,c,6,4},{b,a,1,2},{b,b,4,3},
<a name="4836"/> 4836:           {b,c,6,4},{c,a,1,2},{c,b,4,3},{c,c,6,4}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4837"/> 4837: 
<a name="4838"/> 4838:        &lt;&lt;&quot;Q = qlc:q([{X,Y} || 
<a name="4839"/> 4839:                         {X,Z} &lt;- [{a,1},{b,4},{c,6}],
<a name="4840"/> 4840:                         {W,Y} &lt;- [{2,a},{3,b},{4,c}],
<a name="4841"/> 4841:                         Z &gt; W,
<a name="4842"/> 4842:                         X =:= Y],
<a name="4843"/> 4843:                     {join,merge}),
<a name="4844"/> 4844:           {qlc,_,[{generate,_,{qlc,_,
<a name="4845"/> 4845:                               [{generate,_,
<a name="4846"/> 4846:                                 {qlc,_,[{generate,_,{keysort,_,1,[]}}],[]}},
<a name="4847"/> 4847:                                {generate,_,
<a name="4848"/> 4848:                                 {qlc,_,[{generate,_,{keysort,_,2,[]}}],
<a name="4849"/> 4849:                                  []}},_],[{join,merge}]}},
<a name="4850"/> 4850:                   _,_],[]} = i(Q),
<a name="4851"/> 4851:           [{b,b},{c,c}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4852"/> 4852: 
<a name="4853"/> 4853:        &lt;&lt;&quot;E1 = create_ets(1, 10),
<a name="4854"/> 4854:           E2 = create_ets(5, 15),
<a name="4855"/> 4855:           %% A match spec.; Q does not see Q1 and Q2 as lookup-tables.
<a name="4856"/> 4856:           Q1 = qlc:q([X || X &lt;- ets:table(E1)]),
<a name="4857"/> 4857:           Q2 = qlc:q([X || X &lt;- ets:table(E2)]),
<a name="4858"/> 4858:           F = fun(J) -&gt; qlc:q([{X,Y} || X &lt;- Q1,
<a name="4859"/> 4859:                                         Y &lt;- Q2,
<a name="4860"/> 4860:                                         element(1,X) =:= element(1,Y)], 
<a name="4861"/> 4861:                               [{join,J}])
<a name="4862"/> 4862:               end,
<a name="4863"/> 4863:           {'EXIT',{cannot_carry_out_join,_}} = (catch qlc:e(F(lookup))),
<a name="4864"/> 4864:           Q = F(merge),
<a name="4865"/> 4865:           {1,0,0,2} = join_info(Q),
<a name="4866"/> 4866:           R = lists:sort(qlc:e(Q)),
<a name="4867"/> 4867:           ets:delete(E1),
<a name="4868"/> 4868:           ets:delete(E2),
<a name="4869"/> 4869:           true = [{Y,Y} || X &lt;- lists:seq(5, 10), {} =/= (Y = {X,X})] =:= R
<a name="4870"/> 4870:        &quot;&gt;&gt;,
<a name="4871"/> 4871: 
<a name="4872"/> 4872:        &lt;&lt;&quot;E1 = create_ets(1, 10),
<a name="4873"/> 4873:           E2 = create_ets(5, 15),
<a name="4874"/> 4874:           Q = qlc:q([{X,Y} || X &lt;- ets:table(E1),
<a name="4875"/> 4875:                               Y &lt;- ets:table(E2),
<a name="4876"/> 4876:                               element(1,X) =:= element(1,Y)], 
<a name="4877"/> 4877:                     [{join,merge}]),
<a name="4878"/> 4878:           {1,0,0,2} = join_info(Q),
<a name="4879"/> 4879:           R = lists:sort(qlc:e(Q)),
<a name="4880"/> 4880:           ets:delete(E1),
<a name="4881"/> 4881:           ets:delete(E2),
<a name="4882"/> 4882:           true = [{Y,Y} || X &lt;- lists:seq(5, 10), {} =/= (Y = {X,X})] =:= R
<a name="4883"/> 4883:        &quot;&gt;&gt;,
<a name="4884"/> 4884: 
<a name="4885"/> 4885:        &lt;&lt;&quot;E1 = create_ets(1, 10),
<a name="4886"/> 4886:           E2 = create_ets(5, 15),
<a name="4887"/> 4887:           Q1 = qlc:q([Y || X &lt;- ets:table(E1), begin Y = {X}, true end]),
<a name="4888"/> 4888:           %% A match spec.; Q does not see Q2 as a lookup-table.
<a name="4889"/> 4889:           %%
<a name="4890"/> 4890:           %% OTP-6673: lookup join is considered but since there is no
<a name="4891"/> 4891:           %% filter that can do the job of Q2, lookup join is not an option..
<a name="4892"/> 4892:           Q2 = qlc:q([{X} || X &lt;- ets:table(E2)]),
<a name="4893"/> 4893:           F = fun(J) -&gt;
<a name="4894"/> 4894:                       qlc:q([{X,Y} || X &lt;- Q1,
<a name="4895"/> 4895:                                       Y &lt;- Q2,
<a name="4896"/> 4896:                                       element(1,X) =:= element(1,Y)],
<a name="4897"/> 4897:                             [{join,J}])
<a name="4898"/> 4898:               end,
<a name="4899"/> 4899:           {'EXIT',{cannot_carry_out_join,_}} = (catch qlc:e(F(lookup))),
<a name="4900"/> 4900:           Q = F(any),
<a name="4901"/> 4901:           {1,0,0,2} = join_info(Q),
<a name="4902"/> 4902:           R = lists:sort(qlc:e(Q)),
<a name="4903"/> 4903:           ets:delete(E1),
<a name="4904"/> 4904:           ets:delete(E2),
<a name="4905"/> 4905:           true = [{Y,Y} || X &lt;- lists:seq(5, 10), {} =/= (Y = {{X,X}})] =:= R
<a name="4906"/> 4906:        &quot;&gt;&gt;,
<a name="4907"/> 4907: 
<a name="4908"/> 4908:        &lt;&lt;&quot;L1 = [{1,a},{2,a},{1,b},{2,b},{1,c},{2,c}],
<a name="4909"/> 4909:           L2 = [{b,Y} || Y &lt;- lists:seq(1, 10000)],
<a name="4910"/> 4910:           F = fun(J) -&gt;
<a name="4911"/> 4911:                       Q = qlc:q([{XX,YY} ||
<a name="4912"/> 4912:                                     {X,XX} &lt;- L1,
<a name="4913"/> 4913:                                     {YY,Y} &lt;- L2,
<a name="4914"/> 4914:                                     X == Y],
<a name="4915"/> 4915:                                 {join,J}),
<a name="4916"/> 4916:                       qlc:q([{XX1,YY1,XX2,YY2} ||
<a name="4917"/> 4917:                                 {XX1,YY1} &lt;- Q,
<a name="4918"/> 4918:                                 {XX2,YY2} &lt;- Q])
<a name="4919"/> 4919:               end,
<a name="4920"/> 4920:           Qm = F(merge),
<a name="4921"/> 4921:           Qn = F(nested_loop),
<a name="4922"/> 4922:           true = lists:sort(qlc:e(Qm)) =:= lists:sort(qlc:e(Qn))&quot;&gt;&gt;,
<a name="4923"/> 4923: 
<a name="4924"/> 4924:        &lt;&lt;&quot;L1 = [{{1,a},2},{{3,c},4}],
<a name="4925"/> 4925:           L2 = [{a,{1,a}},{c,{4,d}}],
<a name="4926"/> 4926:           Q = qlc:q([{X,Y} || {X,_} &lt;- L1,
<a name="4927"/> 4927:                               {_,{Y,Z}} &lt;- L2,
<a name="4928"/> 4928:                               X == {Y,Z}
<a name="4929"/> 4929:                            ]),
<a name="4930"/> 4930:           {qlc,_,[{generate,_,{qlc,_,
<a name="4931"/> 4931:                    [{generate,_,
<a name="4932"/> 4932:                      {qlc,_,[{generate,_,{keysort,{list,L1},1,[]}}],[]}},
<a name="4933"/> 4933:                     {generate,_,
<a name="4934"/> 4934:                      {qlc,_,[{generate,_,{keysort,{list,L2},2,[]}}],[]}},
<a name="4935"/> 4935:                     _],
<a name="4936"/> 4936:                    [{join,merge}]}}],[]}  = i(Q),
<a name="4937"/> 4937:           [{{1,a},1}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4938"/> 4938: 
<a name="4939"/> 4939:        &lt;&lt;&quot;etsc(fun(E1) -&gt;
<a name="4940"/> 4940:                    etsc(fun(E2) -&gt;
<a name="4941"/> 4941:                       Q = qlc:q([{X,Y} || {X,Y} &lt;- ets:table(E1), % (1)
<a name="4942"/> 4942:                                           {Z} &lt;- ets:table(E2),   % (2)
<a name="4943"/> 4943:                                             (Z =:= X) and 
<a name="4944"/> 4944:                                             (Y =:= a) and 
<a name="4945"/> 4945:                                             (X =:= Y) or 
<a name="4946"/> 4946:                                           (Y =:= b) and 
<a name="4947"/> 4947:                                           (Z =:= Y)]),
<a name="4948"/> 4948:                       %% Cannot look up in (1) (X is keypos). Can look up (2).
<a name="4949"/> 4949:                       %% Lookup join not possible (cannot look up in (1)).
<a name="4950"/> 4950:                       %% Merge join is possible (after lookup in (2)).
<a name="4951"/> 4951:                       {1,0,0,2} = join_info_count(Q),
<a name="4952"/> 4952:                       {qlc,_,
<a name="4953"/> 4953:                        [{generate,_,
<a name="4954"/> 4954:                          {qlc,_,[{generate,_,
<a name="4955"/> 4955:                                   {qlc,_,[{generate,_,
<a name="4956"/> 4956:                                            {keysort,
<a name="4957"/> 4957:                                             {table,{ets,table,_}},
<a name="4958"/> 4958:                                                   2,[]}},_C1],[]}},
<a name="4959"/> 4959:                                  {generate,_,
<a name="4960"/> 4960:                                   {qlc,_,[{generate,_,
<a name="4961"/> 4961:                                            {keysort,{table,_},1,[]}},_C2],
<a name="4962"/> 4962:                                    []}},
<a name="4963"/> 4963:                                  _],[{join,merge}]}},_],[]} = i(Q),
<a name="4964"/> 4964:                       [{a,a}] = qlc:e(Q)
<a name="4965"/> 4965:                    end, [{a}])
<a name="4966"/> 4966:                 end, [{a,1},{a,a},{b,1},{b,2}])&quot;&gt;&gt;,
<a name="4967"/> 4967: 
<a name="4968"/> 4968:        &lt;&lt;&quot;Q = qlc:q([{G1,G2} || 
<a name="4969"/> 4969:                         G1&lt;- [{1}],
<a name="4970"/> 4970:                         G2 &lt;- [{1}],
<a name="4971"/> 4971:                         element(1, G1) =:= element(1, G2)]),
<a name="4972"/> 4972:           {1,0,0,2} = join_info(Q),
<a name="4973"/> 4973:           [{{1},{1}}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4974"/> 4974: 
<a name="4975"/> 4975:        &lt;&lt;&quot;Q = qlc:q([{X,Y} || 
<a name="4976"/> 4976:                          X &lt;- [{1}], 
<a name="4977"/> 4977:                          Y &lt;- [{1}], 
<a name="4978"/> 4978:                          element(1, X) =:= element(1, Y)], 
<a name="4979"/> 4979:                      {join,merge}),
<a name="4980"/> 4980:           {1,0,0,2} = join_info(Q),
<a name="4981"/> 4981:           [{{1},{1}}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4982"/> 4982: 
<a name="4983"/> 4983:        &lt;&lt;&quot;%% Generator after the join-filter.
<a name="4984"/> 4984:           Q = qlc:q([Z || 
<a name="4985"/> 4985:                         {X} &lt;- [{1},{2},{3}], 
<a name="4986"/> 4986:                         {Y} &lt;- [{2},{3},{4}], 
<a name="4987"/> 4987:                         X =:= Y, 
<a name="4988"/> 4988:                         Z &lt;- [1,2]]),
<a name="4989"/> 4989:           {qlc,_,
<a name="4990"/> 4990:            [{generate,_,{qlc,_,
<a name="4991"/> 4991:                 [{generate,_,{qlc,_,
<a name="4992"/> 4992:                     [{generate,_,{keysort,{list,[{1},{2},{3}]},1,[]}}],[]}},
<a name="4993"/> 4993:                 {generate,_,{qlc,_,
<a name="4994"/> 4994:                     [{generate,_,{keysort,{list,_},1,[]}}],[]}},_],
<a name="4995"/> 4995:                 [{join,merge}]}}, _,{generate,_,{list,_}}],[]} = i(Q),
<a name="4996"/> 4996:           [1,2,1,2] = qlc:e(Q)&quot;&gt;&gt;,
<a name="4997"/> 4997: 
<a name="4998"/> 4998:        &lt;&lt;&quot;%% X and W occur twice in the pattern of the extra join handle.
<a name="4999"/> 4999:           Q = qlc:q([{Z,W} ||
<a name="5000"/> 5000:                         {X,Z,X} &lt;- [{1,2,1},{1,2,2}],
<a name="5001"/> 5001:                         {W,Y,W} &lt;- [{a,1,a}],
<a name="5002"/> 5002:                         X =:= Y]),
<a name="5003"/> 5003:           [{2,a}] = qlc:e(Q)&quot;&gt;&gt;
<a name="5004"/> 5004: 
<a name="5005"/> 5005:           ],
<a name="5006"/> 5006:     run(Config, Ts),
<a name="5007"/> 5007: 
<a name="5008"/> 5008:     %% Small examples. Returning an error term.
<a name="5009"/> 5009:     ETs = [
<a name="5010"/> 5010:        &lt;&lt;&quot;F = fun(M) -&gt;
<a name="5011"/> 5011:                   qlc:q([{XX,YY} ||
<a name="5012"/> 5012:                          {XX,X} &lt;- [{a,1},{b,2},{bb,2},{c,3},{cc,3}],
<a name="5013"/> 5013:                          {Y,YY} &lt;- [{0,a},{1,a},{1,aa},{2,b},{2,bb},{2,bbb},
<a name="5014"/> 5014:                                     {3,c},{3,cc}],
<a name="5015"/> 5015:                           X =:= Y],
<a name="5016"/> 5016:                         {join,M})
<a name="5017"/> 5017:               end,
<a name="5018"/> 5018:           R = qlc:e(F(nested_loop)),
<a name="5019"/> 5019:           R = qlc:e(F(merge))&quot;&gt;&gt;,
<a name="5020"/> 5020: 
<a name="5021"/> 5021:        &lt;&lt;&quot;F = fun(M) -&gt;
<a name="5022"/> 5022:                 qlc:q([{XX,YY} ||
<a name="5023"/> 5023:                        {XX,X} &lt;- [{a,1},{b,2},{bb,2},{c,3},{cc,3}],
<a name="5024"/> 5024:                        {Y,YY} &lt;- [{0,a},{1,a},{1,aa},{2,b},{2,bb},{2,bbb},
<a name="5025"/> 5025:                                   {4,d}],
<a name="5026"/> 5026:                         X =:= Y],
<a name="5027"/> 5027:                       {join,M})
<a name="5028"/> 5028:               end,
<a name="5029"/> 5029:           R = qlc:e(F(nested_loop)),
<a name="5030"/> 5030:           R = qlc:e(F(merge))&quot;&gt;&gt;,
<a name="5031"/> 5031: 
<a name="5032"/> 5032:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5033"/> 5033:                         {XX,X} &lt;- [{b,1},{c,3}],
<a name="5034"/> 5034:                         {Y,YY} &lt;- [{1,a}],
<a name="5035"/> 5035:                         X =:= Y],
<a name="5036"/> 5036:                     {join,merge}),
<a name="5037"/> 5037:           [{b,a}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5038"/> 5038: 
<a name="5039"/> 5039:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5040"/> 5040:                             {XX,X} &lt;- [{b,1},{c,3}],
<a name="5041"/> 5041:                             {Y,YY} &lt;- qlc_SUITE:table_error([{1,a}], 1, err),
<a name="5042"/> 5042:                             X =:= Y],
<a name="5043"/> 5043:                         {join,merge}),
<a name="5044"/> 5044:               err = qlc:e(Q)&quot;&gt;&gt;,
<a name="5045"/> 5045:            
<a name="5046"/> 5046:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5047"/> 5047:                             {XX,X} &lt;- [{a,1},{aa,1}],
<a name="5048"/> 5048:                             {Y,YY} &lt;- [{1,a}],
<a name="5049"/> 5049:                             X =:= Y],
<a name="5050"/> 5050:                         {join,merge}),
<a name="5051"/> 5051:               [{a,a},{aa,a}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5052"/> 5052: 
<a name="5053"/> 5053:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5054"/> 5054:                             {XX,X} &lt;- qlc_SUITE:table_error([{a,1},{aa,1}], 
<a name="5055"/> 5055:                                                              2, err),
<a name="5056"/> 5056:                             {Y,YY} &lt;- [{1,a}],
<a name="5057"/> 5057:                             X =:= Y],
<a name="5058"/> 5058:                         {join,merge}),
<a name="5059"/> 5059:               err = qlc:e(Q)&quot;&gt;&gt;,
<a name="5060"/> 5060:            
<a name="5061"/> 5061:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5062"/> 5062:                             {XX,X} &lt;- [{a,1}],
<a name="5063"/> 5063:                             {Y,YY} &lt;- [{1,a},{1,aa}],
<a name="5064"/> 5064:                             X =:= Y],
<a name="5065"/> 5065:                         {join,merge}),
<a name="5066"/> 5066:               [{a,a},{a,aa}]= qlc:e(Q)&quot;&gt;&gt;,
<a name="5067"/> 5067:            
<a name="5068"/> 5068:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5069"/> 5069:                             {XX,X} &lt;- qlc_SUITE:table_error([{a,1}], 2, err),
<a name="5070"/> 5070:                             {Y,YY} &lt;- [{1,a},{1,aa}],
<a name="5071"/> 5071:                             X =:= Y],
<a name="5072"/> 5072:                         {join,merge}),
<a name="5073"/> 5073:           C = qlc:cursor(Q),
<a name="5074"/> 5074:           [{a,a}] = qlc:next_answers(C, 1),
<a name="5075"/> 5075:           qlc:delete_cursor(C),
<a name="5076"/> 5076:           err = qlc:e(Q)&quot;&gt;&gt;,
<a name="5077"/> 5077: 
<a name="5078"/> 5078:        &lt;&lt;&quot;F = fun(M) -&gt;
<a name="5079"/> 5079:                     qlc:q([{XX,YY} ||
<a name="5080"/> 5080:                                {XX,X} &lt;- [{a,1},{b,2},{bb,2},{c,3},{cc,3}],
<a name="5081"/> 5081:                                {Y,YY} &lt;- [{0,a},{1,a},{1,aa},{2,b},
<a name="5082"/> 5082:                                           {2,bb},{2,bbb}],
<a name="5083"/> 5083:                             X =:= Y],
<a name="5084"/> 5084:                           {join,M})
<a name="5085"/> 5085:               end,
<a name="5086"/> 5086:               %% [{a,a},{a,aa},{b,b},{b,bb},{b,bbb},{bb,b},{bb,bb},{bb,bbb}]
<a name="5087"/> 5087:               R = qlc:e(F(nested_loop)),
<a name="5088"/> 5088:               R = qlc:e(F(merge))&quot;&gt;&gt;,
<a name="5089"/> 5089: 
<a name="5090"/> 5090: 
<a name="5091"/> 5091:        &lt;&lt;&quot;F = fun(M) -&gt;
<a name="5092"/> 5092:                    qlc:q([{XX,YY} ||
<a name="5093"/> 5093:                           {XX,X} &lt;- [{a,1},{b,2},{bb,2},{c,3},{cc,3}],
<a name="5094"/> 5094:                           {Y,YY} &lt;- qlc_SUITE:table_error([{0,a},{1,a},{1,aa},
<a name="5095"/> 5095:                                                            {2,b},{2,bb},
<a name="5096"/> 5096:                                                            {2,bbb}], 
<a name="5097"/> 5097:                                                           1, err),
<a name="5098"/> 5098:                            X =:= Y],
<a name="5099"/> 5099:                          {join,M})
<a name="5100"/> 5100:               end,
<a name="5101"/> 5101:               %% [{a,a},{a,aa},{b,b},{b,bb},{b,bbb},{bb,b},{bb,bb},{bb,bbb}]
<a name="5102"/> 5102:               err = qlc:e(F(nested_loop)),
<a name="5103"/> 5103:               err = qlc:e(F(merge))&quot;&gt;&gt;,
<a name="5104"/> 5104: 
<a name="5105"/> 5105:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5106"/> 5106:                             {XX,X} &lt;- qlc_SUITE:table_error([], 2, err),
<a name="5107"/> 5107:                             {Y,YY} &lt;- [{2,b},{3,c}],
<a name="5108"/> 5108:                             X =:= Y],
<a name="5109"/> 5109:                         {join,merge}),
<a name="5110"/> 5110:               err = qlc:e(Q)&quot;&gt;&gt;,
<a name="5111"/> 5111: 
<a name="5112"/> 5112:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5113"/> 5113:                             {XX,X} &lt;- [{a,1},{c,3}],
<a name="5114"/> 5114:                             {Y,YY} &lt;- [{2,b},{3,c}],
<a name="5115"/> 5115:                             X =:= Y],
<a name="5116"/> 5116:                         {join,merge}),
<a name="5117"/> 5117:               [{c,c}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5118"/> 5118: 
<a name="5119"/> 5119:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5120"/> 5120:                             {XX,X} &lt;- [{a,1},{aa,1}],
<a name="5121"/> 5121:                             {Y,YY} &lt;- [{1,a},{1,aa}],
<a name="5122"/> 5122:                             X =:= Y],
<a name="5123"/> 5123:                         {join,merge}),
<a name="5124"/> 5124:               [{a,a},{a,aa},{aa,a},{aa,aa}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5125"/> 5125: 
<a name="5126"/> 5126:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5127"/> 5127:                             {XX,X} &lt;- [{a,1},{b,2}],
<a name="5128"/> 5128:                             {Y,YY} &lt;- [{1,a},{1,aa}],
<a name="5129"/> 5129:                             X =:= Y],
<a name="5130"/> 5130:                         {join,merge}),
<a name="5131"/> 5131:               [{a,a},{a,aa}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5132"/> 5132: 
<a name="5133"/> 5133:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5134"/> 5134:                             {XX,X} &lt;- [{a,1},{b,2}],
<a name="5135"/> 5135:                             {Y,YY} &lt;- qlc_SUITE:table_error([{1,a},{1,aa}], 
<a name="5136"/> 5136:                                                             1, err),
<a name="5137"/> 5137:                             X =:= Y],
<a name="5138"/> 5138:                         {join,merge}),
<a name="5139"/> 5139:               err = qlc:e(Q)&quot;&gt;&gt;,
<a name="5140"/> 5140: 
<a name="5141"/> 5141:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5142"/> 5142:                             {XX,X} &lt;- [{a,1},{b,2}],
<a name="5143"/> 5143:                             {Y,YY} &lt;- [{1,a},{1,aa},{1,aaa},{1,aaaa}],
<a name="5144"/> 5144:                             X =:= Y],
<a name="5145"/> 5145:                         {join,merge}),
<a name="5146"/> 5146:               [{a,a},{a,aa},{a,aaa},{a,aaaa}]= qlc:e(Q)&quot;&gt;&gt;,
<a name="5147"/> 5147: 
<a name="5148"/> 5148:        &lt;&lt;&quot;Q = qlc:q([{element(1, X), element(2, Y)} ||
<a name="5149"/> 5149:                             X &lt;- [{a,1},{aa,1}],
<a name="5150"/> 5150:                             Y &lt;- [{1,a},{1,aa}],
<a name="5151"/> 5151:                             element(2, X) =:= element(1, Y)],
<a name="5152"/> 5152:                         {join,merge}),
<a name="5153"/> 5153:               [{a,a},{a,aa},{aa,a},{aa,aa}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5154"/> 5154: 
<a name="5155"/> 5155:        &lt;&lt;&quot;Q = qlc:q([{element(1, X), element(2, Y)} ||
<a name="5156"/> 5156:                             X &lt;- [{a,1},{aa,1}],
<a name="5157"/> 5157:                             Y &lt;- qlc_SUITE:table_error([], 1, err),
<a name="5158"/> 5158:                             element(2, X) =:= element(1, Y)],
<a name="5159"/> 5159:                         {join,merge}),
<a name="5160"/> 5160:               err = qlc:e(Q)&quot;&gt;&gt;,
<a name="5161"/> 5161: 
<a name="5162"/> 5162:        &lt;&lt;&quot;Q = qlc:q([{element(1, X), element(2, Y)} ||
<a name="5163"/> 5163:                             X &lt;- qlc_SUITE:table_error([{a,1}], 2, err),
<a name="5164"/> 5164:                             Y &lt;- [{2,b}],
<a name="5165"/> 5165:                             element(2, X) =:= element(1, Y)],
<a name="5166"/> 5166:                         {join,merge}),
<a name="5167"/> 5167:               err = qlc:e(Q)&quot;&gt;&gt;,
<a name="5168"/> 5168: 
<a name="5169"/> 5169:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5170"/> 5170:                   {XX,X} &lt;- [{1,a},{'1b',b},{2,b}],
<a name="5171"/> 5171:                   {Y,YY} &lt;- [{a,1},{b,'1b'},{c,1}],
<a name="5172"/> 5172:                   X == Y],
<a name="5173"/> 5173:               {join,merge}),
<a name="5174"/> 5174:           [{1,1},{'1b','1b'},{2,'1b'}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5175"/> 5175: 
<a name="5176"/> 5176:        &lt;&lt;&quot;Q = qlc:q([{XX,YY} ||
<a name="5177"/> 5177:                   {XX,X} &lt;- qlc_SUITE:table_error([{1,a},{'1b',b},{2,b}], 
<a name="5178"/> 5178:                                                   2, err),
<a name="5179"/> 5179:                   {Y,YY} &lt;- [{a,1},{b,'1b'},{c,1}],
<a name="5180"/> 5180:                   X == Y],
<a name="5181"/> 5181:               {join,merge}),
<a name="5182"/> 5182:           err = qlc:e(Q)&quot;&gt;&gt;
<a name="5183"/> 5183: 
<a name="5184"/> 5184:           ],
<a name="5185"/> 5185:     run(Config, ETs),
<a name="5186"/> 5186: 
<a name="5187"/> 5187:     %% Mostly examples where temporary files are needed while merging.
<a name="5188"/> 5188:     FTs = [
<a name="5189"/> 5189:        &lt;&lt;&quot;L1 = [{Y,a} || Y &lt;- lists:seq(1, 2)],
<a name="5190"/> 5190:           L2 = [{a,Y} || Y &lt;- lists:seq(1, 10000)],
<a name="5191"/> 5191:           F = fun(J) -&gt;
<a name="5192"/> 5192:                       qlc:q([{XX,YY} ||
<a name="5193"/> 5193:                                 {XX,X} &lt;- L1,
<a name="5194"/> 5194:                                 {Y,YY} &lt;- L2,
<a name="5195"/> 5195:                                 X == Y],
<a name="5196"/> 5196:                             {join,J})
<a name="5197"/> 5197:               end,
<a name="5198"/> 5198:           Qm = F(merge),
<a name="5199"/> 5199:           Qn = F(nested_loop),
<a name="5200"/> 5200:           true = qlc:e(Qm,{max_list_size, 0}) =:= qlc:e(Qn)&quot;&gt;&gt;,
<a name="5201"/> 5201: 
<a name="5202"/> 5202:        &lt;&lt;&quot;L1 = [{Y,a} || Y &lt;- lists:seq(1, 2)],
<a name="5203"/> 5203:           L2 = [{a,Y} || Y &lt;- lists:seq(1, 10000)],
<a name="5204"/> 5204:           Q = qlc:q([{XX,YY} ||
<a name="5205"/> 5205:                         {XX,X} &lt;- L1,
<a name="5206"/> 5206:                         {Y,YY} &lt;- L2,
<a name="5207"/> 5207:                         X == Y],
<a name="5208"/> 5208:                     {join,merge}),
<a name="5209"/> 5209:           {error,_,{file_error,_,_}} = 
<a name="5210"/> 5210:                qlc:e(Q, [{max_list_size,64*1024},{tmpdir,\&quot;/a/b/c\&quot;}])&quot;&gt;&gt;,
<a name="5211"/> 5211: 
<a name="5212"/> 5212:        &lt;&lt;&quot;L1 = qlc_SUITE:table_error([{1,a},{2,a}], 2, err),
<a name="5213"/> 5213:           L2 = [{a,Y} || Y &lt;- lists:seq(1, 10000)],
<a name="5214"/> 5214:           F = fun(J) -&gt;
<a name="5215"/> 5215:                       qlc:q([{XX,YY} ||
<a name="5216"/> 5216:                                 {XX,X} &lt;- L1,
<a name="5217"/> 5217:                                 {Y,YY} &lt;- L2,
<a name="5218"/> 5218:                                 X == Y],
<a name="5219"/> 5219:                             {join,J})
<a name="5220"/> 5220:               end,
<a name="5221"/> 5221:           Qm = F(merge),
<a name="5222"/> 5222:           Qn = F(nested_loop),
<a name="5223"/> 5223:           err = qlc:e(Qm, {max_list_size,64*1024}),
<a name="5224"/> 5224:           err = qlc:e(Qn)&quot;&gt;&gt;,
<a name="5225"/> 5225: 
<a name="5226"/> 5226:        &lt;&lt;&quot;L1 = [{Y,a} || Y &lt;- lists:seq(1, 2)],
<a name="5227"/> 5227:           L2 = qlc_SUITE:table_error([{a,Y} || Y &lt;- lists:seq(1, 10000)], 
<a name="5228"/> 5228:                                      1, err),
<a name="5229"/> 5229:           F = fun(J) -&gt;
<a name="5230"/> 5230:                       qlc:q([{XX,YY} ||
<a name="5231"/> 5231:                                 {XX,X} &lt;- L1,
<a name="5232"/> 5232:                                 {Y,YY} &lt;- L2,
<a name="5233"/> 5233:                                 X == Y],
<a name="5234"/> 5234:                             {join,J})
<a name="5235"/> 5235:               end,
<a name="5236"/> 5236:           Qm = F(merge),
<a name="5237"/> 5237:           Qn = F(nested_loop),
<a name="5238"/> 5238:           err = qlc:e(Qm, {max_list_size,64*1024}),
<a name="5239"/> 5239:           err = qlc:e(Qn)&quot;&gt;&gt;,
<a name="5240"/> 5240: 
<a name="5241"/> 5241:        &lt;&lt;&quot;L1 = [{Y,a} || Y &lt;- lists:seq(1, 2)] ++ 
<a name="5242"/> 5242:                [{'1b',b},{2,b}] ++ [{Y,d} || Y &lt;- lists:seq(1, 2)],
<a name="5243"/> 5243:           L2 = [{a,Y} || Y &lt;- lists:seq(1, 10000)] ++ 
<a name="5244"/> 5244:                [{b,'1b'}] ++ [{c,1}] ++ [{d,Y} || Y &lt;- lists:seq(1, 10000)],
<a name="5245"/> 5245:           F = fun(J) -&gt;
<a name="5246"/> 5246:                       qlc:q([{XX,YY} ||
<a name="5247"/> 5247:                                 {XX,X} &lt;- L1,
<a name="5248"/> 5248:                                 {Y,YY} &lt;- L2,
<a name="5249"/> 5249:                                 X == Y],
<a name="5250"/> 5250:                             {join,J})
<a name="5251"/> 5251:               end,
<a name="5252"/> 5252:           Qm = F(merge),
<a name="5253"/> 5253:           Qn = F(nested_loop),
<a name="5254"/> 5254:           true = lists:sort(qlc:e(Qm, {max_list_size,64*1024})) =:= 
<a name="5255"/> 5255:                  lists:sort(qlc:e(Qn))&quot;&gt;&gt;,
<a name="5256"/> 5256: 
<a name="5257"/> 5257:        &lt;&lt;&quot;F = fun(J) -&gt;
<a name="5258"/> 5258:                       qlc:q([{XX,YY} ||
<a name="5259"/> 5259:                                 {XX,X} &lt;- [{Y,a} || Y &lt;- lists:seq(1, 2)],
<a name="5260"/> 5260:                                 {Y,YY} &lt;- [{a,Y} || Y &lt;- lists:seq(1,100000)],
<a name="5261"/> 5261:                                 X == Y],
<a name="5262"/> 5262:                             {join,J})
<a name="5263"/> 5263:               end,
<a name="5264"/> 5264:           Qm = F(merge),
<a name="5265"/> 5265:           Qn = F(nested_loop),
<a name="5266"/> 5266:           true = qlc:e(Qm, {max_list_size,64*1024}) =:= qlc:e(Qn)&quot;&gt;&gt;,
<a name="5267"/> 5267: 
<a name="5268"/> 5268:        %% More than one join in one QLC expression.
<a name="5269"/> 5269:        &lt;&lt;&quot;L1 = [{Y,a} || Y &lt;- lists:seq(1, 2)],
<a name="5270"/> 5270:           L2 = [{a,Y} || Y &lt;- lists:seq(1, 10000)],
<a name="5271"/> 5271:           F = fun(J) -&gt;
<a name="5272"/> 5272:                       Q = qlc:q([{XX,YY} ||
<a name="5273"/> 5273:                                     {XX,X} &lt;- L1,
<a name="5274"/> 5274:                                     {Y,YY} &lt;- L2,
<a name="5275"/> 5275:                                     X == Y,
<a name="5276"/> 5276:                                     begin XX &gt; 1 end,
<a name="5277"/> 5277:                                     begin YY &gt; 9999 end],
<a name="5278"/> 5278:                                 {join,J}),
<a name="5279"/> 5279:                       qlc:q([{XX1,YY1,XX2,YY2} ||
<a name="5280"/> 5280:                                 {XX1,YY1} &lt;- Q,
<a name="5281"/> 5281:                                 {XX2,YY2} &lt;- Q])
<a name="5282"/> 5282:               end,
<a name="5283"/> 5283:           Qm = F(merge),
<a name="5284"/> 5284:           Qn = F(nested_loop),
<a name="5285"/> 5285:           R1 = lists:sort(qlc:e(Qm, {max_list_size,64*1024})),
<a name="5286"/> 5286:           R2 = lists:sort(qlc:e(Qm, {max_list_size,1 bsl 31})),
<a name="5287"/> 5287:           true = R1 =:= lists:sort(qlc:e(Qn)),
<a name="5288"/> 5288:           true = R1 =:= R2&quot;&gt;&gt;,
<a name="5289"/> 5289: 
<a name="5290"/> 5290:        &lt;&lt;&quot;L1 = [{Y,a} || Y &lt;- lists:seq(1, 2)],
<a name="5291"/> 5291:           L2 = [{a,Y} || Y &lt;- lists:seq(1, 10000)],
<a name="5292"/> 5292:           F = fun(J) -&gt;
<a name="5293"/> 5293:                       Q = qlc:q([{XX,YY} ||
<a name="5294"/> 5294:                                     {XX,X} &lt;- L1,
<a name="5295"/> 5295:                                     {Y,YY} &lt;- L2,
<a name="5296"/> 5296:                                     X == Y,
<a name="5297"/> 5297:                                     begin XX &gt; 1 end,
<a name="5298"/> 5298:                                     begin YY &gt; 9999 end],
<a name="5299"/> 5299:                                 {join,J}),
<a name="5300"/> 5300:                       qlc:q([{XX1,YY1,XX2,YY2} ||
<a name="5301"/> 5301:                                 {XX1,YY1} &lt;- Q,
<a name="5302"/> 5302:                                 {XX2,YY2} &lt;- Q,
<a name="5303"/> 5303:                                 throw(thrown)])
<a name="5304"/> 5304:               end,
<a name="5305"/> 5305:           Qm = F(merge),
<a name="5306"/> 5306:           thrown = (catch {any_term, qlc:e(Qm, {max_list_size,64*1024})})&quot;&gt;&gt;,
<a name="5307"/> 5307: 
<a name="5308"/> 5308:        &lt;&lt;&quot;%% Bigger than 64*1024.
<a name="5309"/> 5309:           T1 = {1, lists:seq(1, 20000)},
<a name="5310"/> 5310:           L1 = [{a,T1},{b,T1}],
<a name="5311"/> 5311:           L2 = [{T1,a},{T1,b}],
<a name="5312"/> 5312:           F = fun(J) -&gt;
<a name="5313"/> 5313:                       qlc:q([{XX,YY} ||
<a name="5314"/> 5314:                                 {XX,X} &lt;- L1,
<a name="5315"/> 5315:                                 {Y,YY} &lt;- L2,
<a name="5316"/> 5316:                                 X == Y],
<a name="5317"/> 5317:                             {join,J})
<a name="5318"/> 5318:               end,
<a name="5319"/> 5319:           Qm = F(merge),
<a name="5320"/> 5320:           Qn = F(nested_loop),
<a name="5321"/> 5321:           R = [{a,a},{a,b},{b,a},{b,b}],
<a name="5322"/> 5322:           R = qlc:e(Qm, {max_list_size,64*1024}),
<a name="5323"/> 5323:           R = qlc:e(Qn)&quot;&gt;&gt;,
<a name="5324"/> 5324: 
<a name="5325"/> 5325:        &lt;&lt;&quot;%% Bigger than 64*1024. No temporary files.
<a name="5326"/> 5326:           T1 = {1, lists:seq(1, 20000)},
<a name="5327"/> 5327:           L1 = [{a,T1},{b,T1}],
<a name="5328"/> 5328:           L2 = [{T1,a},{T1,b}],
<a name="5329"/> 5329:           F = fun(J) -&gt;
<a name="5330"/> 5330:                       qlc:q([{XX,YY} ||
<a name="5331"/> 5331:                                 {XX,X} &lt;- L1,
<a name="5332"/> 5332:                                 {Y,YY} &lt;- L2,
<a name="5333"/> 5333:                                 X == Y],
<a name="5334"/> 5334:                             {join,J})
<a name="5335"/> 5335:               end,
<a name="5336"/> 5336:           Qm = F(merge),
<a name="5337"/> 5337:           Qn = F(nested_loop),
<a name="5338"/> 5338:           R = [{a,a},{a,b},{b,a},{b,b}],
<a name="5339"/> 5339:           R = qlc:e(Qm, {max_list_size,1 bsl 31}),
<a name="5340"/> 5340:           R = qlc:e(Qn)&quot;&gt;&gt;
<a name="5341"/> 5341: 
<a name="5342"/> 5342: 
<a name="5343"/> 5343:           ],
<a name="5344"/> 5344:     run(Config, FTs),
<a name="5345"/> 5345:     
<a name="join_merge-last_expr"/><a name="5346"/> 5346:     ok.
<a name="5347"/> 5347: 
<a name="5348"/> 5348: <i>%% Merge join optimizations (avoid unnecessary sorting).</i>
<a name="join_sort-1"/><a name="5349"/> 5349: <b>join_sort</b>(Config) when is_list(Config) -&gt;
<a name="5350"/> 5350:     Ts = [
<a name="5351"/> 5351:        &lt;&lt;&quot;H1_1 = qlc:keysort(1, [{1,2,3},{4,5,6}]),
<a name="5352"/> 5352:           H1 = qlc:q([X || X &lt;- H1_1], unique),
<a name="5353"/> 5353:           H2 = qlc:keysort(2, [{1,2},{3,4}]),
<a name="5354"/> 5354:           H3 = qlc:q([{X,Y} || {X,_,_} &lt;- H1, 
<a name="5355"/> 5355:                                {_,Y} &lt;- H2, 
<a name="5356"/> 5356:                                X =:= Y]),
<a name="5357"/> 5357:           {1,0,0,2} = join_info(H3),
<a name="5358"/> 5358:           [{4,4}] = qlc:e(H3)&quot;&gt;&gt;,
<a name="5359"/> 5359: 
<a name="5360"/> 5360:        &lt;&lt;&quot;H1_1 = qlc:keysort(1, [{1,2,3},{4,5,6}]),
<a name="5361"/> 5361:           H1 = qlc:q([X || X &lt;- H1_1], unique), % keeps the order
<a name="5362"/> 5362:           H2 = qlc:keysort(2, [{1,2},{3,4}]),
<a name="5363"/> 5363:           H3 = qlc:q([{X,Y} || {X,_,_} &lt;- H1, % no extra keysort
<a name="5364"/> 5364:                                {Y,_} &lt;- H2,   % an extra keysort
<a name="5365"/> 5365:                                X =:= Y]),
<a name="5366"/> 5366:           {1,0,0,3} = join_info(H3),
<a name="5367"/> 5367:           [{1,1}] = qlc:e(H3)&quot;&gt;&gt;,
<a name="5368"/> 5368: 
<a name="5369"/> 5369:        &lt;&lt;&quot;H1_1 = qlc:keysort(1, [{1,2,3},{4,5,6}], {tmpdir,\&quot;\&quot;}),
<a name="5370"/> 5370:           H1 = qlc:q([X || X &lt;- H1_1], unique),
<a name="5371"/> 5371:           H2 = qlc:keysort(2, [{1,2},{3,4}]),
<a name="5372"/> 5372:           H3 = qlc:q([{X,Y} || {_,X,_} &lt;- H1, 
<a name="5373"/> 5373:                                {_,Y} &lt;- H2, 
<a name="5374"/> 5374:                                X =:= Y]),
<a name="5375"/> 5375:           {1,0,0,3} = join_info(H3),
<a name="5376"/> 5376:           [{2,2}] = qlc:e(H3)&quot;&gt;&gt;,
<a name="5377"/> 5377: 
<a name="5378"/> 5378:        &lt;&lt;&quot;H1_1 = qlc:keysort(1, [{1,2,3},{4,5,6}], {tmpdir,\&quot;\&quot;}),
<a name="5379"/> 5379:           H1 = qlc:q([X || X &lt;- H1_1], unique),
<a name="5380"/> 5380:           H2 = qlc:keysort(2, [{1,2},{3,4}]),
<a name="5381"/> 5381:           H3 = qlc:q([{X,Y} || {_,X,_} &lt;- H1, 
<a name="5382"/> 5382:                                {_,Y} &lt;- H2, 
<a name="5383"/> 5383:                                X =:= Y]),
<a name="5384"/> 5384:           {1,0,0,3} = join_info(H3),
<a name="5385"/> 5385:           [{2,2}] = qlc:e(H3)&quot;&gt;&gt;,
<a name="5386"/> 5386: 
<a name="5387"/> 5387:        &lt;&lt;&quot;H1 = qlc:sort([{1,a},{2,b},{3,c}]),
<a name="5388"/> 5388:           %% Since H1 is sorted it is also keysorted on the first column.
<a name="5389"/> 5389:           Q = qlc:q([{X, Y} || {X,_} &lt;- H1,
<a name="5390"/> 5390:                                {Y} &lt;- [{0},{1},{2}],
<a name="5391"/> 5391:                                X == Y]),
<a name="5392"/> 5392:           {1,0,0,1} = join_info(Q),
<a name="5393"/> 5393:           [{1,1},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5394"/> 5394: 
<a name="5395"/> 5395:        &lt;&lt;&quot;H1 = qlc:sort([{r,a,1},{r,b,2},{r,c,3}]),
<a name="5396"/> 5396:           Q = qlc:q([{X, Y} || {r,_,X} &lt;- H1, % needs keysort(3)
<a name="5397"/> 5397:                                {Y} &lt;- [{0},{1},{2}],
<a name="5398"/> 5398:                                X == Y]),
<a name="5399"/> 5399:           {1,0,0,2} = join_info(Q),
<a name="5400"/> 5400:           [{1,1},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5401"/> 5401: 
<a name="5402"/> 5402:        &lt;&lt;&quot;QH = qlc:q([X || X &lt;- [{1,2,3},{4,5,6}], 
<a name="5403"/> 5403:                            Y &lt;- qlc:sort([{1,2},{3,4}]), 
<a name="5404"/> 5404:                            element(1, X) =:= element(2, Y)]),
<a name="5405"/> 5405:           {1,0,0,2} = join_info_count(QH),
<a name="5406"/> 5406:           [{4,5,6}] = qlc:e(QH)&quot;&gt;&gt;,
<a name="5407"/> 5407: 
<a name="5408"/> 5408:        &lt;&lt;&quot;H1_1 = qlc:keysort(1, [{1,2,3},{4,5,6},{1,2,3}]),
<a name="5409"/> 5409:           H1 = qlc:q([X || X &lt;- H1_1], unique),
<a name="5410"/> 5410:           H2 = qlc:keysort(2, [{2,1},{3,4}]),
<a name="5411"/> 5411:           H3 = qlc:q([{X,Y} || {X,_,_} &lt;- H1, 
<a name="5412"/> 5412:                                {_,Y} &lt;- H2, 
<a name="5413"/> 5413:                                X =:= Y]),
<a name="5414"/> 5414:           H4 = qlc:keysort(1, [{1,2},{3,4},{4,a}]),
<a name="5415"/> 5415:           H5 = qlc:q([{X,Y} || {X,_} &lt;- H4,
<a name="5416"/> 5416:                                {_,Y} &lt;- H3,
<a name="5417"/> 5417:                                X =:= Y]),
<a name="5418"/> 5418:           {2,0,0,3} = join_info_count(H5),
<a name="5419"/> 5419:           [{1,1},{4,4}]= qlc:e(H5)&quot;&gt;&gt;,
<a name="5420"/> 5420: 
<a name="5421"/> 5421:        &lt;&lt;&quot;
<a name="5422"/> 5422:           H1 = qlc:keysort(2, [{1,a,u},{2,b,k},{3,c,l}]),
<a name="5423"/> 5423:           H2 = qlc:q([{a,X,Y,a} || {1,X,u} &lt;- H1,
<a name="5424"/> 5424:                                    {2,Y,k} &lt;- H1]),
<a name="5425"/> 5425:           %% Neither H1 nor H2 need to be key-sorted 
<a name="5426"/> 5426:           %% (the columns are constant).
<a name="5427"/> 5427:           H3 = qlc:q([{A,B,C,D,E,F,G,H} ||
<a name="5428"/> 5428:                          {A,B,C,D} &lt;- H2,
<a name="5429"/> 5429:                          {E,F,G,H} &lt;- H2,
<a name="5430"/> 5430:                          A =:= H],
<a name="5431"/> 5431:                      {join,merge}),
<a name="5432"/> 5432:           {1,0,0,4} = join_info_count(H3),
<a name="5433"/> 5433:           [{a,a,b,a,a,a,b,a}] = qlc:e(H3)&quot;&gt;&gt;,
<a name="5434"/> 5434: 
<a name="5435"/> 5435:        &lt;&lt;&quot;%% Q1 is sorted on X or Y.
<a name="5436"/> 5436:           Q1 = qlc:q([{X,Y} ||
<a name="5437"/> 5437:                          {X,_} &lt;- qlc:keysort(1, [{1,a},{2,b}]),
<a name="5438"/> 5438:                          {_,Y} &lt;- qlc:keysort(2, [{aa,11},{bb,22}]),
<a name="5439"/> 5439:                          X &lt; Y]),
<a name="5440"/> 5440:           [{1,11},{1,22},{2,11},{2,22}] = qlc:e(Q1),
<a name="5441"/> 5441:           Q = qlc:q([{X,Y} ||
<a name="5442"/> 5442:                         {X,_} &lt;- Q1, % no need to sort Q1
<a name="5443"/> 5443:                         {Y} &lt;- [{0},{1},{2},{3}],
<a name="5444"/> 5444:                         X =:= Y]),
<a name="5445"/> 5445:           {1,0,0,3} = join_info_count(Q),
<a name="5446"/> 5446:           [{1,1},{1,1},{2,2},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5447"/> 5447: 
<a name="5448"/> 5448:        &lt;&lt;&quot;H1 = qlc:keysort([2], [{r,1},{r,2},{r,3}]),
<a name="5449"/> 5449:           %% H1 is actually sorted, but this info is not captured.
<a name="5450"/> 5450:           Q = qlc:q([{X, Y} || {r,X} &lt;- H1,
<a name="5451"/> 5451:                                {Y} &lt;- [{0},{1},{2}],
<a name="5452"/> 5452:                                X == Y]),
<a name="5453"/> 5453:           {1,0,0,2} = join_info_count(Q),
<a name="5454"/> 5454:           [{1,1},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5455"/> 5455: 
<a name="5456"/> 5456:        &lt;&lt;&quot;%% Two leading constants columns and sorted objects
<a name="5457"/> 5457:           %% implies keysorted on column 3.
<a name="5458"/> 5458:           H1 = qlc:sort(qlc:q([{a,X,Y} || {X,Y} &lt;- [{1,2},{2,3},{3,3}]])),
<a name="5459"/> 5459:           H2 = qlc:q([{X,Y} || 
<a name="5460"/> 5460:                          {a,3,X} &lt;- H1,
<a name="5461"/> 5461:                          {a,2,Y} &lt;- H1,
<a name="5462"/> 5462:                          X =:= Y]),
<a name="5463"/> 5463:           {1,0,0,0} = join_info_count(H2),
<a name="5464"/> 5464:           [{3,3}] = qlc:e(H2)&quot;&gt;&gt;,
<a name="5465"/> 5465: 
<a name="5466"/> 5466:        &lt;&lt;&quot;QH = qlc:q([{X,Y} || {X,Y} &lt;- [{1,4},{1,3}],
<a name="5467"/> 5467:                                {Z} &lt;- [{1}],
<a name="5468"/> 5468:                                X =:= Z, (Y =:= 3) or (Y =:= 4)]),
<a name="5469"/> 5469:           {1,0,0,1} = join_info_count(QH),
<a name="5470"/> 5470:           [{1,4},{1,3}] = qlc:e(QH)&quot;&gt;&gt;,
<a name="5471"/> 5471: 
<a name="5472"/> 5472:        &lt;&lt;&quot;E = ets:new(join, [ordered_set]),
<a name="5473"/> 5473:           true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="5474"/> 5474:           Q = qlc:q([{X, Y} || {X,_} &lt;- ets:table(E), % no need to sort
<a name="5475"/> 5475:                                {Y} &lt;- [{0},{1},{2}],
<a name="5476"/> 5476:                                X == Y], {join,merge}),
<a name="5477"/> 5477:           {1,0,0,1} = join_info(Q),
<a name="5478"/> 5478:           [{1,1},{2,2}] = qlc:e(Q),
<a name="5479"/> 5479:           ets:delete(E)&quot;&gt;&gt;,
<a name="5480"/> 5480: 
<a name="5481"/> 5481:        &lt;&lt;&quot;H1 = qlc:sort([{r,1,a},{r,2,b},{r,3,c}]),
<a name="5482"/> 5482:           Q = qlc:q([{X, Y} || {r,X,_} &lt;- H1, % does not need keysort(3)
<a name="5483"/> 5483:                                {Y} &lt;- [{0},{1},{2}],
<a name="5484"/> 5484:                                X == Y]),
<a name="5485"/> 5485:           {1,0,0,1} = join_info(Q),
<a name="5486"/> 5486:           [{1,1},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5487"/> 5487: 
<a name="5488"/> 5488:        &lt;&lt;&quot;H1 = qlc:keysort(2,[{r,1},{r,2},{r,3}]),
<a name="5489"/> 5489:           H2 = [{a},{b}],
<a name="5490"/> 5490:           %% Several columns in different qualifiers have initial 
<a name="5491"/> 5491:           %% constant columns.
<a name="5492"/> 5492:           H3 = qlc:keysort(1,[{c1,c2,1},{foo,bar,2},{c1,c2,3},{c1,c2,2}]),
<a name="5493"/> 5493:           Q = qlc:q([{r,X,Y,Z} || {r,X} &lt;- H1,
<a name="5494"/> 5494:                                   {Y} &lt;- H2,
<a name="5495"/> 5495:                                   {c1,c2,Z} &lt;- H3,
<a name="5496"/> 5496:                                   X =:= Z], {join,merge}),
<a name="5497"/> 5497:           {1,0,0,3} = join_info(Q),
<a name="5498"/> 5498:           [{r,1,a,1},{r,1,b,1},{r,2,a,2},{r,2,b,2},{r,3,a,3},{r,3,b,3}] =
<a name="5499"/> 5499:               qlc:e(Q)&quot;&gt;&gt;,
<a name="5500"/> 5500: 
<a name="5501"/> 5501:        &lt;&lt;&quot;H1 = qlc:keysort(2,[{r,1},{r,2},{r,3}]),
<a name="5502"/> 5502:           H2 = [{a},{b}],
<a name="5503"/> 5503:           %% As the last one, but one keysort less.
<a name="5504"/> 5504:           H3 = qlc:keysort(3,[{c1,c2,1},{foo,bar,2},{c1,c2,3},{c1,c2,2}]),
<a name="5505"/> 5505:           Q = qlc:q([{r,X,Y,Z} || {r,X} &lt;- H1,
<a name="5506"/> 5506:                                   {Y} &lt;- H2,
<a name="5507"/> 5507:                                   {c1,c2,Z} &lt;- H3,
<a name="5508"/> 5508:                                   X =:= Z], {join,merge}),
<a name="5509"/> 5509:           {1,0,0,2} = join_info(Q),
<a name="5510"/> 5510:           [{r,1,a,1},{r,1,b,1},{r,2,a,2},{r,2,b,2},{r,3,a,3},{r,3,b,3}] =
<a name="5511"/> 5511:               qlc:e(Q)&quot;&gt;&gt;,
<a name="5512"/> 5512: 
<a name="5513"/> 5513:        &lt;&lt;&quot;H1 = qlc:keysort(2,[{r,1},{r,2},{r,3}]),
<a name="5514"/> 5514:           H2 = [{a},{b}],
<a name="5515"/> 5515:           H3 = qlc:keysort(1,[{c1,c2,1},{foo,bar,2},{c1,c2,3},{c1,c2,2}]),
<a name="5516"/> 5516:           %% One generator before the joined generators.
<a name="5517"/> 5517:           Q = qlc:q([{r,X,Y,Z} || {Y} &lt;- H2,
<a name="5518"/> 5518:                                   {r,X} &lt;- H1,
<a name="5519"/> 5519:                                   {c1,c2,Z} &lt;- H3,
<a name="5520"/> 5520:                                   X =:= Z], {join,merge}),
<a name="5521"/> 5521:           {1,0,0,3} = join_info(Q),
<a name="5522"/> 5522:           [{r,1,a,1},{r,2,a,2},{r,3,a,3},{r,1,b,1},{r,2,b,2},{r,3,b,3}] = 
<a name="5523"/> 5523:               qlc:e(Q)&quot;&gt;&gt;,
<a name="5524"/> 5524: 
<a name="5525"/> 5525:        &lt;&lt;&quot;H1 = [{a,1},{b,2},{c,3},{d,4}],
<a name="5526"/> 5526:           H2 = [{a},{b}],
<a name="5527"/> 5527:           H3 = [{c1,c2,a},{foo,bar,b},{c1,c2,c},{c1,c2,d}],
<a name="5528"/> 5528:           %% A couple of \&quot;extra\&quot; filters and generators.
<a name="5529"/> 5529:           Q = qlc:q([{X,Y,Z} || {X,_} &lt;- H1,
<a name="5530"/> 5530:                                 {Y} &lt;- H2,
<a name="5531"/> 5531:                                 X &gt; Y,
<a name="5532"/> 5532:                                 {c1,c2,Z} &lt;- H3,
<a name="5533"/> 5533:                                 {W} &lt;- [{a},{b}],
<a name="5534"/> 5534:                                 W &gt; a,
<a name="5535"/> 5535:                                 X =:= Z]),
<a name="5536"/> 5536:           {1,0,0,2} = join_info(Q),
<a name="5537"/> 5537:           [{c,a,c},{c,b,c},{d,a,d},{d,b,d}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5538"/> 5538: 
<a name="5539"/> 5539:        &lt;&lt;&quot;H1 = qlc:keysort(2,[{r,1},{r,2},{r,3}]),
<a name="5540"/> 5540:           H2 = qlc:sort([{c1,c2,1},{foo,bar,2},{c1,c2,3},{c1,c2,2}]),
<a name="5541"/> 5541:           %% H2 is sorted, no keysort necessary.
<a name="5542"/> 5542:           %% This example shows that the 'filter-part' of the pattern
<a name="5543"/> 5543:           %% ({c1,c2,Z}) should be evaluated _before_ the join.
<a name="5544"/> 5544:           %% Otherwise the objects cannot be assumed to be keysort:ed on the
<a name="5545"/> 5545:           %% third column (if merge join), and lookup-join would lookup
<a name="5546"/> 5546:           %% more keys than necessary.
<a name="5547"/> 5547:           Q = qlc:q([{r,X,Z} || {r,X} &lt;- H1,
<a name="5548"/> 5548:                                 {c1,c2,Z} &lt;- H2,
<a name="5549"/> 5549:                                 X =:= Z] ,{join,merge}),
<a name="5550"/> 5550:           {1,0,0,1} = join_info(Q),
<a name="5551"/> 5551:           [{r,1,1},{r,2,2},{r,3,3}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5552"/> 5552: 
<a name="5553"/> 5553:        &lt;&lt;&quot;H1 = [{1,a},{2,b},{3,c}],
<a name="5554"/> 5554:           H2 = [{0,0},{1,1},{2,2}],
<a name="5555"/> 5555:           H3 = qlc:q([{A,C,D} ||
<a name="5556"/> 5556:                          {A,_B} &lt;- H1,
<a name="5557"/> 5557:                          {C,D} &lt;- H2,
<a name="5558"/> 5558:                          A == D, C == D]),
<a name="5559"/> 5559:           H4 = [{1,1},{2,2},{3,3}],
<a name="5560"/> 5560:           H5 = qlc:q([{X,Y} ||
<a name="5561"/> 5561:                          {X,_,_} &lt;- H3, % no need to sort this one (merge join)
<a name="5562"/> 5562:                          {_,Y} &lt;- H4,
<a name="5563"/> 5563:                          X == Y]),
<a name="5564"/> 5564:           Q = qlc:q([{X,Y} ||
<a name="5565"/> 5565:                         {X,_} &lt;- H5, % no need to sort this one
<a name="5566"/> 5566:                         {Y,_} &lt;- H4,
<a name="5567"/> 5567:                         X == Y]),
<a name="5568"/> 5568:           {{3,0,0,4},{3,0,0,6}} = join_info(Q),
<a name="5569"/> 5569:           [{1,1},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5570"/> 5570: 
<a name="5571"/> 5571:        &lt;&lt;&quot;%% There is an extra test (_C1, element(1, X) =:= 1) that is not
<a name="5572"/> 5572:           %% necessary since the match spec does the same check. This can be
<a name="5573"/> 5573:           %% improved upon.
<a name="5574"/> 5574:           Q = qlc:q([{X,Y} ||
<a name="5575"/> 5575:                         X &lt;- [{2},{1}],
<a name="5576"/> 5576:                         element(1, X) =:= 1,
<a name="5577"/> 5577:                         Y=_ &lt;- [{2},{1}],
<a name="5578"/> 5578:                         element(1, X) =:= element(1, Y)]),
<a name="5579"/> 5579:           {qlc,_,
<a name="5580"/> 5580:               [{generate,_,{qlc,_,
<a name="5581"/> 5581:                               [{generate,_,{qlc,_,
<a name="5582"/> 5582:                                              [{generate,_,{list,{list,_},_}},
<a name="5583"/> 5583:                                               _C1],[]}},
<a name="5584"/> 5584:                                {generate,_,{qlc,_,
<a name="5585"/> 5585:                                              [{generate,_,{list,[{2},{1}]}},
<a name="5586"/> 5586:                                               _C2],[]}},_],
<a name="5587"/> 5587:                               [{join,merge}]}},_],[]} = i(Q),
<a name="5588"/> 5588:           {1,0,0,0} = join_info_count(Q),
<a name="5589"/> 5589:           [{{1},{1}}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="5590"/> 5590: 
<a name="5591"/> 5591:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="5592"/> 5592:                        L = [{a,b,a},{c,d,b},{1,2,a},{3,4,b}],
<a name="5593"/> 5593:                        Q = qlc:q([P1 || {X,2,Z}=P1 &lt;- ets:table(E), 
<a name="5594"/> 5594:                                         Y &lt;- L,
<a name="5595"/> 5595:                                         X =:= 1,
<a name="5596"/> 5596:                                         Z =:= a,
<a name="5597"/> 5597:                                         P1 =:= Y, 
<a name="5598"/> 5598:                                         X =:= element(1, Y)]),
<a name="5599"/> 5599:                        {1,0,0,0} = join_info_count(Q),
<a name="5600"/> 5600:                        [{1,2,a}] = qlc:e(Q)
<a name="5601"/> 5601:                end, [{1,2,a},{3,4,b}])&quot;&gt;&gt;,
<a name="5602"/> 5602: 
<a name="5603"/> 5603:        %% Merge join on Z and element(3, Y). No need to sort!
<a name="5604"/> 5604:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="5605"/> 5605:                        L = [{a,b,a},{c,d,b},{1,2,a},{3,4,b}],
<a name="5606"/> 5606:                        Q = qlc:q([P1 || {X,2,Z}=P1 &lt;- ets:table(E), 
<a name="5607"/> 5607:                                         Y &lt;- L,
<a name="5608"/> 5608:                                         (X =:= 1) or (X =:= 2),
<a name="5609"/> 5609:                                         Z =:= a,
<a name="5610"/> 5610:                                         P1 =:= Y, 
<a name="5611"/> 5611:                                         X =:= element(1, Y)]),
<a name="5612"/> 5612:                        {1,0,0,0} = join_info_count(Q),
<a name="5613"/> 5613:                        [{1,2,a}] = qlc:e(Q)
<a name="5614"/> 5614:                end, [{1,2,a},{3,4,b}])&quot;&gt;&gt;,
<a name="5615"/> 5615: 
<a name="5616"/> 5616:        &lt;&lt;&quot;%% Y is constant as well as X. No keysort, which means that
<a name="5617"/> 5617:           %% Y must be filtered before merge join.
<a name="5618"/> 5618:           etsc(fun(E) -&gt;
<a name="5619"/> 5619:                        Q = qlc:q([X || {1,2}=X &lt;- ets:table(E), 
<a name="5620"/> 5620:                                        Y &lt;- [{a,b},{c,d},{1,2},{3,4}], 
<a name="5621"/> 5621:                                        X =:= Y, 
<a name="5622"/> 5622:                                        element(1, X) =:= element(1, Y)]),
<a name="5623"/> 5623:                        {1,0,0,0} = join_info_count(Q),
<a name="5624"/> 5624:                        [{1,2}] = qlc:e(Q)
<a name="5625"/> 5625:                end, [{1,2},{3,4}])&quot;&gt;&gt;
<a name="5626"/> 5626: 
<a name="5627"/> 5627:          ],
<a name="5628"/> 5628:     run(Config, Ts),
<a name="join_sort-last_expr"/><a name="5629"/> 5629:     ok.
<a name="5630"/> 5630: 
<a name="5631"/> 5631: <i>%% Join of more than two columns.</i>
<a name="join_complex-1"/><a name="5632"/> 5632: <b>join_complex</b>(Config) when is_list(Config) -&gt;
<a name="5633"/> 5633:     Ts = [{three,
<a name="5634"/> 5634:            &lt;&lt;&quot;three() -&gt;
<a name="5635"/> 5635:                   L = [],
<a name="5636"/> 5636:                   Q = qlc:q([{X,Y,Z} || {X,_} &lt;- L,
<a name="5637"/> 5637:                                         {_,Y} &lt;- L,
<a name="5638"/> 5638:                                         {Z,_} &lt;- L,
<a name="5639"/> 5639:                                         X =:= Y, Y == Z
<a name="5640"/> 5640:                                      ]),
<a name="5641"/> 5641:                   qlc:e(Q).&quot;&gt;&gt;,
<a name="5642"/> 5642:            [],
<a name="5643"/> 5643:            {warnings,[{{3,23},qlc,too_complex_join}]}},
<a name="5644"/> 5644: 
<a name="5645"/> 5645:           {two,
<a name="5646"/> 5646:            &lt;&lt;&quot;two() -&gt;
<a name="5647"/> 5647:                   Q = qlc:q([{X,Y,Z,W} || 
<a name="5648"/> 5648:                       {X} &lt;- [], 
<a name="5649"/> 5649:                       {Y} &lt;- [], 
<a name="5650"/> 5650:                       {Z} &lt;- [], 
<a name="5651"/> 5651:                       {W} &lt;- [], 
<a name="5652"/> 5652:                       X =:= Y, 
<a name="5653"/> 5653:                       Z =:= W],{join,merge}),
<a name="5654"/> 5654:                   qlc:e(Q).&quot;&gt;&gt;,
<a name="5655"/> 5655:            [],
<a name="5656"/> 5656:            {warnings,[{{2,23},qlc,too_many_joins}]}},
<a name="5657"/> 5657: 
<a name="5658"/> 5658:           {two_again,
<a name="5659"/> 5659:            &lt;&lt;&quot;two() -&gt;
<a name="5660"/> 5660:                   Q = qlc:q([{X,Y,Z,W} ||
<a name="5661"/> 5661:                       {X} &lt;- [],
<a name="5662"/> 5662:                       {Y} &lt;- [],
<a name="5663"/> 5663:                       {Z} &lt;- [],
<a name="5664"/> 5664:                       {W} &lt;- [],
<a name="5665"/> 5665:                       X =:= Y,
<a name="5666"/> 5666:                       Z =:= W],{join,merge}),
<a name="5667"/> 5667:                   qlc:e(Q).&quot;&gt;&gt;,
<a name="5668"/> 5668:            [{error_location, line}],
<a name="5669"/> 5669:            {warnings,[{2,qlc,too_many_joins}]}}
<a name="5670"/> 5670:        ],
<a name="5671"/> 5671: 
<a name="5672"/> 5672:     compile(Config, Ts),
<a name="5673"/> 5673: 
<a name="5674"/> 5674:     Ts2 = [{three,
<a name="5675"/> 5675:             &lt;&lt;&quot;three() -&gt;
<a name="5676"/> 5676:                   L = [],
<a name="5677"/> 5677:                   Q = qlc:q([{X,Y,Z} || {X,_} &lt;- L,
<a name="5678"/> 5678:                                         {_,Y} &lt;- L,
<a name="5679"/> 5679:                                         {Z,_} &lt;- L,
<a name="5680"/> 5680:                                         X =:= Y, Y == Z
<a name="5681"/> 5681:                                      ]),
<a name="5682"/> 5682:                   qlc:e(Q).&quot;&gt;&gt;,
<a name="5683"/> 5683:             [],
<a name="5684"/> 5684:             {[],
<a name="5685"/> 5685:              [&quot;cannot handle join of three or more generators efficiently&quot;]}},
<a name="5686"/> 5686: 
<a name="5687"/> 5687:           {two,
<a name="5688"/> 5688:            &lt;&lt;&quot;two() -&gt;
<a name="5689"/> 5689:                   Q = qlc:q([{X,Y,Z,W} || 
<a name="5690"/> 5690:                       {X} &lt;- [], 
<a name="5691"/> 5691:                       {Y} &lt;- [], 
<a name="5692"/> 5692:                       {Z} &lt;- [], 
<a name="5693"/> 5693:                       {W} &lt;- [], 
<a name="5694"/> 5694:                       X =:= Y, 
<a name="5695"/> 5695:                       Z =:= W],{join,merge}),
<a name="5696"/> 5696:                   qlc:e(Q).&quot;&gt;&gt;,
<a name="5697"/> 5697:            [],
<a name="5698"/> 5698:            {[],[&quot;cannot handle more than one join efficiently&quot;]}}
<a name="5699"/> 5699:        ],
<a name="5700"/> 5700: 
<a name="5701"/> 5701:     compile_format(Config, Ts2),
<a name="5702"/> 5702: 
<a name="join_complex-last_expr"/><a name="5703"/> 5703:     ok.
<a name="5704"/> 5704: 
<a name="5705"/> 5705: 
<a name="5706"/> 5706: <i>%% OTP-5644. Handle the new language element M:F/A.</i>
<a name="otp_5644-1"/><a name="5707"/> 5707: <b>otp_5644</b>(Config) when is_list(Config) -&gt;
<a name="5708"/> 5708:     Ts = [
<a name="5709"/> 5709:        &lt;&lt;&quot;Q = qlc:q([fun modul:mfa/0 || _ &lt;- [1,2], 
<a name="5710"/> 5710:                                         is_function(fun modul:mfa/0, 0)]),
<a name="5711"/> 5711:           [_,_] = qlc:eval(Q)&quot;&gt;&gt;
<a name="5712"/> 5712:        ],
<a name="5713"/> 5713:     
<a name="5714"/> 5714:     run(Config, Ts),
<a name="otp_5644-last_expr"/><a name="5715"/> 5715:     ok.
<a name="5716"/> 5716: 
<a name="5717"/> 5717: <i>%% OTP-5195. Allow traverse functions returning terms.</i>
<a name="otp_5195-1"/><a name="5718"/> 5718: <b>otp_5195</b>(Config) when is_list(Config) -&gt;
<a name="5719"/> 5719:     %% Several minor improvements have been implemented in OTP-5195.
<a name="5720"/> 5720:     %% The test cases are spread all over... except these.
<a name="5721"/> 5721:     %%
<a name="5722"/> 5722:     %% Traverse functions returning terms.
<a name="5723"/> 5723: 
<a name="5724"/> 5724:     Ts = [&lt;&lt;&quot;L = [1,2,3],
<a name="5725"/> 5725:              Err = {error,modul,err},
<a name="5726"/> 5726:              H = qlc:q([X || X &lt;- qlc_SUITE:table_error(L, Err)]),
<a name="5727"/> 5727:              Err = qlc:e(H)&quot;&gt;&gt;,
<a name="5728"/> 5728: 
<a name="5729"/> 5729:           &lt;&lt;&quot;Err = {error,modul,err},
<a name="5730"/> 5730:              TravFun = fun() -&gt; Err end,
<a name="5731"/> 5731:              H1 = qlc:sort(qlc:q([X || X &lt;- qlc:table(TravFun, [])])),
<a name="5732"/> 5732:              H = qlc:q([{X} || X &lt;- H1]),
<a name="5733"/> 5733:              Err = qlc:e(H)&quot;&gt;&gt;,
<a name="5734"/> 5734: 
<a name="5735"/> 5735:           &lt;&lt;&quot;L = [1,2,3],
<a name="5736"/> 5736:              Err = {error,modul,err},
<a name="5737"/> 5737:              H = qlc:q([X || X &lt;- qlc_SUITE:table_error(L, Err)]),
<a name="5738"/> 5738:              C = qlc:cursor(H),
<a name="5739"/> 5739:              R = qlc:next_answers(C, all_remaining),
<a name="5740"/> 5740:              qlc:delete_cursor(C),
<a name="5741"/> 5741:              Err = R&quot;&gt;&gt;,
<a name="5742"/> 5742: 
<a name="5743"/> 5743:           &lt;&lt;&quot;L = [1,2,3],
<a name="5744"/> 5744:              Err = {error,modul,err},
<a name="5745"/> 5745:              H = qlc:q([X || X &lt;- qlc_SUITE:table_error(L, Err)]),
<a name="5746"/> 5746:              F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="5747"/> 5747:              Err = qlc:fold(F, [], H)&quot;&gt;&gt;,
<a name="5748"/> 5748: 
<a name="5749"/> 5749:           &lt;&lt;&quot;Err = {error,modul,err},
<a name="5750"/> 5750:              TravFun = fun() -&gt; Err end,
<a name="5751"/> 5751:              H1 = qlc:sort(qlc:q([X || X &lt;- qlc:table(TravFun, [])])),
<a name="5752"/> 5752:              H = qlc:q([{X} || X &lt;- H1]),
<a name="5753"/> 5753:              F = fun(Obj, A) -&gt; A++[Obj] end,
<a name="5754"/> 5754:              Err = qlc:fold(F, [], H)&quot;&gt;&gt;,
<a name="5755"/> 5755: 
<a name="5756"/> 5756:           &lt;&lt;&quot;Q1 = qlc:append([qlc:append([ugly()]),[3]]),
<a name="5757"/> 5757:              Q = qlc:q([X || X &lt;- Q1]),
<a name="5758"/> 5758:              42 = qlc:e(Q),
<a name="5759"/> 5759:              ok.
<a name="5760"/> 5760: 
<a name="5761"/> 5761:              ugly() -&gt;
<a name="5762"/> 5762:                  [apa | fun() -&gt; 42 end].
<a name="5763"/> 5763:              foo() -&gt; bar&quot;&gt;&gt;,
<a name="5764"/> 5764: 
<a name="5765"/> 5765:           &lt;&lt;&quot;L = [1,2,3],
<a name="5766"/> 5766:              Err = {error,modul,err},
<a name="5767"/> 5767:              H = qlc:q([X || X &lt;- qlc_SUITE:table_error(L, Err)]),
<a name="5768"/> 5768:              H1 = qlc:q([X || X &lt;- H], unique),
<a name="5769"/> 5769:              Err = qlc:e(H1)&quot;&gt;&gt;,
<a name="5770"/> 5770: 
<a name="5771"/> 5771:           &lt;&lt;&quot;Err = {error, module, err},
<a name="5772"/> 5772:              L = [1,2,3],
<a name="5773"/> 5773:              H1 = qlc:q([{X} || X &lt;- qlc_SUITE:table_error(L, Err)]),
<a name="5774"/> 5774:              H = qlc:q([{X,Y,Z} || X &lt;- H1, Y &lt;- H1, Z &lt;- L], cache),
<a name="5775"/> 5775:              qlc:e(H, cache_all)&quot;&gt;&gt;,
<a name="5776"/> 5776: 
<a name="5777"/> 5777:           &lt;&lt;&quot;Err = {error, module, err},
<a name="5778"/> 5778:              L = [1,2,3],
<a name="5779"/> 5779:              H1 = qlc:q([X || X &lt;- qlc_SUITE:table_error(L, Err)]),
<a name="5780"/> 5780:              H = qlc:q([{X,Y,Z} || X &lt;- H1, Y &lt;- H1, Z &lt;- L], cache),
<a name="5781"/> 5781:              qlc:e(H, [cache_all,unique_all])&quot;&gt;&gt;,
<a name="5782"/> 5782: 
<a name="5783"/> 5783:           &lt;&lt;&quot;L = [{1},{2},{3}],
<a name="5784"/> 5784:              H = qlc:q([X || {X} &lt;- qlc_SUITE:table_lookup_error(L), 
<a name="5785"/> 5785:                              X =:= 2]),
<a name="5786"/> 5786:              {error, lookup, failed} = qlc:e(H)&quot;&gt;&gt;,
<a name="5787"/> 5787: 
<a name="5788"/> 5788:           %% The traverse function can return any value, but it must not
<a name="5789"/> 5789:           %% return an improper list. Improper lists must not be given anyway.
<a name="5790"/> 5790:           &lt;&lt;&quot;{'EXIT', {{badfun,a},_}} =
<a name="5791"/> 5791:              (catch qlc:e(qlc:q([{X} || X &lt;- [1 | a], begin true end])))&quot;&gt;&gt;
<a name="5792"/> 5792: 
<a name="5793"/> 5793:        ],
<a name="5794"/> 5794:     
<a name="5795"/> 5795:     run(Config, Ts),
<a name="5796"/> 5796: 
<a name="5797"/> 5797:     Ts2 = [&lt;&lt;&quot;Q = qlc:q([{X,Y} || {X} &lt;- [{1},{2},{3}],
<a name="5798"/> 5798:                                   begin
<a name="5799"/> 5799:                                       %% Used to generate a badly formed file
<a name="5800"/> 5800:                                       Y = 3, true
<a name="5801"/> 5801:                                   end,
<a name="5802"/> 5802:                                   X =:= Y]),
<a name="5803"/> 5803:               [{3,3}] = qlc:e(Q)&quot;&gt;&gt;],
<a name="5804"/> 5804:     run(Config, Ts2),
<a name="5805"/> 5805: 
<a name="otp_5195-last_expr"/><a name="5806"/> 5806:     ok.
<a name="5807"/> 5807: 
<a name="5808"/> 5808: <i>%% OTP-6038. Bug fixes: unique and keysort; cache.</i>
<a name="otp_6038_bug-1"/><a name="5809"/> 5809: <b>otp_6038_bug</b>(Config) when is_list(Config) -&gt;
<a name="5810"/> 5810:     %% The 'unique' option can no longer be merged with the keysort options.
<a name="5811"/> 5811:     %% This used to return [{1,a},{1,c},{2,b},{2,d}], but since 
<a name="5812"/> 5812:     %% file_sorter:keysort now removes duplicates based on keys, the
<a name="5813"/> 5813:     %% correct return value is [{1,a},{2,b}].
<a name="5814"/> 5814:     Ts = [&lt;&lt;&quot;H1 = qlc:q([X || X &lt;- [{1,a},{2,b},{1,c},{2,d}]], unique),
<a name="5815"/> 5815:              H2 = qlc:keysort(1, H1, [{unique,true}]),
<a name="5816"/> 5816:              [{1,a},{2,b}] = qlc:e(H2)&quot;&gt;&gt;],
<a name="5817"/> 5817: 
<a name="5818"/> 5818:     run(Config, Ts),
<a name="5819"/> 5819:     
<a name="5820"/> 5820:     %% Sometimes the cache options did not empty the correct tables.
<a name="5821"/> 5821:     CTs = [
<a name="5822"/> 5822:        &lt;&lt;&quot;Options = [cache,unique],
<a name="5823"/> 5823:           V1 = qlc:q([{X,Y} || X &lt;- [1,2], Y &lt;- [3]], Options),
<a name="5824"/> 5824:           V2 = qlc:q([{X,Y} || X &lt;- [a,b], Y &lt;- V1]),
<a name="5825"/> 5825:           V3 = qlc:q([{X,Y} || X &lt;- [5,6], Y &lt;- [7]], Options),
<a name="5826"/> 5826:           Q = qlc:q([{X,Y} || X &lt;- V2, Y &lt;- V3]),
<a name="5827"/> 5827:           R = qlc:e(Q),
<a name="5828"/> 5828:           L1 = [{X,Y} || X &lt;- [1,2], Y &lt;- [3]],
<a name="5829"/> 5829:           L2 = [{X,Y} || X &lt;- [a,b], Y &lt;- L1],
<a name="5830"/> 5830:           L3 = [{X,Y} || X &lt;- [5,6], Y &lt;- [7]],
<a name="5831"/> 5831:           L = [{X,Y} || X &lt;- L2, Y &lt;- L3],
<a name="5832"/> 5832:           true = R =:= L&quot;&gt;&gt;,
<a name="5833"/> 5833:        &lt;&lt;&quot;Options = [cache,unique],
<a name="5834"/> 5834:           V1 = qlc:q([{X,Y} || X &lt;- [1,2], Y &lt;- [3]], Options),
<a name="5835"/> 5835:           V2 = qlc:q([{X,Y} || X &lt;- [a,b], Y &lt;- V1]),
<a name="5836"/> 5836:           V3 = qlc:q([{X,Y} || X &lt;- [5,6], Y &lt;- [7]], Options),
<a name="5837"/> 5837:           V4 = qlc:q([{X,Y} || X &lt;- V2, Y &lt;- V3], Options),
<a name="5838"/> 5838:           Q = qlc:q([{X,Y} || X &lt;- [1,2], Y &lt;- V4]),
<a name="5839"/> 5839:           R = qlc:e(Q),
<a name="5840"/> 5840:           L1 = [{X,Y} || X &lt;- [1,2], Y &lt;- [3]],
<a name="5841"/> 5841:           L2 = [{X,Y} || X &lt;- [a,b], Y &lt;- L1],
<a name="5842"/> 5842:           L3 = [{X,Y} || X &lt;- [5,6], Y &lt;- [7]],
<a name="5843"/> 5843:           L4 = [{X,Y} || X &lt;- L2, Y &lt;- L3],
<a name="5844"/> 5844:           L = [{X,Y} || X &lt;- [1,2], Y &lt;- L4],
<a name="5845"/> 5845:           true = R =:= L&quot;&gt;&gt;
<a name="5846"/> 5846:        ],
<a name="5847"/> 5847:     run(Config, CTs),
<a name="5848"/> 5848: 
<a name="otp_6038_bug-last_expr"/><a name="5849"/> 5849:     ok.
<a name="5850"/> 5850: 
<a name="5851"/> 5851: <i>%% OTP-6359. dets:select() never returns the empty list.</i>
<a name="otp_6359-1"/><a name="5852"/> 5852: <b>otp_6359</b>(Config) when is_list(Config) -&gt;
<a name="5853"/> 5853:     dets:start(),
<a name="5854"/> 5854:     T = luna,
<a name="5855"/> 5855:     Fname = filename(T, Config),
<a name="5856"/> 5856: 
<a name="5857"/> 5857:     Ts = [
<a name="5858"/> 5858:        [&lt;&lt;&quot;T = luna, Fname = \&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;,
<a name="5859"/> 5859:            {ok, _} = dets:open_file(T, [{file,Fname}]),
<a name="5860"/> 5860:            Q = qlc:q([F || 
<a name="5861"/> 5861:                          F &lt;- dets:table(T), 
<a name="5862"/> 5862:                          (F band ((1 bsl 0)) =/= 0), 
<a name="5863"/> 5863:                          true]),
<a name="5864"/> 5864:            [] = qlc:eval(Q),
<a name="5865"/> 5865:            ok = dets:close(T),
<a name="5866"/> 5866:            file:delete(\&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;),
<a name="5867"/> 5867:            ok&quot;&gt;&gt;]
<a name="5868"/> 5868:     ],
<a name="5869"/> 5869: 
<a name="5870"/> 5870:     run(Config, Ts),
<a name="otp_6359-last_expr"/><a name="5871"/> 5871:     ok.
<a name="5872"/> 5872: 
<a name="5873"/> 5873: <i>%% OTP-6562. compressed = false (should be []) when sorting before join.</i>
<a name="otp_6562-1"/><a name="5874"/> 5874: <b>otp_6562</b>(Config) when is_list(Config) -&gt;
<a name="5875"/> 5875:     Bug = [
<a name="5876"/> 5876:       %% This example uses a file to sort E2 on the second column. It is
<a name="5877"/> 5877:       %% not easy to verify that this happens; the file_sorter module's
<a name="5878"/> 5878:       %% size option cannot be set in this case. But it is not likely
<a name="5879"/> 5879:       %% that the default size (512 KiB) will ever change, so it should
<a name="5880"/> 5880:       %% be future safe.
<a name="5881"/> 5881:       &lt;&lt;&quot;E1 = create_ets(1, 10),
<a name="5882"/> 5882:          E2 = create_ets(5, 150000),
<a name="5883"/> 5883:          Q = qlc:q([{XX,YY} ||
<a name="5884"/> 5884:                        {X,XX} &lt;- ets:table(E1),
<a name="5885"/> 5885:                        {YY,Y} &lt;- ets:table(E2),
<a name="5886"/> 5886:                        X == Y],
<a name="5887"/> 5887:                    {join,merge}),
<a name="5888"/> 5888:          [{5,5},{6,6},{7,7},{8,8},{9,9},{10,10}] = qlc:e(Q),
<a name="5889"/> 5889:          ets:delete(E1),
<a name="5890"/> 5890:          ets:delete(E2)&quot;&gt;&gt;
<a name="5891"/> 5891:     ],
<a name="5892"/> 5892:     run(Config, Bug),
<a name="5893"/> 5893: 
<a name="5894"/> 5894:     Bits = [
<a name="5895"/> 5895:        {otp_6562_1,
<a name="5896"/> 5896:         &lt;&lt;&quot;otp_6562_1() -&gt;
<a name="5897"/> 5897:                Q = qlc:q([X || &lt;&lt;X:8&gt;&gt; &lt;= &lt;&lt;\&quot;hej\&quot;&gt;&gt;]),
<a name="5898"/> 5898:                qlc:info(Q).
<a name="5899"/> 5899:         &quot;&gt;&gt;,
<a name="5900"/> 5900:         [],
<a name="5901"/> 5901:         {errors,[{{2,40},qlc,binary_generator}],
<a name="5902"/> 5902:          []}}
<a name="5903"/> 5903:        ],
<a name="5904"/> 5904:     [] = compile(Config, Bits),
<a name="5905"/> 5905: 
<a name="5906"/> 5906:     R1 = {error,qlc,{1,qlc,binary_generator}}
<a name="5907"/> 5907:              = qlc:string_to_handle(&quot;[X || &lt;&lt;X:8&gt;&gt; &lt;= &lt;&lt;\&quot;hej\&quot;&gt;&gt;].&quot;),
<a name="5908"/> 5908:     &quot;1: cannot handle binary generators\n&quot; =
<a name="5909"/> 5909:              lists:flatten(qlc:format_error(R1)),
<a name="5910"/> 5910: 
<a name="otp_6562-last_expr"/><a name="5911"/> 5911:     ok.
<a name="5912"/> 5912: 
<a name="5913"/> 5913: <i>%% OTP-6590. Bug fix (join info).</i>
<a name="otp_6590-1"/><a name="5914"/> 5914: <b>otp_6590</b>(Config) when is_list(Config) -&gt;
<a name="5915"/> 5915:     Ts = [&lt;&lt;&quot;fun(Tab1Value) -&gt; 
<a name="5916"/> 5916:                     Q = qlc:q([T1#tab1.id || T1 &lt;- [#tab1{id = id1,
<a name="5917"/> 5917:                                                           value = v, 
<a name="5918"/> 5918:                                                           tab2_id = id}],
<a name="5919"/> 5919:                                              T2 &lt;- [#tab2{id = id}],
<a name="5920"/> 5920:                                              T1#tab1.value =:= Tab1Value,
<a name="5921"/> 5921:                                              T1#tab1.tab2_id =:= T2#tab2.id]),
<a name="5922"/> 5922:                     [id1] = qlc:e(Q)
<a name="5923"/> 5923:             end(v)&quot;&gt;&gt;],
<a name="5924"/> 5924: 
<a name="5925"/> 5925:     run(Config, &lt;&lt;&quot;-record(tab1, {id, tab2_id, value}).
<a name="5926"/> 5926:                          -record(tab2, {id, value}).\n&quot;&gt;&gt;, Ts),
<a name="otp_6590-last_expr"/><a name="5927"/> 5927:     ok.
<a name="5928"/> 5928: 
<a name="5929"/> 5929: <i>%% OTP-6673. Optimizations and fixes.</i>
<a name="otp_6673-1"/><a name="5930"/> 5930: <b>otp_6673</b>(Config) when is_list(Config) -&gt;
<a name="5931"/> 5931:     Ts_PT = 
<a name="5932"/> 5932:         [&lt;&lt;&quot;etsc(fun(E1) -&gt;
<a name="5933"/> 5933:                 etsc(fun(E2) -&gt;
<a name="5934"/> 5934:                        Q = qlc:q([{A,B,C,D} || 
<a name="5935"/> 5935:                                      {A,B} &lt;- ets:table(E1),
<a name="5936"/> 5936:                                      {C,D} &lt;- ets:table(E2),
<a name="5937"/> 5937:                                      A =:= 2, % lookup
<a name="5938"/> 5938:                                      B =:= D, % join
<a name="5939"/> 5939:                                      C =:= g]), % lookup invalidated by join
<a name="5940"/> 5940:                        {qlc,_,[{generate,_,
<a name="5941"/> 5941:                                 {qlc,_,
<a name="5942"/> 5942:                                  [{generate,_,
<a name="5943"/> 5943:                                    {qlc,_,[{generate,_,
<a name="5944"/> 5944:                                             {keysort,
<a name="5945"/> 5945:                                              {list,{table,_},
<a name="5946"/> 5946:                                               [{{'$1','$2'},[],['$_']}]},
<a name="5947"/> 5947:                                              2,[]}},_],[]}},
<a name="5948"/> 5948:                                   {generate,_,{qlc,_,
<a name="5949"/> 5949:                                     [{generate,_,
<a name="5950"/> 5950:                                       {keysort,{table,_},2,[]}}],
<a name="5951"/> 5951:                                     []}},_],
<a name="5952"/> 5952:                                  [{join,merge}]}},_,_],[]} = i(Q),
<a name="5953"/> 5953:                        [{2,y,g,y}] = qlc:e(Q)
<a name="5954"/> 5954:                      end, [{f,x},{g,y},{h,z}])
<a name="5955"/> 5955:                  end, 
<a name="5956"/> 5956:                  [{1,x},{2,y},{3,z}])&quot;&gt;&gt;,
<a name="5957"/> 5957:          &lt;&lt;&quot;etsc(fun(E1) -&gt;
<a name="5958"/> 5958:                 etsc(fun(E2) -&gt;
<a name="5959"/> 5959:                        Q = qlc:q([{A,B,C,D} || 
<a name="5960"/> 5960:                                      {A,B} &lt;- ets:table(E1),
<a name="5961"/> 5961:                                      {C,D} &lt;- ets:table(E2),
<a name="5962"/> 5962:                                      A =:= 2, % lookup
<a name="5963"/> 5963:                                      C =:= g, % lookup
<a name="5964"/> 5964:                                      B =:= D]), % join
<a name="5965"/> 5965:                        {qlc,_,[{generate,_,
<a name="5966"/> 5966:                                 {qlc,_,
<a name="5967"/> 5967:                                  [{generate,_,
<a name="5968"/> 5968:                                    {qlc,_,[{generate,_,
<a name="5969"/> 5969:                                             {keysort,
<a name="5970"/> 5970:                                              {list,{table,_},
<a name="5971"/> 5971:                                               [{{'$1','$2'},[],['$_']}]},
<a name="5972"/> 5972:                                              2,[]}},_],[]}},
<a name="5973"/> 5973:                                   {generate,_,{qlc,_,
<a name="5974"/> 5974:                                                [{generate,_,
<a name="5975"/> 5975:                                                  {keysort,
<a name="5976"/> 5976:                                                   {list,{table,_},
<a name="5977"/> 5977:                                                    [{{'$1','$2'},[],['$_']}]},
<a name="5978"/> 5978:                                                   2,[]}},_],[]}},_],
<a name="5979"/> 5979:                                  [{join,merge}]}},_],[]} = i(Q),
<a name="5980"/> 5980:                        [{2,y,g,y}] = qlc:e(Q)
<a name="5981"/> 5981:                      end, [{f,x},{g,y},{h,z}])
<a name="5982"/> 5982:                  end, 
<a name="5983"/> 5983:                  [{1,x},{2,y},{3,z}])&quot;&gt;&gt;],
<a name="5984"/> 5984: 
<a name="5985"/> 5985:     run(Config, Ts_PT),
<a name="5986"/> 5986: 
<a name="5987"/> 5987:     MS = ets:fun2ms(fun({X,_Y}=T) when X &gt; 1 -&gt; T end),
<a name="5988"/> 5988:     Ts_RT = [
<a name="5989"/> 5989:         [&lt;&lt;&quot;%% Explicit match-spec. ets:table() ensures there is no lookup
<a name="5990"/> 5990:             %% function, which means that lookup join will not be considered.
<a name="5991"/> 5991:             MS = &quot;&gt;&gt;, io_lib:format(&quot;~w&quot;, [MS]), &lt;&lt;&quot;,
<a name="5992"/> 5992:             etsc(fun(E) -&gt;
<a name="5993"/> 5993:                          F = fun(J) -&gt;
<a name="5994"/> 5994:                                    qlc:q([{X,W} ||
<a name="5995"/> 5995:                                              {X,_Y} &lt;- 
<a name="5996"/> 5996:                                                  ets:table(E,{traverse,
<a name="5997"/> 5997:                                                               {select,MS}}),
<a name="5998"/> 5998:                                              {Z,W} &lt;- [{1,1},{2,2},{3,3}],
<a name="5999"/> 5999:                                              X =:= Z], {join,J})
<a name="6000"/> 6000:                              end,
<a name="6001"/> 6001:                          Qm = F(any),
<a name="6002"/> 6002:                          [{2,2},{3,3}] = qlc:e(Qm),
<a name="6003"/> 6003:                          {'EXIT',{cannot_carry_out_join,_}} = 
<a name="6004"/> 6004:                              (catch qlc:e(F(lookup)))
<a name="6005"/> 6005:                  end, [{1,a},{2,b},{3,c}])&quot;&gt;&gt;],
<a name="6006"/> 6006: 
<a name="6007"/> 6007:          &lt;&lt;&quot;%% The filter 'A =&lt; y' can be evaluated by traversing E1 using a
<a name="6008"/> 6008:             %% match specification, but then lookup join cannot use E1 for
<a name="6009"/> 6009:             %% looking up keys. This example shows that the filter is kept if
<a name="6010"/> 6010:             %% lookup join is employed (otherwise it is optimized away since
<a name="6011"/> 6011:             %% the match spec is used).
<a name="6012"/> 6012:             etsc(fun(E1) -&gt;
<a name="6013"/> 6013:                          Q = qlc:q([{A,B,C,D} || 
<a name="6014"/> 6014:                                        {A,B} &lt;- ets:table(E1),
<a name="6015"/> 6015:                                        {C,D} &lt;- [{x,f},{y,g},{z,h}],
<a name="6016"/> 6016:                                        A =&lt; y, % kept
<a name="6017"/> 6017:                                        A =:= C], {join,lookup}),
<a name="6018"/> 6018:                          [{x,1,x,f},{y,2,y,g}] = lists:sort(qlc:e(Q))
<a name="6019"/> 6019:                  end, [{x,1},{y,2},{z,3}])&quot;&gt;&gt;
<a name="6020"/> 6020: 
<a name="6021"/> 6021:     ],
<a name="6022"/> 6022:     run(Config, Ts_RT),
<a name="6023"/> 6023: 
<a name="otp_6673-last_expr"/><a name="6024"/> 6024:     ok.
<a name="6025"/> 6025: 
<a name="6026"/> 6026: <i>%% OTP-6964. New option 'tmpdir_usage'.</i>
<a name="otp_6964-1"/><a name="6027"/> 6027: <b>otp_6964</b>(Config) when is_list(Config) -&gt;
<a name="6028"/> 6028:     T1 = [
<a name="6029"/> 6029:        &lt;&lt;&quot;Q1 = qlc:q([{X} || X &lt;- [1,2]]),
<a name="6030"/> 6030:           {'EXIT', {badarg,_}} = (catch qlc:e(Q1, {tmpdir_usage,bad})),
<a name="6031"/> 6031:           %% merge join
<a name="6032"/> 6032:           F = fun(Use) -&gt;
<a name="6033"/> 6033:                       L1 = [{Y,a} || Y &lt;- lists:seq(1, 2)],
<a name="6034"/> 6034:                       L2 = [{a,Y} || Y &lt;- lists:seq(1, 10000)],
<a name="6035"/> 6035:                       Q = qlc:q([{XX,YY} ||
<a name="6036"/> 6036:                                     {XX,X} &lt;- L1,
<a name="6037"/> 6037:                                     {Y,YY} &lt;- L2,
<a name="6038"/> 6038:                                     X == Y],
<a name="6039"/> 6039:                                 {join,merge}),
<a name="6040"/> 6040:                       qlc:e(Q, [{max_list_size,64*1024},{tmpdir_usage,Use}])
<a name="6041"/> 6041:               end,
<a name="6042"/> 6042:           D = erlang:system_flag(backtrace_depth, 0),
<a name="6043"/> 6043:       try
<a name="6044"/> 6044:           20000 = length(F(allowed)),
<a name="6045"/> 6045:           ErrReply = F(not_allowed),
<a name="6046"/> 6046:           {error, qlc, {tmpdir_usage,joining}} = ErrReply,
<a name="6047"/> 6047:           \&quot;temporary file was needed for joining\n\&quot; = 
<a name="6048"/> 6048:               lists:flatten(qlc:format_error(ErrReply)),
<a name="6049"/> 6049:           qlc_SUITE:install_error_logger(),
<a name="6050"/> 6050:           20000 = length(F(warning_msg)),
<a name="6051"/> 6051:           {warning, joining} = qlc_SUITE:read_error_logger(),
<a name="6052"/> 6052:           20000 = length(F(info_msg)),
<a name="6053"/> 6053:           {info, joining} = qlc_SUITE:read_error_logger(),
<a name="6054"/> 6054:           20000 = length(F(error_msg)),
<a name="6055"/> 6055:           {error, joining} = qlc_SUITE:read_error_logger()
<a name="6056"/> 6056:       after
<a name="6057"/> 6057:           _ = erlang:system_flag(backtrace_depth, D)
<a name="6058"/> 6058:       end,
<a name="6059"/> 6059:           qlc_SUITE:uninstall_error_logger()&quot;&gt;&gt;],
<a name="6060"/> 6060:     run(Config, T1),
<a name="6061"/> 6061: 
<a name="6062"/> 6062:     T2 = [
<a name="6063"/> 6063:        &lt;&lt;&quot;%% File sorter.
<a name="6064"/> 6064:           T = lists:seq(1, 10000),
<a name="6065"/> 6065:           Q0 = qlc:q([{X} || X &lt;- [T,T,T], begin X &gt; 0 end], 
<a name="6066"/> 6066:                      [{cache,list},unique]),
<a name="6067"/> 6067:           Q1 = qlc:q([{X,Y,Z} ||
<a name="6068"/> 6068:                          X &lt;- Q0,
<a name="6069"/> 6069:                          Y &lt;- Q0,
<a name="6070"/> 6070:                          Z &lt;- Q0],
<a name="6071"/> 6071:                      [{cache,list},unique]),
<a name="6072"/> 6072:           Q = qlc:q([{X, Y} || Y &lt;- [1], X &lt;- Q1]),
<a name="6073"/> 6073:           F = fun(Use) -&gt;
<a name="6074"/> 6074:                       qlc:e(Q, [{max_list_size,10000},{tmpdir_usage,Use}])
<a name="6075"/> 6075:               end,
<a name="6076"/> 6076:           1 = length(F(allowed)),
<a name="6077"/> 6077:           ErrReply = F(not_allowed),
<a name="6078"/> 6078:           {error, qlc, {tmpdir_usage,caching}} = ErrReply,
<a name="6079"/> 6079:           \&quot;temporary file was needed for caching\n\&quot; = 
<a name="6080"/> 6080:               lists:flatten(qlc:format_error(ErrReply)),
<a name="6081"/> 6081:           qlc_SUITE:install_error_logger(),
<a name="6082"/> 6082:           1 = length(F(error_msg)),
<a name="6083"/> 6083:           {error, caching} = qlc_SUITE:read_error_logger(),
<a name="6084"/> 6084:           {error, caching} = qlc_SUITE:read_error_logger(),
<a name="6085"/> 6085:           1 = length(F(warning_msg)),
<a name="6086"/> 6086:           {warning, caching} = qlc_SUITE:read_error_logger(),
<a name="6087"/> 6087:           {warning, caching} = qlc_SUITE:read_error_logger(),
<a name="6088"/> 6088:           1 = length(F(info_msg)),
<a name="6089"/> 6089:           {info, caching} = qlc_SUITE:read_error_logger(),
<a name="6090"/> 6090:           {info, caching} = qlc_SUITE:read_error_logger(),
<a name="6091"/> 6091:           qlc_SUITE:uninstall_error_logger()&quot;&gt;&gt;],
<a name="6092"/> 6092: 
<a name="6093"/> 6093:     run(Config, T2),
<a name="6094"/> 6094: 
<a name="6095"/> 6095:     T3 = [
<a name="6096"/> 6096:        &lt;&lt;&quot;%% sort/keysort
<a name="6097"/> 6097:           E1 = create_ets(1, 10),
<a name="6098"/> 6098:           E2 = create_ets(5, 50000),
<a name="6099"/> 6099:           Q = qlc:q([{XX,YY} ||
<a name="6100"/> 6100:                         {X,XX} &lt;- ets:table(E1),
<a name="6101"/> 6101:                         {YY,Y} &lt;- ets:table(E2),
<a name="6102"/> 6102:                         X == Y],
<a name="6103"/> 6103:                     {join,merge}),
<a name="6104"/> 6104:           F = fun(Use) -&gt;
<a name="6105"/> 6105:                       qlc:e(Q, {tmpdir_usage,Use})
<a name="6106"/> 6106:               end,
<a name="6107"/> 6107:           ErrReply = F(not_allowed),
<a name="6108"/> 6108:           {error,qlc,{tmpdir_usage,sorting}} = ErrReply,
<a name="6109"/> 6109:           \&quot;temporary file was needed for sorting\n\&quot; = 
<a name="6110"/> 6110:               lists:flatten(qlc:format_error(ErrReply)),
<a name="6111"/> 6111:           qlc_SUITE:install_error_logger(),
<a name="6112"/> 6112:           L = [{5,5},{6,6},{7,7},{8,8},{9,9},{10,10}],
<a name="6113"/> 6113:           L = F(allowed),
<a name="6114"/> 6114:           L = F(error_msg),
<a name="6115"/> 6115:           {error, sorting} = qlc_SUITE:read_error_logger(),
<a name="6116"/> 6116:           L = F(info_msg),
<a name="6117"/> 6117:           {info, sorting} = qlc_SUITE:read_error_logger(),
<a name="6118"/> 6118:           L = F(warning_msg),
<a name="6119"/> 6119:           {warning, sorting} = qlc_SUITE:read_error_logger(),
<a name="6120"/> 6120:           qlc_SUITE:uninstall_error_logger(),
<a name="6121"/> 6121:           ets:delete(E1),
<a name="6122"/> 6122:           ets:delete(E2)&quot;&gt;&gt;],
<a name="6123"/> 6123:     run(Config, T3),
<a name="6124"/> 6124: 
<a name="6125"/> 6125:     T4 = [
<a name="6126"/> 6126:        &lt;&lt;&quot;%% cache list
<a name="6127"/> 6127:           etsc(fun(E) -&gt;
<a name="6128"/> 6128:                        Q0 = qlc:q([X || X &lt;- ets:table(E),
<a name="6129"/> 6129:                                         begin element(1, X) &gt; 5 end],
<a name="6130"/> 6130:                                   {cache,list}),
<a name="6131"/> 6131:                        Q = qlc:q([{X, element(1,Y)} || X &lt;- lists:seq(1, 5),
<a name="6132"/> 6132:                                                        Y &lt;- Q0]),
<a name="6133"/> 6133:                        R = [{X,Y} || X &lt;- lists:seq(1, 5), 
<a name="6134"/> 6134:                                      Y &lt;- lists:seq(6, 10)],
<a name="6135"/> 6135:                        F = fun(Use) -&gt;
<a name="6136"/> 6136:                                    qlc:e(Q, [{max_list_size, 100*1024},
<a name="6137"/> 6137:                                              {tmpdir_usage, Use}])
<a name="6138"/> 6138:                            end,
<a name="6139"/> 6139:                        R = lists:sort(F(allowed)),
<a name="6140"/> 6140:                        qlc_SUITE:install_error_logger(),
<a name="6141"/> 6141:                        R = lists:sort(F(info_msg)),
<a name="6142"/> 6142:                        {info, caching} = qlc_SUITE:read_error_logger(),
<a name="6143"/> 6143:                        R = lists:sort(F(error_msg)),
<a name="6144"/> 6144:                        {error, caching} = qlc_SUITE:read_error_logger(),
<a name="6145"/> 6145:                        R = lists:sort(F(warning_msg)),
<a name="6146"/> 6146:                        {warning, caching} = qlc_SUITE:read_error_logger(),
<a name="6147"/> 6147:                        qlc_SUITE:uninstall_error_logger(),
<a name="6148"/> 6148:                        ErrReply = F(not_allowed),
<a name="6149"/> 6149:                        {error,qlc,{tmpdir_usage,caching}} = ErrReply,
<a name="6150"/> 6150:                        \&quot;temporary file was needed for caching\n\&quot; = 
<a name="6151"/> 6151:                            lists:flatten(qlc:format_error(ErrReply))
<a name="6152"/> 6152:                end, [{keypos,1}], [{I,a,lists:duplicate(100000,1)} || 
<a name="6153"/> 6153:                                        I &lt;- lists:seq(1, 10)])&quot;&gt;&gt;],
<a name="6154"/> 6154:     run(Config, T4),
<a name="otp_6964-last_expr"/><a name="6155"/> 6155:     ok.
<a name="6156"/> 6156: 
<a name="6157"/> 6157: <i>%% OTP-7238. info-option 'depth', &amp;c.</i>
<a name="otp_7238-1"/><a name="6158"/> 6158: <b>otp_7238</b>(Config) when is_list(Config) -&gt;
<a name="6159"/> 6159:     dets:start(),
<a name="6160"/> 6160:     T = otp_7238, 
<a name="6161"/> 6161:     Fname = filename(T, Config),
<a name="6162"/> 6162: 
<a name="6163"/> 6163:     ok = compile_gb_table(Config),
<a name="6164"/> 6164: 
<a name="6165"/> 6165:     %% A few more warnings.
<a name="6166"/> 6166:     T1 = [
<a name="6167"/> 6167:        %% The same error message string, but with different tags
<a name="6168"/> 6168:        %% (the strings are not compared :-(
<a name="6169"/> 6169:        {nomatch_1, 
<a name="6170"/> 6170:         &lt;&lt;&quot;nomatch_1() -&gt;
<a name="6171"/> 6171:                {qlc:q([X || X={X} &lt;- []]), [t || \&quot;a\&quot;=\&quot;b\&quot; &lt;- []]}.&quot;&gt;&gt;,
<a name="6172"/> 6172:         [],
<a name="6173"/> 6173:         %% {warnings,[{{2,30},qlc,nomatch_pattern},
<a name="6174"/> 6174:         {warnings,[{{2,44},v3_core,{nomatch,pattern}}]}},
<a name="6175"/> 6175: 
<a name="6176"/> 6176:        %% Not found by qlc...
<a name="6177"/> 6177:        {nomatch_2,
<a name="6178"/> 6178:         &lt;&lt;&quot;nomatch_2() -&gt;
<a name="6179"/> 6179:                qlc:q([t || {\&quot;a\&quot;++\&quot;b\&quot;} = {\&quot;ac\&quot;} &lt;- []]).&quot;&gt;&gt;,
<a name="6180"/> 6180:         [],
<a name="6181"/> 6181:         {warnings,[{{2,22},v3_core,{nomatch,pattern}}]}},
<a name="6182"/> 6182: 
<a name="6183"/> 6183:        {nomatch_3,
<a name="6184"/> 6184:         &lt;&lt;&quot;nomatch_3() -&gt;
<a name="6185"/> 6185:                qlc:q([t || [$a, $b] = \&quot;ba\&quot; &lt;- []]).&quot;&gt;&gt;,
<a name="6186"/> 6186:         [],
<a name="6187"/> 6187:         %% {warnings,[{{2,37},qlc,nomatch_pattern}]}},
<a name="6188"/> 6188:         {warnings,[{{2,22},v3_core,{nomatch,pattern}}]}},
<a name="6189"/> 6189: 
<a name="6190"/> 6190:        %% Not found by qlc...
<a name="6191"/> 6191:        {nomatch_4,
<a name="6192"/> 6192:         &lt;&lt;&quot;nomatch_4() -&gt;
<a name="6193"/> 6193:                qlc:q([t || \&quot;a\&quot;++_=\&quot;b\&quot; &lt;- []]).&quot;&gt;&gt;,
<a name="6194"/> 6194:         [],
<a name="6195"/> 6195:         {warnings,[{{2,22},v3_core,{nomatch,pattern}}]}},
<a name="6196"/> 6196: 
<a name="6197"/> 6197:        %% Found neither by the compiler nor by qlc...
<a name="6198"/> 6198:        {nomatch_5,
<a name="6199"/> 6199:         &lt;&lt;&quot;nomatch_5() -&gt;
<a name="6200"/> 6200:                qlc:q([X || X = &lt;&lt;X&gt;&gt; &lt;- [3]]).&quot;&gt;&gt;,
<a name="6201"/> 6201:         [],
<a name="6202"/> 6202:         []},
<a name="6203"/> 6203: 
<a name="6204"/> 6204:        {nomatch_6,
<a name="6205"/> 6205:         &lt;&lt;&quot;nomatch_6() -&gt;
<a name="6206"/> 6206:                qlc:q([X || X &lt;- [],
<a name="6207"/> 6207:                            X =:= {X}]).&quot;&gt;&gt;,
<a name="6208"/> 6208:         [],
<a name="6209"/> 6209:         %% {warnings,[{{3,30},qlc,nomatch_filter}]}},
<a name="6210"/> 6210:         []},
<a name="6211"/> 6211: 
<a name="6212"/> 6212:        {nomatch_7,
<a name="6213"/> 6213:         &lt;&lt;&quot;nomatch_7() -&gt;
<a name="6214"/> 6214:                qlc:q([X || {X=Y,{Y}=X} &lt;- []]).&quot;&gt;&gt;,
<a name="6215"/> 6215:         [],
<a name="6216"/> 6216:         %% {warnings,[{{2,28},qlc,nomatch_pattern}]}},
<a name="6217"/> 6217:         []},
<a name="6218"/> 6218: 
<a name="6219"/> 6219:        {nomatch_8,
<a name="6220"/> 6220:         &lt;&lt;&quot;nomatch_8() -&gt;
<a name="6221"/> 6221:                qlc:q([X || {X={},X=[]} &lt;- []]).&quot;&gt;&gt;,
<a name="6222"/> 6222:         [],
<a name="6223"/> 6223:         %% {warnings,[{{2,28},qlc,nomatch_pattern}]}},
<a name="6224"/> 6224:         []},
<a name="6225"/> 6225: 
<a name="6226"/> 6226:        {nomatch_9,
<a name="6227"/> 6227:         &lt;&lt;&quot;nomatch_9() -&gt;
<a name="6228"/> 6228:                qlc:q([X || X &lt;- [], X =:= {}, X =:= []]).&quot;&gt;&gt;,
<a name="6229"/> 6229:         [],
<a name="6230"/> 6230:         %% {warnings,[{{2,49},qlc,nomatch_filter}]}},
<a name="6231"/> 6231:         []},
<a name="6232"/> 6232: 
<a name="6233"/> 6233:        {nomatch_10,
<a name="6234"/> 6234:         &lt;&lt;&quot;nomatch_10() -&gt;
<a name="6235"/> 6235:                qlc:q([X || X &lt;- [],
<a name="6236"/> 6236:                            ((X =:= 1) or (X =:= 2)) and (X =:= 3)]).&quot;&gt;&gt;,
<a name="6237"/> 6237:         [],
<a name="6238"/> 6238:         %% {warnings,[{{3,53},qlc,nomatch_filter}]}},
<a name="6239"/> 6239:         []},
<a name="6240"/> 6240: 
<a name="6241"/> 6241:        {nomatch_11,
<a name="6242"/> 6242:         &lt;&lt;&quot;nomatch_11() -&gt;
<a name="6243"/> 6243:                qlc:q([X || X &lt;- [], x =:= []]).&quot;&gt;&gt;,
<a name="6244"/> 6244:         [],
<a name="6245"/> 6245:         %% {warnings,[{{2,39},qlc,nomatch_filter}]}},
<a name="6246"/> 6246:         {warnings,[{{2,22},sys_core_fold,{nomatch,guard}}]}},
<a name="6247"/> 6247: 
<a name="6248"/> 6248:        {nomatch_12,
<a name="6249"/> 6249:         &lt;&lt;&quot;nomatch_12() -&gt;
<a name="6250"/> 6250:                qlc:q([X || X={} &lt;- [], X =:= []]).&quot;&gt;&gt;,
<a name="6251"/> 6251:         [],
<a name="6252"/> 6252:         %% {warnings,[{{2,42},qlc,nomatch_filter}]}},
<a name="6253"/> 6253:         []},
<a name="6254"/> 6254: 
<a name="6255"/> 6255:        {nomatch_13,
<a name="6256"/> 6256:         &lt;&lt;&quot;nomatch_13() -&gt;
<a name="6257"/> 6257:                qlc:q([Z || Z &lt;- [], 
<a name="6258"/> 6258:                            X={X} &lt;- [], 
<a name="6259"/> 6259:                            Y={Y} &lt;- []]).&quot;&gt;&gt;,
<a name="6260"/> 6260:         [],
<a name="6261"/> 6261:         %% {warnings,[{{3,29},qlc,nomatch_pattern},
<a name="6262"/> 6262:         %%            {{4,29},qlc,nomatch_pattern}]}},
<a name="6263"/> 6263:         []},
<a name="6264"/> 6264: 
<a name="6265"/> 6265:        {nomatch_14,
<a name="6266"/> 6266:         &lt;&lt;&quot;nomatch_14() -&gt;
<a name="6267"/> 6267:                qlc:q([X || X={X} &lt;- [],
<a name="6268"/> 6268:                            1 &gt; 0,
<a name="6269"/> 6269:                            1 &gt; X]).&quot;&gt;&gt;,
<a name="6270"/> 6270:         [],
<a name="6271"/> 6271:         %% {warnings,[{{2,29},qlc,nomatch_pattern}]}},
<a name="6272"/> 6272:         []},
<a name="6273"/> 6273: 
<a name="6274"/> 6274:        {nomatch_15,
<a name="6275"/> 6275:         &lt;&lt;&quot;nomatch_15() -&gt;
<a name="6276"/> 6276:               qlc:q([{X,Y} || X={X} &lt;- [1],
<a name="6277"/> 6277:                               Y &lt;- [1],
<a name="6278"/> 6278:                               1 &gt; 0,
<a name="6279"/> 6279:                               1 &gt; X]).&quot;&gt;&gt;,
<a name="6280"/> 6280:         [],
<a name="6281"/> 6281:         %% {warnings,[{{2,32},qlc,nomatch_pattern}]}},
<a name="6282"/> 6282:         []},
<a name="6283"/> 6283: 
<a name="6284"/> 6284:        %% Template warning.
<a name="6285"/> 6285:        {nomatch_template1,
<a name="6286"/> 6286:         &lt;&lt;&quot;nomatch_template1() -&gt;
<a name="6287"/> 6287:                qlc:q([{X} = {} || X &lt;- []]).&quot;&gt;&gt;,
<a name="6288"/> 6288:         [],
<a name="6289"/> 6289:         {warnings,[{{2,23},sys_core_fold,{nomatch,no_clause}}]}}
<a name="6290"/> 6290:          ],
<a name="6291"/> 6291:     [] = compile(Config, T1),
<a name="6292"/> 6292: 
<a name="6293"/> 6293:     %% 'depth' is a new option used by info()
<a name="6294"/> 6294:     T2 = [
<a name="6295"/> 6295:        %% Firstly: lists
<a name="6296"/> 6296:        &lt;&lt;&quot;L = [[a,b,c],{a,b,c},[],&lt;&lt;\&quot;foobar\&quot;&gt;&gt;],
<a name="6297"/> 6297:           Q = qlc:q([{X} || X &lt;- L]),
<a name="6298"/> 6298:           {call, _,
<a name="6299"/> 6299:            {remote,_,{atom,_,ets},{atom,_,match_spec_run}},
<a name="6300"/> 6300:            [{cons,_,{atom,_,'...'},
<a name="6301"/> 6301:              {cons,_,{atom,_,'...'},
<a name="6302"/> 6302:               {cons,_,{nil,_},{cons,_,{atom,_,'...'},{nil,_}}}}},
<a name="6303"/> 6303:             _]} = qlc:info(Q, [{format,abstract_code},{depth,0}]),
<a name="6304"/> 6304: 
<a name="6305"/> 6305:           {call,_,_,
<a name="6306"/> 6306:            [{cons,_,{cons,_,{atom,_,'...'},{nil,_}},
<a name="6307"/> 6307:              {cons,_,
<a name="6308"/> 6308:               {tuple,_,[{atom,_,'...'}]},
<a name="6309"/> 6309:               {cons,_,{nil,_},
<a name="6310"/> 6310:                {cons,_,
<a name="6311"/> 6311:                 {bin,_,
<a name="6312"/> 6312:                  [{_,_,{_,_,$.},_,_},
<a name="6313"/> 6313:                   {_,_,{_,_,$.},_,_},
<a name="6314"/> 6314:                   {_,_,{_,_,$.},_,_}]},
<a name="6315"/> 6315:                 {nil,_}}}}},
<a name="6316"/> 6316:             _]} = qlc:info(Q, [{format,abstract_code},{depth,1}]),
<a name="6317"/> 6317: 
<a name="6318"/> 6318:           {call,_,
<a name="6319"/> 6319:            _,
<a name="6320"/> 6320:           [{cons,_,{cons,_,{atom,_,a},{atom,_,'...'}},
<a name="6321"/> 6321:             {cons,_,
<a name="6322"/> 6322:              {tuple,_,[{atom,_,a},{atom,_,'...'}]},
<a name="6323"/> 6323:              {cons,_,{nil,_},
<a name="6324"/> 6324:               {cons,_,
<a name="6325"/> 6325:                {bin,_,
<a name="6326"/> 6326:                 [{_,_,{_,_,$f},_,_},
<a name="6327"/> 6327:                  {_,_,{_,_,$.},_,_},
<a name="6328"/> 6328:                  {_,_,{_,_,$.},_,_},
<a name="6329"/> 6329:                  {_,_,{_,_,$.},_,_}]},
<a name="6330"/> 6330:                {nil,_}}}}},
<a name="6331"/> 6331:           _]} = qlc:info(Q, [{format,abstract_code},{depth,2}]),
<a name="6332"/> 6332: 
<a name="6333"/> 6333:           {call,_,_,
<a name="6334"/> 6334:            [{cons,_,
<a name="6335"/> 6335:              {cons,_,{atom,_,a},{cons,_,{atom,_,b},{atom,_,'...'}}},
<a name="6336"/> 6336:              {cons,_,
<a name="6337"/> 6337:               {tuple,_,[{atom,_,a},{atom,_,b},{atom,_,'...'}]},
<a name="6338"/> 6338:               {cons,_,{nil,_},
<a name="6339"/> 6339:                {cons,_,
<a name="6340"/> 6340:                 {bin,_,
<a name="6341"/> 6341:                  [{_,_,{_,_,$f},_,_},
<a name="6342"/> 6342:                   {_,_,{_,_,$o},_,_},_,_,_]},
<a name="6343"/> 6343:                 {nil,_}}}}},
<a name="6344"/> 6344:             _]} = qlc:info(Q, [{format,abstract_code},{depth,3}]),
<a name="6345"/> 6345: 
<a name="6346"/> 6346:           {call,_,_,
<a name="6347"/> 6347:            [{cons,_,
<a name="6348"/> 6348:              {cons,_,
<a name="6349"/> 6349:               {atom,_,a},{cons,_,{atom,_,b},{cons,_,{atom,_,c},{nil,_}}}},
<a name="6350"/> 6350:              {cons,_,
<a name="6351"/> 6351:               {tuple,_,[{atom,_,a},{atom,_,b},{atom,_,c}]},
<a name="6352"/> 6352:               {cons,_,{nil,_},
<a name="6353"/> 6353:                {cons,_,
<a name="6354"/> 6354:                 {bin,_,
<a name="6355"/> 6355:                  [{_,_,{_,_,$f},_,_},
<a name="6356"/> 6356:                   {_,_,{_,_,$o},_,_},
<a name="6357"/> 6357:                   {_,_,{_,_,$o},_,_},
<a name="6358"/> 6358:                   {_,_,{_,_,$b},_,_},
<a name="6359"/> 6359:                   {_,_,{_,_,$a},_,_},
<a name="6360"/> 6360:                   {_,_,{_,_,$r},_,_}]},
<a name="6361"/> 6361:                 {nil,_}}}}},
<a name="6362"/> 6362:             _]} = qlc:info(Q, [{format,abstract_code},{depth,10}]),
<a name="6363"/> 6363: 
<a name="6364"/> 6364:           {call,_,_,
<a name="6365"/> 6365:            [{cons,_,
<a name="6366"/> 6366:              {cons,_,
<a name="6367"/> 6367:               {atom,_,a},{cons,_,{atom,_,b},{cons,_,{atom,_,c},{nil,_}}}},
<a name="6368"/> 6368:              {cons,_,
<a name="6369"/> 6369:               {tuple,_,[{atom,_,a},{atom,_,b},{atom,_,c}]},
<a name="6370"/> 6370:               {cons,_,{nil,_},
<a name="6371"/> 6371:                {cons,_,
<a name="6372"/> 6372:                 {bin,_,
<a name="6373"/> 6373:                  [{_,_,{_,_,$f},_,_},
<a name="6374"/> 6374:                   {_,_,{_,_,$o},_,_},
<a name="6375"/> 6375:                   {_,_,{_,_,$o},_,_},
<a name="6376"/> 6376:                   {_,_,{_,_,$b},_,_},
<a name="6377"/> 6377:                   {_,_,{_,_,$a},_,_},
<a name="6378"/> 6378:                   {_,_,{_,_,$r},_,_}]},
<a name="6379"/> 6379:                 {nil,_}}}}},
<a name="6380"/> 6380:             _]} = qlc:info(Q, [{format,abstract_code},{depth,infinity}])&quot;&gt;&gt;,
<a name="6381"/> 6381:        
<a name="6382"/> 6382:        %% Secondly: looked up keys
<a name="6383"/> 6383:        &lt;&lt;&quot;F = fun(D) -&gt;
<a name="6384"/> 6384:                 etsc(fun(E) -&gt;
<a name="6385"/> 6385:                        Q = qlc:q([C || {N,C} &lt;- ets:table(E), 
<a name="6386"/> 6386:                                        (N =:= {2,2}) or (N =:= {3,3})]),
<a name="6387"/> 6387:                        F = qlc:info(Q, [{format,abstract_code},{depth,D}]),
<a name="6388"/> 6388:                        {call,_,_,[{call,_,_,[_Fun,Values]},_]} = F,
<a name="6389"/> 6389:                        [b,c] = lists:sort(qlc:eval(Q)),
<a name="6390"/> 6390:                        Values
<a name="6391"/> 6391:                      end, [{{1,1},a},{{2,2},b},{{3,3},c},{{4,4},d}])
<a name="6392"/> 6392:               end,
<a name="6393"/> 6393: 
<a name="6394"/> 6394:           [{cons,_,{atom,_,'...'},{cons,_,{atom,_,'...'},{nil,_}}},
<a name="6395"/> 6395:            {cons,_,
<a name="6396"/> 6396:             {tuple,_,[{atom,_,'...'}]},
<a name="6397"/> 6397:             {cons,_,{tuple,_,[{atom,_,'...'}]},{nil,_}}},
<a name="6398"/> 6398:            {cons,_,
<a name="6399"/> 6399:             {tuple,_,[{integer,_,2},{atom,_,'...'}]},
<a name="6400"/> 6400:             {cons,_,{tuple,_,[{integer,_,3},{atom,_,'...'}]},{nil,_}}},
<a name="6401"/> 6401:            {cons,_,
<a name="6402"/> 6402:             {tuple,_,[{integer,_,2},{integer,_,2}]},
<a name="6403"/> 6403:             {cons,_,{tuple,_,[{integer,_,3},{integer,_,3}]},{nil,_}}},
<a name="6404"/> 6404:            {cons,_,
<a name="6405"/> 6405:             {tuple,_,[{integer,_,2},{integer,_,2}]},
<a name="6406"/> 6406:             {cons,_,{tuple,_,[{integer,_,3},{integer,_,3}]},{nil,_}}}] =
<a name="6407"/> 6407:               lists:map(F, [0,1,2,3,infinity])&quot;&gt;&gt;,
<a name="6408"/> 6408:        [&lt;&lt;&quot;T = otp_7238, Fname = \&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;,
<a name="6409"/> 6409:            {ok, _} = dets:open_file(T, [{file,Fname}]),
<a name="6410"/> 6410:            ok = dets:insert(T, [{{1,1},a},{{2,2},b},{{3,3},c},{{4,4},d}]),
<a name="6411"/> 6411:            Q = qlc:q([C || {N,C} &lt;- dets:table(T), 
<a name="6412"/> 6412:                            (N =:= {2,2}) or (N =:= {3,3})]),
<a name="6413"/> 6413:            F = qlc:info(Q, [{format,abstract_code},{depth,1}]),
<a name="6414"/> 6414:            [b,c] = lists:sort(qlc:eval(Q)),
<a name="6415"/> 6415:            {call,_,_,
<a name="6416"/> 6416:             [{call,_,_,
<a name="6417"/> 6417:               [_,
<a name="6418"/> 6418:                {cons,_,
<a name="6419"/> 6419:                 {tuple,_,[{atom,_,'...'}]},
<a name="6420"/> 6420:                 {cons,_,{tuple,_,[{atom,_,'...'}]},{nil,_}}}]},
<a name="6421"/> 6421:              _]} = F,
<a name="6422"/> 6422:            ok = dets:close(T),
<a name="6423"/> 6423:            file:delete(\&quot;&quot;&gt;&gt;, Fname, &lt;&lt;&quot;\&quot;)&quot;&gt;&gt;],
<a name="6424"/> 6424: 
<a name="6425"/> 6425:        %% Thirdly: format_fun has been extended (in particular: gb_table)
<a name="6426"/> 6426:        &lt;&lt;&quot;T = gb_trees:from_orddict([{{1,a},w},{{2,b},v},{{3,c},u}]),
<a name="6427"/> 6427:           QH = qlc:q([X || {{X,Y},_} &lt;- gb_table:table(T),
<a name="6428"/> 6428:                            ((X =:= 1) or (X =:= 2)),
<a name="6429"/> 6429:                            ((Y =:= a) or (Y =:= b) or (Y =:= c))]),
<a name="6430"/> 6430:           {call,_,_,
<a name="6431"/> 6431:            [{call,_,_,
<a name="6432"/> 6432:              [{'fun',_,
<a name="6433"/> 6433:                {clauses,
<a name="6434"/> 6434:                 [{clause,_,_,[],
<a name="6435"/> 6435:                   [{'case',_,
<a name="6436"/> 6436:                     {call,_,_,
<a name="6437"/> 6437:                      [_,
<a name="6438"/> 6438:                       {call,_,_,
<a name="6439"/> 6439:                        [{cons,_,
<a name="6440"/> 6440:                          {tuple,_,[{atom,_,'...'}]},
<a name="6441"/> 6441:                          {cons,_,
<a name="6442"/> 6442:                           {tuple,_,[{atom,_,'...'}]},
<a name="6443"/> 6443:                           {cons,_,{tuple,_,[{atom,_,'...'}]},{nil,_}}}}]}]},
<a name="6444"/> 6444:                     [_,_]}]}]}},
<a name="6445"/> 6445:               {cons,_,
<a name="6446"/> 6446:                {tuple,_,[{atom,_,'...'}]},
<a name="6447"/> 6447:                {cons,_,
<a name="6448"/> 6448:                 {tuple,_,[{atom,_,'...'}]},
<a name="6449"/> 6449:                 {cons,_,
<a name="6450"/> 6450:                  {tuple,_,[{atom,_,'...'}]},
<a name="6451"/> 6451:                  {cons,_,
<a name="6452"/> 6452:                   {tuple,_,[{atom,_,'...'}]},
<a name="6453"/> 6453:                   {cons,_,
<a name="6454"/> 6454:                    {tuple,_,[{atom,_,'...'}]},
<a name="6455"/> 6455:                    {cons,_,{tuple,_,[{atom,_,'...'}]},{nil,_}}}}}}}]},
<a name="6456"/> 6456:             {call,_,_,
<a name="6457"/> 6457:              [{cons,_,{tuple,_,[{atom,_,'...'}]},{nil,_}}]}]} = 
<a name="6458"/> 6458:             qlc:info(QH, [{format,abstract_code},{depth,1}])&quot;&gt;&gt;,
<a name="6459"/> 6459:        &lt;&lt;&quot;T1 = [{1,1,a},{2,2,b},{3,3,c},{4,4,d}],
<a name="6460"/> 6460:           T2 = [{x,1},{y,1},{z,2}],
<a name="6461"/> 6461:           QH1 = T1,
<a name="6462"/> 6462:           T = gb_trees:from_orddict(T2),
<a name="6463"/> 6463:           QH2 = qlc:q([X || {_,X} &lt;- gb_table:table(T)], cache),
<a name="6464"/> 6464:           Q = qlc:q([{X1,X2,X3} || {X1,X2,X3} &lt;- QH1, 
<a name="6465"/> 6465:                                    Y2 &lt;- QH2, 
<a name="6466"/> 6466:                                    X2 =:= Y2]),
<a name="6467"/> 6467:           {block,_,
<a name="6468"/> 6468:            [{match,_,_,
<a name="6469"/> 6469:              {call,_,_,
<a name="6470"/> 6470:               [{lc,_,_,
<a name="6471"/> 6471:                 [{generate,_,_,
<a name="6472"/> 6472:                   {call,_,_,
<a name="6473"/> 6473:                    [{call,_,_,
<a name="6474"/> 6474:                      [{cons,_,
<a name="6475"/> 6475:                        {tuple,_,[{atom,_,'...'}]},
<a name="6476"/> 6476:                        {atom,_,'...'}}]}]}}]},
<a name="6477"/> 6477:                _]}},
<a name="6478"/> 6478:             {call,_,_,
<a name="6479"/> 6479:              [{lc,_,_,
<a name="6480"/> 6480:                [{generate,_,_,
<a name="6481"/> 6481:                  {cons,_,{tuple,_,[{atom,_,'...'}]},{atom,_,'...'}}},
<a name="6482"/> 6482:                 _,_]}]}]} = 
<a name="6483"/> 6483:               qlc:info(Q, [{format,abstract_code},{depth, 1},
<a name="6484"/> 6484:                            {n_elements,1}])&quot;&gt;&gt;,
<a name="6485"/> 6485:        &lt;&lt;&quot;L = [{{key,1},a},{{key,2},b},{{key,3},c}],
<a name="6486"/> 6486:           T = gb_trees:from_orddict(orddict:from_list(L)),
<a name="6487"/> 6487:           Q = qlc:q([K || {K,_} &lt;- gb_table:table(T), 
<a name="6488"/> 6488:                                    (K =:= {key,1}) or (K =:= {key,2})]),
<a name="6489"/> 6489: {call,_,_,
<a name="6490"/> 6490:  [{call,_,_,
<a name="6491"/> 6491:    [{'fun',_,
<a name="6492"/> 6492:      {clauses,
<a name="6493"/> 6493:       [{clause,_,_,[],
<a name="6494"/> 6494:         [{'case',_,
<a name="6495"/> 6495:           {call,_,_,
<a name="6496"/> 6496:            [_,
<a name="6497"/> 6497:             {call,_,_,
<a name="6498"/> 6498:              [{cons,_,
<a name="6499"/> 6499:                {tuple,_,[{tuple,_,[{atom,_,'...'}]},{atom,_,'...'}]},
<a name="6500"/> 6500:                {cons,_,
<a name="6501"/> 6501:                 {tuple,_,[{tuple,_,[{atom,_,'...'}]},{atom,_,'...'}]},
<a name="6502"/> 6502:                 {cons,_,
<a name="6503"/> 6503:                  {tuple,_,[{tuple,_,[{atom,_,'...'}]},{atom,_,'...'}]},
<a name="6504"/> 6504:                  {nil,_}}}}]}]},
<a name="6505"/> 6505:           _}]}]}},
<a name="6506"/> 6506:     {cons,_,
<a name="6507"/> 6507:      {tuple,_,[{atom,_,key},{atom,_,'...'}]},
<a name="6508"/> 6508:      {cons,_,{tuple,_,[{atom,_,key},{atom,_,'...'}]},{nil,_}}}]},
<a name="6509"/> 6509:   {call,_,
<a name="6510"/> 6510:    {remote,_,{atom,_,ets},{atom,_,match_spec_compile}},
<a name="6511"/> 6511:    [{cons,_,
<a name="6512"/> 6512:      {tuple,_,[{tuple,_,[{atom,_,'...'}]},{atom,_,'...'}]},
<a name="6513"/> 6513:      {nil,_}}]}]} = 
<a name="6514"/> 6514:           qlc:info(Q, [{format,abstract_code},{depth, 2}])&quot;&gt;&gt;
<a name="6515"/> 6515: 
<a name="6516"/> 6516:          ],
<a name="6517"/> 6517:     run(Config, T2),
<a name="6518"/> 6518: 
<a name="6519"/> 6519:     T3 = [
<a name="6520"/> 6520: <i>%%        {nomatch_6,</i>
<a name="6521"/> 6521: <i>%%         &lt;&lt;&quot;nomatch_6() -&gt;</i>
<a name="6522"/> 6522: <i>%%                qlc:q([X || X &lt;- [],</i>
<a name="6523"/> 6523: <i>%%                            X =:= {X}]).&quot;&gt;&gt;,</i>
<a name="6524"/> 6524: <i>%%         [],</i>
<a name="6525"/> 6525: <i>%%         {[],[&quot;filter evaluates to 'false'&quot;]}},</i>
<a name="6526"/> 6526: 
<a name="6527"/> 6527: <i>%%        {nomatch_7,</i>
<a name="6528"/> 6528: <i>%%         &lt;&lt;&quot;nomatch_7() -&gt;</i>
<a name="6529"/> 6529: <i>%%                qlc:q([X || {X=Y,{Y}=X} &lt;- []]).&quot;&gt;&gt;,</i>
<a name="6530"/> 6530: <i>%%         [],</i>
<a name="6531"/> 6531: <i>%%         {[],[&quot;pattern cannot possibly match&quot;]}}</i>
<a name="6532"/> 6532:        ],
<a name="6533"/> 6533:     compile_format(Config, T3),
<a name="6534"/> 6534: 
<a name="6535"/> 6535:     %% *Very* simple test - just check that it doesn't crash.
<a name="6536"/> 6536:     Type = [{cres,
<a name="6537"/> 6537:              &lt;&lt;&quot;Q = qlc:q([X || {X} &lt;- []]),
<a name="6538"/> 6538:                 {'EXIT',{{badfun,_},_}} = (catch qlc:e(Q))&quot;&gt;&gt;,
<a name="6539"/> 6539:              [type_checker],
<a name="6540"/> 6540:              []}],
<a name="6541"/> 6541:     run(Config, Type),
<a name="6542"/> 6542: 
<a name="otp_7238-last_expr"/><a name="6543"/> 6543:     ok.
<a name="6544"/> 6544:     
<a name="6545"/> 6545: <i>%% OTP-7114. Match spec, table and duplicated objects...</i>
<a name="otp_7114-1"/><a name="6546"/> 6546: <b>otp_7114</b>(Config) when is_list(Config) -&gt;
<a name="6547"/> 6547:     Ts = [&lt;&lt;&quot;T = ets:new(t, [bag]),
<a name="6548"/> 6548:              [ets:insert(T, {t, I, I div 2}) || I &lt;- lists:seq(1,10)],
<a name="6549"/> 6549:              Q1 = qlc:q([element(3, E) || E &lt;- ets:table(T)]),
<a name="6550"/> 6550:              [0,1,1,2,2,3,3,4,4,5] = lists:sort(qlc:e(Q1)),
<a name="6551"/> 6551:              [0,1,2,3,4,5] = qlc:e(Q1, unique_all),
<a name="6552"/> 6552:              [0,1,2,3,4,5] = qlc:e(qlc:sort(Q1), unique_all),
<a name="6553"/> 6553:              [0,1,2,3,4,5] = qlc:e(qlc:sort(qlc:e(Q1)), unique_all),
<a name="6554"/> 6554:              ets:delete(T),
<a name="6555"/> 6555:              ok&quot;&gt;&gt;],
<a name="otp_7114-last_expr"/><a name="6556"/> 6556: <b>    run</b>(Config, Ts).
<a name="6557"/> 6557: 
<a name="6558"/> 6558: <i>%% OTP-7232. qlc:info() bug (pids, ports, refs, funs).</i>
<a name="otp_7232-1"/><a name="6559"/> 6559: <b>otp_7232</b>(Config) when is_list(Config) -&gt;
<a name="6560"/> 6560:     Ts = [&lt;&lt;&quot;L = [fun math:sqrt/1, list_to_pid(\&quot;&lt;0.4.0&gt;\&quot;),
<a name="6561"/> 6561:                   erlang:make_ref()],
<a name="6562"/> 6562:              \&quot;[fun math:sqrt/1, &lt;0.4.0&gt;, #Ref&lt;\&quot; ++ _  = qlc:info(L),
<a name="6563"/> 6563:              {call,_,
<a name="6564"/> 6564:                {remote,_,{atom,_,qlc},{atom,_,sort}},
<a name="6565"/> 6565:                [{cons,_,
<a name="6566"/> 6566:                       {'fun',_,{function,{atom,_,math},{atom,_,sqrt},_}},
<a name="6567"/> 6567:                       {cons,_,
<a name="6568"/> 6568:                             {string,_,\&quot;&lt;0.4.0&gt;\&quot;}, % could use list_to_pid..
<a name="6569"/> 6569:                             {cons,_,{string,_,\&quot;#Ref&lt;\&quot;++_},{nil,_}}}},
<a name="6570"/> 6570:                 {nil,_}]} = 
<a name="6571"/> 6571:               qlc:info(qlc:sort(L),{format,abstract_code})&quot;&gt;&gt;,
<a name="6572"/> 6572: 
<a name="6573"/> 6573:           &lt;&lt;&quot;Q1 = qlc:q([X || X &lt;- [55296,56296]]),
<a name="6574"/> 6574:              Q = qlc:sort(Q1, {order, fun(A,B)-&gt; A&gt;B end}),
<a name="6575"/> 6575:              \&quot;qlc:sort([55296,56296],[{order,fun'-function/0-fun-2-'/2}])\&quot; =
<a name="6576"/> 6576:                 format_info(Q, true),
<a name="6577"/> 6577:              AC = qlc:info(Q, {format, abstract_code}),
<a name="6578"/> 6578:              \&quot;qlc:sort([55296, 56296], [{order, fun '-function/0-fun-2-'/2}])\&quot; =
<a name="6579"/> 6579:                 binary_to_list(iolist_to_binary(erl_pp:expr(AC)))&quot;&gt;&gt;,
<a name="6580"/> 6580: 
<a name="6581"/> 6581:          %% OTP-7234. erl_parse:abstract() handles bit strings
<a name="6582"/> 6582:           &lt;&lt;&quot;Q = qlc:sort([&lt;&lt;17:9&gt;&gt;]),
<a name="6583"/> 6583:              \&quot;[&lt;&lt;8,1:1&gt;&gt;]\&quot; = qlc:info(Q)&quot;&gt;&gt;
<a name="6584"/> 6584: 
<a name="6585"/> 6585:          ],
<a name="otp_7232-last_expr"/><a name="6586"/> 6586: <b>    run</b>(Config, Ts).
<a name="6587"/> 6587: 
<a name="6588"/> 6588: <i>%% OTP-7552. Merge join bug.</i>
<a name="otp_7552-1"/><a name="6589"/> 6589: <b>otp_7552</b>(Config) when is_list(Config) -&gt;
<a name="6590"/> 6590:     %% The poor performance cannot be observed unless the 
<a name="6591"/> 6591:     %% (redundant) join filter is skipped. 
<a name="6592"/> 6592:     Ts = [&lt;&lt;&quot;Few = lists:seq(1, 2),
<a name="6593"/> 6593:              Many = lists:seq(1, 10),
<a name="6594"/> 6594:              S = [d,e],
<a name="6595"/> 6595:              L1 = [{Y,a} || Y &lt;- Few] ++ [{'1b',b},{2,b}] ++ 
<a name="6596"/> 6596:                     [{Y,X} || X &lt;- S, Y &lt;- Few],
<a name="6597"/> 6597:              L2 = [{a,Y} || Y &lt;- Many] ++ 
<a name="6598"/> 6598:                     [{b,'1b'}] ++ [{c,1}] ++ 
<a name="6599"/> 6599:                     [{X,Y} || X &lt;- S, Y &lt;- Many],
<a name="6600"/> 6600:                    F = fun(J) -&gt;
<a name="6601"/> 6601:                                qlc:q([{XX,YY} ||
<a name="6602"/> 6602:                                          {XX,X} &lt;- L1,
<a name="6603"/> 6603:                                          {Y,YY} &lt;- L2,
<a name="6604"/> 6604:                                          X == Y],
<a name="6605"/> 6605:                                      {join,J})
<a name="6606"/> 6606:                        end,
<a name="6607"/> 6607:                    Qm = F(merge),
<a name="6608"/> 6608:                    Qn = F(nested_loop),
<a name="6609"/> 6609:                    true = lists:sort(qlc:e(Qm, {max_list_size,20})) =:= 
<a name="6610"/> 6610:                           lists:sort(qlc:e(Qn))&quot;&gt;&gt;],
<a name="otp_7552-last_expr"/><a name="6611"/> 6611: <b>    run</b>(Config, Ts).
<a name="6612"/> 6612: 
<a name="6613"/> 6613: <i>%% OTP-7714. Merge join bug.</i>
<a name="otp_7714-1"/><a name="6614"/> 6614: <b>otp_7714</b>(Config) when is_list(Config) -&gt;
<a name="6615"/> 6615:     %% The original example uses Mnesia. This one does not.
<a name="6616"/> 6616:     Ts = [&lt;&lt;&quot;E1 = ets:new(set,[]),
<a name="6617"/> 6617:              true = ets:insert(E1, {a,1}),
<a name="6618"/> 6618:              E2 = ets:new(set,[]),
<a name="6619"/> 6619:              _ = [true = ets:insert(E2, {I, 1}) ||
<a name="6620"/> 6620:                      I &lt;- lists:seq(1, 3)],
<a name="6621"/> 6621:              Q = qlc:q([{A,B} || 
<a name="6622"/> 6622:                            {A,I1} &lt;- ets:table(E1),
<a name="6623"/> 6623:                            {B,I2} &lt;- ets:table(E2),
<a name="6624"/> 6624:                            I1 =:= I2],{join,merge}),
<a name="6625"/> 6625:              [{a,1},{a,2},{a,3}] = lists:sort(qlc:e(Q)),
<a name="6626"/> 6626:              ets:delete(E1),
<a name="6627"/> 6627:              ets:delete(E2)&quot;&gt;&gt;],
<a name="otp_7714-last_expr"/><a name="6628"/> 6628: <b>    run</b>(Config, Ts).
<a name="6629"/> 6629: 
<a name="6630"/> 6630: <i>%% OTP-11758. Bug.</i>
<a name="otp_11758-1"/><a name="6631"/> 6631: <b>otp_11758</b>(Config) when is_list(Config) -&gt;
<a name="6632"/> 6632:     Ts = [&lt;&lt;&quot;T = ets:new(r, [{keypos, 2}]),
<a name="6633"/> 6633:              L = [{rrr, xxx, aaa}, {rrr, yyy, bbb}],
<a name="6634"/> 6634:              true = ets:insert(T, L),
<a name="6635"/> 6635:              QH = qlc:q([{rrr, B, C} || {rrr, B, C} &lt;- ets:table(T),
<a name="6636"/> 6636:                               (B =:= xxx) or (B =:= yyy) and (C =:= aaa)]),
<a name="6637"/> 6637:              [{rrr,xxx,aaa}] = qlc:e(QH),
<a name="6638"/> 6638:              ets:delete(T)&quot;&gt;&gt;],
<a name="otp_11758-last_expr"/><a name="6639"/> 6639: <b>    run</b>(Config, Ts).
<a name="6640"/> 6640: 
<a name="6641"/> 6641: <i>%% OTP-6674. match/comparison.</i>
<a name="otp_6674-1"/><a name="6642"/> 6642: <b>otp_6674</b>(Config) when is_list(Config) -&gt;
<a name="6643"/> 6643: 
<a name="6644"/> 6644:     ok = compile_gb_table(Config),
<a name="6645"/> 6645: 
<a name="6646"/> 6646:     Ts = [%% lookup join
<a name="6647"/> 6647:           &lt;&lt;&quot;E = ets:new(join, [ordered_set]),
<a name="6648"/> 6648:              true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="6649"/> 6649:              Q = qlc:q([{X, Y} || {X,_} &lt;- ets:table(E),
<a name="6650"/> 6650:                                   {Y} &lt;- [{0},{1},{2}],
<a name="6651"/> 6651:                                   X == Y]),
<a name="6652"/> 6652:              {0,1,0,0} = join_info(Q),
<a name="6653"/> 6653:              [{1,1},{2,2}] = qlc:e(Q),
<a name="6654"/> 6654:              ets:delete(E)&quot;&gt;&gt;,
<a name="6655"/> 6655: 
<a name="6656"/> 6656:           &lt;&lt;&quot;E = ets:new(join, [ordered_set]),
<a name="6657"/> 6657:              true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="6658"/> 6658:              Q = qlc:q([{X, Y} || {X,_} &lt;- ets:table(E),
<a name="6659"/> 6659:                                   {Y} &lt;- [{0},{1},{2}],
<a name="6660"/> 6660:                                   X =:= Y]),
<a name="6661"/> 6661:              {0,1,0,0} = join_info(Q),
<a name="6662"/> 6662:              {block,_,
<a name="6663"/> 6663:               [_,
<a name="6664"/> 6664:                {match,_,_,
<a name="6665"/> 6665:                  {call,_,_,
<a name="6666"/> 6666:                   [{lc,_,_,
<a name="6667"/> 6667:                     [_,_,{op,_,'==',_,_}]},
<a name="6668"/> 6668:                    {cons,_,
<a name="6669"/> 6669:                     {tuple,_,[{atom,_,join},{atom,_,lookup}]},_}]}},
<a name="6670"/> 6670:                _]} = qlc:info(Q, {format, abstract_code}),
<a name="6671"/> 6671:              [{1,1},{2,2}] = qlc:e(Q),
<a name="6672"/> 6672:              ets:delete(E)&quot;&gt;&gt;,
<a name="6673"/> 6673: 
<a name="6674"/> 6674:        &lt;&lt;&quot;E = ets:new(join, [set]),
<a name="6675"/> 6675:           Q = qlc:q([{X, Y} || {X,_} &lt;- ets:table(E),
<a name="6676"/> 6676:                                {Y} &lt;- [{0},{1},{2}],
<a name="6677"/> 6677:                                X == Y], {join, lookup}),
<a name="6678"/> 6678:           {'EXIT',{cannot_carry_out_join,_}} = (catch qlc:e(Q)),
<a name="6679"/> 6679:           ets:delete(E)&quot;&gt;&gt;,
<a name="6680"/> 6680: 
<a name="6681"/> 6681:        %% Lookup join possible in both directions.
<a name="6682"/> 6682:        &lt;&lt;&quot;E1 = ets:new(join, [ordered_set]),
<a name="6683"/> 6683:           E2 = ets:new(join, [set]),
<a name="6684"/> 6684:           true = ets:insert(E1, [{1.0,a},{2,b},{3,c}]),
<a name="6685"/> 6685:           true = ets:insert(E2, [{0},{1},{2}]),
<a name="6686"/> 6686:           Q = qlc:q([{X, Y} || {X,_} &lt;- ets:table(E1),
<a name="6687"/> 6687:                                {Y} &lt;- ets:table(E2),
<a name="6688"/> 6688:                                X == Y],{join,lookup}), % skipped
<a name="6689"/> 6689:           {qlc,_,
<a name="6690"/> 6690:             [{generate,_,
<a name="6691"/> 6691:                  {qlc,_,
<a name="6692"/> 6692:                      [{generate,_,
<a name="6693"/> 6693:                           {qlc,_,[{generate,_,{table,{ets,table,[_]}}}],[]}},
<a name="6694"/> 6694:                       {generate,_,{table,{ets,table,[_]}}},
<a name="6695"/> 6695:                       _],
<a name="6696"/> 6696:                      [{join,lookup}]}}],
<a name="6697"/> 6697:             []} = qlc:info(Q, {format,debug}),
<a name="6698"/> 6698:           {0,1,0,0} = join_info(Q),
<a name="6699"/> 6699:           [{1.0,1},{2,2}] = lists:sort(qlc:e(Q)),
<a name="6700"/> 6700:           ets:delete(E1), 
<a name="6701"/> 6701:           ets:delete(E2)&quot;&gt;&gt;,
<a name="6702"/> 6702:        &lt;&lt;&quot;E1 = ets:new(join, [ordered_set]),
<a name="6703"/> 6703:           E2 = ets:new(join, [set]),
<a name="6704"/> 6704:           true = ets:insert(E1, [{1.0,a},{2,b},{3,c}]),
<a name="6705"/> 6705:           true = ets:insert(E2, [{0},{1},{2}]),
<a name="6706"/> 6706:           Q = qlc:q([{X, Y} || {X,_} &lt;- ets:table(E1),
<a name="6707"/> 6707:                                {Y} &lt;- ets:table(E2),
<a name="6708"/> 6708:                                X =:= Y],{join,merge}), % not skipped
<a name="6709"/> 6709:           {1,0,0,1} = join_info(Q),
<a name="6710"/> 6710:           [{2,2}] = qlc:e(Q),
<a name="6711"/> 6711:           ets:delete(E1), 
<a name="6712"/> 6712:           ets:delete(E2)&quot;&gt;&gt;,
<a name="6713"/> 6713:        &lt;&lt;&quot;E1 = ets:new(join, [ordered_set]),
<a name="6714"/> 6714:           E2 = ets:new(join, [set]),
<a name="6715"/> 6715:           true = ets:insert(E1, [{1.0,a},{2,b},{3,c}]),
<a name="6716"/> 6716:           true = ets:insert(E2, [{0},{1},{2}]),
<a name="6717"/> 6717:           Q = qlc:q([{X, Y} || {X,_} &lt;- ets:table(E1),
<a name="6718"/> 6718:                                {Y} &lt;- ets:table(E2),
<a name="6719"/> 6719:                                X =:= Y],{join,lookup}), % skipped
<a name="6720"/> 6720:           {qlc,_,
<a name="6721"/> 6721:            [{generate,_,
<a name="6722"/> 6722:              {qlc,_,
<a name="6723"/> 6723:               [{generate,_,
<a name="6724"/> 6724:                 {qlc,_,
<a name="6725"/> 6725:                  [{generate,_,{table,{ets,table,[_]}}}],
<a name="6726"/> 6726:                  []}},
<a name="6727"/> 6727:                {generate,_,{table,{ets,table,[_]}}},
<a name="6728"/> 6728:                _],
<a name="6729"/> 6729:               [{join,lookup}]}}],
<a name="6730"/> 6730:             []} = qlc:info(Q, {format,debug}),
<a name="6731"/> 6731:           {0,1,0,0} = join_info(Q),
<a name="6732"/> 6732:           [{2,2}] = qlc:e(Q),
<a name="6733"/> 6733:           ets:delete(E1), 
<a name="6734"/> 6734:           ets:delete(E2)&quot;&gt;&gt;,
<a name="6735"/> 6735:        &lt;&lt;&quot;E1 = ets:new(join, [ordered_set]),
<a name="6736"/> 6736:           E2 = ets:new(join, [set]),
<a name="6737"/> 6737:           true = ets:insert(E1, [{1.0,a},{2,b},{3,c}]),
<a name="6738"/> 6738:           true = ets:insert(E2, [{0},{1},{2}]),
<a name="6739"/> 6739:           Q = qlc:q([{X, Y} || {X,_} &lt;- ets:table(E1),
<a name="6740"/> 6740:                                {Y} &lt;- ets:table(E2),
<a name="6741"/> 6741:                                %% Independent of term comparison:
<a name="6742"/> 6742:                                X =:= Y, X == Y]),
<a name="6743"/> 6743:           {0,1,0,0} = join_info(Q),
<a name="6744"/> 6744:           [{2,2}] = qlc:e(Q),
<a name="6745"/> 6745:           ets:delete(E1), 
<a name="6746"/> 6746:           ets:delete(E2)&quot;&gt;&gt;,
<a name="6747"/> 6747: 
<a name="6748"/> 6748:        &lt;&lt;&quot;E = ets:new(join, [ordered_set]),
<a name="6749"/> 6749:           true = ets:insert(E, [{1,1},{2,2},{3,c}]),
<a name="6750"/> 6750:           Q = qlc:q([{X, Y} || {X,Z} &lt;- ets:table(E),
<a name="6751"/> 6751:                                {Y} &lt;- [{0},{1},{2}],
<a name="6752"/> 6752:                                X == Z, Y == Z]), % cannot skip (yet)
<a name="6753"/> 6753:           {qlc,_,
<a name="6754"/> 6754:             [{generate,_,
<a name="6755"/> 6755:                  {qlc,_,[_,_,_],[{join,lookup}]}},
<a name="6756"/> 6756:              _,_],[]} = qlc:info(Q,{format,debug}),
<a name="6757"/> 6757:           {0,1,0,0} = join_info(Q),
<a name="6758"/> 6758:           [{1,1},{2,2}] = qlc:e(Q),
<a name="6759"/> 6759:           ets:delete(E)&quot;&gt;&gt;,
<a name="6760"/> 6760: 
<a name="6761"/> 6761:        %% The following moved here from skip_filters. It was buggy!
<a name="6762"/> 6762:        &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6763"/> 6763:                  A = 3,
<a name="6764"/> 6764:                  Q = qlc:q([X || X &lt;- ets:table(E),
<a name="6765"/> 6765:                                  A == element(1,X)]),
<a name="6766"/> 6766:                  {table, _} = i(Q),
<a name="6767"/> 6767:                  case qlc:e(Q) of
<a name="6768"/> 6768:                        [{3},{3.0}] -&gt; ok;
<a name="6769"/> 6769:                        [{3.0},{3}] -&gt; ok
<a name="6770"/> 6770:                  end,
<a name="6771"/> 6771:                  false = lookup_keys(Q)
<a name="6772"/> 6772:          end, [{3},{3.0},{c}])&quot;&gt;&gt;,
<a name="6773"/> 6773:     &lt;&lt;&quot;H1 = qlc:sort([{{192,192.0},1,a},{{192.0,192.0},2,b},{{192,192.0},3,c}]),
<a name="6774"/> 6774:        Q = qlc:q([{X, Y} || {{A,B},X,_} &lt;- H1, % does not need keysort(3)
<a name="6775"/> 6775:                             A == 192, B =:= 192.0,
<a name="6776"/> 6776:                             {Y} &lt;- [{0},{1},{2}],
<a name="6777"/> 6777:                             X == Y]),
<a name="6778"/> 6778:        A0 = erl_anno:new(0),
<a name="6779"/> 6779:        {block,A0,
<a name="6780"/> 6780:          [{match,_,_,
<a name="6781"/> 6781:            {call,_,_,
<a name="6782"/> 6782:             [{lc,_,_,
<a name="6783"/> 6783:               [_,
<a name="6784"/> 6784:                %% Has to compare extra constant:
<a name="6785"/> 6785:                {op,_,'==',
<a name="6786"/> 6786:                 {tuple,_,[{integer,_,192},{float,_,192.0}]},
<a name="6787"/> 6787:                 {call,_,{atom,_,element},[{integer,_,1},{var,_,'P0'}]}}]}]}},
<a name="6788"/> 6788:           _,_,
<a name="6789"/> 6789:           {call,_,_,
<a name="6790"/> 6790:            [{lc,_,_,
<a name="6791"/> 6791:              [_,
<a name="6792"/> 6792:               %% The join filter has been skipped.
<a name="6793"/> 6793:               {op,_,'==',{var,_,'A'},{integer,_,192}},
<a name="6794"/> 6794:               {op,_,'=:=',{var,_,'B'},{float,_,192.0}}]}]}]}
<a name="6795"/> 6795:       = qlc:info(Q, {format,abstract_code}),
<a name="6796"/> 6796:        {1,0,0,1} = join_info(Q),
<a name="6797"/> 6797:        [{1,1},{2,2}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="6798"/> 6798: 
<a name="6799"/> 6799:     %% Does not handle more than one lookup value (conjunctive).
<a name="6800"/> 6800:     &lt;&lt;&quot;T = gb_trees:from_orddict([{1,a},{2,b}]),
<a name="6801"/> 6801:        H = qlc:q([X || {X,_} &lt;- gb_table:table(T),
<a name="6802"/> 6802:                                 X =:= 1 andalso X == 1.0]),
<a name="6803"/> 6803:        false = lookup_keys(H),
<a name="6804"/> 6804:        [1] = qlc:e(H)&quot;&gt;&gt;,
<a name="6805"/> 6805: 
<a name="6806"/> 6806:     %% EqualConstants...
<a name="6807"/> 6807:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6808"/> 6808:                 Q = qlc:q([{X,Y} || {X} &lt;- ets:table(E), 
<a name="6809"/> 6809:                                 {Y} &lt;- [{{1}},{{2}},{{1.0}},{{2.0}}],
<a name="6810"/> 6810:                                 X =:= {1}, X == {1.0},
<a name="6811"/> 6811:                                 X == Y], {join, merge}),
<a name="6812"/> 6812:                 [{{1},{1}},{{1},{1.0}}] = lists:sort(qlc:e(Q)),
<a name="6813"/> 6813:                 false = lookup_keys(Q)
<a name="6814"/> 6814:          end, [{{1}}, {{2}}])&quot;&gt;&gt;,
<a name="6815"/> 6815: 
<a name="6816"/> 6816:     &lt;&lt;&quot;T = gb_trees:from_orddict([{foo,{1}}, {bar,{2}}]),
<a name="6817"/> 6817:        Q = qlc:q([{X,Y} || {_,X} &lt;- gb_table:table(T), 
<a name="6818"/> 6818:                        {Y} &lt;- [{{1}},{{2}},{{1.0}},{{2.0}}],
<a name="6819"/> 6819:                          (X =:= {1}) or (X == {2}), 
<a name="6820"/> 6820:                          (X == {1.0}) or (X =:= {2.0}),
<a name="6821"/> 6821:                        X == Y], {join, merge}),
<a name="6822"/> 6822:        [{{1},{1}},{{1},{1.0}}] = qlc:e(Q)&quot;&gt;&gt;,
<a name="6823"/> 6823: 
<a name="6824"/> 6824:     %% Compare key
<a name="6825"/> 6825:     &lt;&lt;&quot;T = gb_trees:from_orddict([{1,a},{2,b}]),
<a name="6826"/> 6826:        H = qlc:q([X || {X,_} &lt;- gb_table:table(T),
<a name="6827"/> 6827:                        X == 1]),
<a name="6828"/> 6828:        [1] = lookup_keys(H),
<a name="6829"/> 6829:        [1] = qlc:e(H)&quot;&gt;&gt;,
<a name="6830"/> 6830:     &lt;&lt;&quot;T = gb_trees:from_orddict([{1,a},{2,b}]),
<a name="6831"/> 6831:        H = qlc:q([X || {X,_} &lt;- gb_table:table(T),
<a name="6832"/> 6832:                        X == 1.0]),
<a name="6833"/> 6833:        [1.0] = lookup_keys(H), % this is how gb_table works...
<a name="6834"/> 6834:        [1.0] = qlc:e(H)&quot;&gt;&gt;,
<a name="6835"/> 6835:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6836"/> 6836:                    H = qlc:q([X || {X,_} &lt;- ets:table(E), 
<a name="6837"/> 6837:                                    X == 1.0]),
<a name="6838"/> 6838:                    [1] = qlc:e(H), % and this is how ETS works.
<a name="6839"/> 6839:                    [1.0] = lookup_keys(H)
<a name="6840"/> 6840:            end, [ordered_set], [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="6841"/> 6841: 
<a name="6842"/> 6842:     &lt;&lt;&quot;T = gb_trees:from_orddict([{1,a},{2,b}]),
<a name="6843"/> 6843:        H = qlc:q([X || {X,_} &lt;- gb_table:table(T),
<a name="6844"/> 6844:                        X =:= 2]),
<a name="6845"/> 6845:        [2] = lookup_keys(H),
<a name="6846"/> 6846:        %% Cannot (generally) remove the matching filter (the table
<a name="6847"/> 6847:        %% compares the key). But note that gb_table returns the given
<a name="6848"/> 6848:        %% term as key, so in this case the filter _could_ have been removed.
<a name="6849"/> 6849:        %% However, there is no callback to inform qlc about that.
<a name="6850"/> 6850:        {call,_,_,
<a name="6851"/> 6851:              [_,{call,_,_,
<a name="6852"/> 6852:                [{cons,_,{tuple,_,
<a name="6853"/> 6853:                   [_,{cons,_,
<a name="6854"/> 6854:                     {tuple,_,[{atom,_,'=:='},{atom,_,'$1'},{integer,_,2}]},
<a name="6855"/> 6855:                     _},_]},_}]}]} =  qlc:info(H, {format,abstract_code}),
<a name="6856"/> 6856:        [2] = qlc:e(H)&quot;&gt;&gt;,
<a name="6857"/> 6857:     &lt;&lt;&quot;T = gb_trees:from_orddict([{1,a},{2,b}]),
<a name="6858"/> 6858:        H = qlc:q([X || {X,_} &lt;- gb_table:table(T),
<a name="6859"/> 6859:                        X =:= 2.0]),
<a name="6860"/> 6860:        %% Just shows that the term (not the key) is returned.
<a name="6861"/> 6861:        [2.0] = lookup_keys(H),
<a name="6862"/> 6862:        [2.0] = qlc:e(H)&quot;&gt;&gt;,
<a name="6863"/> 6863: 
<a name="6864"/> 6864:     &lt;&lt;&quot;I = 1,
<a name="6865"/> 6865:        T = gb_trees:from_orddict([{1,a},{2,b}]),
<a name="6866"/> 6866:        H = qlc:q([X || {X,_} &lt;- gb_table:table(T),
<a name="6867"/> 6867:                        X == I]), % imported variable
<a name="6868"/> 6868:        [1] = lookup_keys(H),
<a name="6869"/> 6869:        {call,_,_,
<a name="6870"/> 6870:              [_,{call,_,_,
<a name="6871"/> 6871:                [{cons,_,
<a name="6872"/> 6872:                  {tuple,_,
<a name="6873"/> 6873:                   [{tuple,_,[{atom,_,'$1'},{atom,_,'_'}]},
<a name="6874"/> 6874:                    {nil,_}, % the filter has been skipped
<a name="6875"/> 6875:                    {cons,_,{atom,_,'$1'},_}]},
<a name="6876"/> 6876:                  _}]}]} = qlc:info(H, {format, abstract_code}),
<a name="6877"/> 6877:        [1] = qlc:e(H)&quot;&gt;&gt;,
<a name="6878"/> 6878:     &lt;&lt;&quot;I = 2,
<a name="6879"/> 6879:        T = gb_trees:from_orddict([{1,a},{2,b}]),
<a name="6880"/> 6880:        H = qlc:q([X || {X,_} &lt;- gb_table:table(T),
<a name="6881"/> 6881:                        X =:= I]),
<a name="6882"/> 6882:        [2] = lookup_keys(H),
<a name="6883"/> 6883:        {call,_,_,
<a name="6884"/> 6884:             [_,{call,_,_,
<a name="6885"/> 6885:               [{cons,_,{tuple,_,
<a name="6886"/> 6886:                  [_,{cons,_,
<a name="6887"/> 6887:                    {tuple,_,
<a name="6888"/> 6888:                     [{atom,_,'=:='},
<a name="6889"/> 6889:                      {atom,_,'$1'},
<a name="6890"/> 6890:                      {tuple,_,[{atom,_,const},{integer,_,2}]}]},
<a name="6891"/> 6891:                    _},_]},
<a name="6892"/> 6892:                 _}]}]} = qlc:info(H, {format, abstract_code}),
<a name="6893"/> 6893:           [2] = qlc:e(H)&quot;&gt;&gt;,
<a name="6894"/> 6894: 
<a name="6895"/> 6895:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6896"/> 6896:                  Q = qlc:q([X || {X,_} &lt;- ets:table(E),
<a name="6897"/> 6897:                                  X =:= a]), % skipped
<a name="6898"/> 6898:                  [a] = qlc:e(Q),
<a name="6899"/> 6899:                  {list,{table,_},_} = i(Q),
<a name="6900"/> 6900:                  [a] = lookup_keys(Q)
<a name="6901"/> 6901:             end, [ordered_set], [{a,1},{b,2},{3,c}])&quot;&gt;&gt;,
<a name="6902"/> 6902: 
<a name="6903"/> 6903:     %% Does not find that if for instance X =:= {1} then the filter
<a name="6904"/> 6904:     %% X == {1} can be removed.
<a name="6905"/> 6905:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6906"/> 6906:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="6907"/> 6907:                                 X =:= {1}, X == {1.0}]),
<a name="6908"/> 6908:                 [{1}] = qlc:e(Q),
<a name="6909"/> 6909:                 [{1}] = lookup_keys(Q)
<a name="6910"/> 6910:          end, [{{1}}, {{2}}])&quot;&gt;&gt;,
<a name="6911"/> 6911:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6912"/> 6912:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="6913"/> 6913:                                 X =:= {1}, X == {1.0}]),
<a name="6914"/> 6914:                 [{1}] = qlc:e(Q),
<a name="6915"/> 6915:                 false = lookup_keys(Q)
<a name="6916"/> 6916:          end, [ordered_set], [{{1}}, {{2}}])&quot;&gt;&gt;,
<a name="6917"/> 6917:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6918"/> 6918:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="6919"/> 6919:                                 X == {1.0}, X =:= {1}]),
<a name="6920"/> 6920:                 [{1}] = qlc:e(Q),
<a name="6921"/> 6921:                 [{1}] = lookup_keys(Q)
<a name="6922"/> 6922:          end, [{{1}}, {{2}}])&quot;&gt;&gt;,
<a name="6923"/> 6923:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6924"/> 6924:                 Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="6925"/> 6925:                                 X == {1.0}, X =:= {1}]),
<a name="6926"/> 6926:                 [{1}] = qlc:e(Q),
<a name="6927"/> 6927:                 false = lookup_keys(Q)
<a name="6928"/> 6928:          end, [ordered_set], [{{1}}, {{2}}])&quot;&gt;&gt;,
<a name="6929"/> 6929: 
<a name="6930"/> 6930:     &lt;&lt;&quot;E = ets:new(apa, []),
<a name="6931"/> 6931:        true = ets:insert(E, [{1,a},{2,b}]),
<a name="6932"/> 6932:        {'EXIT', {badarg, _}} = 
<a name="6933"/> 6933:               (catch qlc_SUITE:bad_table_key_equality(E)),
<a name="6934"/> 6934:        ets:delete(E)&quot;&gt;&gt;,
<a name="6935"/> 6935: 
<a name="6936"/> 6936:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6937"/> 6937:            Q = qlc:q([X || {X} &lt;- ets:table(E), 
<a name="6938"/> 6938:                                X =:= 1, X =:= is_integer(X)]),
<a name="6939"/> 6939:            [] = qlc:e(Q),
<a name="6940"/> 6940:            [1] = lookup_keys(Q)
<a name="6941"/> 6941:        end, [{1}, {2}])&quot;&gt;&gt;,
<a name="6942"/> 6942: 
<a name="6943"/> 6943:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="6944"/> 6944:                  Q = qlc:q([X || {X=1} &lt;- ets:table(E), 
<a name="6945"/> 6945:                                  X =:= is_integer(X)]),
<a name="6946"/> 6946:                  {call,_,_,
<a name="6947"/> 6947:                   [{lc,_,_,
<a name="6948"/> 6948:                     [_,
<a name="6949"/> 6949:                      {op,_,'=:=',
<a name="6950"/> 6950:                       {var,_,'X'},
<a name="6951"/> 6951:                       {call,_,
<a name="6952"/> 6952:                        {atom,_,is_integer},
<a name="6953"/> 6953:                        [{var,_,'X'}]}}]}]} = 
<a name="6954"/> 6954:              qlc:info(Q, {format, abstract_code}),
<a name="6955"/> 6955:              [] = qlc:e(Q),
<a name="6956"/> 6956:              [1] = lookup_keys(Q)
<a name="6957"/> 6957:          end, [{1}, {2}])&quot;&gt;&gt;,
<a name="6958"/> 6958: 
<a name="6959"/> 6959:     &lt;&lt;&quot;T = gb_trees:from_orddict([{1,a},{2,b}]),
<a name="6960"/> 6960:        H = qlc:q([X || {X,Y} &lt;- gb_table:table(T),
<a name="6961"/> 6961:                                 Y =:= a, true, X =:= 1]),
<a name="6962"/> 6962:        [1] = lookup_keys(H),
<a name="6963"/> 6963:        [1] = qlc:e(H)&quot;&gt;&gt;,
<a name="6964"/> 6964: 
<a name="6965"/> 6965:     &lt;&lt;&quot;T = gb_trees:from_orddict([{{1.0,1},a},{{2.0,2},b}]),
<a name="6966"/> 6966:        H = qlc:q([X || {{1.0,B}=X,_} &lt;- gb_table:table(T),
<a name="6967"/> 6967:                        B == 1]), % skipped
<a name="6968"/> 6968:        [{1.0, 1}] = qlc:e(H),
<a name="6969"/> 6969:        {qlc,_,[{generate,_,{table,_}}], []} = qlc:info(H, {format,debug})&quot;&gt;&gt;,
<a name="6970"/> 6970:     &lt;&lt;&quot;T = gb_trees:from_orddict([{{1.0,1},a},{{2.0,2},b}]),
<a name="6971"/> 6971:        H = qlc:q([X || {{1.0,B}=X,_} &lt;- gb_table:table(T),
<a name="6972"/> 6972:                     B == 1.0]), % skipped
<a name="6973"/> 6973:        [{1.0, 1.0}] = qlc:e(H), % this is how gb_table works...
<a name="6974"/> 6974:        {qlc,_,[{generate,_,{table,_}}], []} = qlc:info(H, {format,debug})&quot;&gt;&gt;,
<a name="6975"/> 6975:     &lt;&lt;&quot;T = gb_trees:from_orddict([{{1.0,1},a},{{2.0,2},b}]),
<a name="6976"/> 6976:        H = qlc:q([X || {{1.0,B}=X,_} &lt;- gb_table:table(T),
<a name="6977"/> 6977:                        B =:= 1.0]), % not skipped
<a name="6978"/> 6978:        [{1.0, 1.0}] = qlc:e(H),
<a name="6979"/> 6979:        {qlc,_,[{generate,_,{table,_}},_], []} = qlc:info(H,{format,debug})&quot;&gt;&gt;,
<a name="6980"/> 6980:     &lt;&lt;&quot;T = gb_trees:from_orddict([{{1.0,1},a},{{2.0,2},b}]),
<a name="6981"/> 6981:        H = qlc:q([X || {{1.0,B}=X,_} &lt;- gb_table:table(T),
<a name="6982"/> 6982:                        B =:= 1]), % not skipped
<a name="6983"/> 6983:        [{1.0, 1}] = qlc:e(H),
<a name="6984"/> 6984:        {qlc,_,[{generate,_,{table,_}},_], []} = qlc:info(H,{format,debug})&quot;&gt;&gt;,
<a name="6985"/> 6985: 
<a name="6986"/> 6986:     &lt;&lt;&quot;%% The imported variables do not interfere with join.
<a name="6987"/> 6987:        E = ets:new(join, [ordered_set]),
<a name="6988"/> 6988:        {A, B} = {1,1},
<a name="6989"/> 6989:        true = ets:insert(E, [{1,a},{2,b},{3,c}]),
<a name="6990"/> 6990:        Q = qlc:q([{X, Y} || {X,_Z} &lt;- ets:table(E),
<a name="6991"/> 6991:                             {Y} &lt;- [{0},{1},{2}],
<a name="6992"/> 6992:                             X =:= A, Y =:= B, 
<a name="6993"/> 6993:                             Y == X], % skipped
<a name="6994"/> 6994:                 {join, merge}),
<a name="6995"/> 6995:        [{1,1}] = qlc:e(Q),
<a name="6996"/> 6996:        {qlc,_,
<a name="6997"/> 6997:            [{generate,_,
<a name="6998"/> 6998:              {qlc,_,
<a name="6999"/> 6999:               [{generate,_,
<a name="7000"/> 7000:                 {qlc,_,[{generate,_,{list,{table,_},_}},_],[]}},
<a name="7001"/> 7001:                {generate,_,
<a name="7002"/> 7002:                 {qlc,_,[{generate,_,{list,_,_}},_],[]}},
<a name="7003"/> 7003:                _],
<a name="7004"/> 7004:               [{join,merge}]}}],
<a name="7005"/> 7005:            []} = qlc:info(Q, {format, debug}),
<a name="7006"/> 7006:        ets:delete(E)&quot;&gt;&gt;,
<a name="7007"/> 7007: 
<a name="7008"/> 7008:     &lt;&lt;&quot;% An old bug: usort() should not be used when matching values
<a name="7009"/> 7009:        etsc(fun(E) -&gt;
<a name="7010"/> 7010:                    I = 1,
<a name="7011"/> 7011:                    H = qlc:q([X || {X,_} &lt;- ets:table(E), 
<a name="7012"/> 7012:                                    X =:= 1.0 orelse X =:= I]),
<a name="7013"/> 7013:                    [1] = qlc:e(H),
<a name="7014"/> 7014:                    [1.0] = lookup_keys(H) % do not look up twice
<a name="7015"/> 7015:             end, [set], [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="7016"/> 7016:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="7017"/> 7017:                    H = qlc:q([X || {X,_} &lt;- ets:table(E), 
<a name="7018"/> 7018:                                     X =:= 1.0 orelse X == 1]),
<a name="7019"/> 7019:                    [1] = qlc:e(H),
<a name="7020"/> 7020:                    false = lookup_keys(H) % doesn't handle this case
<a name="7021"/> 7021:          end, [ordered_set], [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="7022"/> 7022: 
<a name="7023"/> 7023:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="7024"/> 7024:                  I1 = 1, I2 = 1,
<a name="7025"/> 7025:                  H = qlc:q([X || {X,_} &lt;- ets:table(E), 
<a name="7026"/> 7026:                                  X =:= I1 orelse X == I2]),
<a name="7027"/> 7027:                  [1] = qlc:e(H), % do not look up twice
<a name="7028"/> 7028:                  [1] = lookup_keys(H)
<a name="7029"/> 7029:          end, [ordered_set], [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="7030"/> 7030: 
<a name="7031"/> 7031:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="7032"/> 7032:                  I1 = 1, I2 = 1, I3 = 1,
<a name="7033"/> 7033:                  H = qlc:q([X || {X,_} &lt;- ets:table(E), 
<a name="7034"/> 7034:                                  I1 == I2, I1 =:= I3, I3 == I2, I2 =:= I3,
<a name="7035"/> 7035:                                  X =:= I1 orelse X == I2
<a name="7036"/> 7036:                                  ]),
<a name="7037"/> 7037:                  [1] = qlc:e(H),
<a name="7038"/> 7038:                  [1] = lookup_keys(H)
<a name="7039"/> 7039:          end, [ordered_set], [{1,a},{2,b}])&quot;&gt;&gt;,
<a name="7040"/> 7040: 
<a name="7041"/> 7041:     &lt;&lt;&quot;E = ets:new(join, [ordered_set]),
<a name="7042"/> 7042:        true = ets:insert(E, [{1,a},{2,b,x},{3,c}]),
<a name="7043"/> 7043:        Q = qlc:q([P || P &lt;- ets:table(E),
<a name="7044"/> 7044:                        P =:= {1,a} orelse P =:= {2,b,x}]),
<a name="7045"/> 7045:        [{1,a},{2,b,x}] = qlc:e(Q),
<a name="7046"/> 7046:        ets:delete(E)&quot;&gt;&gt;,
<a name="7047"/> 7047: 
<a name="7048"/> 7048:     &lt;&lt;&quot;etsc(fun(E) -&gt;
<a name="7049"/> 7049:                    Q = qlc:q([X || {X,Y} &lt;- ets:table(E), 
<a name="7050"/> 7050:                                    ((X =:= 3) or (Y =:= 4))  and (X == a)]),
<a name="7051"/> 7051:                    {list,{table,_},_} = i(Q),
<a name="7052"/> 7052:                    [] = qlc:e(Q), % a is not an answer
<a name="7053"/> 7053:                    [a] = lookup_keys(Q)
<a name="7054"/> 7054:           end, [{keypos,1},ordered_set], [{a,3},{b,4}])&quot;&gt;&gt;,
<a name="7055"/> 7055: 
<a name="7056"/> 7056:     &lt;&lt;&quot;Q = qlc:q([{X,Y} ||
<a name="7057"/> 7057:                   {X} &lt;- [{&lt;&lt;3:4&gt;&gt;}],
<a name="7058"/> 7058:                   {Y} &lt;- [{&lt;&lt;3:4&gt;&gt;}],
<a name="7059"/> 7059:                   X =:= &lt;&lt;1:3,1:1&gt;&gt;,        % &lt;&lt;3:4&gt;&gt;
<a name="7060"/> 7060:                   Y =:= &lt;&lt;0:2,1:1,1:1&gt;&gt;,    % &lt;&lt;3:4&gt;&gt;
<a name="7061"/> 7061:                   X =:= Y]),
<a name="7062"/> 7062:                   [{&lt;&lt;3:4&gt;&gt;,&lt;&lt;3:4&gt;&gt;}] = qlc:e(Q)&quot;&gt;&gt;
<a name="7063"/> 7063: 
<a name="7064"/> 7064: 
<a name="7065"/> 7065:     ],
<a name="7066"/> 7066: 
<a name="otp_6674-last_expr"/><a name="7067"/> 7067: <b>    run</b>(Config, Ts).
<a name="7068"/> 7068: 
<a name="7069"/> 7069: <i>%% Syntax error.</i>
<a name="otp_12946-1"/><a name="7070"/> 7070: <b>otp_12946</b>(Config) when is_list(Config) -&gt;
<a name="7071"/> 7071:     Text =
<a name="7072"/> 7072:         &lt;&lt;&quot;-export([init/0]).
<a name="7073"/> 7073:            init() -&gt;
<a name="7074"/> 7074:                ok.
<a name="7075"/> 7075:            y&quot;&gt;&gt;,
<a name="7076"/> 7076:     {errors,[{{4,12},erl_parse,_}],[]} = compile_file(Config, Text, []),
<a name="7077"/> 7077:     {errors,[{4,erl_parse,_}],[]} =
<a name="7078"/> 7078:         compile_file(Config, Text, [{error_location, line}]),
<a name="otp_12946-last_expr"/><a name="7079"/> 7079:     ok.
<a name="7080"/> 7080: 
<a name="7081"/> 7081: <i>%% Examples from qlc(3).</i>
<a name="manpage-1"/><a name="7082"/> 7082: <b>manpage</b>(Config) when is_list(Config) -&gt;
<a name="7083"/> 7083:     dets:start(),
<a name="7084"/> 7084:     ok = compile_gb_table(Config),
<a name="7085"/> 7085: 
<a name="7086"/> 7086:     Ts = [
<a name="7087"/> 7087:        &lt;&lt;&quot;QH = qlc:q([{X,Y} || X &lt;- [a,b], Y &lt;- [1,2]]),
<a name="7088"/> 7088:           QC = qlc:cursor(QH),
<a name="7089"/> 7089:           [{a,1}] = qlc:next_answers(QC, 1),
<a name="7090"/> 7090:           [{a,2}] = qlc:next_answers(QC, 1),
<a name="7091"/> 7091:           [{b,1},{b,2}] = qlc:next_answers(QC, all_remaining),
<a name="7092"/> 7092:           ok = qlc:delete_cursor(QC)&quot;&gt;&gt;,
<a name="7093"/> 7093: 
<a name="7094"/> 7094:        &lt;&lt;&quot;QH = qlc:q([{X,Y} || X &lt;- [a,b], Y &lt;- [1,2]]),
<a name="7095"/> 7095:           [{a,1},{a,2},{b,1},{b,2}] = qlc:eval(QH)&quot;&gt;&gt;,
<a name="7096"/> 7096: 
<a name="7097"/> 7097:        &lt;&lt;&quot;QH = [1,2,3,4,5,6],
<a name="7098"/> 7098:           21 = qlc:fold(fun(X, Sum) -&gt; X + Sum end, 0, QH)&quot;&gt;&gt;,
<a name="7099"/> 7099: 
<a name="7100"/> 7100:        &lt;&lt;&quot;QH = qlc:q([{X,Y} || X &lt;- [x,y], Y &lt;- [a,b]]),
<a name="7101"/> 7101:           B = \&quot;begin\n\&quot;
<a name="7102"/> 7102:               \&quot;    V1 =\n\&quot;
<a name="7103"/> 7103:               \&quot;        qlc:q([ \n\&quot;
<a name="7104"/> 7104:               \&quot;               SQV ||\n\&quot;
<a name="7105"/> 7105:               \&quot;                   SQV &lt;- [x, y]\n\&quot;
<a name="7106"/> 7106:               \&quot;              ],\n\&quot;
<a name="7107"/> 7107:               \&quot;              [{unique, true}]),\n\&quot;
<a name="7108"/> 7108:               \&quot;    V2 =\n\&quot;
<a name="7109"/> 7109:               \&quot;        qlc:q([ \n\&quot;
<a name="7110"/> 7110:               \&quot;               SQV ||\n\&quot;
<a name="7111"/> 7111:               \&quot;                   SQV &lt;- [a, b]\n\&quot;
<a name="7112"/> 7112:               \&quot;              ],\n\&quot;
<a name="7113"/> 7113:               \&quot;              [{unique, true}]),\n\&quot;
<a name="7114"/> 7114:               \&quot;    qlc:q([ \n\&quot;
<a name="7115"/> 7115:               \&quot;           {X, Y} ||\n\&quot;
<a name="7116"/> 7116:               \&quot;               X &lt;- V1,\n\&quot;
<a name="7117"/> 7117:               \&quot;               Y &lt;- V2\n\&quot;
<a name="7118"/> 7118:               \&quot;          ],\n\&quot;
<a name="7119"/> 7119:               \&quot;          [{unique, true}])\n\&quot;
<a name="7120"/> 7120:               \&quot;end\&quot;,
<a name="7121"/> 7121:           true = B =:= qlc:info(QH, unique_all)&quot;&gt;&gt;,
<a name="7122"/> 7122: 
<a name="7123"/> 7123:        &lt;&lt;&quot;E1 = ets:new(e1, []),
<a name="7124"/> 7124:           E2 = ets:new(e2, []),
<a name="7125"/> 7125:           true = ets:insert(E1, [{1,a},{2,b}]),
<a name="7126"/> 7126:           true = ets:insert(E2, [{a,1},{b,2}]),
<a name="7127"/> 7127:           Q = qlc:q([{X,Z,W} ||
<a name="7128"/> 7128:                         {X, Z} &lt;- ets:table(E1),
<a name="7129"/> 7129:                         {W, Y} &lt;- ets:table(E2),
<a name="7130"/> 7130:                         X =:= Y]),
<a name="7131"/> 7131:           L = \&quot;begin\n\&quot;
<a name="7132"/> 7132:               \&quot;    V1 =\n\&quot;
<a name="7133"/> 7133:               \&quot;        qlc:q([ \n\&quot;
<a name="7134"/> 7134:               \&quot;               P0 ||\n\&quot;
<a name="7135"/> 7135:               \&quot;                   P0 = {W, Y} &lt;- ets:table(_)\n\&quot;
<a name="7136"/> 7136:               \&quot;              ]),\n\&quot;
<a name="7137"/> 7137:               \&quot;    V2 =\n\&quot;
<a name="7138"/> 7138:               \&quot;        qlc:q([ \n\&quot;
<a name="7139"/> 7139:               \&quot;               [G1 | G2] ||\n\&quot;
<a name="7140"/> 7140:               \&quot;                   G2 &lt;- V1,\n\&quot;
<a name="7141"/> 7141:               \&quot;                   G1 &lt;- ets:table(_),\n\&quot;
<a name="7142"/> 7142:               \&quot;                   element(2, G1) =:= element(1, G2)\n\&quot;
<a name="7143"/> 7143:               \&quot;              ],\n\&quot;
<a name="7144"/> 7144:               \&quot;              [{join, lookup}]),\n\&quot;
<a name="7145"/> 7145:               \&quot;    qlc:q([ \n\&quot;
<a name="7146"/> 7146:               \&quot;           {X, Z, W} ||\n\&quot;
<a name="7147"/> 7147:               \&quot;               [{X, Z} | {W, Y}] &lt;- V2\n\&quot;
<a name="7148"/> 7148:               \&quot;          ])\n\&quot;
<a name="7149"/> 7149:               \&quot;end\&quot;,
<a name="7150"/> 7150:           Info1 =
<a name="7151"/> 7151:              re:replace(qlc:info(Q), 
<a name="7152"/> 7152:                         \&quot;table\\\\(#Ref&lt;[\\.0-9]*&gt;\&quot;,
<a name="7153"/> 7153:                         \&quot;table(_\&quot;, [{return,list},global]),
<a name="7154"/> 7154:           F = fun(C) -&gt; C =/= $\n andalso C =/= $\s end,
<a name="7155"/> 7155:           Info = lists:filter(F, Info1),
<a name="7156"/> 7156:           L1 = lists:filter(F, L),
<a name="7157"/> 7157:           L1 = Info,
<a name="7158"/> 7158:           ets:delete(E1),
<a name="7159"/> 7159:           ets:delete(E2)&quot;&gt;&gt;,
<a name="7160"/> 7160: 
<a name="7161"/> 7161:        &lt;&lt;&quot;Q = qlc:q([{A,X,Z,W} ||
<a name="7162"/> 7162:                         A &lt;- [a,b,c],
<a name="7163"/> 7163:                         {X,Z} &lt;- [{a,1},{b,4},{c,6}],
<a name="7164"/> 7164:                         {W,Y} &lt;- [{2,a},{3,b},{4,c}],
<a name="7165"/> 7165:                         X =:= Y],
<a name="7166"/> 7166:                     {cache, list}),
<a name="7167"/> 7167:           L =
<a name="7168"/> 7168:        \&quot;begin\n\&quot;
<a name="7169"/> 7169:        \&quot;    V1 =\n\&quot;
<a name="7170"/> 7170:        \&quot;        qlc:q([ \n\&quot;
<a name="7171"/> 7171:        \&quot;               P0 ||\n\&quot;
<a name="7172"/> 7172:        \&quot;                   P0 = {X, Z} &lt;-\n\&quot;
<a name="7173"/> 7173:        \&quot;                       qlc:keysort(1, [{a, 1}, {b, 4}, {c, 6}], [])\n\&quot;
<a name="7174"/> 7174:        \&quot;              ]),\n\&quot;
<a name="7175"/> 7175:        \&quot;    V2 =\n\&quot;
<a name="7176"/> 7176:        \&quot;        qlc:q([ \n\&quot;
<a name="7177"/> 7177:        \&quot;               P0 ||\n\&quot;
<a name="7178"/> 7178:        \&quot;                   P0 = {W, Y} &lt;-\n\&quot;
<a name="7179"/> 7179:        \&quot;                       qlc:keysort(2, [{2, a}, {3, b}, {4, c}], [])\n\&quot;
<a name="7180"/> 7180: 
<a name="7181"/> 7181:        \&quot;              ]),\n\&quot;
<a name="7182"/> 7182:        \&quot;    V3 =\n\&quot;
<a name="7183"/> 7183:        \&quot;        qlc:q([ \n\&quot;
<a name="7184"/> 7184:        \&quot;               [G1 | G2] ||\n\&quot;
<a name="7185"/> 7185:        \&quot;                   G1 &lt;- V1,\n\&quot;
<a name="7186"/> 7186:        \&quot;                   G2 &lt;- V2,\n\&quot;
<a name="7187"/> 7187:        \&quot;                   element(1, G1) == element(2, G2)\n\&quot;
<a name="7188"/> 7188:        \&quot;              ],\n\&quot;
<a name="7189"/> 7189:        \&quot;              [{join, merge}, {cache, list}]),\n\&quot;
<a name="7190"/> 7190:        \&quot;    qlc:q([ \n\&quot;
<a name="7191"/> 7191:        \&quot;           {A, X, Z, W} ||\n\&quot;
<a name="7192"/> 7192:        \&quot;               A &lt;- [a, b, c],\n\&quot;
<a name="7193"/> 7193:        \&quot;               [{X, Z} | {W, Y}] &lt;- V3,\n\&quot;
<a name="7194"/> 7194:        \&quot;               X =:= Y\n\&quot;
<a name="7195"/> 7195:        \&quot;          ])\n\&quot;
<a name="7196"/> 7196:        \&quot;end\&quot;,
<a name="7197"/> 7197:           L = qlc:info(Q)&quot;&gt;&gt;,
<a name="7198"/> 7198: 
<a name="7199"/> 7199:        &lt;&lt;&quot;E1 = ets:new(t, [set]), % uses =:=/2
<a name="7200"/> 7200:           Q1 = qlc:q([K ||
<a name="7201"/> 7201:           {K} &lt;- ets:table(E1),
<a name="7202"/> 7202:           K == 2.71 orelse K == a]),
<a name="7203"/> 7203:           {list,{table,_}, [{{'$1'},[],['$1']}]} = i(Q1),
<a name="7204"/> 7204:           true = ets:delete(E1)&quot;&gt;&gt;,
<a name="7205"/> 7205: 
<a name="7206"/> 7206:        &lt;&lt;&quot;F = fun(E, I) -&gt;
<a name="7207"/> 7207:                     qlc:q([V || {K,V} &lt;- ets:table(E), K == I])
<a name="7208"/> 7208:               end,
<a name="7209"/> 7209:           E2 = ets:new(t, [set]),
<a name="7210"/> 7210:           true = ets:insert(E2, [{{2,2},a},{{2,2.0},b},{{2.0,2},c}]),
<a name="7211"/> 7211:           Q2 = F(E2, {2,2}),
<a name="7212"/> 7212:           {table,{ets,table,[_,
<a name="7213"/> 7213:                 [{traverse,{select,[{{'$1','$2'},
<a name="7214"/> 7214:                                      [{'==','$1',{const,{2,2}}}],
<a name="7215"/> 7215:                                      ['$2']}]}}]]}} = i(Q2),
<a name="7216"/> 7216:           [a,b,c] = lists:sort(qlc:e(Q2)),
<a name="7217"/> 7217:           true = ets:delete(E2),
<a name="7218"/> 7218: 
<a name="7219"/> 7219:           E3 = ets:new(t, [ordered_set]), % uses ==/2
<a name="7220"/> 7220:           true = ets:insert(E3, [{{2,2.0},b}]),
<a name="7221"/> 7221:           Q3 = F(E3,{2,2}),
<a name="7222"/> 7222:           {list,{table,_},[{{'$1','$2'},[],['$2']}]} = i(Q3),
<a name="7223"/> 7223:           [b] = qlc:e(Q3),
<a name="7224"/> 7224:           true = ets:delete(E3)&quot;&gt;&gt;,
<a name="7225"/> 7225: 
<a name="7226"/> 7226:        &lt;&lt;&quot;T = gb_trees:empty(),
<a name="7227"/> 7227:           QH = qlc:q([X || {{X,Y},_} &lt;- gb_table:table(T),
<a name="7228"/> 7228:                            ((X == 1) or (X == 2)) andalso
<a name="7229"/> 7229:                            ((Y == a) or (Y == b) or (Y == c))]),
<a name="7230"/> 7230:           L = \&quot;ets:match_spec_run(lists:flatmap(fun(K) -&gt;
<a name="7231"/> 7231:                                         case
<a name="7232"/> 7232:                                             gb_trees:lookup(K,
<a name="7233"/> 7233:                                                             gb_trees:from_orddict([]))
<a name="7234"/> 7234:                                         of
<a name="7235"/> 7235:                                             {value, V} -&gt;
<a name="7236"/> 7236:                                                 [{K, V}];
<a name="7237"/> 7237:                                             none -&gt;
<a name="7238"/> 7238:                                                 []
<a name="7239"/> 7239:                                         end
<a name="7240"/> 7240:                                  end,
<a name="7241"/> 7241:                                  [{1, a},
<a name="7242"/> 7242:                                   {1, b},
<a name="7243"/> 7243:                                   {1, c},
<a name="7244"/> 7244:                                   {2, a},
<a name="7245"/> 7245:                                   {2, b},
<a name="7246"/> 7246:                                   {2, c}]),
<a name="7247"/> 7247:                    ets:match_spec_compile([{{{'$1', '$2'}, '_'},
<a name="7248"/> 7248:                                             [],
<a name="7249"/> 7249:                                             ['$1']}]))\&quot;,
<a name="7250"/> 7250:           L = qlc:info(QH)&quot;&gt;&gt;
<a name="7251"/> 7251:       ],
<a name="7252"/> 7252:     run(Config, Ts),
<a name="7253"/> 7253: 
<a name="7254"/> 7254:     L = [1,2,3],
<a name="7255"/> 7255:     Bs = erl_eval:add_binding('L', L, erl_eval:new_bindings()),
<a name="7256"/> 7256:     QH = qlc:string_to_handle(&quot;[X+1 || X &lt;- L].&quot;, [], Bs),
<a name="7257"/> 7257:     [2,3,4] = qlc:eval(QH),
<a name="7258"/> 7258: 
<a name="7259"/> 7259:     %% ets(3)
<a name="7260"/> 7260:     MS = ets:fun2ms(fun({X,Y}) when (X &gt; 1) or (X &lt; 5) -&gt; {Y} end),
<a name="7261"/> 7261:     ETs = [
<a name="7262"/> 7262:         [&lt;&lt;&quot;true = ets:insert(Tab = ets:new(t, []),[{1,a},{2,b},{3,c},{4,d}]),
<a name="7263"/> 7263:             MS = &quot;&gt;&gt;, io_lib:format(&quot;~w&quot;, [MS]), &lt;&lt;&quot;,
<a name="7264"/> 7264:             QH1 = ets:table(Tab, [{traverse, {select, MS}}]),
<a name="7265"/> 7265: 
<a name="7266"/> 7266:             QH2 = qlc:q([{Y} || {X,Y} &lt;- ets:table(Tab), (X &gt; 1) or (X &lt; 5)]),
<a name="7267"/> 7267: 
<a name="7268"/> 7268:             true = qlc:info(QH1) =:= qlc:info(QH2),
<a name="7269"/> 7269:             true = ets:delete(Tab)&quot;&gt;&gt;]],
<a name="7270"/> 7270:     run(Config, ETs),
<a name="7271"/> 7271: 
<a name="7272"/> 7272:     %% dets(3)
<a name="7273"/> 7273:     DTs = [
<a name="7274"/> 7274:         [&lt;&lt;&quot;{ok, T} = dets:open_file(t, []),
<a name="7275"/> 7275:             ok = dets:insert(T, [{1,a},{2,b},{3,c},{4,d}]),
<a name="7276"/> 7276:             MS = &quot;&gt;&gt;, io_lib:format(&quot;~w&quot;, [MS]), &lt;&lt;&quot;,
<a name="7277"/> 7277:             QH1 = dets:table(T, [{traverse, {select, MS}}]),
<a name="7278"/> 7278: 
<a name="7279"/> 7279:             QH2 = qlc:q([{Y} || {X,Y} &lt;- dets:table(t), (X &gt; 1) or (X &lt; 5)]),
<a name="7280"/> 7280: 
<a name="7281"/> 7281:             true = qlc:info(QH1) =:= qlc:info(QH2),
<a name="7282"/> 7282:             ok = dets:close(T)&quot;&gt;&gt;]],
<a name="7283"/> 7283:     run(Config, DTs),
<a name="7284"/> 7284: 
<a name="manpage-last_expr"/><a name="7285"/> 7285:     ok.
<a name="7286"/> 7286: 
<a name="compile_gb_table-1"/><a name="7287"/> 7287: <b>compile_gb_table</b>(Config) -&gt;
<a name="7288"/> 7288:     GB_table_file = filename(&quot;gb_table.erl&quot;, Config),
<a name="7289"/> 7289:     ok = file:write_file(GB_table_file, gb_table()),
<a name="7290"/> 7290:     {ok, gb_table} = compile:file(GB_table_file, [{outdir,?privdir}]),
<a name="7291"/> 7291:     code:purge(gb_table),
<a name="7292"/> 7292:     {module, gb_table} =
<a name="7293"/> 7293:         code:load_abs(filename:rootname(GB_table_file)),
<a name="compile_gb_table-last_expr"/><a name="7294"/> 7294:     ok.
<a name="7295"/> 7295: 
<a name="gb_table-0"/><a name="7296"/> 7296: <b>gb_table</b>() -&gt;
<a name="gb_table-last_expr"/><a name="7297"/> 7297:     &lt;&lt;&quot;
<a name="7298"/> 7298: <b>-module</b>(gb_table).
<a name="7299"/> 7299: 
<a name="7300"/> 7300: <b>-export</b>([table/1]).
<a name="7301"/> 7301: 
<a name="7302"/> 7302: table(T) -&gt;
<a name="7303"/> 7303:     TF = fun() -&gt; qlc_next(gb_trees:next(gb_trees:iterator(T))) end,
<a name="7304"/> 7304:     InfoFun = fun(num_of_objects) -&gt; gb_trees:size(T);
<a name="7305"/> 7305:                  (keypos) -&gt; 1;
<a name="7306"/> 7306:                  (is_sorted_key) -&gt; true;
<a name="7307"/> 7307:                  (is_unique_objects) -&gt; true;
<a name="7308"/> 7308:                  (_) -&gt; undefined
<a name="7309"/> 7309:               end,
<a name="7310"/> 7310:     LookupFun =
<a name="7311"/> 7311:         fun(1, Ks) -&gt;
<a name="7312"/> 7312:                 lists:flatmap(fun(K) -&gt;
<a name="7313"/> 7313:                                       case gb_trees:lookup(K, T) of
<a name="7314"/> 7314:                                           {value, V} -&gt; [{K,V}];
<a name="7315"/> 7315:                                           none -&gt; []
<a name="7316"/> 7316:                                       end
<a name="7317"/> 7317:                               end, Ks)
<a name="7318"/> 7318:         end,
<a name="7319"/> 7319:     FormatFun =
<a name="7320"/> 7320:         fun({all, NElements, ElementFun}) -&gt;
<a name="7321"/> 7321:                 ValsS = io_lib:format(\&quot;gb_trees:from_orddict(~w)\&quot;,
<a name="7322"/> 7322:                                       [gb_nodes(T, NElements, ElementFun)]),
<a name="7323"/> 7323:                 io_lib:format(\&quot;gb_table:table(~s)\&quot;, [ValsS]);
<a name="7324"/> 7324:            ({lookup, 1, KeyValues, _NElements, ElementFun}) -&gt;
<a name="7325"/> 7325:                 ValsS = io_lib:format(\&quot;gb_trees:from_orddict(~w)\&quot;,
<a name="7326"/> 7326:                                       [gb_nodes(T, infinity, ElementFun)]),
<a name="7327"/> 7327:                 io_lib:format(\&quot;lists:flatmap(fun(K) -&gt; \&quot;
<a name="7328"/> 7328:                               \&quot;case gb_trees:lookup(K, ~s) of \&quot;
<a name="7329"/> 7329:                               \&quot;{value, V} -&gt; [{K,V}];none -&gt; [] end \&quot;
<a name="7330"/> 7330:                               \&quot;end, ~w)\&quot;,
<a name="7331"/> 7331:                               [ValsS, [ElementFun(KV) || KV &lt;- KeyValues]])
<a name="7332"/> 7332:         end,
<a name="7333"/> 7333:     qlc:table(TF, [{info_fun, InfoFun}, {format_fun, FormatFun},
<a name="7334"/> 7334:                    {lookup_fun, LookupFun},{key_equality,'=='}]).
<a name="7335"/> 7335: 
<a name="7336"/> 7336: qlc_next({X, V, S}) -&gt;
<a name="7337"/> 7337:     [{X,V} | fun() -&gt; qlc_next(gb_trees:next(S)) end];
<a name="7338"/> 7338: qlc_next(none) -&gt;
<a name="7339"/> 7339:     [].
<a name="7340"/> 7340: 
<a name="7341"/> 7341: gb_nodes(T, infinity, ElementFun) -&gt;
<a name="7342"/> 7342:     gb_nodes(T, -1, ElementFun);
<a name="7343"/> 7343: gb_nodes(T, NElements, ElementFun) -&gt;
<a name="7344"/> 7344:     gb_iter(gb_trees:iterator(T), NElements, ElementFun).
<a name="7345"/> 7345: 
<a name="7346"/> 7346: gb_iter(_I, 0, _EFun) -&gt;
<a name="7347"/> 7347:     '...';
<a name="7348"/> 7348: gb_iter(I0, N, EFun) -&gt;
<a name="7349"/> 7349:     case gb_trees:next(I0) of
<a name="7350"/> 7350:         {X, V, I} -&gt;
<a name="7351"/> 7351:             [EFun({X,V}) | gb_iter(I, N-1, EFun)];
<a name="7352"/> 7352:         none -&gt;
<a name="7353"/> 7353:             []
<a name="7354"/> 7354:     end.
<a name="7355"/> 7355:     &quot;&gt;&gt;.
<a name="7356"/> 7356: 
<a name="7357"/> 7357: 
<a name="7358"/> 7358: <i>%% OTP-6674. Join info and extra constants.</i>
<a name="backward-1"/><a name="7359"/> 7359: <b>backward</b>(Config) when is_list(Config) -&gt;
<a name="7360"/> 7360:     try_old_join_info(Config),
<a name="backward-last_expr"/><a name="7361"/> 7361:     ok.
<a name="7362"/> 7362: 
<a name="try_old_join_info-1"/><a name="7363"/> 7363: <b>try_old_join_info</b>(Config) -&gt;
<a name="7364"/> 7364:     %% Check join info for handlers of extra constants.
<a name="7365"/> 7365:     File = filename:join(?datadir, &quot;join_info_compat.erl&quot;),
<a name="7366"/> 7366:     M = join_info_compat,
<a name="7367"/> 7367:     {ok, M} = compile:file(File, [{outdir, ?datadir}]),
<a name="7368"/> 7368:     {module, M} = code:load_abs(filename:rootname(File)),
<a name="7369"/> 7369:     H = M:create_handle(),
<a name="7370"/> 7370:     A0 = erl_anno:new(0),
<a name="7371"/> 7371:     {block,A0,
<a name="7372"/> 7372:      [{match,_,_,
<a name="7373"/> 7373:        {call,_,_,
<a name="7374"/> 7374:         [{lc,_,_,
<a name="7375"/> 7375:           [_,
<a name="7376"/> 7376:            {op,_,'=:=',
<a name="7377"/> 7377:             {float,_,192.0},
<a name="7378"/> 7378:             {call,_,{atom,_,element},[{integer,_,1},_]}}]}]}},
<a name="7379"/> 7379:       _,_,
<a name="7380"/> 7380:       {call,_,_,
<a name="7381"/> 7381:        [{lc,_,_,
<a name="7382"/> 7382:          [_,
<a name="7383"/> 7383:           {op,_,'=:=',{var,_,'B'},{float,_,192.0}},
<a name="7384"/> 7384:           {op,_,'==',{var,_,'X'},{var,_,'Y'}}]}]}]}
<a name="7385"/> 7385:         = qlc:info(H,{format,abstract_code}),
<a name="7386"/> 7386:     [{1,1},{2,2}] = qlc:e(H),
<a name="7387"/> 7387: 
<a name="7388"/> 7388:     H2 = M:lookup_handle(),
<a name="7389"/> 7389:     {qlc,_,[{generate,_,{qlc,_,_,[{join,lookup}]}},_],[]} =
<a name="7390"/> 7390:         qlc:info(H2, {format,debug}),
<a name="try_old_join_info-last_expr"/><a name="7391"/> 7391: <b>    [{1,1},{2,2}] = qlc:e</b>(H2).
<a name="7392"/> 7392: 
<a name="forward-1"/><a name="7393"/> 7393: <b>forward</b>(Config) when is_list(Config) -&gt;
<a name="7394"/> 7394:     Ts = [
<a name="7395"/> 7395:       %% LC_fun() returns something unknown.
<a name="7396"/> 7396:       &lt;&lt;&quot;FakeH = {qlc_handle,{qlc_lc,fun() -&gt; {foo,bar} end,
<a name="7397"/> 7397:                              {qlc_opt,false,false,-1,any,[],any,524288}}},
<a name="7398"/> 7398:          {'EXIT', {{unsupported_qlc_handle,_},_}} = (catch qlc:e(FakeH))&quot;&gt;&gt;,
<a name="7399"/> 7399: 
<a name="7400"/> 7400: <i>%% 'f1' should be used for new stuff that does not interfer with old behavior</i>
<a name="7401"/> 7401: <i>%%       %% The unused element 'f1' of #qlc_table seems to be used.</i>
<a name="7402"/> 7402: <i>%%       &lt;&lt;&quot;DF = fun() -&gt; foo end,</i>
<a name="7403"/> 7403: <i>%%          FakeH = {qlc_handle,{qlc_table,DF,</i>
<a name="7404"/> 7404: <i>%%                        true,DF,DF,DF,DF,DF,</i>
<a name="7405"/> 7405: <i>%%                        undefined,not_undefined,undefined,no_match_spec}},</i>
<a name="7406"/> 7406: <i>%%          {'EXIT', {{unsupported_qlc_handle,_},_}} = (catch qlc:e(FakeH))&quot;&gt;&gt;,</i>
<a name="7407"/> 7407: 
<a name="7408"/> 7408:       %% #qlc_opt has changed.
<a name="7409"/> 7409:       &lt;&lt;&quot;H = qlc:q([X || X &lt;- []]),
<a name="7410"/> 7410:          {qlc_handle, {qlc_lc, Fun, _Opt}} = H,
<a name="7411"/> 7411:          FakeH = {qlc_handle, {qlc_lc, Fun, {new_qlc_opt, a,b,c}}},
<a name="7412"/> 7412:          {'EXIT', {{unsupported_qlc_handle,_},_}} = (catch qlc:e(FakeH))&quot;&gt;&gt;
<a name="7413"/> 7413: 
<a name="7414"/> 7414:      ],
<a name="7415"/> 7415:     run(Config, Ts),
<a name="forward-last_expr"/><a name="7416"/> 7416:     ok.
<a name="7417"/> 7417: 
<a name="eep37-1"/><a name="7418"/> 7418: <b>eep37</b>(Config) when is_list(Config) -&gt;
<a name="7419"/> 7419:     Ts = [
<a name="7420"/> 7420:         &lt;&lt;&quot;H = (fun _Handle() -&gt; qlc:q([X || X &lt;- []]) end)(),
<a name="7421"/> 7421:            [] = qlc:eval(H)&quot;&gt;&gt;
<a name="7422"/> 7422:     ],
<a name="7423"/> 7423:     run(Config, Ts),
<a name="eep37-last_expr"/><a name="7424"/> 7424:     ok.
<a name="7425"/> 7425: 
<a name="7426"/> 7426: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7427"/> 7427: 
<a name="bad_table_throw-1"/><a name="7428"/> 7428: <b>bad_table_throw</b>(Tab) -&gt;
<a name="7429"/> 7429:     Limit = 1,
<a name="7430"/> 7430:     Select = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7431"/> 7431:     PreFun = fun(_) -&gt; throw({throw,bad_pre_fun}) end,
<a name="7432"/> 7432:     PostFun = fun() -&gt; throw({throw,bad_post_fun}) end,
<a name="7433"/> 7433:     InfoFun = fun(Tag) -&gt; info(Tab, Tag) end,
<a name="bad_table_throw-last_expr"/><a name="7434"/> 7434: <b>    qlc:table</b>(Select, [{pre_fun,PreFun}, {post_fun, PostFun}, 
<a name="7435"/> 7435:                        {info_fun, InfoFun}]).
<a name="7436"/> 7436:     
<a name="bad_table_exit-1"/><a name="7437"/> 7437: <b>bad_table_exit</b>(Tab) -&gt;
<a name="7438"/> 7438:     Limit = 1,
<a name="7439"/> 7439:     Select = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7440"/> 7440:     PreFun = fun(_) -&gt; erlang:error(bad_pre_fun) end,
<a name="7441"/> 7441:     PostFun = fun() -&gt; erlang:error(bad_post_fun) end,
<a name="7442"/> 7442:     InfoFun = fun(Tag) -&gt; info(Tab, Tag) end,
<a name="bad_table_exit-last_expr"/><a name="7443"/> 7443: <b>    qlc:table</b>(Select, [{pre_fun,PreFun}, {post_fun, PostFun}, 
<a name="7444"/> 7444:                        {info_fun, InfoFun}]).
<a name="7445"/> 7445:     
<a name="info-2"/><a name="7446"/> 7446: <b>info</b>(_Tab, is_unique_objects) -&gt; 
<a name="7447"/> 7447:     false;
<a name="7448"/> 7448: <b>info</b>(Tab, Tag) -&gt; 
<a name="info-last_expr"/><a name="7449"/> 7449: <b>    try ets:info</b>(Tab, Tag) catch _:_ -&gt; undefined end.
<a name="7450"/> 7450: 
<a name="create_ets-2"/><a name="7451"/> 7451: <b>create_ets</b>(S, E) -&gt;
<a name="create_ets-last_expr"/><a name="7452"/> 7452: <b>    create_ets</b>(lists:seq(S, E)).
<a name="7453"/> 7453: 
<a name="create_ets-1"/><a name="7454"/> 7454: <b>create_ets</b>(L) -&gt;
<a name="7455"/> 7455:     E1 = ets:new(e, []),
<a name="7456"/> 7456:     true = ets:insert(E1, [{X,X} || X &lt;- L]),
<a name="create_ets-last_expr"/><a name="7457"/> 7457:     E1.
<a name="7458"/> 7458: 
<a name="etsc-2"/><a name="7459"/> 7459: <b>etsc</b>(F, Objs) -&gt;
<a name="etsc-last_expr"/><a name="7460"/> 7460: <b>    etsc</b>(F, [{keypos,1}], Objs).
<a name="7461"/> 7461: 
<a name="etsc-3"/><a name="7462"/> 7462: <b>etsc</b>(F, Opts, Objs) -&gt;
<a name="7463"/> 7463:     E = ets:new(test, Opts),
<a name="7464"/> 7464:     true = ets:insert(E, Objs),
<a name="7465"/> 7465:     V = F(E),
<a name="7466"/> 7466:     ets:delete(E),
<a name="etsc-last_expr"/><a name="7467"/> 7467:     V.
<a name="7468"/> 7468: 
<a name="join_info-1"/><a name="7469"/> 7469: <b>join_info</b>(H) -&gt;
<a name="7470"/> 7470:     {qlc, S, Options} = strip_qlc_call(H),
<a name="7471"/> 7471:     %% &quot;Hide&quot; the call to qlc_pt from the test in run_test().
<a name="7472"/> 7472:     LoadedPT = code:is_loaded(qlc_pt),
<a name="7473"/> 7473:     QH = qlc:string_to_handle(S, Options, []),
<a name="7474"/> 7474:     _ = [unload_pt() || false &lt;- [LoadedPT]], % doesn't take long...
<a name="join_info-last_expr"/><a name="7475"/> 7475: <b>    case {join_info_count</b>(H), join_info_count(QH)} of
<a name="7476"/> 7476:         {N, N} -&gt; 
<a name="7477"/> 7477:             N;
<a name="7478"/> 7478:         Ns -&gt; 
<a name="7479"/> 7479:             Ns
<a name="7480"/> 7480:     end.
<a name="7481"/> 7481: 
<a name="strip_qlc_call-1"/><a name="7482"/> 7482: <b>strip_qlc_call</b>(H) -&gt;
<a name="7483"/> 7483:     S = qlc:info(H, {flat, false}),
<a name="7484"/> 7484:     {ok, Tokens, _EndLine} = erl_scan:string(S++&quot;.&quot;, 1, [text]),
<a name="7485"/> 7485:     {ok, [Expr]} = erl_eval:extended_parse_exprs(Tokens),
<a name="strip_qlc_call-last_expr"/><a name="7486"/> 7486:     case Expr of
<a name="7487"/> 7487:         {call,_,{remote,_,{atom,_,qlc},{atom,_,q}},[LC]} -&gt;
<a name="7488"/> 7488:             {qlc, lists:flatten([erl_pp:expr(LC), &quot;.&quot;]), []};
<a name="7489"/> 7489:         {call,_,{remote,_,{atom,_,qlc},{atom,_,q}},[LC, Opts]} -&gt;
<a name="7490"/> 7490:             {qlc, lists:flatten([erl_pp:expr(LC), &quot;.&quot;]),
<a name="7491"/> 7491:              erl_parse:normalise(Opts)};
<a name="7492"/> 7492:         {call,_,{remote,_,{atom,_,ets},{atom,_,match_spec_run}},_} -&gt;
<a name="7493"/> 7493:             {match_spec, Expr};
<a name="7494"/> 7494:         {call,_,{remote,_,{atom,_,M},{atom,_,table}},_} -&gt;
<a name="7495"/> 7495:             {table, M, Expr};
<a name="7496"/> 7496:         _ -&gt;
<a name="7497"/> 7497:             []
<a name="7498"/> 7498:     end.
<a name="7499"/> 7499: 
<a name="7500"/> 7500: <b>-record</b>(ji, {nmerge = 0, nlookup = 0, nnested_loop = 0, nkeysort = 0}).
<a name="7501"/> 7501: 
<a name="7502"/> 7502: <i>%% Counts join options and (all) calls to qlc:keysort().</i>
<a name="join_info_count-1"/><a name="7503"/> 7503: <b>join_info_count</b>(H) -&gt;
<a name="7504"/> 7504:     S = qlc:info(H, {flat, false}),    
<a name="7505"/> 7505:     {ok, Tokens, _EndLine} = erl_scan:string(S++&quot;.&quot;, 1, [text]),
<a name="7506"/> 7506:     {ok, [Expr]} = erl_eval:extended_parse_exprs(Tokens),
<a name="7507"/> 7507:     #ji{nmerge = Nmerge, nlookup = Nlookup, 
<a name="7508"/> 7508:         nkeysort = NKeysort, nnested_loop = Nnested_loop} = 
<a name="7509"/> 7509:         ji(Expr, #ji{}),
<a name="join_info_count-last_expr"/><a name="7510"/> 7510:     {Nmerge, Nlookup, Nnested_loop, NKeysort}.
<a name="7511"/> 7511: 
<a name="ji-2"/><a name="7512"/> 7512: <b>ji</b>({call,_,{remote,_,{atom,_,qlc},{atom,_,q}},[LC,Options]}, JI) -&gt;
<a name="7513"/> 7513:     NJI = case lists:keysearch(join, 1, erl_parse:normalise(Options)) of
<a name="7514"/> 7514:               {value, {join, merge}} -&gt;
<a name="7515"/> 7515:                   JI#ji{nmerge = JI#ji.nmerge + 1};
<a name="7516"/> 7516:               {value, {join, lookup}} -&gt;
<a name="7517"/> 7517:                   JI#ji{nlookup = JI#ji.nlookup + 1};
<a name="7518"/> 7518:               {value, {join, nested_loop}} -&gt;
<a name="7519"/> 7519:                   JI#ji{nnested_loop = JI#ji.nnested_loop + 1};
<a name="7520"/> 7520:               _  -&gt;
<a name="7521"/> 7521:                   JI
<a name="7522"/> 7522:           end,
<a name="7523"/> 7523:     ji(LC, NJI);
<a name="7524"/> 7524: <b>ji</b>({call,_,{remote,_,{atom,_,qlc},{atom,_,keysort}},[_KP,H,_Options]}, JI) -&gt;
<a name="7525"/> 7525:     ji(H, JI#ji{nkeysort = JI#ji.nkeysort + 1});
<a name="7526"/> 7526: <b>ji</b>(T, JI) when is_tuple(T) -&gt;
<a name="7527"/> 7527:     ji(tuple_to_list(T), JI);
<a name="7528"/> 7528: <b>ji</b>([E | Es], JI) -&gt;
<a name="7529"/> 7529:     ji(Es, ji(E, JI));
<a name="7530"/> 7530: <b>ji</b>(_, JI) -&gt;
<a name="ji-last_expr"/><a name="7531"/> 7531:     JI.
<a name="7532"/> 7532: 
<a name="7533"/> 7533: <i>%% Designed for ETS' and gb_table's format funs.</i>
<a name="lookup_keys-1"/><a name="7534"/> 7534: <b>lookup_keys</b>(Q) -&gt;
<a name="lookup_keys-last_expr"/><a name="7535"/> 7535: <b>    case lists:flatten</b>(lookup_keys(i(Q), [])) of
<a name="7536"/> 7536:         [] -&gt; false;
<a name="7537"/> 7537:         L -&gt; lists:usort(L)
<a name="7538"/> 7538:     end.
<a name="7539"/> 7539: 
<a name="lookup_keys-2"/><a name="7540"/> 7540: <b>lookup_keys</b>([Q | Qs], L) -&gt;
<a name="7541"/> 7541:     lookup_keys(Qs, lookup_keys(Q, L));
<a name="7542"/> 7542: <b>lookup_keys</b>({qlc,_,Quals,_}, L) -&gt;
<a name="7543"/> 7543:     lookup_keys(Quals, L);
<a name="7544"/> 7544: <b>lookup_keys</b>({list,Q,_}, L) -&gt;
<a name="7545"/> 7545:     lookup_keys(Q, L);
<a name="7546"/> 7546: <b>lookup_keys</b>({generate,_,Q}, L) -&gt;
<a name="7547"/> 7547:     lookup_keys(Q, L);
<a name="7548"/> 7548: <b>lookup_keys</b>({table,Chars}, L) when is_list(Chars) -&gt;
<a name="7549"/> 7549:     {ok, Tokens, _} = erl_scan:string(lists:flatten(Chars++&quot;.&quot;), 1, [text]),
<a name="7550"/> 7550:     {ok, [Expr]} = erl_eval:extended_parse_exprs(Tokens),
<a name="7551"/> 7551:     case Expr of
<a name="7552"/> 7552:         {call,_,_,[_fun,AKs]} -&gt;
<a name="7553"/> 7553:             case erl_parse:normalise(AKs) of
<a name="7554"/> 7554:                 Ks when is_list(Ks) -&gt;
<a name="7555"/> 7555:                     [lists:sort(Ks) | L];
<a name="7556"/> 7556:                 K -&gt; % assume keys are never lists (ets only)
<a name="7557"/> 7557:                     [K | L]
<a name="7558"/> 7558:             end;
<a name="7559"/> 7559:         _ -&gt; % gb_table
<a name="7560"/> 7560:             L
<a name="7561"/> 7561:     end;
<a name="7562"/> 7562: <b>lookup_keys</b>(_Q, L) -&gt;
<a name="lookup_keys-last_expr"/><a name="7563"/> 7563:     L.
<a name="7564"/> 7564: 
<a name="bad_table_format-1"/><a name="7565"/> 7565: <b>bad_table_format</b>(Tab) -&gt;
<a name="7566"/> 7566:     Limit = 1,
<a name="7567"/> 7567:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7568"/> 7568:     FormatFun = {is, no, good},
<a name="bad_table_format-last_expr"/><a name="7569"/> 7569: <b>    qlc:table</b>(SelectFun, [{format_fun, FormatFun}]).
<a name="7570"/> 7570: 
<a name="bad_table_format_arity-1"/><a name="7571"/> 7571: <b>bad_table_format_arity</b>(Tab) -&gt;
<a name="7572"/> 7572:     Limit = 1,
<a name="7573"/> 7573:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7574"/> 7574:     FormatFun = fun() -&gt; {?MODULE, bad_table_format_arity, [Tab]} end,
<a name="bad_table_format_arity-last_expr"/><a name="7575"/> 7575: <b>    qlc:table</b>(SelectFun, [{format_fun, FormatFun}]).
<a name="7576"/> 7576: 
<a name="bad_table_traverse-1"/><a name="7577"/> 7577: <b>bad_table_traverse</b>(Tab) -&gt;
<a name="7578"/> 7578:     Limit = 1,
<a name="7579"/> 7579:     Select = fun(MS, _) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="bad_table_traverse-last_expr"/><a name="7580"/> 7580: <b>    qlc:table</b>(Select, []).
<a name="7581"/> 7581:     
<a name="bad_table_post-1"/><a name="7582"/> 7582: <b>bad_table_post</b>(Tab) -&gt;
<a name="7583"/> 7583:     Limit = 1,
<a name="7584"/> 7584:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="bad_table_post-last_expr"/><a name="7585"/> 7585: <b>    qlc:table</b>(SelectFun, [{pre_fun,undefined}, 
<a name="7586"/> 7586:                           {post_fun, fun(X) -&gt; X end}, 
<a name="7587"/> 7587:                           {info_fun, undefined}]).
<a name="7588"/> 7588:     
<a name="bad_table_lookup-1"/><a name="7589"/> 7589: <b>bad_table_lookup</b>(Tab) -&gt;
<a name="7590"/> 7590:     Limit = 1,
<a name="7591"/> 7591:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="bad_table_lookup-last_expr"/><a name="7592"/> 7592: <b>    qlc:table</b>(SelectFun, {lookup_fun, fun(X) -&gt; X end}).
<a name="7593"/> 7593: 
<a name="bad_table_max_lookup-1"/><a name="7594"/> 7594: <b>bad_table_max_lookup</b>(Tab) -&gt;
<a name="7595"/> 7595:     Limit = 1,
<a name="7596"/> 7596:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="bad_table_max_lookup-last_expr"/><a name="7597"/> 7597: <b>    qlc:table</b>(SelectFun, {max_lookup, -2}).
<a name="7598"/> 7598: 
<a name="bad_table_info_arity-1"/><a name="7599"/> 7599: <b>bad_table_info_arity</b>(Tab) -&gt;
<a name="7600"/> 7600:     Limit = 1,
<a name="7601"/> 7601:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7602"/> 7602:     InfoFun = fun() -&gt; {?MODULE, bad_table_info_arity, [Tab]} end,
<a name="bad_table_info_arity-last_expr"/><a name="7603"/> 7603: <b>    qlc:table</b>(SelectFun, [{info_fun, InfoFun}]).
<a name="7604"/> 7604: 
<a name="default_table-1"/><a name="7605"/> 7605: <b>default_table</b>(Tab) -&gt;
<a name="7606"/> 7606:     Limit = 1,
<a name="7607"/> 7607:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="default_table-last_expr"/><a name="7608"/> 7608: <b>    qlc:table</b>(SelectFun, [{format_fun, undefined},
<a name="7609"/> 7609:                           {info_fun, undefined},
<a name="7610"/> 7610:                           {lookup_fun, undefined},
<a name="7611"/> 7611:                           {parent_fun, undefined},
<a name="7612"/> 7612:                           {pre_fun,undefined}, 
<a name="7613"/> 7613:                           {post_fun, undefined}]).
<a name="7614"/> 7614:     
<a name="bad_table-1"/><a name="7615"/> 7615: <b>bad_table</b>(Tab) -&gt;
<a name="7616"/> 7616:     Limit = 1,
<a name="7617"/> 7617:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="bad_table-last_expr"/><a name="7618"/> 7618: <b>    qlc:table</b>(SelectFun, [{info, fun() -&gt; ok end}]).
<a name="7619"/> 7619: 
<a name="bad_table_info_fun_n_objects-1"/><a name="7620"/> 7620: <b>bad_table_info_fun_n_objects</b>(Tab) -&gt;
<a name="7621"/> 7621:     Limit = 1,
<a name="7622"/> 7622:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7623"/> 7623:     LookupFun = fun(_Pos, Ks) -&gt; 
<a name="7624"/> 7624:                         lists:flatmap(fun(K) -&gt; ets:lookup(Tab, K) end, Ks) 
<a name="7625"/> 7625:                 end,
<a name="7626"/> 7626:     InfoFun = fun(num_of_objects) -&gt; exit(finito);
<a name="7627"/> 7627:                  (_) -&gt; undefined
<a name="7628"/> 7628:               end,
<a name="bad_table_info_fun_n_objects-last_expr"/><a name="7629"/> 7629: <b>    qlc:table</b>(SelectFun, [{info_fun, InfoFun}, {lookup_fun, LookupFun}]).
<a name="7630"/> 7630: 
<a name="bad_table_info_fun_indices-1"/><a name="7631"/> 7631: <b>bad_table_info_fun_indices</b>(Tab) -&gt;
<a name="7632"/> 7632:     Limit = 1,
<a name="7633"/> 7633:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7634"/> 7634:     LookupFun = fun(_Pos, Ks) -&gt; 
<a name="7635"/> 7635:                         lists:flatmap(fun(K) -&gt; ets:lookup(Tab, K) end, Ks) 
<a name="7636"/> 7636:                 end,
<a name="7637"/> 7637:     InfoFun = fun(indices) -&gt; throw({throw,apa});
<a name="7638"/> 7638:                  (_) -&gt; undefined
<a name="7639"/> 7639:               end,
<a name="bad_table_info_fun_indices-last_expr"/><a name="7640"/> 7640: <b>    qlc:table</b>(SelectFun, [{info_fun, InfoFun}, {lookup_fun, LookupFun}]).
<a name="7641"/> 7641: 
<a name="bad_table_info_fun_keypos-1"/><a name="7642"/> 7642: <b>bad_table_info_fun_keypos</b>(Tab) -&gt;
<a name="7643"/> 7643:     Limit = 1,
<a name="7644"/> 7644:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7645"/> 7645:     LookupFun = fun(_Pos, Ks) -&gt; 
<a name="7646"/> 7646:                         lists:flatmap(fun(K) -&gt; ets:lookup(Tab, K) end, Ks) 
<a name="7647"/> 7647:                 end,
<a name="7648"/> 7648:     InfoFun = fun(indices) -&gt; erlang:error(keypos);
<a name="7649"/> 7649:                   (_) -&gt; undefined
<a name="7650"/> 7650:               end,
<a name="bad_table_info_fun_keypos-last_expr"/><a name="7651"/> 7651: <b>    qlc:table</b>(SelectFun, [{info_fun, InfoFun}, {lookup_fun, LookupFun}]).
<a name="7652"/> 7652: 
<a name="bad_table_key_equality-1"/><a name="7653"/> 7653: <b>bad_table_key_equality</b>(Tab) -&gt;
<a name="7654"/> 7654:     Limit = 1,
<a name="7655"/> 7655:     SelectFun = fun(MS) -&gt; cb(ets:select(Tab, MS, Limit)) end,
<a name="7656"/> 7656:     LookupFun = fun(_Pos, Ks) -&gt; 
<a name="7657"/> 7657:                         lists:flatmap(fun(K) -&gt; ets:lookup(Tab, K) end, Ks) 
<a name="7658"/> 7658:                 end,
<a name="bad_table_key_equality-last_expr"/><a name="7659"/> 7659: <b>    qlc:table</b>(SelectFun, [{lookup_fun, LookupFun},{key_equality,'=/='}]).
<a name="7660"/> 7660: 
<a name="cb-1"/><a name="7661"/> 7661: <b>cb</b>('$end_of_table') -&gt; 
<a name="7662"/> 7662:     [];
<a name="7663"/> 7663: <b>cb</b>({Objects,Cont}) -&gt; 
<a name="cb-last_expr"/><a name="7664"/> 7664: <b>    Objects ++ fun</b>() -&gt; cb(ets:select(Cont)) end.
<a name="7665"/> 7665: 
<a name="i-1"/><a name="7666"/> 7666: <b>i</b>(H) -&gt;
<a name="i-last_expr"/><a name="7667"/> 7667: <b>    i</b>(H, []).
<a name="7668"/> 7668: 
<a name="i-2"/><a name="7669"/> 7669: <b>i</b>(H, Options) when is_list(Options) -&gt;
<a name="7670"/> 7670:     case has_format(Options) of
<a name="7671"/> 7671:         true -&gt; qlc:info(H, Options);
<a name="7672"/> 7672:         false -&gt; qlc:info(H, [{format, debug} | Options])
<a name="7673"/> 7673:     end;
<a name="7674"/> 7674: <b>i</b>(H, Option) -&gt;
<a name="i-last_expr"/><a name="7675"/> 7675: <b>    i</b>(H, [Option]).
<a name="7676"/> 7676: 
<a name="has_format-1"/><a name="7677"/> 7677: <b>has_format</b>({format,_}) -&gt;
<a name="7678"/> 7678:     true;
<a name="7679"/> 7679: <b>has_format</b>([E | Es]) -&gt;
<a name="7680"/> 7680:     has_format(E) orelse has_format(Es);
<a name="7681"/> 7681: <b>has_format</b>(_) -&gt;
<a name="has_format-last_expr"/><a name="7682"/> 7682:     false.
<a name="7683"/> 7683: 
<a name="format_info-2"/><a name="7684"/> 7684: <b>format_info</b>(H, Flat) -&gt;
<a name="7685"/> 7685:     L = qlc:info(H, [{flat, Flat}, {format,string}]),
<a name="format_info-last_expr"/><a name="7686"/> 7686: <b>    re:replace</b>(L, &quot;\s|\n|\t|\f|\r|\v&quot;, &quot;&quot;, [{return,list},global]).
<a name="7687"/> 7687: 
<a name="7688"/> 7688: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7689"/> 7689: <i>%% A list turned into a table...</i>
<a name="7690"/> 7690: 
<a name="table_kill_parent-2"/><a name="7691"/> 7691: <b>table_kill_parent</b>(List, Indices) -&gt;
<a name="7692"/> 7692:     ParentFun = fun() -&gt; exit(self(), kill) end,
<a name="table_kill_parent-last_expr"/><a name="7693"/> 7693: <b>    table_i</b>(List, Indices, ParentFun).
<a name="7694"/> 7694: 
<a name="table_parent_throws-2"/><a name="7695"/> 7695: <b>table_parent_throws</b>(List, Indices) -&gt;
<a name="7696"/> 7696:     ParentFun = fun() -&gt; throw({throw,thrown}) end,
<a name="table_parent_throws-last_expr"/><a name="7697"/> 7697: <b>    table_i</b>(List, Indices, ParentFun).
<a name="7698"/> 7698: 
<a name="table_parent_exits-2"/><a name="7699"/> 7699: <b>table_parent_exits</b>(List, Indices) -&gt;
<a name="7700"/> 7700:     ParentFun = fun() -&gt; 1 + Indices end,
<a name="table_parent_exits-last_expr"/><a name="7701"/> 7701: <b>    table_i</b>(List, Indices, ParentFun).
<a name="7702"/> 7702: 
<a name="table_bad_parent_fun-2"/><a name="7703"/> 7703: <b>table_bad_parent_fun</b>(List, Indices) -&gt;
<a name="7704"/> 7704:     ParentFun = fun(X) -&gt; X end, % parent_fun should be nullary
<a name="table_bad_parent_fun-last_expr"/><a name="7705"/> 7705: <b>    table_i</b>(List, Indices, ParentFun).
<a name="7706"/> 7706: 
<a name="table-2"/><a name="7707"/> 7707: <b>table</b>(List, Indices) -&gt;
<a name="7708"/> 7708:     ParentFun = fun() -&gt; self() end,
<a name="table-last_expr"/><a name="7709"/> 7709: <b>    table_i</b>(List, Indices, ParentFun).    
<a name="7710"/> 7710: 
<a name="table-3"/><a name="7711"/> 7711: <b>table</b>(List, KeyPos, Indices) -&gt;
<a name="7712"/> 7712:     ParentFun = fun() -&gt; self() end,
<a name="table-last_expr"/><a name="7713"/> 7713: <b>    table</b>(List, Indices, KeyPos, ParentFun).    
<a name="7714"/> 7714: 
<a name="table_i-3"/><a name="7715"/> 7715: <b>table_i</b>(List, Indices, ParentFun) -&gt;
<a name="table_i-last_expr"/><a name="7716"/> 7716: <b>    table</b>(List, Indices, undefined, ParentFun).
<a name="7717"/> 7717: 
<a name="table-4"/><a name="7718"/> 7718: <b>table</b>(List, Indices, KeyPos, ParentFun) -&gt;
<a name="7719"/> 7719:     TraverseFun = fun() -&gt; list_traverse(List) end,
<a name="7720"/> 7720:     PreFun = fun(PreArgs) -&gt;
<a name="7721"/> 7721:                      {value, {parent_value, Pid}} = 
<a name="7722"/> 7722:                          lists:keysearch(parent_value, 1, PreArgs),
<a name="7723"/> 7723:                      true = is_pid(Pid)
<a name="7724"/> 7724:              end,
<a name="7725"/> 7725:     PostFun = fun() -&gt; ok end,
<a name="7726"/> 7726:     InfoFun = fun(indices) -&gt;
<a name="7727"/> 7727:                       Indices;
<a name="7728"/> 7728:                  (is_unique_objects) -&gt;
<a name="7729"/> 7729:                       undefined;
<a name="7730"/> 7730:                  (keypos) -&gt;
<a name="7731"/> 7731:                       KeyPos;
<a name="7732"/> 7732:                  (num_of_objects) -&gt;
<a name="7733"/> 7733:                       undefined;
<a name="7734"/> 7734:                  (_) -&gt;
<a name="7735"/> 7735:                       undefined
<a name="7736"/> 7736:               end,
<a name="7737"/> 7737:     LookupFun =
<a name="7738"/> 7738:         fun(Column, Values) -&gt;
<a name="7739"/> 7739:                 lists:flatmap(fun(V) -&gt;
<a name="7740"/> 7740:                                       case lists:keysearch(V, Column, List) of
<a name="7741"/> 7741:                                           false -&gt; [];
<a name="7742"/> 7742:                                           {value,Val} -&gt; [Val]
<a name="7743"/> 7743:                                       end
<a name="7744"/> 7744:                               end, Values)
<a name="7745"/> 7745: 
<a name="7746"/> 7746:                 end,
<a name="7747"/> 7747:     FormatFun = fun(all) -&gt;
<a name="7748"/> 7748:                         A = erl_anno:new(17),
<a name="7749"/> 7749:                         {call,A,{remote,A,{atom,A,?MODULE},{atom,A,the_list}},
<a name="7750"/> 7750:                                  [erl_parse:abstract(List, 17)]};
<a name="7751"/> 7751:                    ({lookup, Column, Values}) -&gt;
<a name="7752"/> 7752:                         {?MODULE, list_keys, [Values, Column, List]}
<a name="7753"/> 7753:                 end,
<a name="table-last_expr"/><a name="7754"/> 7754: <b>    qlc:table</b>(TraverseFun, [{info_fun,InfoFun}, {pre_fun, PreFun}, 
<a name="7755"/> 7755:                             {post_fun, PostFun}, {lookup_fun, LookupFun}, 
<a name="7756"/> 7756:                             {format_fun, FormatFun}, 
<a name="7757"/> 7757:                             {parent_fun, ParentFun}]).
<a name="7758"/> 7758: 
<a name="stop_list-2"/><a name="7759"/> 7759: <b>stop_list</b>(List, Ets) -&gt;
<a name="7760"/> 7760:     Traverse = fun() -&gt; list_traverse(List) end,
<a name="7761"/> 7761:     PV = a_sample_parent_value,
<a name="7762"/> 7762:     ParentFun = fun() -&gt; PV end,
<a name="7763"/> 7763:     Pre = fun(PreArgs) -&gt;
<a name="7764"/> 7764:                   {value, {parent_value, PV}} = 
<a name="7765"/> 7765:                       lists:keysearch(parent_value, 1, PreArgs),
<a name="7766"/> 7766:                   {value, {stop_fun, Fun}} = 
<a name="7767"/> 7767:                       lists:keysearch(stop_fun, 1, PreArgs),
<a name="7768"/> 7768:                   true = ets:insert(Ets, {stop_fun, Fun})
<a name="7769"/> 7769:           end,
<a name="stop_list-last_expr"/><a name="7770"/> 7770: <b>    qlc:table</b>(Traverse, [{pre_fun, Pre}, {parent_fun, ParentFun}]).
<a name="7771"/> 7771: 
<a name="list_traverse-1"/><a name="7772"/> 7772: <b>list_traverse</b>([]) -&gt;
<a name="7773"/> 7773:     [];
<a name="7774"/> 7774: <b>list_traverse</b>([E | Es]) -&gt;
<a name="list_traverse-last_expr"/><a name="7775"/> 7775: <b>    [E | fun</b>() -&gt; list_traverse(Es) end].
<a name="7776"/> 7776: 
<a name="table_error-2"/><a name="7777"/> 7777: <b>table_error</b>(List, Error) -&gt;
<a name="table_error-last_expr"/><a name="7778"/> 7778: <b>    table_error</b>(List, undefined, Error).
<a name="7779"/> 7779: 
<a name="table_error-3"/><a name="7780"/> 7780: <b>table_error</b>(List, KeyPos, Error) -&gt;
<a name="7781"/> 7781:     TraverseFun = fun() -&gt; list_traverse2(lists:sort(List), Error) end,
<a name="7782"/> 7782:     InfoFun = fun(is_sorted_key) -&gt; true;
<a name="7783"/> 7783:                  (keypos) -&gt; KeyPos;
<a name="7784"/> 7784:                  (_) -&gt; undefined
<a name="7785"/> 7785:               end,
<a name="table_error-last_expr"/><a name="7786"/> 7786: <b>    qlc:table</b>(TraverseFun, [{info_fun,InfoFun}]).
<a name="7787"/> 7787: 
<a name="list_traverse2-2"/><a name="7788"/> 7788: <b>list_traverse2</b>([], Err) -&gt;
<a name="7789"/> 7789:     Err;
<a name="7790"/> 7790: <b>list_traverse2</b>([E | Es], Err) -&gt;
<a name="list_traverse2-last_expr"/><a name="7791"/> 7791: <b>    [E | fun</b>() -&gt; list_traverse2(Es, Err) end].
<a name="7792"/> 7792: 
<a name="table_lookup_error-1"/><a name="7793"/> 7793: <b>table_lookup_error</b>(List) -&gt;
<a name="7794"/> 7794:     TraverseFun = fun() -&gt; list_traverse(List) end,
<a name="7795"/> 7795:     LookupFun = fun(_Column, _Values) -&gt; {error,lookup,failed} end,
<a name="7796"/> 7796:     InfoFun = fun(keypos) -&gt; 1;
<a name="7797"/> 7797:                  (_) -&gt; undefined
<a name="7798"/> 7798:               end,
<a name="table_lookup_error-last_expr"/><a name="7799"/> 7799: <b>    qlc:table</b>(TraverseFun, [{lookup_fun,LookupFun},{info_fun,InfoFun}]).
<a name="7800"/> 7800: 
<a name="prep_scratchdir-1"/><a name="7801"/> 7801: <b>prep_scratchdir</b>(Dir) -&gt;
<a name="7802"/> 7802:     put('$qlc_tmpdir', true),
<a name="7803"/> 7803:     _ = filelib:ensure_dir(Dir),
<a name="7804"/> 7804:     lists:foreach(fun(F) -&gt; file:delete(F)
<a name="7805"/> 7805:                   end, filelib:wildcard(filename:join(Dir, &quot;*&quot;))),
<a name="prep_scratchdir-last_expr"/><a name="7806"/> 7806:     true.
<a name="7807"/> 7807: 
<a name="7808"/> 7808: <i>%% Truncate just once.</i>
<a name="truncate_tmpfile-2"/><a name="7809"/> 7809: <b>truncate_tmpfile</b>(Dir, Where) -&gt;
<a name="truncate_tmpfile-last_expr"/><a name="7810"/> 7810: <b>    case get</b>('$qlc_tmpdir') of
<a name="7811"/> 7811:         true -&gt; 
<a name="7812"/> 7812:             {ok, [TmpFile0 | _]} = file:list_dir(Dir),
<a name="7813"/> 7813:             TmpFile = filename:join(Dir, TmpFile0),
<a name="7814"/> 7814:             truncate(TmpFile, Where),
<a name="7815"/> 7815:             erase('$qlc_tmpdir');
<a name="7816"/> 7816:         _ -&gt;
<a name="7817"/> 7817:             true
<a name="7818"/> 7818:     end.
<a name="7819"/> 7819: 
<a name="truncate-2"/><a name="7820"/> 7820: <b>truncate</b>(File, Where) -&gt;
<a name="7821"/> 7821:     {ok, Fd} = file:open(File, [read, write]),
<a name="7822"/> 7822:     {ok, _} = file:position(Fd, Where),
<a name="7823"/> 7823:     ok = file:truncate(Fd),
<a name="truncate-last_expr"/><a name="7824"/> 7824: <b>    ok = file:close</b>(Fd).
<a name="7825"/> 7825: 
<a name="7826"/> 7826: <i>%% Crash just once.</i>
<a name="crash_tmpfile-2"/><a name="7827"/> 7827: <b>crash_tmpfile</b>(Dir, Where) -&gt;
<a name="crash_tmpfile-last_expr"/><a name="7828"/> 7828: <b>    case get</b>('$qlc_tmpdir') of
<a name="7829"/> 7829:         true -&gt; 
<a name="7830"/> 7830:             {ok, [TmpFile0 | _]} = file:list_dir(Dir),
<a name="7831"/> 7831:             TmpFile = filename:join(Dir, TmpFile0),
<a name="7832"/> 7832:             crash(TmpFile, Where),
<a name="7833"/> 7833:             erase('$qlc_tmpdir');
<a name="7834"/> 7834:         _ -&gt;
<a name="7835"/> 7835:             true
<a name="7836"/> 7836:     end.
<a name="7837"/> 7837: 
<a name="crash-2"/><a name="7838"/> 7838: <b>crash</b>(File, Where) -&gt;
<a name="7839"/> 7839:     {ok, Fd} = file:open(File, [read, write]),
<a name="7840"/> 7840:     {ok, _} = file:position(Fd, Where),
<a name="7841"/> 7841:     ok = file:write(Fd, [10]),
<a name="crash-last_expr"/><a name="7842"/> 7842: <b>    ok = file:close</b>(Fd).
<a name="7843"/> 7843: 
<a name="7844"/> 7844: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7845"/> 7845: 
<a name="run-2"/><a name="7846"/> 7846: <b>run</b>(Config, Tests) -&gt;
<a name="run-last_expr"/><a name="7847"/> 7847: <b>    run</b>(Config, [], Tests).
<a name="7848"/> 7848: 
<a name="run-3"/><a name="7849"/> 7849: <b>run</b>(Config, Extra, Tests) -&gt;
<a name="run-last_expr"/><a name="7850"/> 7850: <b>    lists:foreach</b>(fun(Body) -&gt; run_test(Config, Extra, Body) end, Tests).
<a name="7851"/> 7851: 
<a name="run_test-3"/><a name="7852"/> 7852: <b>run_test</b>(Config, Extra, {cres, Body, ExpectedCompileReturn}) -&gt;
<a name="7853"/> 7853:     run_test(Config, Extra, {cres, Body, _Opts = [], ExpectedCompileReturn});
<a name="7854"/> 7854: <b>run_test</b>(Config, Extra, {cres, Body, Opts, ExpectedCompileReturn}) -&gt;
<a name="7855"/> 7855:     {SourceFile, Mod} = compile_file_mod(Config),
<a name="7856"/> 7856:     P = [Extra,&lt;&lt;&quot;function() -&gt; &quot;&gt;&gt;, Body, &lt;&lt;&quot;, ok. &quot;&gt;&gt;],
<a name="7857"/> 7857:     CompileReturn = compile_file(Config, P, Opts),
<a name="7858"/> 7858:     case comp_compare(ExpectedCompileReturn, CompileReturn) of
<a name="7859"/> 7859:         true -&gt; ok;
<a name="7860"/> 7860:         false -&gt; expected(ExpectedCompileReturn, CompileReturn, SourceFile)
<a name="7861"/> 7861:     end,
<a name="7862"/> 7862:     AbsFile = filename:rootname(SourceFile, &quot;.erl&quot;),
<a name="7863"/> 7863:     _ = code:purge(Mod),
<a name="7864"/> 7864:     {module, _} = code:load_abs(AbsFile, Mod),
<a name="7865"/> 7865: 
<a name="7866"/> 7866:     Ms0 = erlang:process_info(self(),messages),
<a name="7867"/> 7867:     Before = {{lget(), lists:sort(ets:all()), Ms0}, pps()},
<a name="7868"/> 7868: 
<a name="7869"/> 7869:     %% Prepare the check that the qlc module does not call qlc_pt.
<a name="7870"/> 7870:     _ = [unload_pt() || {file, Name} &lt;- [code:is_loaded(qlc_pt)], 
<a name="7871"/> 7871:                         Name =/= cover_compiled],
<a name="7872"/> 7872: 
<a name="7873"/> 7873:     R = case catch Mod:function() of
<a name="7874"/> 7874:             {'EXIT', _Reason} = Error -&gt;
<a name="7875"/> 7875:                 io:format(&quot;failed, got ~p~n&quot;, [Error]),
<a name="7876"/> 7876:                 fail(SourceFile);
<a name="7877"/> 7877:             Reply -&gt;
<a name="7878"/> 7878:                 Reply
<a name="7879"/> 7879:         end,
<a name="7880"/> 7880: 
<a name="7881"/> 7881:     %% Check that the qlc module does not call qlc_pt:
<a name="7882"/> 7882:     case code:is_loaded(qlc_pt) of
<a name="7883"/> 7883:         {file, cover_compiled} -&gt;
<a name="7884"/> 7884:             ok;
<a name="7885"/> 7885:         {file, _} -&gt;
<a name="7886"/> 7886:             io:format(&quot;qlc_pt was loaded in runtime~n&quot;, []),
<a name="7887"/> 7887:             fail(SourceFile);
<a name="7888"/> 7888:         false -&gt;
<a name="7889"/> 7889:             ok
<a name="7890"/> 7890:     end,
<a name="7891"/> 7891: 
<a name="7892"/> 7892:     wait_for_expected(R, Before, SourceFile, true),
<a name="7893"/> 7893:     code:purge(Mod);
<a name="7894"/> 7894: <b>run_test</b>(Config, Extra, Body) -&gt;
<a name="run_test-last_expr"/><a name="7895"/> 7895: <b>    run_test</b>(Config, Extra, {cres,Body,[]}).
<a name="7896"/> 7896: 
<a name="wait_for_expected-4"/><a name="7897"/> 7897: <b>wait_for_expected</b>(R, {Strict0,PPS0}=Before, SourceFile, Wait) -&gt;
<a name="7898"/> 7898:     Ms = erlang:process_info(self(),messages),
<a name="7899"/> 7899:     After = {_,PPS1} = {{lget(), lists:sort(ets:all()), Ms}, pps()},
<a name="wait_for_expected-last_expr"/><a name="7900"/> 7900:     case {R, After} of
<a name="7901"/> 7901:         {ok, Before} -&gt;
<a name="7902"/> 7902:             ok;
<a name="7903"/> 7903:         {ok, {Strict0,_}} -&gt;
<a name="7904"/> 7904:             {Ports0,Procs0} = PPS0,
<a name="7905"/> 7905:             {Ports1,Procs1} = PPS1,
<a name="7906"/> 7906:             case {Ports1 -- Ports0, Procs1 -- Procs0} of
<a name="7907"/> 7907:                 {[], []} -&gt; ok;
<a name="7908"/> 7908:                 _ when Wait -&gt;
<a name="7909"/> 7909:                     timer:sleep(1000),
<a name="7910"/> 7910:                     wait_for_expected(R, Before, SourceFile, false);
<a name="7911"/> 7911:                 {PortsDiff,ProcsDiff} -&gt;
<a name="7912"/> 7912:                     io:format(&quot;failure, got ~p~n, expected ~p\n&quot;,
<a name="7913"/> 7913:                               [PPS1, PPS0]),
<a name="7914"/> 7914:                     show(&quot;Old port&quot;, Ports0 -- Ports1),
<a name="7915"/> 7915:                     show(&quot;New port&quot;, PortsDiff),
<a name="7916"/> 7916:                     show(&quot;Old proc&quot;, Procs0 -- Procs1),
<a name="7917"/> 7917:                     show(&quot;New proc&quot;, ProcsDiff),
<a name="7918"/> 7918:                     fail(SourceFile)
<a name="7919"/> 7919:             end;
<a name="7920"/> 7920:         _ when Wait -&gt;
<a name="7921"/> 7921:             timer:sleep(1000),
<a name="7922"/> 7922:             wait_for_expected(R, Before, SourceFile, false);
<a name="7923"/> 7923:         _ -&gt;
<a name="7924"/> 7924:             expected({ok,Before}, {R,After}, SourceFile)
<a name="7925"/> 7925:     end.
<a name="7926"/> 7926: 
<a name="7927"/> 7927: <i>%% The qlc modules uses the process dictionary for storing names of files.</i>
<a name="lget-0"/><a name="7928"/> 7928: <b>lget</b>() -&gt;
<a name="lget-last_expr"/><a name="7929"/> 7929: <b>    lists:sort</b>([T || {K, _} = T &lt;- get(), is_qlc_key(K)]).
<a name="7930"/> 7930: 
<a name="7931"/> 7931: <i>%% Copied from the qlc module.</i>
<a name="7932"/> 7932: <b>-define</b>(LCACHE_FILE(Ref), {Ref, '$_qlc_cache_tmpfiles_'}).
<a name="7933"/> 7933: <b>-define</b>(MERGE_JOIN_FILE, '$_qlc_merge_join_tmpfiles_').
<a name="7934"/> 7934: 
<a name="is_qlc_key-1"/><a name="7935"/> 7935: <b>is_qlc_key</b>(?LCACHE_FILE(_)) -&gt; true;
<a name="7936"/> 7936: <b>is_qlc_key</b>(?MERGE_JOIN_FILE) -&gt; true;
<a name="is_qlc_key-last_expr"/><a name="7937"/> 7937: <b>is_qlc_key</b>(_) -&gt; false.
<a name="7938"/> 7938: 
<a name="unload_pt-0"/><a name="7939"/> 7939: <b>unload_pt</b>() -&gt;
<a name="7940"/> 7940:     erlang:garbage_collect(), % get rid of references to qlc_pt...
<a name="7941"/> 7941:     _ = code:purge(qlc_pt),
<a name="unload_pt-last_expr"/><a name="7942"/> 7942: <b>    _ = code:delete</b>(qlc_pt).
<a name="7943"/> 7943: 
<a name="compile_format-2"/><a name="7944"/> 7944: <b>compile_format</b>(Config, Tests) -&gt;
<a name="7945"/> 7945:     Fun = fun(Test, Opts) -&gt;
<a name="7946"/> 7946:                   Return = compile_file(Config, Test, Opts),
<a name="7947"/> 7947:                   format_messages(Return)
<a name="7948"/> 7948:           end, 
<a name="compile_format-last_expr"/><a name="7949"/> 7949: <b>    compile</b>(Config, Tests, Fun).    
<a name="7950"/> 7950: 
<a name="format_messages-1"/><a name="7951"/> 7951: <b>format_messages</b>({warnings,Ws}) -&gt;
<a name="7952"/> 7952:     format_messages({errors,[],Ws});
<a name="7953"/> 7953: <b>format_messages</b>({errors,Es,Ws}) -&gt;
<a name="format_messages-last_expr"/><a name="7954"/> 7954: <b>    {[format_msg</b>(E, Mod) || {_Line,Mod,E} &lt;- Es],
<a name="7955"/> 7955:      [format_msg(W, Mod) || {_Line,Mod,W} &lt;- Ws]}.
<a name="7956"/> 7956: 
<a name="format_msg-2"/><a name="7957"/> 7957: <b>format_msg</b>(Msg, Mod) -&gt;
<a name="7958"/> 7958:     IOlist = Mod:format_error(Msg),
<a name="format_msg-last_expr"/><a name="7959"/> 7959: <b>    binary_to_list</b>(iolist_to_binary(IOlist)).
<a name="7960"/> 7960: 
<a name="compile-2"/><a name="7961"/> 7961: <b>compile</b>(Config, Tests) -&gt;
<a name="7962"/> 7962:     Fun = fun(Test, Opts) -&gt; catch compile_file(Config, Test, Opts) end,
<a name="compile-last_expr"/><a name="7963"/> 7963: <b>    compile</b>(Config, Tests, Fun).
<a name="7964"/> 7964: 
<a name="compile-3"/><a name="7965"/> 7965: <b>compile</b>(Config, Tests, Fun) -&gt;
<a name="7966"/> 7966:     F = fun({TestName,Test,Opts,Expected}, BadL) -&gt;
<a name="7967"/> 7967:                 Return = Fun(Test, Opts),
<a name="7968"/> 7968:                 case comp_compare(Expected, Return) of
<a name="7969"/> 7969:                     true -&gt;
<a name="7970"/> 7970:                         BadL;
<a name="7971"/> 7971:                     false -&gt; 
<a name="7972"/> 7972:                         {File, _Mod} = compile_file_mod(Config),
<a name="7973"/> 7973:                         expected(TestName, Expected, Return, File)
<a name="7974"/> 7974:                 end
<a name="7975"/> 7975:         end,
<a name="compile-last_expr"/><a name="7976"/> 7976: <b>    lists:foldl</b>(F, [], Tests).
<a name="7977"/> 7977: 
<a name="7978"/> 7978: <i>%% Compiles a test module and returns the list of errors and warnings.</i>
<a name="7979"/> 7979: 
<a name="compile_file-3"/><a name="7980"/> 7980: <b>compile_file</b>(Config, Test0, Opts0) -&gt;
<a name="7981"/> 7981:     {File, Mod} = compile_file_mod(Config),
<a name="7982"/> 7982:     Test = list_to_binary([&quot;-module(&quot;, atom_to_list(Mod), &quot;). &quot;
<a name="7983"/> 7983:                            &quot;-import(qlc_SUITE, [i/1,i/2,format_info/2]). &quot;
<a name="7984"/> 7984:                            &quot;-import(qlc_SUITE, [etsc/2, etsc/3]). &quot;
<a name="7985"/> 7985:                            &quot;-import(qlc_SUITE, [create_ets/2]). &quot;
<a name="7986"/> 7986:                            &quot;-import(qlc_SUITE, [strip_qlc_call/1]). &quot;
<a name="7987"/> 7987:                            &quot;-import(qlc_SUITE, [join_info/1]). &quot;
<a name="7988"/> 7988:                            &quot;-import(qlc_SUITE, [join_info_count/1]). &quot;
<a name="7989"/> 7989:                            &quot;-import(qlc_SUITE, [lookup_keys/1]). &quot;
<a name="7990"/> 7990:                            &quot;-include_lib(\&quot;stdlib/include/qlc.hrl\&quot;). &quot;,
<a name="7991"/> 7991:                            Test0]),
<a name="7992"/> 7992:     Opts = [export_all,nowarn_export_all,return,nowarn_unused_record,{outdir,?privdir}|Opts0],
<a name="7993"/> 7993:     ok = file:write_file(File, Test),
<a name="compile_file-last_expr"/><a name="7994"/> 7994: <b>    case compile:file</b>(File, Opts) of
<a name="7995"/> 7995:         {ok, _M, Ws} -&gt; warnings(File, Ws);
<a name="7996"/> 7996:         {error, [{File,Es}], []} -&gt; {errors, Es, []};
<a name="7997"/> 7997:         {error, [{File,Es}], [{File,Ws}]} -&gt; {errors, Es, Ws}
<a name="7998"/> 7998:     end.
<a name="7999"/> 7999: 
<a name="comp_compare-2"/><a name="8000"/> 8000: <b>comp_compare</b>(T, T) -&gt;
<a name="8001"/> 8001:     true;
<a name="8002"/> 8002: <b>comp_compare</b>(T1, T2_0) -&gt;
<a name="8003"/> 8003:     T2 = wskip(T2_0),
<a name="comp_compare-last_expr"/><a name="8004"/> 8004:     T1 =:= T2.
<a name="8005"/> 8005: 
<a name="wskip-1"/><a name="8006"/> 8006: <b>wskip</b>([]) -&gt;
<a name="8007"/> 8007:     [];
<a name="8008"/> 8008: <b>wskip</b>([{_,sys_core_fold,{eval_failure,badarg}}|L]) -&gt;
<a name="8009"/> 8009:     wskip(L);
<a name="8010"/> 8010: <b>wskip</b>([{{L,_C},sys_core_fold,M}|L]) -&gt;
<a name="8011"/> 8011:     [{L,sys_core_fold,M}|wskip(L)];
<a name="8012"/> 8012: <b>wskip</b>({T,L}) -&gt;
<a name="8013"/> 8013:     {T,wskip(L)};
<a name="8014"/> 8014: <b>wskip</b>([M|L]) -&gt;
<a name="8015"/> 8015:     [M|wskip(L)];
<a name="8016"/> 8016: <b>wskip</b>(T) -&gt;
<a name="wskip-last_expr"/><a name="8017"/> 8017:     T.
<a name="8018"/> 8018: 
<a name="8019"/> 8019: <i>%% -&gt; {FileName, Module}; {string(), atom()}</i>
<a name="compile_file_mod-1"/><a name="8020"/> 8020: <b>compile_file_mod</b>(Config) -&gt;
<a name="8021"/> 8021:     NameL = lists:concat([?TESTMODULE, &quot;_&quot;, ?testcase]),
<a name="8022"/> 8022:     Name = list_to_atom(NameL),
<a name="8023"/> 8023:     File = filename(NameL ++ &quot;.erl&quot;, Config),
<a name="compile_file_mod-last_expr"/><a name="8024"/> 8024:     {File, Name}.
<a name="8025"/> 8025: 
<a name="filename-2"/><a name="8026"/> 8026: <b>filename</b>(Name, Config) when is_atom(Name) -&gt;
<a name="8027"/> 8027:     filename(atom_to_list(Name), Config);
<a name="8028"/> 8028: <b>filename</b>(Name, Config) -&gt;
<a name="filename-last_expr"/><a name="8029"/> 8029: <b>    filename:join</b>(?privdir, Name).
<a name="8030"/> 8030: 
<a name="show-2"/><a name="8031"/> 8031: <b>show</b>(_S, []) -&gt;
<a name="8032"/> 8032:     ok;
<a name="8033"/> 8033: <b>show</b>(S, [{Pid, Name, InitCall}|Pids]) when is_pid(Pid) -&gt;
<a name="8034"/> 8034:     io:format(&quot;~s: ~w (~w), ~w: ~p~n&quot;,
<a name="8035"/> 8035:               [S, Pid, proc_reg_name(Name), InitCall,
<a name="8036"/> 8036:                erlang:process_info(Pid)]),
<a name="8037"/> 8037:     show(S, Pids);
<a name="8038"/> 8038: <b>show</b>(S, [{Port, _}|Ports]) when is_port(Port)-&gt;
<a name="8039"/> 8039:     io:format(&quot;~s: ~w: ~p~n&quot;, [S, Port, erlang:port_info(Port)]),
<a name="show-last_expr"/><a name="8040"/> 8040: <b>    show</b>(S, Ports).
<a name="8041"/> 8041: 
<a name="pps-0"/><a name="8042"/> 8042: <b>pps</b>() -&gt;
<a name="pps-last_expr"/><a name="8043"/> 8043: <b>    {port_list</b>(), process_list()}.
<a name="8044"/> 8044: 
<a name="port_list-0"/><a name="8045"/> 8045: <b>port_list</b>() -&gt;
<a name="port_list-last_expr"/><a name="8046"/> 8046: <b>    [{P,safe_second_element</b>(erlang:port_info(P, name))} || 
<a name="8047"/> 8047:         P &lt;- erlang:ports()].
<a name="8048"/> 8048: 
<a name="process_list-0"/><a name="8049"/> 8049: <b>process_list</b>() -&gt;
<a name="process_list-last_expr"/><a name="8050"/> 8050: <b>    [{P,process_info</b>(P, registered_name),
<a name="8051"/> 8051:       safe_second_element(process_info(P, initial_call))} || 
<a name="8052"/> 8052:         P &lt;- processes(), is_process_alive(P)].
<a name="8053"/> 8053: 
<a name="proc_reg_name-1"/><a name="8054"/> 8054: <b>proc_reg_name</b>({registered_name, Name}) -&gt; Name;
<a name="proc_reg_name-last_expr"/><a name="8055"/> 8055: <b>proc_reg_name</b>([]) -&gt; no_reg_name.
<a name="8056"/> 8056: 
<a name="safe_second_element-1"/><a name="8057"/> 8057: <b>safe_second_element</b>({_,Info}) -&gt; Info;
<a name="safe_second_element-last_expr"/><a name="8058"/> 8058: <b>safe_second_element</b>(Other) -&gt; Other.
<a name="8059"/> 8059: 
<a name="warnings-2"/><a name="8060"/> 8060: <b>warnings</b>(File, Ws) -&gt;
<a name="warnings-last_expr"/><a name="8061"/> 8061: <b>    case lists:append</b>([W || {F, W} &lt;- Ws, F =:= File]) of
<a name="8062"/> 8062:         [] -&gt; [];
<a name="8063"/> 8063:         L -&gt; {warnings, L}
<a name="8064"/> 8064:     end.
<a name="8065"/> 8065: 
<a name="expected-4"/><a name="8066"/> 8066: <b>expected</b>(Test, Expected, Got, File) -&gt;
<a name="8067"/> 8067:     io:format(&quot;~nTest ~p failed. &quot;, [Test]),
<a name="expected-last_expr"/><a name="8068"/> 8068: <b>    expected</b>(Expected, Got, File).
<a name="8069"/> 8069: 
<a name="expected-3"/><a name="8070"/> 8070: <b>expected</b>(Expected, Got, File) -&gt;
<a name="8071"/> 8071:     io:format(&quot;Expected~n  ~p~n, but got~n  ~p~n&quot;, [Expected, Got]),
<a name="expected-last_expr"/><a name="8072"/> 8072: <b>    fail</b>(File).
<a name="8073"/> 8073: 
<a name="fail-1"/><a name="8074"/> 8074: <b>fail</b>(Source) -&gt;
<a name="fail-last_expr"/><a name="8075"/> 8075: <b>    ct:fail</b>({failed,testcase,on,Source}).
<a name="8076"/> 8076: 
<a name="8077"/> 8077: <i>%% Copied from global_SUITE.erl.</i>
<a name="8078"/> 8078: 
<a name="install_error_logger-0"/><a name="8079"/> 8079: <b>install_error_logger</b>() -&gt;
<a name="install_error_logger-last_expr"/><a name="8080"/> 8080: <b>    error_logger:add_report_handler</b>(?MODULE, self()).
<a name="8081"/> 8081: 
<a name="uninstall_error_logger-0"/><a name="8082"/> 8082: <b>uninstall_error_logger</b>() -&gt;
<a name="uninstall_error_logger-last_expr"/><a name="8083"/> 8083: <b>    error_logger:delete_report_handler</b>(?MODULE).
<a name="8084"/> 8084: 
<a name="read_error_logger-0"/><a name="8085"/> 8085: <b>read_error_logger</b>() -&gt;
<a name="read_error_logger-last_expr"/><a name="8086"/> 8086:     receive
<a name="8087"/> 8087: 	{error, Why} -&gt;
<a name="8088"/> 8088:             {error, Why};
<a name="8089"/> 8089:         {info, Why} -&gt;
<a name="8090"/> 8090:             {info, Why};
<a name="8091"/> 8091:         {warning, Why} -&gt;
<a name="8092"/> 8092:             {warning, Why};
<a name="8093"/> 8093:         {error, Pid, Tuple} -&gt;
<a name="8094"/> 8094:             {error, Pid, Tuple}
<a name="8095"/> 8095:     after 1000 -&gt;
<a name="8096"/> 8096: 	    io:format(&quot;No reply after 1 s\n&quot;, []),
<a name="8097"/> 8097: 	    ct:fail(failed)
<a name="8098"/> 8098:     end.
<a name="8099"/> 8099: 
<a name="8100"/> 8100: <i>%%-----------------------------------------------------------------</i>
<a name="8101"/> 8101: <i>%% The error_logger handler used.</i>
<a name="8102"/> 8102: <i>%% (Copied from stdlib/test/proc_lib_SUITE.erl.)</i>
<a name="8103"/> 8103: <i>%%-----------------------------------------------------------------</i>
<a name="init-1"/><a name="8104"/> 8104: <b>init</b>(Tester) -&gt;
<a name="init-last_expr"/><a name="8105"/> 8105:     {ok, Tester}.
<a name="8106"/> 8106:     
<a name="handle_event-2"/><a name="8107"/> 8107: <b>handle_event</b>({error, _GL, {_Pid, _Msg, [Why, _]}}, Tester) when is_atom(Why) -&gt;
<a name="8108"/> 8108:     Tester ! {error, Why},
<a name="8109"/> 8109:     {ok, Tester};
<a name="8110"/> 8110: <b>handle_event</b>({error, _GL, {_Pid, _Msg, [P, T]}}, Tester) when is_pid(P) -&gt;
<a name="8111"/> 8111:     Tester ! {error, P, T},
<a name="8112"/> 8112:     {ok, Tester};
<a name="8113"/> 8113: <b>handle_event</b>({info_msg, _GL, {_Pid, _Msg, [Why, _]}}, Tester) -&gt;
<a name="8114"/> 8114:     Tester ! {info, Why},
<a name="8115"/> 8115:     {ok, Tester};
<a name="8116"/> 8116: <b>handle_event</b>({warning_msg, _GL, {_Pid, _Msg, [Why, _]}}, Tester) when is_atom(Why) -&gt;
<a name="8117"/> 8117:     Tester ! {warning, Why},
<a name="8118"/> 8118:     {ok, Tester};
<a name="8119"/> 8119: <b>handle_event</b>(_Event, State) -&gt;
<a name="handle_event-last_expr"/><a name="8120"/> 8120:     {ok, State}.
<a name="8121"/> 8121: 
<a name="handle_info-2"/><a name="8122"/> 8122: <b>handle_info</b>(_, State) -&gt;
<a name="handle_info-last_expr"/><a name="8123"/> 8123:     {ok, State}.
<a name="8124"/> 8124: 
<a name="handle_call-2"/><a name="handle_call-last_expr"/><a name="8125"/> 8125: <b>handle_call</b>(_Query, State) -&gt; {ok, {error, bad_query}, State}.
<a name="8126"/> 8126: 
<a name="terminate-2"/><a name="8127"/> 8127: <b>terminate</b>(_Reason, State) -&gt;
<a name="terminate-last_expr"/><a name="8128"/> 8128:     State.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
