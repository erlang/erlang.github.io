<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/io_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1999-2024. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(io_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <b>-export</b>([all/0, suite/0]).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-export</b>([error_1/1, float_g/1, float_w/1, otp_5403/1, otp_5813/1, otp_6230/1, 
<a name="25"/>   25:          otp_6282/1, otp_6354/1, otp_6495/1, otp_6517/1, otp_6502/1,
<a name="26"/>   26:          manpage/1, otp_6708/1, otp_7084/0, otp_7084/1, otp_7421/1,
<a name="27"/>   27: 	 io_lib_collect_line_3_wb/1, cr_whitespace_in_string/1,
<a name="28"/>   28: 	 io_fread_newlines/1, otp_8989/1, io_lib_fread_literal/1,
<a name="29"/>   29: 	 printable_range/1, bad_printable_range/1,
<a name="30"/>   30: 	 io_lib_print_binary_depth_one/1, otp_10302/1, otp_10755/1,
<a name="31"/>   31:          otp_10836/1, io_lib_width_too_small/1, calling_self/1,
<a name="32"/>   32:          io_with_huge_message_queue/1, format_string/1, format_neg_zero/1,
<a name="33"/>   33: 	 maps/1, coverage/1, otp_14178_unicode_atoms/1, otp_14175/1,
<a name="34"/>   34:          otp_14285/1, limit_term/1, otp_14983/1, otp_15103/1, otp_15076/1,
<a name="35"/>   35:          otp_15159/1, otp_15639/1, otp_15705/1, otp_15847/1, otp_15875/1,
<a name="36"/>   36:          github_4801/1, chars_limit/1, error_info/1, otp_17525/1,
<a name="37"/>   37:          unscan_format_without_maps_order/1, build_text_without_maps_order/1]).
<a name="38"/>   38: 
<a name="39"/>   39: <b>-export</b>([pretty/2, trf/3]).
<a name="40"/>   40: 
<a name="41"/>   41: <i>%%-define(debug, true).</i>
<a name="42"/>   42: 
<a name="43"/>   43: <b>-ifdef</b>(debug).
<a name="44"/>   44: <b>-define</b>(format(S, A), io:format(S, A)).
<a name="45"/>   45: <b>-define</b>(line, put(line, ?LINE), ).
<a name="46"/>   46: <b>-define</b>(config(X,Y), foo).
<a name="47"/>   47: <b>-define</b>(t, test_server).
<a name="48"/>   48: <b>-define</b>(privdir(_), &quot;./io_SUITE_priv&quot;).
<a name="49"/>   49: -else.
<a name="50"/>   50: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="51"/>   51: <b>-define</b>(format(S, A), ok).
<a name="52"/>   52: <b>-define</b>(privdir(Conf), proplists:get_value(priv_dir, Conf)).
<a name="53"/>   53: -endif.
<a name="54"/>   54: 
<a name="suite-0"/><a name="55"/>   55: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="56"/>   56:     [{ct_hooks,[ts_install_cth]},
<a name="57"/>   57:      {timetrap,{minutes,1}}].
<a name="58"/>   58: 
<a name="all-0"/><a name="59"/>   59: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="60"/>   60:     [error_1, float_g, float_w, otp_5403, otp_5813, otp_6230,
<a name="61"/>   61:      otp_6282, otp_6354, otp_6495, otp_6517, otp_6502,
<a name="62"/>   62:      manpage, otp_6708, otp_7084, otp_7421,
<a name="63"/>   63:      io_lib_collect_line_3_wb, cr_whitespace_in_string,
<a name="64"/>   64:      io_fread_newlines, otp_8989, io_lib_fread_literal,
<a name="65"/>   65:      printable_range, bad_printable_range, format_neg_zero,
<a name="66"/>   66:      io_lib_print_binary_depth_one, otp_10302, otp_10755, otp_10836,
<a name="67"/>   67:      io_lib_width_too_small, io_with_huge_message_queue, calling_self,
<a name="68"/>   68:      format_string, maps, coverage, otp_14178_unicode_atoms, otp_14175,
<a name="69"/>   69:      otp_14285, limit_term, otp_14983, otp_15103, otp_15076, otp_15159,
<a name="70"/>   70:      otp_15639, otp_15705, otp_15847, otp_15875, github_4801, chars_limit,
<a name="71"/>   71:      error_info, otp_17525, unscan_format_without_maps_order,
<a name="72"/>   72:      build_text_without_maps_order].
<a name="73"/>   73: 
<a name="74"/>   74: <i>%% Error cases for output.</i>
<a name="error_1-1"/><a name="75"/>   75: <b>error_1</b>(Config) when is_list(Config) -&gt;
<a name="76"/>   76:     %% We don't do erroneous output on stdout - the test server
<a name="77"/>   77:     %% seems to catch that somehow.
<a name="78"/>   78:     PrivDir = ?privdir(Config),
<a name="79"/>   79:     File = filename:join(PrivDir, &quot;slask&quot;),
<a name="80"/>   80:     {ok, F1} = file:open(File, [write]),
<a name="81"/>   81:     {'EXIT', _} = (catch io:format(muttru, &quot;hej&quot;, [])),
<a name="82"/>   82:     {'EXIT', _} = (catch io:format(F1, pelle, &quot;hej&quot;)),
<a name="83"/>   83:     {'EXIT', _} = (catch io:format(F1, 1, &quot;hej&quot;)),
<a name="84"/>   84:     {'EXIT', _} = (catch io:format(F1, &quot;~p~&quot;, [kaka])),
<a name="85"/>   85:     {'EXIT', _} = (catch io:format(F1, &quot;~m~n&quot;, [kaka])),
<a name="86"/>   86: 
<a name="87"/>   87:     %% This causes the file process to die, and it is linked to us,
<a name="88"/>   88:     %% so we can't catch the error this easily.
<a name="89"/>   89:     %%    {'EXIT', _} = (catch io:put_chars(F1, 666)),
<a name="90"/>   90: 
<a name="91"/>   91:     file:close(F1),
<a name="92"/>   92:     {'EXIT', _} = (catch io:format(F1, &quot;~p&quot;, [&quot;hej&quot;])),
<a name="error_1-last_expr"/><a name="93"/>   93:     ok.
<a name="94"/>   94: 
<a name="format_neg_zero-1"/><a name="95"/>   95: <b>format_neg_zero</b>(Config) when is_list(Config) -&gt;
<a name="96"/>   96:     &lt;&lt;NegZero/float&gt;&gt; = &lt;&lt;16#8000000000000000:64&gt;&gt;,
<a name="97"/>   97:     &quot;-0.000000&quot; = io_lib:format(&quot;~f&quot;, [NegZero]),
<a name="98"/>   98:     &quot;-0.00000e+0&quot; = io_lib:format(&quot;~g&quot;, [NegZero]),
<a name="99"/>   99:     &quot;-0.00000e+0&quot; = io_lib:format(&quot;~e&quot;, [NegZero]),
<a name="100"/>  100:     &quot;-0.0&quot; = io_lib_format:fwrite_g(NegZero),
<a name="format_neg_zero-last_expr"/><a name="101"/>  101:     ok.
<a name="102"/>  102: 
<a name="float_g-1"/><a name="103"/>  103: <b>float_g</b>(Config) when is_list(Config) -&gt;
<a name="104"/>  104:     [&quot;5.00000e-2&quot;,
<a name="105"/>  105:      &quot;0.500000&quot;,
<a name="106"/>  106:      &quot;5.00000&quot;,
<a name="107"/>  107:      &quot;50.0000&quot;,
<a name="108"/>  108:      &quot;500.000&quot;,
<a name="109"/>  109:      &quot;5000.00&quot;,
<a name="110"/>  110:      &quot;5.00000e+4&quot;,
<a name="111"/>  111:      &quot;5.00000e+5&quot;] = float_g_1(&quot;~g&quot;, 5.0, -2, 5),
<a name="112"/>  112: 
<a name="113"/>  113:     [&quot;-5.0000e-2&quot;,
<a name="114"/>  114:      &quot;-0.50000&quot;,
<a name="115"/>  115:      &quot;-5.0000&quot;,
<a name="116"/>  116:      &quot;-50.000&quot;,
<a name="117"/>  117:      &quot;-500.00&quot;,
<a name="118"/>  118:      &quot;-5000.0&quot;,
<a name="119"/>  119:      &quot;-5.0000e+4&quot;,
<a name="120"/>  120:      &quot;-5.0000e+5&quot;] = float_g_1(&quot;~.5g&quot;, -5.0, -2, 5),
<a name="121"/>  121: 
<a name="122"/>  122:     [&quot;5.000e-2&quot;,
<a name="123"/>  123:      &quot;0.5000&quot;,
<a name="124"/>  124:      &quot;5.000&quot;,
<a name="125"/>  125:      &quot;50.00&quot;,
<a name="126"/>  126:      &quot;500.0&quot;,
<a name="127"/>  127:      &quot;5.000e+3&quot;,
<a name="128"/>  128:      &quot;5.000e+4&quot;,
<a name="129"/>  129:      &quot;5.000e+5&quot;] = float_g_1(&quot;~.4g&quot;, 5.0, -2, 5),
<a name="130"/>  130: 
<a name="131"/>  131:     [&quot;-5.00e-2&quot;,
<a name="132"/>  132:      &quot;-0.500&quot;,
<a name="133"/>  133:      &quot;-5.00&quot;,
<a name="134"/>  134:      &quot;-50.0&quot;,
<a name="135"/>  135:      &quot;-5.00e+2&quot;,
<a name="136"/>  136:      &quot;-5.00e+3&quot;,
<a name="137"/>  137:      &quot;-5.00e+4&quot;,
<a name="138"/>  138:      &quot;-5.00e+5&quot;] = float_g_1(&quot;~.3g&quot;, -5.0, -2, 5),
<a name="139"/>  139: 
<a name="140"/>  140:     [&quot;5.0e-2&quot;,
<a name="141"/>  141:      &quot;0.50&quot;,
<a name="142"/>  142:      &quot;5.0&quot;,
<a name="143"/>  143:      &quot;5.0e+1&quot;,
<a name="144"/>  144:      &quot;5.0e+2&quot;,
<a name="145"/>  145:      &quot;5.0e+3&quot;,
<a name="146"/>  146:      &quot;5.0e+4&quot;,
<a name="147"/>  147:      &quot;5.0e+5&quot;] = float_g_1(&quot;~.2g&quot;, 5.0, -2, 5),
<a name="148"/>  148: 
<a name="149"/>  149:     case catch fmt(&quot;~.1g&quot;, [0.5]) of
<a name="150"/>  150: 	&quot;0.5&quot; -&gt;
<a name="151"/>  151: 	    [&quot;5.0e-2&quot;,
<a name="152"/>  152: 	     &quot;0.5&quot;,
<a name="153"/>  153: 	     &quot;5.0e+0&quot;,
<a name="154"/>  154: 	     &quot;5.0e+1&quot;,
<a name="155"/>  155: 	     &quot;5.0e+2&quot;,
<a name="156"/>  156: 	     &quot;5.0e+3&quot;,
<a name="157"/>  157: 	     &quot;5.0e+4&quot;,
<a name="158"/>  158: 	     &quot;5.0e+5&quot;] = float_g_1(&quot;~.1g&quot;, 5.0, -2, 5);
<a name="159"/>  159: 	{'EXIT',_} -&gt; ok
<a name="160"/>  160:     end,
<a name="161"/>  161: 
<a name="162"/>  162:     [&quot;4.99999e-2&quot;,
<a name="163"/>  163:      &quot;0.499999&quot;,
<a name="164"/>  164:      &quot;4.99999&quot;,
<a name="165"/>  165:      &quot;49.9999&quot;,
<a name="166"/>  166:      &quot;499.999&quot;,
<a name="167"/>  167:      &quot;4999.99&quot;,
<a name="168"/>  168:      &quot;4.99999e+4&quot;,
<a name="169"/>  169:      &quot;4.99999e+5&quot;] = float_g_1(&quot;~g&quot;, 4.9999949999, -2, 5),
<a name="170"/>  170: 
<a name="171"/>  171:     [&quot;-5.00000e-2&quot;,
<a name="172"/>  172:      &quot;-0.500000&quot;,
<a name="173"/>  173:      &quot;-5.00000&quot;,
<a name="174"/>  174:      &quot;-50.0000&quot;,
<a name="175"/>  175:      &quot;-500.000&quot;,
<a name="176"/>  176:      &quot;-5000.00&quot;,
<a name="177"/>  177:      &quot;-5.00000e+4&quot;,
<a name="178"/>  178:      &quot;-5.00000e+5&quot;] = float_g_1(&quot;~g&quot;, -4.9999950001, -2, 5),
<a name="179"/>  179: 
<a name="float_g-last_expr"/><a name="180"/>  180:     ok.
<a name="181"/>  181: 
<a name="float_g_1-4"/><a name="182"/>  182: <b>float_g_1</b>(Fmt, V, Min, Max) -&gt;
<a name="float_g_1-last_expr"/><a name="183"/>  183: <b>    [fmt</b>(Fmt, [V*math:pow(10, E)]) || E &lt;- lists:seq(Min, Max)].
<a name="184"/>  184: 
<a name="float_w-1"/><a name="185"/>  185: <b>float_w</b>(Config) when is_list(Config) -&gt;
<a name="186"/>  186:     %% All floats that are &gt;= float(1 bsl 53) or &lt;= -float(1 bsl 53)
<a name="187"/>  187:     %% should be printed with scientific notation to make it clear
<a name="188"/>  188:     %% that the integer part can have lost precision, for example if
<a name="189"/>  189:     %% the float was created from a float literal.
<a name="190"/>  190:     %%
<a name="191"/>  191:     %% All integers in the range [-2^53, 2^53] can be stored without
<a name="192"/>  192:     %% loss of precision in an IEEE 754 64-bit double but 2^53+1
<a name="193"/>  193:     %% cannot be stored in an IEEE 754 64-bit double without loss of
<a name="194"/>  194:     %% precision (float((1 bsl 53)+1) =:= float(1 bsl 53)).
<a name="195"/>  195:     %%
<a name="196"/>  196:     %% https://stackoverflow.com/questions/1848700/biggest-integer-that-can-be-stored-in-a-double?answertab=votes#tab-top
<a name="197"/>  197:     Nums = [-float((1 bsl 53) -1),
<a name="198"/>  198:             -float(1 bsl 53),
<a name="199"/>  199:             -float((1 bsl 53) + 1),
<a name="200"/>  200:             float((1 bsl 53) -1),
<a name="201"/>  201:             float(1 bsl 53),
<a name="202"/>  202:             float((1 bsl 53) + 1)],
<a name="203"/>  203: 
<a name="204"/>  204: 
<a name="205"/>  205:     [&quot;-9007199254740991.0&quot;,
<a name="206"/>  206:      &quot;-9.007199254740992e15&quot;,
<a name="207"/>  207:      &quot;-9.007199254740992e15&quot;,
<a name="208"/>  208:      &quot;9007199254740991.0&quot;,
<a name="209"/>  209:      &quot;9.007199254740992e15&quot;,
<a name="210"/>  210:      &quot;9.007199254740992e15&quot;] =
<a name="211"/>  211:         [begin g_t(X), fmt(&quot;~w&quot;, [X]) end || X &lt;- Nums],
<a name="212"/>  212: 
<a name="float_w-last_expr"/><a name="213"/>  213:     ok.
<a name="214"/>  214: 
<a name="calling_self-1"/><a name="215"/>  215: <b>calling_self</b>(Config) when is_list(Config) -&gt;
<a name="216"/>  216:     {'EXIT', {calling_self, _}} = (catch io:format(self(), &quot;~p&quot;, [oops])),
<a name="calling_self-last_expr"/><a name="217"/>  217:     ok.
<a name="218"/>  218: 
<a name="219"/>  219: <i>%% OTP-5403. ~s formats I/O lists and a single binary.</i>
<a name="otp_5403-1"/><a name="220"/>  220: <b>otp_5403</b>(Config) when is_list(Config) -&gt;
<a name="221"/>  221:     &quot;atom&quot; = fmt(&quot;~s&quot;, [atom]),
<a name="222"/>  222:     &quot;binary&quot; = fmt(&quot;~s&quot;, [&lt;&lt;&quot;binary&quot;&gt;&gt;]),
<a name="223"/>  223:     &quot;atail&quot; = fmt(&quot;~s&quot;, [[&quot;a&quot; | &lt;&lt;&quot;tail&quot;&gt;&gt;]]),
<a name="224"/>  224:     &quot;deepcharlist&quot; = fmt(&quot;~s&quot;, [[&quot;deep&quot;,[&quot;char&quot;,[&quot;list&quot;]]]]),
<a name="225"/>  225:     &quot;somebinaries&quot; = fmt(&quot;~s&quot;, [[&lt;&lt;&quot;some&quot;&gt;&gt;,[&lt;&lt;&quot;binaries&quot;&gt;&gt;]]]),
<a name="otp_5403-last_expr"/><a name="226"/>  226:     ok.
<a name="227"/>  227: 
<a name="228"/>  228: <i>%% OTP-5813. read/3 is new.</i>
<a name="otp_5813-1"/><a name="229"/>  229: <b>otp_5813</b>(Config) when is_list(Config) -&gt;
<a name="230"/>  230:     PrivDir = ?privdir(Config),
<a name="231"/>  231:     File = filename:join(PrivDir, &quot;test&quot;),
<a name="232"/>  232: 
<a name="233"/>  233:     ok = file:write_file(File, &lt;&lt;&quot;a. &quot;&gt;&gt;),
<a name="234"/>  234:     {ok, Fd} = file:open(File, [read]),
<a name="235"/>  235:     {ok, a, 1} = io:read(Fd, '', 1),
<a name="236"/>  236:     {eof,1} = io:read(Fd, '', 1),
<a name="237"/>  237:     ok = file:close(Fd),
<a name="238"/>  238: 
<a name="239"/>  239:     ok = file:write_file(File, &lt;&lt;&quot;[}.&quot;&gt;&gt;),
<a name="240"/>  240:     {ok, Fd2} = file:open(File, [read]),
<a name="241"/>  241:     {error,{1,_,_},1} = io:read(Fd2, '', 1),
<a name="242"/>  242:     ok = file:close(Fd),
<a name="243"/>  243: 
<a name="244"/>  244:     file:delete(File),
<a name="otp_5813-last_expr"/><a name="245"/>  245:     ok.
<a name="246"/>  246: 
<a name="247"/>  247: <i>%% OTP-6230. ~p and ~P with (huge) binaries.</i>
<a name="otp_6230-1"/><a name="248"/>  248: <b>otp_6230</b>(Config) when is_list(Config) -&gt;
<a name="249"/>  249:     %% The problem is actually huge binaries, but the small tests here
<a name="250"/>  250:     %% just run through most of the modified code.
<a name="251"/>  251:     &quot;&lt;&lt;&gt;&gt;&quot; = fmt(&quot;~P&quot;, [&lt;&lt;&quot;&quot;&gt;&gt;,-1]),
<a name="252"/>  252:     &quot;&lt;&lt;\&quot;hej\&quot;&gt;&gt;&quot; = fmt(&quot;~P&quot;, [&lt;&lt;&quot;hej&quot;&gt;&gt;,-1]),
<a name="253"/>  253:     &quot;{hej,...}&quot; = fmt(&quot;~P&quot;, [{hej,&lt;&lt;&quot;hej&quot;&gt;&gt;},2]),
<a name="254"/>  254:     &quot;{hej,&lt;&lt;...&gt;&gt;}&quot; = fmt(&quot;~P&quot;, [{hej,&lt;&lt;&quot;hej&quot;&gt;&gt;},3]),
<a name="255"/>  255:     &quot;{hej,&lt;&lt;\&quot;hejs\&quot;...&gt;&gt;}&quot; = fmt(&quot;~P&quot;, [{hej,&lt;&lt;&quot;hejsan&quot;&gt;&gt;},4]),
<a name="256"/>  256:     &quot;{hej,&lt;&lt;\&quot;hej\&quot;&gt;&gt;}&quot; = fmt(&quot;~P&quot;, [{hej,&lt;&lt;&quot;hej&quot;&gt;&gt;},6]),
<a name="257"/>  257:     &quot;&lt;&lt;...&gt;&gt;&quot; = fmt(&quot;~P&quot;, [&lt;&lt;&quot;hej&quot;&gt;&gt;,1]),
<a name="258"/>  258:     &quot;&lt;&lt;\&quot;hejs\&quot;...&gt;&gt;&quot; = fmt(&quot;~P&quot;, [&lt;&lt;&quot;hejsan&quot;&gt;&gt;,2]),
<a name="259"/>  259:     &quot;&lt;&lt;\&quot;hej\&quot;&gt;&gt;&quot; = fmt(&quot;~P&quot;, [&lt;&lt;&quot;hej&quot;&gt;&gt;,4]),
<a name="260"/>  260:     &quot;{hej,&lt;&lt;127,...&gt;&gt;}&quot; =
<a name="261"/>  261:         fmt(&quot;~P&quot;, [{hej,&lt;&lt;127:8,&lt;&lt;&quot;hej&quot;&gt;&gt;/binary&gt;&gt;},4]),
<a name="262"/>  262:     &quot;{hej,&lt;&lt;127,104,101,...&gt;&gt;}&quot; =
<a name="263"/>  263:         fmt(&quot;~P&quot;, [{hej,&lt;&lt;127:8,&lt;&lt;&quot;hej&quot;&gt;&gt;/binary&gt;&gt;},6]),
<a name="264"/>  264: 
<a name="265"/>  265:     B = list_to_binary(lists:duplicate(30000, $a)),
<a name="266"/>  266:     &quot;&lt;&lt;\&quot;aaaa&quot;++_ = fmt(&quot;~P&quot;, [B, 20000]),
<a name="otp_6230-last_expr"/><a name="267"/>  267:     ok.
<a name="268"/>  268: 
<a name="269"/>  269: <i>%% OTP-6282. ~p truncates strings (like binaries) depending on depth.</i>
<a name="otp_6282-1"/><a name="270"/>  270: <b>otp_6282</b>(Config) when is_list(Config) -&gt;
<a name="271"/>  271:     &quot;[]&quot; = p(&quot;&quot;, 1, 20, 1),
<a name="272"/>  272:     &quot;[]&quot; = p(&quot;&quot;, 1, 20, -1),
<a name="273"/>  273:     &quot;[...]&quot; = p(&quot;a&quot;, 1, 20, 1),
<a name="274"/>  274:     &quot;\&quot;a\&quot;&quot; = p(&quot;a&quot;, 1, 20, 2),
<a name="275"/>  275:     &quot;\&quot;aa\&quot;&quot; = p(&quot;aa&quot;, 1, 20, 2),
<a name="276"/>  276:     &quot;\&quot;aaa\&quot;&quot; = p(&quot;aaa&quot;, 1, 20, 2),
<a name="277"/>  277:     &quot;\&quot;aaaa\&quot;&quot; = p(&quot;aaaa&quot;, 1, 20, 2),
<a name="278"/>  278:     &quot;\&quot;a\&quot;&quot; = p(&quot;a&quot;, 1, 20, -1),
<a name="279"/>  279:     &quot;[97,97,1000]&quot; = p([$a,$a,1000], 1, 20, 4),
<a name="280"/>  280:     S1 = lists:duplicate(200,$a),
<a name="281"/>  281:     &quot;[...]&quot; = p(S1, 1, 20, 1),
<a name="282"/>  282:     true = &quot;\&quot;&quot; ++ S1 ++ &quot;\&quot;&quot; =:= p(S1, 1, 205, -1),
<a name="283"/>  283:     &quot;[97,97,1000|...]&quot; = p([$a,$a,1000,1000], 1, 20, 4),
<a name="284"/>  284: 
<a name="285"/>  285:     &quot;[[]]&quot; = p([&quot;&quot;], 1, 20, 2),
<a name="286"/>  286:     &quot;[[]]&quot; = p([&quot;&quot;], 1, 20, -1),
<a name="287"/>  287:     &quot;[[...]]&quot; = p([&quot;a&quot;], 1, 20, 2),
<a name="288"/>  288:     &quot;[\&quot;a\&quot;]&quot; = p([&quot;a&quot;], 1, 20, 3),
<a name="289"/>  289:     &quot;[\&quot;aa\&quot;]&quot; = p([&quot;aa&quot;], 1, 20, 3),
<a name="290"/>  290:     &quot;[\&quot;aaa\&quot;]&quot; = p([&quot;aaa&quot;], 1, 20, 3),
<a name="291"/>  291:     &quot;[\&quot;a\&quot;]&quot; = p([&quot;a&quot;], 1, 20, -1),
<a name="292"/>  292:     &quot;[[97,97,1000]]&quot; = p([[$a,$a,1000]], 1, 20, 5),
<a name="293"/>  293:     &quot;[[...]]&quot; = p([S1], 1, 20, 2),
<a name="294"/>  294:     true = &quot;[\&quot;&quot; ++ S1 ++ &quot;\&quot;]&quot; =:= p([S1], 1, 210, -1),
<a name="295"/>  295:     &quot;[[97,97,1000|...]]&quot; = p([[$a,$a,1000,1000]], 1, 20, 5),
<a name="296"/>  296: 
<a name="297"/>  297:     &quot;[\&quot;aaaaa\&quot;]&quot; = p([&quot;aaaaa&quot;], 1, 10, 6),
<a name="298"/>  298: 
<a name="otp_6282-last_expr"/><a name="299"/>  299:     ok.
<a name="300"/>  300: 
<a name="301"/>  301: <i>%% OTP-6354. io_lib_pretty rewritten.</i>
<a name="otp_6354-1"/><a name="302"/>  302: <b>otp_6354</b>(Config) when is_list(Config) -&gt;
<a name="303"/>  303:     %% A few tuples:
<a name="304"/>  304:     &quot;{}&quot; = p({}, 1, 20, -1),
<a name="305"/>  305:     &quot;...&quot; = p({}, 1, 20, 0),
<a name="306"/>  306:     &quot;{}&quot; = p({}, 1, 20, 1),
<a name="307"/>  307:     &quot;{}&quot; = p({}, 1, 20, 2),
<a name="308"/>  308:     &quot;{a}&quot; = p({a}, 1, 20, -1),
<a name="309"/>  309:     &quot;...&quot; = p({a}, 1, 20, 0),
<a name="310"/>  310:     &quot;{...}&quot; = p({a}, 1, 20, 1),
<a name="311"/>  311:     &quot;{a}&quot; = p({a}, 1, 20, 2),
<a name="312"/>  312:     &quot;{a,b}&quot; = p({a,b}, 1, 20, -1),
<a name="313"/>  313:     &quot;...&quot; = p({a,b}, 1, 20, 0),
<a name="314"/>  314:     &quot;{...}&quot; = p({a,b}, 1, 20, 1),
<a name="315"/>  315:     &quot;{a,...}&quot; = p({a,b}, 1, 20, 2),
<a name="316"/>  316:     &quot;{a,b}&quot; = p({a,b}, 1, 20, 3),
<a name="317"/>  317:     &quot;{}&quot; = p({}, 1, 1, -1),
<a name="318"/>  318:     &quot;...&quot; = p({}, 1, 1, 0),
<a name="319"/>  319:     &quot;{}&quot; = p({}, 1, 1, 1),
<a name="320"/>  320:     &quot;{}&quot; = p({}, 1, 1, 2),
<a name="321"/>  321:     &quot;{a}&quot; = p({a}, 1, 1, -1),
<a name="322"/>  322:     &quot;...&quot; = p({a}, 1, 1, 0),
<a name="323"/>  323:     &quot;{...}&quot; = p({a}, 1, 1, 1),
<a name="324"/>  324:     &quot;{a}&quot; = p({a}, 1, 1, 2),
<a name="325"/>  325:     &quot;{a,\n b}&quot; = p({a,b}, 1, 1, -1),
<a name="326"/>  326:     &quot;{1,\n b}&quot; = p({1,b}, 1, 1, -1),
<a name="327"/>  327:     &quot;...&quot; = p({a,b}, 1, 1, 0),
<a name="328"/>  328:     &quot;{...}&quot; = p({a,b}, 1, 1, 1),
<a name="329"/>  329:     &quot;{a,...}&quot; = p({a,b}, 1, 1, 2),
<a name="330"/>  330:     &quot;{a,\n b}&quot; = p({a,b}, 1, 1, 3),
<a name="331"/>  331:     &quot;{{}}&quot; = p({{}}, 1, 1, 2),
<a name="332"/>  332:     &quot;{[]}&quot; = p({[]}, 1, 1, 2),
<a name="333"/>  333:     bt(&lt;&lt;&quot;{1,2,a,b,{sfdsf,sdfdsfs},[sfsdf,sdfsdf]}&quot;&gt;&gt;,
<a name="334"/>  334:        p({1,2,a,b,{sfdsf,sdfdsfs},[sfsdf,sdfsdf]}, -1)),
<a name="335"/>  335:     bt(&lt;&lt;&quot;{abcd,ddddd,\n      ddddd}&quot;&gt;&gt;,
<a name="336"/>  336:        p({abcd,ddddd,ddddd}, 1,16, -1)),
<a name="337"/>  337:     bt(&lt;&lt;&quot;{1,2,a,b,\n {sfdsf,sdfdsfs},\n [sfsdf,sdfsdf]}&quot;&gt;&gt;,
<a name="338"/>  338:        p({1,2,a,b,{sfdsf,sdfdsfs},[sfsdf,sdfsdf]}, 1, 35, 100)),
<a name="339"/>  339:     &quot;{1,{1,{2,3}}}&quot; = p({1,{1,{2,3}}}, 1, 80, 100),
<a name="340"/>  340: 
<a name="341"/>  341:     bt(&lt;&lt;&quot;{wwwww,{wwwww,{wwwww,{wwwww,{wwwww,lkjsldfj,klsdjfjklds,\n&quot;
<a name="342"/>  342: 	 &quot;                                   sdkfjdsl,sdakfjdsklj,sdkljfsdj}}}}}&quot;&gt;&gt;,
<a name="343"/>  343:        p({wwwww,{wwwww,{wwwww,{wwwww,{wwwww,lkjsldfj,klsdjfjklds,
<a name="344"/>  344: 				      sdkfjdsl,sdakfjdsklj,sdkljfsdj}}}}}, -1)),
<a name="345"/>  345: 
<a name="346"/>  346:     bt(&lt;&lt;&quot;{wwwww,\n&quot;
<a name="347"/>  347: 	 &quot;    {wwwww,\n&quot;
<a name="348"/>  348: 	 &quot;        {wwwww,\n&quot;
<a name="349"/>  349: 	 &quot;            {wwwww,\n&quot;
<a name="350"/>  350: 	 &quot;                {wwwww,\n&quot;
<a name="351"/>  351: 	 &quot;                    {lkjsldfj,\n&quot;
<a name="352"/>  352: 	 &quot;                        {klsdjfjklds,\n&quot;
<a name="353"/>  353: 	 &quot;                            {klajsljls,\n&quot;
<a name="354"/>  354: 	 &quot;                                #aaaaaaaaaaaaaaaaaaaaa&quot;
<a name="355"/>  355: 	 &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaa{}}}}}}}}}&quot;&gt;&gt;,
<a name="356"/>  356:        p({wwwww,{wwwww,{wwwww,{wwwww,{wwwww,{lkjsldfj,
<a name="357"/>  357: 					     {klsdjfjklds,{klajsljls,
<a name="358"/>  358: 							   {aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa}}}}}}}}},
<a name="359"/>  359: 	 -1)),
<a name="360"/>  360:     &quot;{{...},...}&quot; = p({{a,b},{a,b,c},{d,e,f}},1,8,2),
<a name="361"/>  361:     %% Closing brackets and parentheses count:
<a name="362"/>  362:     &quot;{{a,b,c},\n {{1,2,\n   3}}}&quot; = p({{a,b,c},{{1,2,3}}},1,11,-1),
<a name="363"/>  363:     %% With line breaks:
<a name="364"/>  364:     &quot;{{a,b,c},\n [1,2,\n  3]}&quot; = p({{a,b,c},[1,2,3]},1,10,-1),
<a name="365"/>  365:     %% With line breaks:
<a name="366"/>  366:     &quot;[{{a,b,c},\n  {1,2,\n   3}}]&quot; = p([{{a,b,c},{1,2,3}}],1,12,-1),
<a name="367"/>  367: 
<a name="368"/>  368:     %% A few lists:
<a name="369"/>  369:     &quot;[]&quot; = p([], 1, 20, -1),
<a name="370"/>  370:     &quot;...&quot; = p([], 1, 20, 0),
<a name="371"/>  371:     &quot;[]&quot; = p([], 1, 20, 1),
<a name="372"/>  372:     &quot;[]&quot; = p([], 1, 20, 2),
<a name="373"/>  373:     &quot;[a]&quot; = p([a], 1, 20, -1),
<a name="374"/>  374:     &quot;...&quot; = p([a], 1, 20, 0),
<a name="375"/>  375:     &quot;[...]&quot; = p([a], 1, 20, 1),
<a name="376"/>  376:     &quot;[a]&quot; = p([a], 1, 20, 2),
<a name="377"/>  377:     &quot;[a,b]&quot; = p([a,b], 1, 20, -1),
<a name="378"/>  378:     &quot;...&quot; = p([a,b], 1, 20, 0),
<a name="379"/>  379:     &quot;[...]&quot; = p([a,b], 1, 20, 1),
<a name="380"/>  380:     &quot;[a|...]&quot; = p([a,b], 1, 20, 2),
<a name="381"/>  381:     &quot;[a,b]&quot; = p([a,b], 1, 20, 3),
<a name="382"/>  382:     &quot;[a|b]&quot; = p([a|b], 1, 20, -1),
<a name="383"/>  383:     &quot;...&quot; = p([a|b], 1, 20, 0),
<a name="384"/>  384:     &quot;[...]&quot; = p([a|b], 1, 20, 1),
<a name="385"/>  385:     &quot;[a|...]&quot; = p([a|b], 1, 20, 2),
<a name="386"/>  386:     &quot;[a|b]&quot; = p([a|b], 1, 20, 3),
<a name="387"/>  387:     &quot;[]&quot; = p([], 1, 1, -1),
<a name="388"/>  388:     &quot;...&quot; = p([], 1, 1, 0),
<a name="389"/>  389:     &quot;[]&quot; = p([], 1, 1, 1),
<a name="390"/>  390:     &quot;[]&quot; = p([], 1, 1, 2),
<a name="391"/>  391:     &quot;[a]&quot; = p([a], 1, 1, -1),
<a name="392"/>  392:     &quot;...&quot; = p([a], 1, 1, 0),
<a name="393"/>  393:     &quot;[...]&quot; = p([a], 1, 1, 1),
<a name="394"/>  394:     &quot;[a]&quot; = p([a], 1, 1, 2),
<a name="395"/>  395:     &quot;[a,\n b]&quot; = p([a,b], 1, 1, -1),
<a name="396"/>  396:     &quot;...&quot; = p([a,b], 1, 1, 0),
<a name="397"/>  397:     &quot;[...]&quot; = p([a,b], 1, 1, 1),
<a name="398"/>  398:     &quot;[a|...]&quot; = p([a,b], 1, 1, 2),
<a name="399"/>  399:     &quot;[a,\n b]&quot; = p([a,b], 1, 1, 3),
<a name="400"/>  400:     &quot;[a|\n b]&quot; = p([a|b], 1, 1, -1),
<a name="401"/>  401:     &quot;...&quot; = p([a|b], 1, 1, 0),
<a name="402"/>  402:     &quot;[...]&quot; = p([a|b], 1, 1, 1),
<a name="403"/>  403:     &quot;[a|...]&quot; = p([a|b], 1, 1, 2),
<a name="404"/>  404:     &quot;[a|\n b]&quot; = p([a|b], 1, 1, 3),
<a name="405"/>  405:     &quot;[{}]&quot; = p([{}], 1, 1, 2),
<a name="406"/>  406:     &quot;[[]]&quot; = p([[]], 1, 1, 2),
<a name="407"/>  407:     bt(&lt;&lt;&quot;[1,2,a,b,{sfdsf,sdfdsfs},[sfsdf,sdfsdf]]&quot;&gt;&gt;,
<a name="408"/>  408:        p([1,2,a,b,{sfdsf,sdfdsfs},[sfsdf,sdfsdf]], -1)),
<a name="409"/>  409:     bt(&lt;&lt;&quot;[1,2,a,b,\n {sfdsf,sdfdsfs},\n [sfsdf,sdfsdf]]&quot;&gt;&gt;,
<a name="410"/>  410:        p([1,2,a,b,{sfdsf,sdfdsfs},[sfsdf,sdfsdf]], 1, 35, 100)),
<a name="411"/>  411:     %% Element #8 is not printable:
<a name="412"/>  412:     &quot;[49,&quot; ++ _ = p(&quot;1234567&quot;++[3,4,5,6,7], 1, 100, 9),
<a name="413"/>  413:     %% &quot;\&quot;1234567\&quot;...&quot; = p(&quot;1234567&quot;++[3,4,5,6,7], 1, 100, 8),
<a name="414"/>  414: 
<a name="415"/>  415:     %% A few records:
<a name="416"/>  416:     %% -record(a, {}).
<a name="417"/>  417:     %% -record(a, {}).
<a name="418"/>  418:     &quot;...&quot; = p({a}, 0),
<a name="419"/>  419:     &quot;{...}&quot; = p({a}, 1),
<a name="420"/>  420:     &quot;#a{}&quot; = p({a}, 2),
<a name="421"/>  421:     &quot;#a{}&quot; = p({a}, -1),
<a name="422"/>  422:     %% -record(b, {f}).
<a name="423"/>  423:     &quot;{...}&quot; = p({b}, 1),
<a name="424"/>  424:     &quot;...&quot; = p({b,c}, 0),
<a name="425"/>  425:     &quot;{...}&quot; = p({b,c}, 1),
<a name="426"/>  426:     &quot;#b{...}&quot; = p({b,c}, 2),
<a name="427"/>  427:     &quot;#b{f = c}&quot; = p({b,c}, 3),
<a name="428"/>  428:     &quot;#b{f = c}&quot; = p({b,c}, -1),
<a name="429"/>  429:     &quot;...&quot; = p({b,{c,d}}, 0),
<a name="430"/>  430:     &quot;{...}&quot; = p({b,{c,d}}, 1),
<a name="431"/>  431:     &quot;#b{...}&quot; = p({b,{c,d}}, 2),
<a name="432"/>  432:     &quot;#b{f = {...}}&quot; = p({b,{c,d}}, 3),
<a name="433"/>  433:     &quot;#b{f = {c,...}}&quot; = p({b,{c,d}}, 4),
<a name="434"/>  434:     &quot;#b{f = {c,d}}&quot; = p({b,{c,d}}, 5),
<a name="435"/>  435:     &quot;#b{f = {...}}&quot; = p({b,{b,c}}, 3),
<a name="436"/>  436:     &quot;#b{f = #b{...}}&quot; = p({b,{b,c}}, 4),
<a name="437"/>  437:     &quot;#b{f = #b{f = c}}&quot; = p({b,{b,c}}, 5),
<a name="438"/>  438:     %% -record(c, {f1, f2}).
<a name="439"/>  439:     &quot;#c{f1 = d,f2 = e}&quot; = p({c,d,e}, -1),
<a name="440"/>  440:     &quot;...&quot; = p({c,d,e}, 0),
<a name="441"/>  441:     &quot;{...}&quot; = p({c,d,e}, 1),
<a name="442"/>  442:     &quot;#c{...}&quot; = p({c,d,e}, 2),
<a name="443"/>  443:     &quot;#c{f1 = d,...}&quot; = p({c,d,e}, 3),
<a name="444"/>  444:     &quot;#c{f1 = d,f2 = e}&quot; = p({c,d,e}, 4),
<a name="445"/>  445:     %% -record(d, {a..., b..., c.., d...}).
<a name="446"/>  446:     bt(&lt;&lt;&quot;#d{aaaaaaaaaaaaaaaaaaaa = 1,bbbbbbbbbbbbbbbbbbbb = 2,\n&quot;
<a name="447"/>  447: 	 &quot;   cccccccccccccccccccc = 3,dddddddddddddddddddd = 4,\n&quot;
<a name="448"/>  448: 	 &quot;   eeeeeeeeeeeeeeeeeeee = 5}&quot;&gt;&gt;,
<a name="449"/>  449:        p({d,1,2,3,4,5}, -1)),
<a name="450"/>  450:     &quot;...&quot; = p({d,1,2,3,4,5}, 0),
<a name="451"/>  451:     &quot;{...}&quot; = p({d,1,2,3,4,5}, 1),
<a name="452"/>  452:     &quot;#d{...}&quot; = p({d,1,2,3,4,5}, 2),
<a name="453"/>  453:     &quot;#d{aaaaaaaaaaaaaaaaaaaa = 1,...}&quot; = p({d,1,2,3,4,5}, 3),
<a name="454"/>  454:     bt(&lt;&lt;&quot;#d{aaaaaaaaaaaaaaaaaaaa = 1,bbbbbbbbbbbbbbbbbbbb = 2,...}&quot;&gt;&gt;,
<a name="455"/>  455:        p({d,1,2,3,4,5}, 4)),
<a name="456"/>  456:     bt(&lt;&lt;&quot;#d{aaaaaaaaaaaaaaaaaaaa = 1,bbbbbbbbbbbbbbbbbbbb = 2,\n&quot;
<a name="457"/>  457: 	 &quot;   cccccccccccccccccccc = 3,...}&quot;&gt;&gt;,
<a name="458"/>  458:        p({d,1,2,3,4,5}, 5)), % longer than 80 characters...
<a name="459"/>  459:     bt(&lt;&lt;&quot;#d{aaaaaaaaaaaaaaaaaaaa = 1,bbbbbbbbbbbbbbbbbbbb = 2,\n&quot;
<a name="460"/>  460: 	 &quot;   cccccccccccccccccccc = 3,dddddddddddddddddddd = 4,...}&quot;&gt;&gt;,
<a name="461"/>  461:        p({d,1,2,3,4,5}, 6)),
<a name="462"/>  462:     bt(&lt;&lt;&quot;#d{aaaaaaaaaaaaaaaaaaaa = 1,bbbbbbbbbbbbbbbbbbbb = 2,\n&quot;
<a name="463"/>  463: 	 &quot;   cccccccccccccccccccc = 3,dddddddddddddddddddd = 4,\n&quot;
<a name="464"/>  464: 	 &quot;   eeeeeeeeeeeeeeeeeeee = 5}&quot;&gt;&gt;,
<a name="465"/>  465:        p({d,1,2,3,4,5}, 7)),
<a name="466"/>  466:     bt(&lt;&lt;&quot;#rrrrr{\n&quot;
<a name="467"/>  467: 	 &quot;    f1 = 1,\n&quot;
<a name="468"/>  468: 	 &quot;    f2 = #rrrrr{f1 = a,f2 = b,f3 = c},\n&quot;
<a name="469"/>  469: 	 &quot;    f3 =\n&quot;
<a name="470"/>  470: 	 &quot;        #rrrrr{\n&quot;
<a name="471"/>  471: 	 &quot;            f1 = h,f2 = i,\n&quot;
<a name="472"/>  472: 	 &quot;            f3 =\n&quot;
<a name="473"/>  473: 	 &quot;                #rrrrr{\n&quot;
<a name="474"/>  474: 	 &quot;                    f1 = aa,\n&quot;
<a name="475"/>  475: 	 &quot;                    f2 =\n&quot;
<a name="476"/>  476: 	 &quot;                        #rrrrr{\n&quot;
<a name="477"/>  477: 	 &quot;                            f1 = #rrrrr{f1 = a,f2 = b,f3 = c},\n&quot;
<a name="478"/>  478: 	 &quot;                            f2 = 2,f3 = 3},\n&quot;
<a name="479"/>  479: 	 &quot;                    f3 = bb}}}&quot;&gt;&gt;,
<a name="480"/>  480:        p({rrrrr,1,{rrrrr,a,b,c},{rrrrr,h,i,
<a name="481"/>  481: 				 {rrrrr,aa,{rrrrr,{rrrrr,a,b,c},
<a name="482"/>  482: 					    2,3},bb}}},
<a name="483"/>  483: 	 -1)),
<a name="484"/>  484:     bt(&lt;&lt;&quot;#d{aaaaaaaaaaaaaaaaaaaa = 1,\n&quot;
<a name="485"/>  485: 	 &quot;   bbbbbbbbbbbbbbbbbbbb =\n&quot;
<a name="486"/>  486: 	 &quot;       #d{aaaaaaaaaaaaaaaaaaaa = a,bbbbbbbbbbbbbbbbbbbb = b,\n&quot;
<a name="487"/>  487: 	 &quot;          cccccccccccccccccccc = c,dddddddddddddddddddd = d,\n&quot;
<a name="488"/>  488: 	 &quot;          eeeeeeeeeeeeeeeeeeee = e},\n&quot;
<a name="489"/>  489: 	 &quot;   cccccccccccccccccccc = 3,\n&quot;
<a name="490"/>  490: 	 &quot;   dddddddddddddddddddd =\n&quot;
<a name="491"/>  491: 	 &quot;       #d{aaaaaaaaaaaaaaaaaaaa = h,bbbbbbbbbbbbbbbbbbbb = i,\n&quot;
<a name="492"/>  492: 	 &quot;          cccccccccccccccccccc =\n&quot;
<a name="493"/>  493: 	 &quot;              #d{aaaaaaaaaaaaaaaaaaaa = aa,&quot;
<a name="494"/>  494: 	 &quot;bbbbbbbbbbbbbbbbbbbb = bb,\n&quot;
<a name="495"/>  495: 	 &quot;                 cccccccccccccccccccc =\n&quot;
<a name="496"/>  496: 	 &quot;                     #d{aaaaaaaaaaaaaaaaaaaa = 1,&quot;
<a name="497"/>  497: 	 &quot;bbbbbbbbbbbbbbbbbbbb = 2,\n&quot;
<a name="498"/>  498: 	 &quot;                        cccccccccccccccccccc = 3,&quot;
<a name="499"/>  499: 	 &quot;dddddddddddddddddddd = 4,\n&quot;
<a name="500"/>  500: 	 &quot;                        eeeeeeeeeeeeeeeeeeee = 5},\n&quot;
<a name="501"/>  501: 	 &quot;                 dddddddddddddddddddd = dd,&quot;
<a name="502"/>  502: 	 &quot;eeeeeeeeeeeeeeeeeeee = ee},\n&quot;
<a name="503"/>  503: 	 &quot;          dddddddddddddddddddd = k,&quot;
<a name="504"/>  504: 	 &quot;eeeeeeeeeeeeeeeeeeee = l},\n&quot;
<a name="505"/>  505: 	 &quot;   eeeeeeeeeeeeeeeeeeee = 5}&quot;&gt;&gt;,
<a name="506"/>  506:        p({d,1,{d,a,b,c,d,e},3,{d,h,i,{d,aa,bb,{d,1,2,3,4,5},dd,ee},
<a name="507"/>  507: 			       k,l},5}, -1)),
<a name="508"/>  508: 
<a name="509"/>  509:     A = aaaaaaaaaaaaa,
<a name="510"/>  510:     %% Print the record with dots at the end of the line (Ll = 80).
<a name="511"/>  511:     &quot;{aaaaaaa&quot; ++ _ =
<a name="512"/>  512: 	p({A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,
<a name="513"/>  513: 								       {A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,
<a name="514"/>  514: 																 {A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,
<a name="515"/>  515: 																							   {A,{A,{ggg,{hhh,{ii,{jj,{kk,{ll,{mm,{nn,{oo,{d,1,2,3,4,5}
<a name="516"/>  516: 																												   }}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}
<a name="517"/>  517: 						       }}}}}}}}}}}}}}}}, 146),
<a name="518"/>  518:     &quot;{aaaaaaa&quot; ++ _ =
<a name="519"/>  519: 	p({A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,
<a name="520"/>  520: 								       {A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,
<a name="521"/>  521: 																 {A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{A,
<a name="522"/>  522: 																							   {A,{A,{A,{A,{A,{ggg,{hhh,{ii,{jj,{kk,{ll,{mm,{nn,{oo,{a}
<a name="523"/>  523: 																													    }}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}
<a name="524"/>  524: 								}}}}}}}}}}}}}}}}}}}, 152),
<a name="525"/>  525: 
<a name="526"/>  526:     bt(&lt;&lt;&quot;{aaaaaaaaaaaaa,\n&quot;
<a name="527"/>  527: 	 &quot;    {aaaaaaaaaaaaa,\n&quot;
<a name="528"/>  528: 	 &quot;        {aaaaaaaaaaaaa,\n&quot;
<a name="529"/>  529: 	 &quot;            {aaaaaaaaaaaaa,\n&quot;
<a name="530"/>  530: 	 &quot;                {aaaaaaaaaaaaa,\n&quot;
<a name="531"/>  531: 	 &quot;                    {aaaaaaaaaaaaa,\n&quot;
<a name="532"/>  532: 	 &quot;                        {g,{h,{i,{j,{k,{l,{m,{n,{o,#&quot;
<a name="533"/>  533: 	 &quot;d{...}}}}}}}}}}}}}}}}&quot;&gt;&gt;,
<a name="534"/>  534:        p({A,{A,{A,{A,{A,{A,
<a name="535"/>  535: 			 {g,{h,{i,{j,{k,{l,{m,{n,{o,{d,1,2,3,4,5}}}}}}}}}}}}}}}}, 32)),
<a name="536"/>  536:     bt(&lt;&lt;&quot;{a,#b{f = {c,{d,{e,{f,...}}}}}}&quot;&gt;&gt;,
<a name="537"/>  537:        p({a,{b,{c,{d,{e,{f,g}}}}}}, 12)),
<a name="538"/>  538:     bt(&lt;&lt;&quot;{aaaaaaaaaaaaa,\n&quot;
<a name="539"/>  539: 	 &quot;    {aaaaaaaaaaaaa,\n&quot;
<a name="540"/>  540: 	 &quot;        {aaaaaaaaaaaaa,\n&quot;
<a name="541"/>  541: 	 &quot;            {aaaaaaaaaaaaa,\n&quot;
<a name="542"/>  542: 	 &quot;                {aaaaaaaaaaaaa,\n&quot;
<a name="543"/>  543: 	 &quot;                    {aaaaaaaaaaaaa,\n&quot;
<a name="544"/>  544: 	 &quot;                        {aaaaaaaaaaaaa,\n&quot;
<a name="545"/>  545: 	 &quot;                            {aaaaaaaaaaaaa,\n&quot;
<a name="546"/>  546: 	 &quot;                                {aaaaaaaaaaaaa,#c{f1 = ddd,&quot;
<a name="547"/>  547: 	 &quot;f2 = eee}}}}}}}}}}&quot;&gt;&gt;,
<a name="548"/>  548:        p({A,{A,{A,{A,{A,{A,{A,{A,{A,{c,ddd,eee}}}}}}}}}}, 100)),
<a name="549"/>  549:     bt(&lt;&lt;&quot;{aaaaaaaaaaaaa,\n&quot;
<a name="550"/>  550: 	 &quot;    {aaaaaaaaaaaaa,{aaaaaaaaaaaaa,{aaaaaaaaaaaaa,...}}}}&quot;&gt;&gt;,
<a name="551"/>  551:        p({A,{A,{A,{A,{b}}}}}, 8)),
<a name="552"/>  552:     bt(&lt;&lt;&quot;{aaaaaaaaaaaaa,\n&quot;
<a name="553"/>  553: 	 &quot;    {aaaaaaaaaaaaa,\n&quot;
<a name="554"/>  554: 	 &quot;        {aaaaaaaaaaaaa,{aaaaaaaaaaaaa,{aaaaaaaaaaaaa,...}}}}}&quot;&gt;&gt;,
<a name="555"/>  555:        p({A,{A,{A,{A,{A,{b}}}}}}, 10)),
<a name="556"/>  556:     bt(&lt;&lt;&quot;{aaaaaaaaaaaaa,\n&quot;
<a name="557"/>  557: 	 &quot;    {aaaaaaaaaaaaa,\n&quot;
<a name="558"/>  558: 	 &quot;        {aaaaaaaaaaaaa,\n&quot;
<a name="559"/>  559: 	 &quot;            {aaaaaaaaaaaaa,\n&quot;
<a name="560"/>  560: 	 &quot;                {aaaaaaaaaaaaa,\n&quot;
<a name="561"/>  561: 	 &quot;                    {aaaaaaaaaaaaa,\n&quot;
<a name="562"/>  562: 	 &quot;                        {aaaaaaaaaaaaa,\n&quot;
<a name="563"/>  563: 	 &quot;                            {aaaaaaaaaaaaa,\n&quot;
<a name="564"/>  564: 	 &quot;                                {aaaaaaaaaaaaa,&quot;
<a name="565"/>  565: 	 &quot;{aaaaaaaaaaaaa,#a{}}}}}}}}}}}&quot;&gt;&gt;,
<a name="566"/>  566:        p({A,{A,{A,{A,{A,{A,{A,{A,{A,{A,{a}}}}}}}}}}}, 23)),
<a name="567"/>  567:     bt(&lt;&lt;&quot;{aaaaaaaaaaaaa,\n&quot;
<a name="568"/>  568: 	 &quot;    {aaaaaaaaaaaaa,\n&quot;
<a name="569"/>  569: 	 &quot;        {aaaaaaaaaaaaa,\n&quot;,
<a name="570"/>  570: 	 &quot;            #rrrrr{\n&quot;
<a name="571"/>  571: 	 &quot;                f1 = kljlkjlksfdgkljlsdkjf,&quot;
<a name="572"/>  572: 	 &quot;f2 = kljkljsdaflkjlkjsdf,...}}}}&quot;&gt;&gt;,
<a name="573"/>  573:        p({A,{A,{A,{rrrrr, kljlkjlksfdgkljlsdkjf,
<a name="574"/>  574: 		   kljkljsdaflkjlkjsdf,
<a name="575"/>  575: 		   asdfkldsjfklkljsdklfds}}}}, 10)),
<a name="576"/>  576:     bt(&lt;&lt;&quot;{aaaaaaaaaaaaa,\n&quot;
<a name="577"/>  577: 	 &quot;    {aaaaaaaaaaaaa,\n&quot;
<a name="578"/>  578: 	 &quot;        {aaaaaaaaaaaaa,\n&quot;
<a name="579"/>  579: 	 &quot;            {aaaaaaaaaaaaa,\n&quot;
<a name="580"/>  580: 	 &quot;                {aaaaaaaaaaaaa,\n&quot;
<a name="581"/>  581: 	 &quot;                    {aaaaaaaaaaaaa,\n&quot;
<a name="582"/>  582: 	 &quot;                        {aaaaaaaaaaaaa,\n&quot;
<a name="583"/>  583: 	 &quot;                            {g,{h,{i,{j,{k,{l,{m,{n,&quot;
<a name="584"/>  584: 	 &quot;{o,#a{}}}}}}}}}}}}}}}}}&quot;&gt;&gt;,
<a name="585"/>  585:        p({A,{A,{A,{A,{A,{A,{A,
<a name="586"/>  586: 			    {g,{h,{i,{j,{k,{l,{m,{n,{o,{a}}}}}}}}}}}}}}}}}, 100)),
<a name="587"/>  587:     bt(&lt;&lt;&quot;#c{\n&quot;
<a name="588"/>  588: 	 &quot; f1 =\n&quot;
<a name="589"/>  589: 	 &quot;  #c{\n&quot;
<a name="590"/>  590: 	 &quot;   f1 =\n&quot;
<a name="591"/>  591: 	 &quot;    #c{\n&quot;
<a name="592"/>  592: 	 &quot;     f1 =\n&quot;
<a name="593"/>  593: 	 &quot;      #c{\n&quot;
<a name="594"/>  594: 	 &quot;       f1 =\n&quot;
<a name="595"/>  595: 	 &quot;        #c{\n&quot;
<a name="596"/>  596: 	 &quot;         f1 =\n&quot;
<a name="597"/>  597: 	 &quot;          #c{\n&quot;
<a name="598"/>  598: 	 &quot;           f1 =\n&quot;
<a name="599"/>  599: 	 &quot;            #c{\n&quot;
<a name="600"/>  600: 	 &quot;             f1 =\n&quot;
<a name="601"/>  601: 	 &quot;              #c{\n&quot;
<a name="602"/>  602: 	 &quot;               f1 =\n&quot;
<a name="603"/>  603: 	 &quot;                #c{\n&quot;
<a name="604"/>  604: 	 &quot;                 f1 = #c{f1 = #c{f1 = #c{f1 = a,&quot;
<a name="605"/>  605: 	 &quot;f2 = b},f2 = b},f2 = b},\n&quot;
<a name="606"/>  606: 	 &quot;                 f2 = b},\n&quot;
<a name="607"/>  607: 	 &quot;               f2 = b},\n&quot;
<a name="608"/>  608: 	 &quot;             f2 = b},\n&quot;
<a name="609"/>  609: 	 &quot;           f2 = b},\n&quot;
<a name="610"/>  610: 	 &quot;         f2 = b},\n&quot;
<a name="611"/>  611: 	 &quot;       f2 = b},\n&quot;
<a name="612"/>  612: 	 &quot;     f2 = b},\n&quot;
<a name="613"/>  613: 	 &quot;   f2 = b},\n&quot;
<a name="614"/>  614: 	 &quot; f2 = b}&quot;&gt;&gt;,
<a name="615"/>  615:        p({c,{c,{c,{c,{c,{c,{c,{c,{c,{c,{c,{c,a,b},b},b},b},b},b},
<a name="616"/>  616: 			 b},b},b},b},b},b}, -1)),
<a name="617"/>  617:     bt(&lt;&lt;&quot;#rrrrr{\n&quot;
<a name="618"/>  618: 	 &quot; f1 =\n&quot;
<a name="619"/>  619: 	 &quot;  #rrrrr{\n&quot;
<a name="620"/>  620: 	 &quot;   f1 =\n&quot;
<a name="621"/>  621: 	 &quot;    #rrrrr{\n&quot;
<a name="622"/>  622: 	 &quot;     f1 =\n&quot;
<a name="623"/>  623: 	 &quot;      #rrrrr{\n&quot;
<a name="624"/>  624: 	 &quot;       f1 =\n&quot;
<a name="625"/>  625: 	 &quot;        {rrrrr,{rrrrr,a,#rrrrr{f1 = {rrrrr,1,2},f2 = a,&quot;
<a name="626"/>  626: 	 &quot;f3 = b}},b},\n&quot;
<a name="627"/>  627: 	 &quot;       f2 = {rrrrr,c,d},\n&quot;
<a name="628"/>  628: 	 &quot;       f3 = {rrrrr,1,2}},\n&quot;
<a name="629"/>  629: 	 &quot;     f2 = 1,f3 = 2},\n&quot;
<a name="630"/>  630: 	 &quot;   f2 = 3,f3 = 4},\n&quot;
<a name="631"/>  631: 	 &quot; f2 = 5,f3 = 6}&quot;&gt;&gt;,
<a name="632"/>  632:        p({rrrrr,{rrrrr,{rrrrr,{rrrrr,{rrrrr,{rrrrr,a,{rrrrr,
<a name="633"/>  633: 						      {rrrrr,1,2},a,b}},b},{rrrrr,c,d},{rrrrr,1,2}},
<a name="634"/>  634: 			1,2},3,4},5,6}, -1)),
<a name="635"/>  635:     &quot;{aaa,\n {aaa,&quot; ++ _ =
<a name="636"/>  636:         p({aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,
<a name="637"/>  637: 								       {aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,
<a name="638"/>  638: 															       {aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,
<a name="639"/>  639: 																						  {aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,{aaa,
<a name="640"/>  640: 																												{aaa,a}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}},
<a name="641"/>  641:           1, 80, -1),
<a name="642"/>  642: 
<a name="643"/>  643:     %% A few other cases...
<a name="644"/>  644:     &quot;{a,#Fun&lt;&quot; ++ _ = lists:flatten(io_lib_pretty:print({a,fun fmt/2})),
<a name="645"/>  645:     &quot;#Fun&lt;&quot; ++ _ = io_lib_pretty:print(fun() -&gt; foo end),
<a name="646"/>  646:     %% No support for negative columns any more:
<a name="647"/>  647:     &quot;[a,\n [b,\n  c,\n  d,\n  [e,\n   f]],\n c]&quot; =
<a name="648"/>  648: 	p([a,[b,c,d,[e,f]],c], -1, 2, 10),
<a name="649"/>  649:     &quot;[a,\n [b,\n  c,\n  d,\n  [e,\n   f]],\n c]&quot; =
<a name="650"/>  650: 	p([a,[b,c,d,[e,f]],c], 0, 2, 10),
<a name="651"/>  651:     %% 20 bytes are tried first, then the rest. Try 21 bytes:
<a name="652"/>  652:     L = lists:duplicate(20, $a),
<a name="653"/>  653:     %% bt(&lt;&lt;&quot;&lt;&lt;\&quot;aaaaaa\&quot;\n  \&quot;aaaaaa\&quot;\n  \&quot;aaaaaa\&quot;\n  \&quot;aaa\&quot;&gt;&gt;&quot;&gt;&gt;,
<a name="654"/>  654:     bt(&lt;&lt;&quot;&lt;&lt;\&quot;aaaaaaaaaaaaaaaaaaaaa\&quot;&gt;&gt;&quot;&gt;&gt;,
<a name="655"/>  655:        p(list_to_binary([$a | L]), 1, 10, -1)),
<a name="656"/>  656:     &quot;&lt;&lt;97,&quot; ++ _ = p(list_to_binary(L ++ [3]), 1, 10, -1),
<a name="657"/>  657:     &quot;&lt;&lt;97,&quot; ++ _ = p(list_to_binary(L ++ [3]), 1, 10, 22),
<a name="658"/>  658: 
<a name="659"/>  659:     &quot;\&quot;\\b\\t\\n\\v\\f\\r\\e\250\&quot;&quot; =
<a name="660"/>  660: 	p([8,9,10,11,12,13,27,168], 1, 40, -1),
<a name="661"/>  661:     %% &quot;\&quot;\\b\\t\\n\&quot;\n \&quot;\\v\\f\\r\&quot;\n \&quot;\\e\250\&quot;&quot; =
<a name="662"/>  662:     &quot;\&quot;\\b\\t\\n\\v\\f\\r\\e¨\&quot;&quot; =
<a name="663"/>  663: 	p([8,9,10,11,12,13,27,168], 1, 10, -1),
<a name="664"/>  664:     &quot;\&quot;\\b\\t\\n\\v\\f\\r\\e\250\&quot;&quot; =
<a name="665"/>  665: 	p([8,9,10,11,12,13,27,168], 1, 40, 100),
<a name="666"/>  666:     %% &quot;\&quot;\\e\\t\\nab\&quot;\n \&quot;cd\&quot;&quot; =
<a name="667"/>  667:     &quot;\&quot;\\e\\t\\nabcd\&quot;&quot; =
<a name="668"/>  668: 	p(&quot;\e\t\nabcd&quot;, 1, 12, -1),
<a name="669"/>  669: 
<a name="670"/>  670:     %% DEL (127) is special...
<a name="671"/>  671:     &quot;[127]&quot; = p(&quot;\d&quot;, 1, 10, -1),
<a name="672"/>  672:     &quot;[127]&quot; = p([127], 1, 10, 100),
<a name="673"/>  673: 
<a name="674"/>  674:     &quot;&lt;&lt;\&quot;\\b\\t\\n\\v\\f\\r\\e\250\&quot;&gt;&gt;&quot; =
<a name="675"/>  675: 	p(&lt;&lt;8,9,10,11,12,13,27,168&gt;&gt;, 1, 40, -1),
<a name="676"/>  676:     &quot;&lt;&lt;\&quot;\\b\\t\\n\\v\\f\\r\\e\250\&quot;&gt;&gt;&quot; =
<a name="677"/>  677: 	p(&lt;&lt;8,9,10,11,12,13,27,168&gt;&gt;, 1, 10, -1),
<a name="678"/>  678:     &quot;&lt;&lt;127&gt;&gt;&quot; = p(&lt;&lt;127&gt;&gt;, 1, 10, 100),
<a name="679"/>  679: 
<a name="680"/>  680:     %% &quot;Partial&quot; string binaries:
<a name="681"/>  681:     &quot;&lt;&lt;\&quot;he\&quot;...&gt;&gt;&quot; = p(list_to_binary(&quot;he&quot;++[3]), 1, 80, 2),
<a name="682"/>  682:     &quot;&lt;&lt;\&quot;he\&quot;...&gt;&gt;&quot; = p(list_to_binary(&quot;he&quot;++[3]), 1, 80, 3),
<a name="683"/>  683:     &quot;&lt;&lt;104,101,3&gt;&gt;&quot; = p(list_to_binary(&quot;he&quot;++[3]), 1, 80, 4),
<a name="684"/>  684:     &quot;&lt;&lt;...&gt;&gt;&quot; = p(list_to_binary([3] ++ &quot;he&quot;), 1, 80, 1),
<a name="685"/>  685:     &quot;&lt;&lt;3,...&gt;&gt;&quot; = p(list_to_binary([3] ++ &quot;he&quot;), 1, 80, 2),
<a name="686"/>  686:     &quot;&lt;&lt;3,104,...&gt;&gt;&quot; = p(list_to_binary([3] ++ &quot;he&quot;), 1, 80, 3),
<a name="687"/>  687: 
<a name="688"/>  688:     &quot;&lt;&lt;\&quot;12345678901234567890\&quot;...&gt;&gt;&quot; =
<a name="689"/>  689: 	p(list_to_binary(&quot;12345678901234567890&quot;++[3]), 1, 80, 8),
<a name="690"/>  690:     &quot;&lt;&lt;\&quot;12345678901234567890\&quot;...&gt;&gt;&quot; =
<a name="691"/>  691: 	p(list_to_binary(&quot;12345678901234567890&quot;++[3]), 1, 80, 21),
<a name="692"/>  692:     &quot;&lt;&lt;49,&quot; ++ _ =
<a name="693"/>  693: 	p(list_to_binary(&quot;12345678901234567890&quot;++[3]), 1, 80, 22),
<a name="694"/>  694: 
<a name="695"/>  695:     &quot;{sdfsdfj,\n    23&quot; ++ _ =
<a name="696"/>  696: 	p({sdfsdfj,23423423342.23432423}, 1, 17, -1),
<a name="697"/>  697: 
<a name="698"/>  698:     bt(&lt;&lt;&quot;kljkljlksdjjlf kljalkjlsdajafasjdfj [kjljklasdf,kjlljsfd,sdfsdkjfsd,kjjsdf,jl,
<a name="699"/>  699:                                      lkjjlajsfd|jsdf]&quot;&gt;&gt;,
<a name="700"/>  700:              fmt(&quot;~w ~w ~p&quot;, 
<a name="701"/>  701:                  [kljkljlksdjjlf,
<a name="702"/>  702:                   kljalkjlsdajafasjdfj,
<a name="703"/>  703:                   [kjljklasdf,kjlljsfd,sdfsdkjfsd,kjjsdf,jl,lkjjlajsfd | 
<a name="704"/>  704:                    jsdf]])),
<a name="705"/>  705: 
<a name="706"/>  706:     %% Binaries are split as well:
<a name="707"/>  707:     bt(&lt;&lt;&quot;&lt;&lt;80,100,0,55,55,55,55,55,55,55,55,55,\n  &quot;
<a name="708"/>  708:                &quot;55,55,55,55,55,55,55,...&gt;&gt;&quot;&gt;&gt;, 
<a name="709"/>  709:              p(&lt;&lt;80,100,0,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,
<a name="710"/>  710:                  55,55,55,55,55,55,55,55,55,55,55,55&gt;&gt;,1,40,20)),
<a name="711"/>  711:     bt(&lt;&lt;&quot;&lt;&lt;80,100,0,55,55,55,55,55,55,55,55,55,\n  &quot;
<a name="712"/>  712:                &quot;55,55,55,55,55,55,55,55,55,55,55,55,\n  55,55,55,55,55,55&gt;&gt;&quot;&gt;&gt;,
<a name="713"/>  713:              p(&lt;&lt;80,100,0,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,
<a name="714"/>  714:                  55,55,55,55,55,55,55,55,55,55,55,55&gt;&gt;,1,40,-1)),
<a name="715"/>  715:     &quot;&lt;&lt;0,0,0,\n  ...&gt;&gt;&quot; = p(&lt;&lt;0,0,0,0,0&gt;&gt;, 1, 10, 4),
<a name="716"/>  716: 
<a name="717"/>  717:     %% ~W now uses &quot;,...&quot; when printing tuples
<a name="718"/>  718:     &quot;[a,b|...]&quot; = fmt(&quot;~W&quot;, [[a,b,c,d,e], 3]),
<a name="719"/>  719:     &quot;{a,b,...}&quot; = fmt(&quot;~W&quot;, [{a,b,c,d,e}, 3]),
<a name="otp_6354-last_expr"/><a name="720"/>  720:     ok.
<a name="721"/>  721: 
<a name="722"/>  722: <i>%% OTP-6495. io_lib_pretty bugfix.</i>
<a name="otp_6495-1"/><a name="723"/>  723: <b>otp_6495</b>(Config) when is_list(Config) -&gt;
<a name="724"/>  724:     bt(&lt;&lt;&quot;[120,120,120,120,120,120,120,120,120,120,120,120,120,120,&quot;
<a name="725"/>  725:                &quot;120,120,120,120,120]&lt;&lt;1&gt;&gt;&quot;&gt;&gt;,
<a name="726"/>  726:              fmt(&quot;~w~p&quot;, [&quot;xxxxxxxxxxxxxxxxxxx&quot;, &lt;&lt;1&gt;&gt;])),
<a name="otp_6495-last_expr"/><a name="727"/>  727:     ok.
<a name="728"/>  728: 
<a name="729"/>  729: <i>%% OTP-6517. The Format argument of fwrite can be a binary.</i>
<a name="otp_6517-1"/><a name="730"/>  730: <b>otp_6517</b>(Config) when is_list(Config) -&gt;
<a name="731"/>  731:     &quot;string&quot; = fmt(&lt;&lt;&quot;~s&quot;&gt;&gt;, [&lt;&lt;&quot;string&quot;&gt;&gt;]),
<a name="otp_6517-last_expr"/><a name="732"/>  732:     ok.
<a name="733"/>  733: 
<a name="734"/>  734: <i>%% OTP-6502. Bits.</i>
<a name="otp_6502-1"/><a name="735"/>  735: <b>otp_6502</b>(Config) when is_list(Config) -&gt;
<a name="736"/>  736:     bt(&lt;&lt;
<a name="737"/>  737:      &quot;[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25]&quot;
<a name="738"/>  738:      &quot;&lt;&lt;0,0,8,\n&quot;
<a name="739"/>  739:      &quot;                                                                     &quot;
<a name="740"/>  740:      &quot;  1:1&gt;&gt;&quot;&gt;&gt;,
<a name="741"/>  741:              fmt(&quot;~w~p&quot;, [lists:seq(0, 25), &lt;&lt;17:25&gt;&gt;])),
<a name="otp_6502-last_expr"/><a name="742"/>  742:     ok.
<a name="743"/>  743: 
<a name="744"/>  744: <i>%% OTP-7421. Soft limit of 60 chars removed when pretty printing.</i>
<a name="otp_7421-1"/><a name="745"/>  745: <b>otp_7421</b>(Config) when is_list(Config) -&gt;
<a name="746"/>  746:     bt(&lt;&lt;&quot;{aa,bb,\n&quot;
<a name="747"/>  747:          &quot;    c,dd,\n&quot;
<a name="748"/>  748:          &quot;    eee,\n&quot;
<a name="749"/>  749:          &quot;    fff}&quot;&gt;&gt;,
<a name="750"/>  750:        rp({aa,bb,c,dd,eee,fff}, 1, 80, -1, 5, none)),
<a name="751"/>  751:     bt(&lt;&lt;&quot;{aa,bb,\n&quot;
<a name="752"/>  752:          &quot;    c,\n&quot;
<a name="753"/>  753:          &quot;    dd,\n&quot;
<a name="754"/>  754:          &quot;    eee,\n&quot;
<a name="755"/>  755:          &quot;    fff}&quot;&gt;&gt;,
<a name="756"/>  756:        rp({aa,bb,c,dd,eee,fff}, 1, 80, -1, 4, none)),
<a name="otp_7421-last_expr"/><a name="757"/>  757:     ok.
<a name="758"/>  758: 
<a name="bt-2"/><a name="759"/>  759: <b>bt</b>(Bin, R) -&gt;
<a name="bt-last_expr"/><a name="760"/>  760: <b>    R = binary_to_list</b>(Bin).
<a name="761"/>  761: 
<a name="p-2"/><a name="762"/>  762: <b>p</b>(Term, D) -&gt;
<a name="p-last_expr"/><a name="763"/>  763: <b>    rp</b>(Term, 1, 80, D).
<a name="764"/>  764: 
<a name="p-4"/><a name="765"/>  765: <b>p</b>(Term, Col, Ll, D) -&gt;
<a name="p-last_expr"/><a name="766"/>  766: <b>    rp</b>(Term, Col, Ll, D, none).
<a name="767"/>  767: 
<a name="rp-4"/><a name="768"/>  768: <b>rp</b>(Term, Col, Ll, D) -&gt;
<a name="rp-last_expr"/><a name="769"/>  769: <b>    rp</b>(Term, Col, Ll, D, fun rfd/2).
<a name="770"/>  770: 
<a name="771"/>  771: <b>-define</b>(MAXCS, 60).
<a name="772"/>  772: 
<a name="rp-5"/><a name="773"/>  773: <b>rp</b>(Term, Col, Ll, D, RF) -&gt;
<a name="rp-last_expr"/><a name="774"/>  774: <b>    rp</b>(Term, Col, Ll, D, ?MAXCS, RF).
<a name="775"/>  775: 
<a name="rp-6"/><a name="776"/>  776: <b>rp</b>(Term, Col, Ll, D, M, none) -&gt;
<a name="777"/>  777:     rp(Term, Col, Ll, D, M, fun(_, _) -&gt; no end);
<a name="778"/>  778: <b>rp</b>(Term, Col, Ll, D, M, RF) -&gt;
<a name="779"/>  779:     %% io:format(&quot;~n~n*** Col = ~p Ll = ~p D = ~p~n~p~n--&gt;~n&quot;, 
<a name="780"/>  780:     %%           [Col, Ll, D, Term]),
<a name="781"/>  781:     R = io_lib_pretty:print(Term, Col, Ll, D, M, RF),
<a name="782"/>  782:     %% io:format(&quot;~s~n&lt;--~n&quot;, [R]),
<a name="rp-last_expr"/><a name="783"/>  783: <b>    lists:flatten</b>(io_lib:format(&quot;~s&quot;, [R])).
<a name="784"/>  784: 
<a name="fmt-2"/><a name="785"/>  785: <b>fmt</b>(Fmt, Args) -&gt;
<a name="786"/>  786:     FormatList = io_lib:scan_format(Fmt, Args),
<a name="787"/>  787:     {Fmt2, Args2} = io_lib:unscan_format(FormatList),
<a name="788"/>  788:     Chars1 = lists:flatten(io_lib:build_text(FormatList)),
<a name="789"/>  789:     Chars2 = lists:flatten(io_lib:format(Fmt2, Args2)),
<a name="790"/>  790:     Chars3 = lists:flatten(io_lib:format(Fmt, Args)),
<a name="791"/>  791:     Chars1 = Chars2,
<a name="792"/>  792:     Chars2 = Chars3,
<a name="fmt-last_expr"/><a name="793"/>  793:     Chars3.
<a name="794"/>  794: 
<a name="rfd-2"/><a name="795"/>  795: <b>rfd</b>(a, 0) -&gt;
<a name="796"/>  796:     [];
<a name="797"/>  797: <b>rfd</b>(b, 1) -&gt;
<a name="798"/>  798:     [f];
<a name="799"/>  799: <b>rfd</b>(c, 2) -&gt;
<a name="800"/>  800:     [f1, f2];
<a name="801"/>  801: <b>rfd</b>(e, 3) -&gt;
<a name="802"/>  802:     [f, g, h];
<a name="803"/>  803: <b>rfd</b>(d, 5) -&gt;
<a name="804"/>  804:     [aaaaaaaaaaaaaaaaaaaa, bbbbbbbbbbbbbbbbbbbb,
<a name="805"/>  805:      cccccccccccccccccccc, dddddddddddddddddddd,
<a name="806"/>  806:      eeeeeeeeeeeeeeeeeeee];
<a name="807"/>  807: <b>rfd</b>(rrrrr, 3) -&gt;
<a name="808"/>  808:     [f1, f2, f3];
<a name="809"/>  809: <b>rfd</b>(aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa, 0) -&gt;
<a name="810"/>  810:     [];
<a name="811"/>  811: <b>rfd</b>('\x{400}', 1) -&gt;
<a name="812"/>  812:     ['\x{400}'];
<a name="813"/>  813: <b>rfd</b>(_, _) -&gt;
<a name="rfd-last_expr"/><a name="814"/>  814:     no.
<a name="815"/>  815: 
<a name="816"/>  816: <i>%% The examples in io(3) and io_lib(3).</i>
<a name="manpage-1"/><a name="817"/>  817: <b>manpage</b>(Config) when is_list(Config) -&gt;
<a name="818"/>  818:     %% The examples that write or print only, not the ones that read...
<a name="819"/>  819: 
<a name="820"/>  820:     bt(&lt;&lt;&quot;Hello world!\n&quot;&gt;&gt;,
<a name="821"/>  821:              fmt(&quot;Hello world!~n&quot;, [])),
<a name="822"/>  822:     bt(&lt;&lt;&quot;|     aaaaa|bbbbb     |ccccc|\n&quot;&gt;&gt;, % bugfix
<a name="823"/>  823:              fmt(&quot;|~10.5c|~-10.5c|~5c|~n&quot;, [$a, $b, $c])),
<a name="824"/>  824:     bt(&lt;&lt;&quot;|**********|\n&quot;&gt;&gt;,
<a name="825"/>  825:              fmt(&quot;|~10w|~n&quot;, [{hey, hey, hey}])),
<a name="826"/>  826:     bt(&lt;&lt;&quot;|{hey,hey,h|\n&quot;&gt;&gt;,
<a name="827"/>  827:              fmt(&quot;|~10s|~n&quot;, [io_lib:write({hey, hey, hey})])),
<a name="828"/>  828: 
<a name="829"/>  829:     T = [{attributes,[[{id,age,1.50000},{mode,explicit},
<a name="830"/>  830:         {typename,&quot;INTEGER&quot;}], [{id,cho},{mode,explicit},{typename,'Cho'}]]},
<a name="831"/>  831:         {typename,'Person'},{tag,{'PRIVATE',3}},{mode,implicit}],
<a name="832"/>  832:     bt(&lt;&lt;&quot;[{attributes,[[{id,age,1.5},{mode,explicit},{typename,&quot;
<a name="833"/>  833:                &quot;[73,78,84,69,71,69,82]}],[{id,cho},{mode,explicit},&quot;
<a name="834"/>  834:                &quot;{typename,'Cho'}]]},{typename,'Person'},{tag,{'PRIVATE',3}},&quot;
<a name="835"/>  835:                &quot;{mode,implicit}]\n&quot;&gt;&gt;,
<a name="836"/>  836:              fmt(&quot;~w~n&quot;, [T])),
<a name="837"/>  837:     bt(&lt;&lt;&quot;[{attributes,[[{id,age,1.5},\n&quot;
<a name="838"/>  838:                &quot;               {mode,explicit},\n&quot;
<a name="839"/>  839:                &quot;               {typename,\&quot;INTEGER\&quot;}],\n&quot;
<a name="840"/>  840:                &quot;              [{id,cho},{mode,explicit},{typename,'Cho'}]]},\n&quot;
<a name="841"/>  841:                &quot; {typename,'Person'},\n&quot;
<a name="842"/>  842:                &quot; {tag,{'PRIVATE',3}},\n&quot;
<a name="843"/>  843:                &quot; {mode,implicit}]\n&quot;&gt;&gt;,
<a name="844"/>  844:              fmt(&quot;~62p~n&quot;, [T])),
<a name="845"/>  845:     bt(&lt;&lt;&quot;Here T = [{attributes,[[{id,age,1.5},\n&quot;
<a name="846"/>  846:                &quot;                        {mode,explicit},\n&quot;
<a name="847"/>  847:                &quot;                        {typename,\&quot;INTEGER\&quot;}],\n&quot;
<a name="848"/>  848:                &quot;                       [{id,cho},\n&quot;
<a name="849"/>  849:                &quot;                        {mode,explicit},\n&quot;
<a name="850"/>  850:                &quot;                        {typename,'Cho'}]]},\n&quot;
<a name="851"/>  851:                &quot;          {typename,'Person'},\n&quot;
<a name="852"/>  852:                &quot;          {tag,{'PRIVATE',3}},\n&quot;
<a name="853"/>  853:                &quot;          {mode,implicit}]\n&quot;&gt;&gt;,
<a name="854"/>  854:               fmt(&quot;Here T = ~62p~n&quot;, [T])),
<a name="855"/>  855:     bt(&lt;&lt;&quot;[{attributes,[[{id,age,1.5},{mode,explicit},&quot;
<a name="856"/>  856:                &quot;{typename,...}],[{id,cho},{mode,...},{...}]]},&quot;
<a name="857"/>  857:                &quot;{typename,'Person'},{tag,{'PRIVATE',3}},{mode,implicit}]\n&quot;&gt;&gt;,
<a name="858"/>  858:              fmt(&quot;~W~n&quot;, [T,9])),
<a name="859"/>  859:     bt(&lt;&lt;&quot;[{attributes,[[{id,age,1.5},{mode,explicit},{typename,...}],&quot;
<a name="860"/>  860:                &quot;\n              &quot;
<a name="861"/>  861:                &quot;[{id,cho},{mode,...},{...}]]},\n {typename,'Person'},\n &quot;
<a name="862"/>  862:                &quot;{tag,{'PRIVATE',3}},\n {mode,implicit}]\n&quot;&gt;&gt;,
<a name="863"/>  863:              fmt(&quot;~62P~n&quot;, [T,9])),
<a name="864"/>  864: 
<a name="865"/>  865:     &quot;1F\n&quot; = fmt(&quot;~.16B~n&quot;, [31]),
<a name="866"/>  866:     &quot;-10011\n&quot; = fmt(&quot;~.2B~n&quot;, [-19]),
<a name="867"/>  867:     &quot;5Z\n&quot; = fmt(&quot;~.36B~n&quot;, [5*36+35]),
<a name="868"/>  868:     &quot;10#31\n&quot; = fmt(&quot;~X~n&quot;, [31,&quot;10#&quot;]),
<a name="869"/>  869:     &quot;-0x1F\n&quot; = fmt(&quot;~.16X~n&quot;, [-31,&quot;0x&quot;]),
<a name="870"/>  870:     &quot;10#31\n&quot; = fmt(&quot;~.10#~n&quot;, [31]),
<a name="871"/>  871:     &quot;-16#1F\n&quot; = fmt(&quot;~.16#~n&quot;, [-31]),
<a name="872"/>  872:     &quot;abc def 'abc def'  {foo,1} A \n&quot; =
<a name="873"/>  873:            fmt(&quot;~s ~w ~i ~w ~c ~n&quot;,
<a name="874"/>  874:                ['abc def', 'abc def', {foo, 1},{foo, 1}, 65]),
<a name="875"/>  875:     %% fmt(&quot;~s&quot;, [65]),
<a name="876"/>  876: 
<a name="877"/>  877:     %% io_lib(3)
<a name="878"/>  878:     bt(&lt;&lt;&quot;{1,[2],[3],[...],...}&quot;&gt;&gt;,
<a name="879"/>  879:              lists:flatten(io_lib:write({1,[2],[3],[4,5],6,7,8,9}, 5))),
<a name="manpage-last_expr"/><a name="880"/>  880:     ok.
<a name="881"/>  881: 
<a name="882"/>  882: <i>%% OTP-6708. Fewer newlines when pretty-printing.</i>
<a name="otp_6708-1"/><a name="883"/>  883: <b>otp_6708</b>(Config) when is_list(Config) -&gt;
<a name="884"/>  884:     bt(&lt;&lt;&quot;[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,\n&quot;
<a name="885"/>  885:                &quot; 23,24,25,26,27,28,29|...]&quot;&gt;&gt;,
<a name="886"/>  886:              p(lists:seq(1,1000), 30)),
<a name="887"/>  887:     bt(&lt;&lt;&quot;{lkjasklfjsdak,mlkasjdflksj,klasdjfklasd,jklasdfjkl,\n&quot;
<a name="888"/>  888:                &quot;               jklsdjfklsd,masdfjkkl}&quot;&gt;&gt;,
<a name="889"/>  889:              p({lkjasklfjsdak,mlkasjdflksj,klasdjfklasd,jklasdfjkl,
<a name="890"/>  890:                 jklsdjfklsd, masdfjkkl}, -1)),
<a name="891"/>  891:     bt(&lt;&lt;&quot;#b{f = {lkjljalksdf,jklaskfjd,kljasdlf,kljasdf,kljsdlkf,\n&quot;
<a name="892"/>  892:                &quot;                    kjdd}}&quot;&gt;&gt;,
<a name="893"/>  893:              p({b, {lkjljalksdf,jklaskfjd,kljasdlf,kljasdf,kljsdlkf,kjdd}}, 
<a name="894"/>  894:                -1)),
<a name="895"/>  895:     bt(&lt;&lt;&quot;#b{f = {lkjljalksdf,jklaskfjd,kljasdlf,kljasdf,kljsdlkf,\n&quot;
<a name="896"/>  896:                &quot;                    kdd}}&quot;&gt;&gt;,
<a name="897"/>  897:              p({b, {lkjljalksdf,jklaskfjd,kljasdlf,kljasdf,kljsdlkf,kdd}}, 
<a name="898"/>  898:                -1)),
<a name="899"/>  899:     bt(&lt;&lt;&quot;#e{f = undefined,g = undefined,\n&quot;
<a name="900"/>  900:                &quot;   h = #e{f = 11,g = 22,h = 333}}&quot;&gt;&gt;,
<a name="901"/>  901:              p({e,undefined,undefined,{e,11,22,333}}, -1)),
<a name="902"/>  902:     bt(&lt;&lt;&quot;[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21|\n&quot;
<a name="903"/>  903:                &quot; apa11]&quot;&gt;&gt;,
<a name="904"/>  904:              p(lists:seq(1,21) ++ apa11, -1)),
<a name="905"/>  905:     bt(&lt;&lt;&quot;[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,\n&quot;
<a name="906"/>  906:                &quot; 23,\n&quot;
<a name="907"/>  907:                &quot; {{abadalkjlasdjflksdajfksdklfsdjlkfdlskjflsdj&quot;
<a name="908"/>  908:                         &quot;flsdjfldsdsdddd}}]&quot;&gt;&gt;,
<a name="909"/>  909:           p(lists:seq(1,23) ++ 
<a name="910"/>  910:             [{{abadalkjlasdjflksdajfksdklfsdjlkfdlskjflsdjflsdjfldsdsdddd}}],
<a name="911"/>  911:             -1)),
<a name="912"/>  912:     bt(&lt;&lt;&quot;{lkjasdf,\n&quot;
<a name="913"/>  913:                &quot;    {kjkjsd,\n&quot;
<a name="914"/>  914:                &quot;        {kjsd,\n&quot;
<a name="915"/>  915:                &quot;            {kljsdf,\n&quot;
<a name="916"/>  916:                &quot;                {kjlsd,{dkjsdf,{kjlds,{kljsd,{kljs,&quot;
<a name="917"/>  917:                                    &quot;{kljlkjsd}}}}}}}}}}&quot;&gt;&gt;,
<a name="918"/>  918:              p({lkjasdf,{kjkjsd,{kjsd,
<a name="919"/>  919:                                  {kljsdf,
<a name="920"/>  920:                                   {kjlsd,
<a name="921"/>  921:                                    {dkjsdf,{kjlds,
<a name="922"/>  922:                                             {kljsd,{kljs,{kljlkjsd}}}}}}}}}},
<a name="923"/>  923:                -1)),
<a name="924"/>  924:     bt(&lt;&lt;&quot;{lkjasdf,\n&quot;
<a name="925"/>  925:                &quot;    {kjkjsd,\n&quot;
<a name="926"/>  926:                &quot;        {kjsd,{kljsdf,{kjlsd,{dkjsdf,{kjlds,&quot;
<a name="927"/>  927:                                 &quot;{kljsd,{kljs}}}}}}}}}&quot;&gt;&gt;,
<a name="928"/>  928:              p({lkjasdf,{kjkjsd,{kjsd,
<a name="929"/>  929:                                  {kljsdf,{kjlsd,{dkjsdf,
<a name="930"/>  930:                                                  {kjlds,{kljsd,{kljs}}}}}}}}},
<a name="931"/>  931:                -1)),
<a name="932"/>  932:     bt(&lt;&lt;&quot;&lt;&lt;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,\n&quot;
<a name="933"/>  933:                &quot;  22,23&gt;&gt;&quot;&gt;&gt;,
<a name="934"/>  934:              p(list_to_binary(lists:seq(1,23)), -1)),
<a name="935"/>  935:     bt(&lt;&lt;&quot;&lt;&lt;100,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,\n&quot;
<a name="936"/>  936:                &quot;  27&gt;&gt;&quot;&gt;&gt;,
<a name="937"/>  937:              p(list_to_binary([100|lists:seq(10,27)]), -1)),
<a name="938"/>  938:     bt(&lt;&lt;&quot;&lt;&lt;100,101,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,\n&quot;
<a name="939"/>  939:                &quot;  26&gt;&gt;&quot;&gt;&gt;,
<a name="940"/>  940:              p(list_to_binary([100,101|lists:seq(10,26)]), -1)),
<a name="941"/>  941:     bt(&lt;&lt;&quot;{{&lt;&lt;100,101,102,10,11,12,13,14,15,16,17,18,19,20,21,22,\n&quot;
<a name="942"/>  942:                &quot;    23&gt;&gt;}}&quot;&gt;&gt;,
<a name="943"/>  943:              p({{list_to_binary([100,101,102|lists:seq(10,23)])}}, -1)),
<a name="944"/>  944:     bt(&lt;&lt;&quot;[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22|\n&quot;
<a name="945"/>  945:                &quot; ap]&quot;&gt;&gt;,
<a name="946"/>  946:              p(lists:seq(1,22) ++ ap, -1)),
<a name="947"/>  947:     bt(&lt;&lt;&quot;[1,2,3,4,5,6,7,8,9,10,{},[],\n &lt;&lt;&gt;&gt;,11,12,13,14,15]&quot;&gt;&gt;,
<a name="948"/>  948:              p(lists:seq(1,10) ++ [{},[],&lt;&lt;&gt;&gt;] ++ lists:seq(11,15),1,30,-1)),
<a name="949"/>  949:     bt(&lt;&lt;&quot;[ddd,ddd,\n&quot;
<a name="950"/>  950:                &quot; {1},\n&quot;
<a name="951"/>  951:                &quot; [1,2],\n&quot;
<a name="952"/>  952:                &quot; ddd,kdfd,\n&quot;
<a name="953"/>  953:                &quot; [[1,2],a,b,c],\n&quot;
<a name="954"/>  954:                &quot; &lt;&lt;\&quot;foo\&quot;&gt;&gt;,&lt;&lt;\&quot;bar\&quot;&gt;&gt;,1,\n&quot;
<a name="955"/>  955:                &quot; {2}]&quot;&gt;&gt;,
<a name="956"/>  956:              p([ddd,ddd,{1},[1,2],ddd,kdfd,[[1,2],a,b,c],&lt;&lt;&quot;foo&quot;&gt;&gt;,&lt;&lt;&quot;bar&quot;&gt;&gt;,
<a name="957"/>  957:                 1,{2}],1,50,-1)),
<a name="958"/>  958: 
<a name="959"/>  959:     bt(&lt;&lt;&quot;{dskljsadfkjsdlkjflksdjflksdjfklsdjklfjsdklfjlsdjfkl,jksd,\n&quot;
<a name="960"/>  960:                &quot;                                                     &quot;
<a name="961"/>  961:                    &quot;lkjsdf,kljsdf,kljsf,kljsdf,kljsdf,jkldf,jklsdf,kljsdf,\n&quot;
<a name="962"/>  962:                &quot;                                                     &quot;
<a name="963"/>  963:                    &quot;kljsdf,jklsdf,lkjfd,lkjsdf,kljsdf,kljsdf,lkjsdf,kljsdf,\n&quot;
<a name="964"/>  964:                &quot;                                                     &quot;
<a name="965"/>  965:                    &quot;lkjsdfsd,kljsdf,kjsfj}&quot;&gt;&gt;,
<a name="966"/>  966:              p({dskljsadfkjsdlkjflksdjflksdjfklsdjklfjsdklfjlsdjfkl,jksd,
<a name="967"/>  967:                 lkjsdf,kljsdf,kljsf,kljsdf,kljsdf,jkldf,jklsdf,kljsdf,
<a name="968"/>  968:                 kljsdf,jklsdf,lkjfd,lkjsdf,kljsdf,kljsdf,lkjsdf,kljsdf,
<a name="969"/>  969:                 lkjsdfsd,kljsdf,kjsfj}, 1, 110, -1)),
<a name="970"/>  970:     bt(&lt;&lt;&quot;{dskljsadfkjsdlkjflksdjflksdjfklsdjklfjsdklfjlsdjfkl,&quot;
<a name="971"/>  971:                   &quot;#d{aaaaaaaaaaaaaaaaaaaa = 1,\n&quot;
<a name="972"/>  972:                &quot;                                                        &quot;
<a name="973"/>  973:                   &quot;bbbbbbbbbbbbbbbbbbbb = 2,cccccccccccccccccccc = 3,\n&quot;
<a name="974"/>  974:                &quot;                                                        &quot;
<a name="975"/>  975:                   &quot;dddddddddddddddddddd = 4,eeeeeeeeeeeeeeeeeeee = 5}}&quot;&gt;&gt;,
<a name="976"/>  976:              rp({dskljsadfkjsdlkjflksdjflksdjfklsdjklfjsdklfjlsdjfkl,
<a name="977"/>  977:                  {d,1,2,3,4,5}},1,200,-1)),
<a name="otp_6708-last_expr"/><a name="978"/>  978:     ok.
<a name="979"/>  979: 
<a name="980"/>  980: <b>-define</b>(ONE(N), ((1 bsl N) - 1)).
<a name="981"/>  981: <b>-define</b>(ALL_ONES, ((1 bsl 52) - 1)).
<a name="982"/>  982: 
<a name="983"/>  983: 
<a name="otp_7084-0"/><a name="984"/>  984: <b>otp_7084</b>() -&gt;
<a name="otp_7084-last_expr"/><a name="985"/>  985:     [{timetrap,{minutes,6}}]. %% valgrind needs a lot of time
<a name="986"/>  986: 
<a name="987"/>  987: <i>%% OTP-7084. Printing floating point numbers nicely.</i>
<a name="otp_7084-1"/><a name="988"/>  988: <b>otp_7084</b>(Config) when is_list(Config) -&gt;
<a name="989"/>  989:     L = [{g_warm_up, fun g_warm_up/0},
<a name="990"/>  990:          {g_big_pos_float, fun g_big_pos_float/0},
<a name="991"/>  991:          {g_small_neg_float, fun g_small_neg_float/0},
<a name="992"/>  992:          {g_close_to_zero, fun g_close_to_zero/0},
<a name="993"/>  993:          {g_denormalized, fun g_denormalized/0},
<a name="994"/>  994:          {g_normalized, fun g_normalized/0},
<a name="995"/>  995:          {g_choice, fun g_choice/0},
<a name="996"/>  996:          {g_ryu, fun g_ryu/0},
<a name="997"/>  997:          {g_anomalous, fun g_anomalous/0},
<a name="998"/>  998:          {g_misc, fun g_misc/0}],
<a name="999"/>  999:     F = fun({M,T}) -&gt; io:format(&quot;~p~n&quot;, [M]), T() end,
<a name="1000"/> 1000:     lists:foreach(fun(T) -&gt; F(T) end, L),
<a name="otp_7084-last_expr"/><a name="1001"/> 1001:     ok.
<a name="1002"/> 1002: 
<a name="g_warm_up-0"/><a name="1003"/> 1003: <b>g_warm_up</b>() -&gt;
<a name="1004"/> 1004:     g_t(0.5),
<a name="1005"/> 1005:     g_t(-0.5),
<a name="1006"/> 1006:     g_t((1 bsl 55) * 0.5),
<a name="1007"/> 1007:     g_t(-(1 bsl 55) * 0.5),
<a name="1008"/> 1008:     g_t(1.6799127650033296e+308),
<a name="1009"/> 1009:     g_t(pack(1, 0, 2#1010101010001100101000010111100101000000101100110001)),
<a name="1010"/> 1010:     g_t(pack(1, 0, 2#0001010000001001110100000101010101001110010001010110)),
<a name="1011"/> 1011:     g_t(234324324.23432432432432),
<a name="g_warm_up-last_expr"/><a name="1012"/> 1012:     ok.
<a name="1013"/> 1013: 
<a name="g_big_pos_float-0"/><a name="1014"/> 1014: <b>g_big_pos_float</b>() -&gt;
<a name="1015"/> 1015:     %% The greatest positive float:
<a name="1016"/> 1016:     ft({{0,2046,?ONE(52)}, 100, 0}),
<a name="g_big_pos_float-last_expr"/><a name="1017"/> 1017:     ok.
<a name="1018"/> 1018: 
<a name="g_small_neg_float-0"/><a name="1019"/> 1019: <b>g_small_neg_float</b>() -&gt;
<a name="1020"/> 1020:     %% The least negative float:
<a name="1021"/> 1021:     ft({{1,2046,?ONE(52)}, 0, 100}),
<a name="g_small_neg_float-last_expr"/><a name="1022"/> 1022:     ok.
<a name="1023"/> 1023: 
<a name="g_close_to_zero-0"/><a name="1024"/> 1024: <b>g_close_to_zero</b>() -&gt;
<a name="1025"/> 1025:     %% A few denormalized floats close to zero:
<a name="1026"/> 1026:     ft({{0,0,0}, 100, 100}),
<a name="1027"/> 1027:     g_t(pack(1, 0, 0)), % -0.0
<a name="g_close_to_zero-last_expr"/><a name="1028"/> 1028:     ok.
<a name="1029"/> 1029: 
<a name="g_denormalized-0"/><a name="1030"/> 1030: <b>g_denormalized</b>() -&gt;
<a name="1031"/> 1031:     %% Denormalized floats (mantissa carry):
<a name="1032"/> 1032: <i>%%    D = 5,</i>
<a name="1033"/> 1033:     %% Faster:
<a name="1034"/> 1034:     D = 1,
<a name="1035"/> 1035:     [ft({{S,0,?ONE(N)},D,D}) || S &lt;- [0,1], N &lt;- lists:seq(0, 52)],
<a name="g_denormalized-last_expr"/><a name="1036"/> 1036:     ok.
<a name="1037"/> 1037: 
<a name="g_normalized-0"/><a name="1038"/> 1038: <b>g_normalized</b>() -&gt; 
<a name="1039"/> 1039:     %% Normalized floats (exponent carry):
<a name="1040"/> 1040: <i>%%    D = 5,</i>
<a name="1041"/> 1041:     %% Faster:
<a name="1042"/> 1042:     D = 1,
<a name="1043"/> 1043:     [ft({{S,E,?ONE(52)},D,D}) || S &lt;- [0,1], E &lt;- lists:seq(0, 2045)],
<a name="g_normalized-last_expr"/><a name="1044"/> 1044:     ok.
<a name="1045"/> 1045: 
<a name="g_choice-0"/><a name="1046"/> 1046: <b>g_choice</b>() -&gt;
<a name="1047"/> 1047:     %% Exponent should be used when and only when the string is shorter.
<a name="1048"/> 1048:     %% (g_misc/0 checks this too, and probably more throughly).
<a name="1049"/> 1049:     L = [0.0003, 3.0e-5, 3.3e-5, 3.3e-4,
<a name="1050"/> 1050:          314.0, 314.1, 310.0, 3.1e6, -100.0,
<a name="1051"/> 1051:          3.34e4, 3.0e3, 3.34333e9, 3.3433323e10, 33433323700.0,
<a name="1052"/> 1052:          0.00197963, 1.97963e-4],
<a name="1053"/> 1053:     lists:foreach(fun(V) -&gt; g_t(V) end, L),
<a name="g_choice-last_expr"/><a name="1054"/> 1054:     ok.
<a name="1055"/> 1055: 
<a name="g_anomalous-0"/><a name="1056"/> 1056: <b>g_anomalous</b>() -&gt;
<a name="1057"/> 1057:     %% These test cases come from https://github.com/microsoft/STL/blob/f1515e04fd00876137e762c08b90d9aa450859e0/tests/std/tests/P0067R5_charconv/double_to_chars_test_cases.hpp
<a name="1058"/> 1058: 
<a name="1059"/> 1059:     %% https://www.exploringbinary.com/the-shortest-decimal-string-that-round-trips-may-not-be-the-nearest/
<a name="1060"/> 1060:     %% This is an exhaustive list of anomalous values
<a name="1061"/> 1061:     %% Because math, these values have shortest-round-trip decimal representations containing 16 significant digits,
<a name="1062"/> 1062:     %% but those decimal digits aren't what would be printed by &quot;%.15e&quot;. For ordinary values, shortest-round-trip
<a name="1063"/> 1063:     %% behaves as if it can magically pick a precision for &quot;%.*e&quot;, finding the smallest precision that round-trips.
<a name="1064"/> 1064:     %% (That is, start with the exact decimal representation, and then round it as much as possible.) These anomalous
<a name="1065"/> 1065:     %% values demonstrate an exception to that mental model. They aren't being &quot;incorrectly rounded&quot;; instead, having
<a name="1066"/> 1066:     %% the shortest output that round-trips is being prioritized. (This differs by 1 in the least significant decimal
<a name="1067"/> 1067:     %% digit printed, so it's a very small difference.)
<a name="1068"/> 1068: 
<a name="1069"/> 1069:     L_anom = [6.386688990511104e+293, 5.282945311356653e+269,
<a name="1070"/> 1070:               6.150157786156811e+259, 5.334411546303884e+241,
<a name="1071"/> 1071:               5.386379163185535e+213, 6.483618076376552e+178,
<a name="1072"/> 1072:               6.183260036827614e+172, 5.896816288783659e+166,
<a name="1073"/> 1073:               5.758609657015292e+163, 5.623642243178996e+160,
<a name="1074"/> 1074:               6.243497100631985e+144, 8.263199609878108e+121,
<a name="1075"/> 1075:               6.455624695217272e+119, 6.156563468186638e+113,
<a name="1076"/> 1076:               7.167183174968974e+103, 6.518515124270356e+91,
<a name="1077"/> 1077:               6.070840288205404e+82, 6.129982163463556e+54,
<a name="1078"/> 1078:               5.986310706507379e+51, 5.444517870735016e+39,
<a name="1079"/> 1079:               5.316911983139664e+36, 6.189700196426902e+26,
<a name="1080"/> 1080:               5.960464477539063e-08, 5.684341886080802e-14,
<a name="1081"/> 1081:               6.617444900424222e-24, 6.310887241768095e-30,
<a name="1082"/> 1082:               7.174648137343064e-43, 7.854549544476363e-90,
<a name="1083"/> 1083:               6.653062250012736e-111, 5.075883674631299e-116,
<a name="1084"/> 1084:               6.256509672447191e-148, 4.887898181599368e-150,
<a name="1085"/> 1085:               5.966672584960166e-154, 5.426657103235053e-166,
<a name="1086"/> 1086:               5.351097043477547e-197, 5.225680706521042e-200,
<a name="1087"/> 1087:               6.083493012144512e-210, 5.940911144672375e-213,
<a name="1088"/> 1088:               6.290184345309701e-235, 6.142758149716505e-238,
<a name="1089"/> 1089:               7.678447687145631e-239, 5.858190679279809e-244,
<a name="1090"/> 1090:               5.641232424577593e-278, 8.209073602596753e-289,
<a name="1091"/> 1091:               7.291122019556398e-304, 7.120236347223045e-307],
<a name="1092"/> 1092:     lists:foreach(fun(V) -&gt; g_t(V) end, L_anom),
<a name="1093"/> 1093: 
<a name="1094"/> 1094:     %% This is an exhaustive list of almost-but-not-quite-anomalous values.
<a name="1095"/> 1095:     L_quasi_anom = [6.237000967296e+290, 6.090821257125e+287,
<a name="1096"/> 1096:                     8.25460204899477e+267, 5.78358058743443e+222,
<a name="1097"/> 1097:                     7.1362384635298e+44, 6.10987272699921e-151,
<a name="1098"/> 1098:                     5.17526350329881e-172, 6.84940421565126e-195],
<a name="1099"/> 1099:     lists:foreach(fun(V) -&gt; g_t(V) end, L_quasi_anom),
<a name="1100"/> 1100: 
<a name="g_anomalous-last_expr"/><a name="1101"/> 1101:     ok.
<a name="1102"/> 1102: 
<a name="g_ryu-0"/><a name="1103"/> 1103: <b>g_ryu</b>() -&gt;
<a name="1104"/> 1104:     %% specific white box tests that should trigger specific edge cases
<a name="1105"/> 1105:     %% to the ryu algorithm see: 
<a name="1106"/> 1106:     %% https://github.com/ulfjack/ryu/blob/master/ryu/tests/d2s_test.cc
<a name="1107"/> 1107: 
<a name="1108"/> 1108:     %% this list is regression tests from the ryu C ref implementation
<a name="1109"/> 1109:     L_regression = [-2.109808898695963e16, 4.940656e-318, 1.18575755E-316,
<a name="1110"/> 1110:                     2.989102097996e-312, 9.0608011534336e15,
<a name="1111"/> 1111:                     4.708356024711512e18, 9.409340012568248e18,
<a name="1112"/> 1112:                     1.2345678],
<a name="1113"/> 1113:     lists:foreach(fun(V) -&gt; g_t(V) end, L_regression),
<a name="1114"/> 1114: 
<a name="1115"/> 1115:     %% These numbers have a mantissa that is a multiple of the largest power of 5 that fits,
<a name="1116"/> 1116:     %% and an exponent that causes the computation for q to result in 22, which is a corner
<a name="1117"/> 1117:     %% case for Ryu.
<a name="1118"/> 1118:     L_pow5 = [16#4830F0CF064DD592, 16#4840F0CF064DD592, 
<a name="1119"/> 1119:               16#4850F0CF064DD592],
<a name="1120"/> 1120:     lists:foreach(fun(V) -&gt; g_t(i_2_d(V)) end, L_pow5),
<a name="1121"/> 1121: 
<a name="1122"/> 1122:     %% Test 32-bit chunking 2^32 +- 1/2
<a name="1123"/> 1123:     L_32bits = [4.294967294, 4.294967295, 4.294967296, 4.294967297,
<a name="1124"/> 1124:                 4.294967298],
<a name="1125"/> 1125:     lists:foreach(fun(V) -&gt; g_t(V) end, L_32bits),
<a name="1126"/> 1126: 
<a name="1127"/> 1127:     %% Test 32-bit chunking 2^32 +- 1/2
<a name="1128"/> 1128:     L_32bits = [4.294967294, 4.294967295, 4.294967296, 4.294967297,
<a name="1129"/> 1129:                 4.294967298],
<a name="1130"/> 1130:     lists:foreach(fun(V) -&gt; g_t(V) end, L_32bits),
<a name="1131"/> 1131: 
<a name="1132"/> 1132:     L = [1.2e+1, 1.23e+2, 1.234e+3, 1.2345e+4, 1.23456e+5, 1.234567e+6,
<a name="1133"/> 1133:         1.2345678e+7, 1.23456789e+8, 1.23456789e+9, 1.234567895e+9,
<a name="1134"/> 1134:         1.2345678901e+10, 1.23456789012e+11, 1.234567890123e+12,
<a name="1135"/> 1135:         1.2345678901234e+13, 1.23456789012345e+14, 1.234567890123456e+15],
<a name="1136"/> 1136:     lists:foreach(fun(V) -&gt; g_t(V) end, L),
<a name="1137"/> 1137: 
<a name="1138"/> 1138:     %% power of 2
<a name="1139"/> 1139:     L_pow2 = [8.0, 64.0, 512.0, 8192.0, 65536.0, 524288.0, 8388608.0,
<a name="1140"/> 1140:              67108864.0, 536870912.0, 8589934592.0, 68719476736.0,
<a name="1141"/> 1141:              549755813888.0, 8796093022208.0, 70368744177664.0,
<a name="1142"/> 1142:              562949953421312.0, 9007199254740992.0],
<a name="1143"/> 1143:     lists:foreach(fun(V) -&gt; g_t(V) end, L_pow2),
<a name="1144"/> 1144: 
<a name="1145"/> 1145:     %% 1000 * power of 2
<a name="1146"/> 1146:     L_pow2_1000 = [8.0e+3, 64.0e+3, 512.0e+3, 8192.0e+3, 65536.0e+3,
<a name="1147"/> 1147:                   524288.0e+3, 8388608.0e+3, 67108864.0e+3, 536870912.0e+3,
<a name="1148"/> 1148:                   8589934592.0e+3, 68719476736.0e+3, 549755813888.0e+3,
<a name="1149"/> 1149:                   8796093022208.0e+3],
<a name="1150"/> 1150:     lists:foreach(fun(V) -&gt; g_t(V) end, L_pow2_1000),
<a name="1151"/> 1151: 
<a name="1152"/> 1152:     %% 10^15 + 10^i
<a name="1153"/> 1153:     L_pow10_plus = [1.0e+15 + 1.0e+0, 1.0e+15 + 1.0e+1, 1.0e+15 + 1.0e+2,
<a name="1154"/> 1154:                    1.0e+15 + 1.0e+3, 1.0e+15 + 1.0e+4, 1.0e+15 + 1.0e+5,
<a name="1155"/> 1155:                    1.0e+15 + 1.0e+6, 1.0e+15 + 1.0e+7, 1.0e+15 + 1.0e+8,
<a name="1156"/> 1156:                    1.0e+15 + 1.0e+9, 1.0e+15 + 1.0e+10, 1.0e+15 + 1.0e+11,
<a name="1157"/> 1157:                    1.0e+15 + 1.0e+12, 1.0e+15 + 1.0e+13, 1.0e+15 + 1.0e+14],
<a name="1158"/> 1158:     lists:foreach(fun(V) -&gt; g_t(V) end, L_pow10_plus),
<a name="1159"/> 1159: 
<a name="1160"/> 1160:     %% min and max
<a name="1161"/> 1161:     g_t(i_2_d(1)),
<a name="1162"/> 1162:     g_t(i_2_d(16#7fefffffffffffff)),
<a name="1163"/> 1163: 
<a name="1164"/> 1164:     %% lots of trailing zeroes
<a name="1165"/> 1165:     g_t(2.98023223876953125e-8),
<a name="1166"/> 1166: 
<a name="1167"/> 1167:     %% Switch to Subnormal
<a name="1168"/> 1168:     g_t(2.2250738585072014e-308),
<a name="1169"/> 1169: 
<a name="1170"/> 1170:     %% special case to check for the shift to the right by 128
<a name="1171"/> 1171:     L_shift = [parts_2_f(0, 4,0), parts_2_f(0, 6, (1 bsl 53) - 1),
<a name="1172"/> 1172:                parts_2_f(0, 41, 0), parts_2_f(0, 40, (1 bsl 53) - 1),
<a name="1173"/> 1173:                parts_2_f(0, 1077, 0), parts_2_f(0, 1076, (1 bsl 53) - 1),
<a name="1174"/> 1174:                parts_2_f(0, 307, 0), parts_2_f(0, 306, (1 bsl 53) - 1),
<a name="1175"/> 1175:                parts_2_f(0, 934, 16#000FA7161A4D6E0C)],
<a name="1176"/> 1176:     lists:foreach(fun(V) -&gt; g_t(V) end, L_shift),
<a name="1177"/> 1177: 
<a name="1178"/> 1178:     %% following test cases come from https://github.com/microsoft/STL/blob/f1515e04fd00876137e762c08b90d9aa450859e0/tests/std/tests/P0067R5_charconv/double_to_chars_test_cases.hpp
<a name="1179"/> 1179:     %% These numbers have odd mantissas (unaffected by shifting)
<a name="1180"/> 1180:     %% that are barely within the &quot;max shifted mantissa&quot; limit.
<a name="1181"/> 1181: 
<a name="1182"/> 1182:     L_mantissas_within_limit = [
<a name="1183"/> 1183:         1801439850948197.0e1, 360287970189639.0e2, 72057594037927.0e3,
<a name="1184"/> 1184:         14411518807585.0e4, 2882303761517.0e5, 576460752303.0e6,
<a name="1185"/> 1185:         115292150459.0e7, 23058430091.0e8, 4611686017.0e9, 922337203.0e10,
<a name="1186"/> 1186:         184467439.0e11, 36893487.0e12, 7378697.0e13, 1475739.0e14,
<a name="1187"/> 1187:         295147.0e15, 59029.0e16, 11805.0e17, 2361.0e18, 471.0e19, 93.0e20,
<a name="1188"/> 1188:         17.0e21, 3.0e22],
<a name="1189"/> 1189:     lists:foreach(fun(V) -&gt; g_t(V) end, L_mantissas_within_limit),
<a name="1190"/> 1190: 
<a name="1191"/> 1191:     %% These numbers have odd mantissas (unaffected by shifting)
<a name="1192"/> 1192:     %% that are barely above the &quot;max shifted mantissa&quot; limit.
<a name="1193"/> 1193:     L_mantissas_above_limit = [
<a name="1194"/> 1194:         1801439850948199.0e1, 360287970189641.0e2, 72057594037929.0e3,
<a name="1195"/> 1195:         14411518807587.0e4, 2882303761519.0e5, 576460752305.0e6,
<a name="1196"/> 1196:         115292150461.0e7, 23058430093.0e8, 4611686019.0e9, 922337205.0e10,
<a name="1197"/> 1197:         184467441.0e11, 36893489.0e12, 7378699.0e13, 1475741.0e14,
<a name="1198"/> 1198:         295149.0e15, 59031.0e16, 11807.0e17, 2363.0e18, 473.0e19, 95.0e20,
<a name="1199"/> 1199:         19.0e21, 5.0e22],
<a name="1200"/> 1200:     lists:foreach(fun(V) -&gt; g_t(V) end, L_mantissas_above_limit),
<a name="1201"/> 1201: 
<a name="1202"/> 1202:     L_switch = [1801439850948197.0e1, 360287970189639.0e2, 72057594037927.0e3,
<a name="1203"/> 1203:                 14411518807585.0e4, 2882303761517.0e5, 576460752303.0e6,
<a name="1204"/> 1204:                 115292150459.0e7, 23058430091.0e8, 4611686017.0e9,
<a name="1205"/> 1205:                 922337203.0e10, 184467439.0e11, 36893487.0e12, 7378697.0e13,
<a name="1206"/> 1206:                 1475739.0e14, 295147.0e15, 59029.0e16, 11805.0e17, 2361.0e18,
<a name="1207"/> 1207:                 471.0e19, 93.0e20, 17.0e21, 3.0e22, 1801439850948199.0e1,
<a name="1208"/> 1208:                 360287970189641.0e2, 72057594037929.0e3, 14411518807587.0e4,
<a name="1209"/> 1209:                 2882303761519.0e5, 576460752305.0e6, 115292150461.0e7,
<a name="1210"/> 1210:                 23058430093.0e8, 4611686019.0e9, 922337205.0e10,
<a name="1211"/> 1211:                 184467441.0e11, 36893489.0e12, 7378699.0e13, 1475741.0e14,
<a name="1212"/> 1212:                 295149.0e15, 59031.0e16, 11807.0e17, 2363.0e18, 473.0e19,
<a name="1213"/> 1213:                 95.0e20, 19.0e21, 5.0e22, 302230528.0e15, 302232576.0e15,
<a name="1214"/> 1214:                 81123342286848.0e18, 81192061763584.0e18],
<a name="1215"/> 1215:     lists:foreach(fun(V) -&gt; g_t(V) end, L_switch),
<a name="1216"/> 1216: 
<a name="1217"/> 1217:     L_edge = [123456789012345683968.0, 1.9156918820264798e-56,
<a name="1218"/> 1218:               6.6564021122018745e+264, 4.91e-6, 5.547e-6],
<a name="1219"/> 1219:     lists:foreach(fun(V) -&gt; g_t(V) end, L_edge),
<a name="1220"/> 1220: 
<a name="g_ryu-last_expr"/><a name="1221"/> 1221:     ok.
<a name="1222"/> 1222: 
<a name="i_2_d-1"/><a name="1223"/> 1223: <b>i_2_d</b>(Int) -&gt;
<a name="1224"/> 1224:     &lt;&lt;F:64/float&gt;&gt; = &lt;&lt;Int:64/unsigned-integer&gt;&gt;,
<a name="i_2_d-last_expr"/><a name="1225"/> 1225:     F.
<a name="1226"/> 1226: 
<a name="parts_2_f-3"/><a name="1227"/> 1227: <b>parts_2_f</b>(S, E, M) -&gt;
<a name="1228"/> 1228:     &lt;&lt;F:64/float&gt;&gt; = &lt;&lt;S:1, E:11, M:52&gt;&gt;,
<a name="parts_2_f-last_expr"/><a name="1229"/> 1229:     F.
<a name="1230"/> 1230: 
<a name="g_misc-0"/><a name="1231"/> 1231: <b>g_misc</b>() -&gt; 
<a name="1232"/> 1232:     L_0_308 = lists:seq(0, 308),
<a name="1233"/> 1233:     L_0_307 = lists:seq(0, 307),
<a name="1234"/> 1234: 
<a name="1235"/> 1235:     %% Faster:
<a name="1236"/> 1236:     L_1_9 = [1,5,9],
<a name="1237"/> 1237:     L_0_9 = [0,1,5,9],
<a name="1238"/> 1238: 
<a name="1239"/> 1239:     %% 1.0,10.0, ... 2.0,20.0, ... 9.0,90.0, ... -1,-10, ... -2.0,-20.0...
<a name="1240"/> 1240:     [g_t(S*T*pow10(N)) || S &lt;- [1.0, -1.0], T &lt;- L_1_9, N &lt;- L_0_307],
<a name="1241"/> 1241: 
<a name="1242"/> 1242:     %% 1.0,1.0/10,1.0/100,... 2.0,2.0/10,2.0/100, ... 9.0,9.0/10,9.0/100,
<a name="1243"/> 1243:     %% -1.0,-1.0/10,... -9.0,-9.0/10...
<a name="1244"/> 1244:     [g_t(S*T/pow10(N)) || S &lt;- [1.0, -1.0], T &lt;- L_1_9, N &lt;- L_0_308],
<a name="1245"/> 1245: 
<a name="1246"/> 1246:     %% 0.0,1.0,2.0,...,9.0, 0.0,10.0,20.0,...,90.0,...
<a name="1247"/> 1247:     %% 0.0,-1.0,-2.0,...,-9.0, 0.0,-10.0,-20.0,...,-90.0,...
<a name="1248"/> 1248:     [g_t(S*list_to_float([D+$0]++lists:duplicate(N, $0)++&quot;.0&quot;)) ||
<a name="1249"/> 1249:         S &lt;- [1.0,-1.0], N &lt;- lists:seq(0, 300), D &lt;- L_0_9],
<a name="1250"/> 1250: 
<a name="1251"/> 1251:     %% 0.0,0.1,0.2,...0,9, 0.0,0.01,0.02,...,0.09,
<a name="1252"/> 1252:     %% 0.0,-0.1,-0.2,...-0,9, 0.0,-0.01,-0.02,...,-0.09,
<a name="1253"/> 1253:     [g_t(S*list_to_float(&quot;0.&quot;++lists:duplicate(N, $0)++[D+$0])) ||
<a name="1254"/> 1254:         S &lt;- [1.0,-1.0], N &lt;- lists:seq(0, 300), D &lt;- L_0_9],
<a name="g_misc-last_expr"/><a name="1255"/> 1255:     ok.
<a name="1256"/> 1256: 
<a name="ft-1"/><a name="1257"/> 1257: <b>ft</b>({{S,E,M}, L, G}) -&gt;
<a name="1258"/> 1258:     ft({pack(S, E, M), L, G});
<a name="1259"/> 1259: <b>ft</b>({V, Less, Greater}) when is_float(V) -&gt;
<a name="1260"/> 1260:     _ = g_t(V),
<a name="1261"/> 1261:     ft(V, fun inc/1, Greater),
<a name="ft-last_expr"/><a name="1262"/> 1262: <b>    ft</b>(V, fun dec/1, Less).
<a name="1263"/> 1263: 
<a name="ft-3"/><a name="1264"/> 1264: <b>ft</b>(V0, F, I) when I &gt; 0, is_float(V0) -&gt;
<a name="1265"/> 1265:     V = F(V0),
<a name="1266"/> 1266:     _ = g_t(V),
<a name="1267"/> 1267:     ft(V, F, I - 1);
<a name="1268"/> 1268: <b>ft</b>(V, _F, 0) when is_float(V) -&gt;
<a name="ft-last_expr"/><a name="1269"/> 1269:     ok.
<a name="1270"/> 1270: 
<a name="g_t-1"/><a name="1271"/> 1271: <b>g_t</b>(V) when is_float(V) -&gt;
<a name="1272"/> 1272:     %% io:format(&quot;Testing ~.17g~n&quot;, [V]),
<a name="1273"/> 1273:     Io = io_lib:format(&quot;~p&quot;, [V]),
<a name="1274"/> 1274:     Sv = binary_to_list(iolist_to_binary(Io)),
<a name="1275"/> 1275:     ok = g_t(V, Sv),
<a name="g_t-last_expr"/><a name="1276"/> 1276:     Sv.
<a name="1277"/> 1277: 
<a name="1278"/> 1278: <i>%% -&gt; ok | THROW</i>
<a name="1279"/> 1279: 
<a name="1280"/> 1280: <i>%% Checks that Sv is the shortest, correctly rounded string that</i>
<a name="1281"/> 1281: <i>%% converts to V when read back with list_to_float/1.</i>
<a name="1282"/> 1282: <i>%% Note: in a few cases the least significant digit has been</i>
<a name="1283"/> 1283: <i>%% incremented by one, namely when the correctly rounded string</i>
<a name="1284"/> 1284: <i>%% converts to another floating point number.</i>
<a name="g_t-2"/><a name="1285"/> 1285: <b>g_t</b>(V, Sv) when V &gt; 0.0; V &lt; 0.0 -&gt;
<a name="1286"/> 1286:     try
<a name="1287"/> 1287:         g_t_1(V, Sv)
<a name="1288"/> 1288:     catch throw:Reason -&gt;
<a name="1289"/> 1289:         throw({Reason, V, Sv})
<a name="1290"/> 1290:     end;
<a name="1291"/> 1291: <b>g_t</b>(Zero, Format) -&gt;
<a name="g_t-last_expr"/><a name="1292"/> 1292:     case &lt;&lt;Zero/float&gt;&gt; of
<a name="1293"/> 1293:         &lt;&lt;1:1,_:63&gt;&gt; -&gt;
<a name="1294"/> 1294:             &quot;-0.0&quot; = Format,
<a name="1295"/> 1295:             ok;
<a name="1296"/> 1296:         &lt;&lt;0:1,_:63&gt;&gt; -&gt;
<a name="1297"/> 1297:             &quot;0.0&quot; = Format,
<a name="1298"/> 1298:             ok
<a name="1299"/> 1299:     end.
<a name="1300"/> 1300: 
<a name="g_t_1-2"/><a name="1301"/> 1301: <b>g_t_1</b>(V, Sv) -&gt;
<a name="1302"/> 1302:     %% Check that the least significant digit is correct.
<a name="1303"/> 1303:     %% If Sv is &quot;3.14&quot; then Sv- is &quot;3.13&quot; and Sv+ is &quot;3.15&quot;.
<a name="1304"/> 1304:     %% Check that |V - Sv| =&lt; (V - Sv-) and
<a name="1305"/> 1305:     %%       that |V - Sv| =&lt; (Sv+ - V)
<a name="1306"/> 1306:     Times = least_significant_digit(Sv),
<a name="1307"/> 1307:     case Times of
<a name="1308"/> 1308:         0 -&gt; throw(least_significant_digit_is_zero);
<a name="1309"/> 1309:         _ -&gt; ok
<a name="1310"/> 1310:     end,
<a name="1311"/> 1311:     S = if V &lt; 0 -&gt; -1; true -&gt; 1 end,
<a name="1312"/> 1312:     SvMinus = incr_lsd(Sv, -S),
<a name="1313"/> 1313:     SvPlus = incr_lsd(Sv, S),
<a name="1314"/> 1314:     Svr = s2r(Sv),
<a name="1315"/> 1315:     Svminusr = s2r(SvMinus),
<a name="1316"/> 1316:     Svplusr = s2r(SvPlus),
<a name="1317"/> 1317:     Vr = f2r(V),
<a name="1318"/> 1318: 
<a name="1319"/> 1319:     Abs_Sv_Vr = rat_abs(rat_minus(Svr, Vr)),
<a name="1320"/> 1320:     Svminus_Vr = rat_minus(Vr, Svminusr),
<a name="1321"/> 1321:     Svplus_Vr = rat_minus(Svplusr, Vr),
<a name="1322"/> 1322:     %% The are 45 (negative) floats where SvMinus (SvPlus) is closer
<a name="1323"/> 1323:     %% to V than Sv, but such that when reading SvMinus (SvPlus) wrong
<a name="1324"/> 1324:     %% float would be returned.
<a name="1325"/> 1325:     case rat_lte(Abs_Sv_Vr, Svminus_Vr) of
<a name="1326"/> 1326:         true -&gt; 
<a name="1327"/> 1327:             ok;
<a name="1328"/> 1328:         false -&gt;  
<a name="1329"/> 1329:              case list_to_float(SvMinus) of
<a name="1330"/> 1330:                  V -&gt; throw(vsminus_too_close_to_v);
<a name="1331"/> 1331:                  _Vminus -&gt; ok
<a name="1332"/> 1332:              end
<a name="1333"/> 1333:     end,
<a name="1334"/> 1334:     case rat_lte(Abs_Sv_Vr, Svplus_Vr) of
<a name="1335"/> 1335:         true -&gt; 
<a name="1336"/> 1336:             ok;
<a name="1337"/> 1337:         false -&gt;
<a name="1338"/> 1338:              case list_to_float(SvPlus) of
<a name="1339"/> 1339:                  V -&gt; throw(vsplus_too_close_to_v);
<a name="1340"/> 1340:                  _Vplus -&gt; ok
<a name="1341"/> 1341:              end
<a name="1342"/> 1342:     end,
<a name="1343"/> 1343: 
<a name="1344"/> 1344:     %% Check that Sv is closer to V than to V- and V+.
<a name="1345"/> 1345:     %% Check that |V - Sv| =&lt; (V - V-) and
<a name="1346"/> 1346:     %%       that |V - Sv| =&lt; (V+ - V)
<a name="1347"/> 1347:     %% (An alternative is  V- + V =&lt; 2*Sv =&lt; V + V+.)
<a name="1348"/> 1348:     case inc(V) of
<a name="1349"/> 1349:         inf -&gt; 
<a name="1350"/> 1350:             ok;
<a name="1351"/> 1351:         Vplus -&gt;
<a name="1352"/> 1352:             Vplusr = f2r(Vplus),
<a name="1353"/> 1353:             V_Vplusr = rat_minus(Vplusr, Vr),
<a name="1354"/> 1354:             case rat_lte(Abs_Sv_Vr, V_Vplusr) of
<a name="1355"/> 1355:                 true -&gt; ok;
<a name="1356"/> 1356:                 false -&gt; throw(vplus_too_close_to_sv)
<a name="1357"/> 1357:             end
<a name="1358"/> 1358:     end,
<a name="1359"/> 1359:     case dec(V) of
<a name="1360"/> 1360:         '-inf' -&gt;
<a name="1361"/> 1361:             ok;
<a name="1362"/> 1362:         Vminus -&gt;
<a name="1363"/> 1363:             Vminusr = f2r(Vminus),
<a name="1364"/> 1364:             V_Vminusr = rat_minus(Vr, Vminusr),
<a name="1365"/> 1365:             case rat_lte(Abs_Sv_Vr, V_Vminusr) of
<a name="1366"/> 1366:                 true -&gt; ok;
<a name="1367"/> 1367:                 false -&gt; throw(vminus_too_close_to_sv)
<a name="1368"/> 1368:             end
<a name="1369"/> 1369:     end,
<a name="1370"/> 1370: 
<a name="1371"/> 1371:     %% Check that no prefix of Sv yields V.
<a name="1372"/> 1372:     %% If Sv is &quot;3.14&quot; then Svlow is &quot;3.1&quot; and Svhigh is &quot;3.2&quot;.
<a name="1373"/> 1373:     %%
<a name="1374"/> 1374:     %% This is just one way of getting Svlow and Svhigh:
<a name="1375"/> 1375:     if
<a name="1376"/> 1376:         V &lt; 0 -&gt;
<a name="1377"/> 1377:             SvHigh = step_lsd(Sv, -Times),
<a name="1378"/> 1378:             SvLow = step_lsd(Sv, 10 - Times);
<a name="1379"/> 1379:         true -&gt;
<a name="1380"/> 1380:             SvHigh = step_lsd(Sv, 10 - Times),
<a name="1381"/> 1381:             SvLow = step_lsd(Sv, -Times)
<a name="1382"/> 1382:     end,
<a name="1383"/> 1383: 
<a name="1384"/> 1384:     case catch list_to_float(SvLow) of
<a name="1385"/> 1385:         V -&gt; throw(low_is_v);
<a name="1386"/> 1386:         _ -&gt; ok
<a name="1387"/> 1387:     end,
<a name="1388"/> 1388: 
<a name="1389"/> 1389:     case catch list_to_float(SvHigh) of
<a name="1390"/> 1390:         V -&gt; throw(high_is_v);
<a name="1391"/> 1391:         _ -&gt; ok
<a name="1392"/> 1392:     end,
<a name="1393"/> 1393: 
<a name="1394"/> 1394:     %% Check that Sv has enough digits.
<a name="1395"/> 1395:     case list_to_float(Sv) of
<a name="1396"/> 1396:         V -&gt; ok;
<a name="1397"/> 1397:         _ -&gt; throw(wrong_float) % cannot happen
<a name="1398"/> 1398:     end,
<a name="1399"/> 1399: 
<a name="1400"/> 1400:     g_choice(Sv),
<a name="1401"/> 1401: 
<a name="g_t_1-last_expr"/><a name="1402"/> 1402:     ok.
<a name="1403"/> 1403: 
<a name="1404"/> 1404: <i>%%% In &quot;123450000.0&quot;, '5' is the lsd; </i>
<a name="1405"/> 1405: <i>%%% in &quot;1234.0000&quot;, (the last) '0' is the lsd;</i>
<a name="1406"/> 1406: <i>%%% in &quot;1234.0&quot;, '4' is the lsd (the Erlang syntax requires the final zero).</i>
<a name="1407"/> 1407: 
<a name="1408"/> 1408: <i>%% Trailing zeroes are not significant (&quot;3.0&quot;, &quot;5.0e-324&quot;, &quot;232000.0&quot;).</i>
<a name="least_significant_digit-1"/><a name="1409"/> 1409: <b>least_significant_digit</b>(&quot;-&quot;++Ds) -&gt;
<a name="1410"/> 1410:     least_significant_digit(Ds);
<a name="1411"/> 1411: <b>least_significant_digit</b>(&quot;+&quot;++Ds) -&gt;
<a name="1412"/> 1412:     least_significant_digit(Ds);
<a name="1413"/> 1413: <b>least_significant_digit</b>(Ds) -&gt;
<a name="1414"/> 1414:     [MS|_E] = string:tokens(Ds, &quot;eE&quot;),
<a name="least_significant_digit-last_expr"/><a name="1415"/> 1415: <b>    lsd0</b>(lists:reverse(MS))-$0.
<a name="1416"/> 1416: 
<a name="lsd0-1"/><a name="1417"/> 1417: <b>lsd0</b>(&quot;0.&quot;++Ds) -&gt;
<a name="1418"/> 1418:     lsd1(Ds);
<a name="1419"/> 1419: <b>lsd0</b>([D | _Ds]) -&gt;
<a name="lsd0-last_expr"/><a name="1420"/> 1420:     D.
<a name="1421"/> 1421: 
<a name="lsd1-1"/><a name="1422"/> 1422: <b>lsd1</b>(&quot;0&quot;++Ds) -&gt;
<a name="1423"/> 1423:     lsd1(Ds);
<a name="1424"/> 1424: <b>lsd1</b>([D | _Ds]) -&gt;
<a name="lsd1-last_expr"/><a name="1425"/> 1425:     D.
<a name="1426"/> 1426: 
<a name="step_lsd-2"/><a name="1427"/> 1427: <b>step_lsd</b>(Ds, 0) -&gt;
<a name="1428"/> 1428:     Ds;
<a name="1429"/> 1429: <b>step_lsd</b>(Ds, N) when N &gt; 0 -&gt;
<a name="1430"/> 1430:     NDs = incr_lsd(Ds, 1),
<a name="1431"/> 1431:     step_lsd(NDs, N - 1);
<a name="1432"/> 1432: <b>step_lsd</b>(Ds, N) when N &lt; 0 -&gt;
<a name="1433"/> 1433:     NDs = incr_lsd(Ds, -1),
<a name="step_lsd-last_expr"/><a name="1434"/> 1434: <b>    step_lsd</b>(NDs, N + 1).
<a name="1435"/> 1435: 
<a name="1436"/> 1436: <i>%% Assumes Ds represents some other number than zero.</i>
<a name="1437"/> 1437: <i>%% Increments or decrements the least significant digit.</i>
<a name="incr_lsd-2"/><a name="1438"/> 1438: <b>incr_lsd</b>(&quot;-&quot;++Ds, I) -&gt;
<a name="1439"/> 1439:     &quot;-&quot;++incr_lsd(Ds, I);
<a name="1440"/> 1440: <b>incr_lsd</b>(Ds, I) when I =:= 1; I =:= -1 -&gt; 
<a name="1441"/> 1441:     [MS|E] = string:tokens(Ds, &quot;eE&quot;),
<a name="1442"/> 1442:     X = [&quot;e&quot; || true &lt;- [E =/= []]],
<a name="incr_lsd-last_expr"/><a name="1443"/> 1443: <b>    lists:flatten</b>([incr_lsd0(lists:reverse(MS), I, []), X, E]).
<a name="1444"/> 1444: 
<a name="incr_lsd0-3"/><a name="1445"/> 1445: <b>incr_lsd0</b>(&quot;0.&quot;++Ds, C, L) -&gt;
<a name="1446"/> 1446:     incr_lsd1(Ds, C, [$., $0 | L]);
<a name="1447"/> 1447: <b>incr_lsd0</b>(Ds, C, L) -&gt;
<a name="incr_lsd0-last_expr"/><a name="1448"/> 1448: <b>    incr_lsd2</b>(Ds, C, L).
<a name="1449"/> 1449: 
<a name="incr_lsd1-3"/><a name="1450"/> 1450: <b>incr_lsd1</b>(&quot;0&quot;++Ds, C, L) -&gt;
<a name="1451"/> 1451:     incr_lsd1(Ds, C, [$0 | L]);
<a name="1452"/> 1452: <b>incr_lsd1</b>(Ds, C, L) -&gt;
<a name="incr_lsd1-last_expr"/><a name="1453"/> 1453: <b>    incr_lsd2</b>(Ds, C, L).
<a name="1454"/> 1454: 
<a name="incr_lsd2-3"/><a name="1455"/> 1455: <b>incr_lsd2</b>([], C, L) -&gt;
<a name="1456"/> 1456:     [C + $0 | L];
<a name="1457"/> 1457: <b>incr_lsd2</b>(&quot;.&quot;++Ds, C, L) -&gt;
<a name="1458"/> 1458:     incr_lsd2(Ds, C, [$. | L]);
<a name="1459"/> 1459: <b>incr_lsd2</b>(&quot;9&quot;++Ds, 1=C, L) -&gt;
<a name="1460"/> 1460:     incr_lsd2(Ds, C, [$0 | L]);
<a name="1461"/> 1461: <b>incr_lsd2</b>(&quot;0&quot;++Ds, -1=C, L) -&gt;
<a name="1462"/> 1462:     incr_lsd2(Ds, C, [$9 | L]);
<a name="1463"/> 1463: <b>incr_lsd2</b>([D | Ds], C, L) -&gt;
<a name="incr_lsd2-last_expr"/><a name="1464"/> 1464: <b>    lists:reverse</b>(Ds, [D + C | L]).
<a name="1465"/> 1465: 
<a name="s2r-1"/><a name="1466"/> 1466: <b>s2r</b>(S) when is_list(S) -&gt;
<a name="s2r-last_expr"/><a name="1467"/> 1467: <b>    case string:tokens</b>(S, &quot;eE&quot;) of
<a name="1468"/> 1468:         [MS] -&gt;
<a name="1469"/> 1469:             s10(MS);
<a name="1470"/> 1470:         [MS, ES] -&gt;
<a name="1471"/> 1471:             Mr = s10(MS),
<a name="1472"/> 1472:             E = list_to_integer(ES),
<a name="1473"/> 1473:             if 
<a name="1474"/> 1474:                 E &lt; 0 -&gt;
<a name="1475"/> 1475:                     rat_multiply(Mr, {1,pow10(-E)});
<a name="1476"/> 1476:                 true -&gt;
<a name="1477"/> 1477:                     rat_multiply(Mr, {pow10(E), 1})
<a name="1478"/> 1478:             end
<a name="1479"/> 1479:     end.
<a name="1480"/> 1480: 
<a name="s10-1"/><a name="1481"/> 1481: <b>s10</b>(&quot;-&quot;++S) -&gt;
<a name="1482"/> 1482:     rat_multiply({-1,1},s10(S));
<a name="1483"/> 1483: <b>s10</b>(S) -&gt;
<a name="1484"/> 1484:     [AS, BS] = string:tokens(S, &quot;.&quot;),
<a name="1485"/> 1485:     Sc = length(BS),
<a name="1486"/> 1486:     A = list_to_integer(AS),
<a name="1487"/> 1487:     B = list_to_integer(BS),
<a name="1488"/> 1488:     F = pow10(Sc),
<a name="s10-last_expr"/><a name="1489"/> 1489: <b>    rat_multiply</b>({1,1}, {A*F + B, F}).
<a name="1490"/> 1490: 
<a name="pow10-1"/><a name="1491"/> 1491: <b>pow10</b>(X) -&gt;
<a name="pow10-last_expr"/><a name="1492"/> 1492: <b>    int_pow</b>(10, X).
<a name="1493"/> 1493: 
<a name="int_pow-2"/><a name="1494"/> 1494: <b>int_pow</b>(X, 0) when is_integer(X) -&gt;
<a name="1495"/> 1495:     1;
<a name="1496"/> 1496: <b>int_pow</b>(X, N) when is_integer(X), is_integer(N), N &gt; 0 -&gt;
<a name="int_pow-last_expr"/><a name="1497"/> 1497: <b>    int_pow</b>(X, N, 1).
<a name="1498"/> 1498: 
<a name="int_pow-3"/><a name="1499"/> 1499: <b>int_pow</b>(X, N, R) when N &lt; 2 -&gt;
<a name="1500"/> 1500:     R * X;
<a name="1501"/> 1501: <b>int_pow</b>(X, N, R) -&gt;
<a name="int_pow-last_expr"/><a name="1502"/> 1502: <b>    int_pow</b>(X * X, N bsr 1, case N band 1 of 1 -&gt; R * X; 0 -&gt; R end).
<a name="1503"/> 1503: 
<a name="dec-1"/><a name="1504"/> 1504: <b>dec</b>(F) when is_float(F) -&gt;
<a name="1505"/> 1505:     &lt;&lt;S:1, BE:11, M:52&gt;&gt; = &lt;&lt;F:64/float&gt;&gt;,
<a name="1506"/> 1506:     dec({S,BE,M});
<a name="1507"/> 1507: <b>dec</b>({1,2046,?ALL_ONES}) -&gt;
<a name="1508"/> 1508:     '-inf';
<a name="1509"/> 1509: <b>dec</b>({S,BE,M}) when 0 =&lt; S, S =&lt; 1,
<a name="1510"/> 1510:                    0 =&lt; BE, BE =&lt; 2046,
<a name="1511"/> 1511:                    0 =&lt; M, M =&lt; ?ALL_ONES -&gt;
<a name="1512"/> 1512:     {S1,BE1,M1} = dec1(S, BE, M),
<a name="1513"/> 1513:     &lt;&lt;F:64/float&gt;&gt; = &lt;&lt;S:1, BE:11, M:52&gt;&gt;,
<a name="1514"/> 1514:     &lt;&lt;F1:64/float&gt;&gt; = &lt;&lt;S1:1, BE1:11, M1:52&gt;&gt;,
<a name="1515"/> 1515:     true = F1 &lt; F,
<a name="dec-last_expr"/><a name="1516"/> 1516:     F1.
<a name="1517"/> 1517:     
<a name="1518"/> 1518: 
<a name="dec1-3"/><a name="1519"/> 1519: <b>dec1</b>(0, 0, 0) -&gt;
<a name="1520"/> 1520:     dec1(1, 0, 0);
<a name="1521"/> 1521: <b>dec1</b>(0, BE, 0) -&gt;
<a name="1522"/> 1522:     {0,BE-1,?ALL_ONES};
<a name="1523"/> 1523: <b>dec1</b>(0, BE, M) -&gt;
<a name="1524"/> 1524:     {0,BE,M-1};
<a name="1525"/> 1525: <b>dec1</b>(1, BE, ?ALL_ONES) -&gt;
<a name="1526"/> 1526:     {1,BE+1,0};
<a name="1527"/> 1527: <b>dec1</b>(1, BE, M) -&gt;
<a name="dec1-last_expr"/><a name="1528"/> 1528:     {1,BE,M+1}.
<a name="1529"/> 1529: 
<a name="inc-1"/><a name="1530"/> 1530: <b>inc</b>(F) when is_float(F) -&gt;
<a name="1531"/> 1531:     &lt;&lt;S:1, BE:11, M:52&gt;&gt; = &lt;&lt;F:64/float&gt;&gt;,
<a name="1532"/> 1532:     inc({S,BE,M});
<a name="1533"/> 1533: <b>inc</b>({0,2046,?ALL_ONES}) -&gt;
<a name="1534"/> 1534:     inf;
<a name="1535"/> 1535: <b>inc</b>({S,BE,M}) when 0 =&lt; S, S =&lt; 1,
<a name="1536"/> 1536:                    0 =&lt; BE, BE =&lt; 2046,
<a name="1537"/> 1537:                    0 =&lt; M, M =&lt; ?ALL_ONES -&gt;
<a name="1538"/> 1538:     {S1,BE1,M1} = inc1(S, BE, M),
<a name="1539"/> 1539:     &lt;&lt;F:64/float&gt;&gt; = &lt;&lt;S:1, BE:11, M:52&gt;&gt;,
<a name="1540"/> 1540:     &lt;&lt;F1:64/float&gt;&gt; = &lt;&lt;S1:1, BE1:11, M1:52&gt;&gt;,
<a name="1541"/> 1541:     true = F1 &gt; F,
<a name="inc-last_expr"/><a name="1542"/> 1542:     F1.
<a name="1543"/> 1543: 
<a name="inc1-3"/><a name="1544"/> 1544: <b>inc1</b>(0, BE, ?ALL_ONES) -&gt;
<a name="1545"/> 1545:     {0,BE+1,0};
<a name="1546"/> 1546: <b>inc1</b>(0, BE, M) -&gt;
<a name="1547"/> 1547:     {0,BE,M+1};
<a name="1548"/> 1548: <b>inc1</b>(1, 0, 0) -&gt;
<a name="1549"/> 1549:     inc1(0, 0, 0);
<a name="1550"/> 1550: <b>inc1</b>(1, BE, 0) -&gt;
<a name="1551"/> 1551:     {1,BE-1,?ALL_ONES};
<a name="1552"/> 1552: <b>inc1</b>(1, BE, M) -&gt;
<a name="inc1-last_expr"/><a name="1553"/> 1553:     {1,BE,M-1}.
<a name="1554"/> 1554: 
<a name="f2r-1"/><a name="1555"/> 1555: <b>f2r</b>(F) when is_float(F) -&gt;
<a name="1556"/> 1556:     &lt;&lt;S:1, BE:11, M:52&gt;&gt; = &lt;&lt;F:64/float&gt;&gt;,
<a name="1557"/> 1557:     f2r({S,BE,M});
<a name="1558"/> 1558: <b>f2r</b>({S,BE,M}) when 0 =&lt; S, S =&lt; 1,
<a name="1559"/> 1559:                    0 =&lt; BE, BE =&lt; 2046,
<a name="1560"/> 1560:                    0 =&lt; M, M =&lt; ?ALL_ONES -&gt;
<a name="1561"/> 1561:     Vr = {T,N} = f2r1(S, BE, M),
<a name="1562"/> 1562:     &lt;&lt;F:64/float&gt;&gt; = &lt;&lt;S:1, BE:11, M:52&gt;&gt;,
<a name="1563"/> 1563:     case catch T/N of
<a name="1564"/> 1564:         {'EXIT', _} -&gt; ok;
<a name="1565"/> 1565:         TN -&gt; true = F == TN
<a name="1566"/> 1566:     end,
<a name="f2r-last_expr"/><a name="1567"/> 1567:     Vr.
<a name="1568"/> 1568: 
<a name="f2r1-3"/><a name="1569"/> 1569: <b>f2r1</b>(S, 0, M) -&gt;
<a name="1570"/> 1570:     rat_multiply({sign(S),1}, {M, 1 bsl 1074});
<a name="1571"/> 1571: <b>f2r1</b>(S, BE, M) when BE - 1075 &gt;= 0 -&gt;
<a name="1572"/> 1572:     rat_multiply({sign(S),1}, {((1 bsl 52)+M) * (1 bsl (BE-1075)),1});
<a name="1573"/> 1573: <b>f2r1</b>(S, BE, M) -&gt;
<a name="f2r1-last_expr"/><a name="1574"/> 1574: <b>    rat_multiply</b>({sign(S),1}, {(1 bsl 52)+M, 1 bsl (1075-BE)}).
<a name="1575"/> 1575: 
<a name="sign-1"/><a name="1576"/> 1576: <b>sign</b>(0) -&gt;
<a name="1577"/> 1577:     1;
<a name="1578"/> 1578: <b>sign</b>(1) -&gt;
<a name="sign-last_expr"/><a name="1579"/> 1579:     -1.
<a name="1580"/> 1580: 
<a name="1581"/> 1581: <i>%%% Rational numbers (very scetchy).</i>
<a name="1582"/> 1582: 
<a name="rat_abs-1"/><a name="1583"/> 1583: <b>rat_abs</b>({A,B}) when A &lt; 0 -&gt;
<a name="1584"/> 1584:     {-A,B};
<a name="1585"/> 1585: <b>rat_abs</b>({A,B}) -&gt;
<a name="rat_abs-last_expr"/><a name="1586"/> 1586:     {A,B}.
<a name="1587"/> 1587: 
<a name="1588"/> 1588: <b>-ifdef</b>(not_used).
<a name="1589"/> 1589: rat_equal(R1, R2) -&gt;
<a name="1590"/> 1590:     R1 =:= R2.
<a name="1591"/> 1591: 
<a name="1592"/> 1592: rat_negate({A,B}) -&gt;
<a name="1593"/> 1593:     {-A,B}.
<a name="1594"/> 1594: 
<a name="1595"/> 1595: rat_divide({A,B},{C,D}) -&gt;
<a name="1596"/> 1596:     rat_multiply({A,B},{D,C}).
<a name="1597"/> 1597: -endif.
<a name="1598"/> 1598: 
<a name="rat_lte-2"/><a name="1599"/> 1599: <b>rat_lte</b>({A,B}, {C,D}) when B =/= 0, D =/= 0 -&gt;
<a name="rat_lte-last_expr"/><a name="1600"/> 1600:     A*D =&lt; C*B.
<a name="1601"/> 1601: 
<a name="rat_minus-2"/><a name="1602"/> 1602: <b>rat_minus</b>({A,B}, {C,D}) -&gt;
<a name="rat_minus-last_expr"/><a name="1603"/> 1603: <b>    rat_plus</b>({A,B}, {-C,D}).
<a name="1604"/> 1604: 
<a name="rat_plus-2"/><a name="1605"/> 1605: <b>rat_plus</b>({A,B}, {C,D})  when B =/= 0, D =/= 0 -&gt;
<a name="rat_plus-last_expr"/><a name="1606"/> 1606: <b>    rat_normalize</b>({A*D+B*C, B*D}).
<a name="1607"/> 1607: 
<a name="rat_multiply-2"/><a name="1608"/> 1608: <b>rat_multiply</b>({A,B}, {C,D})  when B =/= 0, D =/= 0 -&gt;
<a name="rat_multiply-last_expr"/><a name="1609"/> 1609: <b>    rat_normalize</b>({A * C, B * D}).
<a name="1610"/> 1610: 
<a name="rat_normalize-1"/><a name="1611"/> 1611: <b>rat_normalize</b>({T,N}) when N =/= 0 -&gt;
<a name="1612"/> 1612:     G = gcd(T, N),
<a name="1613"/> 1613:     T2 = T div G,
<a name="1614"/> 1614:     N2 = N div G,
<a name="rat_normalize-last_expr"/><a name="1615"/> 1615:     if
<a name="1616"/> 1616:         T2 &lt; 0 -&gt;
<a name="1617"/> 1617:             if 
<a name="1618"/> 1618:                 N2 &lt; 0 -&gt; {-T2,-N2};
<a name="1619"/> 1619:                 true -&gt; {T2,N2}
<a name="1620"/> 1620:             end;
<a name="1621"/> 1621:         true -&gt;
<a name="1622"/> 1622:             if 
<a name="1623"/> 1623:                 N2 &lt; 0 -&gt; {-T2,-N2};
<a name="1624"/> 1624:                 true -&gt; {T2,N2}
<a name="1625"/> 1625:             end
<a name="1626"/> 1626:     end.
<a name="1627"/> 1627: 
<a name="gcd-2"/><a name="1628"/> 1628: <b>gcd</b>(A, 0) -&gt; A;
<a name="gcd-last_expr"/><a name="1629"/> 1629: <b>gcd</b>(A, B) -&gt; gcd(B, A rem B).
<a name="1630"/> 1630: 
<a name="1631"/> 1631: <i>%%% End of rational numbers.</i>
<a name="1632"/> 1632: 
<a name="1633"/> 1633: <i>%% Check that there is an exponent if and only if characters are saved</i>
<a name="1634"/> 1634: <i>%% when abs(list_to_float(S)) &lt; float(1 bsl 53) and that there is an</i>
<a name="1635"/> 1635: <i>%% exponent when abs(list_to_float(S)) &gt;= float(1 bsl 53).</i>
<a name="g_choice-1"/><a name="1636"/> 1636: <b>g_choice</b>(S) when is_list(S) -&gt;
<a name="1637"/> 1637:     ShouldAlwaysHaveExponent = abs(list_to_float(S)) &gt;= float(1 bsl 53),
<a name="1638"/> 1638:     HasExponent = lists:member($e, S) orelse lists:member($E, S),
<a name="g_choice-last_expr"/><a name="1639"/> 1639:     case ShouldAlwaysHaveExponent of
<a name="1640"/> 1640:         true -&gt;
<a name="1641"/> 1641:             case HasExponent of
<a name="1642"/> 1642:                 true -&gt; ok;
<a name="1643"/> 1643:                 false -&gt; throw(should_have_exponent)
<a name="1644"/> 1644:             end;
<a name="1645"/> 1645:         false -&gt; g_choice_small(S)
<a name="1646"/> 1646:     end.
<a name="1647"/> 1647: 
<a name="1648"/> 1648: <i>%% Check that there is an exponent if and only if characters are</i>
<a name="1649"/> 1649: <i>%% saved. Note: this assumes floating point numbers &quot;Erlang style&quot;</i>
<a name="1650"/> 1650: <i>%% (with a single zero before and after the dot, and no extra leading</i>
<a name="1651"/> 1651: <i>%% zero in the exponent).</i>
<a name="g_choice_small-1"/><a name="1652"/> 1652: <b>g_choice_small</b>(S) when is_list(S) -&gt;
<a name="1653"/> 1653:     [MS | ES0] = string:tokens(S, &quot;eE&quot;),
<a name="1654"/> 1654:     [IS, FS] = string:tokens(MS, &quot;.&quot;),
<a name="1655"/> 1655:     Il = length(IS),
<a name="1656"/> 1656:     Fl = length(FS),
<a name="1657"/> 1657:     Pre = z(MS),
<a name="1658"/> 1658:     Post = z(lists:reverse(MS)),
<a name="1659"/> 1659:     ES = lists:append(ES0),
<a name="1660"/> 1660:     El = length(ES),
<a name="1661"/> 1661:     I = list_to_integer(IS),
<a name="g_choice_small-last_expr"/><a name="1662"/> 1662:     if
<a name="1663"/> 1663:         El =/= 0, I &gt; 9 orelse I &lt; -9 -&gt;
<a name="1664"/> 1664:             throw(too_many_digits_before_the_dot);
<a name="1665"/> 1665:         El =/= 0, I =:= 0 -&gt;
<a name="1666"/> 1666:             throw(zero_before_the_dot);
<a name="1667"/> 1667:         Pre =:= 0, Post &gt; 0,   El =:= 0 -&gt; % DDDD0000.0
<a name="1668"/> 1668:             Saving = if
<a name="1669"/> 1669:                          I &lt; 0, Il =:= Post + 2 -&gt;
<a name="1670"/> 1670:                              Post;
<a name="1671"/> 1671:                          I &gt; 0, Il =:= Post + 1 -&gt;
<a name="1672"/> 1672:                              Post;
<a name="1673"/> 1673:                          I =/= 0, true -&gt;
<a name="1674"/> 1674:                              Post + 1
<a name="1675"/> 1675:                      end,
<a name="1676"/> 1676:             Cost = 1 + length(integer_to_list(Il - 1)),
<a name="1677"/> 1677:             if
<a name="1678"/> 1678:                 Cost &lt; Saving -&gt;
<a name="1679"/> 1679:                     throw(with_exponent_is_shorter);
<a name="1680"/> 1680:                 true -&gt;
<a name="1681"/> 1681:                     ok
<a name="1682"/> 1682:             end;
<a name="1683"/> 1683:         Pre &gt; 0,   Post =:= 0, El =:= 0 -&gt; % 0.000DDDD
<a name="1684"/> 1684:             Saving = if
<a name="1685"/> 1685:                          Fl =:= Pre + 1 -&gt;
<a name="1686"/> 1686:                              Pre;
<a name="1687"/> 1687:                          true -&gt;
<a name="1688"/> 1688:                              Pre + 1
<a name="1689"/> 1689:                      end,
<a name="1690"/> 1690:             Cost = 2 + length(integer_to_list(Pre + 1)),
<a name="1691"/> 1691:             if
<a name="1692"/> 1692:                 Cost &lt; Saving -&gt;
<a name="1693"/> 1693:                     throw(with_exponent_is_shorter);
<a name="1694"/> 1694:                 true -&gt;
<a name="1695"/> 1695:                     ok
<a name="1696"/> 1696:             end;
<a name="1697"/> 1697:         Pre =:= 0, Post =:= 0, El &gt; 0 -&gt;   % D.DDDeDD
<a name="1698"/> 1698:             E = list_to_integer(ES),
<a name="1699"/> 1699:             if 
<a name="1700"/> 1700:                 E &gt;= 0 -&gt;
<a name="1701"/> 1701:                     Cost = E - (Fl - 1);
<a name="1702"/> 1702:                 E &lt; 0 -&gt;
<a name="1703"/> 1703:                     Cost = -E
<a name="1704"/> 1704:             end,
<a name="1705"/> 1705:             Saving = length(ES) + 1,
<a name="1706"/> 1706:             if
<a name="1707"/> 1707:                 Cost =:= Saving -&gt;
<a name="1708"/> 1708:                     throw(draw_but_choose_form_without_exponent);
<a name="1709"/> 1709:                 Cost &lt; Saving -&gt;
<a name="1710"/> 1710:                     throw(without_exponent_is_shorter);
<a name="1711"/> 1711:                 true -&gt;
<a name="1712"/> 1712:                     ok
<a name="1713"/> 1713:             end;
<a name="1714"/> 1714:         Pre =:= 0, Post =:= 0, El =:= 0 -&gt; % DDD.DDD
<a name="1715"/> 1715:             ok;
<a name="1716"/> 1716:         true -&gt;
<a name="1717"/> 1717:             throw(badly_formed_floating_point_string)
<a name="1718"/> 1718:     end.
<a name="1719"/> 1719: 
<a name="z-1"/><a name="1720"/> 1720: <b>z</b>(&quot;0.&quot;++Ds) -&gt;
<a name="1721"/> 1721:     length(lists:takewhile(fun(D) -&gt; D =:= $0 end, Ds));
<a name="1722"/> 1722: <b>z</b>(_Ds) -&gt;
<a name="z-last_expr"/><a name="1723"/> 1723:     0.
<a name="1724"/> 1724: 
<a name="pack-3"/><a name="1725"/> 1725: <b>pack</b>(Sign, Exp, Frac) -&gt;
<a name="1726"/> 1726:     &lt;&lt;Float:64/float&gt;&gt; = &lt;&lt;Sign:1, Exp:11, Frac:52&gt;&gt;,
<a name="pack-last_expr"/><a name="1727"/> 1727:     Float.
<a name="1728"/> 1728: 
<a name="1729"/> 1729: <i>%% Whitebox test of io_lib:collect_line/3.</i>
<a name="io_lib_collect_line_3_wb-1"/><a name="1730"/> 1730: <b>io_lib_collect_line_3_wb</b>(Config) when is_list(Config) -&gt;
<a name="1731"/> 1731:     do_collect_line(binary, &quot;\n&quot;),
<a name="1732"/> 1732:     do_collect_line(binary, &quot;\r\n&quot;),
<a name="1733"/> 1733:     do_collect_line(list, &quot;\n&quot;),
<a name="1734"/> 1734:     do_collect_line(list, &quot;\r\n&quot;),
<a name="io_lib_collect_line_3_wb-last_expr"/><a name="1735"/> 1735:     ok.
<a name="1736"/> 1736: 
<a name="do_collect_line-2"/><a name="1737"/> 1737: <b>do_collect_line</b>(Mode, Eol) -&gt;
<a name="1738"/> 1738:     First = &quot;abcde&quot;,
<a name="1739"/> 1739:     FirstNL = First++&quot;\n&quot;,
<a name="1740"/> 1740:     Second = &quot;unterminated line&quot;,
<a name="1741"/> 1741:     Data0 = First ++ Eol ++ Second,
<a name="1742"/> 1742:     {Data1,Result0} = do_collect_line_combine(Mode, Data0, FirstNL, Second),
<a name="1743"/> 1743:     do_collect_line_1(Mode, Data1, Result0, []),
<a name="1744"/> 1744: 
<a name="1745"/> 1745:     {Data,Result} = do_collect_line_combine(Mode, &quot;unterm&quot;, &quot;unterm&quot;, eof),
<a name="do_collect_line-last_expr"/><a name="1746"/> 1746: <b>    do_collect_line_1</b>(Mode, Data, Result, []).
<a name="1747"/> 1747: 
<a name="do_collect_line_combine-4"/><a name="1748"/> 1748: <b>do_collect_line_combine</b>(binary, Data0, FirstNL, eof) -&gt;
<a name="1749"/> 1749:     {list_to_binary(Data0),
<a name="1750"/> 1750:      {stop,list_to_binary(FirstNL),eof}};
<a name="1751"/> 1751: <b>do_collect_line_combine</b>(binary, Data0, FirstNL, Second) -&gt;
<a name="1752"/> 1752:     {list_to_binary(Data0),
<a name="1753"/> 1753:      {stop,list_to_binary(FirstNL),list_to_binary(Second)}};
<a name="1754"/> 1754: <b>do_collect_line_combine</b>(list, Data0, FirstNL, Second) -&gt;
<a name="do_collect_line_combine-last_expr"/><a name="1755"/> 1755:     {Data0,{stop,FirstNL,Second}}.
<a name="1756"/> 1756: 
<a name="do_collect_line_1-4"/><a name="1757"/> 1757: <b>do_collect_line_1</b>(Mode, [H|T], Result, Acc0) -&gt;
<a name="1758"/> 1758:     Acc = [H|Acc0],
<a name="1759"/> 1759:     Result = do_collect_line_2(lists:reverse(Acc), T),
<a name="1760"/> 1760:     do_collect_line_1(Mode, T, Result, Acc);
<a name="1761"/> 1761: <b>do_collect_line_1</b>(Mode, &lt;&lt;H,T/binary&gt;&gt;, Result, Acc0) -&gt;
<a name="1762"/> 1762:     Acc = [H|Acc0],
<a name="1763"/> 1763:     Result = do_collect_line_2(list_to_binary(lists:reverse(Acc)), T),
<a name="1764"/> 1764:     do_collect_line_1(Mode, T, Result, Acc);
<a name="1765"/> 1765: <b>do_collect_line_1</b>(_Mode, [], _Result, _Acc) -&gt;
<a name="1766"/> 1766:     ok;
<a name="1767"/> 1767: <b>do_collect_line_1</b>(_Mode, &lt;&lt;&gt;&gt;, _Result, _Acc) -&gt;
<a name="do_collect_line_1-last_expr"/><a name="1768"/> 1768:     ok.
<a name="1769"/> 1769: 
<a name="do_collect_line_2-2"/><a name="1770"/> 1770: <b>do_collect_line_2</b>(Part1, Part2) -&gt;
<a name="1771"/> 1771:     Dummy = make_ref(),
<a name="do_collect_line_2-last_expr"/><a name="1772"/> 1772: <b>    do_collect_line_3</b>(start, [Part1,Part2,eof], Dummy).
<a name="1773"/> 1773: 
<a name="do_collect_line_3-3"/><a name="1774"/> 1774: <b>do_collect_line_3</b>(State0, [H|T], Dummy) -&gt;
<a name="do_collect_line_3-last_expr"/><a name="1775"/> 1775: <b>    case io_lib:collect_line</b>(State0, H, Dummy) of
<a name="1776"/> 1776: 	{stop,Line,Rest} -&gt;
<a name="1777"/> 1777: 	    {stop,Line,do_collect_line_adjust_rest(Rest, T)};
<a name="1778"/> 1778: 	State -&gt;
<a name="1779"/> 1779: 	    do_collect_line_3(State, T, Dummy)
<a name="1780"/> 1780:     end.
<a name="1781"/> 1781: 
<a name="do_collect_line_adjust_rest-2"/><a name="1782"/> 1782: <b>do_collect_line_adjust_rest</b>(eof, []) -&gt; eof;
<a name="1783"/> 1783: <b>do_collect_line_adjust_rest</b>(eof, &lt;&lt;&gt;&gt;) -&gt; eof;
<a name="1784"/> 1784: <b>do_collect_line_adjust_rest</b>(Rest, [eof]) -&gt; Rest;
<a name="1785"/> 1785: <b>do_collect_line_adjust_rest</b>(Rest, [Bin|T]) when is_binary(Bin) -&gt;
<a name="1786"/> 1786:     do_collect_line_adjust_rest(&lt;&lt;Rest/binary,Bin/binary&gt;&gt;, T);
<a name="1787"/> 1787: <b>do_collect_line_adjust_rest</b>(Rest, [List|T]) when is_list(List) -&gt;
<a name="do_collect_line_adjust_rest-last_expr"/><a name="1788"/> 1788: <b>    do_collect_line_adjust_rest</b>(Rest++List, T).
<a name="1789"/> 1789: 
<a name="1790"/> 1790: 
<a name="1791"/> 1791: 
<a name="cr_whitespace_in_string-1"/><a name="1792"/> 1792: <b>cr_whitespace_in_string</b>(Config) when is_list(Config) -&gt;
<a name="cr_whitespace_in_string-last_expr"/><a name="1793"/> 1793: <b>    {ok,[&quot;abc&quot;],[]} = io_lib:fread</b>(&quot;~s&quot;, &quot;\rabc&quot;).
<a name="1794"/> 1794: 
<a name="1795"/> 1795: 
<a name="1796"/> 1796: 
<a name="io_fread_newlines-1"/><a name="1797"/> 1797: <b>io_fread_newlines</b>(Config) when is_list(Config) -&gt;
<a name="1798"/> 1798:     PrivDir = ?privdir(Config),
<a name="1799"/> 1799:     Fname = filename:join(PrivDir, &quot;io_fread_newlines.txt&quot;),
<a name="1800"/> 1800:     F0 = [[0,1,2,3,4,5,6,7,8,9]],
<a name="1801"/> 1801:     F1 = [[0,1,2,3,4,5,6,7,8],[9]],
<a name="1802"/> 1802:     F2 = [[0,1,2,3,4,5,6,7],[8,9]],
<a name="1803"/> 1803:     F3 = [[0,1,2,3,4,5,6],[7,8,9]],
<a name="1804"/> 1804:     F4 = [[0,1,2,3,4,5],[6,7,8,9]],
<a name="1805"/> 1805:     F5 = [[0,1,2,3,4],[5,6,7,8,9]],
<a name="1806"/> 1806:     F6 = [[0,1,2,3],[4,5,6,7],[8,9]],
<a name="1807"/> 1807:     F7 = [[0,1,2],[3,4,5],[6,7,8],[9]],
<a name="1808"/> 1808:     F8 = [[0,1],[2,3],[4,5],[6,7],[8,9]],
<a name="1809"/> 1809:     F9 = [[0],[1],[2],[3],[4],[5],[6],[7],[8],[9]],
<a name="1810"/> 1810:     Newlines = [&quot;\n&quot;, &quot;\r\n&quot;, &quot;\r&quot;],
<a name="io_fread_newlines-last_expr"/><a name="1811"/> 1811:     try
<a name="1812"/> 1812: 	io_fread_newlines_1([F0,F1,F2,F3,F4,F5,F6,F7,F8,F9],
<a name="1813"/> 1813: 				  Fname, Newlines)
<a name="1814"/> 1814:     after
<a name="1815"/> 1815: 	file:delete(Fname)
<a name="1816"/> 1816:     end.
<a name="1817"/> 1817: 
<a name="io_fread_newlines_1-3"/><a name="1818"/> 1818: <b>io_fread_newlines_1</b>(Fs, Fname, [Newline|Newlines]) -&gt;
<a name="1819"/> 1819:     ok = io_fread_newlines_2(Fs, Fname, Newline),
<a name="1820"/> 1820:     io_fread_newlines_1(Fs, Fname, Newlines);
<a name="io_fread_newlines_1-last_expr"/><a name="1821"/> 1821: <b>io_fread_newlines_1</b>(_, _, []) -&gt; ok.
<a name="1822"/> 1822: 
<a name="io_fread_newlines_2-3"/><a name="1823"/> 1823: <b>io_fread_newlines_2</b>([F|Fs], Fname, Newline) -&gt;
<a name="1824"/> 1824:     N1 = write_newlines_file(Fname, F, Newline),
<a name="1825"/> 1825:     {F2,N2} = read_newlines_file(Fname),
<a name="1826"/> 1826:     io:format(&quot;~w ~p ~w~n~n&quot;, [N1,F,N2]),
<a name="1827"/> 1827:     F2 = lists:flatten(F),
<a name="1828"/> 1828:     %% Intermediate newlines are not counted
<a name="1829"/> 1829:     N2 = N1 - (length(F) - 1)*length(Newline),
<a name="1830"/> 1830:     io_fread_newlines_2(Fs, Fname, Newline);
<a name="io_fread_newlines_2-last_expr"/><a name="1831"/> 1831: <b>io_fread_newlines_2</b>([], _, _) -&gt; ok.
<a name="1832"/> 1832: 
<a name="1833"/> 1833: 
<a name="write_newlines_file-3"/><a name="1834"/> 1834: <b>write_newlines_file</b>(Fname, F, Newline) -&gt;
<a name="1835"/> 1835:     Bytes = list_to_binary(digit_lines(F, Newline)),
<a name="1836"/> 1836:     io:format(&quot;Data: ~w~n~w~n&quot;, [Newline,Bytes]),
<a name="1837"/> 1837:     ok = file:write_file(Fname, Bytes),
<a name="write_newlines_file-last_expr"/><a name="1838"/> 1838: <b>    size</b>(Bytes).
<a name="1839"/> 1839: 
<a name="digit_lines-2"/><a name="1840"/> 1840: <b>digit_lines</b>([L], _) -&gt;
<a name="1841"/> 1841:     digit_line(L);
<a name="1842"/> 1842: <b>digit_lines</b>([L|Ls], Newline) -&gt;
<a name="digit_lines-last_expr"/><a name="1843"/> 1843: <b>    [digit_line</b>(L),Newline|digit_lines(Ls, Newline)].
<a name="1844"/> 1844: 
<a name="digit_line-1"/><a name="1845"/> 1845: <b>digit_line</b>([D]) -&gt;
<a name="1846"/> 1846:     integer_to_list(D);
<a name="1847"/> 1847: <b>digit_line</b>([D|Ds]) -&gt;
<a name="digit_line-last_expr"/><a name="1848"/> 1848: <b>    [integer_to_list</b>(D), &quot; &quot;, digit_line(Ds)].
<a name="1849"/> 1849: 
<a name="read_newlines_file-1"/><a name="1850"/> 1850: <b>read_newlines_file</b>(Fname) -&gt;
<a name="1851"/> 1851:     {ok,Fd} = file:open(Fname, [read]),
<a name="read_newlines_file-last_expr"/><a name="1852"/> 1852: <b>    try {L, N0} = R0 = read_newlines</b>(Fd, [], 0),
<a name="1853"/> 1853: 	case io:fread(Fd, &quot;&quot;, &quot;~*s~l&quot;) of
<a name="1854"/> 1854: 	    eof -&gt; R0;
<a name="1855"/> 1855: 	    {ok,[N]} -&gt; {L,N0+N}
<a name="1856"/> 1856: 	end
<a name="1857"/> 1857:     after
<a name="1858"/> 1858: 	file:close(Fd)
<a name="1859"/> 1859:     end.
<a name="1860"/> 1860:     
<a name="1861"/> 1861: 
<a name="read_newlines-3"/><a name="1862"/> 1862: <b>read_newlines</b>(Fd, Acc, N0) -&gt;
<a name="read_newlines-last_expr"/><a name="1863"/> 1863: <b>    case io:fread</b>(Fd, &quot;&quot;, &quot;~d~l&quot;) of
<a name="1864"/> 1864: 	{ok,[D,N]} -&gt;
<a name="1865"/> 1865: 	    read_newlines(Fd, [D|Acc], N0+N);
<a name="1866"/> 1866: 	eof -&gt;
<a name="1867"/> 1867: 	    {lists:reverse(Acc),N0}
<a name="1868"/> 1868:     end.
<a name="1869"/> 1869: 
<a name="1870"/> 1870: 
<a name="1871"/> 1871: 
<a name="1872"/> 1872: <i>%% OTP-8989 io:format for ~F.Ps ignores P in some cases.</i>
<a name="otp_8989-1"/><a name="1873"/> 1873: <b>otp_8989</b>(Suite) when is_list(Suite) -&gt;
<a name="1874"/> 1874:     Hello = &quot;Hello&quot;,
<a name="1875"/> 1875:     &quot; Hello&quot; = fmt(&quot;~6.6s&quot;, [Hello]),
<a name="1876"/> 1876:     &quot; Hello&quot; = fmt(&quot;~*.6s&quot;, [6,Hello]),
<a name="1877"/> 1877:     &quot; Hello&quot; = fmt(&quot;~6.*s&quot;, [6,Hello]),
<a name="1878"/> 1878:     &quot; Hello&quot; = fmt(&quot;~*.*s&quot;, [6,6,Hello]),
<a name="1879"/> 1879:     %%
<a name="1880"/> 1880:     &quot; Hello&quot; = fmt(&quot;~6.5s&quot;, [Hello]),
<a name="1881"/> 1881:     &quot; Hello&quot; = fmt(&quot;~*.5s&quot;, [6,Hello]),
<a name="1882"/> 1882:     &quot; Hello&quot; = fmt(&quot;~6.*s&quot;, [5,Hello]),
<a name="1883"/> 1883:     &quot; Hello&quot; = fmt(&quot;~*.*s&quot;, [6,5,Hello]),
<a name="1884"/> 1884:     %%
<a name="1885"/> 1885:     &quot;  Hell&quot; = fmt(&quot;~6.4s&quot;, [Hello]),
<a name="1886"/> 1886:     &quot;  Hell&quot; = fmt(&quot;~*.4s&quot;, [6,Hello]),
<a name="1887"/> 1887:     &quot;  Hell&quot; = fmt(&quot;~6.*s&quot;, [4,Hello]),
<a name="1888"/> 1888:     &quot;  Hell&quot; = fmt(&quot;~*.*s&quot;, [6,4,Hello]),
<a name="1889"/> 1889:     %%
<a name="1890"/> 1890:     &quot;Hello&quot; = fmt(&quot;~5.5s&quot;, [Hello]),
<a name="1891"/> 1891:     &quot;Hello&quot; = fmt(&quot;~*.5s&quot;, [5,Hello]),
<a name="1892"/> 1892:     &quot;Hello&quot; = fmt(&quot;~5.*s&quot;, [5,Hello]),
<a name="1893"/> 1893:     &quot;Hello&quot; = fmt(&quot;~*.*s&quot;, [5,5,Hello]),
<a name="1894"/> 1894:     %%
<a name="1895"/> 1895:     &quot; Hell&quot; = fmt(&quot;~5.4s&quot;, [Hello]),
<a name="1896"/> 1896:     &quot; Hell&quot; = fmt(&quot;~*.4s&quot;, [5,Hello]),
<a name="1897"/> 1897:     &quot; Hell&quot; = fmt(&quot;~5.*s&quot;, [4,Hello]),
<a name="1898"/> 1898:     &quot; Hell&quot; = fmt(&quot;~*.*s&quot;, [5,4,Hello]),
<a name="1899"/> 1899:     %%
<a name="1900"/> 1900:     &quot;Hell&quot; = fmt(&quot;~4.4s&quot;, [Hello]),
<a name="1901"/> 1901:     &quot;Hell&quot; = fmt(&quot;~*.4s&quot;, [4,Hello]),
<a name="1902"/> 1902:     &quot;Hell&quot; = fmt(&quot;~4.*s&quot;, [4,Hello]),
<a name="1903"/> 1903:     &quot;Hell&quot; = fmt(&quot;~*.*s&quot;, [4,4,Hello]),
<a name="1904"/> 1904:     %%
<a name="1905"/> 1905:     &quot; Hel&quot; = fmt(&quot;~4.3s&quot;, [Hello]),
<a name="1906"/> 1906:     &quot; Hel&quot; = fmt(&quot;~*.3s&quot;, [4,Hello]),
<a name="1907"/> 1907:     &quot; Hel&quot; = fmt(&quot;~4.*s&quot;, [3,Hello]),
<a name="1908"/> 1908:     &quot; Hel&quot; = fmt(&quot;~*.*s&quot;, [4,3,Hello]),
<a name="1909"/> 1909:     %%
<a name="1910"/> 1910:     %%
<a name="1911"/> 1911:     &quot;Hello &quot; = fmt(&quot;~-6.6s&quot;, [Hello]),
<a name="1912"/> 1912:     &quot;Hello &quot; = fmt(&quot;~*.6s&quot;, [-6,Hello]),
<a name="1913"/> 1913:     &quot;Hello &quot; = fmt(&quot;~-6.*s&quot;, [6,Hello]),
<a name="1914"/> 1914:     &quot;Hello &quot; = fmt(&quot;~*.*s&quot;, [-6,6,Hello]),
<a name="1915"/> 1915:     %%
<a name="1916"/> 1916:     &quot;Hello &quot; = fmt(&quot;~-6.5s&quot;, [Hello]),
<a name="1917"/> 1917:     &quot;Hello &quot; = fmt(&quot;~*.5s&quot;, [-6,Hello]),
<a name="1918"/> 1918:     &quot;Hello &quot; = fmt(&quot;~-6.*s&quot;, [5,Hello]),
<a name="1919"/> 1919:     &quot;Hello &quot; = fmt(&quot;~*.*s&quot;, [-6,5,Hello]),
<a name="1920"/> 1920:     %%
<a name="1921"/> 1921:     &quot;Hell  &quot; = fmt(&quot;~-6.4s&quot;, [Hello]),
<a name="1922"/> 1922:     &quot;Hell  &quot; = fmt(&quot;~*.4s&quot;, [-6,Hello]),
<a name="1923"/> 1923:     &quot;Hell  &quot; = fmt(&quot;~-6.*s&quot;, [4,Hello]),
<a name="1924"/> 1924:     &quot;Hell  &quot; = fmt(&quot;~*.*s&quot;, [-6,4,Hello]),
<a name="1925"/> 1925:     %%
<a name="1926"/> 1926:     &quot;Hello&quot; = fmt(&quot;~-5.5s&quot;, [Hello]),
<a name="1927"/> 1927:     &quot;Hello&quot; = fmt(&quot;~*.5s&quot;, [-5,Hello]),
<a name="1928"/> 1928:     &quot;Hello&quot; = fmt(&quot;~-5.*s&quot;, [5,Hello]),
<a name="1929"/> 1929:     &quot;Hello&quot; = fmt(&quot;~*.*s&quot;, [-5,5,Hello]),
<a name="1930"/> 1930:     %%
<a name="1931"/> 1931:     &quot;Hell &quot; = fmt(&quot;~-5.4s&quot;, [Hello]),
<a name="1932"/> 1932:     &quot;Hell &quot; = fmt(&quot;~*.4s&quot;, [-5,Hello]),
<a name="1933"/> 1933:     &quot;Hell &quot; = fmt(&quot;~-5.*s&quot;, [4,Hello]),
<a name="1934"/> 1934:     &quot;Hell &quot; = fmt(&quot;~*.*s&quot;, [-5,4,Hello]),
<a name="1935"/> 1935:     %%
<a name="1936"/> 1936:     &quot;Hell&quot; = fmt(&quot;~-4.4s&quot;, [Hello]),
<a name="1937"/> 1937:     &quot;Hell&quot; = fmt(&quot;~*.4s&quot;, [-4,Hello]),
<a name="1938"/> 1938:     &quot;Hell&quot; = fmt(&quot;~-4.*s&quot;, [4,Hello]),
<a name="1939"/> 1939:     &quot;Hell&quot; = fmt(&quot;~*.*s&quot;, [-4,4,Hello]),
<a name="1940"/> 1940:     %%
<a name="1941"/> 1941:     &quot;Hel &quot; = fmt(&quot;~-4.3s&quot;, [Hello]),
<a name="1942"/> 1942:     &quot;Hel &quot; = fmt(&quot;~*.3s&quot;, [-4,Hello]),
<a name="1943"/> 1943:     &quot;Hel &quot; = fmt(&quot;~-4.*s&quot;, [3,Hello]),
<a name="1944"/> 1944:     &quot;Hel &quot; = fmt(&quot;~*.*s&quot;, [-4,3,Hello]),
<a name="otp_8989-last_expr"/><a name="1945"/> 1945:     ok.
<a name="1946"/> 1946: 
<a name="1947"/> 1947: <i>%% OTP-9439 io_lib:fread bug for literate at end.</i>
<a name="io_lib_fread_literal-1"/><a name="1948"/> 1948: <b>io_lib_fread_literal</b>(Suite) when is_list(Suite) -&gt;
<a name="1949"/> 1949:     {more,&quot;~d&quot;,0,&quot;&quot;} = io_lib:fread(&quot;~d&quot;, &quot;&quot;),
<a name="1950"/> 1950:     {error,{fread,integer}} = io_lib:fread(&quot;~d&quot;, &quot; &quot;),
<a name="1951"/> 1951:     {more,&quot;~d&quot;,1,&quot;&quot;} = io_lib:fread(&quot; ~d&quot;, &quot; &quot;),
<a name="1952"/> 1952:     {ok,[17],&quot;X&quot;} = io_lib:fread(&quot; ~d&quot;, &quot; 17X&quot;),
<a name="1953"/> 1953:     %%
<a name="1954"/> 1954:     {more,&quot;d&quot;,0,&quot;&quot;} = io_lib:fread(&quot;d&quot;, &quot;&quot;),
<a name="1955"/> 1955:     {error,{fread,input}} = io_lib:fread(&quot;d&quot;, &quot; &quot;),
<a name="1956"/> 1956:     {more,&quot;d&quot;,1,&quot;&quot;} = io_lib:fread(&quot; d&quot;, &quot; &quot;),
<a name="1957"/> 1957:     {ok,[],&quot;X&quot;} = io_lib:fread(&quot; d&quot;, &quot; dX&quot;),
<a name="1958"/> 1958:     %%
<a name="1959"/> 1959:     {done,eof,_} = io_lib:fread([], eof, &quot;~d&quot;),
<a name="1960"/> 1960:     {done,eof,_} = io_lib:fread([], eof, &quot; ~d&quot;),
<a name="1961"/> 1961:     {more,C1} = io_lib:fread([], &quot; \n&quot;, &quot; ~d&quot;),
<a name="1962"/> 1962:     {done,{error,{fread,input}},_} = io_lib:fread(C1, eof, &quot; ~d&quot;),
<a name="1963"/> 1963:     {done,{ok,[18]},&quot;&quot;} = io_lib:fread(C1, &quot;18\n&quot;, &quot; ~d&quot;),
<a name="1964"/> 1964:     %%
<a name="1965"/> 1965:     {done,eof,_} = io_lib:fread([], eof, &quot;d&quot;),
<a name="1966"/> 1966:     {done,eof,_} = io_lib:fread([], eof, &quot; d&quot;),
<a name="1967"/> 1967:     {more,C2} = io_lib:fread([], &quot; \n&quot;, &quot; d&quot;),
<a name="1968"/> 1968:     {done,{error,{fread,input}},_} = io_lib:fread(C2, eof, &quot; d&quot;),
<a name="1969"/> 1969:     {done,{ok,[]},[]} = io_lib:fread(C2, &quot;d\n&quot;, &quot; d&quot;),
<a name="io_lib_fread_literal-last_expr"/><a name="1970"/> 1970:     ok.
<a name="1971"/> 1971: 
<a name="1972"/> 1972: 
<a name="1973"/> 1973: <i>%% Check that the printable range set by the user actually works.</i>
<a name="printable_range-1"/><a name="1974"/> 1974: <b>printable_range</b>(Suite) when is_list(Suite) -&gt;
<a name="1975"/> 1975:     {ok, UPeer0, UNode0} = ?CT_PEER([&quot;+pc&quot;, &quot;unicode&quot;]),
<a name="1976"/> 1976:     {ok, LPeer0, LNode0} = ?CT_PEER([&quot;+pc&quot;, &quot;latin1&quot;]),
<a name="1977"/> 1977:     {ok, DPeer, DNode} = ?CT_PEER(),
<a name="1978"/> 1978:     unicode = rpc:call(UNode0,io,printable_range,[]),
<a name="1979"/> 1979:     latin1 = rpc:call(LNode0,io,printable_range,[]),
<a name="1980"/> 1980:     latin1 = rpc:call(DNode,io,printable_range,[]),
<a name="1981"/> 1981:     peer:stop(UPeer0),
<a name="1982"/> 1982:     peer:stop(LPeer0),
<a name="1983"/> 1983:     {ok, UPeer, UNode} = ?CT_PEER([&quot;+pcunicode&quot;]),
<a name="1984"/> 1984:     {ok, LPeer, LNode} = ?CT_PEER([&quot;+pclatin1&quot;]),
<a name="1985"/> 1985:     unicode = rpc:call(UNode,io,printable_range,[]),
<a name="1986"/> 1986:     latin1 = rpc:call(LNode,io,printable_range,[]),
<a name="1987"/> 1987:     PrettyOptions = [{column,1},
<a name="1988"/> 1988: 		     {line_length,109},
<a name="1989"/> 1989: 		     {depth,30},
<a name="1990"/> 1990: 		     {line_max_chars,60},
<a name="1991"/> 1991: 		     {record_print_fun,
<a name="1992"/> 1992: 		      fun(_,_) -&gt; no end},
<a name="1993"/> 1993: 		     {encoding,unicode}],
<a name="1994"/> 1994:     PrintableControls = &quot;\t\v\b\f\e\r\n&quot;,
<a name="1995"/> 1995: 
<a name="1996"/> 1996:     1025 = print_max(UNode, [{hello, [1024,1025]},
<a name="1997"/> 1997: 			     PrettyOptions]),
<a name="1998"/> 1998:     125 = print_max(LNode,  [{hello, [1024,1025]},
<a name="1999"/> 1999: 			     PrettyOptions]),
<a name="2000"/> 2000:     125 = print_max(DNode,  [{hello, [1024,1025]},
<a name="2001"/> 2001: 			     PrettyOptions]),
<a name="2002"/> 2002:     1025 = print_max(UNode, [{hello, &lt;&lt;1024/utf8,1025/utf8&gt;&gt;},
<a name="2003"/> 2003: 			     PrettyOptions]),
<a name="2004"/> 2004:     125 = print_max(LNode,  [{hello, &lt;&lt;1024/utf8,1025/utf8&gt;&gt;},
<a name="2005"/> 2005: 			     PrettyOptions]),
<a name="2006"/> 2006:     125 = print_max(DNode,  [{hello, &lt;&lt;1024/utf8,1025/utf8&gt;&gt;},
<a name="2007"/> 2007: 			     PrettyOptions]),
<a name="2008"/> 2008:     $v = print_max(UNode, [PrintableControls,PrettyOptions]),
<a name="2009"/> 2009:     $v = print_max(LNode, [PrintableControls,PrettyOptions]),
<a name="2010"/> 2010:     $v = print_max(DNode, [PrintableControls,PrettyOptions]),
<a name="2011"/> 2011:     16#10FFFF = print_max(UNode,
<a name="2012"/> 2012: 			  [&lt;&lt;16#10FFFF/utf8,&quot;\t\v\b\f\e\r\n&quot;&gt;&gt;,
<a name="2013"/> 2013: 			   PrettyOptions]),
<a name="2014"/> 2014:     $&gt; = print_max(LNode,
<a name="2015"/> 2015: 		   [&lt;&lt;16#10FFFF/utf8,&quot;\t\v\b\f\e\r\n&quot;&gt;&gt;,
<a name="2016"/> 2016: 		    PrettyOptions]),
<a name="2017"/> 2017:     $&gt; = print_max(DNode,
<a name="2018"/> 2018: 		   [&lt;&lt;16#10FFFF/utf8,&quot;\t\v\b\f\e\r\n&quot;&gt;&gt;,
<a name="2019"/> 2019: 		    PrettyOptions]),
<a name="2020"/> 2020:     
<a name="2021"/> 2021:     1025 = format_max(UNode, [&quot;~tp&quot;, [{hello, [1024,1025]}]]),
<a name="2022"/> 2022:     125 = format_max(LNode,  [&quot;~tp&quot;, [{hello, [1024,1025]}]]),
<a name="2023"/> 2023:     125 = format_max(DNode,  [&quot;~tp&quot;, [{hello, [1024,1025]}]]),
<a name="2024"/> 2024:     1025 = format_max(UNode, [&quot;~tp&quot;, [{hello, &lt;&lt;1024/utf8,1025/utf8&gt;&gt;}]]),
<a name="2025"/> 2025:     125 = format_max(LNode,  [&quot;~tp&quot;, [{hello, &lt;&lt;1024/utf8,1025/utf8&gt;&gt;}]]),
<a name="2026"/> 2026:     125 = format_max(DNode,  [&quot;~tp&quot;, [{hello, &lt;&lt;1024/utf8,1025/utf8&gt;&gt;}]]),
<a name="2027"/> 2027: 
<a name="2028"/> 2028:     $\e = format_max(UNode, [&quot;~ts&quot;, [PrintableControls]]),
<a name="2029"/> 2029:     $\e = format_max(LNode, [&quot;~ts&quot;, [PrintableControls]]),
<a name="2030"/> 2030:     $\e = format_max(DNode, [&quot;~ts&quot;, [PrintableControls]]),
<a name="2031"/> 2031: 
<a name="2032"/> 2032:     peer:stop(UPeer),
<a name="2033"/> 2033:     peer:stop(LPeer),
<a name="2034"/> 2034:     peer:stop(DPeer),
<a name="printable_range-last_expr"/><a name="2035"/> 2035:     ok.
<a name="2036"/> 2036: 
<a name="print_max-2"/><a name="2037"/> 2037: <b>print_max</b>(Node, Args) -&gt;
<a name="print_max-last_expr"/><a name="2038"/> 2038: <b>    rpc_call_max</b>(Node, io_lib_pretty, print, Args).
<a name="2039"/> 2039: 
<a name="format_max-2"/><a name="2040"/> 2040: <b>format_max</b>(Node, Args) -&gt;
<a name="format_max-last_expr"/><a name="2041"/> 2041: <b>    rpc_call_max</b>(Node, io_lib, format, Args).
<a name="2042"/> 2042: 
<a name="rpc_call_max-4"/><a name="2043"/> 2043: <b>rpc_call_max</b>(Node, M, F, Args) -&gt;
<a name="rpc_call_max-last_expr"/><a name="2044"/> 2044: <b>    lists:max</b>(lists:flatten(rpc:call(Node, M, F, Args))).
<a name="2045"/> 2045: 
<a name="2046"/> 2046: <i>%% Make sure that a bad specification for a printable range is rejected.</i>
<a name="bad_printable_range-1"/><a name="2047"/> 2047: <b>bad_printable_range</b>(Config) when is_list(Config) -&gt;
<a name="2048"/> 2048:     Cmd = ct:get_progname() ++ &quot; +pcunnnnnicode -run erlang halt&quot;,
<a name="2049"/> 2049:     P = open_port({spawn, Cmd}, [stderr_to_stdout, {line, 200}]),
<a name="2050"/> 2050:     ok = receive
<a name="2051"/> 2051:              {P, {data, {eol , &quot;bad range of printable characters&quot; ++ _}}} -&gt;
<a name="2052"/> 2052:                  ok;
<a name="2053"/> 2053:              Other -&gt;
<a name="2054"/> 2054:                  Other
<a name="2055"/> 2055:          %% valgrind needs a lot of time
<a name="2056"/> 2056:          after 6000 -&gt;
<a name="2057"/> 2057:                    timeout
<a name="2058"/> 2058:          end,
<a name="2059"/> 2059:     catch port_close(P),
<a name="2060"/> 2060:     flush_from_port(P),
<a name="bad_printable_range-last_expr"/><a name="2061"/> 2061:     ok.
<a name="2062"/> 2062: 
<a name="flush_from_port-1"/><a name="2063"/> 2063: <b>flush_from_port</b>(P) -&gt;
<a name="flush_from_port-last_expr"/><a name="2064"/> 2064:     receive {P, _} -&gt;
<a name="2065"/> 2065: 	    flush_from_port(P)
<a name="2066"/> 2066:     after 0 -&gt;
<a name="2067"/> 2067: 	    ok
<a name="2068"/> 2068:     end.
<a name="2069"/> 2069: 
<a name="2070"/> 2070: <i>%% Test binaries printed with a depth of one behave correctly.</i>
<a name="io_lib_print_binary_depth_one-1"/><a name="2071"/> 2071: <b>io_lib_print_binary_depth_one</b>(Suite) when is_list(Suite) -&gt;
<a name="2072"/> 2072:     &quot;&lt;&lt;&gt;&gt;&quot; = fmt(&quot;~W&quot;, [&lt;&lt;&gt;&gt;, 1]),
<a name="2073"/> 2073:     &quot;&lt;&lt;&gt;&gt;&quot; = fmt(&quot;~P&quot;, [&lt;&lt;&gt;&gt;, 1]),
<a name="2074"/> 2074:     &quot;&lt;&lt;...&gt;&gt;&quot; = fmt(&quot;~W&quot;, [&lt;&lt;1&gt;&gt;, 1]),
<a name="2075"/> 2075:     &quot;&lt;&lt;...&gt;&gt;&quot; = fmt(&quot;~P&quot;, [&lt;&lt;1&gt;&gt;, 1]),
<a name="2076"/> 2076:     &quot;&lt;&lt;...&gt;&gt;&quot; = fmt(&quot;~W&quot;, [&lt;&lt;1:7&gt;&gt;, 1]),
<a name="2077"/> 2077:     &quot;&lt;&lt;...&gt;&gt;&quot; = fmt(&quot;~P&quot;, [&lt;&lt;1:7&gt;&gt;, 1]),
<a name="io_lib_print_binary_depth_one-last_expr"/><a name="2078"/> 2078:     ok.
<a name="2079"/> 2079: 
<a name="2080"/> 2080: <i>%% OTP-10302. Unicode.</i>
<a name="otp_10302-1"/><a name="2081"/> 2081: <b>otp_10302</b>(Suite) when is_list(Suite) -&gt;
<a name="2082"/> 2082:     {ok, UPeer, UNode} = ?CT_PEER([&quot;+pc&quot;, &quot;unicode&quot;]),
<a name="2083"/> 2083:     {ok, LPeer, LNode} = ?CT_PEER([&quot;+pc&quot;, &quot;latin1&quot;]),
<a name="2084"/> 2084:     &quot;\&quot;\x{400}\&quot;&quot; = rpc:call(UNode,?MODULE,pretty,[&quot;\x{400}&quot;, -1]),
<a name="2085"/> 2085:     &quot;&lt;&lt;\&quot;\x{400}\&quot;/utf8&gt;&gt;&quot; = rpc:call(UNode,?MODULE,pretty,
<a name="2086"/> 2086: 				      [&lt;&lt;&quot;\x{400}&quot;/utf8&gt;&gt;, -1]),
<a name="2087"/> 2087: 
<a name="2088"/> 2088:     &quot;&lt;&lt;\&quot;\x{400}foo\&quot;/utf8&gt;&gt;&quot; = rpc:call(UNode,?MODULE,pretty,
<a name="2089"/> 2089: 					 [&lt;&lt;&quot;\x{400}foo&quot;/utf8&gt;&gt;, 2]),
<a name="2090"/> 2090:     &quot;[1024]&quot; = rpc:call(LNode,?MODULE,pretty,[&quot;\x{400}&quot;, -1]),
<a name="2091"/> 2091:     &quot;&lt;&lt;208,128&gt;&gt;&quot; = rpc:call(LNode,?MODULE,pretty,[&lt;&lt;&quot;\x{400}&quot;/utf8&gt;&gt;, -1]),
<a name="2092"/> 2092: 
<a name="2093"/> 2093:     &quot;&lt;&lt;208,...&gt;&gt;&quot; = rpc:call(LNode,?MODULE,pretty,[&lt;&lt;&quot;\x{400}foo&quot;/utf8&gt;&gt;, 2]),
<a name="2094"/> 2094:     peer:stop(UPeer),
<a name="2095"/> 2095:     peer:stop(LPeer),
<a name="2096"/> 2096: 
<a name="2097"/> 2097:     &quot;&lt;&lt;\&quot;äppl\&quot;/utf8&gt;&gt;&quot; = pretty(&lt;&lt;&quot;äppl&quot;/utf8&gt;&gt;, 2),
<a name="2098"/> 2098:     &quot;&lt;&lt;\&quot;äppl\&quot;/utf8...&gt;&gt;&quot; = pretty(&lt;&lt;&quot;äpple&quot;/utf8&gt;&gt;, 2),
<a name="2099"/> 2099:     &quot;&lt;&lt;\&quot;apel\&quot;&gt;&gt;&quot; = pretty(&lt;&lt;&quot;apel&quot;&gt;&gt;, 2),
<a name="2100"/> 2100:     &quot;&lt;&lt;\&quot;apel\&quot;...&gt;&gt;&quot; = pretty(&lt;&lt;&quot;apelsin&quot;&gt;&gt;, 2),
<a name="2101"/> 2101:     &quot;&lt;&lt;\&quot;äppl\&quot;&gt;&gt;&quot; = fmt(&quot;~tp&quot;, [&lt;&lt;&quot;äppl&quot;&gt;&gt;]),
<a name="2102"/> 2102:     &quot;&lt;&lt;\&quot;äppl\&quot;...&gt;&gt;&quot; = fmt(&quot;~tP&quot;, [&lt;&lt;&quot;äpple&quot;&gt;&gt;, 2]),
<a name="2103"/> 2103:     &quot;&lt;&lt;0,0,0,0,0,0,1,0&gt;&gt;&quot; = fmt(&quot;~p&quot;, [&lt;&lt;256:64/unsigned-integer&gt;&gt;]),
<a name="2104"/> 2104:     &quot;&lt;&lt;0,0,0,0,0,0,1,0&gt;&gt;&quot; = fmt(&quot;~tp&quot;, [&lt;&lt;256:64/unsigned-integer&gt;&gt;]),
<a name="2105"/> 2105: 
<a name="2106"/> 2106:     Chars = lists:seq(0, 512), % just a few...
<a name="2107"/> 2107:     [] = [C || C &lt;- Chars, S &lt;- io_lib:write_char_as_latin1(C),
<a name="2108"/> 2108:                not is_latin1(S)],
<a name="2109"/> 2109:     L1 = [S || C &lt;- Chars, S &lt;- io_lib:write_char(C),
<a name="2110"/> 2110:                not is_latin1(S)],
<a name="2111"/> 2111:     L1 = lists:seq(256, 512),
<a name="2112"/> 2112: 
<a name="2113"/> 2113:     [] = [C || C &lt;- Chars, S &lt;- io_lib:write_string_as_latin1([C]),
<a name="2114"/> 2114:                not is_latin1(S)],
<a name="2115"/> 2115:     L2 = [S || C &lt;- Chars, S &lt;- io_lib:write_string([C]),
<a name="2116"/> 2116:                not is_latin1(S)],
<a name="2117"/> 2117:     L2 = lists:seq(256, 512),
<a name="2118"/> 2118: 
<a name="otp_10302-last_expr"/><a name="2119"/> 2119:     ok.
<a name="2120"/> 2120: 
<a name="pretty-2"/><a name="2121"/> 2121: <b>pretty</b>(Term, Depth) when is_integer(Depth) -&gt;
<a name="2122"/> 2122:     Opts = [{column, 1}, {line_length, 20},
<a name="2123"/> 2123:             {depth, Depth}, {line_max_chars, 60},
<a name="2124"/> 2124:             {record_print_fun, fun rfd/2},
<a name="2125"/> 2125:             {encoding, unicode}],
<a name="2126"/> 2126:     pretty(Term, Opts);
<a name="2127"/> 2127: <b>pretty</b>(Term, Opts) when is_list(Opts) -&gt;
<a name="2128"/> 2128:     R = io_lib_pretty:print(Term, Opts),
<a name="pretty-last_expr"/><a name="2129"/> 2129: <b>    lists:flatten</b>(io_lib:format(&quot;~ts&quot;, [R])).
<a name="2130"/> 2130: 
<a name="is_latin1-1"/><a name="2131"/> 2131: <b>is_latin1</b>(S) -&gt;
<a name="is_latin1-last_expr"/><a name="2132"/> 2132:     S &gt;= 0 andalso S =&lt; 255.
<a name="2133"/> 2133: 
<a name="2134"/> 2134: <i>%% OTP-10836. ~ts extended to latin1.</i>
<a name="otp_10836-1"/><a name="2135"/> 2135: <b>otp_10836</b>(Suite) when is_list(Suite) -&gt;
<a name="2136"/> 2136:     S = io_lib:format(&quot;~ts&quot;, [[&lt;&lt;&quot;äpple&quot;/utf8&gt;&gt;, &lt;&lt;&quot;äpple&quot;&gt;&gt;]]),
<a name="2137"/> 2137:     &quot;äppleäpple&quot; = lists:flatten(S),
<a name="otp_10836-last_expr"/><a name="2138"/> 2138:     ok.
<a name="2139"/> 2139: 
<a name="2140"/> 2140: <i>%% OTP-10755. The 'l' modifier</i>
<a name="otp_10755-1"/><a name="2141"/> 2141: <b>otp_10755</b>(Suite) when is_list(Suite) -&gt;
<a name="2142"/> 2142:     %% printing plain ascii characters
<a name="2143"/> 2143:     S = &quot;string&quot;,
<a name="2144"/> 2144:     &quot;\&quot;string\&quot;&quot; = fmt(&quot;~p&quot;, [S]),
<a name="2145"/> 2145:     &quot;[115,116,114,105,110,103]&quot; = fmt(&quot;~lp&quot;, [S]),
<a name="2146"/> 2146:     &quot;\&quot;string\&quot;&quot; = fmt(&quot;~P&quot;, [S, 2]),
<a name="2147"/> 2147:     &quot;[115|...]&quot; = fmt(&quot;~lP&quot;, [S, 2]),
<a name="2148"/> 2148:     %% printing latin1 chars, with and without modifiers
<a name="2149"/> 2149:     T = {[255],list_to_atom([255]),[a,b,c]},
<a name="2150"/> 2150:     &quot;{\&quot;ÿ\&quot;,ÿ,[a,b,c]}&quot; = fmt(&quot;~p&quot;, [T]),
<a name="2151"/> 2151:     &quot;{\&quot;ÿ\&quot;,ÿ,[a,b,c]}&quot; = fmt(&quot;~tp&quot;, [T]),
<a name="2152"/> 2152:     &quot;{[255],ÿ,[a,b,c]}&quot; = fmt(&quot;~lp&quot;, [T]),
<a name="2153"/> 2153:     &quot;{[255],ÿ,[a,b,c]}&quot; = fmt(&quot;~ltp&quot;, [T]),
<a name="2154"/> 2154:     &quot;{[255],ÿ,[a,b,c]}&quot; = fmt(&quot;~tlp&quot;, [T]),
<a name="2155"/> 2155:     &quot;{\&quot;ÿ\&quot;,ÿ,...}&quot; = fmt(&quot;~P&quot;, [T,3]),
<a name="2156"/> 2156:     &quot;{\&quot;ÿ\&quot;,ÿ,...}&quot; = fmt(&quot;~tP&quot;, [T,3]),
<a name="2157"/> 2157:     &quot;{[255],ÿ,...}&quot; = fmt(&quot;~lP&quot;, [T,3]),
<a name="2158"/> 2158:     &quot;{[255],ÿ,...}&quot; = fmt(&quot;~ltP&quot;, [T,3]),
<a name="2159"/> 2159:     &quot;{[255],ÿ,...}&quot; = fmt(&quot;~tlP&quot;, [T,3]),
<a name="2160"/> 2160:     %% printing unicode chars, with and without modifiers
<a name="2161"/> 2161:     U = {[666],list_to_atom([666]),[a,b,c]},
<a name="2162"/> 2162:     &quot;{[666],'\\x{29A}',[a,b,c]}&quot; = fmt(&quot;~p&quot;, [U]),
<a name="2163"/> 2163:     case io:printable_range() of
<a name="2164"/> 2164:         unicode -&gt;
<a name="2165"/> 2165:             &quot;{\&quot;ʚ\&quot;,'ʚ',[a,b,c]}&quot; = fmt(&quot;~tp&quot;, [U]),
<a name="2166"/> 2166:             &quot;{\&quot;ʚ\&quot;,'ʚ',...}&quot; = fmt(&quot;~tP&quot;, [U,3]);
<a name="2167"/> 2167:         latin1 -&gt;
<a name="2168"/> 2168:             &quot;{[666],'ʚ',[a,b,c]}&quot; = fmt(&quot;~tp&quot;, [U]),
<a name="2169"/> 2169:             &quot;{[666],'ʚ',...}&quot; = fmt(&quot;~tP&quot;, [U,3])
<a name="2170"/> 2170:     end,
<a name="2171"/> 2171:     &quot;{[666],'\\x{29A}',[a,b,c]}&quot; = fmt(&quot;~lp&quot;, [U]),
<a name="2172"/> 2172:     &quot;{[666],'ʚ',[a,b,c]}&quot; = fmt(&quot;~ltp&quot;, [U]),
<a name="2173"/> 2173:     &quot;{[666],'ʚ',[a,b,c]}&quot; = fmt(&quot;~tlp&quot;, [U]),
<a name="2174"/> 2174:     &quot;{[666],'\\x{29A}',...}&quot; = fmt(&quot;~P&quot;, [U,3]),
<a name="2175"/> 2175:     &quot;{[666],'\\x{29A}',...}&quot; = fmt(&quot;~lP&quot;, [U,3]),
<a name="2176"/> 2176:     &quot;{[666],'ʚ',...}&quot; = fmt(&quot;~ltP&quot;, [U,3]),
<a name="2177"/> 2177:     &quot;{[666],'ʚ',...}&quot; = fmt(&quot;~tlP&quot;, [U,3]),
<a name="2178"/> 2178:     %% the compiler should catch uses of ~l with other than pP
<a name="2179"/> 2179:     Text =
<a name="2180"/> 2180:         &quot;-module(l_mod).\n&quot;
<a name="2181"/> 2181:         &quot;-export([t/0]).\n&quot;
<a name="2182"/> 2182:         &quot;t() -&gt;\n&quot;
<a name="2183"/> 2183:         &quot;    S = \&quot;string\&quot;,\n&quot;
<a name="2184"/> 2184:         &quot;    io:format(\&quot;~lw\&quot;, [S]),\n&quot;
<a name="2185"/> 2185:         &quot;    io:format(\&quot;~lW\&quot;, [S, 1]),\n&quot;
<a name="2186"/> 2186:         &quot;    io:format(\&quot;~ltw\&quot;, [S]),\n&quot;
<a name="2187"/> 2187:         &quot;    io:format(\&quot;~tlw\&quot;, [S]),\n&quot;
<a name="2188"/> 2188:         &quot;    io:format(\&quot;~ltW\&quot;, [S, 1]),\n&quot;
<a name="2189"/> 2189:         &quot;    io:format(\&quot;~tlW\&quot;, [S, 1]),\n&quot;
<a name="2190"/> 2190:         &quot;    io:format(\&quot;~ltp\&quot;, [S, 1]).\n&quot;,
<a name="2191"/> 2191:     {ok,l_mod,[{_File,Ws}]} = compile_file(&quot;l_mod.erl&quot;, Text, Suite),
<a name="2192"/> 2192:     [&quot;format string invalid (invalid modifier/control combination ~lw)&quot;,
<a name="2193"/> 2193:      &quot;format string invalid (invalid modifier/control combination ~lW)&quot;,
<a name="2194"/> 2194:      &quot;format string invalid (invalid modifier/control combination ~lw)&quot;,
<a name="2195"/> 2195:      &quot;format string invalid (invalid modifier/control combination ~lw)&quot;,
<a name="2196"/> 2196:      &quot;format string invalid (invalid modifier/control combination ~lW)&quot;,
<a name="2197"/> 2197:      &quot;format string invalid (invalid modifier/control combination ~lW)&quot;,
<a name="2198"/> 2198:      &quot;format string invalid (conflicting modifiers ~ltp)&quot;] =
<a name="2199"/> 2199:         [lists:flatten(M:format_error(E)) || {_L,M,E} &lt;- Ws],
<a name="otp_10755-last_expr"/><a name="2200"/> 2200:     ok.
<a name="2201"/> 2201: 
<a name="compile_file-3"/><a name="2202"/> 2202: <b>compile_file</b>(File, Text, Config) -&gt;
<a name="2203"/> 2203:     PrivDir = ?privdir(Config),
<a name="2204"/> 2204:     Fname = filename:join(PrivDir, File),
<a name="2205"/> 2205:     ok = file:write_file(Fname, Text),
<a name="compile_file-last_expr"/><a name="2206"/> 2206: <b>    try compile:file</b>(Fname, [return])
<a name="2207"/> 2207:     after ok %file:delete(Fname)
<a name="2208"/> 2208:     end.
<a name="2209"/> 2209: 
<a name="io_lib_width_too_small-1"/><a name="2210"/> 2210: <b>io_lib_width_too_small</b>(_Config) -&gt;
<a name="2211"/> 2211:     &quot;**&quot; = lists:flatten(io_lib:format(&quot;~2.3w&quot;, [3.14])),
<a name="2212"/> 2212:     &quot;**&quot; = lists:flatten(io_lib:format(&quot;~2.5w&quot;, [3.14])),
<a name="io_lib_width_too_small-last_expr"/><a name="2213"/> 2213:     ok.
<a name="2214"/> 2214: 
<a name="2215"/> 2215: <i>%% Test that the time for a huge message queue is not</i>
<a name="2216"/> 2216: <i>%% significantly slower than with an empty message queue.</i>
<a name="io_with_huge_message_queue-1"/><a name="2217"/> 2217: <b>io_with_huge_message_queue</b>(Config) when is_list(Config) -&gt;
<a name="io_with_huge_message_queue-last_expr"/><a name="2218"/> 2218: <b>    case test_server:is_cover</b>() of
<a name="2219"/> 2219: 	true -&gt;
<a name="2220"/> 2220: 	    {skip,&quot;Running under cover&quot;};
<a name="2221"/> 2221: 	false -&gt;
<a name="2222"/> 2222: 	    do_io_with_huge_message_queue(Config)
<a name="2223"/> 2223:     end.
<a name="2224"/> 2224: 
<a name="do_io_with_huge_message_queue-1"/><a name="2225"/> 2225: <b>do_io_with_huge_message_queue</b>(Config) -&gt;
<a name="2226"/> 2226:     PrivDir = ?privdir(Config),
<a name="2227"/> 2227:     File = filename:join(PrivDir, &quot;slask&quot;),
<a name="2228"/> 2228:     {ok, F1} = file:open(File, [write]),
<a name="2229"/> 2229:     Test = fun(Times) -&gt;
<a name="2230"/> 2230: 		   {Time,ok} = timer:tc(fun() -&gt; writes(Times, F1) end),
<a name="2231"/> 2231: 		   Time
<a name="2232"/> 2232: 	   end,
<a name="2233"/> 2233:     {Times,EmptyTime} = calibrate(100, Test),
<a name="2234"/> 2234: 
<a name="2235"/> 2235:     [self() ! {msg,N} || N &lt;- lists:seq(1, 500000)],
<a name="2236"/> 2236:     erlang:garbage_collect(),
<a name="2237"/> 2237:     FullTime = Test(Times),
<a name="2238"/> 2238:     file:close(F1),
<a name="2239"/> 2239:     file:delete(File),
<a name="2240"/> 2240:     io:format(&quot;Number of writes: ~p&quot;, [Times]),
<a name="2241"/> 2241:     io:format(&quot;Time for empty message queue: ~p&quot;, [EmptyTime]),
<a name="2242"/> 2242:     io:format(&quot;Time for huge message queue: ~p&quot;, [FullTime]),
<a name="2243"/> 2243: 
<a name="2244"/> 2244:     case (FullTime+1) / (EmptyTime+1) of
<a name="2245"/> 2245: 	Q when Q &lt; 10 -&gt;
<a name="2246"/> 2246: 	    ok;
<a name="2247"/> 2247: 	Q -&gt;
<a name="2248"/> 2248: 	    io:format(&quot;Q = ~p&quot;, [Q]),
<a name="2249"/> 2249: 	    ct:fail(failed)
<a name="2250"/> 2250:     end,
<a name="do_io_with_huge_message_queue-last_expr"/><a name="2251"/> 2251:     ok.
<a name="2252"/> 2252: 
<a name="2253"/> 2253: <i>%% Make sure that the time is not too short. That could cause the</i>
<a name="2254"/> 2254: <i>%% test case to fail.</i>
<a name="calibrate-2"/><a name="2255"/> 2255: <b>calibrate</b>(N, Test) when N =&lt; 100000 -&gt;
<a name="2256"/> 2256:     case Test(N) of
<a name="2257"/> 2257: 	Time when Time &lt; 50000 -&gt;
<a name="2258"/> 2258: 	    calibrate(10*N, Test);
<a name="2259"/> 2259: 	Time -&gt;
<a name="2260"/> 2260: 	    {N,Time}
<a name="2261"/> 2261:     end;
<a name="2262"/> 2262: <b>calibrate</b>(N, _) -&gt;
<a name="calibrate-last_expr"/><a name="2263"/> 2263:     N.
<a name="2264"/> 2264: 
<a name="writes-2"/><a name="2265"/> 2265: <b>writes</b>(0, _) -&gt; ok;
<a name="2266"/> 2266: <b>writes</b>(N, F1) -&gt;
<a name="2267"/> 2267:     file:write(F1, &quot;hello\n&quot;),
<a name="writes-last_expr"/><a name="2268"/> 2268: <b>    writes</b>(N - 1, F1).
<a name="2269"/> 2269: 
<a name="format_string-1"/><a name="2270"/> 2270: <b>format_string</b>(_Config) -&gt;
<a name="2271"/> 2271:     %% All but padding is tested by fmt/2.
<a name="2272"/> 2272:     &quot;xxxxxxxsss&quot; = fmt(&quot;~10..xs&quot;, [&quot;sss&quot;]),
<a name="2273"/> 2273:     &quot;xxxxxxsssx&quot; = fmt(&quot;~10.4.xs&quot;, [&quot;sss&quot;]),
<a name="2274"/> 2274:     &quot;xxxxxxsssx&quot; = fmt(&quot;~10.4.*s&quot;, [$x, &quot;sss&quot;]),
<a name="format_string-last_expr"/><a name="2275"/> 2275:     ok.
<a name="2276"/> 2276: 
<a name="maps-1"/><a name="2277"/> 2277: <b>maps</b>(_Config) -&gt;
<a name="2278"/> 2278:     %% Note that order in which a map is printed is arbitrary.
<a name="2279"/> 2279:     %% Therefore, play it completely safe by not assuming any order
<a name="2280"/> 2280:     %% in a map with more than one element.
<a name="2281"/> 2281: 
<a name="2282"/> 2282:     AOrdCmpFun = fun(A, B) -&gt; A =&lt; B end,
<a name="2283"/> 2283:     ARevCmpFun = fun(A, B) -&gt; B &lt; A end,
<a name="2284"/> 2284: 
<a name="2285"/> 2285:     AtomMap1 = #{a =&gt; b},
<a name="2286"/> 2286:     AtomMap2 = #{a =&gt; b, c =&gt; d},
<a name="2287"/> 2287:     AtomMap3 = #{a =&gt; b, c =&gt; d, e =&gt; f},
<a name="2288"/> 2288: 
<a name="2289"/> 2289:     &quot;#{}&quot; = fmt(&quot;~w&quot;, [#{}]),
<a name="2290"/> 2290:     &quot;#{a =&gt; b}&quot; = fmt(&quot;~w&quot;, [AtomMap1]),
<a name="2291"/> 2291:     re_fmt(&lt;&lt;&quot;#\\{(a =&gt; b|c =&gt; d),[.][.][.]\\}&quot;&gt;&gt;,
<a name="2292"/> 2292: 	     &quot;~W&quot;, [AtomMap2, 2]),
<a name="2293"/> 2293:     re_fmt(&lt;&lt;&quot;#\\{(a =&gt; b|c =&gt; d|e =&gt; f),[.][.][.]\\}&quot;&gt;&gt;,
<a name="2294"/> 2294: 	   &quot;~W&quot;, [AtomMap3, 2]),
<a name="2295"/> 2295:     &quot;#{a =&gt; b,c =&gt; d,e =&gt; f}&quot; = fmt(&quot;~kw&quot;, [AtomMap3]),
<a name="2296"/> 2296:     re_fmt(&lt;&lt;&quot;#\\{(a =&gt; b|c =&gt; d|e =&gt; f),[.][.][.]\\}&quot;&gt;&gt;,
<a name="2297"/> 2297:            &quot;~KW&quot;, [undefined, AtomMap3, 2]),
<a name="2298"/> 2298:     &quot;#{a =&gt; b,c =&gt; d,e =&gt; f}&quot; = fmt(&quot;~Kw&quot;, [ordered, AtomMap3]),
<a name="2299"/> 2299:     &quot;#{e =&gt; f,c =&gt; d,a =&gt; b}&quot; = fmt(&quot;~Kw&quot;, [reversed, AtomMap3]),
<a name="2300"/> 2300:     &quot;#{a =&gt; b,c =&gt; d,e =&gt; f}&quot; = fmt(&quot;~Kw&quot;, [AOrdCmpFun, AtomMap3]),
<a name="2301"/> 2301:     &quot;#{e =&gt; f,c =&gt; d,a =&gt; b}&quot; = fmt(&quot;~Kw&quot;, [ARevCmpFun, AtomMap3]),
<a name="2302"/> 2302: 
<a name="2303"/> 2303:     &quot;#{}&quot; = fmt(&quot;~p&quot;, [#{}]),
<a name="2304"/> 2304:     &quot;#{a =&gt; b}&quot; = fmt(&quot;~p&quot;, [AtomMap1]),
<a name="2305"/> 2305:     &quot;#{...}&quot; = fmt(&quot;~P&quot;, [AtomMap1, 1]),
<a name="2306"/> 2306:     re_fmt(&lt;&lt;&quot;#\\{(a =&gt; b|c =&gt; d),[.][.][.]\\}&quot;&gt;&gt;,
<a name="2307"/> 2307: 	   &quot;~P&quot;, [AtomMap2, 2]),
<a name="2308"/> 2308:     re_fmt(&lt;&lt;&quot;#\\{(a =&gt; b|c =&gt; d|e =&gt; f),[.][.][.]\\}&quot;&gt;&gt;,
<a name="2309"/> 2309: 	   &quot;~P&quot;, [AtomMap3, 2]),
<a name="2310"/> 2310:     &quot;#{a =&gt; b,c =&gt; d,e =&gt; f}&quot; = fmt(&quot;~kp&quot;, [AtomMap3]),
<a name="2311"/> 2311:     re_fmt(&lt;&lt;&quot;#\\{(a =&gt; b|c =&gt; d|e =&gt; f),[.][.][.]\\}&quot;&gt;&gt;,
<a name="2312"/> 2312:            &quot;~KP&quot;, [undefined, AtomMap3, 2]),
<a name="2313"/> 2313:     &quot;#{a =&gt; b,c =&gt; d,e =&gt; f}&quot; = fmt(&quot;~Kp&quot;, [ordered, AtomMap3]),
<a name="2314"/> 2314:     &quot;#{e =&gt; f,c =&gt; d,a =&gt; b}&quot; = fmt(&quot;~Kp&quot;, [reversed, AtomMap3]),
<a name="2315"/> 2315:     &quot;#{a =&gt; b,c =&gt; d,e =&gt; f}&quot; = fmt(&quot;~Kp&quot;, [AOrdCmpFun, AtomMap3]),
<a name="2316"/> 2316:     &quot;#{e =&gt; f,c =&gt; d,a =&gt; b}&quot; = fmt(&quot;~Kp&quot;, [ARevCmpFun, AtomMap3]),
<a name="2317"/> 2317: 
<a name="2318"/> 2318:     List = [{I, I * I} || I &lt;- lists:seq(1, 64)],
<a name="2319"/> 2319:     Map = maps:from_list(List),
<a name="2320"/> 2320: 
<a name="2321"/> 2321:     &quot;#{...}&quot; = fmt(&quot;~P&quot;, [Map, 1]),
<a name="2322"/> 2322:     &quot;#{1 =&gt; 1,...}&quot; = fmt(&quot;~kP&quot;, [Map, 2]),
<a name="2323"/> 2323:     &quot;#{1 =&gt; 1,...}&quot; = fmt(&quot;~KP&quot;, [ordered, Map, 2]),
<a name="2324"/> 2324:     &quot;#{64 =&gt; 4096,...}&quot; = fmt(&quot;~KP&quot;, [reversed, Map, 2]),
<a name="2325"/> 2325:     &quot;#{1 =&gt; 1,...}&quot; = fmt(&quot;~KP&quot;, [AOrdCmpFun, Map, 2]),
<a name="2326"/> 2326:     &quot;#{64 =&gt; 4096,...}&quot; = fmt(&quot;~KP&quot;, [ARevCmpFun, Map, 2]),
<a name="2327"/> 2327: 
<a name="2328"/> 2328:     FloatIntegerMap = #{-1.0 =&gt; a, 0.0 =&gt; b, -1 =&gt; c, 0 =&gt; d},
<a name="2329"/> 2329:     re_fmt(&lt;&lt;&quot;#\\{(-1.0 =&gt; a|0.0 =&gt; b|-1 =&gt; c|0 =&gt; d),[.][.][.]\\}&quot;&gt;&gt;,
<a name="2330"/> 2330:            &quot;~P&quot;, [FloatIntegerMap, 2]),
<a name="2331"/> 2331:     &quot;#{-1 =&gt; c,0 =&gt; d,-1.0 =&gt; a,0.0 =&gt; b}&quot; = fmt(&quot;~kp&quot;, [FloatIntegerMap]),
<a name="2332"/> 2332:     re_fmt(&lt;&lt;&quot;#\\{(-1.0 =&gt; a|0.0 =&gt; b|-1 =&gt; c|0 =&gt; d),[.][.][.]\\}&quot;&gt;&gt;,
<a name="2333"/> 2333:            &quot;~KP&quot;, [undefined, FloatIntegerMap, 2]),
<a name="2334"/> 2334:     &quot;#{-1 =&gt; c,0 =&gt; d,-1.0 =&gt; a,0.0 =&gt; b}&quot; = fmt(&quot;~Kp&quot;, [ordered, FloatIntegerMap]),
<a name="2335"/> 2335:     &quot;#{0.0 =&gt; b,-1.0 =&gt; a,0 =&gt; d,-1 =&gt; c}&quot; = fmt(&quot;~Kp&quot;, [reversed, FloatIntegerMap]),
<a name="2336"/> 2336: 
<a name="2337"/> 2337:     %% Print a map and parse it back to a map.
<a name="2338"/> 2338:     S = fmt(&quot;~p\n&quot;, [Map]),
<a name="2339"/> 2339:     io:format(&quot;~p\n&quot;, [S]),
<a name="2340"/> 2340:     Map = parse_map(S),
<a name="2341"/> 2341: 
<a name="2342"/> 2342:     %% Smoke test of a map as key.
<a name="2343"/> 2343:     MapAsKey = #{Map =&gt; &quot;value&quot;},
<a name="2344"/> 2344:     io:format(&quot;~s\n&quot;, [fmt(&quot;~p&quot;, [MapAsKey])]),
<a name="maps-last_expr"/><a name="2345"/> 2345:     ok.
<a name="2346"/> 2346: 
<a name="re_fmt-3"/><a name="2347"/> 2347: <b>re_fmt</b>(Pattern, Format, Args) -&gt;
<a name="2348"/> 2348:     S = list_to_binary(fmt(Format, Args)),
<a name="re_fmt-last_expr"/><a name="2349"/> 2349: <b>    case re:run</b>(S, Pattern, [{capture,none}]) of
<a name="2350"/> 2350: 	nomatch -&gt;
<a name="2351"/> 2351: 	    io:format(&quot;Pattern: ~s&quot;, [Pattern]),
<a name="2352"/> 2352: 	    io:format(&quot;Result:  ~s&quot;, [S]),
<a name="2353"/> 2353: 	    ct:fail(failed);
<a name="2354"/> 2354: 	match -&gt;
<a name="2355"/> 2355: 	    ok
<a name="2356"/> 2356:     end.
<a name="2357"/> 2357: 
<a name="2358"/> 2358: <i>%% Parse a map consisting of integer keys and values.</i>
<a name="parse_map-1"/><a name="2359"/> 2359: <b>parse_map</b>(S0) -&gt;
<a name="2360"/> 2360:     S1 = parse_expect(S0, &quot;#{&quot;),
<a name="2361"/> 2361:     {M,S2} = parse_map_1(S1),
<a name="2362"/> 2362:     S = parse_expect(S2, &quot;}&quot;),
<a name="2363"/> 2363:     S = &quot;&quot;,
<a name="parse_map-last_expr"/><a name="2364"/> 2364:     M.
<a name="2365"/> 2365: 
<a name="parse_map_1-1"/><a name="2366"/> 2366: <b>parse_map_1</b>(S0) -&gt;
<a name="2367"/> 2367:     {Key,S1} = parse_number(S0),
<a name="2368"/> 2368:     S2 = parse_expect(S1, &quot;=&gt;&quot;),
<a name="2369"/> 2369:     {Val,S3} = parse_number(S2),
<a name="parse_map_1-last_expr"/><a name="2370"/> 2370:     case S3 of
<a name="2371"/> 2371: 	&quot;,&quot;++S4 -&gt;
<a name="2372"/> 2372: 	    S5 = parse_skip_ws(S4),
<a name="2373"/> 2373: 	    {Map,S} = parse_map_1(S5),
<a name="2374"/> 2374: 	    {Map#{Key=&gt;Val},S};
<a name="2375"/> 2375: 	S -&gt;
<a name="2376"/> 2376: 	    {#{Key=&gt;Val},S}
<a name="2377"/> 2377:     end.
<a name="2378"/> 2378: 
<a name="parse_number-1"/><a name="2379"/> 2379: <b>parse_number</b>(S) -&gt;
<a name="parse_number-last_expr"/><a name="2380"/> 2380: <b>    parse_number</b>(S, none).
<a name="2381"/> 2381: 
<a name="parse_number-2"/><a name="2382"/> 2382: <b>parse_number</b>([C|S], Acc0) when $0 =&lt; C, C =&lt; $9 -&gt;
<a name="2383"/> 2383:     Acc = case Acc0 of
<a name="2384"/> 2384: 	      none -&gt; 0;
<a name="2385"/> 2385: 	      _ when is_integer(Acc0) -&gt; Acc0
<a name="2386"/> 2386: 	  end,
<a name="2387"/> 2387:     parse_number(S, Acc*10+C-$0);
<a name="2388"/> 2388: <b>parse_number</b>(S, Acc) -&gt;
<a name="parse_number-last_expr"/><a name="2389"/> 2389: <b>    {Acc,parse_skip_ws</b>(S)}.
<a name="2390"/> 2390: 
<a name="parse_expect-2"/><a name="2391"/> 2391: <b>parse_expect</b>([H|T1], [H|T2]) -&gt;
<a name="2392"/> 2392:     parse_expect(T1, T2);
<a name="2393"/> 2393: <b>parse_expect</b>(S, []) -&gt;
<a name="parse_expect-last_expr"/><a name="2394"/> 2394: <b>    parse_skip_ws</b>(S).
<a name="2395"/> 2395: 
<a name="parse_skip_ws-1"/><a name="2396"/> 2396: <b>parse_skip_ws</b>([C|S]) when C =&lt; $\s -&gt;
<a name="2397"/> 2397:     parse_skip_ws(S);
<a name="2398"/> 2398: <b>parse_skip_ws</b>(S) -&gt;
<a name="parse_skip_ws-last_expr"/><a name="2399"/> 2399:     S.
<a name="2400"/> 2400: 
<a name="2401"/> 2401: <i>%% Cover the last uncovered lines for completeness.</i>
<a name="coverage-1"/><a name="2402"/> 2402: <b>coverage</b>(_Config) -&gt;
<a name="2403"/> 2403:     S1 = io_lib_pretty:print({a,term}, fun(_, _) -&gt; no end),
<a name="2404"/> 2404:     io:format(&quot;~s\n&quot;, [S1]),
<a name="2405"/> 2405: 
<a name="2406"/> 2406:     %% The tuple of arity three will be ignored.
<a name="2407"/> 2407:     S2 = io_lib_pretty:print(lists:seq(1, 100), [{depth,1,1}]),
<a name="2408"/> 2408:     io:format(&quot;~s\n&quot;, [S2]),
<a name="2409"/> 2409: 
<a name="coverage-last_expr"/><a name="2410"/> 2410:     ok.
<a name="2411"/> 2411: 
<a name="2412"/> 2412: <i>%% Test UTF-8 atoms.</i>
<a name="otp_14178_unicode_atoms-1"/><a name="2413"/> 2413: <b>otp_14178_unicode_atoms</b>(_Config) -&gt;
<a name="2414"/> 2414:     &quot;atom&quot; = fmt(&quot;~ts&quot;, ['atom']),
<a name="2415"/> 2415:     &quot;кирилли́ческий атом&quot; = fmt(&quot;~ts&quot;, ['кирилли́ческий атом']),
<a name="2416"/> 2416:     [16#10FFFF] = fmt(&quot;~ts&quot;, ['\x{10FFFF}']),
<a name="2417"/> 2417: 
<a name="2418"/> 2418:     %% ~s must not accept code points greater than 255.
<a name="2419"/> 2419:     bad_io_lib_format(&quot;~s&quot;, ['\x{100}']),
<a name="2420"/> 2420:     bad_io_lib_format(&quot;~s&quot;, ['кирилли́ческий атом']),
<a name="2421"/> 2421: 
<a name="otp_14178_unicode_atoms-last_expr"/><a name="2422"/> 2422:     ok.
<a name="2423"/> 2423: 
<a name="bad_io_lib_format-2"/><a name="2424"/> 2424: <b>bad_io_lib_format</b>(F, S) -&gt;
<a name="bad_io_lib_format-last_expr"/><a name="2425"/> 2425: <b>    try io_lib:format</b>(F, S) of
<a name="2426"/> 2426:         _ -&gt;
<a name="2427"/> 2427:             ct:fail({should_fail,F,S})
<a name="2428"/> 2428:     catch
<a name="2429"/> 2429:         error:badarg -&gt;
<a name="2430"/> 2430:             ok
<a name="2431"/> 2431:     end.
<a name="2432"/> 2432: 
<a name="otp_14175-1"/><a name="2433"/> 2433: <b>otp_14175</b>(_Config) -&gt;
<a name="2434"/> 2434:     &quot;...&quot; = p(#{}, 0),
<a name="2435"/> 2435:     &quot;#{}&quot; = p(#{}, 1),
<a name="2436"/> 2436:     &quot;#{...}&quot; = p(#{a =&gt; 1}, 1),
<a name="2437"/> 2437:     &quot;#{#{} =&gt; a}&quot; = p(#{#{} =&gt; a}, 2),
<a name="2438"/> 2438:     mt(&quot;#{a =&gt; 1,...}&quot;, p(#{a =&gt; 1, b =&gt; 2}, 2)),
<a name="2439"/> 2439:     mt(&quot;#{a =&gt; 1,b =&gt; 2}&quot;, p(#{a =&gt; 1, b =&gt; 2}, -1)),
<a name="2440"/> 2440: 
<a name="2441"/> 2441:     M = #{kaaaaaaaaaaaaaaaaaaa =&gt; v1,kbbbbbbbbbbbbbbbbbbb =&gt; v2,
<a name="2442"/> 2442:           kccccccccccccccccccc =&gt; v3,kddddddddddddddddddd =&gt; v4,
<a name="2443"/> 2443:           keeeeeeeeeeeeeeeeeee =&gt; v5},
<a name="2444"/> 2444:     &quot;#{...}&quot; = p(M, 1),
<a name="2445"/> 2445:     mt(&quot;#{kaaaaaaaaaaaaaaaaaaaa =&gt; v1,...}&quot;, p(M, 2)),
<a name="2446"/> 2446:     mt(&quot;#{kaaaaaaaaaaaaaaaaaaaa =&gt; 1,kbbbbbbbbbbbbbbbbbbbb =&gt; 2,...}&quot;,
<a name="2447"/> 2447:        p(M, 3)),
<a name="2448"/> 2448: 
<a name="2449"/> 2449:     mt(&quot;#{kaaaaaaaaaaaaaaaaaaa =&gt; v1,kbbbbbbbbbbbbbbbbbbb =&gt; v2,\n&quot;
<a name="2450"/> 2450:        &quot;  kccccccccccccccccccc =&gt; v3,...}&quot;, p(M, 4)),
<a name="2451"/> 2451: 
<a name="2452"/> 2452:     mt(&quot;#{kaaaaaaaaaaaaaaaaaaa =&gt; v1,kbbbbbbbbbbbbbbbbbbb =&gt; v2,\n&quot;
<a name="2453"/> 2453:        &quot;  kccccccccccccccccccc =&gt; v3,kddddddddddddddddddd =&gt; v4,...}&quot;,
<a name="2454"/> 2454:        p(M, 5)),
<a name="2455"/> 2455: 
<a name="2456"/> 2456:     mt(&quot;#{kaaaaaaaaaaaaaaaaaaa =&gt; v1,kbbbbbbbbbbbbbbbbbbb =&gt; v2,\n&quot;
<a name="2457"/> 2457:        &quot;  kccccccccccccccccccc =&gt; v3,kddddddddddddddddddd =&gt; v4,\n&quot;
<a name="2458"/> 2458:        &quot;  keeeeeeeeeeeeeeeeeee =&gt; v5}&quot;, p(M, 6)),
<a name="2459"/> 2459: 
<a name="2460"/> 2460:     weak(&quot;#{aaaaaaaaaaaaaaaaaaa =&gt; 1,bbbbbbbbbbbbbbbbbbbb =&gt; 2,\n&quot;
<a name="2461"/> 2461:          &quot;  cccccccccccccccccccc =&gt; {3},\n&quot;
<a name="2462"/> 2462:          &quot;  dddddddddddddddddddd =&gt; 4,eeeeeeeeeeeeeeeeeeee =&gt; 5}&quot;,
<a name="2463"/> 2463:        p(#{aaaaaaaaaaaaaaaaaaa =&gt; 1,bbbbbbbbbbbbbbbbbbbb =&gt; 2,
<a name="2464"/> 2464:            cccccccccccccccccccc =&gt; {3},
<a name="2465"/> 2465:            dddddddddddddddddddd =&gt; 4,eeeeeeeeeeeeeeeeeeee =&gt; 5}, -1)),
<a name="2466"/> 2466: 
<a name="2467"/> 2467:     M2 = #{dddddddddddddddddddd =&gt; {1}, {aaaaaaaaaaaaaaaaaaaa} =&gt; 2,
<a name="2468"/> 2468:            {bbbbbbbbbbbbbbbbbbbb} =&gt; 3,{cccccccccccccccccccc} =&gt; 4,
<a name="2469"/> 2469:            {eeeeeeeeeeeeeeeeeeee} =&gt; 5},
<a name="2470"/> 2470:     &quot;#{...}&quot; = p(M2, 1),
<a name="2471"/> 2471:     weak(&quot;#{dddddddddddddddddddd =&gt; {...},...}&quot;, p(M2, 2)),
<a name="2472"/> 2472:     weak(&quot;#{dddddddddddddddddddd =&gt; {1},{...} =&gt; 2,...}&quot;, p(M2, 3)),
<a name="2473"/> 2473: 
<a name="2474"/> 2474:     weak(&quot;#{dddddddddddddddddddd =&gt; {1},\n&quot;
<a name="2475"/> 2475:          &quot;  {aaaaaaaaaaaaaaaaaaaa} =&gt; 2,\n&quot;
<a name="2476"/> 2476:          &quot;  {...} =&gt; 3,...}&quot;, p(M2, 4)),
<a name="2477"/> 2477: 
<a name="2478"/> 2478:     weak(&quot;#{dddddddddddddddddddd =&gt; {1},\n&quot;
<a name="2479"/> 2479:          &quot;  {aaaaaaaaaaaaaaaaaaaa} =&gt; 2,\n&quot;
<a name="2480"/> 2480:          &quot;  {bbbbbbbbbbbbbbbbbbbb} =&gt; 3,\n&quot;
<a name="2481"/> 2481:          &quot;  {...} =&gt; 4,...}&quot;, p(M2, 5)),
<a name="2482"/> 2482: 
<a name="2483"/> 2483:     weak(&quot;#{dddddddddddddddddddd =&gt; {1},\n&quot;
<a name="2484"/> 2484:          &quot;  {aaaaaaaaaaaaaaaaaaaa} =&gt; 2,\n&quot;
<a name="2485"/> 2485:          &quot;  {bbbbbbbbbbbbbbbbbbbb} =&gt; 3,\n&quot;
<a name="2486"/> 2486:          &quot;  {cccccccccccccccccccc} =&gt; 4,\n&quot;
<a name="2487"/> 2487:          &quot;  {...} =&gt; 5}&quot;, p(M2, 6)),
<a name="2488"/> 2488: 
<a name="2489"/> 2489:     weak(&quot;#{dddddddddddddddddddd =&gt; {1},\n&quot;
<a name="2490"/> 2490:          &quot;  {aaaaaaaaaaaaaaaaaaaa} =&gt; 2,\n&quot;
<a name="2491"/> 2491:          &quot;  {bbbbbbbbbbbbbbbbbbbb} =&gt; 3,\n&quot;
<a name="2492"/> 2492:          &quot;  {cccccccccccccccccccc} =&gt; 4,\n&quot;
<a name="2493"/> 2493:          &quot;  {eeeeeeeeeeeeeeeeeeee} =&gt; 5}&quot;, p(M2, 7)),
<a name="2494"/> 2494: 
<a name="2495"/> 2495:     M3 = #{kaaaaaaaaaaaaaaaaaaa =&gt; vuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuu,
<a name="2496"/> 2496:            kbbbbbbbbbbbbbbbbbbb =&gt; vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv,
<a name="2497"/> 2497:            kccccccccccccccccccc =&gt; vxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx,
<a name="2498"/> 2498:            kddddddddddddddddddd =&gt; vyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy,
<a name="2499"/> 2499:            keeeeeeeeeeeeeeeeeee =&gt; vzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz},
<a name="2500"/> 2500: 
<a name="2501"/> 2501:     mt(&quot;#{aaaaaaaaaaaaaaaaaaaa =&gt;\n&quot;
<a name="2502"/> 2502:        &quot;      uuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuu,\n&quot;
<a name="2503"/> 2503:        &quot;  bbbbbbbbbbbbbbbbbbbb =&gt;\n&quot;
<a name="2504"/> 2504:        &quot;      vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv,\n&quot;
<a name="2505"/> 2505:        &quot;  cccccccccccccccccccc =&gt;\n&quot;
<a name="2506"/> 2506:        &quot;      xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx,\n&quot;
<a name="2507"/> 2507:        &quot;  dddddddddddddddddddd =&gt;\n&quot;
<a name="2508"/> 2508:        &quot;      yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy,\n&quot;
<a name="2509"/> 2509:        &quot;  eeeeeeeeeeeeeeeeeeee =&gt;\n&quot;
<a name="2510"/> 2510:        &quot;      zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz}&quot;, p(M3, -1)),
<a name="2511"/> 2511: 
<a name="2512"/> 2512:     R4 = {c,{c,{c,{c,{c,{c,{c,{c,{c,{c,{c,{c,a,b},b},b},b},b},b},
<a name="2513"/> 2513: 			 b},b},b},b},b},b},
<a name="2514"/> 2514:     M4 = #{aaaaaaaaaaaaaaaaaaaa =&gt; R4,
<a name="2515"/> 2515:            bbbbbbbbbbbbbbbbbbbb =&gt; R4,
<a name="2516"/> 2516:            cccccccccccccccccccc =&gt; R4,
<a name="2517"/> 2517:            dddddddddddddddddddd =&gt; R4,
<a name="2518"/> 2518:            eeeeeeeeeeeeeeeeeeee =&gt; R4},
<a name="2519"/> 2519: 
<a name="2520"/> 2520:     weak(&quot;#{aaaaaaaaaaaaaaaaaaaa =&gt;\n&quot;
<a name="2521"/> 2521:          &quot;      #c{f1 = #c{f1 = #c{...},f2 = b},f2 = b},\n&quot;
<a name="2522"/> 2522:          &quot;  bbbbbbbbbbbbbbbbbbbb =&gt; #c{f1 = #c{f1 = {...},...},f2 = b},\n&quot;
<a name="2523"/> 2523:          &quot;  cccccccccccccccccccc =&gt; #c{f1 = #c{...},f2 = b},\n&quot;
<a name="2524"/> 2524:          &quot;  dddddddddddddddddddd =&gt; #c{f1 = {...},...},\n&quot;
<a name="2525"/> 2525:          &quot;  eeeeeeeeeeeeeeeeeeee =&gt; #c{...}}&quot;, p(M4, 7)),
<a name="2526"/> 2526: 
<a name="2527"/> 2527:     M5 = #{aaaaaaaaaaaaaaaaaaaa =&gt; R4},
<a name="2528"/> 2528:     mt(&quot;#{aaaaaaaaaaaaaaaaaaaa =&gt;\n&quot;
<a name="2529"/> 2529:        &quot;   #c{\n&quot;
<a name="2530"/> 2530:        &quot;    f1 =\n&quot;
<a name="2531"/> 2531:        &quot;     #c{\n&quot;
<a name="2532"/> 2532:        &quot;      f1 =\n&quot;
<a name="2533"/> 2533:        &quot;       #c{\n&quot;
<a name="2534"/> 2534:        &quot;        f1 =\n&quot;
<a name="2535"/> 2535:        &quot;         #c{\n&quot;
<a name="2536"/> 2536:        &quot;          f1 =\n&quot;
<a name="2537"/> 2537:        &quot;           #c{\n&quot;
<a name="2538"/> 2538:        &quot;            f1 =\n&quot;
<a name="2539"/> 2539:        &quot;             #c{\n&quot;
<a name="2540"/> 2540:        &quot;              f1 =\n&quot;
<a name="2541"/> 2541:        &quot;               #c{\n&quot;
<a name="2542"/> 2542:        &quot;                f1 =\n&quot;
<a name="2543"/> 2543:        &quot;                 #c{\n&quot;
<a name="2544"/> 2544:        &quot;                  f1 =\n&quot;
<a name="2545"/> 2545:        &quot;                   #c{\n&quot;
<a name="2546"/> 2546:        &quot;                    f1 = #c{f1 = #c{f1 = #c{f1 = a,f2 = b},f2 = b},&quot;
<a name="2547"/> 2547:                                         &quot;f2 = b},\n&quot;
<a name="2548"/> 2548:        &quot;                    f2 = b},\n&quot;
<a name="2549"/> 2549:        &quot;                  f2 = b},\n&quot;
<a name="2550"/> 2550:        &quot;                f2 = b},\n&quot;
<a name="2551"/> 2551:        &quot;              f2 = b},\n&quot;
<a name="2552"/> 2552:        &quot;            f2 = b},\n&quot;
<a name="2553"/> 2553:        &quot;          f2 = b},\n&quot;
<a name="2554"/> 2554:        &quot;        f2 = b},\n&quot;
<a name="2555"/> 2555:        &quot;      f2 = b},\n&quot;
<a name="2556"/> 2556:        &quot;    f2 = b}}&quot;, p(M5, -1)),
<a name="otp_14175-last_expr"/><a name="2557"/> 2557:     ok.
<a name="2558"/> 2558: 
<a name="2559"/> 2559: <i>%% Just check number of newlines and dots ('...').</i>
<a name="2560"/> 2560: <b>-define</b>(WEAK, true).
<a name="2561"/> 2561: 
<a name="2562"/> 2562: <b>-ifdef</b>(WEAK).
<a name="2563"/> 2563: 
<a name="weak-2"/><a name="2564"/> 2564: <b>weak</b>(S, R) -&gt;
<a name="weak-last_expr"/><a name="2565"/> 2565: <b>    </b>(nl(S) =:= nl(R) andalso
<a name="2566"/> 2566:      dots(S) =:= dots(S)).
<a name="2567"/> 2567: 
<a name="nl-1"/><a name="2568"/> 2568: <b>nl</b>(S) -&gt;
<a name="nl-last_expr"/><a name="2569"/> 2569:     [C || C &lt;- S, C =:= $\n].
<a name="2570"/> 2570: 
<a name="dots-1"/><a name="2571"/> 2571: <b>dots</b>(S) -&gt;
<a name="dots-last_expr"/><a name="2572"/> 2572:     [C || C &lt;- S, C =:= $\.].
<a name="2573"/> 2573: 
<a name="2574"/> 2574: -else. % WEAK
<a name="2575"/> 2575: 
<a name="2576"/> 2576: weak(S, R) -&gt;
<a name="2577"/> 2577:     mt(S, R).
<a name="2578"/> 2578: 
<a name="2579"/> 2579: -endif. % WEAK
<a name="2580"/> 2580: 
<a name="2581"/> 2581: <i>%% If EXACT is defined: mt() matches strings exactly.</i>
<a name="2582"/> 2582: <i>%%</i>
<a name="2583"/> 2583: <i>%% if EXACT is not defined: do not match the strings exactly, but</i>
<a name="2584"/> 2584: <i>%% compare them assuming that all map keys and all map values are</i>
<a name="2585"/> 2585: <i>%% equal (by assuming all map keys and all map values have the same</i>
<a name="2586"/> 2586: <i>%% length and begin with $k and $v respectively).</i>
<a name="2587"/> 2587: 
<a name="2588"/> 2588: <i>%-define(EXACT, true).</i>
<a name="2589"/> 2589: 
<a name="2590"/> 2590: <b>-ifdef</b>(EXACT).
<a name="2591"/> 2591: 
<a name="2592"/> 2592: mt(S, R) -&gt;
<a name="2593"/> 2593:     S =:= R.
<a name="2594"/> 2594: 
<a name="2595"/> 2595: -else. % EXACT
<a name="2596"/> 2596: 
<a name="mt-2"/><a name="2597"/> 2597: <b>mt</b>(S, R) -&gt;
<a name="mt-last_expr"/><a name="2598"/> 2598: <b>    anon</b>(S) =:= anon(R).
<a name="2599"/> 2599: 
<a name="anon-1"/><a name="2600"/> 2600: <b>anon</b>(S) -&gt;
<a name="2601"/> 2601:     {ok, Ts0, _} = erl_scan:string(S, 1, [text]),
<a name="2602"/> 2602:     Ts = anon1(Ts0),
<a name="anon-last_expr"/><a name="2603"/> 2603: <b>    text</b>(Ts).
<a name="2604"/> 2604: 
<a name="anon1-1"/><a name="2605"/> 2605: <b>anon1</b>([]) -&gt; [];
<a name="2606"/> 2606: <b>anon1</b>([{atom,Anno,Atom}=T|Ts]) -&gt;
<a name="2607"/> 2607:     case erl_anno:text(Anno) of
<a name="2608"/> 2608:         &quot;k&quot; ++ _ -&gt;
<a name="2609"/> 2609:             NewAnno = erl_anno:set_text(&quot;key&quot;, Anno),
<a name="2610"/> 2610:             [{atom,NewAnno,Atom}|anon1(Ts)];
<a name="2611"/> 2611:         &quot;v&quot; ++ _ -&gt;
<a name="2612"/> 2612:             NewAnno = erl_anno:set_text(&quot;val&quot;, Anno),
<a name="2613"/> 2613:             [{atom,NewAnno,Atom}|anon1(Ts)];
<a name="2614"/> 2614:         _ -&gt;
<a name="2615"/> 2615:             [T|anon1(Ts)]
<a name="2616"/> 2616:     end;
<a name="2617"/> 2617: <b>anon1</b>([T|Ts]) -&gt;
<a name="anon1-last_expr"/><a name="2618"/> 2618: <b>    [T|anon1</b>(Ts)].
<a name="2619"/> 2619: 
<a name="text-1"/><a name="2620"/> 2620: <b>text</b>(Ts) -&gt;
<a name="text-last_expr"/><a name="2621"/> 2621: <b>    lists:append</b>(text1(Ts)).
<a name="2622"/> 2622: 
<a name="text1-1"/><a name="2623"/> 2623: <b>text1</b>([]) -&gt; [];
<a name="2624"/> 2624: <b>text1</b>([T|Ts]) -&gt;
<a name="2625"/> 2625:     Anno = element(2, T),
<a name="text1-last_expr"/><a name="2626"/> 2626: <b>    [erl_anno:text</b>(Anno) | text1(Ts)].
<a name="2627"/> 2627: 
<a name="2628"/> 2628: -endif. % EXACT
<a name="2629"/> 2629: 
<a name="otp_14285-1"/><a name="2630"/> 2630: <b>otp_14285</b>(_Config) -&gt;
<a name="2631"/> 2631:     UOpts = [{record_print_fun, fun rfd/2},
<a name="2632"/> 2632:              {encoding, unicode}],
<a name="2633"/> 2633:     LOpts = [{record_print_fun, fun rfd/2},
<a name="2634"/> 2634:              {encoding, latin1}],
<a name="2635"/> 2635: 
<a name="2636"/> 2636:     RT = {'\x{400}','\x{400}'},
<a name="2637"/> 2637:     &quot;#'\x{400}'{'\x{400}' = '\x{400}'}&quot; = pretty(RT, UOpts),
<a name="2638"/> 2638:     &quot;#'\\x{400}'{'\\x{400}' = '\\x{400}'}&quot; = pretty(RT, LOpts),
<a name="2639"/> 2639: 
<a name="2640"/> 2640:     Chars = lists:seq(0, 512),
<a name="2641"/> 2641:     [] = [C ||
<a name="2642"/> 2642:              C &lt;- Chars,
<a name="2643"/> 2643:              S &lt;- io_lib:write_atom_as_latin1(list_to_atom([C])),
<a name="2644"/> 2644:              not is_latin1(S)],
<a name="2645"/> 2645:     L1 = [S || C &lt;- Chars, S &lt;- io_lib:write_atom(list_to_atom([C])),
<a name="2646"/> 2646:                not is_latin1(S)],
<a name="2647"/> 2647:     L1 = lists:seq(256, 512),
<a name="2648"/> 2648: 
<a name="2649"/> 2649:     latin1_fmt(&quot;~w&quot;, ['кирилли́ческий атом']),
<a name="2650"/> 2650:     latin1_fmt(&quot;~w&quot;, ['\x{10FFFF}']),
<a name="2651"/> 2651:     &quot;'кирилли́ческий атом'&quot; = fmt(&quot;~tw&quot;, ['кирилли́ческий атом']),
<a name="2652"/> 2652:     [$',16#10FFFF,$'] = fmt(&quot;~tw&quot;, ['\x{10FFFF}']),
<a name="2653"/> 2653: 
<a name="2654"/> 2654:     latin1_fmt(&quot;~W&quot;, ['кирилли́ческий атом', 13]),
<a name="2655"/> 2655:     latin1_fmt(&quot;~W&quot;, ['\x{10FFFF}', 13]),
<a name="2656"/> 2656:     &quot;'кирилли́ческий атом'&quot; = fmt(&quot;~tW&quot;, ['кирилли́ческий атом', 13]),
<a name="2657"/> 2657:     [$',16#10FFFF,$'] = fmt(&quot;~tW&quot;, ['\x{10FFFF}', 13]),
<a name="2658"/> 2658: 
<a name="2659"/> 2659:     {ok, [an_atom],[]} = io_lib:fread(&quot;~a&quot;, &quot;an_atom&quot;),
<a name="2660"/> 2660:     {ok, [an_atom],[]} = io_lib:fread(&quot;~ta&quot;, &quot;an_atom&quot;),
<a name="2661"/> 2661:     Str = &quot;\&quot;ab&quot; ++ [1089] ++ &quot;cd\&quot;&quot;,
<a name="2662"/> 2662:     {ok, [&quot;\&quot;ab&quot;], [1089]++&quot;cd\&quot;&quot;} = io_lib:fread(&quot;~s&quot;, Str),
<a name="2663"/> 2663:     {ok, ['\&quot;ab'], [1089]++&quot;cd\&quot;&quot;} = io_lib:fread(&quot;~a&quot;, Str),
<a name="2664"/> 2664:     {ok,[Str], []} = io_lib:fread(&quot;~ts&quot;, Str),
<a name="2665"/> 2665:     {ok,[Atom],[]} = io_lib:fread(&quot;~ta&quot;, Str),
<a name="2666"/> 2666:     Str = atom_to_list(Atom),
<a name="2667"/> 2667: 
<a name="otp_14285-last_expr"/><a name="2668"/> 2668:     ok.
<a name="2669"/> 2669: 
<a name="latin1_fmt-2"/><a name="2670"/> 2670: <b>latin1_fmt</b>(Fmt, Args) -&gt;
<a name="2671"/> 2671:     L = fmt(Fmt, Args),
<a name="latin1_fmt-last_expr"/><a name="2672"/> 2672: <b>    true = lists:all</b>(fun is_latin1/1, L).
<a name="2673"/> 2673: 
<a name="limit_term-1"/><a name="2674"/> 2674: <b>limit_term</b>(_Config) -&gt;
<a name="2675"/> 2675:     {_, 2} = limt([a,b,c], 2),
<a name="2676"/> 2676:     {_, 2} = limt([a,b,c], 3),
<a name="2677"/> 2677:     {_, 2} = limt([a,b|c], 2),
<a name="2678"/> 2678:     {_, 2} = limt([a,b|c], 3),
<a name="2679"/> 2679:     {_, 2} = limt({a,b,c,[d,e]}, 2),
<a name="2680"/> 2680:     {_, 2} = limt({a,b,c,[d,e]}, 3),
<a name="2681"/> 2681:     {_, 2} = limt({a,b,c,[d,e]}, 4),
<a name="2682"/> 2682:     T0 = [1|{a,b,c}],
<a name="2683"/> 2683:     {_, 2} = limt(T0, 2),
<a name="2684"/> 2684:     {_, 2} = limt(T0, 3),
<a name="2685"/> 2685:     {_, 2} = limt(T0, 4),
<a name="2686"/> 2686:     {_, 1} = limt(&lt;&lt;&quot;foo&quot;&gt;&gt;, 18),
<a name="2687"/> 2687:     {_, 2} = limt({&quot;&quot;,[1,2]}, 3),
<a name="2688"/> 2688:     {_, 2} = limt({&quot;&quot;,{1,2}}, 3),
<a name="2689"/> 2689:     true = limt_pp({&quot;123456789012345678901234567890&quot;,{1,2}}, 3),
<a name="2690"/> 2690:     ok = blimt(&lt;&lt;&quot;123456789012345678901234567890&quot;&gt;&gt;),
<a name="2691"/> 2691:     true = limt_pp(&lt;&lt;&quot;123456789012345678901234567890&quot;&gt;&gt;, 3),
<a name="2692"/> 2692:     {_, 2} = limt({&lt;&lt;&quot;kljlkjsl&quot;&gt;&gt;,[1,2,3,4]}, 4),
<a name="2693"/> 2693:     {_, 1} = limt(&lt;&lt;7:3&gt;&gt;, 2),
<a name="2694"/> 2694:     {_, 1} = limt(&lt;&lt;7:21&gt;&gt;, 2),
<a name="2695"/> 2695:     {_, 1} = limt([], 2),
<a name="2696"/> 2696:     {_, 1} = limt({}, 2),
<a name="2697"/> 2697:     {_, 1} = limt({&quot;&quot;, &quot;&quot;}, 4),
<a name="2698"/> 2698:     {_, 1} = limt(#{}, 2),
<a name="2699"/> 2699:     {_, 2} = limt(#{[] =&gt; {}}, 1),
<a name="2700"/> 2700:     {_, 2} = limt(#{[] =&gt; {}}, 2),
<a name="2701"/> 2701:     {_, 1} = limt(#{[] =&gt; {}}, 3),
<a name="2702"/> 2702:     T = #{[] =&gt; {},[a] =&gt; [b]},
<a name="2703"/> 2703:     {_, 1} = limt(T, 0),
<a name="2704"/> 2704:     {_, 2} = limt(T, 1),
<a name="2705"/> 2705:     {_, 2} = limt(T, 2),
<a name="2706"/> 2706:     {_, 2} = limt(T, 3),
<a name="2707"/> 2707:     {_, 1} = limt(T, 4),
<a name="2708"/> 2708:     T2 = #{[] =&gt; {},{} =&gt; []},
<a name="2709"/> 2709:     {_, 2} = limt(T2, 1),
<a name="2710"/> 2710:     {_, 2} = limt(T2, 2),
<a name="2711"/> 2711:     {_, 1} = limt(T2, 3),
<a name="limit_term-last_expr"/><a name="2712"/> 2712:     ok.
<a name="2713"/> 2713: 
<a name="blimt-1"/><a name="2714"/> 2714: <b>blimt</b>(Binary) -&gt;
<a name="blimt-last_expr"/><a name="2715"/> 2715: <b>    blimt</b>(Binary, byte_size(Binary)).
<a name="2716"/> 2716: 
<a name="blimt-2"/><a name="2717"/> 2717: <b>blimt</b>(_B, 1) -&gt; ok;
<a name="2718"/> 2718: <b>blimt</b>(B, D) -&gt;
<a name="2719"/> 2719:     {_, 1} = limt(B, D),
<a name="blimt-last_expr"/><a name="2720"/> 2720: <b>    blimt</b>(B, D - 1).
<a name="2721"/> 2721: 
<a name="limt-2"/><a name="2722"/> 2722: <b>limt</b>(Term, Depth) when is_integer(Depth) -&gt;
<a name="2723"/> 2723:     T1 = io_lib:limit_term(Term, Depth),
<a name="2724"/> 2724:     S = form(Term, Depth),
<a name="2725"/> 2725:     S1 = form(T1, Depth),
<a name="2726"/> 2726:     OK1 = S1 =:= S,
<a name="2727"/> 2727: 
<a name="2728"/> 2728:     T2 = io_lib:limit_term(Term, Depth+1),
<a name="2729"/> 2729:     S2 = form(T2, Depth),
<a name="2730"/> 2730:     OK2 = S2 =:= S,
<a name="2731"/> 2731: 
<a name="2732"/> 2732:     T3 = io_lib:limit_term(Term, Depth-1),
<a name="2733"/> 2733:     S3 = form(T3, Depth),
<a name="2734"/> 2734:     OK3 = S3 =/= S,
<a name="2735"/> 2735: 
<a name="2736"/> 2736:     R = case {OK1, OK2, OK3} of
<a name="2737"/> 2737:             {true, true, true} -&gt; 2;
<a name="2738"/> 2738:             {true, true, false} -&gt; 1;
<a name="2739"/> 2739:             _ -&gt; 0
<a name="2740"/> 2740:         end,
<a name="limt-last_expr"/><a name="2741"/> 2741:     {{S, S1, S2}, R}.
<a name="2742"/> 2742: 
<a name="form-2"/><a name="2743"/> 2743: <b>form</b>(Term, Depth) -&gt;
<a name="form-last_expr"/><a name="2744"/> 2744: <b>    lists:flatten</b>(io_lib:format(&quot;~W&quot;, [Term, Depth])).
<a name="2745"/> 2745: 
<a name="limt_pp-2"/><a name="2746"/> 2746: <b>limt_pp</b>(Term, Depth) when is_integer(Depth) -&gt;
<a name="2747"/> 2747:     T1 = io_lib:limit_term(Term, Depth),
<a name="2748"/> 2748:     S = pp(Term, Depth),
<a name="2749"/> 2749:     S1 = pp(T1, Depth),
<a name="limt_pp-last_expr"/><a name="2750"/> 2750:     S1 =:= S.
<a name="2751"/> 2751: 
<a name="pp-2"/><a name="2752"/> 2752: <b>pp</b>(Term, Depth) -&gt;
<a name="pp-last_expr"/><a name="2753"/> 2753: <b>    lists:flatten</b>(io_lib:format(&quot;~P&quot;, [Term, Depth])).
<a name="2754"/> 2754: 
<a name="otp_14983-1"/><a name="2755"/> 2755: <b>otp_14983</b>(_Config) -&gt;
<a name="2756"/> 2756:     trunc_depth(-1, fun trp/3),
<a name="2757"/> 2757:     trunc_depth(10, fun trp/3),
<a name="2758"/> 2758:     trunc_depth(-1, fun trw/3),
<a name="2759"/> 2759:     trunc_depth(10, fun trw/3),
<a name="2760"/> 2760:     trunc_depth_p(-1),
<a name="2761"/> 2761:     trunc_depth_p(10),
<a name="2762"/> 2762:     trunc_string(),
<a name="otp_14983-last_expr"/><a name="2763"/> 2763:     ok.
<a name="2764"/> 2764: 
<a name="trunc_string-0"/><a name="2765"/> 2765: <b>trunc_string</b>() -&gt;
<a name="2766"/> 2766:     &quot;str &quot; = trf(&quot;str &quot;, [], 10),
<a name="2767"/> 2767:     &quot;str str&quot; = trf(&quot;str ~s&quot;, [&quot;str&quot;], 6),
<a name="2768"/> 2768:     &quot;str ...&quot; = trf(&quot;str ~s&quot;, [&quot;str1&quot;], 6),
<a name="2769"/> 2769:     &quot;str str&quot; = trf(&quot;str ~s&quot;, [&quot;str&quot;], 7),
<a name="2770"/> 2770:     &quot;str str&quot; = trf(&quot;str ~8s&quot;, [&quot;str&quot;], 6),
<a name="2771"/> 2771:     &quot;str ...&quot; = trf(&quot;str ~8s&quot;, [&quot;str1&quot;], 6),
<a name="2772"/> 2772:     {ok, UPeer, UNode} = ?CT_PEER([&quot;+pc&quot;, &quot;unicode&quot;]),
<a name="2773"/> 2773:     U = &quot;кирилли́ческий атом&quot;,
<a name="2774"/> 2774:     UFun = fun(Format, Args, CharsLimit) -&gt;
<a name="2775"/> 2775:                    rpc:call(UNode,
<a name="2776"/> 2776:                             ?MODULE, trf, [Format, Args, CharsLimit])
<a name="2777"/> 2777:            end,
<a name="2778"/> 2778:     &quot;str кир&quot; = UFun(&quot;str ~3ts&quot;, [U], 7),
<a name="2779"/> 2779:     &quot;str ...&quot; = UFun(&quot;str ~3ts&quot;, [U], 6),
<a name="2780"/> 2780:     &quot;str ...&quot; = UFun(&quot;str ~30ts&quot;, [U], 6),
<a name="2781"/> 2781:     &quot;str кир...&quot; = UFun(&quot;str ~30ts&quot;, [U], 10),
<a name="2782"/> 2782:     &quot;str кирилл...&quot; = UFun(&quot;str ~30ts&quot;, [U], 13),
<a name="2783"/> 2783:     &quot;str кирилли́...&quot; = UFun(&quot;str ~30ts&quot;, [U], 14),
<a name="2784"/> 2784:     &quot;str кирилли́ч...&quot; = UFun(&quot;str ~30ts&quot;, [U], 15),
<a name="2785"/> 2785:     &quot;\&quot;кирилли́ческ\&quot;...&quot; = UFun(&quot;~tp&quot;, [U], 13),
<a name="2786"/> 2786:     BU = &lt;&lt;&quot;кирилли́ческий атом&quot;/utf8&gt;&gt;,
<a name="2787"/> 2787:     &quot;&lt;&lt;\&quot;кирилли́\&quot;/utf8...&gt;&gt;&quot; = UFun(&quot;~tp&quot;, [BU], 20),
<a name="2788"/> 2788:     &quot;&lt;&lt;\&quot;кирилли́\&quot;/utf8...&gt;&gt;&quot; = UFun(&quot;~tp&quot;, [BU], 21),
<a name="2789"/> 2789:     &quot;&lt;&lt;\&quot;кирилли́ческ\&quot;/utf8...&gt;&gt;&quot; = UFun(&quot;~tp&quot;, [BU], 22),
<a name="trunc_string-last_expr"/><a name="2790"/> 2790: <b>    peer:stop</b>(UPeer).
<a name="2791"/> 2791: 
<a name="trunc_depth-2"/><a name="2792"/> 2792: <b>trunc_depth</b>(D, Fun) -&gt;
<a name="2793"/> 2793:     &quot;...&quot; = Fun(&quot;&quot;, D, 0),
<a name="2794"/> 2794:     &quot;[]&quot; = Fun(&quot;&quot;, D, 1),
<a name="2795"/> 2795: 
<a name="2796"/> 2796:     &quot;#{}&quot; = Fun(#{}, D, 1),
<a name="2797"/> 2797:     &quot;#{a =&gt; 1}&quot; = Fun(#{a =&gt; 1}, D, 7),
<a name="2798"/> 2798:     &quot;#{...}&quot; = Fun(#{a =&gt; 1}, D, 5),
<a name="2799"/> 2799:     &quot;#{a =&gt; 1}&quot; = Fun(#{a =&gt; 1}, D, 6),
<a name="2800"/> 2800:     A = lists:seq(1, 1000),
<a name="2801"/> 2801:     M = #{A =&gt; A, {A,A} =&gt; {A,A}},
<a name="2802"/> 2802:     &quot;#{...}&quot; = Fun(M, D, 6),
<a name="2803"/> 2803:     &quot;#{{...} =&gt; {...},...}&quot; = Fun(M, D, 7),
<a name="2804"/> 2804:     &quot;#{{[...],...} =&gt; {[...],...},...}&quot; = Fun(M, D, 22),
<a name="2805"/> 2805:     &quot;#{{[...],...} =&gt; {[...],...},[...] =&gt; [...]}&quot; = Fun(M, D, 31),
<a name="2806"/> 2806:     &quot;#{{[...],...} =&gt; {[...],...},[1|...] =&gt; [...]}&quot; = Fun(M, D, 33),
<a name="2807"/> 2807:     &quot;#{{[1|...],[...]} =&gt; {[1|...],[...]},[1,2|...] =&gt; [...]}&quot; =
<a name="2808"/> 2808:         Fun(M, D, 50),
<a name="2809"/> 2809: 
<a name="2810"/> 2810:     &quot;...&quot; = Fun({c, 1, 2}, D, 0),
<a name="2811"/> 2811:     &quot;{...}&quot; = Fun({c, 1, 2}, D, 1),
<a name="2812"/> 2812: 
<a name="2813"/> 2813:     &quot;...&quot; = Fun({}, D, 0),
<a name="2814"/> 2814:     &quot;{}&quot; = Fun({}, D, 1),
<a name="2815"/> 2815:     T = {A, A, A},
<a name="2816"/> 2816:     &quot;{...}&quot; = Fun(T, D, 5),
<a name="2817"/> 2817:     &quot;{[...],...}&quot; = Fun(T, D, 6),
<a name="2818"/> 2818:     &quot;{[1|...],[...],...}&quot; = Fun(T, D, 12),
<a name="2819"/> 2819:     &quot;{[1,2|...],[1|...],...}&quot; = Fun(T, D, 20),
<a name="2820"/> 2820:     &quot;{[1,2|...],[1|...],[...]}&quot; = Fun(T, D, 21),
<a name="2821"/> 2821:     &quot;{[1,2,3|...],[1,2|...],[1|...]}&quot; = Fun(T, D, 28),
<a name="2822"/> 2822: 
<a name="trunc_depth-last_expr"/><a name="2823"/> 2823: <b>    &quot;{[1],[1,2|...]}&quot; = Fun</b>({[1],[1,2,3,4]}, D, 14).
<a name="2824"/> 2824: 
<a name="trunc_depth_p-1"/><a name="2825"/> 2825: <b>trunc_depth_p</b>(D) -&gt;
<a name="2826"/> 2826:     UOpts = [{record_print_fun, fun rfd/2},
<a name="2827"/> 2827:              {encoding, unicode}],
<a name="2828"/> 2828:     LOpts = [{record_print_fun, fun rfd/2},
<a name="2829"/> 2829:              {encoding, latin1}],
<a name="2830"/> 2830:     trunc_depth_p(D, UOpts),
<a name="trunc_depth_p-last_expr"/><a name="2831"/> 2831: <b>    trunc_depth_p</b>(D, LOpts).
<a name="2832"/> 2832: 
<a name="trunc_depth_p-2"/><a name="2833"/> 2833: <b>trunc_depth_p</b>(D, Opts) -&gt;
<a name="2834"/> 2834:     &quot;[...]&quot; = trp(&quot;abcdefg&quot;, D, 4, Opts),
<a name="2835"/> 2835:     &quot;\&quot;abc\&quot;...&quot; = trp(&quot;abcdefg&quot;, D, 5, Opts),
<a name="2836"/> 2836:     &quot;\&quot;abcdef\&quot;...&quot; = trp(&quot;abcdefg&quot;, D, 8, Opts),
<a name="2837"/> 2837:     &quot;\&quot;abcdefg\&quot;&quot; = trp(&quot;abcdefg&quot;, D, 9, Opts),
<a name="2838"/> 2838:     &quot;\&quot;abcdefghijkl\&quot;&quot; = trp(&quot;abcdefghijkl&quot;, D, -1, Opts),
<a name="2839"/> 2839:     AZ = lists:seq($A, $Z),
<a name="2840"/> 2840:     AZb = list_to_binary(AZ),
<a name="2841"/> 2841:     AZbS = &quot;&lt;&lt;\&quot;&quot; ++ AZ ++ &quot;\&quot;&gt;&gt;&quot;,
<a name="2842"/> 2842:     AZbS = trp(AZb, D, -1),
<a name="2843"/> 2843:     &quot;&lt;&lt;\&quot;ABCDEFGH\&quot;...&gt;&gt;&quot; = trp(AZb, D, 17, Opts), % 4 chars even if D = -1...
<a name="2844"/> 2844:     &quot;&lt;&lt;\&quot;ABCDEFGHIJKL\&quot;...&gt;&gt;&quot; = trp(AZb, D, 18, Opts),
<a name="2845"/> 2845:     B1 = &lt;&lt;&quot;abcdef&quot;,0:8&gt;&gt;,
<a name="2846"/> 2846:     &quot;&lt;&lt;\&quot;ab\&quot;...&gt;&gt;&quot; = trp(B1, D, 8, Opts),
<a name="2847"/> 2847:     &quot;&lt;&lt;\&quot;abcdef\&quot;...&gt;&gt;&quot; = trp(B1, D, 14, Opts),
<a name="2848"/> 2848:     &quot;&lt;&lt;97,98,99,100,...&gt;&gt;&quot; = trp(B1, D, 16, Opts),
<a name="2849"/> 2849:     &quot;&lt;&lt;97,98,99,100,101,102,0&gt;&gt;&quot; = trp(B1, D, -1, Opts),
<a name="2850"/> 2850:     B2 = &lt;&lt;AZb/binary,0:8&gt;&gt;,
<a name="2851"/> 2851:     &quot;&lt;&lt;\&quot;AB\&quot;...&gt;&gt;&quot; = trp(B2, D, 8, Opts),
<a name="2852"/> 2852:     &quot;&lt;&lt;\&quot;ABCDEFGH\&quot;...&gt;&gt;&quot; = trp(B2, D, 14, Opts),
<a name="2853"/> 2853:     &quot;&lt;&lt;65,66,67,68,69,70,71,72,0&gt;&gt;&quot; = trp(&lt;&lt;&quot;ABCDEFGH&quot;,0:8&gt;&gt;, D, -1, Opts),
<a name="2854"/> 2854:     &quot;&lt;&lt;97,0,107,108,...&gt;&gt;&quot; = trp(&lt;&lt;&quot;a&quot;,0:8,&quot;kllkjlksdjfsj&quot;&gt;&gt;, D, 20, Opts),
<a name="2855"/> 2855: 
<a name="2856"/> 2856:     A = lists:seq(1, 1000),
<a name="2857"/> 2857:     &quot;#c{...}&quot; = trp({c, 1, 2}, D, 6),
<a name="2858"/> 2858:     &quot;#c{...}&quot; = trp({c, 1, 2}, D, 7),
<a name="2859"/> 2859:     &quot;#c{f1 = [...],...}&quot; = trp({c, A, A}, D, 18),
<a name="2860"/> 2860:     &quot;#c{f1 = [1|...],f2 = [...]}&quot; = trp({c, A, A}, D, 19),
<a name="2861"/> 2861:     &quot;#c{f1 = [1,2|...],f2 = [1|...]}&quot; = trp({c, A, A}, D, 31),
<a name="trunc_depth_p-last_expr"/><a name="2862"/> 2862: <b>    &quot;#c{f1 = [1,2,3|...],f2 = [1,2|...]}&quot; = trp</b>({c, A, A}, D, 32).
<a name="2863"/> 2863: 
<a name="trp-3"/><a name="2864"/> 2864: <b>trp</b>(Term, D, T) -&gt;
<a name="trp-last_expr"/><a name="2865"/> 2865: <b>    trp</b>(Term, D, T, [{record_print_fun, fun rfd/2}]).
<a name="2866"/> 2866: 
<a name="trp-4"/><a name="2867"/> 2867: <b>trp</b>(Term, D, T, Opts) -&gt;
<a name="2868"/> 2868:     R = io_lib_pretty:print(Term, [{depth, D},
<a name="2869"/> 2869:                                    {chars_limit, T}|Opts]),
<a name="trp-last_expr"/><a name="2870"/> 2870: <b>    lists:flatten</b>(io_lib:format(&quot;~s&quot;, [R])).
<a name="2871"/> 2871: 
<a name="trw-3"/><a name="2872"/> 2872: <b>trw</b>(Term, D, T) -&gt;
<a name="trw-last_expr"/><a name="2873"/> 2873: <b>    lists:flatten</b>(io_lib:format(&quot;~W&quot;, [Term, D], [{chars_limit, T}])).
<a name="2874"/> 2874: 
<a name="trf-3"/><a name="2875"/> 2875: <b>trf</b>(Format, Args, T) -&gt;
<a name="trf-last_expr"/><a name="2876"/> 2876: <b>    trf</b>(Format, Args, T, [{record_print_fun, fun rfd/2}]).
<a name="2877"/> 2877: 
<a name="trf-4"/><a name="2878"/> 2878: <b>trf</b>(Format, Args, T, Opts) -&gt;
<a name="trf-last_expr"/><a name="2879"/> 2879: <b>    lists:flatten</b>(io_lib:format(Format, Args, [{chars_limit, T}|Opts])).
<a name="2880"/> 2880: 
<a name="otp_15103-1"/><a name="2881"/> 2881: <b>otp_15103</b>(_Config) -&gt;
<a name="2882"/> 2882:     T = lists:duplicate(5, {a,b,c}),
<a name="2883"/> 2883: 
<a name="2884"/> 2884:     S1 = io_lib:format(&quot;~0p&quot;, [T]),
<a name="2885"/> 2885:     &quot;[{a,b,c},{a,b,c},{a,b,c},{a,b,c},{a,b,c}]&quot; = lists:flatten(S1),
<a name="2886"/> 2886:     S2 = io_lib:format(&quot;~-0p&quot;, [T]),
<a name="2887"/> 2887:     &quot;[{a,b,c},{a,b,c},{a,b,c},{a,b,c},{a,b,c}]&quot; = lists:flatten(S2),
<a name="2888"/> 2888:     S3 = io_lib:format(&quot;~1p&quot;, [T]),
<a name="2889"/> 2889:     &quot;[{a,\n  b,\n  c},\n {a,\n  b,\n  c},\n {a,\n  b,\n  c},\n {a,\n  b,\n&quot;
<a name="2890"/> 2890:     &quot;  c},\n {a,\n  b,\n  c}]&quot; = lists:flatten(S3),
<a name="2891"/> 2891: 
<a name="2892"/> 2892:     S4 = io_lib:format(&quot;~0P&quot;, [T, 5]),
<a name="2893"/> 2893:     &quot;[{a,b,c},{a,b,...},{a,...},{...}|...]&quot; = lists:flatten(S4),
<a name="2894"/> 2894:     S5 = io_lib:format(&quot;~1P&quot;, [T, 5]),
<a name="2895"/> 2895:     &quot;[{a,\n  b,\n  c},\n {a,\n  b,...},\n {a,...},\n {...}|...]&quot; =
<a name="2896"/> 2896:         lists:flatten(S5),
<a name="otp_15103-last_expr"/><a name="2897"/> 2897:     ok.
<a name="2898"/> 2898: 
<a name="otp_15159-1"/><a name="2899"/> 2899: <b>otp_15159</b>(_Config) -&gt;
<a name="2900"/> 2900:     &quot;[atom]&quot; =
<a name="2901"/> 2901:         lists:flatten(io_lib:format(&quot;~p&quot;, [[atom]], [{chars_limit,5}])),
<a name="otp_15159-last_expr"/><a name="2902"/> 2902:     ok.
<a name="2903"/> 2903: 
<a name="otp_15076-1"/><a name="2904"/> 2904: <b>otp_15076</b>(_Config) -&gt;
<a name="2905"/> 2905:     {'EXIT', {badarg, _}} = (catch io_lib:format(&quot;~c&quot;, [a])),
<a name="2906"/> 2906:     L = io_lib:scan_format(&quot;~c&quot;, [a]),
<a name="2907"/> 2907:     {&quot;~c&quot;, [a]} = io_lib:unscan_format(L),
<a name="2908"/> 2908:     {'EXIT', {badarg, _}} = (catch io_lib:build_text(L)),
<a name="2909"/> 2909:     {'EXIT', {badarg, _}} = (catch io_lib:build_text(L, [])),
<a name="otp_15076-last_expr"/><a name="2910"/> 2910:     ok.
<a name="2911"/> 2911: 
<a name="otp_15639-1"/><a name="2912"/> 2912: <b>otp_15639</b>(_Config) -&gt;
<a name="2913"/> 2913:     L = lists:duplicate(10, &quot;a&quot;),
<a name="2914"/> 2914:     LOpts = [{encoding, latin1},  {chars_limit, 10}],
<a name="2915"/> 2915:     UOpts = [{encoding, unicode}, {chars_limit, 10}],
<a name="2916"/> 2916:     &quot;[[...]|...]&quot; = pretty(L, LOpts),
<a name="2917"/> 2917:     &quot;[[...]|...]&quot; = pretty(L, UOpts),
<a name="2918"/> 2918:     &quot;[\&quot;a\&quot;,[...]|...]&quot; =
<a name="2919"/> 2919:         pretty(L, [{chars_limit, 12}, {encoding, latin1}]),
<a name="2920"/> 2920:     &quot;[\&quot;a\&quot;,[...]|...]&quot; =
<a name="2921"/> 2921:         pretty(L, [{chars_limit, 12}, {encoding, unicode}]),
<a name="2922"/> 2922: 
<a name="2923"/> 2923:     %% Latin-1
<a name="2924"/> 2924:     &quot;\&quot;12345678\&quot;&quot; = pretty(&quot;12345678&quot;, LOpts),
<a name="2925"/> 2925:     &quot;\&quot;12345678\&quot;...&quot; = pretty(&quot;123456789&quot;, LOpts),
<a name="2926"/> 2926:     &quot;\&quot;\\r\\n123456\&quot;...&quot; = pretty(&quot;\r\n1234567&quot;, LOpts),
<a name="2927"/> 2927:     &quot;\&quot;\\r1234567\&quot;...&quot; = pretty(&quot;\r12345678&quot;, LOpts),
<a name="2928"/> 2928:     &quot;\&quot;\\r\\n123456\&quot;...&quot; = pretty(&quot;\r\n12345678&quot;, LOpts),
<a name="2929"/> 2929:     &quot;\&quot;12345678\&quot;...&quot; = pretty(&quot;12345678&quot;++[x], LOpts),
<a name="2930"/> 2930:     &quot;[49,50|...]&quot; = pretty(&quot;1234567&quot;++[x], LOpts),
<a name="2931"/> 2931:     &quot;[49,x]&quot; = pretty(&quot;1&quot;++[x], LOpts),
<a name="2932"/> 2932:     &quot;[[...]|...]&quot; = pretty([&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;], LOpts),
<a name="2933"/> 2933:     %% Unicode
<a name="2934"/> 2934:     &quot;\&quot;12345678\&quot;&quot; = pretty(&quot;12345678&quot;, UOpts),
<a name="2935"/> 2935:     &quot;\&quot;12345678\&quot;...&quot; = pretty(&quot;123456789&quot;, UOpts),
<a name="2936"/> 2936:     &quot;\&quot;\\r\\n1234567\&quot;&quot; = pretty(&quot;\r\n1234567&quot;, UOpts),
<a name="2937"/> 2937:     &quot;\&quot;\\r1234567\&quot;...&quot; = pretty(&quot;\r12345678&quot;, UOpts),
<a name="2938"/> 2938:     &quot;\&quot;\\r\\n1234567\&quot;...&quot; = pretty(&quot;\r\n12345678&quot;, UOpts),
<a name="2939"/> 2939:     &quot;[49,50|...]&quot; = pretty(&quot;12345678&quot;++[x], UOpts),
<a name="2940"/> 2940:     &quot;\&quot;12345678\&quot;...&quot; = pretty(&quot;123456789&quot;++[x], UOpts),
<a name="2941"/> 2941:     &quot;[[...]|...]&quot; = pretty([&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;], UOpts),
<a name="otp_15639-last_expr"/><a name="2942"/> 2942:     ok.
<a name="2943"/> 2943: 
<a name="otp_15705-1"/><a name="2944"/> 2944: <b>otp_15705</b>(_Config) -&gt;
<a name="2945"/> 2945:     L = [&lt;&lt;&quot;an&quot;&gt;&gt;,[&quot;at&quot;],[[&quot;om&quot;]]],
<a name="2946"/> 2946:     &quot;...&quot; = trf(&quot;~s&quot;, [L], 0),
<a name="2947"/> 2947:     &quot;...&quot; = trf(&quot;~s&quot;, [L], 1),
<a name="2948"/> 2948:     &quot;...&quot; = trf(&quot;~s&quot;, [L], 2),
<a name="2949"/> 2949:     &quot;...&quot; = trf(&quot;~s&quot;, [L], 3),
<a name="2950"/> 2950:     &quot;a...&quot; = trf(&quot;~s&quot;, [L], 4),
<a name="2951"/> 2951:     &quot;an...&quot; = trf(&quot;~s&quot;, [L], 5),
<a name="2952"/> 2952:     &quot;anatom&quot; = trf(&quot;~s&quot;, [L], 6),
<a name="2953"/> 2953:     L2 = [&quot;a&quot;,[&lt;&lt;&quot;na&quot;&gt;&gt;],[[&quot;tom&quot;]]],
<a name="2954"/> 2954:     &quot;...&quot; = trf(&quot;~s&quot;, [L2], 3),
<a name="2955"/> 2955:     &quot;a...&quot; = trf(&quot;~s&quot;, [L2], 4),
<a name="2956"/> 2956:     &quot;an...&quot; = trf(&quot;~s&quot;, [L2], 5),
<a name="2957"/> 2957:     &quot;anatom&quot; = trf(&quot;~s&quot;, [L2], 6),
<a name="2958"/> 2958: 
<a name="2959"/> 2959:     A = [[&lt;&lt;&quot;äpple&quot;/utf8&gt;&gt;, &quot;plus&quot;, &lt;&lt;&quot;äpple&quot;&gt;&gt;]],
<a name="2960"/> 2960:     &quot;äp...&quot; = trf(&quot;~ts&quot;, [A], 5),
<a name="2961"/> 2961:     &quot;äppleplusäpple&quot; = trf(&quot;~ts&quot;, [A], 14),
<a name="2962"/> 2962:     U = [[&quot;ки&quot;],&quot;рилл&quot;,&quot;и́ческий атом&quot;],
<a name="2963"/> 2963:     &quot;ки...&quot; = trf(&quot;~ts&quot;, [U], 5),
<a name="2964"/> 2964:     &quot;кирилли́ческий...&quot; = trf(&quot;~ts&quot;, [U], 16),
<a name="2965"/> 2965:     &quot;кирилли́ческий атом&quot; = trf(&quot;~ts&quot;, [U], 20),
<a name="2966"/> 2966: 
<a name="2967"/> 2967:     &quot;|кирилли́чес|&quot; = trf(&quot;|~10ts|&quot;, [U], -1),
<a name="otp_15705-last_expr"/><a name="2968"/> 2968:     ok.
<a name="2969"/> 2969: 
<a name="otp_15847-1"/><a name="2970"/> 2970: <b>otp_15847</b>(_Config) -&gt;
<a name="2971"/> 2971:     T = {someRecord,&lt;&lt;&quot;1234567890&quot;&gt;&gt;,some,more},
<a name="2972"/> 2972:     &quot;{someRecord,&lt;&lt;...&gt;&gt;,...}&quot; =
<a name="2973"/> 2973:         pretty(T, [{chars_limit,20}, {encoding,latin1}]),
<a name="otp_15847-last_expr"/><a name="2974"/> 2974:     ok.
<a name="2975"/> 2975: 
<a name="otp_15875-1"/><a name="2976"/> 2976: <b>otp_15875</b>(_Config) -&gt;
<a name="2977"/> 2977:     %% This test is moot due to the fix in GH-4842.
<a name="2978"/> 2978:     S = io_lib:format(&quot;~tp&quot;, [[{0, [&lt;&lt;&quot;00&quot;&gt;&gt;]}]], [{chars_limit, 18}]),
<a name="otp_15875-last_expr"/><a name="2979"/> 2979: <b>    &quot;[{0,[&lt;&lt;\&quot;00\&quot;&gt;&gt;]}]&quot; = lists:flatten</b>(S).
<a name="2980"/> 2980: 
<a name="2981"/> 2981: 
<a name="github_4801-1"/><a name="2982"/> 2982: <b>github_4801</b>(_Config) -&gt;
<a name="github_4801-last_expr"/><a name="2983"/> 2983: <b>	  &lt;&lt;&quot;{[81.6]}&quot;&gt;&gt; = iolist_to_binary</b>(io_lib:format(&quot;~p&quot;, [{[81.6]}], [{chars_limit,40}])).
<a name="2984"/> 2984: 
<a name="2985"/> 2985: <i>%% GH-4824, GH-4842, OTP-17459.</i>
<a name="chars_limit-1"/><a name="2986"/> 2986: <b>chars_limit</b>(_Config) -&gt;
<a name="2987"/> 2987:     List = fun R(I) -&gt;
<a name="2988"/> 2988:                    case I =:= 0 of true -&gt; 0; false -&gt; [I, R(I-1)] end
<a name="2989"/> 2989:            end,
<a name="2990"/> 2990:     Tuple = fun R(I) -&gt;
<a name="2991"/> 2991:                    case I =:= 0 of true -&gt; 0; false -&gt; {I, R(I-1)} end
<a name="2992"/> 2992:            end,
<a name="2993"/> 2993:     Map = fun R(I) -&gt;
<a name="2994"/> 2994:                    case I =:= 0 of true -&gt; 0; false -&gt; #{I =&gt; R(I-1)} end
<a name="2995"/> 2995:            end,
<a name="2996"/> 2996:     Record = fun R(I) -&gt;
<a name="2997"/> 2997:                    case I =:= 0 of true -&gt; 0; false -&gt; {b, R(I-1)} end
<a name="2998"/> 2998:            end,
<a name="2999"/> 2999:     Test = fun (F, N, Lim) -&gt;
<a name="3000"/> 3000:                    Opts = [{chars_limit, Lim},
<a name="3001"/> 3001:                            {record_print_fun, fun rfd/2}],
<a name="3002"/> 3002:                    [_|_] = io_lib_pretty:print(F(N), Opts)
<a name="3003"/> 3003:            end,
<a name="3004"/> 3004:     %% Used to loop:
<a name="3005"/> 3005:     Test(List, 1000, 1000),
<a name="3006"/> 3006:     Test(Tuple, 1000, 1000),
<a name="3007"/> 3007:     Test(Map, 1000, 1000),
<a name="3008"/> 3008:     Test(Record, 1000, 1000),
<a name="3009"/> 3009: 
<a name="3010"/> 3010:     %% Misc sizes and char limits:
<a name="3011"/> 3011:     _ = [Test(What, N, CL) ||
<a name="3012"/> 3012:             N &lt;- lists:seq(1, 50),
<a name="3013"/> 3013:             CL &lt;- lists:seq(N, N*3),
<a name="3014"/> 3014:             What &lt;- [List, Tuple, Map, Record]
<a name="3015"/> 3015:         ],
<a name="chars_limit-last_expr"/><a name="3016"/> 3016:     ok.
<a name="3017"/> 3017: 
<a name="error_info-1"/><a name="3018"/> 3018: <b>error_info</b>(Config) -&gt;
<a name="3019"/> 3019: 
<a name="3020"/> 3020:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="3021"/> 3021:     TmpFile = filename:join(PrivDir,?FUNCTION_NAME),
<a name="3022"/> 3022: 
<a name="3023"/> 3023:     FullDev =
<a name="3024"/> 3024:         fun() -&gt;
<a name="3025"/> 3025:                 case file:read_file_info(&quot;/dev/full&quot;) of
<a name="3026"/> 3026:                     {ok, _} -&gt;
<a name="3027"/> 3027:                         {ok, Dev} = file:open(&quot;/dev/full&quot;, [write]),
<a name="3028"/> 3028:                         Dev;
<a name="3029"/> 3029:                     _ -&gt;
<a name="3030"/> 3030:                         dummy_full_device()
<a name="3031"/> 3031:                 end
<a name="3032"/> 3032:         end,
<a name="3033"/> 3033: 
<a name="3034"/> 3034:     UnknownDev = fun dummy_unknown_error_device/0,
<a name="3035"/> 3035: 
<a name="3036"/> 3036:     Latin1Dev = fun() -&gt;
<a name="3037"/> 3037:                         {ok, Dev} = file:open(TmpFile, [read, write, {encoding, latin1}]),
<a name="3038"/> 3038:                         Dev
<a name="3039"/> 3039:                 end,
<a name="3040"/> 3040: 
<a name="3041"/> 3041:     UnicodeDev = fun() -&gt;
<a name="3042"/> 3042:                         {ok, Dev} = file:open(TmpFile, [read, write, {encoding, unicode}]),
<a name="3043"/> 3043:                         Dev
<a name="3044"/> 3044:                 end,
<a name="3045"/> 3045: 
<a name="3046"/> 3046:     DeadDev = spawn(fun() -&gt; ok end),
<a name="3047"/> 3047: 
<a name="3048"/> 3048:     UserDev = fun() -&gt; whereis(user) end,
<a name="3049"/> 3049:     FileDev = FullDev,
<a name="3050"/> 3050:     TestServerDev = fun() -&gt; group_leader() end,
<a name="3051"/> 3051:     ApplicationMasterDev =
<a name="3052"/> 3052:         fun() -&gt;
<a name="3053"/> 3053:                 {_,GL} = process_info(whereis(kernel_sup),group_leader),
<a name="3054"/> 3054:                 GL
<a name="3055"/> 3055:         end,
<a name="3056"/> 3056:     GroupDev = TestServerDev,
<a name="3057"/> 3057:     StandardError = fun() -&gt; whereis(standard_error) end,
<a name="3058"/> 3058: 
<a name="3059"/> 3059:     L = [
<a name="3060"/> 3060:          {put_chars,[DeadDev,&quot;test&quot;],[{1,&quot;terminated&quot;}]},
<a name="3061"/> 3061:          {put_chars,[&quot;test&quot;],[{gl,DeadDev},{general,&quot;terminated&quot;}]},
<a name="3062"/> 3062:          {put_chars,[?MODULE,&quot;test&quot;],[{1,&quot;does not exist&quot;}]},
<a name="3063"/> 3063:          {put_chars,[FullDev(),&quot;test&quot;], [{1,&quot;no space left on device&quot;}]},
<a name="3064"/> 3064:          {put_chars,[&quot;test&quot;], [{gl,FullDev()},{general,&quot;no space left on device&quot;}]},
<a name="3065"/> 3065:          {put_chars,[Latin1Dev(),&quot;Спутник-1&quot;], [{1,&quot;transcode&quot;}]},
<a name="3066"/> 3066:          {put_chars,[a], [{1,&quot;not valid character data&quot;}]},
<a name="3067"/> 3067:          {put_chars,[UnicodeDev(), &lt;&lt;222&gt;&gt;], [{1,&quot;transcode&quot;}]},
<a name="3068"/> 3068:          {put_chars,[&lt;&lt;1:1&gt;&gt;], [{1,&quot;not valid character data&quot;}]},
<a name="3069"/> 3069:          {put_chars,[UnknownDev(),&quot;test&quot;], [{general,&quot;unknown error: 'Спутник-1'&quot;}]},
<a name="3070"/> 3070:          {put_chars,[&quot;test&quot;], [{gl,UnknownDev()},{general,&quot;unknown error: 'Спутник-1'&quot;}]},
<a name="3071"/> 3071:          {put_chars,[self(),&quot;test&quot;],[{1,&quot;the device is not allowed to be the current process&quot;}]},
<a name="3072"/> 3072:          {put_chars,[&quot;test&quot;],[{gl,self()},{general,&quot;the device is not allowed to be the current process&quot;}]},
<a name="3073"/> 3073: 
<a name="3074"/> 3074:          {write,[DeadDev,&quot;test&quot;],[{1,&quot;terminated&quot;}]},
<a name="3075"/> 3075:          {write,[&quot;test&quot;],[{gl,DeadDev},{general,&quot;terminated&quot;}]},
<a name="3076"/> 3076:          {write,[?MODULE,&quot;test&quot;],[{1,&quot;does not exist&quot;}]},
<a name="3077"/> 3077:          {write,[FullDev(),&quot;test&quot;], [{1,&quot;no space left on device&quot;}]},
<a name="3078"/> 3078:          {write,[&quot;test&quot;], [{gl,FullDev()},{general,&quot;no space left on device&quot;}]},
<a name="3079"/> 3079:          {write,[UnknownDev(),&quot;test&quot;], [{general,&quot;unknown error: 'Спутник-1'&quot;}]},
<a name="3080"/> 3080:          {write,[&quot;test&quot;], [{gl,UnknownDev()},{general,&quot;unknown error: 'Спутник-1'&quot;}]},
<a name="3081"/> 3081: 
<a name="3082"/> 3082:          {nl,[DeadDev],[{1,&quot;terminated&quot;}]},
<a name="3083"/> 3083:          {nl,[?MODULE],[{1,&quot;does not exist&quot;}]},
<a name="3084"/> 3084:          {nl,[],[{gl,DeadDev},{general,&quot;terminated&quot;}]},
<a name="3085"/> 3085:          {nl,[FullDev()], [{1,&quot;no space left on device&quot;}]},
<a name="3086"/> 3086:          {nl,[], [{gl,FullDev()},{general,&quot;no space left on device&quot;}]},
<a name="3087"/> 3087:          {nl,[UnknownDev()], [{general,&quot;unknown error: 'Спутник-1'&quot;}]},
<a name="3088"/> 3088:          {nl,[], [{gl,UnknownDev()},{general,&quot;unknown error: 'Спутник-1'&quot;}]},
<a name="3089"/> 3089: 
<a name="3090"/> 3090:          [[{Format,[DeadDev,&quot;test&quot;,[]],   [{1,&quot;terminated&quot;}]},
<a name="3091"/> 3091:            {Format,[&quot;test&quot;,[{gl,DeadDev},  {general,&quot;terminated&quot;}]]},
<a name="3092"/> 3092:            {Format,[?MODULE,&quot;test&quot;,[]],   [{1,&quot;does not exist&quot;}]},
<a name="3093"/> 3093:            {Format,[FullDev(),&quot;test&quot;,[]], [{1,&quot;no space left on device&quot;}]},
<a name="3094"/> 3094:            {Format,[&quot;test&quot;], [{gl,FullDev()},{general,&quot;no space left on device&quot;}]},
<a name="3095"/> 3095:            {Format,[standard_io,&quot;test&quot;],  [{1,&quot;wrong number of arguments&quot;},
<a name="3096"/> 3096:                                            {general,&quot;possibly missing argument list&quot;}]},
<a name="3097"/> 3097:            {Format,[UnknownDev(),&quot;test&quot;,[]], [{general,&quot;unknown error: 'Спутник-1'&quot;}]},
<a name="3098"/> 3098: 
<a name="3099"/> 3099:            %% Test a latin1 device
<a name="3100"/> 3100:            {Format,[Latin1Dev(), &quot;~ts&quot;, [&lt;&lt;&quot;Спутник-1&quot;/utf8&gt;&gt;]],[{1,&quot;transcode&quot;}]},
<a name="3101"/> 3101:            {Format,[&quot;~ts&quot;, [&lt;&lt;&quot;Спутник-1&quot;/utf8&gt;&gt;]],[{gl,Latin1Dev()},{general,&quot;transcode&quot;}]},
<a name="3102"/> 3102: 
<a name="3103"/> 3103:            %% The format error is reported differently
<a name="3104"/> 3104:            %% depending on the current group_leader.
<a name="3105"/> 3105:            %% The different group leaders we test are:
<a name="3106"/> 3106:            %%  * file_io_server
<a name="3107"/> 3107:            %%  * standard_error
<a name="3108"/> 3108:            %%  * test_server_gl
<a name="3109"/> 3109:            %%  * user
<a name="3110"/> 3110:            %%  * application_master
<a name="3111"/> 3111:            %%  * ssh_cli (TODO)
<a name="3112"/> 3112:            %%  * eunit (TODO)
<a name="3113"/> 3113:            %%  * group (TODO)
<a name="3114"/> 3114:            [ [{Format,[Device(),make_ref(),[]],    [{2,&quot;format string&quot;}]},
<a name="3115"/> 3115:               {Format,[Device(),&quot;~p&quot;,make_ref()],  [{3, &quot;not a list&quot;}]},
<a name="3116"/> 3116:               {Format,[make_ref(),[]],[{gl,Device()},{1,&quot;format string&quot;}]},
<a name="3117"/> 3117:               {Format,[&quot;~p&quot;,make_ref()],[{gl,Device()},{2, &quot;not a list&quot;}]}]
<a name="3118"/> 3118:              || Device &lt;- [UserDev, FileDev, TestServerDev, StandardError,
<a name="3119"/> 3119:                            GroupDev, ApplicationMasterDev]],
<a name="3120"/> 3120: 
<a name="3121"/> 3121:            %% Test number of arguments
<a name="3122"/> 3122:            {Format,[&quot;~p&quot;,[&quot;Sputnik-1&quot;,&quot;Laika&quot;]],[{1,&quot;wrong number of arguments&quot;}]},
<a name="3123"/> 3123:            {Format,[standard_io, &quot;~p&quot;,[&quot;Sputnik-1&quot;,&quot;Laika&quot;]],[{2,&quot;wrong number of arguments&quot;}]},
<a name="3124"/> 3124: 
<a name="3125"/> 3125:            %% Test different formatting strings
<a name="3126"/> 3126:            {Format,[&quot;~B&quot;,[&quot;Sputnik-1&quot;]],[{2,&quot;1 must be of type integer&quot;}]},
<a name="3127"/> 3127:            {Format,[standard_io, &quot;~B&quot;,[&quot;Sputnik-1&quot;]],[{3,&quot;1 must be of type integer&quot;}]},
<a name="3128"/> 3128:            {Format,[&quot;~b&quot;,[&quot;Sputnik-1&quot;]],[{2,&quot;1 must be of type integer&quot;}]},
<a name="3129"/> 3129:            {Format,[&quot;~*b&quot;,[&quot;Sputnik-1&quot;,16]],[{2,&quot;1 must be of type integer&quot;}]},
<a name="3130"/> 3130:            {Format,[&quot;~*f&quot;,[1.0,1]],[{2,&quot;1 must be of type integer\\n.*2 must be of type float&quot;}]},
<a name="3131"/> 3131:            {Format,[&quot;~1.*f&quot;,[1.0,1]],[{2,&quot;1 must be of type integer\\n.*2 must be of type float&quot;}]},
<a name="3132"/> 3132:            {Format,[&quot;~*.*f&quot;,[a,b,c]],[{2,&quot;1 must be of type integer\\n.*&quot;
<a name="3133"/> 3133:                                        &quot;2 must be of type integer\\n.*&quot;
<a name="3134"/> 3134:                                        &quot;3 must be of type float&quot;}]},
<a name="3135"/> 3135:            {Format,[&quot;~s&quot;,[&quot;Спутник-1&quot;]],[{1,&quot;failed to format string&quot;}]},
<a name="3136"/> 3136:            {Format,[&quot;~s&quot;,[1]],[{2,&quot;1 must be of type string&quot;}]},
<a name="3137"/> 3137:            {Format,[&quot;~s~s&quot;,[a,1]],[{2,&quot;2 must be of type string&quot;}]},
<a name="3138"/> 3138:            {Format,[&quot;~s&quot;,[[a]]],[{2,&quot;1 must be of type string&quot;}]},
<a name="3139"/> 3139: 
<a name="3140"/> 3140: 	   %% Ensure error messages contain the correct reason (GH-8568)
<a name="3141"/> 3141: 	   {Format, [&quot;~ltkKltkKp&quot;, []], [{1,&quot;wrong number of arguments&quot;}]},
<a name="3142"/> 3142: 	   {Format, [&quot;~ltkKltkKm&quot;, [undefined, ordered, a]], [{1,&quot;format string&quot;}]},
<a name="3143"/> 3143: 	   {Format, [&quot;~ltkKltkKb&quot;, [undefined, ordered, a]], [{2,&quot;3 must be of type integer&quot;}]},
<a name="3144"/> 3144: 	   {Format, [&quot;~ltkKp&quot;, [foo, #{a =&gt; b}]], [{2,&quot;1 must be 'undefined', 'ordered', 'reversed', or a fun that takes two arguments&quot;}]}
<a name="3145"/> 3145: 	  ]
<a name="3146"/> 3146: 	  || Format &lt;- [format,fwrite]]
<a name="3147"/> 3147: 
<a name="3148"/> 3148:         ],
<a name="3149"/> 3149: 
<a name="error_info-last_expr"/><a name="3150"/> 3150: <b>    error_info_lib:test_error_info</b>(io, lists:flatten(L), [allow_nyi]).
<a name="3151"/> 3151: 
<a name="dummy_full_device-0"/><a name="3152"/> 3152: <b>dummy_full_device</b>() -&gt;
<a name="dummy_full_device-last_expr"/><a name="3153"/> 3153: <b>    dummy_device</b>(enospc).
<a name="dummy_unknown_error_device-0"/><a name="3154"/> 3154: <b>dummy_unknown_error_device</b>() -&gt;
<a name="dummy_unknown_error_device-last_expr"/><a name="3155"/> 3155: <b>    dummy_device</b>('Спутник-1').
<a name="3156"/> 3156: 
<a name="dummy_device-1"/><a name="3157"/> 3157: <b>dummy_device</b>(Error) -&gt;
<a name="dummy_device-last_expr"/><a name="3158"/> 3158: <b>    spawn_link</b>(
<a name="3159"/> 3159:       fun() -&gt;
<a name="3160"/> 3160:               receive
<a name="3161"/> 3161:                   {io_request, From, ReplyAs, {put_chars, _Encoding, _Chars}} -&gt;
<a name="3162"/> 3162:                       From ! {io_reply, ReplyAs, {error, Error}};
<a name="3163"/> 3163:                   {io_request, From, ReplyAs, {put_chars, _Encoding, M, F, As}} -&gt;
<a name="3164"/> 3164:                       try apply(M, F, As) of
<a name="3165"/> 3165:                           _ -&gt;
<a name="3166"/> 3166:                               From ! {io_reply, ReplyAs, {error, Error}}
<a name="3167"/> 3167:                       catch _:_ -&gt;
<a name="3168"/> 3168:                               From ! {io_reply, ReplyAs, {error, format}}
<a name="3169"/> 3169:                       end
<a name="3170"/> 3170:               end
<a name="3171"/> 3171:       end).
<a name="3172"/> 3172: 
<a name="3173"/> 3173: <i>%% GH-5053. 'chars_limit' bug.</i>
<a name="otp_17525-1"/><a name="3174"/> 3174: <b>otp_17525</b>(_Config) -&gt;
<a name="3175"/> 3175:     L = [{xxxxxxxxx,aaaa},
<a name="3176"/> 3176:          {yyyyyyyyyyyy,1},
<a name="3177"/> 3177:          {eeeeeeeeeeeee,bbbb},
<a name="3178"/> 3178:          {ddddddddd,1111111111},
<a name="3179"/> 3179:          {gggggggggggggggggggg,cccc},
<a name="3180"/> 3180:          {uuuuuuuuuuuu,11}],
<a name="3181"/> 3181:     S = io_lib:format(&quot;aaaaaaaaaaaaaaaaaa ~p bbbbbbbbbbb ~p&quot;,
<a name="3182"/> 3182:                       [&quot;cccccccccccccccccccccccccccccccccccccc&quot;, L],
<a name="3183"/> 3183:                       [{chars_limit, 155}]),
<a name="3184"/> 3184:     &quot;aaaaaaaaaaaaaaaaaa \&quot;cccccccccccccccccccccccccccccccccccccc\&quot; bbbbbbbbbbb [{xxxxxxxxx,\n&quot;
<a name="3185"/> 3185:     &quot;                                                                          aaaa},\n&quot;
<a name="3186"/> 3186:     &quot;                                                                         {yyyyyyyyyyyy,\n&quot;
<a name="3187"/> 3187:     &quot;                                                                          1},\n&quot;
<a name="3188"/> 3188:     &quot;                                                                         {eeeeeeeeeeeee,\n&quot;
<a name="3189"/> 3189:     &quot;                                                                          bbbb},\n&quot;
<a name="3190"/> 3190:     &quot;                                                                         {ddddddddd,\n&quot;
<a name="3191"/> 3191:     &quot;                                                                          1111111111},\n&quot;
<a name="3192"/> 3192:     &quot;                                                                         {...}|...]&quot; =
<a name="3193"/> 3193:     lists:flatten(S),
<a name="otp_17525-last_expr"/><a name="3194"/> 3194:     ok.
<a name="3195"/> 3195: 
<a name="unscan_format_without_maps_order-1"/><a name="3196"/> 3196: <b>unscan_format_without_maps_order</b>(_Config) -&gt;
<a name="3197"/> 3197:     FormatSpec = #{
<a name="3198"/> 3198:         adjust =&gt; right,
<a name="3199"/> 3199:         args =&gt; [[&lt;&lt;&quot;1&quot;&gt;&gt;]],
<a name="3200"/> 3200:         control_char =&gt; 115,
<a name="3201"/> 3201:         encoding =&gt; unicode,
<a name="3202"/> 3202:         pad_char =&gt; 32,
<a name="3203"/> 3203:         precision =&gt; none,
<a name="3204"/> 3204:         strings =&gt; true,
<a name="3205"/> 3205:         width =&gt; none
<a name="3206"/> 3206:     },
<a name="unscan_format_without_maps_order-last_expr"/><a name="3207"/> 3207: <b>    {&quot;~ts&quot;,[[&lt;&lt;&quot;1&quot;&gt;&gt;]]} = io_lib:unscan_format</b>([FormatSpec]).
<a name="3208"/> 3208: 
<a name="build_text_without_maps_order-1"/><a name="3209"/> 3209: <b>build_text_without_maps_order</b>(_Config) -&gt;
<a name="3210"/> 3210:     FormatSpec = #{
<a name="3211"/> 3211:         adjust =&gt; right,
<a name="3212"/> 3212:         args =&gt; [[&lt;&lt;&quot;1&quot;&gt;&gt;]],
<a name="3213"/> 3213:         control_char =&gt; 115,
<a name="3214"/> 3214:         encoding =&gt; unicode,
<a name="3215"/> 3215:         pad_char =&gt; 32,
<a name="3216"/> 3216:         precision =&gt; none,
<a name="3217"/> 3217:         strings =&gt; true,
<a name="3218"/> 3218:         width =&gt; none
<a name="3219"/> 3219:     },
<a name="build_text_without_maps_order-last_expr"/><a name="3220"/> 3220: <b>    [[&quot;1&quot;]] = io_lib:build_text</b>([FormatSpec]).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
