<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/megaco/make_test_dir/megaco_test/megaco_mib_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2002-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <i>%%----------------------------------------------------------------------</i>
<a name="23"/>   23: <i>%% Purpose: Verify the application specifics of the Megaco application</i>
<a name="24"/>   24: <i>%%----------------------------------------------------------------------</i>
<a name="25"/>   25: 
<a name="26"/>   26: <b>-module</b>(megaco_mib_SUITE).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-export</b>([
<a name="29"/>   29: 	 suite/0, all/0, groups/0,
<a name="30"/>   30:          init_per_suite/1, end_per_suite/1,
<a name="31"/>   31:          init_per_group/2, end_per_group/2,
<a name="32"/>   32:          init_per_testcase/2, end_per_testcase/2,
<a name="33"/>   33: 
<a name="34"/>   34:          plain/1,
<a name="35"/>   35:          connect/1,
<a name="36"/>   36:          traffic/1,
<a name="37"/>   37: 
<a name="38"/>   38:          mg/3,
<a name="39"/>   39:          mgc/3,
<a name="40"/>   40: 
<a name="41"/>   41:          handle_connect/3,
<a name="42"/>   42:          handle_disconnect/4,
<a name="43"/>   43:          handle_syntax_error/4,
<a name="44"/>   44:          handle_message_error/4,
<a name="45"/>   45:          handle_trans_request/4,
<a name="46"/>   46:          handle_trans_long_request/4,
<a name="47"/>   47:          handle_trans_reply/5,
<a name="48"/>   48:          handle_trans_ack/5
<a name="49"/>   49:         ]).
<a name="50"/>   50: 
<a name="51"/>   51: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="52"/>   52: <b>-include_lib</b>(&quot;megaco/include/megaco.hrl&quot;).
<a name="53"/>   53: <b>-include_lib</b>(&quot;megaco/include/megaco_message_v1.hrl&quot;).
<a name="54"/>   54: <b>-include</b>(&quot;megaco_test_lib.hrl&quot;).
<a name="55"/>   55: 
<a name="56"/>   56: <b>-define</b>(TEST_VERBOSITY, info). % silence | info | debug
<a name="57"/>   57: <b>-define</b>(MGC_VERBOSITY,  debug).
<a name="58"/>   58: <b>-define</b>(MG_VERBOSITY,   debug).
<a name="59"/>   59: 
<a name="60"/>   60: <b>-define</b>(LOAD_COUNTER_START, 100).
<a name="61"/>   61: <b>-define</b>(A4444, [&quot;11111111&quot;, &quot;00000000&quot;, &quot;00000000&quot;]).
<a name="62"/>   62: 
<a name="63"/>   63: <b>-record</b>(mgc, {parent  = undefined,
<a name="64"/>   64: 	      tcp_sup = undefined,
<a name="65"/>   65: 	      udp_sup = undefined,
<a name="66"/>   66: 	      mid     = undefined,
<a name="67"/>   67: 	      mg      = []}).
<a name="68"/>   68: <b>-record</b>(mg, {parent       = undefined,
<a name="69"/>   69: 	     mid          = undefined,
<a name="70"/>   70: 	     conn_handle  = undefined,
<a name="71"/>   71: 	     state        = initiated,
<a name="72"/>   72: 	     load_counter = 0}).
<a name="73"/>   73: 
<a name="74"/>   74: 
<a name="75"/>   75: <i>%%======================================================================</i>
<a name="76"/>   76: <i>%% Common Test interface functions</i>
<a name="77"/>   77: <i>%%======================================================================</i>
<a name="78"/>   78: 
<a name="suite-0"/><a name="79"/>   79: <b>suite</b>() -&gt; 
<a name="suite-last_expr"/><a name="80"/>   80:     [{ct_hooks, [ts_install_cth]}].
<a name="81"/>   81: 
<a name="all-0"/><a name="82"/>   82: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="83"/>   83:     [
<a name="84"/>   84:      plain,
<a name="85"/>   85:      connect,
<a name="86"/>   86:      traffic
<a name="87"/>   87:     ].
<a name="88"/>   88: 
<a name="groups-0"/><a name="89"/>   89: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="90"/>   90:     [].
<a name="91"/>   91: 
<a name="92"/>   92: 
<a name="93"/>   93: 
<a name="94"/>   94: <i>%%</i>
<a name="95"/>   95: <i>%% -----</i>
<a name="96"/>   96: <i>%%</i>
<a name="97"/>   97: 
<a name="init_per_suite-1"/><a name="98"/>   98: <b>init_per_suite</b>(suite) -&gt;
<a name="99"/>   99:     [];
<a name="100"/>  100: <b>init_per_suite</b>(doc) -&gt;
<a name="101"/>  101:     [];
<a name="102"/>  102: <b>init_per_suite</b>(Config0) when is_list(Config0) -&gt;
<a name="103"/>  103: 
<a name="104"/>  104:     ?ANNOUNCE_SUITE_INIT(),
<a name="105"/>  105: 
<a name="106"/>  106:     p(&quot;init_per_suite -&gt; entry with&quot;
<a name="107"/>  107:       &quot;~n      Config: ~p&quot;
<a name="108"/>  108:       &quot;~n      Nodes:  ~p&quot;, [Config0, erlang:nodes()]),
<a name="109"/>  109: 
<a name="init_per_suite-last_expr"/><a name="110"/>  110: <b>    case ?LIB:init_per_suite</b>(Config0) of
<a name="111"/>  111:         {skip, _} = SKIP -&gt;
<a name="112"/>  112:             SKIP;
<a name="113"/>  113: 
<a name="114"/>  114:         Config1 when is_list(Config1) -&gt;
<a name="115"/>  115: 
<a name="116"/>  116:             %% We need a (local) monitor on this node also
<a name="117"/>  117:             megaco_test_sys_monitor:start(),
<a name="118"/>  118: 
<a name="119"/>  119:             p(&quot;init_per_suite -&gt; end when&quot;
<a name="120"/>  120:               &quot;~n      Config: ~p&quot;
<a name="121"/>  121:               &quot;~n      Nodes:  ~p&quot;, [Config1, erlang:nodes()]),
<a name="122"/>  122: 
<a name="123"/>  123:             Config1
<a name="124"/>  124:     end.
<a name="125"/>  125: 
<a name="end_per_suite-1"/><a name="126"/>  126: <b>end_per_suite</b>(suite) -&gt; [];
<a name="127"/>  127: <b>end_per_suite</b>(doc) -&gt; [];
<a name="128"/>  128: <b>end_per_suite</b>(Config0) when is_list(Config0) -&gt;
<a name="129"/>  129: 
<a name="130"/>  130:     p(&quot;end_per_suite -&gt; entry with&quot;
<a name="131"/>  131:       &quot;~n      Config: ~p&quot;
<a name="132"/>  132:       &quot;~n      Nodes:  ~p&quot;, [Config0, erlang:nodes()]),
<a name="133"/>  133: 
<a name="134"/>  134:     megaco_test_sys_monitor:stop(),
<a name="135"/>  135:     Config1 = ?LIB:end_per_suite(Config0),
<a name="136"/>  136: 
<a name="137"/>  137:     p(&quot;end_per_suite -&gt; end when&quot;
<a name="138"/>  138:       &quot;~n      Nodes:  ~p&quot;, [erlang:nodes()]),
<a name="139"/>  139: 
<a name="end_per_suite-last_expr"/><a name="140"/>  140:     Config1.
<a name="141"/>  141: 
<a name="142"/>  142: 
<a name="143"/>  143: <i>%%</i>
<a name="144"/>  144: <i>%% -----</i>
<a name="145"/>  145: <i>%%</i>
<a name="146"/>  146: 
<a name="init_per_group-2"/><a name="147"/>  147: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="148"/>  148:     Config.
<a name="149"/>  149: 
<a name="end_per_group-2"/><a name="150"/>  150: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="151"/>  151:     Config.
<a name="152"/>  152: 
<a name="153"/>  153: 
<a name="154"/>  154: 
<a name="155"/>  155: <i>%%</i>
<a name="156"/>  156: <i>%% -----</i>
<a name="157"/>  157: <i>%%</i>
<a name="158"/>  158: 
<a name="init_per_testcase-2"/><a name="159"/>  159: <b>init_per_testcase</b>(Case, Config) -&gt;
<a name="160"/>  160:     process_flag(trap_exit, true),
<a name="161"/>  161: 
<a name="162"/>  162:     progress(&quot;init_per_testcase -&gt; ~w&quot;, [Case]),
<a name="163"/>  163: 
<a name="164"/>  164:     megaco_test_global_sys_monitor:reset_events(),
<a name="165"/>  165: 
<a name="init_per_testcase-last_expr"/><a name="166"/>  166:     case Case of
<a name="167"/>  167: 	traffic -&gt;
<a name="168"/>  168: 	    Conf0 = lists:keydelete(tc_timeout, 1, Config),
<a name="169"/>  169: 	    Conf  = [{tc_timeout, timer:minutes(5)}|Conf0],
<a name="170"/>  170: 	    megaco_test_lib:init_per_testcase(Case, Conf);
<a name="171"/>  171: 	_ -&gt;
<a name="172"/>  172: 	    megaco_test_lib:init_per_testcase(Case, Config)
<a name="173"/>  173:     end.
<a name="174"/>  174: 
<a name="end_per_testcase-2"/><a name="175"/>  175: <b>end_per_testcase</b>(Case, Config) -&gt;
<a name="176"/>  176:     process_flag(trap_exit, false),
<a name="177"/>  177: 
<a name="178"/>  178:     progress(&quot;end_per_testcase -&gt; ~w&quot;, [Case]),
<a name="179"/>  179: 
<a name="180"/>  180:     p(&quot;system events during test: &quot;
<a name="181"/>  181:       &quot;~n   ~p&quot;, [megaco_test_global_sys_monitor:events()]),
<a name="182"/>  182: 
<a name="end_per_testcase-last_expr"/><a name="183"/>  183: <b>    megaco_test_lib:end_per_testcase</b>(Case, Config).
<a name="184"/>  184: 
<a name="185"/>  185: 
<a name="186"/>  186: 
<a name="187"/>  187: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="188"/>  188: 
<a name="plain-1"/><a name="189"/>  189: <b>plain</b>(suite) -&gt;
<a name="190"/>  190:     [];
<a name="191"/>  191: <b>plain</b>(doc) -&gt;
<a name="192"/>  192:     [&quot;Test case for the basic statistics counter handling. &quot;];
<a name="193"/>  193: <b>plain</b>(Config) when is_list(Config) -&gt;
<a name="194"/>  194:     ct:timetrap(?SECS(10)),
<a name="195"/>  195:     io:format(&quot;create test table 1~n&quot;, []),
<a name="196"/>  196:     Tab1 = megaco_test_cnt1,
<a name="197"/>  197:     megaco_stats:init(Tab1),
<a name="198"/>  198: 
<a name="199"/>  199:     io:format(&quot;~ncreate test table 2~n&quot;, []),
<a name="200"/>  200:     Tab2 = megaco_test_cnt2,
<a name="201"/>  201:     megaco_stats:init(Tab2, [kalle, hobbe]),
<a name="202"/>  202: 
<a name="203"/>  203:     io:format(&quot;~ntable 1 increments~n&quot;, []),
<a name="204"/>  204:     H1 = #megaco_conn_handle{local_mid  = {deviceName, &quot;a&quot;},
<a name="205"/>  205: 			     remote_mid = {deviceName, &quot;b&quot;}},
<a name="206"/>  206:     H2 = #megaco_conn_handle{local_mid  = {deviceName, &quot;a&quot;},
<a name="207"/>  207: 			     remote_mid = {deviceName, &quot;c&quot;}},
<a name="208"/>  208:     1 = megaco_stats:inc(Tab1, H1, sune),
<a name="209"/>  209:     2 = megaco_stats:inc(Tab1, H2, sune, 2),
<a name="210"/>  210:     3 = megaco_stats:inc(Tab1, H1, gurka, 3),
<a name="211"/>  211:     4 = megaco_stats:inc(Tab1, H2, sune, 2),
<a name="212"/>  212:     4 = megaco_stats:inc(Tab1, H1, gurka),
<a name="213"/>  213: 
<a name="214"/>  214:     io:format(&quot;~ntable 2 increments~n&quot;, []),
<a name="215"/>  215:     H3 = #megaco_conn_handle{local_mid  = {deviceName, &quot;e&quot;},
<a name="216"/>  216: 			     remote_mid = {deviceName, &quot;c&quot;}},
<a name="217"/>  217:     H4 = #megaco_conn_handle{local_mid  = {deviceName, &quot;e&quot;},
<a name="218"/>  218: 			     remote_mid = {deviceName, &quot;d&quot;}},
<a name="219"/>  219:     1 = megaco_stats:inc(Tab2, H3, tomat),
<a name="220"/>  220:     4 = megaco_stats:inc(Tab2, H3, tomat, 3),
<a name="221"/>  221:     5 = megaco_stats:inc(Tab2, H4, paprika, 5),
<a name="222"/>  222: 
<a name="223"/>  223:     io:format(&quot;~ntable 2 global increments~n&quot;, []),
<a name="224"/>  224:     1 = megaco_stats:inc(Tab2, kalle),
<a name="225"/>  225:     1 = megaco_stats:inc(Tab2, hobbe),
<a name="226"/>  226:     2 = megaco_stats:inc(Tab2, hobbe),
<a name="227"/>  227:     2 = megaco_stats:inc(Tab2, kalle),
<a name="228"/>  228:     3 = megaco_stats:inc(Tab2, kalle),
<a name="229"/>  229:     4 = megaco_stats:inc(Tab2, hobbe, 2),
<a name="230"/>  230:     
<a name="231"/>  231:     io:format(&quot;~ntable 1 stats~n&quot;, []),
<a name="232"/>  232:     {ok, Stats1} = megaco_stats:get_stats(Tab1),
<a name="233"/>  233:     io:format(&quot;Stats1 = ~p~n&quot;, [Stats1]),
<a name="234"/>  234:     {value, {H1, H1Stats}} = lists:keysearch(H1, 1, Stats1),
<a name="235"/>  235:     Stats1_2 = lists:keydelete(H1, 1, Stats1),
<a name="236"/>  236:     {value, {H2, H2Stats}} = lists:keysearch(H2, 1, Stats1_2), 
<a name="237"/>  237:     Stats1_3 = lists:keydelete(H2, 1, Stats1_2),
<a name="238"/>  238:     [] = Stats1_3,
<a name="239"/>  239:     io:format(&quot;H1Stats = ~p~n&quot;, [H1Stats]),
<a name="240"/>  240:     io:format(&quot;H2Stats = ~p~n&quot;, [H2Stats]),
<a name="241"/>  241: 
<a name="242"/>  242:     {value, {sune, 1}}  = lists:keysearch(sune, 1, H1Stats),
<a name="243"/>  243:     H1Stats_2 = lists:keydelete(sune, 1, H1Stats),
<a name="244"/>  244:     {value, {gurka, 4}} = lists:keysearch(gurka, 1, H1Stats_2),
<a name="245"/>  245:     H1Stats_3 = lists:keydelete(gurka, 1, H1Stats_2),
<a name="246"/>  246:     [] = H1Stats_3,
<a name="247"/>  247: 
<a name="248"/>  248:     {value, {sune, 4}} = lists:keysearch(sune, 1, H2Stats),
<a name="249"/>  249:     H2Stats_2 = lists:keydelete(sune, 1, H2Stats),
<a name="250"/>  250:     [] = H2Stats_2,
<a name="251"/>  251:     
<a name="252"/>  252: 
<a name="253"/>  253:     %% --
<a name="254"/>  254:     io:format(&quot;~ntable 2 stats~n&quot;, []),
<a name="255"/>  255:     {ok, Stats2} = megaco_stats:get_stats(Tab2),
<a name="256"/>  256:     io:format(&quot;Stats2 = ~p~n&quot;, [Stats2]),
<a name="257"/>  257:     {ok, 3} = megaco_stats:get_stats(Tab2, kalle),
<a name="258"/>  258:     {ok, 4} = megaco_stats:get_stats(Tab2, hobbe),
<a name="259"/>  259:      
<a name="260"/>  260: 
<a name="261"/>  261:     %% --
<a name="262"/>  262:     io:format(&quot;~ntable 1 reset stats for ~p~n&quot;, [H1]),
<a name="263"/>  263:     megaco_stats:reset_stats(Tab1, H1),
<a name="264"/>  264:     {ok, Stats1_4} = megaco_stats:get_stats(Tab1),
<a name="265"/>  265:     io:format(&quot;Stats1_4 = ~p~n&quot;, [Stats1_4]),
<a name="266"/>  266:     {ok, 0} = megaco_stats:get_stats(Tab1, H1, sune),
<a name="267"/>  267:     {ok, 0} = megaco_stats:get_stats(Tab1, H1, gurka),
<a name="268"/>  268:     
<a name="269"/>  269: 
<a name="270"/>  270:     %% --
<a name="271"/>  271:     io:format(&quot;~ntable 2 reset stats for kalle and ~p~n&quot;, [H4]),
<a name="272"/>  272:     megaco_stats:reset_stats(Tab2, kalle),
<a name="273"/>  273:     megaco_stats:reset_stats(Tab2, H4),
<a name="274"/>  274:     {ok, Stats2_2} = megaco_stats:get_stats(Tab2),
<a name="275"/>  275:     io:format(&quot;Stats2_2 = ~p~n&quot;, [Stats2_2]),
<a name="276"/>  276:     {ok, 0} = megaco_stats:get_stats(Tab2, kalle),
<a name="277"/>  277:     {ok, 4} = megaco_stats:get_stats(Tab2, hobbe),
<a name="278"/>  278:     {ok, 4} = megaco_stats:get_stats(Tab2, H3, tomat),
<a name="279"/>  279:     {ok, 0} = megaco_stats:get_stats(Tab2, H4, paprika),
<a name="280"/>  280:     {ok, Stats4_4} = megaco_stats:get_stats(Tab2, H4),
<a name="281"/>  281:     io:format(&quot;Stats4_4 = ~p~n&quot;, [Stats4_4]),
<a name="282"/>  282: 
<a name="283"/>  283:     %% --
<a name="284"/>  284:     io:format(&quot;~ntable 2 stats for nonexisting counters~n&quot;, []),
<a name="285"/>  285:     {error, _} = megaco_stats:get_stats(Tab2, kalla),
<a name="286"/>  286:     {error, _} = megaco_stats:get_stats(Tab2, H3, paprika),
<a name="plain-last_expr"/><a name="287"/>  287:     ok.
<a name="288"/>  288: 
<a name="289"/>  289: 
<a name="290"/>  290: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="291"/>  291: 
<a name="connect-1"/><a name="292"/>  292: <b>connect</b>(suite) -&gt;
<a name="293"/>  293:     [];
<a name="294"/>  294: <b>connect</b>(doc) -&gt;
<a name="295"/>  295:     [];
<a name="296"/>  296: <b>connect</b>(Config) when is_list(Config) -&gt;
<a name="297"/>  297:     Factor = ?config(megaco_factor, Config),
<a name="298"/>  298:     ct:timetrap(?SECS(10) + Factor * ?SECS(1)),
<a name="299"/>  299:     Pre = fun() -&gt;
<a name="300"/>  300:                   progress(&quot;start nodes&quot;),
<a name="301"/>  301:                   MgcNode = make_node_name(mgc),
<a name="302"/>  302:                   Mg1Node = make_node_name(mg1),
<a name="303"/>  303:                   Mg2Node = make_node_name(mg2),
<a name="304"/>  304:                   d(&quot;connect -&gt; Nodes: &quot;
<a name="305"/>  305:                     &quot;~n   MgcNode: ~p&quot;
<a name="306"/>  306:                     &quot;~n   Mg1Node: ~p&quot;
<a name="307"/>  307:                     &quot;~n   Mg2Node: ~p&quot;, [MgcNode, Mg1Node, Mg2Node]),
<a name="308"/>  308:                   Nodes = [MgcNode, Mg1Node, Mg2Node],
<a name="309"/>  309:                   ok = ?START_NODES(Nodes, true),
<a name="310"/>  310:                   Nodes
<a name="311"/>  311:           end,
<a name="312"/>  312:     Case = fun do_connect/1,
<a name="313"/>  313:     Post = fun(Nodes) -&gt;
<a name="314"/>  314:                    progress(&quot;stop nodes&quot;),
<a name="315"/>  315:                    d(&quot;stop nodes&quot;),
<a name="316"/>  316:                    ?STOP_NODES(lists:reverse(Nodes))
<a name="317"/>  317:            end,
<a name="connect-last_expr"/><a name="318"/>  318: <b>    try_tc</b>(connect, Pre, Case, Post).
<a name="319"/>  319: 
<a name="do_connect-1"/><a name="320"/>  320: <b>do_connect</b>([MgcNode, Mg1Node, Mg2Node]) -&gt;
<a name="321"/>  321:     %% Start the MGC and MGs
<a name="322"/>  322: 
<a name="323"/>  323:     ET = [{text, tcp}, {text, udp}, {binary, tcp}, {binary, udp}],
<a name="324"/>  324:     progress(&quot;start MGC (on ~p)&quot;, [MgcNode]),
<a name="325"/>  325:     {ok, Mgc} = 
<a name="326"/>  326: 	start_mgc(MgcNode, {deviceName, &quot;ctrl&quot;}, ET, ?MGC_VERBOSITY),
<a name="327"/>  327: 
<a name="328"/>  328:     progress(&quot;start MG1 (on ~p) using tcp&quot;, [Mg1Node]),
<a name="329"/>  329:     {ok, Mg1} = 
<a name="330"/>  330: 	start_mg(Mg1Node,  {deviceName, &quot;mg1&quot;}, text,   tcp, ?MG_VERBOSITY),
<a name="331"/>  331: 
<a name="332"/>  332:     progress(&quot;start MG2 (on ~p) using udp&quot;, [Mg2Node]),
<a name="333"/>  333:     {ok, Mg2} = 
<a name="334"/>  334: 	start_mg(Mg2Node,  {deviceName, &quot;mg2&quot;}, binary, udp, ?MG_VERBOSITY),
<a name="335"/>  335: 
<a name="336"/>  336:     %% Collect the initial statistics (should be zero if anything)
<a name="337"/>  337:     progress(&quot;collect initial MG1 stats&quot;),
<a name="338"/>  338:     {ok, Mg1Stats0} = get_stats(Mg1, 1),
<a name="339"/>  339:     d(&quot;connect  -&gt; stats for Mg1: ~n~p&quot;, [Mg1Stats0]),
<a name="340"/>  340:     progress(&quot;collect initial MG2 stats&quot;),
<a name="341"/>  341:     {ok, Mg2Stats0} = get_stats(Mg2, 1),
<a name="342"/>  342:     d(&quot;connect  -&gt; stats for Mg2: ~n~p&quot;, [Mg2Stats0]),
<a name="343"/>  343:     progress(&quot;collect initial MGC stats&quot;),
<a name="344"/>  344:     {ok, MgcStats0} = get_stats(Mgc, 1),
<a name="345"/>  345:     d(&quot;connect  -&gt; stats for Mgc: ~n~p&quot;, [MgcStats0]),
<a name="346"/>  346: 
<a name="347"/>  347:     %% Ask Mg1 to do a service change
<a name="348"/>  348:     progress(&quot;perform MG1 service change&quot;),
<a name="349"/>  349:     {ok, Res1} = service_change(Mg1),
<a name="350"/>  350:     d(&quot;connect -&gt; (Mg1) service change result: ~p&quot;, [Res1]),
<a name="351"/>  351: 
<a name="352"/>  352:     %% Collect the statistics
<a name="353"/>  353:     progress(&quot;collect MG1 statistics (after service change)&quot;),
<a name="354"/>  354:     {ok, Mg1Stats1} = get_stats(Mg1, 1),
<a name="355"/>  355:     d(&quot;connect  -&gt; stats for Mg1: ~n~p&quot;, [Mg1Stats1]),
<a name="356"/>  356:     progress(&quot;collect MGC statistics (after MG1 service change)&quot;),
<a name="357"/>  357:     {ok, MgcStats1} = get_stats(Mgc, 1),
<a name="358"/>  358:     d(&quot;connect  -&gt; stats (1) for Mgc: ~n~p&quot;, [MgcStats1]),
<a name="359"/>  359:     {ok, MgcStats2} = get_stats(Mgc, 2),
<a name="360"/>  360:     d(&quot;connect  -&gt; stats (2) for Mgc: ~n~p&quot;, [MgcStats2]),
<a name="361"/>  361: 
<a name="362"/>  362:     %% Ask Mg2 to do a service change
<a name="363"/>  363:     progress(&quot;perform MG2 service change&quot;),
<a name="364"/>  364:     {ok, Res2} = service_change(Mg2),
<a name="365"/>  365:     d(&quot;connect -&gt; (Mg2) service change result: ~p&quot;, [Res2]),
<a name="366"/>  366: 
<a name="367"/>  367:     %% Collect the statistics
<a name="368"/>  368:     progress(&quot;collect MG2 statistics (after service change)&quot;),
<a name="369"/>  369:     {ok, Mg2Stats1} = get_stats(Mg2, 1),
<a name="370"/>  370:     d(&quot;connect  -&gt; stats for Mg1: ~n~p&quot;, [Mg2Stats1]),
<a name="371"/>  371:     progress(&quot;collect MGC statistics (after MG2 service change)&quot;),
<a name="372"/>  372:     {ok, MgcStats3} = get_stats(Mgc, 1),
<a name="373"/>  373:     d(&quot;connect  -&gt; stats (1) for Mgc: ~n~p&quot;, [MgcStats3]),
<a name="374"/>  374:     {ok, MgcStats4} = get_stats(Mgc, 2),
<a name="375"/>  375:     d(&quot;connect  -&gt; stats (2) for Mgc: ~n~p&quot;, [MgcStats4]),
<a name="376"/>  376: 
<a name="377"/>  377:     %% Tell Mg1 to stop
<a name="378"/>  378:     progress(&quot;stop MG1&quot;),
<a name="379"/>  379:     stop(Mg1),
<a name="380"/>  380: 
<a name="381"/>  381:     %% Collect the statistics
<a name="382"/>  382:     progress(&quot;collect MGC statistics (after MG1 stop)&quot;),
<a name="383"/>  383:     {ok, MgcStats5} = get_stats(Mgc, 1),
<a name="384"/>  384:     d(&quot;connect  -&gt; stats (1) for Mgc: ~n~p&quot;, [MgcStats5]),
<a name="385"/>  385:     {ok, MgcStats6} = get_stats(Mgc, 2),
<a name="386"/>  386:     d(&quot;connect  -&gt; stats (2) for Mgc: ~n~p&quot;, [MgcStats6]),
<a name="387"/>  387: 
<a name="388"/>  388:     %% Tell Mg2 to stop
<a name="389"/>  389:     progress(&quot;stop MG2&quot;),
<a name="390"/>  390:     stop(Mg2),
<a name="391"/>  391: 
<a name="392"/>  392:     %% Collect the statistics
<a name="393"/>  393:     progress(&quot;collect MGC statistics (after MG2 stop)&quot;),
<a name="394"/>  394:     {ok, MgcStats7} = get_stats(Mgc, 1),
<a name="395"/>  395:     d(&quot;connect  -&gt; stats (1) for Mgc: ~n~p&quot;, [MgcStats7]),
<a name="396"/>  396:     {ok, MgcStats8} = get_stats(Mgc, 2),
<a name="397"/>  397:     d(&quot;connect  -&gt; stats (2) for Mgc: ~n~p&quot;, [MgcStats8]),
<a name="398"/>  398: 
<a name="399"/>  399:     %% Tell Mgc to stop
<a name="400"/>  400:     progress(&quot;stop MGC&quot;),
<a name="401"/>  401:     stop(Mgc),
<a name="402"/>  402: 
<a name="403"/>  403:     i(&quot;connect -&gt; done&quot;, []),
<a name="do_connect-last_expr"/><a name="404"/>  404:     ok.
<a name="405"/>  405: 
<a name="406"/>  406: 
<a name="407"/>  407: 
<a name="408"/>  408: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="409"/>  409: 
<a name="traffic-1"/><a name="410"/>  410: <b>traffic</b>(suite) -&gt;
<a name="411"/>  411:     [];
<a name="412"/>  412: <b>traffic</b>(doc) -&gt;
<a name="413"/>  413:     [];
<a name="414"/>  414: <b>traffic</b>(Config) when is_list(Config) -&gt;
<a name="415"/>  415:     Factor = ?config(megaco_factor, Config),
<a name="416"/>  416:     ct:timetrap(?MINS(1) + Factor * ?SECS(10)),
<a name="417"/>  417:     Pre = fun() -&gt;
<a name="418"/>  418:                   progress(&quot;start nodes&quot;),
<a name="419"/>  419:                   MgcNode = make_node_name(mgc),
<a name="420"/>  420:                   Mg1Node = make_node_name(mg1),
<a name="421"/>  421:                   Mg2Node = make_node_name(mg2),
<a name="422"/>  422:                   Mg3Node = make_node_name(mg3),
<a name="423"/>  423:                   Mg4Node = make_node_name(mg4),
<a name="424"/>  424:                   Nodes = [MgcNode, Mg1Node, Mg2Node, Mg3Node, Mg4Node],
<a name="425"/>  425:                   d(&quot;traffic -&gt; Nodes: &quot;
<a name="426"/>  426:                     &quot;~n   MgcNode: ~p&quot;
<a name="427"/>  427:                     &quot;~n   Mg1Node: ~p&quot;
<a name="428"/>  428:                     &quot;~n   Mg2Node: ~p&quot;
<a name="429"/>  429:                     &quot;~n   Mg3Node: ~p&quot;
<a name="430"/>  430:                     &quot;~n   Mg4Node: ~p&quot;, 
<a name="431"/>  431:                     [MgcNode, Mg1Node, Mg2Node, Mg3Node, Mg4Node]),
<a name="432"/>  432:                   ok = ?START_NODES(Nodes, true),
<a name="433"/>  433:                   Nodes
<a name="434"/>  434:           end,
<a name="435"/>  435:     Case = fun do_traffic/1,
<a name="436"/>  436:     Post = fun(Nodes) -&gt;
<a name="437"/>  437:                    progress(&quot;stop nodes&quot;),
<a name="438"/>  438:                    d(&quot;stop nodes&quot;),
<a name="439"/>  439:                    ?STOP_NODES(lists:reverse(Nodes))
<a name="440"/>  440:            end,
<a name="traffic-last_expr"/><a name="441"/>  441: <b>    try_tc</b>(traffic, Pre, Case, Post).
<a name="442"/>  442: 
<a name="do_traffic-1"/><a name="443"/>  443: <b>do_traffic</b>([MgcNode, Mg1Node, Mg2Node, Mg3Node, Mg4Node]) -&gt;
<a name="444"/>  444:     %% Start the MGC and MGs
<a name="445"/>  445:     i(&quot;start the MGC&quot;),    
<a name="446"/>  446:     progress(&quot;start MGC (on ~p)&quot;, [MgcNode]),
<a name="447"/>  447:     ET = [{text,tcp}, {text,udp}, {binary,tcp}, {binary,udp}],
<a name="448"/>  448:     {ok, Mgc} = 
<a name="449"/>  449: 	start_mgc(MgcNode, {deviceName, &quot;ctrl&quot;}, ET, ?MGC_VERBOSITY),
<a name="450"/>  450: 
<a name="451"/>  451:     i(&quot;traffic -&gt; start and connect the MGs&quot;),    
<a name="452"/>  452:     progress(&quot;start and connect MGs&quot;),
<a name="453"/>  453:     MgConf0 = [{Mg1Node, &quot;mg1&quot;, text,   tcp},
<a name="454"/>  454: 	       {Mg2Node, &quot;mg2&quot;, text,   udp},
<a name="455"/>  455: 	       {Mg3Node, &quot;mg3&quot;, binary, tcp},
<a name="456"/>  456: 	       {Mg4Node, &quot;mg4&quot;, binary, udp}],
<a name="457"/>  457:     MgConf = traffic_connect_mg(MgConf0, []),
<a name="458"/>  458: 
<a name="459"/>  459:     %% Collect and check the MGs statistics
<a name="460"/>  460:     i(&quot;traffic -&gt; collect and check the MGs stats&quot;),    
<a name="461"/>  461:     progress(&quot;collect and verify MGs (initial) stats&quot;),
<a name="462"/>  462:     traffic_verify_mg_stats(MgConf, 1, 1),
<a name="463"/>  463: 
<a name="464"/>  464:     %% Collect and check the MGC statistics
<a name="465"/>  465:     i(&quot;traffic -&gt; collect and check the MGC (initial) stats&quot;),    
<a name="466"/>  466:     progress(&quot;collect and verify MGC stats&quot;),
<a name="467"/>  467:     {ok, MgcStats1} = get_stats(Mgc, 1),
<a name="468"/>  468:     d(&quot;traffic  -&gt; stats (1) for Mgc: ~n~p~n&quot;, [MgcStats1]),
<a name="469"/>  469:     traffic_verify_mgc_stats(Mgc, 1, 1),
<a name="470"/>  470: 
<a name="471"/>  471: 
<a name="472"/>  472:     ?SLEEP(1000),
<a name="473"/>  473: 
<a name="474"/>  474: 
<a name="475"/>  475:     %% And apply some load 
<a name="476"/>  476:     i(&quot;traffic -&gt; apply traffic load (1)&quot;),
<a name="477"/>  477:     progress(&quot;apply some load (1)&quot;),
<a name="478"/>  478:     ok = traffic_apply_load(MgConf),
<a name="479"/>  479: 
<a name="480"/>  480:     %% Await completion of load part and the collect traffic
<a name="481"/>  481:     i(&quot;traffic -&gt; await load (1) competion&quot;),
<a name="482"/>  482:     progress(&quot;await load (1) completion&quot;),
<a name="483"/>  483:     ok = traffic_await_load_complete(MgConf),
<a name="484"/>  484: 
<a name="485"/>  485: 
<a name="486"/>  486:     ?SLEEP(1000),
<a name="487"/>  487: 
<a name="488"/>  488: 
<a name="489"/>  489:     i(&quot;traffic -&gt; collect and check the MGs statistics&quot;),
<a name="490"/>  490:     progress(&quot;collect and verify MGs (after load 1) stats&quot;),
<a name="491"/>  491:     traffic_verify_mg_stats(MgConf, 
<a name="492"/>  492: 			    1 + ?LOAD_COUNTER_START, 
<a name="493"/>  493: 			    1 + ?LOAD_COUNTER_START),
<a name="494"/>  494: 
<a name="495"/>  495:     i(&quot;traffic -&gt; collect and check the MGC statistics&quot;),
<a name="496"/>  496:     progress(&quot;collect and verify MGC (after load 1) stats&quot;),
<a name="497"/>  497:     {ok, MgcStats3} = get_stats(Mgc, 1),
<a name="498"/>  498:     d(&quot;traffic  -&gt; stats (1) for Mgc: ~n~p~n&quot;, [MgcStats3]),
<a name="499"/>  499:     traffic_verify_mgc_stats(Mgc, 
<a name="500"/>  500: 			     1 + ?LOAD_COUNTER_START, 
<a name="501"/>  501: 			     1 + ?LOAD_COUNTER_START),
<a name="502"/>  502: 
<a name="503"/>  503: 
<a name="504"/>  504:     ?SLEEP(1000),
<a name="505"/>  505: 
<a name="506"/>  506: 
<a name="507"/>  507:     %% Reset counters
<a name="508"/>  508:     i(&quot;traffic -&gt; reset the MGs statistics&quot;),
<a name="509"/>  509:     progress(&quot;reset MGs stats&quot;),
<a name="510"/>  510:     traffic_reset_mg_stats(MgConf),
<a name="511"/>  511:     i(&quot;traffic -&gt; collect and check the MGs statistics&quot;),
<a name="512"/>  512:     progress(&quot;collect and verify MGs (after reset) stats&quot;),
<a name="513"/>  513:     traffic_verify_mg_stats(MgConf, 0, 0),
<a name="514"/>  514: 
<a name="515"/>  515:     i(&quot;traffic -&gt; reset the MGC statistics&quot;),
<a name="516"/>  516:     progress(&quot;reset MGC stats&quot;),
<a name="517"/>  517:     traffic_reset_mgc_stats(Mgc),
<a name="518"/>  518:     i(&quot;traffic -&gt; collect and check the MGC statistics&quot;),
<a name="519"/>  519:     progress(&quot;collect and verify MGC (after reset) stats&quot;),
<a name="520"/>  520:     traffic_verify_mgc_stats(Mgc, 0, 0),
<a name="521"/>  521: 
<a name="522"/>  522: 
<a name="523"/>  523:     ?SLEEP(1000),
<a name="524"/>  524: 
<a name="525"/>  525: 
<a name="526"/>  526:     %% And apply some load 
<a name="527"/>  527:     i(&quot;traffic -&gt; apply traffic load (2)&quot;),
<a name="528"/>  528:     progress(&quot;apply some load (2)&quot;),
<a name="529"/>  529:     ok = traffic_apply_load(MgConf),
<a name="530"/>  530: 
<a name="531"/>  531:     %% Await completion of load part and the collect traffic
<a name="532"/>  532:     i(&quot;traffic -&gt; await load (2) competion&quot;),
<a name="533"/>  533:     progress(&quot;await load (2) completion&quot;),
<a name="534"/>  534:     ok = traffic_await_load_complete(MgConf),
<a name="535"/>  535: 
<a name="536"/>  536: 
<a name="537"/>  537:     ?SLEEP(1000),
<a name="538"/>  538: 
<a name="539"/>  539: 
<a name="540"/>  540:     i(&quot;traffic -&gt; collect and check the MGs statistics&quot;),
<a name="541"/>  541:     progress(&quot;collect and verify MGs (after load 2) stats&quot;),
<a name="542"/>  542:     traffic_verify_mg_stats(MgConf, 
<a name="543"/>  543: 			    ?LOAD_COUNTER_START, 
<a name="544"/>  544: 			    ?LOAD_COUNTER_START),
<a name="545"/>  545: 
<a name="546"/>  546:     i(&quot;traffic -&gt; collect and check the MGC statistics&quot;),
<a name="547"/>  547:     progress(&quot;collect and verify MGC (after load 2) stats&quot;),
<a name="548"/>  548:     traffic_verify_mgc_stats(Mgc, 
<a name="549"/>  549: 			     ?LOAD_COUNTER_START, 
<a name="550"/>  550: 			     ?LOAD_COUNTER_START),
<a name="551"/>  551: 
<a name="552"/>  552: 
<a name="553"/>  553:     ?SLEEP(1000),
<a name="554"/>  554: 
<a name="555"/>  555: 
<a name="556"/>  556:     %% Tell MGs to stop
<a name="557"/>  557:     i(&quot;traffic -&gt; stop the MGs&quot;),
<a name="558"/>  558:     progress(&quot;stop MGs&quot;),
<a name="559"/>  559:     traffic_stop_mg(MgConf),
<a name="560"/>  560: 
<a name="561"/>  561: 
<a name="562"/>  562:     ?SLEEP(1000),
<a name="563"/>  563: 
<a name="564"/>  564: 
<a name="565"/>  565:     %% Collect the statistics
<a name="566"/>  566:     i(&quot;traffic -&gt; collect the MGC statistics&quot;),
<a name="567"/>  567:     progress(&quot;collect and verify MGC (after MGs stop) stats&quot;),
<a name="568"/>  568:     {ok, MgcStats7} = get_stats(Mgc, 1),
<a name="569"/>  569:     d(&quot;traffic -&gt; stats (1) for Mgc: ~n~p~n&quot;, [MgcStats7]),
<a name="570"/>  570:     {ok, MgcStats8} = get_stats(Mgc, 2),
<a name="571"/>  571:     d(&quot;traffic -&gt; stats (2) for Mgc: ~n~p~n&quot;, [MgcStats8]),
<a name="572"/>  572: 
<a name="573"/>  573:     %% Tell Mgc to stop
<a name="574"/>  574:     i(&quot;traffic -&gt; stop the MGC&quot;),
<a name="575"/>  575:     progress(&quot;stop MGC&quot;),
<a name="576"/>  576:     stop(Mgc),
<a name="577"/>  577: 
<a name="578"/>  578:     i(&quot;traffic -&gt; done&quot;, []),
<a name="do_traffic-last_expr"/><a name="579"/>  579:     ok.
<a name="580"/>  580: 
<a name="581"/>  581: 
<a name="traffic_verify_mgc_stats-3"/><a name="582"/>  582: <b>traffic_verify_mgc_stats</b>(Pid, Out, In) 
<a name="583"/>  583:   when is_pid(Pid) andalso is_integer(Out) andalso is_integer(In) -&gt;
<a name="584"/>  584:     d(&quot;traffic_verify_mgc_stats -&gt; entry with&quot;
<a name="585"/>  585:       &quot;~n   Out:   ~p&quot;
<a name="586"/>  586:       &quot;~n   In:    ~p&quot;, [Out, In]),
<a name="587"/>  587:     {ok, Stats} = get_stats(Pid, 2),
<a name="588"/>  588:     d(&quot;traffic_verify_mgc_stats -&gt; stats (2) for Mgc: ~n~p~n&quot;, [Stats]),
<a name="589"/>  589:     traffic_verify_mgc_stats(Stats, Out, In);
<a name="590"/>  590:     
<a name="591"/>  591: <b>traffic_verify_mgc_stats</b>(Stats, Out, In) when is_list(Stats) -&gt;
<a name="592"/>  592:     d(&quot;traffic_verify_mgc_stats -&gt; checking stats&quot;),
<a name="593"/>  593:     Gen   = traffic_verify_get_stats(gen, Stats),
<a name="594"/>  594:     Trans = traffic_verify_get_stats(trans, Stats),
<a name="595"/>  595:     traffic_verify_mgc_stats_gen(Gen),
<a name="traffic_verify_mgc_stats-last_expr"/><a name="596"/>  596: <b>    traffic_verify_mgc_stats_trans</b>(Trans, Out, In).
<a name="597"/>  597: 
<a name="traffic_verify_mgc_stats_gen-1"/><a name="598"/>  598: <b>traffic_verify_mgc_stats_gen</b>([]) -&gt;
<a name="599"/>  599:     d(&quot;traffic_verify_mgc_stats_gen -&gt; done&quot;),
<a name="600"/>  600:     ok;
<a name="601"/>  601: <b>traffic_verify_mgc_stats_gen</b>([{medGwyGatewayNumErrors, 0}|Stats]) -&gt;
<a name="602"/>  602:     traffic_verify_mgc_stats_gen(Stats);
<a name="603"/>  603: <b>traffic_verify_mgc_stats_gen</b>([{medGwyGatewayNumErrors, Val}|_]) -&gt;
<a name="604"/>  604:     exit({global_error_counter, Val, mgc});
<a name="605"/>  605: <b>traffic_verify_mgc_stats_gen</b>([{Handle, Counters}|Stats]) -&gt;
<a name="606"/>  606:     N = {mgc, Handle, Handle},
<a name="607"/>  607:     traffic_verify_counter(N, medGwyGatewayNumErrors, Counters, 0),
<a name="traffic_verify_mgc_stats_gen-last_expr"/><a name="608"/>  608: <b>    traffic_verify_mgc_stats_gen</b>(Stats).
<a name="609"/>  609: 
<a name="610"/>  610: 
<a name="traffic_verify_mgc_stats_trans-3"/><a name="611"/>  611: <b>traffic_verify_mgc_stats_trans</b>([], _Out, _In) -&gt;    
<a name="612"/>  612:     ok;
<a name="613"/>  613: <b>traffic_verify_mgc_stats_trans</b>([{Mod, Stats}|MgcStats], Out, In) -&gt;    
<a name="614"/>  614:     d(&quot;traffic_verify_mgc_stats_trans -&gt; entry with&quot;
<a name="615"/>  615:       &quot;~n   Mod:   ~p&quot;
<a name="616"/>  616:       &quot;~n   Stats: ~p&quot;, [Mod, Stats]),
<a name="617"/>  617:     traffic_verify_mgc_stats_trans(Mod, Stats, Out, In),
<a name="traffic_verify_mgc_stats_trans-last_expr"/><a name="618"/>  618: <b>    traffic_verify_mgc_stats_trans</b>(MgcStats, Out, In).
<a name="619"/>  619: 
<a name="traffic_verify_mgc_stats_trans-4"/><a name="620"/>  620: <b>traffic_verify_mgc_stats_trans</b>(_Mod, [], _Out, _In) -&gt;
<a name="621"/>  621:     ok;
<a name="622"/>  622: <b>traffic_verify_mgc_stats_trans</b>(Mod, [{Handle,Counters}|Stats], Out, In) -&gt;
<a name="623"/>  623:     N = {mgc, Mod, Handle},
<a name="624"/>  624:     traffic_verify_counter(N, medGwyGatewayNumErrors, Counters, 0),
<a name="625"/>  625:     traffic_verify_counter(N, medGwyGatewayNumOutMessages, Counters, Out),
<a name="626"/>  626:     traffic_verify_counter(N, medGwyGatewayNumInMessages, Counters, In),
<a name="traffic_verify_mgc_stats_trans-last_expr"/><a name="627"/>  627: <b>    traffic_verify_mgc_stats_trans</b>(Mod, Stats, Out, In).
<a name="628"/>  628:     
<a name="629"/>  629: 
<a name="traffic_verify_mg_stats-3"/><a name="630"/>  630: <b>traffic_verify_mg_stats</b>(MgConf, Out, In) 
<a name="631"/>  631:   when is_integer(Out) andalso is_integer(In) -&gt;
<a name="632"/>  632:     d(&quot;traffic_verify_mg_stats -&gt; entry with&quot;
<a name="633"/>  633:       &quot;~n   Out:   ~p&quot;
<a name="634"/>  634:       &quot;~n   In:    ~p&quot;, [Out, In]),
<a name="635"/>  635:     Stats = traffic_get_mg_stats(MgConf, []),
<a name="636"/>  636:     d(&quot;traffic_verify_mg_stats -&gt; stats for MGs: ~n~p&quot;, [Stats]),
<a name="traffic_verify_mg_stats-last_expr"/><a name="637"/>  637: <b>    traffic_verify_mg_stats1</b>(Stats, Out, In).
<a name="638"/>  638:     
<a name="traffic_verify_mg_stats1-3"/><a name="639"/>  639: <b>traffic_verify_mg_stats1</b>([], _, _) -&gt;
<a name="640"/>  640:     ok;
<a name="641"/>  641: <b>traffic_verify_mg_stats1</b>([{Name, Stats}|MgStats], Out, In) -&gt;
<a name="642"/>  642:     d(&quot;traffic_verify_mg_stats1 -&gt; entry with&quot;
<a name="643"/>  643:       &quot;~n   Name:  ~s&quot;
<a name="644"/>  644:       &quot;~n   Stats: ~p&quot;, [Name, Stats]),
<a name="645"/>  645:     Gen   = traffic_verify_get_stats(gen, Stats),
<a name="646"/>  646:     Trans = traffic_verify_get_stats(trans, Stats),
<a name="647"/>  647:     traffic_verify_mg_stats_gen(Name, Gen),
<a name="648"/>  648:     traffic_verify_mg_stats_trans(Name, Trans, Out, In),
<a name="traffic_verify_mg_stats1-last_expr"/><a name="649"/>  649: <b>    traffic_verify_mg_stats1</b>(MgStats, Out, In).
<a name="650"/>  650: 
<a name="traffic_verify_mg_stats_gen-2"/><a name="651"/>  651: <b>traffic_verify_mg_stats_gen</b>(Mg, []) -&gt;
<a name="652"/>  652:     d(&quot;traffic_verify_mg_stats_gen -&gt; ~s checked out OK&quot;,[Mg]),
<a name="653"/>  653:     ok;
<a name="654"/>  654: <b>traffic_verify_mg_stats_gen</b>(Mg, [{medGwyGatewayNumErrors, 0}|Stats]) -&gt;
<a name="655"/>  655:     traffic_verify_mg_stats_gen(Mg, Stats);
<a name="656"/>  656: <b>traffic_verify_mg_stats_gen</b>(Mg, [{medGwyGatewayNumErrors, Val}|_]) -&gt;
<a name="657"/>  657:     exit({global_error_counter, Val, Mg});
<a name="658"/>  658: <b>traffic_verify_mg_stats_gen</b>(Mg, [{_Handle, Counters}|Stats]) -&gt;
<a name="659"/>  659:     traffic_verify_counter(Mg, medGwyGatewayNumErrors, Counters, 0),
<a name="traffic_verify_mg_stats_gen-last_expr"/><a name="660"/>  660: <b>    traffic_verify_mg_stats_gen</b>(Mg, Stats).
<a name="661"/>  661: 
<a name="traffic_verify_mg_stats_trans-4"/><a name="662"/>  662: <b>traffic_verify_mg_stats_trans</b>(Mg, Counters, Out, In) -&gt;
<a name="663"/>  663:     traffic_verify_counter(Mg, medGwyGatewayNumErrors,      Counters, 0),
<a name="664"/>  664:     traffic_verify_counter(Mg, medGwyGatewayNumOutMessages, Counters, Out),
<a name="traffic_verify_mg_stats_trans-last_expr"/><a name="665"/>  665: <b>    traffic_verify_counter</b>(Mg, medGwyGatewayNumInMessages,  Counters, In).
<a name="666"/>  666: 
<a name="667"/>  667: 
<a name="traffic_verify_get_stats-2"/><a name="668"/>  668: <b>traffic_verify_get_stats</b>(S, Stats) -&gt;
<a name="traffic_verify_get_stats-last_expr"/><a name="669"/>  669: <b>    case lists:keysearch</b>(S, 1, Stats) of
<a name="670"/>  670: 	{value, {S, Val}} -&gt;
<a name="671"/>  671: 	    Val;
<a name="672"/>  672: 	false -&gt;
<a name="673"/>  673: 	    exit({not_found, S, Stats})
<a name="674"/>  674:     end.
<a name="675"/>  675:     
<a name="traffic_verify_counter-4"/><a name="676"/>  676: <b>traffic_verify_counter</b>(Name, Counter, Counters, Expected) -&gt;
<a name="traffic_verify_counter-last_expr"/><a name="677"/>  677: <b>    case lists:keysearch</b>(Counter, 1, Counters) of
<a name="678"/>  678: 	{value, {Counter, Expected}} -&gt;
<a name="679"/>  679:             i(&quot;counter ~w verified for ~p&quot;, [Counter, Name]),
<a name="680"/>  680: 	    ok;
<a name="681"/>  681: 	{value, {Counter, Val}} -&gt;
<a name="682"/>  682:             i(&quot;counter ~w *not* verified for ~p: &quot;
<a name="683"/>  683:               &quot;~n   Expected: ~w&quot;
<a name="684"/>  684:               &quot;~n   Actual:   ~w&quot;
<a name="685"/>  685:               &quot;~n   Counters: ~w&quot;,
<a name="686"/>  686:               [Counter, Name, Expected, Val, Counters]),
<a name="687"/>  687: 	    exit({illegal_counter_value, Name, Counter, Expected, Val,
<a name="688"/>  688:                   Counters});
<a name="689"/>  689: 	false -&gt;
<a name="690"/>  690:             i(&quot;counter ~w *not* found for ~p: &quot;
<a name="691"/>  691:               &quot;~n   Counters: ~p&quot;, [Counter, Name, Counters]),
<a name="692"/>  692: 	    exit({not_found, Name, Counter, Counters, Expected})
<a name="693"/>  693:     end.
<a name="694"/>  694:     
<a name="695"/>  695: 
<a name="traffic_connect_mg-2"/><a name="696"/>  696: <b>traffic_connect_mg</b>([], Acc) -&gt;
<a name="697"/>  697:     lists:reverse(Acc);
<a name="698"/>  698: <b>traffic_connect_mg</b>([{Node, Name, Coding, Trans}|Mg], Acc) -&gt;
<a name="699"/>  699:     Pid = traffic_connect_mg(Node, Name, Coding, Trans),
<a name="traffic_connect_mg-last_expr"/><a name="700"/>  700: <b>    traffic_connect_mg</b>(Mg, [{Name, Pid}|Acc]).
<a name="701"/>  701: 
<a name="traffic_connect_mg-4"/><a name="702"/>  702: <b>traffic_connect_mg</b>(Node, Name, Coding, Trans) -&gt;
<a name="703"/>  703:     progress(&quot;start (and connect) ~s (on ~p) using ~p&quot;, [Name, Node, Trans]),
<a name="704"/>  704:     Mid = {deviceName, Name}, 
<a name="705"/>  705:     {ok, Pid} = start_mg(Node, Mid, Coding, Trans, ?MG_VERBOSITY),
<a name="706"/>  706: 
<a name="707"/>  707:     %% Ask the MGs to do a service change
<a name="708"/>  708:     progress(&quot;perform ~s service change&quot;, [Name]),
<a name="709"/>  709:     {ok, Res} = service_change(Pid),
<a name="710"/>  710:     d(&quot;traffic_connect_mg -&gt; (~s) service change result: ~p&quot;, [Name, Res]),
<a name="traffic_connect_mg-last_expr"/><a name="711"/>  711:     Pid.
<a name="712"/>  712: 
<a name="713"/>  713: 
<a name="traffic_stop_mg-1"/><a name="714"/>  714: <b>traffic_stop_mg</b>(MGs) -&gt;
<a name="traffic_stop_mg-last_expr"/><a name="715"/>  715: <b>    [stop</b>(Pid) || {_Name, Pid} &lt;- MGs].
<a name="716"/>  716: 
<a name="717"/>  717: 
<a name="traffic_get_mg_stats-2"/><a name="718"/>  718: <b>traffic_get_mg_stats</b>([], Acc) -&gt;
<a name="719"/>  719:     lists:reverse(Acc);
<a name="720"/>  720: <b>traffic_get_mg_stats</b>([{Name, Pid}|Mgs], Acc) -&gt;
<a name="721"/>  721:     {ok, Stats} = get_stats(Pid, 1),
<a name="722"/>  722:     d(&quot;traffic_get_mg_stats -&gt; stats for ~s: &quot;
<a name="723"/>  723:       &quot;~n   ~p&quot;
<a name="724"/>  724:       &quot;~n&quot;, [Name, Stats]),
<a name="traffic_get_mg_stats-last_expr"/><a name="725"/>  725: <b>    traffic_get_mg_stats</b>(Mgs, [{Name, Stats}|Acc]).
<a name="726"/>  726: 
<a name="727"/>  727: 
<a name="traffic_apply_load-1"/><a name="728"/>  728: <b>traffic_apply_load</b>([]) -&gt;
<a name="729"/>  729:     ok;
<a name="730"/>  730: <b>traffic_apply_load</b>([{_,MG}|MGs]) -&gt;
<a name="731"/>  731:     MG ! {apply_load, self(), ?LOAD_COUNTER_START},
<a name="traffic_apply_load-last_expr"/><a name="732"/>  732:     receive
<a name="733"/>  733: 	{apply_load_ack, MG} -&gt;
<a name="734"/>  734: 	    traffic_apply_load(MGs);
<a name="735"/>  735: 	{'EXIT', MG, Reason} -&gt;
<a name="736"/>  736: 	    exit({mg_exit, MG, Reason})
<a name="737"/>  737:     after 10000 -&gt;
<a name="738"/>  738: 	    exit({apply_load_ack_timeout, MG})
<a name="739"/>  739:     end.
<a name="740"/>  740: 
<a name="741"/>  741: 
<a name="traffic_reset_mg_stats-1"/><a name="742"/>  742: <b>traffic_reset_mg_stats</b>([]) -&gt;
<a name="743"/>  743:     ok;
<a name="744"/>  744: <b>traffic_reset_mg_stats</b>([{Name, Pid}|MGs]) -&gt;
<a name="745"/>  745:     d(&quot;traffic_reset_mg_stats -&gt; resetting ~s&quot;, [Name]),
<a name="746"/>  746:     traffic_reset_stats(Pid),
<a name="traffic_reset_mg_stats-last_expr"/><a name="747"/>  747: <b>    traffic_reset_mg_stats</b>(MGs).
<a name="748"/>  748: 
<a name="traffic_reset_mgc_stats-1"/><a name="749"/>  749: <b>traffic_reset_mgc_stats</b>(Mgc) -&gt;
<a name="750"/>  750:     d(&quot;traffic_reset_mgc_stats -&gt; resetting ~p&quot;, [Mgc]),
<a name="traffic_reset_mgc_stats-last_expr"/><a name="751"/>  751: <b>    traffic_reset_stats</b>(Mgc).
<a name="752"/>  752:     
<a name="traffic_reset_stats-1"/><a name="753"/>  753: <b>traffic_reset_stats</b>(Pid) -&gt;
<a name="754"/>  754:     Pid ! {reset_stats, self()},
<a name="traffic_reset_stats-last_expr"/><a name="755"/>  755:     receive
<a name="756"/>  756: 	{reset_stats_ack, Pid} -&gt;
<a name="757"/>  757: 	    ok;
<a name="758"/>  758: 	{'EXIT', Pid, Reason} -&gt;
<a name="759"/>  759: 	    exit({client_exit, Pid, Reason})
<a name="760"/>  760:     after 10000 -&gt;
<a name="761"/>  761: 	    exit({reset_stats_ack_timeout, Pid})
<a name="762"/>  762:     end.
<a name="763"/>  763: 
<a name="764"/>  764:     
<a name="traffic_await_load_complete-1"/><a name="765"/>  765: <b>traffic_await_load_complete</b>([]) -&gt;
<a name="766"/>  766:     ok;
<a name="767"/>  767: <b>traffic_await_load_complete</b>(MGs0) -&gt;
<a name="traffic_await_load_complete-last_expr"/><a name="768"/>  768:     receive
<a name="769"/>  769: 	{load_complete, Pid} -&gt;
<a name="770"/>  770: 	    d(&quot;received load_complete from ~p&quot;, [Pid]),
<a name="771"/>  771: 	    MGs1 = lists:keydelete(Pid, 2, MGs0),
<a name="772"/>  772: 	    traffic_await_load_complete(lists:delete(Pid, MGs1));
<a name="773"/>  773: 	{'EXIT', Pid, Reason} -&gt;
<a name="774"/>  774: 	    i(&quot;exit signal from ~p: ~p&quot;, [Pid, Reason]),
<a name="775"/>  775: 	    case lists:keymember(Pid, 2, MGs0) of
<a name="776"/>  776: 		true -&gt;
<a name="777"/>  777: 		    exit({mg_exit, Pid, Reason});
<a name="778"/>  778: 		false -&gt;
<a name="779"/>  779: 		    MGs1 = lists:keydelete(Pid, 2, MGs0),
<a name="780"/>  780: 		    traffic_await_load_complete(lists:delete(Pid, MGs1))
<a name="781"/>  781: 	    end
<a name="782"/>  782:     end.
<a name="783"/>  783: 	    
<a name="784"/>  784: 
<a name="785"/>  785: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="786"/>  786: 
<a name="make_node_name-1"/><a name="787"/>  787: <b>make_node_name</b>(Name) -&gt;
<a name="make_node_name-last_expr"/><a name="788"/>  788: <b>    case string:tokens</b>(atom_to_list(node()), [$@]) of
<a name="789"/>  789: 	[_,Host] -&gt;
<a name="790"/>  790: 	    list_to_atom(lists:concat([atom_to_list(Name) ++ &quot;@&quot; ++ Host]));
<a name="791"/>  791: 	_ -&gt;
<a name="792"/>  792: 	    exit(&quot;Test node must be started with '-sname'&quot;)
<a name="793"/>  793:      end.
<a name="794"/>  794: 
<a name="795"/>  795: 
<a name="796"/>  796: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="797"/>  797: 
<a name="start_mgc-4"/><a name="798"/>  798: <b>start_mgc</b>(Node, Mid, ET, Verbosity) -&gt;
<a name="799"/>  799:     d(&quot;start mgc[~p]: ~p&quot;, [Node, Mid]),
<a name="800"/>  800:     RI = {receive_info, mk_recv_info(ET)},
<a name="801"/>  801:     Config = [{local_mid, Mid}, RI],
<a name="802"/>  802:     Pid = spawn_link(Node, ?MODULE, mgc, [self(), Verbosity, Config]),
<a name="start_mgc-last_expr"/><a name="803"/>  803: <b>    await_started</b>(Pid).
<a name="804"/>  804: 
<a name="mk_recv_info-1"/><a name="805"/>  805: <b>mk_recv_info</b>(ET) -&gt;
<a name="mk_recv_info-last_expr"/><a name="806"/>  806: <b>    mk_recv_info</b>(ET, []).
<a name="807"/>  807: 
<a name="mk_recv_info-2"/><a name="808"/>  808: <b>mk_recv_info</b>([], Acc) -&gt;
<a name="809"/>  809:     Acc;
<a name="810"/>  810: <b>mk_recv_info</b>([{text,tcp}|ET], Acc) -&gt;
<a name="811"/>  811:     RI = [{encoding_module, megaco_pretty_text_encoder},
<a name="812"/>  812: 	  {encoding_config, []},
<a name="813"/>  813: 	  {transport_module, megaco_tcp},
<a name="814"/>  814: 	  {port, 2944}],
<a name="815"/>  815:     mk_recv_info(ET, [RI|Acc]);
<a name="816"/>  816: <b>mk_recv_info</b>([{text,udp}|ET], Acc) -&gt;
<a name="817"/>  817:     RI = [{encoding_module, megaco_pretty_text_encoder},
<a name="818"/>  818: 	  {encoding_config, []},
<a name="819"/>  819: 	  {transport_module, megaco_udp},
<a name="820"/>  820: 	  {port, 2944}],
<a name="821"/>  821:     mk_recv_info(ET, [RI|Acc]);
<a name="822"/>  822: <b>mk_recv_info</b>([{binary,tcp}|ET], Acc) -&gt;
<a name="823"/>  823:     RI = [{encoding_module, megaco_ber_encoder},
<a name="824"/>  824: 	  {encoding_config, []},
<a name="825"/>  825: 	  {transport_module, megaco_tcp},
<a name="826"/>  826: 	  {port, 2945}],
<a name="827"/>  827:     mk_recv_info(ET, [RI|Acc]);
<a name="828"/>  828: <b>mk_recv_info</b>([{binary,udp}|ET], Acc) -&gt;
<a name="829"/>  829:     RI = [{encoding_module, megaco_ber_encoder},
<a name="830"/>  830: 	  {encoding_config, []},
<a name="831"/>  831: 	  {transport_module, megaco_udp},
<a name="832"/>  832: 	  {port, 2945}],
<a name="833"/>  833:     mk_recv_info(ET, [RI|Acc]);
<a name="834"/>  834: <b>mk_recv_info</b>([ET|_], _) -&gt;
<a name="mk_recv_info-last_expr"/><a name="835"/>  835: <b>    throw</b>({error, {invaalid_encoding_transport, ET}}).
<a name="836"/>  836: 
<a name="mgc-3"/><a name="837"/>  837: <b>mgc</b>(Parent, Verbosity, Config) -&gt;
<a name="838"/>  838:     process_flag(trap_exit, true),
<a name="839"/>  839:     put(verbosity, Verbosity),
<a name="840"/>  840:     put(sname,   &quot;MGC&quot;),
<a name="841"/>  841:     i(&quot;mgc -&gt; starting&quot;),
<a name="842"/>  842:     {Mid, TcpSup, UdpSup} = mgc_init(Config),
<a name="843"/>  843:     notify_started(Parent),
<a name="844"/>  844:     S = #mgc{parent = Parent, 
<a name="845"/>  845: 	     tcp_sup = TcpSup, udp_sup = UdpSup, mid = Mid},
<a name="846"/>  846:     i(&quot;mgc -&gt; started&quot;),
<a name="mgc-last_expr"/><a name="847"/>  847: <b>    mgc_loop</b>(S).
<a name="848"/>  848: 
<a name="mgc_init-1"/><a name="849"/>  849: <b>mgc_init</b>(Config) -&gt;
<a name="850"/>  850:     d(&quot;mgc_init -&gt; entry&quot;),
<a name="851"/>  851:     Mid = get_conf(local_mid, Config),
<a name="852"/>  852:     RI  = get_conf(receive_info, Config),
<a name="853"/>  853:     i(&quot;mgc_init -&gt; start megaco&quot;),
<a name="854"/>  854:     application:start(megaco),
<a name="855"/>  855:     d(&quot;mgc_init -&gt; start megaco user&quot;),
<a name="856"/>  856:     megaco:start_user(Mid, []),
<a name="857"/>  857:     d(&quot;mgc_init -&gt; update user info (user_mod)&quot;),
<a name="858"/>  858:     megaco:update_user_info(Mid, user_mod,  ?MODULE),
<a name="859"/>  859:     d(&quot;mgc_init -&gt; update user info (user_args)&quot;),
<a name="860"/>  860:     megaco:update_user_info(Mid, user_args, [self()]),
<a name="861"/>  861:     d(&quot;mgc_init -&gt; get user info (receive_handle)&quot;),
<a name="862"/>  862:     RH = megaco:user_info(Mid,receive_handle),
<a name="863"/>  863:     d(&quot;mgc_init -&gt; parse receive info&quot;),
<a name="864"/>  864:     ListenTo = mgc_parse_receive_info(RI, RH),
<a name="865"/>  865:     i(&quot;mgc_init -&gt; start transport(s) with:&quot;
<a name="866"/>  866:       &quot;~n      ListenTo: ~p&quot;, [ListenTo]),
<a name="867"/>  867:     {Tcp, Udp} = mgc_start_transports(ListenTo),
<a name="868"/>  868:     i(&quot;mgc_init -&gt; transport(s) started:&quot;
<a name="869"/>  869:       &quot;~n      Tcp: ~p&quot;
<a name="870"/>  870:       &quot;~n      Udp: ~p&quot;, [Tcp, Udp]),
<a name="mgc_init-last_expr"/><a name="871"/>  871:     {Mid, Tcp, Udp}.
<a name="872"/>  872:     
<a name="873"/>  873: 
<a name="mgc_loop-1"/><a name="874"/>  874: <b>mgc_loop</b>(S) -&gt;
<a name="875"/>  875:     d(&quot;mgc_loop -&gt; await request&quot;),
<a name="mgc_loop-last_expr"/><a name="876"/>  876:     receive
<a name="877"/>  877: 	{stop, Parent} when S#mgc.parent == Parent -&gt;
<a name="878"/>  878: 	    i(&quot;mgc_loop -&gt; stopping&quot;, []),
<a name="879"/>  879:   	    Mid = S#mgc.mid,
<a name="880"/>  880: 	    (catch mgc_close_conns(Mid)),
<a name="881"/>  881: 	    megaco:stop_user(Mid),
<a name="882"/>  882: 	    application:stop(megaco),
<a name="883"/>  883: 	    i(&quot;mgc_loop -&gt; stopped&quot;, []),
<a name="884"/>  884: 	    Parent ! {stopped, self()},
<a name="885"/>  885: 	    exit(normal);
<a name="886"/>  886: 
<a name="887"/>  887: 
<a name="888"/>  888: 
<a name="889"/>  889: 	%% Reset stats
<a name="890"/>  890: 	{reset_stats, Parent} when S#mgc.parent == Parent -&gt;
<a name="891"/>  891: 	    i(&quot;mgc_loop -&gt; got request to reset stats counters&quot;),
<a name="892"/>  892: 	    mgc_reset_stats(S#mgc.mid),
<a name="893"/>  893: 	    Parent ! {reset_stats_ack, self()},
<a name="894"/>  894: 	    mgc_loop(S);
<a name="895"/>  895: 
<a name="896"/>  896: 
<a name="897"/>  897: 	%% Give me statistics
<a name="898"/>  898: 	{statistics, 1, Parent} when S#mgc.parent == Parent -&gt;
<a name="899"/>  899: 	    i(&quot;mgc_loop -&gt; got request for statistics 1&quot;),
<a name="900"/>  900: 	    {ok, Gen} = megaco:get_stats(),
<a name="901"/>  901: 	    GetTrans = 
<a name="902"/>  902: 		fun(CH) -&gt;
<a name="903"/>  903: 			Reason = {statistics, CH}, 
<a name="904"/>  904: 			Pid = megaco:conn_info(CH, control_pid),
<a name="905"/>  905: 			SendMod = megaco:conn_info(CH, send_mod),
<a name="906"/>  906: 			SendHandle = megaco:conn_info(CH, send_handle),
<a name="907"/>  907: 			{ok, Stats} = 
<a name="908"/>  908: 			    case SendMod of
<a name="909"/>  909: 				megaco_tcp -&gt; megaco_tcp:get_stats(SendHandle);
<a name="910"/>  910: 				megaco_udp -&gt; megaco_udp:get_stats(SendHandle);
<a name="911"/>  911: 				SendMod    -&gt; exit(Pid, Reason)
<a name="912"/>  912: 			    end,
<a name="913"/>  913: 			{SendHandle, Stats}
<a name="914"/>  914: 		end,
<a name="915"/>  915: 	    Mid = S#mgc.mid,
<a name="916"/>  916: 	    Trans = 
<a name="917"/>  917: 		lists:map(GetTrans, megaco:user_info(Mid, connections)),
<a name="918"/>  918: 	    Parent ! {statistics, 1, [{gen, Gen}, {trans, Trans}], self()},
<a name="919"/>  919: 	    mgc_loop(S);
<a name="920"/>  920: 
<a name="921"/>  921: 
<a name="922"/>  922: 	{statistics, 2, Parent} when S#mgc.parent == Parent -&gt;
<a name="923"/>  923: 	    i(&quot;mgc_loop -&gt; got request for statistics 2&quot;),
<a name="924"/>  924: 	    {ok, Gen} = megaco:get_stats(),
<a name="925"/>  925: 	    #mgc{tcp_sup = TcpSup, udp_sup = UdpSup} = S,
<a name="926"/>  926: 	    TcpStats = get_trans_stats(TcpSup, megaco_tcp),
<a name="927"/>  927: 	    UdpStats = get_trans_stats(UdpSup, megaco_udp),
<a name="928"/>  928: 	    Parent ! {statistics, 2, [{gen, Gen}, {trans, [TcpStats, UdpStats]}], self()},
<a name="929"/>  929: 	    mgc_loop(S);
<a name="930"/>  930: 
<a name="931"/>  931: 
<a name="932"/>  932: 	%% Megaco callback messages
<a name="933"/>  933: 	{request, Request, From} -&gt;
<a name="934"/>  934: 	    d(&quot;mgc_loop -&gt; received megaco request: ~n~p~n   From: ~p&quot;, 
<a name="935"/>  935: 	      [Request, From]),
<a name="936"/>  936: 	    Reply = mgc_handle_request(Request),
<a name="937"/>  937: 	    d(&quot;mgc_loop -&gt; send request reply: ~n~p&quot;, [Reply]),
<a name="938"/>  938: 	    From ! {reply, Reply, self()},
<a name="939"/>  939: 	    mgc_loop(S);
<a name="940"/>  940: 
<a name="941"/>  941: 
<a name="942"/>  942: 	{'EXIT', Pid, Reason} -&gt;
<a name="943"/>  943: 	    error_msg(&quot;MGC received unexpected exit signal from ~p:~n~p&quot;, 
<a name="944"/>  944: 		      [Pid, Reason]),
<a name="945"/>  945: 	    mgc_loop(S);
<a name="946"/>  946: 
<a name="947"/>  947: 
<a name="948"/>  948: 	Invalid -&gt;
<a name="949"/>  949: 	    i(&quot;mgc_loop -&gt; received invalid request: ~p&quot;, [Invalid]),
<a name="950"/>  950: 	    mgc_loop(S)
<a name="951"/>  951:     end.
<a name="952"/>  952: 
<a name="953"/>  953: 
<a name="mgc_reset_stats-1"/><a name="954"/>  954: <b>mgc_reset_stats</b>(Mid) -&gt;
<a name="955"/>  955:     megaco:reset_stats(),
<a name="mgc_reset_stats-last_expr"/><a name="956"/>  956: <b>    mgc_reset_trans_stats</b>(megaco:user_info(Mid, connections), []).
<a name="957"/>  957: 
<a name="mgc_reset_trans_stats-2"/><a name="958"/>  958: <b>mgc_reset_trans_stats</b>([], _Reset) -&gt;
<a name="959"/>  959:     ok;
<a name="960"/>  960: <b>mgc_reset_trans_stats</b>([CH|CHs], Reset) -&gt;
<a name="961"/>  961:     SendMod = megaco:conn_info(CH, send_mod),
<a name="mgc_reset_trans_stats-last_expr"/><a name="962"/>  962: <b>    case lists:member</b>(SendMod, Reset) of
<a name="963"/>  963: 	true -&gt;
<a name="964"/>  964: 	    mgc_reset_trans_stats(CHs, Reset);
<a name="965"/>  965: 	false -&gt;
<a name="966"/>  966: 	    SendMod:reset_stats(),
<a name="967"/>  967: 	    mgc_reset_trans_stats(CHs, [SendMod|Reset])
<a name="968"/>  968:     end.
<a name="969"/>  969: 	    
<a name="970"/>  970: 
<a name="mgc_close_conns-1"/><a name="971"/>  971: <b>mgc_close_conns</b>(Mid) -&gt;
<a name="972"/>  972:     Reason = {self(), ignore},
<a name="973"/>  973:     Disco  = fun(CH) -&gt;
<a name="974"/>  974: 		     (catch mgc_close_conn(CH, Reason))
<a name="975"/>  975: 	     end,
<a name="mgc_close_conns-last_expr"/><a name="976"/>  976: <b>    lists:map</b>(Disco, megaco:user_info(Mid, connections)).
<a name="977"/>  977: 
<a name="mgc_close_conn-2"/><a name="978"/>  978: <b>mgc_close_conn</b>(CH, Reason) -&gt;
<a name="979"/>  979:     d(&quot;close connection to ~p&quot;, [CH#megaco_conn_handle.remote_mid]),
<a name="980"/>  980:     Pid        = megaco:conn_info(CH, control_pid),
<a name="981"/>  981:     SendMod    = megaco:conn_info(CH, send_mod),
<a name="982"/>  982:     SendHandle = megaco:conn_info(CH, send_handle),
<a name="983"/>  983:     megaco:disconnect(CH, Reason),
<a name="mgc_close_conn-last_expr"/><a name="984"/>  984:     case SendMod of
<a name="985"/>  985: 	megaco_tcp -&gt; megaco_tcp:close(SendHandle);
<a name="986"/>  986: 	megaco_udp -&gt; megaco_udp:close(SendHandle);
<a name="987"/>  987: 	SendMod    -&gt; exit(Pid, Reason)
<a name="988"/>  988:     end.
<a name="989"/>  989:     
<a name="get_trans_stats-2"/><a name="990"/>  990: <b>get_trans_stats</b>(P, SendMod) when is_pid(P) -&gt;
<a name="991"/>  991:     case (catch SendMod:get_stats()) of
<a name="992"/>  992: 	{ok, Stats} -&gt;
<a name="993"/>  993: 	    {SendMod, Stats};
<a name="994"/>  994: 	Else -&gt;
<a name="995"/>  995: 	    {SendMod, Else}
<a name="996"/>  996:     end;
<a name="997"/>  997: <b>get_trans_stats</b>(_P, SendMod) -&gt;
<a name="get_trans_stats-last_expr"/><a name="998"/>  998:     {SendMod, undefined}.
<a name="999"/>  999: 
<a name="mgc_parse_receive_info-2"/><a name="1000"/> 1000: <b>mgc_parse_receive_info</b>([], _RH) -&gt;
<a name="1001"/> 1001:     throw({error, no_receive_info});
<a name="1002"/> 1002: <b>mgc_parse_receive_info</b>(RI, RH) -&gt;
<a name="mgc_parse_receive_info-last_expr"/><a name="1003"/> 1003: <b>    mgc_parse_receive_info</b>(RI, RH, []).
<a name="1004"/> 1004: 
<a name="mgc_parse_receive_info-3"/><a name="1005"/> 1005: <b>mgc_parse_receive_info</b>([], _RH, ListenTo) -&gt;
<a name="1006"/> 1006:     ListenTo;
<a name="1007"/> 1007: <b>mgc_parse_receive_info</b>([RI|RIs], RH, ListenTo) -&gt;
<a name="1008"/> 1008:     d(&quot;mgc_parse_receive_info -&gt; parse receive info&quot;),
<a name="1009"/> 1009:     RH1 = mgc_parse_receive_info1(RI, RH),
<a name="mgc_parse_receive_info-last_expr"/><a name="1010"/> 1010: <b>    case </b>(catch mgc_parse_receive_info1(RI, RH)) of
<a name="1011"/> 1011: 	{error, Reason} -&gt;
<a name="1012"/> 1012: 	    i(&quot;failed parsing receive info: ~p~n~p&quot;, [RI, Reason]),
<a name="1013"/> 1013: 	    exit({failed_parsing_recv_info, RI, Reason});
<a name="1014"/> 1014: 	RH1 -&gt;
<a name="1015"/> 1015: 	    mgc_parse_receive_info(RIs, RH, [RH1|ListenTo])
<a name="1016"/> 1016:     end.
<a name="1017"/> 1017:     
<a name="mgc_parse_receive_info1-2"/><a name="1018"/> 1018: <b>mgc_parse_receive_info1</b>(RI, RH) -&gt;
<a name="1019"/> 1019:     d(&quot;mgc_parse_receive_info1 -&gt; get encoding module&quot;),
<a name="1020"/> 1020:     EM = get_encoding_module(RI),
<a name="1021"/> 1021:     d(&quot;mgc_parse_receive_info1 -&gt; get encoding config&quot;),
<a name="1022"/> 1022:     EC = get_encoding_config(RI, EM),
<a name="1023"/> 1023:     d(&quot;mgc_parse_receive_info1 -&gt; get transport module&quot;),
<a name="1024"/> 1024:     TM = get_transport_module(RI),
<a name="1025"/> 1025:     d(&quot;mgc_parse_receive_info1 -&gt; get transport port&quot;),
<a name="1026"/> 1026:     TP = get_transport_port(RI),
<a name="1027"/> 1027:     RH1 = RH#megaco_receive_handle{send_mod        = TM,
<a name="1028"/> 1028: 				   encoding_mod    = EM,
<a name="1029"/> 1029: 				   encoding_config = EC},
<a name="mgc_parse_receive_info1-last_expr"/><a name="1030"/> 1030:     {TP, RH1}.
<a name="1031"/> 1031: 
<a name="1032"/> 1032: 
<a name="mgc_start_transports-1"/><a name="1033"/> 1033: <b>mgc_start_transports</b>([]) -&gt;
<a name="1034"/> 1034:     throw({error, no_transport});
<a name="1035"/> 1035: <b>mgc_start_transports</b>(ListenTo) -&gt;
<a name="mgc_start_transports-last_expr"/><a name="1036"/> 1036: <b>    mgc_start_transports</b>(ListenTo, undefined, undefined).
<a name="1037"/> 1037:     
<a name="1038"/> 1038: 
<a name="mgc_start_transports-3"/><a name="1039"/> 1039: <b>mgc_start_transports</b>([], TcpSup, UdpSup) -&gt;
<a name="1040"/> 1040:     {TcpSup, UdpSup};
<a name="1041"/> 1041: <b>mgc_start_transports</b>([{Port, RH}|ListenTo], TcpSup, UdpSup) 
<a name="1042"/> 1042:   when RH#megaco_receive_handle.send_mod == megaco_tcp -&gt;
<a name="1043"/> 1043:     TcpSup1 = mgc_start_tcp(RH, Port, TcpSup),
<a name="1044"/> 1044:     mgc_start_transports(ListenTo, TcpSup1, UdpSup);
<a name="1045"/> 1045: <b>mgc_start_transports</b>([{Port, RH}|ListenTo], TcpSup, UdpSup) 
<a name="1046"/> 1046:   when RH#megaco_receive_handle.send_mod == megaco_udp -&gt;
<a name="1047"/> 1047:     UdpSup1 = mgc_start_udp(RH, Port, UdpSup),
<a name="1048"/> 1048:     mgc_start_transports(ListenTo, TcpSup, UdpSup1);
<a name="1049"/> 1049: <b>mgc_start_transports</b>([{_Port, RH}|_ListenTo], _TcpSup, _UdpSup) -&gt;
<a name="mgc_start_transports-last_expr"/><a name="1050"/> 1050: <b>    throw</b>({error, {bad_send_mod, RH#megaco_receive_handle.send_mod}}).
<a name="1051"/> 1051: 
<a name="1052"/> 1052: 
<a name="mgc_start_tcp-3"/><a name="1053"/> 1053: <b>mgc_start_tcp</b>(RH, Port, undefined) -&gt;
<a name="1054"/> 1054:     i(&quot;start tcp transport&quot;),
<a name="1055"/> 1055:     case megaco_tcp:start_transport() of
<a name="1056"/> 1056: 	{ok, Sup} -&gt;
<a name="1057"/> 1057: 	    mgc_start_tcp(RH, Port, Sup);
<a name="1058"/> 1058: 	Else -&gt;
<a name="1059"/> 1059: 	    throw({error, {failed_starting_tcp_transport, Else}})
<a name="1060"/> 1060:     end;
<a name="1061"/> 1061: <b>mgc_start_tcp</b>(RH, Port, Sup) when is_pid(Sup) -&gt;
<a name="1062"/> 1062:     i(&quot;tcp listen on ~p&quot;, [Port]),
<a name="1063"/> 1063:     Opts = [{port,           Port}, 
<a name="1064"/> 1064: 	    {receive_handle, RH}, 
<a name="1065"/> 1065: 	    {tcp_options,    [{nodelay, true}]}],
<a name="mgc_start_tcp-last_expr"/><a name="1066"/> 1066: <b>    mgc_tcp_create_listen</b>(Sup, Opts, 3).
<a name="1067"/> 1067: 
<a name="mgc_tcp_create_listen-3"/><a name="1068"/> 1068: <b>mgc_tcp_create_listen</b>(Sup, Opts, N) -&gt;
<a name="mgc_tcp_create_listen-last_expr"/><a name="1069"/> 1069: <b>    mgc_tcp_create_listen</b>(Sup, Opts, N, 1, undefined).
<a name="1070"/> 1070: 
<a name="mgc_tcp_create_listen-5"/><a name="1071"/> 1071: <b>mgc_tcp_create_listen</b>(_Sup, _Opts, N, N, InitialReason) -&gt;
<a name="1072"/> 1072:     d(&quot;failed creating mgc tcp listen socket after ~p tries: ~p&quot;, 
<a name="1073"/> 1073:       [N, InitialReason]),
<a name="1074"/> 1074:     throw({error, {failed_starting_tcp_listen, InitialReason}});
<a name="1075"/> 1075: <b>mgc_tcp_create_listen</b>(Sup, Opts, MaxN, N, _InitialReason) 
<a name="1076"/> 1076:   when is_integer(N) andalso is_integer(MaxN) andalso (MaxN &gt; N) -&gt;
<a name="1077"/> 1077:     d(&quot;try create mgc tcp listen socket [~w]&quot;, [N]),
<a name="mgc_tcp_create_listen-last_expr"/><a name="1078"/> 1078: <b>    case megaco_tcp:listen</b>(Sup, Opts) of
<a name="1079"/> 1079: 	ok -&gt;
<a name="1080"/> 1080: 	    Sup;
<a name="1081"/> 1081: 	{error, {could_not_start_listener, {gen_tcp_listen, eaddrinuse} = Reason}} -&gt;
<a name="1082"/> 1082: 	    ?SLEEP(N * 200),
<a name="1083"/> 1083: 	    mgc_tcp_create_listen(Sup, Opts, MaxN, N + 1, Reason);
<a name="1084"/> 1084: 	{error, Reason} -&gt;
<a name="1085"/> 1085: 	    throw({error, {failed_starting_tcp_listen, Reason}});
<a name="1086"/> 1086: 	Else -&gt;
<a name="1087"/> 1087: 	    throw({error, {failed_starting_tcp_listen, Else}})
<a name="1088"/> 1088:     end.
<a name="1089"/> 1089: 
<a name="1090"/> 1090: 
<a name="mgc_start_udp-3"/><a name="1091"/> 1091: <b>mgc_start_udp</b>(RH, Port, undefined) -&gt;
<a name="1092"/> 1092:     i(&quot;start udp transport&quot;),
<a name="1093"/> 1093:     case megaco_udp:start_transport() of
<a name="1094"/> 1094: 	{ok, Sup} -&gt;
<a name="1095"/> 1095: 	    mgc_start_udp(RH, Port, Sup);
<a name="1096"/> 1096: 	Else -&gt;
<a name="1097"/> 1097: 	    throw({error, {failed_starting_udp_transport, Else}})
<a name="1098"/> 1098:     end;
<a name="1099"/> 1099: <b>mgc_start_udp</b>(RH, Port, Sup) -&gt;
<a name="1100"/> 1100:     i(&quot;open udp ~p&quot;, [Port]),
<a name="1101"/> 1101:     Opts = [{port, Port}, {receive_handle, RH}],
<a name="mgc_start_udp-last_expr"/><a name="1102"/> 1102: <b>    case megaco_udp:open</b>(Sup, Opts) of
<a name="1103"/> 1103: 	{ok, _SendHandle, _ControlPid} -&gt;
<a name="1104"/> 1104: 	    Sup;
<a name="1105"/> 1105: 	Else -&gt;
<a name="1106"/> 1106: 	    exit({error, {failed_starting_udp_listen, Else}})
<a name="1107"/> 1107:     end.
<a name="1108"/> 1108: 
<a name="1109"/> 1109: 
<a name="1110"/> 1110: 
<a name="1111"/> 1111: <i>%% -----------------------</i>
<a name="1112"/> 1112: <i>%% Handle megaco callbacks</i>
<a name="1113"/> 1113: <i>%%</i>
<a name="1114"/> 1114: 
<a name="mgc_handle_request-1"/><a name="1115"/> 1115: <b>mgc_handle_request</b>({handle_connect, _CH, _PV}) -&gt;
<a name="1116"/> 1116:     ok;
<a name="1117"/> 1117: <b>mgc_handle_request</b>({handle_disconnect, CH, _PV, R}) -&gt;
<a name="1118"/> 1118:     megaco:cancel(CH, R), % Cancel the outstanding messages
<a name="1119"/> 1119:     ok;
<a name="1120"/> 1120: <b>mgc_handle_request</b>({handle_syntax_error, _RH, _PV, _ED}) -&gt;
<a name="1121"/> 1121:     %% There is no point in this test where this is expected.
<a name="1122"/> 1122:     %% There if it *does* happen; stop 
<a name="1123"/> 1123:     no_reply;
<a name="1124"/> 1124: <b>mgc_handle_request</b>({handle_message_error, _CH, _PV, _ED}) -&gt;
<a name="1125"/> 1125:     no_reply;
<a name="1126"/> 1126: <b>mgc_handle_request</b>({handle_trans_request, CH, PV, ARs}) -&gt;
<a name="1127"/> 1127:     ED =  #'ErrorDescriptor'{errorCode = ?megaco_not_implemented,
<a name="1128"/> 1128:                              errorText = &quot;Only single service change on null context handled&quot;},
<a name="1129"/> 1129:     case ARs of
<a name="1130"/> 1130:         [AR] -&gt;
<a name="1131"/> 1131:             ContextId = AR#'ActionRequest'.contextId,
<a name="1132"/> 1132:             case AR#'ActionRequest'.commandRequests of
<a name="1133"/> 1133:                 [CR] when ContextId == ?megaco_null_context_id -&gt;
<a name="1134"/> 1134:                     case CR#'CommandRequest'.command of
<a name="1135"/> 1135:                         {serviceChangeReq, Req} -&gt;
<a name="1136"/> 1136:                             Rep    = mgc_service_change(CH, PV, Req),
<a name="1137"/> 1137: 			    CmdRep = [{serviceChangeReply, Rep}],
<a name="1138"/> 1138:                             {discard_ack,
<a name="1139"/> 1139:                              [#'ActionReply'{contextId    = ContextId,
<a name="1140"/> 1140:                                              commandReply = CmdRep}]};
<a name="1141"/> 1141:                         _ -&gt;
<a name="1142"/> 1142:                             {discard_ack, ED}
<a name="1143"/> 1143:                     end;
<a name="1144"/> 1144:                 _ -&gt;
<a name="1145"/> 1145:                     {discard_ack, ED}
<a name="1146"/> 1146:             end;
<a name="1147"/> 1147:         _ -&gt;
<a name="1148"/> 1148:             {discard_ack, ED}
<a name="1149"/> 1149:     end;
<a name="1150"/> 1150: <b>mgc_handle_request</b>({handle_trans_long_request, _CH, _PV, _RD}) -&gt;
<a name="1151"/> 1151:     ED = #'ErrorDescriptor'{errorCode = ?megaco_not_implemented,
<a name="1152"/> 1152:                             errorText = &quot;Long transaction requests not handled&quot;},
<a name="1153"/> 1153:     {discard_ack,  ED};
<a name="1154"/> 1154: <b>mgc_handle_request</b>({handle_trans_reply, _CH, _PV, _AR, _RD}) -&gt;
<a name="1155"/> 1155:     ok;
<a name="1156"/> 1156: <b>mgc_handle_request</b>({handle_trans_ack, _CH, _PV, _AS, _AD}) -&gt;
<a name="mgc_handle_request-last_expr"/><a name="1157"/> 1157:     ok.
<a name="1158"/> 1158: 
<a name="mgc_service_change-3"/><a name="1159"/> 1159: <b>mgc_service_change</b>(CH, _PV, SCR) -&gt;
<a name="1160"/> 1160:     SCP = SCR#'ServiceChangeRequest'.serviceChangeParms,
<a name="1161"/> 1161:     #'ServiceChangeParm'{serviceChangeAddress = Address,
<a name="1162"/> 1162:                          serviceChangeProfile = Profile,
<a name="1163"/> 1163:                          serviceChangeReason  = [_Reason]} = SCP,
<a name="1164"/> 1164:     TermId = SCR#'ServiceChangeRequest'.terminationID,
<a name="mgc_service_change-last_expr"/><a name="1165"/> 1165:     if
<a name="1166"/> 1166:         TermId == [?megaco_root_termination_id] -&gt;
<a name="1167"/> 1167:             MyMid = CH#megaco_conn_handle.local_mid,
<a name="1168"/> 1168:             Res = {serviceChangeResParms,
<a name="1169"/> 1169:                    #'ServiceChangeResParm'{serviceChangeMgcId   = MyMid,
<a name="1170"/> 1170:                                            serviceChangeAddress = Address,
<a name="1171"/> 1171:                                            serviceChangeProfile = Profile}},
<a name="1172"/> 1172:             #'ServiceChangeReply'{terminationID       = TermId,
<a name="1173"/> 1173:                                   serviceChangeResult = Res};
<a name="1174"/> 1174:         true -&gt;
<a name="1175"/> 1175:             Res = {errorDescriptor,
<a name="1176"/> 1176:                    #'ErrorDescriptor'{errorCode = ?megaco_not_implemented,
<a name="1177"/> 1177:                                       errorText = &quot;Only handled for root&quot;}},
<a name="1178"/> 1178:             
<a name="1179"/> 1179:              #'ServiceChangeReply'{terminationID       = TermId,
<a name="1180"/> 1180:                                    serviceChangeResult = Res}
<a name="1181"/> 1181:     end.
<a name="1182"/> 1182: 
<a name="1183"/> 1183:     
<a name="1184"/> 1184: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1185"/> 1185: 
<a name="start_mg-5"/><a name="1186"/> 1186: <b>start_mg</b>(Node, Mid, Encoding, Transport, Verbosity) -&gt;
<a name="1187"/> 1187:     d(&quot;start mg[~p]: ~p&quot;, [Node, Mid]),
<a name="1188"/> 1188:     RI1 = 
<a name="1189"/> 1189: 	case Encoding of 
<a name="1190"/> 1190: 	    text -&gt;
<a name="1191"/> 1191: 		[{encoding_module, megaco_pretty_text_encoder},
<a name="1192"/> 1192: 		 {encoding_config, []},
<a name="1193"/> 1193: 		 {port,2944}];
<a name="1194"/> 1194: 	    binary -&gt;
<a name="1195"/> 1195: 		[{encoding_module, megaco_ber_encoder},
<a name="1196"/> 1196: 		 {encoding_config, []},
<a name="1197"/> 1197: 		 {port,2945}]
<a name="1198"/> 1198: 	end,
<a name="1199"/> 1199:     RI2 = 
<a name="1200"/> 1200: 	case Transport of
<a name="1201"/> 1201: 	    tcp -&gt;
<a name="1202"/> 1202: 		[{transport_module, megaco_tcp}];
<a name="1203"/> 1203: 	    udp -&gt;
<a name="1204"/> 1204: 		[{transport_module, megaco_udp}]
<a name="1205"/> 1205: 	end,
<a name="1206"/> 1206:     RI = {receive_info, RI1 ++ RI2},
<a name="1207"/> 1207:     Config = [{local_mid, Mid}, RI],
<a name="1208"/> 1208:     Pid = spawn_link(Node, ?MODULE, mg, [self(), Verbosity, Config]),
<a name="start_mg-last_expr"/><a name="1209"/> 1209: <b>    await_started</b>(Pid).
<a name="1210"/> 1210: 
<a name="1211"/> 1211: 
<a name="mg-3"/><a name="1212"/> 1212: <b>mg</b>(Parent, Verbosity, Config) -&gt;
<a name="1213"/> 1213:     process_flag(trap_exit, true),
<a name="1214"/> 1214:     put(verbosity, Verbosity),
<a name="1215"/> 1215:     put(sname,     get_mg_sname(Config)),
<a name="1216"/> 1216:     i(&quot;mg -&gt; starting&quot;),
<a name="1217"/> 1217:     {Mid, ConnHandle} = mg_init(Config),
<a name="1218"/> 1218:     notify_started(Parent),
<a name="1219"/> 1219:     S = #mg{parent = Parent, mid = Mid, conn_handle = ConnHandle},
<a name="1220"/> 1220:     i(&quot;mg -&gt; started&quot;),
<a name="mg-last_expr"/><a name="1221"/> 1221: <b>    mg_loop</b>(S).
<a name="1222"/> 1222: 
<a name="get_mg_sname-1"/><a name="1223"/> 1223: <b>get_mg_sname</b>(Config) -&gt;
<a name="get_mg_sname-last_expr"/><a name="1224"/> 1224: <b>    case get_conf</b>(local_mid, Config) of
<a name="1225"/> 1225:         {deviceName, Name} -&gt;
<a name="1226"/> 1226:             Name;
<a name="1227"/> 1227:         _ -&gt;
<a name="1228"/> 1228:             &quot;MG&quot;
<a name="1229"/> 1229: end.
<a name="1230"/> 1230: 
<a name="mg_init-1"/><a name="1231"/> 1231: <b>mg_init</b>(Config) -&gt;
<a name="1232"/> 1232:     d(&quot;mg_init -&gt; entry&quot;),
<a name="1233"/> 1233:     Mid = get_conf(local_mid, Config),
<a name="1234"/> 1234:     RI  = get_conf(receive_info, Config),
<a name="1235"/> 1235:     i(&quot;mg_init -&gt; start megaco&quot;),
<a name="1236"/> 1236:     application:start(megaco),
<a name="1237"/> 1237:     d(&quot;mg_init -&gt; start megaco user&quot;),
<a name="1238"/> 1238:     megaco:start_user(Mid, []),
<a name="1239"/> 1239:     d(&quot;mg_init -&gt; update user info (user_mod)&quot;),
<a name="1240"/> 1240:     megaco:update_user_info(Mid, user_mod,  ?MODULE),
<a name="1241"/> 1241:     d(&quot;mg_init -&gt; update user info (user_args)&quot;),
<a name="1242"/> 1242:     megaco:update_user_info(Mid, user_args, [self()]),
<a name="1243"/> 1243:     d(&quot;mg_init -&gt; get user info (receive_handle)&quot;),
<a name="1244"/> 1244:     RH = megaco:user_info(Mid,receive_handle),
<a name="1245"/> 1245:     d(&quot;mg_init -&gt; parse receive info&quot;),
<a name="1246"/> 1246:     {MgcPort,RH1} = mg_parse_receive_info(RI, RH),
<a name="1247"/> 1247:     i(&quot;mg_init -&gt; start transport(s)&quot;),
<a name="1248"/> 1248:     ConnHandle = mg_start_transport(MgcPort, RH1),
<a name="mg_init-last_expr"/><a name="1249"/> 1249:     {Mid, ConnHandle}.
<a name="1250"/> 1250: 
<a name="mg_loop-1"/><a name="1251"/> 1251: <b>mg_loop</b>(#mg{state = State} = S) -&gt;
<a name="1252"/> 1252:     d(&quot;mg_loop(~p) -&gt; await request&quot;, [State]),
<a name="mg_loop-last_expr"/><a name="1253"/> 1253:     receive
<a name="1254"/> 1254: 	{stop, Parent} when S#mg.parent == Parent -&gt;
<a name="1255"/> 1255: 	    i(&quot;mg_loop(~p) -&gt; stopping&quot;, [State]),
<a name="1256"/> 1256: 	    mg_close_conn(S#mg.conn_handle),
<a name="1257"/> 1257: 	    megaco:stop_user(S#mg.mid),
<a name="1258"/> 1258: 	    application:stop(megaco),
<a name="1259"/> 1259: 	    i(&quot;mg_loop(~p) -&gt; stopped&quot;, [State]),
<a name="1260"/> 1260: 	    Parent ! {stopped, self()},
<a name="1261"/> 1261: 	    exit(normal);
<a name="1262"/> 1262: 
<a name="1263"/> 1263: 
<a name="1264"/> 1264: 	{reset_stats, Parent} when S#mg.parent == Parent -&gt;
<a name="1265"/> 1265: 	    i(&quot;mg_loop(~p) -&gt; got request to reset stats counters&quot;, [State]),
<a name="1266"/> 1266: 	    %% mg_reset_stats(S#mgc.conn_handle),
<a name="1267"/> 1267: 	    mg_reset_stats(S#mg.conn_handle),
<a name="1268"/> 1268: 	    Parent ! {reset_stats_ack, self()},
<a name="1269"/> 1269: 	    mg_loop(S);
<a name="1270"/> 1270: 
<a name="1271"/> 1271: 
<a name="1272"/> 1272: 
<a name="1273"/> 1273: 	%% Give me statistics
<a name="1274"/> 1274: 	{statistics, 1, Parent} when S#mg.parent == Parent -&gt;
<a name="1275"/> 1275: 	    i(&quot;mg_loop(~p) -&gt; got request for statistics 1&quot;, [State]),
<a name="1276"/> 1276: 	    {ok, Gen}   = megaco:get_stats(),
<a name="1277"/> 1277: 	    CH          = S#mg.conn_handle,
<a name="1278"/> 1278: 	    Reason      = {statistics, CH}, 
<a name="1279"/> 1279: 	    Pid         = megaco:conn_info(CH, control_pid),
<a name="1280"/> 1280: 	    SendMod     = megaco:conn_info(CH, send_mod),
<a name="1281"/> 1281: 	    SendHandle  = megaco:conn_info(CH, send_handle),
<a name="1282"/> 1282: 	    {ok, Trans} = 
<a name="1283"/> 1283: 		case SendMod of
<a name="1284"/> 1284: 		    megaco_tcp -&gt; megaco_tcp:get_stats(SendHandle);
<a name="1285"/> 1285: 		    megaco_udp -&gt; megaco_udp:get_stats(SendHandle);
<a name="1286"/> 1286: 		    SendMod    -&gt; exit(Pid, Reason)
<a name="1287"/> 1287: 		end,
<a name="1288"/> 1288: 	    Parent ! {statistics, 1, [{gen, Gen}, {trans, Trans}], self()},
<a name="1289"/> 1289: 	    mg_loop(S); 
<a name="1290"/> 1290: 
<a name="1291"/> 1291: 
<a name="1292"/> 1292: 	%% Do a service change
<a name="1293"/> 1293: 	{service_change, Parent} when S#mg.parent == Parent, 
<a name="1294"/> 1294: 				      State == initiated -&gt;
<a name="1295"/> 1295: 	    i(&quot;mg_loop(~p) -&gt; received request to perform service change when:&quot;
<a name="1296"/> 1296:               &quot;~n      Conn Handle: ~p&quot;
<a name="1297"/> 1297:               &quot;~n      Conn Data:   ~p&quot;, 
<a name="1298"/> 1298: 	      [State,
<a name="1299"/> 1299:                S#mg.conn_handle,
<a name="1300"/> 1300:                megaco:conn_info(S#mg.conn_handle, conn_data)]),
<a name="1301"/> 1301: 	    Res = mg_service_change(S#mg.conn_handle),
<a name="1302"/> 1302: 	    d(&quot;mg_loop(~p) -&gt; service change request send result: ~p&quot;,
<a name="1303"/> 1303:               [State, Res]),
<a name="1304"/> 1304: 	    mg_loop(S#mg{state = connecting}); 
<a name="1305"/> 1305: 
<a name="1306"/> 1306: 
<a name="1307"/> 1307: 	%% Apply some load
<a name="1308"/> 1308: 	{apply_load, Parent, Times} when S#mg.parent == Parent -&gt;
<a name="1309"/> 1309: 	    i(&quot;mg_loop(~p) -&gt; received apply_load request&quot;, [State]),
<a name="1310"/> 1310: 	    apply_load_timer(),
<a name="1311"/> 1311: 	    Parent ! {apply_load_ack, self()},
<a name="1312"/> 1312: 	    mg_loop(S#mg{load_counter = Times - 1});
<a name="1313"/> 1313: 
<a name="1314"/> 1314: 
<a name="1315"/> 1315: 	apply_load_timeout -&gt;
<a name="1316"/> 1316: 	    d(&quot;mg_loop(~p) -&gt; received apply_load timeout [~p]&quot;, 
<a name="1317"/> 1317: 	      [State, S#mg.load_counter]),
<a name="1318"/> 1318: 	    mg_apply_load(S),
<a name="1319"/> 1319: 	    mg_loop(S);
<a name="1320"/> 1320: 
<a name="1321"/> 1321: 
<a name="1322"/> 1322: 	%% Megaco callback messages
<a name="1323"/> 1323: 	{request, Request, From} -&gt;
<a name="1324"/> 1324: 	    d(&quot;mg_loop(~p) -&gt; received megaco request: ~n~p~n   From: ~p&quot;, 
<a name="1325"/> 1325: 	      [State, Request, From]),
<a name="1326"/> 1326: 	    {Reply, NewS} = mg_handle_request(Request, S),
<a name="1327"/> 1327: 	    d(&quot;mg_loop(~p) -&gt; send request reply: ~n~p&quot;, 
<a name="1328"/> 1328: 	      [NewS#mg.state, Reply]),
<a name="1329"/> 1329: 	    From ! {reply, Reply, self()},
<a name="1330"/> 1330: 	    mg_loop(NewS);
<a name="1331"/> 1331: 
<a name="1332"/> 1332: 
<a name="1333"/> 1333: 	{'EXIT', Pid, Reason} -&gt;
<a name="1334"/> 1334: 	    error_msg(&quot;MG ~p received unexpected exit signal from ~p:~n~p&quot;, 
<a name="1335"/> 1335: 		      [S#mg.mid, Pid, Reason]),
<a name="1336"/> 1336: 	    mg_loop(S);
<a name="1337"/> 1337: 
<a name="1338"/> 1338: 
<a name="1339"/> 1339: 	Invalid -&gt;
<a name="1340"/> 1340: 	    i(&quot;mg_loop(~p) -&gt; received invalid request: ~p&quot;, [State, Invalid]),
<a name="1341"/> 1341: 	    mg_loop(S)
<a name="1342"/> 1342: 
<a name="1343"/> 1343:     end.
<a name="1344"/> 1344: 
<a name="1345"/> 1345: 
<a name="mg_reset_stats-1"/><a name="1346"/> 1346: <b>mg_reset_stats</b>(CH) -&gt;
<a name="1347"/> 1347:     megaco:reset_stats(),
<a name="mg_reset_stats-last_expr"/><a name="1348"/> 1348: <b>    case </b>(catch megaco:conn_info(CH, send_mod)) of
<a name="1349"/> 1349: 	{error, Reason} -&gt;
<a name="1350"/> 1350: 	    error_msg(&quot;unexpected result when retrieving send module for &quot;
<a name="1351"/> 1351: 		      &quot;own connection ~p: ~p. &quot;
<a name="1352"/> 1352: 		      &quot;~nexiting...&quot;, [CH, Reason]),
<a name="1353"/> 1353: 	    exit({invalid_connection, CH, Reason});
<a name="1354"/> 1354: 	{'EXIT', Reason} -&gt;
<a name="1355"/> 1355: 	    error_msg(&quot;exit signal when retrieving send module for &quot;
<a name="1356"/> 1356: 		      &quot;own connection ~p: ~p. &quot;
<a name="1357"/> 1357: 		      &quot;~nexiting...&quot;, [CH, Reason]),
<a name="1358"/> 1358: 	    exit({invalid_connection, CH, Reason});
<a name="1359"/> 1359: 	SendMod when is_atom(SendMod) -&gt;
<a name="1360"/> 1360: 	    SendMod:reset_stats()
<a name="1361"/> 1361:     end.
<a name="1362"/> 1362: 
<a name="1363"/> 1363: 
<a name="mg_close_conn-1"/><a name="1364"/> 1364: <b>mg_close_conn</b>(CH) -&gt;
<a name="1365"/> 1365:     Reason = {self(), ignore},
<a name="1366"/> 1366:     Pid        = megaco:conn_info(CH, control_pid),
<a name="1367"/> 1367:     SendMod    = megaco:conn_info(CH, send_mod),
<a name="1368"/> 1368:     SendHandle = megaco:conn_info(CH, send_handle),
<a name="1369"/> 1369:     megaco:disconnect(CH, Reason),
<a name="mg_close_conn-last_expr"/><a name="1370"/> 1370:     case SendMod of
<a name="1371"/> 1371: 	megaco_tcp -&gt; megaco_tcp:close(SendHandle);
<a name="1372"/> 1372: 	megaco_udp -&gt; megaco_udp:close(SendHandle);
<a name="1373"/> 1373: 	SendMod    -&gt; exit(Pid, Reason)
<a name="1374"/> 1374:     end.
<a name="1375"/> 1375: 
<a name="1376"/> 1376: 
<a name="mg_parse_receive_info-2"/><a name="1377"/> 1377: <b>mg_parse_receive_info</b>(RI, RH) -&gt;
<a name="1378"/> 1378:     d(&quot;mg_parse_receive_info -&gt; get encoding module&quot;),
<a name="1379"/> 1379:     EM = get_encoding_module(RI),
<a name="1380"/> 1380:     d(&quot;mg_parse_receive_info -&gt; get encoding config&quot;),
<a name="1381"/> 1381:     EC = get_encoding_config(RI, EM),
<a name="1382"/> 1382:     d(&quot;mg_parse_receive_info -&gt; get transport module&quot;),
<a name="1383"/> 1383:     TM = get_transport_module(RI),
<a name="1384"/> 1384:     d(&quot;mg_parse_receive_info -&gt; get transport port&quot;),
<a name="1385"/> 1385:     TP = get_transport_port(RI),
<a name="1386"/> 1386:     RH1 = RH#megaco_receive_handle{send_mod        = TM,
<a name="1387"/> 1387: 				   encoding_mod    = EM,
<a name="1388"/> 1388: 				   encoding_config = EC},
<a name="mg_parse_receive_info-last_expr"/><a name="1389"/> 1389:     {TP, RH1}.
<a name="1390"/> 1390: 
<a name="1391"/> 1391: 
<a name="mg_start_transport-2"/><a name="1392"/> 1392: <b>mg_start_transport</b>(MgcPort,
<a name="1393"/> 1393: 		   #megaco_receive_handle{send_mod = megaco_tcp} = RH) -&gt;
<a name="1394"/> 1394:     mg_start_tcp(MgcPort,RH);
<a name="1395"/> 1395: <b>mg_start_transport</b>(MgcPort,
<a name="1396"/> 1396: 		   #megaco_receive_handle{send_mod = megaco_udp} = RH) -&gt;
<a name="1397"/> 1397:     mg_start_udp(MgcPort,RH);
<a name="1398"/> 1398: <b>mg_start_transport</b>(_, #megaco_receive_handle{send_mod = Mod}) -&gt;
<a name="mg_start_transport-last_expr"/><a name="1399"/> 1399: <b>    throw</b>({error, {bad_send_mod, Mod}}).
<a name="1400"/> 1400: 
<a name="1401"/> 1401: 
<a name="mg_start_tcp-2"/><a name="1402"/> 1402: <b>mg_start_tcp</b>(MgcPort, RH) -&gt;
<a name="1403"/> 1403:     i(&quot;start tcp transport&quot;),
<a name="mg_start_tcp-last_expr"/><a name="1404"/> 1404: <b>    case megaco_tcp:start_transport</b>() of
<a name="1405"/> 1405: 	{ok, Sup} -&gt;
<a name="1406"/> 1406: 	    {ok, LocalHost} = inet:gethostname(),
<a name="1407"/> 1407: 	    Opts = [{host,           LocalHost},
<a name="1408"/> 1408: 		    {port,           MgcPort}, 
<a name="1409"/> 1409: 		    {receive_handle, RH}, 
<a name="1410"/> 1410: 		    {tcp_options,    [{nodelay, true}]}],
<a name="1411"/> 1411:             i(&quot;tcp transport started: attempt (tcp) connect to MGC at:&quot;
<a name="1412"/> 1412:               &quot;~n   ~p&quot;, [LocalHost]),
<a name="1413"/> 1413: 	    case megaco_tcp:connect(Sup, Opts) of
<a name="1414"/> 1414: 		{ok, SendHandle, ControlPid} -&gt;
<a name="1415"/> 1415:                     PrelMgcMid = preliminary_mid,
<a name="1416"/> 1416:                     i(&quot;tcp transport (tcp) connected: attempt (megaco) connect:&quot;),
<a name="1417"/> 1417: 		    {ok, ConnHandle} = 
<a name="1418"/> 1418: 			megaco:connect(RH, PrelMgcMid, 
<a name="1419"/> 1419: 				       SendHandle, ControlPid),
<a name="1420"/> 1420: 		    ConnHandle;
<a name="1421"/> 1421: 		{error, Reason} -&gt;
<a name="1422"/> 1422: 		    {error, {megaco_tcp_connect, Reason}}
<a name="1423"/> 1423: 	    end;
<a name="1424"/> 1424:         {error, Reason} -&gt;
<a name="1425"/> 1425:             {error, {megaco_tcp_start_transport, Reason}}
<a name="1426"/> 1426:     end.
<a name="1427"/> 1427: 
<a name="1428"/> 1428: 
<a name="mg_start_udp-2"/><a name="1429"/> 1429: <b>mg_start_udp</b>(MgcPort, RH) -&gt;
<a name="1430"/> 1430:     i(&quot;start udp transport&quot;),
<a name="mg_start_udp-last_expr"/><a name="1431"/> 1431: <b>    case megaco_udp:start_transport</b>() of
<a name="1432"/> 1432: 	{ok, Sup} -&gt;
<a name="1433"/> 1433:             %% Some linux (Ubuntu) has &quot;crap&quot; in their /etc/hosts, that 
<a name="1434"/> 1434:             %% causes problem for us in this case (UDP). So we can't use
<a name="1435"/> 1435:             %% local host. Try instead to &quot;figure out&quot; tha actual address...
<a name="1436"/> 1436:             LocalAddr = which_local_addr(),
<a name="1437"/> 1437: 	    Opts = [{port, 0}, {receive_handle, RH}],
<a name="1438"/> 1438:             i(&quot;udp transport started: attempt (udp) open&quot;),
<a name="1439"/> 1439: 	    case megaco_udp:open(Sup, Opts) of
<a name="1440"/> 1440: 		{ok, Handle, ControlPid} -&gt;
<a name="1441"/> 1441:                     MgcMid = preliminary_mid,
<a name="1442"/> 1442:                     i(&quot;udp transport open: &quot;
<a name="1443"/> 1443:                       &quot;now create send handle with MGC address: &quot;
<a name="1444"/> 1444:                       &quot;~n   ~p&quot;, [LocalAddr]),
<a name="1445"/> 1445:                     SendHandle = megaco_udp:create_send_handle(Handle, 
<a name="1446"/> 1446: 							       LocalAddr, 
<a name="1447"/> 1447: 							       MgcPort),
<a name="1448"/> 1448:                     i(&quot;udp transport: attempt (megaco) connect to:&quot;
<a name="1449"/> 1449:                       &quot;~n   ~p&quot;, [SendHandle]),
<a name="1450"/> 1450: 		    {ok, ConnHandle} = 
<a name="1451"/> 1451: 			megaco:connect(RH, MgcMid, 
<a name="1452"/> 1452: 				       SendHandle, ControlPid),
<a name="1453"/> 1453: 		    ConnHandle;
<a name="1454"/> 1454: 		{error, Reason} -&gt;
<a name="1455"/> 1455:                     {error, {megaco_udp_open, Reason}}
<a name="1456"/> 1456: 	    end;
<a name="1457"/> 1457:         {error, Reason} -&gt;
<a name="1458"/> 1458:             {error, {megaco_udp_start_transport, Reason}}
<a name="1459"/> 1459:     end.
<a name="1460"/> 1460: 
<a name="1461"/> 1461: 
<a name="mg_service_change-1"/><a name="1462"/> 1462: <b>mg_service_change</b>(ConnHandle) -&gt;
<a name="mg_service_change-last_expr"/><a name="1463"/> 1463: <b>    mg_service_change</b>(ConnHandle, restart, ?megaco_cold_boot).
<a name="1464"/> 1464: 
<a name="mg_service_change-3"/><a name="1465"/> 1465: <b>mg_service_change</b>(ConnHandle, Method, Reason) -&gt;
<a name="1466"/> 1466:     SCP = #'ServiceChangeParm'{serviceChangeMethod = Method,
<a name="1467"/> 1467:                                serviceChangeReason = [Reason]},
<a name="1468"/> 1468:     TermId = [?megaco_root_termination_id],
<a name="1469"/> 1469:     SCR = #'ServiceChangeRequest'{terminationID = TermId,
<a name="1470"/> 1470:                                   serviceChangeParms = SCP},
<a name="1471"/> 1471:     CR = #'CommandRequest'{command = {serviceChangeReq, SCR}},
<a name="1472"/> 1472:     AR = #'ActionRequest'{contextId = ?megaco_null_context_id,
<a name="1473"/> 1473:                           commandRequests = [CR]},
<a name="mg_service_change-last_expr"/><a name="1474"/> 1474: <b>    megaco:cast</b>(ConnHandle, [AR], []).
<a name="1475"/> 1475: 
<a name="1476"/> 1476: 
<a name="mg_notify_request-1"/><a name="1477"/> 1477: <b>mg_notify_request</b>(CH) -&gt;
<a name="1478"/> 1478:     TimeStamp = cre_timeNotation(&quot;19990729&quot;, &quot;22000000&quot;),
<a name="1479"/> 1479:     Event     = cre_observedEvent(&quot;al/of&quot;,TimeStamp),
<a name="1480"/> 1480:     Desc      = cre_observedEventsDesc(2222,[Event]),
<a name="1481"/> 1481:     NotifyReq = cre_notifyReq([#megaco_term_id{id = ?A4444}],Desc),
<a name="1482"/> 1482:     CmdReq    = cre_commandReq({notifyReq, NotifyReq}),
<a name="1483"/> 1483:     ActReq    = cre_actionReq(?megaco_null_context_id, [CmdReq]),
<a name="mg_notify_request-last_expr"/><a name="1484"/> 1484: <b>    megaco:cast</b>(CH, [ActReq], [{reply_data, Desc}]).
<a name="1485"/> 1485:     
<a name="mg_apply_load-1"/><a name="1486"/> 1486: <b>mg_apply_load</b>(#mg{conn_handle = CH}) -&gt;
<a name="mg_apply_load-last_expr"/><a name="1487"/> 1487: <b>    mg_notify_request</b>(CH).
<a name="1488"/> 1488: 
<a name="1489"/> 1489: 
<a name="cre_actionReq-2"/><a name="1490"/> 1490: <b>cre_actionReq</b>(Cid, Cmds) -&gt;
<a name="cre_actionReq-last_expr"/><a name="1491"/> 1491:     #'ActionRequest'{contextId = Cid,
<a name="1492"/> 1492: 		     commandRequests = Cmds}.
<a name="1493"/> 1493: 
<a name="cre_commandReq-1"/><a name="1494"/> 1494: <b>cre_commandReq</b>(Cmd) -&gt;
<a name="cre_commandReq-last_expr"/><a name="1495"/> 1495:     #'CommandRequest'{command = Cmd}.
<a name="1496"/> 1496: 
<a name="cre_notifyReq-2"/><a name="1497"/> 1497: <b>cre_notifyReq</b>(Tid, EvsDesc) -&gt;
<a name="cre_notifyReq-last_expr"/><a name="1498"/> 1498:     #'NotifyRequest'{terminationID = Tid, observedEventsDescriptor = EvsDesc}.
<a name="1499"/> 1499: 
<a name="cre_observedEventsDesc-2"/><a name="1500"/> 1500: <b>cre_observedEventsDesc</b>(Id, EvList) -&gt;
<a name="cre_observedEventsDesc-last_expr"/><a name="1501"/> 1501:     #'ObservedEventsDescriptor'{requestId = Id, observedEventLst = EvList}.
<a name="1502"/> 1502: 
<a name="cre_observedEvent-2"/><a name="1503"/> 1503: <b>cre_observedEvent</b>(Name, Not) -&gt;
<a name="cre_observedEvent-last_expr"/><a name="1504"/> 1504:     #'ObservedEvent'{eventName = Name, timeNotation = Not}.
<a name="1505"/> 1505: 
<a name="cre_timeNotation-2"/><a name="1506"/> 1506: <b>cre_timeNotation</b>(D,T) -&gt;
<a name="cre_timeNotation-last_expr"/><a name="1507"/> 1507:     #'TimeNotation'{date = D, time = T}.
<a name="1508"/> 1508: 
<a name="1509"/> 1509: <i>%% -----------------------</i>
<a name="1510"/> 1510: <i>%% Handle megaco callbacks</i>
<a name="1511"/> 1511: <i>%%</i>
<a name="1512"/> 1512: 
<a name="mg_handle_request-2"/><a name="1513"/> 1513: <b>mg_handle_request</b>({handle_connect, CH, _PV}, 
<a name="1514"/> 1514: 		  #mg{state = connecting} = S) -&gt;
<a name="1515"/> 1515:     {ok, S#mg{conn_handle = CH}};
<a name="1516"/> 1516: 
<a name="1517"/> 1517: <b>mg_handle_request</b>({handle_disconnect, CH, _PV, _R}, S) -&gt;
<a name="1518"/> 1518:     {ok, S#mg{conn_handle = CH}};
<a name="1519"/> 1519: 
<a name="1520"/> 1520: <b>mg_handle_request</b>({handle_syntax_error, RH, PV, ED}, S) -&gt;
<a name="1521"/> 1521:     %% There is no point in this test where this is expected.
<a name="1522"/> 1522:     %% But if it *does* happen; stop
<a name="1523"/> 1523:     %% But can we do that from here? Spawn?
<a name="1524"/> 1524:     p(&quot;Received unexpected syntax error: cancel connection&quot;
<a name="1525"/> 1525:       &quot;~n   RH: ~p&quot;
<a name="1526"/> 1526:       &quot;~n   PV: ~p&quot;
<a name="1527"/> 1527:       &quot;~n   ED: ~p&quot;, [RH, PV, ED]),
<a name="1528"/> 1528:     megaco:cancel(S#mg.conn_handle, ED),
<a name="1529"/> 1529:     megaco:disconnect(S#mg.conn_handle, {syntax_error, ED}),
<a name="1530"/> 1530:     {no_reply, S};
<a name="1531"/> 1531: 
<a name="1532"/> 1532: <b>mg_handle_request</b>({handle_message_error, CH, _PV, _ED}, S) -&gt;
<a name="1533"/> 1533:     {no_reply, S#mg{conn_handle = CH}};
<a name="1534"/> 1534: 
<a name="1535"/> 1535: <b>mg_handle_request</b>({handle_trans_request, CH, _PV, _AR}, S) -&gt;
<a name="1536"/> 1536:     ED =  #'ErrorDescriptor'{errorCode = ?megaco_not_implemented,
<a name="1537"/> 1537:                              errorText = &quot;Transaction requests not handled&quot;},
<a name="1538"/> 1538:     {{discard_ack, ED}, S#mg{conn_handle = CH}};
<a name="1539"/> 1539: 
<a name="1540"/> 1540: <b>mg_handle_request</b>({handle_trans_long_request, CH, _PV, _RD}, S) -&gt;
<a name="1541"/> 1541:     ED = #'ErrorDescriptor'{errorCode = ?megaco_not_implemented,
<a name="1542"/> 1542:                             errorText = &quot;Long transaction requests not handled&quot;},
<a name="1543"/> 1543:     {{discard_ack,  ED}, S#mg{conn_handle = CH}};
<a name="1544"/> 1544: 
<a name="1545"/> 1545: <b>mg_handle_request</b>({handle_trans_reply, CH, _PV, _AR, _RD}, 
<a name="1546"/> 1546: 		  #mg{parent = Pid, state = connecting} = S) -&gt;
<a name="1547"/> 1547:     %% Should really check this...
<a name="1548"/> 1548:     Pid ! {service_change_reply, ok, self()},
<a name="1549"/> 1549:     {ok, S#mg{conn_handle = CH, state = connected}};
<a name="1550"/> 1550: <b>mg_handle_request</b>({handle_trans_reply, _CH, _PV, {error, ED}, RD}, 
<a name="1551"/> 1551: 		  #mg{parent = Pid, load_counter = 0} = S) 
<a name="1552"/> 1552:   when is_record(ED, 'ErrorDescriptor') andalso 
<a name="1553"/> 1553:        is_record(RD, 'ObservedEventsDescriptor') -&gt;
<a name="1554"/> 1554:     Pid ! {load_complete, self()},
<a name="1555"/> 1555:     {ok, S};
<a name="1556"/> 1556: <b>mg_handle_request</b>({handle_trans_reply, _CH, _PV, {error, ED}, RD}, 
<a name="1557"/> 1557: 		  #mg{load_counter = N} = S) 
<a name="1558"/> 1558:   when is_record(ED, 'ErrorDescriptor') andalso 
<a name="1559"/> 1559:        is_record(RD, 'ObservedEventsDescriptor') -&gt;
<a name="1560"/> 1560:     apply_load_timer(),
<a name="1561"/> 1561:     {ok, S#mg{load_counter = N-1}};
<a name="1562"/> 1562: 
<a name="1563"/> 1563: <b>mg_handle_request</b>({handle_trans_ack, _CH, _PV, _AS, _AD}, S) -&gt;
<a name="mg_handle_request-last_expr"/><a name="1564"/> 1564:     {ok, S}.
<a name="1565"/> 1565: 
<a name="1566"/> 1566:     
<a name="1567"/> 1567: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1568"/> 1568: 
<a name="await_started-1"/><a name="1569"/> 1569: <b>await_started</b>(Pid) -&gt;
<a name="await_started-last_expr"/><a name="1570"/> 1570:     receive
<a name="1571"/> 1571: 	{started, Pid} -&gt;
<a name="1572"/> 1572: 	    d(&quot;await_started ~p: ok&quot;, [Pid]),
<a name="1573"/> 1573: 	    {ok, Pid};
<a name="1574"/> 1574: 	{'EXIT', Pid, Reason} -&gt;
<a name="1575"/> 1575: 	    i(&quot;await_started ~p: received exit signal: ~p&quot;, [Pid, Reason]),
<a name="1576"/> 1576: 	    exit({failed_starting, Pid, Reason})
<a name="1577"/> 1577:     after 10000 -&gt;
<a name="1578"/> 1578: 	    i(&quot;await_started ~p: timeout&quot;, [Pid]),
<a name="1579"/> 1579: 	    exit({error, timeout})
<a name="1580"/> 1580:     end.
<a name="1581"/> 1581: 
<a name="stop-1"/><a name="1582"/> 1582: <b>stop</b>(Pid) -&gt;
<a name="1583"/> 1583:     d(&quot;stop ~p&quot;, [Pid]),
<a name="1584"/> 1584:     Pid ! {stop, self()},
<a name="stop-last_expr"/><a name="1585"/> 1585:     receive 
<a name="1586"/> 1586: 	{stopped, Pid} -&gt;
<a name="1587"/> 1587: 	    d(&quot;stop -&gt; received stopped from ~p&quot;, [Pid]),
<a name="1588"/> 1588: 	    ok;
<a name="1589"/> 1589: 	{'EXIT', Pid, Reason} -&gt;
<a name="1590"/> 1590: 	    i(&quot;stop ~p: received exit signal: ~p&quot;, [Pid, Reason]),
<a name="1591"/> 1591: 	    exit({failed_stopping, Pid, Reason})
<a name="1592"/> 1592:     after 10000 -&gt;
<a name="1593"/> 1593: 	    exit({error, timeout})
<a name="1594"/> 1594:     end.
<a name="1595"/> 1595: 
<a name="get_stats-2"/><a name="1596"/> 1596: <b>get_stats</b>(Pid, No) -&gt;
<a name="1597"/> 1597:     d(&quot;get_stats ~p&quot;, [Pid]),
<a name="1598"/> 1598:     Pid ! {statistics, No, self()},
<a name="get_stats-last_expr"/><a name="1599"/> 1599:     receive 
<a name="1600"/> 1600: 	{statistics, No, Stats, Pid} -&gt;
<a name="1601"/> 1601: 	    {ok, Stats};
<a name="1602"/> 1602: 	{'EXIT', Pid, Reason} -&gt;
<a name="1603"/> 1603: 	    i(&quot;get_stats ~p: received exit signal: ~p&quot;, [Pid, Reason]),
<a name="1604"/> 1604: 	    exit({failed_getting_stats, Pid, Reason})
<a name="1605"/> 1605:     after 10000 -&gt;
<a name="1606"/> 1606: 	    exit({error, timeout})
<a name="1607"/> 1607:     end.
<a name="1608"/> 1608: 
<a name="service_change-1"/><a name="1609"/> 1609: <b>service_change</b>(Pid) -&gt;
<a name="1610"/> 1610:     d(&quot;service_change ~p&quot;, [Pid]),
<a name="1611"/> 1611:     Pid ! {service_change, self()},
<a name="service_change-last_expr"/><a name="1612"/> 1612:     receive 
<a name="1613"/> 1613: 	{service_change_reply, Res, Pid} -&gt;
<a name="1614"/> 1614: 	    {ok, Res};
<a name="1615"/> 1615: 	{'EXIT', Pid, Reason} -&gt;
<a name="1616"/> 1616: 	    i(&quot;service_change ~p: received exit signal: ~p&quot;, [Pid, Reason]),
<a name="1617"/> 1617: 	    exit({failed_service_change, Pid, Reason})
<a name="1618"/> 1618:     after 10000 -&gt;
<a name="1619"/> 1619: 	    exit({error, timeout})
<a name="1620"/> 1620:     end.
<a name="1621"/> 1621: 
<a name="1622"/> 1622: 
<a name="1623"/> 1623: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1624"/> 1624: 
<a name="notify_started-1"/><a name="1625"/> 1625: <b>notify_started</b>(Parent) -&gt;
<a name="notify_started-last_expr"/><a name="1626"/> 1626: <b>    Parent ! {started, self</b>()}.
<a name="1627"/> 1627: 
<a name="1628"/> 1628: 
<a name="1629"/> 1629: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1630"/> 1630: 
<a name="1631"/> 1631: <i>%% The megaco user callback interface </i>
<a name="1632"/> 1632: 
<a name="handle_connect-3"/><a name="1633"/> 1633: <b>handle_connect</b>(CH, PV, Pid) -&gt;
<a name="1634"/> 1634: <i>%     i(&quot;handle_connect -&gt; entry with&quot;</i>
<a name="1635"/> 1635: <i>%       &quot;~n    CH:  ~p&quot;</i>
<a name="1636"/> 1636: <i>%       &quot;~n    PV:  ~p&quot;</i>
<a name="1637"/> 1637: <i>%       &quot;~n    Pid: ~p&quot;, [CH, PV, Pid]),</i>
<a name="handle_connect-last_expr"/><a name="1638"/> 1638:     case CH#megaco_conn_handle.remote_mid of
<a name="1639"/> 1639:         preliminary_mid -&gt;
<a name="1640"/> 1640: 	    %% Avoids deadlock
<a name="1641"/> 1641: 	    ok;
<a name="1642"/> 1642: 	_ -&gt;
<a name="1643"/> 1643: 	    Reply = request(Pid, {handle_connect, CH, PV}),
<a name="1644"/> 1644: <i>% 	    d(&quot;handle_connect -&gt; Reply:~n~p&quot;, [Reply]),</i>
<a name="1645"/> 1645: 	    Reply
<a name="1646"/> 1646:     end.
<a name="1647"/> 1647: 
<a name="handle_disconnect-4"/><a name="1648"/> 1648: <b>handle_disconnect</b>(_CH, _PV, 
<a name="1649"/> 1649: 		  {user_disconnect, {Pid, ignore}}, 
<a name="1650"/> 1650: 		  Pid) -&gt;
<a name="1651"/> 1651: <i>%     i(&quot;handle_disconnect(ignore) -&gt; entry with&quot;</i>
<a name="1652"/> 1652: <i>%       &quot;~n   CH: ~p&quot;</i>
<a name="1653"/> 1653: <i>%       &quot;~n   PV: ~p&quot;, [CH, PV]),</i>
<a name="1654"/> 1654:     %% Avoids deadlock
<a name="1655"/> 1655:     ok;
<a name="1656"/> 1656: <b>handle_disconnect</b>(CH, PV, R, Pid) -&gt;
<a name="1657"/> 1657: <i>%     i(&quot;handle_disconnect -&gt; entry with&quot;</i>
<a name="1658"/> 1658: <i>%       &quot;~n   CH: ~p&quot;</i>
<a name="1659"/> 1659: <i>%       &quot;~n   PV: ~p&quot;</i>
<a name="1660"/> 1660: <i>%       &quot;~n   R:  ~p&quot;, [CH, PV, R]),</i>
<a name="handle_disconnect-last_expr"/><a name="1661"/> 1661: <b>    request</b>(Pid, {handle_disconnect, CH, PV, R}).
<a name="1662"/> 1662: 
<a name="handle_syntax_error-4"/><a name="1663"/> 1663: <b>handle_syntax_error</b>(ReceiveHandle, ProtocolVersion, ErrorDescriptor, Pid) -&gt;
<a name="1664"/> 1664: <i>%     i(&quot;handle_syntax_error -&gt; entry with&quot;</i>
<a name="1665"/> 1665: <i>%       &quot;~n   ReceiveHandle:   ~p&quot;</i>
<a name="1666"/> 1666: <i>%       &quot;~n   ProtocolVersion: ~p&quot;</i>
<a name="1667"/> 1667: <i>%       &quot;~n   ErrorDescriptor: ~p&quot;, </i>
<a name="1668"/> 1668: <i>%       [ReceiveHandle, ProtocolVersion, ErrorDescriptor]),</i>
<a name="1669"/> 1669:     Req = {handle_syntax_error, ReceiveHandle, ProtocolVersion, 
<a name="1670"/> 1670: 	   ErrorDescriptor},
<a name="handle_syntax_error-last_expr"/><a name="1671"/> 1671: <b>    request</b>(Pid, Req).
<a name="1672"/> 1672:     
<a name="handle_message_error-4"/><a name="1673"/> 1673: <b>handle_message_error</b>(ConnHandle, ProtocolVersion, ErrorDescriptor, Pid) -&gt;
<a name="1674"/> 1674: <i>%     i(&quot;handle_message_error -&gt; entry with&quot;</i>
<a name="1675"/> 1675: <i>%       &quot;~n   ConnHandle:      ~p&quot;</i>
<a name="1676"/> 1676: <i>%       &quot;~n   ProtocolVersion: ~p&quot;</i>
<a name="1677"/> 1677: <i>%       &quot;~n   ErrorDescriptor: ~p&quot;, </i>
<a name="1678"/> 1678: <i>%       [ConnHandle, ProtocolVersion, ErrorDescriptor]),</i>
<a name="1679"/> 1679:     Req = {handle_message_error, ConnHandle, ProtocolVersion, ErrorDescriptor},
<a name="handle_message_error-last_expr"/><a name="1680"/> 1680: <b>    request</b>(Pid, Req).
<a name="1681"/> 1681: 
<a name="handle_trans_request-4"/><a name="1682"/> 1682: <b>handle_trans_request</b>(CH, PV, AR, Pid) -&gt;
<a name="1683"/> 1683: <i>%     i(&quot;handle_trans_request -&gt; entry with&quot; </i>
<a name="1684"/> 1684: <i>%       &quot;~n   CH:  ~p&quot;</i>
<a name="1685"/> 1685: <i>%       &quot;~n   PV:  ~p&quot;</i>
<a name="1686"/> 1686: <i>%       &quot;~n   AR:  ~p&quot;</i>
<a name="1687"/> 1687: <i>%       &quot;~n   Pid: ~p&quot;, [CH, PV, AR, Pid]),</i>
<a name="1688"/> 1688:     Reply = request(Pid, {handle_trans_request, CH, PV, AR}),
<a name="1689"/> 1689: <i>%     i(&quot;handle_trans_request -&gt; Reply:~n~p&quot;, [Reply]),</i>
<a name="handle_trans_request-last_expr"/><a name="1690"/> 1690:     Reply.
<a name="1691"/> 1691: 
<a name="handle_trans_long_request-4"/><a name="1692"/> 1692: <b>handle_trans_long_request</b>(ConnHandle, ProtocolVersion, ReqData, Pid) -&gt;
<a name="1693"/> 1693: <i>%     i(&quot;handle_trans_long_request -&gt; entry with&quot;</i>
<a name="1694"/> 1694: <i>%       &quot;~n   ConnHandle:      ~p&quot;</i>
<a name="1695"/> 1695: <i>%       &quot;~n   ProtocolVersion: ~p&quot;</i>
<a name="1696"/> 1696: <i>%       &quot;~n   ReqData:         ~p&quot;, [ConnHandle, ProtocolVersion, ReqData]),</i>
<a name="1697"/> 1697:     Req = {handle_trans_long_request, ConnHandle, ProtocolVersion, ReqData},
<a name="handle_trans_long_request-last_expr"/><a name="1698"/> 1698: <b>    request</b>(Pid, Req).
<a name="1699"/> 1699: 
<a name="handle_trans_reply-5"/><a name="1700"/> 1700: <b>handle_trans_reply</b>(ConnHandle, ProtocolVersion, ActualReply, ReplyData, Pid) -&gt;
<a name="1701"/> 1701: <i>%     i(&quot;handle_trans_reply -&gt; entry with&quot;</i>
<a name="1702"/> 1702: <i>%       &quot;~n   ConnHandle:      ~p&quot;</i>
<a name="1703"/> 1703: <i>%       &quot;~n   ProtocolVersion: ~p&quot;</i>
<a name="1704"/> 1704: <i>%       &quot;~n   ActualReply:     ~p&quot;</i>
<a name="1705"/> 1705: <i>%       &quot;~n   ReplyData:       ~p&quot;, </i>
<a name="1706"/> 1706: <i>%       [ConnHandle, ProtocolVersion, ActualReply, ReplyData]),</i>
<a name="1707"/> 1707:     Req = {handle_trans_reply, ConnHandle, ProtocolVersion, 
<a name="1708"/> 1708: 	   ActualReply, ReplyData},
<a name="handle_trans_reply-last_expr"/><a name="1709"/> 1709: <b>    request</b>(Pid, Req).
<a name="1710"/> 1710: 
<a name="handle_trans_ack-5"/><a name="1711"/> 1711: <b>handle_trans_ack</b>(ConnHandle, ProtocolVersion, AckStatus, AckData, Pid) -&gt;
<a name="1712"/> 1712: <i>%     i(&quot;handle_trans_ack -&gt; entry with&quot;</i>
<a name="1713"/> 1713: <i>%       &quot;~n   ConnHandle:      ~p&quot;</i>
<a name="1714"/> 1714: <i>%       &quot;~n   ProtocolVersion: ~p&quot;</i>
<a name="1715"/> 1715: <i>%       &quot;~n   AckStatus:       ~p&quot;</i>
<a name="1716"/> 1716: <i>%       &quot;~n   AckData:         ~p&quot;, </i>
<a name="1717"/> 1717: <i>%       [ConnHandle, ProtocolVersion, AckStatus, AckData]),</i>
<a name="1718"/> 1718:     Req = {handle_trans_ack, ConnHandle, ProtocolVersion, AckStatus, AckData},
<a name="handle_trans_ack-last_expr"/><a name="1719"/> 1719: <b>    request</b>(Pid, Req).
<a name="1720"/> 1720: 
<a name="1721"/> 1721: 
<a name="request-2"/><a name="1722"/> 1722: <b>request</b>(Pid, Request) -&gt;
<a name="1723"/> 1723:     Pid ! {request, Request, self()},
<a name="request-last_expr"/><a name="1724"/> 1724:     receive
<a name="1725"/> 1725: 	{reply, Reply, Pid} -&gt;
<a name="1726"/> 1726: 	    Reply
<a name="1727"/> 1727:     end.
<a name="1728"/> 1728: 
<a name="1729"/> 1729: 
<a name="1730"/> 1730: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1731"/> 1731: 
<a name="error_msg-2"/><a name="error_msg-last_expr"/><a name="1732"/> 1732: <b>error_msg</b>(F,A) -&gt; error_logger:error_msg(F ++ &quot;~n&quot;,A).
<a name="1733"/> 1733: 
<a name="1734"/> 1734: 
<a name="get_encoding_module-1"/><a name="1735"/> 1735: <b>get_encoding_module</b>(RI) -&gt;
<a name="get_encoding_module-last_expr"/><a name="1736"/> 1736: <b>    case </b>(catch get_conf(encoding_module, RI)) of
<a name="1737"/> 1737: 	{error, _} -&gt;
<a name="1738"/> 1738: 	    undefined;
<a name="1739"/> 1739: 	Val -&gt;
<a name="1740"/> 1740: 	    Val
<a name="1741"/> 1741:     end.
<a name="1742"/> 1742: 
<a name="get_encoding_config-2"/><a name="1743"/> 1743: <b>get_encoding_config</b>(RI, EM) -&gt;
<a name="get_encoding_config-last_expr"/><a name="1744"/> 1744: <b>    case text_codec</b>(EM) of
<a name="1745"/> 1745: 	true -&gt;
<a name="1746"/> 1746: 	    case megaco:system_info(text_config) of
<a name="1747"/> 1747: 		[Conf] when is_list(Conf) -&gt;
<a name="1748"/> 1748: 		    Conf;
<a name="1749"/> 1749: 		_ -&gt;
<a name="1750"/> 1750: 		    []
<a name="1751"/> 1751: 	    end;
<a name="1752"/> 1752: 
<a name="1753"/> 1753: 	false -&gt;
<a name="1754"/> 1754: 	    get_conf(encoding_config, RI)
<a name="1755"/> 1755:     end.
<a name="1756"/> 1756: 
<a name="text_codec-1"/><a name="1757"/> 1757: <b>text_codec</b>(megaco_compact_text_encoder) -&gt;
<a name="1758"/> 1758:     true;
<a name="1759"/> 1759: <b>text_codec</b>(megaco_pretty_text_encoder) -&gt;
<a name="1760"/> 1760:     true;
<a name="1761"/> 1761: <b>text_codec</b>(_) -&gt;
<a name="text_codec-last_expr"/><a name="1762"/> 1762:     false.
<a name="1763"/> 1763: 
<a name="1764"/> 1764: 
<a name="get_transport_module-1"/><a name="1765"/> 1765: <b>get_transport_module</b>(RI) -&gt;
<a name="get_transport_module-last_expr"/><a name="1766"/> 1766: <b>    get_conf</b>(transport_module, RI).
<a name="1767"/> 1767: 
<a name="get_transport_port-1"/><a name="1768"/> 1768: <b>get_transport_port</b>(RI) -&gt;
<a name="get_transport_port-last_expr"/><a name="1769"/> 1769: <b>    get_conf</b>(port, RI).
<a name="1770"/> 1770: 
<a name="1771"/> 1771: 
<a name="get_conf-2"/><a name="1772"/> 1772: <b>get_conf</b>(Key, Config) -&gt;
<a name="get_conf-last_expr"/><a name="1773"/> 1773: <b>    case lists:keysearch</b>(Key, 1, Config) of
<a name="1774"/> 1774: 	{value, {Key, Val}} -&gt;
<a name="1775"/> 1775: 	    Val;
<a name="1776"/> 1776: 	_ -&gt;
<a name="1777"/> 1777: 	    exit({error, {not_found, Key, Config}})
<a name="1778"/> 1778:     end.
<a name="1779"/> 1779: 
<a name="1780"/> 1780: 
<a name="1781"/> 1781: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1782"/> 1782: 
<a name="1783"/> 1783: <i>%% Tries to find a valid local address...</i>
<a name="which_local_addr-0"/><a name="1784"/> 1784: <b>which_local_addr</b>() -&gt;
<a name="which_local_addr-last_expr"/><a name="1785"/> 1785: <b>    case inet:getifaddrs</b>() of
<a name="1786"/> 1786:         {ok, IFs} -&gt;
<a name="1787"/> 1787:             which_local_addr(IFs);
<a name="1788"/> 1788:         {error, Reason} -&gt;
<a name="1789"/> 1789:             i(&quot;Failed get local address: &quot;
<a name="1790"/> 1790:               &quot;~n   ~p&quot;, [Reason]),
<a name="1791"/> 1791:             ?SKIP({failed_get_local_addr, Reason})
<a name="1792"/> 1792:     end.
<a name="1793"/> 1793: 
<a name="1794"/> 1794: <i>%% We explicitly skip some interfaces that we know is not &quot;valid&quot; </i>
<a name="1795"/> 1795: <i>%% (docker stuff)</i>
<a name="which_local_addr-1"/><a name="1796"/> 1796: <b>which_local_addr</b>([]) -&gt;
<a name="1797"/> 1797:     ?SKIP(failed_get_local_addr);
<a name="1798"/> 1798: <b>which_local_addr</b>([{&quot;br-&quot; ++ _ = _IfName, _IfOpts}|IFs]) -&gt;
<a name="1799"/> 1799:     which_local_addr(IFs);
<a name="1800"/> 1800: <b>which_local_addr</b>([{&quot;docker&quot; ++ _ = _IfName, _IfOpts}|IFs]) -&gt;
<a name="1801"/> 1801:     which_local_addr(IFs);
<a name="1802"/> 1802: <b>which_local_addr</b>([{_IfName, IfOpts}|IFs]) -&gt;
<a name="which_local_addr-last_expr"/><a name="1803"/> 1803: <b>    case which_local_addr2</b>(IfOpts) of
<a name="1804"/> 1804:         {ok, Addr} -&gt;
<a name="1805"/> 1805:             Addr;
<a name="1806"/> 1806:         error -&gt;
<a name="1807"/> 1807:             which_local_addr(IFs)
<a name="1808"/> 1808:     end.
<a name="1809"/> 1809: 
<a name="which_local_addr2-1"/><a name="1810"/> 1810: <b>which_local_addr2</b>(IfOpts) -&gt;
<a name="which_local_addr2-last_expr"/><a name="1811"/> 1811: <b>    case if_is_running</b>(IfOpts) of
<a name="1812"/> 1812:         true -&gt;
<a name="1813"/> 1813:             which_local_addr3(IfOpts);
<a name="1814"/> 1814:         false -&gt;
<a name="1815"/> 1815:             error
<a name="1816"/> 1816:     end.
<a name="1817"/> 1817: 
<a name="if_is_running-1"/><a name="1818"/> 1818: <b>if_is_running</b>(If) -&gt;
<a name="if_is_running-last_expr"/><a name="1819"/> 1819: <b>    lists:keymember</b>(flags, 1, If) andalso
<a name="1820"/> 1820:         begin
<a name="1821"/> 1821:             {value, {flags, Flags}} = lists:keysearch(flags, 1, If),
<a name="1822"/> 1822:             (not lists:member(loopback, Flags)) andalso lists:member(running, Flags)
<a name="1823"/> 1823:         end.
<a name="1824"/> 1824:     
<a name="which_local_addr3-1"/><a name="1825"/> 1825: <b>which_local_addr3</b>([]) -&gt;
<a name="1826"/> 1826:     error;
<a name="1827"/> 1827: <b>which_local_addr3</b>([{addr, Addr}|_]) 
<a name="1828"/> 1828:   when (size(Addr) =:= 4) andalso (element(1, Addr) =/= 127) -&gt;
<a name="1829"/> 1829:     {ok, Addr};
<a name="1830"/> 1830: <b>which_local_addr3</b>([_|T]) -&gt;
<a name="which_local_addr3-last_expr"/><a name="1831"/> 1831: <b>    which_local_addr3</b>(T).
<a name="1832"/> 1832: 
<a name="1833"/> 1833: 
<a name="1834"/> 1834: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1835"/> 1835: 
<a name="try_tc-4"/><a name="1836"/> 1836: <b>try_tc</b>(TCName, Pre, Case, Post) -&gt;
<a name="try_tc-last_expr"/><a name="1837"/> 1837: <b>    try_tc</b>(TCName, &quot;TEST&quot;, ?TEST_VERBOSITY, Pre, Case, Post).
<a name="1838"/> 1838: 
<a name="try_tc-6"/><a name="1839"/> 1839: <b>try_tc</b>(TCName, Name, Verbosity, Pre, Case, Post) -&gt;
<a name="try_tc-last_expr"/><a name="1840"/> 1840: <b>    ?TRY_TC</b>(TCName, Name, Verbosity, Pre, Case, Post).
<a name="1841"/> 1841: 
<a name="1842"/> 1842: 
<a name="1843"/> 1843: 
<a name="1844"/> 1844: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1845"/> 1845: 
<a name="1846"/> 1846: <i>%% p(F) -&gt;</i>
<a name="1847"/> 1847: <i>%%     p(F, []).</i>
<a name="1848"/> 1848: 
<a name="p-2"/><a name="1849"/> 1849: <b>p</b>(F, A) -&gt;
<a name="p-last_expr"/><a name="1850"/> 1850: <b>    p</b>(get(sname), F, A).
<a name="1851"/> 1851: 
<a name="p-3"/><a name="1852"/> 1852: <b>p</b>(S, F, A) when is_list(S) -&gt;
<a name="1853"/> 1853:     io:format(&quot;*** [~s] ~p ~s ***&quot; 
<a name="1854"/> 1854: 	      &quot;~n   &quot; ++ F ++ &quot;~n&quot;, 
<a name="1855"/> 1855: 	      [?FTS(), self(), S | A]);
<a name="1856"/> 1856: <b>p</b>(_S, F, A) -&gt;
<a name="p-last_expr"/><a name="1857"/> 1857: <b>    io:format</b>(&quot;*** [~s] ~p *** &quot;
<a name="1858"/> 1858: 	      &quot;~n   &quot; ++ F ++ &quot;~n&quot;, 
<a name="1859"/> 1859: 	      [?FTS(), self() | A]).
<a name="1860"/> 1860: 
<a name="1861"/> 1861: 
<a name="i-1"/><a name="1862"/> 1862: <b>i</b>(F) -&gt;
<a name="i-last_expr"/><a name="1863"/> 1863: <b>    i</b>(F, []).
<a name="1864"/> 1864: 
<a name="i-2"/><a name="1865"/> 1865: <b>i</b>(F, A) -&gt;
<a name="i-last_expr"/><a name="1866"/> 1866: <b>    print</b>(info, get(verbosity), &quot;&quot;, F, A).
<a name="1867"/> 1867: 
<a name="1868"/> 1868: 
<a name="d-1"/><a name="1869"/> 1869: <b>d</b>(F) -&gt;
<a name="d-last_expr"/><a name="1870"/> 1870: <b>    d</b>(F, []).
<a name="1871"/> 1871: 
<a name="d-2"/><a name="1872"/> 1872: <b>d</b>(F, A) -&gt;
<a name="d-last_expr"/><a name="1873"/> 1873: <b>    print</b>(debug, get(verbosity), &quot;DBG: &quot;, F, A).
<a name="1874"/> 1874: 
<a name="1875"/> 1875: 
<a name="printable-2"/><a name="1876"/> 1876: <b>printable</b>(_, debug)   -&gt; true;
<a name="1877"/> 1877: <b>printable</b>(info, info) -&gt; true;
<a name="printable-last_expr"/><a name="1878"/> 1878: <b>printable</b>(_,_)        -&gt; false.
<a name="1879"/> 1879: 
<a name="print-5"/><a name="1880"/> 1880: <b>print</b>(Severity, Verbosity, P, F, A) -&gt;
<a name="print-last_expr"/><a name="1881"/> 1881: <b>    print</b>(printable(Severity,Verbosity), P, F, A).
<a name="1882"/> 1882: 
<a name="print-4"/><a name="1883"/> 1883: <b>print</b>(true, P, F, A) -&gt;
<a name="1884"/> 1884:     io:format(&quot;~s~p:~s:~s: &quot; ++ F ++ &quot;~n&quot;, [P, self(), get(sname), ?FTS() | A]);
<a name="1885"/> 1885: <b>print</b>(_, _, _, _) -&gt;
<a name="print-last_expr"/><a name="1886"/> 1886:     ok.
<a name="1887"/> 1887: 
<a name="1888"/> 1888: 
<a name="progress-1"/><a name="1889"/> 1889: <b>progress</b>(F) -&gt;
<a name="progress-last_expr"/><a name="1890"/> 1890: <b>    progress</b>(F, []).
<a name="1891"/> 1891: 
<a name="progress-2"/><a name="1892"/> 1892: <b>progress</b>(F, A) -&gt;
<a name="1893"/> 1893:     io:format(&quot;~s &quot; ++ F ++ &quot;~n&quot;, [?FTS()|A]),
<a name="progress-last_expr"/><a name="1894"/> 1894: <b>    io:format</b>(user, &quot;~s &quot; ++ F ++ &quot;~n&quot;, [?FTS()|A]).
<a name="1895"/> 1895: 
<a name="1896"/> 1896: 
<a name="1897"/> 1897: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1898"/> 1898: 
<a name="random-0"/><a name="1899"/> 1899: <b>random</b>() -&gt;
<a name="random-last_expr"/><a name="1900"/> 1900: <b>    10 * rand:uniform</b>(50).
<a name="1901"/> 1901: 
<a name="apply_load_timer-0"/><a name="1902"/> 1902: <b>apply_load_timer</b>() -&gt;
<a name="apply_load_timer-last_expr"/><a name="1903"/> 1903: <b>    erlang:send_after</b>(random(), self(), apply_load_timeout).
<a name="1904"/> 1904: 
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
