<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/num_bif_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1997-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(num_bif_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="24"/>   24: 
<a name="25"/>   25: <i>%% Tests the BIFs:</i>
<a name="26"/>   26: <i>%% 	abs/1</i>
<a name="27"/>   27: <i>%%	float/1</i>
<a name="28"/>   28: <i>%%	float_to_list/1</i>
<a name="29"/>   29: <i>%%  float_to_list/2</i>
<a name="30"/>   30: <i>%%	integer_to_list/1</i>
<a name="31"/>   31: <i>%%	list_to_float/1</i>
<a name="32"/>   32: <i>%%	list_to_integer/1</i>
<a name="33"/>   33: <i>%%	round/1</i>
<a name="34"/>   34: <i>%%	trunc/1</i>
<a name="35"/>   35: <i>%%      floor/1</i>
<a name="36"/>   36: <i>%%      ceil/1</i>
<a name="37"/>   37: <i>%%	integer_to_binary/1</i>
<a name="38"/>   38: <i>%%	integer_to_binary/2</i>
<a name="39"/>   39: <i>%%	binary_to_integer/1</i>
<a name="40"/>   40: 
<a name="41"/>   41: <b>-export</b>([all/0, suite/0, groups/0, init_per_suite/1, end_per_suite/1,
<a name="42"/>   42: 	 init_per_group/2, end_per_group/2, t_abs/1, t_float/1,
<a name="43"/>   43: 	 t_float_to_string/1, t_integer_to_string/1,
<a name="44"/>   44: 	 t_string_to_integer/1, t_list_to_integer_edge_cases/1,
<a name="45"/>   45: 	 t_string_to_float_safe/1, t_string_to_float_risky/1,
<a name="46"/>   46: 	 t_round/1, t_trunc_and_friends/1
<a name="47"/>   47:      ]).
<a name="48"/>   48: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="49"/>   49: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="50"/>   50: 
<a name="all-0"/><a name="51"/>   51: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="52"/>   52:     [t_abs, t_float, t_float_to_string, t_integer_to_string,
<a name="53"/>   53:      {group, t_string_to_float}, t_string_to_integer, t_round,
<a name="54"/>   54:      t_trunc_and_friends, t_list_to_integer_edge_cases].
<a name="55"/>   55: 
<a name="groups-0"/><a name="56"/>   56: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="57"/>   57:     [{t_string_to_float, [],
<a name="58"/>   58:       [t_string_to_float_safe, t_string_to_float_risky]}].
<a name="59"/>   59: 
<a name="init_per_suite-1"/><a name="60"/>   60: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="61"/>   61:     Config.
<a name="62"/>   62: 
<a name="end_per_suite-1"/><a name="63"/>   63: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="64"/>   64:     ok.
<a name="65"/>   65: 
<a name="init_per_group-2"/><a name="66"/>   66: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="67"/>   67:     Config.
<a name="68"/>   68: 
<a name="end_per_group-2"/><a name="69"/>   69: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="70"/>   70:     Config.
<a name="71"/>   71: 
<a name="72"/>   72: 
<a name="t_abs-1"/><a name="73"/>   73: <b>t_abs</b>(Config) when is_list(Config) -&gt;
<a name="74"/>   74:     %% Floats.
<a name="75"/>   75:     5.5 = abs(id(5.5)),
<a name="76"/>   76:     0.0 = abs(id(0.0)),
<a name="77"/>   77:     100.0 = abs(id(-100.0)),
<a name="78"/>   78: 
<a name="79"/>   79:     %% Integers.
<a name="80"/>   80:     5 = abs(id(5)),
<a name="81"/>   81:     0 = abs(id(0)),
<a name="82"/>   82:     100 = abs(id(-100)),
<a name="83"/>   83: 
<a name="84"/>   84:     %% The largest smallnum. OTP-3190.
<a name="85"/>   85:     X = id((1 bsl 27) - 1),
<a name="86"/>   86:     X = abs(X),
<a name="87"/>   87:     X = abs(X-1)+1,
<a name="88"/>   88:     X = abs(X+1)-1,
<a name="89"/>   89:     X = abs(-X),
<a name="90"/>   90:     X = abs(-X-1)-1,
<a name="91"/>   91:     X = abs(-X+1)+1,
<a name="92"/>   92: 
<a name="93"/>   93:     %% Bignums.
<a name="94"/>   94:     BigNum = id(13984792374983749),
<a name="95"/>   95:     BigNum = abs(BigNum),
<a name="96"/>   96:     BigNum = abs(-BigNum),
<a name="t_abs-last_expr"/><a name="97"/>   97:     ok.
<a name="98"/>   98: 
<a name="t_float-1"/><a name="99"/>   99: <b>t_float</b>(Config) when is_list(Config) -&gt;
<a name="100"/>  100:     0.0 = float(id(0)),
<a name="101"/>  101:     2.5 = float(id(2.5)),
<a name="102"/>  102:     0.0 = float(id(0.0)),
<a name="103"/>  103:     -100.55 = float(id(-100.55)),
<a name="104"/>  104:     42.0 = float(id(42)),
<a name="105"/>  105:     -100.0 = float(id(-100)),
<a name="106"/>  106: 
<a name="107"/>  107:     %% Bignums.
<a name="108"/>  108:     4294967305.0 = float(id(4294967305)),
<a name="109"/>  109:     -4294967305.0 = float(id(-4294967305)),
<a name="110"/>  110: 
<a name="111"/>  111:     %% Extremely big bignums.
<a name="112"/>  112:     Big = id(list_to_integer(id(lists:duplicate(2000, $1)))),
<a name="113"/>  113:     {'EXIT', {badarg, _}} = (catch float(Big)),
<a name="114"/>  114: 
<a name="t_float-last_expr"/><a name="115"/>  115:     ok.
<a name="116"/>  116: 
<a name="117"/>  117: 
<a name="118"/>  118: <i>%% Tests float_to_list/1, float_to_list/2, float_to_binary/1, float_to_binary/2</i>
<a name="119"/>  119: 
<a name="t_float_to_string-1"/><a name="120"/>  120: <b>t_float_to_string</b>(Config) when is_list(Config) -&gt;
<a name="121"/>  121:     rand_seed(),
<a name="122"/>  122:     test_fts(&quot;0.00000000000000000000e+00&quot;, 0.0),
<a name="123"/>  123:     test_fts(&quot;2.50000000000000000000e+01&quot;, 25.0),
<a name="124"/>  124:     test_fts(&quot;2.50000000000000000000e+00&quot;, 2.5),
<a name="125"/>  125:     test_fts(&quot;2.50000000000000000000e-01&quot;, 0.25),
<a name="126"/>  126:     test_fts(&quot;-3.50000000000000000000e+17&quot;, -350.0e15),
<a name="127"/>  127:     test_fts(&quot;1.00000000000000000000e+00&quot;,1.0),
<a name="128"/>  128:     test_fts(&quot;1.00000000000000000000e+00&quot;,1.0,  []),
<a name="129"/>  129:     test_fts(&quot;-1.00000000000000000000e+00&quot;,-1.0, []),
<a name="130"/>  130:     test_fts(&quot;-1.00000000000000000000&quot;,-1.0, [{decimals, 20}]),
<a name="131"/>  131:     {'EXIT', {badarg, _}} = (catch float_to_list(1.0,  [{decimals, -1}])),
<a name="132"/>  132:     {'EXIT', {badarg, _}} = (catch float_to_list(1.0,  [{decimals, 254}])),
<a name="133"/>  133:     {'EXIT', {badarg, _}} = (catch float_to_list(1.0,  [{scientific, 250}])),
<a name="134"/>  134:     {'EXIT', {badarg, _}} = (catch float_to_list(1.0e+300, [{decimals, 1}])),
<a name="135"/>  135:     {'EXIT', {badarg, _}} = (catch float_to_binary(1.0,  [{decimals, -1}])),
<a name="136"/>  136:     {'EXIT', {badarg, _}} = (catch float_to_binary(1.0,  [{decimals, 254}])),
<a name="137"/>  137:     {'EXIT', {badarg, _}} = (catch float_to_binary(1.0,  [{scientific, 250}])),
<a name="138"/>  138:     {'EXIT', {badarg, _}} = (catch float_to_binary(1.0e+300, [{decimals, 1}])),
<a name="139"/>  139:     test_fts(&quot;1.0e+300&quot;,1.0e+300, [{scientific, 1}]),
<a name="140"/>  140:     test_fts(&quot;1.0&quot;,1.0,  [{decimals,   249}, compact]),
<a name="141"/>  141:     test_fts(&quot;1&quot;,1.0,[{decimals,0}]),
<a name="142"/>  142:     test_fts(&quot;2&quot;,1.9,[{decimals,0}]),
<a name="143"/>  143:     test_fts(&quot;123456789012345680.0&quot;,123456789012345678.0,
<a name="144"/>  144: 	     [{decimals, 236}, compact]),
<a name="145"/>  145:     {'EXIT', {badarg, _}} = (catch float_to_list(
<a name="146"/>  146: 				     123456789012345678.0, [{decimals, 237}])),
<a name="147"/>  147:     {'EXIT', {badarg, _}} = (catch float_to_binary(
<a name="148"/>  148: 				     123456789012345678.0, [{decimals, 237}])),
<a name="149"/>  149:     test_fts(&quot;1.&quot; ++ lists:duplicate(249, $0) ++ &quot;e+00&quot;,
<a name="150"/>  150: 	     1.0,  [{scientific, 249}, compact]),
<a name="151"/>  151: 
<a name="152"/>  152:     X1 = float_to_list(1.0),
<a name="153"/>  153:     X2 = float_to_list(1.0, [{scientific, 20}]),
<a name="154"/>  154:     X1 = X2,
<a name="155"/>  155: 
<a name="156"/>  156:     Y1 = float_to_binary(1.0),
<a name="157"/>  157:     Y2 = float_to_binary(1.0, [{scientific, 20}]),
<a name="158"/>  158:     Y1 = Y2,
<a name="159"/>  159: 
<a name="160"/>  160:     test_fts(&quot;1.000e+00&quot;,1.0,   [{scientific, 3}]),
<a name="161"/>  161:     test_fts(&quot;1.000&quot;,1.0,   [{decimals,   3}]),
<a name="162"/>  162:     test_fts(&quot;1.0&quot;,1.0, [{decimals, 1}]),
<a name="163"/>  163:     test_fts(&quot;1.0&quot;,1.0, [{decimals, 3}, compact]),
<a name="164"/>  164:     test_fts(&quot;10&quot;,10.0, [{decimals, 0}, compact]),
<a name="165"/>  165:     test_fts(&quot;1.12&quot;,1.123, [{decimals, 2}]),
<a name="166"/>  166:     test_fts(&quot;1.123&quot;,1.123, [{decimals, 3}]),
<a name="167"/>  167:     test_fts(&quot;1.123&quot;,1.123, [{decimals, 3}, compact]),
<a name="168"/>  168:     test_fts(&quot;1.1230&quot;,1.123, [{decimals, 4}]),
<a name="169"/>  169:     test_fts(&quot;1.12300&quot;,1.123, [{decimals, 5}]),
<a name="170"/>  170:     test_fts(&quot;1.123&quot;,1.123, [{decimals, 5}, compact]),
<a name="171"/>  171:     test_fts(&quot;1.1234&quot;,1.1234,[{decimals, 6}, compact]),
<a name="172"/>  172:     test_fts(&quot;1.00&quot;,1.005, [{decimals, 2}]),  %% 1.005 is really 1.0049999999...
<a name="173"/>  173:     test_fts(&quot;-1.00&quot;,-1.005,[{decimals, 2}]),
<a name="174"/>  174:     test_fts(&quot;0.999&quot;,0.999, [{decimals, 3}]),
<a name="175"/>  175:     test_fts(&quot;-0.999&quot;,-0.999,[{decimals, 3}]),
<a name="176"/>  176:     test_fts(&quot;1.0&quot;,0.999, [{decimals, 2}, compact]),
<a name="177"/>  177:     test_fts(&quot;-1.0&quot;,-0.999,[{decimals, 2}, compact]),
<a name="178"/>  178:     test_fts(&quot;0.5&quot;,0.5,   [{decimals, 1}]),
<a name="179"/>  179:     test_fts(&quot;-0.5&quot;,-0.5,  [{decimals, 1}]),
<a name="180"/>  180:     &quot;2.333333&quot;  = erlang:float_to_list(7/3, [{decimals, 6}, compact]),
<a name="181"/>  181:     &quot;2.333333&quot;  = erlang:float_to_list(7/3, [{decimals, 6}]),
<a name="182"/>  182:     &lt;&lt;&quot;2.333333&quot;&gt;&gt;  = erlang:float_to_binary(7/3, [{decimals, 6}, compact]),
<a name="183"/>  183:     &lt;&lt;&quot;2.333333&quot;&gt;&gt;  = erlang:float_to_binary(7/3, [{decimals, 6}]),
<a name="184"/>  184:     test_fts(&quot;0.00000000000000000000e+00&quot;,0.0, [compact]),
<a name="185"/>  185:     test_fts(&quot;0.0&quot;,0.0,   [{decimals, 10}, compact]),
<a name="186"/>  186:     test_fts(&quot;123000000000000000000.0&quot;,1.23e20, [{decimals,   10}, compact]),
<a name="187"/>  187:     test_fts(&quot;1.2300000000e+20&quot;,1.23e20, [{scientific, 10}, compact]),
<a name="188"/>  188:     test_fts(&quot;1.23000000000000000000e+20&quot;,1.23e20, []),
<a name="189"/>  189: 
<a name="190"/>  190:     %% Negative zero
<a name="191"/>  191:     &lt;&lt;NegZero/float&gt;&gt; = &lt;&lt;16#8000000000000000:64&gt;&gt;,
<a name="192"/>  192:     &quot;-0.0&quot; = float_to_list(NegZero, [{decimals, 1}, compact]),
<a name="193"/>  193:     &quot;-0.0&quot; = float_to_list(NegZero, [{decimals, 1}]),
<a name="194"/>  194:     &quot;-0.0&quot; = float_to_list(NegZero, [short]),
<a name="195"/>  195:     &quot;-0.0e+00&quot; = float_to_list(NegZero, [{scientific, 1}]),
<a name="196"/>  196:     &quot;-0.0e+00&quot; = float_to_list(NegZero, [{scientific, 1}, compact]),
<a name="197"/>  197:     &lt;&lt;&quot;-0.0&quot;&gt;&gt; = float_to_binary(NegZero, [{decimals, 1}, compact]),
<a name="198"/>  198:     &lt;&lt;&quot;-0.0&quot;&gt;&gt; = float_to_binary(NegZero, [{decimals, 1}]),
<a name="199"/>  199:     &lt;&lt;&quot;-0.0&quot;&gt;&gt; = float_to_binary(NegZero, [short]),
<a name="200"/>  200:     &lt;&lt;&quot;-0.0e+00&quot;&gt;&gt; = float_to_binary(NegZero, [{scientific, 1}]),
<a name="201"/>  201:     &lt;&lt;&quot;-0.0e+00&quot;&gt;&gt; = float_to_binary(NegZero, [{scientific, 1}, compact]),
<a name="202"/>  202: 
<a name="203"/>  203:     fts_rand_float_decimals(1000),
<a name="204"/>  204: 
<a name="205"/>  205:     % test short option
<a name="206"/>  206: 
<a name="207"/>  207:     % test switch for big integers
<a name="208"/>  208:     test_fts(&quot;-9007199254740991.0&quot;, -float((1 bsl 53) -1), [short]),
<a name="209"/>  209:     test_fts(&quot;-9.007199254740992e15&quot;, -float(1 bsl 53), [short]),
<a name="210"/>  210:     test_fts(&quot;-9.007199254740992e15&quot;, -float((1 bsl 53) +1), [short]),
<a name="211"/>  211:     test_fts(&quot;9007199254740991.0&quot;, float((1 bsl 53) -1), [short]),
<a name="212"/>  212:     test_fts(&quot;9.007199254740992e15&quot;, float(1 bsl 53), [short]),
<a name="213"/>  213:     test_fts(&quot;9.007199254740992e15&quot;, float((1 bsl 53) +1), [short]),
<a name="214"/>  214: 
<a name="215"/>  215:     % test basic
<a name="216"/>  216:     test_fts(&quot;2.018&quot;, 2.018, [short]),
<a name="217"/>  217:     test_fts(&quot;-2.018&quot;, -2.018, [short]),
<a name="218"/>  218: 
<a name="219"/>  219:     % test switching logic between decimal and scientific
<a name="220"/>  220:     test_fts(&quot;1.0e-6&quot;, 1.0e-6, [short]),
<a name="221"/>  221:     test_fts(&quot;1.0e-5&quot;, 1.0e-5, [short]),
<a name="222"/>  222:     test_fts(&quot;0.0001&quot;, 1.0e-4, [short]),
<a name="223"/>  223:     test_fts(&quot;0.001&quot;, 1.0e-3, [short]),
<a name="224"/>  224:     test_fts(&quot;0.01&quot;, 1.0e-2, [short]),
<a name="225"/>  225:     test_fts(&quot;0.1&quot;, 1.0e-1, [short]),
<a name="226"/>  226:     test_fts(&quot;1.0&quot;, 1.0e0, [short]),
<a name="227"/>  227:     test_fts(&quot;10.0&quot;, 1.0e1, [short]),
<a name="228"/>  228:     test_fts(&quot;100.0&quot;, 1.0e2, [short]),
<a name="229"/>  229:     test_fts(&quot;1.0e3&quot;, 1.0e3, [short]),
<a name="230"/>  230:     test_fts(&quot;1.0e4&quot;, 1.0e4, [short]),
<a name="231"/>  231:     test_fts(&quot;1.0e5&quot;, 1.0e5, [short]),
<a name="232"/>  232:     test_fts(&quot;1.0e6&quot;, 1.0e6, [short]),
<a name="233"/>  233:     test_fts(&quot;1.0e7&quot;, 1.0e7, [short]),
<a name="234"/>  234:     test_fts(&quot;1.234e-6&quot;, 1.234e-6, [short]),
<a name="235"/>  235:     test_fts(&quot;1.234e-5&quot;, 1.234e-5, [short]),
<a name="236"/>  236:     test_fts(&quot;1.234e-4&quot;, 1.234e-4, [short]),
<a name="237"/>  237:     test_fts(&quot;0.001234&quot;, 1.234e-3, [short]),
<a name="238"/>  238:     test_fts(&quot;0.01234&quot;, 1.234e-2, [short]),
<a name="239"/>  239:     test_fts(&quot;0.1234&quot;, 1.234e-1, [short]),
<a name="240"/>  240:     test_fts(&quot;1.234&quot;, 1.234e0, [short]),
<a name="241"/>  241:     test_fts(&quot;12.34&quot;, 1.234e1, [short]),
<a name="242"/>  242:     test_fts(&quot;123.4&quot;, 1.234e2, [short]),
<a name="243"/>  243:     test_fts(&quot;1234.0&quot;, 1.234e3, [short]),
<a name="244"/>  244:     test_fts(&quot;12340.0&quot;, 1.234e4, [short]),
<a name="245"/>  245:     test_fts(&quot;1.234e5&quot;, 1.234e5, [short]),
<a name="246"/>  246:     test_fts(&quot;1.234e6&quot;, 1.234e6, [short]),
<a name="247"/>  247: 
<a name="248"/>  248:     % test the switch to subnormals
<a name="249"/>  249:     test_fts(&quot;2.2250738585072014e-308&quot;, 2.2250738585072014e-308, [short]),
<a name="250"/>  250: 
<a name="251"/>  251:     % test lots of trailing zeroes
<a name="252"/>  252:     test_fts(&quot;2.9802322387695312e-8&quot;, 2.98023223876953125e-8, [short]),
<a name="253"/>  253: 
<a name="254"/>  254:     % test some ryu regressions
<a name="255"/>  255:     test_fts(&quot;-2.109808898695963e16&quot;, -2.109808898695963e16, [short]),
<a name="256"/>  256:     test_fts(&quot;4.940656e-318&quot;, 4.940656e-318, [short]),
<a name="257"/>  257:     test_fts(&quot;1.18575755e-316&quot;, 1.18575755e-316, [short]),
<a name="258"/>  258:     test_fts(&quot;2.989102097996e-312&quot;, 2.989102097996e-312, [short]),
<a name="259"/>  259:     test_fts(&quot;9.0608011534336e15&quot;, 9.0608011534336e15, [short]),
<a name="260"/>  260:     test_fts(&quot;4.708356024711512e18&quot;, 4.708356024711512e18, [short]),
<a name="261"/>  261:     test_fts(&quot;9.409340012568248e18&quot;, 9.409340012568248e18, [short]),
<a name="262"/>  262:     test_fts(&quot;1.2345678&quot;, 1.2345678, [short]),
<a name="t_float_to_string-last_expr"/><a name="263"/>  263:     ok.
<a name="264"/>  264: 
<a name="test_fts-2"/><a name="265"/>  265: <b>test_fts</b>(Expect, Float) -&gt;
<a name="266"/>  266:     Expect = float_to_list(Float),
<a name="267"/>  267:     BinExpect = list_to_binary(Expect),
<a name="test_fts-last_expr"/><a name="268"/>  268: <b>    BinExpect = float_to_binary</b>(Float).
<a name="269"/>  269: 
<a name="test_fts-3"/><a name="270"/>  270: <b>test_fts</b>(Expect, Float, Args) -&gt;
<a name="271"/>  271:     Expect = float_to_list(Float,Args),
<a name="272"/>  272:     BinExpect = list_to_binary(Expect),
<a name="test_fts-last_expr"/><a name="273"/>  273: <b>    BinExpect = float_to_binary</b>(Float,Args).
<a name="274"/>  274: 
<a name="275"/>  275: 
<a name="rand_float_reasonable-0"/><a name="276"/>  276: <b>rand_float_reasonable</b>() -&gt;
<a name="277"/>  277:     F = rand_float(),
<a name="rand_float_reasonable-last_expr"/><a name="278"/>  278: <b>    case abs</b>(F) &gt; 1.0e238 of
<a name="279"/>  279:         true -&gt; rand_float_reasonable();
<a name="280"/>  280:         false -&gt; F
<a name="281"/>  281:     end.
<a name="282"/>  282: 
<a name="fts_rand_float_decimals-1"/><a name="283"/>  283: <b>fts_rand_float_decimals</b>(0) -&gt; ok;
<a name="284"/>  284: <b>fts_rand_float_decimals</b>(N) -&gt;
<a name="285"/>  285:     [begin
<a name="286"/>  286:          F0 = rand_float_reasonable(),
<a name="287"/>  287:          L0 = float_to_list(F0, [{decimals, D}]),
<a name="288"/>  288:          case conform_with_io_lib_format_os(F0,D) of
<a name="289"/>  289:              false -&gt; ok;
<a name="290"/>  290:              true -&gt;
<a name="291"/>  291:                  IOL = lists:flatten(io_lib:format(&quot;~.*f&quot;, [D, F0])),
<a name="292"/>  292:                  true = case L0 =:= IOL of
<a name="293"/>  293:                             true -&gt; true;
<a name="294"/>  294:                             false -&gt;
<a name="295"/>  295:                                 io:format(&quot;F0 = ~w ~w\n&quot;,  [F0, &lt;&lt;F0/float&gt;&gt;]),
<a name="296"/>  296:                                 io:format(&quot;decimals = ~w\n&quot;,  [D]),
<a name="297"/>  297:                                 io:format(&quot;float_to_list = ~s\n&quot;,  [L0]),
<a name="298"/>  298:                                 io:format(&quot;io_lib:format = ~s\n&quot;,  [IOL]),
<a name="299"/>  299:                                 false
<a name="300"/>  300:                         end
<a name="301"/>  301:          end,
<a name="302"/>  302:          L1 = case D of
<a name="303"/>  303:                   0 -&gt; L0 ++ &quot;.0&quot;;
<a name="304"/>  304:                   _ -&gt; L0
<a name="305"/>  305:               end,
<a name="306"/>  306:          F1 = list_to_float(L1),
<a name="307"/>  307:          Diff = abs(F0-F1),
<a name="308"/>  308:          MaxDiff = max_diff_decimals(F0, D-1),
<a name="309"/>  309:          ok = case Diff =&lt; MaxDiff of
<a name="310"/>  310:                   true -&gt; ok;
<a name="311"/>  311:                   false -&gt;
<a name="312"/>  312:                       io:format(&quot;F0 = ~w ~w\n&quot;,  [F0, &lt;&lt;F0/float&gt;&gt;]),
<a name="313"/>  313:                       io:format(&quot;L1 = ~s\n&quot;,  [L1]),
<a name="314"/>  314:                       io:format(&quot;F1 = ~w ~w\n&quot;,  [F1, &lt;&lt;F1/float&gt;&gt;]),
<a name="315"/>  315:                       io:format(&quot;Diff = ~w, MaxDiff = ~w\n&quot;, [Diff, MaxDiff]),
<a name="316"/>  316:                       error
<a name="317"/>  317:               end
<a name="318"/>  318:      end
<a name="319"/>  319:      || D &lt;- lists:seq(0,15)],
<a name="320"/>  320: 
<a name="fts_rand_float_decimals-last_expr"/><a name="321"/>  321: <b>    fts_rand_float_decimals</b>(N-1).
<a name="322"/>  322: 
<a name="conform_with_io_lib_format_os-2"/><a name="323"/>  323: <b>conform_with_io_lib_format_os</b>(F, D) -&gt;
<a name="conform_with_io_lib_format_os-last_expr"/><a name="324"/>  324: <b>    case os:type</b>() of
<a name="325"/>  325:         {win32,_} -&gt;
<a name="326"/>  326:             %% io_lib:format(&quot;~.*f&quot;) buggy on windows? OTP-15010
<a name="327"/>  327:             false;
<a name="328"/>  328:         _ -&gt;
<a name="329"/>  329:             conform_with_io_lib_format(F, D)
<a name="330"/>  330:     end.
<a name="331"/>  331: 
<a name="conform_with_io_lib_format-2"/><a name="332"/>  332: <b>conform_with_io_lib_format</b>(_, 0) -&gt;
<a name="333"/>  333:     %% io_lib:format(&quot;~.*f&quot;) does not support zero decimals
<a name="334"/>  334:     false;
<a name="335"/>  335: <b>conform_with_io_lib_format</b>(_, D) when D &gt; 10 -&gt;
<a name="336"/>  336:     %% Seems float_to_list gets it slightly wrong sometimes for many decimals
<a name="337"/>  337:     false;
<a name="338"/>  338: <b>conform_with_io_lib_format</b>(F, D) -&gt;
<a name="339"/>  339:     %% io_lib:format prints '0' for input bits beyond mantissa precision
<a name="340"/>  340:     %% float_to_list treats those unknown input bits as if they were zeros.
<a name="conform_with_io_lib_format-last_expr"/><a name="341"/>  341: <b>    math:log2</b>(abs(F) * math:pow(10,D)) &lt; 54.
<a name="342"/>  342: 
<a name="max_diff_decimals-2"/><a name="343"/>  343: <b>max_diff_decimals</b>(F, D) -&gt;
<a name="344"/>  344:     IntBits = floor(math:log2(abs(F))) + 1,
<a name="345"/>  345:     FracBits = (52 - IntBits),
<a name="346"/>  346:     Log10_2 = 0.3010299956639812,  % math:log10(2)
<a name="347"/>  347:     MaxDec = floor(FracBits * Log10_2),
<a name="348"/>  348: 
<a name="349"/>  349:     Resolution = math:pow(2, IntBits - 53),
<a name="350"/>  350: 
<a name="max_diff_decimals-last_expr"/><a name="351"/>  351: <b>    </b>(math:pow(10, -min(D,MaxDec)) / 2) + Resolution.
<a name="352"/>  352: 
<a name="353"/>  353: <i>%% Tests list_to_float/1.</i>
<a name="354"/>  354: 
<a name="t_string_to_float_safe-1"/><a name="355"/>  355: <b>t_string_to_float_safe</b>(Config) when is_list(Config) -&gt;
<a name="356"/>  356:     test_stf(0.0,&quot;0.0&quot;),
<a name="357"/>  357:     test_stf(-0.0,&quot;-0.0&quot;),
<a name="358"/>  358:     test_stf(0.5,&quot;0.5&quot;),
<a name="359"/>  359:     test_stf(-0.5,&quot;-0.5&quot;),
<a name="360"/>  360:     test_stf(100.0,&quot;1.0e2&quot;),
<a name="361"/>  361:     test_stf(127.5,&quot;127.5&quot;),
<a name="362"/>  362:     test_stf(-199.5,&quot;-199.5&quot;),
<a name="363"/>  363: 
<a name="364"/>  364:     {'EXIT',{badarg,_}} = (catch list_to_float(id(&quot;0&quot;))),
<a name="365"/>  365:     {'EXIT',{badarg,_}} = (catch list_to_float(id(&quot;0..0&quot;))),
<a name="366"/>  366:     {'EXIT',{badarg,_}} = (catch list_to_float(id(&quot;0e12&quot;))),
<a name="367"/>  367:     {'EXIT',{badarg,_}} = (catch list_to_float(id(&quot;--0.0&quot;))),
<a name="368"/>  368:     {'EXIT',{badarg,_}} = (catch binary_to_float(id(&lt;&lt;&quot;0&quot;&gt;&gt;))),
<a name="369"/>  369:     {'EXIT',{badarg,_}} = (catch binary_to_float(id(&lt;&lt;&quot;0..0&quot;&gt;&gt;))),
<a name="370"/>  370:     {'EXIT',{badarg,_}} = (catch binary_to_float(id(&lt;&lt;&quot;0e12&quot;&gt;&gt;))),
<a name="371"/>  371:     {'EXIT',{badarg,_}} = (catch binary_to_float(id(&lt;&lt;&quot;--0.0&quot;&gt;&gt;))),
<a name="372"/>  372: 
<a name="373"/>  373:     UBin = &lt;&lt;0:3,(id(&lt;&lt;&quot;0.0&quot;&gt;&gt;))/binary,0:5&gt;&gt;,
<a name="374"/>  374:     &lt;&lt;_:3,UnAlignedBin:3/binary,0:5&gt;&gt; = id(UBin),
<a name="375"/>  375:     0.0 = binary_to_float(UnAlignedBin),
<a name="376"/>  376: 
<a name="377"/>  377:     ABin = &lt;&lt;0:8,(id(&lt;&lt;&quot;1.0&quot;&gt;&gt;))/binary,0:8&gt;&gt;,
<a name="378"/>  378:     &lt;&lt;_:8,AlignedBin:3/binary,0:8&gt;&gt; = id(ABin),
<a name="379"/>  379:     1.0 = binary_to_float(AlignedBin),
<a name="380"/>  380: 
<a name="t_string_to_float_safe-last_expr"/><a name="381"/>  381:     ok.
<a name="382"/>  382: 
<a name="383"/>  383: <i>%% This might crash the emulator...</i>
<a name="384"/>  384: <i>%% (Known to crash the Unix version of Erlang 4.4.1)</i>
<a name="385"/>  385: 
<a name="t_string_to_float_risky-1"/><a name="386"/>  386: <b>t_string_to_float_risky</b>(Config) when is_list(Config) -&gt;
<a name="387"/>  387:     Many_Ones = lists:duplicate(25000, id($1)),
<a name="388"/>  388:     id(list_to_float(&quot;2.&quot;++Many_Ones)),
<a name="389"/>  389:     {'EXIT', {badarg, _}} = (catch list_to_float(&quot;2&quot;++Many_Ones)),
<a name="390"/>  390: 
<a name="391"/>  391:     id(binary_to_float(list_to_binary(&quot;2.&quot;++Many_Ones))),
<a name="392"/>  392:     {'EXIT', {badarg, _}} = (catch binary_to_float(
<a name="393"/>  393: 				     list_to_binary(&quot;2&quot;++Many_Ones))),
<a name="t_string_to_float_risky-last_expr"/><a name="394"/>  394:     ok.
<a name="395"/>  395: 
<a name="test_stf-2"/><a name="396"/>  396: <b>test_stf</b>(Expect,List) -&gt;
<a name="397"/>  397:     Expect = list_to_float(List),
<a name="398"/>  398:     Bin = list_to_binary(List),
<a name="test_stf-last_expr"/><a name="399"/>  399: <b>    Expect = binary_to_float</b>(Bin).
<a name="400"/>  400: 
<a name="401"/>  401: <i>%% Tests round/1.</i>
<a name="402"/>  402: 
<a name="t_round-1"/><a name="403"/>  403: <b>t_round</b>(Config) when is_list(Config) -&gt;
<a name="404"/>  404:     0 = round(id(0.0)),
<a name="405"/>  405:     0 = round(id(0.4)),
<a name="406"/>  406:     1 = round(id(0.5)),
<a name="407"/>  407:     0 = round(id(-0.4)),
<a name="408"/>  408:     -1 = round(id(-0.5)),
<a name="409"/>  409:     255 = round(id(255.3)),
<a name="410"/>  410:     256 = round(id(255.6)),
<a name="411"/>  411:     -1033 = round(id(-1033.3)),
<a name="412"/>  412:     -1034 = round(id(-1033.6)),
<a name="413"/>  413: 
<a name="414"/>  414:     % OTP-3722:
<a name="415"/>  415:     X = id((1 bsl 27) - 1),
<a name="416"/>  416:     MX = -X,
<a name="417"/>  417:     MXm1 = -X-1,
<a name="418"/>  418:     MXp1 = -X+1,
<a name="419"/>  419:     F = id(X + 0.0),
<a name="420"/>  420:     X = round(F),
<a name="421"/>  421:     X = round(F+1)-1,
<a name="422"/>  422:     X = round(F-1)+1,
<a name="423"/>  423:     MX = round(-F),
<a name="424"/>  424:     MXm1 = round(-F-1),
<a name="425"/>  425:     MXp1 = round(-F+1),
<a name="426"/>  426: 
<a name="427"/>  427:     X = round(F+0.1),
<a name="428"/>  428:     X = round(F+1+0.1)-1,
<a name="429"/>  429:     X = round(F-1+0.1)+1,
<a name="430"/>  430:     MX = round(-F+0.1),
<a name="431"/>  431:     MXm1 = round(-F-1+0.1),
<a name="432"/>  432:     MXp1 = round(-F+1+0.1),
<a name="433"/>  433: 
<a name="434"/>  434:     X = round(F-0.1),
<a name="435"/>  435:     X = round(F+1-0.1)-1,
<a name="436"/>  436:     X = round(F-1-0.1)+1,
<a name="437"/>  437:     MX = round(-F-0.1),
<a name="438"/>  438:     MXm1 = round(-F-1-0.1),
<a name="439"/>  439:     MXp1 = round(-F+1-0.1),
<a name="440"/>  440: 
<a name="441"/>  441:     0.5 = abs(round(F+0.5)-(F+0.5)),
<a name="442"/>  442:     0.5 = abs(round(F-0.5)-(F-0.5)),
<a name="443"/>  443:     0.5 = abs(round(-F-0.5)-(-F-0.5)),
<a name="444"/>  444:     0.5 = abs(round(-F+0.5)-(-F+0.5)),
<a name="445"/>  445: 
<a name="446"/>  446:     %% Bignums.
<a name="447"/>  447:     4294967296 = round(id(4294967296.1)),
<a name="448"/>  448:     4294967297 = round(id(4294967296.9)),
<a name="449"/>  449:     -4294967296 = -round(id(4294967296.1)),
<a name="450"/>  450:     -4294967297 = -round(id(4294967296.9)),
<a name="451"/>  451: 
<a name="452"/>  452:     6209607916799025 = round(id(6209607916799025.0)),
<a name="453"/>  453:     -6209607916799025 = round(id(-6209607916799025.0)),
<a name="t_round-last_expr"/><a name="454"/>  454:     ok.
<a name="455"/>  455: 
<a name="456"/>  456: <i>%% Test trunc/1, floor/1, ceil/1, and round/1.</i>
<a name="t_trunc_and_friends-1"/><a name="457"/>  457: <b>t_trunc_and_friends</b>(_Config) -&gt;
<a name="458"/>  458:     MinusZero = 0.0 / (-1.0),
<a name="459"/>  459:     0 = trunc_and_friends(MinusZero),
<a name="460"/>  460:     0 = trunc_and_friends(0.0),
<a name="461"/>  461:     5 = trunc_and_friends(5.3333),
<a name="462"/>  462:     -10 = trunc_and_friends(-10.978987),
<a name="463"/>  463: 
<a name="464"/>  464:     %% The largest smallnum, converted to float (OTP-3722):
<a name="465"/>  465:     X = id((1 bsl 27) - 1),
<a name="466"/>  466:     F = X + 0.0,
<a name="467"/>  467:     io:format(&quot;X = ~p/~w/~w, F = ~p/~w/~w, trunc(F) = ~p/~w/~w~n&quot;,
<a name="468"/>  468: 	      [X, X, binary_to_list(term_to_binary(X)),
<a name="469"/>  469: 	       F, F, binary_to_list(term_to_binary(F)),
<a name="470"/>  470: 	       trunc_and_friends(F),
<a name="471"/>  471: 	       trunc_and_friends(F),
<a name="472"/>  472: 	       binary_to_list(term_to_binary(trunc_and_friends(F)))]),
<a name="473"/>  473:     X = trunc_and_friends(F),
<a name="474"/>  474:     X = trunc_and_friends(F+1)-1,
<a name="475"/>  475:     X = trunc_and_friends(F-1)+1,
<a name="476"/>  476:     X = -trunc_and_friends(-F),
<a name="477"/>  477:     X = -trunc_and_friends(-F-1)-1,
<a name="478"/>  478:     X = -trunc_and_friends(-F+1)+1,
<a name="479"/>  479: 
<a name="480"/>  480:     %% Bignums.
<a name="481"/>  481:     4294967305 = trunc_and_friends(4294967305.7),
<a name="482"/>  482:     -4294967305 = trunc_and_friends(-4294967305.7),
<a name="483"/>  483:     18446744073709551616 = trunc_and_friends(float(1 bsl 64)),
<a name="484"/>  484:     -18446744073709551616 = trunc_and_friends(-float(1 bsl 64)),
<a name="485"/>  485: 
<a name="486"/>  486:     %% Random.
<a name="487"/>  487:     rand_seed(),
<a name="488"/>  488:     t_trunc_and_friends_rand(100),
<a name="t_trunc_and_friends-last_expr"/><a name="489"/>  489:     ok.
<a name="490"/>  490: 
<a name="rand_seed-0"/><a name="491"/>  491: <b>rand_seed</b>() -&gt;
<a name="492"/>  492:     rand:seed(exrop),
<a name="493"/>  493:     io:format(&quot;\n*** rand:export_seed() = ~w\n\n&quot;, [rand:export_seed()]),
<a name="rand_seed-last_expr"/><a name="494"/>  494:     ok.
<a name="495"/>  495: 
<a name="rand_float-0"/><a name="496"/>  496: <b>rand_float</b>() -&gt;
<a name="497"/>  497:     F0 = rand:uniform() * math:pow(10, 50*rand:normal()),
<a name="rand_float-last_expr"/><a name="498"/>  498: <b>    case rand:uniform</b>() of
<a name="499"/>  499:         U when U &lt; 0.5 -&gt; -F0;
<a name="500"/>  500:         _ -&gt; F0
<a name="501"/>  501:     end.
<a name="502"/>  502: 
<a name="t_trunc_and_friends_rand-1"/><a name="503"/>  503: <b>t_trunc_and_friends_rand</b>(0) -&gt;
<a name="504"/>  504:     ok;
<a name="505"/>  505: <b>t_trunc_and_friends_rand</b>(N) -&gt;
<a name="506"/>  506:     _ = trunc_and_friends(rand_float()),
<a name="t_trunc_and_friends_rand-last_expr"/><a name="507"/>  507: <b>    t_trunc_and_friends_rand</b>(N-1).
<a name="508"/>  508: 
<a name="trunc_and_friends-1"/><a name="509"/>  509: <b>trunc_and_friends</b>(F) -&gt;
<a name="510"/>  510:     Trunc = trunc(F),
<a name="511"/>  511:     Floor = floor(F),
<a name="512"/>  512:     Ceil = ceil(F),
<a name="513"/>  513:     Round = round(F),
<a name="514"/>  514: 
<a name="515"/>  515:     Trunc = trunc(Trunc),
<a name="516"/>  516:     Floor = floor(Floor),
<a name="517"/>  517:     Ceil = ceil(Ceil),
<a name="518"/>  518:     Round = round(Round),
<a name="519"/>  519: 
<a name="520"/>  520:     Trunc = trunc(float(Trunc)),
<a name="521"/>  521:     Floor = floor(float(Floor)),
<a name="522"/>  522:     Ceil = ceil(float(Ceil)),
<a name="523"/>  523:     Round = round(float(Round)),
<a name="524"/>  524: 
<a name="525"/>  525:     true = Floor =&lt; Trunc andalso Trunc =&lt; Ceil,
<a name="526"/>  526:     true = Ceil - Floor =&lt; 1,
<a name="527"/>  527:     true = Round =:= Floor orelse Round =:= Ceil,
<a name="528"/>  528: 
<a name="529"/>  529:     if
<a name="530"/>  530: 	F &lt; 0 -&gt;
<a name="531"/>  531: 	    Trunc = Ceil;
<a name="532"/>  532: 	true -&gt;
<a name="533"/>  533: 	    Trunc = Floor
<a name="534"/>  534:     end,
<a name="trunc_and_friends-last_expr"/><a name="535"/>  535:     Trunc.
<a name="536"/>  536: 
<a name="537"/>  537: <i>%% Tests integer_to_binary/{1,2} and integer_to_list/{1,2}.</i>
<a name="538"/>  538: 
<a name="t_integer_to_string-1"/><a name="539"/>  539: <b>t_integer_to_string</b>(Config) when is_list(Config) -&gt;
<a name="540"/>  540:     test_its(&quot;0&quot;,0),
<a name="541"/>  541:     test_its(&quot;42&quot;,42),
<a name="542"/>  542:     test_its(&quot;-42&quot;,-42),
<a name="543"/>  543:     test_its(&quot;32768&quot;,32768),
<a name="544"/>  544:     test_its(&quot;268435455&quot;,268435455),
<a name="545"/>  545:     test_its(&quot;-268435455&quot;,-268435455),
<a name="546"/>  546:     test_its(&quot;123456932798748738738&quot;,123456932798748738738),
<a name="547"/>  547: 
<a name="548"/>  548:     %% 1 bsl 33, just beyond 32 bit
<a name="549"/>  549:     test_its(&quot;8589934592&quot;,8589934592),
<a name="550"/>  550:     test_its(&quot;-8589934592&quot;,-8589934592),
<a name="551"/>  551:     %% 1 bsl 65, just beyond 64 bit
<a name="552"/>  552:     test_its(&quot;36893488147419103232&quot;,36893488147419103232),
<a name="553"/>  553:     test_its(&quot;-36893488147419103232&quot;,-36893488147419103232),
<a name="554"/>  554: 
<a name="555"/>  555:     %% Bignums.
<a name="556"/>  556:     BigBin = id(list_to_binary(lists:duplicate(2000, id($1)))),
<a name="557"/>  557:     Big    = erlang:binary_to_integer(BigBin),
<a name="558"/>  558:     BigBin = erlang:integer_to_binary(Big),
<a name="559"/>  559: 
<a name="560"/>  560:     %% Invalid types
<a name="561"/>  561:     lists:foreach(fun(Value) -&gt;
<a name="562"/>  562: 			  {'EXIT', {badarg, _}} =
<a name="563"/>  563: 			      (catch erlang:integer_to_binary(Value)),
<a name="564"/>  564: 			  {'EXIT', {badarg, _}} =
<a name="565"/>  565: 			      (catch erlang:integer_to_list(Value))
<a name="566"/>  566: 		  end,[atom,1.2,0.0,[$1,[$2]]]),
<a name="567"/>  567: 
<a name="568"/>  568:     %% Base-2 integers
<a name="569"/>  569:     test_its(&quot;0&quot;, 0, 2),
<a name="570"/>  570:     test_its(&quot;1&quot;, 1, 2),
<a name="571"/>  571:     test_its(&quot;110110&quot;, 54, 2),
<a name="572"/>  572:     test_its(&quot;-1000000&quot;, -64, 2),
<a name="573"/>  573:     %% Base-16 integers
<a name="574"/>  574:     test_its(&quot;0&quot;, 0, 16),
<a name="575"/>  575:     test_its(&quot;A&quot;, 10, 16),
<a name="576"/>  576:     test_its(&quot;D4BE&quot;, 54462, 16),
<a name="577"/>  577:     test_its(&quot;-D4BE&quot;, -54462, 16),
<a name="578"/>  578:     test_its(&quot;FFFFFFFFFF&quot;, 1099511627775, 16),
<a name="579"/>  579:     test_its(&quot;123456789ABCDEF123456789ABCDEF123456789ABCDEF&quot;,
<a name="580"/>  580:              108977460683796539709587792812439445667270661579197935,
<a name="581"/>  581:              16),
<a name="582"/>  582: 
<a name="583"/>  583:     lists:foreach(fun(Value) -&gt;
<a name="584"/>  584: 			  {'EXIT', {badarg, _}} =
<a name="585"/>  585: 			      (catch erlang:integer_to_binary(Value, 8)),
<a name="586"/>  586: 			  {'EXIT', {badarg, _}} =
<a name="587"/>  587: 			      (catch erlang:integer_to_list(Value, 8))
<a name="588"/>  588: 		  end,[atom,1.2,0.0,[$1,[$2]]]),
<a name="589"/>  589: 
<a name="t_integer_to_string-last_expr"/><a name="590"/>  590:     ok.
<a name="591"/>  591: 
<a name="test_its-2"/><a name="592"/>  592: <b>test_its</b>(List,Int) -&gt;
<a name="593"/>  593:     List = integer_to_list(Int),
<a name="594"/>  594:     Binary = list_to_binary(List),
<a name="test_its-last_expr"/><a name="595"/>  595: <b>    Binary = integer_to_binary</b>(Int).
<a name="596"/>  596: 
<a name="test_its-3"/><a name="597"/>  597: <b>test_its</b>(List,Int,Base) -&gt;
<a name="598"/>  598:     List = integer_to_list(Int, Base),
<a name="599"/>  599:     Binary = list_to_binary(List),
<a name="test_its-last_expr"/><a name="600"/>  600: <b>    Binary = integer_to_binary</b>(Int, Base).
<a name="601"/>  601: 
<a name="602"/>  602: <i>%% Tests list_to_integer/{1,2} and binary_to_integer/{1,2}.</i>
<a name="603"/>  603: 
<a name="t_string_to_integer-1"/><a name="604"/>  604: <b>t_string_to_integer</b>(Config) when is_list(Config) -&gt;
<a name="605"/>  605:     _ = rand:uniform(),				%Seed generator
<a name="606"/>  606:     io:format(&quot;Seed: ~p&quot;, [rand:export_seed()]),
<a name="607"/>  607: 
<a name="608"/>  608:     0 = erlang:binary_to_integer(id(&lt;&lt;&quot;00&quot;&gt;&gt;)),
<a name="609"/>  609:     0 = erlang:binary_to_integer(id(&lt;&lt;&quot;-0&quot;&gt;&gt;)),
<a name="610"/>  610:     0 = erlang:binary_to_integer(id(&lt;&lt;&quot;+0&quot;&gt;&gt;)),
<a name="611"/>  611: 
<a name="612"/>  612:     test_sti(0),
<a name="613"/>  613:     test_sti(1),
<a name="614"/>  614:     test_sti(12),
<a name="615"/>  615:     test_sti(42),
<a name="616"/>  616:     test_sti(32768),
<a name="617"/>  617:     test_sti(268435455),
<a name="618"/>  618: 
<a name="619"/>  619:     %% Interesting values around 2-pows, such as MIN_SMALL and MAX_SMALL.
<a name="620"/>  620:     lists:foreach(fun(Bits) -&gt;
<a name="621"/>  621: 			  N = 1 bsl Bits,
<a name="622"/>  622: 			  test_sti(N - 1),
<a name="623"/>  623: 			  test_sti(N),
<a name="624"/>  624: 			  test_sti(N + 1)
<a name="625"/>  625: 		  end,
<a name="626"/>  626: 		  lists:seq(16, 130)),
<a name="627"/>  627: 
<a name="628"/>  628:     %% Bignums
<a name="629"/>  629:     _ = [test_sti(rand_bignum()) || _ &lt;- lists:seq(1, 1000)],
<a name="630"/>  630:     test_sti(123456932798748738738, 16),
<a name="631"/>  631:     test_sti(list_to_integer(lists:duplicate(2000, $1))),
<a name="632"/>  632: 
<a name="633"/>  633:     %% Unaligned string
<a name="634"/>  634:     Str = &lt;&lt;&quot;10&quot;&gt;&gt;,
<a name="635"/>  635:     UnalignStr = &lt;&lt;0:3, (id(Str))/binary, 0:5&gt;&gt;,
<a name="636"/>  636:     &lt;&lt;_:3, SomeStr:2/binary, _:5&gt;&gt; = id(UnalignStr),
<a name="637"/>  637:     10 = binary_to_integer(SomeStr),
<a name="638"/>  638: 
<a name="639"/>  639:     %% Invalid types
<a name="640"/>  640:     lists:foreach(fun(Value) -&gt;
<a name="641"/>  641: 			  {'EXIT', {badarg, _}} =
<a name="642"/>  642: 			      (catch binary_to_integer(Value)),
<a name="643"/>  643: 			  {'EXIT', {badarg, _}} =
<a name="644"/>  644: 			      (catch list_to_integer(Value))
<a name="645"/>  645: 		  end,[atom,1.2,0.0,[$1,[$2]]]),
<a name="646"/>  646: 
<a name="647"/>  647:     %% Default base error cases
<a name="648"/>  648:     lists:foreach(fun(Value) -&gt;
<a name="649"/>  649: 			  {'EXIT', {badarg, _}} =
<a name="650"/>  650: 			      (catch binary_to_integer(list_to_binary(Value))),
<a name="651"/>  651: 			  {'EXIT', {badarg, _}} =
<a name="652"/>  652: 			      (catch list_to_integer(Value))
<a name="653"/>  653: 		  end,[&quot;1.0&quot;,&quot; 1&quot;,&quot; -1&quot;,&quot;&quot;,&quot;+&quot;]),
<a name="654"/>  654: 
<a name="655"/>  655:     %% Custom base error cases
<a name="656"/>  656:     lists:foreach(fun({Value,Base}) -&gt;
<a name="657"/>  657: 			  {'EXIT', {badarg, _}} =
<a name="658"/>  658: 			      (catch binary_to_integer(list_to_binary(Value), Base)),
<a name="659"/>  659: 			  {'EXIT', {badarg, _}} =
<a name="660"/>  660: 			      (catch list_to_integer(Value, Base))
<a name="661"/>  661: 		  end,
<a name="662"/>  662:                   [{&quot; 1&quot;,1},{&quot; 1&quot;,37},{&quot;2&quot;,2},{&quot;B&quot;,11},{&quot;b&quot;,11},{&quot;:&quot;, 16},
<a name="663"/>  663:                    {&quot;1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111z&quot;,16},
<a name="664"/>  664:                    {&quot;1z111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111&quot;,16},
<a name="665"/>  665:                    {&quot;111z11111111&quot;,16},
<a name="666"/>  666:                    %% Untagging atoms at the beginning of atom.names
<a name="667"/>  667:                    %% would produce a base in the valid range.
<a name="668"/>  668:                    {&quot;10&quot;,true},                 %Base 4
<a name="669"/>  669:                    {&quot;10&quot;,'_'},                  %Base 8
<a name="670"/>  670:                    {&quot;10&quot;,nonode@nohost},        %Base 12
<a name="671"/>  671:                    {&quot;10&quot;,'$end_of_table'},      %Base 16
<a name="672"/>  672:                    {&quot;10&quot;,''}                    %Base 20
<a name="673"/>  673:                   ]),
<a name="674"/>  674: 
<a name="675"/>  675:     %% System limit
<a name="676"/>  676:     Digits = lists:duplicate(3_000_000, $9),
<a name="677"/>  677:     {'EXIT',{system_limit,_}} = catch list_to_integer(Digits),
<a name="678"/>  678:     _ = erlang:garbage_collect(),
<a name="679"/>  679:     {'EXIT',{system_limit,_}} = catch list_to_integer(Digits, 16),
<a name="680"/>  680:     _ = erlang:garbage_collect(),
<a name="681"/>  681:     {error,system_limit} = string:to_integer(Digits),
<a name="682"/>  682:     _ = erlang:garbage_collect(),
<a name="683"/>  683: 
<a name="t_string_to_integer-last_expr"/><a name="684"/>  684:     ok.
<a name="685"/>  685: 
<a name="rand_bignum-0"/><a name="686"/>  686: <b>rand_bignum</b>() -&gt;
<a name="687"/>  687:     Sz = max(floor(rand:normal() * 128 + 64), 2*8),
<a name="688"/>  688:     &lt;&lt;Int:Sz/unit:8&gt;&gt; = rand:bytes(Sz),
<a name="rand_bignum-last_expr"/><a name="689"/>  689:     Int.
<a name="690"/>  690: 
<a name="691"/>  691: <i>%% Tests edge cases for list_to_integer; compares with known good values</i>
<a name="692"/>  692: 
<a name="t_list_to_integer_edge_cases-1"/><a name="693"/>  693: <b>t_list_to_integer_edge_cases</b>(Config) when is_list(Config) -&gt;
<a name="694"/>  694:     %% Take integer literals and compare to their representation in ExtTerm
<a name="695"/>  695:     T = [
<a name="696"/>  696:         {16, &quot;0&quot;, &lt;&lt;131,97,0&gt;&gt;},
<a name="697"/>  697:         {16, &quot;-0&quot;, &lt;&lt;131,97,0&gt;&gt;},
<a name="698"/>  698: 
<a name="699"/>  699:         {16, &quot;f&quot;, &lt;&lt;131,97,15&gt;&gt;},
<a name="700"/>  700:         {16, &quot;-f&quot;, &lt;&lt;131,98,255,255,255,241&gt;&gt;},
<a name="701"/>  701: 
<a name="702"/>  702:         {16, &quot;0000000000000000000000000000000000000000000000000f&quot;,
<a name="703"/>  703:             &lt;&lt;131,97,15&gt;&gt;},
<a name="704"/>  704:         {16, &quot;-0000000000000000000000000000000000000000000000000f&quot;,
<a name="705"/>  705:             &lt;&lt;131,98,255,255,255,241&gt;&gt;},
<a name="706"/>  706: 
<a name="707"/>  707:         {16, &quot;ffffffff&quot;, &lt;&lt;131,110,4,0,255,255,255,255&gt;&gt;},
<a name="708"/>  708:         {16, &quot;-ffffffff&quot;, &lt;&lt;131,110,4,1,255,255,255,255&gt;&gt;},
<a name="709"/>  709: 
<a name="710"/>  710:         {16, &quot;7fffffff&quot;, &lt;&lt;131,110,4,0,255,255,255,127&gt;&gt;},
<a name="711"/>  711:         {16, &quot;-7fffffff&quot;, &lt;&lt;131,98,128,0,0,1&gt;&gt;},
<a name="712"/>  712: 
<a name="713"/>  713:         {16, &quot;ffffffffffffffff&quot;,
<a name="714"/>  714:             &lt;&lt;131,110,8,0,255,255,255,255,255,255,255,255&gt;&gt;},
<a name="715"/>  715:         {16, &quot;-ffffffffffffffff&quot;,
<a name="716"/>  716:             &lt;&lt;131,110,8,1,255,255,255,255,255,255,255,255&gt;&gt;},
<a name="717"/>  717: 
<a name="718"/>  718:         {16, &quot;7fffffffffffffff&quot;,
<a name="719"/>  719:             &lt;&lt;131,110,8,0,255,255,255,255,255,255,255,127&gt;&gt;},
<a name="720"/>  720:         {16, &quot;-7fffffffffffffff&quot;,
<a name="721"/>  721:             &lt;&lt;131,110,8,1,255,255,255,255,255,255,255,127&gt;&gt;},
<a name="722"/>  722: 
<a name="723"/>  723:         %% Alleged 32-bit corner case (should not happen on 64-bit). At 32-4
<a name="724"/>  724:         %% bits we may corrupt sign bit and fall out of SMALL_INT range.
<a name="725"/>  725:         {2, &quot;1000000000000000000000000000&quot;, &lt;&lt;131,98,8,0,0,0&gt;&gt;},
<a name="726"/>  726:         {2, &quot;-1000000000000000000000000000&quot;, &lt;&lt;131,98,248,0,0,0&gt;&gt;},
<a name="727"/>  727: 
<a name="728"/>  728:         %% 64-bit corner case (should not happen on 32-bit) at 64-4 bits we
<a name="729"/>  729:         %% corrupt sign bit and fall out of SMALL_INT range (bam! all dead)
<a name="730"/>  730:         {2, &quot;100000000000000000000000000000000000000000000000000000000000&quot;,
<a name="731"/>  731:             &lt;&lt;131,110,8,0,0,0,0,0,0,0,0,8&gt;&gt;},
<a name="732"/>  732:         {2, &quot;-100000000000000000000000000000000000000000000000000000000000&quot;,
<a name="733"/>  733:             &lt;&lt;131,110,8,1,0,0,0,0,0,0,0,8&gt;&gt;}
<a name="734"/>  734:     ],
<a name="735"/>  735:     [begin
<a name="736"/>  736:          io:format(&quot;~s base ~p vs ~p~n&quot;, [Str, Base, Bin]),
<a name="737"/>  737:          FromStr = list_to_integer(Str, Base),
<a name="738"/>  738:          FromStr = binary_to_term(Bin)
<a name="739"/>  739:      end || {Base, Str, Bin} &lt;- T],
<a name="t_list_to_integer_edge_cases-last_expr"/><a name="740"/>  740:     ok.
<a name="741"/>  741: 
<a name="test_sti-1"/><a name="742"/>  742: <b>test_sti</b>(Num) -&gt;
<a name="test_sti-last_expr"/><a name="743"/>  743:     [begin
<a name="744"/>  744: 	 io:format(&quot;Testing ~p:~p&quot;,[Num,Base]),
<a name="745"/>  745: 	 test_sti(Num,Base)
<a name="746"/>  746:      end|| Base &lt;- lists:seq(2,36)].
<a name="747"/>  747: 
<a name="test_sti-2"/><a name="748"/>  748: <b>test_sti</b>(Num, Base) -&gt;
<a name="749"/>  749:     Neg = -Num,
<a name="750"/>  750: 
<a name="751"/>  751:     NumList = int2list(Num, Base),
<a name="752"/>  752:     NegNumList = int2list(Neg, Base),
<a name="753"/>  753: 
<a name="754"/>  754:     Num = list_to_integer(NumList, Base),
<a name="755"/>  755:     Neg = list_to_integer(NegNumList, Base),
<a name="756"/>  756:     Num = binary_to_integer(iolist_to_binary(NumList), Base),
<a name="757"/>  757:     Neg = binary_to_integer(iolist_to_binary(NegNumList), Base),
<a name="758"/>  758: 
<a name="759"/>  759:     if
<a name="760"/>  760:         Base =:= 10 -&gt;
<a name="761"/>  761:             Num = list_to_integer(NumList),
<a name="762"/>  762:             Neg = list_to_integer(NegNumList),
<a name="763"/>  763:             Num = binary_to_integer(iolist_to_binary(NumList)),
<a name="764"/>  764:             Neg = binary_to_integer(iolist_to_binary(NegNumList));
<a name="765"/>  765:         true -&gt;
<a name="766"/>  766:             ok
<a name="767"/>  767:     end,
<a name="768"/>  768: 
<a name="test_sti-last_expr"/><a name="769"/>  769:     ok.
<a name="770"/>  770: 
<a name="771"/>  771: <i>%% Calling this function (which is not supposed to be inlined)</i>
<a name="772"/>  772: <i>%% prevents the compiler from calculating the answer, so we don't test</i>
<a name="773"/>  773: <i>%% the compiler instead of the newest runtime system.</i>
<a name="id-1"/><a name="id-last_expr"/><a name="774"/>  774: <b>id</b>(X) -&gt; X.
<a name="775"/>  775: 
<a name="776"/>  776: <i>%% Use the printing library to convert to list.</i>
<a name="int2list-2"/><a name="777"/>  777: <b>int2list</b>(Int, Base) when is_integer(Base), 2 =&lt; Base, Base =&lt; 36 -&gt;
<a name="int2list-last_expr"/><a name="778"/>  778: <b>    lists:flatten</b>(io_lib:format(&quot;~.&quot;++integer_to_list(Base)++&quot;B&quot;,[Int])).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
