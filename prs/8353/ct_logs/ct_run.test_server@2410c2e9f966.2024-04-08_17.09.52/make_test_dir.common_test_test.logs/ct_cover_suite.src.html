<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/common_test/make_test_dir/common_test_test/ct_cover_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2012-2016. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%%-------------------------------------------------------------------</i>
<a name="22"/>   22: <i>%%% File: ct_cover_SUITE</i>
<a name="23"/>   23: <i>%%%</i>
<a name="24"/>   24: <i>%%% Description:</i>
<a name="25"/>   25: <i>%%% Test code cover analysis support</i>
<a name="26"/>   26: <i>%%%</i>
<a name="27"/>   27: <i>%%%-------------------------------------------------------------------</i>
<a name="28"/>   28: <b>-module</b>(ct_cover_SUITE).
<a name="29"/>   29: 
<a name="30"/>   30: <b>-compile</b>(export_all).
<a name="31"/>   31: 
<a name="32"/>   32: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="33"/>   33: <b>-include_lib</b>(&quot;common_test/include/ct_event.hrl&quot;).
<a name="34"/>   34: 
<a name="35"/>   35: <b>-define</b>(eh, ct_test_support_eh).
<a name="36"/>   36: <b>-define</b>(suite, cover_SUITE).
<a name="37"/>   37: <b>-define</b>(mod, cover_test_mod).
<a name="38"/>   38: 
<a name="39"/>   39: <i>%%--------------------------------------------------------------------</i>
<a name="40"/>   40: <i>%% TEST SERVER CALLBACK FUNCTIONS</i>
<a name="41"/>   41: <i>%%--------------------------------------------------------------------</i>
<a name="42"/>   42: 
<a name="43"/>   43: <i>%%--------------------------------------------------------------------</i>
<a name="44"/>   44: <i>%% Description: Since Common Test starts another Test Server</i>
<a name="45"/>   45: <i>%% instance, the tests need to be performed on a separate node (or</i>
<a name="46"/>   46: <i>%% there will be clashes with logging processes etc).</i>
<a name="47"/>   47: <i>%%--------------------------------------------------------------------</i>
<a name="init_per_suite-1"/><a name="48"/>   48: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="49"/>   49: <b>    case test_server:is_cover</b>() of
<a name="50"/>   50: 	true -&gt;
<a name="51"/>   51: 	    {skip,&quot;Test server is running cover already - skipping&quot;};
<a name="52"/>   52: 	false -&gt;
<a name="53"/>   53: 	    ct_test_support:init_per_suite(Config)
<a name="54"/>   54:     end.
<a name="55"/>   55: 
<a name="end_per_suite-1"/><a name="56"/>   56: <b>end_per_suite</b>(Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="57"/>   57: <b>    ct_test_support:end_per_suite</b>(Config).
<a name="58"/>   58: 
<a name="init_per_testcase-2"/><a name="59"/>   59: <b>init_per_testcase</b>(TestCase, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="60"/>   60: <b>    ct_test_support:init_per_testcase</b>(TestCase, Config).
<a name="61"/>   61: 
<a name="end_per_testcase-2"/><a name="62"/>   62: <b>end_per_testcase</b>(TestCase, Config) -&gt;
<a name="63"/>   63:     try apply(?MODULE,TestCase,[cleanup,Config])
<a name="64"/>   64:     catch error:undef -&gt; ok
<a name="65"/>   65:     end,
<a name="end_per_testcase-last_expr"/><a name="66"/>   66: <b>    ct_test_support:end_per_testcase</b>(TestCase, Config).
<a name="67"/>   67: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="68"/>   68: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="69"/>   69: 
<a name="all-0"/><a name="70"/>   70: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="71"/>   71:     [
<a name="72"/>   72:      default,
<a name="73"/>   73:      cover_stop_true,
<a name="74"/>   74:      cover_stop_false,
<a name="75"/>   75:      slave,
<a name="76"/>   76:      slave_start_slave,
<a name="77"/>   77:      cover_node_option,
<a name="78"/>   78:      ct_cover_add_remove_nodes,
<a name="79"/>   79:      otp_9956,
<a name="80"/>   80:      cross,
<a name="81"/>   81:      export_import,
<a name="82"/>   82:      relative_incl_dirs,
<a name="83"/>   83:      absolute_incl_dirs,
<a name="84"/>   84:      relative_excl_dirs,
<a name="85"/>   85:      absolute_excl_dirs
<a name="86"/>   86:     ].
<a name="87"/>   87: 
<a name="88"/>   88: <i>%%--------------------------------------------------------------------</i>
<a name="89"/>   89: <i>%% TEST CASES</i>
<a name="90"/>   90: <i>%%--------------------------------------------------------------------</i>
<a name="91"/>   91: 
<a name="92"/>   92: <i>%% Check that cover is collected from test node</i>
<a name="93"/>   93: <i>%% Also check that cover is by default stopped after test is completed</i>
<a name="default-1"/><a name="94"/>   94: <b>default</b>(Config) -&gt;
<a name="95"/>   95:     {ok,Events} = run_test(default,Config),
<a name="96"/>   96:     false = check_cover(Config),
<a name="97"/>   97:     check_calls(Events,1),
<a name="default-last_expr"/><a name="98"/>   98:     ok.
<a name="99"/>   99: 
<a name="100"/>  100: <i>%% Check that cover is stopped when cover_stop option is set to true</i>
<a name="cover_stop_true-1"/><a name="101"/>  101: <b>cover_stop_true</b>(Config) -&gt;
<a name="102"/>  102:     {ok,_Events} = run_test(cover_stop_true,[{cover_stop,true}],Config),
<a name="cover_stop_true-last_expr"/><a name="103"/>  103: <b>    false = check_cover</b>(Config).
<a name="104"/>  104: 
<a name="105"/>  105: <i>%% Check that cover is not stopped when cover_stop option is set to false</i>
<a name="cover_stop_false-1"/><a name="106"/>  106: <b>cover_stop_false</b>(Config) -&gt;
<a name="107"/>  107:     {ok,_Events} = run_test(cover_stop_false,[{cover_stop,false}],Config),
<a name="108"/>  108:     {true,[],[?mod]} = check_cover(Config),
<a name="109"/>  109:     CTNode = proplists:get_value(ct_node, Config),
<a name="110"/>  110:     ok = rpc:call(CTNode,cover,stop,[]),
<a name="111"/>  111:     false = check_cover(Config),
<a name="cover_stop_false-last_expr"/><a name="112"/>  112:     ok.
<a name="113"/>  113: 
<a name="114"/>  114: <i>%% Let test node start a slave node - check that cover is collected</i>
<a name="115"/>  115: <i>%% from both nodes</i>
<a name="slave-1"/><a name="116"/>  116: <b>slave</b>(Config) -&gt;
<a name="117"/>  117:     {ok,Events} = run_test(slave,slave,[],Config),
<a name="118"/>  118:     check_calls(Events,2),
<a name="slave-last_expr"/><a name="119"/>  119:     ok.
<a name="120"/>  120: 
<a name="121"/>  121: <i>%% Let test node start a slave node which in turn starts another slave</i>
<a name="122"/>  122: <i>%% node - check that cover is collected from all three nodes</i>
<a name="slave_start_slave-1"/><a name="123"/>  123: <b>slave_start_slave</b>(Config) -&gt;
<a name="124"/>  124:     {ok,Events} = run_test(slave_start_slave,slave_start_slave,[],Config),
<a name="125"/>  125:     check_calls(Events,3),
<a name="slave_start_slave-last_expr"/><a name="126"/>  126:     ok.
<a name="127"/>  127: 
<a name="128"/>  128: <i>%% Start a slave node before test starts - the node is listed in cover</i>
<a name="129"/>  129: <i>%% spec file.</i>
<a name="130"/>  130: <i>%% Check that cover is collected from test node and slave node.</i>
<a name="cover_node_option-1"/><a name="131"/>  131: <b>cover_node_option</b>(Config) -&gt;
<a name="132"/>  132:     DataDir = ?config(data_dir,Config),
<a name="133"/>  133:     {ok,Node} = start_slave(existing_node_1, &quot;-pa &quot; ++ DataDir),
<a name="134"/>  134:     false = check_cover(Node),
<a name="135"/>  135:     CoverSpec = default_cover_file_content() ++ [{nodes,[Node]}],
<a name="136"/>  136:     CoverFile = create_cover_file(cover_node_option,CoverSpec,Config),
<a name="137"/>  137:     {ok,Events} = run_test(cover_node_option,cover_node_option,
<a name="138"/>  138: 			   [{cover,CoverFile}],Config),
<a name="139"/>  139:     check_calls(Events,2),
<a name="140"/>  140:     {ok,Node} = ct_slave:stop(existing_node_1),
<a name="cover_node_option-last_expr"/><a name="141"/>  141:     ok.
<a name="142"/>  142: 
<a name="cover_node_option-2"/><a name="143"/>  143: <b>cover_node_option</b>(cleanup,_Config) -&gt;
<a name="144"/>  144:     _ = ct_slave:stop(existing_node_1),
<a name="cover_node_option-last_expr"/><a name="145"/>  145:     ok.
<a name="146"/>  146: 
<a name="147"/>  147: <i>%% Test ct_cover:add_nodes/1 and ct_cover:remove_nodes/1</i>
<a name="148"/>  148: <i>%% Check that cover is collected from added node</i>
<a name="ct_cover_add_remove_nodes-1"/><a name="149"/>  149: <b>ct_cover_add_remove_nodes</b>(Config) -&gt;
<a name="150"/>  150:     DataDir = ?config(data_dir,Config),
<a name="151"/>  151:     {ok,Node} = start_slave(existing_node_2, &quot;-pa &quot; ++ DataDir),
<a name="152"/>  152:     false = check_cover(Node),
<a name="153"/>  153:     {ok,Events} = run_test(ct_cover_add_remove_nodes,ct_cover_add_remove_nodes,
<a name="154"/>  154: 			   [],Config),
<a name="155"/>  155:     check_calls(Events,2),
<a name="156"/>  156:     {ok,Node} = ct_slave:stop(existing_node_2),
<a name="ct_cover_add_remove_nodes-last_expr"/><a name="157"/>  157:     ok.
<a name="158"/>  158: 
<a name="ct_cover_add_remove_nodes-2"/><a name="159"/>  159: <b>ct_cover_add_remove_nodes</b>(cleanup,_Config) -&gt;
<a name="160"/>  160:     _ = ct_slave:stop(existing_node_2),
<a name="ct_cover_add_remove_nodes-last_expr"/><a name="161"/>  161:     ok.
<a name="162"/>  162: 
<a name="163"/>  163: <i>%% Test that the test suite itself can be cover compiled and that</i>
<a name="164"/>  164: <i>%% data_dir is set correctly (OTP-9956)</i>
<a name="otp_9956-1"/><a name="165"/>  165: <b>otp_9956</b>(Config) -&gt;
<a name="166"/>  166:     CoverFile = create_cover_file(otp_9956,[{incl_mods,[?suite]}],Config),
<a name="167"/>  167:     {ok,Events} = run_test(otp_9956,otp_9956,[{cover,CoverFile}],Config),
<a name="168"/>  168:     check_calls(Events,{?suite,otp_9956,1},1),
<a name="otp_9956-last_expr"/><a name="169"/>  169:     ok.
<a name="170"/>  170: 
<a name="171"/>  171: <i>%% Test cross cover mechanism</i>
<a name="cross-1"/><a name="172"/>  172: <b>cross</b>(Config) -&gt;
<a name="173"/>  173:     {ok,Events1} = run_test(cross1,Config),
<a name="174"/>  174:     check_calls(Events1,1),
<a name="175"/>  175: 
<a name="176"/>  176:     CoverFile2 = create_cover_file(cross1,[{cross,[{cross1,[?mod]}]}],Config),
<a name="177"/>  177:     {ok,Events2} = run_test(cross2,[{cover,CoverFile2}],Config),
<a name="178"/>  178:     check_calls(Events2,1),
<a name="179"/>  179: 
<a name="180"/>  180:     %% Get the log dirs for each test and run cross cover analyse
<a name="181"/>  181:     [D11,D12] = lists:sort(get_log_dirs(Events1)),
<a name="182"/>  182:     [D21,D22] = lists:sort(get_log_dirs(Events2)),
<a name="183"/>  183: 
<a name="184"/>  184:     ct_cover:cross_cover_analyse(details,[{cross1,D11},{cross2,D21}]),
<a name="185"/>  185:     ct_cover:cross_cover_analyse(details,[{cross1,D12},{cross2,D22}]),
<a name="186"/>  186: 
<a name="187"/>  187:     %% Get the cross cover logs and read for each test
<a name="188"/>  188:     [C11,C12,C21,C22] =
<a name="189"/>  189: 	[filename:join(D,&quot;cross_cover.html&quot;) || D &lt;- [D11,D12,D21,D22]],
<a name="190"/>  190: 
<a name="191"/>  191:     {ok,CrossData} = file:read_file(C11),
<a name="192"/>  192:     {ok,CrossData} = file:read_file(C12),
<a name="193"/>  193: 
<a name="194"/>  194:     {ok,Def} = file:read_file(C21),
<a name="195"/>  195:     {ok,Def} = file:read_file(C22),
<a name="196"/>  196: 
<a name="197"/>  197:     %% A simple test: just check that the test module exists in the
<a name="198"/>  198:     %% log from cross1 test, and that it does not exist in the log
<a name="199"/>  199:     %% from cross2 test.
<a name="200"/>  200:     TestMod = list_to_binary(atom_to_list(?mod)),
<a name="201"/>  201:     {_,_} = binary:match(CrossData,TestMod),
<a name="202"/>  202:     nomatch = binary:match(Def,TestMod),
<a name="203"/>  203:     {_,_} = binary:match(Def,
<a name="204"/>  204: 			 &lt;&lt;&quot;No cross cover modules exist for this application&quot;&gt;&gt;),
<a name="205"/>  205: 
<a name="cross-last_expr"/><a name="206"/>  206:     ok.
<a name="207"/>  207: 
<a name="export_import-1"/><a name="208"/>  208: <b>export_import</b>(Config) -&gt;
<a name="209"/>  209:     DataDir = ?config(data_dir,Config),
<a name="210"/>  210:     false = check_cover(Config),
<a name="211"/>  211:     CoverSpec1 =
<a name="212"/>  212: 	default_cover_file_content() ++ [{export,&quot;export_import.coverdata&quot;}],
<a name="213"/>  213:     CoverFile1 = create_cover_file(export_import1,CoverSpec1,Config),
<a name="214"/>  214:     {ok,Events1} = run_test(export_import1,default,[{cover,CoverFile1}],Config),
<a name="215"/>  215:     check_calls(Events1,1),
<a name="216"/>  216:     CoverSpec2 =
<a name="217"/>  217: 	default_cover_file_content() ++ [{import,&quot;export_import.coverdata&quot;}],
<a name="218"/>  218:     CoverFile2 = create_cover_file(export_import2,CoverSpec2,Config),
<a name="219"/>  219:     {ok,Events2} = run_test(export_import2,default,[{cover,CoverFile2}],Config),
<a name="220"/>  220:     check_calls(Events2,2),
<a name="export_import-last_expr"/><a name="221"/>  221:     ok.
<a name="222"/>  222: 
<a name="relative_incl_dirs-1"/><a name="223"/>  223: <b>relative_incl_dirs</b>(Config) -&gt;
<a name="224"/>  224:     false = check_cover(Config),
<a name="225"/>  225:     RelDir = rel_path(?config(priv_dir, Config), ?config(data_dir, Config)),
<a name="226"/>  226:     CoverSpec = [{incl_dirs, [RelDir]}],
<a name="227"/>  227:     CoverFile = create_cover_file(rel_incl_dirs, CoverSpec, Config),
<a name="228"/>  228:     Opts = [{cover, CoverFile}],
<a name="229"/>  229:     {ok, Events} = run_test(rel_incl_dirs, default, Opts, Config),
<a name="230"/>  230:     check_calls(Events, 1),
<a name="relative_incl_dirs-last_expr"/><a name="231"/>  231:     ok.
<a name="232"/>  232: 
<a name="absolute_incl_dirs-1"/><a name="233"/>  233: <b>absolute_incl_dirs</b>(Config) -&gt;
<a name="234"/>  234:     false = check_cover(Config),
<a name="235"/>  235:     CoverSpec = [{incl_dirs, [?config(data_dir, Config)]}],
<a name="236"/>  236:     CoverFile = create_cover_file(abs_incl_dirs, CoverSpec, Config),
<a name="237"/>  237:     Opts = [{cover, CoverFile}],
<a name="238"/>  238:     {ok, Events} = run_test(abs_incl_dirs, default, Opts, Config),
<a name="239"/>  239:     check_calls(Events, 1),
<a name="absolute_incl_dirs-last_expr"/><a name="240"/>  240:     ok.
<a name="241"/>  241: 
<a name="relative_excl_dirs-1"/><a name="242"/>  242: <b>relative_excl_dirs</b>(Config) -&gt;
<a name="243"/>  243:     false = check_cover(Config),
<a name="244"/>  244:     RelDir = rel_path(?config(priv_dir, Config), ?config(data_dir, Config)),
<a name="245"/>  245:     CoverSpec = default_cover_file_content() ++ [{excl_dirs, [RelDir]}],
<a name="246"/>  246:     CoverFile = create_cover_file(rel_excl_dirs, CoverSpec, Config),
<a name="247"/>  247:     Opts = [{cover, CoverFile}],
<a name="248"/>  248:     {ok, Events} = run_test(rel_excl_dirs, default_no_cover, Opts, Config),
<a name="249"/>  249:     check_no_cover_compiled(Events),
<a name="relative_excl_dirs-last_expr"/><a name="250"/>  250:     ok.
<a name="251"/>  251: 
<a name="absolute_excl_dirs-1"/><a name="252"/>  252: <b>absolute_excl_dirs</b>(Config) -&gt;
<a name="253"/>  253:     false = check_cover(Config),
<a name="254"/>  254:     AbsDir = ?config(data_dir, Config),
<a name="255"/>  255:     CoverSpec = default_cover_file_content() ++ [{excl_dirs, [AbsDir]}],
<a name="256"/>  256:     CoverFile = create_cover_file(abs_excl_dirs, CoverSpec, Config),
<a name="257"/>  257:     Opts = [{cover, CoverFile}],
<a name="258"/>  258:     {ok, Events} = run_test(abs_excl_dirs, default_no_cover, Opts, Config),
<a name="259"/>  259:     check_no_cover_compiled(Events),
<a name="absolute_excl_dirs-last_expr"/><a name="260"/>  260:     ok.
<a name="261"/>  261: 
<a name="262"/>  262: <i>%%%-----------------------------------------------------------------</i>
<a name="263"/>  263: <i>%%% HELP FUNCTIONS</i>
<a name="264"/>  264: <i>%%%-----------------------------------------------------------------</i>
<a name="run_test-2"/><a name="265"/>  265: <b>run_test</b>(Label,Config) -&gt;
<a name="run_test-last_expr"/><a name="266"/>  266: <b>    run_test</b>(Label,[],Config).
<a name="run_test-3"/><a name="267"/>  267: <b>run_test</b>(Label,ExtraOpts,Config) -&gt;
<a name="run_test-last_expr"/><a name="268"/>  268: <b>    run_test</b>(Label,default,ExtraOpts,Config).
<a name="run_test-4"/><a name="269"/>  269: <b>run_test</b>(Label,Testcase,ExtraOpts,Config) -&gt;
<a name="270"/>  270:     DataDir = ?config(data_dir, Config),
<a name="271"/>  271:     Suite = filename:join(DataDir, ?suite),
<a name="272"/>  272:     CoverFile =
<a name="273"/>  273: 	case proplists:get_value(cover,ExtraOpts) of
<a name="274"/>  274: 	    undefined -&gt;
<a name="275"/>  275: 		create_default_cover_file(Label,Config);
<a name="276"/>  276: 	    CF -&gt;
<a name="277"/>  277: 		CF
<a name="278"/>  278: 	end,
<a name="279"/>  279:     RestOpts = lists:keydelete(cover,1,ExtraOpts),
<a name="280"/>  280:     {Opts,ERPid} = setup([{suite,Suite},{testcase,Testcase},
<a name="281"/>  281: 			  {cover,CoverFile},{label,Label}] ++ RestOpts, Config),
<a name="run_test-last_expr"/><a name="282"/>  282: <b>    execute</b>(Label, Testcase, Opts, ERPid, Config).
<a name="283"/>  283: 
<a name="setup-2"/><a name="284"/>  284: <b>setup</b>(Test, Config) -&gt;
<a name="285"/>  285:     Opts0 = ct_test_support:get_opts(Config),
<a name="286"/>  286:     Level = ?config(trace_level, Config),
<a name="287"/>  287:     EvHArgs = [{cbm,ct_test_support},{trace_level,Level}],
<a name="288"/>  288:     Opts = Opts0 ++ [{event_handler,{?eh,EvHArgs}}|Test],
<a name="289"/>  289:     ERPid = ct_test_support:start_event_receiver(Config),
<a name="setup-last_expr"/><a name="290"/>  290:     {Opts,ERPid}.
<a name="291"/>  291: 
<a name="execute-5"/><a name="292"/>  292: <b>execute</b>(Name, Testcase, Opts, ERPid, Config) -&gt;
<a name="293"/>  293:     ok = ct_test_support:run(Opts, Config),
<a name="294"/>  294:     Events = ct_test_support:get_events(ERPid, Config),
<a name="295"/>  295: 
<a name="296"/>  296:     ct_test_support:log_events(Name,
<a name="297"/>  297: 			       reformat(Events, ?eh),
<a name="298"/>  298: 			       ?config(priv_dir, Config),
<a name="299"/>  299: 			       Opts),
<a name="300"/>  300:     TestEvents = events_to_check(Testcase),
<a name="301"/>  301:     R = ct_test_support:verify_events(TestEvents, Events, Config),
<a name="execute-last_expr"/><a name="302"/>  302:    {R,Events}.
<a name="303"/>  303: 
<a name="reformat-2"/><a name="304"/>  304: <b>reformat</b>(Events, EH) -&gt;
<a name="reformat-last_expr"/><a name="305"/>  305: <b>    ct_test_support:reformat</b>(Events, EH).
<a name="306"/>  306: 
<a name="events_to_check-1"/><a name="307"/>  307: <b>events_to_check</b>(Testcase) -&gt;
<a name="308"/>  308:     OneTest =
<a name="309"/>  309: 	[{?eh,start_logging,{'DEF','RUNDIR'}}] ++
<a name="310"/>  310: 	[{?eh,tc_done,{?suite,Testcase,ok}}] ++
<a name="311"/>  311: 	[{?eh,stop_logging,[]}],
<a name="312"/>  312: 
<a name="313"/>  313:     %% 2 tests (ct:run_test + script_start) is default
<a name="events_to_check-last_expr"/><a name="314"/>  314:     OneTest ++ OneTest.
<a name="315"/>  315: 
<a name="check_cover-1"/><a name="316"/>  316: <b>check_cover</b>(Config) when is_list(Config) -&gt;
<a name="317"/>  317:     CTNode = proplists:get_value(ct_node, Config),
<a name="318"/>  318:     check_cover(CTNode);
<a name="319"/>  319: <b>check_cover</b>(Node) when is_atom(Node) -&gt;
<a name="check_cover-last_expr"/><a name="320"/>  320: <b>    case rpc:call</b>(Node,test_server,is_cover,[]) of
<a name="321"/>  321: 	true -&gt;
<a name="322"/>  322: 	    {true,
<a name="323"/>  323: 	     rpc:call(Node,cover,which_nodes,[]),
<a name="324"/>  324: 	     rpc:call(Node,cover,modules,[])};
<a name="325"/>  325: 	false -&gt;
<a name="326"/>  326: 	    false
<a name="327"/>  327:     end.
<a name="328"/>  328: 
<a name="329"/>  329: <i>%% Get the log dir &quot;ct_run.&lt;timestamp&gt;&quot; for all (both!) tests</i>
<a name="get_log_dirs-1"/><a name="330"/>  330: <b>get_log_dirs</b>(Events) -&gt;
<a name="get_log_dirs-last_expr"/><a name="331"/>  331:     [LogDir ||
<a name="332"/>  332: 	{ct_test_support_eh,
<a name="333"/>  333: 	 {event,start_logging,_Node,LogDir}} &lt;- Events].
<a name="334"/>  334: 
<a name="335"/>  335: <i>%% Check if a module was compiled without cover</i>
<a name="check_no_cover_compiled-1"/><a name="336"/>  336: <b>check_no_cover_compiled</b>(Events) -&gt;
<a name="check_no_cover_compiled-last_expr"/><a name="337"/>  337: <b>    check_no_cover_compiled</b>(Events, ?mod).
<a name="check_no_cover_compiled-2"/><a name="338"/>  338: <b>check_no_cover_compiled</b>(Events, Mod) -&gt;
<a name="check_no_cover_compiled-last_expr"/><a name="339"/>  339: <b>    [ {error, {not_cover_compiled, Mod}} = analyse_log</b>(CoverLog, Mod)
<a name="340"/>  340:       || CoverLog &lt;- cover_logs(Events) ].
<a name="341"/>  341: 
<a name="342"/>  342: <i>%% Check that each coverlog includes N calls to ?mod:foo/0</i>
<a name="check_calls-2"/><a name="343"/>  343: <b>check_calls</b>(Events,N) -&gt;
<a name="check_calls-last_expr"/><a name="344"/>  344: <b>    check_calls</b>(Events,{?mod,foo,0},N).
<a name="check_calls-3"/><a name="345"/>  345: <b>check_calls</b>(Events,MFA,N) -&gt;
<a name="check_calls-last_expr"/><a name="346"/>  346: <b>    do_check_logs</b>(cover_logs(Events),MFA,N).
<a name="347"/>  347: 
<a name="do_check_logs-3"/><a name="348"/>  348: <b>do_check_logs</b>([CoverLog|CoverLogs],{Mod,_,_} = MFA,N) -&gt;
<a name="349"/>  349:     {ok, Calls} = analyse_log(CoverLog, Mod),
<a name="350"/>  350:     {MFA,N} = lists:keyfind(MFA,1,Calls),
<a name="351"/>  351:     do_check_logs(CoverLogs,MFA,N);
<a name="352"/>  352: <b>do_check_logs</b>([],_,_) -&gt;
<a name="do_check_logs-last_expr"/><a name="353"/>  353:     ok.
<a name="354"/>  354: 
<a name="cover_logs-1"/><a name="355"/>  355: <b>cover_logs</b>(Events) -&gt;
<a name="cover_logs-last_expr"/><a name="356"/>  356: <b>    [filename:join</b>(D,&quot;all.coverdata&quot;) || D &lt;- get_log_dirs(Events)].
<a name="357"/>  357: 
<a name="analyse_log-2"/><a name="358"/>  358: <b>analyse_log</b>(CoverLog, Mod) -&gt;
<a name="359"/>  359:     {ok, _} = cover:start(),
<a name="360"/>  360:     ok = cover:import(CoverLog),
<a name="361"/>  361:     Result = cover:analyse(Mod, calls, function),
<a name="362"/>  362:     ok = cover:stop(),
<a name="analyse_log-last_expr"/><a name="363"/>  363:     Result.
<a name="364"/>  364: 
<a name="fullname-1"/><a name="365"/>  365: <b>fullname</b>(Name) -&gt;
<a name="366"/>  366:     {ok,Host} = inet:gethostname(),
<a name="fullname-last_expr"/><a name="367"/>  367: <b>    list_to_atom</b>(atom_to_list(Name) ++ &quot;@&quot; ++ Host).
<a name="368"/>  368: 
<a name="default_cover_file_content-0"/><a name="369"/>  369: <b>default_cover_file_content</b>() -&gt;
<a name="default_cover_file_content-last_expr"/><a name="370"/>  370:     [{incl_mods,[?mod]}].
<a name="371"/>  371: 
<a name="create_default_cover_file-2"/><a name="372"/>  372: <b>create_default_cover_file</b>(Filename,Config) -&gt;
<a name="create_default_cover_file-last_expr"/><a name="373"/>  373: <b>    create_cover_file</b>(Filename,default_cover_file_content(),Config).
<a name="374"/>  374: 
<a name="create_cover_file-3"/><a name="375"/>  375: <b>create_cover_file</b>(Filename,Terms,Config) -&gt;
<a name="376"/>  376:     PrivDir = ?config(priv_dir,Config),
<a name="377"/>  377:     File = filename:join(PrivDir,Filename) ++ &quot;.cover&quot;,
<a name="378"/>  378:     {ok,Fd} = file:open(File,[write]),
<a name="379"/>  379:     lists:foreach(fun(Term) -&gt;
<a name="380"/>  380: 			  file:write(Fd,io_lib:format(&quot;~p.~n&quot;,[Term]))
<a name="381"/>  381: 		  end,Terms),
<a name="382"/>  382:     ok = file:close(Fd),
<a name="create_cover_file-last_expr"/><a name="383"/>  383:     File.
<a name="384"/>  384: 
<a name="start_slave-2"/><a name="385"/>  385: <b>start_slave</b>(Name,Args) -&gt;
<a name="386"/>  386:     {ok, HostStr}=inet:gethostname(),
<a name="387"/>  387:     Host = list_to_atom(HostStr),
<a name="start_slave-last_expr"/><a name="388"/>  388: <b>    ct_slave:start</b>(Host,Name,
<a name="389"/>  389: 		   [{erl_flags,Args},
<a name="390"/>  390: 		    {boot_timeout,10}, % extending some timers for slow test hosts
<a name="391"/>  391: 		    {init_timeout,10},
<a name="392"/>  392: 		    {startup_timeout,10}]).
<a name="393"/>  393: 
<a name="rel_path-2"/><a name="394"/>  394: <b>rel_path</b>(From, To) -&gt;
<a name="395"/>  395:     Segments = do_rel_path(filename:split(From), filename:split(To)),
<a name="rel_path-last_expr"/><a name="396"/>  396: <b>    filename:join</b>(Segments).
<a name="397"/>  397: 
<a name="do_rel_path-2"/><a name="398"/>  398: <b>do_rel_path</b>([Seg|RestA], [Seg|RestB]) -&gt;
<a name="399"/>  399:     do_rel_path(RestA, RestB);
<a name="400"/>  400: <b>do_rel_path</b>(PathA, PathB) -&gt;
<a name="do_rel_path-last_expr"/><a name="401"/>  401: <b>    lists:duplicate</b>(length(PathA), &quot;..&quot;) ++ PathB.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
