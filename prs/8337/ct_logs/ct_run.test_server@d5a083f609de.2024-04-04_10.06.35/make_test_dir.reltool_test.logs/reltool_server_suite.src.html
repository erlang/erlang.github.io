<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/reltool/make_test_dir/reltool_test/reltool_server_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2009-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: 
<a name="20"/>   20: <b>-module</b>(reltool_server_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <b>-compile</b>([export_all, nowarn_export_all]).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-include_lib</b>(&quot;reltool/src/reltool.hrl&quot;).
<a name="25"/>   25: <b>-include</b>(&quot;reltool_test_lib.hrl&quot;).
<a name="26"/>   26: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="27"/>   27: <b>-include_lib</b>(&quot;kernel/include/file.hrl&quot;).
<a name="28"/>   28: 
<a name="29"/>   29: <b>-define</b>(NODE_NAME, '__RELTOOL__TEMPORARY_TEST__NODE__').
<a name="30"/>   30: <b>-define</b>(WORK_DIR, &quot;reltool_work_dir&quot;).
<a name="31"/>   31: 
<a name="32"/>   32: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33"/>   33: <i>%% Initialization functions.</i>
<a name="34"/>   34: 
<a name="init_per_suite-1"/><a name="35"/>   35: <b>init_per_suite</b>(Config) -&gt;
<a name="36"/>   36:     {ok,Cwd} = file:get_cwd(),
<a name="37"/>   37:     ?ignore(file:make_dir(?WORK_DIR)),
<a name="init_per_suite-last_expr"/><a name="38"/>   38: <b>    [{cwd,Cwd}|reltool_test_lib:init_per_suite</b>(Config)].
<a name="39"/>   39: 
<a name="end_per_suite-1"/><a name="40"/>   40: <b>end_per_suite</b>(Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="41"/>   41: <b>    reltool_test_lib:end_per_suite</b>(Config).
<a name="42"/>   42: 
<a name="init_per_testcase-2"/><a name="43"/>   43: <b>init_per_testcase</b>(Func,Config) -&gt;
<a name="44"/>   44:     Node = full_node_name(?NODE_NAME),
<a name="45"/>   45:     case net_adm:ping(Node) of
<a name="46"/>   46: 	pong -&gt; stop_node(Node);
<a name="47"/>   47: 	pang -&gt; ok
<a name="48"/>   48:     end,
<a name="init_per_testcase-last_expr"/><a name="49"/>   49: <b>    reltool_test_lib:init_per_testcase</b>(Func,Config).
<a name="end_per_testcase-2"/><a name="50"/>   50: <b>end_per_testcase</b>(Func,Config) -&gt;
<a name="51"/>   51:     ok = file:set_cwd(filename:join(?config(cwd,Config),?WORK_DIR)),
<a name="52"/>   52:     {ok,All}  = file:list_dir(&quot;.&quot;),
<a name="53"/>   53:     Files = [F || F &lt;- All, false == lists:prefix(&quot;save.&quot;,F)],
<a name="54"/>   54:     case ?config(tc_status,Config) of
<a name="55"/>   55: 	ok -&gt;
<a name="56"/>   56: 	    ok;
<a name="57"/>   57: 	_Fail -&gt;
<a name="58"/>   58: 	    SaveDir = &quot;save.&quot;++atom_to_list(Func),
<a name="59"/>   59: 	    ok = file:make_dir(SaveDir),
<a name="60"/>   60: 	    save_test_result(Files,SaveDir)
<a name="61"/>   61:     end,
<a name="62"/>   62:     rm_files(Files),
<a name="63"/>   63:     ok = file:set_cwd(?config(cwd,Config)),
<a name="end_per_testcase-last_expr"/><a name="64"/>   64: <b>    reltool_test_lib:end_per_testcase</b>(Func,Config).
<a name="65"/>   65: 
<a name="66"/>   66: 
<a name="save_test_result-2"/><a name="67"/>   67: <b>save_test_result</b>(Files,DestDir) -&gt;
<a name="68"/>   68:     Tar = &quot;copy.tar&quot;,
<a name="69"/>   69:     ok = erl_tar:create(Tar, Files),
<a name="70"/>   70:     ok = erl_tar:extract(Tar, [{cwd,DestDir}]),
<a name="71"/>   71:     ok = file:delete(Tar),
<a name="save_test_result-last_expr"/><a name="72"/>   72:     ok.
<a name="73"/>   73: 
<a name="rm_files-1"/><a name="74"/>   74: <b>rm_files</b>([F | Fs]) -&gt;
<a name="75"/>   75:     case file:read_file_info(F) of
<a name="76"/>   76: 	{ok,#file_info{type=directory}} -&gt;
<a name="77"/>   77: 	    rm_dir(F);
<a name="78"/>   78: 	{ok,_Regular} -&gt;
<a name="79"/>   79: 	    ok = file:delete(F)
<a name="80"/>   80:     end,
<a name="81"/>   81:     rm_files(Fs);
<a name="82"/>   82: <b>rm_files</b>([]) -&gt;
<a name="rm_files-last_expr"/><a name="83"/>   83:     ok.
<a name="84"/>   84: 
<a name="rm_dir-1"/><a name="85"/>   85: <b>rm_dir</b>(Dir) -&gt;
<a name="86"/>   86:     {ok,Files} = file:list_dir(Dir),
<a name="87"/>   87:     rm_files([filename:join(Dir, F) || F &lt;- Files]),
<a name="rm_dir-last_expr"/><a name="88"/>   88: <b>    ok = file:del_dir</b>(Dir).
<a name="89"/>   89: 
<a name="90"/>   90: 
<a name="91"/>   91: 
<a name="92"/>   92: 
<a name="93"/>   93: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="94"/>   94: <i>%% SUITE specification</i>
<a name="95"/>   95: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="96"/>   96: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="97"/>   97: 
<a name="all-0"/><a name="98"/>   98: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="99"/>   99:     [start_server,
<a name="100"/>  100:      set_config,
<a name="101"/>  101:      get_config,
<a name="102"/>  102:      create_release,
<a name="103"/>  103:      create_release_sort,
<a name="104"/>  104:      create_script,
<a name="105"/>  105:      create_script_without_dot_erlang,
<a name="106"/>  106:      create_script_sort,
<a name="107"/>  107:      create_target,
<a name="108"/>  108:      create_target_unicode,
<a name="109"/>  109:      create_embedded,
<a name="110"/>  110:      create_standalone,
<a name="111"/>  111:      create_standalone_beam,
<a name="112"/>  112:      create_standalone_app,
<a name="113"/>  113:      create_standalone_app_clash,
<a name="114"/>  114:      create_multiple_standalone,
<a name="115"/>  115:      create_old_target,
<a name="116"/>  116:      create_slim,
<a name="117"/>  117:      eval_target_spec,
<a name="118"/>  118:      otp_9135,
<a name="119"/>  119:      otp_9229_dupl_mod_exclude_app,
<a name="120"/>  120:      otp_9229_dupl_mod_exclude_mod,
<a name="121"/>  121:      dupl_mod_in_app_file,
<a name="122"/>  122:      include_non_existing_app,
<a name="123"/>  123:      exclude_non_existing_app,
<a name="124"/>  124:      get_apps,
<a name="125"/>  125:      get_mod,
<a name="126"/>  126:      get_sys,
<a name="127"/>  127:      set_app_and_undo,
<a name="128"/>  128:      set_apps_and_undo,
<a name="129"/>  129:      set_apps_inlined,
<a name="130"/>  130:      set_sys_and_undo,
<a name="131"/>  131:      load_config_and_undo,
<a name="132"/>  132:      load_config_fail,
<a name="133"/>  133:      load_config_escript_path,
<a name="134"/>  134:      load_config_same_escript_source,
<a name="135"/>  135:      load_config_same_escript_beam,
<a name="136"/>  136:      load_config_add_escript,
<a name="137"/>  137:      reset_config_and_undo,
<a name="138"/>  138:      gen_rel_files,
<a name="139"/>  139:      save_config,
<a name="140"/>  140:      dependencies,
<a name="141"/>  141:      mod_incl_cond_derived,
<a name="142"/>  142:      dep_in_app_not_xref,
<a name="143"/>  143:      use_selected_vsn,
<a name="144"/>  144:      use_selected_vsn_relative_path,
<a name="145"/>  145:      non_standard_vsn_id,
<a name="146"/>  146:      undefined_regexp,
<a name="147"/>  147:      windows_erl_libs].
<a name="148"/>  148: 
<a name="groups-0"/><a name="149"/>  149: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="150"/>  150:     [].
<a name="151"/>  151: 
<a name="init_per_group-2"/><a name="152"/>  152: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="153"/>  153:     Config.
<a name="154"/>  154: 
<a name="end_per_group-2"/><a name="155"/>  155: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="156"/>  156:     Config.
<a name="157"/>  157: 
<a name="158"/>  158: 
<a name="159"/>  159: <i>%% The test cases</i>
<a name="160"/>  160: 
<a name="161"/>  161: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="162"/>  162: <i>%% A dummy break test case which is NOT in all(), but can be run</i>
<a name="163"/>  163: <i>%% directly from the command line with ct_run. It just does a</i>
<a name="164"/>  164: <i>%% test_server:break()...</i>
<a name="break-1"/><a name="165"/>  165: <b>break</b>(_Config) -&gt;
<a name="166"/>  166:     test_server:break(&quot;&quot;),
<a name="break-last_expr"/><a name="167"/>  167:     ok.
<a name="168"/>  168: 
<a name="169"/>  169: 
<a name="170"/>  170: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="171"/>  171: <i>%% Start a server process and check that it does not crash</i>
<a name="172"/>  172: 
<a name="start_server-1"/><a name="173"/>  173: <b>start_server</b>(_Config) -&gt;
<a name="174"/>  174:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([])),
<a name="175"/>  175:     Libs = reltool_test_lib:erl_libs(),
<a name="176"/>  176:     StrippedDefault =
<a name="177"/>  177:         case Libs of
<a name="178"/>  178:             [] -&gt; {sys, []};
<a name="179"/>  179:             _  -&gt; {sys, [{lib_dirs, Libs}]}
<a name="180"/>  180:         end,
<a name="181"/>  181:     ?m({ok, StrippedDefault}, reltool:get_config(Pid)),
<a name="182"/>  182:     ?m(ok, reltool:stop(Pid)),
<a name="start_server-last_expr"/><a name="183"/>  183:     ok.
<a name="184"/>  184: 
<a name="185"/>  185: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="186"/>  186: <i>%% Start a server process and check that it does not crash</i>
<a name="187"/>  187: 
<a name="set_config-1"/><a name="188"/>  188: <b>set_config</b>(_Config) -&gt;
<a name="189"/>  189:     Libs = reltool_test_lib:erl_libs(),
<a name="190"/>  190:     Default =
<a name="191"/>  191:         {sys,
<a name="192"/>  192:          [
<a name="193"/>  193:           {mod_cond, all},
<a name="194"/>  194:           {incl_cond, derived},
<a name="195"/>  195:           {root_dir, code:root_dir()},
<a name="196"/>  196:           {lib_dirs, Libs}
<a name="197"/>  197:          ]},
<a name="198"/>  198:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Default}])),
<a name="199"/>  199:     StrippedDefault =
<a name="200"/>  200:         case Libs of
<a name="201"/>  201:             [] -&gt; {sys, []};
<a name="202"/>  202:             _  -&gt; {sys, [{lib_dirs, Libs}]}
<a name="203"/>  203:         end,
<a name="204"/>  204:     ?m({ok, StrippedDefault}, reltool:get_config(Pid)),
<a name="205"/>  205: 
<a name="206"/>  206:     ?m(ok, reltool:stop(Pid)),
<a name="set_config-last_expr"/><a name="207"/>  207:     ok.
<a name="208"/>  208: 
<a name="209"/>  209: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="210"/>  210: <i>%% Check that get_config returns the expected derivates and defaults</i>
<a name="211"/>  211: <i>%% as specified</i>
<a name="get_config-1"/><a name="212"/>  212: <b>get_config</b>(_Config) -&gt;
<a name="213"/>  213: 
<a name="214"/>  214:     KVsn = latest(kernel),
<a name="215"/>  215:     StdVsn = latest(stdlib),
<a name="216"/>  216:     SaslVsn = latest(sasl),
<a name="217"/>  217: 
<a name="218"/>  218:     LibDir = code:lib_dir(),
<a name="219"/>  219:     KLibDir = filename:join(LibDir,&quot;kernel-&quot;++KVsn),
<a name="220"/>  220:     StdLibDir = filename:join(LibDir,&quot;stdlib-&quot;++StdVsn),
<a name="221"/>  221:     SaslLibDir = filename:join(LibDir,&quot;sasl-&quot;++SaslVsn),
<a name="222"/>  222: 
<a name="223"/>  223:     Libs = reltool_test_lib:erl_libs(),
<a name="224"/>  224:     LibDirs =
<a name="225"/>  225:         case Libs of
<a name="226"/>  226:             [] -&gt; [];
<a name="227"/>  227:             _ -&gt; [{lib_dirs,Libs}]
<a name="228"/>  228:         end,
<a name="229"/>  229: 
<a name="230"/>  230:     Sys = {sys,LibDirs ++
<a name="231"/>  231:                [{incl_cond, exclude},
<a name="232"/>  232: 		{app,kernel,[{incl_cond,include}]},
<a name="233"/>  233: 		{app,sasl,[{incl_cond,include},{vsn,SaslVsn}]},
<a name="234"/>  234: 		{app,stdlib,[{incl_cond,include},{lib_dir,StdLibDir}]}]},
<a name="235"/>  235:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="236"/>  236:     ?m({ok, Sys}, reltool:get_config(Pid)),
<a name="237"/>  237:     ?m({ok, Sys}, reltool:get_config(Pid,false,false)),
<a name="238"/>  238: 
<a name="239"/>  239:     %% Include derived info
<a name="240"/>  240:     case Libs of
<a name="241"/>  241:         [] -&gt;
<a name="242"/>  242:             ?msym({ok,{sys,[{incl_cond, exclude},
<a name="243"/>  243:                             {erts,[]},
<a name="244"/>  244:                             {app,kernel,[{incl_cond,include},{mod,_,[]}|_]},
<a name="245"/>  245:                             {app,sasl,[{incl_cond,include},{vsn,SaslVsn},
<a name="246"/>  246:                                        {mod,_,[]}|_]},
<a name="247"/>  247:                             {app,stdlib,[{incl_cond,include},{lib_dir,StdLibDir},
<a name="248"/>  248:                                          {mod,_,[]}|_]}]}},
<a name="249"/>  249:                   reltool:get_config(Pid,false,true));
<a name="250"/>  250:         _ -&gt;
<a name="251"/>  251:             ?msym({ok,{sys,[{lib_dirs,Libs},
<a name="252"/>  252:                             {incl_cond, exclude},
<a name="253"/>  253:                             {erts,[]},
<a name="254"/>  254:                             {app,kernel,[{incl_cond,include},{mod,_,[]}|_]},
<a name="255"/>  255:                             {app,sasl,[{incl_cond,include},{vsn,SaslVsn},
<a name="256"/>  256:                                        {mod,_,[]}|_]},
<a name="257"/>  257:                             {app,stdlib,[{incl_cond,include},{lib_dir,StdLibDir},
<a name="258"/>  258:                                          {mod,_,[]}|_]}]}},
<a name="259"/>  259:                   reltool:get_config(Pid,false,true))
<a name="260"/>  260:     end,
<a name="261"/>  261: 
<a name="262"/>  262:     %% Include defaults
<a name="263"/>  263:     ?msym({ok,{sys,[{root_dir,_},
<a name="264"/>  264: 		    {lib_dirs,_},
<a name="265"/>  265: 		    {mod_cond,all},
<a name="266"/>  266: 		    {incl_cond,exclude},
<a name="267"/>  267: 		    {app,kernel,[{incl_cond,include},{vsn,undefined},
<a name="268"/>  268: 				 {lib_dir,undefined}]},
<a name="269"/>  269: 		    {app,sasl,[{incl_cond,include},{vsn,SaslVsn},
<a name="270"/>  270: 			       {lib_dir,undefined}]},
<a name="271"/>  271: 		    {app,stdlib,[{incl_cond,include},{vsn,undefined},
<a name="272"/>  272: 				 {lib_dir,StdLibDir}]},
<a name="273"/>  273: 		    {boot_rel,&quot;start_clean&quot;},
<a name="274"/>  274:                     {rel,&quot;no_dot_erlang&quot;,&quot;1.0&quot;,[],[{load_dot_erlang,false}]},
<a name="275"/>  275: 		    {rel,&quot;start_clean&quot;,&quot;1.0&quot;,[],[{load_dot_erlang,true}]},
<a name="276"/>  276: 		    {rel,&quot;start_sasl&quot;,&quot;1.0&quot;,[sasl],[{load_dot_erlang,true}]},
<a name="277"/>  277: 		    {emu_name,&quot;beam&quot;},
<a name="278"/>  278: 		    {relocatable,true},
<a name="279"/>  279: 		    {profile,development},
<a name="280"/>  280: 		    {incl_sys_filters,[&quot;.*&quot;]},
<a name="281"/>  281: 		    {excl_sys_filters,[]},
<a name="282"/>  282: 		    {incl_app_filters,[&quot;.*&quot;]},
<a name="283"/>  283: 		    {excl_app_filters,[]},
<a name="284"/>  284: 		    {rel_app_type,permanent},
<a name="285"/>  285: 		    {app_file,keep},
<a name="286"/>  286: 		    {debug_info,keep}]}},
<a name="287"/>  287: 	  reltool:get_config(Pid,true,false)),
<a name="288"/>  288: 
<a name="289"/>  289:     %% Include both defaults and derived info
<a name="290"/>  290:     ?msym({ok,{sys,[{root_dir,_},
<a name="291"/>  291: 		    {lib_dirs,_},
<a name="292"/>  292: 		    {mod_cond,all},
<a name="293"/>  293: 		    {incl_cond,exclude},
<a name="294"/>  294: 		    {erts,[]},
<a name="295"/>  295: 		    {app,kernel,[{incl_cond,include},{vsn,KVsn},
<a name="296"/>  296: 				 {lib_dir,KLibDir},{mod,_,[]}|_]},
<a name="297"/>  297: 		    {app,sasl,[{incl_cond,include},{vsn,SaslVsn},
<a name="298"/>  298: 				 {lib_dir,SaslLibDir},{mod,_,[]}|_]},
<a name="299"/>  299: 		    {app,stdlib,[{incl_cond,include},{vsn,StdVsn},
<a name="300"/>  300: 				 {lib_dir,StdLibDir},{mod,_,[]}|_]},
<a name="301"/>  301: 		    {boot_rel,&quot;start_clean&quot;},
<a name="302"/>  302:                     {rel,&quot;no_dot_erlang&quot;,&quot;1.0&quot;,[],[{load_dot_erlang,false}]},
<a name="303"/>  303: 		    {rel,&quot;start_clean&quot;,&quot;1.0&quot;,[],[{load_dot_erlang,true}]},
<a name="304"/>  304: 		    {rel,&quot;start_sasl&quot;,&quot;1.0&quot;,[sasl],[{load_dot_erlang,true}]},
<a name="305"/>  305: 		    {emu_name,&quot;beam&quot;},
<a name="306"/>  306: 		    {relocatable,true},
<a name="307"/>  307: 		    {profile,development},
<a name="308"/>  308: 		    {incl_sys_filters,[&quot;.*&quot;]},
<a name="309"/>  309: 		    {excl_sys_filters,[]},
<a name="310"/>  310: 		    {incl_app_filters,[&quot;.*&quot;]},
<a name="311"/>  311: 		    {excl_app_filters,[]},
<a name="312"/>  312: 		    {rel_app_type,permanent},
<a name="313"/>  313: 		    {app_file,keep},
<a name="314"/>  314: 		    {debug_info,keep}]}},
<a name="315"/>  315: 	  reltool:get_config(Pid,true,true)),
<a name="316"/>  316: 
<a name="317"/>  317:     ?m(ok, reltool:stop(Pid)),
<a name="get_config-last_expr"/><a name="318"/>  318:     ok.
<a name="319"/>  319: 
<a name="320"/>  320: 
<a name="321"/>  321: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="322"/>  322: <i>%% OTP-9135, test that app_file option can be set to all | keep | strip</i>
<a name="323"/>  323: 
<a name="otp_9135-1"/><a name="324"/>  324: <b>otp_9135</b>(_Config) -&gt;
<a name="325"/>  325:     Libs = reltool_test_lib:erl_libs(),
<a name="326"/>  326:     StrippedDefaultSys = 
<a name="327"/>  327:         case Libs of
<a name="328"/>  328:             [] -&gt; [];
<a name="329"/>  329:             _  -&gt; [{lib_dirs, Libs}]
<a name="330"/>  330:         end,
<a name="331"/>  331:     
<a name="332"/>  332:     Config1 = {sys,[{app_file, keep}]}, % this is the default
<a name="333"/>  333:     {ok, Pid1} = ?msym({ok, _}, reltool:start_server([{config, Config1}])),
<a name="334"/>  334:     ?m({ok, {sys,StrippedDefaultSys}}, reltool:get_config(Pid1)),
<a name="335"/>  335:     ?m(ok, reltool:stop(Pid1)),
<a name="336"/>  336:        
<a name="337"/>  337:     Config2 = {sys,[{app_file, strip}]},
<a name="338"/>  338:     {ok, Pid2} = ?msym({ok, _}, reltool:start_server([{config, Config2}])),
<a name="339"/>  339:     ExpectedConfig2 = StrippedDefaultSys++[{app_file,strip}],
<a name="340"/>  340:     ?m({ok, {sys,ExpectedConfig2}}, reltool:get_config(Pid2)),
<a name="341"/>  341:     ?m(ok, reltool:stop(Pid2)),
<a name="342"/>  342: 
<a name="343"/>  343:     Config3 = {sys,[{app_file, all}]},
<a name="344"/>  344:     {ok, Pid3} = ?msym({ok, _}, reltool:start_server([{config, Config3}])),
<a name="345"/>  345:     ExpectedConfig3 = StrippedDefaultSys++[{app_file,all}],
<a name="346"/>  346:     ?m({ok, {sys,ExpectedConfig3}}, reltool:get_config(Pid3)),
<a name="347"/>  347:     ?m(ok, reltool:stop(Pid3)),
<a name="otp_9135-last_expr"/><a name="348"/>  348:     ok.
<a name="349"/>  349: 
<a name="350"/>  350: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="351"/>  351: <i>%% Generate releases</i>
<a name="352"/>  352: 
<a name="create_release-1"/><a name="353"/>  353: <b>create_release</b>(_Config) -&gt;
<a name="354"/>  354:     %% Configure the server
<a name="355"/>  355:     RelName = &quot;Just testing...&quot;,
<a name="356"/>  356:     RelVsn = &quot;1.0&quot;,
<a name="357"/>  357:     Config =
<a name="358"/>  358:         {sys,
<a name="359"/>  359:          [
<a name="360"/>  360:           {lib_dirs, []},
<a name="361"/>  361:           {boot_rel, RelName},
<a name="362"/>  362:           {rel, RelName, RelVsn, [kernel, stdlib]}
<a name="363"/>  363:          ]},
<a name="364"/>  364:     %% Generate release 
<a name="365"/>  365:     ErtsVsn = erlang:system_info(version),
<a name="366"/>  366:     Apps = application:loaded_applications(),
<a name="367"/>  367:     {value, {_, _, KernelVsn}} = lists:keysearch(kernel, 1, Apps),
<a name="368"/>  368:     {value, {_, _, StdlibVsn}} = lists:keysearch(stdlib, 1, Apps),
<a name="369"/>  369:     Rel = {release, {RelName, RelVsn}, 
<a name="370"/>  370:            {erts, ErtsVsn}, 
<a name="371"/>  371:            [{kernel, KernelVsn}, {stdlib, StdlibVsn}]},
<a name="372"/>  372:     ?m({ok, Rel}, reltool:get_rel([{config, Config}], RelName)),
<a name="create_release-last_expr"/><a name="373"/>  373:     ok.
<a name="374"/>  374: 
<a name="375"/>  375: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="376"/>  376: <i>%% Generate releases and make sure order of applications specified in</i>
<a name="377"/>  377: <i>%% 'rel' parameter is preserved and that included applications are</i>
<a name="378"/>  378: <i>%% started before the including application.</i>
<a name="379"/>  379: <i>%% Circular dependencies shall also be detected and cause error.</i>
<a name="380"/>  380: 
<a name="create_release_sort-1"/><a name="381"/>  381: <b>create_release_sort</b>(Config) -&gt;
<a name="382"/>  382:     DataDir = ?config(data_dir,Config),
<a name="383"/>  383:     %% Configure the server
<a name="384"/>  384:     RelName1 = &quot;MnesiaFirst&quot;,
<a name="385"/>  385:     RelName2 = &quot;SaslFirst&quot;,
<a name="386"/>  386:     RelName3 = &quot;Include-both&quot;,
<a name="387"/>  387:     RelName4 = &quot;Include-only-app&quot;,
<a name="388"/>  388:     RelName5 = &quot;Include-only-rel&quot;,
<a name="389"/>  389:     RelName6 = &quot;Auto-add-missing-apps&quot;,
<a name="390"/>  390:     RelName7 = &quot;Circular&quot;,
<a name="391"/>  391:     RelName8 = &quot;Include-rel-alter-order&quot;,
<a name="392"/>  392:     RelName9 = &quot;Include-none-overwrite&quot;,
<a name="393"/>  393:     RelName10= &quot;Uses-order-as-rel&quot;,
<a name="394"/>  394:     RelName11= &quot;Auto-add-dont-overwrite-load&quot;,
<a name="395"/>  395:     RelVsn = &quot;1.0&quot;,
<a name="396"/>  396:     %% Application z (.app file):
<a name="397"/>  397:     %%     includes [tools, mnesia]
<a name="398"/>  398:     %%     uses [kernel, stdlib, sasl, inets, unknown]
<a name="399"/>  399:     %% where unknown is optional dependency
<a name="400"/>  400:     Sys =
<a name="401"/>  401:         {sys,
<a name="402"/>  402:          [
<a name="403"/>  403:           {lib_dirs, [filename:join(DataDir,&quot;sort_apps&quot;)]},
<a name="404"/>  404:           {boot_rel, RelName1},
<a name="405"/>  405:           {rel, RelName1, RelVsn, [stdlib, kernel, mnesia, sasl]},
<a name="406"/>  406:           {rel, RelName2, RelVsn, [stdlib, kernel, sasl, mnesia]},
<a name="407"/>  407:           {rel, RelName3, RelVsn, [stdlib, kernel, {z,[tools]}, tools, mnesia]},
<a name="408"/>  408:           {rel, RelName4, RelVsn, [stdlib, kernel, z, mnesia, tools]},
<a name="409"/>  409:           {rel, RelName5, RelVsn, [stdlib, kernel, {sasl,[tools]}]},
<a name="410"/>  410:           {rel, RelName6, RelVsn, [z]},
<a name="411"/>  411: 	  {rel, RelName7, RelVsn, [stdlib, kernel, mnesia, y, sasl, x]},
<a name="412"/>  412:           {rel, RelName8, RelVsn, [stdlib, kernel, {z,[mnesia,tools]}]},
<a name="413"/>  413:           {rel, RelName9, RelVsn, [stdlib, kernel, {z,[]}]},
<a name="414"/>  414:           {rel, RelName10, RelVsn, [stdlib, kernel, {z,[]}, inets, sasl]},
<a name="415"/>  415:           {rel, RelName11, RelVsn, [stdlib, kernel, z, {inets, load}]},
<a name="416"/>  416: 	  {incl_cond,exclude},
<a name="417"/>  417: 	  {mod_cond,app},
<a name="418"/>  418: 	  {app,kernel,[{incl_cond,include}]},
<a name="419"/>  419: 	  {app,stdlib,[{incl_cond,include}]},
<a name="420"/>  420: 	  {app,mnesia,[{incl_cond,include}]},
<a name="421"/>  421: 	  {app,sasl,[{incl_cond,include}]},
<a name="422"/>  422: 	  {app,inets,[{incl_cond,include}]},
<a name="423"/>  423: 	  {app,x,[{incl_cond,include}]},
<a name="424"/>  424: 	  {app,y,[{incl_cond,include}]},
<a name="425"/>  425: 	  {app,z,[{incl_cond,include}]},
<a name="426"/>  426: 	  {app,tools,[{mod_cond,app},{incl_cond,include}]}
<a name="427"/>  427:          ]},
<a name="428"/>  428:     %% Generate release
<a name="429"/>  429:     ?msym({ok, {release, {RelName1, RelVsn},
<a name="430"/>  430: 		{erts, _},
<a name="431"/>  431: 		[{kernel, _},
<a name="432"/>  432: 		 {stdlib, _},
<a name="433"/>  433: 		 {mnesia, _},
<a name="434"/>  434: 		 {sasl, _}]}},
<a name="435"/>  435: 	  reltool:get_rel([{config, Sys}], RelName1)),
<a name="436"/>  436: 
<a name="437"/>  437:     ?msym({ok, {release, {RelName2, RelVsn},
<a name="438"/>  438: 		{erts, _},
<a name="439"/>  439: 		[{kernel, _},
<a name="440"/>  440: 		 {stdlib, _},
<a name="441"/>  441: 		 {sasl, _},
<a name="442"/>  442: 		 {mnesia, _}]}},
<a name="443"/>  443: 	  reltool:get_rel([{config, Sys}], RelName2)),
<a name="444"/>  444: 
<a name="445"/>  445:     ?msym({ok, {release, {RelName3, RelVsn},
<a name="446"/>  446: 		{erts, _},
<a name="447"/>  447: 		[{kernel, _},
<a name="448"/>  448: 		 {stdlib, _},
<a name="449"/>  449: 		 {sasl, _},
<a name="450"/>  450: 		 {inets, _},
<a name="451"/>  451: 		 {tools, _},
<a name="452"/>  452: 		 {z, _, [tools]},
<a name="453"/>  453: 		 {mnesia, _}]}},
<a name="454"/>  454: 	  reltool:get_rel([{config, Sys}], RelName3)),
<a name="455"/>  455: 
<a name="456"/>  456:     ?msym({ok, {release, {RelName4, RelVsn},
<a name="457"/>  457: 		{erts, _},
<a name="458"/>  458: 		[{kernel, _},
<a name="459"/>  459: 		 {stdlib, _},
<a name="460"/>  460: 		 {sasl, _},
<a name="461"/>  461: 		 {inets, _},
<a name="462"/>  462: 		 {mnesia, _},
<a name="463"/>  463: 		 {tools, _},
<a name="464"/>  464: 		 {z, _}]}},
<a name="465"/>  465: 	  reltool:get_rel([{config, Sys}], RelName4)),
<a name="466"/>  466: 
<a name="467"/>  467:     ?m({error,&quot;sasl: These applications are used by release &quot;
<a name="468"/>  468: 	&quot;Include-only-rel but are missing as included_applications &quot;
<a name="469"/>  469: 	&quot;in the app file: [tools]&quot;},
<a name="470"/>  470:        reltool:get_rel([{config, Sys}], RelName5)),
<a name="471"/>  471: 
<a name="472"/>  472:     ?msym({ok, {release, {RelName6, RelVsn},
<a name="473"/>  473: 		{erts, _},
<a name="474"/>  474: 		[{kernel, _},
<a name="475"/>  475: 		 {stdlib, _},
<a name="476"/>  476: 		 {sasl, _},
<a name="477"/>  477: 		 {inets, _},
<a name="478"/>  478: 		 {tools, _},
<a name="479"/>  479: 		 {mnesia, _},
<a name="480"/>  480: 		 {z, _}]}},
<a name="481"/>  481:        reltool:get_rel([{config, Sys}], RelName6)),
<a name="482"/>  482: 
<a name="483"/>  483:     ?m({error,&quot;Circular dependencies: [x,y]&quot;},
<a name="484"/>  484:        reltool:get_rel([{config, Sys}], RelName7)),
<a name="485"/>  485: 
<a name="486"/>  486:     ?msym({ok, {release, {RelName8, RelVsn},
<a name="487"/>  487: 		{erts, _},
<a name="488"/>  488: 		[{kernel, _},
<a name="489"/>  489: 		 {stdlib, _},
<a name="490"/>  490: 		 {sasl, _},
<a name="491"/>  491: 		 {inets, _},
<a name="492"/>  492: 		 {mnesia, _},
<a name="493"/>  493: 		 {tools, _},
<a name="494"/>  494: 		 {z, _, [mnesia,tools]}]}},
<a name="495"/>  495:        reltool:get_rel([{config, Sys}], RelName8)),
<a name="496"/>  496: 
<a name="497"/>  497:     ?msym({ok,{release,{RelName9,RelVsn},
<a name="498"/>  498: 	       {erts,_},
<a name="499"/>  499: 	       [{kernel,_},
<a name="500"/>  500: 		{stdlib,_},
<a name="501"/>  501: 		{sasl, _},
<a name="502"/>  502: 		{inets, _},
<a name="503"/>  503: 		{z,_,[]}]}},
<a name="504"/>  504: 	  reltool:get_rel([{config, Sys}], RelName9)),
<a name="505"/>  505: 
<a name="506"/>  506:     ?msym({ok,{release,{RelName10,RelVsn},
<a name="507"/>  507: 	       {erts,_},
<a name="508"/>  508: 	       [{kernel,_},
<a name="509"/>  509: 		{stdlib,_},
<a name="510"/>  510: 		{inets, _},
<a name="511"/>  511: 		{sasl, _},
<a name="512"/>  512: 		{z,_,[]}]}},
<a name="513"/>  513: 	  reltool:get_rel([{config, Sys}], RelName10)),
<a name="514"/>  514: 
<a name="515"/>  515:     ?msym({ok,{release,{RelName11,RelVsn},
<a name="516"/>  516: 	       {erts,_},
<a name="517"/>  517: 	       [{kernel,_},
<a name="518"/>  518: 		{stdlib,_},
<a name="519"/>  519: 		{sasl, _},
<a name="520"/>  520: 		{inets, _, load},
<a name="521"/>  521: 		{tools, _},
<a name="522"/>  522: 		{mnesia, _},
<a name="523"/>  523: 		{z,_}]}},
<a name="524"/>  524: 	  reltool:get_rel([{config, Sys}], RelName11)),
<a name="525"/>  525: 
<a name="create_release_sort-last_expr"/><a name="526"/>  526:     ok.
<a name="527"/>  527: 
<a name="528"/>  528: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="529"/>  529: <i>%% Generate boot scripts</i>
<a name="530"/>  530: 
<a name="create_script-1"/><a name="531"/>  531: <b>create_script</b>(_Config) -&gt;
<a name="532"/>  532:     %% Configure the server
<a name="533"/>  533:     RelName = &quot;Just testing&quot;,
<a name="534"/>  534:     RelVsn = &quot;1.0&quot;,
<a name="535"/>  535:     Config =
<a name="536"/>  536:         {sys,
<a name="537"/>  537:          [
<a name="538"/>  538:           {lib_dirs, []},
<a name="539"/>  539:           {boot_rel, RelName},
<a name="540"/>  540:           {rel, RelName, RelVsn, [stdlib, kernel]}
<a name="541"/>  541:          ]},
<a name="542"/>  542:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Config}])),
<a name="543"/>  543: 
<a name="544"/>  544:     %% Generate release file
<a name="545"/>  545:     ErtsVsn = erlang:system_info(version),
<a name="546"/>  546:     Apps = application:loaded_applications(),
<a name="547"/>  547:     {value, {_, _, KernelVsn}} = lists:keysearch(kernel, 1, Apps),
<a name="548"/>  548:     {value, {_, _, StdlibVsn}} = lists:keysearch(stdlib, 1, Apps),
<a name="549"/>  549:     Rel = {release, 
<a name="550"/>  550:            {RelName, RelVsn}, 
<a name="551"/>  551:            {erts, ErtsVsn},
<a name="552"/>  552:            [{kernel, KernelVsn}, {stdlib, StdlibVsn}]},
<a name="553"/>  553:     ?m({ok, Rel}, reltool:get_rel(Pid, RelName)),
<a name="554"/>  554:     ?m(ok, file:write_file(filename:join([?WORK_DIR, RelName ++ &quot;.rel&quot;]),
<a name="555"/>  555: 			   io_lib:format(&quot;~p.\n&quot;, [Rel]))),
<a name="556"/>  556: 
<a name="557"/>  557:     %% Generate script file
<a name="558"/>  558:     {ok, Cwd} = file:get_cwd(),
<a name="559"/>  559:     ?m(ok, file:set_cwd(?WORK_DIR)),
<a name="560"/>  560:     ?m(ok, systools:make_script(RelName, [])),
<a name="561"/>  561:     {ok, [OrigScript]} = ?msym({ok, [_]}, file:consult(RelName ++ &quot;.script&quot;)),
<a name="562"/>  562:     ?m(ok, file:set_cwd(Cwd)),
<a name="563"/>  563:     {ok, Script} = ?msym({ok, _}, reltool:get_script(Pid, RelName)),
<a name="564"/>  564:     %% OrigScript2 = sort_script(OrigScript),
<a name="565"/>  565:     %% Script2 = sort_script(Script),
<a name="566"/>  566:     %% ?m(OrigScript2, Script2),
<a name="567"/>  567:     
<a name="568"/>  568:     ?m(equal, diff_script(OrigScript, Script)),
<a name="569"/>  569: 
<a name="570"/>  570:     %% A release defaults to load_dot_erlang == true
<a name="571"/>  571:     {script, {RelName, RelVsn}, ScriptInstructions} = Script,
<a name="572"/>  572:     ?m(true, lists:member({apply,{c,erlangrc,[]}}, ScriptInstructions)),
<a name="573"/>  573: 
<a name="574"/>  574:     %% Stop server
<a name="575"/>  575:     ?m(ok, reltool:stop(Pid)),
<a name="create_script-last_expr"/><a name="576"/>  576:     ok.
<a name="577"/>  577: 
<a name="create_script_without_dot_erlang-1"/><a name="578"/>  578: <b>create_script_without_dot_erlang</b>(_Config) -&gt;
<a name="579"/>  579:     %% Configure the server
<a name="580"/>  580:     RelName = &quot;Just testing&quot;,
<a name="581"/>  581:     RelVsn = &quot;1.0&quot;,
<a name="582"/>  582:     Config =
<a name="583"/>  583:         {sys,
<a name="584"/>  584:          [
<a name="585"/>  585:           {lib_dirs, []},
<a name="586"/>  586:           {boot_rel, RelName},
<a name="587"/>  587:           {rel, RelName, RelVsn, [stdlib, kernel], [{load_dot_erlang, false}]}
<a name="588"/>  588:          ]},
<a name="589"/>  589:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Config}])),
<a name="590"/>  590: 
<a name="591"/>  591:     %% Confirm that load_dot_erlang == false was used
<a name="592"/>  592:     {ok, Script} = ?msym({ok, _}, reltool:get_script(Pid, RelName)),
<a name="593"/>  593:     {script, {RelName, RelVsn}, ScriptInstructions} = Script,
<a name="594"/>  594:     ?m(false, lists:member({apply,{c,erlangrc,[]}}, ScriptInstructions)),
<a name="595"/>  595: 
<a name="596"/>  596:     %% Stop server
<a name="597"/>  597:     ?m(ok, reltool:stop(Pid)),
<a name="create_script_without_dot_erlang-last_expr"/><a name="598"/>  598:     ok.
<a name="599"/>  599: 
<a name="600"/>  600: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="601"/>  601: <i>%% Test creation of .script with different sorting of applications and</i>
<a name="602"/>  602: <i>%% included applications.</i>
<a name="603"/>  603: <i>%% Test that result is equal to what systools produces</i>
<a name="create_script_sort-1"/><a name="604"/>  604: <b>create_script_sort</b>(Config) -&gt;
<a name="605"/>  605:     DataDir = ?config(data_dir,Config),
<a name="606"/>  606:     %% Configure the server
<a name="607"/>  607:     RelName1 = &quot;MnesiaFirst&quot;,
<a name="608"/>  608:     RelName2 = &quot;SaslFirst&quot;,
<a name="609"/>  609:     RelName3 = &quot;Include-both&quot;,
<a name="610"/>  610:     RelName4 = &quot;Include-only-app&quot;,
<a name="611"/>  611:     RelName5 = &quot;Include-only-rel&quot;,
<a name="612"/>  612:     RelName6 = &quot;Auto-add-missing-apps&quot;,
<a name="613"/>  613:     RelName7 = &quot;Circular&quot;,
<a name="614"/>  614:     RelName8 = &quot;Include-rel-alter-order&quot;,
<a name="615"/>  615:     RelName9 = &quot;Include-none-overwrite&quot;,
<a name="616"/>  616:     RelName10= &quot;Uses-order-as-rel&quot;,
<a name="617"/>  617:     RelVsn = &quot;1.0&quot;,
<a name="618"/>  618:     LibDir = filename:join(DataDir,&quot;sort_apps&quot;),
<a name="619"/>  619:     %% Application z (.app file):
<a name="620"/>  620:     %%     includes [tools, mnesia]
<a name="621"/>  621:     %%     uses [kernel, stdlib, sasl, inets, unknown]
<a name="622"/>  622:     %% where unknown is optional dependency
<a name="623"/>  623:     Sys =
<a name="624"/>  624:         {sys,
<a name="625"/>  625:          [
<a name="626"/>  626:           {lib_dirs, [LibDir]},
<a name="627"/>  627:           {boot_rel, RelName1},
<a name="628"/>  628:           {rel, RelName1, RelVsn, [stdlib, kernel, mnesia, sasl]},
<a name="629"/>  629:           {rel, RelName2, RelVsn, [stdlib, kernel, sasl, mnesia]},
<a name="630"/>  630:           {rel, RelName3, RelVsn, [stdlib, kernel, {z,[tools]}, tools, mnesia]},
<a name="631"/>  631:           {rel, RelName4, RelVsn, [stdlib, kernel, z, mnesia, tools]},
<a name="632"/>  632:           {rel, RelName5, RelVsn, [stdlib, kernel, {sasl,[tools]}]},
<a name="633"/>  633:           {rel, RelName6, RelVsn, [z]},
<a name="634"/>  634: 	  {rel, RelName7, RelVsn, [stdlib, kernel, mnesia, y, sasl, x]},
<a name="635"/>  635:           {rel, RelName8, RelVsn, [stdlib, kernel, {z,[mnesia,tools]}]},
<a name="636"/>  636:           {rel, RelName9, RelVsn, [stdlib, kernel, {z,[]}]},
<a name="637"/>  637:           {rel, RelName10, RelVsn, [stdlib, kernel, {z,[]}, inets, sasl]},
<a name="638"/>  638: 	  {incl_cond,exclude},
<a name="639"/>  639: 	  {mod_cond,app},
<a name="640"/>  640: 	  {app,kernel,[{incl_cond,include}]},
<a name="641"/>  641: 	  {app,stdlib,[{incl_cond,include}]},
<a name="642"/>  642: 	  {app,mnesia,[{incl_cond,include}]},
<a name="643"/>  643: 	  {app,sasl,[{incl_cond,include}]},
<a name="644"/>  644: 	  {app,inets,[{incl_cond,include}]},
<a name="645"/>  645: 	  {app,x,[{incl_cond,include}]},
<a name="646"/>  646: 	  {app,y,[{incl_cond,include}]},
<a name="647"/>  647: 	  {app,z,[{incl_cond,include}]},
<a name="648"/>  648: 	  {app,tools,[{mod_cond,app},{incl_cond,include}]}
<a name="649"/>  649:          ]},
<a name="650"/>  650: 
<a name="651"/>  651:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="652"/>  652: 
<a name="653"/>  653:     %% Generate release files
<a name="654"/>  654:     application:load(sasl),
<a name="655"/>  655:     application:load(inets),
<a name="656"/>  656:     application:load(mnesia),
<a name="657"/>  657:     application:load(tools),
<a name="658"/>  658:     {ok,KernelVsn} = application:get_key(kernel,vsn),
<a name="659"/>  659:     {ok,StdlibVsn} = application:get_key(stdlib,vsn),
<a name="660"/>  660:     {ok,SaslVsn} = application:get_key(sasl,vsn),
<a name="661"/>  661:     {ok,InetsVsn} = application:get_key(inets,vsn),
<a name="662"/>  662:     {ok,MnesiaVsn} = application:get_key(mnesia,vsn),
<a name="663"/>  663:     {ok,ToolsVsn} = application:get_key(tools,vsn),
<a name="664"/>  664:     ErtsVsn = erlang:system_info(version),
<a name="665"/>  665: 
<a name="666"/>  666:     Rel1 = {release, {RelName1,RelVsn}, {erts,ErtsVsn},
<a name="667"/>  667: 	    [{kernel,KernelVsn},
<a name="668"/>  668: 	     {stdlib,StdlibVsn},
<a name="669"/>  669: 	     {mnesia,MnesiaVsn},
<a name="670"/>  670: 	     {sasl,SaslVsn}]},
<a name="671"/>  671:     FullName1 = filename:join(?WORK_DIR,RelName1),
<a name="672"/>  672:     ?m(ok, file:write_file(FullName1 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel1]))),
<a name="673"/>  673:     Rel2 = {release, {RelName2,RelVsn}, {erts,ErtsVsn},
<a name="674"/>  674: 	    [{kernel,KernelVsn},
<a name="675"/>  675: 	     {stdlib,StdlibVsn},
<a name="676"/>  676: 	     {sasl,SaslVsn},
<a name="677"/>  677: 	     {mnesia,MnesiaVsn}]},
<a name="678"/>  678:     FullName2 = filename:join(?WORK_DIR,RelName2),
<a name="679"/>  679:     ?m(ok, file:write_file(FullName2 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel2]))),
<a name="680"/>  680:     Rel3 = {release, {RelName3,RelVsn}, {erts,ErtsVsn},
<a name="681"/>  681: 	     [{kernel,KernelVsn},
<a name="682"/>  682: 	      {stdlib,StdlibVsn},
<a name="683"/>  683: 	      {z,&quot;1.0&quot;,[tools]},
<a name="684"/>  684: 	      {tools,ToolsVsn},
<a name="685"/>  685: 	      {mnesia,MnesiaVsn},
<a name="686"/>  686: 	      {sasl,SaslVsn},
<a name="687"/>  687: 	      {inets,InetsVsn}]},
<a name="688"/>  688:     FullName3 = filename:join(?WORK_DIR,RelName3),
<a name="689"/>  689:     ?m(ok, file:write_file(FullName3 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel3]))),
<a name="690"/>  690:     Rel4 = {release, {RelName4,RelVsn}, {erts,ErtsVsn},
<a name="691"/>  691: 	     [{kernel,KernelVsn},
<a name="692"/>  692: 	      {stdlib,StdlibVsn},
<a name="693"/>  693: 	      {z,&quot;1.0&quot;},
<a name="694"/>  694: 	      {mnesia,MnesiaVsn},
<a name="695"/>  695: 	      {tools,ToolsVsn},
<a name="696"/>  696: 	      {sasl,SaslVsn},
<a name="697"/>  697: 	      {inets,InetsVsn}]},
<a name="698"/>  698:     FullName4 = filename:join(?WORK_DIR,RelName4),
<a name="699"/>  699:     ?m(ok, file:write_file(FullName4 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel4]))),
<a name="700"/>  700:     Rel5 = {release, {RelName5,RelVsn}, {erts,ErtsVsn},
<a name="701"/>  701: 	     [{kernel,KernelVsn},
<a name="702"/>  702: 	      {stdlib,StdlibVsn},
<a name="703"/>  703: 	      {sasl,SaslVsn,[tools]},
<a name="704"/>  704: 	      {tools,ToolsVsn}]},
<a name="705"/>  705:     FullName5 = filename:join(?WORK_DIR,RelName5),
<a name="706"/>  706:     ?m(ok, file:write_file(FullName5 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel5]))),
<a name="707"/>  707:     Rel6 = {release, {RelName6,RelVsn}, {erts,ErtsVsn},
<a name="708"/>  708: 	     [{kernel,KernelVsn},
<a name="709"/>  709: 	      {stdlib,StdlibVsn},
<a name="710"/>  710: 	      {sasl,SaslVsn},
<a name="711"/>  711: 	      {inets,InetsVsn},
<a name="712"/>  712: 	      {tools,ToolsVsn},
<a name="713"/>  713: 	      {mnesia,MnesiaVsn},
<a name="714"/>  714: 	      {z,&quot;1.0&quot;}]},
<a name="715"/>  715:     FullName6 = filename:join(?WORK_DIR,RelName6),
<a name="716"/>  716:     ?m(ok, file:write_file(FullName6 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel6]))),
<a name="717"/>  717:     Rel7 = {release, {RelName7,RelVsn}, {erts,ErtsVsn},
<a name="718"/>  718: 	     [{kernel,KernelVsn},
<a name="719"/>  719: 	      {stdlib,StdlibVsn},
<a name="720"/>  720: 	      {mnesia,MnesiaVsn},
<a name="721"/>  721: 	      {y,&quot;1.0&quot;},
<a name="722"/>  722: 	      {sasl,SaslVsn},
<a name="723"/>  723: 	      {x,&quot;1.0&quot;}]},
<a name="724"/>  724:     FullName7 = filename:join(?WORK_DIR,RelName7),
<a name="725"/>  725:     ?m(ok, file:write_file(FullName7 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel7]))),
<a name="726"/>  726:     Rel8 = {release, {RelName8,RelVsn}, {erts,ErtsVsn},
<a name="727"/>  727: 	     [{kernel,KernelVsn},
<a name="728"/>  728: 	      {stdlib,StdlibVsn},
<a name="729"/>  729: 	      {z,&quot;1.0&quot;,[mnesia,tools]},
<a name="730"/>  730: 	      {sasl,SaslVsn},
<a name="731"/>  731: 	      {inets,InetsVsn},
<a name="732"/>  732: 	      {mnesia,MnesiaVsn},
<a name="733"/>  733: 	      {tools,ToolsVsn}]},
<a name="734"/>  734:     FullName8 = filename:join(?WORK_DIR,RelName8),
<a name="735"/>  735:     ?m(ok, file:write_file(FullName8 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel8]))),
<a name="736"/>  736:     Rel9 = {release, {RelName9,RelVsn}, {erts,ErtsVsn},
<a name="737"/>  737: 	     [{kernel,KernelVsn},
<a name="738"/>  738: 	      {stdlib,StdlibVsn},
<a name="739"/>  739: 	      {z,&quot;1.0&quot;,[]},
<a name="740"/>  740: 	      {sasl,SaslVsn},
<a name="741"/>  741: 	      {inets,InetsVsn}]},
<a name="742"/>  742:     FullName9 = filename:join(?WORK_DIR,RelName9),
<a name="743"/>  743:     ?m(ok, file:write_file(FullName9 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel9]))),
<a name="744"/>  744:     Rel10 = {release, {RelName10,RelVsn}, {erts,ErtsVsn},
<a name="745"/>  745: 	     [{kernel,KernelVsn},
<a name="746"/>  746: 	      {stdlib,StdlibVsn},
<a name="747"/>  747: 	      {z,&quot;1.0&quot;,[]},
<a name="748"/>  748: 	      {inets,InetsVsn},
<a name="749"/>  749: 	      {sasl,SaslVsn}]},
<a name="750"/>  750:     FullName10 = filename:join(?WORK_DIR,RelName10),
<a name="751"/>  751:     ?m(ok, file:write_file(FullName10 ++ &quot;.rel&quot;, io_lib:format(&quot;~p.\n&quot;, [Rel10]))),
<a name="752"/>  752: 
<a name="753"/>  753:     %% Generate script files with systools and reltool and compare
<a name="754"/>  754:     ZPath = filename:join([LibDir,&quot;*&quot;,ebin]),
<a name="755"/>  755: 
<a name="756"/>  756:     ?msym({ok,_,_}, systools_make_script(FullName1,ZPath)),
<a name="757"/>  757:     {ok, [SystoolsScript1]} = ?msym({ok,[_]}, file:consult(FullName1++&quot;.script&quot;)),
<a name="758"/>  758:     {ok, Script1} = ?msym({ok, _}, reltool:get_script(Pid, RelName1)),
<a name="759"/>  759:     ?m(equal, diff_script(SystoolsScript1, Script1)),
<a name="760"/>  760: 
<a name="761"/>  761:     ?msym({ok,_,_}, systools_make_script(FullName2,ZPath)),
<a name="762"/>  762:     {ok, [SystoolsScript2]} = ?msym({ok,[_]}, file:consult(FullName2++&quot;.script&quot;)),
<a name="763"/>  763:     {ok, Script2} = ?msym({ok, _}, reltool:get_script(Pid, RelName2)),
<a name="764"/>  764:     ?m(equal, diff_script(SystoolsScript2, Script2)),
<a name="765"/>  765: 
<a name="766"/>  766:     ?msym({ok,_,_}, systools_make_script(FullName3,ZPath)),
<a name="767"/>  767:     {ok, [SystoolsScript3]} = ?msym({ok,[_]}, file:consult(FullName3++&quot;.script&quot;)),
<a name="768"/>  768:     {ok, Script3} = ?msym({ok, _}, reltool:get_script(Pid, RelName3)),
<a name="769"/>  769:     ?m(equal, diff_script(SystoolsScript3, Script3)),
<a name="770"/>  770: 
<a name="771"/>  771:     ?msym({ok,_,_}, systools_make_script(FullName4,ZPath)),
<a name="772"/>  772:     {ok, [SystoolsScript4]} = ?msym({ok,[_]}, file:consult(FullName4++&quot;.script&quot;)),
<a name="773"/>  773:     {ok, Script4} = ?msym({ok, _}, reltool:get_script(Pid, RelName4)),
<a name="774"/>  774:     ?m(equal, diff_script(SystoolsScript4, Script4)),
<a name="775"/>  775: 
<a name="776"/>  776:     ?msym({error,_,[{error_reading,{sasl,{override_include,_}}}]},
<a name="777"/>  777: 	  systools_make_script(FullName5,ZPath)),
<a name="778"/>  778:     ?m({error,&quot;sasl: These applications are used by release &quot;
<a name="779"/>  779: 	&quot;Include-only-rel but are missing as included_applications &quot;
<a name="780"/>  780: 	&quot;in the app file: [tools]&quot;},
<a name="781"/>  781:        reltool:get_script(Pid, RelName5)),
<a name="782"/>  782: 
<a name="783"/>  783:     ?msym({ok,_,_}, systools_make_script(FullName6,ZPath)),
<a name="784"/>  784:     {ok, [SystoolsScript6]} = ?msym({ok,[_]}, file:consult(FullName6++&quot;.script&quot;)),
<a name="785"/>  785:     {ok, Script6} = ?msym({ok, _}, reltool:get_script(Pid, RelName6)),
<a name="786"/>  786:     ?m(equal, diff_script(SystoolsScript6, Script6)),
<a name="787"/>  787: 
<a name="788"/>  788:     ?msym({error,_,{circular_dependencies,_}},
<a name="789"/>  789: 	  systools_make_script(FullName7,ZPath)),
<a name="790"/>  790:     ?m({error,&quot;Circular dependencies: [x,y]&quot;},
<a name="791"/>  791:        reltool:get_script(Pid, RelName7)),
<a name="792"/>  792: 
<a name="793"/>  793:     ?msym({ok,_,_}, systools_make_script(FullName8,ZPath)),
<a name="794"/>  794:     {ok, [SystoolsScript8]} = ?msym({ok,[_]}, file:consult(FullName8++&quot;.script&quot;)),
<a name="795"/>  795:     {ok, Script8} = ?msym({ok, _}, reltool:get_script(Pid, RelName8)),
<a name="796"/>  796:     ?m(equal, diff_script(SystoolsScript8, Script8)),
<a name="797"/>  797: 
<a name="798"/>  798:     ?msym({ok,_,_}, systools_make_script(FullName9,ZPath)),
<a name="799"/>  799:     {ok, [SystoolsScript9]} = ?msym({ok,[_]}, file:consult(FullName9++&quot;.script&quot;)),
<a name="800"/>  800:     {ok, Script9} = ?msym({ok, _}, reltool:get_script(Pid, RelName9)),
<a name="801"/>  801:     ?m(equal, diff_script(SystoolsScript9, Script9)),
<a name="802"/>  802: 
<a name="803"/>  803:     ?msym({ok,_,_}, systools_make_script(FullName10,ZPath)),
<a name="804"/>  804:     {ok, [SystoolsScript10]} = ?msym({ok,[_]}, file:consult(FullName10++&quot;.script&quot;)),
<a name="805"/>  805:     {ok, Script10} = ?msym({ok, _}, reltool:get_script(Pid, RelName10)),
<a name="806"/>  806:     ?m(equal, diff_script(SystoolsScript10, Script10)),
<a name="807"/>  807: 
<a name="808"/>  808:     %% Stop server
<a name="809"/>  809:     ?m(ok, reltool:stop(Pid)),
<a name="create_script_sort-last_expr"/><a name="810"/>  810:     ok.
<a name="811"/>  811: 
<a name="812"/>  812: 
<a name="systools_make_script-2"/><a name="813"/>  813: <b>systools_make_script</b>(Name,Path) -&gt;
<a name="systools_make_script-last_expr"/><a name="814"/>  814: <b>    systools:make_script</b>(Name,[{path,[Path]},{outdir,?WORK_DIR},silent]).
<a name="815"/>  815: 
<a name="816"/>  816: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="817"/>  817: <i>%% Generate target system</i>
<a name="818"/>  818: 
<a name="create_target-1"/><a name="819"/>  819: <b>create_target</b>(_Config) -&gt;
<a name="820"/>  820:     %% Configure the server
<a name="821"/>  821:     RelName1 = &quot;Just testing&quot;,
<a name="822"/>  822:     RelName2 = &quot;Just testing with SASL&quot;,
<a name="823"/>  823:     RelVsn = &quot;1.0&quot;,
<a name="824"/>  824:     Config =
<a name="825"/>  825:         {sys,
<a name="826"/>  826:          [
<a name="827"/>  827:           {root_dir, code:root_dir()},
<a name="828"/>  828:           {lib_dirs, []},
<a name="829"/>  829:           {boot_rel, RelName2},
<a name="830"/>  830:           {rel, RelName1, RelVsn, [stdlib, kernel]},
<a name="831"/>  831:           {rel, RelName2, RelVsn, [sasl, stdlib, kernel]},
<a name="832"/>  832:           {app, sasl, [{incl_cond, include}]}
<a name="833"/>  833:          ]},
<a name="834"/>  834: 
<a name="835"/>  835:     %% Generate target file
<a name="836"/>  836:     TargetDir = filename:join([?WORK_DIR, &quot;target_development&quot;]),
<a name="837"/>  837:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="838"/>  838:     ?m(ok, file:make_dir(TargetDir)),
<a name="839"/>  839:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, Config}])]),
<a name="840"/>  840:     ok = ?m(ok, reltool:create_target([{config, Config}], TargetDir)),
<a name="841"/>  841:     
<a name="842"/>  842:     Erl = filename:join([TargetDir, &quot;bin&quot;, &quot;erl&quot;]),
<a name="843"/>  843:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="844"/>  844:     ?msym(ok, stop_node(Node)),
<a name="845"/>  845: 
<a name="create_target-last_expr"/><a name="846"/>  846:     ok.
<a name="847"/>  847: 
<a name="848"/>  848: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="849"/>  849: <i>%% Generate target system</i>
<a name="850"/>  850: 
<a name="create_target_unicode-1"/><a name="851"/>  851: <b>create_target_unicode</b>(Config) -&gt;
<a name="852"/>  852:     DataDir = ?config(data_dir,Config),
<a name="853"/>  853: 
<a name="854"/>  854:     %% If file name translation mode is unicode, then use unicode
<a name="855"/>  855:     %% characters release name (which will be used as file name for
<a name="856"/>  856:     %% .rel, .script and .boot), and install the release under a path
<a name="857"/>  857:     %% which icludes unicode characters.
<a name="858"/>  858:     {RelNamePrefix,TargetDirName} =
<a name="859"/>  859: 	case file:native_name_encoding() of
<a name="860"/>  860: 	    utf8 -&gt;
<a name="861"/>  861: 		{&quot;Unicode test &quot;,&quot;target_unicode_&quot;} ;
<a name="862"/>  862: 	    latin1 -&gt;
<a name="863"/>  863: 		{&quot;Unicode test&quot;,&quot;target_unicode&quot;}
<a name="864"/>  864: 	end,
<a name="865"/>  865: 
<a name="866"/>  866:     %% Configure the server
<a name="867"/>  867:     RelName1 = RelNamePrefix,
<a name="868"/>  868:     RelName2 = RelNamePrefix ++ &quot; with SASL&quot;,
<a name="869"/>  869:     RelVsn = &quot;1.0&quot;,
<a name="870"/>  870:     Sys =
<a name="871"/>  871:         {sys,
<a name="872"/>  872:          [
<a name="873"/>  873:           {root_dir, code:root_dir()},
<a name="874"/>  874:           {lib_dirs, [filename:join(DataDir,&quot;unicode&quot;)]},
<a name="875"/>  875: 	  {app_file, all},
<a name="876"/>  876: 	  {incl_cond,exclude},
<a name="877"/>  877: 	  {boot_rel, RelName2},
<a name="878"/>  878:           {rel, RelName1, RelVsn, [stdlib, kernel, ua]},
<a name="879"/>  879:           {rel, RelName2, RelVsn, [sasl, stdlib, kernel, ua]},
<a name="880"/>  880:           {app, kernel, [{incl_cond, include}]},
<a name="881"/>  881:           {app, stdlib, [{incl_cond, include}]},
<a name="882"/>  882:           {app, sasl, [{incl_cond, include}]},
<a name="883"/>  883:           {app, ua, [{incl_cond, include}]}
<a name="884"/>  884:          ]},
<a name="885"/>  885: 
<a name="886"/>  886:     %% Generate target file
<a name="887"/>  887:     TargetDir = filename:join([?WORK_DIR, TargetDirName]),
<a name="888"/>  888:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="889"/>  889:     ?m(ok, file:make_dir(TargetDir)),
<a name="890"/>  890:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, Sys}])]),
<a name="891"/>  891:     ok = ?m(ok, reltool:create_target([{config, Sys}], TargetDir)),
<a name="892"/>  892: 
<a name="893"/>  893:     %% Start a node
<a name="894"/>  894:     Erl = filename:join([TargetDir, &quot;bin&quot;, &quot;erl&quot;]),
<a name="895"/>  895:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="896"/>  896: 
<a name="897"/>  897: 
<a name="898"/>  898:     %% The ua application has a unicode string as description - check
<a name="899"/>  899:     %% that it is translated correctly.
<a name="900"/>  900:     wait_for_app(Node,ua,50),
<a name="901"/>  901:     Apps = rpc:call(Node,application,which_applications,[]),
<a name="902"/>  902:     ?m({ua,&quot;Application for testing unicode in reltool - &quot;,&quot;1.0&quot;},
<a name="903"/>  903:        lists:keyfind(ua,1,Apps)),
<a name="904"/>  904: 
<a name="905"/>  905:     %% Check that the release name is correct (really only
<a name="906"/>  906:     %% insteresting if file name translation mode is utf8)
<a name="907"/>  907:     [{RelName,_,_,_}] =
<a name="908"/>  908: 	?msym([{_,_,_,_}],rpc:call(Node,release_handler,which_releases,[])),
<a name="909"/>  909:     ?m(true,lists:prefix(RelNamePrefix,RelName)),
<a name="910"/>  910: 
<a name="911"/>  911:     ?msym(ok, stop_node(Node)),
<a name="912"/>  912: 
<a name="create_target_unicode-last_expr"/><a name="913"/>  913:     ok.
<a name="914"/>  914: 
<a name="915"/>  915: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="916"/>  916: <i>%% Generate embedded target system</i>
<a name="917"/>  917: 
<a name="create_embedded-1"/><a name="918"/>  918: <b>create_embedded</b>(_Config) -&gt;
<a name="919"/>  919:     %% Configure the server
<a name="920"/>  920:     RelName1 = &quot;Just testing&quot;,
<a name="921"/>  921:     RelName2 = &quot;Just testing with SASL&quot;,
<a name="922"/>  922:     RelVsn = &quot;1.0&quot;,
<a name="923"/>  923:     Config =
<a name="924"/>  924:         {sys,
<a name="925"/>  925:          [
<a name="926"/>  926:           {lib_dirs, []},
<a name="927"/>  927:           {profile, embedded},
<a name="928"/>  928:           {boot_rel, RelName2},
<a name="929"/>  929:           {rel, RelName1, RelVsn, [stdlib, kernel]},
<a name="930"/>  930:           {rel, RelName2, RelVsn, [sasl, stdlib, kernel]},
<a name="931"/>  931:           {app, sasl, [{incl_cond, include}]}
<a name="932"/>  932:          ]},
<a name="933"/>  933: 
<a name="934"/>  934:     %% Generate target file
<a name="935"/>  935:     TargetDir = filename:join([?WORK_DIR, &quot;target_embedded&quot;]),
<a name="936"/>  936:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="937"/>  937:     ?m(ok, file:make_dir(TargetDir)),
<a name="938"/>  938:     ok = ?m(ok, reltool:create_target([{config, Config}], TargetDir)),
<a name="939"/>  939: 
<a name="940"/>  940:     Erl = filename:join([TargetDir, &quot;bin&quot;, &quot;erl&quot;]),
<a name="941"/>  941:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="942"/>  942:     ?msym(ok, stop_node(Node)),
<a name="943"/>  943:         
<a name="create_embedded-last_expr"/><a name="944"/>  944:     ok.
<a name="945"/>  945: 
<a name="946"/>  946: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="947"/>  947: <i>%% Generate standalone system</i>
<a name="948"/>  948: 
<a name="create_standalone-1"/><a name="949"/>  949: <b>create_standalone</b>(_Config) -&gt;
<a name="950"/>  950:     %% Configure the server
<a name="951"/>  951:     ExDir = code:lib_dir(reltool, examples),
<a name="952"/>  952:     EscriptName = &quot;display_args&quot;,
<a name="953"/>  953:     Escript = filename:join([ExDir, EscriptName]),
<a name="954"/>  954:     Config =
<a name="955"/>  955:         {sys,
<a name="956"/>  956:          [
<a name="957"/>  957:           {lib_dirs, []},
<a name="958"/>  958:           {escript, Escript, [{incl_cond, include}]},
<a name="959"/>  959:           {profile, standalone}
<a name="960"/>  960:          ]},
<a name="961"/>  961: 
<a name="962"/>  962:     %% Generate target file
<a name="963"/>  963:     TargetDir = filename:join([?WORK_DIR, &quot;target_standalone&quot;]),
<a name="964"/>  964:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="965"/>  965:     ?m(ok, file:make_dir(TargetDir)),
<a name="966"/>  966:     ok = ?m(ok, reltool:create_target([{config, Config}], TargetDir)),
<a name="967"/>  967: 
<a name="968"/>  968:     %% Start the target system and fetch root dir
<a name="969"/>  969:     BinDir = filename:join([TargetDir, &quot;bin&quot;]),
<a name="970"/>  970:     Erl = filename:join([BinDir, &quot;erl&quot;]),
<a name="971"/>  971:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)), 
<a name="972"/>  972:     RootDir = ?ignore(rpc:call(Node, code, root_dir, [])),
<a name="973"/>  973:     ?msym(ok, stop_node(Node)),
<a name="974"/>  974:     
<a name="975"/>  975:     %% Execute escript
<a name="976"/>  976:     Expected =  s2b([&quot;Root dir: &quot;, RootDir, &quot;\n&quot;
<a name="977"/>  977: 		     &quot;Script args: [\&quot;-arg1\&quot;,\&quot;arg2\&quot;,\&quot;arg3\&quot;]\n&quot;,
<a name="978"/>  978: 		     &quot;Emuarg: [\&quot;emuvalue\&quot;]\n&quot;,
<a name="979"/>  979: 		     &quot;ExitCode:0&quot;]),
<a name="980"/>  980:     io:format(&quot;Expected: ~ts\n&quot;, [Expected]),
<a name="981"/>  981:     ?m(Expected, run(BinDir, EscriptName, &quot;-arg1 arg2 arg3&quot;)),
<a name="982"/>  982:     
<a name="create_standalone-last_expr"/><a name="983"/>  983:     ok.
<a name="984"/>  984: 
<a name="985"/>  985: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="986"/>  986: <i>%% Generate standalone system with inlined beam file</i>
<a name="987"/>  987: 
<a name="create_standalone_beam-1"/><a name="988"/>  988: <b>create_standalone_beam</b>(Config) -&gt;
<a name="989"/>  989:     %% Read beam file
<a name="990"/>  990:     DataDir = ?config(data_dir,Config),
<a name="991"/>  991:     BeamFile = filename:join([DataDir,escript,&quot;someapp-1.0&quot;,ebin,&quot;mymod.beam&quot;]),
<a name="992"/>  992:     {ok,BeamBin} = file:read_file(BeamFile),
<a name="993"/>  993: 
<a name="994"/>  994:     %% Create the escript
<a name="995"/>  995:     EscriptName = &quot;mymod.escript&quot;,
<a name="996"/>  996:     Escript = filename:join(?WORK_DIR,EscriptName),
<a name="997"/>  997:     ok = escript:create(Escript,[shebang,{beam,BeamBin}]),
<a name="998"/>  998:     ok = file:change_mode(Escript,8#00744),
<a name="999"/>  999: 
<a name="1000"/> 1000:     %% Configure the server
<a name="1001"/> 1001:     Sys =
<a name="1002"/> 1002:         {sys,
<a name="1003"/> 1003:          [
<a name="1004"/> 1004:           {lib_dirs, []},
<a name="1005"/> 1005:           {escript, Escript, [{incl_cond, include}]},
<a name="1006"/> 1006:           {profile, standalone}
<a name="1007"/> 1007:          ]},
<a name="1008"/> 1008: 
<a name="1009"/> 1009:     %% Generate target file
<a name="1010"/> 1010:     TargetDir = filename:join([?WORK_DIR, &quot;target_standalone_beam&quot;]),
<a name="1011"/> 1011:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1012"/> 1012:     ?m(ok, file:make_dir(TargetDir)),
<a name="1013"/> 1013:     ok = ?m(ok, reltool:create_target([{config, Sys}], TargetDir)),
<a name="1014"/> 1014: 
<a name="1015"/> 1015:     %% Start the target system and fetch root dir
<a name="1016"/> 1016:     BinDir = filename:join([TargetDir, &quot;bin&quot;]),
<a name="1017"/> 1017:     Erl = filename:join([BinDir, &quot;erl&quot;]),
<a name="1018"/> 1018:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="1019"/> 1019:     RootDir = ?ignore(rpc:call(Node, code, root_dir, [])),
<a name="1020"/> 1020:     ?msym(ok, stop_node(Node)),
<a name="1021"/> 1021: 
<a name="1022"/> 1022:     %% Execute escript
<a name="1023"/> 1023:     Expected =  s2b([&quot;Module: mymod\n&quot;
<a name="1024"/> 1024: 		     &quot;Root dir: &quot;, RootDir, &quot;\n&quot;
<a name="1025"/> 1025: 		     &quot;Script args: [\&quot;-arg1\&quot;,\&quot;arg2\&quot;,\&quot;arg3\&quot;]\n&quot;,
<a name="1026"/> 1026: 		     &quot;ExitCode:0&quot;]),
<a name="1027"/> 1027:     io:format(&quot;Expected: ~ts\n&quot;, [Expected]),
<a name="1028"/> 1028:     ?m(Expected, run(BinDir, EscriptName, &quot;-arg1 arg2 arg3&quot;)),
<a name="1029"/> 1029: 
<a name="create_standalone_beam-last_expr"/><a name="1030"/> 1030:     ok.
<a name="1031"/> 1031: 
<a name="1032"/> 1032: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1033"/> 1033: <i>%% Generate standalone system with inlined archived application</i>
<a name="1034"/> 1034: 
<a name="create_standalone_app-1"/><a name="1035"/> 1035: <b>create_standalone_app</b>(Config) -&gt;
<a name="1036"/> 1036:     %% Create archive
<a name="1037"/> 1037:     DataDir = ?config(data_dir,Config),
<a name="1038"/> 1038:     EscriptDir = filename:join(DataDir,escript),
<a name="1039"/> 1039:     {ok,{_Archive,Bin}} = zip:create(&quot;someapp-1.0.ez&quot;,[&quot;someapp-1.0&quot;],
<a name="1040"/> 1040: 				     [memory,
<a name="1041"/> 1041: 				      {cwd,EscriptDir},
<a name="1042"/> 1042: 				      {compress,all},
<a name="1043"/> 1043: 				      {uncompress,[&quot;.beam&quot;,&quot;.app&quot;]}]),
<a name="1044"/> 1044: 
<a name="1045"/> 1045:     %% Create the escript
<a name="1046"/> 1046:     EscriptName = &quot;someapp.escript&quot;,
<a name="1047"/> 1047:     Escript = filename:join(?WORK_DIR,EscriptName),
<a name="1048"/> 1048:     ok = escript:create(Escript,[shebang,
<a name="1049"/> 1049: 				 {emu_args,&quot;-escript main mymod&quot;},
<a name="1050"/> 1050: 				 {archive,Bin}]),
<a name="1051"/> 1051:     ok = file:change_mode(Escript,8#00744),
<a name="1052"/> 1052: 
<a name="1053"/> 1053:     %% Configure the server
<a name="1054"/> 1054:     Sys =
<a name="1055"/> 1055:         {sys,
<a name="1056"/> 1056:          [
<a name="1057"/> 1057:           {lib_dirs, []},
<a name="1058"/> 1058:           {escript, Escript, [{incl_cond, include}]},
<a name="1059"/> 1059:           {profile, standalone}
<a name="1060"/> 1060:          ]},
<a name="1061"/> 1061: 
<a name="1062"/> 1062:     %% Generate target file
<a name="1063"/> 1063:     TargetDir = filename:join([?WORK_DIR, &quot;target_standalone_app&quot;]),
<a name="1064"/> 1064:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1065"/> 1065:     ?m(ok, file:make_dir(TargetDir)),
<a name="1066"/> 1066:     ok = ?m(ok, reltool:create_target([{config, Sys}], TargetDir)),
<a name="1067"/> 1067: 
<a name="1068"/> 1068:     %% Start the target system and fetch root dir
<a name="1069"/> 1069:     BinDir = filename:join([TargetDir, &quot;bin&quot;]),
<a name="1070"/> 1070:     Erl = filename:join([BinDir, &quot;erl&quot;]),
<a name="1071"/> 1071:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="1072"/> 1072:     RootDir = ?ignore(rpc:call(Node, code, root_dir, [])),
<a name="1073"/> 1073:     ?msym(ok, stop_node(Node)),
<a name="1074"/> 1074: 
<a name="1075"/> 1075:     %% Execute escript
<a name="1076"/> 1076:     Expected =  s2b([&quot;Module: mymod\n&quot;
<a name="1077"/> 1077: 		     &quot;Root dir: &quot;, RootDir, &quot;\n&quot;
<a name="1078"/> 1078: 		     &quot;Script args: [\&quot;-arg1\&quot;,\&quot;arg2\&quot;,\&quot;arg3\&quot;]\n&quot;,
<a name="1079"/> 1079: 		     &quot;ExitCode:0&quot;]),
<a name="1080"/> 1080:     io:format(&quot;Expected: ~ts\n&quot;, [Expected]),
<a name="1081"/> 1081:     ?m(Expected, run(BinDir, EscriptName, &quot;-arg1 arg2 arg3&quot;)),
<a name="1082"/> 1082: 
<a name="create_standalone_app-last_expr"/><a name="1083"/> 1083:     ok.
<a name="1084"/> 1084: 
<a name="1085"/> 1085: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1086"/> 1086: <i>%% Generate standalone system with inlined archived application</i>
<a name="1087"/> 1087: <i>%% Check that the inlined app cannot be explicitly configured</i>
<a name="1088"/> 1088: 
<a name="create_standalone_app_clash-1"/><a name="1089"/> 1089: <b>create_standalone_app_clash</b>(Config) -&gt;
<a name="1090"/> 1090:     %% Create archive
<a name="1091"/> 1091:     DataDir = ?config(data_dir,Config),
<a name="1092"/> 1092:     EscriptDir = filename:join(DataDir,escript),
<a name="1093"/> 1093:     {ok,{_Archive,Bin}} = zip:create(&quot;someapp-1.0.ez&quot;,[&quot;someapp-1.0&quot;],
<a name="1094"/> 1094: 				     [memory,
<a name="1095"/> 1095: 				      {cwd,EscriptDir},
<a name="1096"/> 1096: 				      {compress,all},
<a name="1097"/> 1097: 				      {uncompress,[&quot;.beam&quot;,&quot;.app&quot;]}]),
<a name="1098"/> 1098: 
<a name="1099"/> 1099:     %% Create the escript
<a name="1100"/> 1100:     EscriptName = &quot;someapp.escript&quot;,
<a name="1101"/> 1101:     Escript = filename:join(?WORK_DIR,EscriptName),
<a name="1102"/> 1102:     ok = escript:create(Escript,[shebang,
<a name="1103"/> 1103: 				 {emu_args,&quot;-escript main mymod&quot;},
<a name="1104"/> 1104: 				 {archive,Bin}]),
<a name="1105"/> 1105:     ok = file:change_mode(Escript,8#00744),
<a name="1106"/> 1106: 
<a name="1107"/> 1107:     %% Configure the server
<a name="1108"/> 1108:     Sys =
<a name="1109"/> 1109:         {sys,
<a name="1110"/> 1110:          [
<a name="1111"/> 1111:           {lib_dirs, []},
<a name="1112"/> 1112:           {escript, Escript, [{incl_cond, include}]},
<a name="1113"/> 1113:           {profile, standalone},
<a name="1114"/> 1114: 	  {app, someapp, [{incl_cond,include}]}
<a name="1115"/> 1115:          ]},
<a name="1116"/> 1116: 
<a name="1117"/> 1117:     ?msym({error,&quot;someapp: Application name clash. Escript &quot;++_},
<a name="1118"/> 1118: 	  reltool:start_server([{config,Sys}])),
<a name="create_standalone_app_clash-last_expr"/><a name="1119"/> 1119:     ok.
<a name="1120"/> 1120: 
<a name="1121"/> 1121: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1122"/> 1122: <i>%% Generate standalone system with multiple escripts</i>
<a name="1123"/> 1123: 
<a name="create_multiple_standalone-1"/><a name="1124"/> 1124: <b>create_multiple_standalone</b>(Config) -&gt;
<a name="1125"/> 1125:     %% First escript
<a name="1126"/> 1126:     ExDir = code:lib_dir(reltool, examples),
<a name="1127"/> 1127:     EscriptName1 = &quot;display_args&quot;,
<a name="1128"/> 1128:     Escript1 = filename:join([ExDir, EscriptName1]),
<a name="1129"/> 1129: 
<a name="1130"/> 1130:     %% Second escript
<a name="1131"/> 1131:     DataDir = ?config(data_dir,Config),
<a name="1132"/> 1132:     BeamFile = filename:join([DataDir,escript,&quot;someapp-1.0&quot;,ebin,&quot;mymod.beam&quot;]),
<a name="1133"/> 1133:     {ok,BeamBin} = file:read_file(BeamFile),
<a name="1134"/> 1134:     EscriptName2 = &quot;mymod.escript&quot;,
<a name="1135"/> 1135:     Escript2 = filename:join(?WORK_DIR,EscriptName2),
<a name="1136"/> 1136:     ok = escript:create(Escript2,[shebang,{beam,BeamBin}]),
<a name="1137"/> 1137:     ok = file:change_mode(Escript2,8#00744),
<a name="1138"/> 1138: 
<a name="1139"/> 1139:     %% Configure server
<a name="1140"/> 1140:     Sys =
<a name="1141"/> 1141:         {sys,
<a name="1142"/> 1142:          [
<a name="1143"/> 1143:           {lib_dirs, []},
<a name="1144"/> 1144:           {escript, Escript1, [{incl_cond, include}]},
<a name="1145"/> 1145:           {escript, Escript2, [{incl_cond, include}]},
<a name="1146"/> 1146:           {profile, standalone}
<a name="1147"/> 1147:          ]},
<a name="1148"/> 1148: 
<a name="1149"/> 1149:     %% Generate target system
<a name="1150"/> 1150:     TargetDir = filename:join([?WORK_DIR, &quot;target_multiple_standalone&quot;]),
<a name="1151"/> 1151:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1152"/> 1152:     ?m(ok, file:make_dir(TargetDir)),
<a name="1153"/> 1153:     ok = ?m(ok, reltool:create_target([{config,Sys}], TargetDir)),
<a name="1154"/> 1154: 
<a name="1155"/> 1155:     %% Start the target system and fetch root dir
<a name="1156"/> 1156:     BinDir = filename:join([TargetDir, &quot;bin&quot;]),
<a name="1157"/> 1157:     Erl = filename:join([BinDir, &quot;erl&quot;]),
<a name="1158"/> 1158:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="1159"/> 1159:     RootDir = ?ignore(rpc:call(Node, code, root_dir, [])),
<a name="1160"/> 1160:     ?msym(ok, stop_node(Node)),
<a name="1161"/> 1161: 
<a name="1162"/> 1162:     %% Execute escript1
<a name="1163"/> 1163:     Expected1 =  s2b([&quot;Root dir: &quot;, RootDir, &quot;\n&quot;
<a name="1164"/> 1164: 		      &quot;Script args: [\&quot;-arg1\&quot;,\&quot;arg2\&quot;,\&quot;arg3\&quot;]\n&quot;,
<a name="1165"/> 1165: 		      &quot;Emuarg: [\&quot;emuvalue\&quot;]\n&quot;,
<a name="1166"/> 1166: 		      &quot;ExitCode:0&quot;]),
<a name="1167"/> 1167:     io:format(&quot;Expected1: ~ts\n&quot;, [Expected1]),
<a name="1168"/> 1168:     ?m(Expected1, run(BinDir, EscriptName1, &quot;-arg1 arg2 arg3&quot;)),
<a name="1169"/> 1169: 
<a name="1170"/> 1170: 
<a name="1171"/> 1171:     %% Execute escript2
<a name="1172"/> 1172:     Expected2 =  s2b([&quot;Module: mymod\n&quot;
<a name="1173"/> 1173: 		      &quot;Root dir: &quot;, RootDir, &quot;\n&quot;
<a name="1174"/> 1174: 		      &quot;Script args: [\&quot;-arg1\&quot;,\&quot;arg2\&quot;,\&quot;arg3\&quot;]\n&quot;,
<a name="1175"/> 1175: 		      &quot;ExitCode:0&quot;]),
<a name="1176"/> 1176:     io:format(&quot;Expected2: ~ts\n&quot;, [Expected2]),
<a name="1177"/> 1177:     ?m(Expected2, run(BinDir, EscriptName2, &quot;-arg1 arg2 arg3&quot;)),
<a name="1178"/> 1178: 
<a name="create_multiple_standalone-last_expr"/><a name="1179"/> 1179:     ok.
<a name="1180"/> 1180: 
<a name="1181"/> 1181: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1182"/> 1182: <i>%% Generate old type of target system</i>
<a name="create_old_target-1"/><a name="1183"/> 1183: <b>create_old_target</b>(_Config) -&gt;
<a name="1184"/> 1184:     
<a name="1185"/> 1185:     %% Configure the server
<a name="1186"/> 1186:     RelName1 = &quot;Just testing&quot;,
<a name="1187"/> 1187:     RelName2 = &quot;Just testing with SASL&quot;,
<a name="1188"/> 1188:     RelVsn = &quot;1.0&quot;,
<a name="1189"/> 1189:     Config =
<a name="1190"/> 1190:         {sys,
<a name="1191"/> 1191:          [
<a name="1192"/> 1192:           {lib_dirs, []},
<a name="1193"/> 1193:           {boot_rel, RelName2},
<a name="1194"/> 1194:           {rel, RelName1, RelVsn, [stdlib, kernel]},
<a name="1195"/> 1195:           {rel, RelName2, RelVsn, [sasl, stdlib, kernel]},
<a name="1196"/> 1196:           {relocatable, false}, % Implies explicit old style installation
<a name="1197"/> 1197:           {app, sasl, [{incl_cond, include}]}
<a name="1198"/> 1198:          ]},
<a name="1199"/> 1199: 
<a name="1200"/> 1200:     %% Generate target file
<a name="1201"/> 1201:     TargetDir = filename:join([?WORK_DIR, &quot;target_old_style&quot;]),
<a name="1202"/> 1202:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1203"/> 1203:     ?m(ok, file:make_dir(TargetDir)),
<a name="1204"/> 1204:     ok = ?m(ok, reltool:create_target([{config, Config}], TargetDir)),
<a name="1205"/> 1205: 
<a name="1206"/> 1206:     ok = ?m(ok, reltool:install(RelName2, TargetDir)),
<a name="1207"/> 1207: 
<a name="1208"/> 1208:     Erl = filename:join([TargetDir, &quot;bin&quot;, &quot;erl&quot;]),
<a name="1209"/> 1209:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="1210"/> 1210:     ?msym(ok, stop_node(Node)),
<a name="1211"/> 1211:     
<a name="create_old_target-last_expr"/><a name="1212"/> 1212:     ok.
<a name="1213"/> 1213: 
<a name="1214"/> 1214: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1215"/> 1215: <i>%% Generate target system</i>
<a name="1216"/> 1216: 
<a name="create_slim-1"/><a name="1217"/> 1217: <b>create_slim</b>(Config) -&gt;
<a name="1218"/> 1218:     %% Configure the server
<a name="1219"/> 1219:     RelName = &quot;slim&quot;,
<a name="1220"/> 1220:     RelVsn = &quot;1.0&quot;,
<a name="1221"/> 1221: 
<a name="1222"/> 1222:     DataDir =  ?config(data_dir,Config),
<a name="1223"/> 1223:     LibDir = filename:join(DataDir,&quot;slim&quot;),
<a name="1224"/> 1224: 
<a name="1225"/> 1225:     Sys =
<a name="1226"/> 1226:         {sys,
<a name="1227"/> 1227:          [
<a name="1228"/> 1228:           {root_dir, code:root_dir()},
<a name="1229"/> 1229:           {lib_dirs, []},
<a name="1230"/> 1230:           {boot_rel, RelName},
<a name="1231"/> 1231:           {rel, RelName, RelVsn, [sasl, stdlib, kernel, a]},
<a name="1232"/> 1232:           {app, sasl, [{incl_cond, include}]},
<a name="1233"/> 1233:           {app, a, [{incl_cond, include},
<a name="1234"/> 1234: 		    {lib_dir,filename:join(LibDir,&quot;a-1.0&quot;)}]},
<a name="1235"/> 1235: 	  {excl_lib,otp_root}
<a name="1236"/> 1236:          ]},
<a name="1237"/> 1237: 
<a name="1238"/> 1238:     %% Generate target file
<a name="1239"/> 1239:     TargetDir = filename:absname(filename:join([?WORK_DIR, &quot;target_slim&quot;])),
<a name="1240"/> 1240:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1241"/> 1241:     ?m(ok, file:make_dir(TargetDir)),
<a name="1242"/> 1242:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, Sys}])]),
<a name="1243"/> 1243:     ok = ?m(ok, reltool:create_target([{config, Sys}], TargetDir)),
<a name="1244"/> 1244: 
<a name="1245"/> 1245:     TargetLibDir = filename:join(TargetDir,&quot;lib&quot;),
<a name="1246"/> 1246:     TargetRelDir = filename:join(TargetDir,&quot;releases&quot;),
<a name="1247"/> 1247:     TargetRelVsnDir = filename:join(TargetRelDir,RelVsn),
<a name="1248"/> 1248: 
<a name="1249"/> 1249:     {ok,[&quot;a-1.0&quot;]} = file:list_dir(TargetLibDir),
<a name="1250"/> 1250: 
<a name="1251"/> 1251:     RootDir = code:root_dir(),
<a name="1252"/> 1252:     Erl = filename:join([RootDir, &quot;bin&quot;, &quot;erl&quot;]),
<a name="1253"/> 1253:     Args = [&quot;-boot_var&quot;, &quot;RELTOOL_EXT_LIB&quot;, TargetLibDir,
<a name="1254"/> 1254: 	    &quot;-boot&quot;, filename:join(TargetRelVsnDir,RelName),
<a name="1255"/> 1255: 	    &quot;-sasl&quot;, &quot;releases_dir&quot;, &quot;\&quot;&quot;++TargetRelDir++&quot;\&quot;&quot;],
<a name="1256"/> 1256:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl, Args)),
<a name="1257"/> 1257:     ?msym(RootDir, rpc:call(Node, code, root_dir, [])),
<a name="1258"/> 1258:     wait_for_app(Node,sasl,50),
<a name="1259"/> 1259:     ?msym([{RelName,RelVsn,_,permanent}],
<a name="1260"/> 1260: 	  rpc:call(Node,release_handler,which_releases,[])),
<a name="1261"/> 1261:     ?msym(ok, stop_node(Node)),
<a name="1262"/> 1262: 
<a name="create_slim-last_expr"/><a name="1263"/> 1263:     ok.
<a name="1264"/> 1264: 
<a name="1265"/> 1265: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1266"/> 1266: <i>%% Generate target system with eval_target_spec/3</i>
<a name="1267"/> 1267: 
<a name="eval_target_spec-1"/><a name="1268"/> 1268: <b>eval_target_spec</b>(_Config) -&gt;
<a name="1269"/> 1269:     %% Configure the server
<a name="1270"/> 1270:     RelName1 = &quot;Just testing&quot;,
<a name="1271"/> 1271:     RelName2 = &quot;Just testing with SASL&quot;,
<a name="1272"/> 1272:     RelVsn = &quot;1.0&quot;,
<a name="1273"/> 1273:     Config =
<a name="1274"/> 1274:         {sys,
<a name="1275"/> 1275:          [
<a name="1276"/> 1276:           {root_dir, code:root_dir()},
<a name="1277"/> 1277:           {lib_dirs, []},
<a name="1278"/> 1278:           {boot_rel, RelName2},
<a name="1279"/> 1279:           {rel, RelName1, RelVsn, [stdlib, kernel]},
<a name="1280"/> 1280:           {rel, RelName2, RelVsn, [sasl, stdlib, kernel]},
<a name="1281"/> 1281:           {app, sasl, [{incl_cond, include}]}
<a name="1282"/> 1282:          ]},
<a name="1283"/> 1283: 
<a name="1284"/> 1284:     %% Generate target file
<a name="1285"/> 1285:     TargetDir = filename:join([?WORK_DIR, &quot;eval_target_spec&quot;]),
<a name="1286"/> 1286:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1287"/> 1287:     ?m(ok, file:make_dir(TargetDir)),
<a name="1288"/> 1288:     {ok, Spec} = ?msym({ok,_}, reltool:get_target_spec([{config, Config}])),
<a name="1289"/> 1289:     ok = ?m(ok, reltool:eval_target_spec(Spec, code:root_dir(), TargetDir)),
<a name="1290"/> 1290: 
<a name="1291"/> 1291:     Erl = filename:join([TargetDir, &quot;bin&quot;, &quot;erl&quot;]),
<a name="1292"/> 1292:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="1293"/> 1293:     ?msym(ok, stop_node(Node)),
<a name="1294"/> 1294: 
<a name="eval_target_spec-last_expr"/><a name="1295"/> 1295:     ok.
<a name="1296"/> 1296: 
<a name="1297"/> 1297: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1298"/> 1298: <i>%% OTP-9229 - handle duplicated module names, i.e. same module name</i>
<a name="1299"/> 1299: <i>%% exists in two applications.</i>
<a name="1300"/> 1300: 
<a name="1301"/> 1301: <i>%% Include on app, exclude the other</i>
<a name="otp_9229_dupl_mod_exclude_app-1"/><a name="1302"/> 1302: <b>otp_9229_dupl_mod_exclude_app</b>(Config) -&gt;
<a name="1303"/> 1303:     DataDir =  ?config(data_dir,Config),
<a name="1304"/> 1304:     LibDir = filename:join(DataDir,&quot;otp_9229&quot;),
<a name="1305"/> 1305: 
<a name="1306"/> 1306:     %% Configure the server
<a name="1307"/> 1307:     ExclApp =
<a name="1308"/> 1308:         {sys,
<a name="1309"/> 1309:          [
<a name="1310"/> 1310:           {root_dir, code:root_dir()},
<a name="1311"/> 1311:           {lib_dirs, [LibDir]},
<a name="1312"/> 1312: 	  {incl_cond,exclude},
<a name="1313"/> 1313: 	  {app,x,[{incl_cond,include}]},
<a name="1314"/> 1314: 	  {app,y,[{incl_cond,exclude}]},
<a name="1315"/> 1315: 	  {app,kernel,[{incl_cond,include}]},
<a name="1316"/> 1316: 	  {app,stdlib,[{incl_cond,include}]},
<a name="1317"/> 1317: 	  {app,sasl,[{incl_cond,include}]}
<a name="1318"/> 1318:          ]},
<a name="1319"/> 1319: 
<a name="1320"/> 1320:     %% Generate target file
<a name="1321"/> 1321:     TargetDir = filename:join([?WORK_DIR, &quot;target_dupl_mod_excl_app&quot;]),
<a name="1322"/> 1322:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1323"/> 1323:     ?m(ok, file:make_dir(TargetDir)),
<a name="1324"/> 1324:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, ExclApp}])]),
<a name="1325"/> 1325:     ?m({ok,[&quot;Module mylib exists in applications x and y. Using module from application x.&quot;]}, reltool:get_status([{config, ExclApp}])),
<a name="1326"/> 1326:     ok = ?m(ok, reltool:create_target([{config, ExclApp}], TargetDir)),
<a name="1327"/> 1327: 
<a name="1328"/> 1328:     Erl = filename:join([TargetDir, &quot;bin&quot;, &quot;erl&quot;]),
<a name="1329"/> 1329:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="1330"/> 1330: 
<a name="1331"/> 1331:     AbsTargetDir = filename:absname(TargetDir),
<a name="1332"/> 1332:     AbsX = filename:join([AbsTargetDir,lib,&quot;x-1.0&quot;]),
<a name="1333"/> 1333:     XEbin = [&quot;ebin&quot;,&quot;x-1.0&quot;],
<a name="1334"/> 1334:     AbsY = filename:join([AbsTargetDir,lib,&quot;y-1.0&quot;]),
<a name="1335"/> 1335: 
<a name="1336"/> 1336:     ?m(true, filelib:is_file(AbsX)),
<a name="1337"/> 1337:     ?m(XEbin, mod_path(Node,x)),
<a name="1338"/> 1338:     ?m(XEbin, mod_path(Node,mylib)),
<a name="1339"/> 1339:     ?m(false, filelib:is_file(AbsY)),
<a name="1340"/> 1340:     ?m(non_existing, mod_path(Node,y)),
<a name="1341"/> 1341: 
<a name="1342"/> 1342:     ?msym(ok, stop_node(Node)),
<a name="1343"/> 1343: 
<a name="otp_9229_dupl_mod_exclude_app-last_expr"/><a name="1344"/> 1344:     ok.
<a name="1345"/> 1345: 
<a name="1346"/> 1346: <i>%% Include both apps, but exclude common module from one app</i>
<a name="otp_9229_dupl_mod_exclude_mod-1"/><a name="1347"/> 1347: <b>otp_9229_dupl_mod_exclude_mod</b>(Config) -&gt;
<a name="1348"/> 1348:     DataDir =  ?config(data_dir,Config),
<a name="1349"/> 1349:     LibDir = filename:join(DataDir,&quot;otp_9229&quot;),
<a name="1350"/> 1350: 
<a name="1351"/> 1351:     %% Configure the server
<a name="1352"/> 1352:     ExclMod =
<a name="1353"/> 1353:         {sys,
<a name="1354"/> 1354:          [
<a name="1355"/> 1355:           {root_dir, code:root_dir()},
<a name="1356"/> 1356:           {lib_dirs, [LibDir]},
<a name="1357"/> 1357: 	  {incl_cond,exclude},
<a name="1358"/> 1358: 	  {app,x,[{incl_cond,include}]},
<a name="1359"/> 1359: 	  {app,y,[{incl_cond,include},{mod, mylib,[{incl_cond,exclude}]}]},
<a name="1360"/> 1360: 	  {app,kernel,[{incl_cond,include}]},
<a name="1361"/> 1361: 	  {app,stdlib,[{incl_cond,include}]},
<a name="1362"/> 1362: 	  {app,sasl,[{incl_cond,include}]}
<a name="1363"/> 1363:          ]},
<a name="1364"/> 1364: 
<a name="1365"/> 1365:     %% Generate target file
<a name="1366"/> 1366:     TargetDir = filename:join([?WORK_DIR, &quot;target_dupl_mod_excl_mod&quot;]),
<a name="1367"/> 1367:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1368"/> 1368:     ?m(ok, file:make_dir(TargetDir)),
<a name="1369"/> 1369:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, ExclMod}])]),
<a name="1370"/> 1370:     ?m({ok,[&quot;Module mylib exists in applications x and y. Using module from application x.&quot;]}, reltool:get_status([{config, ExclMod}])),
<a name="1371"/> 1371:     ok = ?m(ok, reltool:create_target([{config, ExclMod}], TargetDir)),
<a name="1372"/> 1372: 
<a name="1373"/> 1373:     Erl = filename:join([TargetDir, &quot;bin&quot;, &quot;erl&quot;]),
<a name="1374"/> 1374:     {ok, Node} = ?msym({ok, _}, start_node(?NODE_NAME, Erl)),
<a name="1375"/> 1375: 
<a name="1376"/> 1376:     AbsTargetDir = filename:absname(TargetDir),
<a name="1377"/> 1377:     AbsX = filename:join([AbsTargetDir,lib,&quot;x-1.0&quot;]),
<a name="1378"/> 1378:     XEbin = [&quot;ebin&quot;,&quot;x-1.0&quot;],
<a name="1379"/> 1379:     AbsY = filename:join([AbsTargetDir,lib,&quot;y-1.0&quot;]),
<a name="1380"/> 1380:     YEbin = [&quot;ebin&quot;,&quot;y-1.0&quot;],
<a name="1381"/> 1381: 
<a name="1382"/> 1382:     ?m(true, filelib:is_file(AbsX)),
<a name="1383"/> 1383:     ?m(XEbin, mod_path(Node,x)),
<a name="1384"/> 1384:     ?m(XEbin, mod_path(Node,mylib)),
<a name="1385"/> 1385:     ?m(true, filelib:is_file(AbsY)),
<a name="1386"/> 1386:     ?m(YEbin, mod_path(Node,y)),
<a name="1387"/> 1387: 
<a name="1388"/> 1388:     %% Remove path to XEbin and check that mylib is not located in YEbin
<a name="1389"/> 1389:     Mylib = rpc:call(Node,code,which,[mylib]),
<a name="1390"/> 1390:     rpc:call(Node,code,del_path,[filename:dirname(Mylib)]),
<a name="1391"/> 1391:     ?m(non_existing, mod_path(Node,mylib)),
<a name="1392"/> 1392: 
<a name="1393"/> 1393:     ?msym(ok, stop_node(Node)),
<a name="1394"/> 1394: 
<a name="otp_9229_dupl_mod_exclude_mod-last_expr"/><a name="1395"/> 1395:     ok.
<a name="1396"/> 1396: 
<a name="1397"/> 1397: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1398"/> 1398: <i>%% Test that if a module is duplicated in a .app file, then a warning</i>
<a name="1399"/> 1399: <i>%% is produced, but target can still be created.</i>
<a name="dupl_mod_in_app_file-1"/><a name="1400"/> 1400: <b>dupl_mod_in_app_file</b>(Config) -&gt;
<a name="1401"/> 1401:     DataDir =  ?config(data_dir,Config),
<a name="1402"/> 1402:     LibDir = filename:join(DataDir,&quot;dupl_mod&quot;),
<a name="1403"/> 1403: 
<a name="1404"/> 1404:     %% Configure the server
<a name="1405"/> 1405:     Sys =
<a name="1406"/> 1406:         {sys,
<a name="1407"/> 1407:          [
<a name="1408"/> 1408:           {lib_dirs, [LibDir]},
<a name="1409"/> 1409: 	  {incl_cond,exclude},
<a name="1410"/> 1410: 	  {app,a,[{incl_cond,include}]},
<a name="1411"/> 1411: 	  {app,kernel,[{incl_cond,include}]},
<a name="1412"/> 1412: 	  {app,stdlib,[{incl_cond,include}]},
<a name="1413"/> 1413: 	  {app,sasl,[{incl_cond,include}]}
<a name="1414"/> 1414:          ]},
<a name="1415"/> 1415: 
<a name="1416"/> 1416:     %% Generate target file
<a name="1417"/> 1417:     TargetDir = filename:join([?WORK_DIR, &quot;target_dupl_mod_in_app_file&quot;]),
<a name="1418"/> 1418:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1419"/> 1419:     ?m(ok, file:make_dir(TargetDir)),
<a name="1420"/> 1420:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, Sys}])]),
<a name="1421"/> 1421:     ?m({ok,[&quot;Module a duplicated in app file for application a.&quot;]},
<a name="1422"/> 1422:        reltool:get_status([{config, Sys}])),
<a name="1423"/> 1423: 
<a name="1424"/> 1424:     %%! test that only one module installed (in spec)
<a name="1425"/> 1425: 
<a name="dupl_mod_in_app_file-last_expr"/><a name="1426"/> 1426:     ok.
<a name="1427"/> 1427: 
<a name="1428"/> 1428: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1429"/> 1429: <i>%% Test that a reasonable error message is returned if an application</i>
<a name="1430"/> 1430: <i>%% is missing</i>
<a name="include_non_existing_app-1"/><a name="1431"/> 1431: <b>include_non_existing_app</b>(_Config) -&gt;
<a name="1432"/> 1432:     %% Configure the server
<a name="1433"/> 1433:     Sys =
<a name="1434"/> 1434:         {sys,
<a name="1435"/> 1435:          [
<a name="1436"/> 1436:           {incl_cond,exclude},
<a name="1437"/> 1437:           {app,foobar,[{incl_cond,include}]},
<a name="1438"/> 1438:           {app,kernel,[{incl_cond,include}]},
<a name="1439"/> 1439:           {app,stdlib,[{incl_cond,include}]},
<a name="1440"/> 1440:           {app,sasl,[{incl_cond,include}]}
<a name="1441"/> 1441:          ]},
<a name="1442"/> 1442: 
<a name="1443"/> 1443:     %% Generate target file
<a name="1444"/> 1444:     TargetDir = filename:join([?WORK_DIR, &quot;target_include_non_existing_app&quot;]),
<a name="1445"/> 1445:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1446"/> 1446:     ?m(ok, file:make_dir(TargetDir)),
<a name="1447"/> 1447:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, Sys}])]),
<a name="1448"/> 1448:     ?m({error,&quot;foobar: Missing application directory.&quot;},
<a name="1449"/> 1449:        reltool:get_status([{config, Sys}])),
<a name="1450"/> 1450: 
<a name="include_non_existing_app-last_expr"/><a name="1451"/> 1451:     ok.
<a name="1452"/> 1452: 
<a name="1453"/> 1453: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1454"/> 1454: <i>%% Test that if a missing application is explicitly excluded a warning</i>
<a name="1455"/> 1455: <i>%% should be issued.</i>
<a name="exclude_non_existing_app-1"/><a name="1456"/> 1456: <b>exclude_non_existing_app</b>(_Config) -&gt;
<a name="1457"/> 1457:     %% Configure the server
<a name="1458"/> 1458:     Sys =
<a name="1459"/> 1459:         {sys,
<a name="1460"/> 1460:          [
<a name="1461"/> 1461:           {incl_cond,exclude},
<a name="1462"/> 1462:           {app,foobar,[{incl_cond,exclude}]},
<a name="1463"/> 1463:           {app,kernel,[{incl_cond,include}]},
<a name="1464"/> 1464:           {app,stdlib,[{incl_cond,include}]},
<a name="1465"/> 1465:           {app,sasl,[{incl_cond,include}]}
<a name="1466"/> 1466:          ]},
<a name="1467"/> 1467: 
<a name="1468"/> 1468:     %% Generate target file
<a name="1469"/> 1469:     TargetDir = filename:join([?WORK_DIR, &quot;target_exclude_non_existing_app&quot;]),
<a name="1470"/> 1470:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="1471"/> 1471:     ?m(ok, file:make_dir(TargetDir)),
<a name="1472"/> 1472:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, Sys}])]),
<a name="1473"/> 1473:     ?m({ok,[&quot;foobar: Missing application directory.&quot;]},
<a name="1474"/> 1474:        reltool:get_status([{config, Sys}])),
<a name="1475"/> 1475: 
<a name="exclude_non_existing_app-last_expr"/><a name="1476"/> 1476:     ok.
<a name="1477"/> 1477: 
<a name="1478"/> 1478: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1479"/> 1479: <i>%% Test the interface used by the GUI:</i>
<a name="1480"/> 1480: <i>%%  get_app</i>
<a name="1481"/> 1481: <i>%%  get_apps</i>
<a name="1482"/> 1482: <i>%%  set_app</i>
<a name="1483"/> 1483: <i>%%  set_apps</i>
<a name="1484"/> 1484: <i>%%  load_config</i>
<a name="1485"/> 1485: <i>%%  reset_config</i>
<a name="1486"/> 1486: <i>%%</i>
<a name="1487"/> 1487: <i>%% Also, for each operation which manipulates the config, test</i>
<a name="1488"/> 1488: <i>%% get_status and undo_config.</i>
<a name="1489"/> 1489: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="get_apps-1"/><a name="1490"/> 1490: <b>get_apps</b>(_Config) -&gt;
<a name="1491"/> 1491:     Sys = {sys,[{app,kernel,[{incl_cond,include}]},
<a name="1492"/> 1492: 		{app,sasl,[{incl_cond,include}]},
<a name="1493"/> 1493: 		{app,stdlib,[{incl_cond,include}]},
<a name="1494"/> 1494: 		{app,tools,[{incl_cond,derived}]},
<a name="1495"/> 1495: 		{app,runtime_tools,[{incl_cond,exclude}]}]},
<a name="1496"/> 1496:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="1497"/> 1497: 
<a name="1498"/> 1498:     {ok,Sasl} = ?msym({ok,#app{name=sasl}}, reltool_server:get_app(Pid,sasl)),
<a name="1499"/> 1499:     {ok,[#app{name=kernel},
<a name="1500"/> 1500: 	 #app{name=sasl}=Sasl,
<a name="1501"/> 1501: 	 #app{name=stdlib}] = White} =
<a name="1502"/> 1502: 	?msym({ok,_}, reltool_server:get_apps(Pid,whitelist)),
<a name="1503"/> 1503:     {ok,[#app{name=runtime_tools}] = Black} =
<a name="1504"/> 1504: 	?msym({ok,_}, reltool_server:get_apps(Pid,blacklist)),
<a name="1505"/> 1505: 
<a name="1506"/> 1506:     {ok,Derived} = ?msym({ok,_}, reltool_server:get_apps(Pid,derived)),
<a name="1507"/> 1507:     true = lists:keymember(tools,#app.name,Derived),
<a name="1508"/> 1508: 
<a name="1509"/> 1509:     {ok,Source} = ?msym({ok,_}, reltool_server:get_apps(Pid,source)),
<a name="1510"/> 1510:     true = lists:keymember(common_test,#app.name,Source),
<a name="1511"/> 1511: 
<a name="1512"/> 1512:     %% Check that the four lists are disjoint
<a name="1513"/> 1513:     Number = length(White) + length(Black) + length(Derived) + length(Source),
<a name="1514"/> 1514:     WN = lists:usort([N || #app{name=N} &lt;- White]),
<a name="1515"/> 1515:     BN = lists:usort([N || #app{name=N} &lt;- Black]),
<a name="1516"/> 1516:     DN = lists:usort([N || #app{name=N} &lt;- Derived]),
<a name="1517"/> 1517:     SN = lists:usort([N || #app{name=N} &lt;- Source]),
<a name="1518"/> 1518:     AllN = lists:umerge([WN,BN,DN,SN]),
<a name="1519"/> 1519:     ?m(Number,length(AllN)),
<a name="1520"/> 1520: 
<a name="1521"/> 1521:     ?m(ok, reltool:stop(Pid)),
<a name="get_apps-last_expr"/><a name="1522"/> 1522:     ok.
<a name="1523"/> 1523: 
<a name="1524"/> 1524: 
<a name="1525"/> 1525: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="get_mod-1"/><a name="1526"/> 1526: <b>get_mod</b>(_Config) -&gt;
<a name="1527"/> 1527:     Sys = {sys,[{app,kernel,[{incl_cond,include}]},
<a name="1528"/> 1528: 		{app,sasl,[{incl_cond,include}]},
<a name="1529"/> 1529: 		{app,stdlib,[{incl_cond,include}]},
<a name="1530"/> 1530: 		{app,tools,[{incl_cond,derived}]},
<a name="1531"/> 1531: 		{app,runtime_tools,[{incl_cond,exclude}]}]},
<a name="1532"/> 1532:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="1533"/> 1533: 
<a name="1534"/> 1534:     %% Read app and get a module from the #app record
<a name="1535"/> 1535:     {ok,Tools} = ?msym({ok,#app{name=tools}}, reltool_server:get_app(Pid,tools)),
<a name="1536"/> 1536:     Cover = lists:keyfind(cover,#mod.name,Tools#app.mods),
<a name="1537"/> 1537: 
<a name="1538"/> 1538:     %% get_mod - and check that it is equal to the one in #app.mods
<a name="1539"/> 1539:     ?m({ok,Cover}, reltool_server:get_mod(Pid,cover)),
<a name="1540"/> 1540: 
<a name="1541"/> 1541:     ?m(ok, reltool:stop(Pid)),
<a name="get_mod-last_expr"/><a name="1542"/> 1542:     ok.
<a name="1543"/> 1543: 
<a name="1544"/> 1544: 
<a name="1545"/> 1545: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="get_sys-1"/><a name="1546"/> 1546: <b>get_sys</b>(_Config) -&gt;
<a name="1547"/> 1547:     Sys = {sys,[{app,kernel,[{incl_cond,include}]},
<a name="1548"/> 1548: 		{app,sasl,[{incl_cond,include}]},
<a name="1549"/> 1549: 		{app,stdlib,[{incl_cond,include}]},
<a name="1550"/> 1550: 		{app,tools,[{incl_cond,derived}]},
<a name="1551"/> 1551: 		{app,runtime_tools,[{incl_cond,exclude}]}]},
<a name="1552"/> 1552:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="1553"/> 1553: 
<a name="1554"/> 1554:     RootDir = code:root_dir(),
<a name="1555"/> 1555:     ?msym({ok,#sys{root_dir=RootDir,apps=undefined}},reltool_server:get_sys(Pid)),
<a name="1556"/> 1556: 
<a name="1557"/> 1557:     ?m(ok, reltool:stop(Pid)),
<a name="get_sys-last_expr"/><a name="1558"/> 1558:     ok.
<a name="1559"/> 1559: 
<a name="1560"/> 1560: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="set_app_and_undo-1"/><a name="1561"/> 1561: <b>set_app_and_undo</b>(Config) -&gt;
<a name="1562"/> 1562:     Sys = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;faulty_app_file&quot;)]},
<a name="1563"/> 1563: 		{incl_cond, exclude},
<a name="1564"/> 1564: 		{app,a,[{incl_cond,include}]},
<a name="1565"/> 1565: 		{app,kernel,[{incl_cond,include}]},
<a name="1566"/> 1566: 		{app,sasl,[{incl_cond,include}]},
<a name="1567"/> 1567: 		{app,stdlib,[{incl_cond,include}]},
<a name="1568"/> 1568: 		{app,tools,[{incl_cond,include}]}]},
<a name="1569"/> 1569:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="1570"/> 1570:     ?m({ok, Sys}, reltool:get_config(Pid)),
<a name="1571"/> 1571:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="1572"/> 1572: 
<a name="1573"/> 1573:     %% Get app and mod
<a name="1574"/> 1574:     {ok,Tools} = ?msym({ok,_}, reltool_server:get_app(Pid,tools)),
<a name="1575"/> 1575:     {ok,Cover} = ?msym({ok,#mod{name=cover, is_included=true}},
<a name="1576"/> 1576: 		       reltool_server:get_mod(Pid,cover)),
<a name="1577"/> 1577: 
<a name="1578"/> 1578:     %% Exclude one module with set_app
<a name="1579"/> 1579:     ExclCover = Cover#mod{incl_cond=exclude},
<a name="1580"/> 1580:     Mods = Tools#app.mods,
<a name="1581"/> 1581:     Tools1 = Tools#app{mods = lists:keyreplace(cover,#mod.name,Mods,ExclCover)},
<a name="1582"/> 1582:     {ok,ToolsNoCover,[&quot;a: Cannot parse app file&quot;++_|_]} =
<a name="1583"/> 1583: 	?msym({ok,_,[&quot;a: Cannot parse app file&quot;++_|_]},
<a name="1584"/> 1584: 	      reltool_server:set_app(Pid,Tools1)),
<a name="1585"/> 1585:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]}, reltool_server:get_status(Pid)),
<a name="1586"/> 1586: 
<a name="1587"/> 1587:     %% Check that the module is no longer included
<a name="1588"/> 1588:     ?m({ok,ToolsNoCover}, reltool_server:get_app(Pid,tools)),
<a name="1589"/> 1589:     {ok,NoIncludeCover} = ?msym({ok,#mod{name=cover, is_included=false}},
<a name="1590"/> 1590: 				reltool_server:get_mod(Pid,cover)),
<a name="1591"/> 1591: 
<a name="1592"/> 1592:     %% Undo
<a name="1593"/> 1593:     ?m(ok, reltool_server:undo_config(Pid)),
<a name="1594"/> 1594:     ?m({ok,Tools}, reltool_server:get_app(Pid,tools)),
<a name="1595"/> 1595:     ?m({ok,Cover}, reltool_server:get_mod(Pid,cover)),
<a name="1596"/> 1596:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]}, reltool_server:get_status(Pid)),
<a name="1597"/> 1597: 
<a name="1598"/> 1598:     %% Undo again, to check that it toggles
<a name="1599"/> 1599:     ?msym(ok, reltool_server:undo_config(Pid)),
<a name="1600"/> 1600:     ?m({ok,ToolsNoCover}, reltool_server:get_app(Pid,tools)),
<a name="1601"/> 1601:     ?m({ok,NoIncludeCover}, reltool_server:get_mod(Pid,cover)),
<a name="1602"/> 1602:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]}, reltool_server:get_status(Pid)),
<a name="1603"/> 1603: 
<a name="1604"/> 1604:     ?m(ok, reltool:stop(Pid)),
<a name="set_app_and_undo-last_expr"/><a name="1605"/> 1605:     ok.
<a name="1606"/> 1606: 
<a name="1607"/> 1607: 
<a name="1608"/> 1608: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="set_apps_and_undo-1"/><a name="1609"/> 1609: <b>set_apps_and_undo</b>(Config) -&gt;
<a name="1610"/> 1610:     Sys = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;faulty_app_file&quot;)]},
<a name="1611"/> 1611: 		{incl_cond, exclude},
<a name="1612"/> 1612: 		{app,kernel,[{incl_cond,include}]},
<a name="1613"/> 1613: 		{app,sasl,[{incl_cond,include}]},
<a name="1614"/> 1614: 		{app,stdlib,[{incl_cond,include}]},
<a name="1615"/> 1615: 		{app,tools,[{incl_cond,include}]}]},
<a name="1616"/> 1616:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="1617"/> 1617:     ?m({ok, Sys}, reltool:get_config(Pid)),
<a name="1618"/> 1618:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="1619"/> 1619: 
<a name="1620"/> 1620:     %% Get app and mod
<a name="1621"/> 1621:     {ok,Tools} = ?msym({ok,_}, reltool_server:get_app(Pid,tools)),
<a name="1622"/> 1622:     ?m(true, Tools#app.is_pre_included),
<a name="1623"/> 1623:     ?m(true, Tools#app.is_included),
<a name="1624"/> 1624:     {ok,Cover} = ?msym({ok,#mod{name=cover, is_included=true}},
<a name="1625"/> 1625: 		       reltool_server:get_mod(Pid,cover)),
<a name="1626"/> 1626: 
<a name="1627"/> 1627:     %% Exclude one application with set_apps
<a name="1628"/> 1628:     ExclTools = Tools#app{incl_cond=exclude},
<a name="1629"/> 1629:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},
<a name="1630"/> 1630:        reltool_server:set_apps(Pid,[ExclTools])),
<a name="1631"/> 1631:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]}, reltool_server:get_status(Pid)),
<a name="1632"/> 1632: 
<a name="1633"/> 1633:     %% Check that the app and its modules (one of them) are no longer included
<a name="1634"/> 1634:     {ok,NoTools} = ?msym({ok,_}, reltool_server:get_app(Pid,tools)),
<a name="1635"/> 1635:     ?m(false, NoTools#app.is_pre_included),
<a name="1636"/> 1636:     ?m(false, NoTools#app.is_included),
<a name="1637"/> 1637:     {ok,NoIncludeCover} = ?msym({ok,#mod{name=cover, is_included=false}},
<a name="1638"/> 1638: 				reltool_server:get_mod(Pid,cover)),
<a name="1639"/> 1639: 
<a name="1640"/> 1640:     %% Undo
<a name="1641"/> 1641:     ?m(ok, reltool_server:undo_config(Pid)),
<a name="1642"/> 1642:     ?m({ok,Tools}, reltool_server:get_app(Pid,tools)),
<a name="1643"/> 1643:     ?m({ok,Cover}, reltool_server:get_mod(Pid,cover)),
<a name="1644"/> 1644:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="1645"/> 1645: 
<a name="1646"/> 1646:     %% Undo again, to check that it toggles
<a name="1647"/> 1647:     ?m(ok, reltool_server:undo_config(Pid)),
<a name="1648"/> 1648:     ?m({ok,NoTools}, reltool_server:get_app(Pid,tools)),
<a name="1649"/> 1649:     ?m({ok,NoIncludeCover}, reltool_server:get_mod(Pid,cover)),
<a name="1650"/> 1650:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]}, reltool_server:get_status(Pid)),
<a name="1651"/> 1651: 
<a name="1652"/> 1652:     ?m(ok, reltool:stop(Pid)),
<a name="set_apps_and_undo-last_expr"/><a name="1653"/> 1653:     ok.
<a name="1654"/> 1654: 
<a name="1655"/> 1655: 
<a name="1656"/> 1656: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1657"/> 1657: <i>%% Test that escript can be configured, but not its inlined applications</i>
<a name="set_apps_inlined-1"/><a name="1658"/> 1658: <b>set_apps_inlined</b>(Config) -&gt;
<a name="1659"/> 1659:     %% Create archive
<a name="1660"/> 1660:     DataDir = ?config(data_dir,Config),
<a name="1661"/> 1661:     EscriptDir = filename:join(DataDir,escript),
<a name="1662"/> 1662:     {ok,{_Archive,Bin}} = zip:create(&quot;someapp-1.0.ez&quot;,[&quot;someapp-1.0&quot;],
<a name="1663"/> 1663: 				     [memory,
<a name="1664"/> 1664: 				      {cwd,EscriptDir},
<a name="1665"/> 1665: 				      {compress,all},
<a name="1666"/> 1666: 				      {uncompress,[&quot;.beam&quot;,&quot;.app&quot;]}]),
<a name="1667"/> 1667: 
<a name="1668"/> 1668:     %% Create the escript
<a name="1669"/> 1669:     EscriptName = &quot;someapp.escript&quot;,
<a name="1670"/> 1670:     Escript = filename:join(?WORK_DIR,EscriptName),
<a name="1671"/> 1671:     ok = escript:create(Escript,[shebang,
<a name="1672"/> 1672: 				 {emu_args,&quot;-escript main mymod&quot;},
<a name="1673"/> 1673: 				 {archive,Bin}]),
<a name="1674"/> 1674:     ok = file:change_mode(Escript,8#00744),
<a name="1675"/> 1675: 
<a name="1676"/> 1676:     %% Configure the server
<a name="1677"/> 1677:     Sys = {sys,[{incl_cond, exclude},
<a name="1678"/> 1678: 		{escript,Escript,[]},
<a name="1679"/> 1679: 		{app,kernel,[{incl_cond,include}]},
<a name="1680"/> 1680: 		{app,sasl,[{incl_cond,include}]},
<a name="1681"/> 1681: 		{app,stdlib,[{incl_cond,include}]}]},
<a name="1682"/> 1682:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="1683"/> 1683:     ?msym({ok,[]},reltool_server:get_status(Pid)),
<a name="1684"/> 1684: 
<a name="1685"/> 1685:     %% Get app and mod
<a name="1686"/> 1686:     {ok,EApp} = ?msym({ok,_}, reltool_server:get_app(Pid,'*escript* someapp')),
<a name="1687"/> 1687:     {ok,Someapp} = ?msym({ok,_}, reltool_server:get_app(Pid,someapp)),
<a name="1688"/> 1688:     ?m(undefined, EApp#app.incl_cond),
<a name="1689"/> 1689:     ?m(undefined, Someapp#app.incl_cond),
<a name="1690"/> 1690:     ?m(false, Someapp#app.is_included),
<a name="1691"/> 1691:     ?m(false, Someapp#app.is_pre_included),
<a name="1692"/> 1692: 
<a name="1693"/> 1693:     %% Include escript
<a name="1694"/> 1694:     EApp1 = EApp#app{incl_cond=include},
<a name="1695"/> 1695:     ?m({ok,[]}, reltool_server:set_apps(Pid,[EApp1])),
<a name="1696"/> 1696:     ExpectedEApp = EApp1#app{is_included=true,is_pre_included=true},
<a name="1697"/> 1697:     ?m({ok,ExpectedEApp}, reltool_server:get_app(Pid,'*escript* someapp')),
<a name="1698"/> 1698:     {ok,Someapp1} = ?msym({ok,_}, reltool_server:get_app(Pid,someapp)),
<a name="1699"/> 1699:     ?m(include, Someapp1#app.incl_cond),
<a name="1700"/> 1700:     ?m(true, Someapp1#app.is_included),
<a name="1701"/> 1701:     ?m(true, Someapp1#app.is_pre_included),
<a name="1702"/> 1702: 
<a name="1703"/> 1703:     %% Check that inlined app cannot be configured
<a name="1704"/> 1704:     Someapp2 = Someapp1#app{incl_cond=exclude},
<a name="1705"/> 1705:     ?msym({error,
<a name="1706"/> 1706: 	   &quot;Application someapp is inlined in '*escript* someapp'. &quot;
<a name="1707"/> 1707: 	   &quot;Can not change configuration for an inlined application.&quot;},
<a name="1708"/> 1708: 	  reltool_server:set_apps(Pid,[Someapp2])),
<a name="1709"/> 1709:     ?m({ok,Someapp1}, reltool_server:get_app(Pid,someapp)),
<a name="1710"/> 1710: 
<a name="1711"/> 1711:     %% Exclude escript
<a name="1712"/> 1712:     {ok,EApp2} = ?msym({ok,_}, reltool_server:get_app(Pid,'*escript* someapp')),
<a name="1713"/> 1713:     EApp3 = EApp2#app{incl_cond=exclude},
<a name="1714"/> 1714:     ?m({ok,[]}, reltool_server:set_apps(Pid,[EApp3])),
<a name="1715"/> 1715:     ExpectedEApp3 = EApp3#app{is_included=false,is_pre_included=false},
<a name="1716"/> 1716:     ?m({ok,ExpectedEApp3}, reltool_server:get_app(Pid,'*escript* someapp')),
<a name="1717"/> 1717:     {ok,Someapp3} = ?msym({ok,_}, reltool_server:get_app(Pid,someapp)),
<a name="1718"/> 1718:     ?m(exclude, Someapp3#app.incl_cond),
<a name="1719"/> 1719:     ?m(false, Someapp3#app.is_included),
<a name="1720"/> 1720:     ?m(false, Someapp3#app.is_pre_included),
<a name="1721"/> 1721: 
<a name="1722"/> 1722:     ?m(ok, reltool:stop(Pid)),
<a name="set_apps_inlined-last_expr"/><a name="1723"/> 1723:     ok.
<a name="1724"/> 1724: 
<a name="1725"/> 1725: 
<a name="1726"/> 1726: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="set_sys_and_undo-1"/><a name="1727"/> 1727: <b>set_sys_and_undo</b>(Config) -&gt;
<a name="1728"/> 1728:     Sys1 = {sys,[{incl_cond, exclude},
<a name="1729"/> 1729: 		 {app,kernel,[{incl_cond,include}]},
<a name="1730"/> 1730: 		 {app,sasl,[{incl_cond,include}]},
<a name="1731"/> 1731: 		 {app,stdlib,[{incl_cond,include}]},
<a name="1732"/> 1732: 		 {app,tools,[{incl_cond,include}]}]},
<a name="1733"/> 1733:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys1}])),
<a name="1734"/> 1734:     ?m({ok,[]}, reltool_server:get_status(Pid)),
<a name="1735"/> 1735: 
<a name="1736"/> 1736:     %% Read sys record
<a name="1737"/> 1737:     {ok, SysRec} = reltool_server:get_sys(Pid),
<a name="1738"/> 1738: 
<a name="1739"/> 1739:     %% Set lib dirs by call to set_sys
<a name="1740"/> 1740:     NewLib = filename:join(datadir(Config),&quot;faulty_app_file&quot;),
<a name="1741"/> 1741:     NewLibDirs = [NewLib | SysRec#sys.lib_dirs],
<a name="1742"/> 1742:     NewSysRec = SysRec#sys{lib_dirs=NewLibDirs},
<a name="1743"/> 1743:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},
<a name="1744"/> 1744: 	  reltool_server:set_sys(Pid, NewSysRec)),
<a name="1745"/> 1745:     ?m({ok,NewSysRec}, reltool_server:get_sys(Pid)),
<a name="1746"/> 1746:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="1747"/> 1747: 
<a name="1748"/> 1748:     %% Undo
<a name="1749"/> 1749:     ?m(ok, reltool_server:undo_config(Pid)),
<a name="1750"/> 1750:     ?m({ok,SysRec}, reltool_server:get_sys(Pid)),
<a name="1751"/> 1751:     ?m({ok,[]}, reltool_server:get_status(Pid)),
<a name="1752"/> 1752: 
<a name="1753"/> 1753:     %% Undo again, to check that it toggles
<a name="1754"/> 1754:     ?m(ok,reltool_server:undo_config(Pid)),
<a name="1755"/> 1755:     ?m({ok,NewSysRec}, reltool_server:get_sys(Pid)),
<a name="1756"/> 1756:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="1757"/> 1757: 
<a name="1758"/> 1758:     ?m(ok, reltool:stop(Pid)),
<a name="set_sys_and_undo-last_expr"/><a name="1759"/> 1759:     ok.
<a name="1760"/> 1760: 
<a name="1761"/> 1761: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="load_config_and_undo-1"/><a name="1762"/> 1762: <b>load_config_and_undo</b>(Config) -&gt;
<a name="1763"/> 1763:     Sys1 = {sys,Cfg1=[{incl_cond, exclude},
<a name="1764"/> 1764:                       {app,kernel,[{incl_cond,include}]},
<a name="1765"/> 1765:                       {app,sasl,[{incl_cond,include}]},
<a name="1766"/> 1766:                       {app,stdlib,[{incl_cond,include}]},
<a name="1767"/> 1767:                       {app,tools,[{incl_cond,include}]}]},
<a name="1768"/> 1768:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys1}])),
<a name="1769"/> 1769:     Libs = reltool_test_lib:erl_libs(),
<a name="1770"/> 1770:     Sys11 =
<a name="1771"/> 1771:         case Libs of
<a name="1772"/> 1772:             [] -&gt; Sys1;
<a name="1773"/> 1773:             _  -&gt; {sys, [{lib_dirs, Libs}|Cfg1]}
<a name="1774"/> 1774:         end,
<a name="1775"/> 1775:     ?m({ok, Sys11}, reltool:get_config(Pid)),
<a name="1776"/> 1776:     ?m({ok,[]}, reltool_server:get_status(Pid)),
<a name="1777"/> 1777: 
<a name="1778"/> 1778:     %% Get app and mod
<a name="1779"/> 1779:     {ok,Tools1} = ?msym({ok,_}, reltool_server:get_app(Pid,tools)),
<a name="1780"/> 1780:     ?m(true, Tools1#app.is_pre_included),
<a name="1781"/> 1781:     ?m(true, Tools1#app.is_included),
<a name="1782"/> 1782:     {ok,Cover1} = ?msym({ok,#mod{name=cover,
<a name="1783"/> 1783: 				 is_included=true,
<a name="1784"/> 1784: 				 is_pre_included=true}},
<a name="1785"/> 1785: 			reltool_server:get_mod(Pid,cover)),
<a name="1786"/> 1786: 
<a name="1787"/> 1787:     %% Change tools from include to derived by loading new config
<a name="1788"/> 1788:     Sys2 = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;faulty_app_file&quot;)]},
<a name="1789"/> 1789: 		 {app,a,[{incl_cond,include}]},
<a name="1790"/> 1790: 		 {app,kernel,[{incl_cond,include}]},
<a name="1791"/> 1791: 		 {app,sasl,[{incl_cond,include}]},
<a name="1792"/> 1792: 		 {app,stdlib,[{incl_cond,include}]},
<a name="1793"/> 1793: 		 {app,tools,[{incl_cond,derived}]}]},
<a name="1794"/> 1794:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},
<a name="1795"/> 1795: 	  reltool_server:load_config(Pid,Sys2)),
<a name="1796"/> 1796: <i>%%% OTP-0702, 15)    ?m({ok, Sys2}, reltool:get_config(Pid)),</i>
<a name="1797"/> 1797: <i>%%% Note that {incl_cond,exclude} is removed compared to Sys1 -</i>
<a name="1798"/> 1798: <i>%%% config is merged, not overwritten - is this correct???</i>
<a name="1799"/> 1799:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="1800"/> 1800: 
<a name="1801"/> 1801:     %% Check that tools is included (since it is used by sasl) but not
<a name="1802"/> 1802:     %% pre-included (neither included or excluded =&gt; undefined)
<a name="1803"/> 1803:     {ok,Tools2} = ?msym({ok,_}, reltool_server:get_app(Pid,tools)),
<a name="1804"/> 1804:     ?m(undefined, Tools2#app.is_pre_included),
<a name="1805"/> 1805:     ?m(true, Tools2#app.is_included),
<a name="1806"/> 1806:     {ok,Cover2} = ?msym({ok,#mod{name=cover,
<a name="1807"/> 1807: 				 is_included=true,
<a name="1808"/> 1808: 				 is_pre_included=undefined}},
<a name="1809"/> 1809: 			reltool_server:get_mod(Pid,cover)),
<a name="1810"/> 1810: 
<a name="1811"/> 1811:     %% Undo
<a name="1812"/> 1812:     ?m(ok, reltool_server:undo_config(Pid)),
<a name="1813"/> 1813:     ?m({ok,Tools1}, reltool_server:get_app(Pid,tools)),
<a name="1814"/> 1814:     ?m({ok,Cover1}, reltool_server:get_mod(Pid,cover)),
<a name="1815"/> 1815:     ?m({ok,[]}, reltool_server:get_status(Pid)),
<a name="1816"/> 1816: 
<a name="1817"/> 1817:     %% Undo again, to check that it toggles
<a name="1818"/> 1818:     ?m(ok, reltool_server:undo_config(Pid)),
<a name="1819"/> 1819:     ?m({ok,Tools2}, reltool_server:get_app(Pid,tools)),
<a name="1820"/> 1820:     ?m({ok,Cover2}, reltool_server:get_mod(Pid,cover)),
<a name="1821"/> 1821:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="1822"/> 1822: 
<a name="1823"/> 1823:     ?m(ok, reltool:stop(Pid)),
<a name="load_config_and_undo-last_expr"/><a name="1824"/> 1824:     ok.
<a name="1825"/> 1825: 
<a name="1826"/> 1826: 
<a name="1827"/> 1827: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1828"/> 1828: <i>%% Test that load_config is properly rolled back if it fails</i>
<a name="load_config_fail-1"/><a name="1829"/> 1829: <b>load_config_fail</b>(_Config) -&gt;
<a name="1830"/> 1830:     Sys1 = {sys,Cfg1=[{incl_cond, exclude},
<a name="1831"/> 1831:                       {app,kernel,[{incl_cond,include}]},
<a name="1832"/> 1832:                       {app,sasl,[{incl_cond,include}]},
<a name="1833"/> 1833:                       {app,stdlib,[{incl_cond,include}]},
<a name="1834"/> 1834:                       {app,tools,[{incl_cond,include}]}]},
<a name="1835"/> 1835:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys1}])),
<a name="1836"/> 1836:     Libs = reltool_test_lib:erl_libs(),
<a name="1837"/> 1837:     Sys11 =
<a name="1838"/> 1838:         case Libs of
<a name="1839"/> 1839:             [] -&gt; Sys1;
<a name="1840"/> 1840:             _  -&gt; {sys, [{lib_dirs, Libs}|Cfg1]}
<a name="1841"/> 1841:         end,
<a name="1842"/> 1842:     ?m({ok, Sys11}, reltool:get_config(Pid)),
<a name="1843"/> 1843:     ?m({ok,[]}, reltool_server:get_status(Pid)),
<a name="1844"/> 1844: 
<a name="1845"/> 1845:     %% Get app and mod
<a name="1846"/> 1846:     {ok,Tools} = ?msym({ok,_}, reltool_server:get_app(Pid,tools)),
<a name="1847"/> 1847: 
<a name="1848"/> 1848:     %% Try to load a config with a faulty rel statement (includes a
<a name="1849"/> 1849:     %% non-existing application)
<a name="1850"/> 1850:     Sys2 = {sys,[{incl_cond, exclude},
<a name="1851"/> 1851: 		 {boot_rel, &quot;faulty_rel&quot;},
<a name="1852"/> 1852: 		 {rel, &quot;faulty_rel&quot;, &quot;1.0&quot;, [kernel, sasl, stdlib, xxx]},
<a name="1853"/> 1853: 		 {app,kernel,[{incl_cond,include}]},
<a name="1854"/> 1854: 		 {app,sasl,[{incl_cond,include}]},
<a name="1855"/> 1855: 		 {app,stdlib,[{incl_cond,include}]}]},
<a name="1856"/> 1856:     ?msym({error,&quot;Release \&quot;faulty_rel\&quot; uses non existing application xxx&quot;},
<a name="1857"/> 1857: 	  reltool_server:load_config(Pid,Sys2)),
<a name="1858"/> 1858: 
<a name="1859"/> 1859:     %% Check that a rollback is done to the old configuration
<a name="1860"/> 1860:     ?m({ok, Sys11}, reltool:get_config(Pid,false,false)),
<a name="1861"/> 1861: 
<a name="1862"/> 1862:     %% and that tools is not changed (i.e. that the new configuration
<a name="1863"/> 1863:     %% is not applied)
<a name="1864"/> 1864:     ?m({ok,Tools}, reltool_server:get_app(Pid,tools)),
<a name="1865"/> 1865: 
<a name="1866"/> 1866:     ?m(ok, reltool:stop(Pid)),
<a name="load_config_fail-last_expr"/><a name="1867"/> 1867:     ok.
<a name="1868"/> 1868: 
<a name="1869"/> 1869: 
<a name="1870"/> 1870: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1871"/> 1871: <i>%% Load config with escript</i>
<a name="1872"/> 1872: 
<a name="load_config_escript_path-1"/><a name="1873"/> 1873: <b>load_config_escript_path</b>(Config) -&gt;
<a name="1874"/> 1874:     %% Create escript
<a name="1875"/> 1875:     DataDir = ?config(data_dir,Config),
<a name="1876"/> 1876:     BeamFile = filename:join([DataDir,escript,&quot;someapp-1.0&quot;,ebin,&quot;mymod.beam&quot;]),
<a name="1877"/> 1877:     {ok,BeamBin} = file:read_file(BeamFile),
<a name="1878"/> 1878:     EscriptName = &quot;mymod.escript&quot;,
<a name="1879"/> 1879:     Escript = filename:join(?WORK_DIR,EscriptName),
<a name="1880"/> 1880:     ok = escript:create(Escript,[shebang,{beam,BeamBin}]),
<a name="1881"/> 1881:     ok = file:change_mode(Escript,8#00744),
<a name="1882"/> 1882: 
<a name="1883"/> 1883:     %% Start reltool_server with one escript in configuration
<a name="1884"/> 1884:     EscriptSys =
<a name="1885"/> 1885:         {sys,
<a name="1886"/> 1886:          [
<a name="1887"/> 1887:           {lib_dirs, []},
<a name="1888"/> 1888:           {escript, Escript, [{incl_cond, include}]},
<a name="1889"/> 1889:           {profile, standalone}
<a name="1890"/> 1890:          ]},
<a name="1891"/> 1891: 
<a name="1892"/> 1892:     {ok, Pid1} = ?msym({ok, _}, reltool:start_server([{config, EscriptSys}])),
<a name="1893"/> 1893:     {ok,[#app{name='*escript* mymod'}=A]} =
<a name="1894"/> 1894: 	?msym({ok,[_]}, reltool_server:get_apps(Pid1,whitelist)),
<a name="1895"/> 1895:     ?m(ok, reltool:stop(Pid1)),
<a name="1896"/> 1896: 
<a name="1897"/> 1897: 
<a name="1898"/> 1898:     %% Do same again, but now start reltool first with simple config,
<a name="1899"/> 1899:     %% then add escript by loading new configuration and check that
<a name="1900"/> 1900:     %% #app is the same
<a name="1901"/> 1901:     SimpleSys =
<a name="1902"/> 1902:         {sys,
<a name="1903"/> 1903:          [
<a name="1904"/> 1904:           {lib_dirs, []}
<a name="1905"/> 1905:          ]},
<a name="1906"/> 1906: 
<a name="1907"/> 1907:     {ok, Pid2} = ?msym({ok, _}, reltool:start_server([{config, SimpleSys}])),
<a name="1908"/> 1908:     ?m({ok,[]}, reltool_server:get_apps(Pid2,whitelist)),
<a name="1909"/> 1909:     ?m({ok,[]}, reltool_server:load_config(Pid2,EscriptSys)),
<a name="1910"/> 1910:     ?m({ok,[A]}, reltool_server:get_apps(Pid2,whitelist)),
<a name="1911"/> 1911: 
<a name="1912"/> 1912:     ?m(ok, reltool:stop(Pid2)),
<a name="1913"/> 1913: 
<a name="load_config_escript_path-last_expr"/><a name="1914"/> 1914:     ok.
<a name="1915"/> 1915: 
<a name="1916"/> 1916: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1917"/> 1917: <i>%% Load config with same (source) escript twice and check that the</i>
<a name="1918"/> 1918: <i>%% application information is not changed.</i>
<a name="1919"/> 1919: 
<a name="load_config_same_escript_source-1"/><a name="1920"/> 1920: <b>load_config_same_escript_source</b>(_Config) -&gt;
<a name="1921"/> 1921:     %% Create escript
<a name="1922"/> 1922:     ExDir = code:lib_dir(reltool, examples),
<a name="1923"/> 1923:     EscriptName = &quot;display_args&quot;,
<a name="1924"/> 1924:     Escript = filename:join([ExDir, EscriptName]),
<a name="1925"/> 1925: 
<a name="1926"/> 1926:     %% Start reltool_server with one escript in configuration
<a name="1927"/> 1927:     Sys =
<a name="1928"/> 1928:         {sys,
<a name="1929"/> 1929:          [
<a name="1930"/> 1930:           {lib_dirs, []},
<a name="1931"/> 1931:           {escript, Escript, [{incl_cond, include}]},
<a name="1932"/> 1932:           {profile, standalone}
<a name="1933"/> 1933:          ]},
<a name="1934"/> 1934: 
<a name="1935"/> 1935:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="1936"/> 1936: <i>%    {ok,[#app{name='*escript* display_args'}]} =</i>
<a name="1937"/> 1937:     ?msym({ok,[#app{name='*escript* display_args',mods=[_]}]},
<a name="1938"/> 1938: 	  reltool_server:get_apps(Pid,whitelist)),
<a name="1939"/> 1939: 
<a name="1940"/> 1940:     %% Load the same config again, then check that app is not changed
<a name="1941"/> 1941:     ?m({ok,[]}, reltool_server:load_config(Pid,Sys)),
<a name="1942"/> 1942:     ?msym({ok,[#app{name='*escript* display_args',mods=[_]}]},
<a name="1943"/> 1943: 	  reltool_server:get_apps(Pid,whitelist)),
<a name="1944"/> 1944: 
<a name="1945"/> 1945:     ?m(ok, reltool:stop(Pid)),
<a name="1946"/> 1946: 
<a name="load_config_same_escript_source-last_expr"/><a name="1947"/> 1947:     ok.
<a name="1948"/> 1948: 
<a name="1949"/> 1949: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1950"/> 1950: <i>%% Load config with same (beam) escript twice and check that the</i>
<a name="1951"/> 1951: <i>%% application information is not changed.</i>
<a name="1952"/> 1952: 
<a name="load_config_same_escript_beam-1"/><a name="1953"/> 1953: <b>load_config_same_escript_beam</b>(Config) -&gt;
<a name="1954"/> 1954:     %% Create escript
<a name="1955"/> 1955:     DataDir = ?config(data_dir,Config),
<a name="1956"/> 1956:     BeamFile = filename:join([DataDir,escript,&quot;someapp-1.0&quot;,ebin,&quot;mymod.beam&quot;]),
<a name="1957"/> 1957:     {ok,BeamBin} = file:read_file(BeamFile),
<a name="1958"/> 1958:     EscriptName = &quot;mymod.escript&quot;,
<a name="1959"/> 1959:     Escript = filename:join(?WORK_DIR,EscriptName),
<a name="1960"/> 1960:     ok = escript:create(Escript,[shebang,{beam,BeamBin}]),
<a name="1961"/> 1961:     ok = file:change_mode(Escript,8#00744),
<a name="1962"/> 1962: 
<a name="1963"/> 1963:     %% Start reltool_server with one escript in configuration
<a name="1964"/> 1964:     Sys =
<a name="1965"/> 1965:         {sys,
<a name="1966"/> 1966:          [
<a name="1967"/> 1967:           {lib_dirs, []},
<a name="1968"/> 1968:           {escript, Escript, [{incl_cond, include}]},
<a name="1969"/> 1969:           {profile, standalone}
<a name="1970"/> 1970:          ]},
<a name="1971"/> 1971: 
<a name="1972"/> 1972:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="1973"/> 1973:     {ok,[#app{name='*escript* mymod'}=A]} =
<a name="1974"/> 1974: 	?msym({ok,[_]}, reltool_server:get_apps(Pid,whitelist)),
<a name="1975"/> 1975: 
<a name="1976"/> 1976:     %% Load the same config again, then check that app is not changed
<a name="1977"/> 1977:     ?m({ok,[]}, reltool_server:load_config(Pid,Sys)),
<a name="1978"/> 1978:     ?m({ok,[A]}, reltool_server:get_apps(Pid,whitelist)),
<a name="1979"/> 1979: 
<a name="1980"/> 1980:     ?m(ok, reltool:stop(Pid)),
<a name="1981"/> 1981: 
<a name="load_config_same_escript_beam-last_expr"/><a name="1982"/> 1982:     ok.
<a name="1983"/> 1983: 
<a name="1984"/> 1984: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1985"/> 1985: <i>%% Load config with escript</i>
<a name="1986"/> 1986: 
<a name="load_config_add_escript-1"/><a name="1987"/> 1987: <b>load_config_add_escript</b>(Config) -&gt;
<a name="1988"/> 1988:     %% First escript
<a name="1989"/> 1989:     ExDir = code:lib_dir(reltool, examples),
<a name="1990"/> 1990:     EscriptName1 = &quot;display_args&quot;,
<a name="1991"/> 1991:     Escript1 = filename:join([ExDir, EscriptName1]),
<a name="1992"/> 1992: 
<a name="1993"/> 1993:     %% Second escript
<a name="1994"/> 1994:     DataDir = ?config(data_dir,Config),
<a name="1995"/> 1995:     BeamFile = filename:join([DataDir,escript,&quot;someapp-1.0&quot;,ebin,&quot;mymod.beam&quot;]),
<a name="1996"/> 1996:     {ok,BeamBin} = file:read_file(BeamFile),
<a name="1997"/> 1997:     EscriptName2 = &quot;mymod.escript&quot;,
<a name="1998"/> 1998:     Escript2 = filename:join(?WORK_DIR,EscriptName2),
<a name="1999"/> 1999:     ok = escript:create(Escript2,[shebang,{beam,BeamBin}]),
<a name="2000"/> 2000:     ok = file:change_mode(Escript2,8#00744),
<a name="2001"/> 2001: 
<a name="2002"/> 2002:     %% Start reltool_server with one escript in configuration
<a name="2003"/> 2003:     Sys1 =
<a name="2004"/> 2004:         {sys,
<a name="2005"/> 2005:          [
<a name="2006"/> 2006:           {lib_dirs, []},
<a name="2007"/> 2007:           {escript, Escript2, [{incl_cond, include}]},
<a name="2008"/> 2008:           {profile, standalone}
<a name="2009"/> 2009:          ]},
<a name="2010"/> 2010: 
<a name="2011"/> 2011:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys1}])),
<a name="2012"/> 2012: 
<a name="2013"/> 2013:     %% Add second escript by loading new configuration
<a name="2014"/> 2014:     Sys2 =
<a name="2015"/> 2015:         {sys,
<a name="2016"/> 2016:          [
<a name="2017"/> 2017:           {lib_dirs, []},
<a name="2018"/> 2018:           {escript, Escript1, [{incl_cond, include}]},
<a name="2019"/> 2019:           {escript, Escript2, [{incl_cond, include}]},
<a name="2020"/> 2020:           {profile, standalone}
<a name="2021"/> 2021:          ]},
<a name="2022"/> 2022: 
<a name="2023"/> 2023:     {ok,[]} = ?m({ok,[]}, reltool_server:load_config(Pid,Sys2)),
<a name="2024"/> 2024:     {ok,[#app{name='*escript* display_args'},
<a name="2025"/> 2025: 	 #app{name='*escript* mymod'}]} =
<a name="2026"/> 2026: 	?msym({ok,[_,_]}, reltool_server:get_apps(Pid,whitelist)),
<a name="2027"/> 2027: 
<a name="2028"/> 2028:     ?m(ok, reltool:stop(Pid)),
<a name="2029"/> 2029: 
<a name="load_config_add_escript-last_expr"/><a name="2030"/> 2030:     ok.
<a name="2031"/> 2031: 
<a name="2032"/> 2032: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="reset_config_and_undo-1"/><a name="2033"/> 2033: <b>reset_config_and_undo</b>(Config) -&gt;
<a name="2034"/> 2034:     Sys1 = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;faulty_app_file&quot;)]},
<a name="2035"/> 2035: 		 {incl_cond, exclude},
<a name="2036"/> 2036: 		 {app,a,[{incl_cond,include}]},
<a name="2037"/> 2037: 		 {app,kernel,[{incl_cond,include}]},
<a name="2038"/> 2038: 		 {app,sasl,[{incl_cond,include}]},
<a name="2039"/> 2039: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2040"/> 2040: 		 {app,tools,[{incl_cond,include}]}]},
<a name="2041"/> 2041:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys1}])),
<a name="2042"/> 2042:     ?m({ok, Sys1}, reltool:get_config(Pid)),
<a name="2043"/> 2043:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="2044"/> 2044: 
<a name="2045"/> 2045:     %% Get app and mod
<a name="2046"/> 2046:     {ok,Tools1} = ?msym({ok,_}, reltool_server:get_app(Pid,tools)),
<a name="2047"/> 2047:     ?m(true, Tools1#app.is_pre_included),
<a name="2048"/> 2048:     ?m(true, Tools1#app.is_included),
<a name="2049"/> 2049:     {ok,Cover1} = ?msym({ok,#mod{name=cover,
<a name="2050"/> 2050: 				 is_included=true,
<a name="2051"/> 2051: 				 is_pre_included=true}},
<a name="2052"/> 2052: 			reltool_server:get_mod(Pid,cover)),
<a name="2053"/> 2053: 
<a name="2054"/> 2054:     %% Exclude tools by loading new config
<a name="2055"/> 2055:     Sys2 = {sys,[{incl_cond, exclude},
<a name="2056"/> 2056: 		 {app,kernel,[{incl_cond,include}]},
<a name="2057"/> 2057: 		 {app,sasl,[{incl_cond,include}]},
<a name="2058"/> 2058: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2059"/> 2059: 		 {app,tools,[{incl_cond,exclude}]}]},
<a name="2060"/> 2060:     ?m({ok,[]}, reltool_server:load_config(Pid,Sys2)),
<a name="2061"/> 2061:     ?m({ok,[]}, reltool_server:get_status(Pid)),
<a name="2062"/> 2062: 
<a name="2063"/> 2063:     %% Check that tools is excluded
<a name="2064"/> 2064:     {ok,Tools2} = ?msym({ok,_}, reltool_server:get_app(Pid,tools)),
<a name="2065"/> 2065:     ?m(false, Tools2#app.is_pre_included),
<a name="2066"/> 2066:     ?m(false, Tools2#app.is_included),
<a name="2067"/> 2067:     {ok,Cover2} = ?msym({ok,#mod{name=cover,
<a name="2068"/> 2068: 				 is_included=false,
<a name="2069"/> 2069: 				 is_pre_included=false}},
<a name="2070"/> 2070: 			reltool_server:get_mod(Pid,cover)),
<a name="2071"/> 2071: 
<a name="2072"/> 2072:     %% Reset
<a name="2073"/> 2073:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:reset_config(Pid)),
<a name="2074"/> 2074:     ?m({ok,Tools1}, reltool_server:get_app(Pid,tools)),
<a name="2075"/> 2075:     ?m({ok,Cover1}, reltool_server:get_mod(Pid,cover)),
<a name="2076"/> 2076:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="2077"/> 2077: 
<a name="2078"/> 2078:     %% Undo
<a name="2079"/> 2079:     ?m(ok, reltool_server:undo_config(Pid)),
<a name="2080"/> 2080:     ?m({ok,Tools2}, reltool_server:get_app(Pid,tools)),
<a name="2081"/> 2081:     ?m({ok,Cover2}, reltool_server:get_mod(Pid,cover)),
<a name="2082"/> 2082:     ?m({ok,[]}, reltool_server:get_status(Pid)),
<a name="2083"/> 2083: 
<a name="2084"/> 2084:     %% Undo again, to check that it toggles
<a name="2085"/> 2085:     ?m(ok, reltool_server:undo_config(Pid)),
<a name="2086"/> 2086:     ?m({ok,Tools1}, reltool_server:get_app(Pid,tools)),
<a name="2087"/> 2087:     ?m({ok,Cover1}, reltool_server:get_mod(Pid,cover)),
<a name="2088"/> 2088:     ?msym({ok,[&quot;a: Cannot parse app file&quot;++_]},reltool_server:get_status(Pid)),
<a name="2089"/> 2089: 
<a name="2090"/> 2090:     ?m(ok, reltool:stop(Pid)),
<a name="reset_config_and_undo-last_expr"/><a name="2091"/> 2091:     ok.
<a name="2092"/> 2092: 
<a name="2093"/> 2093: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="gen_rel_files-1"/><a name="2094"/> 2094: <b>gen_rel_files</b>(_Config) -&gt;
<a name="2095"/> 2095:     %% Configure the server
<a name="2096"/> 2096:     RelName = &quot;gen_fel_files_test&quot;,
<a name="2097"/> 2097:     RelVsn = &quot;1.0&quot;,
<a name="2098"/> 2098:     Sys =
<a name="2099"/> 2099:         {sys,
<a name="2100"/> 2100:          [
<a name="2101"/> 2101:           {lib_dirs, []},
<a name="2102"/> 2102:           {boot_rel, RelName},
<a name="2103"/> 2103:           {rel, RelName, RelVsn, [kernel, stdlib]}
<a name="2104"/> 2104:          ]},
<a name="2105"/> 2105:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="2106"/> 2106: 
<a name="2107"/> 2107:     %% Generate .rel, .script and .boot
<a name="2108"/> 2108:     Dir = filename:join(?WORK_DIR,&quot;gen_rel_files&quot;),
<a name="2109"/> 2109:     ok = file:make_dir(Dir),
<a name="2110"/> 2110:     ?m({ok,[]}, reltool_server:gen_rel_files(Pid,Dir)),
<a name="2111"/> 2111: 
<a name="2112"/> 2112:     Script = RelName ++ &quot;.script&quot;,
<a name="2113"/> 2113:     Rel = RelName ++ &quot;.rel&quot;,
<a name="2114"/> 2114:     Boot = RelName ++ &quot;.boot&quot;,
<a name="2115"/> 2115:     {ok,Files} = ?msym({ok,_}, file:list_dir(Dir)),
<a name="2116"/> 2116:     [Boot,Rel,Script] = lists:sort(Files),
<a name="2117"/> 2117: 
<a name="2118"/> 2118:     %% Check that contents is reasonable
<a name="2119"/> 2119:     {ok,[S]} = ?msym({ok,[{script,_,_}]},file:consult(filename:join(Dir,Script))),
<a name="2120"/> 2120:     ?msym({ok,[{release,_,_,_}]}, file:consult(filename:join(Dir,Rel))),
<a name="2121"/> 2121:     {ok,Bin} = ?msym({ok,_}, file:read_file(filename:join(Dir,Boot))),
<a name="2122"/> 2122:     ?m(S,binary_to_term(Bin)),
<a name="2123"/> 2123: 
<a name="2124"/> 2124:     ?m(ok, reltool:stop(Pid)),
<a name="gen_rel_files-last_expr"/><a name="2125"/> 2125:     ok.
<a name="2126"/> 2126: 
<a name="2127"/> 2127: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="save_config-1"/><a name="2128"/> 2128: <b>save_config</b>(Config) -&gt;
<a name="2129"/> 2129:     PrivDir = ?config(priv_dir,Config),
<a name="2130"/> 2130:     Sys = {sys,Cfg=[{incl_cond, exclude},
<a name="2131"/> 2131:                     {app,kernel,[{incl_cond,include}]},
<a name="2132"/> 2132:                     {app,sasl,[{incl_cond,include}]},
<a name="2133"/> 2133:                     {app,stdlib,[{incl_cond,include}]}]},
<a name="2134"/> 2134:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="2135"/> 2135:     Libs = reltool_test_lib:erl_libs(),
<a name="2136"/> 2136:     Sys1 =
<a name="2137"/> 2137:         case Libs of
<a name="2138"/> 2138:             [] -&gt; Sys;
<a name="2139"/> 2139:             _  -&gt; {sys, [{lib_dirs, Libs}|Cfg]}
<a name="2140"/> 2140:         end,
<a name="2141"/> 2141:     ?m({ok, Sys1}, reltool:get_config(Pid)),
<a name="2142"/> 2142: 
<a name="2143"/> 2143:     Simple = filename:join(PrivDir,&quot;save_simple.reltool&quot;),
<a name="2144"/> 2144:     ?m(ok, reltool_server:save_config(Pid,Simple,false,false)),
<a name="2145"/> 2145:     ?m({ok,[Sys1]}, file:consult(Simple)),
<a name="2146"/> 2146: 
<a name="2147"/> 2147:     Derivates = filename:join(PrivDir,&quot;save_derivates.reltool&quot;),
<a name="2148"/> 2148:     ?m(ok, reltool_server:save_config(Pid,Derivates,false,true)),
<a name="2149"/> 2149:     case Libs of
<a name="2150"/> 2150:         [] -&gt;
<a name="2151"/> 2151:             ?msym({ok,[{sys,[{incl_cond, exclude},
<a name="2152"/> 2152:                              {erts,[]},
<a name="2153"/> 2153:                              {app,kernel,[{incl_cond,include},{mod,_,[]}|_]},
<a name="2154"/> 2154:                              {app,sasl,[{incl_cond,include},{mod,_,[]}|_]},
<a name="2155"/> 2155:                              {app,stdlib,[{incl_cond,include},{mod,_,[]}|_]}]}]},
<a name="2156"/> 2156:                   file:consult(Derivates));
<a name="2157"/> 2157:         _ -&gt;
<a name="2158"/> 2158:             ?msym({ok,[{sys,[{lib_dirs,Libs},
<a name="2159"/> 2159:                              {incl_cond, exclude},
<a name="2160"/> 2160:                              {erts,[]},
<a name="2161"/> 2161:                              {app,kernel,[{incl_cond,include},{mod,_,[]}|_]},
<a name="2162"/> 2162:                              {app,sasl,[{incl_cond,include},{mod,_,[]}|_]},
<a name="2163"/> 2163:                              {app,stdlib,[{incl_cond,include},{mod,_,[]}|_]}]}]},
<a name="2164"/> 2164:                   file:consult(Derivates))
<a name="2165"/> 2165:     end,
<a name="2166"/> 2166: 
<a name="2167"/> 2167:     Defaults = filename:join(PrivDir,&quot;save_defaults.reltool&quot;),
<a name="2168"/> 2168:     ?m(ok, reltool_server:save_config(Pid,Defaults,true,false)),
<a name="2169"/> 2169:     ?msym({ok,[{sys,[{root_dir,_},
<a name="2170"/> 2170: 		     {lib_dirs,_},
<a name="2171"/> 2171: 		     {mod_cond,all},
<a name="2172"/> 2172: 		     {incl_cond,exclude},
<a name="2173"/> 2173: 		     {app,kernel,[{incl_cond,include},{vsn,undefined},
<a name="2174"/> 2174: 				  {lib_dir,undefined}]},
<a name="2175"/> 2175: 		     {app,sasl,[{incl_cond,include},{vsn,undefined},
<a name="2176"/> 2176: 				{lib_dir,undefined}]},
<a name="2177"/> 2177: 		     {app,stdlib,[{incl_cond,include},{vsn,undefined},
<a name="2178"/> 2178: 				  {lib_dir,undefined}]},
<a name="2179"/> 2179: 		     {boot_rel,&quot;start_clean&quot;},
<a name="2180"/> 2180:                      {rel,&quot;no_dot_erlang&quot;,&quot;1.0&quot;,[],[{load_dot_erlang,false}]},
<a name="2181"/> 2181: 		     {rel,&quot;start_clean&quot;,&quot;1.0&quot;,[],[{load_dot_erlang,true}]},
<a name="2182"/> 2182: 		     {rel,&quot;start_sasl&quot;,&quot;1.0&quot;,[sasl],[{load_dot_erlang,true}]},
<a name="2183"/> 2183: 		     {emu_name,&quot;beam&quot;},
<a name="2184"/> 2184: 		     {relocatable,true},
<a name="2185"/> 2185: 		     {profile,development},
<a name="2186"/> 2186: 		     {incl_sys_filters,[&quot;.*&quot;]},
<a name="2187"/> 2187: 		     {excl_sys_filters,[]},
<a name="2188"/> 2188: 		     {incl_app_filters,[&quot;.*&quot;]},
<a name="2189"/> 2189: 		     {excl_app_filters,[]},
<a name="2190"/> 2190: 		     {rel_app_type,permanent},
<a name="2191"/> 2191: 		     {app_file,keep},
<a name="2192"/> 2192: 		     {debug_info,keep}]}]},
<a name="2193"/> 2193: 	  file:consult(Defaults)),
<a name="2194"/> 2194: 
<a name="2195"/> 2195:     KVsn = latest(kernel),
<a name="2196"/> 2196:     StdVsn = latest(stdlib),
<a name="2197"/> 2197:     SaslVsn = latest(sasl),
<a name="2198"/> 2198: 
<a name="2199"/> 2199:     LibDir = code:lib_dir(),
<a name="2200"/> 2200:     KLibDir = filename:join(LibDir,&quot;kernel-&quot;++KVsn),
<a name="2201"/> 2201:     StdLibDir = filename:join(LibDir,&quot;stdlib-&quot;++StdVsn),
<a name="2202"/> 2202:     SaslLibDir = filename:join(LibDir,&quot;sasl-&quot;++SaslVsn),
<a name="2203"/> 2203: 
<a name="2204"/> 2204:     All = filename:join(PrivDir,&quot;save_all.reltool&quot;),
<a name="2205"/> 2205:     ?m(ok, reltool_server:save_config(Pid,All,true,true)),
<a name="2206"/> 2206:     ?msym({ok,[{sys,[{root_dir,_},
<a name="2207"/> 2207: 		     {lib_dirs,_},
<a name="2208"/> 2208: 		     {mod_cond,all},
<a name="2209"/> 2209: 		     {incl_cond,exclude},
<a name="2210"/> 2210: 		     {erts,[]},
<a name="2211"/> 2211: 		     {app,kernel,[{incl_cond,include},{vsn,KVsn},
<a name="2212"/> 2212: 				  {lib_dir,KLibDir},{mod,_,[]}|_]},
<a name="2213"/> 2213: 		     {app,sasl,[{incl_cond,include},{vsn,SaslVsn},
<a name="2214"/> 2214: 				{lib_dir,SaslLibDir},{mod,_,[]}|_]},
<a name="2215"/> 2215: 		     {app,stdlib,[{incl_cond,include},{vsn,StdVsn},
<a name="2216"/> 2216: 				  {lib_dir,StdLibDir},{mod,_,[]}|_]},
<a name="2217"/> 2217: 		     {boot_rel,&quot;start_clean&quot;},
<a name="2218"/> 2218:                      {rel,&quot;no_dot_erlang&quot;,&quot;1.0&quot;,[],[{load_dot_erlang,false}]},
<a name="2219"/> 2219: 		     {rel,&quot;start_clean&quot;,&quot;1.0&quot;,[],[{load_dot_erlang,true}]},
<a name="2220"/> 2220: 		     {rel,&quot;start_sasl&quot;,&quot;1.0&quot;,[sasl],[{load_dot_erlang,true}]},
<a name="2221"/> 2221: 		     {emu_name,&quot;beam&quot;},
<a name="2222"/> 2222: 		     {relocatable,true},
<a name="2223"/> 2223: 		     {profile,development},
<a name="2224"/> 2224: 		     {incl_sys_filters,[&quot;.*&quot;]},
<a name="2225"/> 2225: 		     {excl_sys_filters,[]},
<a name="2226"/> 2226: 		     {incl_app_filters,[&quot;.*&quot;]},
<a name="2227"/> 2227: 		     {excl_app_filters,[]},
<a name="2228"/> 2228: 		     {rel_app_type,permanent},
<a name="2229"/> 2229: 		     {app_file,keep},
<a name="2230"/> 2230: 		     {debug_info,keep}]}]},
<a name="2231"/> 2231: 	  file:consult(All)),
<a name="2232"/> 2232: 
<a name="2233"/> 2233:     ?m(ok, reltool:stop(Pid)),
<a name="save_config-last_expr"/><a name="2234"/> 2234:     ok.
<a name="2235"/> 2235: 
<a name="2236"/> 2236: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2237"/> 2237: <i>%% Test calculation of dependencies</i>
<a name="2238"/> 2238: <i>%% The following test applications are used</i>
<a name="2239"/> 2239: <i>%%</i>
<a name="2240"/> 2240: <i>%% x-1.0: x1.erl   x2.erl   x3.erl</i>
<a name="2241"/> 2241: <i>%%                   \        /         (x2 calls y1, x3 calls y2)</i>
<a name="2242"/> 2242: <i>%% y-1.0: y0.erl    y1.erl   y2.erl</i>
<a name="2243"/> 2243: <i>%%                    \                 (y1 calls z1)</i>
<a name="2244"/> 2244: <i>%% z-1.0            z1.erl</i>
<a name="2245"/> 2245: <i>%%</i>
<a name="2246"/> 2246: <i>%% Test includes x and derives y and z.</i>
<a name="2247"/> 2247: <i>%%</i>
<a name="dependencies-1"/><a name="2248"/> 2248: <b>dependencies</b>(Config) -&gt;
<a name="2249"/> 2249:     %% Default: all modules included =&gt; y and z are included (derived)
<a name="2250"/> 2250:     Sys = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;dependencies&quot;)]},
<a name="2251"/> 2251: 		{incl_cond, exclude},
<a name="2252"/> 2252: 		{app,kernel,[{incl_cond,include}]},
<a name="2253"/> 2253: 		{app,sasl,[{incl_cond,include}]},
<a name="2254"/> 2254: 		{app,stdlib,[{incl_cond,include}]},
<a name="2255"/> 2255: 		{app,x,[{incl_cond,include}]},
<a name="2256"/> 2256: 		{app,y,[{incl_cond,derived}]},
<a name="2257"/> 2257: 		{app,z,[{incl_cond,derived}]}]},
<a name="2258"/> 2258:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="2259"/> 2259: 
<a name="2260"/> 2260:     ?msym({ok,[#app{name=kernel},
<a name="2261"/> 2261: 	       #app{name=sasl},
<a name="2262"/> 2262: 	       #app{name=stdlib},
<a name="2263"/> 2263: 	       #app{name=x,uses_apps=[y]}]},
<a name="2264"/> 2264: 	  reltool_server:get_apps(Pid,whitelist)),
<a name="2265"/> 2265:     {ok, Der} = ?msym({ok,_},
<a name="2266"/> 2266: 		      reltool_server:get_apps(Pid,derived)),
<a name="2267"/> 2267:     ?msym([#app{name=y,uses_apps=[z]},
<a name="2268"/> 2268: 	   #app{name=z}],
<a name="2269"/> 2269: 	  rm_missing_app(Der)),
<a name="2270"/> 2270:     ?msym({ok,[]},
<a name="2271"/> 2271: 	  reltool_server:get_apps(Pid,source)),
<a name="2272"/> 2272: 
<a name="2273"/> 2273:     %% Excluding x2 =&gt; y still included since y2 is used by x3
<a name="2274"/> 2274:     %%                 z still included since z1 is used by y1
<a name="2275"/> 2275:     Sys2 = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;dependencies&quot;)]},
<a name="2276"/> 2276: 		 {incl_cond, exclude},
<a name="2277"/> 2277: 		 {app,kernel,[{incl_cond,include}]},
<a name="2278"/> 2278: 		 {app,sasl,[{incl_cond,include}]},
<a name="2279"/> 2279: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2280"/> 2280: 		 {app,x,[{incl_cond,include},{mod,x2,[{incl_cond,exclude}]}]},
<a name="2281"/> 2281: 		 {app,y,[{incl_cond,derived}]},
<a name="2282"/> 2282: 		 {app,z,[{incl_cond,derived}]}]},
<a name="2283"/> 2283:     ?m({ok,[]}, reltool_server:load_config(Pid,Sys2)),
<a name="2284"/> 2284:     ?msym({ok,[#app{name=kernel},
<a name="2285"/> 2285: 	       #app{name=sasl},
<a name="2286"/> 2286: 	       #app{name=stdlib},
<a name="2287"/> 2287: 	       #app{name=x,uses_apps=[y]}]},
<a name="2288"/> 2288: 	  reltool_server:get_apps(Pid,whitelist)),
<a name="2289"/> 2289:     {ok, Der2} = ?msym({ok,_},
<a name="2290"/> 2290: 		       reltool_server:get_apps(Pid,derived)),
<a name="2291"/> 2291:     ?msym([#app{name=y,uses_apps=[z]},
<a name="2292"/> 2292: 	   #app{name=z}],
<a name="2293"/> 2293: 	  rm_missing_app(Der2)),
<a name="2294"/> 2294:     ?msym({ok,[]},
<a name="2295"/> 2295: 	  reltool_server:get_apps(Pid,source)),
<a name="2296"/> 2296: 
<a name="2297"/> 2297:     %% Excluding x3 =&gt; y still included since y1 is used by x2
<a name="2298"/> 2298:     %%                 z still included since z1 is used by y1
<a name="2299"/> 2299:     Sys3 = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;dependencies&quot;)]},
<a name="2300"/> 2300: 		 {incl_cond, exclude},
<a name="2301"/> 2301: 		 {app,kernel,[{incl_cond,include}]},
<a name="2302"/> 2302: 		 {app,sasl,[{incl_cond,include}]},
<a name="2303"/> 2303: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2304"/> 2304: 		 {app,x,[{incl_cond,include},{mod,x3,[{incl_cond,exclude}]}]},
<a name="2305"/> 2305: 		 {app,y,[{incl_cond,derived}]},
<a name="2306"/> 2306: 		 {app,z,[{incl_cond,derived}]}]},
<a name="2307"/> 2307:     ?m({ok,[]}, reltool_server:load_config(Pid,Sys3)),
<a name="2308"/> 2308:     ?msym({ok,[#app{name=kernel},
<a name="2309"/> 2309: 	       #app{name=sasl},
<a name="2310"/> 2310: 	       #app{name=stdlib},
<a name="2311"/> 2311: 	       #app{name=x,uses_apps=[y]}]},
<a name="2312"/> 2312: 	  reltool_server:get_apps(Pid,whitelist)),
<a name="2313"/> 2313:     {ok, Der3} = ?msym({ok,_},
<a name="2314"/> 2314: 		       reltool_server:get_apps(Pid,derived)),
<a name="2315"/> 2315:     ?msym([#app{name=y,uses_apps=[z]},
<a name="2316"/> 2316: 	   #app{name=z}],
<a name="2317"/> 2317: 	  rm_missing_app(Der3)),
<a name="2318"/> 2318:     ?msym({ok,[]},
<a name="2319"/> 2319: 	  reltool_server:get_apps(Pid,source)),
<a name="2320"/> 2320: 
<a name="2321"/> 2321:     %% Excluding x2 and x3 =&gt; y and z excluded
<a name="2322"/> 2322:     Sys4 = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;dependencies&quot;)]},
<a name="2323"/> 2323: 		 {incl_cond, exclude},
<a name="2324"/> 2324: 		 {app,kernel,[{incl_cond,include}]},
<a name="2325"/> 2325: 		 {app,sasl,[{incl_cond,include}]},
<a name="2326"/> 2326: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2327"/> 2327: 		 {app,x,[{incl_cond,include},
<a name="2328"/> 2328: 			 {mod,x2,[{incl_cond,exclude}]},
<a name="2329"/> 2329: 			 {mod,x3,[{incl_cond,exclude}]}]},
<a name="2330"/> 2330: 		 {app,y,[{incl_cond,derived}]},
<a name="2331"/> 2331: 		 {app,z,[{incl_cond,derived}]}]},
<a name="2332"/> 2332:     ?m({ok,[]}, reltool_server:load_config(Pid,Sys4)),
<a name="2333"/> 2333:     ?msym({ok,[#app{name=kernel},
<a name="2334"/> 2334: 	       #app{name=sasl},
<a name="2335"/> 2335: 	       #app{name=stdlib},
<a name="2336"/> 2336: 	       #app{name=x,uses_apps=[]}]},
<a name="2337"/> 2337: 	  reltool_server:get_apps(Pid,whitelist)),
<a name="2338"/> 2338:     {ok, Der4} = ?msym({ok,_},
<a name="2339"/> 2339: 		       reltool_server:get_apps(Pid,derived)),
<a name="2340"/> 2340:     ?msym([], rm_missing_app(Der4)),
<a name="2341"/> 2341:     ?msym({ok,[#app{name=y},
<a name="2342"/> 2342: 	       #app{name=z}]},
<a name="2343"/> 2343: 	  reltool_server:get_apps(Pid,source)),
<a name="2344"/> 2344: 
<a name="2345"/> 2345:     %% Excluding y1 =&gt; y still included since y2 is used by x3
<a name="2346"/> 2346:     %%                 z excluded since not used by any other than y1
<a name="2347"/> 2347:     Sys5 = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;dependencies&quot;)]},
<a name="2348"/> 2348: 		 {incl_cond, exclude},
<a name="2349"/> 2349: 		 {app,kernel,[{incl_cond,include}]},
<a name="2350"/> 2350: 		 {app,sasl,[{incl_cond,include}]},
<a name="2351"/> 2351: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2352"/> 2352: 		 {app,x,[{incl_cond,include}]},
<a name="2353"/> 2353: 		 {app,y,[{incl_cond,derived},
<a name="2354"/> 2354: 			 {mod,y1,[{incl_cond,exclude}]}]},
<a name="2355"/> 2355: 		 {app,z,[{incl_cond,derived}]}]},
<a name="2356"/> 2356:     ?m({ok,[]}, reltool_server:load_config(Pid,Sys5)),
<a name="2357"/> 2357:     ?msym({ok,[#app{name=kernel},
<a name="2358"/> 2358: 	       #app{name=sasl},
<a name="2359"/> 2359: 	       #app{name=stdlib},
<a name="2360"/> 2360: 	       #app{name=x,uses_apps=[y]}]},
<a name="2361"/> 2361: 	  reltool_server:get_apps(Pid,whitelist)),
<a name="2362"/> 2362:     {ok, Der5} = ?msym({ok,_},
<a name="2363"/> 2363: 		       reltool_server:get_apps(Pid,derived)),
<a name="2364"/> 2364:     ?msym([#app{name=y,uses_apps=[]}], rm_missing_app(Der5)),
<a name="2365"/> 2365:     ?msym({ok,[#app{name=z}]},
<a name="2366"/> 2366: 	  reltool_server:get_apps(Pid,source)),
<a name="2367"/> 2367: 
<a name="2368"/> 2368:     ?m(ok, reltool:stop(Pid)),
<a name="dependencies-last_expr"/><a name="2369"/> 2369:     ok.
<a name="2370"/> 2370: 
<a name="2371"/> 2371: 
<a name="2372"/> 2372: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2373"/> 2373: <i>%% Test that incl_cond on mod level overwrites mod_cond on app level</i>
<a name="2374"/> 2374: <i>%% Uses same test applications as dependencies/1 above</i>
<a name="mod_incl_cond_derived-1"/><a name="2375"/> 2375: <b>mod_incl_cond_derived</b>(Config) -&gt;
<a name="2376"/> 2376:     %% In app y: mod_cond=none means no module shall be included
<a name="2377"/> 2377:     %% but mod_cond is overwritten by incl_cond on mod level
<a name="2378"/> 2378:     Sys = {sys,[{lib_dirs,[filename:join(datadir(Config),&quot;dependencies&quot;)]},
<a name="2379"/> 2379: 		{incl_cond, exclude},
<a name="2380"/> 2380: 		{app,kernel,[{incl_cond,include}]},
<a name="2381"/> 2381: 		{app,sasl,[{incl_cond,include}]},
<a name="2382"/> 2382: 		{app,stdlib,[{incl_cond,include}]},
<a name="2383"/> 2383: 		{app,x,[{incl_cond,include}]},
<a name="2384"/> 2384: 		{app,y,[{incl_cond,include},
<a name="2385"/> 2385: 			{mod_cond,none},
<a name="2386"/> 2386: 			{mod,y0,[{incl_cond,derived}]},
<a name="2387"/> 2387: 			{mod,y2,[{incl_cond,derived}]}]}]},
<a name="2388"/> 2388:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="2389"/> 2389: 
<a name="2390"/> 2390:     ?msym({ok,[#app{name=kernel},
<a name="2391"/> 2391: 	       #app{name=sasl},
<a name="2392"/> 2392: 	       #app{name=stdlib},
<a name="2393"/> 2393: 	       #app{name=x,uses_apps=[y]},
<a name="2394"/> 2394: 	       #app{name=y,uses_apps=[]}]},
<a name="2395"/> 2395: 	  reltool_server:get_apps(Pid,whitelist)),
<a name="2396"/> 2396:     {ok, Der} = ?msym({ok,_},reltool_server:get_apps(Pid,derived)),
<a name="2397"/> 2397:     ?msym([], rm_missing_app(Der)),
<a name="2398"/> 2398:     ?msym({ok,[]}, reltool_server:get_apps(Pid,source)),
<a name="2399"/> 2399: 
<a name="2400"/> 2400:     %% 1. check that y0 is not included since it has
<a name="2401"/> 2401:     %% incl_cond=derived, but is not used by any other module.
<a name="2402"/> 2402:     ?msym({ok,#mod{is_included=undefined}}, reltool_server:get_mod(Pid,y0)),
<a name="2403"/> 2403: 
<a name="2404"/> 2404:     %% 2. check that y1 is excluded since it has undefined incl_cond
<a name="2405"/> 2405:     %% on mod level, so mod_cond on app level shall be used.
<a name="2406"/> 2406:     ?msym({ok,#mod{is_included=false}}, reltool_server:get_mod(Pid,y1)),
<a name="2407"/> 2407: 
<a name="2408"/> 2408:     %% 3. check that y2 is included since it has incl_cond=derived and
<a name="2409"/> 2409:     %% is used by x3.
<a name="2410"/> 2410:     ?msym({ok,#mod{is_included=true}}, reltool_server:get_mod(Pid,y2)),
<a name="2411"/> 2411: 
<a name="mod_incl_cond_derived-last_expr"/><a name="2412"/> 2412:     ok.
<a name="2413"/> 2413: 
<a name="2414"/> 2414: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2415"/> 2415: <i>%% ERL-167, OTP-11993: For applications that are not included in a</i>
<a name="2416"/> 2416: <i>%% release spec ('rel'), dependencies in the .app files are not</i>
<a name="2417"/> 2417: <i>%% considered - only those found with xref.</i>
<a name="dep_in_app_not_xref-1"/><a name="2418"/> 2418: <b>dep_in_app_not_xref</b>(Config) -&gt;
<a name="2419"/> 2419:     RelName = &quot;Just testing...&quot;,
<a name="2420"/> 2420:     RelVsn = &quot;1.0&quot;,
<a name="2421"/> 2421:     Sys =
<a name="2422"/> 2422:         {sys,
<a name="2423"/> 2423:          [
<a name="2424"/> 2424: 	  {lib_dirs,[filename:join(datadir(Config),&quot;dep_in_app_not_xref&quot;)]},
<a name="2425"/> 2425: 	  {incl_cond,exclude},
<a name="2426"/> 2426: 	  {erts,[{incl_cond,exclude}]},
<a name="2427"/> 2427:           {boot_rel, RelName},
<a name="2428"/> 2428:           {rel, RelName, RelVsn, [kernel, stdlib]},
<a name="2429"/> 2429: 	  {app,kernel,[{incl_cond,include}]},
<a name="2430"/> 2430: 	  {app,stdlib,[{incl_cond,include}]},
<a name="2431"/> 2431: 	  {app,x,[{incl_cond,include}]},
<a name="2432"/> 2432: 	  {app,y,[{incl_cond,derived}]},
<a name="2433"/> 2433: 	  {app,z,[{incl_cond,derived}]}
<a name="2434"/> 2434:          ]},
<a name="2435"/> 2435: 
<a name="2436"/> 2436:     TargetDir = filename:join([?WORK_DIR, &quot;target_dep_in_app_not_xref&quot;]),
<a name="2437"/> 2437:     ?m(ok, reltool_utils:recursive_delete(TargetDir)),
<a name="2438"/> 2438:     ?m(ok, file:make_dir(TargetDir)),
<a name="2439"/> 2439:     ?log(&quot;SPEC: ~p\n&quot;, [reltool:get_target_spec([{config, Sys}])]),
<a name="2440"/> 2440:     ok = ?m(ok, reltool:create_target([{config, Sys}], TargetDir)),
<a name="2441"/> 2441:     ?log(&quot;~p~n&quot;,[file:list_dir(filename:join([TargetDir,&quot;lib&quot;]))]),
<a name="2442"/> 2442: 
<a name="2443"/> 2443:     ?m(true, filelib:is_dir(filename:join([TargetDir,&quot;lib&quot;,&quot;y-1.0&quot;]))),
<a name="2444"/> 2444:     ?m(true, filelib:is_dir(filename:join([TargetDir,&quot;lib&quot;,&quot;z-1.0&quot;]))),
<a name="dep_in_app_not_xref-last_expr"/><a name="2445"/> 2445:     ok.
<a name="2446"/> 2446: 
<a name="2447"/> 2447: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="use_selected_vsn-1"/><a name="2448"/> 2448: <b>use_selected_vsn</b>(Config) -&gt;
<a name="2449"/> 2449:     LibDir1 = filename:join(datadir(Config),&quot;use_selected_vsn&quot;),
<a name="2450"/> 2450:     B1Dir = filename:join(LibDir1,&quot;b-1.0&quot;),
<a name="2451"/> 2451:     B3Dir = filename:join(LibDir1,&quot;b-3.0&quot;),
<a name="2452"/> 2452: 
<a name="2453"/> 2453:     LibDir2 = filename:join(LibDir1,&quot;lib2&quot;),
<a name="2454"/> 2454:     B2Dir = filename:join(LibDir2,&quot;b-2.0&quot;),
<a name="2455"/> 2455: 
<a name="2456"/> 2456:     %%-----------------------------------------------------------------
<a name="2457"/> 2457:     %% Pre-selected vsn of app b
<a name="2458"/> 2458:     Sys1 = {sys,[{lib_dirs,[LibDir1]},
<a name="2459"/> 2459: 		 {incl_cond, exclude},
<a name="2460"/> 2460: 		 {app,kernel,[{incl_cond,include}]},
<a name="2461"/> 2461: 		 {app,sasl,[{incl_cond,include}]},
<a name="2462"/> 2462: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2463"/> 2463: 		 {app,b,[{incl_cond,include},{vsn,&quot;1.0&quot;}]}]},
<a name="2464"/> 2464:     {ok, Pid1} = ?msym({ok, _}, reltool:start_server([{config, Sys1}])),
<a name="2465"/> 2465:     {ok,B11} = ?msym({ok,#app{vsn=&quot;1.0&quot;,active_dir=B1Dir}},
<a name="2466"/> 2466: 		     reltool_server:get_app(Pid1,b)),
<a name="2467"/> 2467: 
<a name="2468"/> 2468:     %% Change from a pre-selected vsn to use a specific dir
<a name="2469"/> 2469:     ?msym({ok, #app{vsn =&quot;3.0&quot;, active_dir = B3Dir}, []},
<a name="2470"/> 2470: 	  reltool_server:set_app(Pid1,
<a name="2471"/> 2471: 				 B11#app{active_dir = B3Dir,
<a name="2472"/> 2472: 					 use_selected_vsn = dir,
<a name="2473"/> 2473: 					 label = undefined,
<a name="2474"/> 2474: 					 vsn = undefined,
<a name="2475"/> 2475: 					 info = undefined})),
<a name="2476"/> 2476:     ?m(ok, reltool:stop(Pid1)),
<a name="2477"/> 2477: 
<a name="2478"/> 2478: 
<a name="2479"/> 2479:     %%-----------------------------------------------------------------
<a name="2480"/> 2480:     %% Pre-selected vsn of app b
<a name="2481"/> 2481:     Sys2 = {sys,[{lib_dirs,[LibDir1]},
<a name="2482"/> 2482: 		 {incl_cond, exclude},
<a name="2483"/> 2483: 		 {app,kernel,[{incl_cond,include}]},
<a name="2484"/> 2484: 		 {app,sasl,[{incl_cond,include}]},
<a name="2485"/> 2485: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2486"/> 2486: 		 {app,b,[{incl_cond,include},{vsn,&quot;1.0&quot;}]}]},
<a name="2487"/> 2487:     {ok, Pid2} = ?msym({ok, _}, reltool:start_server([{config, Sys2}])),
<a name="2488"/> 2488:     {ok,B21} = ?msym({ok,#app{vsn=&quot;1.0&quot;,active_dir=B1Dir}},
<a name="2489"/> 2489: 		     reltool_server:get_app(Pid2,b)),
<a name="2490"/> 2490: 
<a name="2491"/> 2491:     %% Change from a pre-selected vsn to use latest
<a name="2492"/> 2492:     ?msym({ok, #app{vsn =&quot;3.0&quot;, active_dir = B3Dir}, []},
<a name="2493"/> 2493: 	  reltool_server:set_app(Pid2,
<a name="2494"/> 2494: 				 B21#app{use_selected_vsn=undefined,
<a name="2495"/> 2495: 					 label = undefined,
<a name="2496"/> 2496: 					 vsn = undefined,
<a name="2497"/> 2497: 					 info = undefined})),
<a name="2498"/> 2498:     ?m(ok, reltool:stop(Pid2)),
<a name="2499"/> 2499: 
<a name="2500"/> 2500: 
<a name="2501"/> 2501:     %%-----------------------------------------------------------------
<a name="2502"/> 2502:     %% Pre-selected directory for app b
<a name="2503"/> 2503:     Sys3 = {sys,[{lib_dirs,[LibDir1]},
<a name="2504"/> 2504: 		 {incl_cond, exclude},
<a name="2505"/> 2505: 		 {app,kernel,[{incl_cond,include}]},
<a name="2506"/> 2506: 		 {app,sasl,[{incl_cond,include}]},
<a name="2507"/> 2507: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2508"/> 2508: 		 {app,b,[{incl_cond,include},{lib_dir,B2Dir}]}]},
<a name="2509"/> 2509:     {ok, Pid3} = ?msym({ok, _}, reltool:start_server([{config, Sys3}])),
<a name="2510"/> 2510: <i>%    test_server:break(&quot;Pid3 = list_to_pid(\&quot;&quot;++pid_to_list(Pid3)++&quot;\&quot;).&quot;),</i>
<a name="2511"/> 2511:     {ok,B31} = ?msym({ok,#app{vsn=&quot;2.0&quot;,active_dir=B2Dir}},
<a name="2512"/> 2512: 		     reltool_server:get_app(Pid3,b)),
<a name="2513"/> 2513:     %% Change from a pre-selected dir to use latest
<a name="2514"/> 2514:     {ok,B32,_} = ?msym({ok, #app{vsn =&quot;3.0&quot;, active_dir = B3Dir}, []},
<a name="2515"/> 2515: 		       reltool_server:set_app(Pid3,
<a name="2516"/> 2516: 					      B31#app{use_selected_vsn=undefined,
<a name="2517"/> 2517: 						      label = undefined,
<a name="2518"/> 2518: 						      vsn = undefined,
<a name="2519"/> 2519: 						      info = undefined})),
<a name="2520"/> 2520:     %% Change back to use selected dir
<a name="2521"/> 2521:     {ok,B33,_} = ?msym({ok, #app{vsn =&quot;3.0&quot;, active_dir = B3Dir}, []},
<a name="2522"/> 2522: 		       reltool_server:set_app(Pid3,
<a name="2523"/> 2523: 					      B32#app{use_selected_vsn = dir})),
<a name="2524"/> 2524:     %% use dir 1
<a name="2525"/> 2525:     {ok,B34,_} = ?msym({ok, #app{vsn =&quot;1.0&quot;, active_dir = B1Dir}, []},
<a name="2526"/> 2526: 		       reltool_server:set_app(Pid3,
<a name="2527"/> 2527: 					      B33#app{active_dir = B1Dir,
<a name="2528"/> 2528: 						      label = undefined,
<a name="2529"/> 2529: 						      vsn = undefined,
<a name="2530"/> 2530: 						      info = undefined})),
<a name="2531"/> 2531:     %% use dir 2
<a name="2532"/> 2532:     {ok,B35,_} = ?msym({ok, #app{vsn =&quot;2.0&quot;, active_dir = B2Dir}, []},
<a name="2533"/> 2533: 		       reltool_server:set_app(Pid3,
<a name="2534"/> 2534: 					      B34#app{active_dir = B2Dir,
<a name="2535"/> 2535: 						      label = undefined,
<a name="2536"/> 2536: 						      vsn = undefined,
<a name="2537"/> 2537: 						      info = undefined})),
<a name="2538"/> 2538:     %% use dir 3
<a name="2539"/> 2539:     ?msym({ok, #app{vsn =&quot;3.0&quot;, active_dir = B3Dir}, []},
<a name="2540"/> 2540: 	  reltool_server:set_app(Pid3,
<a name="2541"/> 2541: 				 B35#app{active_dir = B3Dir,
<a name="2542"/> 2542: 					 label = undefined,
<a name="2543"/> 2543: 					 vsn = undefined,
<a name="2544"/> 2544: 					 info = undefined})),
<a name="2545"/> 2545:     ?m(ok, reltool:stop(Pid3)),
<a name="use_selected_vsn-last_expr"/><a name="2546"/> 2546:     ok.
<a name="2547"/> 2547: 
<a name="2548"/> 2548: 
<a name="2549"/> 2549: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="use_selected_vsn_relative_path-1"/><a name="2550"/> 2550: <b>use_selected_vsn_relative_path</b>(Config) -&gt;
<a name="2551"/> 2551:     LibDir = filename:join([datadir(Config),&quot;use_selected_vsn&quot;,&quot;b-1.0&quot;]),
<a name="2552"/> 2552:     RelDir = filename:join(LibDir,&quot;rel&quot;),
<a name="2553"/> 2553: 
<a name="2554"/> 2554:     {ok,Cwd} = file:get_cwd(),
<a name="2555"/> 2555:     ok = file:set_cwd(RelDir),
<a name="2556"/> 2556: 
<a name="2557"/> 2557:     Sys = {sys,[{incl_cond, exclude},
<a name="2558"/> 2558: 		{app,kernel,[{incl_cond,include}]},
<a name="2559"/> 2559: 		{app,sasl,[{incl_cond,include}]},
<a name="2560"/> 2560: 		{app,stdlib,[{incl_cond,include}]},
<a name="2561"/> 2561: 		{app,b,[{incl_cond,include},{lib_dir,&quot;..&quot;}]}]},
<a name="2562"/> 2562:     {ok, Pid} = ?msym({ok, _}, reltool:start_server([{config, Sys}])),
<a name="2563"/> 2563: 
<a name="2564"/> 2564:     ?msym({ok,#app{vsn=&quot;1.0&quot;,active_dir=LibDir}},reltool_server:get_app(Pid,b)),
<a name="2565"/> 2565: 
<a name="2566"/> 2566:     ?m(ok, reltool:stop(Pid)),
<a name="2567"/> 2567: 
<a name="2568"/> 2568:     ok = file:set_cwd(Cwd),
<a name="use_selected_vsn_relative_path-last_expr"/><a name="2569"/> 2569:     ok.
<a name="2570"/> 2570: 
<a name="2571"/> 2571: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2572"/> 2572: <i>%% Test that reltool recognizes an application with its real name even</i>
<a name="2573"/> 2573: <i>%% though it uses non standard format for its version number (in the</i>
<a name="2574"/> 2574: <i>%% directory name)</i>
<a name="non_standard_vsn_id-1"/><a name="2575"/> 2575: <b>non_standard_vsn_id</b>(Config) -&gt;
<a name="2576"/> 2576:     LibDir = filename:join(datadir(Config),&quot;non_standard_vsn_id&quot;),
<a name="2577"/> 2577:     B1Dir = filename:join(LibDir,&quot;b-first&quot;),
<a name="2578"/> 2578:     B2Dir = filename:join(LibDir,&quot;b-second&quot;),
<a name="2579"/> 2579: 
<a name="2580"/> 2580:     %%-----------------------------------------------------------------
<a name="2581"/> 2581:     %% Default vsn of app b
<a name="2582"/> 2582:     Sys1 = {sys,[{lib_dirs,[LibDir]},
<a name="2583"/> 2583: 		 {incl_cond, exclude},
<a name="2584"/> 2584: 		 {app,kernel,[{incl_cond,include}]},
<a name="2585"/> 2585: 		 {app,sasl,[{incl_cond,include}]},
<a name="2586"/> 2586: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2587"/> 2587: 		 {app,b,[{incl_cond,include}]}]},
<a name="2588"/> 2588:     {ok, Pid1} = ?msym({ok, _}, reltool:start_server([{config, Sys1}])),
<a name="2589"/> 2589:     ?msym({ok,#app{vsn=&quot;first&quot;,active_dir=B1Dir,sorted_dirs=[B1Dir,B2Dir]}},
<a name="2590"/> 2590: 	  reltool_server:get_app(Pid1,b)),
<a name="2591"/> 2591: 
<a name="2592"/> 2592:     %%-----------------------------------------------------------------
<a name="2593"/> 2593:     %% Pre-selected vsn of app b
<a name="2594"/> 2594:     Sys2 = {sys,[{lib_dirs,[LibDir]},
<a name="2595"/> 2595: 		 {incl_cond, exclude},
<a name="2596"/> 2596: 		 {app,kernel,[{incl_cond,include}]},
<a name="2597"/> 2597: 		 {app,sasl,[{incl_cond,include}]},
<a name="2598"/> 2598: 		 {app,stdlib,[{incl_cond,include}]},
<a name="2599"/> 2599: 		 {app,b,[{incl_cond,include},{vsn,&quot;second&quot;}]}]},
<a name="2600"/> 2600:     {ok, Pid2} = ?msym({ok, _}, reltool:start_server([{config, Sys2}])),
<a name="2601"/> 2601:     ?msym({ok,#app{vsn=&quot;second&quot;,active_dir=B2Dir,sorted_dirs=[B1Dir,B2Dir]}},
<a name="2602"/> 2602: 	  reltool_server:get_app(Pid2,b)),
<a name="non_standard_vsn_id-last_expr"/><a name="2603"/> 2603:    ok.
<a name="2604"/> 2604: 
<a name="2605"/> 2605: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="undefined_regexp-1"/><a name="2606"/> 2606: <b>undefined_regexp</b>(_Config) -&gt;
<a name="2607"/> 2607:     ?msym({ok,_},
<a name="2608"/> 2608:           reltool:get_config([{sys,[{app,asn1,[{excl_app_filters,
<a name="2609"/> 2609:                                                 {add, [&quot;^priv&quot;]}}]}]}])),
<a name="undefined_regexp-last_expr"/><a name="2610"/> 2610:     ok.
<a name="2611"/> 2611: 
<a name="2612"/> 2612: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2613"/> 2613: <i>%% Checks that reltool_utils can correctly read Windows ERL_LIBS</i>
<a name="2614"/> 2614: 
<a name="windows_erl_libs-1"/><a name="2615"/> 2615: <b>windows_erl_libs</b>(_Config) -&gt;
<a name="2616"/> 2616:     WinErlLibs =
<a name="2617"/> 2617:         &quot;C:\\Program Files\\Erlang Libs;C:\\Program Files\\More Erlang Libs&quot;,
<a name="2618"/> 2618:     Ret = reltool_utils:erl_libs(WinErlLibs, {win32, nt}),
<a name="2619"/> 2619:     ?m([&quot;C:\\Program Files\\Erlang Libs&quot;,&quot;C:\\Program Files\\More Erlang Libs&quot;],
<a name="2620"/> 2620:        Ret),
<a name="windows_erl_libs-last_expr"/><a name="2621"/> 2621:     ok.
<a name="2622"/> 2622: 
<a name="2623"/> 2623: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2624"/> 2624: <i>%% Library functions</i>
<a name="2625"/> 2625: 
<a name="datadir-1"/><a name="2626"/> 2626: <b>datadir</b>(Config) -&gt;
<a name="2627"/> 2627:     %% Removes the trailing slash...
<a name="datadir-last_expr"/><a name="2628"/> 2628: <b>    filename:nativename</b>(?config(data_dir,Config)).
<a name="2629"/> 2629: 
<a name="latest-1"/><a name="2630"/> 2630: <b>latest</b>(App) -&gt;
<a name="2631"/> 2631:     AppStr = atom_to_list(App),
<a name="2632"/> 2632:     AppDirs = filelib:wildcard(filename:join(code:lib_dir(),AppStr++&quot;-*&quot;)),
<a name="2633"/> 2633:     [LatestAppDir|_] = lists:reverse(AppDirs),
<a name="2634"/> 2634:     [_,Vsn] = string:lexemes(filename:basename(LatestAppDir),&quot;-&quot;),
<a name="latest-last_expr"/><a name="2635"/> 2635:     Vsn.
<a name="2636"/> 2636: 
<a name="rm_missing_app-1"/><a name="2637"/> 2637: <b>rm_missing_app</b>(Apps) -&gt;
<a name="rm_missing_app-last_expr"/><a name="2638"/> 2638: <b>    lists:keydelete</b>(?MISSING_APP_NAME,#app.name,Apps).
<a name="2639"/> 2639: 
<a name="2640"/> 2640: <i>%% We will compare the script generated by systools with</i>
<a name="2641"/> 2641: <i>%% the script generated by Reltool.</i>
<a name="2642"/> 2642: <i>%%</i>
<a name="2643"/> 2643: <i>%% The systools script may include additional modules in</i>
<a name="2644"/> 2644: <i>%% the first primLoad command (as a pure optimization).</i>
<a name="2645"/> 2645: <i>%% Therefore, we cannot compare the primLoad commands</i>
<a name="2646"/> 2646: <i>%% directly. Instead we will collect all modules from</i>
<a name="2647"/> 2647: <i>%% all primLoad commands in each script. The same</i>
<a name="2648"/> 2648: <i>%% modules must be loaded by both scripts. In addition,</i>
<a name="2649"/> 2649: <i>%% the error_handler module must be included in the</i>
<a name="2650"/> 2650: <i>%% first primLoad in each script.</i>
<a name="2651"/> 2651: 
<a name="diff_script-2"/><a name="2652"/> 2652: <b>diff_script</b>(Script, Script) -&gt;
<a name="2653"/> 2653:     equal;
<a name="2654"/> 2654: <b>diff_script</b>({script, Rel, Commands1}, {script, Rel, Commands2}) -&gt;
<a name="2655"/> 2655:     case diff_cmds(Commands1, Commands2) of
<a name="2656"/> 2656: 	equal -&gt;
<a name="2657"/> 2657: 	    Loaded = diff_get_prim_load(Commands1),
<a name="2658"/> 2658: 	    case diff_get_prim_load(Commands2) of
<a name="2659"/> 2659: 		Loaded -&gt;
<a name="2660"/> 2660: 		    equal;
<a name="2661"/> 2661: 		Other -&gt;
<a name="2662"/> 2662: 		    io:format(&quot;Only loaded by systools: ~p&quot;,
<a name="2663"/> 2663: 			      [Loaded--Other]),
<a name="2664"/> 2664: 		    io:format(&quot;Only loaded by reltool: ~p&quot;,
<a name="2665"/> 2665: 			      [Other--Loaded]),
<a name="2666"/> 2666: 		    ct:fail(different_prim_loads)
<a name="2667"/> 2667: 	    end;
<a name="2668"/> 2668: 	Error -&gt;
<a name="2669"/> 2669: 	    Error
<a name="2670"/> 2670:     end;
<a name="2671"/> 2671: <b>diff_script</b>({script, Rel1, _}, {script, Rel2, _}) -&gt;
<a name="diff_script-last_expr"/><a name="2672"/> 2672:     {error, {Rel1, Rel2}}.
<a name="2673"/> 2673: 
<a name="diff_cmds-2"/><a name="2674"/> 2674: <b>diff_cmds</b>([{primLoad, Ms1}=Cmd1 | Commands1],
<a name="2675"/> 2675: 	  [{primLoad, Ms2}=Cmd2 | Commands2]) -&gt;
<a name="2676"/> 2676:     case lists:member(error_handler, Ms1) xor
<a name="2677"/> 2677: 	lists:member(error_handler, Ms2) of
<a name="2678"/> 2678: 	false -&gt;
<a name="2679"/> 2679: 	    %% error_handler either present in both or
<a name="2680"/> 2680: 	    %% absent in both.
<a name="2681"/> 2681: 	    diff_cmds(Commands1, Commands2);
<a name="2682"/> 2682: 	true -&gt;
<a name="2683"/> 2683: 	    %% error_handler only present in one primLoad.
<a name="2684"/> 2684: 	    %% Not OK.
<a name="2685"/> 2685: 	    {diff, missing_error_handler,
<a name="2686"/> 2686: 	     {expected, Cmd1}, {actual, Cmd2}}
<a name="2687"/> 2687:     end;
<a name="2688"/> 2688: <b>diff_cmds</b>([Cmd | Commands1], [Cmd | Commands2]) -&gt;
<a name="2689"/> 2689:     diff_cmds(Commands1, Commands2);
<a name="2690"/> 2690: <b>diff_cmds</b>([Cmd1 | _Commands1], [Cmd2 | _Commands2]) -&gt;
<a name="2691"/> 2691:     {diff, {expected, Cmd1}, {actual, Cmd2}};
<a name="2692"/> 2692: <b>diff_cmds</b>([], []) -&gt;
<a name="diff_cmds-last_expr"/><a name="2693"/> 2693:     equal.
<a name="2694"/> 2694: 
<a name="diff_get_prim_load-1"/><a name="2695"/> 2695: <b>diff_get_prim_load</b>(Cmds) -&gt;
<a name="2696"/> 2696:     L = [Ms || {primLoad, Ms} &lt;- Cmds],
<a name="diff_get_prim_load-last_expr"/><a name="2697"/> 2697: <b>    lists:sort</b>(lists:flatten(L)).
<a name="2698"/> 2698: 
<a name="os_cmd-1"/><a name="2699"/> 2699: <b>os_cmd</b>(Cmd) when is_list(Cmd) -&gt;
<a name="2700"/> 2700:     %% Call the plain os:cmd with an echo command appended to print command status
<a name="2701"/> 2701:     %% io:format(&quot;os:cmd(~p).\n&quot;, [Cmd]),
<a name="os_cmd-last_expr"/><a name="2702"/> 2702: <b>    case os:cmd</b>(Cmd++&quot;;echo \&quot;#$?\&quot;&quot;) of
<a name="2703"/> 2703:         %% There is (as far as I can tell) only one thing that will match this
<a name="2704"/> 2704:         %% and that is too silly to ever be used, but...
<a name="2705"/> 2705:         []-&gt;
<a name="2706"/> 2706:             {99, []};
<a name="2707"/> 2707:         Return-&gt;
<a name="2708"/> 2708:             %% Find the position of the status code which is last in the string
<a name="2709"/> 2709:             %% prepended with #
<a name="2710"/> 2710:             case string:split(Return, &quot;$#&quot;, trailing) of
<a name="2711"/> 2711:                 [_] -&gt; %% This happens only if the sh command pipe is somehow interrupted
<a name="2712"/> 2712:                     {98, Return};
<a name="2713"/> 2713:                 [Result, Status0] -&gt;
<a name="2714"/> 2714:                     {list_to_integer(string:trim(Status0)), Result}
<a name="2715"/> 2715:             end
<a name="2716"/> 2716:     end.
<a name="2717"/> 2717: 
<a name="2718"/> 2718: <i>%% Returns the location (directory) of the given module. Split,</i>
<a name="2719"/> 2719: <i>%% reverted and relative to the lib dir.</i>
<a name="mod_path-2"/><a name="2720"/> 2720: <b>mod_path</b>(Node,Mod) -&gt;
<a name="mod_path-last_expr"/><a name="2721"/> 2721: <b>    case rpc:call</b>(Node,code,which,[Mod]) of
<a name="2722"/> 2722: 	Path when is_list(Path) -&gt;
<a name="2723"/> 2723: 	    lists:takewhile(
<a name="2724"/> 2724: 	      fun(&quot;lib&quot;) -&gt; false;
<a name="2725"/> 2725: 		 (_) -&gt; true
<a name="2726"/> 2726: 	      end,
<a name="2727"/> 2727: 	      lists:reverse(filename:split(filename:dirname(Path))));
<a name="2728"/> 2728: 	Other -&gt;
<a name="2729"/> 2729: 	    Other
<a name="2730"/> 2730:     end.
<a name="2731"/> 2731: 
<a name="2732"/> 2732: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2733"/> 2733: <i>%% Node handling</i>
<a name="2734"/> 2734: 
<a name="start_node-2"/><a name="2735"/> 2735: <b>start_node</b>(Name, ErlPath) -&gt;
<a name="start_node-last_expr"/><a name="2736"/> 2736: <b>    start_node</b>(Name, ErlPath, []).
<a name="start_node-3"/><a name="2737"/> 2737: <b>start_node</b>(Name, ErlPath, Args0) -&gt;
<a name="2738"/> 2738:     FullName = full_node_name(Name),
<a name="2739"/> 2739:     Args = mk_node_args(Name, Args0),
<a name="2740"/> 2740:     io:format(&quot;Starting node ~p: ~ts~n&quot;,
<a name="2741"/> 2741: 	      [FullName, lists:flatten([[X,&quot; &quot;] || X &lt;- [ErlPath|Args]])]),
<a name="2742"/> 2742:     %io:format(&quot;open_port({spawn_executable, ~p}, [{args,~p}])~n&quot;,[ErlPath,Args]),
<a name="start_node-last_expr"/><a name="2743"/> 2743: <b>    case open_port</b>({spawn_executable, ErlPath}, [{args,Args}]) of
<a name="2744"/> 2744:         Port when is_port(Port) -&gt;
<a name="2745"/> 2745: 	    %% no need to close port since node is detached (see
<a name="2746"/> 2746: 	    %% mk_node_args) so port will be closed anyway.
<a name="2747"/> 2747:             case ping_node(FullName, 50) of
<a name="2748"/> 2748:                 ok -&gt; {ok, FullName};
<a name="2749"/> 2749:                 Other -&gt; exit({failed_to_start_node, FullName, Other})
<a name="2750"/> 2750:             end;
<a name="2751"/> 2751:         Error -&gt;
<a name="2752"/> 2752:             exit({failed_to_start_node, FullName, Error})
<a name="2753"/> 2753:     end.
<a name="2754"/> 2754: 
<a name="stop_node-1"/><a name="2755"/> 2755: <b>stop_node</b>(Node) -&gt;
<a name="2756"/> 2756:     rpc:call(Node,erlang,halt,[]),
<a name="stop_node-last_expr"/><a name="2757"/> 2757: <b>    wait_for_node_down</b>(Node,50).
<a name="2758"/> 2758: 
<a name="wait_for_node_down-2"/><a name="2759"/> 2759: <b>wait_for_node_down</b>(Node,0) -&gt;
<a name="2760"/> 2760:     ct:fail({cant_terminate_node,Node});
<a name="2761"/> 2761: <b>wait_for_node_down</b>(Node,N) -&gt;
<a name="wait_for_node_down-last_expr"/><a name="2762"/> 2762: <b>    case net_adm:ping</b>(Node) of
<a name="2763"/> 2763: 	pong -&gt;
<a name="2764"/> 2764: 	    timer:sleep(1000),
<a name="2765"/> 2765: 	    wait_for_node_down(Node,N-1);
<a name="2766"/> 2766: 	pang -&gt;
<a name="2767"/> 2767: 	    ok
<a name="2768"/> 2768:     end.
<a name="2769"/> 2769: 
<a name="mk_node_args-2"/><a name="2770"/> 2770: <b>mk_node_args</b>(Name, Args) -&gt;
<a name="2771"/> 2771:     Pa = filename:dirname(code:which(?MODULE)),
<a name="2772"/> 2772:     NameSw = case net_kernel:longnames() of
<a name="2773"/> 2773:                  false -&gt; &quot;-sname&quot;;
<a name="2774"/> 2774:                  true -&gt; &quot;-name&quot;;
<a name="2775"/> 2775:                  _ -&gt; exit(not_distributed_node)
<a name="2776"/> 2776:              end,
<a name="2777"/> 2777:     {ok, Pwd} = file:get_cwd(),
<a name="2778"/> 2778:     NameStr = atom_to_list(Name),
<a name="mk_node_args-last_expr"/><a name="2779"/> 2779:     [&quot;-detached&quot;,
<a name="2780"/> 2780:      %% Don't want to try to run the debug emulator here
<a name="2781"/> 2781:      &quot;-emu_type&quot;,&quot;opt&quot;,
<a name="2782"/> 2782:      NameSw, NameStr,
<a name="2783"/> 2783:      &quot;-pa&quot;, Pa,
<a name="2784"/> 2784:      &quot;-env&quot;, &quot;ERL_CRASH_DUMP&quot;, Pwd ++ &quot;/erl_crash_dump.&quot; ++ NameStr,
<a name="2785"/> 2785:      &quot;-setcookie&quot;, atom_to_list(erlang:get_cookie())
<a name="2786"/> 2786:      | Args].
<a name="2787"/> 2787: 
<a name="full_node_name-1"/><a name="2788"/> 2788: <b>full_node_name</b>(PreName) -&gt;
<a name="2789"/> 2789:     HostSuffix = lists:dropwhile(fun ($@) -&gt; false; (_) -&gt; true end,
<a name="2790"/> 2790:                                  atom_to_list(node())),
<a name="full_node_name-last_expr"/><a name="2791"/> 2791: <b>    list_to_atom</b>(atom_to_list(PreName) ++ HostSuffix).
<a name="2792"/> 2792: 
<a name="ping_node-2"/><a name="2793"/> 2793: <b>ping_node</b>(_Node, 0) -&gt;
<a name="2794"/> 2794:     {error, net_adm};
<a name="2795"/> 2795: <b>ping_node</b>(Node, N) when is_integer(N), N &gt; 0 -&gt;
<a name="ping_node-last_expr"/><a name="2796"/> 2796: <b>    case catch net_adm:ping</b>(Node) of
<a name="2797"/> 2797:         pong -&gt; 
<a name="2798"/> 2798: 	    wait_for_process(Node, code_server, 50);
<a name="2799"/> 2799:         _ -&gt;
<a name="2800"/> 2800: 	    timer:sleep(1000),
<a name="2801"/> 2801:             ping_node(Node, N-1)
<a name="2802"/> 2802:     end.
<a name="2803"/> 2803: 
<a name="wait_for_process-3"/><a name="2804"/> 2804: <b>wait_for_process</b>(_Node, Name, 0) -&gt;
<a name="2805"/> 2805:     {error, Name};
<a name="2806"/> 2806: <b>wait_for_process</b>(Node, Name, N) when is_integer(N), N &gt; 0 -&gt;
<a name="wait_for_process-last_expr"/><a name="2807"/> 2807: <b>    case rpc:call</b>(Node, erlang, whereis, [Name]) of
<a name="2808"/> 2808: 	undefined -&gt;
<a name="2809"/> 2809: 	    timer:sleep(1000),
<a name="2810"/> 2810: 	    wait_for_process(Node, Name, N-1);
<a name="2811"/> 2811: 	{badrpc, _} = Reason -&gt;
<a name="2812"/> 2812: 	    erlang:error({Reason, Node});
<a name="2813"/> 2813: 	Pid when is_pid(Pid) -&gt;
<a name="2814"/> 2814: 	    ok
<a name="2815"/> 2815:     end.
<a name="2816"/> 2816: 
<a name="wait_for_app-3"/><a name="2817"/> 2817: <b>wait_for_app</b>(_Node, Name, 0) -&gt;
<a name="2818"/> 2818:     {error, Name};
<a name="2819"/> 2819: <b>wait_for_app</b>(Node, Name, N) when is_integer(N), N &gt; 0 -&gt;
<a name="wait_for_app-last_expr"/><a name="2820"/> 2820: <b>    case rpc:call</b>(Node,application,which_applications,[]) of
<a name="2821"/> 2821: 	{badrpc,Reason} -&gt;
<a name="2822"/> 2822: 	    ct:fail({failed_to_get_applications,Reason});
<a name="2823"/> 2823: 	Apps -&gt;
<a name="2824"/> 2824: 	    case lists:member(Name,Apps) of
<a name="2825"/> 2825: 		false -&gt;
<a name="2826"/> 2826: 		    timer:sleep(1000),
<a name="2827"/> 2827: 		    wait_for_app(Node, Name, N-1);
<a name="2828"/> 2828: 		true -&gt;
<a name="2829"/> 2829: 		    ok
<a name="2830"/> 2830: 	    end
<a name="2831"/> 2831:     end.
<a name="2832"/> 2832: 
<a name="2833"/> 2833: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2834"/> 2834: <i>%% Run escript</i>
<a name="2835"/> 2835: 
<a name="run-3"/><a name="2836"/> 2836: <b>run</b>(Dir, Script, Args) -&gt;
<a name="2837"/> 2837:     Cmd0 = filename:rootname(Script) ++ &quot; &quot; ++ Args,
<a name="2838"/> 2838:     Cmd = case os:type() of
<a name="2839"/> 2839:               {win32,_} -&gt; filename:nativename(Dir) ++ &quot;\\&quot; ++ Cmd0;
<a name="2840"/> 2840:               _ -&gt; Cmd0
<a name="2841"/> 2841:           end,
<a name="run-last_expr"/><a name="2842"/> 2842: <b>    do_run</b>(Dir, Cmd).
<a name="2843"/> 2843: 
<a name="run-4"/><a name="2844"/> 2844: <b>run</b>(Dir, Opts, Script, Args) -&gt;
<a name="2845"/> 2845:     Cmd0 = filename:rootname(Script) ++ &quot; &quot; ++ Args,
<a name="2846"/> 2846:     Cmd = case os:type() of
<a name="2847"/> 2847:               {win32,_} -&gt; Opts ++ &quot; &quot; ++ filename:nativename(Dir) ++ &quot;\\&quot; ++ Cmd0;
<a name="2848"/> 2848:               _ -&gt; Opts ++ &quot; &quot; ++ Dir ++ &quot;/&quot; ++ Cmd0
<a name="2849"/> 2849:           end,
<a name="run-last_expr"/><a name="2850"/> 2850: <b>    do_run</b>(Dir, Cmd).
<a name="2851"/> 2851: 
<a name="do_run-2"/><a name="2852"/> 2852: <b>do_run</b>(Dir, Cmd) -&gt;
<a name="2853"/> 2853:     io:format(&quot;Run: ~p\n&quot;, [Cmd]),
<a name="2854"/> 2854:     Env = [{&quot;PATH&quot;,Dir++&quot;:&quot;++os:getenv(&quot;PATH&quot;)},
<a name="2855"/> 2855: 	   {&quot;ERL_FLAGS&quot;,&quot;&quot;},   % Make sure no flags are set that can override
<a name="2856"/> 2856: 	   {&quot;ERL_ZFLAGS&quot;,&quot;&quot;}], % any of the flags set in the escript.
<a name="2857"/> 2857:     Port = open_port({spawn,Cmd}, [exit_status,eof,in,{env,Env}]),
<a name="2858"/> 2858:     Res = get_data(Port, []),
<a name="do_run-last_expr"/><a name="2859"/> 2859:     receive
<a name="2860"/> 2860:         {Port,{exit_status,ExitCode}} -&gt;
<a name="2861"/> 2861:             s2b([Res,&quot;ExitCode:&quot;++integer_to_list(ExitCode)])
<a name="2862"/> 2862:     end.
<a name="2863"/> 2863: 
<a name="get_data-2"/><a name="2864"/> 2864: <b>get_data</b>(Port, SoFar) -&gt;
<a name="get_data-last_expr"/><a name="2865"/> 2865:     receive
<a name="2866"/> 2866:         {Port,{data,Bytes}} -&gt;
<a name="2867"/> 2867:             get_data(Port, [SoFar|Bytes]);
<a name="2868"/> 2868:         {Port,eof} -&gt;
<a name="2869"/> 2869:             erlang:port_close(Port),
<a name="2870"/> 2870:             SoFar
<a name="2871"/> 2871:     end.
<a name="2872"/> 2872: 
<a name="expected_output-2"/><a name="2873"/> 2873: <b>expected_output</b>([data_dir|T], Data) -&gt;
<a name="2874"/> 2874:     Slash = case os:type() of
<a name="2875"/> 2875:                 {win32,_} -&gt; &quot;\\&quot;;
<a name="2876"/> 2876:                 _ -&gt; &quot;/&quot;
<a name="2877"/> 2877:             end,
<a name="2878"/> 2878:     [filename:nativename(Data)++Slash|expected_output(T, Data)];
<a name="2879"/> 2879: <b>expected_output</b>([H|T], Data) -&gt;
<a name="2880"/> 2880:     [H|expected_output(T, Data)];
<a name="2881"/> 2881: <b>expected_output</b>([], _) -&gt; 
<a name="2882"/> 2882:     [];
<a name="2883"/> 2883: <b>expected_output</b>(Bin, _) when is_binary(Bin) -&gt; 
<a name="expected_output-last_expr"/><a name="2884"/> 2884:     Bin.
<a name="2885"/> 2885: 
<a name="2886"/> 2886: <i>%% Convert the given list to a binary with the same encoding as the</i>
<a name="2887"/> 2887: <i>%% file name translation mode</i>
<a name="s2b-1"/><a name="2888"/> 2888: <b>s2b</b>(List) -&gt;
<a name="2889"/> 2889:     Enc = file:native_name_encoding(),
<a name="s2b-last_expr"/><a name="2890"/> 2890: <b>    unicode:characters_to_binary</b>(List,Enc,Enc).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
