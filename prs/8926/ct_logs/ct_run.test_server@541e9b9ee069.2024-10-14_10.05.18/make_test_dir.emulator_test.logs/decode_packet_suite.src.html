<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/decode_packet_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2008-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%% Test suite for erlang:decode_packet/3</i>
<a name="22"/>   22: 
<a name="23"/>   23: <b>-module</b>(decode_packet_SUITE).
<a name="24"/>   24: 
<a name="25"/>   25: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="26"/>   26: 
<a name="27"/>   27: <b>-export</b>([all/0, suite/0,groups/0,
<a name="28"/>   28:          init_per_testcase/2,end_per_testcase/2,
<a name="29"/>   29:          basic/1, ipv6/1, packet_size/1, neg/1, http/1, line/1, ssl/1, otp_8536/1,
<a name="30"/>   30:          otp_9389/1, otp_9389_line/1]).
<a name="31"/>   31: 
<a name="suite-0"/><a name="32"/>   32: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="33"/>   33:     [{ct_hooks,[ts_install_cth]},
<a name="34"/>   34:      {timetrap, {minutes, 1}}].
<a name="35"/>   35: 
<a name="all-0"/><a name="36"/>   36: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="37"/>   37:     [basic, packet_size, neg, http, line, ssl, otp_8536,
<a name="38"/>   38:      otp_9389, otp_9389_line, ipv6].
<a name="39"/>   39: 
<a name="groups-0"/><a name="40"/>   40: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="41"/>   41:     [].
<a name="42"/>   42: 
<a name="init_per_testcase-2"/><a name="43"/>   43: <b>init_per_testcase</b>(Func, Config) when is_atom(Func), is_list(Config) -&gt;
<a name="44"/>   44:     rand:seed(exsplus),
<a name="45"/>   45:     io:format(&quot;*** SEED: ~p ***\n&quot;, [rand:export_seed()]),
<a name="init_per_testcase-last_expr"/><a name="46"/>   46:     Config.
<a name="47"/>   47: 
<a name="end_per_testcase-2"/><a name="48"/>   48: <b>end_per_testcase</b>(_Func, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="49"/>   49:     ok.
<a name="50"/>   50: 
<a name="basic-1"/><a name="51"/>   51: <b>basic</b>(Config) when is_list(Config) -&gt;
<a name="52"/>   52:     Packet = &lt;&lt;101,22,203,54,175&gt;&gt;,
<a name="53"/>   53:     Rest = &lt;&lt;123,34,0,250&gt;&gt;,
<a name="54"/>   54:     Bin = &lt;&lt;Packet/binary,Rest/binary&gt;&gt;,
<a name="55"/>   55:     {ok, Bin, &lt;&lt;&gt;&gt;} = decode_pkt(raw,Bin),
<a name="56"/>   56: 
<a name="57"/>   57:     {more, 5+1} = decode_pkt(1,&lt;&lt;5,1,2,3,4&gt;&gt;),
<a name="58"/>   58:     {more, 5+2} = decode_pkt(2,&lt;&lt;0,5,1,2,3,4&gt;&gt;),
<a name="59"/>   59:     {more, 5+4} = decode_pkt(4,&lt;&lt;0,0,0,5,1,2,3,4&gt;&gt;),
<a name="60"/>   60: 
<a name="61"/>   61:     {more, undefined} = decode_pkt(1,&lt;&lt;&gt;&gt;),
<a name="62"/>   62:     {more, undefined} = decode_pkt(2,&lt;&lt;0&gt;&gt;),
<a name="63"/>   63:     {more, undefined} = decode_pkt(4,&lt;&lt;0,0,0&gt;&gt;),
<a name="64"/>   64: 
<a name="65"/>   65:     Types = [1,2,4,asn1,sunrm,cdr,fcgi,tpkt,ssl_tls],
<a name="66"/>   66: 
<a name="67"/>   67:     %% Run tests for different header types and bit offsets.
<a name="68"/>   68: 
<a name="69"/>   69:     lists:foreach(fun({Type,Bits})-&gt;basic_pack(Type,Packet,Rest,Bits),
<a name="70"/>   70:                                     more_length(Type,Packet,Bits) end,
<a name="71"/>   71:                   [{T,B} || T&lt;-Types, B&lt;-lists:seq(0,32)]),
<a name="basic-last_expr"/><a name="72"/>   72:     ok.
<a name="73"/>   73: 
<a name="basic_pack-4"/><a name="74"/>   74: <b>basic_pack</b>(Type,Body,Rest,BitOffs) -&gt;
<a name="75"/>   75:     {Bin,Unpacked,_} = pack(Type,Body,Rest,BitOffs),
<a name="76"/>   76:     {ok, Unpacked, Rest} = decode_pkt(Type,Bin),
<a name="basic_pack-last_expr"/><a name="77"/>   77:     case Rest of
<a name="78"/>   78:         &lt;&lt;&gt;&gt; -&gt; ok;
<a name="79"/>   79:         _ -&gt; 
<a name="80"/>   80:             &lt;&lt;_, NRest/binary&gt;&gt; = Rest,
<a name="81"/>   81:             basic_pack(Type,Body,NRest,BitOffs)
<a name="82"/>   82:     end.
<a name="83"/>   83: 
<a name="more_length-3"/><a name="84"/>   84: <b>more_length</b>(Type,Body,BitOffs) -&gt;
<a name="85"/>   85:     {Bin,_,_} = pack(Type,Body,&lt;&lt;&gt;&gt;,BitOffs),
<a name="86"/>   86:     HdrSize = byte_size(Bin) - byte_size(Body),
<a name="more_length-last_expr"/><a name="87"/>   87: <b>    more_length_do</b>(Type,HdrSize,Bin,byte_size(Bin)).
<a name="88"/>   88: 
<a name="more_length_do-4"/><a name="89"/>   89: <b>more_length_do</b>(_,_,_,0) -&gt;
<a name="90"/>   90:     ok;
<a name="91"/>   91: <b>more_length_do</b>(Type,HdrSize,Bin,Size) -&gt;
<a name="92"/>   92:     TrySize = (Size*3) div 4,
<a name="93"/>   93:     NSize = if TrySize &lt; HdrSize -&gt; Size - 1;
<a name="94"/>   94:                true -&gt; TrySize
<a name="95"/>   95:             end,
<a name="96"/>   96:     {B1,_} = split_binary(Bin,NSize),
<a name="97"/>   97:     {more, Length} = decode_pkt(Type,B1),
<a name="98"/>   98:     case Length of
<a name="99"/>   99:         L when L=:=byte_size(Bin) -&gt; ok;
<a name="100"/>  100:         undefined when NSize&lt;HdrSize -&gt; ok
<a name="101"/>  101:     end,
<a name="more_length_do-last_expr"/><a name="102"/>  102: <b>    more_length_do</b>(Type,HdrSize,Bin,NSize).
<a name="103"/>  103: 
<a name="104"/>  104: 
<a name="105"/>  105: 
<a name="pack-3"/><a name="106"/>  106: <b>pack</b>(Type,Packet,Rest) -&gt;
<a name="107"/>  107:     {Bin,Unpacked} = pack(Type,Packet),
<a name="pack-last_expr"/><a name="108"/>  108:     {&lt;&lt;Bin/binary,Rest/bits&gt;&gt;,Unpacked}.
<a name="109"/>  109: 
<a name="110"/>  110: <i>%pack(0,B,R,Bits) -&gt; </i>
<a name="111"/>  111: <i>%    pack(raw,B,R,Bits);</i>
<a name="112"/>  112: <i>%pack(raw,Body,Rest,BitOffs) -&gt;</i>
<a name="113"/>  113: <i>%    Orig = &lt;&lt;0:BitOffs,Body/binary,Rest/bits&gt;&gt;,</i>
<a name="114"/>  114: <i>%    &lt;&lt;_:BitOffs,Bin/bits&gt;&gt; = Orig,</i>
<a name="115"/>  115: <i>%    {Bin,&lt;&lt;Bin/binary,Rest/bits&gt;&gt;,Orig};</i>
<a name="pack-4"/><a name="116"/>  116: <b>pack</b>(Type, Body, Rest, BitOffs) -&gt;
<a name="117"/>  117:     {Packet, Unpacked} = pack(Type, Body),
<a name="118"/>  118: 
<a name="119"/>  119:     %% Make Bin a sub-binary with an arbitrary bitoffset within Orig. Note that
<a name="120"/>  120:     %% we do not tolerate the Rest to be a bitstring.
<a name="121"/>  121:     Prefix = rand:uniform(1 bsl BitOffs) - 1,
<a name="122"/>  122:     Orig = &lt;&lt;Prefix:BitOffs, Packet/binary, Rest/binary&gt;&gt;,
<a name="123"/>  123:     &lt;&lt;_:BitOffs, Bin/binary&gt;&gt; = Orig,
<a name="124"/>  124: 
<a name="pack-last_expr"/><a name="125"/>  125:     {Bin, Unpacked, Orig}.
<a name="126"/>  126: 
<a name="pack-2"/><a name="127"/>  127: <b>pack</b>(1,Bin) -&gt;
<a name="128"/>  128:     Psz = byte_size(Bin),
<a name="129"/>  129:     {&lt;&lt;Psz:8,Bin/binary&gt;&gt;, Bin};
<a name="130"/>  130: <b>pack</b>(2,Bin) -&gt;
<a name="131"/>  131:     Psz = byte_size(Bin),
<a name="132"/>  132:     {&lt;&lt;Psz:16,Bin/binary&gt;&gt;, Bin};
<a name="133"/>  133: <b>pack</b>(4,Bin) -&gt;
<a name="134"/>  134:     Psz = byte_size(Bin),
<a name="135"/>  135:     {&lt;&lt;Psz:32,Bin/binary&gt;&gt;, Bin};
<a name="136"/>  136: <b>pack</b>(asn1,Bin) -&gt;
<a name="137"/>  137:     Ident = case rand:uniform(3) of
<a name="138"/>  138:                 1 -&gt; &lt;&lt;17&gt;&gt;;
<a name="139"/>  139:                 2 -&gt; &lt;&lt;16#1f,16#81,17&gt;&gt;;
<a name="140"/>  140:                 3 -&gt; &lt;&lt;16#1f,16#81,16#80,16#80,17&gt;&gt;
<a name="141"/>  141:             end,
<a name="142"/>  142:     Psz = byte_size(Bin),
<a name="143"/>  143:     Length = case rand:uniform(4) of
<a name="144"/>  144:                  1 when Psz &lt; 128 -&gt; 
<a name="145"/>  145:                      &lt;&lt;Psz:8&gt;&gt;;
<a name="146"/>  146:                  R when R=&lt;2 andalso Psz &lt; 16#10000 -&gt;
<a name="147"/>  147:                      &lt;&lt;16#82,Psz:16&gt;&gt;;
<a name="148"/>  148:                  R when R=&lt;3 andalso Psz &lt; 16#1000000 -&gt; 
<a name="149"/>  149:                      &lt;&lt;16#83,Psz:24&gt;&gt;;
<a name="150"/>  150:                  _ when Psz &lt; 16#100000000 -&gt;
<a name="151"/>  151:                      &lt;&lt;16#84,Psz:32&gt;&gt;
<a name="152"/>  152:              end,
<a name="153"/>  153:     Res = &lt;&lt;Ident/binary,Length/binary,Bin/binary&gt;&gt;,
<a name="154"/>  154:     {Res,Res};
<a name="155"/>  155: <b>pack</b>(sunrm,Bin) -&gt;
<a name="156"/>  156:     Psz = byte_size(Bin),
<a name="157"/>  157:     Res = if Psz &lt; 16#80000000 -&gt;
<a name="158"/>  158:                  &lt;&lt;Psz:32,Bin/binary&gt;&gt;
<a name="159"/>  159:           end,
<a name="160"/>  160:     {Res,Res};
<a name="161"/>  161: <b>pack</b>(cdr,Bin) -&gt;
<a name="162"/>  162:     GIOP = &lt;&lt;&quot;GIOP&quot;&gt;&gt;,
<a name="163"/>  163:     Major = rand:uniform(256) - 1,
<a name="164"/>  164:     Minor = rand:uniform(256) - 1,
<a name="165"/>  165:     MType = rand:uniform(256) - 1,
<a name="166"/>  166:     Psz = byte_size(Bin),
<a name="167"/>  167:     Res = case rand:uniform(2) of
<a name="168"/>  168:               1 -&gt; &lt;&lt;GIOP/binary,Major:8,Minor:8,0:8,MType:8,Psz:32/big,Bin/binary&gt;&gt;;
<a name="169"/>  169:               2 -&gt; &lt;&lt;GIOP/binary,Major:8,Minor:8,1:8,MType:8,Psz:32/little,Bin/binary&gt;&gt;
<a name="170"/>  170:           end,
<a name="171"/>  171:     {Res,Res};
<a name="172"/>  172: <b>pack</b>(fcgi,Bin) -&gt;
<a name="173"/>  173:     Ver = 1,
<a name="174"/>  174:     Type = rand:uniform(256) - 1,
<a name="175"/>  175:     Id = rand:uniform(65536) - 1,
<a name="176"/>  176:     PaddSz = rand:uniform(16) - 1,
<a name="177"/>  177:     Psz = byte_size(Bin),
<a name="178"/>  178:     Reserv = rand:uniform(256) - 1,
<a name="179"/>  179:     Padd = rand:bytes(PaddSz),
<a name="180"/>  180:     Res = &lt;&lt;Ver:8,Type:8,Id:16,Psz:16/big,PaddSz:8,Reserv:8,Bin/binary&gt;&gt;,
<a name="181"/>  181:     {&lt;&lt;Res/binary,Padd/binary&gt;&gt;, Res};
<a name="182"/>  182: <b>pack</b>(tpkt,Bin) -&gt;
<a name="183"/>  183:     Ver = 3,
<a name="184"/>  184:     Reserv = rand:uniform(256) - 1,
<a name="185"/>  185:     Size = byte_size(Bin) + 4,
<a name="186"/>  186:     Res = &lt;&lt;Ver:8,Reserv:8,Size:16,Bin/binary&gt;&gt;,
<a name="187"/>  187:     {Res, Res};
<a name="188"/>  188: <b>pack</b>(ssl_tls,Bin) -&gt;
<a name="189"/>  189:     Content = case (rand:uniform(256) - 1) of
<a name="190"/>  190:                   C when C&lt;128 -&gt; C;
<a name="191"/>  191:                   _ -&gt; v2hello
<a name="192"/>  192:               end,
<a name="193"/>  193:     Major = rand:uniform(256) - 1,
<a name="194"/>  194:     Minor = rand:uniform(256) - 1,
<a name="pack-last_expr"/><a name="195"/>  195: <b>    pack_ssl</b>(Content,Major,Minor,Bin).
<a name="196"/>  196: 
<a name="pack_ssl-4"/><a name="197"/>  197: <b>pack_ssl</b>(Content, Major, Minor, Body) -&gt;
<a name="198"/>  198:     case Content of
<a name="199"/>  199:         v2hello -&gt;
<a name="200"/>  200:             Size = byte_size(Body),
<a name="201"/>  201:             Res = &lt;&lt;1:1,(Size+3):15, 1:8, Major:8, Minor:8, Body/binary&gt;&gt;,
<a name="202"/>  202:             C = 22,
<a name="203"/>  203:             Data = &lt;&lt;1:8, (Size+2):24, Major:8, Minor:8, Body/binary&gt;&gt;;
<a name="204"/>  204:         C when is_integer(C) -&gt;
<a name="205"/>  205:             Size = byte_size(Body),
<a name="206"/>  206:             Res = &lt;&lt;Content:8, Major:8, Minor:8, Size:16, Body/binary&gt;&gt;,
<a name="207"/>  207:             Data = Body			    
<a name="208"/>  208:     end,
<a name="pack_ssl-last_expr"/><a name="209"/>  209:     {Res, {ssl_tls,[],C,{Major,Minor}, Data}}.
<a name="210"/>  210: 
<a name="ipv6-1"/><a name="211"/>  211: <b>ipv6</b>(Config) when is_list(Config) -&gt;
<a name="212"/>  212:     %% Test with port
<a name="213"/>  213:     Packet = &lt;&lt;&quot;GET http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:4000/echo_components HTTP/1.1\r\nhost: orange\r\n\r\n&quot;&gt;&gt;,
<a name="214"/>  214:     {ok, {http_request, 'GET',  {absoluteURI, http, &lt;&lt;&quot;[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]&quot;&gt;&gt;, 4000, &lt;&lt;&quot;/echo_components&quot;&gt;&gt;}, {1, 1}}, &lt;&lt;&quot;host: orange\r\n\r\n&quot;&gt;&gt;} =
<a name="215"/>  215:       erlang:decode_packet(http_bin, Packet, []),
<a name="216"/>  216:     %% Test no port
<a name="217"/>  217:     Packet2 = &lt;&lt;&quot;GET http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]/1234 HTTP/1.1\r\nhost: orange\r\n\r\n&quot;&gt;&gt;,
<a name="218"/>  218:     {ok, {http_request, 'GET',  {absoluteURI, http, &lt;&lt;&quot;[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]&quot;&gt;&gt;, undefined, &lt;&lt;&quot;/1234&quot;&gt;&gt;}, {1, 1}}, &lt;&lt;&quot;host: orange\r\n\r\n&quot;&gt;&gt;} =
<a name="219"/>  219:       erlang:decode_packet(http_bin, Packet2, []),
<a name="220"/>  220:     %% Test short ipv6 form
<a name="221"/>  221:     Packet3 = &lt;&lt;&quot;GET http://[::1]/1234 HTTP/1.1\r\nhost: orange\r\n\r\n&quot;&gt;&gt;,
<a name="222"/>  222:     {ok, {http_request, 'GET',  {absoluteURI, http, &lt;&lt;&quot;[::1]&quot;&gt;&gt;, undefined, &lt;&lt;&quot;/1234&quot;&gt;&gt;}, {1, 1}}, &lt;&lt;&quot;host: orange\r\n\r\n&quot;&gt;&gt;} =
<a name="223"/>  223:       erlang:decode_packet(http_bin, Packet3, []),
<a name="224"/>  224:     %% Test missing `]`
<a name="225"/>  225:     Packet4 = &lt;&lt;&quot;GET http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210:4000/echo_components HTTP/1.1\r\nhost: orange\r\n\r\n&quot;&gt;&gt;,
<a name="ipv6-last_expr"/><a name="226"/>  226:     {ok, {http_request, 'GET',  {absoluteURI, http, &lt;&lt;&quot;[FEDC&quot;&gt;&gt;, undefined, &lt;&lt;&quot;/echo_components&quot;&gt;&gt;}, {1, 1}}, &lt;&lt;&quot;host: orange\r\n\r\n&quot;&gt;&gt;} =
<a name="227"/>  227:       erlang:decode_packet(http_bin, Packet4, []).
<a name="228"/>  228: 
<a name="packet_size-1"/><a name="229"/>  229: <b>packet_size</b>(Config) when is_list(Config) -&gt;
<a name="230"/>  230:     Packet = &lt;&lt;101,22,203,54,175&gt;&gt;,
<a name="231"/>  231:     Rest = &lt;&lt;123,34,0,250&gt;&gt;,
<a name="232"/>  232: 
<a name="233"/>  233:     F = fun({Type,Max})-&gt;
<a name="234"/>  234:                 {Bin,Unpacked} = pack(Type,Packet,Rest),
<a name="235"/>  235:                 case decode_pkt(Type,Bin,[{packet_size,Max}]) of
<a name="236"/>  236:                     {ok,Unpacked,Rest} when Max=:=0; Max&gt;=byte_size(Packet) -&gt;
<a name="237"/>  237:                         ok;
<a name="238"/>  238:                     {error,_} when Max&lt;byte_size(Packet), Max=/=0 -&gt;
<a name="239"/>  239:                         ok;
<a name="240"/>  240:                     {error,_} when Type=:=fcgi, Max=/=0 -&gt;
<a name="241"/>  241:                         %% packet includes random amount of padding
<a name="242"/>  242:                         ok
<a name="243"/>  243:                 end
<a name="244"/>  244:         end,
<a name="245"/>  245:     lists:foreach(F, [{T,D} || T&lt;-[1,2,4,asn1,sunrm,cdr,fcgi,tpkt,ssl_tls],
<a name="246"/>  246:                                D&lt;-lists:seq(0, byte_size(Packet)*2)]),
<a name="247"/>  247: 
<a name="248"/>  248:     %% Test OTP-8102, &quot;negative&quot; 4-byte sizes.
<a name="249"/>  249:     lists:foreach(fun(Size) -&gt; 
<a name="250"/>  250:                           {error,_} = decode_pkt(4,&lt;&lt;Size:32,Packet/binary&gt;&gt;)
<a name="251"/>  251:                   end, 
<a name="252"/>  252:                   lists:seq(-10,-1)),
<a name="253"/>  253: 
<a name="254"/>  254:     %% Test OTP-9389, long HTTP header lines.
<a name="255"/>  255:     Opts = [{packet_size, 128}],
<a name="256"/>  256:     Pkt = list_to_binary([&quot;GET / HTTP/1.1\r\nHost: localhost\r\nLink: /&quot;,
<a name="257"/>  257:                           lists:duplicate(64, $Y), &quot;\r\n\r\n&quot;]),
<a name="258"/>  258:     &lt;&lt;Pkt1:50/binary, Pkt2/binary&gt;&gt; = Pkt,
<a name="259"/>  259:     {ok, {http_request,'GET',{abs_path,&quot;/&quot;},{1,1}}, Rest1} =
<a name="260"/>  260:     erlang:decode_packet(http, Pkt1, Opts),
<a name="261"/>  261:     {ok, {http_header,_,'Host',_,&quot;localhost&quot;}, Rest2} =
<a name="262"/>  262:     erlang:decode_packet(httph, Rest1, Opts),
<a name="263"/>  263:     {more, undefined} = erlang:decode_packet(httph, Rest2, Opts),
<a name="264"/>  264:     {ok, {http_header,_,&quot;Link&quot;,_,_}, _} =
<a name="265"/>  265:     erlang:decode_packet(httph, list_to_binary([Rest2, Pkt2]), Opts),
<a name="266"/>  266: 
<a name="267"/>  267:     Pkt3 = list_to_binary([&quot;GET / HTTP/1.1\r\nHost: localhost\r\nLink: /&quot;,
<a name="268"/>  268:                            lists:duplicate(129, $Y), &quot;\r\n\r\n&quot;]),
<a name="269"/>  269:     {ok, {http_request,'GET',{abs_path,&quot;/&quot;},{1,1}}, Rest3} =
<a name="270"/>  270:     erlang:decode_packet(http, Pkt3, Opts),
<a name="271"/>  271:     {ok, {http_header,_,'Host',_,&quot;localhost&quot;}, Rest4} =
<a name="272"/>  272:     erlang:decode_packet(httph, Rest3, Opts),
<a name="273"/>  273:     {error, invalid} = erlang:decode_packet(httph, Rest4, Opts),
<a name="274"/>  274: 
<a name="packet_size-last_expr"/><a name="275"/>  275:     ok.
<a name="276"/>  276: 
<a name="277"/>  277: 
<a name="neg-1"/><a name="278"/>  278: <b>neg</b>(Config) when is_list(Config) -&gt;
<a name="279"/>  279:     Bin = &lt;&lt;&quot;dummy&quot;&gt;&gt;,
<a name="280"/>  280:     Fun = fun()-&gt;dummy end,
<a name="281"/>  281: 
<a name="282"/>  282:     BadargF = fun(T,B,Opts)-&gt; {'EXIT',{badarg,_}} = (catch decode_pkt(T,B,Opts)) end,
<a name="283"/>  283: 
<a name="284"/>  284:     %% Invalid Type args
<a name="285"/>  285:     lists:foreach(fun(T)-&gt; BadargF(T,Bin,[]) end, 
<a name="286"/>  286:                   [3,-1,5,2.0,{2},unknown,[],&quot;line&quot;,Bin,Fun,self()]),
<a name="287"/>  287: 
<a name="288"/>  288:     %% Invalid Bin args
<a name="289"/>  289:     lists:foreach(fun(B)-&gt; BadargF(0,B,[]) end, 
<a name="290"/>  290:                   [3,2.0,unknown,[],&quot;Bin&quot;,[Bin],{Bin},Fun,self()]),
<a name="291"/>  291: 
<a name="292"/>  292:     %% Invalid options
<a name="293"/>  293:     InvOpts = [2,false,self(),Bin,&quot;Options&quot;,Fun,
<a name="294"/>  294:                packet_size,{packet_size},{packet_size,0,false},
<a name="295"/>  295:                {packet_size,-1},{packet_size,100.0},{packet_size,false},
<a name="296"/>  296:                {line_length,-1},{line_length,100.0},{line_length,false}],
<a name="297"/>  297: 
<a name="298"/>  298:     lists:foreach(fun(Opt)-&gt; BadargF(0,Bin,Opt),
<a name="299"/>  299:                              BadargF(0,Bin,[Opt]),
<a name="300"/>  300:                              BadargF(0,Bin,[Opt,{packet_size,1000}]),
<a name="301"/>  301:                              BadargF(0,Bin,[{packet_size,1000},Opt]) end,
<a name="302"/>  302:                   InvOpts),
<a name="neg-last_expr"/><a name="303"/>  303:     ok.
<a name="304"/>  304: 
<a name="305"/>  305: 
<a name="http-1"/><a name="306"/>  306: <b>http</b>(Config) when is_list(Config) -&gt;
<a name="307"/>  307:     &lt;&lt;&quot;foo&quot;&gt;&gt; = http_do(http_request(&quot;foo&quot;)),
<a name="308"/>  308:     &lt;&lt;&quot; bar&quot;&gt;&gt; = http_do(http_request(&quot; bar&quot;)),
<a name="309"/>  309:     &lt;&lt;&quot;Hello!&quot;&gt;&gt; = http_do(http_response(&quot;Hello!&quot;)),
<a name="310"/>  310: 
<a name="311"/>  311:     %% Test all known header atoms
<a name="312"/>  312:     Val = &quot;dummy value&quot;,
<a name="313"/>  313:     ValB = list_to_binary(Val),
<a name="314"/>  314:     Rest = &lt;&lt;&quot;Rest&quot;&gt;&gt;,    
<a name="315"/>  315:     HdrF = fun(Str,N) -&gt;  
<a name="316"/>  316:                    StrA = list_to_atom(Str),
<a name="317"/>  317:                    StrB = list_to_binary(Str),
<a name="318"/>  318:                    Bin = &lt;&lt;StrB/binary,&quot;: &quot;,ValB/binary,&quot;\r\n&quot;,Rest/binary&gt;&gt;,
<a name="319"/>  319:                    {ok, {http_header,N,StrA,Str,Val}, Rest} = decode_pkt(httph,Bin),
<a name="320"/>  320:                    {ok, {http_header,N,StrA,StrB,ValB}, Rest} = decode_pkt(httph_bin,Bin),
<a name="321"/>  321:                    N + 1
<a name="322"/>  322:            end,
<a name="323"/>  323:     lists:foldl(HdrF, 1, http_hdr_strings()),
<a name="324"/>  324: 
<a name="325"/>  325:     %% Test all known method atoms
<a name="326"/>  326:     MethF = fun(Meth) -&gt;  
<a name="327"/>  327:                     MethA = list_to_atom(Meth),
<a name="328"/>  328:                     MethB = list_to_binary(Meth),
<a name="329"/>  329:                     Bin = &lt;&lt;MethB/binary,&quot; /invalid/url HTTP/1.0\r\n&quot;,Rest/binary&gt;&gt;,
<a name="330"/>  330:                     {ok, {http_request,MethA,{abs_path,&quot;/invalid/url&quot;},{1,0}},
<a name="331"/>  331:                      Rest} = decode_pkt(http,Bin),
<a name="332"/>  332:                     {ok, {http_request,MethA,{abs_path,&lt;&lt;&quot;/invalid/url&quot;&gt;&gt;},{1,0}},
<a name="333"/>  333:                      Rest} = decode_pkt(http_bin,Bin)
<a name="334"/>  334:             end,
<a name="335"/>  335:     lists:foreach(MethF, http_meth_strings()),
<a name="336"/>  336: 
<a name="337"/>  337:     %% Test all uri variants    
<a name="338"/>  338:     UriF = fun({Str,ResL,ResB}) -&gt; 
<a name="339"/>  339:                    Bin = &lt;&lt;&quot;GET &quot;,(list_to_binary(Str))/binary,&quot; HTTP/1.1\r\n&quot;,Rest/binary&gt;&gt;,
<a name="340"/>  340:                    {ok, {http_request, 'GET', ResL, {1,1}}, Rest} = decode_pkt(http,Bin),
<a name="341"/>  341:                    {ok, {http_request, 'GET', ResB, {1,1}}, Rest} = decode_pkt(http_bin,Bin) 
<a name="342"/>  342:            end,
<a name="343"/>  343:     lists:foreach(UriF, http_uri_variants()),
<a name="344"/>  344: 
<a name="345"/>  345:     %% Response with empty phrase
<a name="346"/>  346:     {ok,{http_response,{1,1},200,[]},&lt;&lt;&gt;&gt;} = decode_pkt(http, &lt;&lt;&quot;HTTP/1.1 200\r\n&quot;&gt;&gt;, []),
<a name="347"/>  347:     {ok,{http_response,{1,1},200,&lt;&lt;&gt;&gt;},&lt;&lt;&gt;&gt;} = decode_pkt(http_bin, &lt;&lt;&quot;HTTP/1.1 200\r\n&quot;&gt;&gt;, []),
<a name="348"/>  348: 
<a name="349"/>  349: 
<a name="350"/>  350:     %% Test error cases
<a name="351"/>  351:     {ok,{http_error,&quot;Host\t: localhost:8000\r\n&quot;},&lt;&lt;&quot;a&quot;&gt;&gt;} =
<a name="352"/>  352:         decode_pkt(httph, &lt;&lt;&quot;Host\t: localhost:8000\r\na&quot;&gt;&gt;, []),
<a name="353"/>  353:     {ok,{http_error,&quot;Host : localhost:8000\r\n&quot;},&lt;&lt;&quot;a&quot;&gt;&gt;} =
<a name="354"/>  354:         decode_pkt(httph, &lt;&lt;&quot;Host : localhost:8000\r\na&quot;&gt;&gt;, []),
<a name="355"/>  355:     {ok,{http_error,&quot; : localhost:8000\r\n&quot;},&lt;&lt;&quot;a&quot;&gt;&gt;} =
<a name="356"/>  356:         decode_pkt(httph, &lt;&lt;&quot; : localhost:8000\r\na&quot;&gt;&gt;, []),
<a name="http-last_expr"/><a name="357"/>  357:     ok.
<a name="358"/>  358: 
<a name="http_with_bin-1"/><a name="359"/>  359: <b>http_with_bin</b>(http) -&gt;
<a name="360"/>  360:     http_bin;
<a name="361"/>  361: <b>http_with_bin</b>(httph) -&gt;
<a name="http_with_bin-last_expr"/><a name="362"/>  362:     httph_bin.
<a name="363"/>  363: 
<a name="http_do-1"/><a name="364"/>  364: <b>http_do</b>(Tup) -&gt;
<a name="http_do-last_expr"/><a name="365"/>  365: <b>    http_do</b>(Tup,http).
<a name="http_do-2"/><a name="366"/>  366: <b>http_do</b>({Bin, []}, _) -&gt;
<a name="367"/>  367:     Bin;
<a name="368"/>  368: <b>http_do</b>({Bin,[{_Line,PL,PB}|Tail]}, Type) -&gt;
<a name="369"/>  369:     {ok, PL, Rest} = decode_pkt(Type,Bin),
<a name="370"/>  370:     {ok, PB, Rest} = decode_pkt(http_with_bin(Type),Bin),
<a name="371"/>  371: 
<a name="372"/>  372:     %% Same tests again but as SubBin
<a name="373"/>  373:     PreLen = rand:uniform(64),
<a name="374"/>  374:     Prefix = rand:uniform(1 bsl PreLen) - 1,
<a name="375"/>  375:     SufLen = rand:uniform(64),
<a name="376"/>  376:     Suffix = rand:uniform(1 bsl SufLen) - 1,
<a name="377"/>  377:     Orig = &lt;&lt;Prefix:PreLen, Bin/bits, Suffix:SufLen&gt;&gt;,
<a name="378"/>  378:     BinLen = bit_size(Bin),
<a name="379"/>  379:     &lt;&lt;_:PreLen, SubBin:BinLen/bits, _/bits&gt;&gt; = Orig, % Make SubBin
<a name="380"/>  380:     SubBin = Bin, % just to make sure
<a name="381"/>  381: 
<a name="382"/>  382:     {ok, PL, Rest} = decode_pkt(Type,SubBin),
<a name="383"/>  383:     {ok, PB, Rest} = decode_pkt(http_with_bin(Type),SubBin),
<a name="http_do-last_expr"/><a name="384"/>  384: <b>    http_do</b>({Rest, Tail}, httph).
<a name="385"/>  385: 
<a name="http_request-1"/><a name="386"/>  386: <b>http_request</b>(Msg) -&gt;
<a name="387"/>  387:     QnA = [{&quot;POST /invalid/url HTTP/1.1\r\n&quot;,
<a name="388"/>  388:             {http_request, 'POST', {abs_path,  &quot;/invalid/url&quot;  }, {1,1}},
<a name="389"/>  389:             {http_request, 'POST', {abs_path,&lt;&lt;&quot;/invalid/url&quot;&gt;&gt;}, {1,1}}},
<a name="390"/>  390:            {&quot;Connection: close\r\n&quot;,
<a name="391"/>  391:             {http_header,2,'Connection',  &quot;Connection&quot;  ,  &quot;close&quot;},
<a name="392"/>  392:             {http_header,2,'Connection',&lt;&lt;&quot;Connection&quot;&gt;&gt;,&lt;&lt;&quot;close&quot;&gt;&gt;}},
<a name="393"/>  393:            {&quot;User-Agent: perl post\r\n&quot;,
<a name="394"/>  394:             {http_header,24,'User-Agent',  &quot;User-Agent&quot;  ,  &quot;perl post&quot;},
<a name="395"/>  395:             {http_header,24,'User-Agent',&lt;&lt;&quot;User-Agent&quot;&gt;&gt;,&lt;&lt;&quot;perl post&quot;&gt;&gt;}},
<a name="396"/>  396:            {&quot;Content-Length: 4\r\n&quot;,
<a name="397"/>  397:             {http_header,38,'Content-Length',  &quot;Content-Length&quot;  ,  &quot;4&quot;},
<a name="398"/>  398:             {http_header,38,'Content-Length',&lt;&lt;&quot;Content-Length&quot;&gt;&gt;,&lt;&lt;&quot;4&quot;&gt;&gt;}},
<a name="399"/>  399:            {&quot;Content-Type: text/xml; charset=utf-8\r\n&quot;,
<a name="400"/>  400:             {http_header,42,'Content-Type',  &quot;Content-Type&quot;  ,  &quot;text/xml; charset=utf-8&quot;},
<a name="401"/>  401:             {http_header,42,'Content-Type',&lt;&lt;&quot;Content-Type&quot;&gt;&gt;,&lt;&lt;&quot;text/xml; charset=utf-8&quot;&gt;&gt;}},
<a name="402"/>  402:            {&quot;Other-Field: with some text\r\n&quot;,
<a name="403"/>  403:             {http_header,0,  &quot;Other-Field&quot;  ,  &quot;Other-Field&quot;  ,  &quot;with some text&quot;},
<a name="404"/>  404:             {http_header,0,&lt;&lt;&quot;Other-Field&quot;&gt;&gt;,&lt;&lt;&quot;Other-Field&quot;&gt;&gt;,&lt;&lt;&quot;with some text&quot;&gt;&gt;}},
<a name="405"/>  405:            {&quot;Content--Type: text/xml; charset=utf-8\r\n&quot;,
<a name="406"/>  406:             {http_header,0,  &quot;Content--type&quot;  ,  &quot;Content--Type&quot;  ,  &quot;text/xml; charset=utf-8&quot;},
<a name="407"/>  407:             {http_header,0,&lt;&lt;&quot;Content--type&quot;&gt;&gt;,&lt;&lt;&quot;Content--Type&quot;&gt;&gt;,&lt;&lt;&quot;text/xml; charset=utf-8&quot;&gt;&gt;}},
<a name="408"/>  408:            {&quot;Content---Type: text/xml; charset=utf-8\r\n&quot;,
<a name="409"/>  409:             {http_header,0,  &quot;Content---Type&quot;  ,  &quot;Content---Type&quot;  ,  &quot;text/xml; charset=utf-8&quot;},
<a name="410"/>  410:             {http_header,0,&lt;&lt;&quot;Content---Type&quot;&gt;&gt;,&lt;&lt;&quot;Content---Type&quot;&gt;&gt;,&lt;&lt;&quot;text/xml; charset=utf-8&quot;&gt;&gt;}},
<a name="411"/>  411:            {&quot;CONTENT-type: text/xml; charset=utf-8\r\n&quot;,
<a name="412"/>  412:             {http_header,42,'Content-Type',  &quot;CONTENT-type&quot;  ,  &quot;text/xml; charset=utf-8&quot;},
<a name="413"/>  413:             {http_header,42,'Content-Type',&lt;&lt;&quot;CONTENT-type&quot;&gt;&gt;,&lt;&lt;&quot;text/xml; charset=utf-8&quot;&gt;&gt;}},
<a name="414"/>  414:            {&quot;OTHER-field: with some text\r\n&quot;,
<a name="415"/>  415:             {http_header,0,  &quot;Other-Field&quot;  ,  &quot;OTHER-field&quot;  ,  &quot;with some text&quot;},
<a name="416"/>  416:             {http_header,0,&lt;&lt;&quot;Other-Field&quot;&gt;&gt;,&lt;&lt;&quot;OTHER-field&quot;&gt;&gt;,&lt;&lt;&quot;with some text&quot;&gt;&gt;}},
<a name="417"/>  417:            {&quot;Make-sure-a-LONG-HEaDer-fIeLd-is-fORMATTED-NicelY: with some text\r\n&quot;,
<a name="418"/>  418:             {http_header,0,  &quot;Make-Sure-A-Long-Header-Field-Is-Formatted-Nicely&quot;  ,  &quot;Make-sure-a-LONG-HEaDer-fIeLd-is-fORMATTED-NicelY&quot;  ,  &quot;with some text&quot;},
<a name="419"/>  419:             {http_header,0,&lt;&lt;&quot;Make-Sure-A-Long-Header-Field-Is-Formatted-Nicely&quot;&gt;&gt;,&lt;&lt;&quot;Make-sure-a-LONG-HEaDer-fIeLd-is-fORMATTED-NicelY&quot;&gt;&gt;,&lt;&lt;&quot;with some text&quot;&gt;&gt;}},
<a name="420"/>  420:            {&quot;Multi-Line: Once upon a time in a land far far away,\r\n&quot;
<a name="421"/>  421:             &quot; there lived a princess imprisoned in the highest tower\r\n&quot;
<a name="422"/>  422:             &quot; of the most haunted castle.\r\n&quot;,
<a name="423"/>  423:             {http_header,0,  &quot;Multi-Line&quot;  ,  &quot;Multi-Line&quot;  ,  &quot;Once upon a time in a land far far away,\r\n there lived a princess imprisoned in the highest tower\r\n of the most haunted castle.&quot;},
<a name="424"/>  424:             {http_header,0,&lt;&lt;&quot;Multi-Line&quot;&gt;&gt;,&lt;&lt;&quot;Multi-Line&quot;&gt;&gt;,&lt;&lt;&quot;Once upon a time in a land far far away,\r\n there lived a princess imprisoned in the highest tower\r\n of the most haunted castle.&quot;&gt;&gt;}},
<a name="425"/>  425:            {&quot;\r\n&quot;,
<a name="426"/>  426:             http_eoh,
<a name="427"/>  427:             http_eoh}],
<a name="428"/>  428:     Bin = lists:foldl(fun({Line,_,_},Acc) -&gt; LineBin = list_to_binary(Line), 
<a name="429"/>  429:                                              &lt;&lt;Acc/binary,LineBin/binary&gt;&gt; end,
<a name="430"/>  430:                       &lt;&lt;&quot;&quot;&gt;&gt;, QnA),
<a name="431"/>  431:     MsgBin = list_to_binary(Msg),
<a name="http_request-last_expr"/><a name="432"/>  432:     {&lt;&lt;Bin/binary,MsgBin/binary&gt;&gt;, QnA}.
<a name="433"/>  433: 
<a name="434"/>  434: 
<a name="http_response-1"/><a name="435"/>  435: <b>http_response</b>(Msg) -&gt;
<a name="436"/>  436:     QnA = [{&quot;HTTP/1.0 404 Object Not Found\r\n&quot;,
<a name="437"/>  437:             {http_response, {1,0}, 404,   &quot;Object Not Found&quot;},
<a name="438"/>  438:             {http_response, {1,0}, 404, &lt;&lt;&quot;Object Not Found&quot;&gt;&gt;}},
<a name="439"/>  439:            {&quot;Server: inets/4.7.16\r\n&quot;,
<a name="440"/>  440:             {http_header, 30, 'Server',   &quot;Server&quot;  ,   &quot;inets/4.7.16&quot;},
<a name="441"/>  441:             {http_header, 30, 'Server', &lt;&lt;&quot;Server&quot;&gt;&gt;, &lt;&lt;&quot;inets/4.7.16&quot;&gt;&gt;}},
<a name="442"/>  442:            {&quot;Date: Fri, 04 Jul 2008 17:16:22 GMT\r\n&quot;,
<a name="443"/>  443:             {http_header, 3, 'Date',   &quot;Date&quot;  ,   &quot;Fri, 04 Jul 2008 17:16:22 GMT&quot;},
<a name="444"/>  444:             {http_header, 3, 'Date', &lt;&lt;&quot;Date&quot;&gt;&gt;, &lt;&lt;&quot;Fri, 04 Jul 2008 17:16:22 GMT&quot;&gt;&gt;}},
<a name="445"/>  445:            {&quot;Content-Type: text/html\r\n&quot;,
<a name="446"/>  446:             {http_header, 42, 'Content-Type',   &quot;Content-Type&quot;  ,   &quot;text/html&quot;},
<a name="447"/>  447:             {http_header, 42, 'Content-Type', &lt;&lt;&quot;Content-Type&quot;&gt;&gt;, &lt;&lt;&quot;text/html&quot;&gt;&gt;}},
<a name="448"/>  448:            {&quot;Content-Length: 207\r\n&quot;,
<a name="449"/>  449:             {http_header, 38, 'Content-Length',   &quot;Content-Length&quot;  ,   &quot;207&quot;},
<a name="450"/>  450:             {http_header, 38, 'Content-Length', &lt;&lt;&quot;Content-Length&quot;&gt;&gt;, &lt;&lt;&quot;207&quot;&gt;&gt;}},
<a name="451"/>  451:            {&quot;\r\n&quot;,
<a name="452"/>  452:             http_eoh,
<a name="453"/>  453:             http_eoh}],
<a name="454"/>  454: 
<a name="455"/>  455: 
<a name="456"/>  456: 
<a name="457"/>  457:     Bin = lists:foldl(fun({Line,_,_},Acc) -&gt; LineBin = list_to_binary(Line), 
<a name="458"/>  458:                                              &lt;&lt;Acc/binary,LineBin/binary&gt;&gt; end,
<a name="459"/>  459:                       &lt;&lt;&quot;&quot;&gt;&gt;, QnA),
<a name="460"/>  460:     MsgBin = list_to_binary(Msg),
<a name="http_response-last_expr"/><a name="461"/>  461:     {&lt;&lt;Bin/binary,MsgBin/binary&gt;&gt;, QnA}.
<a name="462"/>  462: 
<a name="http_hdr_strings-0"/><a name="463"/>  463: <b>http_hdr_strings</b>() -&gt;
<a name="464"/>  464:     %% Must be correct order
<a name="http_hdr_strings-last_expr"/><a name="465"/>  465:     [&quot;Cache-Control&quot;,&quot;Connection&quot;,&quot;Date&quot;,&quot;Pragma&quot;,&quot;Transfer-Encoding&quot;,
<a name="466"/>  466:      &quot;Upgrade&quot;,&quot;Via&quot;,&quot;Accept&quot;, &quot;Accept-Charset&quot;, &quot;Accept-Encoding&quot;,
<a name="467"/>  467:      &quot;Accept-Language&quot;, &quot;Authorization&quot;,&quot;From&quot;,&quot;Host&quot;,&quot;If-Modified-Since&quot;,
<a name="468"/>  468:      &quot;If-Match&quot;,&quot;If-None-Match&quot;,&quot;If-Range&quot;,&quot;If-Unmodified-Since&quot;,&quot;Max-Forwards&quot;,
<a name="469"/>  469:      &quot;Proxy-Authorization&quot;,&quot;Range&quot;,&quot;Referer&quot;,&quot;User-Agent&quot;,&quot;Age&quot;,&quot;Location&quot;,
<a name="470"/>  470:      &quot;Proxy-Authenticate&quot;,&quot;Public&quot;,&quot;Retry-After&quot;,&quot;Server&quot;,&quot;Vary&quot;,&quot;Warning&quot;,
<a name="471"/>  471:      &quot;Www-Authenticate&quot;,&quot;Allow&quot;,&quot;Content-Base&quot;,&quot;Content-Encoding&quot;,
<a name="472"/>  472:      &quot;Content-Language&quot;,&quot;Content-Length&quot;,&quot;Content-Location&quot;,&quot;Content-Md5&quot;,
<a name="473"/>  473:      &quot;Content-Range&quot;,&quot;Content-Type&quot;,&quot;Etag&quot;,&quot;Expires&quot;,&quot;Last-Modified&quot;,
<a name="474"/>  474:      &quot;Accept-Ranges&quot;,&quot;Set-Cookie&quot;,&quot;Set-Cookie2&quot;,&quot;X-Forwarded-For&quot;,&quot;Cookie&quot;,
<a name="475"/>  475:      &quot;Keep-Alive&quot;,&quot;Proxy-Connection&quot;].
<a name="476"/>  476: 
<a name="http_meth_strings-0"/><a name="477"/>  477: <b>http_meth_strings</b>() -&gt;
<a name="http_meth_strings-last_expr"/><a name="478"/>  478:     [&quot;OPTIONS&quot;, &quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;TRACE&quot;].
<a name="479"/>  479: 
<a name="http_uri_variants-0"/><a name="480"/>  480: <b>http_uri_variants</b>() -&gt;
<a name="http_uri_variants-last_expr"/><a name="481"/>  481:     [{&quot;*&quot;, '*', '*'},
<a name="482"/>  482:      {&quot;http://tools.ietf.org/html/rfc3986&quot;,
<a name="483"/>  483:       {absoluteURI,http,  &quot;tools.ietf.org&quot;,  undefined,  &quot;/html/rfc3986&quot;},
<a name="484"/>  484:       {absoluteURI,http,&lt;&lt;&quot;tools.ietf.org&quot;&gt;&gt;,undefined,&lt;&lt;&quot;/html/rfc3986&quot;&gt;&gt;}},
<a name="485"/>  485:      {&quot;http://otp.ericsson.se:8000/product/internal/&quot;,
<a name="486"/>  486:       {absoluteURI,http,  &quot;otp.ericsson.se&quot;  ,8000,  &quot;/product/internal/&quot;},
<a name="487"/>  487:       {absoluteURI,http,&lt;&lt;&quot;otp.ericsson.se&quot;&gt;&gt;,8000,&lt;&lt;&quot;/product/internal/&quot;&gt;&gt;}},
<a name="488"/>  488:      {&quot;https://example.com:8042/over/there?name=ferret#nose&quot;,
<a name="489"/>  489:       {absoluteURI,https,  &quot;example.com&quot;,  8042,  &quot;/over/there?name=ferret#nose&quot;},
<a name="490"/>  490:       {absoluteURI,https,&lt;&lt;&quot;example.com&quot;&gt;&gt;,8042,&lt;&lt;&quot;/over/there?name=ferret#nose&quot;&gt;&gt;}},
<a name="491"/>  491:      {&quot;ftp://cnn.example.com&amp;story=breaking_news@10.0.0.1/top_story.htm&quot;,
<a name="492"/>  492:       {scheme,  &quot;ftp&quot;,    &quot;//cnn.example.com&amp;story=breaking_news@10.0.0.1/top_story.htm&quot;},
<a name="493"/>  493:       {scheme,&lt;&lt;&quot;ftp&quot;&gt;&gt;,&lt;&lt;&quot;//cnn.example.com&amp;story=breaking_news@10.0.0.1/top_story.htm&quot;&gt;&gt;}},
<a name="494"/>  494:      {&quot;/some/absolute/path&quot;,
<a name="495"/>  495:       {abs_path,  &quot;/some/absolute/path&quot;},
<a name="496"/>  496:       {abs_path,&lt;&lt;&quot;/some/absolute/path&quot;&gt;&gt;}},
<a name="497"/>  497:      {&quot;something_else&quot;, &quot;something_else&quot;, &lt;&lt;&quot;something_else&quot;&gt;&gt;}].
<a name="498"/>  498: 
<a name="499"/>  499: 
<a name="line-1"/><a name="500"/>  500: <b>line</b>(Config) when is_list(Config) -&gt;
<a name="501"/>  501:     Text = &lt;&lt;&quot;POST /invalid/url HTTP/1.1\r\n&quot;
<a name="502"/>  502:              &quot;Connection: close\r\n&quot;
<a name="503"/>  503:              &quot;Host\t : localhost:8000\r\n&quot;
<a name="504"/>  504:              &quot;User-Agent: perl post\r\n&quot;
<a name="505"/>  505:              &quot;Content-Length: 4\r\n&quot;
<a name="506"/>  506:              &quot;Content-Type: text/xml; charset=utf-8\r\n&quot;
<a name="507"/>  507:              &quot;Other-Field: with some text\r\n&quot;
<a name="508"/>  508:              &quot;Multi-Line: Once upon a time in a land far far away,\r\n&quot;
<a name="509"/>  509:              &quot; there lived a princess imprisoned in the highest tower\r\n&quot;
<a name="510"/>  510:              &quot; of the most haunted castle.\r\n&quot;
<a name="511"/>  511:              &quot;\r\nThe residue&quot;&gt;&gt;,
<a name="512"/>  512: 
<a name="513"/>  513:     lists:foreach(fun(MaxLen) -&gt; line_do(Text,MaxLen) end,
<a name="514"/>  514:                   [0,7,19,29,37]),
<a name="line-last_expr"/><a name="515"/>  515:     ok.
<a name="516"/>  516: 
<a name="line_do-2"/><a name="517"/>  517: <b>line_do</b>(Bin,MaxLen) -&gt;
<a name="518"/>  518:     Res = decode_pkt(line,Bin,[{line_length,MaxLen}]),
<a name="519"/>  519:     MyRes = decode_line(Bin,MaxLen),
<a name="520"/>  520:     MyRes = Res,
<a name="line_do-last_expr"/><a name="521"/>  521:     case Res of
<a name="522"/>  522:         {ok,_,Rest} -&gt;
<a name="523"/>  523:             line_do(Rest,MaxLen);
<a name="524"/>  524:         {more,undefined} -&gt;
<a name="525"/>  525:             ok
<a name="526"/>  526:     end.
<a name="527"/>  527: 
<a name="528"/>  528: <i>% Emulates decode_packet(line,Bin,[{line_length,MaxLen}])</i>
<a name="decode_line-2"/><a name="529"/>  529: <b>decode_line</b>(Bin,MaxLen) -&gt;
<a name="decode_line-last_expr"/><a name="530"/>  530: <b>    case find_in_binary</b>($\n,Bin) of
<a name="531"/>  531:         notfound when MaxLen&gt;0 andalso byte_size(Bin) &gt;= MaxLen -&gt;
<a name="532"/>  532:             {LineB,Rest} = split_binary(Bin,MaxLen),
<a name="533"/>  533:             {ok,LineB,Rest};
<a name="534"/>  534:         notfound -&gt;
<a name="535"/>  535:             {more,undefined};
<a name="536"/>  536:         Pos when MaxLen&gt;0 andalso Pos &gt; MaxLen -&gt;
<a name="537"/>  537:             {LineB,Rest} = split_binary(Bin,MaxLen),
<a name="538"/>  538:             {ok,LineB,Rest};
<a name="539"/>  539:         Pos -&gt;
<a name="540"/>  540:             {LineB,Rest} = split_binary(Bin,Pos),
<a name="541"/>  541:             {ok,LineB,Rest}
<a name="542"/>  542:     end.
<a name="543"/>  543: 
<a name="find_in_binary-2"/><a name="544"/>  544: <b>find_in_binary</b>(Byte, Bin) -&gt;
<a name="find_in_binary-last_expr"/><a name="545"/>  545: <b>    case string:find</b>(Bin, [Byte]) of
<a name="546"/>  546:         nomatch -&gt; notfound;
<a name="547"/>  547:         Suffix -&gt; byte_size(Bin) - byte_size(Suffix) + 1
<a name="548"/>  548:     end.    
<a name="549"/>  549: 
<a name="ssl-1"/><a name="550"/>  550: <b>ssl</b>(Config) when is_list(Config) -&gt;
<a name="551"/>  551:     Major = 34,
<a name="552"/>  552:     Minor = 17,
<a name="553"/>  553:     Body = &lt;&lt;234,189,73,199,1,32,4,0,254&gt;&gt;,
<a name="554"/>  554:     Rest = &lt;&lt;23,123,203,12,234&gt;&gt;,
<a name="555"/>  555: 
<a name="556"/>  556:     F = fun(Content) -&gt;
<a name="557"/>  557:                 {Packet,Unpacked} = pack_ssl(Content, Major, Minor, Body),
<a name="558"/>  558:                 Bin = &lt;&lt;Packet/binary,Rest/binary&gt;&gt;,
<a name="559"/>  559:                 {ok, Unpacked, Rest} = decode_pkt(ssl_tls, Bin)
<a name="560"/>  560:         end,    
<a name="561"/>  561:     F(25),
<a name="562"/>  562:     F(v2hello),
<a name="ssl-last_expr"/><a name="563"/>  563:     ok.
<a name="564"/>  564: 
<a name="565"/>  565: <i>%% Corrupt sub-binary-strings from httph_bin</i>
<a name="otp_8536-1"/><a name="566"/>  566: <b>otp_8536</b>(Config) when is_list(Config) -&gt;
<a name="567"/>  567:     lists:foreach(fun otp_8536_do/1, lists:seq(1,50)),
<a name="otp_8536-last_expr"/><a name="568"/>  568:     ok.
<a name="569"/>  569: 
<a name="otp_8536_do-1"/><a name="570"/>  570: <b>otp_8536_do</b>(N) -&gt;
<a name="571"/>  571:     Data = &lt;&lt;&quot;some data 123&quot;&gt;&gt;,
<a name="572"/>  572:     Letters = &lt;&lt;&quot;bcdefghijklmnopqrstuvwxyzyxwvutsrqponmlkjihgfedcba&quot;&gt;&gt;,
<a name="573"/>  573:     &lt;&lt;HdrTail:N/binary,_/binary&gt;&gt; = Letters,
<a name="574"/>  574:     Hdr = &lt;&lt;$A, HdrTail/binary&gt;&gt;,
<a name="575"/>  575:     Bin = &lt;&lt;Hdr/binary, &quot;: &quot;, Data/binary, &quot;\r\n\r\n&quot;&gt;&gt;,
<a name="576"/>  576: 
<a name="577"/>  577:     io:format(&quot;Bin='~p'\n&quot;,[Bin]),
<a name="578"/>  578:     {ok,{http_header,0,Hdr2,Hdr2,Data2},&lt;&lt;&quot;\r\n&quot;&gt;&gt;} = decode_pkt(httph_bin, Bin,  []),
<a name="579"/>  579: 
<a name="580"/>  580:     %% Do something to trash the C-stack, how about another decode_packet:
<a name="581"/>  581:     decode_pkt(httph_bin,&lt;&lt;Letters/binary, &quot;: &quot;, Data/binary, &quot;\r\n\r\n&quot;&gt;&gt;, []),
<a name="582"/>  582: 
<a name="583"/>  583:     %% Now check that we got the expected binaries
<a name="otp_8536_do-last_expr"/><a name="584"/>  584:     {Hdr, Data} = {Hdr2, Data2}.
<a name="585"/>  585: 
<a name="decode_pkt-2"/><a name="586"/>  586: <b>decode_pkt</b>(Type,Bin) -&gt;
<a name="decode_pkt-last_expr"/><a name="587"/>  587: <b>    decode_pkt</b>(Type,Bin,[]).		       
<a name="decode_pkt-3"/><a name="588"/>  588: <b>decode_pkt</b>(Type,Bin,Opts) -&gt;
<a name="589"/>  589:     %%io:format(&quot;decode_packet(~p,~p,~p)\n&quot;,[Type,Bin,Opts]),
<a name="590"/>  590:     Res = erlang:decode_packet(Type,Bin,Opts),
<a name="591"/>  591:     %%io:format(&quot; -&gt; ~p\n&quot;,[Res]),
<a name="decode_pkt-last_expr"/><a name="592"/>  592:     Res.
<a name="593"/>  593: 
<a name="594"/>  594: <i>%% Verify line_length works correctly for HTTP headers</i>
<a name="otp_9389-1"/><a name="595"/>  595: <b>otp_9389</b>(Config) when is_list(Config) -&gt;
<a name="596"/>  596:     Opts = [{packet_size, 16384}, {line_length, 3000}],
<a name="597"/>  597:     Pkt = list_to_binary([&quot;GET / HTTP/1.1\r\nHost: localhost\r\nLink: /&quot;,
<a name="598"/>  598:                           lists:duplicate(8192, $X),
<a name="599"/>  599:                           &quot;\r\nContent-Length: 0\r\n\r\n&quot;]),
<a name="600"/>  600:     &lt;&lt;Pkt1:5000/binary, Pkt2/binary&gt;&gt; = Pkt,
<a name="601"/>  601:     {ok, {http_request,'GET',{abs_path,&quot;/&quot;},{1,1}}, Rest1} =
<a name="602"/>  602:     erlang:decode_packet(http, Pkt1, Opts),
<a name="603"/>  603:     {ok, {http_header,_,'Host',_,&quot;localhost&quot;}, Rest2} =
<a name="604"/>  604:     erlang:decode_packet(httph, Rest1, Opts),
<a name="605"/>  605:     {more, undefined} = erlang:decode_packet(httph, Rest2, Opts),
<a name="606"/>  606:     {ok, {http_header,_,&quot;Link&quot;,_,Link}, Rest3} =
<a name="607"/>  607:     erlang:decode_packet(httph, list_to_binary([Rest2, Pkt2]), Opts),
<a name="608"/>  608:     true = (length(Link) &gt; 8000),
<a name="609"/>  609:     {ok, {http_header,_,'Content-Length',_,&quot;0&quot;}, &lt;&lt;&quot;\r\n&quot;&gt;&gt;} =
<a name="610"/>  610:     erlang:decode_packet(httph, Rest3, Opts),
<a name="otp_9389-last_expr"/><a name="611"/>  611:     ok.
<a name="612"/>  612: 
<a name="613"/>  613: <i>%% Verify packet_size works correctly for line mode</i>
<a name="otp_9389_line-1"/><a name="614"/>  614: <b>otp_9389_line</b>(Config) when is_list(Config) -&gt;
<a name="615"/>  615:     Opts = [{packet_size, 20}],
<a name="616"/>  616:     Line1 = &lt;&lt;&quot;0123456789012345678\n&quot;&gt;&gt;,
<a name="617"/>  617:     Line2 = &lt;&lt;&quot;0123456789\n&quot;&gt;&gt;,
<a name="618"/>  618:     Line3 = &lt;&lt;&quot;01234567890123456789\n&quot;&gt;&gt;,
<a name="619"/>  619:     Pkt = list_to_binary([Line1, Line2, Line3]),
<a name="620"/>  620:     {ok, Line1, Rest1} = erlang:decode_packet(line, Pkt, Opts),
<a name="621"/>  621:     {ok, Line2, Rest2} = erlang:decode_packet(line, Rest1, Opts),
<a name="622"/>  622:     {error, invalid} = erlang:decode_packet(line, Rest2, Opts),
<a name="otp_9389_line-last_expr"/><a name="623"/>  623:     ok.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
