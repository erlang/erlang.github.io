<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/mnesia/make_test_dir/mnesia_test/mnesia_qlc_test.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2004-2018. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <b>-module</b>(mnesia_qlc_test).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-export</b>([init_per_testcase/2, end_per_testcase/2,
<a name="25"/>   25:          init_per_group/2, end_per_group/2,
<a name="26"/>   26:          all/0, groups/0]).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-export</b>([frag/1, info/1, mnesia_down/1,
<a name="29"/>   29:          dirty_nice_ram_copies/1, dirty_nice_disc_copies/1,
<a name="30"/>   30:          dirty_nice_disc_only_copies/1,
<a name="31"/>   31:          trans_nice_ram_copies/1, trans_nice_disc_copies/1,
<a name="32"/>   32:          trans_nice_disc_only_copies/1, atomic_eval/1,
<a name="33"/>   33:          nested_qlc/1
<a name="34"/>   34:         ]).
<a name="35"/>   35: 
<a name="36"/>   36: 
<a name="37"/>   37: <b>-include</b>(&quot;mnesia_test_lib.hrl&quot;).
<a name="38"/>   38: <b>-include_lib</b>(&quot;stdlib/include/qlc.hrl&quot;). 
<a name="39"/>   39: 
<a name="init_per_testcase-2"/><a name="40"/>   40: <b>init_per_testcase</b>(Func, Conf) -&gt;
<a name="41"/>   41:     setup(Conf),
<a name="init_per_testcase-last_expr"/><a name="42"/>   42: <b>    mnesia_test_lib:init_per_testcase</b>(Func, Conf).
<a name="43"/>   43: 
<a name="end_per_testcase-2"/><a name="44"/>   44: <b>end_per_testcase</b>(Func, Conf) -&gt;
<a name="end_per_testcase-last_expr"/><a name="45"/>   45: <b>    mnesia_test_lib:end_per_testcase</b>(Func, Conf).
<a name="46"/>   46: 
<a name="all-0"/><a name="47"/>   47: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="48"/>   48: <b>    case code:which</b>(qlc) of
<a name="49"/>   49: 	non_existing -&gt; [];
<a name="50"/>   50: 	_ -&gt; all_qlc()
<a name="51"/>   51:     end.
<a name="52"/>   52: 
<a name="groups-0"/><a name="53"/>   53: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="54"/>   54:     [{dirty, [],
<a name="55"/>   55:       [dirty_nice_ram_copies, dirty_nice_disc_copies,
<a name="56"/>   56:        dirty_nice_disc_only_copies]},
<a name="57"/>   57:      {trans, [],
<a name="58"/>   58:       [trans_nice_ram_copies, trans_nice_disc_copies,
<a name="59"/>   59:        trans_nice_disc_only_copies, {group, atomic}]},
<a name="60"/>   60:      {atomic, [], [atomic_eval]}].
<a name="61"/>   61: 
<a name="init_per_group-2"/><a name="62"/>   62: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="63"/>   63:     Config.
<a name="64"/>   64: 
<a name="end_per_group-2"/><a name="65"/>   65: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="66"/>   66:     Config.
<a name="67"/>   67: 
<a name="68"/>   68: 
<a name="all_qlc-0"/><a name="69"/>   69: <b>all_qlc</b>() -&gt; 
<a name="all_qlc-last_expr"/><a name="70"/>   70:     [{group, dirty}, {group, trans}, frag, info,
<a name="71"/>   71:      mnesia_down].
<a name="72"/>   72: 
<a name="init_testcases-2"/><a name="73"/>   73: <b>init_testcases</b>(Type,Config) -&gt;
<a name="74"/>   74:     Nodes = [N1,N2] = ?acquire_nodes(2, Config),
<a name="75"/>   75:     ?match({atomic, ok}, mnesia:create_table(a, [{Type,[N1]}, {index,[3]}])),
<a name="76"/>   76:     ?match({atomic, ok}, mnesia:create_table(b, [{Type,[N2]}])),
<a name="77"/>   77:     Write = fun(Id) -&gt; 
<a name="78"/>   78: 		    ok = mnesia:write({a, {a,Id}, 100 - Id}),
<a name="79"/>   79: 		    ok = mnesia:write({b, {b,100-Id}, Id})
<a name="80"/>   80: 	    end,
<a name="81"/>   81:     All = fun() -&gt; [Write(Id) || Id &lt;- lists:seq(1,10)], ok end,
<a name="82"/>   82:     ?match({atomic, ok}, mnesia:sync_transaction(All)),
<a name="83"/>   83:     ?match({atomic, [{b, {b,100-1}, 1}]}, mnesia:transaction(fun() -&gt; mnesia:read({b, {b, 99}}) end)),
<a name="init_testcases-last_expr"/><a name="84"/>   84:     Nodes.
<a name="85"/>   85: 
<a name="86"/>   86: <i>%% Test cases       </i>
<a name="87"/>   87: 
<a name="dirty_nice_ram_copies-1"/><a name="dirty_nice_ram_copies-last_expr"/><a name="88"/>   88: <b>dirty_nice_ram_copies</b>(Setup) -&gt; dirty_nice(Setup,ram_copies).
<a name="dirty_nice_disc_copies-1"/><a name="dirty_nice_disc_copies-last_expr"/><a name="89"/>   89: <b>dirty_nice_disc_copies</b>(Setup) -&gt; dirty_nice(Setup,disc_copies).
<a name="dirty_nice_disc_only_copies-1"/><a name="dirty_nice_disc_only_copies-last_expr"/><a name="90"/>   90: <b>dirty_nice_disc_only_copies</b>(Setup) -&gt; dirty_nice(Setup,disc_only_copies).
<a name="91"/>   91: 
<a name="dirty_nice-2"/><a name="92"/>   92: <b>dirty_nice</b>(suite, _) -&gt; [];
<a name="93"/>   93: <b>dirty_nice</b>(doc, _) -&gt; [];
<a name="94"/>   94: <b>dirty_nice</b>(Config, Type) when is_list(Config) -&gt;
<a name="95"/>   95:     Ns = init_testcases(Type,Config),
<a name="96"/>   96:     QA = handle(&lt;&lt;&quot;[Q || Q = {_,{_,Key},Val} &lt;- mnesia:table(a),&quot;
<a name="97"/>   97: 		 &quot;     Val == 90 + Key]&quot;&gt;&gt;),
<a name="98"/>   98:     QB = handle(&lt;&lt;&quot;[Q || Q = {_,{_,Key},Val} &lt;- mnesia:table(b),&quot;
<a name="99"/>   99: 		 &quot;     Key == 90 + Val]&quot;&gt;&gt;),
<a name="100"/>  100:     QC = qlc:sort(mnesia:table(a, [{n_objects,1}, {lock,write}, {traverse, select}])),
<a name="101"/>  101:     QD = qlc:sort(mnesia:table(a, [{n_objects,1}, {traverse,{select,[{'$1',[],['$1']}]}}])),
<a name="102"/>  102: 
<a name="103"/>  103:     FA = fun() -&gt; qlc:e(QA) end,
<a name="104"/>  104:     FB = fun() -&gt; qlc:e(QB) end,
<a name="105"/>  105:     FC = fun() -&gt; qlc:e(QC) end,
<a name="106"/>  106:     FD = fun() -&gt; qlc:e(QD) end,
<a name="107"/>  107: 
<a name="108"/>  108:     %% Currently unsupported
<a name="109"/>  109:     ?match({'EXIT',{aborted,no_transaction}}, FA()),
<a name="110"/>  110:     ?match({'EXIT',{aborted,no_transaction}}, FB()),
<a name="111"/>  111:     %%
<a name="112"/>  112:     CRes = lists:sort(mnesia:dirty_match_object(a, {'_','_','_'})),
<a name="113"/>  113:     ?match([{a,{a,5},95}], mnesia:async_dirty(FA)),
<a name="114"/>  114:     ?match([{b,{b,95},5}], mnesia:async_dirty(FB)),
<a name="115"/>  115:     ?match(CRes, mnesia:async_dirty(FC)),
<a name="116"/>  116:     ?match(CRes, mnesia:async_dirty(FD)),
<a name="117"/>  117:     ?match([{a,{a,5},95}], mnesia:sync_dirty(FA)),
<a name="118"/>  118:     ?match([{b,{b,95},5}], mnesia:sync_dirty(FB)),
<a name="119"/>  119:     ?match(CRes, mnesia:sync_dirty(FC)),
<a name="120"/>  120:     ?match([{a,{a,5},95}], mnesia:activity(async_dirty, FA)),
<a name="121"/>  121:     ?match([{b,{b,95},5}], mnesia:activity(async_dirty, FB)),
<a name="122"/>  122:     ?match([{a,{a,5},95}], mnesia:activity(sync_dirty, FA)),
<a name="123"/>  123:     ?match([{b,{b,95},5}], mnesia:activity(sync_dirty, FB)),
<a name="124"/>  124:     ?match(CRes, mnesia:activity(async_dirty,FC)),
<a name="125"/>  125:     case Type of
<a name="126"/>  126: 	disc_only_copies -&gt; skip;
<a name="127"/>  127: 	_ -&gt; 
<a name="128"/>  128: 	    ?match([{a,{a,5},95}], mnesia:ets(FA)),
<a name="129"/>  129: 	    ?match([{a,{a,5},95}], mnesia:activity(ets, FA))
<a name="130"/>  130:     end,
<a name="dirty_nice-last_expr"/><a name="131"/>  131: <b>    ?verify_mnesia</b>(Ns, []).
<a name="132"/>  132: 
<a name="133"/>  133: 
<a name="trans_nice_ram_copies-1"/><a name="trans_nice_ram_copies-last_expr"/><a name="134"/>  134: <b>trans_nice_ram_copies</b>(Setup) -&gt; trans_nice(Setup,ram_copies).
<a name="trans_nice_disc_copies-1"/><a name="trans_nice_disc_copies-last_expr"/><a name="135"/>  135: <b>trans_nice_disc_copies</b>(Setup) -&gt; trans_nice(Setup,disc_copies).
<a name="trans_nice_disc_only_copies-1"/><a name="trans_nice_disc_only_copies-last_expr"/><a name="136"/>  136: <b>trans_nice_disc_only_copies</b>(Setup) -&gt; trans_nice(Setup,disc_only_copies).
<a name="137"/>  137: 
<a name="trans_nice-2"/><a name="138"/>  138: <b>trans_nice</b>(suite, _) -&gt; [];
<a name="139"/>  139: <b>trans_nice</b>(doc, _) -&gt; [];
<a name="140"/>  140: <b>trans_nice</b>(Config, Type) when is_list(Config) -&gt;
<a name="141"/>  141:     Ns = init_testcases(Type,Config),
<a name="142"/>  142:     QA = handle(&lt;&lt;&quot;[Q || Q = {_,{_,Key},Val} &lt;- mnesia:table(a),&quot;
<a name="143"/>  143: 		 &quot;     Val == 90 + Key]&quot;&gt;&gt;),
<a name="144"/>  144:     QB = handle(&lt;&lt;&quot;[Q || Q = {_,{_,Key},Val} &lt;- mnesia:table(b),&quot;
<a name="145"/>  145: 		 &quot;     Key == 90 + Val]&quot;&gt;&gt;),
<a name="146"/>  146:     QC = handle(recs(), 
<a name="147"/>  147:  		&lt;&lt;&quot;[Q || Q = #a{v=91} &lt;- mnesia:table(a)]&quot;
<a name="148"/>  148:  		 &gt;&gt;),
<a name="149"/>  149: 
<a name="150"/>  150:     QD = qlc:sort(mnesia:table(a, [{n_objects,1}, {lock,write}, {traverse, select}])),
<a name="151"/>  151:     QE = qlc:sort(mnesia:table(a, [{n_objects,1}, {traverse,{select,[{'$1',[],['$1']}]}}])),
<a name="152"/>  152: 
<a name="153"/>  153:     DRes = lists:sort(mnesia:dirty_match_object(a, {'_','_','_'})),
<a name="154"/>  154: 
<a name="155"/>  155:     FA = fun() -&gt; qlc:e(QA) end,
<a name="156"/>  156:     FB = fun() -&gt; qlc:e(QB) end,
<a name="157"/>  157:     FC = fun() -&gt; qlc:e(QC) end,
<a name="158"/>  158:     FD = fun() -&gt; qlc:e(QD) end,
<a name="159"/>  159:     FE = fun() -&gt; qlc:e(QE) end,
<a name="160"/>  160: 		  
<a name="161"/>  161:     ?match({atomic,[{a,{a,5},95}]}, mnesia:transaction(FA)),
<a name="162"/>  162:     ?match({atomic,[{b,{b,95},5}]}, mnesia:transaction(FB)),
<a name="163"/>  163:     ?match({atomic,[{a,{a,9},91}]}, mnesia:transaction(FC)),
<a name="164"/>  164:     ?match({atomic,[{a,{a,5},95}]}, mnesia:sync_transaction(FA)),
<a name="165"/>  165:     ?match({atomic,[{b,{b,95},5}]}, mnesia:sync_transaction(FB)),
<a name="166"/>  166:     ?match({atomic,[{a,{a,9},91}]}, mnesia:sync_transaction(FC)),
<a name="167"/>  167:     ?match([{a,{a,5},95}], mnesia:activity(transaction,FA)),
<a name="168"/>  168:     ?match([{b,{b,95},5}], mnesia:activity(transaction,FB)),
<a name="169"/>  169:     ?match([{a,{a,9},91}], mnesia:activity(transaction,FC)),
<a name="170"/>  170:     ?match([{a,{a,5},95}], mnesia:activity(sync_transaction,FA)),
<a name="171"/>  171:     ?match([{b,{b,95},5}], mnesia:activity(sync_transaction,FB)),
<a name="172"/>  172:     ?match([{a,{a,9},91}], mnesia:activity(sync_transaction,FC)),
<a name="173"/>  173: 
<a name="174"/>  174:     ?match({atomic, DRes}, mnesia:transaction(FD)),
<a name="175"/>  175:     ?match({atomic, DRes}, mnesia:transaction(FE)),
<a name="176"/>  176: 
<a name="177"/>  177:     Rest = fun(Cursor,Loop) -&gt; 
<a name="178"/>  178: 		   case qlc:next_answers(Cursor, 1) of
<a name="179"/>  179: 		       [] -&gt; [];
<a name="180"/>  180: 		       [A]-&gt; [A|Loop(Cursor,Loop)] 
<a name="181"/>  181: 		   end
<a name="182"/>  182: 	   end,
<a name="183"/>  183:     Loop = fun() -&gt; 
<a name="184"/>  184: 		   Cursor = qlc:cursor(QD),
<a name="185"/>  185: 		   Rest(Cursor,Rest)
<a name="186"/>  186: 	   end,
<a name="187"/>  187:     ?match({atomic, DRes}, mnesia:transaction(Loop)),
<a name="188"/>  188: 
<a name="trans_nice-last_expr"/><a name="189"/>  189: <b>    ?verify_mnesia</b>(Ns, []).
<a name="190"/>  190: 
<a name="191"/>  191: <i>%% -record(a, {k,v}).</i>
<a name="192"/>  192: <i>%% -record(b, {k,v}).</i>
<a name="193"/>  193: <i>%% -record(k, {t,v}).</i>
<a name="194"/>  194: 
<a name="recs-0"/><a name="195"/>  195: <b>recs</b>() -&gt;
<a name="recs-last_expr"/><a name="196"/>  196: <b>    &lt;&lt;&quot;-record</b>(a, {k,v}). &quot;
<a name="197"/>  197:       &quot;-record(b, {k,v}). &quot;
<a name="198"/>  198:       &quot;-record(k, {t,v}). &quot;
<a name="199"/>  199:      &gt;&gt;.
<a name="200"/>  200:  
<a name="201"/>  201: 
<a name="atomic_eval-1"/><a name="202"/>  202: <b>atomic_eval</b>(suite) -&gt; [];
<a name="203"/>  203: <b>atomic_eval</b>(doc) -&gt; []; 
<a name="204"/>  204: <b>atomic_eval</b>(Config) -&gt;
<a name="205"/>  205:     Ns = init_testcases(ram_copies, Config),    
<a name="206"/>  206:     Q1 = handle(recs(), 
<a name="207"/>  207: 		&lt;&lt;&quot;[Q || Q = #a{k={_,9}} &lt;- mnesia:table(a)]&quot;
<a name="208"/>  208: 		 &gt;&gt;),
<a name="209"/>  209:     Eval = fun(Q) -&gt; 
<a name="210"/>  210: 		   {qlc:e(Q),
<a name="211"/>  211: 		    mnesia:system_info(held_locks)}
<a name="212"/>  212: 	   end,
<a name="213"/>  213:     Self = self(),
<a name="214"/>  214:     ?match({[{a,{a,9},91}], [{{a,'______WHOLETABLE_____'},read,{tid,_,Self}}]},
<a name="215"/>  215: 	   ok(Eval,[Q1])),
<a name="216"/>  216:     
<a name="217"/>  217:     Q2 = handle(recs(), 
<a name="218"/>  218: 		&lt;&lt;&quot;[Q || Q = #a{k={a,9}} &lt;- mnesia:table(a)]&quot;
<a name="219"/>  219: 		 &gt;&gt;),
<a name="220"/>  220:     
<a name="221"/>  221:     ?match({[{a,{a,9},91}],[{{a,{a,9}},read,{tid,_,Self}}]},
<a name="222"/>  222: 	   ok(Eval,[Q2])),
<a name="223"/>  223: 
<a name="224"/>  224:     Flush = fun(Loop) -&gt; %% Clean queue
<a name="225"/>  225: 		    receive _ -&gt; Loop(Loop) 
<a name="226"/>  226: 		    after 0 -&gt; ok end
<a name="227"/>  227: 	    end,
<a name="228"/>  228:     
<a name="229"/>  229:     Flush(Flush),
<a name="230"/>  230: 
<a name="231"/>  231:     GrabLock = fun(Father) -&gt;  
<a name="232"/>  232: 		       mnesia:read(a, {a,9}, write),
<a name="233"/>  233: 		       Father ! locked,
<a name="234"/>  234: 		       receive cont -&gt; ok end end,
<a name="235"/>  235: 
<a name="236"/>  236:     Pid1 = spawn(fun() -&gt; ?match(ok, ok(GrabLock, [Self])) end),    
<a name="237"/>  237:     ?match(locked,receive locked -&gt; locked after 5000 -&gt; timeout end), %% Wait
<a name="238"/>  238: 
<a name="239"/>  239:     put(count,0),
<a name="240"/>  240:     Restart = fun(Locker,Fun) -&gt;
<a name="241"/>  241: 		      Count = get(count),
<a name="242"/>  242: 		      case {Count,(catch Fun())}  of
<a name="243"/>  243: 			  {0, {'EXIT', R}} -&gt;
<a name="244"/>  244: 			      Locker ! cont,
<a name="245"/>  245: 			      put(count, Count+1),
<a name="246"/>  246: 			      erlang:yield(),
<a name="247"/>  247: 			      exit(R);
<a name="248"/>  248: 			  Else -&gt;
<a name="249"/>  249: 			      Else
<a name="250"/>  250: 		      end
<a name="251"/>  251: 	      end,
<a name="252"/>  252:     
<a name="253"/>  253:     ?match({1,{[{a,{a,9},91}], [{{a,'______WHOLETABLE_____'},read,{tid,_,Self}}]}},
<a name="254"/>  254: 	   ok(Restart,[Pid1,fun() -&gt; Eval(Q1) end])),
<a name="255"/>  255:     
<a name="256"/>  256:     Pid2 = spawn(fun() -&gt; ?match(ok, ok(GrabLock, [Self])) end),
<a name="257"/>  257:     ?match(locked,receive locked -&gt; locked after 5000 -&gt; timeout end), %% Wait
<a name="258"/>  258:     put(count,0),
<a name="259"/>  259:     ?match({1,{[{a,{a,9},91}],[{{a,{a,9}},read,{tid,_,Self}}]}},
<a name="260"/>  260: 	   ok(Restart,[Pid2, fun() -&gt; Eval(Q2) end])),
<a name="261"/>  261: 
<a name="262"/>  262: <i>%% Basic test     </i>
<a name="263"/>  263:     Cursor = fun() -&gt;
<a name="264"/>  264: 		     QC = qlc:cursor(Q1),
<a name="265"/>  265: 		     qlc:next_answers(QC) 
<a name="266"/>  266: 	     end,
<a name="267"/>  267: 
<a name="268"/>  268:     ?match([{a,{a,9},91}], ok(Cursor, [])),
<a name="269"/>  269:     %% Lock 
<a name="270"/>  270: 
<a name="271"/>  271:     Pid3 = spawn(fun() -&gt; ?match(ok, ok(GrabLock, [Self])) end),    
<a name="272"/>  272:     ?match(locked,receive locked -&gt; locked after 5000 -&gt; timeout end), %% Wait
<a name="273"/>  273:     put(count,0),
<a name="274"/>  274:     
<a name="275"/>  275:     ?match({1,[{a,{a,9},91}]}, ok(Restart,[Pid3, Cursor])),
<a name="276"/>  276:     QC1 = ok(fun() -&gt; qlc:cursor(Q1) end, []),
<a name="277"/>  277:     ?match({'EXIT', _},  (catch qlc:next_answers(QC1))),
<a name="278"/>  278:     ?match({aborted,_},  ok(fun()-&gt;qlc:next_answers(QC1)end,[])),
<a name="atomic_eval-last_expr"/><a name="279"/>  279: <b>    ?verify_mnesia</b>(Ns, []).
<a name="280"/>  280: 
<a name="281"/>  281: 
<a name="frag-1"/><a name="282"/>  282: <b>frag</b>(suite) -&gt; [];
<a name="283"/>  283: <b>frag</b>(doc) -&gt; [];
<a name="284"/>  284: <b>frag</b>(Config) -&gt;
<a name="285"/>  285:     Ns = init_testcases(ram_copies,Config),
<a name="286"/>  286:     QA = handle(&lt;&lt;&quot;[Q || Q = {_,{_,Key},Val} &lt;- mnesia:table(a),&quot;
<a name="287"/>  287: 		 &quot;     Val == 90 + Key]&quot;&gt;&gt;),
<a name="288"/>  288:     QB = handle(&lt;&lt;&quot;[Q || Q = {_,{_,Key},Val} &lt;- mnesia:table(b),&quot;
<a name="289"/>  289: 		 &quot;     Key == 90 + Val]&quot;&gt;&gt;),
<a name="290"/>  290:     
<a name="291"/>  291:     Activate = 
<a name="292"/>  292: 	fun(Tab) -&gt;
<a name="293"/>  293: 		?match({atomic,ok},mnesia:change_table_frag(Tab, {activate, []})),
<a name="294"/>  294: 		Dist = mnesia_frag_test:frag_dist(Tab),
<a name="295"/>  295: 		?match({atomic,ok},mnesia:change_table_frag(Tab,{add_frag,Dist}))
<a name="296"/>  296: 	end,
<a name="297"/>  297:     Activate(a),
<a name="298"/>  298:     Activate(b),
<a name="299"/>  299: 
<a name="300"/>  300:     Fun = fun(Tab) -&gt; mnesia:table_info(Tab, frag_names) end,
<a name="301"/>  301:     FTs = mnesia:activity(sync_dirty, Fun, [a], mnesia_frag) ++
<a name="302"/>  302: 	mnesia:activity(sync_dirty, Fun, [b], mnesia_frag),
<a name="303"/>  303:     Size = fun(Tab) -&gt; mnesia:dirty_rpc(Tab, mnesia, table_info, [Tab,size]) end,
<a name="304"/>  304: 
<a name="305"/>  305:     %% Verify that all data doesn't belong to the same frag.
<a name="306"/>  306:     ?match([], [{Tab,Size(Tab)} || Tab &lt;- FTs,
<a name="307"/>  307: 				   Size(Tab) =&lt; 0]),
<a name="308"/>  308:     
<a name="309"/>  309:     FA = fun() -&gt; qlc:e(QA) end,
<a name="310"/>  310:     FB = fun() -&gt; qlc:e(QB) end,
<a name="311"/>  311:     ?match([{a,{a,5},95}], mnesia:activity(transaction,FA,[],mnesia_frag)),
<a name="312"/>  312:     ?match([{b,{b,95},5}], mnesia:activity(transaction,FB,[],mnesia_frag)),
<a name="313"/>  313:     
<a name="frag-last_expr"/><a name="314"/>  314: <b>    ?verify_mnesia</b>(Ns, []).
<a name="315"/>  315: 
<a name="info-1"/><a name="316"/>  316: <b>info</b>(suite) -&gt; [];
<a name="317"/>  317: <b>info</b>(doc) -&gt; [];
<a name="318"/>  318: <b>info</b>(Config) -&gt;
<a name="319"/>  319:     Ns = init_testcases(ram_copies, Config),
<a name="320"/>  320:     Q1 = handle(recs(), 
<a name="321"/>  321: 		&lt;&lt;&quot;[Q || Q = #a{k={_,9}} &lt;- mnesia:table(a)]&quot;
<a name="322"/>  322: 		 &gt;&gt;),
<a name="323"/>  323:     
<a name="324"/>  324:     Q2 = handle(recs(), 
<a name="325"/>  325: 		&lt;&lt;&quot;[Q || Q = #a{k={a,9}} &lt;- mnesia:table(a)]&quot;
<a name="326"/>  326: 		 &gt;&gt;),
<a name="327"/>  327:     
<a name="328"/>  328:     Q3 = handle(recs(), 
<a name="329"/>  329: 		&lt;&lt;&quot;[Q || Q = #a{v=91} &lt;- mnesia:table(a)]&quot;
<a name="330"/>  330: 		 &gt;&gt;),
<a name="331"/>  331:     
<a name="332"/>  332:     %% FIXME compile and check results!
<a name="333"/>  333:     
<a name="334"/>  334:     ?match(ok,io:format(&quot;~s~n&quot;,[qlc:info(Q1)])),
<a name="335"/>  335:     ?match(ok,io:format(&quot;~s~n&quot;,[qlc:info(Q2)])),
<a name="336"/>  336:     ?match(ok,io:format(&quot;~s~n&quot;,[qlc:info(Q3)])),
<a name="337"/>  337:  
<a name="info-last_expr"/><a name="338"/>  338: <b>    ?verify_mnesia</b>(Ns, []).
<a name="339"/>  339: 
<a name="ok-2"/><a name="340"/>  340: <b>ok</b>(Fun,A) -&gt;
<a name="ok-last_expr"/><a name="341"/>  341: <b>    case mnesia:transaction</b>(Fun,A) of
<a name="342"/>  342: 	{atomic, R} -&gt; R;
<a name="343"/>  343: 	E -&gt; E
<a name="344"/>  344:     end.
<a name="345"/>  345: 
<a name="346"/>  346: 
<a name="mnesia_down-1"/><a name="347"/>  347: <b>mnesia_down</b>(suite) -&gt; [];
<a name="348"/>  348: <b>mnesia_down</b>(doc) -&gt;
<a name="349"/>  349:     [&quot;Test bug OTP-7968, which crashed mnesia when a&quot;
<a name="350"/>  350:      &quot;mnesia_down came after qlc had been invoked&quot;];
<a name="351"/>  351: <b>mnesia_down</b>(Config) when is_list(Config) -&gt;
<a name="352"/>  352:     [N1,N2] = init_testcases(ram_copies,Config),
<a name="353"/>  353:     QB = handle(&lt;&lt;&quot;[Q || Q = {_,{_,Key},Val} &lt;- mnesia:table(b),&quot;
<a name="354"/>  354: 		 &quot;     Val == Key - 90]&quot;&gt;&gt;),
<a name="355"/>  355: 
<a name="356"/>  356:     Tester = self(),    
<a name="357"/>  357:     
<a name="358"/>  358:     Eval = fun() -&gt; 
<a name="359"/>  359: 		   Cursor = qlc:cursor(QB), %% Forces another process
<a name="360"/>  360: 		   Res = qlc:next_answers(Cursor),
<a name="361"/>  361: 		   Tester ! {qlc, self(), Res},
<a name="362"/>  362: 		   {Mod, Tid, Ts} = get(mnesia_activity_state),
<a name="363"/>  363: 		   receive
<a name="364"/>  364: 		       continue -&gt;
<a name="365"/>  365: 			   io:format(&quot;Continuing ~p ~p ~n&quot;,[self(), {Mod, Tid, Ts}]),
<a name="366"/>  366: 			   io:format(&quot;ETS ~p~n&quot;,[ets:tab2list(element(2,Ts))]),
<a name="367"/>  367: 			   io:format(&quot;~p~n&quot;,[process_info(self(),messages)]),
<a name="368"/>  368: 			   Res
<a name="369"/>  369: 		   end
<a name="370"/>  370: 	   end,
<a name="371"/>  371:     spawn(fun() -&gt; TransRes = mnesia:transaction(Eval), Tester ! {test,TransRes} end),
<a name="372"/>  372: 
<a name="373"/>  373:     TMInfo = fun() -&gt;
<a name="374"/>  374: 		     TmInfo = mnesia_tm:get_info(5000),
<a name="375"/>  375: 		     mnesia_tm:display_info(user, TmInfo)
<a name="376"/>  376: 	     end,
<a name="377"/>  377:     receive
<a name="378"/>  378: 	{qlc, QPid, QRes} -&gt;
<a name="379"/>  379: 	    ?match([{b,{b,95},5}], QRes),
<a name="380"/>  380: 	    TMInfo(),
<a name="381"/>  381: 	    mnesia_test_lib:kill_mnesia([N2]),
<a name="382"/>  382: 	    %%timer:sleep(1000),
<a name="383"/>  383: 	    QPid ! continue
<a name="384"/>  384:     after 2000 -&gt;
<a name="385"/>  385: 	    exit(timeout1)
<a name="386"/>  386:     end,
<a name="387"/>  387: 
<a name="388"/>  388:     receive
<a name="389"/>  389: 	{test, QRes2} -&gt;
<a name="390"/>  390: 	    ?match({atomic, [{b,{b,95},5}]}, QRes2)
<a name="391"/>  391:     after 2000 -&gt;
<a name="392"/>  392: 	    exit(timeout2)
<a name="393"/>  393:     end,
<a name="394"/>  394:     
<a name="mnesia_down-last_expr"/><a name="395"/>  395: <b>    ?verify_mnesia</b>([N1], [N2]).
<a name="396"/>  396: 
<a name="397"/>  397: 
<a name="nested_qlc-1"/><a name="398"/>  398: <b>nested_qlc</b>(suite) -&gt; [];
<a name="399"/>  399: <b>nested_qlc</b>(doc) -&gt;
<a name="400"/>  400:     [&quot;Test bug in OTP-7968 (the second problem) where nested&quot;
<a name="401"/>  401:      &quot;transaction don't work as expected&quot;];
<a name="402"/>  402: <b>nested_qlc</b>(Config) when is_list(Config) -&gt;
<a name="403"/>  403:     Ns = init_testcases(ram_copies,Config),    
<a name="404"/>  404:     Res = as_with_bs(),
<a name="405"/>  405:     ?match([_|_], Res),
<a name="406"/>  406:     top_as_with_some_bs(10),
<a name="407"/>  407:     
<a name="nested_qlc-last_expr"/><a name="408"/>  408: <b>    ?verify_mnesia</b>(Ns, []).
<a name="409"/>  409: 
<a name="410"/>  410: 
<a name="411"/>  411: <i>%% Code from Daniel </i>
<a name="bs_by_a_id-1"/><a name="412"/>  412: <b>bs_by_a_id</b>(A_id) -&gt;
<a name="bs_by_a_id-last_expr"/><a name="413"/>  413: <b>    find</b>(qlc:q([ B || B={_,_,F_id} &lt;- mnesia:table(b), F_id == A_id])).
<a name="414"/>  414: 
<a name="as_with_bs-0"/><a name="415"/>  415: <b>as_with_bs</b>() -&gt;
<a name="as_with_bs-last_expr"/><a name="416"/>  416: <b>    find</b>(qlc:q([ {A,bs_by_a_id(Id)} ||
<a name="417"/>  417: 		   A = {_, {a,Id}, _} &lt;- mnesia:table(a)])).
<a name="418"/>  418: 
<a name="top_as_with_some_bs-1"/><a name="419"/>  419: <b>top_as_with_some_bs</b>(Limit) -&gt;
<a name="top_as_with_some_bs-last_expr"/><a name="420"/>  420: <b>    top</b>(
<a name="421"/>  421:       qlc:q([ {A,bs_by_a_id(Id)} ||
<a name="422"/>  422: 		A = {_, {a,Id}, _} &lt;- mnesia:table(a)]),
<a name="423"/>  423:       Limit,
<a name="424"/>  424:       fun(A1,A2) -&gt; A1 &lt; A2  end
<a name="425"/>  425:      ).
<a name="426"/>  426: 
<a name="427"/>  427: <i>% --- utils</i>
<a name="428"/>  428: 
<a name="find-1"/><a name="429"/>  429: <b>find</b>(Q) -&gt;
<a name="430"/>  430:     F = fun() -&gt; qlc:e(Q) end,
<a name="431"/>  431:     {atomic, Res} = mnesia:transaction(F),
<a name="find-last_expr"/><a name="432"/>  432:     Res.
<a name="433"/>  433: 
<a name="434"/>  434: <i>% --- it returns top Limit results from query Q ordered by Order sort function</i>
<a name="top-3"/><a name="435"/>  435: <b>top</b>(Q, Limit, Order) -&gt;
<a name="436"/>  436:     Do = fun() -&gt;
<a name="437"/>  437: 		 OQ = qlc:sort(Q, [{order,Order}]),
<a name="438"/>  438: 		 QC = qlc:cursor(OQ),
<a name="439"/>  439: 		 Res = qlc:next_answers(QC, Limit),
<a name="440"/>  440: 		 qlc:delete_cursor(QC),
<a name="441"/>  441: 		 Res
<a name="442"/>  442: 	 end,
<a name="443"/>  443:     {atomic, Res} = mnesia:transaction(Do),
<a name="top-last_expr"/><a name="444"/>  444:     Res.
<a name="445"/>  445: 
<a name="446"/>  446: <i>%% To keep mnesia suite backward compatible,</i>
<a name="447"/>  447: <i>%% we compile the queries in runtime when qlc is available</i>
<a name="448"/>  448: <i>%% Compiles and returns a handle to a qlc</i>
<a name="handle-1"/><a name="449"/>  449: <b>handle</b>(Expr) -&gt;
<a name="handle-last_expr"/><a name="450"/>  450: <b>    handle</b>(&lt;&lt;&gt;&gt;,Expr).
<a name="handle-2"/><a name="451"/>  451: <b>handle</b>(Records,Expr) -&gt;
<a name="handle-last_expr"/><a name="452"/>  452: <b>    case catch handle2</b>(Records,Expr) of
<a name="453"/>  453: 	{ok, Handle} -&gt;
<a name="454"/>  454: 	    Handle;
<a name="455"/>  455: 	Else -&gt;
<a name="456"/>  456: 	    ?match(ok, Else)
<a name="457"/>  457:     end.
<a name="458"/>  458: 
<a name="handle2-2"/><a name="459"/>  459: <b>handle2</b>(Records,Expr) -&gt;
<a name="460"/>  460:     {FN,Mod} = temp_name(),
<a name="461"/>  461:     ModStr = list_to_binary(&quot;-module(&quot; ++ atom_to_list(Mod) ++ &quot;).\n&quot;),
<a name="462"/>  462:     Prog = &lt;&lt;
<a name="463"/>  463: 	    ModStr/binary,
<a name="464"/>  464: 	    &quot;-include_lib(\&quot;stdlib/include/qlc.hrl\&quot;).\n&quot;,
<a name="465"/>  465: 	    &quot;-export([tmp/0]).\n&quot;,
<a name="466"/>  466: 	    Records/binary,&quot;\n&quot;,
<a name="467"/>  467: 	    &quot;tmp() -&gt;\n&quot;,
<a name="468"/>  468: <i>%%	    &quot;   _ = (catch throw(fvalue_not_reset)),&quot;</i>
<a name="469"/>  469: 	    &quot;   qlc:q( &quot;,
<a name="470"/>  470: 	    Expr/binary,&quot;).\n&quot;&gt;&gt;,
<a name="471"/>  471: 
<a name="472"/>  472:     ?match(ok,file:write_file(FN,Prog)),
<a name="473"/>  473:     {ok,Forms} = epp:parse_file(FN,&quot;&quot;,&quot;&quot;),
<a name="474"/>  474:     {ok,Mod,Bin} = compile:forms(Forms),
<a name="475"/>  475:     code:load_binary(Mod,FN,Bin),
<a name="handle2-last_expr"/><a name="476"/>  476: <b>    {ok, Mod:tmp</b>()}.
<a name="477"/>  477: 
<a name="setup-1"/><a name="478"/>  478: <b>setup</b>(Config) -&gt;
<a name="479"/>  479:     put(mts_config,Config),
<a name="setup-last_expr"/><a name="480"/>  480: <b>    put</b>(mts_tf_counter,0).
<a name="481"/>  481: 
<a name="temp_name-0"/><a name="482"/>  482: <b>temp_name</b>() -&gt;
<a name="483"/>  483:     Conf = get(mts_config),
<a name="484"/>  484:     C = get(mts_tf_counter),
<a name="485"/>  485:     put(mts_tf_counter,C+1),
<a name="temp_name-last_expr"/><a name="486"/>  486: <b>    {filename:join</b>([proplists:get_value(priv_dir,Conf, &quot;.&quot;),
<a name="487"/>  487: 		    &quot;tempfile&quot;++integer_to_list(C)++&quot;.tmp&quot;]),
<a name="488"/>  488:      list_to_atom(&quot;tmp&quot; ++ integer_to_list(C))}.
</pre>
</body>
</html>
