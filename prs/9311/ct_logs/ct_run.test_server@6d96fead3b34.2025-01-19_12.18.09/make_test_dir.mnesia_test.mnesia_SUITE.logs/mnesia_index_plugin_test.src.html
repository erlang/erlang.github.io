<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/mnesia/make_test_dir/mnesia_test/mnesia_index_plugin_test.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1996-2020. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <b>-module</b>(mnesia_index_plugin_test).
<a name="23"/>   23: <b>-author</b>('ulf@wiger.net').
<a name="24"/>   24: 
<a name="25"/>   25: <b>-export</b>([init_per_testcase/2, end_per_testcase/2,
<a name="26"/>   26:          init_per_group/2, end_per_group/2,
<a name="27"/>   27:          init_per_suite/1, end_per_suite/1,
<a name="28"/>   28:          all/0, groups/0]).
<a name="29"/>   29: 
<a name="30"/>   30: <b>-export</b>([
<a name="31"/>   31:          add_rm_plugin/1,
<a name="32"/>   32:          tab_with_plugin_index/1,
<a name="33"/>   33:          tab_with_multiple_plugin_indexes/1,
<a name="34"/>   34:          ix_match_w_plugin/1,
<a name="35"/>   35:          ix_match_w_plugin_ordered/1,
<a name="36"/>   36:          ix_match_w_plugin_bag/1,
<a name="37"/>   37:          ix_update_w_plugin/1
<a name="38"/>   38:         ]).
<a name="39"/>   39: 
<a name="40"/>   40: <b>-export</b>([ix_prefixes/3,    % test plugin
<a name="41"/>   41:          ix_prefixes2/3]). % test plugin 2
<a name="42"/>   42: 
<a name="43"/>   43: <b>-include</b>(&quot;mnesia_test_lib.hrl&quot;).
<a name="44"/>   44: 
<a name="init_per_suite-1"/><a name="45"/>   45: <b>init_per_suite</b>(Conf) -&gt;
<a name="init_per_suite-last_expr"/><a name="46"/>   46:     Conf.
<a name="47"/>   47: 
<a name="end_per_suite-1"/><a name="48"/>   48: <b>end_per_suite</b>(Conf) -&gt;
<a name="end_per_suite-last_expr"/><a name="49"/>   49:     Conf.
<a name="50"/>   50: 
<a name="init_per_testcase-2"/><a name="51"/>   51: <b>init_per_testcase</b>(Func, Conf) -&gt;
<a name="init_per_testcase-last_expr"/><a name="52"/>   52: <b>    mnesia_test_lib:init_per_testcase</b>(Func, Conf).
<a name="53"/>   53: 
<a name="end_per_testcase-2"/><a name="54"/>   54: <b>end_per_testcase</b>(Func, Conf) -&gt;
<a name="end_per_testcase-last_expr"/><a name="55"/>   55: <b>    mnesia_test_lib:end_per_testcase</b>(Func, Conf).
<a name="56"/>   56: 
<a name="all-0"/><a name="57"/>   57: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="58"/>   58:     [add_rm_plugin,
<a name="59"/>   59:      tab_with_plugin_index,
<a name="60"/>   60:      tab_with_multiple_plugin_indexes,
<a name="61"/>   61:      ix_match_w_plugin,
<a name="62"/>   62:      ix_match_w_plugin_ordered,
<a name="63"/>   63:      ix_match_w_plugin_bag,
<a name="64"/>   64:      ix_update_w_plugin].
<a name="65"/>   65: 
<a name="groups-0"/><a name="66"/>   66: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="67"/>   67:     [].
<a name="68"/>   68: 
<a name="init_per_group-2"/><a name="69"/>   69: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="70"/>   70:     Config.
<a name="71"/>   71: 
<a name="end_per_group-2"/><a name="72"/>   72: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="73"/>   73:     Config.
<a name="74"/>   74: 
<a name="75"/>   75: 
<a name="add_rm_plugin-1"/><a name="76"/>   76: <b>add_rm_plugin</b>(suite) -&gt; [];
<a name="77"/>   77: <b>add_rm_plugin</b>(Config) when is_list(Config) -&gt;
<a name="78"/>   78:     [N1, N2] = Nodes = ?acquire_nodes(2, Config),
<a name="79"/>   79:     ok = add_plugin(),
<a name="80"/>   80:     ok = rpc_check_plugin(N1),
<a name="81"/>   81:     ok = rpc_check_plugin(N2),
<a name="82"/>   82:     ok = add_plugin2(),
<a name="83"/>   83:     ok = del_plugin(),
<a name="84"/>   84:     ok = del_plugin2(),
<a name="85"/>   85:     ok = add_plugin(),
<a name="86"/>   86:     ok = add_plugin2(),
<a name="87"/>   87:     ok = del_plugin(),
<a name="88"/>   88:     ok = del_plugin2(),
<a name="add_rm_plugin-last_expr"/><a name="89"/>   89: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="90"/>   90: 
<a name="91"/>   91: <b>-define</b>(PLUGIN1, {{pfx},?MODULE,ix_prefixes}).
<a name="92"/>   92: <b>-define</b>(PLUGIN2, {{pfx2},?MODULE,ix_prefixes2}).
<a name="93"/>   93: 
<a name="add_plugin-0"/><a name="94"/>   94: <b>add_plugin</b>() -&gt;
<a name="95"/>   95:     {atomic, ok} = mnesia_schema:add_index_plugin({pfx}, ?MODULE, ix_prefixes),
<a name="96"/>   96:     [?PLUGIN1] = mnesia_schema:index_plugins(),
<a name="add_plugin-last_expr"/><a name="97"/>   97:     ok.
<a name="98"/>   98: 
<a name="add_plugin2-0"/><a name="99"/>   99: <b>add_plugin2</b>() -&gt;
<a name="100"/>  100:     {atomic, ok} = mnesia_schema:add_index_plugin({pfx2}, ?MODULE, ix_prefixes2),
<a name="101"/>  101:     [?PLUGIN1, ?PLUGIN2] = lists:sort(mnesia_schema:index_plugins()),
<a name="add_plugin2-last_expr"/><a name="102"/>  102:     ok.
<a name="103"/>  103: 
<a name="del_plugin-0"/><a name="104"/>  104: <b>del_plugin</b>() -&gt;
<a name="105"/>  105:     {atomic, ok} = mnesia_schema:delete_index_plugin({pfx}),
<a name="106"/>  106:     [?PLUGIN2] = mnesia_schema:index_plugins(),
<a name="del_plugin-last_expr"/><a name="107"/>  107:     ok.
<a name="108"/>  108: 
<a name="del_plugin2-0"/><a name="109"/>  109: <b>del_plugin2</b>() -&gt;
<a name="110"/>  110:     {atomic, ok} = mnesia_schema:delete_index_plugin({pfx2}),
<a name="111"/>  111:     [] = mnesia_schema:index_plugins(),
<a name="del_plugin2-last_expr"/><a name="112"/>  112:     ok.
<a name="113"/>  113: 
<a name="rpc_check_plugin-1"/><a name="114"/>  114: <b>rpc_check_plugin</b>(N) -&gt;
<a name="115"/>  115:     [?PLUGIN1] =
<a name="116"/>  116:         rpc:call(N, mnesia_schema, index_plugins, []),
<a name="rpc_check_plugin-last_expr"/><a name="117"/>  117:     ok.
<a name="118"/>  118: 
<a name="tab_with_plugin_index-1"/><a name="119"/>  119: <b>tab_with_plugin_index</b>(suite) -&gt; [];
<a name="120"/>  120: <b>tab_with_plugin_index</b>(Config) when is_list(Config) -&gt;
<a name="121"/>  121:     [_N1] = Nodes = ?acquire_nodes(1, Config),
<a name="122"/>  122:     ok = add_plugin(),
<a name="123"/>  123:     {atomic, ok} = mnesia:create_table(t, [{attributes, [k,v1,v2]},
<a name="124"/>  124:                                            {index, [{{pfx}, ordered},
<a name="125"/>  125:                                                     {v1, ordered},
<a name="126"/>  126:                                                     v2]}]),
<a name="127"/>  127:     [ok,ok,ok,ok] =
<a name="128"/>  128:         [mnesia:dirty_write({t, K, V1, V2})
<a name="129"/>  129:          || {K,V1,V2} &lt;- [{1,a,&quot;123&quot;},
<a name="130"/>  130:                           {2,b,&quot;12345&quot;},
<a name="131"/>  131:                           {3,c,&quot;6789&quot;},
<a name="132"/>  132:                           {4,d,nil}]],
<a name="133"/>  133:     [{t,1,a,&quot;123&quot;},{t,2,b,&quot;12345&quot;}] =
<a name="134"/>  134:         mnesia:dirty_index_read(t,&lt;&lt;&quot;123&quot;&gt;&gt;,{pfx}),
<a name="135"/>  135:     [{t,3,c,&quot;6789&quot;}] =
<a name="136"/>  136:         mnesia:dirty_index_read(t,&quot;6789&quot;,v2),
<a name="137"/>  137:     [{t,1,a,&quot;123&quot;}] =
<a name="138"/>  138:         mnesia:dirty_match_object({t,'_',a,&quot;123&quot;}),
<a name="139"/>  139:     [{t,1,a,&quot;123&quot;}] =
<a name="140"/>  140:         mnesia:dirty_select(t, [{ {t,'_',a,&quot;123&quot;}, [], ['$_']}]),
<a name="141"/>  141:     mnesia:dirty_delete(t,2),
<a name="142"/>  142:     [{t,1,a,&quot;123&quot;}] =
<a name="143"/>  143:         mnesia:dirty_index_read(t,&lt;&lt;&quot;123&quot;&gt;&gt;,{pfx}),
<a name="tab_with_plugin_index-last_expr"/><a name="144"/>  144: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="145"/>  145: 
<a name="tab_with_multiple_plugin_indexes-1"/><a name="146"/>  146: <b>tab_with_multiple_plugin_indexes</b>(suite) -&gt; [];
<a name="147"/>  147: <b>tab_with_multiple_plugin_indexes</b>(Config) when is_list(Config) -&gt;
<a name="148"/>  148:     [_N1] = Nodes = ?acquire_nodes(1, Config),
<a name="149"/>  149:     ok = add_plugin(),
<a name="150"/>  150:     ok = add_plugin2(),
<a name="151"/>  151:     {atomic, ok} =
<a name="152"/>  152:         mnesia:create_table(u, [{attributes, [k,v1,v2]},
<a name="153"/>  153:                                 {index, [{{pfx}, ordered},
<a name="154"/>  154:                                          {{pfx2}, ordered}]}]),
<a name="155"/>  155:         [ok,ok,ok,ok] =
<a name="156"/>  156:         [mnesia:dirty_write({u, K, V1, V2})
<a name="157"/>  157:          || {K,V1,V2} &lt;- [{1,a,&quot;123&quot;},
<a name="158"/>  158:                           {2,b,&quot;12345&quot;},
<a name="159"/>  159:                           {3,c,&quot;6789&quot;},
<a name="160"/>  160:                           {4,d,nil}]],
<a name="161"/>  161:     [{u,1,a,&quot;123&quot;},{u,2,b,&quot;12345&quot;}] =
<a name="162"/>  162:         mnesia:dirty_index_read(u,&lt;&lt;&quot;123&quot;&gt;&gt;,{pfx}),
<a name="163"/>  163:     [{u,1,a,&quot;123&quot;},{u,2,b,&quot;12345&quot;}] =
<a name="164"/>  164:         mnesia:dirty_index_read(u,&lt;&lt;&quot;321&quot;&gt;&gt;,{pfx2}),
<a name="tab_with_multiple_plugin_indexes-last_expr"/><a name="165"/>  165: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="166"/>  166: 
<a name="ix_match_w_plugin-1"/><a name="167"/>  167: <b>ix_match_w_plugin</b>(suite) -&gt; [];
<a name="168"/>  168: <b>ix_match_w_plugin</b>(Config) when is_list(Config) -&gt;
<a name="169"/>  169:     [_N1] = Nodes = ?acquire_nodes(1, Config),
<a name="170"/>  170:     ok = add_plugin(),
<a name="171"/>  171:     {atomic, ok} = mnesia:create_table(im1, [{attributes, [k, v1, v2]},
<a name="172"/>  172:                                              {index, [{{pfx}, ordered},
<a name="173"/>  173:                                                       {v1, ordered}]}]),
<a name="174"/>  174:     fill_and_test_index_match(im1, set),
<a name="ix_match_w_plugin-last_expr"/><a name="175"/>  175: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="176"/>  176: 
<a name="177"/>  177: 
<a name="ix_match_w_plugin_ordered-1"/><a name="178"/>  178: <b>ix_match_w_plugin_ordered</b>(suite) -&gt; [];
<a name="179"/>  179: <b>ix_match_w_plugin_ordered</b>(Config) when is_list(Config) -&gt;
<a name="180"/>  180:     [_N1] = Nodes = ?acquire_nodes(1, Config),
<a name="181"/>  181:     ok = add_plugin(),
<a name="182"/>  182:     {atomic, ok} = mnesia:create_table(im2, [{attributes, [k, v1, v2]},
<a name="183"/>  183:                                              {type, ordered_set},
<a name="184"/>  184:                                              {index, [{{pfx}, ordered},
<a name="185"/>  185:                                                       {v1, ordered}]}]),
<a name="186"/>  186:     fill_and_test_index_match(im2, ordered_set),
<a name="ix_match_w_plugin_ordered-last_expr"/><a name="187"/>  187: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="188"/>  188: 
<a name="ix_match_w_plugin_bag-1"/><a name="189"/>  189: <b>ix_match_w_plugin_bag</b>(suite) -&gt; [];
<a name="190"/>  190: <b>ix_match_w_plugin_bag</b>(Config) when is_list(Config) -&gt;
<a name="191"/>  191:     [_N1] = Nodes = ?acquire_nodes(1, Config),
<a name="192"/>  192:     ok = add_plugin(),
<a name="193"/>  193:     {atomic, ok} = mnesia:create_table(im3, [{attributes, [k, v1, v2]},
<a name="194"/>  194:                                              {type, bag},
<a name="195"/>  195:                                              {index, [{{pfx}, ordered},
<a name="196"/>  196:                                                       {v1, ordered}]}]),
<a name="197"/>  197:     fill_and_test_index_match(im3, bag),
<a name="ix_match_w_plugin_bag-last_expr"/><a name="198"/>  198: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="199"/>  199: 
<a name="ix_update_w_plugin-1"/><a name="200"/>  200: <b>ix_update_w_plugin</b>(suite) -&gt; [];
<a name="201"/>  201: <b>ix_update_w_plugin</b>(Config) when is_list(Config) -&gt;
<a name="202"/>  202:     [_N1] = Nodes = ?acquire_nodes(1, Config),
<a name="203"/>  203:     ok = add_plugin(),
<a name="204"/>  204:     {atomic, ok} = mnesia:create_table(im4, [{attributes, [k, v1, v2]},
<a name="205"/>  205:                                              {type, ordered_set},
<a name="206"/>  206:                                              {index, [{{pfx}, ordered},
<a name="207"/>  207:                                                       {v1, ordered}]}]),
<a name="208"/>  208: 
<a name="209"/>  209:     mnesia:dirty_write({im4, 1, &quot;1234&quot;, &quot;abcd&quot;}),
<a name="210"/>  210:     ?match([{im4, 1, &quot;1234&quot;, &quot;abcd&quot;}], mnesia:dirty_index_read(im4, &lt;&lt;&quot;123&quot;&gt;&gt;, {pfx})),
<a name="211"/>  211:     ?match([{im4, 1, &quot;1234&quot;, &quot;abcd&quot;}], mnesia:dirty_index_read(im4, &lt;&lt;&quot;abc&quot;&gt;&gt;, {pfx})),
<a name="212"/>  212:     mnesia:dirty_write({im4, 1, &quot;1234&quot;, &quot;efgh&quot;}),
<a name="213"/>  213:     ?match([{im4, 1, &quot;1234&quot;, &quot;efgh&quot;}], mnesia:dirty_index_read(im4, &lt;&lt;&quot;123&quot;&gt;&gt;, {pfx})),
<a name="214"/>  214:     ?match([{im4, 1, &quot;1234&quot;, &quot;efgh&quot;}], mnesia:dirty_index_read(im4, &lt;&lt;&quot;efg&quot;&gt;&gt;, {pfx})),
<a name="ix_update_w_plugin-last_expr"/><a name="215"/>  215: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="216"/>  216: 
<a name="fill_and_test_index_match-2"/><a name="217"/>  217: <b>fill_and_test_index_match</b>(Tab, Type) -&gt;
<a name="218"/>  218:     [ok,ok,ok,ok,ok,ok,ok,ok,ok] =
<a name="219"/>  219:         [mnesia:dirty_write({Tab, K, V1, V2})
<a name="220"/>  220:          || {K,V1,V2} &lt;- [{1,a,&quot;123&quot;},
<a name="221"/>  221:                           {2,b,&quot;12345&quot;},
<a name="222"/>  222:                           {3,c,&quot;123&quot;},
<a name="223"/>  223:                           {4,d,nil},
<a name="224"/>  224:                           {5,e,nil},
<a name="225"/>  225:                           {6,f,nil},
<a name="226"/>  226:                           {7,g,nil},  %% overwritten if not bag
<a name="227"/>  227:                           {7,g,&quot;234&quot;},
<a name="228"/>  228:                           {8,h,&quot;123&quot;}]],
<a name="fill_and_test_index_match-last_expr"/><a name="229"/>  229: <b>    mnesia:activity</b>(
<a name="230"/>  230:       transaction,
<a name="231"/>  231:       fun() -&gt;
<a name="232"/>  232:               ok = mnesia:write({Tab, 1, aa, &quot;1234&quot;}), %% replaces if not bag
<a name="233"/>  233:               ok = mnesia:delete({Tab, 2}),
<a name="234"/>  234:               ok = mnesia:delete({Tab, 4}),
<a name="235"/>  235:               ok = mnesia:write({Tab, 6, ff, nil}),
<a name="236"/>  236:               ok = mnesia:write({Tab, 7, gg, &quot;123&quot;}),
<a name="237"/>  237:               ok = mnesia:write({Tab, 100, x, nil}),
<a name="238"/>  238:               ok = mnesia:delete_object({Tab,3,c,&quot;123&quot;}),
<a name="239"/>  239:               ok = mnesia:delete_object({Tab,5,e,nil}),
<a name="240"/>  240:               Res = mnesia:index_read(Tab, &lt;&lt;&quot;123&quot;&gt;&gt;, {pfx}),
<a name="241"/>  241:               SetRes = [{Tab,1,aa,&quot;1234&quot;}, {Tab,7,gg,&quot;123&quot;}, {Tab,8,h,&quot;123&quot;}],
<a name="242"/>  242:               case Type of
<a name="243"/>  243:                   set -&gt;
<a name="244"/>  244:                       SetRes = lists:sort(Res);
<a name="245"/>  245:                   ordered_set -&gt;
<a name="246"/>  246:                       SetRes = Res;
<a name="247"/>  247:                   bag -&gt;
<a name="248"/>  248:                       [{Tab,1,a,&quot;123&quot;}, {Tab,1,aa,&quot;1234&quot;},
<a name="249"/>  249:                        {Tab,7,gg,&quot;123&quot;}, {Tab,8,h,&quot;123&quot;}] = lists:sort(Res)
<a name="250"/>  250:               end
<a name="251"/>  251:       end).
<a name="252"/>  252: 
<a name="253"/>  253: <i>%% ============================================================</i>
<a name="254"/>  254: <i>%%</i>
<a name="ix_prefixes-3"/><a name="255"/>  255: <b>ix_prefixes</b>(_Tab, _Pos, Obj) -&gt;
<a name="ix_prefixes-last_expr"/><a name="256"/>  256: <b>    lists:foldl</b>(
<a name="257"/>  257:       fun(V, Acc) when is_list(V) -&gt;
<a name="258"/>  258:               try Pfxs = prefixes(list_to_binary(V)),
<a name="259"/>  259:                    Pfxs ++ Acc
<a name="260"/>  260:               catch
<a name="261"/>  261:                   error:_ -&gt;
<a name="262"/>  262:                       Acc
<a name="263"/>  263:               end;
<a name="264"/>  264:          (V, Acc) when is_binary(V) -&gt;
<a name="265"/>  265:               Pfxs = prefixes(V),
<a name="266"/>  266:               Pfxs ++ Acc;
<a name="267"/>  267:          (_, Acc) -&gt;
<a name="268"/>  268:               Acc
<a name="269"/>  269:       end, [], tl(tuple_to_list(Obj))).
<a name="270"/>  270: 
<a name="ix_prefixes2-3"/><a name="271"/>  271: <b>ix_prefixes2</b>(Tab, Pos, Obj) -&gt;
<a name="ix_prefixes2-last_expr"/><a name="272"/>  272: <b>    [rev</b>(P) || P &lt;- ix_prefixes(Tab, Pos, Obj)].
<a name="273"/>  273: 
<a name="rev-1"/><a name="274"/>  274: <b>rev</b>(B) when is_binary(B) -&gt;
<a name="rev-last_expr"/><a name="275"/>  275: <b>    list_to_binary</b>(lists:reverse(binary_to_list(B))).
<a name="276"/>  276: 
<a name="prefixes-1"/><a name="277"/>  277: <b>prefixes</b>(&lt;&lt;P:3/binary, _/binary&gt;&gt;) -&gt;
<a name="278"/>  278:     [P];
<a name="279"/>  279: <b>prefixes</b>(_) -&gt;
<a name="prefixes-last_expr"/><a name="280"/>  280:     [].
</pre>
</body>
</html>
