<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/after_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1997-2017. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(after_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <i>%% Tests receive after.</i>
<a name="24"/>   24: 
<a name="25"/>   25: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="26"/>   26: 
<a name="27"/>   27: <b>-export</b>([all/0, suite/0,
<a name="28"/>   28: 	 t_after/1, receive_after/1, receive_after_big/1,
<a name="29"/>   29: 	 receive_after_errors/1, receive_var_zero/1, receive_zero/1,
<a name="30"/>   30: 	 multi_timeout/1, receive_after_32bit/1,
<a name="31"/>   31: 	 receive_after_blast/1]).
<a name="32"/>   32: 
<a name="33"/>   33: <i>%% Internal exports.</i>
<a name="34"/>   34: 
<a name="35"/>   35: <b>-export</b>([timeout_g/0]).
<a name="36"/>   36: 
<a name="suite-0"/><a name="37"/>   37: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="38"/>   38:     [{ct_hooks,[ts_install_cth]},
<a name="39"/>   39:      {timetrap, {minutes, 4}}].
<a name="40"/>   40: 
<a name="all-0"/><a name="41"/>   41: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="42"/>   42:     [t_after, receive_after, receive_after_big,
<a name="43"/>   43:      receive_after_errors, receive_var_zero, receive_zero,
<a name="44"/>   44:      multi_timeout, receive_after_32bit, receive_after_blast].
<a name="45"/>   45: 
<a name="46"/>   46: <i>%% Tests for an old round-off error in 'receive after'.&quot;</i>
<a name="t_after-1"/><a name="47"/>   47: <b>t_after</b>(Config) when is_list(Config) -&gt;
<a name="48"/>   48:     Frequent = spawn_link(fun frequent_process/0),
<a name="49"/>   49:     Period = test_server:minutes(1),
<a name="50"/>   50:     Before = erlang:monotonic_time(),
<a name="t_after-last_expr"/><a name="51"/>   51:     receive
<a name="52"/>   52:     after Period -&gt;
<a name="53"/>   53:             After = erlang:monotonic_time(),
<a name="54"/>   54:             unlink(Frequent),
<a name="55"/>   55:             exit(Frequent, die),
<a name="56"/>   56:             report(Period, Before, After)
<a name="57"/>   57:     end.
<a name="58"/>   58: 
<a name="report-3"/><a name="59"/>   59: <b>report</b>(Period, Before, After) -&gt;
<a name="report-last_expr"/><a name="60"/>   60: <b>    case erlang:convert_time_unit</b>(After - Before, native, 100*1000) / Period of
<a name="61"/>   61:         Percent when Percent &gt; 100.10 -&gt;
<a name="62"/>   62:             ct:fail({too_inaccurate, Percent});
<a name="63"/>   63:         Percent when Percent &lt; 100.0 -&gt;
<a name="64"/>   64:             ct:fail({too_early, Percent});
<a name="65"/>   65:         Percent -&gt;
<a name="66"/>   66:             Comment = io_lib:format(&quot;Elapsed/expected: ~.2f %&quot;, [Percent]),
<a name="67"/>   67:             {comment, lists:flatten(Comment)}
<a name="68"/>   68:     end.
<a name="69"/>   69: 
<a name="frequent_process-0"/><a name="70"/>   70: <b>frequent_process</b>() -&gt;
<a name="frequent_process-last_expr"/><a name="71"/>   71:     receive
<a name="72"/>   72:     after 100 -&gt;
<a name="73"/>   73:               frequent_process()
<a name="74"/>   74:     end.
<a name="75"/>   75: 
<a name="76"/>   76: <i>%%  Test that 'receive after' works (doesn't hang).</i>
<a name="77"/>   77: <i>%%  The test takes 10 seconds to complete.</i>
<a name="receive_after-1"/><a name="78"/>   78: <b>receive_after</b>(Config) when is_list(Config) -&gt;
<a name="receive_after-last_expr"/><a name="79"/>   79: <b>    receive_after1</b>(5000).
<a name="80"/>   80: 
<a name="receive_after1-1"/><a name="81"/>   81: <b>receive_after1</b>(1) -&gt;
<a name="82"/>   82:     io:format(&quot;Testing: receive after ~p~n&quot;, [1]), 
<a name="83"/>   83:     receive after 1 -&gt; ok end;
<a name="84"/>   84: <b>receive_after1</b>(N) -&gt; 
<a name="85"/>   85:     io:format(&quot;Testing: receive after ~p~n&quot;, [N]), 
<a name="receive_after1-last_expr"/><a name="86"/>   86: <b>    receive after N -&gt; receive_after1</b>(N div 2) end.
<a name="87"/>   87: 
<a name="receive_after_big-1"/><a name="88"/>   88: <b>receive_after_big</b>(Config) when is_list(Config) -&gt;
<a name="89"/>   89:     %% Test that 'receive after' with a 32 bit number works.
<a name="90"/>   90:     receive_after_big1(16#f7654321),
<a name="receive_after_big-last_expr"/><a name="91"/>   91: <b>    receive_after_big2</b>().
<a name="92"/>   92: 
<a name="receive_after_big1-1"/><a name="93"/>   93: <b>receive_after_big1</b>(Timeout) -&gt;
<a name="94"/>   94:     Self = self(),
<a name="95"/>   95:     erlang:yield(),
<a name="96"/>   96:     spawn(fun() -&gt; Self ! here_is_a_message end),
<a name="receive_after_big1-last_expr"/><a name="97"/>   97:     ok = receive
<a name="98"/>   98:              here_is_a_message -&gt;
<a name="99"/>   99:                  ok
<a name="100"/>  100:          after Timeout -&gt;
<a name="101"/>  101:                    %% We test that the timeout can be set,
<a name="102"/>  102:                    %% not that an timeout occurs after the appropriate delay
<a name="103"/>  103:                    %% (48 days, 56 minutes, 48 seconds)!
<a name="104"/>  104:                    timeout
<a name="105"/>  105:          end.
<a name="106"/>  106: 
<a name="receive_after_big2-0"/><a name="107"/>  107: <b>receive_after_big2</b>() -&gt;
<a name="108"/>  108:     Self = self(),
<a name="109"/>  109:     erlang:yield(),
<a name="110"/>  110:     spawn(fun() -&gt; Self ! here_is_a_message end),
<a name="receive_after_big2-last_expr"/><a name="111"/>  111:     ok = receive
<a name="112"/>  112: 	     here_is_a_message -&gt;
<a name="113"/>  113: 		 ok
<a name="114"/>  114: 	 after 16#f7999977 -&gt;
<a name="115"/>  115: 		 %% We only test that the timeout can be set.
<a name="116"/>  116: 		 timeout
<a name="117"/>  117: 	 end.
<a name="118"/>  118: 
<a name="119"/>  119: <b>-define</b>(TryAfter(Timeout), 
<a name="120"/>  120: 	{'EXIT',{timeout_value,_}} = (catch receive mission -&gt; exit(impossible) after Timeout -&gt; ok end),
<a name="121"/>  121: 	{'EXIT',{timeout_value,_}} = (catch receive after Timeout -&gt; ok end),
<a name="122"/>  122: 	try_after(Timeout)).
<a name="123"/>  123: 
<a name="124"/>  124: <i>%% Test error cases for 'receive after'.</i>
<a name="receive_after_errors-1"/><a name="125"/>  125: <b>receive_after_errors</b>(Config) when is_list(Config) -&gt;
<a name="126"/>  126:     ?TryAfter(-1),
<a name="127"/>  127:     ?TryAfter(0.0),
<a name="128"/>  128:     ?TryAfter(3.14),
<a name="129"/>  129:     ?TryAfter(16#100000000),
<a name="130"/>  130:     ?TryAfter(392347129847294724972398472984729847129874),
<a name="131"/>  131:     ?TryAfter(16#3fffffffffffffff),
<a name="132"/>  132:     ?TryAfter(16#ffffffffffffffff),
<a name="133"/>  133:     ?TryAfter(-16#100000000),
<a name="134"/>  134:     ?TryAfter(-3891278094774921784123987129848),
<a name="135"/>  135:     ?TryAfter(xxx),
<a name="receive_after_errors-last_expr"/><a name="136"/>  136:     ok.
<a name="137"/>  137: 
<a name="try_after-1"/><a name="138"/>  138: <b>try_after</b>(Timeout) -&gt;
<a name="try_after-last_expr"/><a name="139"/>  139: <b>    {'EXIT',{timeout_value,_}} = </b>(catch receive after Timeout -&gt; ok end).
<a name="140"/>  140: 
<a name="141"/>  141: <i>%% Test 'after Z', when Z == 0.</i>
<a name="receive_var_zero-1"/><a name="142"/>  142: <b>receive_var_zero</b>(Config) when is_list(Config) -&gt;
<a name="143"/>  143:     self() ! x,
<a name="144"/>  144:     self() ! y,
<a name="145"/>  145:     Z = zero(),
<a name="146"/>  146:     timeout = receive
<a name="147"/>  147:                   z -&gt; ok
<a name="148"/>  148:               after Z -&gt; timeout
<a name="149"/>  149:               end,
<a name="150"/>  150:     timeout = receive
<a name="151"/>  151:               after Z -&gt; timeout
<a name="152"/>  152:               end,
<a name="153"/>  153:     self() ! w,
<a name="receive_var_zero-last_expr"/><a name="154"/>  154:     receive
<a name="155"/>  155: 	x -&gt; ok;
<a name="156"/>  156: 	Other -&gt;
<a name="157"/>  157: 	    ct:fail({bad_message,Other})
<a name="158"/>  158:     end.
<a name="159"/>  159: 
<a name="zero-0"/><a name="zero-last_expr"/><a name="160"/>  160: <b>zero</b>() -&gt; 0.
<a name="161"/>  161: 
<a name="162"/>  162: <i>%% Test 'after 0'.</i>
<a name="receive_zero-1"/><a name="163"/>  163: <b>receive_zero</b>(Config) when is_list(Config) -&gt;
<a name="164"/>  164:     self() ! x,
<a name="165"/>  165:     self() ! y,
<a name="166"/>  166:     timeout = receive
<a name="167"/>  167:                   z -&gt; ok
<a name="168"/>  168:               after 0 -&gt;
<a name="169"/>  169:                         timeout
<a name="170"/>  170:               end,
<a name="171"/>  171:     self() ! w,
<a name="172"/>  172:     timeout = receive
<a name="173"/>  173:               after 0 -&gt; timeout
<a name="174"/>  174:               end,
<a name="receive_zero-last_expr"/><a name="175"/>  175:     receive
<a name="176"/>  176:         x -&gt; ok;
<a name="177"/>  177:         Other -&gt;
<a name="178"/>  178:             ct:fail({bad_message,Other})
<a name="179"/>  179:     end.
<a name="180"/>  180: 
<a name="181"/>  181: <i>%% Test for catching invalid assertion in erl_message.c (in queue_message)</i>
<a name="182"/>  182: <i>%% This failed (dumped core) with debug-compiled emulator.</i>
<a name="multi_timeout-1"/><a name="183"/>  183: <b>multi_timeout</b>(Config) when is_list(Config) -&gt;
<a name="184"/>  184:     P = spawn(?MODULE, timeout_g, []),
<a name="185"/>  185:     P ! a,
<a name="186"/>  186:     P ! b,
<a name="187"/>  187:     receive
<a name="188"/>  188:     after 1000 -&gt; ok
<a name="189"/>  189:     end,
<a name="190"/>  190:     P ! c,
<a name="191"/>  191:     receive
<a name="192"/>  192:     after 1000 -&gt; ok
<a name="193"/>  193:     end,
<a name="194"/>  194:     P ! d,
<a name="multi_timeout-last_expr"/><a name="195"/>  195:     ok.
<a name="196"/>  196: 
<a name="timeout_g-0"/><a name="197"/>  197: <b>timeout_g</b>() -&gt;
<a name="198"/>  198:     receive
<a name="199"/>  199:         a -&gt; ok
<a name="200"/>  200:     end,
<a name="201"/>  201:     receive
<a name="202"/>  202:     after 100000 -&gt; ok
<a name="203"/>  203:     end,
<a name="timeout_g-last_expr"/><a name="204"/>  204:     ok.
<a name="205"/>  205: 
<a name="206"/>  206: <i>%% OTP-7493: Timeout for 32 bit numbers (such as 16#ffffFFFF) could</i>
<a name="207"/>  207: <i>%% timeout at once.</i>
<a name="receive_after_32bit-1"/><a name="208"/>  208: <b>receive_after_32bit</b>(Config) when is_list(Config) -&gt;
<a name="209"/>  209:     T = 16#ffffFFFF,
<a name="210"/>  210:     Pids = [spawn_link(fun() -&gt; recv_after_32bit(I, T) end) ||
<a name="211"/>  211: 	       I &lt;- lists:seq(1, 2048)],
<a name="212"/>  212: 
<a name="213"/>  213:     %% Wait two seconds for any of the processes to timeout too early.
<a name="214"/>  214:     receive after 2000 -&gt; ok end,
<a name="215"/>  215: 
<a name="216"/>  216:     %% Kill the processes.
<a name="217"/>  217:     [begin unlink(Pid), exit(Pid, kill) end || Pid &lt;- Pids],
<a name="receive_after_32bit-last_expr"/><a name="218"/>  218:     ok.
<a name="219"/>  219: 
<a name="recv_after_32bit-2"/><a name="220"/>  220: <b>recv_after_32bit</b>(I, T) when I rem 2 =:= 0 -&gt;
<a name="221"/>  221:     receive after T -&gt; exit(timeout) end;
<a name="222"/>  222: <b>recv_after_32bit</b>(_, _) -&gt;
<a name="recv_after_32bit-last_expr"/><a name="223"/>  223: <b>    receive after 16#ffffFFFF -&gt; exit</b>(timeout) end.
<a name="224"/>  224: 
<a name="blaster-0"/><a name="225"/>  225: <b>blaster</b>() -&gt;
<a name="blaster-last_expr"/><a name="226"/>  226:     receive
<a name="227"/>  227: 	{go, TimeoutTime} -&gt;
<a name="228"/>  228: 	    Tmo = TimeoutTime - erlang:monotonic_time(millisecond),
<a name="229"/>  229: 	    receive after Tmo -&gt; ok end
<a name="230"/>  230:     end.
<a name="231"/>  231: 
<a name="spawn_blasters-1"/><a name="232"/>  232: <b>spawn_blasters</b>(0) -&gt;
<a name="233"/>  233:     [];
<a name="234"/>  234: <b>spawn_blasters</b>(N) -&gt;
<a name="spawn_blasters-last_expr"/><a name="235"/>  235: <b>    [spawn_monitor</b>(fun () -&gt; blaster() end)|spawn_blasters(N-1)].
<a name="236"/>  236: 
<a name="receive_after_blast-1"/><a name="237"/>  237: <b>receive_after_blast</b>(Config) when is_list(Config) -&gt;
<a name="238"/>  238:     PMs = spawn_blasters(10000),
<a name="239"/>  239:     TimeoutTime = erlang:monotonic_time(millisecond) + 5000,
<a name="240"/>  240:     lists:foreach(fun ({P, _}) -&gt; P ! {go, TimeoutTime} end, PMs),
<a name="receive_after_blast-last_expr"/><a name="241"/>  241: <b>    lists:foreach</b>(fun ({P, M}) -&gt;
<a name="242"/>  242:                           receive
<a name="243"/>  243:                               {'DOWN', M, process, P, normal} -&gt;
<a name="244"/>  244:                                   ok
<a name="245"/>  245:                           end
<a name="246"/>  246:                   end, PMs).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
