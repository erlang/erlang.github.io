<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/compiler/make_test_dir/compiler_test/compilation_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1997-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%% Purpose : Compiles various modules with tough code</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(compilation_SUITE).
<a name="22"/>   22: <b>-export</b>([all/0,suite/0,groups/0,init_per_suite/1,end_per_suite/1,
<a name="23"/>   23: 	 init_per_group/2,end_per_group/2,
<a name="24"/>   24: 	 beam_compiler_4/1,
<a name="25"/>   25: 	 beam_compiler_6/1,
<a name="26"/>   26: 	 beam_compiler_7/1,
<a name="27"/>   27: 	 beam_compiler_8/1,
<a name="28"/>   28: 	 beam_compiler_9/1,
<a name="29"/>   29: 	 beam_compiler_10/1,
<a name="30"/>   30: 	 beam_compiler_11/1,
<a name="31"/>   31: 	 compiler_1/1,
<a name="32"/>   32: 	 const_list_256/1,
<a name="33"/>   33: 	 convopts/1,
<a name="34"/>   34: 	 live_var/1,
<a name="35"/>   35: 	 on_load/1,
<a name="36"/>   36: 	 on_load_inline/1,
<a name="37"/>   37: 	 opt_crash/1,
<a name="38"/>   38: 	 otp_2330/1,
<a name="39"/>   39: 	 otp_2380/1,
<a name="40"/>   40: 	 otp_4790/1,
<a name="41"/>   41: 	 otp_5151/1,
<a name="42"/>   42: 	 otp_5235/1,
<a name="43"/>   43: 	 otp_5404/1,
<a name="44"/>   44: 	 otp_5436/1,
<a name="45"/>   45: 	 otp_5481/1,
<a name="46"/>   46: 	 otp_5553/1,
<a name="47"/>   47: 	 otp_5632/1,
<a name="48"/>   48: 	 otp_5714/1,
<a name="49"/>   49: 	 otp_5872/1,
<a name="50"/>   50: 	 otp_6121/1,
<a name="51"/>   51: 	 otp_7202/1,
<a name="52"/>   52: 	 otp_8949_a/1,
<a name="53"/>   53: 	 redundant_case/1,
<a name="54"/>   54: 	 self_compile/1,
<a name="55"/>   55: 	 self_compile_old_inliner/1,
<a name="56"/>   56: 	 split_cases/1,
<a name="57"/>   57: 	 string_table/1,
<a name="58"/>   58: 	 vsn_1/1,
<a name="59"/>   59: 	 vsn_2/1,
<a name="60"/>   60:          vsn_3/1,
<a name="61"/>   61:          infinite_loop/0,infinite_loop/1]).
<a name="62"/>   62: 
<a name="63"/>   63: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="64"/>   64: 
<a name="suite-0"/><a name="65"/>   65: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="66"/>   66:     [{ct_hooks,[ts_install_cth]},
<a name="67"/>   67:      {timetrap,{minutes,10}}].
<a name="68"/>   68: 
<a name="all-0"/><a name="69"/>   69: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="70"/>   70:     [self_compile_old_inliner,self_compile,
<a name="71"/>   71:      {group,p}].
<a name="72"/>   72: 
<a name="groups-0"/><a name="73"/>   73: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="74"/>   74:     [{vsn,[parallel],[vsn_1,vsn_2,vsn_3]},
<a name="75"/>   75:      {p,test_lib:parallel(),
<a name="76"/>   76:       [compiler_1,
<a name="77"/>   77:        beam_compiler_4,beam_compiler_6,beam_compiler_7,
<a name="78"/>   78:        beam_compiler_8,beam_compiler_9,beam_compiler_10,
<a name="79"/>   79:        beam_compiler_11,
<a name="80"/>   80:        otp_2330,
<a name="81"/>   81:        {group,vsn},otp_2380,otp_4790,
<a name="82"/>   82:        const_list_256,live_var,convopts,
<a name="83"/>   83:        redundant_case,
<a name="84"/>   84:        otp_5151,otp_5235,
<a name="85"/>   85:        opt_crash,otp_5404,otp_5436,otp_5481,
<a name="86"/>   86:        otp_5553,otp_5632,otp_5714,otp_5872,otp_6121,
<a name="87"/>   87:        otp_7202,on_load,on_load_inline,
<a name="88"/>   88:        string_table,otp_8949_a,split_cases,
<a name="89"/>   89:        infinite_loop]}].
<a name="90"/>   90: 
<a name="init_per_suite-1"/><a name="91"/>   91: <b>init_per_suite</b>(Config) -&gt;
<a name="92"/>   92:     test_lib:recompile(?MODULE),
<a name="init_per_suite-last_expr"/><a name="93"/>   93:     Config.
<a name="94"/>   94: 
<a name="end_per_suite-1"/><a name="95"/>   95: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="96"/>   96:     ok.
<a name="97"/>   97: 
<a name="init_per_group-2"/><a name="98"/>   98: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="99"/>   99:     Config.
<a name="100"/>  100: 
<a name="end_per_group-2"/><a name="101"/>  101: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="102"/>  102:     Config.
<a name="103"/>  103: 
<a name="104"/>  104: <b>-define</b>(comp(N),
<a name="105"/>  105: 	N(Config) when is_list(Config) -&gt; try_it(N, Config)).
<a name="106"/>  106: 
<a name="compiler_1-1"/><a name="compiler_1-last_expr"/><a name="107"/>  107: <b>?comp</b>(compiler_1).
<a name="108"/>  108: 
<a name="beam_compiler_4-1"/><a name="beam_compiler_4-last_expr"/><a name="109"/>  109: <b>?comp</b>(beam_compiler_4).
<a name="beam_compiler_6-1"/><a name="beam_compiler_6-last_expr"/><a name="110"/>  110: <b>?comp</b>(beam_compiler_6).
<a name="beam_compiler_8-1"/><a name="beam_compiler_8-last_expr"/><a name="111"/>  111: <b>?comp</b>(beam_compiler_8).
<a name="beam_compiler_9-1"/><a name="beam_compiler_9-last_expr"/><a name="112"/>  112: <b>?comp</b>(beam_compiler_9).
<a name="beam_compiler_10-1"/><a name="beam_compiler_10-last_expr"/><a name="113"/>  113: <b>?comp</b>(beam_compiler_10).
<a name="beam_compiler_11-1"/><a name="beam_compiler_11-last_expr"/><a name="114"/>  114: <b>?comp</b>(beam_compiler_11).
<a name="115"/>  115: 
<a name="otp_2330-1"/><a name="otp_2330-last_expr"/><a name="116"/>  116: <b>?comp</b>(otp_2330).
<a name="otp_2380-1"/><a name="otp_2380-last_expr"/><a name="117"/>  117: <b>?comp</b>(otp_2380).
<a name="otp_4790-1"/><a name="otp_4790-last_expr"/><a name="118"/>  118: <b>?comp</b>(otp_4790).
<a name="otp_5235-1"/><a name="otp_5235-last_expr"/><a name="119"/>  119: <b>?comp</b>(otp_5235).
<a name="120"/>  120: 
<a name="const_list_256-1"/><a name="const_list_256-last_expr"/><a name="121"/>  121: <b>?comp</b>(const_list_256).
<a name="122"/>  122: 
<a name="otp_5151-1"/><a name="otp_5151-last_expr"/><a name="123"/>  123: <b>?comp</b>(otp_5151).
<a name="124"/>  124: 
<a name="live_var-1"/><a name="live_var-last_expr"/><a name="125"/>  125: <b>?comp</b>(live_var).
<a name="opt_crash-1"/><a name="opt_crash-last_expr"/><a name="126"/>  126: <b>?comp</b>(opt_crash).
<a name="127"/>  127: 
<a name="otp_5404-1"/><a name="otp_5404-last_expr"/><a name="128"/>  128: <b>?comp</b>(otp_5404).
<a name="otp_5436-1"/><a name="otp_5436-last_expr"/><a name="129"/>  129: <b>?comp</b>(otp_5436).
<a name="otp_5481-1"/><a name="otp_5481-last_expr"/><a name="130"/>  130: <b>?comp</b>(otp_5481).
<a name="otp_5553-1"/><a name="otp_5553-last_expr"/><a name="131"/>  131: <b>?comp</b>(otp_5553).
<a name="otp_5632-1"/><a name="otp_5632-last_expr"/><a name="132"/>  132: <b>?comp</b>(otp_5632).
<a name="otp_5714-1"/><a name="otp_5714-last_expr"/><a name="133"/>  133: <b>?comp</b>(otp_5714).
<a name="otp_5872-1"/><a name="otp_5872-last_expr"/><a name="134"/>  134: <b>?comp</b>(otp_5872).
<a name="otp_6121-1"/><a name="otp_6121-last_expr"/><a name="135"/>  135: <b>?comp</b>(otp_6121).
<a name="convopts-1"/><a name="convopts-last_expr"/><a name="136"/>  136: <b>?comp</b>(convopts).
<a name="otp_7202-1"/><a name="otp_7202-last_expr"/><a name="137"/>  137: <b>?comp</b>(otp_7202).
<a name="on_load-1"/><a name="on_load-last_expr"/><a name="138"/>  138: <b>?comp</b>(on_load).
<a name="on_load_inline-1"/><a name="on_load_inline-last_expr"/><a name="139"/>  139: <b>?comp</b>(on_load_inline).
<a name="140"/>  140: 
<a name="infinite_loop-0"/><a name="infinite_loop-last_expr"/><a name="141"/>  141: <b>infinite_loop</b>() -&gt; [{timetrap,{minutes,1}}].
<a name="infinite_loop-1"/><a name="infinite_loop-last_expr"/><a name="142"/>  142: <b>?comp</b>(infinite_loop).
<a name="143"/>  143: 
<a name="144"/>  144: <i>%% Code snippet submitted from Ulf Wiger which fails in R3 Beam.</i>
<a name="beam_compiler_7-1"/><a name="145"/>  145: <b>beam_compiler_7</b>(Config) when is_list(Config) -&gt;
<a name="beam_compiler_7-last_expr"/><a name="146"/>  146: <b>    done = empty</b>(2, false).
<a name="147"/>  147: 
<a name="empty-2"/><a name="148"/>  148: <b>empty</b>(N, Toggle) when N &gt; 0 -&gt;
<a name="149"/>  149:     %% R3 Beam copies the second argument to the first before call.
<a name="150"/>  150:     empty(N-1, not(Toggle));
<a name="151"/>  151: <b>empty</b>(_, _) -&gt;
<a name="empty-last_expr"/><a name="152"/>  152:     done.
<a name="153"/>  153: 
<a name="redundant_case-1"/><a name="154"/>  154: <b>redundant_case</b>(Config) when is_list(Config) -&gt;
<a name="155"/>  155:     d = redundant_case_1(1),
<a name="156"/>  156:     d = redundant_case_1(2),
<a name="157"/>  157:     d = redundant_case_1(3),
<a name="158"/>  158:     d = redundant_case_1(4),
<a name="159"/>  159:     d = redundant_case_1(5),
<a name="160"/>  160:     d = redundant_case_1({glurf,glarf}),
<a name="redundant_case-last_expr"/><a name="161"/>  161:     ok.
<a name="162"/>  162: 
<a name="163"/>  163: <i>%% This function always returns 'd'. Check that the compiler otptimizes</i>
<a name="164"/>  164: <i>%% it properly.</i>
<a name="redundant_case_1-1"/><a name="165"/>  165: <b>redundant_case_1</b>(1) -&gt; d;
<a name="166"/>  166: <b>redundant_case_1</b>(2) -&gt; d;
<a name="167"/>  167: <b>redundant_case_1</b>(3) -&gt; d;
<a name="168"/>  168: <b>redundant_case_1</b>(4) -&gt; d;
<a name="redundant_case_1-last_expr"/><a name="169"/>  169: <b>redundant_case_1</b>(_) -&gt; d.
<a name="170"/>  170: 
<a name="try_it-2"/><a name="171"/>  171: <b>try_it</b>(Module, Conf) -&gt;
<a name="172"/>  172:     Timetrap = {minutes,10},
<a name="173"/>  173:     OtherOpts = [],			%Can be changed to [time] if needed
<a name="174"/>  174:     Src = filename:join(proplists:get_value(data_dir, Conf),
<a name="175"/>  175: 			atom_to_list(Module)),
<a name="176"/>  176:     Out = proplists:get_value(priv_dir,Conf),
<a name="177"/>  177:     io:format(&quot;Compiling: ~s\n&quot;, [Src]),
<a name="178"/>  178:     CompRc0 = compile:file(Src, [clint0,clint,ssalint,{outdir,Out},report,
<a name="179"/>  179: 				 bin_opt_info,recv_opt_info|OtherOpts]),
<a name="180"/>  180:     io:format(&quot;Result: ~p\n&quot;,[CompRc0]),
<a name="181"/>  181:     {ok,Mod} = CompRc0,
<a name="182"/>  182: 
<a name="183"/>  183:     load_and_call(Out, Module),
<a name="184"/>  184: 
<a name="185"/>  185:     ct:timetrap(Timetrap),
<a name="186"/>  186:     io:format(&quot;Compiling (without optimization): ~s\n&quot;, [Src]),
<a name="187"/>  187:     CompRc1 = compile:file(Src,
<a name="188"/>  188: 			   [no_copt,no_postopt,
<a name="189"/>  189: 			    {outdir,Out},report|OtherOpts]),
<a name="190"/>  190: 
<a name="191"/>  191:     io:format(&quot;Result: ~p\n&quot;,[CompRc1]),
<a name="192"/>  192:     {ok,Mod} = CompRc1,
<a name="193"/>  193:     load_and_call(Out, Module),
<a name="194"/>  194: 
<a name="195"/>  195:     ct:timetrap(Timetrap),
<a name="196"/>  196:     io:format(&quot;Compiling (with old inliner): ~s\n&quot;, [Src]),
<a name="197"/>  197:     CompRc2 = compile:file(Src, [clint,ssalint,
<a name="198"/>  198: 				 {outdir,Out},report,bin_opt_info,
<a name="199"/>  199: 				 recv_opt_info,{inline,1000}|OtherOpts]),
<a name="200"/>  200:     io:format(&quot;Result: ~p\n&quot;,[CompRc2]),
<a name="201"/>  201:     {ok,Mod} = CompRc2,
<a name="202"/>  202:     load_and_call(Out, Module),
<a name="203"/>  203: 
<a name="204"/>  204:     ct:timetrap(Timetrap),
<a name="205"/>  205:     io:format(&quot;Compiling (from assembly): ~s\n&quot;, [Src]),
<a name="206"/>  206:     {ok,_} = compile:file(Src, [to_asm,{outdir,Out},report|OtherOpts]),
<a name="207"/>  207:     Asm = filename:join(Out, lists:concat([Module, &quot;.S&quot;])),
<a name="208"/>  208:     CompRc3 = compile:file(Asm, [from_asm,{outdir,Out},report|OtherOpts]),
<a name="209"/>  209:     io:format(&quot;Result: ~p\n&quot;,[CompRc3]),
<a name="210"/>  210:     {ok,_} = CompRc3,
<a name="211"/>  211:     load_and_call(Out, Module),
<a name="212"/>  212: 
<a name="try_it-last_expr"/><a name="213"/>  213:     ok.
<a name="214"/>  214: 
<a name="load_and_call-2"/><a name="215"/>  215: <b>load_and_call</b>(Out, Module) -&gt;
<a name="216"/>  216:     io:format(&quot;Loading...\n&quot;,[]),
<a name="217"/>  217:     {module,Module} = code:load_abs(filename:join(Out, Module)),
<a name="218"/>  218: 
<a name="219"/>  219:     io:format(&quot;Calling...\n&quot;,[]),
<a name="220"/>  220:     %% Call M:M, and expect ok back, that's our interface
<a name="221"/>  221:     CallRc = Module:Module(),
<a name="222"/>  222:     io:format(&quot;Got value: ~p\n&quot;,[CallRc]),
<a name="223"/>  223: 
<a name="224"/>  224:     ok = CallRc,
<a name="225"/>  225: 
<a name="226"/>  226:     %% Smoke-test of beam disassembler.
<a name="227"/>  227:     test_lib:smoke_disasm(Module),
<a name="228"/>  228: 
<a name="229"/>  229:     _ = code:delete(Module),
<a name="230"/>  230:     _ = code:purge(Module),
<a name="231"/>  231: 
<a name="232"/>  232:     %% Restore state of trap_exit just in case. (Since the compiler
<a name="233"/>  233:     %% uses a temporary process, we will get {'EXIT',Pid,normal} messages
<a name="234"/>  234:     %% if trap_exit is true.)
<a name="235"/>  235: 
<a name="236"/>  236:     process_flag(trap_exit, false),
<a name="load_and_call-last_expr"/><a name="237"/>  237:     ok.
<a name="238"/>  238: 
<a name="239"/>  239: 
<a name="240"/>  240: <i>%% Test generation of 'vsn' attribute.</i>
<a name="vsn_1-1"/><a name="241"/>  241: <b>vsn_1</b>(Conf) when is_list(Conf) -&gt;
<a name="242"/>  242:     M = vsn_1,
<a name="243"/>  243: 
<a name="244"/>  244:     compile_load(M, proplists:get_value(data_dir, Conf), Conf),
<a name="245"/>  245:     Vsn1 = get_vsn(M),
<a name="246"/>  246:     timer:sleep(1000),
<a name="247"/>  247: 
<a name="248"/>  248:     compile_load(M, proplists:get_value(data_dir, Conf), Conf),
<a name="249"/>  249:     Vsn2 = get_vsn(M),
<a name="250"/>  250: 
<a name="251"/>  251:     compile_load(M, filename:join(proplists:get_value(data_dir, Conf),
<a name="252"/>  252: 				  &quot;other&quot;),
<a name="253"/>  253: 		 Conf),
<a name="254"/>  254:     Vsn3 = get_vsn(M),
<a name="255"/>  255:     if
<a name="256"/>  256: 	Vsn1 == Vsn2, Vsn2 == Vsn3 -&gt;
<a name="257"/>  257: 	    ok;
<a name="258"/>  258: 	true -&gt;
<a name="259"/>  259: 	    ct:fail({vsn, Vsn1, Vsn2, Vsn3})
<a name="260"/>  260:     end,
<a name="vsn_1-last_expr"/><a name="261"/>  261:     ok.
<a name="262"/>  262: 
<a name="263"/>  263: <i>%% Test overriding of generation of 'vsn' attribute.</i>
<a name="vsn_2-1"/><a name="264"/>  264: <b>vsn_2</b>(Conf) when is_list(Conf) -&gt;
<a name="265"/>  265:     M = vsn_2,
<a name="266"/>  266: 
<a name="267"/>  267:     compile_load(M, proplists:get_value(data_dir, Conf), Conf),
<a name="268"/>  268:     Vsn = get_vsn(M),
<a name="269"/>  269:     case Vsn of
<a name="270"/>  270: 	[34] -&gt;
<a name="271"/>  271: 	    ok;
<a name="272"/>  272: 	_ -&gt;
<a name="273"/>  273: 	    ct:fail({vsn, Vsn})
<a name="274"/>  274:     end,
<a name="vsn_2-last_expr"/><a name="275"/>  275:     ok.
<a name="276"/>  276: 
<a name="277"/>  277: <i>%% Test that different code yields different generated 'vsn'.</i>
<a name="vsn_3-1"/><a name="278"/>  278: <b>vsn_3</b>(Conf) when is_list(Conf) -&gt;
<a name="279"/>  279:     M = vsn_3,
<a name="280"/>  280: 
<a name="281"/>  281:     compile_load(M, proplists:get_value(data_dir, Conf), Conf),
<a name="282"/>  282:     Vsn1 = get_vsn(M),
<a name="283"/>  283: 
<a name="284"/>  284:     compile_load(M, filename:join(proplists:get_value(data_dir, Conf),
<a name="285"/>  285: 				  &quot;other&quot;),
<a name="286"/>  286: 		 Conf),
<a name="287"/>  287:     Vsn2 = get_vsn(M),
<a name="288"/>  288:     if
<a name="289"/>  289: 	Vsn1 /= Vsn2 -&gt;
<a name="290"/>  290: 	    ok;
<a name="291"/>  291: 	true -&gt;
<a name="292"/>  292: 	    ct:fail({vsn, Vsn1, Vsn2})
<a name="293"/>  293:     end,
<a name="vsn_3-last_expr"/><a name="294"/>  294:     ok.
<a name="295"/>  295: 
<a name="get_vsn-1"/><a name="296"/>  296: <b>get_vsn</b>(M) -&gt;
<a name="297"/>  297:     {vsn,V} = lists:keyfind(vsn, 1, M:module_info(attributes)),
<a name="get_vsn-last_expr"/><a name="298"/>  298:     V.
<a name="299"/>  299: 
<a name="compile_load-3"/><a name="300"/>  300: <b>compile_load</b>(Module, Dir, Conf) -&gt;
<a name="301"/>  301:     Src = filename:join(Dir, atom_to_list(Module)),
<a name="302"/>  302:     Out = proplists:get_value(priv_dir,Conf),
<a name="303"/>  303:     CompRc = compile:file(Src, [{outdir,Out}]),
<a name="304"/>  304:     {ok, Module} = CompRc,
<a name="305"/>  305:     code:purge(Module),
<a name="306"/>  306:     {module, Module} =
<a name="307"/>  307: 	code:load_abs(filename:join(Out, atom_to_list(Module))),
<a name="compile_load-last_expr"/><a name="308"/>  308:     ok.
<a name="309"/>  309: 
<a name="self_compile-1"/><a name="310"/>  310: <b>self_compile</b>(Config) when is_list(Config) -&gt;
<a name="self_compile-last_expr"/><a name="311"/>  311: <b>    self_compile_1</b>(Config, &quot;new&quot;, [inline]).
<a name="312"/>  312: 
<a name="self_compile_old_inliner-1"/><a name="313"/>  313: <b>self_compile_old_inliner</b>(Config) when is_list(Config) -&gt;
<a name="314"/>  314:     %% The old inliner is useful for testing that sys_core_fold does not
<a name="315"/>  315:     %% introduce name capture problems.
<a name="self_compile_old_inliner-last_expr"/><a name="316"/>  316: <b>    self_compile_1</b>(Config, &quot;old&quot;, [verbose,{inline,500}]).
<a name="317"/>  317: 
<a name="self_compile_1-3"/><a name="318"/>  318: <b>self_compile_1</b>(Config, Prefix, Opts) -&gt;
<a name="319"/>  319:     ct:timetrap({minutes,40}),
<a name="320"/>  320: 
<a name="321"/>  321:     Priv = proplists:get_value(priv_dir,Config),
<a name="322"/>  322:     Version = compiler_version(),
<a name="323"/>  323: 
<a name="324"/>  324:     %% Compile the compiler. (In this node to get better coverage.)
<a name="325"/>  325:     CompA = make_compiler_dir(Priv, Prefix++&quot;compiler_a&quot;),
<a name="326"/>  326:     VsnA = Version ++ &quot;.0&quot;,
<a name="327"/>  327:     compile_compiler(compiler_src(), CompA, VsnA, Opts),
<a name="328"/>  328: 
<a name="329"/>  329:     %% Compile the compiler again using the newly compiled compiler.
<a name="330"/>  330:     %% (In another node because reloading the compiler would disturb cover.)
<a name="331"/>  331:     CompilerB = Prefix++&quot;compiler_b&quot;,
<a name="332"/>  332:     CompB = make_compiler_dir(Priv, CompilerB),
<a name="333"/>  333:     VsnB = VsnA ++ &quot;.0&quot;,
<a name="334"/>  334:     self_compile_node(CompA, CompB, VsnB, Opts),
<a name="335"/>  335: 
<a name="336"/>  336:     %% Compare compiler directories. The compiler directories should
<a name="337"/>  337:     %% be equal (except for beam_asm that contains the compiler version).
<a name="338"/>  338:     compare_compilers(CompA, CompB),
<a name="339"/>  339: 
<a name="self_compile_1-last_expr"/><a name="340"/>  340:     ok.
<a name="341"/>  341: 
<a name="self_compile_node-4"/><a name="342"/>  342: <b>self_compile_node</b>(CompilerDir, OutDir, Version, Opts) -&gt;
<a name="343"/>  343:     ct:timetrap({minutes,15}),
<a name="344"/>  344:     Pa = &quot;-pa &quot; ++ filename:dirname(code:which(?MODULE)) ++
<a name="345"/>  345: 	&quot; -pa &quot; ++ CompilerDir,
<a name="346"/>  346:     Files = compiler_src(),
<a name="347"/>  347: 
<a name="348"/>  348:     %% We don't want the cover server started on the other node,
<a name="349"/>  349:     %% because it will load the same cover-compiled code as on this
<a name="350"/>  350:     %% node. Use a shielded node to prevent the cover server from
<a name="351"/>  351:     %% being started.
<a name="352"/>  352:     test_server:run_on_shielded_node(
<a name="353"/>  353:       fun() -&gt;
<a name="354"/>  354: 	      compile_compiler(Files, OutDir, Version, Opts)
<a name="355"/>  355:       end, Pa),
<a name="356"/>  356: 
<a name="self_compile_node-last_expr"/><a name="357"/>  357:     ok.
<a name="358"/>  358: 
<a name="compile_compiler-4"/><a name="359"/>  359: <b>compile_compiler</b>(Files, OutDir, Version, InlineOpts) -&gt;
<a name="360"/>  360:     io:format(&quot;~ts&quot;, [code:which(compile)]),
<a name="361"/>  361:     io:format(&quot;Compiling ~s into ~ts&quot;, [Version,OutDir]),
<a name="362"/>  362:     Opts = [report,
<a name="363"/>  363: 	    clint0,clint,ssalint,
<a name="364"/>  364: 	    bin_opt_info,
<a name="365"/>  365:             recv_opt_info,
<a name="366"/>  366: 	    {outdir,OutDir},
<a name="367"/>  367: 	    {d,'COMPILER_VSN',&quot;\&quot;&quot;++Version++&quot;\&quot;&quot;},
<a name="368"/>  368: 	    nowarn_shadow_vars,
<a name="369"/>  369: 	    {i,filename:join(code:lib_dir(stdlib), &quot;include&quot;)}|InlineOpts],
<a name="compile_compiler-last_expr"/><a name="370"/>  370: <b>    test_lib:p_run</b>(fun(File) -&gt;
<a name="371"/>  371: 			   case compile:file(File, Opts) of
<a name="372"/>  372: 			       {ok,_} -&gt; ok;
<a name="373"/>  373: 			       _ -&gt; error
<a name="374"/>  374: 			   end
<a name="375"/>  375: 		   end, Files).
<a name="376"/>  376: 
<a name="compiler_src-0"/><a name="377"/>  377: <b>compiler_src</b>() -&gt;
<a name="compiler_src-last_expr"/><a name="378"/>  378: <b>    filelib:wildcard</b>(filename:join([code:lib_dir(compiler), &quot;src&quot;, &quot;*.erl&quot;])).
<a name="379"/>  379: 
<a name="make_compiler_dir-2"/><a name="380"/>  380: <b>make_compiler_dir</b>(Priv, Dir0) -&gt;
<a name="381"/>  381:     Dir = filename:join(Priv, Dir0),
<a name="382"/>  382:     ok = file:make_dir(Dir),
<a name="make_compiler_dir-last_expr"/><a name="383"/>  383:     Dir.
<a name="384"/>  384: 
<a name="compiler_version-0"/><a name="385"/>  385: <b>compiler_version</b>() -&gt;
<a name="386"/>  386:     {version,Version} = lists:keyfind(version, 1,
<a name="387"/>  387: 				      compile:module_info(compile)),
<a name="compiler_version-last_expr"/><a name="388"/>  388:     Version.
<a name="389"/>  389: 
<a name="compare_compilers-2"/><a name="390"/>  390: <b>compare_compilers</b>(ADir, BDir) -&gt;
<a name="391"/>  391:     {[],[],D} = beam_lib:cmp_dirs(ADir, BDir),
<a name="392"/>  392: 
<a name="393"/>  393:     %% beam_asm.beam contains compiler version and therefore it *must*
<a name="394"/>  394:     %% compare unequal.
<a name="395"/>  395:     [&quot;beam_asm.beam&quot;] = [filename:basename(A) || {A,_} &lt;- D],
<a name="compare_compilers-last_expr"/><a name="396"/>  396:     ok.
<a name="397"/>  397: 
<a name="398"/>  398: <i>%% Check the generation of the string table.</i>
<a name="399"/>  399: 
<a name="string_table-1"/><a name="400"/>  400: <b>string_table</b>(Config) when is_list(Config) -&gt;
<a name="401"/>  401:     DataDir = proplists:get_value(data_dir, Config),
<a name="402"/>  402:     File = filename:join(DataDir, &quot;string_table.erl&quot;),
<a name="403"/>  403:     {ok,string_table,Beam,[]} = compile:file(File, [return, binary]),
<a name="404"/>  404:     {ok,{string_table,[StringTableChunk]}} = beam_lib:chunks(Beam, [&quot;StrT&quot;]),
<a name="405"/>  405:     {&quot;StrT&quot;, &lt;&lt;&quot;abcdefghiABCDEFGHI&quot;&gt;&gt;} = StringTableChunk,
<a name="string_table-last_expr"/><a name="406"/>  406:     ok.
<a name="407"/>  407: 
<a name="otp_8949_a-1"/><a name="408"/>  408: <b>otp_8949_a</b>(Config) when is_list(Config) -&gt;
<a name="409"/>  409:     value = do_otp_8949_a(),
<a name="otp_8949_a-last_expr"/><a name="410"/>  410:     ok.
<a name="411"/>  411: 
<a name="412"/>  412: <b>-record</b>(cs, {exs,keys = [],flags = 1}).
<a name="413"/>  413: <b>-record</b>(exs, {children = []}).
<a name="414"/>  414: 
<a name="do_otp_8949_a-0"/><a name="415"/>  415: <b>do_otp_8949_a</b>() -&gt;
<a name="do_otp_8949_a-last_expr"/><a name="416"/>  416: <b>    case id</b>([#cs{}]) of
<a name="417"/>  417:         [#cs{}=Cs] -&gt;
<a name="418"/>  418:             SomeVar = id(value),
<a name="419"/>  419: 	    if
<a name="420"/>  420: 		Cs#cs.flags band 1 =/= 0 -&gt;
<a name="421"/>  421: 		    id(SomeVar);
<a name="422"/>  422: 		(((Cs#cs.exs)#exs.children /= [])
<a name="423"/>  423:                  and
<a name="424"/>  424: 		   (Cs#cs.flags band (1 bsl 0 bor (1 bsl 22)) == 0));
<a name="425"/>  425: 		Cs#cs.flags band (1 bsl 22) =/= 0 -&gt;
<a name="426"/>  426: 		    ok
<a name="427"/>  427: 	    end
<a name="428"/>  428:     end.
<a name="429"/>  429:     
<a name="split_cases-1"/><a name="430"/>  430: <b>split_cases</b>(_) -&gt;
<a name="431"/>  431:     dummy1 = do_split_cases(x),
<a name="432"/>  432:     {'EXIT',{{badmatch,b},_}} = (catch do_split_cases(y)),
<a name="split_cases-last_expr"/><a name="433"/>  433:     ok.
<a name="434"/>  434: 
<a name="do_split_cases-1"/><a name="435"/>  435: <b>do_split_cases</b>(A) -&gt;
<a name="436"/>  436:     case A of
<a name="437"/>  437:         x -&gt;
<a name="438"/>  438: 	    Z = dummy1;
<a name="439"/>  439:         _ -&gt;
<a name="440"/>  440: 	    Z = dummy2,
<a name="441"/>  441: 	    a=b
<a name="442"/>  442:     end,
<a name="do_split_cases-last_expr"/><a name="443"/>  443:     Z.
<a name="444"/>  444: 
<a name="445"/>  445: 
<a name="id-1"/><a name="id-last_expr"/><a name="446"/>  446: <b>id</b>(I) -&gt; I.
</pre>
</body>
</html>
