<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/sensitive_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2007-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(sensitive_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="24"/>   24: 
<a name="25"/>   25: <b>-export</b>([all/0, suite/0,
<a name="26"/>   26:          stickiness/1,send_trace/1,recv_trace/1,proc_trace/1,call_trace/1,
<a name="27"/>   27:          meta_trace/1,running_trace/1,gc_trace/1,seq_trace/1,
<a name="28"/>   28:          t_process_info/1,t_process_display/1,save_calls/1]).
<a name="29"/>   29: 
<a name="30"/>   30: <b>-export</b>([remote_process_display/0,an_exported_function/1]).
<a name="31"/>   31: 
<a name="32"/>   32: <b>-import</b>(lists, [keysearch/3,foreach/2,sort/1]).
<a name="33"/>   33: 
<a name="suite-0"/><a name="34"/>   34: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="35"/>   35:     [{ct_hooks,[ts_install_cth]},
<a name="36"/>   36:      {timetrap, {minutes, 5}}].
<a name="37"/>   37: 
<a name="all-0"/><a name="38"/>   38: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="39"/>   39:     [stickiness, send_trace, recv_trace, proc_trace,
<a name="40"/>   40:      call_trace, meta_trace, running_trace, gc_trace,
<a name="41"/>   41:      seq_trace, t_process_info, t_process_display,
<a name="42"/>   42:      save_calls].
<a name="43"/>   43: 
<a name="stickiness-1"/><a name="44"/>   44: <b>stickiness</b>(Config) when is_list(Config) -&gt;
<a name="45"/>   45:     {Tracer,Mref} = spawn_monitor(fun() -&gt;
<a name="46"/>   46:                                           receive after infinity -&gt; ok end
<a name="47"/>   47:                                   end),
<a name="48"/>   48:     false = process_flag(sensitive, true),
<a name="49"/>   49:     put(foo, bar),
<a name="50"/>   50: 
<a name="51"/>   51:     Flags = sort([send,'receive',procs,call,running,garbage_collection,
<a name="52"/>   52:                   set_on_spawn,set_on_first_spawn,set_on_link,set_on_first_link]),
<a name="53"/>   53:     foreach(fun(F) -&gt;
<a name="54"/>   54:                     1 = erlang:trace(self(), true, [F,{tracer,Tracer}])
<a name="55"/>   55:             end, Flags),
<a name="56"/>   56:     foreach(fun(F) -&gt;
<a name="57"/>   57:                     1 = erlang:trace(self(), false, [F,{tracer,Tracer}])
<a name="58"/>   58:             end, Flags),
<a name="59"/>   59:     1 = erlang:trace(self(), true, [{tracer,Tracer}|Flags]),
<a name="60"/>   60:     1 = erlang:trace(self(), false, [{tracer,Tracer}|Flags]),
<a name="61"/>   61: 
<a name="62"/>   62:     {messages,[]} = process_info(Tracer, messages),
<a name="63"/>   63:     exit(Tracer, kill),
<a name="64"/>   64:     receive {'DOWN',Mref,_,_,_} -&gt; ok end,
<a name="65"/>   65: 
<a name="66"/>   66:     case process_info(self(), dictionary) of
<a name="67"/>   67:         {dictionary,[]} -&gt; ok;
<a name="68"/>   68:         {dictionary,_} -&gt; ct:fail(sensitive_flag_cleared)
<a name="69"/>   69:     end,
<a name="70"/>   70: 
<a name="71"/>   71:     NewTracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="72"/>   72:     1 = erlang:trace(self(), true, [{tracer,NewTracer}|Flags]),
<a name="73"/>   73:     Flags = sort(element(2, erlang:trace_info(self(), flags))),
<a name="74"/>   74:     {tracer,NewTracer} = erlang:trace_info(self(), tracer),
<a name="75"/>   75: 
<a name="76"/>   76:     %% Process still sensitive. Tracer should disappear when we clear
<a name="77"/>   77:     %% all trace flags.
<a name="78"/>   78:     1 = erlang:trace(self(), false, [{tracer,NewTracer}|Flags]),
<a name="79"/>   79:     {tracer,[]} = erlang:trace_info(self(), tracer),
<a name="80"/>   80: 
<a name="81"/>   81:     unlink(NewTracer), exit(NewTracer, kill),
<a name="stickiness-last_expr"/><a name="82"/>   82:     ok.
<a name="83"/>   83: 
<a name="send_trace-1"/><a name="84"/>   84: <b>send_trace</b>(Config) when is_list(Config) -&gt;
<a name="85"/>   85:     {Dead,Mref} = spawn_monitor(fun() -&gt; ok end),
<a name="86"/>   86:     receive {'DOWN',Mref,_,_,_} -&gt; ok end,
<a name="87"/>   87:     Tracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="88"/>   88:     Sink = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="89"/>   89:     Self = self(),
<a name="90"/>   90: 
<a name="91"/>   91:     1 = erlang:trace(self(), true, [send,{tracer,Tracer}]),
<a name="92"/>   92:     Dead ! before,
<a name="93"/>   93:     Sink ! before,
<a name="94"/>   94:     false = process_flag(sensitive, true),
<a name="95"/>   95:     Sink ! {blurf,lists:seq(1, 50)},
<a name="96"/>   96:     true = process_flag(sensitive, true),
<a name="97"/>   97:     Sink ! lists:seq(1, 100),
<a name="98"/>   98:     Dead ! forget_me,
<a name="99"/>   99:     true = process_flag(sensitive, false),
<a name="100"/>  100:     Sink ! after1,
<a name="101"/>  101:     false = process_flag(sensitive, false),
<a name="102"/>  102:     Sink ! after2,
<a name="103"/>  103:     Dead ! after2,
<a name="104"/>  104:     wait_trace(Self),
<a name="105"/>  105: 
<a name="106"/>  106:     {messages,Messages} = process_info(Tracer, messages),
<a name="107"/>  107:     [{trace,Self,send_to_non_existing_process,before,Dead},
<a name="108"/>  108:      {trace,Self,send,before,Sink},
<a name="109"/>  109:      {trace,Self,send,after1,Sink},
<a name="110"/>  110:      {trace,Self,send,after2,Sink},
<a name="111"/>  111:      {trace,Self,send_to_non_existing_process,after2,Dead}] = Messages,
<a name="112"/>  112: 
<a name="113"/>  113:     unlink(Tracer), exit(Tracer, kill),
<a name="114"/>  114:     unlink(Sink), exit(Sink, kill),
<a name="send_trace-last_expr"/><a name="115"/>  115:     ok.
<a name="116"/>  116: 
<a name="recv_trace-1"/><a name="117"/>  117: <b>recv_trace</b>(Config) when is_list(Config) -&gt;
<a name="118"/>  118:     Parent = self(),
<a name="119"/>  119:     Tracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="120"/>  120:     Sender = spawn_link(fun() -&gt; recv_trace_sender(Parent) end),
<a name="121"/>  121: 
<a name="122"/>  122:     1 = erlang:trace(self(), true, ['receive',{tracer,Tracer}]),
<a name="123"/>  123: 
<a name="124"/>  124:     Sender ! 1,
<a name="125"/>  125:     receive a -&gt; wait_trace(Sender) end,
<a name="126"/>  126: 
<a name="127"/>  127:     false = process_flag(sensitive, true),
<a name="128"/>  128: 
<a name="129"/>  129:     Sender ! 2,
<a name="130"/>  130:     receive {b,[x,y,z]} -&gt; wait_trace(Sender) end,
<a name="131"/>  131: 
<a name="132"/>  132:     true = process_flag(sensitive, false),
<a name="133"/>  133: 
<a name="134"/>  134:     Sender ! 3,
<a name="135"/>  135:     receive c -&gt; wait_trace(Sender) end,
<a name="136"/>  136: 
<a name="137"/>  137:     {messages,Messages} = process_info(Tracer, messages),
<a name="138"/>  138:     [{trace,Parent,'receive',a},
<a name="139"/>  139:      {trace,Parent,'receive',{trace_delivered,_,_}},
<a name="140"/>  140:      {trace,Parent,'receive',c}|_] = Messages,
<a name="141"/>  141: 
<a name="142"/>  142:     unlink(Tracer), exit(Tracer, kill),
<a name="143"/>  143:     unlink(Sender), exit(Sender, kill),
<a name="recv_trace-last_expr"/><a name="144"/>  144:     ok.
<a name="145"/>  145: 
<a name="recv_trace_sender-1"/><a name="146"/>  146: <b>recv_trace_sender</b>(Pid) -&gt;
<a name="147"/>  147:     receive
<a name="148"/>  148:         1 -&gt; Pid ! a;
<a name="149"/>  149:         2 -&gt; Pid ! {b,[x,y,z]};
<a name="150"/>  150:         3 -&gt; Pid ! c
<a name="151"/>  151:     end,
<a name="recv_trace_sender-last_expr"/><a name="152"/>  152: <b>    recv_trace_sender</b>(Pid).
<a name="153"/>  153: 
<a name="proc_trace-1"/><a name="154"/>  154: <b>proc_trace</b>(Config) when is_list(Config) -&gt;
<a name="155"/>  155:     Self = self(),
<a name="156"/>  156:     Tracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="157"/>  157: 
<a name="158"/>  158:     1 = erlang:trace(self(), true, [procs,{tracer,Tracer}]),
<a name="159"/>  159:     false = process_flag(sensitive, true),
<a name="160"/>  160: 
<a name="161"/>  161:     spawn(fun() -&gt; ok end),
<a name="162"/>  162:     register(nisse, self()),
<a name="163"/>  163:     unregister(nisse),
<a name="164"/>  164:     link(Tracer),
<a name="165"/>  165:     unlink(Tracer),
<a name="166"/>  166:     Linker0 = spawn_link(fun() -&gt; ok end),
<a name="167"/>  167:     Mref0 = erlang:monitor(process, Linker0),
<a name="168"/>  168: 
<a name="169"/>  169:     {_,Mref} = spawn_monitor(fun() -&gt; link(Self), unlink(Self) end),
<a name="170"/>  170: 
<a name="171"/>  171:     receive {'DOWN',Mref0,_,_,_} -&gt; ok end,
<a name="172"/>  172: 
<a name="173"/>  173:     receive {'DOWN',Mref,_,_,_} -&gt; ok end,
<a name="174"/>  174: 
<a name="175"/>  175:     true = process_flag(sensitive, false),
<a name="176"/>  176: 
<a name="177"/>  177:     Dead = spawn(fun() -&gt; ok end),
<a name="178"/>  178:     register(arne, self()),
<a name="179"/>  179:     unregister(arne),
<a name="180"/>  180:     {Linker,Mref2} = spawn_monitor(fun() -&gt; link(Self), unlink(Self) end),
<a name="181"/>  181:     receive {'DOWN',Mref2,_,_,_} -&gt; ok end,
<a name="182"/>  182:     Last = spawn_link(fun() -&gt; ok end),
<a name="183"/>  183:     receive after 10 -&gt; ok end,
<a name="184"/>  184:     wait_trace(all),
<a name="185"/>  185:     {messages,Messages} = process_info(Tracer, messages),    
<a name="186"/>  186:     [{trace,Self,spawn,Dead,{erlang,apply,_}},
<a name="187"/>  187:      {trace,Self,register,arne},
<a name="188"/>  188:      {trace,Self,unregister,arne},
<a name="189"/>  189:      {trace,Self,spawn,Linker,_},
<a name="190"/>  190:      {trace,Self,getting_linked,Linker},
<a name="191"/>  191:      {trace,Self,getting_unlinked,Linker},
<a name="192"/>  192:      {trace,Self,spawn,Last,_},
<a name="193"/>  193:      {trace,Self,link,Last},
<a name="194"/>  194:      {trace,Self,getting_unlinked,Last}] = Messages,
<a name="195"/>  195: 
<a name="196"/>  196:     unlink(Tracer), exit(Tracer, kill),
<a name="proc_trace-last_expr"/><a name="197"/>  197:     ok.
<a name="198"/>  198: 
<a name="call_trace-1"/><a name="199"/>  199: <b>call_trace</b>(Config) when is_list(Config) -&gt;
<a name="200"/>  200:     Self = self(),
<a name="201"/>  201:     Tracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="202"/>  202: 
<a name="203"/>  203:     1 = erlang:trace(self(), true, [call,{tracer,Tracer}]),
<a name="204"/>  204:     1 = erlang:trace_pattern({?MODULE,an_exported_function,1},
<a name="205"/>  205:                              true, [global]),
<a name="206"/>  206:     1 = erlang:trace_pattern({erlang,list_to_binary,1}, true, [global]),
<a name="207"/>  207:     1 = erlang:trace_pattern({erlang,binary_to_list,1}, true, [local]),
<a name="208"/>  208:     Local = erlang:trace_pattern({?MODULE,'_','_'}, true, [local]),
<a name="209"/>  209: 
<a name="210"/>  210:     false = process_flag(sensitive, true),
<a name="211"/>  211:     {ok,42} = a_local_function(42),
<a name="212"/>  212:     7 = an_exported_function(6),
<a name="213"/>  213:     &lt;&lt;7,8,9,10&gt;&gt; = list_to_binary(id([7,8,9,10])),
<a name="214"/>  214:     [42,43] = binary_to_list(id(&lt;&lt;42,43&gt;&gt;)),
<a name="215"/>  215:     true = process_flag(sensitive, false),
<a name="216"/>  216: 
<a name="217"/>  217:     {ok,{a,b}} = a_local_function({a,b}),
<a name="218"/>  218:     1 = an_exported_function(0),
<a name="219"/>  219:     &lt;&lt;1,2,3&gt;&gt; = list_to_binary(id([1,2,3])),
<a name="220"/>  220:     [42,43,44] = binary_to_list(id(&lt;&lt;42,43,44&gt;&gt;)),
<a name="221"/>  221: 
<a name="222"/>  222:     wait_trace(Self),
<a name="223"/>  223: 
<a name="224"/>  224:     {messages,Messages} = process_info(Tracer, messages),    
<a name="225"/>  225:     [{trace,Self,call,{?MODULE,a_local_function,[{a,b}]}},
<a name="226"/>  226:      {trace,Self,call,{?MODULE,an_exported_function,[0]}},
<a name="227"/>  227:      {trace,Self,call,{?MODULE,id,[_]}},
<a name="228"/>  228:      {trace,Self,call,{erlang,list_to_binary,[[1,2,3]]}},
<a name="229"/>  229:      {trace,Self,call,{sensitive_SUITE,id,[&lt;&lt;42,43,44&gt;&gt;]}},
<a name="230"/>  230:      {trace,Self,call,{erlang,binary_to_list,[&lt;&lt;42,43,44&gt;&gt;]}},
<a name="231"/>  231:      {trace,Self,call,{?MODULE,wait_trace,[Self]}}] = Messages,
<a name="232"/>  232: 
<a name="233"/>  233:     Local = erlang:trace_pattern({?MODULE,'_','_'}, false, [local]),
<a name="234"/>  234:     erlang:trace_pattern({erlang,'_','_'}, false, [local]),
<a name="235"/>  235:     erlang:trace_pattern({'_','_','_'}, false, [global]),
<a name="236"/>  236: 
<a name="237"/>  237:     unlink(Tracer), exit(Tracer, kill),
<a name="call_trace-last_expr"/><a name="238"/>  238:     ok.
<a name="239"/>  239: 
<a name="meta_trace-1"/><a name="240"/>  240: <b>meta_trace</b>(Config) when is_list(Config) -&gt;
<a name="241"/>  241:     Self = self(),
<a name="242"/>  242:     Tracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="243"/>  243: 
<a name="244"/>  244:     Local = erlang:trace_pattern({?MODULE,'_','_'}, true, [{meta,Tracer}]),
<a name="245"/>  245:     1 = erlang:trace_pattern({erlang,list_to_binary,1}, true, [{meta,Tracer}]),
<a name="246"/>  246: 
<a name="247"/>  247:     false = process_flag(sensitive, true),
<a name="248"/>  248:     {ok,blurf} = a_local_function(blurf),
<a name="249"/>  249:     100 = an_exported_function(99),
<a name="250"/>  250:     &lt;&lt;8,9,10&gt;&gt; = list_to_binary(id([8,9,10])),
<a name="251"/>  251:     true = process_flag(sensitive, false),
<a name="252"/>  252: 
<a name="253"/>  253:     {ok,{x,y}} = a_local_function({x,y}),
<a name="254"/>  254:     1 = an_exported_function(0),
<a name="255"/>  255:     &lt;&lt;10&gt;&gt; = list_to_binary(id([10])),
<a name="256"/>  256:     wait_trace(Self),
<a name="257"/>  257: 
<a name="258"/>  258:     Local = erlang:trace_pattern({?MODULE,'_','_'}, false, [meta]),
<a name="259"/>  259:     1 = erlang:trace_pattern({erlang,list_to_binary,1}, false, [meta]),
<a name="260"/>  260:     a_local_function(0),
<a name="261"/>  261: 
<a name="262"/>  262:     {messages,Messages} = process_info(Tracer, messages),    
<a name="263"/>  263:     [{trace_ts,Self,call,{?MODULE,a_local_function,[{x,y}]},{_,_,_}},
<a name="264"/>  264:      {trace_ts,Self,call,{?MODULE,an_exported_function,[0]},{_,_,_}},
<a name="265"/>  265:      {trace_ts,Self,call,{?MODULE,id,[_]},{_,_,_}},
<a name="266"/>  266:      {trace_ts,Self,call,{erlang,list_to_binary,[[10]]},{_,_,_}},
<a name="267"/>  267:      {trace_ts,Self,call,{?MODULE,wait_trace,[Self]},{_,_,_}}] = Messages,
<a name="268"/>  268: 
<a name="269"/>  269:     unlink(Tracer), exit(Tracer, kill),
<a name="meta_trace-last_expr"/><a name="270"/>  270:     ok.
<a name="271"/>  271: 
<a name="a_local_function-1"/><a name="272"/>  272: <b>a_local_function</b>(A) -&gt;
<a name="a_local_function-last_expr"/><a name="273"/>  273:     {ok,A}.
<a name="274"/>  274: 
<a name="an_exported_function-1"/><a name="275"/>  275: <b>an_exported_function</b>(X) -&gt;
<a name="an_exported_function-last_expr"/><a name="276"/>  276:     X+1.
<a name="277"/>  277: 
<a name="running_trace-1"/><a name="278"/>  278: <b>running_trace</b>(Config) when is_list(Config) -&gt;
<a name="279"/>  279:     Self = self(),
<a name="280"/>  280:     Tracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="281"/>  281: 
<a name="282"/>  282:     false = process_flag(sensitive, true),
<a name="283"/>  283:     1 = erlang:trace(Self, true, [running,{tracer,Tracer}]),
<a name="284"/>  284:     erlang:yield(), erlang:yield(), erlang:yield(), erlang:yield(),
<a name="285"/>  285:     erlang:yield(), erlang:yield(), erlang:yield(), erlang:yield(),
<a name="286"/>  286:     true = process_flag(sensitive, false),
<a name="287"/>  287:     erlang:yield(),
<a name="288"/>  288:     1 = erlang:trace(Self, false, [running,{tracer,Tracer}]),
<a name="289"/>  289: 
<a name="290"/>  290:     wait_trace(Self),
<a name="291"/>  291:     {messages,Messages} = process_info(Tracer, messages),    
<a name="292"/>  292:     [{trace,Self,out,{sensitive_SUITE,running_trace,1}},
<a name="293"/>  293:      {trace,Self,in,{sensitive_SUITE,running_trace,1}} | Extra] = Messages,
<a name="294"/>  294:     case erlang:system_info(emu_type) of
<a name="295"/>  295: 	ET when ET =:= debug; ET =:= asan -&gt;
<a name="296"/>  296: 	    %% F_DBG_FORCED_TRAP in erts_try_seize_code_mod_permission
<a name="297"/>  297: 	    [{trace,Self,out,{erts_internal,trace,3}},
<a name="298"/>  298: 	     {trace,Self,in,{erts_internal,trace,3}}] = Extra;
<a name="299"/>  299: 	_ -&gt;
<a name="300"/>  300: 	    [] = Extra
<a name="301"/>  301:     end,
<a name="302"/>  302: 
<a name="303"/>  303:     unlink(Tracer), exit(Tracer, kill),
<a name="running_trace-last_expr"/><a name="304"/>  304:     ok.
<a name="305"/>  305: 
<a name="gc_trace-1"/><a name="306"/>  306: <b>gc_trace</b>(Config) when is_list(Config) -&gt;
<a name="307"/>  307:     Self = self(),
<a name="308"/>  308:     Tracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="309"/>  309: 
<a name="310"/>  310:     false = process_flag(sensitive, true),
<a name="311"/>  311:     1 = erlang:trace(Self, true, [garbage_collection,{tracer,Tracer}]),
<a name="312"/>  312:     erlang:garbage_collect(), erlang:garbage_collect(),
<a name="313"/>  313:     erlang:garbage_collect(), erlang:garbage_collect(),
<a name="314"/>  314:     erlang:garbage_collect(), erlang:garbage_collect(),
<a name="315"/>  315:     erlang:garbage_collect(), erlang:garbage_collect(),
<a name="316"/>  316:     true = process_flag(sensitive, false),
<a name="317"/>  317:     erlang:garbage_collect(),
<a name="318"/>  318:     1 = erlang:trace(Self, false, [garbage_collection,{tracer,Tracer}]),
<a name="319"/>  319: 
<a name="320"/>  320:     wait_trace(Self),
<a name="321"/>  321:     {messages,Messages} = process_info(Tracer, messages),    
<a name="322"/>  322:     [{trace,Self,gc_major_start,_},{trace,Self,gc_major_end,_}] = Messages,
<a name="323"/>  323: 
<a name="324"/>  324:     unlink(Tracer), exit(Tracer, kill),
<a name="gc_trace-last_expr"/><a name="325"/>  325:     ok.
<a name="326"/>  326: 
<a name="seq_trace-1"/><a name="327"/>  327: <b>seq_trace</b>(Config) when is_list(Config) -&gt;
<a name="328"/>  328:     Self = self(),
<a name="329"/>  329:     Tracer = spawn_link(fun() -&gt; receive after infinity -&gt; ok end end),
<a name="330"/>  330:     seq_trace:set_system_tracer(Tracer),
<a name="331"/>  331: 
<a name="332"/>  332:     false = process_flag(sensitive, true),
<a name="333"/>  333: 
<a name="334"/>  334:     Echo = spawn_link(fun() -&gt;
<a name="335"/>  335:                               receive
<a name="336"/>  336:                                   {Pid,Message} -&gt;
<a name="337"/>  337:                                       Pid ! {reply,Message}
<a name="338"/>  338:                               end
<a name="339"/>  339:                       end),
<a name="340"/>  340:     Sender = spawn_link(fun() -&gt;
<a name="341"/>  341:                                 seq_trace:set_token(label, 42),
<a name="342"/>  342:                                 seq_trace:set_token('receive', true),
<a name="343"/>  343:                                 seq_trace:set_token(send, true),
<a name="344"/>  344:                                 seq_trace:set_token(print, true),
<a name="345"/>  345:                                 seq_trace:print(42, &quot;trace started&quot;),
<a name="346"/>  346:                                 Self ! blurf
<a name="347"/>  347:                         end),
<a name="348"/>  348:     seq_trace:set_token(label, 17),
<a name="349"/>  349:     seq_trace:set_token('receive', true),
<a name="350"/>  350:     seq_trace:set_token(send, true),
<a name="351"/>  351:     seq_trace:set_token(print, true),
<a name="352"/>  352:     seq_trace:print(17, &quot;trace started&quot;),
<a name="353"/>  353:     Echo ! {Self,hello},
<a name="354"/>  354:     receive {reply,hello} -&gt; ok end,
<a name="355"/>  355:     receive blurf -&gt; ok end,
<a name="356"/>  356: 
<a name="357"/>  357:     wait_trace(all),
<a name="358"/>  358: 
<a name="359"/>  359:     {messages,Messages} = process_info(Tracer, messages),
<a name="360"/>  360:     [{seq_trace,17,{'receive',{0,2},Self,Echo,{Self,hello}}},
<a name="361"/>  361:      {seq_trace,17,{send,{2,3},Echo,Self,{reply,hello}}}] =
<a name="362"/>  362:     [M || {seq_trace,17,_}=M &lt;- Messages],
<a name="363"/>  363: 
<a name="364"/>  364:     [{seq_trace,42,{print,{0,1},Sender,[],&quot;trace started&quot;}},
<a name="365"/>  365:      {seq_trace,42,{send,{0,2},Sender,Self,blurf}}] =
<a name="366"/>  366:     [M || {seq_trace,42,_}=M &lt;- Messages],
<a name="367"/>  367: 
<a name="368"/>  368:     unlink(Tracer), exit(Tracer, kill),
<a name="369"/>  369:     unlink(Echo), exit(Echo, kill),
<a name="370"/>  370:     unlink(Sender), exit(Sender, kill),
<a name="seq_trace-last_expr"/><a name="371"/>  371:     ok.
<a name="372"/>  372: 
<a name="t_process_info-1"/><a name="373"/>  373: <b>t_process_info</b>(Config) when is_list(Config) -&gt;
<a name="374"/>  374:     Parent = self(),
<a name="375"/>  375:     Pid = spawn_link(fun() -&gt;
<a name="376"/>  376:                              put(foo, bar),
<a name="377"/>  377:                              false = process_flag(sensitive, true),
<a name="378"/>  378:                              Parent ! go,
<a name="379"/>  379:                              receive
<a name="380"/>  380:                                  revert -&gt;
<a name="381"/>  381:                                      true = process_flag(sensitive, false),
<a name="382"/>  382:                                      Parent ! go_again,
<a name="383"/>  383:                                      receive never -&gt; ok end
<a name="384"/>  384:                              end end),
<a name="385"/>  385:     receive go -&gt; ok end,
<a name="386"/>  386: 
<a name="387"/>  387:     put(foo, bar),
<a name="388"/>  388:     self() ! Pid ! {i,am,a,message},
<a name="389"/>  389: 
<a name="390"/>  390:     false = process_flag(sensitive, true),
<a name="391"/>  391:     t_process_info_suppressed(self()),
<a name="392"/>  392:     t_process_info_suppressed(Pid),
<a name="393"/>  393: 
<a name="394"/>  394:     true = process_flag(sensitive, false),
<a name="395"/>  395:     Pid ! revert,
<a name="396"/>  396:     receive go_again -&gt; ok end,
<a name="397"/>  397: 
<a name="398"/>  398:     t_process_info_normal(self()),
<a name="399"/>  399:     t_process_info_normal(Pid),
<a name="t_process_info-last_expr"/><a name="400"/>  400:     ok.
<a name="401"/>  401: 
<a name="t_process_info_suppressed-1"/><a name="402"/>  402: <b>t_process_info_suppressed</b>(Pid) -&gt;
<a name="403"/>  403:     [] = my_process_info(Pid, dictionary),
<a name="404"/>  404:     &lt;&lt;&gt;&gt; = my_process_info(Pid, backtrace),
<a name="t_process_info_suppressed-last_expr"/><a name="405"/>  405: <b>    [] = my_process_info</b>(Pid, messages).
<a name="406"/>  406: 
<a name="t_process_info_normal-1"/><a name="407"/>  407: <b>t_process_info_normal</b>(Pid) -&gt;
<a name="408"/>  408:     {value,{foo,bar}} = keysearch(foo, 1, my_process_info(Pid, dictionary)),
<a name="409"/>  409:     case process_info(Pid, backtrace) of
<a name="410"/>  410:         {backtrace,Bin} when size(Bin) &gt; 20 -&gt; ok
<a name="411"/>  411:     end,
<a name="t_process_info_normal-last_expr"/><a name="412"/>  412: <b>    [{i,am,a,message}] = my_process_info</b>(Pid, messages).
<a name="413"/>  413: 
<a name="my_process_info-2"/><a name="414"/>  414: <b>my_process_info</b>(Pid, Tag) -&gt;
<a name="415"/>  415:     {Tag,Value} = process_info(Pid, Tag),
<a name="416"/>  416:     All = process_info(Pid),
<a name="my_process_info-last_expr"/><a name="417"/>  417: <b>    case keysearch</b>(Tag, 1, All) of
<a name="418"/>  418:         false -&gt; Value;
<a name="419"/>  419:         {value,{Tag,Value}} -&gt; Value
<a name="420"/>  420:     end.
<a name="421"/>  421: 
<a name="t_process_display-1"/><a name="422"/>  422: <b>t_process_display</b>(Config) when is_list(Config) -&gt;
<a name="423"/>  423:     Dir = filename:dirname(code:which(?MODULE)),
<a name="424"/>  424:     Cmd = ct:get_progname() ++ &quot; -noinput -pa &quot; ++ Dir ++
<a name="425"/>  425:     &quot; -run &quot; ++ ?MODULE_STRING ++ &quot; remote_process_display&quot;,
<a name="426"/>  426:     io:put_chars(Cmd),
<a name="427"/>  427:     P = open_port({spawn,Cmd}, [in,stderr_to_stdout,eof]),
<a name="428"/>  428:     &lt;&lt;&quot;done&quot;,_/binary&gt;&gt; = get_all(P),
<a name="t_process_display-last_expr"/><a name="429"/>  429:     ok.
<a name="430"/>  430: 
<a name="remote_process_display-0"/><a name="431"/>  431: <b>remote_process_display</b>() -&gt;
<a name="432"/>  432:     false = process_flag(sensitive, true),
<a name="433"/>  433:     erlang:process_display(self(), backtrace),
<a name="434"/>  434:     erlang:display(done),
<a name="435"/>  435:     receive after 10 -&gt; ok end,
<a name="remote_process_display-last_expr"/><a name="436"/>  436: <b>    init:stop</b>().
<a name="437"/>  437: 
<a name="get_all-1"/><a name="438"/>  438: <b>get_all</b>(P) -&gt;
<a name="get_all-last_expr"/><a name="439"/>  439: <b>    get_all</b>(P, []).
<a name="440"/>  440: 
<a name="get_all-2"/><a name="441"/>  441: <b>get_all</b>(P, Acc) -&gt;
<a name="get_all-last_expr"/><a name="442"/>  442:     receive
<a name="443"/>  443:         {P,{data,S}} -&gt;
<a name="444"/>  444:             get_all(P, [Acc|S]);
<a name="445"/>  445:         {P,eof} -&gt;
<a name="446"/>  446:             iolist_to_binary(Acc)
<a name="447"/>  447:     end.
<a name="448"/>  448: 
<a name="save_calls-1"/><a name="449"/>  449: <b>save_calls</b>(Config) when is_list(Config) -&gt;
<a name="450"/>  450:     process_flag(save_calls, 10),
<a name="451"/>  451: 
<a name="452"/>  452:     false = process_flag(sensitive, true),
<a name="453"/>  453:     {last_calls,LastCalls} = process_info(self(), last_calls),
<a name="454"/>  454:     [{erlang,process_flag,2}] = LastCalls,
<a name="455"/>  455:     [2,4,6] = lists:map(fun(E) -&gt; 2*E end, [1,2,3]),
<a name="456"/>  456:     {last_calls,LastCalls} = process_info(self(), last_calls),
<a name="save_calls-last_expr"/><a name="457"/>  457:     ok.
<a name="458"/>  458: 
<a name="wait_trace-1"/><a name="459"/>  459: <b>wait_trace</b>(Pid) -&gt;
<a name="460"/>  460:     Ref = erlang:trace_delivered(Pid),
<a name="wait_trace-last_expr"/><a name="461"/>  461:     receive
<a name="462"/>  462:         {trace_delivered,Pid,Ref} -&gt; ok
<a name="463"/>  463:     end.
<a name="464"/>  464: 
<a name="id-1"/><a name="id-last_expr"/><a name="465"/>  465: <b>id</b>(I) -&gt; I.
</pre>
</body>
</html>
