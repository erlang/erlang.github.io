<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/kernel/make_test_dir/kernel_test/zlib_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2005-2024. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(zlib_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct_event.hrl&quot;).
<a name="25"/>   25: 
<a name="26"/>   26: <b>-export</b>([suite/0, all/0, groups/0]).
<a name="27"/>   27: 
<a name="28"/>   28: <i>%% API group</i>
<a name="29"/>   29: <b>-export</b>([api_open_close/1]).
<a name="30"/>   30: <b>-export</b>([api_deflateInit/1, api_deflateSetDictionary/1, api_deflateReset/1,
<a name="31"/>   31:          api_deflateParams/1, api_deflate/1, api_deflateEnd/1]).
<a name="32"/>   32: <b>-export</b>([api_inflateInit/1, api_inflateReset/1, api_inflate2/1, api_inflate3/1,
<a name="33"/>   33:          api_safeInflate/1, api_inflateEnd/1]).
<a name="34"/>   34: <b>-export</b>([api_inflateSetDictionary/1, api_inflateGetDictionary/1]).
<a name="35"/>   35: <b>-export</b>([api_un_compress/1, api_un_zip/1, api_g_un_zip/1]).
<a name="36"/>   36: 
<a name="37"/>   37: <i>%% Examples group</i>
<a name="38"/>   38: <b>-export</b>([intro/1]).
<a name="39"/>   39: 
<a name="40"/>   40: <i>%% Usage group</i>
<a name="41"/>   41: <b>-export</b>([zip_usage/1, gz_usage/1, gz_usage2/1, compress_usage/1,
<a name="42"/>   42:          dictionary_usage/1, large_deflate/1,
<a name="43"/>   43:          only_allow_owner/1, sub_heap_binaries/1]).
<a name="44"/>   44: 
<a name="45"/>   45: <i>%% Bench group</i>
<a name="46"/>   46: <b>-export</b>([inflate_bench_zeroed/1, inflate_bench_rand/1,
<a name="47"/>   47:        deflate_bench_zeroed/1, deflate_bench_rand/1,
<a name="48"/>   48:        chunk_bench_zeroed/1, chunk_bench_rand/1]).
<a name="49"/>   49: 
<a name="50"/>   50: <i>%% Others</i>
<a name="51"/>   51: <b>-export</b>([smp/1, otp_9981/1, checksum/1]).
<a name="52"/>   52: 
<a name="53"/>   53: <b>-define</b>(m(Guard, Expression),
<a name="54"/>   54:     fun() -&gt;
<a name="55"/>   55:         Actual = (catch (Expression)),
<a name="56"/>   56:         case Actual of
<a name="57"/>   57:             Guard -&gt; Actual;
<a name="58"/>   58:             _Other -&gt;
<a name="59"/>   59:                 ct:fail(&quot;Failed to match ~p, actual result was ~p&quot;,
<a name="60"/>   60:                     [??Guard, Actual])
<a name="61"/>   61:         end
<a name="62"/>   62:     end()).
<a name="63"/>   63: 
<a name="64"/>   64: <b>-define</b>(EXIT(Reason), {'EXIT',{Reason,[{_,_,_,_}|_]}}).
<a name="65"/>   65: 
<a name="suite-0"/><a name="66"/>   66: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="67"/>   67:     [{ct_hooks,[ts_install_cth]},
<a name="68"/>   68:      {timetrap,{minutes,1}}].
<a name="69"/>   69: 
<a name="all-0"/><a name="70"/>   70: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="71"/>   71:     [{group, api}, {group, examples}, {group, func},
<a name="72"/>   72:      {group, bench}, smp,
<a name="73"/>   73:      otp_9981,
<a name="74"/>   74:      checksum].
<a name="75"/>   75: 
<a name="groups-0"/><a name="76"/>   76: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="77"/>   77:     [{api, [],
<a name="78"/>   78:       [api_open_close, api_deflateInit,
<a name="79"/>   79:        api_deflateSetDictionary, api_deflateReset,
<a name="80"/>   80:        api_deflateParams, api_deflate, api_deflateEnd,
<a name="81"/>   81:        api_inflateInit, api_inflateSetDictionary, api_inflateGetDictionary,
<a name="82"/>   82:        api_inflateReset, api_inflate2, api_inflate3,
<a name="83"/>   83:        api_safeInflate, api_inflateEnd,
<a name="84"/>   84:        api_un_compress, api_un_zip,
<a name="85"/>   85:        api_g_un_zip]},
<a name="86"/>   86:      {examples, [], [intro]},
<a name="87"/>   87:      {func, [],
<a name="88"/>   88:       [zip_usage, gz_usage, gz_usage2, compress_usage,
<a name="89"/>   89:        dictionary_usage, large_deflate,
<a name="90"/>   90:        only_allow_owner, sub_heap_binaries]},
<a name="91"/>   91:      {bench,
<a name="92"/>   92:       [inflate_bench_zeroed, inflate_bench_rand,
<a name="93"/>   93:        deflate_bench_zeroed, deflate_bench_rand,
<a name="94"/>   94:        chunk_bench_zeroed, chunk_bench_rand]}].
<a name="95"/>   95: 
<a name="96"/>   96: <i>%% Test open/0 and close/1.</i>
<a name="api_open_close-1"/><a name="97"/>   97: <b>api_open_close</b>(Config) when is_list(Config) -&gt;
<a name="98"/>   98:     Fd1 = zlib:open(),
<a name="99"/>   99:     Fd2 = zlib:open(),
<a name="100"/>  100:     ?m(false,Fd1 == Fd2),
<a name="101"/>  101:     ?m(ok,zlib:close(Fd1)),
<a name="102"/>  102:     ?m(?EXIT(not_initialized), zlib:close(Fd1)),
<a name="103"/>  103:     ?m(ok,zlib:close(Fd2)),
<a name="104"/>  104: 
<a name="105"/>  105:     %% Make sure that we don't get any EXIT messages if trap_exit is enabled.
<a name="106"/>  106:     process_flag(trap_exit, true),
<a name="107"/>  107:     Fd3 = zlib:open(),
<a name="108"/>  108:     ?m(ok,zlib:close(Fd3)),
<a name="api_open_close-last_expr"/><a name="109"/>  109:     receive
<a name="110"/>  110: 	Any -&gt; ct:fail({unexpected_message,Any})
<a name="111"/>  111:     after 10 -&gt; ok
<a name="112"/>  112:     end.
<a name="113"/>  113: 
<a name="114"/>  114: <i>%% Test deflateInit/2 and /6.</i>
<a name="api_deflateInit-1"/><a name="115"/>  115: <b>api_deflateInit</b>(Config) when is_list(Config) -&gt;
<a name="116"/>  116:     Z1 = zlib:open(),
<a name="117"/>  117: 
<a name="118"/>  118:     ?m(?EXIT(badarg), zlib:deflateInit(gurka, none)),
<a name="119"/>  119: 
<a name="120"/>  120:     ?m(?EXIT(bad_compression_level), zlib:deflateInit(gurka, gurka)),
<a name="121"/>  121:     ?m(?EXIT(bad_compression_level), zlib:deflateInit(Z1, gurka)),
<a name="122"/>  122:     Levels = [none, default, best_speed, best_compression] ++ lists:seq(0,9),
<a name="123"/>  123:     lists:foreach(fun(Level) -&gt;
<a name="124"/>  124: 			  Z = zlib:open(),
<a name="125"/>  125: 			  ?m(ok, zlib:deflateInit(Z, Level)),
<a name="126"/>  126: 			  ?m(ok,zlib:close(Z))
<a name="127"/>  127: 		  end, Levels),
<a name="128"/>  128:     %% /6
<a name="129"/>  129:     ?m(?EXIT(bad_compression_level),
<a name="130"/>  130:         zlib:deflateInit(Z1,gurka,deflated,-15,8,default)),
<a name="131"/>  131: 
<a name="132"/>  132:     ?m(?EXIT(bad_compression_method),
<a name="133"/>  133:         zlib:deflateInit(Z1,default,undefined,-15,8,default)),
<a name="134"/>  134: 
<a name="135"/>  135:     ?m(?EXIT(bad_compression_strategy),
<a name="136"/>  136:         zlib:deflateInit(Z1,default,deflated,-15,8,0)),
<a name="137"/>  137:     ?m(?EXIT(bad_compression_strategy),
<a name="138"/>  138:         zlib:deflateInit(Z1,default,deflated,-15,8,undefined)),
<a name="139"/>  139: 
<a name="140"/>  140:     ?m(?EXIT(bad_windowbits),
<a name="141"/>  141:         zlib:deflateInit(Z1,default,deflated,48,8,default)),
<a name="142"/>  142:     ?m(?EXIT(bad_windowbits),
<a name="143"/>  143:         zlib:deflateInit(Z1,default,deflated,-20,8,default)),
<a name="144"/>  144:     ?m(?EXIT(bad_windowbits),
<a name="145"/>  145:         zlib:deflateInit(Z1,default,deflated,-7,8,default)),
<a name="146"/>  146:     ?m(?EXIT(bad_windowbits),
<a name="147"/>  147:         zlib:deflateInit(Z1,default,deflated,7,8,default)),
<a name="148"/>  148: 
<a name="149"/>  149:     ?m(?EXIT(bad_memlevel),
<a name="150"/>  150:         zlib:deflateInit(Z1,default,deflated,-15,0,default)),
<a name="151"/>  151:     ?m(?EXIT(bad_memlevel),
<a name="152"/>  152:         zlib:deflateInit(Z1,default,deflated,-15,10,default)),
<a name="153"/>  153: 
<a name="154"/>  154:     lists:foreach(fun(Level) -&gt;
<a name="155"/>  155: 			  Z = zlib:open(),
<a name="156"/>  156: 			  ?m(ok, zlib:deflateInit(Z, Level, deflated, -15, 8, default)),
<a name="157"/>  157: 			  ?m(ok,zlib:close(Z))
<a name="158"/>  158: 		  end, Levels),
<a name="159"/>  159: 
<a name="160"/>  160:     lists:foreach(fun(Wbits) -&gt;
<a name="161"/>  161: 			  Z11 = zlib:open(),
<a name="162"/>  162: 			  ?m(ok, zlib:deflateInit(Z11,best_compression,deflated,
<a name="163"/>  163: 						  Wbits,8,default)),
<a name="164"/>  164: 			  Z12 = zlib:open(),
<a name="165"/>  165: 			  ?m(ok, zlib:deflateInit(Z12,default,deflated,-Wbits,8,default)),
<a name="166"/>  166: 			  ?m(ok,zlib:close(Z11)),
<a name="167"/>  167: 			  ?m(ok,zlib:close(Z12))
<a name="168"/>  168: 		  end, lists:seq(9, 15)),
<a name="169"/>  169: 
<a name="170"/>  170:     lists:foreach(fun(MemLevel) -&gt;
<a name="171"/>  171: 			  Z = zlib:open(),
<a name="172"/>  172: 			  ?m(ok, zlib:deflateInit(Z,default,deflated,-15, 
<a name="173"/>  173: 						  MemLevel,default)),
<a name="174"/>  174: 			  ?m(ok,zlib:close(Z))
<a name="175"/>  175: 		  end, lists:seq(1,8)),
<a name="176"/>  176: 
<a name="177"/>  177:     Strategies = [filtered,huffman_only,rle,default],
<a name="178"/>  178:     lists:foreach(fun(Strategy) -&gt;
<a name="179"/>  179: 			  Z = zlib:open(),
<a name="180"/>  180: 			  ?m(ok, zlib:deflateInit(Z,best_speed,deflated,-15,8,Strategy)),
<a name="181"/>  181: 			  ?m(ok,zlib:close(Z))
<a name="182"/>  182: 		  end, Strategies),
<a name="183"/>  183:     ?m(ok, zlib:deflateInit(Z1,default,deflated,-15,8,default)),
<a name="184"/>  184: 
<a name="185"/>  185:     %% Let it crash for any reason; we don't care about the order in which the
<a name="186"/>  186:     %% parameters are checked.
<a name="187"/>  187:     ?m(?EXIT(_), zlib:deflateInit(Z1,none,deflated,-15,8,default)),
<a name="188"/>  188: 
<a name="api_deflateInit-last_expr"/><a name="189"/>  189: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="190"/>  190: 
<a name="191"/>  191: <i>%% Test deflateSetDictionary.</i>
<a name="api_deflateSetDictionary-1"/><a name="192"/>  192: <b>api_deflateSetDictionary</b>(Config) when is_list(Config) -&gt;
<a name="193"/>  193:     Z1 = zlib:open(),
<a name="194"/>  194:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="195"/>  195:     ?m(Id when is_integer(Id), zlib:deflateSetDictionary(Z1, &lt;&lt;1,1,2,3,4,5,1&gt;&gt;)),
<a name="196"/>  196:     ?m(Id when is_integer(Id), zlib:deflateSetDictionary(Z1, [1,1,2,3,4,5,1])),
<a name="197"/>  197:     ?m(?EXIT(badarg), zlib:deflateSetDictionary(Z1, gurka)),
<a name="198"/>  198:     ?m(?EXIT(badarg), zlib:deflateSetDictionary(Z1, 128)),
<a name="199"/>  199:     ?m(L when is_list(L), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, none)),
<a name="200"/>  200:     ?m(?EXIT(stream_error), zlib:deflateSetDictionary(Z1,&lt;&lt;1,1,2,3,4,5,1&gt;&gt;)),
<a name="api_deflateSetDictionary-last_expr"/><a name="201"/>  201: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="202"/>  202: 
<a name="203"/>  203: <i>%% Test deflateReset.</i>
<a name="api_deflateReset-1"/><a name="204"/>  204: <b>api_deflateReset</b>(Config) when is_list(Config) -&gt;
<a name="205"/>  205:     Z1 = zlib:open(),
<a name="206"/>  206:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="207"/>  207:     ?m(L when is_list(L), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, none)),
<a name="208"/>  208:     ?m(ok, zlib:deflateReset(Z1)),
<a name="209"/>  209:     ?m(ok, zlib:deflateReset(Z1)),
<a name="210"/>  210:     %% FIXME how do I make this go wrong??
<a name="api_deflateReset-last_expr"/><a name="211"/>  211: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="212"/>  212: 
<a name="213"/>  213: <i>%% Test deflateParams.</i>
<a name="api_deflateParams-1"/><a name="214"/>  214: <b>api_deflateParams</b>(Config) when is_list(Config) -&gt;
<a name="215"/>  215:     Levels = [none, default, best_speed, best_compression] ++ lists:seq(0, 9),
<a name="216"/>  216:     Strategies = [filtered, huffman_only, rle, default],
<a name="217"/>  217: 
<a name="218"/>  218:     Z1 = zlib:open(),
<a name="219"/>  219:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="220"/>  220: 
<a name="221"/>  221:     ApiTest =
<a name="222"/>  222:         fun(Level, Strategy) -&gt;
<a name="223"/>  223:             ?m(ok, zlib:deflateParams(Z1, Level, Strategy)),
<a name="224"/>  224:             ?m(ok, zlib:deflateReset(Z1))
<a name="225"/>  225:         end,
<a name="226"/>  226: 
<a name="227"/>  227:     [ ApiTest(Level, Strategy) || Level &lt;- Levels, Strategy &lt;- Strategies ],
<a name="228"/>  228: 
<a name="229"/>  229:     ?m(ok, zlib:close(Z1)),
<a name="230"/>  230: 
<a name="231"/>  231:     FlushTest =
<a name="232"/>  232:         fun FlushTest(Size, Level, Strategy) -&gt;
<a name="233"/>  233:             Z = zlib:open(),
<a name="234"/>  234:             ok = zlib:deflateInit(Z, default),
<a name="235"/>  235:             Data = gen_determ_rand_bytes(Size),
<a name="236"/>  236:             case zlib:deflate(Z, Data, none) of
<a name="237"/>  237:                 [&lt;&lt;120, 156&gt;&gt;] -&gt;
<a name="238"/>  238:                     %% All data is present in the internal zlib state, and will
<a name="239"/>  239:                     %% be flushed on deflateParams.
<a name="240"/>  240: 
<a name="241"/>  241:                     ok = zlib:deflateParams(Z, Level, Strategy),
<a name="242"/>  242:                     Compressed = [&lt;&lt;120, 156&gt;&gt;, zlib:deflate(Z, &lt;&lt;&gt;&gt;, finish)],
<a name="243"/>  243:                     Data = zlib:uncompress(Compressed),
<a name="244"/>  244:                     zlib:close(Z),
<a name="245"/>  245: 
<a name="246"/>  246:                     FlushTest(Size + (1 bsl 10), Level, Strategy);
<a name="247"/>  247:                 _Other -&gt;
<a name="248"/>  248:                     ok
<a name="249"/>  249:             end
<a name="250"/>  250:         end,
<a name="251"/>  251: 
<a name="252"/>  252:     [ FlushTest(1, Level, Strategy) || Level &lt;- Levels, Strategy &lt;- Strategies ],
<a name="253"/>  253: 
<a name="api_deflateParams-last_expr"/><a name="254"/>  254:     ok.
<a name="255"/>  255: 
<a name="256"/>  256: <i>%% Test deflate.</i>
<a name="api_deflate-1"/><a name="257"/>  257: <b>api_deflate</b>(Config) when is_list(Config) -&gt;
<a name="258"/>  258:     Z1 = zlib:open(),
<a name="259"/>  259:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="260"/>  260:     ?m([B] when is_binary(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, finish)),
<a name="261"/>  261:     ?m(ok, zlib:deflateReset(Z1)),
<a name="262"/>  262:     ?m([B] when is_binary(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, finish)),
<a name="263"/>  263:     ?m(ok, zlib:deflateReset(Z1)),
<a name="264"/>  264:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;)),
<a name="265"/>  265:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, none)),
<a name="266"/>  266:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, sync)),
<a name="267"/>  267:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, full)),
<a name="268"/>  268:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;&gt;&gt;, finish)),
<a name="269"/>  269: 
<a name="270"/>  270:     ?m(?EXIT(badarg), zlib:deflate(gurka, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, full)),
<a name="271"/>  271: 
<a name="272"/>  272:     ?m(?EXIT(bad_flush_mode), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, asdj)),
<a name="273"/>  273:     ?m(?EXIT(bad_flush_mode), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, 198)),
<a name="274"/>  274: 
<a name="275"/>  275:     %% Causes problems ERROR REPORT
<a name="276"/>  276:     ?m(?EXIT(badarg), zlib:deflate(Z1, [asdj,asd], none)),
<a name="277"/>  277: 
<a name="api_deflate-last_expr"/><a name="278"/>  278: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="279"/>  279: 
<a name="280"/>  280: <i>%% Test deflateEnd.</i>
<a name="api_deflateEnd-1"/><a name="281"/>  281: <b>api_deflateEnd</b>(Config) when is_list(Config) -&gt;
<a name="282"/>  282:     Z1 = zlib:open(),
<a name="283"/>  283:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="284"/>  284:     ?m(ok, zlib:deflateEnd(Z1)),
<a name="285"/>  285:     ?m(?EXIT(not_initialized), zlib:deflateEnd(Z1)),
<a name="286"/>  286:     ?m(?EXIT(badarg), zlib:deflateEnd(gurka)),
<a name="287"/>  287:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="288"/>  288:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;&quot;Kilroy was here&quot;&gt;&gt;)),
<a name="289"/>  289:     ?m(?EXIT(data_error), zlib:deflateEnd(Z1)),
<a name="290"/>  290:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="291"/>  291:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;&quot;Kilroy was here&quot;&gt;&gt;)),
<a name="292"/>  292:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;&quot;Kilroy was here&quot;&gt;&gt;, finish)),
<a name="293"/>  293:     ?m(ok, zlib:deflateEnd(Z1)),
<a name="294"/>  294: 
<a name="api_deflateEnd-last_expr"/><a name="295"/>  295: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="296"/>  296: 
<a name="297"/>  297: <i>%% Test inflateInit /1 and /2.</i>
<a name="api_inflateInit-1"/><a name="298"/>  298: <b>api_inflateInit</b>(Config) when is_list(Config) -&gt;
<a name="299"/>  299:     Z1 = zlib:open(),
<a name="300"/>  300:     ?m(?EXIT(badarg), zlib:inflateInit(gurka)),
<a name="301"/>  301:     ?m(ok, zlib:inflateInit(Z1)),
<a name="302"/>  302:     ?m(?EXIT(already_initialized), zlib:inflateInit(Z1, 15)),
<a name="303"/>  303:     lists:foreach(fun(Wbits) -&gt;
<a name="304"/>  304: 			  Z11 = zlib:open(),
<a name="305"/>  305: 			  ?m(ok, zlib:inflateInit(Z11,Wbits)),
<a name="306"/>  306: 			  Z12 = zlib:open(),
<a name="307"/>  307: 			  ?m(ok, zlib:inflateInit(Z12,-Wbits)),
<a name="308"/>  308: 			  ?m(ok,zlib:close(Z11)),
<a name="309"/>  309: 			  ?m(ok,zlib:close(Z12))
<a name="310"/>  310: 		  end, lists:seq(8,15)),
<a name="311"/>  311:     ?m(?EXIT(badarg), zlib:inflateInit(gurka, -15)),
<a name="312"/>  312:     ?m(?EXIT(bad_windowbits), zlib:inflateInit(Z1, 7)),
<a name="313"/>  313:     ?m(?EXIT(bad_windowbits), zlib:inflateInit(Z1, -7)),
<a name="314"/>  314:     ?m(?EXIT(bad_windowbits), zlib:inflateInit(Z1, 48)),
<a name="315"/>  315:     ?m(?EXIT(bad_windowbits), zlib:inflateInit(Z1, -16)),
<a name="api_inflateInit-last_expr"/><a name="316"/>  316: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="317"/>  317: 
<a name="318"/>  318: <i>%% Test inflateSetDictionary.</i>
<a name="api_inflateSetDictionary-1"/><a name="319"/>  319: <b>api_inflateSetDictionary</b>(Config) when is_list(Config) -&gt;
<a name="320"/>  320:     Z1 = zlib:open(),
<a name="321"/>  321:     ?m(ok, zlib:inflateInit(Z1)),
<a name="322"/>  322:     ?m(?EXIT(badarg), zlib:inflateSetDictionary(gurka,&lt;&lt;1,1,1,1,1&gt;&gt;)),
<a name="323"/>  323:     ?m(?EXIT(badarg), zlib:inflateSetDictionary(Z1,102)),
<a name="324"/>  324:     ?m(?EXIT(badarg), zlib:inflateSetDictionary(Z1,gurka)),
<a name="325"/>  325:     Dict = &lt;&lt;1,1,1,1,1&gt;&gt;,
<a name="326"/>  326:     ?m(?EXIT(stream_error), zlib:inflateSetDictionary(Z1,Dict)),
<a name="api_inflateSetDictionary-last_expr"/><a name="327"/>  327: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="328"/>  328: 
<a name="329"/>  329: <i>%% Test inflateGetDictionary.</i>
<a name="api_inflateGetDictionary-1"/><a name="330"/>  330: <b>api_inflateGetDictionary</b>(Config) when is_list(Config) -&gt;
<a name="331"/>  331:     Z1 = zlib:open(),
<a name="332"/>  332:     zlib:inflateInit(Z1),
<a name="333"/>  333:     IsOperationSupported =
<a name="334"/>  334:         case catch zlib:inflateGetDictionary(Z1) of
<a name="335"/>  335:             ?EXIT(not_supported) -&gt; false;
<a name="336"/>  336:             _ -&gt; true
<a name="337"/>  337:         end,
<a name="338"/>  338:     zlib:close(Z1),
<a name="api_inflateGetDictionary-last_expr"/><a name="339"/>  339: <b>    api_inflateGetDictionary_if_supported</b>(IsOperationSupported).
<a name="340"/>  340: 
<a name="api_inflateGetDictionary_if_supported-1"/><a name="341"/>  341: <b>api_inflateGetDictionary_if_supported</b>(false) -&gt;
<a name="342"/>  342:     {skip, &quot;inflateGetDictionary/1 unsupported in current setup&quot;};
<a name="343"/>  343: <b>api_inflateGetDictionary_if_supported</b>(true) -&gt;
<a name="344"/>  344:     % Compress payload using custom dictionary
<a name="345"/>  345:     Z1 = zlib:open(),
<a name="346"/>  346:     ?m(ok, zlib:deflateInit(Z1)),
<a name="347"/>  347:     Dict = &lt;&lt;&quot;foobar barfoo foo bar far boo&quot;&gt;&gt;,
<a name="348"/>  348:     Checksum = zlib:deflateSetDictionary(Z1, Dict),
<a name="349"/>  349:     Payload = &lt;&lt;&quot;foobarbarbar&quot;&gt;&gt;,
<a name="350"/>  350:     Compressed = zlib:deflate(Z1, Payload, finish),
<a name="351"/>  351:     ?m(ok, zlib:close(Z1)),
<a name="352"/>  352: 
<a name="353"/>  353:     % Decompress and test dictionary extraction with inflate/2
<a name="354"/>  354:     Z2 = zlib:open(),
<a name="355"/>  355:     ?m(ok, zlib:inflateInit(Z2)),
<a name="356"/>  356:     ?m(&lt;&lt;&gt;&gt;, iolist_to_binary(zlib:inflateGetDictionary(Z2))),
<a name="357"/>  357:     ?m(?EXIT(stream_error), zlib:inflateSetDictionary(Z2, Dict)),
<a name="358"/>  358:     ?m(?EXIT({need_dictionary,Checksum}), zlib:inflate(Z2, Compressed)),
<a name="359"/>  359:     ?m(ok, zlib:inflateSetDictionary(Z2, Dict)),
<a name="360"/>  360:     ?m(Dict, iolist_to_binary(zlib:inflateGetDictionary(Z2))),
<a name="361"/>  361:     Payload = iolist_to_binary(zlib:inflate(Z2, [])),
<a name="362"/>  362:     ?m(ok, zlib:close(Z2)),
<a name="363"/>  363:     ?m(?EXIT(not_initialized), zlib:inflateSetDictionary(Z2, Dict)),
<a name="364"/>  364: 
<a name="365"/>  365:     %% ... And do the same for inflate/3
<a name="366"/>  366:     Z3 = zlib:open(),
<a name="367"/>  367:     ?m(ok, zlib:inflateInit(Z3)),
<a name="368"/>  368:     ?m(&lt;&lt;&gt;&gt;, iolist_to_binary(zlib:inflateGetDictionary(Z3))),
<a name="369"/>  369:     ?m(?EXIT(stream_error), zlib:inflateSetDictionary(Z3, Dict)),
<a name="370"/>  370: 
<a name="371"/>  371:     {need_dictionary, Checksum, _Output = []} =
<a name="372"/>  372:         zlib:inflate(Z3, Compressed, [{exception_on_need_dict, false}]),
<a name="373"/>  373: 
<a name="374"/>  374:     ?m(ok, zlib:inflateSetDictionary(Z3, Dict)),
<a name="375"/>  375:     ?m(Dict, iolist_to_binary(zlib:inflateGetDictionary(Z3))),
<a name="376"/>  376: 
<a name="377"/>  377:     Payload = iolist_to_binary(
<a name="378"/>  378:         zlib:inflate(Z3, [], [{exception_on_need_dict, false}])),
<a name="379"/>  379: 
<a name="380"/>  380:     ?m(ok, zlib:close(Z3)),
<a name="381"/>  381:     ?m(?EXIT(not_initialized), zlib:inflateSetDictionary(Z3, Dict)),
<a name="382"/>  382: 
<a name="api_inflateGetDictionary_if_supported-last_expr"/><a name="383"/>  383:     ok.
<a name="384"/>  384: 
<a name="385"/>  385: <i>%% Test inflateReset.</i>
<a name="api_inflateReset-1"/><a name="386"/>  386: <b>api_inflateReset</b>(Config) when is_list(Config) -&gt;
<a name="387"/>  387:     Z1 = zlib:open(),
<a name="388"/>  388:     ?m(ok, zlib:inflateInit(Z1)),
<a name="389"/>  389:     ?m(?EXIT(badarg), zlib:inflateReset(gurka)),
<a name="390"/>  390:     ?m(ok, zlib:inflateReset(Z1)),
<a name="api_inflateReset-last_expr"/><a name="391"/>  391: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="392"/>  392: 
<a name="393"/>  393: <i>%% Test inflate/2</i>
<a name="api_inflate2-1"/><a name="394"/>  394: <b>api_inflate2</b>(Config) when is_list(Config) -&gt;
<a name="395"/>  395:     Data = [&lt;&lt;1,2,2,3,3,3,4,4,4,4&gt;&gt;],
<a name="396"/>  396:     Compressed = zlib:compress(Data),
<a name="397"/>  397: 
<a name="398"/>  398:     Z1 = zlib:open(),
<a name="399"/>  399:     ?m(ok, zlib:inflateInit(Z1)),
<a name="400"/>  400:     ?m([], zlib:inflate(Z1, &lt;&lt;&gt;&gt;)),
<a name="401"/>  401:     ?m(Data, zlib:inflate(Z1, Compressed)),
<a name="402"/>  402:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="403"/>  403:     ?m(ok, zlib:inflateInit(Z1)),
<a name="404"/>  404:     ?m(Data, zlib:inflate(Z1, Compressed)),
<a name="405"/>  405:     ?m(?EXIT(badarg), zlib:inflate(gurka, Compressed)),
<a name="406"/>  406:     ?m(?EXIT(badarg), zlib:inflate(Z1, 4384)),
<a name="407"/>  407:     ?m(?EXIT(badarg), zlib:inflate(Z1, [atom_list])),
<a name="408"/>  408:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="409"/>  409:     ?m(ok, zlib:inflateInit(Z1)),
<a name="410"/>  410:     ?m(?EXIT(data_error), zlib:inflate(Z1, &lt;&lt;2,1,2,1,2&gt;&gt;)),
<a name="411"/>  411:     ?m(ok, zlib:close(Z1)),
<a name="412"/>  412: 
<a name="413"/>  413:     %% OTP-17299: we failed to fully flush the zlib state if we ran out of
<a name="414"/>  414:     %% input and filled the internal output buffer at the same time.
<a name="415"/>  415:     EdgeCaseData = &lt;&lt;&quot;gurka&quot;, 0:16384/integer-unit:8&gt;&gt;,
<a name="416"/>  416:     EdgeCaseZipped = zlib:zip(EdgeCaseData),
<a name="417"/>  417:     Z2 = zlib:open(),
<a name="418"/>  418:     ?m(ok, zlib:inflateInit(Z2, -15)),
<a name="419"/>  419:     Unzipped = iolist_to_binary(zlib:inflate(Z2, EdgeCaseZipped)),
<a name="420"/>  420:     ?m(EdgeCaseData, Unzipped),
<a name="421"/>  421:     ?m(ok, zlib:inflateEnd(Z2)),
<a name="422"/>  422:     ?m(ok, zlib:close(Z2)),
<a name="423"/>  423: 
<a name="api_inflate2-last_expr"/><a name="424"/>  424:     ok.
<a name="425"/>  425: 
<a name="426"/>  426: <i>%% Test inflate/3; same as inflate/2 but with the default options inverted.</i>
<a name="api_inflate3-1"/><a name="427"/>  427: <b>api_inflate3</b>(Config) when is_list(Config) -&gt;
<a name="428"/>  428:     Data = [&lt;&lt;1,2,2,3,3,3,4,4,4,4&gt;&gt;],
<a name="429"/>  429:     Options = [{exception_on_need_dict, false}],
<a name="430"/>  430:     Compressed = zlib:compress(Data),
<a name="431"/>  431:     Z1 = zlib:open(),
<a name="432"/>  432:     ?m(ok, zlib:inflateInit(Z1)),
<a name="433"/>  433:     ?m([], zlib:inflate(Z1, &lt;&lt;&gt;&gt;, Options)),
<a name="434"/>  434:     ?m(Data, zlib:inflate(Z1, Compressed)),
<a name="435"/>  435:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="436"/>  436:     ?m(ok, zlib:inflateInit(Z1)),
<a name="437"/>  437:     ?m(Data, zlib:inflate(Z1, Compressed, Options)),
<a name="438"/>  438:     ?m(?EXIT(badarg), zlib:inflate(gurka, Compressed, Options)),
<a name="439"/>  439:     ?m(?EXIT(badarg), zlib:inflate(Z1, 4384, Options)),
<a name="440"/>  440:     ?m(?EXIT(badarg), zlib:inflate(Z1, [atom_list], Options)),
<a name="441"/>  441:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="442"/>  442:     ?m(ok, zlib:inflateInit(Z1)),
<a name="443"/>  443:     ?m(?EXIT(data_error), zlib:inflate(Z1, &lt;&lt;2,1,2,1,2&gt;&gt;, Options)),
<a name="api_inflate3-last_expr"/><a name="444"/>  444: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="445"/>  445: 
<a name="446"/>  446: <i>%% Test safeInflate as a mirror of inflateChunk, but ignore the stuff about</i>
<a name="447"/>  447: <i>%% exact chunk sizes.</i>
<a name="api_safeInflate-1"/><a name="448"/>  448: <b>api_safeInflate</b>(Config) when is_list(Config) -&gt;
<a name="449"/>  449:     Data = &lt;&lt; &lt;&lt;(I rem 150)&gt;&gt; || I &lt;- lists:seq(1, 20 bsl 10) &gt;&gt;,
<a name="450"/>  450:     Compressed = zlib:compress(Data),
<a name="451"/>  451:     Z1 = zlib:open(),
<a name="452"/>  452: 
<a name="453"/>  453:     ?m(ok, zlib:inflateInit(Z1)),
<a name="454"/>  454: 
<a name="455"/>  455:     SafeInflateLoop =
<a name="456"/>  456:         fun
<a name="457"/>  457:             Loop({continue, Chunk}, Output) -&gt;
<a name="458"/>  458:                 Loop(zlib:safeInflate(Z1, []), [Output, Chunk]);
<a name="459"/>  459:             Loop({finished, Chunk}, Output) -&gt;
<a name="460"/>  460:                 [Output, Chunk]
<a name="461"/>  461:         end,
<a name="462"/>  462: 
<a name="463"/>  463:     Decompressed = SafeInflateLoop(zlib:safeInflate(Z1, Compressed), []),
<a name="464"/>  464:     Data = iolist_to_binary(Decompressed),
<a name="465"/>  465: 
<a name="466"/>  466:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="467"/>  467:     ?m(ok, zlib:inflateInit(Z1)),
<a name="468"/>  468: 
<a name="469"/>  469:     {continue, Partial} = zlib:safeInflate(Z1, Compressed),
<a name="470"/>  470:     PBin = iolist_to_binary(Partial),
<a name="471"/>  471:     PSize = byte_size(PBin),
<a name="472"/>  472:     &lt;&lt;PBin:PSize/binary, Rest/binary&gt;&gt; = Data,
<a name="473"/>  473: 
<a name="474"/>  474:     ?m(ok, zlib:inflateReset(Z1)),
<a name="475"/>  475: 
<a name="476"/>  476:     {continue, Partial} = zlib:safeInflate(Z1, Compressed),
<a name="477"/>  477:     PBin = iolist_to_binary(Partial),
<a name="478"/>  478:     PSize = byte_size(PBin),
<a name="479"/>  479:     &lt;&lt;PBin:PSize/binary, Rest/binary&gt;&gt; = Data,
<a name="480"/>  480: 
<a name="481"/>  481:     ?m(ok, zlib:inflateReset(Z1)),
<a name="482"/>  482: 
<a name="483"/>  483:     SafeInflateLoop(zlib:safeInflate(Z1, Compressed), []),
<a name="484"/>  484: 
<a name="485"/>  485:     ?m({finished, []}, zlib:safeInflate(Z1, Compressed)),
<a name="486"/>  486:     ?m({finished, []}, zlib:safeInflate(Z1, Compressed)),
<a name="487"/>  487: 
<a name="488"/>  488:     ?m(ok, zlib:inflateReset(Z1)),
<a name="489"/>  489:     ?m(?EXIT(badarg), zlib:safeInflate(gurka, Compressed)),
<a name="490"/>  490:     ?m(?EXIT(badarg), zlib:safeInflate(Z1, 4384)),
<a name="491"/>  491:     ?m(?EXIT(data_error), zlib:inflateEnd(Z1)),
<a name="api_safeInflate-last_expr"/><a name="492"/>  492: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="493"/>  493: 
<a name="494"/>  494: <i>%% Test inflateEnd.</i>
<a name="api_inflateEnd-1"/><a name="495"/>  495: <b>api_inflateEnd</b>(Config) when is_list(Config) -&gt;
<a name="496"/>  496:     Z1 = zlib:open(),
<a name="497"/>  497:     ?m(?EXIT(not_initialized), zlib:inflateEnd(Z1)),
<a name="498"/>  498:     ?m(ok, zlib:inflateInit(Z1)),
<a name="499"/>  499:     ?m(?EXIT(badarg), zlib:inflateEnd(gurka)),
<a name="500"/>  500:     ?m(?EXIT(data_error), zlib:inflateEnd(Z1)),
<a name="501"/>  501:     ?m(?EXIT(not_initialized), zlib:inflateEnd(Z1)),
<a name="502"/>  502:     ?m(ok, zlib:inflateInit(Z1)),
<a name="503"/>  503:     ?m(B when is_list(B), zlib:inflate(Z1, zlib:compress(&quot;abc&quot;))),
<a name="504"/>  504:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="api_inflateEnd-last_expr"/><a name="505"/>  505: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="506"/>  506: 
<a name="507"/>  507: <i>%% Test compress.</i>
<a name="api_un_compress-1"/><a name="508"/>  508: <b>api_un_compress</b>(Config) when is_list(Config) -&gt;
<a name="509"/>  509:     ?m(?EXIT(badarg),zlib:compress(not_a_binary)),
<a name="510"/>  510:     Bin = &lt;&lt;1,11,1,23,45&gt;&gt;,
<a name="511"/>  511:     Comp = zlib:compress(Bin),
<a name="512"/>  512:     ?m(?EXIT(badarg),zlib:uncompress(not_a_binary)),
<a name="513"/>  513:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;171,171,171,171,171&gt;&gt;)),
<a name="514"/>  514:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;&gt;&gt;)),
<a name="515"/>  515:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;120&gt;&gt;)),
<a name="516"/>  516:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;120,156&gt;&gt;)),
<a name="517"/>  517:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;120,156,3&gt;&gt;)),
<a name="518"/>  518:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;120,156,3,0&gt;&gt;)),
<a name="519"/>  519:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;0,156,3,0,0,0,0,1&gt;&gt;)),
<a name="520"/>  520:     ?m(Bin, zlib:uncompress(binary_to_list(Comp))),
<a name="api_un_compress-last_expr"/><a name="521"/>  521: <b>    ?m</b>(Bin, zlib:uncompress(Comp)).
<a name="522"/>  522: 
<a name="523"/>  523: <i>%% Test zip.</i>
<a name="api_un_zip-1"/><a name="524"/>  524: <b>api_un_zip</b>(Config) when is_list(Config) -&gt;
<a name="525"/>  525:     ?m(?EXIT(badarg),zlib:zip(not_a_binary)),
<a name="526"/>  526:     Bin = &lt;&lt;1,11,1,23,45&gt;&gt;,
<a name="527"/>  527:     Comp = zlib:zip(Bin),
<a name="528"/>  528:     ?m(Comp, zlib:zip(binary_to_list(Bin))),
<a name="529"/>  529:     ?m(?EXIT(badarg),zlib:unzip(not_a_binary)),
<a name="530"/>  530:     ?m(?EXIT(data_error), zlib:unzip(&lt;&lt;171,171,171,171,171&gt;&gt;)),
<a name="531"/>  531:     ?m(?EXIT(data_error), zlib:unzip(&lt;&lt;&gt;&gt;)),
<a name="532"/>  532:     ?m(Bin, zlib:unzip(Comp)),
<a name="533"/>  533:     ?m(Bin, zlib:unzip(binary_to_list(Comp))),
<a name="534"/>  534: 
<a name="535"/>  535:     %% OTP-6396
<a name="536"/>  536:     B =
<a name="537"/>  537:         &lt;&lt;131,104,19,100,0,13,99,95,99,105,100,95,99,115,103,115,110,95,50,97,
<a name="538"/>  538:           1,107,0,4,208,161,246,29,107,0,3,237,166,224,107,0,6,66,240,153,0,2,
<a name="539"/>  539:           10,1,0,8,97,116,116,97,99,104,101,100,104,2,100,0,22,117,112,100,97,
<a name="540"/>  540:           116,101,95,112,100,112,95,99,111,110,116,101,120,116,95,114,101,113,
<a name="541"/>  541:           107,0,114,69,3,12,1,11,97,31,113,150,64,104,132,61,64,104,12,3,197,
<a name="542"/>  542:           31,113,150,64,104,132,61,64,104,12,1,11,97,31,115,150,64,104,116,73,
<a name="543"/>  543:           64,104,0,0,0,0,0,0,65,149,16,61,65,149,16,61,1,241,33,4,5,0,33,4,4,10
<a name="544"/>  544:           ,6,10,181,4,10,6,10,181,38,15,99,111,109,109,97,110,100,1,114,45,97,
<a name="545"/>  545:           112,110,45,49,3,99,111,109,5,109,110,99,57,57,6,109,99,99,50,52,48,4,
<a name="546"/>  546:           103,112,114,115,8,0,104,2,104,2,100,0,8,97,99,116,105,118,97,116,101,
<a name="547"/>  547:           104,23,100,0,11,112,100,112,95,99,111,110,116,1,120,116,100,0,7,112,
<a name="548"/>  548:           114,105,109,97,114,121,97,1,100,0,9,117,110,100,101,102,105,110,101,
<a name="549"/>  549:           100,97,1,97,4,97,4,97,7,100,0,9,117,110,100,101,102,105,110,101,100,
<a name="550"/>  550:           100,0,9,117,110,100,101,102,105,110,10100,100,0,9,117,110,100,101,
<a name="551"/>  551:           102,105,110,101,100,100,0,5,102,97,108,115,101,100,0,9,117,110,100,
<a name="552"/>  552:           101,102,105,110,101,100,100,0,9,117,110,100,101,102,105,110,101,100,
<a name="553"/>  553:           100,0,9,117,110,100,101,102,105,1,101,100,97,0,100,0,9,117,110,100,
<a name="554"/>  554:           101,102,105,110,101,100,107,0,4,16,0,1,144,107,0,4,61,139,186,181,
<a name="555"/>  555:           107,0,4,10,8,201,49,100,0,9,117,110,100,101,102,105,110,101,100,100,
<a name="556"/>  556:           0,9,117,110,100,101,102,105,0,101,100,100,0,9,117,110,100,101,102,
<a name="557"/>  557:           105,110,101,100,104,2,104,3,98,0,0,7,214,97,11,97,20,104,3,97,17,97,
<a name="558"/>  558:           16,97,21,106,108,0,0,0,3,104,2,97,1,104,2,104,3,98,0,0,7,214,97,11,
<a name="559"/>  559:           97,20,104,3,97,17,97,167,20,104,2,97,4,104,2,104,3,98,0,0,7,214,97,
<a name="560"/>  560:           11,97,20,104,3,97,17,97,16,97,21,104,2,97,10,104,2,104,3,98,0,0,7,
<a name="561"/>  561:           214,97,11,97,20,104,3,97,17,97,16,97,26,106,100,0,5,118,101,114,57,
<a name="562"/>  562:           57,100,0,9,117,110,0,101,102,105,110,101,100,107,0,2,0,244,107,0,4,
<a name="563"/>  563:           10,6,102,195,107,0,4,10,6,102,195,100,0,9,117,110,100,101,102,105,
<a name="564"/>  564:           110,101,100,100,0,9,117,110,100,101,102,105,110,101,100,107,0,125,
<a name="565"/>  565:           248,143,0,203,25115,157,116,65,185,65,172,55,87,164,88,225,50,203,
<a name="566"/>  566:           251,115,157,116,65,185,65,172,55,87,164,88,225,50,0,0,82,153,50,0,
<a name="567"/>  567:           200,98,87,148,237,193,185,65,149,167,69,144,14,16,153,50,3,81,70,94,
<a name="568"/>  568:           13,109,193,1,120,5,181,113,198,118,50,3,81,70,94,13,109,193,185,120,
<a name="569"/>  569:           5,181,113,198,118,153,3,81,70,94,13,109,193,185,120,5,181,113,198,
<a name="570"/>  570:           118,153,50,16,1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,113,92,2,119,128,0,0,
<a name="571"/>  571:           108,0,0,1,107,0,114,69,3,12,1,11,97,31,113,150,64,104,132,61,64,104,
<a name="572"/>  572:           12,3,11,97,31,113,150,64,104,132,61,64,104,12,1,11,97,31,115,150,64,
<a name="573"/>  573:           104,116,73,64,104,0,0,0,0,0,0,65,149,16,61,65,149,16,61,1,241,33,4,0,
<a name="574"/>  574:           33,4,4,10,6,10,181,4,10,6,10,181,38,15,99,111,109,109,97,110,100,101,
<a name="575"/>  575:           114,45,97,112,110,45,49,3,99,111,109,5,109,110,99,57,57,6,109,99,99,
<a name="576"/>  576:           50,52,48,4,103,112,114,115,8,0,106&gt;&gt;,
<a name="577"/>  577: 
<a name="578"/>  578:     Z = zlib:zip(B),
<a name="api_un_zip-last_expr"/><a name="579"/>  579: <b>    ?m</b>(B, zlib:unzip(Z)).
<a name="580"/>  580: 
<a name="581"/>  581: <i>%% Test gunzip.</i>
<a name="api_g_un_zip-1"/><a name="582"/>  582: <b>api_g_un_zip</b>(Config) when is_list(Config) -&gt;
<a name="583"/>  583:     ?m(?EXIT(badarg),zlib:gzip(not_a_binary)),
<a name="584"/>  584:     Bin = &lt;&lt;1,11,1,23,45&gt;&gt;,
<a name="585"/>  585:     Comp = zlib:gzip(Bin),
<a name="586"/>  586: 
<a name="587"/>  587:     ?m(Comp, zlib:gzip(binary_to_list(Bin))),
<a name="588"/>  588:     ?m(?EXIT(badarg), zlib:gunzip(not_a_binary)),
<a name="589"/>  589:     ?m(?EXIT(data_error), zlib:gunzip(&lt;&lt;171,171,171,171,171&gt;&gt;)),
<a name="590"/>  590:     ?m(?EXIT(data_error), zlib:gunzip(&lt;&lt;&gt;&gt;)),
<a name="591"/>  591:     ?m(Bin, zlib:gunzip(Comp)),
<a name="592"/>  592:     ?m(Bin, zlib:gunzip(binary_to_list(Comp))),
<a name="593"/>  593: 
<a name="594"/>  594:     %% RFC 1952:
<a name="595"/>  595:     %%
<a name="596"/>  596:     %% &quot;A gzip file consists of a series of &quot;members&quot; (compressed data
<a name="597"/>  597:     %% sets). [...] The members simply appear one after another in the file,
<a name="598"/>  598:     %% with no additional information before, between, or after them.&quot;
<a name="599"/>  599:     Concatenated = &lt;&lt;Bin/binary, Bin/binary&gt;&gt;,
<a name="600"/>  600:     ?m(Concatenated, zlib:gunzip([Comp, Comp])),
<a name="601"/>  601: 
<a name="602"/>  602:     %% Don't explode if the uncompressed size is a perfect multiple of the
<a name="603"/>  603:     %% internal inflate chunk size.
<a name="604"/>  604:     ChunkSizedData = &lt;&lt;0:16384/unit:8&gt;&gt;,
<a name="605"/>  605:     ?m(ChunkSizedData, zlib:gunzip(zlib:gzip(ChunkSizedData))),
<a name="606"/>  606: 
<a name="607"/>  607:     %% Bad CRC; bad length.
<a name="608"/>  608:     BadCrc = bad_crc_data(),
<a name="609"/>  609:     ?m(?EXIT(data_error),(catch zlib:gunzip(BadCrc))),
<a name="610"/>  610:     BadLen = bad_len_data(),
<a name="611"/>  611:     ?m(?EXIT(data_error),(catch zlib:gunzip(BadLen))),
<a name="api_g_un_zip-last_expr"/><a name="612"/>  612:     ok.
<a name="613"/>  613: 
<a name="bad_crc_data-0"/><a name="614"/>  614: <b>bad_crc_data</b>() -&gt;
<a name="615"/>  615:     %% zlib:zip(&lt;&lt;42&gt;&gt;), one byte changed.
<a name="bad_crc_data-last_expr"/><a name="616"/>  616:     &lt;&lt;31,139,8,0,0,0,0,0,0,3,211,2,0,91,39,185,9,1,0,0,0&gt;&gt;.
<a name="617"/>  617: 
<a name="bad_len_data-0"/><a name="618"/>  618: <b>bad_len_data</b>() -&gt;
<a name="619"/>  619:     %% zlib:zip(&lt;&lt;42&gt;&gt;), one byte changed.
<a name="bad_len_data-last_expr"/><a name="620"/>  620:     &lt;&lt;31,139,8,0,0,0,0,0,0,3,211,2,0,91,38,185,9,2,0,0,0&gt;&gt;.
<a name="621"/>  621: 
<a name="622"/>  622: 
<a name="intro-1"/><a name="623"/>  623: <b>intro</b>(Config) when is_list(Config) -&gt;
<a name="624"/>  624:     D = &lt;&lt;&quot;This is a binary&quot;&gt;&gt;,
<a name="625"/>  625:     [put({ex, N}, &lt;&lt;&quot;This is a binary&quot;&gt;&gt;) || N &lt;- [0,1,2,3,4]],
<a name="626"/>  626:     put({ex, 5}, end_of_data),
<a name="627"/>  627:     put(ex,0),
<a name="628"/>  628:     Read = fun() -&gt;
<a name="629"/>  629: 		   N = get(ex),
<a name="630"/>  630: 		   put(ex,N+1),
<a name="631"/>  631: 		   get({ex,N})
<a name="632"/>  632: 	   end,
<a name="633"/>  633: 
<a name="634"/>  634:     Z = zlib:open(),
<a name="635"/>  635:     ok = zlib:deflateInit(Z,default),
<a name="636"/>  636: 
<a name="637"/>  637:     Compress = fun(end_of_data, _Cont) -&gt; [];
<a name="638"/>  638: 		  (Data, Cont) -&gt;
<a name="639"/>  639: 		       [zlib:deflate(Z, Data)|Cont(Read(),Cont)]
<a name="640"/>  640: 	       end,
<a name="641"/>  641:     Compressed = Compress(Read(),Compress),
<a name="642"/>  642:     Last = zlib:deflate(Z, [], finish),
<a name="643"/>  643:     ok = zlib:deflateEnd(Z),
<a name="644"/>  644:     zlib:close(Z),
<a name="645"/>  645:     Res = list_to_binary([Compressed|Last]),
<a name="646"/>  646:     Orig = list_to_binary(lists:duplicate(5, D)),
<a name="intro-last_expr"/><a name="647"/>  647: <b>    ?m</b>(Orig, zlib:uncompress(Res)).
<a name="648"/>  648: 
<a name="649"/>  649: 
<a name="650"/>  650: <i>%% Test deflate large file, which had a bug reported on erlang-bugs.</i>
<a name="large_deflate-1"/><a name="651"/>  651: <b>large_deflate</b>(Config) when is_list(Config) -&gt;
<a name="large_deflate-last_expr"/><a name="652"/>  652: <b>    large_deflate_do</b>().
<a name="large_deflate_do-0"/><a name="653"/>  653: <b>large_deflate_do</b>() -&gt;
<a name="654"/>  654:     Plain = gen_determ_rand_bytes(64 bsl 10),
<a name="655"/>  655:     Deflated = zlib:zip(Plain),
<a name="large_deflate_do-last_expr"/><a name="656"/>  656: <b>    ?m</b>(Plain, zlib:unzip(Deflated)).
<a name="657"/>  657: 
<a name="658"/>  658: <i>%% Test a standard compressed zip file.</i>
<a name="zip_usage-1"/><a name="659"/>  659: <b>zip_usage</b>(Config) when is_list(Config) -&gt;
<a name="660"/>  660:     zip_usage(zip_usage({get_arg,Config}));
<a name="661"/>  661: <b>zip_usage</b>({get_arg,Config}) -&gt;
<a name="662"/>  662:     Out = get_data_dir(Config),
<a name="663"/>  663:     {ok,ZIP} = file:read_file(filename:join(Out,&quot;zipdoc.zip&quot;)),
<a name="664"/>  664:     {ok,ORIG} = file:read_file(filename:join(Out,&quot;zipdoc&quot;)),
<a name="665"/>  665:     {run,ZIP,ORIG};
<a name="666"/>  666: <b>zip_usage</b>({run,ZIP,ORIG}) -&gt;    
<a name="667"/>  667:     &lt;&lt;_:14/binary, CRC:32/little,
<a name="668"/>  668:       CompSz:32/little, UnCompSz:32/little,_:31/binary,
<a name="669"/>  669:       Compressed:CompSz/binary, _/binary&gt;&gt; = ZIP,
<a name="670"/>  670: 
<a name="671"/>  671:     %%io:format(&quot;CRC ~p CSz ~p UnCSz ~p ~n&quot;, [CRC,CompSz,UnCompSz]),
<a name="672"/>  672:     Split = split_bin(Compressed,[]),
<a name="673"/>  673:     Z = zlib:open(),
<a name="674"/>  674: 
<a name="675"/>  675:     ?m(ok, zlib:inflateInit(Z, -15)),
<a name="676"/>  676:     Bs = [zlib:inflate(Z, Part) || Part &lt;- Split],
<a name="677"/>  677:     UC0 = list_to_binary(Bs),
<a name="678"/>  678:     ?m(UnCompSz, byte_size(UC0)),
<a name="679"/>  679:     ?m(ok, zlib:inflateEnd(Z)),
<a name="680"/>  680:     ?m(true, CRC =:= erlang:crc32(UC0)),
<a name="681"/>  681: 
<a name="682"/>  682:     UC1 = zlib:unzip(Compressed),
<a name="683"/>  683:     ?m(true, CRC =:= erlang:crc32(UC1)),
<a name="684"/>  684:     ?m(UnCompSz, byte_size(UC1)),
<a name="685"/>  685: 
<a name="686"/>  686:     ?m(ok, zlib:inflateInit(Z, -15)),
<a name="687"/>  687:     UC2 = zlib:inflate(Z, Compressed),
<a name="688"/>  688:     ?m(UnCompSz, byte_size(list_to_binary(UC2))),
<a name="689"/>  689:     ?m(ok, zlib:inflateEnd(Z)),
<a name="690"/>  690:     ?m(true, CRC =:= erlang:crc32(UC2)),
<a name="691"/>  691: 
<a name="692"/>  692:     ?m(ok, zlib:inflateInit(Z, -15)),
<a name="693"/>  693:     UC3 = zlib:inflate(Z, Split), % Test multivec.
<a name="694"/>  694:     ?m(UnCompSz, byte_size(list_to_binary(UC3))),
<a name="695"/>  695:     ?m(ok, zlib:inflateEnd(Z)),
<a name="696"/>  696:     ?m(true, CRC =:= erlang:crc32(UC3)),
<a name="697"/>  697: 
<a name="698"/>  698:     ?m(ok, zlib:inflateInit(Z, -15)),
<a name="699"/>  699:     UC4 = zlib:inflate(Z, Compressed),
<a name="700"/>  700:     ?m(UnCompSz, byte_size(list_to_binary(UC4))),
<a name="701"/>  701:     ?m(ok, zlib:inflateEnd(Z)),
<a name="702"/>  702:     ?m(true, CRC =:= erlang:crc32(UC4)),
<a name="703"/>  703: 
<a name="704"/>  704:     C1 = zlib:zip(ORIG),
<a name="705"/>  705:     UC5 =  zlib:unzip(C1),
<a name="706"/>  706:     ?m(true, CRC =:= erlang:crc32(UC5)),
<a name="707"/>  707: 
<a name="708"/>  708:     ?m(ok, zlib:deflateInit(Z, default, deflated, -15, 8, default)),
<a name="709"/>  709:     C2 = zlib:deflate(Z, ORIG, finish),
<a name="710"/>  710:     ?m(ORIG, zlib:unzip(C2)),
<a name="711"/>  711:     ?m(ok, zlib:deflateEnd(Z)),
<a name="712"/>  712:     ?m(true, CRC =:= erlang:crc32(ORIG)),
<a name="713"/>  713: 
<a name="714"/>  714:     ?m(ok, zlib:deflateInit(Z, none, deflated, -15, 8, filtered)),
<a name="715"/>  715:     ?m(ok, zlib:deflateParams(Z, default, default)),
<a name="716"/>  716:     C3 = zlib:deflate(Z, ORIG, finish),
<a name="717"/>  717:     ?m(ORIG, zlib:unzip(C3)),
<a name="718"/>  718:     ?m(ok, zlib:deflateEnd(Z)),
<a name="719"/>  719: 
<a name="720"/>  720:     ok = zlib:close(Z),
<a name="zip_usage-last_expr"/><a name="721"/>  721:     ok.
<a name="722"/>  722: 
<a name="723"/>  723: <i>%% Test a standard compressed gzipped file.</i>
<a name="gz_usage-1"/><a name="724"/>  724: <b>gz_usage</b>(Config) when is_list(Config) -&gt;
<a name="725"/>  725:     gz_usage(gz_usage({get_arg,Config}));
<a name="726"/>  726: <b>gz_usage</b>({get_arg,Config}) -&gt;
<a name="727"/>  727:     Out = get_data_dir(Config),
<a name="728"/>  728:     {ok,GZIP} = file:read_file(filename:join(Out,&quot;zipdoc.1.gz&quot;)),
<a name="729"/>  729:     {ok,ORIG} = file:read_file(filename:join(Out,&quot;zipdoc&quot;)),
<a name="730"/>  730:     {ok,GZIP2} = file:read_file(filename:join(Out,&quot;zipdoc.txt.gz&quot;)),
<a name="731"/>  731:     {run,GZIP,ORIG,GZIP2};    
<a name="732"/>  732: <b>gz_usage</b>({run,GZIP,ORIG,GZIP2}) -&gt;
<a name="733"/>  733:     Z = zlib:open(),
<a name="734"/>  734:     UC1 = zlib:gunzip(GZIP),
<a name="735"/>  735:     ?m(true, erlang:crc32(UC1) =:= erlang:crc32(ORIG)),
<a name="736"/>  736:     UC3 = zlib:gunzip(GZIP2),
<a name="737"/>  737:     ?m(true, erlang:crc32(UC3) =:= erlang:crc32(ORIG)),
<a name="738"/>  738:     Compressed = zlib:gzip(ORIG),
<a name="739"/>  739:     UC5 = zlib:gunzip(Compressed),
<a name="740"/>  740:     ?m(true, erlang:crc32(UC5) =:= erlang:crc32(ORIG)),
<a name="gz_usage-last_expr"/><a name="741"/>  741: <b>    ok = zlib:close</b>(Z).
<a name="742"/>  742: 
<a name="743"/>  743: <i>%% Test more of a standard compressed gzipped file.</i>
<a name="gz_usage2-1"/><a name="744"/>  744: <b>gz_usage2</b>(Config) -&gt;
<a name="gz_usage2-last_expr"/><a name="745"/>  745: <b>    case os:find_executable</b>(&quot;gzip&quot;) of
<a name="746"/>  746: 	Name when is_list(Name) -&gt;
<a name="747"/>  747: 	    Z = zlib:open(),
<a name="748"/>  748: 	    Out = get_data_dir(Config),
<a name="749"/>  749: 	    {ok,ORIG} = file:read_file(filename:join(Out,&quot;zipdoc&quot;)),
<a name="750"/>  750: 	    Compressed = zlib:gzip(ORIG),
<a name="751"/>  751: 	    GzOutFile = filename:join(Out,&quot;out.gz&quot;),
<a name="752"/>  752: 	    OutFile = filename:join(Out,&quot;out.txt&quot;),
<a name="753"/>  753: 	    ?m(ok, file:write_file(GzOutFile,Compressed)),
<a name="754"/>  754: 	    os:cmd(&quot;gzip -c -d &quot; ++ GzOutFile ++ &quot; &gt; &quot; ++ OutFile),
<a name="755"/>  755: 	    case file:read_file(OutFile) of
<a name="756"/>  756: 		{ok,ExtDecompressed} -&gt;
<a name="757"/>  757: 		    ?m(true, 
<a name="758"/>  758: 		       erlang:crc32(ExtDecompressed) =:= erlang:crc32(ORIG));
<a name="759"/>  759: 		Error -&gt;
<a name="760"/>  760: 		    io:format(&quot;Couldn't test external decompressor ~p\n&quot;, 
<a name="761"/>  761: 			      [Error])
<a name="762"/>  762: 	    end,
<a name="763"/>  763: 	    ok = zlib:close(Z),
<a name="764"/>  764: 	    ok;
<a name="765"/>  765: 	false -&gt;
<a name="766"/>  766: 	    {skipped,&quot;No gzip in path&quot;}
<a name="767"/>  767:     end.
<a name="768"/>  768: 
<a name="769"/>  769: 
<a name="770"/>  770: 
<a name="771"/>  771: <i>%% Test that (de)compress funcs work with standard tools, for example</i>
<a name="772"/>  772: <i>%% a chunk from a png file.</i>
<a name="compress_usage-1"/><a name="773"/>  773: <b>compress_usage</b>(Config) when is_list(Config) -&gt;
<a name="774"/>  774:     compress_usage(compress_usage({get_arg,Config}));
<a name="775"/>  775: <b>compress_usage</b>({get_arg,Config}) -&gt;
<a name="776"/>  776:     Out = get_data_dir(Config),
<a name="777"/>  777:     {ok,C1} = file:read_file(filename:join(Out,&quot;png-compressed.zlib&quot;)),
<a name="778"/>  778:     {run,C1};
<a name="779"/>  779: <b>compress_usage</b>({run,C1}) -&gt;
<a name="780"/>  780:     Z = zlib:open(),
<a name="781"/>  781:     %% See that we can uncompress a file generated with external prog.
<a name="782"/>  782:     UC1 = zlib:uncompress(C1),
<a name="783"/>  783:     %% Check that the crc is correct.
<a name="784"/>  784:     ?m(4125865008, erlang:crc32(UC1)),
<a name="785"/>  785:     C2 = zlib:compress(UC1),
<a name="786"/>  786:     UC2 = zlib:uncompress(C2),
<a name="787"/>  787:     %% Check that the crc is correct.
<a name="788"/>  788:     ?m(4125865008, erlang:crc32(UC2)),
<a name="789"/>  789: 
<a name="790"/>  790:     ok = zlib:close(Z),
<a name="791"/>  791: 
<a name="792"/>  792:     D = [&lt;&lt;&quot;We tests some partial&quot;&gt;&gt;,
<a name="793"/>  793: 	 &lt;&lt;&quot;data, sent over&quot;&gt;&gt;,
<a name="794"/>  794: 	 &lt;&lt;&quot;the stream&quot;&gt;&gt;,
<a name="795"/>  795: 	 &lt;&lt;&quot;we check that we can unpack&quot;&gt;&gt;,
<a name="796"/>  796: 	 &lt;&lt;&quot;every message we get&quot;&gt;&gt;],
<a name="797"/>  797: 
<a name="798"/>  798:     ZC = zlib:open(),
<a name="799"/>  799:     ZU = zlib:open(),
<a name="800"/>  800:     Test = fun(finish, {_,Tot}) -&gt;
<a name="801"/>  801: 		   Compressed = zlib:deflate(ZC, &lt;&lt;&gt;&gt;, finish),
<a name="802"/>  802: 		   Data = zlib:inflate(ZU, Compressed),
<a name="803"/>  803: 		   [Tot|Data];
<a name="804"/>  804: 	      (Data, {Op,Tot}) -&gt;
<a name="805"/>  805: 		   Compressed = zlib:deflate(ZC, Data, Op),
<a name="806"/>  806: 		   Res1 = ?m([Data],zlib:inflate(ZU, Compressed)),
<a name="807"/>  807: 		   {Op, [Tot|Res1]}
<a name="808"/>  808: 	   end,
<a name="809"/>  809:     zlib:deflateInit(ZC),
<a name="810"/>  810:     zlib:inflateInit(ZU),
<a name="811"/>  811:     T1 = lists:foldl(Test,{sync,[]},D++[finish]),
<a name="812"/>  812:     ?m(true, list_to_binary(D) == list_to_binary(T1)),
<a name="813"/>  813:     zlib:deflateEnd(ZC),
<a name="814"/>  814:     zlib:inflateEnd(ZU),
<a name="815"/>  815: 
<a name="816"/>  816:     zlib:deflateInit(ZC),
<a name="817"/>  817:     zlib:inflateInit(ZU),
<a name="818"/>  818:     T2 = lists:foldl(Test,{full,[]},D++[finish]),
<a name="819"/>  819:     ?m(true, list_to_binary(D) == list_to_binary(T2)),
<a name="820"/>  820:     zlib:deflateEnd(ZC),
<a name="821"/>  821:     zlib:inflateEnd(ZU),
<a name="822"/>  822: 
<a name="823"/>  823:     ok = zlib:close(ZC),
<a name="compress_usage-last_expr"/><a name="824"/>  824: <b>    ok = zlib:close</b>(ZU).
<a name="825"/>  825: 
<a name="826"/>  826: <i>%% Test dictionary usage.</i>
<a name="dictionary_usage-1"/><a name="827"/>  827: <b>dictionary_usage</b>(Config) when is_list(Config) -&gt;
<a name="828"/>  828:     dictionary_usage(dictionary_usage({get_arg,Config}));
<a name="829"/>  829: <b>dictionary_usage</b>({get_arg,_Config}) -&gt;
<a name="830"/>  830:     {run}; % no args
<a name="831"/>  831: <b>dictionary_usage</b>({run}) -&gt;
<a name="832"/>  832:     Z1 = zlib:open(),
<a name="833"/>  833:     Dict = &lt;&lt;&quot;Anka&quot;&gt;&gt;,
<a name="834"/>  834:     Data = &lt;&lt;&quot;Kalle Anka&quot;&gt;&gt;,
<a name="835"/>  835:     ?m(ok, zlib:deflateInit(Z1)),
<a name="836"/>  836:     DictID = zlib:deflateSetDictionary(Z1, Dict),
<a name="837"/>  837:     %% io:format(&quot;DictID = ~p\n&quot;, [DictID]),
<a name="838"/>  838:     B1 = zlib:deflate(Z1, Data),
<a name="839"/>  839:     B2 = zlib:deflate(Z1, &lt;&lt;&gt;&gt;, finish),
<a name="840"/>  840:     ?m(ok, zlib:deflateEnd(Z1)),
<a name="841"/>  841:     ?m(ok, zlib:close(Z1)),
<a name="842"/>  842:     Compressed = list_to_binary([B1,B2]),
<a name="843"/>  843:     %% io:format(&quot;~p\n&quot;, [Compressed]),
<a name="844"/>  844: 
<a name="845"/>  845:     %% Now uncompress.
<a name="846"/>  846:     Z2 = zlib:open(),
<a name="847"/>  847:     ?m(ok, zlib:inflateInit(Z2)),
<a name="848"/>  848: 
<a name="849"/>  849:     ?m(?EXIT({need_dictionary, DictID}), zlib:inflate(Z2, Compressed)),
<a name="850"/>  850: 
<a name="851"/>  851:     ?m(ok, zlib:inflateSetDictionary(Z2, Dict)),
<a name="852"/>  852:     ?m(ok, zlib:inflateSetDictionary(Z2, binary_to_list(Dict))),
<a name="853"/>  853: 
<a name="854"/>  854:     Uncompressed = ?m(B when is_list(B), zlib:inflate(Z2, [])),
<a name="855"/>  855: 
<a name="856"/>  856:     ?m(ok, zlib:inflateEnd(Z2)),
<a name="857"/>  857:     ?m(ok, zlib:close(Z2)),    
<a name="dictionary_usage-last_expr"/><a name="858"/>  858: <b>    ?m</b>(Data, list_to_binary(Uncompressed)).
<a name="859"/>  859: 
<a name="split_bin-2"/><a name="860"/>  860: <b>split_bin</b>(&lt;&lt;Part:1997/binary,Rest/binary&gt;&gt;, Acc) -&gt;
<a name="861"/>  861:     split_bin(Rest, [Part|Acc]);
<a name="862"/>  862: <b>split_bin</b>(Last,Acc) -&gt;
<a name="split_bin-last_expr"/><a name="863"/>  863: <b>    lists:reverse</b>([Last|Acc]).
<a name="864"/>  864: 
<a name="only_allow_owner-1"/><a name="865"/>  865: <b>only_allow_owner</b>(Config) when is_list(Config) -&gt;
<a name="866"/>  866:     Z = zlib:open(),
<a name="867"/>  867:     Owner = self(),
<a name="868"/>  868: 
<a name="869"/>  869:     ?m(ok, zlib:inflateInit(Z)),
<a name="870"/>  870:     ?m(ok, zlib:inflateReset(Z)),
<a name="871"/>  871: 
<a name="872"/>  872:     {Pid, Ref} = spawn_monitor(
<a name="873"/>  873:         fun() -&gt;
<a name="874"/>  874:             ?m(?EXIT(not_on_controlling_process), zlib:inflateReset(Z)),
<a name="875"/>  875:             Owner ! '$transfer_ownership',
<a name="876"/>  876:             receive
<a name="877"/>  877:                 '$ownership_transferred' -&gt;
<a name="878"/>  878:                     ?m(ok, zlib:inflateReset(Z))
<a name="879"/>  879:             after 200 -&gt;
<a name="880"/>  880:                 ct:fail(&quot;Never received transfer signal.&quot;)
<a name="881"/>  881:             end
<a name="882"/>  882:         end),
<a name="only_allow_owner-last_expr"/><a name="883"/>  883: <b>    ownership_transfer_check</b>(Z, Pid, Ref).
<a name="884"/>  884: 
<a name="ownership_transfer_check-3"/><a name="885"/>  885: <b>ownership_transfer_check</b>(Z, WorkerPid, Ref) -&gt;
<a name="ownership_transfer_check-last_expr"/><a name="886"/>  886:     receive
<a name="887"/>  887:         '$transfer_ownership' -&gt;
<a name="888"/>  888:             zlib:set_controlling_process(Z, WorkerPid),
<a name="889"/>  889:             WorkerPid ! '$ownership_transferred',
<a name="890"/>  890:             ownership_transfer_check(Z, WorkerPid, Ref);
<a name="891"/>  891:         {'DOWN', Ref, process, WorkerPid, normal} -&gt;
<a name="892"/>  892:             ok;
<a name="893"/>  893:         {'DOWN', Ref, process, WorkerPid, Reason} -&gt;
<a name="894"/>  894:             ct:fail(&quot;Spawned worker crashed with reason ~p.&quot;, [Reason])
<a name="895"/>  895:     after 200 -&gt;
<a name="896"/>  896:         ct:fail(&quot;Spawned worker timed out.&quot;)
<a name="897"/>  897:     end.
<a name="898"/>  898: 
<a name="sub_heap_binaries-1"/><a name="899"/>  899: <b>sub_heap_binaries</b>(Config) when is_list(Config) -&gt;
<a name="900"/>  900:     Compressed = zlib:compress(&lt;&lt;&quot;gurka&quot;&gt;&gt;),
<a name="901"/>  901:     ConfLen = erlang:length(Config),
<a name="902"/>  902: 
<a name="903"/>  903:     HeapBin = &lt;&lt;ConfLen:8/integer, Compressed/binary&gt;&gt;,
<a name="904"/>  904:     &lt;&lt;_:8/integer, SubHeapBin/binary&gt;&gt; = HeapBin,
<a name="905"/>  905: 
<a name="906"/>  906:     ?m(&lt;&lt;&quot;gurka&quot;&gt;&gt;, zlib:uncompress(SubHeapBin)),
<a name="sub_heap_binaries-last_expr"/><a name="907"/>  907:     ok.
<a name="908"/>  908: 
<a name="909"/>  909: <i>%% Check concurrent access to zlib driver.</i>
<a name="smp-1"/><a name="910"/>  910: <b>smp</b>(Config) -&gt;
<a name="911"/>  911:     NumOfProcs = lists:min([8,erlang:system_info(schedulers)]),
<a name="912"/>  912:     io:format(&quot;smp starting ~p workers\n&quot;,[NumOfProcs]),
<a name="913"/>  913: 
<a name="914"/>  914:     %% Tests to run in parallel.
<a name="915"/>  915:     Funcs = [zip_usage, gz_usage, compress_usage, dictionary_usage],
<a name="916"/>  916: 
<a name="917"/>  917:     %% We get all function arguments here to avoid repeated parallel
<a name="918"/>  918:     %% file read access.
<a name="919"/>  919:     UsageArgs =
<a name="920"/>  920:         list_to_tuple([{F, ?MODULE:F({get_arg,Config})} || F &lt;- Funcs]),
<a name="921"/>  921:     Parent = self(),
<a name="922"/>  922: 
<a name="923"/>  923:     WorkerFun =
<a name="924"/>  924:         fun() -&gt;
<a name="925"/>  925:             worker(rand:uniform(9999), UsageArgs, Parent)
<a name="926"/>  926:         end,
<a name="927"/>  927: 
<a name="928"/>  928:     Pids = [spawn_link(WorkerFun) || _ &lt;- lists:seq(1, NumOfProcs)],
<a name="smp-last_expr"/><a name="929"/>  929: <b>    wait_pids</b>(Pids).
<a name="930"/>  930: 
<a name="worker-3"/><a name="931"/>  931: <b>worker</b>(Seed, FnATpl, Parent) -&gt;
<a name="932"/>  932:     io:format(&quot;smp worker ~p, seed=~p~n&quot;,[self(),Seed]),
<a name="933"/>  933:     rand:seed(exsplus, {Seed,Seed,Seed}),
<a name="934"/>  934:     worker_loop(100, FnATpl),
<a name="worker-last_expr"/><a name="935"/>  935: <b>    Parent ! self</b>().
<a name="936"/>  936: 
<a name="worker_loop-2"/><a name="937"/>  937: <b>worker_loop</b>(0, _FnATpl) -&gt;
<a name="938"/>  938:     large_deflate_do(), % the time consuming one as finale
<a name="939"/>  939:     ok;
<a name="940"/>  940: <b>worker_loop</b>(N, FnATpl) -&gt;
<a name="941"/>  941:     {F,A} = element(rand:uniform(tuple_size(FnATpl)), FnATpl),
<a name="942"/>  942:     ?MODULE:F(A),
<a name="worker_loop-last_expr"/><a name="943"/>  943: <b>    worker_loop</b>(N-1, FnATpl).
<a name="944"/>  944: 
<a name="wait_pids-1"/><a name="945"/>  945: <b>wait_pids</b>([]) -&gt; 
<a name="946"/>  946:     ok;
<a name="947"/>  947: <b>wait_pids</b>(Pids) -&gt;
<a name="wait_pids-last_expr"/><a name="948"/>  948:     receive
<a name="949"/>  949: 	Pid -&gt;
<a name="950"/>  950: 	    true = lists:member(Pid,Pids),
<a name="951"/>  951: 	    Others = lists:delete(Pid,Pids),
<a name="952"/>  952: 	    io:format(&quot;wait_pid got ~p, still waiting for ~p\n&quot;,[Pid,Others]),
<a name="953"/>  953: 	    wait_pids(Others)
<a name="954"/>  954:     end.
<a name="955"/>  955: 
<a name="otp_9981-1"/><a name="956"/>  956: <b>otp_9981</b>(Config) when is_list(Config) -&gt;
<a name="957"/>  957:     Ports = lists:sort(erlang:ports()),
<a name="958"/>  958:     Invalid = &lt;&lt;&quot;My invalid data&quot;&gt;&gt;,
<a name="959"/>  959:     catch zlib:compress(invalid),
<a name="960"/>  960:     Ports = lists:sort(erlang:ports()),
<a name="961"/>  961:     catch zlib:uncompress(Invalid),
<a name="962"/>  962:     Ports = lists:sort(erlang:ports()),
<a name="963"/>  963:     catch zlib:zip(invalid),
<a name="964"/>  964:     Ports = lists:sort(erlang:ports()),
<a name="965"/>  965:     catch zlib:unzip(Invalid),
<a name="966"/>  966:     Ports = lists:sort(erlang:ports()),
<a name="967"/>  967:     catch zlib:gzip(invalid),
<a name="968"/>  968:     Ports = lists:sort(erlang:ports()),
<a name="969"/>  969:     catch zlib:gunzip(Invalid),
<a name="970"/>  970:     Ports = lists:sort(erlang:ports()),
<a name="otp_9981-last_expr"/><a name="971"/>  971:     ok.
<a name="972"/>  972: 
<a name="973"/>  973: <i>%% ERIERL-994: the Adler32 checksum returned by the dictionary functionality</i>
<a name="974"/>  974: <i>%% could be negative due to returning a signed instead of unsigned integer.</i>
<a name="checksum-1"/><a name="975"/>  975: <b>checksum</b>(Config) when is_list(Config) -&gt;
<a name="976"/>  976:     Z = zlib:open(),
<a name="977"/>  977:     ok = zlib:deflateInit(Z),
<a name="978"/>  978:     TestVec = list_to_binary(lists:duplicate(16, 255)),
<a name="979"/>  979:     Chk = zlib:deflateSetDictionary(Z, TestVec),
<a name="980"/>  980:     true = Chk &gt;= 0,
<a name="981"/>  981:     zlib:close(Z),
<a name="checksum-last_expr"/><a name="982"/>  982:     ok.
<a name="983"/>  983: 
<a name="984"/>  984: <b>-define</b>(BENCH_SIZE, (16 bsl 20)).
<a name="985"/>  985: 
<a name="986"/>  986: <b>-define</b>(DECOMPRESS_BENCH(Name, What, Data),
<a name="987"/>  987:         Name(Config) when is_list(Config) -&gt;
<a name="988"/>  988:         Uncompressed = Data,
<a name="989"/>  989:         Compressed = zlib:compress(Uncompressed),
<a name="990"/>  990:         What(Compressed, byte_size(Uncompressed))).
<a name="991"/>  991: 
<a name="992"/>  992: <b>-define</b>(COMPRESS_BENCH(Name, What, Data),
<a name="993"/>  993:         Name(Config) when is_list(Config) -&gt;
<a name="994"/>  994:         Compressed = Data,
<a name="995"/>  995:         What(Compressed, byte_size(Compressed))).
<a name="996"/>  996: 
<a name="inflate_bench_zeroed-1"/><a name="inflate_bench_zeroed-last_expr"/><a name="997"/>  997: <b>?DECOMPRESS_BENCH</b>(inflate_bench_zeroed, throughput_bench_inflate,
<a name="998"/>  998:     &lt;&lt;0:(8 * ?BENCH_SIZE)&gt;&gt;).
<a name="inflate_bench_rand-1"/><a name="inflate_bench_rand-last_expr"/><a name="999"/>  999: <b>?DECOMPRESS_BENCH</b>(inflate_bench_rand, throughput_bench_inflate,
<a name="1000"/> 1000:     gen_determ_rand_bytes(?BENCH_SIZE)).
<a name="1001"/> 1001: 
<a name="chunk_bench_zeroed-1"/><a name="chunk_bench_zeroed-last_expr"/><a name="1002"/> 1002: <b>?DECOMPRESS_BENCH</b>(chunk_bench_zeroed, throughput_bench_chunk,
<a name="1003"/> 1003:     &lt;&lt;0:(8 * ?BENCH_SIZE)&gt;&gt;).
<a name="chunk_bench_rand-1"/><a name="chunk_bench_rand-last_expr"/><a name="1004"/> 1004: <b>?DECOMPRESS_BENCH</b>(chunk_bench_rand, throughput_bench_chunk,
<a name="1005"/> 1005:     gen_determ_rand_bytes(?BENCH_SIZE)).
<a name="1006"/> 1006: 
<a name="deflate_bench_zeroed-1"/><a name="deflate_bench_zeroed-last_expr"/><a name="1007"/> 1007: <b>?COMPRESS_BENCH</b>(deflate_bench_zeroed, throughput_bench_deflate,
<a name="1008"/> 1008:     &lt;&lt;0:(8 * ?BENCH_SIZE)&gt;&gt;).
<a name="deflate_bench_rand-1"/><a name="deflate_bench_rand-last_expr"/><a name="1009"/> 1009: <b>?COMPRESS_BENCH</b>(deflate_bench_rand, throughput_bench_deflate,
<a name="1010"/> 1010:     gen_determ_rand_bytes(?BENCH_SIZE)).
<a name="1011"/> 1011: 
<a name="throughput_bench_inflate-2"/><a name="1012"/> 1012: <b>throughput_bench_inflate</b>(Compressed, Size) -&gt;
<a name="1013"/> 1013:     Z = zlib:open(),
<a name="1014"/> 1014:     zlib:inflateInit(Z),
<a name="1015"/> 1015: 
<a name="throughput_bench_inflate-last_expr"/><a name="1016"/> 1016: <b>    submit_throughput_results</b>(Size,
<a name="1017"/> 1017:         fun() -&gt;
<a name="1018"/> 1018:             zlib:inflate(Z, Compressed)
<a name="1019"/> 1019:         end).
<a name="1020"/> 1020: 
<a name="throughput_bench_deflate-2"/><a name="1021"/> 1021: <b>throughput_bench_deflate</b>(Uncompressed, Size) -&gt;
<a name="1022"/> 1022:     Z = zlib:open(),
<a name="1023"/> 1023:     zlib:deflateInit(Z),
<a name="1024"/> 1024: 
<a name="throughput_bench_deflate-last_expr"/><a name="1025"/> 1025: <b>    submit_throughput_results</b>(Size,
<a name="1026"/> 1026:         fun() -&gt;
<a name="1027"/> 1027:             zlib:deflate(Z, Uncompressed, finish)
<a name="1028"/> 1028:         end).
<a name="1029"/> 1029: 
<a name="throughput_bench_chunk-2"/><a name="1030"/> 1030: <b>throughput_bench_chunk</b>(Compressed, Size) -&gt;
<a name="1031"/> 1031:     Z = zlib:open(),
<a name="1032"/> 1032:     zlib:inflateInit(Z),
<a name="1033"/> 1033: 
<a name="1034"/> 1034:     ChunkLoop =
<a name="1035"/> 1035:         fun Loop({continue, _}) -&gt; Loop(zlib:safeInflate(Z, []));
<a name="1036"/> 1036:             Loop({finished, _}) -&gt; ok
<a name="1037"/> 1037:         end,
<a name="1038"/> 1038: 
<a name="throughput_bench_chunk-last_expr"/><a name="1039"/> 1039: <b>    submit_throughput_results</b>(Size,
<a name="1040"/> 1040:         fun() -&gt;
<a name="1041"/> 1041:                 ChunkLoop(zlib:safeInflate(Z, Compressed))
<a name="1042"/> 1042:         end).
<a name="1043"/> 1043: 
<a name="submit_throughput_results-2"/><a name="1044"/> 1044: <b>submit_throughput_results</b>(Size, Fun) -&gt;
<a name="1045"/> 1045:     TimeTaken = measure_perf_counter(Fun, millisecond),
<a name="1046"/> 1046: 
<a name="1047"/> 1047:     KBPS = trunc((Size bsr 10) / (TimeTaken / 1000)),
<a name="1048"/> 1048:     ct_event:notify(#event{ name = benchmark_data, data = [{value,KBPS}] }),
<a name="submit_throughput_results-last_expr"/><a name="1049"/> 1049: <b>    {comment, io_lib:format</b>(&quot;~p ms, ~p KBPS&quot;, [TimeTaken, KBPS])}.
<a name="1050"/> 1050: 
<a name="measure_perf_counter-2"/><a name="1051"/> 1051: <b>measure_perf_counter</b>(Fun, Unit) -&gt;
<a name="1052"/> 1052:     Start = os:perf_counter(Unit),
<a name="1053"/> 1053:     Fun(),
<a name="measure_perf_counter-last_expr"/><a name="1054"/> 1054: <b>    os:perf_counter</b>(Unit) - Start.
<a name="1055"/> 1055: 
<a name="1056"/> 1056: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1057"/> 1057: <i>%%% Helps with testing directly %%%%%%%%%%%%%</i>
<a name="1058"/> 1058: 
<a name="get_data_dir-1"/><a name="1059"/> 1059: <b>get_data_dir</b>(Config) -&gt;
<a name="get_data_dir-last_expr"/><a name="1060"/> 1060: <b>    try proplists:get_value</b>(data_dir,Config) of
<a name="1061"/> 1061:         undefined -&gt;
<a name="1062"/> 1062:             &quot;./zlib_SUITE_data&quot;;
<a name="1063"/> 1063:         Dir -&gt;
<a name="1064"/> 1064:             Dir
<a name="1065"/> 1065:     catch
<a name="1066"/> 1066:         _:_ -&gt; &quot;./zlib_SUITE_data&quot;
<a name="1067"/> 1067:     end.
<a name="1068"/> 1068: 
<a name="1069"/> 1069: <i>%% Generates a bunch of statistically random bytes using the size as seed.</i>
<a name="gen_determ_rand_bytes-1"/><a name="1070"/> 1070: <b>gen_determ_rand_bytes</b>(Size) -&gt;
<a name="gen_determ_rand_bytes-last_expr"/><a name="1071"/> 1071: <b>    gen_determ_rand_bytes</b>(Size, erlang:md5_init(), &lt;&lt;&gt;&gt;).
<a name="gen_determ_rand_bytes-3"/><a name="1072"/> 1072: <b>gen_determ_rand_bytes</b>(Size, _Context, Acc) when Size =&lt; 0 -&gt;
<a name="1073"/> 1073:     Acc;
<a name="1074"/> 1074: <b>gen_determ_rand_bytes</b>(Size, Context0, Acc) when Size &gt; 0 -&gt;
<a name="1075"/> 1075:     Context = erlang:md5_update(Context0, &lt;&lt;Size/integer&gt;&gt;),
<a name="1076"/> 1076:     Checksum = erlang:md5_final(Context),
<a name="gen_determ_rand_bytes-last_expr"/><a name="1077"/> 1077: <b>    gen_determ_rand_bytes</b>(Size - 16, Context, &lt;&lt;Acc/binary, Checksum/binary&gt;&gt;).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
