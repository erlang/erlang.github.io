<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/erl_scan_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1998-2022. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: 
<a name="20"/>   20: <b>-module</b>(erl_scan_SUITE).
<a name="21"/>   21: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1,
<a name="22"/>   22: 	 init_per_testcase/2, end_per_testcase/2,
<a name="23"/>   23: 	 init_per_group/2,end_per_group/2]).
<a name="24"/>   24: 
<a name="25"/>   25: <b>-export</b>([error_1/1, error_2/1, iso88591/1, otp_7810/1, otp_10302/1,
<a name="26"/>   26: 	 otp_10990/1, otp_10992/1, otp_11807/1, otp_16480/1, otp_17024/1,
<a name="27"/>   27:          text_fun/1]).
<a name="28"/>   28: 
<a name="29"/>   29: <b>-import</b>(lists, [nth/2,flatten/1]).
<a name="30"/>   30: <b>-import</b>(io_lib, [print/1]).
<a name="31"/>   31: 
<a name="32"/>   32: <i>%%</i>
<a name="33"/>   33: <i>%% Define to run outside of test server</i>
<a name="34"/>   34: <i>%%</i>
<a name="35"/>   35: <i>%%-define(STANDALONE,1).</i>
<a name="36"/>   36: 
<a name="37"/>   37: <b>-ifdef</b>(STANDALONE).
<a name="38"/>   38: <b>-compile</b>(export_all).
<a name="39"/>   39: <b>-define</b>(line, put(line, ?LINE), ).
<a name="40"/>   40: <b>-define</b>(config(A,B),config(A,B)).
<a name="41"/>   41: <b>-define</b>(t, test_server).
<a name="42"/>   42: <i>%% config(priv_dir, _) -&gt;</i>
<a name="43"/>   43: <i>%%     &quot;.&quot;;</i>
<a name="44"/>   44: <i>%% config(data_dir, _) -&gt;</i>
<a name="45"/>   45: <i>%%     &quot;.&quot;.</i>
<a name="46"/>   46: -else.
<a name="47"/>   47: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="48"/>   48: -endif.
<a name="49"/>   49: 
<a name="init_per_testcase-2"/><a name="50"/>   50: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="51"/>   51:     Config.
<a name="52"/>   52: 
<a name="end_per_testcase-2"/><a name="53"/>   53: <b>end_per_testcase</b>(_Case, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="54"/>   54:     ok.
<a name="55"/>   55: 
<a name="suite-0"/><a name="56"/>   56: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="57"/>   57:     [{ct_hooks,[ts_install_cth]},
<a name="58"/>   58:      {timetrap,{minutes,20}}].
<a name="59"/>   59: 
<a name="all-0"/><a name="60"/>   60: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="61"/>   61:     [{group, error}, iso88591, otp_7810, otp_10302, otp_10990, otp_10992,
<a name="62"/>   62:      otp_11807, otp_16480, otp_17024, text_fun].
<a name="63"/>   63: 
<a name="groups-0"/><a name="64"/>   64: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="65"/>   65:     [{error, [], [error_1, error_2]}].
<a name="66"/>   66: 
<a name="init_per_suite-1"/><a name="67"/>   67: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="68"/>   68:     Config.
<a name="69"/>   69: 
<a name="end_per_suite-1"/><a name="70"/>   70: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="71"/>   71:     ok.
<a name="72"/>   72: 
<a name="init_per_group-2"/><a name="73"/>   73: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="74"/>   74:     Config.
<a name="75"/>   75: 
<a name="end_per_group-2"/><a name="76"/>   76: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="77"/>   77:     Config.
<a name="78"/>   78: 
<a name="79"/>   79: 
<a name="80"/>   80: 
<a name="81"/>   81: <i>%% (OTP-2347)</i>
<a name="error_1-1"/><a name="82"/>   82: <b>error_1</b>(Config) when is_list(Config) -&gt;
<a name="83"/>   83:     {error, _, _} = erl_scan:string(&quot;'a&quot;),
<a name="error_1-last_expr"/><a name="84"/>   84:     ok.
<a name="85"/>   85: 
<a name="86"/>   86: <i>%% Checks that format_error works on the error cases.</i>
<a name="error_2-1"/><a name="87"/>   87: <b>error_2</b>(Config) when is_list(Config) -&gt;
<a name="88"/>   88:     lists:foreach(fun check/1, error_cases()),
<a name="error_2-last_expr"/><a name="89"/>   89:     ok.
<a name="90"/>   90: 
<a name="error_cases-0"/><a name="91"/>   91: <b>error_cases</b>() -&gt;
<a name="error_cases-last_expr"/><a name="92"/>   92:     [&quot;'a&quot;,
<a name="93"/>   93:      &quot;\&quot;a&quot;,
<a name="94"/>   94:      &quot;'\\&quot;,
<a name="95"/>   95:      &quot;\&quot;\\&quot;,
<a name="96"/>   96:      &quot;$&quot;,
<a name="97"/>   97:      &quot;$\\&quot;,
<a name="98"/>   98:      &quot;2.3e&quot;,
<a name="99"/>   99:      &quot;2.3e-&quot;,
<a name="100"/>  100:      &quot;91#9&quot;
<a name="101"/>  101:     ].
<a name="102"/>  102: 
<a name="assert_type-2"/><a name="103"/>  103: <b>assert_type</b>(N, integer) when is_integer(N) -&gt;
<a name="104"/>  104:     ok;
<a name="105"/>  105: <b>assert_type</b>(N, atom) when is_atom(N) -&gt;
<a name="assert_type-last_expr"/><a name="106"/>  106:     ok.
<a name="107"/>  107: 
<a name="check-1"/><a name="108"/>  108: <b>check</b>(String) -&gt;
<a name="109"/>  109:     Error = erl_scan:string(String),
<a name="check-last_expr"/><a name="110"/>  110: <b>    check_error</b>(Error, erl_scan).
<a name="111"/>  111: 
<a name="112"/>  112: <i>%%% (This should be useful for all format_error functions.)</i>
<a name="check_error-2"/><a name="113"/>  113: <b>check_error</b>({error, Info, EndLine}, Module0) -&gt;
<a name="114"/>  114:     {ErrorLine, Module, Desc} = Info,
<a name="115"/>  115:     true = (Module == Module0),
<a name="116"/>  116:     assert_type(EndLine, integer),
<a name="117"/>  117:     assert_type(ErrorLine, integer),
<a name="118"/>  118:     true = (ErrorLine =&lt; EndLine),
<a name="119"/>  119:     String = lists:flatten(Module0:format_error(Desc)),
<a name="check_error-last_expr"/><a name="120"/>  120: <b>    true = io_lib:printable_list</b>(String).
<a name="121"/>  121: 
<a name="122"/>  122: <i>%% Tests the support for ISO-8859-1 i.e Latin-1.</i>
<a name="iso88591-1"/><a name="123"/>  123: <b>iso88591</b>(Config) when is_list(Config) -&gt;
<a name="iso88591-last_expr"/><a name="124"/>  124:     ok =
<a name="125"/>  125: 	case catch begin
<a name="126"/>  126: 		       %% Some atom and variable names
<a name="127"/>  127: 		       V1s = [$Á,$á,$é,$ë],
<a name="128"/>  128: 		       V2s = [$N,$ä,$r],
<a name="129"/>  129: 		       A1s = [$h,$ä,$r],
<a name="130"/>  130: 		       A2s = [$ö,$r,$e],
<a name="131"/>  131: 		       %% Test parsing atom and variable characters.
<a name="132"/>  132: 		       {ok,Ts1,_} = erl_scan_string(V1s ++ &quot; &quot; ++ V2s ++
<a name="133"/>  133: 							&quot;\327&quot; ++
<a name="134"/>  134: 							A1s ++ &quot; &quot; ++ A2s),
<a name="135"/>  135: 		       V1s = atom_to_list(element(3, nth(1, Ts1))),
<a name="136"/>  136: 		       V2s = atom_to_list(element(3, nth(2, Ts1))),
<a name="137"/>  137: 		       A1s = atom_to_list(element(3, nth(4, Ts1))),
<a name="138"/>  138: 		       A2s = atom_to_list(element(3, nth(5, Ts1))),
<a name="139"/>  139: 		       %% Test printing atoms
<a name="140"/>  140: 		       A1s = flatten(print(element(3, nth(4, Ts1)))),
<a name="141"/>  141: 		       A2s = flatten(print(element(3, nth(5, Ts1)))),
<a name="142"/>  142: 		       %% Test parsing and printing strings.
<a name="143"/>  143: 		       S1 = V1s ++ &quot;\327&quot; ++ A1s ++ &quot;\250&quot; ++ A2s,
<a name="144"/>  144: 		       S1s = &quot;\&quot;&quot; ++ S1 ++ &quot;\&quot;&quot;,
<a name="145"/>  145: 		       {ok,Ts2,_} = erl_scan_string(S1s),
<a name="146"/>  146: 		       S1 = element(3, nth(1, Ts2)),
<a name="147"/>  147: 		       S1s = flatten(print(element(3, nth(1, Ts2)))),
<a name="148"/>  148: 		       ok				%It all worked
<a name="149"/>  149: 		   end of
<a name="150"/>  150: 	    {'EXIT',R} -&gt;				%Something went wrong!
<a name="151"/>  151: 		{error,R};
<a name="152"/>  152: 	    ok -&gt; ok				%Aok
<a name="153"/>  153: 	end.
<a name="154"/>  154: 
<a name="155"/>  155: <i>%% OTP-7810. White spaces, comments, and more...</i>
<a name="otp_7810-1"/><a name="156"/>  156: <b>otp_7810</b>(Config) when is_list(Config) -&gt;
<a name="157"/>  157:     ok = reserved_words(),
<a name="158"/>  158:     ok = atoms(),
<a name="159"/>  159:     ok = punctuations(),
<a name="160"/>  160:     ok = comments(),
<a name="161"/>  161:     ok = errors(),
<a name="162"/>  162:     ok = integers(),
<a name="163"/>  163:     ok = base_integers(),
<a name="164"/>  164:     ok = floats(),
<a name="165"/>  165:     ok = dots(),
<a name="166"/>  166:     ok = chars(),
<a name="167"/>  167:     ok = variables(),
<a name="168"/>  168:     ok = eof(),
<a name="169"/>  169:     ok = illegal(),
<a name="170"/>  170:     ok = crashes(),
<a name="171"/>  171: 
<a name="172"/>  172:     ok = options(),
<a name="173"/>  173:     ok = token_info(),
<a name="174"/>  174:     ok = column_errors(),
<a name="175"/>  175:     ok = white_spaces(),
<a name="176"/>  176: 
<a name="177"/>  177:     ok = unicode(),
<a name="178"/>  178: 
<a name="179"/>  179:     ok = more_chars(),
<a name="180"/>  180:     ok = more_options(),
<a name="181"/>  181:     ok = anno_info(),
<a name="182"/>  182: 
<a name="otp_7810-last_expr"/><a name="183"/>  183:     ok.
<a name="184"/>  184: 
<a name="reserved_words-0"/><a name="185"/>  185: <b>reserved_words</b>() -&gt;
<a name="186"/>  186:     L = ['after', 'begin', 'case', 'try', 'cond', 'catch',
<a name="187"/>  187:          'andalso', 'orelse', 'end', 'fun', 'if', 'let', 'of',
<a name="188"/>  188:          'receive', 'when', 'bnot', 'not', 'div',
<a name="189"/>  189:          'rem', 'band', 'and', 'bor', 'bxor', 'bsl', 'bsr',
<a name="190"/>  190:          'or', 'xor'],
<a name="191"/>  191:     [begin
<a name="192"/>  192:          {RW, true} = {RW, erl_scan:reserved_word(RW)},
<a name="193"/>  193:          S = atom_to_list(RW),
<a name="194"/>  194:          Ts = [{RW,{1,1}}],
<a name="195"/>  195:          test_string(S, Ts)
<a name="196"/>  196:      end || RW &lt;- L],
<a name="reserved_words-last_expr"/><a name="197"/>  197:     ok.
<a name="198"/>  198: 
<a name="199"/>  199: 
<a name="atoms-0"/><a name="200"/>  200: <b>atoms</b>() -&gt;
<a name="201"/>  201:     test_string(&quot;a
<a name="202"/>  202:                  b&quot;, [{atom,{1,1},a},{atom,{2,18},b}]),
<a name="203"/>  203:     test_string(&quot;'a b'&quot;, [{atom,{1,1},'a b'}]),
<a name="204"/>  204: 		test_string(&quot;a&quot;, [{atom,{1,1},a}]),
<a name="205"/>  205: 		test_string(&quot;a@2&quot;, [{atom,{1,1},a@2}]),
<a name="206"/>  206: 		test_string([39,65,200,39], [{atom,{1,1},'AÈ'}]),
<a name="207"/>  207: 		test_string(&quot;ärlig östen&quot;, [{atom,{1,1},ärlig},{atom,{1,7},östen}]),
<a name="208"/>  208: 		{ok,[{atom,_,'$a'}],{1,6}} =
<a name="209"/>  209: 		    erl_scan_string(&quot;'$\\a'&quot;, {1,1}),
<a name="210"/>  210: 		test(&quot;'$\\a'&quot;),
<a name="atoms-last_expr"/><a name="211"/>  211: 		ok.
<a name="212"/>  212: 
<a name="punctuations-0"/><a name="213"/>  213: <b>punctuations</b>() -&gt;
<a name="214"/>  214:     L = [&quot;&lt;&lt;&quot;, &quot;&lt;-&quot;, &quot;&lt;=&quot;, &quot;&lt;&quot;, &quot;&gt;&gt;&quot;, &quot;&gt;=&quot;, &quot;&gt;&quot;, &quot;-&gt;&quot;, &quot;--&quot;,
<a name="215"/>  215:          &quot;-&quot;, &quot;++&quot;, &quot;+&quot;, &quot;=:=&quot;, &quot;=/=&quot;, &quot;=&lt;&quot;, &quot;=&gt;&quot;, &quot;==&quot;, &quot;=&quot;, &quot;/=&quot;,
<a name="216"/>  216:          &quot;/&quot;, &quot;||&quot;, &quot;|&quot;, &quot;:=&quot;, &quot;::&quot;, &quot;:&quot;],
<a name="217"/>  217:     %% One token at a time:
<a name="218"/>  218:     [begin
<a name="219"/>  219:          W = list_to_atom(S),
<a name="220"/>  220:          Ts = [{W,{1,1}}],
<a name="221"/>  221:          test_string(S, Ts)
<a name="222"/>  222:      end || S &lt;- L],
<a name="223"/>  223:     Three = [&quot;/=:=&quot;, &quot;&lt;=:=&quot;, &quot;==:=&quot;, &quot;&gt;=:=&quot;], % three tokens...
<a name="224"/>  224:     No = Three ++ L,
<a name="225"/>  225:     SL0 = [{S1++S2,{-length(S1),S1,S2}} ||
<a name="226"/>  226:               S1 &lt;- L,
<a name="227"/>  227:               S2 &lt;- L,
<a name="228"/>  228:               not lists:member(S1++S2, No)],
<a name="229"/>  229:     SL = family_list(SL0),
<a name="230"/>  230:     %% Two tokens. When there are several answers, the one with
<a name="231"/>  231:     %% the longest first token is chosen:
<a name="232"/>  232:     %% [the special case &quot;=&lt;&lt;&quot; is among the tested ones]
<a name="233"/>  233:     [begin
<a name="234"/>  234:          W1 = list_to_atom(S1),
<a name="235"/>  235:          W2 = list_to_atom(S2),
<a name="236"/>  236:          Ts = [{W1,{1,1}},{W2,{1,-L2+1}}],
<a name="237"/>  237:          test_string(S, Ts)
<a name="238"/>  238:      end || {S,[{L2,S1,S2}|_]}  &lt;- SL],
<a name="239"/>  239: 
<a name="240"/>  240:     PTs1 = [{'!',{1,1}},{'(',{1,2}},{')',{1,3}},{',',{1,4}},{';',{1,5}},
<a name="241"/>  241:             {'=',{1,6}},{'[',{1,7}},{']',{1,8}},{'{',{1,9}},{'|',{1,10}},
<a name="242"/>  242:             {'}',{1,11}}],
<a name="243"/>  243:     test_string(&quot;!(),;=[]{|}&quot;, PTs1),
<a name="244"/>  244: 
<a name="245"/>  245:     PTs2 = [{'#',{1,1}},{'&amp;',{1,2}},{'*',{1,3}},{'+',{1,4}},{'/',{1,5}},
<a name="246"/>  246:             {':',{1,6}},{'&lt;',{1,7}},{'&gt;',{1,8}},{'?',{1,9}},{'@',{1,10}},
<a name="247"/>  247:             {'\\',{1,11}},{'^',{1,12}},{'`',{1,13}},{'~',{1,14}}],
<a name="248"/>  248:     test_string(&quot;#&amp;*+/:&lt;&gt;?@\\^`~&quot;, PTs2),
<a name="249"/>  249: 
<a name="250"/>  250:     test_string(&quot;.. &quot;, [{'..',{1,1}}]),
<a name="251"/>  251:     test_string(&quot;1 .. 2&quot;,
<a name="252"/>  252:                 [{integer,{1,1},1},{'..',{1,3}},{integer,{1,6},2}]),
<a name="253"/>  253:     test_string(&quot;...&quot;, [{'...',{1,1}}]),
<a name="punctuations-last_expr"/><a name="254"/>  254:     ok.
<a name="255"/>  255: 
<a name="comments-0"/><a name="256"/>  256: <b>comments</b>() -&gt;
<a name="257"/>  257:     test(&quot;a %%\n b&quot;),
<a name="258"/>  258:     {ok,[],1} = erl_scan_string(&quot;%&quot;),
<a name="259"/>  259:     test(&quot;a %%\n b&quot;),
<a name="260"/>  260:     {ok,[{atom,{1,1},a},{atom,{2,2},b}],{2,3}} =
<a name="261"/>  261:         erl_scan_string(&quot;a %%\n b&quot;, {1,1}),
<a name="262"/>  262:     {ok,[{atom,{1,1},a},{comment,{1,3},&quot;%%&quot;},{atom,{2,2},b}],{2,3}} =
<a name="263"/>  263:         erl_scan_string(&quot;a %%\n b&quot;,{1,1}, [return_comments]),
<a name="264"/>  264:     {ok,[{atom,{1,1},a},
<a name="265"/>  265:          {white_space,{1,2},&quot; &quot;},
<a name="266"/>  266:          {white_space,{1,5},&quot;\n &quot;},
<a name="267"/>  267:          {atom,{2,2},b}],
<a name="268"/>  268:      {2,3}} =
<a name="269"/>  269:         erl_scan_string(&quot;a %%\n b&quot;,{1,1},[return_white_spaces]),
<a name="270"/>  270:     {ok,[{atom,{1,1},a},
<a name="271"/>  271:          {white_space,{1,2},&quot; &quot;},
<a name="272"/>  272:          {comment,{1,3},&quot;%%&quot;},
<a name="273"/>  273:          {white_space,{1,5},&quot;\n &quot;},
<a name="274"/>  274:          {atom,{2,2},b}],
<a name="275"/>  275:      {2,3}} = erl_scan_string(&quot;a %%\n b&quot;,{1,1},[return]),
<a name="comments-last_expr"/><a name="276"/>  276:     ok.
<a name="277"/>  277: 
<a name="errors-0"/><a name="278"/>  278: <b>errors</b>() -&gt;
<a name="279"/>  279:     {error,{1,erl_scan,{string,$',&quot;qa&quot;}},1} = erl_scan:string(&quot;'qa&quot;), %'
<a name="280"/>  280:     {error,{{1,1},erl_scan,{string,$',&quot;qa&quot;}},{1,4}} = %'
<a name="281"/>  281:         erl_scan:string(&quot;'qa&quot;, {1,1}, []), %'
<a name="282"/>  282:     {error,{1,erl_scan,{string,$&quot;,&quot;str&quot;}},1} = %&quot;
<a name="283"/>  283:         erl_scan:string(&quot;\&quot;str&quot;), %&quot;
<a name="284"/>  284:     {error,{{1,1},erl_scan,{string,$&quot;,&quot;str&quot;}},{1,5}} = %&quot;
<a name="285"/>  285:         erl_scan:string(&quot;\&quot;str&quot;, {1,1}, []), %&quot;
<a name="286"/>  286:     {error,{1,erl_scan,char},1} = erl_scan:string(&quot;$&quot;),
<a name="287"/>  287:     {error,{{1,1},erl_scan,char},{1,2}} = erl_scan:string(&quot;$&quot;, {1,1}, []),
<a name="288"/>  288:     test_string([34,65,200,34], [{string,{1,1},&quot;AÈ&quot;}]),
<a name="289"/>  289:     test_string(&quot;\\&quot;, [{'\\',{1,1}}]),
<a name="290"/>  290:     {'EXIT',_} =
<a name="291"/>  291:         (catch {foo, erl_scan:string('$\\a', {1,1})}), % type error
<a name="292"/>  292:     {'EXIT',_} =
<a name="293"/>  293:         (catch {foo, erl_scan:tokens([], '$\\a', {1,1})}), % type error
<a name="294"/>  294: 
<a name="295"/>  295:     &quot;{a,tuple}&quot; = erl_scan:format_error({a,tuple}),
<a name="errors-last_expr"/><a name="296"/>  296:     ok.
<a name="297"/>  297: 
<a name="integers-0"/><a name="298"/>  298: <b>integers</b>() -&gt;
<a name="299"/>  299:     [begin
<a name="300"/>  300:          I = list_to_integer(S),
<a name="301"/>  301:          Ts = [{integer,{1,1},I}],
<a name="302"/>  302:          test_string(S, Ts)
<a name="303"/>  303:      end || S &lt;- [[N] || N &lt;- lists:seq($0, $9)] ++ [&quot;2323&quot;,&quot;000&quot;] ],
<a name="304"/>  304:     UnderscoreSamples =
<a name="305"/>  305:         [{&quot;123_456&quot;, 123456},
<a name="306"/>  306:          {&quot;123_456_789&quot;, 123456789},
<a name="307"/>  307:          {&quot;1_2&quot;, 12}],
<a name="308"/>  308:     lists:foreach(
<a name="309"/>  309:          fun({S, I}) -&gt;
<a name="310"/>  310:                  test_string(S, [{integer, {1, 1}, I}])
<a name="311"/>  311:          end, UnderscoreSamples),
<a name="312"/>  312:     UnderscoreErrors =
<a name="313"/>  313:         [&quot;123_&quot;,
<a name="314"/>  314:          &quot;123__&quot;,
<a name="315"/>  315:          &quot;123_456_&quot;,
<a name="316"/>  316:          &quot;123__456&quot;,
<a name="317"/>  317:          &quot;_123&quot;,
<a name="318"/>  318:          &quot;__123&quot;],
<a name="319"/>  319:     lists:foreach(
<a name="320"/>  320:       fun(S) -&gt;
<a name="321"/>  321:               case erl_scan:string(S) of
<a name="322"/>  322:                   {ok, [{integer, _, _}], _} -&gt;
<a name="323"/>  323:                       error({unexpected_integer, S});
<a name="324"/>  324:                   _ -&gt;
<a name="325"/>  325:                       ok
<a name="326"/>  326:               end
<a name="327"/>  327:       end, UnderscoreErrors),
<a name="328"/>  328:     test_string(&quot;_123&quot;, [{var,{1,1},'_123'}]),
<a name="329"/>  329:     test_string(&quot;123_&quot;, [{integer,{1,1},123},{var,{1,4},'_'}]),
<a name="integers-last_expr"/><a name="330"/>  330:     ok.
<a name="331"/>  331: 
<a name="base_integers-0"/><a name="332"/>  332: <b>base_integers</b>() -&gt;
<a name="333"/>  333:     [begin
<a name="334"/>  334:          B = list_to_integer(BS),
<a name="335"/>  335:          I = erlang:list_to_integer(S, B),
<a name="336"/>  336:          Ts = [{integer,{1,1},I}],
<a name="337"/>  337:          test_string(BS++&quot;#&quot;++S, Ts)
<a name="338"/>  338:      end || {BS,S} &lt;- [{&quot;2&quot;,&quot;11&quot;}, {&quot;5&quot;,&quot;23234&quot;}, {&quot;12&quot;,&quot;05a&quot;},
<a name="339"/>  339:                        {&quot;16&quot;,&quot;abcdef&quot;}, {&quot;16&quot;,&quot;ABCDEF&quot;}] ],
<a name="340"/>  340: 
<a name="341"/>  341:     {error,{1,erl_scan,{base,1}},1} = erl_scan:string(&quot;1#000&quot;),
<a name="342"/>  342:     {error,{{1,1},erl_scan,{base,1}},{1,2}} =
<a name="343"/>  343:         erl_scan:string(&quot;1#000&quot;, {1,1}, []),
<a name="344"/>  344: 
<a name="345"/>  345:     {error,{1,erl_scan,{base,1}},1} = erl_scan:string(&quot;1#000&quot;),
<a name="346"/>  346:     {error,{{1,1},erl_scan,{base,1000}},{1,6}} =
<a name="347"/>  347:         erl_scan:string(&quot;1_000#000&quot;, {1,1}, []),
<a name="348"/>  348: 
<a name="349"/>  349:     test_string(&quot;12#bc&quot;, [{integer,{1,1},11},{atom,{1,5},c}]),
<a name="350"/>  350: 
<a name="351"/>  351:     [begin
<a name="352"/>  352:          Str = BS ++ &quot;#&quot; ++ S,
<a name="353"/>  353:          E = 2 + length(BS),
<a name="354"/>  354:          {error,{{1,1},erl_scan,{illegal,integer}},{1,E}} =
<a name="355"/>  355:              erl_scan:string(Str, {1,1}, [])
<a name="356"/>  356:      end || {BS,S} &lt;- [{&quot;3&quot;,&quot;3&quot;},{&quot;15&quot;,&quot;f&quot;},{&quot;12&quot;,&quot;c&quot;},
<a name="357"/>  357:                        {&quot;1_5&quot;,&quot;f&quot;},{&quot;1_2&quot;,&quot;c&quot;}] ],
<a name="358"/>  358: 
<a name="359"/>  359:     {ok,[{integer,1,239},{'@',1}],1} = erl_scan_string(&quot;16#ef@&quot;),
<a name="360"/>  360:     {ok,[{integer,{1,1},239},{'@',{1,6}}],{1,7}} =
<a name="361"/>  361:         erl_scan_string(&quot;16#ef@&quot;, {1,1}, []),
<a name="362"/>  362:     {ok,[{integer,{1,1},14},{atom,{1,5},g@}],{1,7}} =
<a name="363"/>  363:         erl_scan_string(&quot;16#eg@&quot;, {1,1}, []),
<a name="364"/>  364: 
<a name="365"/>  365:     UnderscoreSamples =
<a name="366"/>  366:         [{&quot;16#1234_ABCD_EF56&quot;, 16#1234abcdef56},
<a name="367"/>  367:          {&quot;2#0011_0101_0011&quot;, 2#001101010011},
<a name="368"/>  368:          {&quot;1_6#123ABC&quot;, 16#123abc},
<a name="369"/>  369:          {&quot;1_6#123_ABC&quot;, 16#123abc},
<a name="370"/>  370:          {&quot;16#abcdef&quot;, 16#ABCDEF}],
<a name="371"/>  371:     lists:foreach(
<a name="372"/>  372:          fun({S, I}) -&gt;
<a name="373"/>  373:                  test_string(S, [{integer, {1, 1}, I}])
<a name="374"/>  374:          end, UnderscoreSamples),
<a name="375"/>  375:     UnderscoreErrors =
<a name="376"/>  376:         [&quot;16_#123ABC&quot;,
<a name="377"/>  377:          &quot;16#123_&quot;,
<a name="378"/>  378:          &quot;16#_123&quot;,
<a name="379"/>  379:          &quot;16#ABC_&quot;,
<a name="380"/>  380:          &quot;16#_ABC&quot;,
<a name="381"/>  381:          &quot;2#_0101&quot;,
<a name="382"/>  382:          &quot;1__6#ABC&quot;,
<a name="383"/>  383:          &quot;16#AB__CD&quot;],
<a name="384"/>  384:     lists:foreach(
<a name="385"/>  385:       fun(S) -&gt;
<a name="386"/>  386:               case erl_scan:string(S) of
<a name="387"/>  387:                   {ok, [{integer, _, _}], _} -&gt;
<a name="388"/>  388:                       error({unexpected_integer, S});
<a name="389"/>  389:                   _ -&gt;
<a name="390"/>  390:                       ok
<a name="391"/>  391:               end
<a name="392"/>  392:       end, UnderscoreErrors),
<a name="393"/>  393:     test_string(&quot;16#123_&quot;, [{integer,{1,1},291},{var,{1,7},'_'}]),
<a name="394"/>  394:     test_string(&quot;_16#ABC&quot;, [{var,{1,1},'_16'},{'#',{1,4}},{var,{1,5},'ABC'}]),
<a name="base_integers-last_expr"/><a name="395"/>  395:     ok.
<a name="396"/>  396: 
<a name="floats-0"/><a name="397"/>  397: <b>floats</b>() -&gt;
<a name="398"/>  398:     [begin
<a name="399"/>  399:          F = list_to_float(FS),
<a name="400"/>  400:          Ts = [{float,{1,1},F}],
<a name="401"/>  401:          test_string(FS, Ts)
<a name="402"/>  402:      end || FS &lt;- [&quot;1.0&quot;,&quot;001.17&quot;,&quot;3.31200&quot;,&quot;1.0e0&quot;,&quot;1.0E17&quot;,
<a name="403"/>  403:                    &quot;34.21E-18&quot;, &quot;17.0E+14&quot;]],
<a name="404"/>  404:     test_string(&quot;1.e2&quot;, [{integer,{1,1},1},{'.',{1,2}},{atom,{1,3},e2}]),
<a name="405"/>  405: 
<a name="406"/>  406:     {error,{1,erl_scan,{illegal,float}},1} =
<a name="407"/>  407:         erl_scan:string(&quot;1.0e400&quot;),
<a name="408"/>  408:     {error,{{1,1},erl_scan,{illegal,float}},{1,8}} =
<a name="409"/>  409:         erl_scan:string(&quot;1.0e400&quot;, {1,1}, []),
<a name="410"/>  410:     {error,{{1,1},erl_scan,{illegal,float}},{1,9}} =
<a name="411"/>  411:         erl_scan:string(&quot;1.0e4_00&quot;, {1,1}, []),
<a name="412"/>  412:     [begin
<a name="413"/>  413:          {error,{1,erl_scan,{illegal,float}},1} = erl_scan:string(S),
<a name="414"/>  414:          {error,{{1,1},erl_scan,{illegal,float}},{1,_}} =
<a name="415"/>  415:              erl_scan:string(S, {1,1}, [])
<a name="416"/>  416:      end || S &lt;- [&quot;1.14Ea&quot;]],
<a name="417"/>  417: 
<a name="418"/>  418:     UnderscoreSamples =
<a name="419"/>  419:         [{&quot;123_456.789&quot;, 123456.789},
<a name="420"/>  420:          {&quot;123.456_789&quot;, 123.456789},
<a name="421"/>  421:          {&quot;1.2_345e10&quot;, 1.2345e10},
<a name="422"/>  422:          {&quot;1.234e1_06&quot;, 1.234e106},
<a name="423"/>  423:          {&quot;12_34.56_78e1_6&quot;, 1234.5678e16},
<a name="424"/>  424:          {&quot;12_34.56_78e-1_8&quot;, 1234.5678e-18}],
<a name="425"/>  425:     lists:foreach(
<a name="426"/>  426:          fun({S, I}) -&gt;
<a name="427"/>  427:                  test_string(S, [{float, {1, 1}, I}])
<a name="428"/>  428:          end, UnderscoreSamples),
<a name="429"/>  429:     UnderscoreErrors =
<a name="430"/>  430:         [&quot;123_.456&quot;,
<a name="431"/>  431:          &quot;123._456&quot;,
<a name="432"/>  432:          &quot;123.456_&quot;,
<a name="433"/>  433:          &quot;123._&quot;,
<a name="434"/>  434:          &quot;1._23e10&quot;,
<a name="435"/>  435:          &quot;1.23e_10&quot;,
<a name="436"/>  436:          &quot;1.23e10_&quot;],
<a name="437"/>  437:     lists:foreach(
<a name="438"/>  438:       fun(S) -&gt;
<a name="439"/>  439:               case erl_scan:string(S) of
<a name="440"/>  440:                   {ok, [{float, _, _}], _} -&gt;
<a name="441"/>  441:                       error({unexpected_float, S});
<a name="442"/>  442:                   _ -&gt;
<a name="443"/>  443:                       ok
<a name="444"/>  444:               end
<a name="445"/>  445:       end, UnderscoreErrors),
<a name="446"/>  446:     test_string(&quot;123._&quot;, [{integer,{1,1},123},{'.',{1,4}},{var,{1,5},'_'}]),
<a name="447"/>  447:     test_string(&quot;1.23_e10&quot;, [{float,{1,1},1.23},{var,{1,5},'_e10'}]),
<a name="floats-last_expr"/><a name="448"/>  448:     ok.
<a name="449"/>  449: 
<a name="dots-0"/><a name="450"/>  450: <b>dots</b>() -&gt;
<a name="451"/>  451:     Dot = [{&quot;.&quot;,    {ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,2}}},
<a name="452"/>  452:            {&quot;. &quot;,   {ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,3}}},
<a name="453"/>  453:            {&quot;.\n&quot;,  {ok,[{dot,1}],2}, {ok,[{dot,{1,1}}],{2,1}}},
<a name="454"/>  454:            {&quot;.%&quot;,   {ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,3}}},
<a name="455"/>  455:            {&quot;.\210&quot;,{ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,3}}},
<a name="456"/>  456:            {&quot;.% öh&quot;,{ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,6}}},
<a name="457"/>  457:            {&quot;.%\n&quot;, {ok,[{dot,1}],2}, {ok,[{dot,{1,1}}],{2,1}}},
<a name="458"/>  458:            {&quot;.$&quot;,   {error,{1,erl_scan,char},1},
<a name="459"/>  459: 	    {error,{{1,2},erl_scan,char},{1,3}}},
<a name="460"/>  460:            {&quot;.$\\&quot;, {error,{1,erl_scan,char},1},
<a name="461"/>  461:                     {error,{{1,2},erl_scan,char},{1,4}}},
<a name="462"/>  462:            {&quot;.a&quot;,   {ok,[{'.',1},{atom,1,a}],1},
<a name="463"/>  463: 	    {ok,[{'.',{1,1}},{atom,{1,2},a}],{1,3}}}
<a name="464"/>  464:           ],
<a name="465"/>  465:     [begin
<a name="466"/>  466:          R = erl_scan_string(S),
<a name="467"/>  467:          R2 = erl_scan_string(S, {1,1}, [])
<a name="468"/>  468:      end || {S, R, R2} &lt;- Dot],
<a name="469"/>  469: 
<a name="470"/>  470:     {ok,[{dot,_}=T1],{1,2}} = erl_scan:string(&quot;.&quot;, {1,1}, text),
<a name="471"/>  471:     [1, 1, &quot;.&quot;] = token_info(T1),
<a name="472"/>  472:     {ok,[{dot,_}=T2],{1,3}} = erl_scan:string(&quot;.%&quot;, {1,1}, text),
<a name="473"/>  473:     [1, 1, &quot;.&quot;] = token_info(T2),
<a name="474"/>  474:     {ok,[{dot,_}=T3],{1,6}} =
<a name="475"/>  475:         erl_scan:string(&quot;.% öh&quot;, {1,1}, text),
<a name="476"/>  476:     [1, 1, &quot;.&quot;] = token_info(T3),
<a name="477"/>  477:     {error,{{1,2},erl_scan,char},{1,3}} = erl_scan:string(&quot;.$&quot;, {1,1}),
<a name="478"/>  478:     {error,{{1,2},erl_scan,char},{1,4}} = erl_scan:string(&quot;.$\\&quot;, {1,1}),
<a name="479"/>  479: 
<a name="480"/>  480:     test_string(&quot;. &quot;, [{dot,{1,1}}]),
<a name="481"/>  481:     test_string(&quot;.  &quot;, [{dot,{1,1}}]),
<a name="482"/>  482:     test_string(&quot;.\n&quot;, [{dot,{1,1}}]),
<a name="483"/>  483:     test_string(&quot;.\n\n&quot;, [{dot,{1,1}}]),
<a name="484"/>  484:     test_string(&quot;.\n\r&quot;, [{dot,{1,1}}]),
<a name="485"/>  485:     test_string(&quot;.\n\n\n&quot;, [{dot,{1,1}}]),
<a name="486"/>  486:     test_string(&quot;.\210&quot;, [{dot,{1,1}}]),
<a name="487"/>  487:     test_string(&quot;.%\n&quot;, [{dot,{1,1}}]),
<a name="488"/>  488:     test_string(&quot;.a&quot;, [{'.',{1,1}},{atom,{1,2},a}]),
<a name="489"/>  489: 
<a name="490"/>  490:     test_string(&quot;%. \n. &quot;, [{dot,{2,1}}]),
<a name="491"/>  491:     {more,C} = erl_scan:tokens([], &quot;%. &quot;,{1,1}, return),
<a name="492"/>  492:     {done,{ok,[{comment,{1,1},&quot;%. &quot;},
<a name="493"/>  493:                {white_space,{1,4},&quot;\n&quot;},
<a name="494"/>  494:                {dot,{2,1}}],
<a name="495"/>  495:            {2,3}}, &quot;&quot;} =
<a name="496"/>  496:         erl_scan_tokens(C, &quot;\n. &quot;, {1,1}, return), % any loc, any options
<a name="497"/>  497: 
<a name="498"/>  498:     [test_string(S, R) ||
<a name="499"/>  499:         {S, R} &lt;- [{&quot;.$\n&quot;,   [{'.',{1,1}},{char,{1,2},$\n}]},
<a name="500"/>  500:                    {&quot;$\\\n&quot;,  [{char,{1,1},$\n}]},
<a name="501"/>  501:                    {&quot;'\\\n'&quot;, [{atom,{1,1},'\n'}]},
<a name="502"/>  502:                    {&quot;$\n&quot;,    [{char,{1,1},$\n}]}] ],
<a name="dots-last_expr"/><a name="503"/>  503:     ok.
<a name="504"/>  504: 
<a name="chars-0"/><a name="505"/>  505: <b>chars</b>() -&gt;
<a name="506"/>  506:     [begin
<a name="507"/>  507:          L = lists:flatten(io_lib:format(&quot;$\\~.8b&quot;, [C])),
<a name="508"/>  508:          Ts = [{char,{1,1},C}],
<a name="509"/>  509:          test_string(L, Ts)
<a name="510"/>  510:      end || C &lt;- lists:seq(0, 255)],
<a name="511"/>  511: 
<a name="512"/>  512:     %% Leading zeroes...
<a name="513"/>  513:     [begin
<a name="514"/>  514:          L = lists:flatten(io_lib:format(&quot;$\\~3.8.0b&quot;, [C])),
<a name="515"/>  515:          Ts = [{char,{1,1},C}],
<a name="516"/>  516:          test_string(L, Ts)
<a name="517"/>  517:      end || C &lt;- lists:seq(0, 255)],
<a name="518"/>  518: 
<a name="519"/>  519:     %% GH-6477. Test legal use of caret notation.
<a name="520"/>  520:     [begin
<a name="521"/>  521:          L = &quot;$\\^&quot; ++ [C],
<a name="522"/>  522:          Ts = case C of
<a name="523"/>  523:                   $? -&gt;
<a name="524"/>  524:                       [{char,{1,1},127}];
<a name="525"/>  525:                   _ -&gt;
<a name="526"/>  526:                       [{char,{1,1},C band 2#11111}]
<a name="527"/>  527:               end,
<a name="528"/>  528:          test_string(L, Ts)
<a name="529"/>  529:      end || C &lt;- lists:seq($?, $Z) ++ lists:seq($a, $z)],
<a name="530"/>  530: 
<a name="531"/>  531:     [begin
<a name="532"/>  532:          L = &quot;$\\&quot; ++ [C],
<a name="533"/>  533:          Ts = [{char,{1,1},V}],
<a name="534"/>  534:          test_string(L, Ts)
<a name="535"/>  535:      end || {C,V} &lt;- [{$n,$\n}, {$r,$\r}, {$t,$\t}, {$v,$\v},
<a name="536"/>  536:                       {$b,$\b}, {$f,$\f}, {$e,$\e}, {$s,$\s},
<a name="537"/>  537:                       {$d,$\d}]],
<a name="538"/>  538: 
<a name="539"/>  539:     EC = [$\n,$\r,$\t,$\v,$\b,$\f,$\e,$\s,$\d],
<a name="540"/>  540:     Ds = lists:seq($0, $9),
<a name="541"/>  541:     X = [$^,$n,$r,$t,$v,$b,$f,$e,$s,$d],
<a name="542"/>  542:     New = [${,$x],
<a name="543"/>  543:     No = EC ++ Ds ++ X ++ New,
<a name="544"/>  544:     [begin
<a name="545"/>  545:          L = &quot;$\\&quot; ++ [C],
<a name="546"/>  546:          Ts = [{char,{1,1},C}],
<a name="547"/>  547:          test_string(L, Ts)
<a name="548"/>  548:      end || C &lt;- lists:seq(0, 255) -- No],
<a name="549"/>  549: 
<a name="550"/>  550:     [begin
<a name="551"/>  551:          L = &quot;'$\\&quot; ++ [C] ++ &quot;'&quot;,
<a name="552"/>  552:          Ts = [{atom,{1,1},list_to_atom(&quot;$&quot;++[C])}],
<a name="553"/>  553:          test_string(L, Ts)
<a name="554"/>  554:      end || C &lt;- lists:seq(0, 255) -- No],
<a name="555"/>  555: 
<a name="556"/>  556:     test_string(&quot;\&quot;\\013a\\\n\&quot;&quot;, [{string,{1,1},&quot;\va\n&quot;}]),
<a name="557"/>  557: 
<a name="558"/>  558:     test_string(&quot;'\n'&quot;, [{atom,{1,1},'\n'}]),
<a name="559"/>  559:     test_string(&quot;\&quot;\n\a\&quot;&quot;, [{string,{1,1},&quot;\na&quot;}]),
<a name="560"/>  560: 
<a name="561"/>  561:     %% No escape
<a name="562"/>  562:     [begin
<a name="563"/>  563:          L = &quot;$&quot; ++ [C],
<a name="564"/>  564:          Ts = [{char,{1,1},C}],
<a name="565"/>  565:          test_string(L, Ts)
<a name="566"/>  566:      end || C &lt;- lists:seq(0, 255) -- (No ++ [$\\])],
<a name="567"/>  567:     test_string(&quot;$\n&quot;, [{char,{1,1},$\n}]),
<a name="568"/>  568: 
<a name="569"/>  569:     {error,{{1,1},erl_scan,char},{1,4}} =
<a name="570"/>  570:         erl_scan:string(&quot;$\\^&quot;,{1,1}),
<a name="571"/>  571:     test_string(&quot;$\\\n&quot;, [{char,{1,1},$\n}]),
<a name="572"/>  572:     %% Robert's scanner returns line 1:
<a name="573"/>  573:     test_string(&quot;$\\\n&quot;, [{char,{1,1},$\n}]),
<a name="574"/>  574:     test_string(&quot;$\n\n&quot;, [{char,{1,1},$\n}]),
<a name="575"/>  575:     test(&quot;$\n\n&quot;),
<a name="chars-last_expr"/><a name="576"/>  576:     ok.
<a name="577"/>  577: 
<a name="578"/>  578: 
<a name="variables-0"/><a name="579"/>  579: <b>variables</b>() -&gt;
<a name="580"/>  580:     test_string(&quot;     \237_Aouåeiyäö&quot;, [{var,{1,7},'_Aouåeiyäö'}]),
<a name="581"/>  581:     test_string(&quot;A_b_c@&quot;, [{var,{1,1},'A_b_c@'}]),
<a name="582"/>  582:     test_string(&quot;V@2&quot;, [{var,{1,1},'V@2'}]),
<a name="583"/>  583:     test_string(&quot;ABDÀ&quot;, [{var,{1,1},'ABDÀ'}]),
<a name="584"/>  584:     test_string(&quot;Ärlig Östen&quot;, [{var,{1,1},'Ärlig'},{var,{1,7},'Östen'}]),
<a name="variables-last_expr"/><a name="585"/>  585:     ok.
<a name="586"/>  586: 
<a name="eof-0"/><a name="587"/>  587: <b>eof</b>() -&gt;
<a name="588"/>  588:     {done,{eof,1},eof} = erl_scan:tokens([], eof, 1),
<a name="589"/>  589:     {more, C1} = erl_scan:tokens([],&quot;    \n&quot;, 1),
<a name="590"/>  590:     {done,{eof,2},eof} = erl_scan:tokens(C1, eof, 1),
<a name="591"/>  591:     {more, C2} = erl_scan:tokens([], &quot;abra&quot;, 1),
<a name="592"/>  592:     %% An error before R13A.
<a name="593"/>  593:     %% {done,Err={error,{1,erl_scan,scan},1},eof} =
<a name="594"/>  594:     {done,{ok,[{atom,1,abra}],1},eof} =
<a name="595"/>  595:         erl_scan_tokens(C2, eof, 1),
<a name="596"/>  596: 
<a name="597"/>  597:     %% With column.
<a name="598"/>  598:     {more, C3} = erl_scan:tokens([],&quot;    \n&quot;,{1,1}),
<a name="599"/>  599:     {done,{eof,{2,1}},eof} = erl_scan:tokens(C3, eof, 1),
<a name="600"/>  600:     {more, C4} = erl_scan:tokens([], &quot;abra&quot;, {1,1}),
<a name="601"/>  601:     %% An error before R13A.
<a name="602"/>  602:     %% {done,{error,{{1,1},erl_scan,scan},{1,5}},eof} =
<a name="603"/>  603:     {done,{ok,[{atom,_,abra}],{1,5}},eof} =
<a name="604"/>  604:         erl_scan_tokens(C4, eof, 1),
<a name="605"/>  605: 
<a name="606"/>  606:     %% Robert's scanner returns &quot;&quot; as LeftoverChars;
<a name="607"/>  607:     %% the R12B scanner returns eof as LeftoverChars: (eof is correct)
<a name="608"/>  608:     {more, C5} = erl_scan:tokens([], &quot;a&quot;, 1),
<a name="609"/>  609:     %% An error before R13A.
<a name="610"/>  610:     %% {done,{error,{1,erl_scan,scan},1},eof} =
<a name="611"/>  611:     {done,{ok,[{atom,1,a}],1},eof} =
<a name="612"/>  612:         erl_scan_tokens(C5,eof,1),
<a name="613"/>  613: 
<a name="614"/>  614:     %% With column.
<a name="615"/>  615:     {more, C6} = erl_scan:tokens([], &quot;a&quot;, {1,1}),
<a name="616"/>  616:     %% An error before R13A.
<a name="617"/>  617:     %% {done,{error,{1,erl_scan,scan},1},eof} =
<a name="618"/>  618:     {done,{ok,[{atom,{1,1},a}],{1,2}},eof} =
<a name="619"/>  619:         erl_scan_tokens(C6,eof,1),
<a name="620"/>  620: 
<a name="621"/>  621:     %% A dot followed by eof is special:
<a name="622"/>  622:     {more, C} = erl_scan:tokens([], &quot;a.&quot;, 1),
<a name="623"/>  623:     {done,{ok,[{atom,1,a},{dot,1}],1},eof} = erl_scan_tokens(C,eof,1),
<a name="624"/>  624:     {ok,[{atom,1,foo},{dot,1}],1} = erl_scan_string(&quot;foo.&quot;),
<a name="625"/>  625: 
<a name="626"/>  626:     %% With column.
<a name="627"/>  627:     {more, CCol} = erl_scan:tokens([], &quot;a.&quot;, {1,1}),
<a name="628"/>  628:     {done,{ok,[{atom,{1,1},a},{dot,{1,2}}],{1,3}},eof} =
<a name="629"/>  629:         erl_scan_tokens(CCol,eof,1),
<a name="630"/>  630:     {ok,[{atom,{1,1},foo},{dot,{1,4}}],{1,5}} =
<a name="631"/>  631:         erl_scan_string(&quot;foo.&quot;, {1,1}, []),
<a name="632"/>  632: 
<a name="eof-last_expr"/><a name="633"/>  633:     ok.
<a name="634"/>  634: 
<a name="illegal-0"/><a name="635"/>  635: <b>illegal</b>() -&gt;
<a name="636"/>  636:     Atom = lists:duplicate(1000, $a),
<a name="637"/>  637:     {error,{1,erl_scan,{illegal,atom}},1} = erl_scan:string(Atom),
<a name="638"/>  638:     {done,{error,{1,erl_scan,{illegal,atom}},1},&quot;. &quot;} =
<a name="639"/>  639:         erl_scan:tokens([], Atom++&quot;. &quot;, 1),
<a name="640"/>  640:     QAtom = &quot;'&quot; ++ Atom ++ &quot;'&quot;,
<a name="641"/>  641:     {error,{1,erl_scan,{illegal,atom}},1} = erl_scan:string(QAtom),
<a name="642"/>  642:     {done,{error,{1,erl_scan,{illegal,atom}},1},&quot;. &quot;} =
<a name="643"/>  643:         erl_scan:tokens([], QAtom++&quot;. &quot;, 1),
<a name="644"/>  644:     Var = lists:duplicate(1000, $A),
<a name="645"/>  645:     {error,{1,erl_scan,{illegal,var}},1} = erl_scan:string(Var),
<a name="646"/>  646:     {done,{error,{1,erl_scan,{illegal,var}},1},&quot;. &quot;} =
<a name="647"/>  647:         erl_scan:tokens([], Var++&quot;. &quot;, 1),
<a name="648"/>  648:     Float = &quot;1&quot; ++ lists:duplicate(400, $0) ++ &quot;.0&quot;,
<a name="649"/>  649:     {error,{1,erl_scan,{illegal,float}},1} = erl_scan:string(Float),
<a name="650"/>  650:     {done,{error,{1,erl_scan,{illegal,float}},1},&quot;. &quot;} =
<a name="651"/>  651:         erl_scan:tokens([], Float++&quot;. &quot;, 1),
<a name="652"/>  652:     String = &quot;\&quot;43\\x{aaaaaa}34\&quot;&quot;,
<a name="653"/>  653:     {error,{1,erl_scan,{illegal,character}},1} = erl_scan:string(String),
<a name="654"/>  654:     {done,{error,{1,erl_scan,{illegal,character}},1},&quot;34\&quot;. &quot;} =
<a name="655"/>  655:         %% Would be nice if `34\&quot;' were skipped...
<a name="656"/>  656:         %% Maybe, but then the LeftOverChars would not be the characters
<a name="657"/>  657:         %% immediately following the end location of the error.
<a name="658"/>  658:         erl_scan:tokens([], String++&quot;. &quot;, 1),
<a name="659"/>  659: 
<a name="660"/>  660:     {error,{{1,1},erl_scan,{illegal,atom}},{1,1001}} =
<a name="661"/>  661:         erl_scan:string(Atom, {1,1}),
<a name="662"/>  662:     {done,{error,{{1,5},erl_scan,{illegal,atom}},{1,1005}},&quot;. &quot;} =
<a name="663"/>  663:         erl_scan:tokens([], &quot;foo &quot;++Atom++&quot;. &quot;, {1,1}),
<a name="664"/>  664:     {error,{{1,1},erl_scan,{illegal,atom}},{1,1003}} =
<a name="665"/>  665:         erl_scan:string(QAtom, {1,1}),
<a name="666"/>  666:     {done,{error,{{1,5},erl_scan,{illegal,atom}},{1,1007}},&quot;. &quot;} =
<a name="667"/>  667:         erl_scan:tokens([], &quot;foo &quot;++QAtom++&quot;. &quot;, {1,1}),
<a name="668"/>  668:     {error,{{1,1},erl_scan,{illegal,var}},{1,1001}} =
<a name="669"/>  669:         erl_scan:string(Var, {1,1}),
<a name="670"/>  670:     {done,{error,{{1,5},erl_scan,{illegal,var}},{1,1005}},&quot;. &quot;} =
<a name="671"/>  671:         erl_scan:tokens([], &quot;foo &quot;++Var++&quot;. &quot;, {1,1}),
<a name="672"/>  672:     {error,{{1,1},erl_scan,{illegal,float}},{1,404}} =
<a name="673"/>  673:         erl_scan:string(Float, {1,1}),
<a name="674"/>  674:     {done,{error,{{1,5},erl_scan,{illegal,float}},{1,408}},&quot;. &quot;} =
<a name="675"/>  675:         erl_scan:tokens([], &quot;foo &quot;++Float++&quot;. &quot;, {1,1}),
<a name="676"/>  676:     {error,{{1,4},erl_scan,{illegal,character}},{1,14}} =
<a name="677"/>  677:         erl_scan:string(String, {1,1}),
<a name="678"/>  678:     {done,{error,{{1,4},erl_scan,{illegal,character}},{1,14}},&quot;34\&quot;. &quot;} =
<a name="679"/>  679:         erl_scan:tokens([], String++&quot;. &quot;, {1,1}),
<a name="680"/>  680: 
<a name="681"/>  681:     %% GH-6477. Test for illegal characters in caret notation.
<a name="682"/>  682:     _ = [begin
<a name="683"/>  683:              S = [$$,$\\,$^,C],
<a name="684"/>  684:              {error,{1,erl_scan,{illegal,character}},1} = erl_scan:string(S)
<a name="685"/>  685:          end || C &lt;- lists:seq(0, 16#3e) ++ [16#60] ++ lists:seq($z+1, 16#10ffff)],
<a name="illegal-last_expr"/><a name="686"/>  686:     ok.
<a name="687"/>  687: 
<a name="crashes-0"/><a name="688"/>  688: <b>crashes</b>() -&gt;
<a name="689"/>  689:     {'EXIT',_} = (catch {foo, erl_scan:string([-1])}), % type error
<a name="690"/>  690:     {'EXIT',_} = (catch erl_scan:string(&quot;'a&quot; ++ [999999999] ++ &quot;c'&quot;)),
<a name="691"/>  691: 
<a name="692"/>  692:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$&quot;++[-1])}),
<a name="693"/>  693:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$\\&quot;++[-1])}),
<a name="694"/>  694:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$\\^&quot;++[-1])}),
<a name="695"/>  695:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,-1,$&quot;],{1,1})}),
<a name="696"/>  696:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;\&quot;\\v&quot;++[-1,$&quot;])}), %$&quot;
<a name="697"/>  697:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,-1,$&quot;])}),
<a name="698"/>  698:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;% foo&quot;++[-1])}),
<a name="699"/>  699:     {'EXIT',_} =
<a name="700"/>  700:          (catch {foo, erl_scan:string(&quot;% foo&quot;++[-1],{1,1})}),
<a name="701"/>  701: 
<a name="702"/>  702:     {'EXIT',_} = (catch {foo, erl_scan:string([a])}), % type error
<a name="703"/>  703:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$&quot;++[a])}),
<a name="704"/>  704:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$\\&quot;++[a])}),
<a name="705"/>  705:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$\\^&quot;++[a])}),
<a name="706"/>  706:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,a,$&quot;],{1,1})}),
<a name="707"/>  707:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;\&quot;\\v&quot;++[a,$&quot;])}), %$&quot;
<a name="708"/>  708:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,a,$&quot;])}),
<a name="709"/>  709:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;% foo&quot;++[a])}),
<a name="710"/>  710:     {'EXIT',_} =
<a name="711"/>  711:          (catch {foo, erl_scan:string(&quot;% foo&quot;++[a],{1,1})}),
<a name="712"/>  712: 
<a name="713"/>  713:     {'EXIT',_} = (catch {foo, erl_scan:string([3.0])}), % type error
<a name="714"/>  714:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;A&quot; ++ [999999999])}),
<a name="715"/>  715: 
<a name="crashes-last_expr"/><a name="716"/>  716:     ok.
<a name="717"/>  717: 
<a name="options-0"/><a name="718"/>  718: <b>options</b>() -&gt;
<a name="719"/>  719:     %% line and column are not options, but tested here
<a name="720"/>  720:     {ok,[{atom,1,foo},{white_space,1,&quot; &quot;},{comment,1,&quot;% bar&quot;}], 1} =
<a name="721"/>  721:         erl_scan_string(&quot;foo % bar&quot;, 1, return),
<a name="722"/>  722:     {ok,[{atom,1,foo},{white_space,1,&quot; &quot;}],1} =
<a name="723"/>  723:         erl_scan_string(&quot;foo % bar&quot;, 1, return_white_spaces),
<a name="724"/>  724:     {ok,[{atom,1,foo},{comment,1,&quot;% bar&quot;}],1} =
<a name="725"/>  725:         erl_scan_string(&quot;foo % bar&quot;, 1, return_comments),
<a name="726"/>  726:     {ok,[{atom,17,foo}],17} =
<a name="727"/>  727:         erl_scan_string(&quot;foo % bar&quot;, 17),
<a name="728"/>  728:     {'EXIT',{function_clause,_}} =
<a name="729"/>  729:         (catch {foo,
<a name="730"/>  730:                 erl_scan:string(&quot;foo % bar&quot;, {a,1}, [])}), % type error
<a name="731"/>  731:     {ok,[{atom,_,foo}],{17,18}} =
<a name="732"/>  732:         erl_scan_string(&quot;foo % bar&quot;, {17,9}, []),
<a name="733"/>  733:     {'EXIT',{function_clause,_}} =
<a name="734"/>  734:         (catch {foo,
<a name="735"/>  735:                 erl_scan:string(&quot;foo % bar&quot;, {1,0}, [])}), % type error
<a name="736"/>  736:     {ok,[{foo,1}],1} =
<a name="737"/>  737:         erl_scan_string(&quot;foo % bar&quot;,1, [{reserved_word_fun,
<a name="738"/>  738:                                          fun(W) -&gt; W =:= foo end}]),
<a name="739"/>  739:     {'EXIT',{badarg,_}} =
<a name="740"/>  740:         (catch {foo,
<a name="741"/>  741:                 erl_scan:string(&quot;foo % bar&quot;,1, % type error
<a name="742"/>  742:                                 [{reserved_word_fun,
<a name="743"/>  743:                                   fun(W,_) -&gt; W =:= foo end}])}),
<a name="options-last_expr"/><a name="744"/>  744:     ok.
<a name="745"/>  745: 
<a name="more_options-0"/><a name="746"/>  746: <b>more_options</b>() -&gt;
<a name="747"/>  747:     {ok,[{atom,_,foo}=T1],{19,20}} =
<a name="748"/>  748:         erl_scan:string(&quot;foo&quot;, {19,17},[]),
<a name="749"/>  749:     {19,17} = erl_scan:location(T1),
<a name="750"/>  750:     {done,{ok,[{atom,_,foo}=T2,{dot,_}],{19,22}},[]} =
<a name="751"/>  751:         erl_scan:tokens([], &quot;foo. &quot;, {19,17}, [bad_opt]), % type error
<a name="752"/>  752:     {19,17} = erl_scan:location(T2),
<a name="753"/>  753:     {ok,[{atom,_,foo}=T3],{19,20}} =
<a name="754"/>  754:         erl_scan:string(&quot;foo&quot;, {19,17},[text]),
<a name="755"/>  755:     {19,17} = erl_scan:location(T3),
<a name="756"/>  756:     &quot;foo&quot; = erl_scan:text(T3),
<a name="757"/>  757: 
<a name="758"/>  758:     {ok,[{atom,_,foo}=T4],1} = erl_scan:string(&quot;foo&quot;, 1, [text]),
<a name="759"/>  759:     1 = erl_scan:line(T4),
<a name="760"/>  760:     1 = erl_scan:location(T4),
<a name="761"/>  761:     &quot;foo&quot; = erl_scan:text(T4),
<a name="762"/>  762: 
<a name="more_options-last_expr"/><a name="763"/>  763:     ok.
<a name="764"/>  764: 
<a name="token_info-0"/><a name="765"/>  765: <b>token_info</b>() -&gt;
<a name="766"/>  766:     {ok,[T1],_} = erl_scan:string(&quot;foo&quot;, {1,18}, [text]),
<a name="767"/>  767:     {'EXIT',{badarg,_}} =
<a name="768"/>  768:         (catch {foo, erl_scan:category(foo)}), % type error
<a name="769"/>  769:     {'EXIT',{badarg,_}} =
<a name="770"/>  770:         (catch {foo, erl_scan:symbol(foo)}), % type error
<a name="771"/>  771:     atom = erl_scan:category(T1),
<a name="772"/>  772:     foo = erl_scan:symbol(T1),
<a name="773"/>  773: 
<a name="774"/>  774:     {ok,[T2],_} = erl_scan:string(&quot;foo&quot;, 1, []),
<a name="775"/>  775:     1 = erl_scan:line(T2),
<a name="776"/>  776:     undefined = erl_scan:column(T2),
<a name="777"/>  777:     undefined = erl_scan:text(T2),
<a name="778"/>  778:     1 = erl_scan:location(T2),
<a name="779"/>  779: 
<a name="780"/>  780:     {ok,[T3],_} = erl_scan:string(&quot;=&quot;, 1, []),
<a name="781"/>  781:     '=' = erl_scan:category(T3),
<a name="782"/>  782:     '=' = erl_scan:symbol(T3),
<a name="token_info-last_expr"/><a name="783"/>  783:     ok.
<a name="784"/>  784: 
<a name="anno_info-0"/><a name="785"/>  785: <b>anno_info</b>() -&gt;
<a name="786"/>  786:     {'EXIT',_} =
<a name="787"/>  787:         (catch {foo,erl_scan:line(foo)}), % type error
<a name="788"/>  788:     {ok,[{atom,_,foo}=T0],_} = erl_scan:string(&quot;foo&quot;, 19, [text]),
<a name="789"/>  789:     19 = erl_scan:location(T0),
<a name="790"/>  790:     19 = erl_scan:end_location(T0),
<a name="791"/>  791: 
<a name="792"/>  792:     {ok,[{atom,_,foo}=T3],_} = erl_scan:string(&quot;foo&quot;, {1,3}, [text]),
<a name="793"/>  793:     1 = erl_scan:line(T3),
<a name="794"/>  794:     3 = erl_scan:column(T3),
<a name="795"/>  795:     {1,3} = erl_scan:location(T3),
<a name="796"/>  796:     {1,6} = erl_scan:end_location(T3),
<a name="797"/>  797:     &quot;foo&quot; = erl_scan:text(T3),
<a name="798"/>  798: 
<a name="799"/>  799:     {ok,[{atom,_,foo}=T4],_} = erl_scan:string(&quot;foo&quot;, 2, [text]),
<a name="800"/>  800:     2 = erl_scan:line(T4),
<a name="801"/>  801:     undefined = erl_scan:column(T4),
<a name="802"/>  802:     2 = erl_scan:location(T4),
<a name="803"/>  803:     &quot;foo&quot; = erl_scan:text(T4),
<a name="804"/>  804: 
<a name="805"/>  805:     {ok,[{atom,_,foo}=T5],_} = erl_scan:string(&quot;foo&quot;, {1,3}, []),
<a name="806"/>  806:     1 = erl_scan:line(T5),
<a name="807"/>  807:     3 = erl_scan:column(T5),
<a name="808"/>  808:     {1,3} = erl_scan:location(T5),
<a name="809"/>  809:     undefined = erl_scan:text(T5),
<a name="810"/>  810: 
<a name="anno_info-last_expr"/><a name="811"/>  811:     ok.
<a name="812"/>  812: 
<a name="column_errors-0"/><a name="813"/>  813: <b>column_errors</b>() -&gt;
<a name="814"/>  814:     {error,{{1,1},erl_scan,{string,$',&quot;&quot;}},{1,3}} = % $'
<a name="815"/>  815:         erl_scan:string(&quot;'\\&quot;,{1,1}),
<a name="816"/>  816:     {error,{{1,1},erl_scan,{string,$&quot;,&quot;&quot;}},{1,3}} = % $&quot;
<a name="817"/>  817:         erl_scan:string(&quot;\&quot;\\&quot;,{1,1}),
<a name="818"/>  818: 
<a name="819"/>  819:     {error,{{1,1},erl_scan,{string,$',&quot;&quot;}},{1,2}} =  % $'
<a name="820"/>  820:         erl_scan:string(&quot;'&quot;,{1,1}),
<a name="821"/>  821:     {error,{{1,1},erl_scan,{string,$&quot;,&quot;&quot;}},{1,2}} =  % $&quot;
<a name="822"/>  822:         erl_scan:string(&quot;\&quot;&quot;,{1,1}),
<a name="823"/>  823: 
<a name="824"/>  824:     {error,{{1,1},erl_scan,char},{1,2}} =
<a name="825"/>  825:         erl_scan:string(&quot;$&quot;,{1,1}),
<a name="826"/>  826: 
<a name="827"/>  827:     {error,{{1,2},erl_scan,{string,$',&quot;1234567890123456&quot;}},{1,20}} = %'
<a name="828"/>  828:         erl_scan:string(&quot; '12345678901234567&quot;, {1,1}),
<a name="829"/>  829:     {error,{{1,2},erl_scan,{string,$',&quot;123456789012345 &quot;}}, {1,20}} = %'
<a name="830"/>  830:         erl_scan:string(&quot; '123456789012345\\s&quot;, {1,1}),
<a name="831"/>  831:     {error,{{1,2},erl_scan,{string,$&quot;,&quot;1234567890123456&quot;}},{1,20}} = %&quot;
<a name="832"/>  832:         erl_scan:string(&quot; \&quot;12345678901234567&quot;, {1,1}),
<a name="833"/>  833:     {error,{{1,2},erl_scan,{string,$&quot;,&quot;123456789012345 &quot;}}, {1,20}} = %&quot;
<a name="834"/>  834:         erl_scan:string(&quot; \&quot;123456789012345\\s&quot;, {1,1}),
<a name="835"/>  835:     {error,{{1,2},erl_scan,{string,$',&quot;1234567890123456&quot;}},{2,1}} = %'
<a name="836"/>  836:         erl_scan:string(&quot; '12345678901234567\n&quot;, {1,1}),
<a name="column_errors-last_expr"/><a name="837"/>  837:     ok.
<a name="838"/>  838: 
<a name="white_spaces-0"/><a name="839"/>  839: <b>white_spaces</b>() -&gt;
<a name="840"/>  840:     {ok,[{white_space,_,&quot;\r&quot;},
<a name="841"/>  841:                {white_space,_,&quot;   &quot;},
<a name="842"/>  842:                {atom,_,a},
<a name="843"/>  843:                {white_space,_,&quot;\n&quot;}],
<a name="844"/>  844:            _} = erl_scan_string(&quot;\r   a\n&quot;, {1,1}, return),
<a name="845"/>  845:     test(&quot;\r   a\n&quot;),
<a name="846"/>  846:     L = &quot;{\&quot;a\nb\&quot;, \&quot;a\\nb\&quot;,\nabc\r,def}.\n\n&quot;,
<a name="847"/>  847:     {ok,[{'{',_},
<a name="848"/>  848:                {string,_,&quot;a\nb&quot;},
<a name="849"/>  849:                {',',_},
<a name="850"/>  850:                {white_space,_,&quot; &quot;},
<a name="851"/>  851:                {string,_,&quot;a\nb&quot;},
<a name="852"/>  852:                {',',_},
<a name="853"/>  853:                {white_space,_,&quot;\n&quot;},
<a name="854"/>  854:                {atom,_,abc},
<a name="855"/>  855:                {white_space,_,&quot;\r&quot;},
<a name="856"/>  856:                {',',_},
<a name="857"/>  857:                {atom,_,def},
<a name="858"/>  858:                {'}',_},
<a name="859"/>  859:                {dot,_},
<a name="860"/>  860:                {white_space,_,&quot;\n&quot;}],
<a name="861"/>  861:            _} = erl_scan_string(L, {1,1}, return),
<a name="862"/>  862:     test(L),
<a name="863"/>  863:     test(&quot;\&quot;\n\&quot;\n&quot;),
<a name="864"/>  864:     test(&quot;\n\r\n&quot;),
<a name="865"/>  865:     test(&quot;\n\r&quot;),
<a name="866"/>  866:     test(&quot;\r\n&quot;),
<a name="867"/>  867:     test(&quot;\n\f&quot;),
<a name="868"/>  868:     [test(lists:duplicate(N, $\t)) || N &lt;- lists:seq(1, 20)],
<a name="869"/>  869:     [test([$\n|lists:duplicate(N, $\t)]) || N &lt;- lists:seq(1, 20)],
<a name="870"/>  870:     [test(lists:duplicate(N, $\s)) || N &lt;- lists:seq(1, 20)],
<a name="871"/>  871:     [test([$\n|lists:duplicate(N, $\s)]) || N &lt;- lists:seq(1, 20)],
<a name="872"/>  872:     test(&quot;\v\f\n\v &quot;),
<a name="873"/>  873:     test(&quot;\n\e\n\b\f\n\da\n&quot;),
<a name="white_spaces-last_expr"/><a name="874"/>  874:     ok.
<a name="875"/>  875: 
<a name="unicode-0"/><a name="876"/>  876: <b>unicode</b>() -&gt;
<a name="877"/>  877:     {ok,[{char,1,83},{integer,1,45}],1} =
<a name="878"/>  878:         erl_scan_string(&quot;$\\12345&quot;), % not unicode
<a name="879"/>  879: 
<a name="880"/>  880:     {error,{1,erl_scan,{illegal,character}},1} =
<a name="881"/>  881:         erl_scan:string([1089]),
<a name="882"/>  882:     {error,{{1,1},erl_scan,{illegal,character}},{1,2}} =
<a name="883"/>  883:         erl_scan:string([1089], {1,1}),
<a name="884"/>  884:     {error,{{1,1},erl_scan,{illegal,character}},{1,2}} =
<a name="885"/>  885:         erl_scan:string([16#D800], {1,1}),
<a name="886"/>  886: 
<a name="887"/>  887:     test(&quot;\&quot;a&quot;++[1089]++&quot;b\&quot;&quot;),
<a name="888"/>  888:     {error,{1,erl_scan,{illegal,character}},1} =
<a name="889"/>  889:         erl_scan_string([$$,$\\,$^,1089], 1),
<a name="890"/>  890: 
<a name="891"/>  891:     {error,{1,erl_scan,Error},1} =
<a name="892"/>  892:         erl_scan:string(&quot;\&quot;qa\x{aaa}&quot;, 1),
<a name="893"/>  893:     &quot;unterminated string starting with \&quot;qa&quot;++[2730]++&quot;\&quot;&quot; =
<a name="894"/>  894:         erl_scan:format_error(Error),
<a name="895"/>  895:     {error,{{1,1},erl_scan,_},{1,11}} =
<a name="896"/>  896:         erl_scan:string(&quot;\&quot;qa\\x{aaa}&quot;,{1,1}),
<a name="897"/>  897:     {error,{{1,1},erl_scan,_},{1,11}} =
<a name="898"/>  898:         erl_scan:string(&quot;'qa\\x{aaa}&quot;,{1,1}),
<a name="899"/>  899: 
<a name="900"/>  900:     {ok,[{char,1,1089}],1} =
<a name="901"/>  901:         erl_scan_string([$$,1089], 1),
<a name="902"/>  902:     {ok,[{char,1,1089}],1} =
<a name="903"/>  903:         erl_scan_string([$$,$\\,1089], 1),
<a name="904"/>  904: 
<a name="905"/>  905:     Qs = &quot;$\\x{aaa}&quot;,
<a name="906"/>  906:     {ok,[{char,1,$\x{aaa}}],1} =
<a name="907"/>  907:         erl_scan_string(Qs, 1),
<a name="908"/>  908:     {ok,[Q2],{1,9}} =
<a name="909"/>  909:         erl_scan:string(&quot;$\\x{aaa}&quot;, {1,1}, [text]),
<a name="910"/>  910:     [{category,char},{column,1},{line,1},{symbol,16#aaa},{text,Qs}] =
<a name="911"/>  911:         token_info_long(Q2),
<a name="912"/>  912: 
<a name="913"/>  913:     U1 = &quot;\&quot;\\x{aaa}\&quot;&quot;,
<a name="914"/>  914:     {ok,[{string,_,[2730]}=T1],{1,10}} = erl_scan:string(U1, {1,1}, [text]),
<a name="915"/>  915:     {1,1} = erl_scan:location(T1),
<a name="916"/>  916:     &quot;\&quot;\\x{aaa}\&quot;&quot; = erl_scan:text(T1),
<a name="917"/>  917:     {ok,[{string,1,[2730]}],1} = erl_scan_string(U1, 1),
<a name="918"/>  918: 
<a name="919"/>  919:     U2 = &quot;\&quot;\\x41\\x{fff}\\x42\&quot;&quot;,
<a name="920"/>  920:     {ok,[{string,1,[$\x41,$\x{fff},$\x42]}],1} = erl_scan_string(U2, 1),
<a name="921"/>  921: 
<a name="922"/>  922:     U3 = &quot;\&quot;a\n\\x{fff}\n\&quot;&quot;,
<a name="923"/>  923:     {ok,[{string,1,[$a,$\n,$\x{fff},$\n]}],3} = erl_scan_string(U3, 1),
<a name="924"/>  924: 
<a name="925"/>  925:     U4 = &quot;\&quot;\n\\x{aaa}\n\&quot;&quot;,
<a name="926"/>  926:     {ok,[{string,1,[$\n,$\x{aaa},$\n]}],3} = erl_scan_string(U4, 1),
<a name="927"/>  927: 
<a name="928"/>  928:     %% Keep these tests:
<a name="929"/>  929:     test(Qs),
<a name="930"/>  930:     test(U1),
<a name="931"/>  931:     test(U2),
<a name="932"/>  932:     test(U3),
<a name="933"/>  933:     test(U4),
<a name="934"/>  934: 
<a name="935"/>  935:     Str1 = &quot;\&quot;ab&quot; ++ [1089] ++ &quot;cd\&quot;&quot;,
<a name="936"/>  936:     {ok,[{string,1,[$a,$b,1089,$c,$d]}],1} = erl_scan_string(Str1, 1),
<a name="937"/>  937:     {ok,[{string,{1,1},[$a,$b,1089,$c,$d]}],{1,8}} =
<a name="938"/>  938:         erl_scan_string(Str1, {1,1}),
<a name="939"/>  939:     test(Str1),
<a name="940"/>  940:     Comment = &quot;%% &quot;++[1089],
<a name="941"/>  941:     {ok,[{comment,1,[$%,$%,$\s,1089]}],1} =
<a name="942"/>  942:         erl_scan_string(Comment, 1, [return]),
<a name="943"/>  943:     {ok,[{comment,{1,1},[$%,$%,$\s,1089]}],{1,5}} =
<a name="944"/>  944:         erl_scan_string(Comment, {1,1}, [return]),
<a name="unicode-last_expr"/><a name="945"/>  945:     ok.
<a name="946"/>  946: 
<a name="more_chars-0"/><a name="947"/>  947: <b>more_chars</b>() -&gt;
<a name="948"/>  948:     %% Due to unicode, the syntax has been incompatibly augmented:
<a name="949"/>  949:     %% $\x{...}, $\xHH
<a name="950"/>  950: 
<a name="951"/>  951:     %% All kinds of tests...
<a name="952"/>  952:     {ok,[{char,_,123}],{1,4}} =
<a name="953"/>  953:         erl_scan_string(&quot;$\\{&quot;,{1,1}),
<a name="954"/>  954:     {more, C1} = erl_scan:tokens([], &quot;$\\{&quot;, {1,1}),
<a name="955"/>  955:     {done,{ok,[{char,_,123}],{1,4}},eof} =
<a name="956"/>  956:         erl_scan_tokens(C1, eof, 1),
<a name="957"/>  957:     {ok,[{char,1,123},{atom,1,a},{'}',1}],1} =
<a name="958"/>  958:         erl_scan_string(&quot;$\\{a}&quot;),
<a name="959"/>  959: 
<a name="960"/>  960:     {error,{{1,1},erl_scan,char},{1,4}} =
<a name="961"/>  961:         erl_scan:string(&quot;$\\x&quot;, {1,1}),
<a name="962"/>  962:     {error,{{1,1},erl_scan,char},{1,5}} =
<a name="963"/>  963:         erl_scan:string(&quot;$\\x{&quot;,{1,1}),
<a name="964"/>  964:     {more, C3} = erl_scan:tokens([], &quot;$\\x&quot;, {1,1}),
<a name="965"/>  965:     {done,{error,{{1,1},erl_scan,char},{1,4}},eof} =
<a name="966"/>  966:         erl_scan:tokens(C3, eof, 1),
<a name="967"/>  967:     {error,{{1,1},erl_scan,char},{1,5}} =
<a name="968"/>  968:         erl_scan:string(&quot;$\\x{&quot;,{1,1}),
<a name="969"/>  969:     {more, C2} = erl_scan:tokens([], &quot;$\\x{&quot;, {1,1}),
<a name="970"/>  970:     {done,{error,{{1,1},erl_scan,char},{1,5}},eof} =
<a name="971"/>  971:         erl_scan:tokens(C2, eof, 1),
<a name="972"/>  972:     {error,{1,erl_scan,{illegal,character}},1} =
<a name="973"/>  973:         erl_scan:string(&quot;$\\x{g}&quot;),
<a name="974"/>  974:     {error,{{1,1},erl_scan,{illegal,character}},{1,5}} =
<a name="975"/>  975:         erl_scan:string(&quot;$\\x{g}&quot;, {1,1}),
<a name="976"/>  976:     {error,{{1,1},erl_scan,{illegal,character}},{1,6}} =
<a name="977"/>  977:         erl_scan:string(&quot;$\\x{}&quot;,{1,1}),
<a name="978"/>  978: 
<a name="979"/>  979:     test(&quot;\&quot;\\{0}\&quot;&quot;),
<a name="980"/>  980:     test(&quot;\&quot;\\x{0}\&quot;&quot;),
<a name="981"/>  981:     test(&quot;\'\\{0}\'&quot;),
<a name="982"/>  982:     test(&quot;\'\\x{0}\'&quot;),
<a name="983"/>  983: 
<a name="984"/>  984:     {error,{{2,3},erl_scan,{illegal,character}},{2,6}} =
<a name="985"/>  985:         erl_scan:string(&quot;\&quot;ab \n $\\x{g}\&quot;&quot;,{1,1}),
<a name="986"/>  986:     {error,{{2,3},erl_scan,{illegal,character}},{2,6}} =
<a name="987"/>  987:         erl_scan:string(&quot;\'ab \n $\\x{g}\'&quot;,{1,1}),
<a name="988"/>  988: 
<a name="989"/>  989:     test(&quot;$\\{34}&quot;),
<a name="990"/>  990:     test(&quot;$\\x{34}&quot;),
<a name="991"/>  991:     test(&quot;$\\{377}&quot;),
<a name="992"/>  992:     test(&quot;$\\x{FF}&quot;),
<a name="993"/>  993:     test(&quot;$\\{400}&quot;),
<a name="994"/>  994:     test(&quot;$\\x{100}&quot;),
<a name="995"/>  995:     test(&quot;$\\x{10FFFF}&quot;),
<a name="996"/>  996:     test(&quot;$\\x{10ffff}&quot;),
<a name="997"/>  997:     test(&quot;\&quot;$\n \\{1}\&quot;&quot;),
<a name="998"/>  998:     {error,{1,erl_scan,{illegal,character}},1} =
<a name="999"/>  999:         erl_scan:string(&quot;$\\x{110000}&quot;),
<a name="1000"/> 1000:     {error,{{1,1},erl_scan,{illegal,character}},{1,12}} =
<a name="1001"/> 1001:         erl_scan:string(&quot;$\\x{110000}&quot;, {1,1}),
<a name="1002"/> 1002: 
<a name="1003"/> 1003:     {error,{{1,1},erl_scan,{illegal,character}},{1,4}} =
<a name="1004"/> 1004:         erl_scan:string(&quot;$\\xfg&quot;, {1,1}),
<a name="1005"/> 1005: 
<a name="1006"/> 1006:     test(&quot;$\\xffg&quot;),
<a name="1007"/> 1007: 
<a name="1008"/> 1008:     {error,{{1,1},erl_scan,{illegal,character}},{1,4}} =
<a name="1009"/> 1009:         erl_scan:string(&quot;$\\xg&quot;, {1,1}),
<a name="more_chars-last_expr"/><a name="1010"/> 1010:     ok.
<a name="1011"/> 1011: 
<a name="1012"/> 1012: <i>%% OTP-10302. Unicode characters scanner/parser.</i>
<a name="otp_10302-1"/><a name="1013"/> 1013: <b>otp_10302</b>(Config) when is_list(Config) -&gt;
<a name="1014"/> 1014:     %% From unicode():
<a name="1015"/> 1015:     {ok,[{atom,1,'aсb'}],1} =
<a name="1016"/> 1016:         erl_scan_string(&quot;'a&quot;++[1089]++&quot;b'&quot;, 1),
<a name="1017"/> 1017:     {ok,[{atom,{1,1},'qaપ'}],{1,12}} =
<a name="1018"/> 1018:         erl_scan_string(&quot;'qa\\x{aaa}'&quot;,{1,1}),
<a name="1019"/> 1019: 
<a name="1020"/> 1020:     {ok,[{char,1,1089}],1} = erl_scan_string([$$,1089], 1),
<a name="1021"/> 1021:     {ok,[{char,1,1089}],1} = erl_scan_string([$$,$\\,1089],1),
<a name="1022"/> 1022: 
<a name="1023"/> 1023:     Qs = &quot;$\\x{aaa}&quot;,
<a name="1024"/> 1024:     {ok,[{char,1,2730}],1} = erl_scan_string(Qs, 1),
<a name="1025"/> 1025:     {ok,[Q2],{1,9}} = erl_scan:string(Qs,{1,1},[text]),
<a name="1026"/> 1026:     [{category,char},{column,1},{line,1},{symbol,16#aaa},{text,Qs}] =
<a name="1027"/> 1027:         token_info_long(Q2),
<a name="1028"/> 1028: 
<a name="1029"/> 1029:     U1 = &quot;\&quot;\\x{aaa}\&quot;&quot;,
<a name="1030"/> 1030:     {ok,[T1],{1,10}} = erl_scan:string(U1, {1,1}, [text]),
<a name="1031"/> 1031:     [{category,string},{column,1},{line,1},{symbol,[16#aaa]},{text,U1}] =
<a name="1032"/> 1032:         token_info_long(T1),
<a name="1033"/> 1033: 
<a name="1034"/> 1034:     U2 = &quot;\&quot;\\x41\\x{fff}\\x42\&quot;&quot;,
<a name="1035"/> 1035:     {ok,[{string,1,[65,4095,66]}],1} = erl_scan_string(U2, 1),
<a name="1036"/> 1036: 
<a name="1037"/> 1037:     U3 = &quot;\&quot;a\n\\x{fff}\n\&quot;&quot;,
<a name="1038"/> 1038:     {ok,[{string,1,[97,10,4095,10]}],3} = erl_scan_string(U3, 1),
<a name="1039"/> 1039: 
<a name="1040"/> 1040:     U4 = &quot;\&quot;\n\\x{aaa}\n\&quot;&quot;,
<a name="1041"/> 1041:     {ok,[{string,1,[10,2730,10]}],3} = erl_scan_string(U4, 1,[]),
<a name="1042"/> 1042: 
<a name="1043"/> 1043:     Str1 = &quot;\&quot;ab&quot; ++ [1089] ++ &quot;cd\&quot;&quot;,
<a name="1044"/> 1044:     {ok,[{string,1,[97,98,1089,99,100]}],1} =
<a name="1045"/> 1045:         erl_scan_string(Str1,1),
<a name="1046"/> 1046:     {ok,[{string,{1,1},[97,98,1089,99,100]}],{1,8}} =
<a name="1047"/> 1047:         erl_scan_string(Str1, {1,1}),
<a name="1048"/> 1048: 
<a name="1049"/> 1049:     OK1 = 16#D800-1,
<a name="1050"/> 1050:     OK2 = 16#DFFF+1,
<a name="1051"/> 1051:     OK3 = 16#FFFE-1,
<a name="1052"/> 1052:     OK4 = 16#FFFF+1,
<a name="1053"/> 1053:     OKL = [OK1,OK2,OK3,OK4],
<a name="1054"/> 1054: 
<a name="1055"/> 1055:     Illegal1 = 16#D800,
<a name="1056"/> 1056:     Illegal2 = 16#DFFF,
<a name="1057"/> 1057:     Illegal3 = 16#FFFE,
<a name="1058"/> 1058:     Illegal4 = 16#FFFF,
<a name="1059"/> 1059:     IllegalL = [Illegal1,Illegal2,Illegal3,Illegal4],
<a name="1060"/> 1060: 
<a name="1061"/> 1061:     [{ok,[{comment,1,[$%,$%,$\s,OK]}],1} =
<a name="1062"/> 1062:          erl_scan_string(&quot;%% &quot;++[OK], 1, [return]) ||
<a name="1063"/> 1063:         OK &lt;- OKL],
<a name="1064"/> 1064:     {ok,[{comment,_,[$%,$%,$\s,OK1]}],{1,5}} =
<a name="1065"/> 1065:         erl_scan_string(&quot;%% &quot;++[OK1], {1,1}, [return]),
<a name="1066"/> 1066:     [{error,{1,erl_scan,{illegal,character}},1} =
<a name="1067"/> 1067:          erl_scan:string(&quot;%% &quot;++[Illegal], 1, [return]) ||
<a name="1068"/> 1068:         Illegal &lt;- IllegalL],
<a name="1069"/> 1069:     {error,{{1,1},erl_scan,{illegal,character}},{1,5}} =
<a name="1070"/> 1070:         erl_scan:string(&quot;%% &quot;++[Illegal1], {1,1}, [return]),
<a name="1071"/> 1071: 
<a name="1072"/> 1072:     [{ok,[],1} = erl_scan_string(&quot;%% &quot;++[OK], 1, []) ||
<a name="1073"/> 1073:         OK &lt;- OKL],
<a name="1074"/> 1074:     {ok,[],{1,5}} = erl_scan_string(&quot;%% &quot;++[OK1], {1,1}, []),
<a name="1075"/> 1075:     [{error,{1,erl_scan,{illegal,character}},1} =
<a name="1076"/> 1076:          erl_scan:string(&quot;%% &quot;++[Illegal], 1, []) ||
<a name="1077"/> 1077:         Illegal &lt;- IllegalL],
<a name="1078"/> 1078:     {error,{{1,1},erl_scan,{illegal,character}},{1,5}} =
<a name="1079"/> 1079:         erl_scan:string(&quot;%% &quot;++[Illegal1], {1,1}, []),
<a name="1080"/> 1080: 
<a name="1081"/> 1081:     [{ok,[{string,{1,1},[OK]}],{1,4}} =
<a name="1082"/> 1082:         erl_scan_string(&quot;\&quot;&quot;++[OK]++&quot;\&quot;&quot;,{1,1}) ||
<a name="1083"/> 1083:         OK &lt;- OKL],
<a name="1084"/> 1084:     [{error,{{1,2},erl_scan,{illegal,character}},{1,3}} =
<a name="1085"/> 1085:          erl_scan:string(&quot;\&quot;&quot;++[OK]++&quot;\&quot;&quot;,{1,1}) ||
<a name="1086"/> 1086:         OK &lt;- IllegalL],
<a name="1087"/> 1087: 
<a name="1088"/> 1088:     [{error,{{1,1},erl_scan,{illegal,character}},{1,2}} =
<a name="1089"/> 1089:         erl_scan:string([Illegal],{1,1}) ||
<a name="1090"/> 1090:         Illegal &lt;- IllegalL],
<a name="1091"/> 1091: 
<a name="1092"/> 1092:     {ok,[{char,{1,1},OK1}],{1,3}} =
<a name="1093"/> 1093:         erl_scan_string([$$,OK1],{1,1}),
<a name="1094"/> 1094:     {error,{{1,1},erl_scan,{illegal,character}},{1,2}} =
<a name="1095"/> 1095:         erl_scan:string([$$,Illegal1],{1,1}),
<a name="1096"/> 1096: 
<a name="1097"/> 1097:     {ok,[{char,{1,1},OK1}],{1,4}} =
<a name="1098"/> 1098:         erl_scan_string([$$,$\\,OK1],{1,1}),
<a name="1099"/> 1099:     {error,{{1,1},erl_scan,{illegal,character}},{1,4}} =
<a name="1100"/> 1100:         erl_scan:string([$$,$\\,Illegal1],{1,1}),
<a name="1101"/> 1101: 
<a name="1102"/> 1102:     {ok,[{string,{1,1},[55295]}],{1,5}} =
<a name="1103"/> 1103:         erl_scan_string(&quot;\&quot;\\&quot;++[OK1]++&quot;\&quot;&quot;,{1,1}),
<a name="1104"/> 1104:     {error,{{1,2},erl_scan,{illegal,character}},{1,4}} =
<a name="1105"/> 1105:         erl_scan:string(&quot;\&quot;\\&quot;++[Illegal1]++&quot;\&quot;&quot;,{1,1}),
<a name="1106"/> 1106: 
<a name="1107"/> 1107:     {ok,[{char,{1,1},OK1}],{1,10}} =
<a name="1108"/> 1108:         erl_scan_string(&quot;$\\x{D7FF}&quot;,{1,1}),
<a name="1109"/> 1109:     {error,{{1,1},erl_scan,{illegal,character}},{1,10}} =
<a name="1110"/> 1110:         erl_scan:string(&quot;$\\x{D800}&quot;,{1,1}),
<a name="1111"/> 1111: 
<a name="1112"/> 1112:     %% Not erl_scan, but erl_parse.
<a name="1113"/> 1113:     {integer,0,1} = erl_parse_abstract(1),
<a name="1114"/> 1114:     Float = 3.14, {float,0,Float} = erl_parse_abstract(Float),
<a name="1115"/> 1115:     {nil,0} = erl_parse_abstract([]),
<a name="1116"/> 1116:     {bin,0,
<a name="1117"/> 1117:      [{bin_element,0,{integer,0,1},default,default},
<a name="1118"/> 1118:       {bin_element,0,{integer,0,2},default,default}]} =
<a name="1119"/> 1119:         erl_parse_abstract(&lt;&lt;1,2&gt;&gt;),
<a name="1120"/> 1120:     {cons,0,{tuple,0,[{atom,0,a}]},{atom,0,b}} =
<a name="1121"/> 1121:         erl_parse_abstract([{a} | b]),
<a name="1122"/> 1122:     {string,0,&quot;str&quot;} = erl_parse_abstract(&quot;str&quot;),
<a name="1123"/> 1123:     {cons,0,
<a name="1124"/> 1124:      {integer,0,$a},
<a name="1125"/> 1125:      {cons,0,{integer,0,55296},{string,0,&quot;c&quot;}}} =
<a name="1126"/> 1126:         erl_parse_abstract(&quot;a&quot;++[55296]++&quot;c&quot;),
<a name="1127"/> 1127: 
<a name="1128"/> 1128:     Line = 17,
<a name="1129"/> 1129:     {integer,Line,1} = erl_parse_abstract(1, Line),
<a name="1130"/> 1130:     Float = 3.14, {float,Line,Float} = erl_parse_abstract(Float, Line),
<a name="1131"/> 1131:     {nil,Line} = erl_parse_abstract([], Line),
<a name="1132"/> 1132:     {bin,Line,
<a name="1133"/> 1133:      [{bin_element,Line,{integer,Line,1},default,default},
<a name="1134"/> 1134:       {bin_element,Line,{integer,Line,2},default,default}]} =
<a name="1135"/> 1135:         erl_parse_abstract(&lt;&lt;1,2&gt;&gt;, Line),
<a name="1136"/> 1136:     {cons,Line,{tuple,Line,[{atom,Line,a}]},{atom,Line,b}} =
<a name="1137"/> 1137:         erl_parse_abstract([{a} | b], Line),
<a name="1138"/> 1138:     {string,Line,&quot;str&quot;} = erl_parse_abstract(&quot;str&quot;, Line),
<a name="1139"/> 1139:     {cons,Line,
<a name="1140"/> 1140:      {integer,Line,$a},
<a name="1141"/> 1141:      {cons,Line,{integer,Line,55296},{string,Line,&quot;c&quot;}}} =
<a name="1142"/> 1142:         erl_parse_abstract(&quot;a&quot;++[55296]++&quot;c&quot;, Line),
<a name="1143"/> 1143: 
<a name="1144"/> 1144:     Opts1 = [{line,17}],
<a name="1145"/> 1145:     {integer,Line,1} = erl_parse_abstract(1, Opts1),
<a name="1146"/> 1146:     Float = 3.14, {float,Line,Float} = erl_parse_abstract(Float, Opts1),
<a name="1147"/> 1147:     {nil,Line} = erl_parse_abstract([], Opts1),
<a name="1148"/> 1148:     {bin,Line,
<a name="1149"/> 1149:      [{bin_element,Line,{integer,Line,1},default,default},
<a name="1150"/> 1150:       {bin_element,Line,{integer,Line,2},default,default}]} =
<a name="1151"/> 1151:         erl_parse_abstract(&lt;&lt;1,2&gt;&gt;, Opts1),
<a name="1152"/> 1152:     {cons,Line,{tuple,Line,[{atom,Line,a}]},{atom,Line,b}} =
<a name="1153"/> 1153:         erl_parse_abstract([{a} | b], Opts1),
<a name="1154"/> 1154:     {string,Line,&quot;str&quot;} = erl_parse_abstract(&quot;str&quot;, Opts1),
<a name="1155"/> 1155:     {cons,Line,
<a name="1156"/> 1156:      {integer,Line,$a},
<a name="1157"/> 1157:      {cons,Line,{integer,Line,55296},{string,Line,&quot;c&quot;}}} =
<a name="1158"/> 1158:         erl_parse_abstract(&quot;a&quot;++[55296]++&quot;c&quot;, Opts1),
<a name="1159"/> 1159: 
<a name="1160"/> 1160:     [begin
<a name="1161"/> 1161:          {integer,Line,1} = erl_parse_abstract(1, Opts2),
<a name="1162"/> 1162:          Float = 3.14, {float,Line,Float} = erl_parse_abstract(Float, Opts2),
<a name="1163"/> 1163:          {nil,Line} = erl_parse_abstract([], Opts2),
<a name="1164"/> 1164:          {bin,Line,
<a name="1165"/> 1165:           [{bin_element,Line,{integer,Line,1},default,default},
<a name="1166"/> 1166:            {bin_element,Line,{integer,Line,2},default,default}]} =
<a name="1167"/> 1167:              erl_parse_abstract(&lt;&lt;1,2&gt;&gt;, Opts2),
<a name="1168"/> 1168:          {cons,Line,{tuple,Line,[{atom,Line,a}]},{atom,Line,b}} =
<a name="1169"/> 1169:              erl_parse_abstract([{a} | b], Opts2),
<a name="1170"/> 1170:          {string,Line,&quot;str&quot;} = erl_parse_abstract(&quot;str&quot;, Opts2),
<a name="1171"/> 1171:          {string,Line,[97,1024,99]} =
<a name="1172"/> 1172:              erl_parse_abstract(&quot;a&quot;++[1024]++&quot;c&quot;, Opts2)
<a name="1173"/> 1173:      end || Opts2 &lt;- [[{encoding,unicode},{line,Line}],
<a name="1174"/> 1174:                       [{encoding,utf8},{line,Line}]]],
<a name="1175"/> 1175: 
<a name="1176"/> 1176:     {cons,0,
<a name="1177"/> 1177:      {integer,0,97},
<a name="1178"/> 1178:      {cons,0,{integer,0,1024},{string,0,&quot;c&quot;}}} =
<a name="1179"/> 1179:         erl_parse_abstract(&quot;a&quot;++[1024]++&quot;c&quot;, [{encoding,latin1}]),
<a name="otp_10302-last_expr"/><a name="1180"/> 1180:     ok.
<a name="1181"/> 1181: 
<a name="1182"/> 1182: <i>%% OTP-10990. Floating point number in input string.</i>
<a name="otp_10990-1"/><a name="1183"/> 1183: <b>otp_10990</b>(Config) when is_list(Config) -&gt;
<a name="1184"/> 1184:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,42.0,$&quot;],1)}),
<a name="otp_10990-last_expr"/><a name="1185"/> 1185:     ok.
<a name="1186"/> 1186: 
<a name="1187"/> 1187: <i>%% OTP-10992. List of floats to abstract format.</i>
<a name="otp_10992-1"/><a name="1188"/> 1188: <b>otp_10992</b>(Config) when is_list(Config) -&gt;
<a name="1189"/> 1189:     {cons,0,{float,0,42.0},{nil,0}} =
<a name="1190"/> 1190:         erl_parse_abstract([42.0], [{encoding,unicode}]),
<a name="1191"/> 1191:     {cons,0,{float,0,42.0},{nil,0}} =
<a name="1192"/> 1192:         erl_parse_abstract([42.0], [{encoding,utf8}]),
<a name="1193"/> 1193:     {cons,0,{integer,0,65},{cons,0,{float,0,42.0},{nil,0}}} =
<a name="1194"/> 1194:         erl_parse_abstract([$A,42.0], [{encoding,unicode}]),
<a name="1195"/> 1195:     {cons,0,{integer,0,65},{cons,0,{float,0,42.0},{nil,0}}} =
<a name="1196"/> 1196:         erl_parse_abstract([$A,42.0], [{encoding,utf8}]),
<a name="otp_10992-last_expr"/><a name="1197"/> 1197:     ok.
<a name="1198"/> 1198: 
<a name="1199"/> 1199: <i>%% OTP-11807. Generalize erl_parse:abstract/2.</i>
<a name="otp_11807-1"/><a name="1200"/> 1200: <b>otp_11807</b>(Config) when is_list(Config) -&gt;
<a name="1201"/> 1201:     {cons,0,{integer,0,97},{cons,0,{integer,0,98},{nil,0}}} =
<a name="1202"/> 1202:         erl_parse_abstract(&quot;ab&quot;, [{encoding,none}]),
<a name="1203"/> 1203:     {cons,0,{integer,0,-1},{nil,0}} =
<a name="1204"/> 1204:         erl_parse_abstract([-1], [{encoding,latin1}]),
<a name="1205"/> 1205:     ASCII = fun(I) -&gt; I &gt;= 0 andalso I &lt; 128 end,
<a name="1206"/> 1206:     {string,0,&quot;xyz&quot;} = erl_parse_abstract(&quot;xyz&quot;, [{encoding,ASCII}]),
<a name="1207"/> 1207:     {cons,0,{integer,0,228},{nil,0}} =
<a name="1208"/> 1208:         erl_parse_abstract([228], [{encoding,ASCII}]),
<a name="1209"/> 1209:     {cons,0,{integer,0,97},{atom,0,a}} =
<a name="1210"/> 1210:         erl_parse_abstract(&quot;a&quot;++a, [{encoding,latin1}]),
<a name="1211"/> 1211:     {'EXIT', {{badarg,bad},_}} = % minor backward incompatibility
<a name="1212"/> 1212:          (catch erl_parse:abstract(&quot;string&quot;, [{encoding,bad}])),
<a name="otp_11807-last_expr"/><a name="1213"/> 1213:    ok.
<a name="1214"/> 1214: 
<a name="otp_16480-1"/><a name="1215"/> 1215: <b>otp_16480</b>(Config) when is_list(Config) -&gt;
<a name="1216"/> 1216:     F = fun mod:func/19,
<a name="1217"/> 1217:     F = erl_parse:normalise(erl_parse_abstract(F)),
<a name="otp_16480-last_expr"/><a name="1218"/> 1218:     ok.
<a name="1219"/> 1219: 
<a name="otp_17024-1"/><a name="1220"/> 1220: <b>otp_17024</b>(Config) when is_list(Config) -&gt;
<a name="1221"/> 1221:     Line = 17,
<a name="1222"/> 1222:     Opts1 = [{location,Line}],
<a name="1223"/> 1223:     {integer,Line,1} = erl_parse_abstract(1, Opts1),
<a name="1224"/> 1224:     Location = {17, 42},
<a name="1225"/> 1225:     {integer,Location,1} = erl_parse_abstract(1, Location),
<a name="1226"/> 1226:     Opts2 = [{location,Location}],
<a name="1227"/> 1227:     {integer,Location,1} = erl_parse_abstract(1, Opts2),
<a name="otp_17024-last_expr"/><a name="1228"/> 1228:     ok.
<a name="1229"/> 1229: 
<a name="text_fun-1"/><a name="1230"/> 1230: <b>text_fun</b>(Config) when is_list(Config) -&gt;
<a name="1231"/> 1231:     KeepClass = fun(Class) -&gt;
<a name="1232"/> 1232:                         fun(C, _) -&gt; C == Class end
<a name="1233"/> 1233:                 end,
<a name="1234"/> 1234: 
<a name="1235"/> 1235:     Join = fun(L, S) -&gt; string:join(L, S) end,
<a name="1236"/> 1236:     String = fun(L) -&gt; Join(L, &quot; &quot;) end,
<a name="1237"/> 1237: 
<a name="1238"/> 1238:     TextAtom = KeepClass(atom),
<a name="1239"/> 1239:     TextInt = KeepClass(integer),
<a name="1240"/> 1240:     %% Keep text for integers written with a base.
<a name="1241"/> 1241:     TextBase = fun(C, S) -&gt;
<a name="1242"/> 1242:                        C == integer andalso string:find(S, &quot;#&quot;) /= nomatch
<a name="1243"/> 1243:                end,
<a name="1244"/> 1244:     %% Keep text for long strings, regardless of class
<a name="1245"/> 1245:     TextLong = fun(_, S) -&gt; length(S) &gt; 10 end,
<a name="1246"/> 1246: 
<a name="1247"/> 1247:     Texts = fun(Toks) -&gt; [erl_scan:text(T) || T &lt;- Toks] end,
<a name="1248"/> 1248:     Values =  fun(Toks) -&gt; [erl_scan:symbol(T) || T &lt;- Toks] end,
<a name="1249"/> 1249: 
<a name="1250"/> 1250:     Atom1 = &quot;foo&quot;,
<a name="1251"/> 1251:     Atom2 = &quot;'this is a long atom'&quot;,
<a name="1252"/> 1252:     Int1 = &quot;42&quot;,
<a name="1253"/> 1253:     Int2 = &quot;16#10&quot;,
<a name="1254"/> 1254:     Int3 = &quot;8#20&quot;,
<a name="1255"/> 1255:     Int4 = &quot;16&quot;,
<a name="1256"/> 1256:     Int5 = &quot;12345678901234567890&quot;,
<a name="1257"/> 1257:     String1 = &quot;\&quot;A String\&quot;&quot;,
<a name="1258"/> 1258:     String2 = &quot;\&quot;guitar string\&quot;&quot;,
<a name="1259"/> 1259:     Name1 = &quot;Short&quot;,
<a name="1260"/> 1260:     Name2 = &quot;LongAndDescriptiveName&quot;,
<a name="1261"/> 1261:     Sep1 = &quot;{&quot;,
<a name="1262"/> 1262:     Sep2 = &quot;+&quot;,
<a name="1263"/> 1263:     Sep3 = &quot;]&quot;,
<a name="1264"/> 1264:     Sep4 = &quot;/&quot;,
<a name="1265"/> 1265: 
<a name="1266"/> 1266:     All = [Atom1, Atom2, Int1, Int2, Int3, Int4, Int5,
<a name="1267"/> 1267:            String1, String2, Name1, Name2,
<a name="1268"/> 1268:            Sep1, Sep2, Sep3, Sep4],
<a name="1269"/> 1269: 
<a name="1270"/> 1270:     {ok, Tokens0, 2} =
<a name="1271"/> 1271:         erl_scan:string(String([Atom1, Int1]), 2, [{text_fun, TextAtom}]),
<a name="1272"/> 1272:     [Atom1, undefined] = Texts(Tokens0),
<a name="1273"/> 1273:     [foo, 42] = Values(Tokens0),
<a name="1274"/> 1274: 
<a name="1275"/> 1275:     {ok, Tokens1, 3} =
<a name="1276"/> 1276:         erl_scan:string(Join([Int2, Int3, Int4], &quot;\n&quot;), 1,
<a name="1277"/> 1277:                         [{text_fun, TextInt}]),
<a name="1278"/> 1278:     [Int2, Int3, Int4] = Texts(Tokens1),
<a name="1279"/> 1279:     [16, 16, 16] = Values(Tokens1),
<a name="1280"/> 1280: 
<a name="1281"/> 1281:     TS = [Int2, String1, Atom1, Int3, Int4, String2],
<a name="1282"/> 1282:     {ok, Tokens2, 6} =
<a name="1283"/> 1283:         %% If text is present, we supply text for *all* tokens.
<a name="1284"/> 1284:         erl_scan:string(Join(TS, &quot;\n&quot;), 1, [{text_fun, TextAtom}, text]),
<a name="1285"/> 1285:     TS = Texts(Tokens2),
<a name="1286"/> 1286:     [16, &quot;A String&quot;, foo, 16, 16, &quot;guitar string&quot;] = Values(Tokens2),
<a name="1287"/> 1287: 
<a name="1288"/> 1288:     Ints = [Int1, Int2, Int3, Int4],
<a name="1289"/> 1289:     {ok, Tokens3, 1} = erl_scan:string(String(Ints), 1, [{text_fun, TextBase}]),
<a name="1290"/> 1290:     [undefined, Int2, Int3, undefined] = Texts(Tokens3),
<a name="1291"/> 1291:     [42, 16, 16, 16] = Values(Tokens3),
<a name="1292"/> 1292: 
<a name="1293"/> 1293:     Longs = lists:filter(fun(S) -&gt; length(S) &gt; 10 end, All),
<a name="1294"/> 1294:     {ok, Tokens4, 1} =
<a name="1295"/> 1295:         erl_scan:string(String(All), 1, [{text_fun, TextLong}]),
<a name="1296"/> 1296:     Longs = lists:filter(fun(T) -&gt; T /= undefined end, Texts(Tokens4)),
<a name="1297"/> 1297: 
<a name="1298"/> 1298:     {ok, Tokens5, 7} =
<a name="1299"/> 1299:         erl_scan:string(String(All), 7, [{text_fun, KeepClass('{')}]),
<a name="text_fun-last_expr"/><a name="1300"/> 1300: <b>    [Sep1] = lists:filter</b>(fun(T) -&gt; T /= undefined end, Texts(Tokens5)).
<a name="1301"/> 1301: 
<a name="1302"/> 1302: 
<a name="test_string-2"/><a name="1303"/> 1303: <b>test_string</b>(String, ExpectedWithCol) -&gt;
<a name="1304"/> 1304:     {ok, ExpectedWithCol, _EndWithCol} = erl_scan_string(String, {1, 1}, []),
<a name="1305"/> 1305:     Expected = [ begin
<a name="1306"/> 1306:                      {L,_C} = element(2, T),
<a name="1307"/> 1307:                      setelement(2, T, L)
<a name="1308"/> 1308:                  end
<a name="1309"/> 1309:                     || T &lt;- ExpectedWithCol ],
<a name="1310"/> 1310:     {ok, Expected, _End} = erl_scan_string(String),
<a name="test_string-last_expr"/><a name="1311"/> 1311: <b>    test</b>(String).
<a name="1312"/> 1312: 
<a name="erl_scan_string-1"/><a name="1313"/> 1313: <b>erl_scan_string</b>(String) -&gt;
<a name="erl_scan_string-last_expr"/><a name="1314"/> 1314: <b>    erl_scan_string</b>(String, 1, []).
<a name="1315"/> 1315: 
<a name="erl_scan_string-2"/><a name="1316"/> 1316: <b>erl_scan_string</b>(String, StartLocation) -&gt;
<a name="erl_scan_string-last_expr"/><a name="1317"/> 1317: <b>    erl_scan_string</b>(String, StartLocation, []).
<a name="1318"/> 1318: 
<a name="erl_scan_string-3"/><a name="1319"/> 1319: <b>erl_scan_string</b>(String, StartLocation, Options) -&gt;
<a name="erl_scan_string-last_expr"/><a name="1320"/> 1320: <b>    case erl_scan:string</b>(String, StartLocation, Options) of
<a name="1321"/> 1321:         {ok, Tokens, EndLocation} -&gt;
<a name="1322"/> 1322:             {ok, unopaque_tokens(Tokens), EndLocation};
<a name="1323"/> 1323:         Else -&gt;
<a name="1324"/> 1324:             Else
<a name="1325"/> 1325:     end.
<a name="1326"/> 1326: 
<a name="erl_scan_tokens-3"/><a name="1327"/> 1327: <b>erl_scan_tokens</b>(C, S, L) -&gt;
<a name="erl_scan_tokens-last_expr"/><a name="1328"/> 1328: <b>    erl_scan_tokens</b>(C, S, L, []).
<a name="1329"/> 1329: 
<a name="erl_scan_tokens-4"/><a name="1330"/> 1330: <b>erl_scan_tokens</b>(C, S, L, O) -&gt;
<a name="erl_scan_tokens-last_expr"/><a name="1331"/> 1331: <b>    case erl_scan:tokens</b>(C, S, L, O) of
<a name="1332"/> 1332:         {done, {ok, Ts, End}, R} -&gt;
<a name="1333"/> 1333:             {done, {ok, unopaque_tokens(Ts), End}, R};
<a name="1334"/> 1334:         Else -&gt;
<a name="1335"/> 1335:             Else
<a name="1336"/> 1336:     end.
<a name="1337"/> 1337: 
<a name="unopaque_tokens-1"/><a name="1338"/> 1338: <b>unopaque_tokens</b>([]) -&gt;
<a name="1339"/> 1339:     [];
<a name="1340"/> 1340: <b>unopaque_tokens</b>([Token|Tokens]) -&gt;
<a name="1341"/> 1341:     Attrs = element(2, Token),
<a name="1342"/> 1342:     Term = erl_anno:to_term(Attrs),
<a name="1343"/> 1343:     T = setelement(2, Token, Term),
<a name="unopaque_tokens-last_expr"/><a name="1344"/> 1344: <b>    [T | unopaque_tokens</b>(Tokens)].
<a name="1345"/> 1345: 
<a name="erl_parse_abstract-1"/><a name="1346"/> 1346: <b>erl_parse_abstract</b>(Term) -&gt;
<a name="erl_parse_abstract-last_expr"/><a name="1347"/> 1347: <b>    erl_parse_abstract</b>(Term, []).
<a name="1348"/> 1348: 
<a name="erl_parse_abstract-2"/><a name="1349"/> 1349: <b>erl_parse_abstract</b>(Term, Options) -&gt;
<a name="1350"/> 1350:     Abstr = erl_parse:abstract(Term, Options),
<a name="erl_parse_abstract-last_expr"/><a name="1351"/> 1351: <b>    unopaque_abstract</b>(Abstr).
<a name="1352"/> 1352: 
<a name="unopaque_abstract-1"/><a name="1353"/> 1353: <b>unopaque_abstract</b>(Abstr) -&gt;
<a name="unopaque_abstract-last_expr"/><a name="1354"/> 1354: <b>    erl_parse:anno_to_term</b>(Abstr).
<a name="1355"/> 1355: 
<a name="1356"/> 1356: <i>%% test_string(String, Expected, StartLocation, Options) -&gt;</i>
<a name="1357"/> 1357: <i>%%     {ok, Expected, _End} = erl_scan:string(String, StartLocation, Options),</i>
<a name="1358"/> 1358: <i>%%     test(String).</i>
<a name="1359"/> 1359: 
<a name="1360"/> 1360: <i>%% There are no checks of the tags...</i>
<a name="test-1"/><a name="1361"/> 1361: <b>test</b>(String) -&gt;
<a name="1362"/> 1362:     %% io:format(&quot;Testing `~ts'~n&quot;, [String]),
<a name="1363"/> 1363:     [{Tokens, End},
<a name="1364"/> 1364:      {Wtokens, Wend},
<a name="1365"/> 1365:      {Ctokens, Cend},
<a name="1366"/> 1366:      {CWtokens, CWend},
<a name="1367"/> 1367:      {CWtokens2, _}] =
<a name="1368"/> 1368:         [scan_string_with_column(String, X) ||
<a name="1369"/> 1369:             X &lt;- [[],
<a name="1370"/> 1370:                   [return_white_spaces],
<a name="1371"/> 1371:                   [return_comments],
<a name="1372"/> 1372:                   [return],
<a name="1373"/> 1373:                   [return]]], % for white space compaction test
<a name="1374"/> 1374: 
<a name="1375"/> 1375:     {end1,End,Wend} = {end1,Wend,End},
<a name="1376"/> 1376:     {end2,Wend,Cend} = {end2,Cend,Wend},
<a name="1377"/> 1377:     {end3,Cend,CWend} = {end3,CWend,Cend},
<a name="1378"/> 1378: 
<a name="1379"/> 1379:     %% Test that the tokens that are common to two token lists are identical.
<a name="1380"/> 1380:     {none,Tokens} = {none, filter_tokens(CWtokens, [white_space,comment])},
<a name="1381"/> 1381:     {comments,Ctokens} =
<a name="1382"/> 1382:         {comments,filter_tokens(CWtokens, [white_space])},
<a name="1383"/> 1383:     {white_spaces,Wtokens} =
<a name="1384"/> 1384:         {white_spaces,filter_tokens(CWtokens, [comment])},
<a name="1385"/> 1385: 
<a name="1386"/> 1386:     %% Use token attributes to extract parts from the original string,
<a name="1387"/> 1387:     %% and check that the parts are identical to the token strings.
<a name="1388"/> 1388:     {Line,Column} = test_decorated_tokens(String, CWtokens),
<a name="1389"/> 1389:     {deco,{Line,Column},End} = {deco,End,{Line,Column}},
<a name="1390"/> 1390: 
<a name="1391"/> 1391:     %% Almost the same again: concat texts to get the original:
<a name="1392"/> 1392:     Text = get_text(CWtokens),
<a name="1393"/> 1393:     {text,Text,String} = {text,String,Text},
<a name="1394"/> 1394: 
<a name="1395"/> 1395:     %% Test that white spaces occupy less heap than the worst case.
<a name="1396"/> 1396:     ok = test_white_space_compaction(CWtokens, CWtokens2),
<a name="1397"/> 1397: 
<a name="1398"/> 1398:     %% Test that white newlines are always first in text:
<a name="1399"/> 1399:     WhiteTokens = select_tokens(CWtokens, [white_space]),
<a name="1400"/> 1400:     ok = newlines_first(WhiteTokens),
<a name="1401"/> 1401: 
<a name="1402"/> 1402:     %% Line attribute only:
<a name="1403"/> 1403:     [Simple,Wsimple,Csimple,WCsimple] = Simples =
<a name="1404"/> 1404:         [element(2, erl_scan:string(String, 1, Opts)) ||
<a name="1405"/> 1405:             Opts &lt;- [[],
<a name="1406"/> 1406:                      [return_white_spaces],
<a name="1407"/> 1407:                      [return_comments],
<a name="1408"/> 1408:                      [return]]],
<a name="1409"/> 1409:     {consistent,true} = {consistent,consistent_attributes(Simples)},
<a name="1410"/> 1410:     {simple_wc,WCsimple} = {simple_wc,simplify(CWtokens)},
<a name="1411"/> 1411:     {simple,Simple} = {simple,filter_tokens(WCsimple, [white_space,comment])},
<a name="1412"/> 1412:     {simple_c,Csimple} = {simple_c,filter_tokens(WCsimple, [white_space])},
<a name="1413"/> 1413:     {simple_w,Wsimple} = {simple_w,filter_tokens(WCsimple, [comment])},
<a name="1414"/> 1414: 
<a name="1415"/> 1415:     %% Line attribute only, with text:
<a name="1416"/> 1416:     [SimpleTxt,WsimpleTxt,CsimpleTxt,WCsimpleTxt] = SimplesTxt =
<a name="1417"/> 1417:         [element(2, erl_scan:string(String, 1, [text|Opts])) ||
<a name="1418"/> 1418:             Opts &lt;- [[],
<a name="1419"/> 1419:                      [return_white_spaces],
<a name="1420"/> 1420:                      [return_comments],
<a name="1421"/> 1421:                      [return]]],
<a name="1422"/> 1422:     TextTxt = get_text(WCsimpleTxt),
<a name="1423"/> 1423:     {text_txt,TextTxt,String} = {text_txt,String,TextTxt},
<a name="1424"/> 1424:     {consistent_txt,true} =
<a name="1425"/> 1425:         {consistent_txt,consistent_attributes(SimplesTxt)},
<a name="1426"/> 1426:     {simple_txt,SimpleTxt} =
<a name="1427"/> 1427:         {simple_txt,filter_tokens(WCsimpleTxt, [white_space,comment])},
<a name="1428"/> 1428:     {simple_c_txt,CsimpleTxt} =
<a name="1429"/> 1429:         {simple_c_txt,filter_tokens(WCsimpleTxt, [white_space])},
<a name="1430"/> 1430:     {simple_w_txt,WsimpleTxt} =
<a name="1431"/> 1431:         {simple_w_txt,filter_tokens(WCsimpleTxt, [comment])},
<a name="1432"/> 1432: 
<a name="test-last_expr"/><a name="1433"/> 1433:     ok.
<a name="1434"/> 1434: 
<a name="test_white_space_compaction-2"/><a name="1435"/> 1435: <b>test_white_space_compaction</b>(Tokens, Tokens2) when Tokens =:= Tokens2 -&gt;
<a name="1436"/> 1436:     [WS, WS2] = [select_tokens(Ts, [white_space]) || Ts &lt;- [Tokens, Tokens2]],
<a name="test_white_space_compaction-last_expr"/><a name="1437"/> 1437: <b>    test_wsc</b>(WS, WS2).
<a name="1438"/> 1438: 
<a name="test_wsc-2"/><a name="1439"/> 1439: <b>test_wsc</b>([], []) -&gt;
<a name="1440"/> 1440:     ok;
<a name="1441"/> 1441: <b>test_wsc</b>([Token|Tokens], [Token2|Tokens2]) -&gt;
<a name="1442"/> 1442:     [Text, Text2] = [Text ||
<a name="1443"/> 1443:                         Text &lt;- [erl_scan:text(T) || T &lt;- [Token, Token2]]],
<a name="1444"/> 1444:     Sz = erts_debug:size(Text),
<a name="1445"/> 1445:     Sz2 = erts_debug:size({Text, Text2}),
<a name="1446"/> 1446:     IsCompacted = Sz2 &lt; 2*Sz+erts_debug:size({a,a}),
<a name="1447"/> 1447:     ToBeCompacted = is_compacted(Text),
<a name="test_wsc-last_expr"/><a name="1448"/> 1448:     if
<a name="1449"/> 1449:         IsCompacted =:= ToBeCompacted -&gt;
<a name="1450"/> 1450:             test_wsc(Tokens, Tokens2);
<a name="1451"/> 1451:         true -&gt;
<a name="1452"/> 1452:             {compaction_error, Token}
<a name="1453"/> 1453:     end.
<a name="1454"/> 1454: 
<a name="is_compacted-1"/><a name="1455"/> 1455: <b>is_compacted</b>(&quot;\r&quot;) -&gt;
<a name="1456"/> 1456:     true;
<a name="1457"/> 1457: <b>is_compacted</b>(&quot;\n\r&quot;) -&gt;
<a name="1458"/> 1458:     true;
<a name="1459"/> 1459: <b>is_compacted</b>(&quot;\n\f&quot;) -&gt;
<a name="1460"/> 1460:     true;
<a name="1461"/> 1461: <b>is_compacted</b>([$\n|String]) -&gt;
<a name="1462"/> 1462:       all_spaces(String)
<a name="1463"/> 1463:     orelse
<a name="1464"/> 1464:       all_tabs(String);
<a name="1465"/> 1465: <b>is_compacted</b>(String) -&gt;
<a name="1466"/> 1466:       all_spaces(String)
<a name="is_compacted-last_expr"/><a name="1467"/> 1467:     orelse
<a name="1468"/> 1468:       all_tabs(String).
<a name="1469"/> 1469: 
<a name="all_spaces-1"/><a name="1470"/> 1470: <b>all_spaces</b>(L) -&gt;
<a name="all_spaces-last_expr"/><a name="1471"/> 1471: <b>    all_same</b>(L, $\s).
<a name="1472"/> 1472: 
<a name="all_tabs-1"/><a name="1473"/> 1473: <b>all_tabs</b>(L) -&gt;
<a name="all_tabs-last_expr"/><a name="1474"/> 1474: <b>    all_same</b>(L, $\t).
<a name="1475"/> 1475: 
<a name="all_same-2"/><a name="1476"/> 1476: <b>all_same</b>(L, Char) -&gt;
<a name="all_same-last_expr"/><a name="1477"/> 1477: <b>    lists:all</b>(fun(C) -&gt; C =:= Char end, L).
<a name="1478"/> 1478: 
<a name="newlines_first-1"/><a name="1479"/> 1479: <b>newlines_first</b>([]) -&gt;
<a name="1480"/> 1480:     ok;
<a name="1481"/> 1481: <b>newlines_first</b>([Token|Tokens]) -&gt;
<a name="1482"/> 1482:     Text = erl_scan:text(Token),
<a name="1483"/> 1483:     Nnls = length([C || C &lt;- Text, C =:= $\n]),
<a name="1484"/> 1484:     OK = case Text of
<a name="1485"/> 1485:              [$\n|_] -&gt;
<a name="1486"/> 1486:                  Nnls =:= 1;
<a name="1487"/> 1487:              _ -&gt;
<a name="1488"/> 1488:                  Nnls =:= 0
<a name="1489"/> 1489:          end,
<a name="newlines_first-last_expr"/><a name="1490"/> 1490:     if
<a name="1491"/> 1491:         OK -&gt; newlines_first(Tokens);
<a name="1492"/> 1492:         true -&gt; OK
<a name="1493"/> 1493:     end.
<a name="1494"/> 1494: 
<a name="filter_tokens-2"/><a name="1495"/> 1495: <b>filter_tokens</b>(Tokens, Tags) -&gt;
<a name="filter_tokens-last_expr"/><a name="1496"/> 1496: <b>    lists:filter</b>(fun(T) -&gt; not lists:member(element(1, T), Tags) end, Tokens).
<a name="1497"/> 1497: 
<a name="select_tokens-2"/><a name="1498"/> 1498: <b>select_tokens</b>(Tokens, Tags) -&gt;
<a name="select_tokens-last_expr"/><a name="1499"/> 1499: <b>    lists:filter</b>(fun(T) -&gt; lists:member(element(1, T), Tags) end, Tokens).
<a name="1500"/> 1500: 
<a name="simplify-1"/><a name="1501"/> 1501: <b>simplify</b>([Token|Tokens]) -&gt;
<a name="1502"/> 1502:     Line = erl_scan:line(Token),
<a name="1503"/> 1503:     [setelement(2, Token, erl_anno:new(Line)) | simplify(Tokens)];
<a name="1504"/> 1504: <b>simplify</b>([]) -&gt;
<a name="simplify-last_expr"/><a name="1505"/> 1505:     [].
<a name="1506"/> 1506: 
<a name="get_text-1"/><a name="1507"/> 1507: <b>get_text</b>(Tokens) -&gt;
<a name="get_text-last_expr"/><a name="1508"/> 1508: <b>    lists:flatten</b>(
<a name="1509"/> 1509:       [T ||
<a name="1510"/> 1510:           Token &lt;- Tokens,
<a name="1511"/> 1511:           (T = erl_scan:text(Token)) =/= []]).
<a name="1512"/> 1512: 
<a name="test_decorated_tokens-2"/><a name="1513"/> 1513: <b>test_decorated_tokens</b>(String, Tokens) -&gt;
<a name="1514"/> 1514:     ToksAttrs = token_attrs(Tokens),
<a name="test_decorated_tokens-last_expr"/><a name="1515"/> 1515: <b>    test_strings</b>(ToksAttrs, String, 1, 1).
<a name="1516"/> 1516: 
<a name="token_attrs-1"/><a name="1517"/> 1517: <b>token_attrs</b>(Tokens) -&gt;
<a name="token_attrs-last_expr"/><a name="1518"/> 1518: <b>    [{L,C,length</b>(T),T} ||
<a name="1519"/> 1519:         Token &lt;- Tokens,
<a name="1520"/> 1520:         ([C,L,T] = token_info(Token)) =/= []].
<a name="1521"/> 1521: 
<a name="token_info-1"/><a name="1522"/> 1522: <b>token_info</b>(T) -&gt;
<a name="1523"/> 1523:     Column = erl_scan:column(T),
<a name="1524"/> 1524:     Line = erl_scan:line(T),
<a name="1525"/> 1525:     Text = erl_scan:text(T),
<a name="token_info-last_expr"/><a name="1526"/> 1526:     [Column, Line, Text].
<a name="1527"/> 1527: 
<a name="token_info_long-1"/><a name="1528"/> 1528: <b>token_info_long</b>(T) -&gt;
<a name="1529"/> 1529:     Column = erl_scan:column(T),
<a name="1530"/> 1530:     Line = erl_scan:line(T),
<a name="1531"/> 1531:     Text = erl_scan:text(T),
<a name="1532"/> 1532:     Category = erl_scan:category(T),
<a name="1533"/> 1533:     Symbol = erl_scan:symbol(T),
<a name="token_info_long-last_expr"/><a name="1534"/> 1534:     [{category,Category},{column,Column},{line,Line},
<a name="1535"/> 1535:      {symbol,Symbol},{text,Text}].
<a name="1536"/> 1536: 
<a name="test_strings-4"/><a name="1537"/> 1537: <b>test_strings</b>([], _S, Line, Column) -&gt;
<a name="1538"/> 1538:     {Line,Column};
<a name="1539"/> 1539: <b>test_strings</b>([{L,C,Len,T}=Attr|Attrs], String0, Line0, Column0) -&gt;
<a name="1540"/> 1540:     {String1, Column1} = skip_newlines(String0, L, Line0, Column0),
<a name="1541"/> 1541:     String = skip_chars(String1, C-Column1),
<a name="1542"/> 1542:     {Str,Rest} = lists:split(Len, String),
<a name="test_strings-last_expr"/><a name="1543"/> 1543:     if
<a name="1544"/> 1544:         Str =:= T -&gt;
<a name="1545"/> 1545:             {Line,Column} = string_newlines(T, L, C),
<a name="1546"/> 1546:             test_strings(Attrs, Rest, Line, Column);
<a name="1547"/> 1547:         true -&gt;
<a name="1548"/> 1548:             {token_error, Attr, Str}
<a name="1549"/> 1549:     end.
<a name="1550"/> 1550: 
<a name="skip_newlines-4"/><a name="1551"/> 1551: <b>skip_newlines</b>(String, Line, Line, Column) -&gt;
<a name="1552"/> 1552:     {String, Column};
<a name="1553"/> 1553: <b>skip_newlines</b>([$\n|String], L, Line, _Column) -&gt;
<a name="1554"/> 1554:     skip_newlines(String, L, Line+1, 1);
<a name="1555"/> 1555: <b>skip_newlines</b>([_|String], L, Line, Column) -&gt;
<a name="skip_newlines-last_expr"/><a name="1556"/> 1556: <b>    skip_newlines</b>(String, L, Line, Column+1).
<a name="1557"/> 1557: 
<a name="skip_chars-2"/><a name="1558"/> 1558: <b>skip_chars</b>(String, 0) -&gt;
<a name="1559"/> 1559:     String;
<a name="1560"/> 1560: <b>skip_chars</b>([_|String], N) -&gt;
<a name="skip_chars-last_expr"/><a name="1561"/> 1561: <b>    skip_chars</b>(String, N-1).
<a name="1562"/> 1562: 
<a name="string_newlines-3"/><a name="1563"/> 1563: <b>string_newlines</b>([$\n|String], Line, _Column) -&gt;
<a name="1564"/> 1564:     string_newlines(String, Line+1, 1);
<a name="1565"/> 1565: <b>string_newlines</b>([], Line, Column) -&gt;
<a name="1566"/> 1566:     {Line, Column};
<a name="1567"/> 1567: <b>string_newlines</b>([_|String], Line, Column) -&gt;
<a name="string_newlines-last_expr"/><a name="1568"/> 1568: <b>    string_newlines</b>(String, Line, Column+1).
<a name="1569"/> 1569: 
<a name="scan_string_with_column-2"/><a name="1570"/> 1570: <b>scan_string_with_column</b>(String, Options0) -&gt;
<a name="1571"/> 1571:     Options = [text | Options0],
<a name="1572"/> 1572:     StartLoc = {1, 1},
<a name="1573"/> 1573:     {ok, Ts1, End1} = erl_scan:string(String, StartLoc, Options),
<a name="1574"/> 1574:     TString = String ++ &quot;. &quot;,
<a name="1575"/> 1575:     {ok,Ts2,End2} = scan_tokens(TString, Options, [], StartLoc),
<a name="1576"/> 1576:     {ok, Ts3, End3} =
<a name="1577"/> 1577:         scan_tokens_1({more, []}, TString, Options, [], StartLoc),
<a name="1578"/> 1578:     {end_2,End2,End3} = {end_2,End3,End2},
<a name="1579"/> 1579:     {EndLine1,EndColumn1} = End1,
<a name="1580"/> 1580:     End2 = {EndLine1,EndColumn1+2},
<a name="1581"/> 1581:     {ts_1,Ts2,Ts3} = {ts_1,Ts3,Ts2},
<a name="1582"/> 1582:     Ts2 = Ts1 ++ [lists:last(Ts2)],
<a name="1583"/> 1583: 
<a name="1584"/> 1584:     %% Attributes are keylists, but have no text.
<a name="1585"/> 1585:     {ok, Ts7, End7} = erl_scan:string(String, {1,1}, Options),
<a name="1586"/> 1586:     {ok, Ts8, End8} = scan_tokens(TString, Options, [], {1,1}),
<a name="1587"/> 1587:     {end1, End1} = {end1, End7},
<a name="1588"/> 1588:     {end2, End2} = {end2, End8},
<a name="1589"/> 1589:     Ts8 = Ts7 ++ [lists:last(Ts8)],
<a name="1590"/> 1590:     {cons,true} = {cons,consistent_attributes([Ts1,Ts2,Ts3,Ts7,Ts8])},
<a name="1591"/> 1591: 
<a name="scan_string_with_column-last_expr"/><a name="1592"/> 1592:     {Ts1, End1}.
<a name="1593"/> 1593: 
<a name="scan_tokens-4"/><a name="1594"/> 1594: <b>scan_tokens</b>(String, Options, Rs, Location) -&gt;
<a name="scan_tokens-last_expr"/><a name="1595"/> 1595: <b>    case erl_scan:tokens</b>([], String, Location, Options) of
<a name="1596"/> 1596:         {done, {ok,Ts,End}, &quot;&quot;} -&gt;
<a name="1597"/> 1597:             {ok, lists:append(lists:reverse([Ts|Rs])), End};
<a name="1598"/> 1598:         {done, {ok,Ts,End}, Rest} -&gt;
<a name="1599"/> 1599:             scan_tokens(Rest, Options, [Ts|Rs], End)
<a name="1600"/> 1600:     end.
<a name="1601"/> 1601: 
<a name="scan_tokens_1-5"/><a name="1602"/> 1602: <b>scan_tokens_1</b>({done, {ok,Ts,End}, &quot;&quot;}, &quot;&quot;, _Options, Rs, _Location) -&gt;
<a name="1603"/> 1603:     {ok,lists:append(lists:reverse([Ts|Rs])),End};
<a name="1604"/> 1604: <b>scan_tokens_1</b>({done, {ok,Ts,End}, Rest}, Cs, Options, Rs, _Location) -&gt;
<a name="1605"/> 1605:     scan_tokens_1({more,[]}, Rest++Cs, Options, [Ts|Rs], End);
<a name="1606"/> 1606: <b>scan_tokens_1</b>({more, Cont}, [C | Cs], Options, Rs, Loc) -&gt;
<a name="1607"/> 1607:     R = erl_scan:tokens(Cont, [C], Loc, Options),
<a name="scan_tokens_1-last_expr"/><a name="1608"/> 1608: <b>    scan_tokens_1</b>(R, Cs, Options, Rs, Loc).
<a name="1609"/> 1609: 
<a name="consistent_attributes-1"/><a name="1610"/> 1610: <b>consistent_attributes</b>([]) -&gt;
<a name="1611"/> 1611:     true;
<a name="1612"/> 1612: <b>consistent_attributes</b>([Ts | TsL]) -&gt;
<a name="1613"/> 1613:     L = [T || T &lt;- Ts, is_integer(element(2, T))],
<a name="consistent_attributes-last_expr"/><a name="1614"/> 1614:     case L of
<a name="1615"/> 1615:         [] -&gt;
<a name="1616"/> 1616:             TagsL = [[Tag || {Tag,_} &lt;- defined(token_info_long(T))] ||
<a name="1617"/> 1617:                         T &lt;- Ts],
<a name="1618"/> 1618:             case lists:usort(TagsL) of
<a name="1619"/> 1619:                 [_] -&gt;
<a name="1620"/> 1620:                     consistent_attributes(TsL);
<a name="1621"/> 1621:                 [] when Ts =:= [] -&gt;
<a name="1622"/> 1622:                     consistent_attributes(TsL);
<a name="1623"/> 1623:                 _ -&gt;
<a name="1624"/> 1624:                     Ts
<a name="1625"/> 1625:             end;
<a name="1626"/> 1626:         Ts -&gt;
<a name="1627"/> 1627:             consistent_attributes(TsL);
<a name="1628"/> 1628:         _ -&gt;
<a name="1629"/> 1629:             Ts
<a name="1630"/> 1630:     end.
<a name="1631"/> 1631: 
<a name="defined-1"/><a name="1632"/> 1632: <b>defined</b>(L) -&gt;
<a name="defined-last_expr"/><a name="1633"/> 1633:     [{T,V} || {T,V} &lt;- L, V =/= undefined].
<a name="1634"/> 1634: 
<a name="family_list-1"/><a name="1635"/> 1635: <b>family_list</b>(L) -&gt;
<a name="family_list-last_expr"/><a name="1636"/> 1636: <b>    sofs:to_external</b>(family(L)).
<a name="1637"/> 1637: 
<a name="family-1"/><a name="1638"/> 1638: <b>family</b>(L) -&gt;
<a name="family-last_expr"/><a name="1639"/> 1639: <b>    sofs:relation_to_family</b>(sofs:relation(L)).
</pre>
</body>
</html>
