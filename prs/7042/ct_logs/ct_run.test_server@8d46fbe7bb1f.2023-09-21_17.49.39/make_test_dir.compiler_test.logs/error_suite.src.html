<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/compiler/make_test_dir/compiler_test/error_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1998-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <b>-module</b>(error_SUITE).
<a name="20"/>   20: 
<a name="21"/>   21: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1, 
<a name="24"/>   24: 	 init_per_group/2,end_per_group/2,
<a name="25"/>   25: 	 head_mismatch_line/1, head_mismatch_same_function_name/1, warnings_as_errors/1,
<a name="26"/>   26: 	 bif_clashes/1, transforms/1,maps_warnings/1,bad_utf8/1,bad_decls/1]).
<a name="27"/>   27: 
<a name="28"/>   28: <i>%% Used by transforms/1 test case.</i>
<a name="29"/>   29: <b>-export</b>([parse_transform/2]).
<a name="30"/>   30: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="31"/>   31: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="32"/>   32: 
<a name="all-0"/><a name="33"/>   33: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="34"/>   34:     [{group,p}].
<a name="35"/>   35: 
<a name="groups-0"/><a name="36"/>   36: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="37"/>   37: <b>    [{p,test_lib:parallel</b>(),
<a name="38"/>   38:       [head_mismatch_line,head_mismatch_same_function_name,
<a name="39"/>   39:        warnings_as_errors,bif_clashes,
<a name="40"/>   40:        transforms,maps_warnings,bad_utf8,bad_decls]}].
<a name="41"/>   41: 
<a name="init_per_suite-1"/><a name="42"/>   42: <b>init_per_suite</b>(Config) -&gt;
<a name="43"/>   43:     test_lib:recompile(?MODULE),
<a name="init_per_suite-last_expr"/><a name="44"/>   44:     Config.
<a name="45"/>   45: 
<a name="end_per_suite-1"/><a name="46"/>   46: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="47"/>   47:     ok.
<a name="48"/>   48: 
<a name="init_per_group-2"/><a name="49"/>   49: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="50"/>   50:     Config.
<a name="51"/>   51: 
<a name="end_per_group-2"/><a name="52"/>   52: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="53"/>   53:     Config.
<a name="54"/>   54: 
<a name="55"/>   55: 
<a name="bif_clashes-1"/><a name="56"/>   56: <b>bif_clashes</b>(Config) when is_list(Config) -&gt;
<a name="57"/>   57:     Ts = [{bif_clashes1,
<a name="58"/>   58:            &lt;&lt;&quot;
<a name="59"/>   59:               -export([t/0]).
<a name="60"/>   60:               t() -&gt;
<a name="61"/>   61:                  length([a,b,c]).
<a name="62"/>   62: 
<a name="63"/>   63:               length(X) -&gt;
<a name="64"/>   64:                erlang:length(X).
<a name="65"/>   65:              &quot;&gt;&gt;,
<a name="66"/>   66:            [return_warnings],
<a name="67"/>   67: 	   {error,
<a name="68"/>   68: 	    [{{4,18}, erl_lint,{call_to_redefined_old_bif,{length,1}}}], []} }],
<a name="69"/>   69:     [] = run(Config, Ts),
<a name="70"/>   70:     Ts1 = [{bif_clashes2,
<a name="71"/>   71:            &lt;&lt;&quot;
<a name="72"/>   72:               -export([t/0]).
<a name="73"/>   73:               -import(x,[length/1]).
<a name="74"/>   74:               t() -&gt;
<a name="75"/>   75:                  length([a,b,c]).
<a name="76"/>   76:              &quot;&gt;&gt;,
<a name="77"/>   77:            [return_warnings],
<a name="78"/>   78: 	    {error,
<a name="79"/>   79: 	     [{{3,16}, erl_lint,{redefine_old_bif_import,{length,1}}}], []} }],
<a name="80"/>   80:     [] = run(Config, Ts1),
<a name="81"/>   81:     Ts00 = [{bif_clashes3,
<a name="82"/>   82:            &lt;&lt;&quot;
<a name="83"/>   83:               -export([t/0]).
<a name="84"/>   84:               -compile({no_auto_import,[length/1]}).
<a name="85"/>   85:               t() -&gt;
<a name="86"/>   86:                  length([a,b,c]).
<a name="87"/>   87: 
<a name="88"/>   88:               length(X) -&gt;
<a name="89"/>   89:                erlang:length(X).
<a name="90"/>   90:              &quot;&gt;&gt;,
<a name="91"/>   91:            [return_warnings],
<a name="92"/>   92: 	   []}],
<a name="93"/>   93:     [] = run(Config, Ts00),
<a name="94"/>   94:     Ts11 = [{bif_clashes4,
<a name="95"/>   95:            &lt;&lt;&quot;
<a name="96"/>   96:               -export([t/0]).
<a name="97"/>   97:               -compile({no_auto_import,[length/1]}).
<a name="98"/>   98:               -import(x,[length/1]).
<a name="99"/>   99:               t() -&gt;
<a name="100"/>  100:                  length([a,b,c]).
<a name="101"/>  101:              &quot;&gt;&gt;,
<a name="102"/>  102:            [return_warnings],
<a name="103"/>  103: 	    []}],
<a name="104"/>  104:     [] = run(Config, Ts11),
<a name="105"/>  105:     Ts000 = [{bif_clashes5,
<a name="106"/>  106:            &lt;&lt;&quot;
<a name="107"/>  107:               -export([t/0]).
<a name="108"/>  108:               t() -&gt;
<a name="109"/>  109:                  binary_part(&lt;&lt;1,2,3,4&gt;&gt;,1,2).
<a name="110"/>  110: 
<a name="111"/>  111:               binary_part(X,Y,Z) -&gt;
<a name="112"/>  112:                erlang:binary_part(X,Y,Z).
<a name="113"/>  113:              &quot;&gt;&gt;,
<a name="114"/>  114:            [return_warnings],
<a name="115"/>  115: 	   {warning,
<a name="116"/>  116: 	    [{{4,18}, erl_lint,{call_to_redefined_bif,{binary_part,3}}}]} }],
<a name="117"/>  117:     [] = run(Config, Ts000),
<a name="118"/>  118:     Ts111 = [{bif_clashes6,
<a name="119"/>  119:            &lt;&lt;&quot;
<a name="120"/>  120:               -export([t/0]).
<a name="121"/>  121:               -import(x,[binary_part/3]).
<a name="122"/>  122:               t() -&gt;
<a name="123"/>  123:                   binary_part(&lt;&lt;1,2,3,4&gt;&gt;,1,2).
<a name="124"/>  124:              &quot;&gt;&gt;,
<a name="125"/>  125:            [return_warnings],
<a name="126"/>  126: 	    {warning,
<a name="127"/>  127: 	     [{{3,16}, erl_lint,{redefine_bif_import,{binary_part,3}}}]} }],
<a name="128"/>  128:     [] = run(Config, Ts111),
<a name="129"/>  129:     Ts2 = [{bif_clashes7,
<a name="130"/>  130:            &lt;&lt;&quot;
<a name="131"/>  131:               -export([t/0]).
<a name="132"/>  132:               -compile({no_auto_import,[length/1]}).
<a name="133"/>  133:               -import(x,[length/1]).
<a name="134"/>  134:               t() -&gt;
<a name="135"/>  135:                  length([a,b,c]).
<a name="136"/>  136:               length(X) -&gt;
<a name="137"/>  137:                  erlang:length(X).
<a name="138"/>  138:              &quot;&gt;&gt;,
<a name="139"/>  139:            [],
<a name="140"/>  140:           {error,
<a name="141"/>  141:            [{{7,15},erl_lint,{define_import,{length,1}}}],
<a name="142"/>  142:            []} }],
<a name="143"/>  143:     [] = run2(Config, Ts2),
<a name="144"/>  144:     Ts3 = [{bif_clashes8,
<a name="145"/>  145:            &lt;&lt;&quot;
<a name="146"/>  146:               -export([t/1]).
<a name="147"/>  147:               -compile({no_auto_import,[length/1]}).
<a name="148"/>  148:               t(X) when length(X) &gt; 3 -&gt;
<a name="149"/>  149:                  length([a,b,c]).
<a name="150"/>  150:               length(X) -&gt;
<a name="151"/>  151:                  erlang:length(X).
<a name="152"/>  152:              &quot;&gt;&gt;,
<a name="153"/>  153:            [],
<a name="154"/>  154:           {error,
<a name="155"/>  155:            [{{4,25},erl_lint,{illegal_guard_local_call,{length,1}}}],
<a name="156"/>  156:            []} }],
<a name="157"/>  157:     [] = run2(Config, Ts3),
<a name="158"/>  158:     Ts4 = [{bif_clashes9,
<a name="159"/>  159:            &lt;&lt;&quot;
<a name="160"/>  160:               -export([t/1]).
<a name="161"/>  161:               -compile({no_auto_import,[length/1]}).
<a name="162"/>  162:               -import(x,[length/1]).
<a name="163"/>  163:               t(X) when length(X) &gt; 3 -&gt;
<a name="164"/>  164:                  length([a,b,c]).
<a name="165"/>  165:              &quot;&gt;&gt;,
<a name="166"/>  166:            [],
<a name="167"/>  167:           {error,
<a name="168"/>  168:            [{{5,25},erl_lint,{illegal_guard_local_call,{length,1}}}],
<a name="169"/>  169:            []} }],
<a name="170"/>  170:     [] = run2(Config, Ts4),
<a name="171"/>  171: 
<a name="bif_clashes-last_expr"/><a name="172"/>  172:     ok.
<a name="173"/>  173: 
<a name="174"/>  174: 
<a name="175"/>  175: 
<a name="176"/>  176: 
<a name="177"/>  177: <i>%% Tests that a head mismatch is reported on the correct line (OTP-2125).</i>
<a name="head_mismatch_line-1"/><a name="178"/>  178: <b>head_mismatch_line</b>(Config) when is_list(Config) -&gt;
<a name="179"/>  179:     [E|_] = get_compilation_errors(Config, &quot;head_mismatch_line&quot;),
<a name="180"/>  180:     {{26,1}, Mod, Reason} = E,
<a name="181"/>  181:     (&quot;head mismatch: previous function foo/1 is distinct from bar/1. &quot;
<a name="182"/>  182:      &quot;Is the semicolon in foo/1 unwanted?&quot;) = lists:flatten(Reason),
<a name="183"/>  183:     Mod:format_error(Reason),
<a name="head_mismatch_line-last_expr"/><a name="184"/>  184:     ok.
<a name="185"/>  185: 
<a name="186"/>  186: <i>%% Tests that a head mismatch with the same function name reports a different error from above.</i>
<a name="187"/>  187: <i>%% https://github.com/erlang/otp/pull/7383#issuecomment-1586564294</i>
<a name="head_mismatch_same_function_name-1"/><a name="188"/>  188: <b>head_mismatch_same_function_name</b>(Config) when is_list(Config) -&gt;
<a name="189"/>  189:     [E|_] = get_compilation_errors(Config, &quot;head_mismatch_same_function_name&quot;),
<a name="190"/>  190:     {{25,1}, Mod, Reason} = E,
<a name="191"/>  191:     (&quot;head mismatch: function foo with arities 1 and 2 is regarded as &quot;
<a name="192"/>  192:      &quot;two distinct functions. Is the number of arguments incorrect &quot;
<a name="193"/>  193:      &quot;or is the semicolon in foo/1 unwanted?&quot;) = lists:flatten(Reason),
<a name="194"/>  194:     Mod:format_error(Reason),
<a name="head_mismatch_same_function_name-last_expr"/><a name="195"/>  195:     ok.
<a name="196"/>  196: 
<a name="197"/>  197: <i>%% Compiles a test file and returns the list of errors.</i>
<a name="198"/>  198: 
<a name="get_compilation_errors-2"/><a name="199"/>  199: <b>get_compilation_errors</b>(Config, Filename) -&gt;
<a name="200"/>  200:     DataDir = proplists:get_value(data_dir, Config),
<a name="201"/>  201:     File = filename:join(DataDir, Filename),
<a name="202"/>  202:     {error, [{_Name, E}|_], []} = compile:file(File, [return_errors]),
<a name="get_compilation_errors-last_expr"/><a name="203"/>  203:     E.
<a name="204"/>  204: 
<a name="warnings_as_errors-1"/><a name="205"/>  205: <b>warnings_as_errors</b>(Config) when is_list(Config) -&gt;
<a name="206"/>  206:     TestFile = test_filename(Config),
<a name="207"/>  207:     BeamFile = filename:rootname(TestFile, &quot;.erl&quot;) ++ &quot;.beam&quot;,
<a name="208"/>  208:     OutDir = proplists:get_value(priv_dir, Config),
<a name="209"/>  209: 
<a name="210"/>  210:     Ts1 = [{warnings_as_errors,
<a name="211"/>  211:            &lt;&lt;&quot;
<a name="212"/>  212:                t() -&gt;
<a name="213"/>  213:                  A = unused,
<a name="214"/>  214:                  ok.
<a name="215"/>  215:              &quot;&gt;&gt;,
<a name="216"/>  216: 	    [warnings_as_errors, export_all, {outdir, OutDir}],
<a name="217"/>  217: 	    {error,
<a name="218"/>  218: 	     [],
<a name="219"/>  219: 	     [{{3,18},erl_lint,{unused_var,'A'}}]} }],
<a name="220"/>  220:     [] = run(Ts1, TestFile, write_beam),
<a name="221"/>  221:     false = filelib:is_regular(BeamFile),
<a name="222"/>  222: 
<a name="223"/>  223:     Ts2 = [{warning_unused_var,
<a name="224"/>  224:            &lt;&lt;&quot;
<a name="225"/>  225:                t() -&gt;
<a name="226"/>  226:                  A = unused,
<a name="227"/>  227:                  ok.
<a name="228"/>  228:              &quot;&gt;&gt;,
<a name="229"/>  229: 	    [return_warnings, export_all, {outdir, OutDir}],
<a name="230"/>  230: 	    {warning,
<a name="231"/>  231: 	       [{{3,18},erl_lint,{unused_var,'A'}}]} }],
<a name="232"/>  232: 
<a name="233"/>  233:     [] = run(Ts2, TestFile, write_beam),
<a name="234"/>  234:     true = filelib:is_regular(BeamFile),
<a name="235"/>  235:     ok = file:delete(BeamFile),
<a name="236"/>  236: 
<a name="warnings_as_errors-last_expr"/><a name="237"/>  237:     ok.
<a name="238"/>  238: 
<a name="transforms-1"/><a name="239"/>  239: <b>transforms</b>(Config) -&gt;
<a name="240"/>  240:     Ts1 = [{undef_parse_transform,
<a name="241"/>  241: 	    &lt;&lt;&quot;
<a name="242"/>  242:               -compile({parse_transform,non_existing}).
<a name="243"/>  243:              &quot;&gt;&gt;,
<a name="244"/>  244: 	    [return],
<a name="245"/>  245: 	    {error,[{none,compile,{undef_parse_transform,non_existing}}],[]}}],
<a name="246"/>  246:     [] = run(Config, Ts1),
<a name="247"/>  247: 
<a name="248"/>  248:     Ts2 = &lt;&lt;&quot;
<a name="249"/>  249:               -compile({parse_transform,&quot;,?MODULE_STRING,&quot;}).
<a name="250"/>  250:              &quot;&gt;&gt;,
<a name="251"/>  251: 
<a name="252"/>  252:     {error,[{none,compile,{parse_transform,?MODULE,{error,too_bad,_}}}],[]} =
<a name="253"/>  253: 	run_test(Ts2, test_filename(Config), [{pt_error,error}], dont_write_beam),
<a name="254"/>  254: 
<a name="255"/>  255:     {error,[{none,compile,{parse_transform,?MODULE,{error,undef,_}}}],[]} =
<a name="256"/>  256:         run_test(Ts2, test_filename(Config), [{pt_error,call_undef}], dont_write_beam),
<a name="257"/>  257: 
<a name="258"/>  258:     {error,[{none,compile,{parse_transform,?MODULE,{exit,exited,_}}}],[]} =
<a name="259"/>  259:         run_test(Ts2, test_filename(Config), [{pt_error,exit}], dont_write_beam),
<a name="260"/>  260: 
<a name="261"/>  261:     {error,[{none,compile,{parse_transform,?MODULE,{throw,thrown,[_|_]}}}],[]} =
<a name="262"/>  262:         run_test(Ts2, test_filename(Config), [{pt_error,throw}], dont_write_beam),
<a name="263"/>  263: 
<a name="transforms-last_expr"/><a name="264"/>  264:     ok.
<a name="265"/>  265: 
<a name="parse_transform-2"/><a name="266"/>  266: <b>parse_transform</b>(_, Opts) -&gt;
<a name="267"/>  267:     {_,Error} = lists:keyfind(pt_error, 1, Opts),
<a name="parse_transform-last_expr"/><a name="268"/>  268:     case Error of
<a name="269"/>  269:         call_undef -&gt;
<a name="270"/>  270:             camembert:délicieux();
<a name="271"/>  271:         throw -&gt;
<a name="272"/>  272:             throw(thrown);
<a name="273"/>  273:         exit -&gt;
<a name="274"/>  274:             exit(exited);
<a name="275"/>  275:         error -&gt;
<a name="276"/>  276:             error(too_bad)
<a name="277"/>  277:     end.
<a name="278"/>  278: 
<a name="maps_warnings-1"/><a name="279"/>  279: <b>maps_warnings</b>(Config) when is_list(Config) -&gt;
<a name="280"/>  280:     Ts1 = [{map_ok_use_of_pattern,
<a name="281"/>  281: 	   &lt;&lt;&quot;
<a name="282"/>  282:               -export([t/1]).
<a name="283"/>  283:               t(K) -&gt;
<a name="284"/>  284:                  #{K := 1 = V} = id(#{&lt;&lt;\&quot;hi all\&quot;&gt;&gt; =&gt; 1}),
<a name="285"/>  285: 		 V.
<a name="286"/>  286:               id(I) -&gt; I.
<a name="287"/>  287:              &quot;&gt;&gt;,
<a name="288"/>  288: 	    [return],
<a name="289"/>  289: 	    []},
<a name="290"/>  290: 	{map_illegal_use_of_pattern,
<a name="291"/>  291: 	   &lt;&lt;&quot;
<a name="292"/>  292:               -export([t/0,t/2]).
<a name="293"/>  293: 	      t(K,#{ K := V }) -&gt; V.
<a name="294"/>  294:               t() -&gt;
<a name="295"/>  295:                  V = 32,
<a name="296"/>  296:                  #{&lt;&lt;\&quot;hi\&quot;,V,\&quot;all\&quot;&gt;&gt; := 1} = id(#{&lt;&lt;\&quot;hi all\&quot;&gt;&gt; =&gt; 1}).
<a name="297"/>  297:               id(I) -&gt; I.
<a name="298"/>  298:              &quot;&gt;&gt;,
<a name="299"/>  299: 	    [return],
<a name="300"/>  300: 	    {error,[{{3,15},erl_lint,{unbound_var,'K'}}],[]}}
<a name="301"/>  301:     ],
<a name="302"/>  302:     [] = run2(Config, Ts1),
<a name="maps_warnings-last_expr"/><a name="303"/>  303:     ok.
<a name="304"/>  304: 
<a name="bad_utf8-1"/><a name="305"/>  305: <b>bad_utf8</b>(Config) -&gt;
<a name="306"/>  306:     Ts = [{bad_explicit_utf8,
<a name="307"/>  307: 	   %% If coding is specified explicitly as utf-8, there should be
<a name="308"/>  308: 	   %% a compilation error for a latin-1 comment.
<a name="309"/>  309: 	   &lt;&lt;&quot;%% coding: utf-8
<a name="310"/>  310:               %% Bj&quot;,246,&quot;rn
<a name="311"/>  311:               t() -&gt; \&quot;&quot;,246,&quot;\&quot;.
<a name="312"/>  312:              &quot;&gt;&gt;,
<a name="313"/>  313: 	   [],
<a name="314"/>  314: 	   {error,[{{2,15},epp,cannot_parse},
<a name="315"/>  315: 		   {{2,15},file_io_server,invalid_unicode}],
<a name="316"/>  316: 	    []}
<a name="317"/>  317: 	  },
<a name="318"/>  318: 
<a name="319"/>  319:           {bad_implicit_utf8,
<a name="320"/>  320:            %% If there is no coding comment given, encoding defaults to utf-8
<a name="321"/>  321: 	   %% and there should be a compilation error for a latin-1 comment.
<a name="322"/>  322: 	   &lt;&lt;&quot;
<a name="323"/>  323:               %% Bj&quot;,246,&quot;rn
<a name="324"/>  324:               t() -&gt; \&quot;&quot;,246,&quot;\&quot;.
<a name="325"/>  325:              &quot;&gt;&gt;,
<a name="326"/>  326: 	   [],
<a name="327"/>  327: 	   {error,[{{2,15},epp,cannot_parse},
<a name="328"/>  328: 		   {{2,15},file_io_server,invalid_unicode}],
<a name="329"/>  329: 	    []}
<a name="330"/>  330:           }
<a name="331"/>  331:          ],
<a name="332"/>  332:     [] = run2(Config, Ts),
<a name="bad_utf8-last_expr"/><a name="333"/>  333:     ok.
<a name="334"/>  334: 
<a name="bad_decls-1"/><a name="335"/>  335: <b>bad_decls</b>(Config) -&gt;
<a name="336"/>  336:     Ts = [{bad_decls_1,
<a name="337"/>  337: 	   &lt;&lt;&quot;\n-module({l}).
<a name="338"/>  338:              &quot;&gt;&gt;,
<a name="339"/>  339: 	   [],
<a name="340"/>  340:            {error,[{{2,9},erl_parse,&quot;bad &quot; ++ [&quot;module&quot;] ++ &quot; declaration&quot;}],
<a name="341"/>  341:             []}
<a name="342"/>  342: 	  },
<a name="343"/>  343:           {bad_decls_2,
<a name="344"/>  344: 	   &lt;&lt;&quot;\n-module(l, m).
<a name="345"/>  345:              &quot;&gt;&gt;,
<a name="346"/>  346: 	   [],
<a name="347"/>  347:            {error,[{{2,12},erl_parse,&quot;bad variable list&quot;}],[]}
<a name="348"/>  348: 	  },
<a name="349"/>  349:           {bad_decls_3,
<a name="350"/>  350: 	   &lt;&lt;&quot;\n-export([a/1], Y).
<a name="351"/>  351:              &quot;&gt;&gt;,
<a name="352"/>  352: 	   [],
<a name="353"/>  353:            {error,[{{2,16},erl_parse,&quot;bad &quot; ++ [&quot;export&quot;] ++ &quot; declaration&quot;}],
<a name="354"/>  354:             []}
<a name="355"/>  355: 	  },
<a name="356"/>  356:           {bad_decls_4,
<a name="357"/>  357: 	   &lt;&lt;&quot;\n-import([a/1], Y).
<a name="358"/>  358:              &quot;&gt;&gt;,
<a name="359"/>  359: 	   [],
<a name="360"/>  360:            {error,[{{2,16},erl_parse,&quot;bad &quot; ++ [&quot;import&quot;] ++ &quot; declaration&quot;}],
<a name="361"/>  361:             []}
<a name="362"/>  362: 	  },
<a name="363"/>  363:           {bad_decls_5,
<a name="364"/>  364: 	   &lt;&lt;&quot;\n-ugly({A,B}).
<a name="365"/>  365:              &quot;&gt;&gt;,
<a name="366"/>  366: 	   [],
<a name="367"/>  367:            {error,[{{2,7},erl_parse,&quot;bad attribute&quot;}],[]}
<a name="368"/>  368: 	  },
<a name="369"/>  369:           {bad_decls_6,
<a name="370"/>  370: 	   &lt;&lt;&quot;\n-ugly(a, b).
<a name="371"/>  371:              &quot;&gt;&gt;,
<a name="372"/>  372: 	   [],
<a name="373"/>  373:            {error,[{{2,10},erl_parse,&quot;bad attribute&quot;}],[]}
<a name="374"/>  374: 	  },
<a name="375"/>  375:           {bad_decls_7,
<a name="376"/>  376: 	   &lt;&lt;&quot;\n-export([A/1]).
<a name="377"/>  377:              &quot;&gt;&gt;,
<a name="378"/>  378: 	   [],
<a name="379"/>  379:            {error,[{{2,10},erl_parse,&quot;bad function name&quot;}],[]}
<a name="380"/>  380: 	  },
<a name="381"/>  381:           {bad_decls_8,
<a name="382"/>  382: 	   &lt;&lt;&quot;\n-export([a/a]).
<a name="383"/>  383:              &quot;&gt;&gt;,
<a name="384"/>  384: 	   [],
<a name="385"/>  385:            {error,[{{2,12},erl_parse,&quot;bad function arity&quot;}],[]}
<a name="386"/>  386: 	  },
<a name="387"/>  387:           {bad_decls_9,
<a name="388"/>  388: 	   &lt;&lt;&quot;\n-export([a/1, {3,4}]).
<a name="389"/>  389:              &quot;&gt;&gt;,
<a name="390"/>  390: 	   [],
<a name="391"/>  391:            {error,[{{2,15},erl_parse,&quot;bad Name/Arity&quot;}],[]}
<a name="392"/>  392: 	  },
<a name="393"/>  393:           {bad_decls_10,
<a name="394"/>  394: 	   &lt;&lt;&quot;\n-record(A, {{bad,a}}).
<a name="395"/>  395:              &quot;&gt;&gt;,
<a name="396"/>  396: 	   [],
<a name="397"/>  397:            {error,[{{2,9},erl_parse,&quot;bad &quot; ++ [&quot;record&quot;] ++ &quot; declaration&quot;}],
<a name="398"/>  398:             []}
<a name="399"/>  399:            },
<a name="400"/>  400:           {bad_decls_11,
<a name="401"/>  401: 	   &lt;&lt;&quot;\n-record(a, [a,b,c,d]).
<a name="402"/>  402:              &quot;&gt;&gt;,
<a name="403"/>  403: 	   [],
<a name="404"/>  404:            {error,[{{2,12},erl_parse,&quot;bad record declaration&quot;}],[]}
<a name="405"/>  405:            },
<a name="406"/>  406:           {bad_decls_12,
<a name="407"/>  407: 	   &lt;&lt;&quot;\n-record(a).
<a name="408"/>  408:              &quot;&gt;&gt;,
<a name="409"/>  409: 	   [],
<a name="410"/>  410:            {error,[{{2,9},erl_parse,&quot;bad &quot; ++ [&quot;record&quot;] ++ &quot; declaration&quot;}],
<a name="411"/>  411:             []}
<a name="412"/>  412:            }
<a name="413"/>  413:           ],
<a name="414"/>  414:     [] = run2(Config, Ts),
<a name="415"/>  415: 
<a name="416"/>  416:     {error,{{1,4},erl_parse,&quot;bad term&quot;}} = parse_string(&quot;1, 2 + 4.&quot;),
<a name="417"/>  417:     {error,{{1,1},erl_parse,&quot;bad term&quot;}} = parse_string(&quot;34 + begin 34 end.&quot;),
<a name="bad_decls-last_expr"/><a name="418"/>  418:     ok.
<a name="419"/>  419: 
<a name="parse_string-1"/><a name="420"/>  420: <b>parse_string</b>(S) -&gt;
<a name="421"/>  421:     {ok,Ts,_} = erl_scan:string(S, {1, 1}),
<a name="parse_string-last_expr"/><a name="422"/>  422: <b>    erl_parse:parse_term</b>(Ts).
<a name="423"/>  423: 
<a name="424"/>  424: 
<a name="run-2"/><a name="425"/>  425: <b>run</b>(Config, Tests) -&gt;
<a name="426"/>  426:     File = test_filename(Config),
<a name="run-last_expr"/><a name="427"/>  427: <b>    run</b>(Tests, File, dont_write_beam).
<a name="428"/>  428: 
<a name="run-3"/><a name="429"/>  429: <b>run</b>(Tests, File, WriteBeam) -&gt;
<a name="430"/>  430:     F = fun({N,P,Ws,E}, BadL) -&gt;
<a name="431"/>  431:                 case catch run_test(P, File, Ws, WriteBeam) of
<a name="432"/>  432:                     E -&gt; 
<a name="433"/>  433:                         BadL;
<a name="434"/>  434:                     Bad -&gt; 
<a name="435"/>  435:                         io:format(&quot;~nTest ~p failed. Expected~n  ~p~n&quot;
<a name="436"/>  436:                                   &quot;but got~n  ~p~n&quot;, [N, E, Bad]),
<a name="437"/>  437: 			fail()
<a name="438"/>  438:                 end
<a name="439"/>  439:         end,
<a name="run-last_expr"/><a name="440"/>  440: <b>    lists:foldl</b>(F, [], Tests).
<a name="441"/>  441: 
<a name="run2-2"/><a name="442"/>  442: <b>run2</b>(Config, Tests) -&gt;
<a name="443"/>  443:     File = test_filename(Config),
<a name="run2-last_expr"/><a name="444"/>  444: <b>    run2</b>(Tests, File, dont_write_beam).
<a name="445"/>  445: 
<a name="run2-3"/><a name="446"/>  446: <b>run2</b>(Tests, File, WriteBeam) -&gt;
<a name="447"/>  447:     F = fun({N,P,Ws,E}, BadL) -&gt;
<a name="448"/>  448:                 case catch filter(run_test(P, File, Ws, WriteBeam)) of
<a name="449"/>  449:                     E -&gt;
<a name="450"/>  450:                         BadL;
<a name="451"/>  451:                     Bad -&gt;
<a name="452"/>  452:                         io:format(&quot;~nTest ~p failed. Expected~n  ~p~n&quot;
<a name="453"/>  453:                                   &quot;but got~n  ~p~n&quot;, [N, E, Bad]),
<a name="454"/>  454: 			fail()
<a name="455"/>  455:                 end
<a name="456"/>  456:         end,
<a name="run2-last_expr"/><a name="457"/>  457: <b>    lists:foldl</b>(F, [], Tests).
<a name="458"/>  458: 
<a name="filter-1"/><a name="459"/>  459: <b>filter</b>({error,Es,_Ws}) -&gt;
<a name="460"/>  460:     {error,Es,[]};
<a name="461"/>  461: <b>filter</b>(X) -&gt;
<a name="filter-last_expr"/><a name="462"/>  462:     X.
<a name="463"/>  463: 
<a name="464"/>  464: 
<a name="465"/>  465: <i>%% Compiles a test module and returns the list of errors and warnings.</i>
<a name="466"/>  466: 
<a name="test_filename-1"/><a name="467"/>  467: <b>test_filename</b>(Conf) -&gt;
<a name="468"/>  468:     Filename = [&quot;errors_test_&quot;,test_lib:uniq(),&quot;.erl&quot;],
<a name="469"/>  469:     DataDir = proplists:get_value(priv_dir, Conf),
<a name="test_filename-last_expr"/><a name="470"/>  470: <b>    filename:join</b>(DataDir, Filename).
<a name="471"/>  471: 
<a name="run_test-4"/><a name="472"/>  472: <b>run_test</b>(Test0, File, Warnings, WriteBeam) -&gt;
<a name="473"/>  473:     ModName = filename:rootname(filename:basename(File), &quot;.erl&quot;),
<a name="474"/>  474:     Mod = list_to_atom(ModName),
<a name="475"/>  475:     Test = iolist_to_binary([&quot;-module(&quot;,ModName,&quot;). &quot;,Test0]),
<a name="476"/>  476:     Opts = case WriteBeam of
<a name="477"/>  477: 	       dont_write_beam -&gt;
<a name="478"/>  478: 		   [binary,return_errors|Warnings];
<a name="479"/>  479: 	       write_beam -&gt;
<a name="480"/>  480: 		   [return_errors|Warnings]
<a name="481"/>  481: 	   end,
<a name="482"/>  482:     ok = file:write_file(File, Test),
<a name="483"/>  483: 
<a name="484"/>  484:     %% Compile once just to print all errors and warnings.
<a name="485"/>  485:     compile:file(File, [binary,report|Warnings]),
<a name="486"/>  486: 
<a name="487"/>  487:     %% Test result of compilation.
<a name="488"/>  488:     io:format(&quot;~p\n&quot;, [Opts]),
<a name="489"/>  489:     Res = case compile:file(File, Opts) of
<a name="490"/>  490: 	      {ok,Mod,_,[{_File,Ws}]} -&gt;
<a name="491"/>  491:                   print_diagnostics(Ws, Test),
<a name="492"/>  492: 		  {warning,Ws};
<a name="493"/>  493: 	      {ok,Mod,_,[]} -&gt;
<a name="494"/>  494: 		  [];
<a name="495"/>  495: 	      {ok,Mod,[{_File,Ws}]} -&gt;
<a name="496"/>  496: 		  {warning,Ws};
<a name="497"/>  497: 	      {ok,Mod,[]} -&gt;
<a name="498"/>  498: 		  [];
<a name="499"/>  499: 	      {error,[{XFile,Es}],Ws} = _ZZ when is_list(XFile) -&gt;
<a name="500"/>  500:                   print_diagnostics(Es, Test),
<a name="501"/>  501: 		  {error,Es,Ws};
<a name="502"/>  502: 	      {error,[{XFile,Es1},{XFile,Es2}],Ws} = _ZZ
<a name="503"/>  503: 		when is_list(XFile) -&gt;
<a name="504"/>  504:                   Es = Es1 ++ Es2,
<a name="505"/>  505:                   print_diagnostics(Es, Test),
<a name="506"/>  506: 		  {error,Es,Ws};
<a name="507"/>  507: 	      {error,Es,[{_File,Ws}]} = _ZZ-&gt;
<a name="508"/>  508:                   print_diagnostics(Es ++ Ws, Test),
<a name="509"/>  509: 		  {error,Es,Ws}
<a name="510"/>  510: 	  end,
<a name="511"/>  511:     file:delete(File),
<a name="run_test-last_expr"/><a name="512"/>  512:     Res.
<a name="513"/>  513: 
<a name="print_diagnostics-2"/><a name="514"/>  514: <b>print_diagnostics</b>(Warnings, Source) -&gt;
<a name="print_diagnostics-last_expr"/><a name="515"/>  515: <b>    case binary:match</b>(Source, &lt;&lt;&quot;-file(&quot;&gt;&gt;) of
<a name="516"/>  516:         nomatch -&gt;
<a name="517"/>  517:             Lines = binary:split(Source, &lt;&lt;&quot;\n&quot;&gt;&gt;, [global]),
<a name="518"/>  518:             Cs = [print_diagnostic(W, Lines) || W &lt;- Warnings],
<a name="519"/>  519:             io:put_chars(Cs);
<a name="520"/>  520:         _ -&gt;
<a name="521"/>  521:             %% There are probably fake line numbers greater than
<a name="522"/>  522:             %% the number of actual lines.
<a name="523"/>  523:             ok
<a name="524"/>  524:     end.
<a name="525"/>  525: 
<a name="print_diagnostic-2"/><a name="526"/>  526: <b>print_diagnostic</b>({{LineNum,Column},Mod,Data}, Lines) -&gt;
<a name="527"/>  527:     Line0 = lists:nth(LineNum, Lines),
<a name="528"/>  528:     &lt;&lt;Line1:(Column-1)/binary,_/binary&gt;&gt; = Line0,
<a name="529"/>  529:     Spaces = re:replace(Line1, &lt;&lt;&quot;[^\t]&quot;&gt;&gt;, &lt;&lt;&quot; &quot;&gt;&gt;, [global]),
<a name="530"/>  530:     CaretLine = [Spaces,&quot;^&quot;],
<a name="531"/>  531:     [io_lib:format(&quot;~p:~p: ~ts\n&quot;, [LineNum,Column,Mod:format_error(Data)]),
<a name="532"/>  532:      Line0, &quot;\n&quot;,
<a name="533"/>  533:      CaretLine, &quot;\n\n&quot;];
<a name="534"/>  534: <b>print_diagnostic</b>(_, _) -&gt;
<a name="print_diagnostic-last_expr"/><a name="535"/>  535:     [].
<a name="536"/>  536: 
<a name="fail-0"/><a name="537"/>  537: <b>fail</b>() -&gt;
<a name="fail-last_expr"/><a name="538"/>  538: <b>    ct:fail</b>(failed).
</pre>
</body>
</html>
