<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/inets/make_test_dir/inets_test/httpd_basic_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2007-2022. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <i>%%</i>
<a name="21"/>   21: <b>-module</b>(httpd_basic_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-include_lib</b>(&quot;kernel/include/file.hrl&quot;).
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="25"/>   25: <b>-include</b>(&quot;inets_test_lib.hrl&quot;).
<a name="26"/>   26: 
<a name="27"/>   27: 
<a name="28"/>   28: <i>%% Note: This directive should only be used in test suites.</i>
<a name="29"/>   29: <b>-compile</b>(export_all).
<a name="30"/>   30: 
<a name="31"/>   31: <b>-define</b>(URL_START, &quot;http://localhost:&quot;).
<a name="32"/>   32: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="33"/>   33: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]},
<a name="34"/>   34: 	    {timetrap, {seconds, 30}}].
<a name="35"/>   35: 
<a name="all-0"/><a name="36"/>   36: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="37"/>   37:     [uri_too_long_414, 
<a name="38"/>   38:      header_too_long_413,
<a name="39"/>   39:      entity_too_long,
<a name="40"/>   40:      http_0_9_not_supported,
<a name="41"/>   41:      erl_script_nocache_opt,
<a name="42"/>   42:      script_nocache,
<a name="43"/>   43:      escaped_url_in_error_body,
<a name="44"/>   44:      script_timeout,
<a name="45"/>   45:      slowdose,
<a name="46"/>   46:      keep_alive_timeout,
<a name="47"/>   47:      invalid_rfc1123_date
<a name="48"/>   48:     ].
<a name="49"/>   49: 
<a name="groups-0"/><a name="50"/>   50: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="51"/>   51:     [].
<a name="52"/>   52: 
<a name="init_per_group-2"/><a name="53"/>   53: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="54"/>   54:     Config.
<a name="55"/>   55: 
<a name="end_per_group-2"/><a name="56"/>   56: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="57"/>   57:     Config.
<a name="58"/>   58: 
<a name="59"/>   59: 
<a name="60"/>   60: <i>%%--------------------------------------------------------------------</i>
<a name="61"/>   61: <i>%% Function: init_per_suite(Config) -&gt; Config</i>
<a name="62"/>   62: <i>%% Config - [tuple()]</i>
<a name="63"/>   63: <i>%%   A list of key/value pairs, holding the test case configuration.</i>
<a name="64"/>   64: <i>%% Description: Initiation before the whole suite</i>
<a name="65"/>   65: <i>%%</i>
<a name="66"/>   66: <i>%% Note: This function is free to add any key/value pairs to the Config</i>
<a name="67"/>   67: <i>%% variable, but should NOT alter/remove any existing entries.</i>
<a name="68"/>   68: <i>%%--------------------------------------------------------------------</i>
<a name="init_per_suite-1"/><a name="69"/>   69: <b>init_per_suite</b>(Config) -&gt;
<a name="70"/>   70:     inets_test_lib:stop_apps([inets]),
<a name="71"/>   71:     inets_test_lib:start_apps([inets]),
<a name="72"/>   72:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="73"/>   73:     DataDir = proplists:get_value(data_dir, Config), 
<a name="74"/>   74:     
<a name="75"/>   75:     Dummy = 
<a name="76"/>   76: 	&quot;&lt;HTML&gt;
<a name="77"/>   77: &lt;HEAD&gt;
<a name="78"/>   78: &lt;TITLE&gt;/index.html&lt;/TITLE&gt;
<a name="79"/>   79: &lt;/HEAD&gt;
<a name="80"/>   80: &lt;BODY&gt;
<a name="81"/>   81: DUMMY
<a name="82"/>   82: &lt;/BODY&gt;
<a name="83"/>   83: &lt;/HTML&gt;&quot;,
<a name="84"/>   84:     
<a name="85"/>   85:     DummyFile = filename:join([PrivDir,&quot;dummy.html&quot;]),
<a name="86"/>   86:     CgiDir =  filename:join(PrivDir, &quot;cgi-bin&quot;),
<a name="87"/>   87:     ok = file:make_dir(CgiDir),
<a name="88"/>   88:     {CgiPrintEnv, CgiSleep} = case os:type() of
<a name="89"/>   89: 				  {win32, _} -&gt;
<a name="90"/>   90: 				      {&quot;printenv.bat&quot;, &quot;cgi_sleep.exe&quot;};
<a name="91"/>   91: 				  _ -&gt;
<a name="92"/>   92: 				      {&quot;printenv.sh&quot;, &quot;cgi_sleep&quot;}
<a name="93"/>   93: 			      end,
<a name="94"/>   94:     lists:foreach(
<a name="95"/>   95:       fun(Cgi) -&gt;
<a name="96"/>   96: 	      inets_test_lib:copy_file(Cgi, DataDir, CgiDir),
<a name="97"/>   97: 	      AbsCgi = filename:join([CgiDir, Cgi]),
<a name="98"/>   98: 	      {ok, FileInfo} = file:read_file_info(AbsCgi),
<a name="99"/>   99: 	      ok = file:write_file_info(AbsCgi, FileInfo#file_info{mode = 8#00755})
<a name="100"/>  100:       end, [CgiPrintEnv, CgiSleep]),
<a name="101"/>  101:     {ok, Fd}  = file:open(DummyFile, [write]),
<a name="102"/>  102:     ok        = file:write(Fd, Dummy),
<a name="103"/>  103:     ok        = file:close(Fd), 
<a name="104"/>  104:     HttpdConf = [{port,          0}, 
<a name="105"/>  105: 		 {ipfamily,      inet}, 
<a name="106"/>  106: 		 {server_name,   &quot;httpd_test&quot;}, 
<a name="107"/>  107: 		 {server_root,   PrivDir},
<a name="108"/>  108: 		 {document_root, PrivDir}, 
<a name="109"/>  109: 		 {bind_address,  &quot;localhost&quot;}],
<a name="110"/>  110: 
<a name="init_per_suite-last_expr"/><a name="111"/>  111:     [{httpd_conf, HttpdConf}, {cgi_dir, CgiDir},
<a name="112"/>  112:      {cgi_printenv, CgiPrintEnv}, {cgi_sleep, CgiSleep} |  Config].
<a name="113"/>  113: 
<a name="114"/>  114: <i>%%--------------------------------------------------------------------</i>
<a name="115"/>  115: <i>%% Function: end_per_suite(Config) -&gt; _</i>
<a name="116"/>  116: <i>%% Config - [tuple()]</i>
<a name="117"/>  117: <i>%%   A list of key/value pairs, holding the test case configuration.</i>
<a name="118"/>  118: <i>%% Description: Cleanup after the whole suite</i>
<a name="119"/>  119: <i>%%--------------------------------------------------------------------</i>
<a name="end_per_suite-1"/><a name="120"/>  120: <b>end_per_suite</b>(_Config) -&gt;
<a name="121"/>  121:     inets:stop(),
<a name="end_per_suite-last_expr"/><a name="122"/>  122:     ok.
<a name="123"/>  123: 
<a name="124"/>  124: <i>%%--------------------------------------------------------------------</i>
<a name="125"/>  125: <i>%% Function: init_per_testcase(Case, Config) -&gt; Config</i>
<a name="126"/>  126: <i>% Case - atom()</i>
<a name="127"/>  127: <i>%%   Name of the test case that is about to be run.</i>
<a name="128"/>  128: <i>%% Config - [tuple()]</i>
<a name="129"/>  129: <i>%%   A list of key/value pairs, holding the test case configuration.</i>
<a name="130"/>  130: <i>%%</i>
<a name="131"/>  131: <i>%% Description: Initiation before each test case</i>
<a name="132"/>  132: <i>%%</i>
<a name="133"/>  133: <i>%% Note: This function is free to add any key/value pairs to the Config</i>
<a name="134"/>  134: <i>%% variable, but should NOT alter/remove any existing entries.</i>
<a name="135"/>  135: <i>%%--------------------------------------------------------------------</i>
<a name="init_per_testcase-2"/><a name="136"/>  136: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="137"/>  137:     Config.
<a name="138"/>  138: 
<a name="139"/>  139: 
<a name="140"/>  140: <i>%%--------------------------------------------------------------------</i>
<a name="141"/>  141: <i>%% Function: end_per_testcase(Case, Config) -&gt; _</i>
<a name="142"/>  142: <i>%% Case - atom()</i>
<a name="143"/>  143: <i>%%   Name of the test case that is about to be run.</i>
<a name="144"/>  144: <i>%% Config - [tuple()]</i>
<a name="145"/>  145: <i>%%   A list of key/value pairs, holding the test case configuration.</i>
<a name="146"/>  146: <i>%% Description: Cleanup after each test case</i>
<a name="147"/>  147: <i>%%--------------------------------------------------------------------</i>
<a name="end_per_testcase-2"/><a name="148"/>  148: <b>end_per_testcase</b>(_Case, Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="149"/>  149:     Config.
<a name="150"/>  150: 
<a name="151"/>  151: 
<a name="152"/>  152: <i>%%-------------------------------------------------------------------------</i>
<a name="153"/>  153: <i>%% Test cases starts here.</i>
<a name="154"/>  154: <i>%%-------------------------------------------------------------------------</i>
<a name="uri_too_long_414-0"/><a name="155"/>  155: <b>uri_too_long_414</b>() -&gt;
<a name="uri_too_long_414-last_expr"/><a name="156"/>  156:     [{doc, &quot;Test that too long uri's get 414 HTTP code&quot;}].
<a name="uri_too_long_414-1"/><a name="157"/>  157: <b>uri_too_long_414</b>(Config) when is_list(Config) -&gt;
<a name="158"/>  158:     HttpdConf =   proplists:get_value(httpd_conf, Config),    
<a name="159"/>  159:     {ok, Pid} = inets:start(httpd, [{max_uri_size, 10} 
<a name="160"/>  160: 				    | HttpdConf]),
<a name="161"/>  161:     Info = httpd:info(Pid),
<a name="162"/>  162:     Port = proplists:get_value(port, Info),
<a name="163"/>  163:     Address = proplists:get_value(bind_address, Info),
<a name="164"/>  164:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="165"/>  165:  				       &quot;GET /morethantenchars &quot;
<a name="166"/>  166:  				       &quot;HTTP/1.1\r\n\r\n&quot;,
<a name="167"/>  167:  				       [{statuscode, 414},                            
<a name="168"/>  168:        			        {version, &quot;HTTP/1.1&quot;}]),
<a name="uri_too_long_414-last_expr"/><a name="169"/>  169: <b>    inets:stop</b>(httpd, Pid).
<a name="170"/>  170: 
<a name="171"/>  171: <i>%%-------------------------------------------------------------------------</i>
<a name="header_too_long_413-0"/><a name="172"/>  172: <b>header_too_long_413</b>() -&gt;
<a name="header_too_long_413-last_expr"/><a name="173"/>  173:     [{doc,&quot;Test that too long headers's get 413 HTTP code&quot;}].
<a name="header_too_long_413-1"/><a name="174"/>  174: <b>header_too_long_413</b>(Config) when is_list(Config) -&gt;
<a name="175"/>  175:     HttpdConf = proplists:get_value(httpd_conf, Config), 
<a name="176"/>  176:     {ok, Pid} = inets:start(httpd, [{max_header_size, 10}
<a name="177"/>  177: 				    | HttpdConf]),
<a name="178"/>  178:     Info = httpd:info(Pid),
<a name="179"/>  179:     Port = proplists:get_value(port, Info),
<a name="180"/>  180:     Address = proplists:get_value(bind_address, Info),
<a name="181"/>  181:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="182"/>  182:  				       &quot;GET index.html &quot;
<a name="183"/>  183:  				       &quot;HTTP/1.1\r\n&quot;
<a name="184"/>  184: 				       &quot;Connection:close \r\n\r\n &quot;,
<a name="185"/>  185:  				       [{statuscode, 413},
<a name="186"/>  186:  				        {version, &quot;HTTP/1.1&quot;}]),
<a name="header_too_long_413-last_expr"/><a name="187"/>  187: <b>    inets:stop</b>(httpd, Pid).
<a name="188"/>  188: 
<a name="189"/>  189: <i>%%-------------------------------------------------------------------------</i>
<a name="190"/>  190: 
<a name="http_0_9_not_supported-0"/><a name="191"/>  191: <b>http_0_9_not_supported</b>() -&gt;
<a name="http_0_9_not_supported-last_expr"/><a name="192"/>  192:     [{doc, &quot;Test that HTTP 0.9 is not supported&quot;}].
<a name="http_0_9_not_supported-1"/><a name="193"/>  193: <b>http_0_9_not_supported</b>(Config) when is_list(Config) -&gt;
<a name="194"/>  194:     HttpdConf =   proplists:get_value(httpd_conf, Config),
<a name="195"/>  195:     {ok, Pid} = inets:start(httpd, HttpdConf),
<a name="196"/>  196:     Info = httpd:info(Pid),
<a name="197"/>  197:     Port = proplists:get_value(port, Info),
<a name="198"/>  198:     Address = proplists:get_value(bind_address, Info),
<a name="199"/>  199: 
<a name="200"/>  200:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(),
<a name="201"/>  201:      				       &quot;GET /\r\n\r\n&quot;,
<a name="202"/>  202:      				       [{statuscode, 505},
<a name="203"/>  203:      				        {version, &quot;HTTP/1.1&quot;}]),
<a name="http_0_9_not_supported-last_expr"/><a name="204"/>  204: <b>    inets:stop</b>(httpd, Pid).
<a name="205"/>  205: 
<a name="206"/>  206: <i>%%-------------------------------------------------------------------------</i>
<a name="207"/>  207: 
<a name="entity_too_long-0"/><a name="208"/>  208: <b>entity_too_long</b>() -&gt;
<a name="entity_too_long-last_expr"/><a name="209"/>  209:     [{doc, &quot;Test that too long versions and method strings are rejected&quot;}].
<a name="entity_too_long-1"/><a name="210"/>  210: <b>entity_too_long</b>(Config) when is_list(Config) -&gt;
<a name="211"/>  211:     HttpdConf =   proplists:get_value(httpd_conf, Config),    
<a name="212"/>  212:     {ok, Pid} = inets:start(httpd, HttpdConf),
<a name="213"/>  213:     Info = httpd:info(Pid),
<a name="214"/>  214:     Port = proplists:get_value(port, Info),
<a name="215"/>  215:     Address = proplists:get_value(bind_address, Info),
<a name="216"/>  216:     
<a name="217"/>  217:     %% Not so long but wrong
<a name="218"/>  218:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="219"/>  219:      				       &quot;GET / &quot; ++
<a name="220"/>  220: 					   lists:duplicate(5, $A) ++ &quot;\r\n\r\n&quot;,
<a name="221"/>  221:      				       [{statuscode, 400},
<a name="222"/>  222:      				        {version, &quot;HTTP/1.1&quot;}]),
<a name="223"/>  223: 
<a name="224"/>  224:     %% Too long
<a name="225"/>  225:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="226"/>  226:  				       &quot;GET / &quot; ++
<a name="227"/>  227: 					   lists:duplicate(100, $A) ++ &quot;\r\n\r\n&quot;,
<a name="228"/>  228:  				       [{statuscode, 413},
<a name="229"/>  229:  				        {version, &quot;HTTP/1.1&quot;}]),
<a name="230"/>  230:     %% Not so long but wrong
<a name="231"/>  231:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="232"/>  232: 				       lists:duplicate(5, $A) ++ &quot; / &quot;
<a name="233"/>  233: 				       &quot;HTTP/1.1\r\n\r\n&quot;,
<a name="234"/>  234:  				       [{statuscode, 501},
<a name="235"/>  235: 					%% Server will send lowest version
<a name="236"/>  236: 					%% as it will not get to the 
<a name="237"/>  237: 					%% client version
<a name="238"/>  238: 					%% before aborting
<a name="239"/>  239:  				        {version, &quot;HTTP/1.1&quot;}]),
<a name="240"/>  240:     %% Too long
<a name="241"/>  241:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(), 
<a name="242"/>  242: 				       lists:duplicate(100, $A) ++ &quot; / &quot;
<a name="243"/>  243: 				       &quot;HTTP/1.1\r\n\r\n&quot;,
<a name="244"/>  244:  				       [{statuscode, 413},
<a name="245"/>  245: 					%% Server will send lowest version
<a name="246"/>  246: 					%% as it will not get to the 
<a name="247"/>  247: 					%% client version
<a name="248"/>  248: 					%% before aborting
<a name="249"/>  249:  				        {version, &quot;HTTP/1.1&quot;}]),   
<a name="entity_too_long-last_expr"/><a name="250"/>  250: <b>    inets:stop</b>(httpd, Pid).
<a name="251"/>  251:     
<a name="252"/>  252: <i>%%-------------------------------------------------------------------------</i>
<a name="253"/>  253: 
<a name="script_nocache-0"/><a name="254"/>  254: <b>script_nocache</b>() -&gt;
<a name="script_nocache-last_expr"/><a name="255"/>  255:     [{doc,&quot;Test nocache option for mod_cgi and mod_esi&quot;}].
<a name="script_nocache-1"/><a name="256"/>  256: <b>script_nocache</b>(Config) when is_list(Config) -&gt;
<a name="257"/>  257:     Normal = {no_header, &quot;cache-control&quot;},
<a name="258"/>  258:     NoCache = {header, &quot;cache-control&quot;, &quot;no-cache&quot;},
<a name="259"/>  259:     verify_script_nocache(Config, false, false, Normal, Normal),
<a name="260"/>  260:     verify_script_nocache(Config, true, false, NoCache, Normal),
<a name="261"/>  261:     verify_script_nocache(Config, false, true, Normal, NoCache),
<a name="script_nocache-last_expr"/><a name="262"/>  262: <b>    verify_script_nocache</b>(Config, true, true, NoCache, NoCache).
<a name="263"/>  263: 
<a name="264"/>  264: <i>%%-------------------------------------------------------------------------</i>
<a name="erl_script_nocache_opt-1"/><a name="265"/>  265: <b>erl_script_nocache_opt</b>(doc) -&gt;
<a name="266"/>  266:     [&quot;Test that too long headers's get 413 HTTP code&quot;];
<a name="267"/>  267: <b>erl_script_nocache_opt</b>(suite) -&gt;
<a name="268"/>  268:     [];
<a name="269"/>  269: <b>erl_script_nocache_opt</b>(Config) when is_list(Config) -&gt;
<a name="270"/>  270:     HttpdConf   = proplists:get_value(httpd_conf, Config),
<a name="271"/>  271:     {ok, Pid}   = inets:start(httpd, [{port, 0}, {erl_script_nocache, true} | HttpdConf]),
<a name="272"/>  272:     Info        = httpd:info(Pid),
<a name="273"/>  273:     Port        = proplists:get_value(port,         Info),
<a name="274"/>  274:     _Address    = proplists:get_value(bind_address, Info),
<a name="275"/>  275:     URL1        = ?URL_START ++ integer_to_list(Port),
<a name="276"/>  276:     case httpc:request(get, {URL1 ++ &quot;/dummy.html&quot;, []},
<a name="277"/>  277: 		       [{url_encode,  false}, 
<a name="278"/>  278: 			{version,     &quot;HTTP/1.0&quot;}],
<a name="279"/>  279: 		       [{full_result, false}]) of
<a name="280"/>  280: 	{ok, {200, _}} -&gt;
<a name="281"/>  281: 	    ok
<a name="282"/>  282:     end,
<a name="erl_script_nocache_opt-last_expr"/><a name="283"/>  283: <b>    inets:stop</b>(httpd, Pid).
<a name="284"/>  284: 
<a name="285"/>  285: <i>%%-------------------------------------------------------------------------</i>
<a name="286"/>  286: 
<a name="287"/>  287: 
<a name="288"/>  288: <i>%%-------------------------------------------------------------------------</i>
<a name="289"/>  289: 
<a name="escaped_url_in_error_body-0"/><a name="290"/>  290: <b>escaped_url_in_error_body</b>() -&gt;
<a name="escaped_url_in_error_body-last_expr"/><a name="291"/>  291:     [{doc, &quot;Test Url-encoding see OTP-8940&quot;}].
<a name="escaped_url_in_error_body-1"/><a name="292"/>  292: <b>escaped_url_in_error_body</b>(Config) when is_list(Config) -&gt; 
<a name="293"/>  293:     HttpdConf   = proplists:get_value(httpd_conf, Config),
<a name="294"/>  294:     {ok, Pid}   = inets:start(httpd, [{port, 0} | HttpdConf]),
<a name="295"/>  295:     Info        = httpd:info(Pid),
<a name="296"/>  296:     Port        = proplists:get_value(port,         Info),
<a name="297"/>  297:     URL1        = ?URL_START ++ integer_to_list(Port),
<a name="298"/>  298:    
<a name="299"/>  299:     %% Sanity check
<a name="300"/>  300:     {ok, {200, _}} = httpc:request(get, {URL1 ++ &quot;/dummy.html&quot;, []},
<a name="301"/>  301:      				   [{url_encode,  false}, 
<a name="302"/>  302:      				    {version,     &quot;HTTP/1.0&quot;}],
<a name="303"/>  303:      				   [{full_result, false}]),
<a name="304"/>  304:     {ok, {200, _}} = httpc:request(get, {URL1 ++ &quot;/dummy.html&quot;, []},
<a name="305"/>  305:      				   [{url_encode,  true}, 
<a name="306"/>  306:      				    {version,     &quot;HTTP/1.0&quot;}],
<a name="307"/>  307:      				   [{full_result, false}]),
<a name="308"/>  308:     
<a name="309"/>  309:     %% Ask for a non-existing page(1)
<a name="310"/>  310:     Path            = &quot;/&lt;b&gt;this_is_bold&lt;b&gt;&quot;,
<a name="311"/>  311:     URL2 = uri_string:recompose(#{scheme =&gt; &quot;http&quot;,
<a name="312"/>  312:                                   host =&gt; &quot;localhost&quot;,
<a name="313"/>  313:                                   port =&gt; Port,
<a name="314"/>  314:                                   path =&gt; Path}),
<a name="315"/>  315:     
<a name="316"/>  316:     #{path := EncodedPath} = uri_string:parse(URL2),
<a name="317"/>  317:     HTMLEncodedPath =  http_util:html_encode(EncodedPath),
<a name="318"/>  318:     {ok, {404, Body3}} = httpc:request(get, {URL2, []},
<a name="319"/>  319: 				       [{url_encode,  true}, 
<a name="320"/>  320: 					{version,     &quot;HTTP/1.0&quot;}],
<a name="321"/>  321: 				       [{full_result, false}]),
<a name="322"/>  322: 
<a name="323"/>  323:     HTMLEncodedPath = find_URL_path(string:tokens(Body3, &quot; &quot;)),
<a name="324"/>  324: 
<a name="325"/>  325:     {ok, {404, Body4}} = httpc:request(get, {URL2, []}, 
<a name="326"/>  326: 				       [{url_encode,  false}, 
<a name="327"/>  327: 					{version,     &quot;HTTP/1.0&quot;}],
<a name="328"/>  328: 				       [{full_result, false}]),
<a name="329"/>  329:     
<a name="330"/>  330:     HTMLEncodedPath = find_URL_path(string:tokens(Body4, &quot; &quot;)),
<a name="escaped_url_in_error_body-last_expr"/><a name="331"/>  331: <b>    inets:stop</b>(httpd, Pid).
<a name="332"/>  332: 
<a name="333"/>  333: <i>%%-------------------------------------------------------------------------</i>
<a name="334"/>  334: 
<a name="keep_alive_timeout-1"/><a name="335"/>  335: <b>keep_alive_timeout</b>(doc) -&gt;
<a name="336"/>  336:     [&quot;Test the keep_alive_timeout option&quot;];
<a name="337"/>  337: <b>keep_alive_timeout</b>(suite) -&gt;
<a name="338"/>  338:     [];
<a name="339"/>  339: <b>keep_alive_timeout</b>(Config) when is_list(Config) -&gt;
<a name="340"/>  340:     HttpdConf   = proplists:get_value(httpd_conf, Config),
<a name="341"/>  341:     {ok, Pid}   = inets:start(httpd, [{port, 0}, {keep_alive, true}, {keep_alive_timeout, 2} | HttpdConf]),
<a name="342"/>  342:     Info        = httpd:info(Pid),
<a name="343"/>  343:     Port        = proplists:get_value(port,         Info),
<a name="344"/>  344:     _Address    = proplists:get_value(bind_address, Info),
<a name="345"/>  345:     {ok, S} = gen_tcp:connect(&quot;localhost&quot;, Port, []),
<a name="346"/>  346:     receive
<a name="347"/>  347:     after 3000 -&gt;
<a name="348"/>  348: 	    {error, closed} = gen_tcp:send(S, &quot;hey&quot;)
<a name="349"/>  349:     end,
<a name="keep_alive_timeout-last_expr"/><a name="350"/>  350: <b>    inets:stop</b>(httpd, Pid).
<a name="351"/>  351: 
<a name="352"/>  352: <i>%%-------------------------------------------------------------------------</i>
<a name="353"/>  353: 
<a name="script_timeout-1"/><a name="354"/>  354: <b>script_timeout</b>(doc) -&gt;
<a name="355"/>  355:     [&quot;Test the httpd script_timeout option&quot;];
<a name="356"/>  356: <b>script_timeout</b>(suite) -&gt;
<a name="357"/>  357:     [];
<a name="358"/>  358: <b>script_timeout</b>(Config) when is_list(Config) -&gt;
<a name="359"/>  359:     verify_script_timeout(Config, 20, 200),
<a name="360"/>  360:     verify_script_timeout(Config, 5, 403),
<a name="script_timeout-last_expr"/><a name="361"/>  361:     ok.
<a name="362"/>  362: 
<a name="verify_script_timeout-3"/><a name="363"/>  363: <b>verify_script_timeout</b>(Config, ScriptTimeout, StatusCode) -&gt;
<a name="364"/>  364:     HttpdConf = proplists:get_value(httpd_conf, Config),
<a name="365"/>  365:     CgiScript = proplists:get_value(cgi_sleep, Config),
<a name="366"/>  366:     CgiDir = proplists:get_value(cgi_dir, Config),
<a name="367"/>  367:     {ok, Pid} = inets:start(httpd, [{port, 0},
<a name="368"/>  368: 				    {script_alias,
<a name="369"/>  369: 				     {&quot;/cgi-bin/&quot;, CgiDir ++ &quot;/&quot;}},
<a name="370"/>  370: 				    {script_timeout, ScriptTimeout}
<a name="371"/>  371: 				    | HttpdConf]),
<a name="372"/>  372:     Info = httpd:info(Pid),
<a name="373"/>  373:     Port = proplists:get_value(port, Info),
<a name="374"/>  374:     Address = proplists:get_value(bind_address, Info),
<a name="375"/>  375:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(),
<a name="376"/>  376: 				       &quot;GET /cgi-bin/&quot; ++ CgiScript ++
<a name="377"/>  377: 					   &quot; HTTP/1.0\r\n\r\n&quot;,
<a name="378"/>  378: 				       [{statuscode, StatusCode},
<a name="379"/>  379: 					{version, &quot;HTTP/1.0&quot;}]),
<a name="verify_script_timeout-last_expr"/><a name="380"/>  380: <b>    inets:stop</b>(httpd, Pid).
<a name="381"/>  381: 
<a name="382"/>  382: <i>%%-------------------------------------------------------------------------</i>
<a name="383"/>  383: 
<a name="slowdose-0"/><a name="384"/>  384: <b>slowdose</b>() -&gt;
<a name="slowdose-last_expr"/><a name="385"/>  385:     [{doc, &quot;Testing minimum bytes per second option&quot;}].
<a name="slowdose-1"/><a name="386"/>  386: <b>slowdose</b>(Config) when is_list(Config) -&gt;
<a name="387"/>  387:     HttpdConf =   proplists:get_value(httpd_conf, Config),
<a name="388"/>  388:     {ok, Pid} = inets:start(httpd, [{port, 0}, {minimum_bytes_per_second, 200}|HttpdConf]),
<a name="389"/>  389:     Info = httpd:info(Pid),
<a name="390"/>  390:     Port = proplists:get_value(port, Info),
<a name="391"/>  391:     {ok, Socket} = gen_tcp:connect(&quot;localhost&quot;, Port, []),
<a name="slowdose-last_expr"/><a name="392"/>  392:     receive
<a name="393"/>  393:     after 6000 -&gt;
<a name="394"/>  394: 	    {error, closed} = gen_tcp:send(Socket, &quot;Hey&quot;)
<a name="395"/>  395:     end.
<a name="396"/>  396: 
<a name="397"/>  397: <i>%%-------------------------------------------------------------------------</i>
<a name="398"/>  398: 
<a name="invalid_rfc1123_date-0"/><a name="399"/>  399: <b>invalid_rfc1123_date</b>() -&gt;
<a name="invalid_rfc1123_date-last_expr"/><a name="400"/>  400:     [{doc, &quot;Test that a non-DST date is handled correctly&quot;}].
<a name="invalid_rfc1123_date-1"/><a name="401"/>  401: <b>invalid_rfc1123_date</b>(Config) when is_list(Config) -&gt;
<a name="402"/>  402:     Rfc1123FormattedDate = &quot;Sun, 26 Mar 2017 01:00:00 GMT&quot;,
<a name="403"/>  403:     NonDSTDateTime = {{2017, 03, 26},{1, 0, 0}},
<a name="invalid_rfc1123_date-last_expr"/><a name="404"/>  404: <b>    Rfc1123FormattedDate =:= httpd_util:rfc1123_date</b>(NonDSTDateTime).
<a name="405"/>  405: 
<a name="406"/>  406: 
<a name="407"/>  407: <i>%%-------------------------------------------------------------------------</i>
<a name="408"/>  408: <i>%% Internal functions</i>
<a name="409"/>  409: <i>%%-------------------------------------------------------------------------</i>
<a name="410"/>  410: 
<a name="verify_script_nocache-5"/><a name="411"/>  411: <b>verify_script_nocache</b>(Config, CgiNoCache, EsiNoCache, CgiOption, EsiOption) -&gt;
<a name="412"/>  412:     HttpdConf = proplists:get_value(httpd_conf, Config),
<a name="413"/>  413:     CgiScript = proplists:get_value(cgi_printenv, Config),
<a name="414"/>  414:     CgiDir = proplists:get_value(cgi_dir, Config),
<a name="415"/>  415:     {ok, Pid} = inets:start(httpd, [{port, 0},
<a name="416"/>  416: 				    {script_alias,
<a name="417"/>  417: 				     {&quot;/cgi-bin/&quot;, CgiDir ++ &quot;/&quot;}},
<a name="418"/>  418: 				    {script_nocache, CgiNoCache},
<a name="419"/>  419: 				    {erl_script_alias,
<a name="420"/>  420: 				     {&quot;/cgi-bin/erl&quot;, [httpd_example,io]}},
<a name="421"/>  421: 				    {erl_script_nocache, EsiNoCache}
<a name="422"/>  422: 				    | HttpdConf]),
<a name="423"/>  423:     Info = httpd:info(Pid),
<a name="424"/>  424:     Port = proplists:get_value(port, Info),
<a name="425"/>  425:     Address = proplists:get_value(bind_address, Info),
<a name="426"/>  426:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(),
<a name="427"/>  427: 				       &quot;GET /cgi-bin/&quot; ++ CgiScript ++
<a name="428"/>  428: 					   &quot; HTTP/1.0\r\n\r\n&quot;,
<a name="429"/>  429: 				       [{statuscode, 200},
<a name="430"/>  430: 					CgiOption,
<a name="431"/>  431: 					{version, &quot;HTTP/1.0&quot;}]),
<a name="432"/>  432:     ok = httpd_test_lib:verify_request(ip_comm, Address, Port, node(),
<a name="433"/>  433: 				       &quot;GET /cgi-bin/erl/httpd_example:get &quot;
<a name="434"/>  434: 				       &quot;HTTP/1.0\r\n\r\n&quot;,
<a name="435"/>  435: 				       [{statuscode, 200},
<a name="436"/>  436: 					EsiOption,
<a name="437"/>  437: 					{version, &quot;HTTP/1.0&quot;}]),
<a name="verify_script_nocache-last_expr"/><a name="438"/>  438: <b>    inets:stop</b>(httpd, Pid).
<a name="439"/>  439: 
<a name="find_URL_path-1"/><a name="440"/>  440: <b>find_URL_path</b>([]) -&gt;
<a name="441"/>  441:     &quot;&quot;;
<a name="442"/>  442: <b>find_URL_path</b>([&quot;URL&quot;, URL | _]) -&gt;
<a name="443"/>  443:     URL;
<a name="444"/>  444: <b>find_URL_path</b>([_ | Rest]) -&gt;
<a name="find_URL_path-last_expr"/><a name="445"/>  445: <b>    find_URL_path</b>(Rest).
<a name="446"/>  446: 
<a name="skip-1"/><a name="447"/>  447: <b>skip</b>(Reason) -&gt;
<a name="skip-last_expr"/><a name="448"/>  448:     {skip, Reason}.
<a name="449"/>  449: 
</pre>
</body>
</html>
