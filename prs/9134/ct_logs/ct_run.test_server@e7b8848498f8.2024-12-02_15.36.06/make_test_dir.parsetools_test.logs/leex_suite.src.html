<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/parsetools/make_test_dir/parsetools_test/leex_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2010-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(leex_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <i>%-define(debug, true).</i>
<a name="23"/>   23: 
<a name="24"/>   24: <b>-include_lib</b>(&quot;stdlib/include/erl_compile.hrl&quot;).
<a name="25"/>   25: <b>-include_lib</b>(&quot;stdlib/include/assert.hrl&quot;).
<a name="26"/>   26: <b>-include_lib</b>(&quot;kernel/include/file.hrl&quot;).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-ifdef</b>(debug).
<a name="29"/>   29: <b>-define</b>(config(X,Y), foo).
<a name="30"/>   30: <b>-define</b>(datadir, &quot;leex_SUITE_data&quot;).
<a name="31"/>   31: <b>-define</b>(privdir, &quot;leex_SUITE_priv&quot;).
<a name="32"/>   32: -else.
<a name="33"/>   33: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="34"/>   34: <b>-define</b>(datadir, ?config(data_dir, Config)).
<a name="35"/>   35: <b>-define</b>(privdir, ?config(priv_dir, Config)).
<a name="36"/>   36: -endif.
<a name="37"/>   37: 
<a name="38"/>   38: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1, 
<a name="39"/>   39: 	 init_per_group/2,end_per_group/2, 
<a name="40"/>   40: 	 init_per_testcase/2, end_per_testcase/2]).
<a name="41"/>   41: 
<a name="42"/>   42: <b>-export</b>([
<a name="43"/>   43: 	 file/1, compile/1, syntax/1, deterministic/1,
<a name="44"/>   44: 	 
<a name="45"/>   45: 	 pt/1, man/1, ex/1, ex2/1, not_yet/1,
<a name="46"/>   46: 	 line_wrap/1,
<a name="47"/>   47: 	 otp_10302/1, otp_11286/1, unicode/1, otp_13916/1, otp_14285/1,
<a name="48"/>   48:          otp_17023/1, compiler_warnings/1, column_support/1]).
<a name="49"/>   49: 
<a name="50"/>   50: <i>% Default timetrap timeout (set in init_per_testcase).</i>
<a name="51"/>   51: <b>-define</b>(default_timeout, test_server:minutes(1)).
<a name="52"/>   52: 
<a name="init_per_testcase-2"/><a name="53"/>   53: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="54"/>   54:     Dog = test_server:timetrap(?default_timeout),
<a name="init_per_testcase-last_expr"/><a name="55"/>   55:     [{watchdog, Dog} | Config].
<a name="56"/>   56: 
<a name="end_per_testcase-2"/><a name="57"/>   57: <b>end_per_testcase</b>(_Case, Config) -&gt;
<a name="58"/>   58:     Dog = ?config(watchdog, Config),
<a name="59"/>   59:     test_server:timetrap_cancel(Dog),
<a name="end_per_testcase-last_expr"/><a name="60"/>   60:     ok.
<a name="61"/>   61: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="62"/>   62: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="63"/>   63: 
<a name="all-0"/><a name="64"/>   64: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="65"/>   65:     [{group, checks}, {group, examples}, {group, tickets}, {group, bugs}].
<a name="66"/>   66: 
<a name="groups-0"/><a name="67"/>   67: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="68"/>   68:     [{checks, [], [file, compile, syntax, deterministic]},
<a name="69"/>   69:      {examples, [], [pt, man, ex, ex2, not_yet, unicode, column_support]},
<a name="70"/>   70:      {tickets, [], [otp_10302, otp_11286, otp_13916, otp_14285, otp_17023,
<a name="71"/>   71:                     compiler_warnings]},
<a name="72"/>   72:      {bugs, [], [line_wrap]}].
<a name="73"/>   73: 
<a name="init_per_suite-1"/><a name="74"/>   74: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="75"/>   75:     Config.
<a name="76"/>   76: 
<a name="end_per_suite-1"/><a name="77"/>   77: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="78"/>   78:     ok.
<a name="79"/>   79: 
<a name="init_per_group-2"/><a name="80"/>   80: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="81"/>   81:     Config.
<a name="82"/>   82: 
<a name="end_per_group-2"/><a name="83"/>   83: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="84"/>   84:     Config.
<a name="85"/>   85: 
<a name="86"/>   86: 
<a name="87"/>   87: 
<a name="file-1"/><a name="88"/>   88: <b>file</b>(doc) -&gt;
<a name="89"/>   89:     &quot;Bad files and options.&quot;;
<a name="90"/>   90: <b>file</b>(suite) -&gt; [];
<a name="91"/>   91: <b>file</b>(Config) when is_list(Config) -&gt;
<a name="92"/>   92:     Dir = ?privdir,
<a name="93"/>   93:     Ret = [return, {report, false}],
<a name="94"/>   94:     {error,[{_,[{none,leex,{file_error,_}}]}],[]} = 
<a name="95"/>   95:         leex:file(&quot;not_a_file&quot;, Ret),
<a name="96"/>   96:     {error,[{_,[{none,leex,{file_error,_}}]}],[]} = 
<a name="97"/>   97:         leex:file(&quot;not_a_file&quot;, [{return,true}]),
<a name="98"/>   98:     {error,[{_,[{none,leex,{file_error,_}}]}],[]} = 
<a name="99"/>   99:         leex:file(&quot;not_a_file&quot;, [{report,false},return_errors]),
<a name="100"/>  100:     error = leex:file(&quot;not_a_file&quot;),
<a name="101"/>  101:     error = leex:file(&quot;not_a_file&quot;, [{return,false},report]),
<a name="102"/>  102:     error = leex:file(&quot;not_a_file&quot;, [return_warnings,{report,false}]),
<a name="103"/>  103: 
<a name="104"/>  104:     Filename = filename:join(Dir, &quot;file.xrl&quot;),
<a name="105"/>  105:     file:delete(Filename),
<a name="106"/>  106: 
<a name="107"/>  107:     {'EXIT', {badarg, _}} = (catch leex:file({foo})),
<a name="108"/>  108:     {'EXIT', {badarg, _}} = 
<a name="109"/>  109:         (catch leex:file(Filename, {parserfile,{foo}})),
<a name="110"/>  110:     {'EXIT', {badarg, _}} = 
<a name="111"/>  111:         (catch leex:file(Filename, {includefile,{foo}})),
<a name="112"/>  112: 
<a name="113"/>  113:     {'EXIT', {badarg, _}} = (catch leex:file(Filename, no_option)),
<a name="114"/>  114:     {'EXIT', {badarg, _}} = 
<a name="115"/>  115:         (catch leex:file(Filename, [return | report])),
<a name="116"/>  116:     {'EXIT', {badarg, _}} = 
<a name="117"/>  117:         (catch leex:file(Filename, {return,foo})),
<a name="118"/>  118:     {'EXIT', {badarg, _}} = 
<a name="119"/>  119:         (catch leex:file(Filename, includefile)),
<a name="120"/>  120: 
<a name="121"/>  121:     {'EXIT', {badarg, _}} =
<a name="122"/>  122:         (catch leex:file(Filename, {tab_size,0})),
<a name="123"/>  123:     {'EXIT', {badarg, _}} =
<a name="124"/>  124:         (catch leex:file(Filename, {tab_size,&quot;4&quot;})),
<a name="125"/>  125:     {'EXIT', {badarg, _}} =
<a name="126"/>  126:         (catch leex:file(Filename, {tab_size,3.5})),
<a name="127"/>  127:     {'EXIT', {badarg, _}} =
<a name="128"/>  128:         (catch leex:file(Filename, {error_location,{line,column}})),
<a name="129"/>  129:     {'EXIT', {badarg, _}} =
<a name="130"/>  130:         (catch leex:file(Filename, {error_location,col})),
<a name="131"/>  131: 
<a name="132"/>  132:     Mini = &lt;&lt;&quot;Definitions.\n&quot;
<a name="133"/>  133:              &quot;D  = [0-9]\n&quot;
<a name="134"/>  134:              &quot;Rules.\n&quot;
<a name="135"/>  135:              &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n&quot;
<a name="136"/>  136:              &quot;Erlang code.\n&quot;&gt;&gt;,
<a name="137"/>  137:     ok = file:write_file(Filename, Mini),
<a name="138"/>  138:     {error,[{_,[{none,leex,{file_error,_}}]}],[]} = 
<a name="139"/>  139:         leex:file(Filename, [{includefile,&quot;/ /&quot;} | Ret]),
<a name="140"/>  140: 
<a name="141"/>  141:     LeexPre = filename:join(Dir, &quot;leexinc.hrl&quot;),
<a name="142"/>  142:     ok = file:write_file(LeexPre, &lt;&lt;&quot;syntax error.\n&quot;&gt;&gt;),
<a name="143"/>  143:     PreErrors = run_test(Config, Mini, LeexPre),
<a name="144"/>  144:     {errors,
<a name="145"/>  145:            [{{1,8},_,[&quot;syntax error before: &quot;,&quot;error&quot;]},
<a name="146"/>  146:             {{3,1},_,undefined_module}],
<a name="147"/>  147:            []} =
<a name="148"/>  148:         extract(LeexPre, PreErrors),
<a name="149"/>  149:     file:delete(LeexPre),
<a name="150"/>  150: 
<a name="151"/>  151:     Ret2 = [return, report_errors, report_warnings, verbose],
<a name="152"/>  152:     Scannerfile = filename:join(Dir, &quot;file.erl&quot;),
<a name="153"/>  153:     ok = file:write_file(Scannerfile, &lt;&lt;&quot;nothing&quot;&gt;&gt;),
<a name="154"/>  154:     unwritable(Scannerfile),
<a name="155"/>  155:     {error,[{_,[{none,leex,{file_error,_}}]}],[]} = 
<a name="156"/>  156:         leex:file(Filename, Ret2),
<a name="157"/>  157:     writable(Scannerfile),
<a name="158"/>  158:     file:delete(Scannerfile),
<a name="159"/>  159: 
<a name="160"/>  160:     Dotfile = filename:join(Dir, &quot;file.dot&quot;),
<a name="161"/>  161:     ok = file:write_file(Dotfile, &lt;&lt;&quot;nothing&quot;&gt;&gt;),
<a name="162"/>  162:     unwritable(Dotfile),
<a name="163"/>  163:     {error,[{_,[{none,leex,{file_error,_}}]}],[]} = 
<a name="164"/>  164:         leex:file(Filename, [dfa_graph | Ret2]),
<a name="165"/>  165:     writable(Dotfile),
<a name="166"/>  166:     file:delete(Dotfile),
<a name="167"/>  167: 
<a name="168"/>  168:     ok = file:delete(Scannerfile),
<a name="169"/>  169:     Warn = &lt;&lt;&quot;Definitions.1998\n&quot;
<a name="170"/>  170:              &quot;D  = [0-9]\n&quot;
<a name="171"/>  171:              &quot;Rules.\n&quot;
<a name="172"/>  172:              &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n&quot;
<a name="173"/>  173:              &quot;Erlang code.\n&quot;&gt;&gt;,
<a name="174"/>  174:     ok = file:write_file(Filename, Warn),
<a name="175"/>  175:     error = leex:file(Filename, [warnings_as_errors]),
<a name="176"/>  176:     false = filelib:is_regular(Scannerfile),
<a name="177"/>  177:     error = leex:file(Filename, [return_warnings,warnings_as_errors]),
<a name="178"/>  178:     false = filelib:is_regular(Scannerfile),
<a name="179"/>  179:     {error,_,[{Filename,[{1,leex,ignored_characters}]}]} =
<a name="180"/>  180:         leex:file(Filename, [return_errors,warnings_as_errors]),
<a name="181"/>  181:     false = filelib:is_regular(Scannerfile),
<a name="182"/>  182:     {ok,Scannerfile,[{Filename,[{1,leex,ignored_characters}]}]} =
<a name="183"/>  183:         leex:file(Filename, [return_warnings]),
<a name="184"/>  184:     true = filelib:is_regular(Scannerfile),
<a name="185"/>  185: 
<a name="186"/>  186:     file:delete(Filename),
<a name="file-last_expr"/><a name="187"/>  187:     ok.
<a name="188"/>  188: 
<a name="compile-1"/><a name="189"/>  189: <b>compile</b>(doc) -&gt;
<a name="190"/>  190:     &quot;Check of compile/3.&quot;;
<a name="191"/>  191: <b>compile</b>(suite) -&gt; [];
<a name="192"/>  192: <b>compile</b>(Config) when is_list(Config) -&gt;
<a name="193"/>  193:     Dir = ?privdir,
<a name="194"/>  194:     Filename = filename:join(Dir, &quot;file.xrl&quot;),
<a name="195"/>  195:     Scannerfile = filename:join(Dir, &quot;file.erl&quot;),
<a name="196"/>  196:     Mini = &lt;&lt;&quot;Definitions.\n&quot;
<a name="197"/>  197:              &quot;D  = [0-9]\n&quot;
<a name="198"/>  198:              &quot;Rules.\n&quot;
<a name="199"/>  199:              &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n&quot;
<a name="200"/>  200:              &quot;Erlang code.\n&quot;&gt;&gt;,
<a name="201"/>  201:     ok = file:write_file(Filename, Mini),
<a name="202"/>  202:     ok = leex:compile(Filename, Scannerfile, #options{}),
<a name="203"/>  203:     file:delete(Scannerfile),
<a name="204"/>  204:     file:delete(Filename),
<a name="compile-last_expr"/><a name="205"/>  205:     ok.
<a name="206"/>  206: 
<a name="syntax-1"/><a name="207"/>  207: <b>syntax</b>(doc) -&gt;
<a name="208"/>  208:     &quot;Syntax checks.&quot;;
<a name="209"/>  209: <b>syntax</b>(suite) -&gt; [];
<a name="210"/>  210: <b>syntax</b>(Config) when is_list(Config) -&gt;
<a name="211"/>  211:     Dir = ?privdir,
<a name="212"/>  212:     Filename = filename:join(Dir, &quot;file.xrl&quot;),
<a name="213"/>  213:     Ret = [return, {report, true}],
<a name="214"/>  214:     ok = file:write_file(Filename, 
<a name="215"/>  215:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="216"/>  216:                                  &quot;D  = [0-9]\n&quot;
<a name="217"/>  217:                                  &quot;%% comment\n&quot;
<a name="218"/>  218:                                  &quot;Rules.\n&quot;
<a name="219"/>  219:                                  &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n
<a name="220"/>  220:                                  &quot;&gt;&gt;),
<a name="221"/>  221:     {error,[{_,[{7,leex,missing_code}]}],[]} = leex:file(Filename, Ret),
<a name="222"/>  222:     ok = file:write_file(Filename, 
<a name="223"/>  223:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="224"/>  224:                                  &quot;D  = [0-9]\n&quot;
<a name="225"/>  225:                                  &quot;Rules.\n&quot;
<a name="226"/>  226:                                  &quot;{L}+  : \n&quot;&gt;&gt;),
<a name="227"/>  227:     {error,[{_,[{5,leex,missing_code}]}],[]} = leex:file(Filename, Ret),
<a name="228"/>  228:     ok = file:write_file(Filename, 
<a name="229"/>  229:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="230"/>  230:                                  &quot;D  = [0-9]\n&quot;
<a name="231"/>  231:                                  &quot;Rules.\n&quot;
<a name="232"/>  232:                                  &quot;[] :&quot;&gt;&gt;),
<a name="233"/>  233:     {error,[{_,[{4,leex,{regexp,_}}]}],[]} = 
<a name="234"/>  234:         leex:file(Filename, Ret),
<a name="235"/>  235:     ok = file:write_file(Filename, 
<a name="236"/>  236:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="237"/>  237:                                  &quot;D  = [0-9]\n&quot;
<a name="238"/>  238:                                  &quot;Rules.\n&quot;
<a name="239"/>  239:                                  &quot;{L}+ : .\n&quot;
<a name="240"/>  240:                                  &quot;[] : &quot;&gt;&gt;),
<a name="241"/>  241:     {error,[{_,[{5,leex,{regexp,_}}]}],[]} = 
<a name="242"/>  242:         leex:file(Filename, Ret),
<a name="243"/>  243:     ok = file:write_file(Filename, 
<a name="244"/>  244:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="245"/>  245:                                  &quot;D  = [0-9]\n&quot;
<a name="246"/>  246:                                  &quot;Rules.\n&quot;
<a name="247"/>  247:                                  &quot;[] : .\n&quot;&gt;&gt;),
<a name="248"/>  248:     {error,[{_,[{4,leex,{regexp,_}}]}],[]} = 
<a name="249"/>  249:         leex:file(Filename, Ret),
<a name="250"/>  250:     ok = file:write_file(Filename, 
<a name="251"/>  251:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="252"/>  252:                                  &quot;D  = [0-9]\n&quot;
<a name="253"/>  253:                                  &quot;Rules.\n&quot;
<a name="254"/>  254:                                  &quot;{L}+ &quot;&gt;&gt;),
<a name="255"/>  255:     {error,[{_,[{5,leex,bad_rule}]}],[]} = 
<a name="256"/>  256:         leex:file(Filename, Ret),
<a name="257"/>  257:     ok = file:write_file(Filename, 
<a name="258"/>  258:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="259"/>  259:                                  &quot;D  = [0-9]\n&quot;
<a name="260"/>  260:                                  &quot;Rules.\n&quot;
<a name="261"/>  261:                                  &quot;{L}+ ; &quot;&gt;&gt;),
<a name="262"/>  262:     {error,[{_,[{4,leex,bad_rule}]}],[]} = 
<a name="263"/>  263:         leex:file(Filename, Ret),
<a name="264"/>  264:     ok = file:write_file(Filename, 
<a name="265"/>  265:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="266"/>  266:                                  &quot;D  = [0-9]\n&quot;
<a name="267"/>  267:                                  &quot;Rules.\n&quot;
<a name="268"/>  268:                                  &quot;[] : '99\n&quot;&gt;&gt;),
<a name="269"/>  269:     {error,[{_,[{4,erl_scan,_}]}],[]} = leex:file(Filename, Ret),
<a name="270"/>  270:     ok = file:write_file(Filename, 
<a name="271"/>  271:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="272"/>  272:                                  &quot;D  = [0-9]\n&quot;
<a name="273"/>  273:                                  &quot;Rules.\n&quot;&gt;&gt;),
<a name="274"/>  274:     {error,[{_,[{3,leex,empty_rules}]}],[]} = leex:file(Filename, Ret),
<a name="275"/>  275:     ok = file:write_file(Filename, 
<a name="276"/>  276:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="277"/>  277:                                  &quot;D  = [0-9]\n&quot;
<a name="278"/>  278:                                  &quot;Rules.\n&quot;
<a name="279"/>  279:                                  &quot;Erlang code.\n&quot;&gt;&gt;),
<a name="280"/>  280:     {error,[{_,[{4,leex,empty_rules}]}],[]} = leex:file(Filename, Ret),
<a name="281"/>  281:     ok = file:write_file(Filename, 
<a name="282"/>  282:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="283"/>  283:                                  &quot;D  = [0-9]\n&quot;&gt;&gt;),
<a name="284"/>  284:     {error,[{_,[{2,leex,missing_rules}]}],[]} = leex:file(Filename, Ret),
<a name="285"/>  285:     ok = file:write_file(Filename, 
<a name="286"/>  286:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="287"/>  287:                                  &quot;D  = [0-9]\n&quot;
<a name="288"/>  288:                                  &quot;Erlang code.\n&quot;&gt;&gt;),
<a name="289"/>  289:     {error,[{_,[{3,leex,missing_rules}]}],[]} = leex:file(Filename, Ret),
<a name="290"/>  290:     ok = file:write_file(Filename, 
<a name="291"/>  291:                                &lt;&lt;&quot;&quot;&gt;&gt;),
<a name="292"/>  292:     %% This is a weird line:
<a name="293"/>  293:     {error,[{_,[{0,leex,missing_defs}]}],[]} = leex:file(Filename, Ret),
<a name="294"/>  294:     ok = file:write_file(Filename, 
<a name="295"/>  295:                                &lt;&lt;&quot;Rules.\n&quot;&gt;&gt;),
<a name="296"/>  296:     {error,[{_,[{1,leex,missing_defs}]}],[]} = leex:file(Filename, Ret),
<a name="297"/>  297: 
<a name="298"/>  298:     %% Check that correct line number is used in messages.
<a name="299"/>  299:     ErlFile = filename:join(Dir, &quot;file.erl&quot;),
<a name="300"/>  300:     Ret1 = [{scannerfile,ErlFile}|Ret],
<a name="301"/>  301:     ok = file:write_file(Filename,
<a name="302"/>  302:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="303"/>  303:                                  &quot;D  = [0-9]\n&quot;
<a name="304"/>  304:                                  &quot;Rules.\n&quot;
<a name="305"/>  305:                                  &quot;{L}+  : {token,\n&quot;
<a name="306"/>  306:                                  &quot;         {word,TokenLine,TokenChars,\n&quot;
<a name="307"/>  307:                                  &quot;          DDDD}}.\n&quot; % unbound
<a name="308"/>  308:                                  &quot;Erlang code.\n&quot;
<a name="309"/>  309:                                  &quot;an error.\n&quot;&gt;&gt;),     % syntax error
<a name="310"/>  310:     {ok, _, []} = leex:file(Filename, Ret1),
<a name="311"/>  311:     {error, 
<a name="312"/>  312:            [{_,[{{8,4},_,[&quot;syntax error before: &quot;,&quot;error&quot;]}]},
<a name="313"/>  313:             {_,[{{6,6},_,{unbound_var,'DDDD'}}]}],
<a name="314"/>  314:            []} =
<a name="315"/>  315:         compile:file(ErlFile, [basic_validation, return]),
<a name="316"/>  316: 
<a name="317"/>  317:     %% Ignored characters
<a name="318"/>  318:     ok = file:write_file(Filename,
<a name="319"/>  319:                                &lt;&lt;&quot;Definitions. D = [0-9]\n&quot;
<a name="320"/>  320:                                  &quot;Rules. [a-z] : .\n&quot;
<a name="321"/>  321:                                  &quot;1 : skip_token.\n&quot;
<a name="322"/>  322:                                  &quot;Erlang code. f() -&gt; a.\n&quot;&gt;&gt;),
<a name="323"/>  323:     {ok,_,[{_,
<a name="324"/>  324:                   [{1,leex,ignored_characters},
<a name="325"/>  325:                    {2,leex,ignored_characters},
<a name="326"/>  326:                    {4,leex,ignored_characters}]}]} = 
<a name="327"/>  327:         leex:file(Filename, Ret),
<a name="328"/>  328: 
<a name="329"/>  329:     ok = file:write_file(Filename,
<a name="330"/>  330:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="331"/>  331:                                  &quot;D  = [0-9]\n&quot;
<a name="332"/>  332:                                  &quot;Rules.\n&quot;
<a name="333"/>  333:                                  &quot;{L}+\\  : token.\n&quot;&gt;&gt;),
<a name="334"/>  334:     {error,[{_,[{4,leex,{regexp,{unterminated,&quot;\\&quot;}}}]}],[]} =
<a name="335"/>  335:         leex:file(Filename, Ret),
<a name="336"/>  336:     ok = file:write_file(Filename,
<a name="337"/>  337:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="338"/>  338:                                  &quot;D  = [0-9]\n&quot;
<a name="339"/>  339:                                  &quot;Rules.\n&quot;
<a name="340"/>  340:                                  &quot;{L}+\\x  : token.\n&quot;&gt;&gt;),
<a name="341"/>  341:     {error,[{_,[{4,leex,{regexp,{illegal_char,&quot;\\x&quot;}}}]}],[]} =
<a name="342"/>  342:         leex:file(Filename, Ret),
<a name="343"/>  343:     ok = file:write_file(Filename,
<a name="344"/>  344:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="345"/>  345:                                  &quot;D  = [0-9]\n&quot;
<a name="346"/>  346:                                  &quot;Rules.\n&quot;
<a name="347"/>  347:                                  &quot;{L}+\\x{  : token.\n&quot;&gt;&gt;),
<a name="348"/>  348:     {error,[{_,[{4,leex,{regexp,{unterminated,&quot;\\x{&quot;}}}]}],[]} =
<a name="349"/>  349:         leex:file(Filename, Ret),
<a name="350"/>  350:     ok = file:write_file(Filename,
<a name="351"/>  351:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="352"/>  352:                                  &quot;D  = [0-9]\n&quot;
<a name="353"/>  353:                                  &quot;Rules.\n&quot;
<a name="354"/>  354:                                  &quot;[^ab : token.\n&quot;&gt;&gt;),
<a name="355"/>  355:     {error,[{_,[{4,leex,{regexp,{unterminated,&quot;[&quot;}}}]}],[]} =
<a name="356"/>  356:         leex:file(Filename, Ret),
<a name="357"/>  357:     ok = file:write_file(Filename,
<a name="358"/>  358:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="359"/>  359:                                  &quot;D  = [0-9]\n&quot;
<a name="360"/>  360:                                  &quot;Rules.\n&quot;
<a name="361"/>  361:                                  &quot;(a : token.\n&quot;&gt;&gt;),
<a name="362"/>  362:     {error,[{_,[{4,leex,{regexp,{unterminated,&quot;(&quot;}}}]}],[]} =
<a name="363"/>  363:         leex:file(Filename, Ret),
<a name="364"/>  364:     ok = file:write_file(Filename,
<a name="365"/>  365:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="366"/>  366:                                  &quot;D  = [0-9]\n&quot;
<a name="367"/>  367:                                  &quot;Rules.\n&quot;
<a name="368"/>  368:                                  &quot;[b-a] : token.\n&quot;&gt;&gt;),
<a name="369"/>  369:     {error,[{_,[{4,leex,{regexp,{char_class,&quot;b-a&quot;}}}]}],[]} =
<a name="370"/>  370:         leex:file(Filename, Ret),
<a name="371"/>  371: 
<a name="372"/>  372:     ok = file:write_file(Filename,
<a name="373"/>  373:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="374"/>  374:                                  &quot;D  = [0-9]\n&quot;
<a name="375"/>  375:                                  &quot;Rules.\n&quot;
<a name="376"/>  376:                                  &quot;\\x{333333333333333333333333} : token.\n&quot;&gt;&gt;),
<a name="377"/>  377:     {error,[{_,[{4,leex,{regexp,
<a name="378"/>  378:                                 {illegal_char,
<a name="379"/>  379:                                  &quot;\\x{333333333333333333333333}&quot;}}}]}],[]} =
<a name="380"/>  380:         leex:file(Filename, Ret),
<a name="syntax-last_expr"/><a name="381"/>  381:     ok.
<a name="382"/>  382: 
<a name="deterministic-1"/><a name="383"/>  383: <b>deterministic</b>(doc) -&gt;
<a name="384"/>  384:     &quot;Check leex respects the +deterministic flag.&quot;;
<a name="385"/>  385: <b>deterministic</b>(suite) -&gt; [];
<a name="386"/>  386: <b>deterministic</b>(Config) when is_list(Config) -&gt;
<a name="387"/>  387:     Dir = ?privdir,
<a name="388"/>  388:     Filename = filename:join(Dir, &quot;file.xrl&quot;),
<a name="389"/>  389:     Scannerfile = filename:join(Dir, &quot;file.erl&quot;),
<a name="390"/>  390:     Mini = &lt;&lt;&quot;Definitions.\n&quot;
<a name="391"/>  391:              &quot;D  = [0-9]\n&quot;
<a name="392"/>  392:              &quot;Rules.\n&quot;
<a name="393"/>  393:              &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n&quot;
<a name="394"/>  394:              &quot;Erlang code.\n&quot;&gt;&gt;,
<a name="395"/>  395:     ok = file:write_file(Filename, Mini),
<a name="396"/>  396: 
<a name="397"/>  397:     %% Generated leex scanners include the leexinc.hrl header file by default,
<a name="398"/>  398:     %% so we'll get a -file attribute corresponding to that include. In
<a name="399"/>  399:     %% deterministic mode, that include should only use the basename,
<a name="400"/>  400:     %% &quot;leexinc.hrl&quot;, but otherwise, it should contain the full path.
<a name="401"/>  401: 
<a name="402"/>  402:     %% Matches when OTP is not installed (e.g. /lib/parsetools/include/leexinc.hrl)
<a name="403"/>  403:     %% and when it is (e.g. /lib/parsetools-2.3.2/include/leexinc.hrl)
<a name="404"/>  404:     AbsolutePathSuffix = &quot;.*/lib/parsetools.*/include/leexinc\.hrl&quot;,
<a name="405"/>  405: 
<a name="406"/>  406:     ok = leex:compile(Filename, Scannerfile, #options{specific=[deterministic]}),
<a name="407"/>  407:     {ok, FormsDet} = epp:parse_file(Scannerfile,[]),
<a name="408"/>  408:     ?assertMatch(false, search_for_file_attr(AbsolutePathSuffix, FormsDet)),
<a name="409"/>  409:     ?assertMatch({value, _}, search_for_file_attr(&quot;leexinc\.hrl&quot;, FormsDet)),
<a name="410"/>  410:     file:delete(Scannerfile),
<a name="411"/>  411: 
<a name="412"/>  412:     ok = leex:compile(Filename, Scannerfile, #options{}),
<a name="413"/>  413:     {ok, Forms} = epp:parse_file(Scannerfile,[]),
<a name="414"/>  414:     ?assertMatch({value, _}, search_for_file_attr(AbsolutePathSuffix, Forms)),
<a name="415"/>  415:     file:delete(Scannerfile),
<a name="416"/>  416: 
<a name="417"/>  417:     file:delete(Filename),
<a name="deterministic-last_expr"/><a name="418"/>  418:     ok.
<a name="419"/>  419: 
<a name="pt-1"/><a name="420"/>  420: <b>pt</b>(doc) -&gt;
<a name="421"/>  421:     &quot;Pushing back characters.&quot;;
<a name="422"/>  422: <b>pt</b>(suite) -&gt; [];
<a name="423"/>  423: <b>pt</b>(Config) when is_list(Config) -&gt;
<a name="424"/>  424:     %% Needs more testing...
<a name="425"/>  425:     Ts = [{pt_1, 
<a name="426"/>  426:          &lt;&lt;&quot;Definitions.\n&quot;
<a name="427"/>  427:             &quot;D  = [0-9]\n&quot;
<a name="428"/>  428:             &quot;L  = [a-z]\n&quot;
<a name="429"/>  429: 
<a name="430"/>  430:             &quot;Rules.\n&quot;
<a name="431"/>  431:             &quot;{L}+  : {token,{word,TokenLoc,TokenChars}}.\n&quot;
<a name="432"/>  432:             &quot;abc{D}+  : {skip_token,\&quot;sture\&quot; ++ string:substr(TokenChars, 4)}.\n&quot;
<a name="433"/>  433:             &quot;{D}+  : {token,{integer,TokenLoc,list_to_integer(TokenChars)}}.\n&quot;
<a name="434"/>  434:             &quot;\\s  : .\n&quot;
<a name="435"/>  435:             &quot;\\r\\n  : {end_token,{crlf,TokenLine}}.\n&quot;
<a name="436"/>  436: 
<a name="437"/>  437:             &quot;Erlang code.\n&quot;
<a name="438"/>  438:             &quot;-export([t/0]).\n&quot;
<a name="439"/>  439:             &quot;t() -&gt;
<a name="440"/>  440:                 {ok,[{word,{1,7},\&quot;sture\&quot;},{integer,{1,12},123}],{1,15}} =
<a name="441"/>  441:                     string(\&quot;abc123\&quot;), ok. &quot;&gt;&gt;,
<a name="442"/>  442:            default,
<a name="443"/>  443:            ok}],
<a name="444"/>  444: 
<a name="445"/>  445:     run(Config, Ts),
<a name="pt-last_expr"/><a name="446"/>  446:     ok.
<a name="447"/>  447: 
<a name="unicode-1"/><a name="448"/>  448: <b>unicode</b>(suite) -&gt;
<a name="449"/>  449:     [];
<a name="450"/>  450: <b>unicode</b>(Config) when is_list(Config) -&gt;
<a name="451"/>  451:     Ts = [{unicode_1, 
<a name="452"/>  452: 	   &lt;&lt;&quot;%% -*- coding: utf-8 -*-\n&quot;
<a name="453"/>  453: 	     &quot;Definitions.\n&quot;
<a name="454"/>  454: 	     &quot;RTLarrow    = (â)\n&quot;
<a name="455"/>  455: 	     &quot;Rules.\n&quot;
<a name="456"/>  456: 	     &quot;{RTLarrow}  : {token,{\&quot;â\&quot;,TokenLoc}}.\n&quot;
<a name="457"/>  457: 	     &quot;Erlang code.\n&quot;
<a name="458"/>  458: 	     &quot;-export([t/0]).\n&quot;
<a name="459"/>  459: 	     &quot;t() -&gt; {ok, [{\&quot;â\&quot;, {1,1}}], {1,4}} = string(\&quot;â\&quot;), ok.&quot;&gt;&gt;,
<a name="460"/>  460:            default,
<a name="461"/>  461:            ok}],
<a name="462"/>  462: 
<a name="463"/>  463:     run(Config, Ts),
<a name="unicode-last_expr"/><a name="464"/>  464:     ok.
<a name="465"/>  465: 
<a name="man-1"/><a name="466"/>  466: <b>man</b>(doc) -&gt;
<a name="467"/>  467:     &quot;Examples from the manpage.&quot;;
<a name="468"/>  468: <b>man</b>(suite) -&gt; [];
<a name="469"/>  469: <b>man</b>(Config) when is_list(Config) -&gt;
<a name="470"/>  470:     Ts = [{man_1, 
<a name="471"/>  471:      &lt;&lt;&quot;Definitions.\n&quot;
<a name="472"/>  472:        &quot;Rules.\n&quot;
<a name="473"/>  473:        &quot;[a-z][0-9a-zA-Z_]* :\n&quot;
<a name="474"/>  474:        &quot;    {token,{atom,TokenLoc,list_to_atom(TokenChars)}}.\n&quot;
<a name="475"/>  475:        &quot;[A-Z_][0-9a-zA-Z_]* :\n&quot;
<a name="476"/>  476:        &quot;    {token,{var,TokenLoc,list_to_atom(TokenChars)}}.\n&quot;
<a name="477"/>  477:        &quot;(\\+|-)?[0-9]+\\.[0-9]+((E|e)(\\+|-)?[0-9]+)? : \n&quot;
<a name="478"/>  478:        &quot;   {token,{float,TokenLoc,list_to_float(TokenChars)}}.\n&quot;
<a name="479"/>  479:        &quot;\\s : skip_token.\n&quot;
<a name="480"/>  480:        &quot;Erlang code.\n&quot;
<a name="481"/>  481:        &quot;-export([t/0]).\n&quot;
<a name="482"/>  482:        &quot;t() -&gt;\n&quot;
<a name="483"/>  483:        &quot;    {ok,[{float,{1,1},3.14},{atom,{1,5},atom},{var,{1,10},'V314'}],{1,14}} =\n&quot;
<a name="484"/>  484:        &quot;        string(\&quot;3.14atom V314\&quot;),\n&quot;
<a name="485"/>  485:        &quot;    ok.\n&quot;&gt;&gt;,
<a name="486"/>  486:            default,
<a name="487"/>  487:            ok},
<a name="488"/>  488:         {man_2,
<a name="489"/>  489:      &lt;&lt;&quot;Definitions.\n&quot;
<a name="490"/>  490:        &quot;D = [0-9]\n&quot;
<a name="491"/>  491:        &quot;Rules.\n&quot;
<a name="492"/>  492:        &quot;{D}+ :\n&quot;
<a name="493"/>  493:        &quot;  {token,{integer,TokenLoc,list_to_integer(TokenChars)}}.\n&quot;
<a name="494"/>  494:        &quot;{D}+\\.{D}+((E|e)(\\+|\\-)?{D}+)? :\n&quot;
<a name="495"/>  495:        &quot;  {token,{float,TokenLoc,list_to_float(TokenChars)}}.\n&quot;
<a name="496"/>  496:        &quot;\\s : skip_token.\n&quot;
<a name="497"/>  497:        &quot;Erlang code.\n&quot;
<a name="498"/>  498:        &quot;-export([t/0]).\n&quot;
<a name="499"/>  499:        &quot;t() -&gt;\n&quot;
<a name="500"/>  500:        &quot;    {ok,[{float,{1,1},3.14},{integer,{1,6},314}],{1,9}} = \n&quot;
<a name="501"/>  501:        &quot;        string(\&quot;3.14 314\&quot;),\n&quot;
<a name="502"/>  502:        &quot;    ok.\n&quot;&gt;&gt;,
<a name="503"/>  503:            default,
<a name="504"/>  504:            ok}],
<a name="505"/>  505:     
<a name="506"/>  506:     run(Config, Ts),
<a name="man-last_expr"/><a name="507"/>  507:     ok.
<a name="508"/>  508: 
<a name="ex-1"/><a name="509"/>  509: <b>ex</b>(doc) -&gt;
<a name="510"/>  510:     &quot;Examples.&quot;;
<a name="511"/>  511: <b>ex</b>(suite) -&gt; [];
<a name="512"/>  512: <b>ex</b>(Config) when is_list(Config) -&gt;
<a name="513"/>  513:     Ts = [{ex_1,
<a name="514"/>  514:       &lt;&lt;&quot;Definitions.\n&quot;
<a name="515"/>  515:         &quot;D = [0-543-705-982]\n&quot;
<a name="516"/>  516:         &quot;Rules.\n&quot;
<a name="517"/>  517:         &quot;{D}+ :\n&quot;
<a name="518"/>  518:         &quot;  {token,{integer,TokenLoc,list_to_integer(TokenChars)}}.\n&quot;
<a name="519"/>  519:         &quot;[^235]+ :\n&quot;
<a name="520"/>  520:         &quot;  {token,{list_to_atom(TokenChars),TokenLoc}}.\n&quot;
<a name="521"/>  521:         &quot;Erlang code.\n&quot;
<a name="522"/>  522:         &quot;-export([t/0]).\n&quot;
<a name="523"/>  523:         &quot;t() -&gt;\n&quot;
<a name="524"/>  524:         &quot;    {ok,[{integer,{1,1},12},{' c\\na',{1,3}},{integer,{2,2},34},{b789a,{2,4}}],{2,9}} =\n&quot;
<a name="525"/>  525:         &quot;        string(\&quot;12 c\\na34b789a\&quot;),\n&quot;
<a name="526"/>  526:         &quot;    ok.\n&quot;&gt;&gt;,
<a name="527"/>  527:            default,
<a name="528"/>  528:            ok},
<a name="529"/>  529: 
<a name="530"/>  530:           {ex_2,
<a name="531"/>  531:       &lt;&lt;&quot;Definitions.\n&quot;
<a name="532"/>  532:         &quot;L = [a-z]\n&quot;
<a name="533"/>  533:         &quot;D = [0-9]\n&quot;
<a name="534"/>  534:         &quot;Rules.\n&quot;
<a name="535"/>  535:         &quot;{L}+ : {token,chars}.\n&quot;
<a name="536"/>  536:         &quot;zyx{D}+ : {token,zyx}.\n&quot;
<a name="537"/>  537:         &quot;\\s : skip_token.\n&quot;
<a name="538"/>  538:         &quot;Erlang code.\n&quot;
<a name="539"/>  539:         &quot;-export([t/0]).\n&quot;
<a name="540"/>  540:         &quot;t() -&gt;\n&quot;
<a name="541"/>  541:         &quot;    {ok,[chars,zyx],{1,14}} = string(\&quot;abcdef zyx123\&quot;),\n&quot;
<a name="542"/>  542:         &quot;    ok.\n&quot;&gt;&gt;,
<a name="543"/>  543:            default,
<a name="544"/>  544:            ok},
<a name="545"/>  545: 
<a name="546"/>  546:           {ex_3,
<a name="547"/>  547:       &lt;&lt;&quot;Definitions.\n&quot;
<a name="548"/>  548:         &quot;NL = [\\n]\n&quot;
<a name="549"/>  549:         &quot;Rules.\n&quot;
<a name="550"/>  550:         &quot;{NL}* : {token,newlines}.\n&quot;
<a name="551"/>  551:         &quot;Erlang code.\n&quot;
<a name="552"/>  552:         &quot;-export([t/0]).\n&quot;
<a name="553"/>  553:         &quot;t() -&gt;\n&quot;
<a name="554"/>  554:         &quot;     {ok,[],{1,1}} = string(\&quot;\&quot;), ok.\n&quot;&gt;&gt;, % string(&quot;a&quot;) would loop...
<a name="555"/>  555:            default,
<a name="556"/>  556:            ok},
<a name="557"/>  557: 
<a name="558"/>  558:           {ex_4,
<a name="559"/>  559:       &lt;&lt;&quot;Definitions.\n&quot;
<a name="560"/>  560:         &quot;SP1 = [\\n-\\s]\n&quot;
<a name="561"/>  561:         &quot;SP0 = [\\000-\\n]\n&quot;
<a name="562"/>  562:         &quot;Rules.\n&quot;
<a name="563"/>  563:         &quot;{SP0}+ : {token,{small,TokenChars}}.\n&quot;
<a name="564"/>  564:         &quot;{SP1}+ : {token,{big,TokenChars}}.\n&quot;
<a name="565"/>  565:         &quot;Erlang code.\n&quot;
<a name="566"/>  566:         &quot;-export([t/0]).\n&quot;
<a name="567"/>  567:         &quot;t() -&gt;\n&quot;
<a name="568"/>  568:         &quot;     string(\&quot;\\x00\\n\\s\\n\\n\&quot;),\n&quot;
<a name="569"/>  569:         &quot;     ok.\n&quot;&gt;&gt;,
<a name="570"/>  570:           default,
<a name="571"/>  571:           ok},
<a name="572"/>  572: 
<a name="573"/>  573:           {ex_5, 
<a name="574"/>  574:       &lt;&lt;&quot;Definitions.\n&quot;
<a name="575"/>  575:         &quot;L = [a-z]\n&quot;
<a name="576"/>  576:         &quot;W = [\\s\\b\\n\\r\\t\\e\\v\\d\\f]\n&quot;
<a name="577"/>  577:         &quot;Rules.\n&quot;
<a name="578"/>  578:         &quot;\\[{L}+(,{L}+)*\\] : {token,{list,TokenChars}}.\n&quot;
<a name="579"/>  579:         &quot;\&quot;{L}+\&quot; : {token,{string,TokenChars}}.\n&quot;
<a name="580"/>  580:         &quot;\\$. : {token,{char,TokenChars}}.\n&quot;
<a name="581"/>  581:         &quot;{W}+ : {token,{white,TokenChars}}.\n&quot;
<a name="582"/>  582:         &quot;ff\\f+ : {token,{form,TokenChars}}.\n&quot;
<a name="583"/>  583:         &quot;\\$\\^+\\\\+ : {token,{other,TokenChars}}.\n&quot;
<a name="584"/>  584:         &quot;Erlang code.\n&quot;
<a name="585"/>  585:         &quot;-export([t/0]).\n&quot;
<a name="586"/>  586:         &quot;t() -&gt;\n&quot;
<a name="587"/>  587:         &quot;    {ok,[{white,\&quot;\\b\\f\&quot;}],{1,3}} = string(\&quot;\\b\\f\&quot;),\n&quot;
<a name="588"/>  588:         &quot;    {ok,[{form,\&quot;ff\\f\&quot;}],{1,4}} = string(\&quot;ff\\f\&quot;),\n&quot;
<a name="589"/>  589:         &quot;    {ok,[{string,\&quot;\\\&quot;foo\\\&quot;\&quot;}],{1,6}} = string(\&quot;\\\&quot;foo\\\&quot;\&quot;),\n&quot;
<a name="590"/>  590:         &quot;    {ok,[{char,\&quot;$.\&quot;}],{1,3}} = string(\&quot;$\\.\&quot;),\n&quot;
<a name="591"/>  591:         &quot;    {ok,[{list,\&quot;[a,b,c]\&quot;}],{1,8}} = string(\&quot;[a,b,c]\&quot;),\n&quot;
<a name="592"/>  592:         &quot;    {ok,[{other,\&quot;$^\\\\\&quot;}],{1,4}} = string(\&quot;$^\\\\\&quot;),\n&quot;
<a name="593"/>  593:         &quot;    ok.\n&quot;&gt;&gt;,
<a name="594"/>  594:            default,
<a name="595"/>  595:            ok},
<a name="596"/>  596: 
<a name="597"/>  597:          {ex_6,
<a name="598"/>  598:       &lt;&lt;&quot;Definitions.\n&quot;
<a name="599"/>  599:         &quot;L = [a-z]\n&quot;
<a name="600"/>  600:         &quot;Rules.\n&quot;
<a name="601"/>  601:         &quot;L}+ : {token,{TokenChars,#r.f}}.\n&quot;
<a name="602"/>  602:         &quot;Erlang code.\n&quot;
<a name="603"/>  603:         &quot;-record(r, {f}).\n&quot;
<a name="604"/>  604:         &quot;-export([t/0]).\n&quot;
<a name="605"/>  605:         &quot;t() -&gt;\n&quot;
<a name="606"/>  606:         &quot;    string(\&quot;abc\&quot;),\n&quot;
<a name="607"/>  607:         &quot;    ok.\n&quot;&gt;&gt;,
<a name="608"/>  608:           default,
<a name="609"/>  609:           ok},
<a name="610"/>  610: 
<a name="611"/>  611:          {ex_7, %% Assumes regexp can handle \x
<a name="612"/>  612:       &lt;&lt;&quot;Definitions.\n&quot;
<a name="613"/>  613:         &quot;H1 = \\x11\\x{ab}\n&quot;
<a name="614"/>  614:         &quot;H2 = [\\x{30}\\x{ac}]\n&quot;
<a name="615"/>  615:         &quot;Rules.\n&quot;
<a name="616"/>  616:         &quot;{H1}{H2}+ : {token,{hex,TokenChars}}.\n&quot;
<a name="617"/>  617:         &quot;Erlang code.\n&quot;
<a name="618"/>  618:         &quot;-export([t/0]).\n&quot;
<a name="619"/>  619:         &quot;t() -&gt;\n&quot;
<a name="620"/>  620:         &quot;    {ok,[{hex,[17,171,48,172]}],{1,7}} =\n&quot;
<a name="621"/>  621:         &quot;        string(\&quot;\\x{11}\\xab0\\xac\&quot;),\n&quot;
<a name="622"/>  622:         &quot;    ok.\n&quot;&gt;&gt;,
<a name="623"/>  623:           default,
<a name="624"/>  624:           ok}],
<a name="625"/>  625:     
<a name="626"/>  626:     run(Config, Ts),
<a name="ex-last_expr"/><a name="627"/>  627:     ok.
<a name="628"/>  628: 
<a name="ex2-1"/><a name="629"/>  629: <b>ex2</b>(doc) -&gt;
<a name="630"/>  630:     &quot;More examples.&quot;;
<a name="631"/>  631: <b>ex2</b>(suite) -&gt; [];
<a name="632"/>  632: <b>ex2</b>(Config) when is_list(Config) -&gt;
<a name="633"/>  633:     Xrl = 
<a name="634"/>  634:      &lt;&lt;&quot;
<a name="635"/>  635: <i>%%% File : erlang_scan.xrl</i>
<a name="636"/>  636: <i>%%% Author : Robert Virding</i>
<a name="637"/>  637: <i>%%% Purpose : Token definitions for Erlang.</i>
<a name="638"/>  638:  
<a name="639"/>  639: Definitions.
<a name="640"/>  640: O  = [0-7]
<a name="641"/>  641: D  = [0-9]
<a name="642"/>  642: H  = [0-9a-fA-F]
<a name="643"/>  643: U  = [A-Z]
<a name="644"/>  644: L  = [a-z]
<a name="645"/>  645: A  = ({U}|{L}|{D}|_|@)
<a name="646"/>  646: WS  = ([\\000-\\s]|%.*)
<a name="647"/>  647:  
<a name="648"/>  648: Rules.
<a name="649"/>  649: {D}+\\.{D}+((E|e)(\\+|\\-)?{D}+)? :
<a name="650"/>  650:       {token,{float,TokenLoc,list_to_float(TokenChars)}}.
<a name="651"/>  651: {D}+#{H}+  :  base(TokenLoc, TokenChars).
<a name="652"/>  652: {D}+    :  {token,{integer,TokenLoc,list_to_integer(TokenChars)}}.
<a name="653"/>  653: {L}{A}*    :  Atom = list_to_atom(TokenChars),
<a name="654"/>  654:       {token,case reserved_word(Atom) of
<a name="655"/>  655:          true -&gt; {Atom,TokenLoc};
<a name="656"/>  656:          false -&gt; {atom,TokenLoc,Atom}
<a name="657"/>  657:        end}.
<a name="658"/>  658: '(\\\\\\^.|\\\\.|[^'])*' :
<a name="659"/>  659:       %% Strip quotes.
<a name="660"/>  660:       S = lists:sublist(TokenChars, 2, TokenLen - 2),
<a name="661"/>  661:       case catch list_to_atom(string_gen(S)) of
<a name="662"/>  662:        {'EXIT',_} -&gt; {error,\&quot;illegal atom \&quot; ++ TokenChars};
<a name="663"/>  663:        Atom -&gt; {token,{atom,TokenLoc,Atom}}
<a name="664"/>  664:       end.
<a name="665"/>  665: ({U}|_){A}*  :  {token,{var,TokenLoc,list_to_atom(TokenChars)}}.
<a name="666"/>  666: \&quot;(\\\\\\^.|\\\\.|[^\&quot;])*\&quot; :
<a name="667"/>  667:       %% Strip quotes.
<a name="668"/>  668:       S = lists:sublist(TokenChars, 2, TokenLen - 2),
<a name="669"/>  669:       {token,{string,TokenLoc,string_gen(S)}}.
<a name="670"/>  670: \\$(\\\\{O}{O}{O}|\\\\\\^.|\\\\.|.) :
<a name="671"/>  671:       {token,{char,TokenLoc,cc_convert(TokenChars)}}.
<a name="672"/>  672: -&gt;    :  {token,{'-&gt;',TokenLoc}}.
<a name="673"/>  673: :-    :  {token,{':-',TokenLoc}}.
<a name="674"/>  674: \\|\\|    :  {token,{'||',TokenLoc}}.
<a name="675"/>  675: &lt;-    :  {token,{'&lt;-',TokenLoc}}.
<a name="676"/>  676: \\+\\+    :  {token,{'++',TokenLoc}}.
<a name="677"/>  677: --    :  {token,{'--',TokenLoc}}.
<a name="678"/>  678: =/=    :  {token,{'=/=',TokenLoc}}.
<a name="679"/>  679: ==    :  {token,{'==',TokenLoc}}.
<a name="680"/>  680: =:=    :  {token,{'=:=',TokenLoc}}.
<a name="681"/>  681: /=    :  {token,{'/=',TokenLoc}}.
<a name="682"/>  682: &gt;=    :  {token,{'&gt;=',TokenLoc}}.
<a name="683"/>  683: =&lt;    :  {token,{'=&lt;',TokenLoc}}.
<a name="684"/>  684: &lt;=    :  {token,{'&lt;=',TokenLoc}}.
<a name="685"/>  685: &lt;&lt;    :  {token,{'&lt;&lt;',TokenLoc}}.
<a name="686"/>  686: &gt;&gt;    :  {token,{'&gt;&gt;',TokenLoc}}.
<a name="687"/>  687: ::    :  {token,{'::',TokenLoc}}.
<a name="688"/>  688: []()[}{|!?/;:,.*+#&lt;&gt;=-] :
<a name="689"/>  689:       {token,{list_to_atom(TokenChars),TokenLoc}}.
<a name="690"/>  690: \\.{WS}    :  {end_token,{dot,TokenLoc}}.
<a name="691"/>  691: {WS}+    :  skip_token.
<a name="692"/>  692:  
<a name="693"/>  693: Erlang code.
<a name="694"/>  694:  
<a name="695"/>  695: <b>-export</b>([reserved_word/1]).
<a name="696"/>  696: 
<a name="697"/>  697: <i>%% reserved_word(Atom) -&gt; Bool</i>
<a name="698"/>  698: <i>%% return 'true' if Atom is an Erlang reserved word, else 'false'.</i>
<a name="699"/>  699: 
<a name="700"/>  700: reserved_word('after') -&gt; true;
<a name="701"/>  701: reserved_word('begin') -&gt; true;
<a name="702"/>  702: reserved_word('case') -&gt; true;
<a name="703"/>  703: reserved_word('try') -&gt; true;
<a name="704"/>  704: reserved_word('cond') -&gt; true;
<a name="705"/>  705: reserved_word('catch') -&gt; true;
<a name="706"/>  706: reserved_word('andalso') -&gt; true;
<a name="707"/>  707: reserved_word('orelse') -&gt; true;
<a name="708"/>  708: reserved_word('end') -&gt; true;
<a name="709"/>  709: reserved_word('fun') -&gt; true;
<a name="710"/>  710: reserved_word('if') -&gt; true;
<a name="711"/>  711: reserved_word('let') -&gt; true;
<a name="712"/>  712: reserved_word('of') -&gt; true;
<a name="713"/>  713: reserved_word('receive') -&gt; true;
<a name="714"/>  714: reserved_word('when') -&gt; true;
<a name="715"/>  715: reserved_word('bnot') -&gt; true;
<a name="716"/>  716: reserved_word('not') -&gt; true;
<a name="717"/>  717: reserved_word('div') -&gt; true;
<a name="718"/>  718: reserved_word('rem') -&gt; true;
<a name="719"/>  719: reserved_word('band') -&gt; true;
<a name="720"/>  720: reserved_word('and') -&gt; true;
<a name="721"/>  721: reserved_word('bor') -&gt; true;
<a name="722"/>  722: reserved_word('bxor') -&gt; true;
<a name="723"/>  723: reserved_word('bsl') -&gt; true;
<a name="724"/>  724: reserved_word('bsr') -&gt; true;
<a name="725"/>  725: reserved_word('or') -&gt; true;
<a name="726"/>  726: reserved_word('xor') -&gt; true;
<a name="727"/>  727: reserved_word('spec') -&gt; true;
<a name="728"/>  728: reserved_word(_) -&gt; false.
<a name="729"/>  729: 
<a name="730"/>  730: base(L, Cs) -&gt;
<a name="731"/>  731:     H = string:chr(Cs, $#),
<a name="732"/>  732:     case list_to_integer(string:substr(Cs, 1, H-1)) of
<a name="733"/>  733:         B when B &gt; 16 -&gt; {error,\&quot;illegal base\&quot;};
<a name="734"/>  734:         B -&gt;
<a name="735"/>  735:             case base(string:substr(Cs, H+1), B, 0) of
<a name="736"/>  736:                 error -&gt; {error,\&quot;illegal based number\&quot;};
<a name="737"/>  737:                 N -&gt; {token,{integer,L,N}}
<a name="738"/>  738:             end
<a name="739"/>  739:     end.
<a name="740"/>  740: 
<a name="741"/>  741: base([C|Cs], Base, SoFar) when C &gt;= $0, C =&lt; $9, C &lt; Base + $0 -&gt;
<a name="742"/>  742:     Next = SoFar * Base + (C - $0),
<a name="743"/>  743:     base(Cs, Base, Next);
<a name="744"/>  744: base([C|Cs], Base, SoFar) when C &gt;= $a, C =&lt; $f, C &lt; Base + $a - 10 -&gt;
<a name="745"/>  745:     Next = SoFar * Base + (C - $a + 10),
<a name="746"/>  746:     base(Cs, Base, Next);
<a name="747"/>  747: base([C|Cs], Base, SoFar) when C &gt;= $A, C =&lt; $F, C &lt; Base + $A - 10 -&gt;
<a name="748"/>  748:     Next = SoFar * Base + (C - $A + 10),
<a name="749"/>  749:     base(Cs, Base, Next);
<a name="750"/>  750: base([_|_], _, _) -&gt; error;      %Unknown character
<a name="751"/>  751: base([], _, N) -&gt; N.
<a name="752"/>  752: 
<a name="753"/>  753: cc_convert([$$,$\\\\|Cs]) -&gt;
<a name="754"/>  754:     hd(string_escape(Cs));
<a name="755"/>  755: cc_convert([$$,C]) -&gt; C.
<a name="756"/>  756: 
<a name="757"/>  757: string_gen([$\\\\|Cs]) -&gt;
<a name="758"/>  758:     string_escape(Cs);
<a name="759"/>  759: string_gen([C|Cs]) -&gt;
<a name="760"/>  760:     [C|string_gen(Cs)];
<a name="761"/>  761: string_gen([]) -&gt; [].
<a name="762"/>  762: 
<a name="763"/>  763: string_escape([O1,O2,O3|S]) when
<a name="764"/>  764:         O1 &gt;= $0, O1 =&lt; $7, O2 &gt;= $0, O2 =&lt; $7, O3 &gt;= $0, O3 =&lt; $7 -&gt;
<a name="765"/>  765:     [(O1*8 + O2)*8 + O3 - 73*$0|string_gen(S)];
<a name="766"/>  766: string_escape([$^,C|Cs]) -&gt;
<a name="767"/>  767:     [C band 31|string_gen(Cs)];
<a name="768"/>  768: string_escape([C|Cs]) when C &gt;= $\\000, C =&lt; $\\s -&gt;
<a name="769"/>  769:     string_gen(Cs);
<a name="770"/>  770: string_escape([C|Cs]) -&gt;
<a name="771"/>  771:     [escape_char(C)|string_gen(Cs)].
<a name="772"/>  772: 
<a name="773"/>  773: escape_char($n) -&gt; $\\n;        %\\n = LF
<a name="774"/>  774: escape_char($r) -&gt; $\\r;        %\\r = CR
<a name="775"/>  775: escape_char($t) -&gt; $\\t;        %\\t = TAB
<a name="776"/>  776: escape_char($v) -&gt; $\\v;        %\\v = VT
<a name="777"/>  777: escape_char($b) -&gt; $\\b;        %\\b = BS
<a name="778"/>  778: escape_char($f) -&gt; $\\f;        %\\f = FF
<a name="779"/>  779: escape_char($e) -&gt; $\\e;        %\\e = ESC
<a name="780"/>  780: escape_char($s) -&gt; $\\s;        %\\s = SPC
<a name="781"/>  781: escape_char($d) -&gt; $\\d;        %\\d = DEL
<a name="782"/>  782: escape_char(C) -&gt; C.
<a name="783"/>  783:       &quot;&gt;&gt;, % &quot;
<a name="784"/>  784:     Dir = ?privdir,
<a name="785"/>  785:     XrlFile = filename:join(Dir, &quot;erlang_scan.xrl&quot;),
<a name="786"/>  786:     ok = file:write_file(XrlFile, Xrl),
<a name="787"/>  787:     ErlFile = filename:join(Dir, &quot;erlang_scan.erl&quot;),
<a name="788"/>  788:     {ok, _} = leex:file(XrlFile, [{error_location, column}]),
<a name="789"/>  789:     {ok, _} = compile:file(ErlFile, [{outdir,Dir}]),
<a name="790"/>  790:     code:purge(erlang_scan),
<a name="791"/>  791:     AbsFile = filename:rootname(ErlFile, &quot;.erl&quot;),
<a name="792"/>  792:     code:load_abs(AbsFile, erlang_scan),
<a name="793"/>  793: 
<a name="794"/>  794:     F = fun(Cont, Chars, Location) -&gt;
<a name="795"/>  795:                 erlang_scan:tokens(Cont, Chars, Location)
<a name="796"/>  796:         end,
<a name="797"/>  797:     F1 = fun(Cont, Chars, Location) -&gt;
<a name="798"/>  798:                 erlang_scan:token(Cont, Chars, Location)
<a name="799"/>  799:         end,
<a name="800"/>  800:     fun() -&gt;
<a name="801"/>  801:             S = &quot;ab cd. &quot;,
<a name="802"/>  802:             {ok, Ts, {1,8}} = scan_tokens_1(S, F, {1,1}),
<a name="803"/>  803:             {ok, Ts, {1,8}} = scan_token_1(S, F1, {1,1}),
<a name="804"/>  804:             {ok, Ts, {1,8}} = scan_tokens(S, F, {1,1}),
<a name="805"/>  805:             {ok, Ts, {1,8}} = erlang_scan:string(S, {1,1})
<a name="806"/>  806:     end(),
<a name="807"/>  807:     fun() -&gt;
<a name="808"/>  808:             S = &quot;'ab\n cd'. &quot;,
<a name="809"/>  809:             {ok, Ts, {2,7}} = scan_tokens_1(S, F, {1,1}),
<a name="810"/>  810:             {ok, Ts, {2,7}} = scan_token_1(S, F1, {1,1}),
<a name="811"/>  811:             {ok, Ts, {2,7}} = scan_tokens(S, F, {1,1}),
<a name="812"/>  812:             {ok, Ts, {2,7}} = erlang_scan:string(S, {1,1})
<a name="813"/>  813:     end(),
<a name="814"/>  814:     fun() -&gt;
<a name="815"/>  815:             S = &quot;99. &quot;,
<a name="816"/>  816:             {ok, Ts, {1,5}} = scan_tokens_1(S, F, {1,1}),
<a name="817"/>  817:             {ok, Ts, {1,5}} = scan_token_1(S, F1, {1,1}),
<a name="818"/>  818:             {ok, Ts, {1,5}} = scan_tokens(S, F, {1,1}),
<a name="819"/>  819:             {ok, Ts, {1,5}} = erlang_scan:string(S, {1,1})
<a name="820"/>  820:     end(),
<a name="821"/>  821:     {ok,[{integer,{1,1},99},{dot,{1,3}}],{1,5}} = erlang_scan:string(&quot;99. &quot;),
<a name="822"/>  822:     fun() -&gt;
<a name="823"/>  823:             Atom = &quot;'&quot; ++ lists:duplicate(1000,$a) ++ &quot;'&quot;,
<a name="824"/>  824:             S = Atom ++ &quot;. &quot;,
<a name="825"/>  825:             Reason = &quot;illegal atom &quot; ++ Atom,
<a name="826"/>  826:             Err = {error,{{1,1003},erlang_scan,{user,Reason}},{1,1003}},
<a name="827"/>  827:             {done,Err,[]} = scan_tokens_1(S, F, {1,1}),
<a name="828"/>  828:             {done,Err,[]} = scan_token_1(S, F1, {1,1}),
<a name="829"/>  829:             {done,Err,[]} = scan_tokens(S, F, {1,1}),
<a name="830"/>  830:             Err = erlang_scan:string(S, {1,1})
<a name="831"/>  831:     end(),
<a name="832"/>  832:     fun() -&gt;
<a name="833"/>  833:             S = &quot;\x{aaa}. &quot;,
<a name="834"/>  834:             Err = {error,{{1,1},erlang_scan,{illegal,[2730]}},{1,1}},
<a name="835"/>  835:             {done,Err,[]} = scan_tokens_1(S, F, {1,1}),
<a name="836"/>  836:             {done,Err,[_]} = scan_token_1(S, F1, {1,1}), % Note: Rest non-empty
<a name="837"/>  837:             {done,Err,[]} = scan_tokens(S, F, {1,1}),
<a name="838"/>  838:             Err = erlang_scan:string(S, {1,1})
<a name="839"/>  839:     end(),
<a name="840"/>  840:     fun() -&gt;
<a name="841"/>  841:             S = &quot;\x{aaa} + 1. 34&quot;,
<a name="842"/>  842:             Err = {error,{{1,1},erlang_scan,{illegal,[2730]}},{1,1}},
<a name="843"/>  843:             {done,Err,[]} = scan_tokens_1(S, F, {1,1}),
<a name="844"/>  844:             {done,Err,[_]} = scan_token_1(S, F1, {1,1}), % Note: Rest non-empty
<a name="845"/>  845:             {done,Err,&quot;34&quot;} = scan_tokens(S, F, {1,1}),
<a name="846"/>  846:             Err = erlang_scan:string(S, {1,1})
<a name="847"/>  847:     end(),
<a name="848"/>  848:     fun() -&gt;
<a name="849"/>  849:             S = &quot;\x{aaa} \x{bbb}. 34&quot;,
<a name="850"/>  850:             Err = {error,{{1,1},erlang_scan,{illegal,[2730]}},{1,1}},
<a name="851"/>  851:             {done,Err,[]} = scan_tokens_1(S, F, {1,1}),
<a name="852"/>  852:             {done,Err,[_]} = scan_token_1(S, F1, {1,1}), % Note: Rest non-empty
<a name="853"/>  853:             {done,Err,&quot;34&quot;} = scan_tokens(S, F, {1,1}),
<a name="854"/>  854:             Err = erlang_scan:string(S, {1,1})
<a name="855"/>  855:     end(),
<a name="856"/>  856:     fun() -&gt;
<a name="857"/>  857:             S = &quot;\x{aaa} 18#34. 34&quot;,
<a name="858"/>  858:             Err = {error,{{1,1},erlang_scan,{illegal,[2730]}},{1,1}},
<a name="859"/>  859:             {done,Err,[]} = scan_tokens_1(S, F, {1,1}),
<a name="860"/>  860:             {done,Err,[_]} = scan_token_1(S, F1, {1,1}), % Note: Rest non-empty
<a name="861"/>  861:             {done,Err,&quot;34&quot;} = scan_tokens(S, F, {1,1}),
<a name="862"/>  862:             Err = erlang_scan:string(S, {1,1})
<a name="863"/>  863:     end(),
<a name="864"/>  864:     fun() -&gt;
<a name="865"/>  865:             S = &quot;\x{aaa}&quot;++eof,
<a name="866"/>  866:             Err = {error,{{1,1},erlang_scan,{illegal,[2730]}},{1,1}},
<a name="867"/>  867:             {done,Err,eof} = scan_tokens_1(S, F, {1,1}),
<a name="868"/>  868:             {done,Err,[_]} = scan_token_1(S, F1, {1,1}), % Note: Rest non-empty
<a name="869"/>  869:             {done,Err,eof} = scan_tokens(S, F, {1,1}),
<a name="870"/>  870:             Err = erlang_scan:string(S, {1,1})
<a name="871"/>  871:     end(),
<a name="ex2-last_expr"/><a name="872"/>  872:     ok.
<a name="873"/>  873: 
<a name="scan_tokens-3"/><a name="874"/>  874: <b>scan_tokens</b>(String, Fun, Location) -&gt;
<a name="scan_tokens-last_expr"/><a name="875"/>  875: <b>    scan_tokens</b>(String, Fun, Location, []).
<a name="876"/>  876: 
<a name="scan_tokens-4"/><a name="877"/>  877: <b>scan_tokens</b>(String, Fun, Location, Rs) -&gt;
<a name="scan_tokens-last_expr"/><a name="878"/>  878: <b>    case Fun</b>([], String, Location) of
<a name="879"/>  879:         {done, {error,_,_}, _} = Error -&gt;
<a name="880"/>  880:             Error;
<a name="881"/>  881:         {done, {ok,Ts,End}, &quot;&quot;} -&gt;
<a name="882"/>  882:             {ok, lists:append(lists:reverse([Ts|Rs])), End};
<a name="883"/>  883:         {done, {ok,Ts,End}, Rest} -&gt;
<a name="884"/>  884:             scan_tokens(Rest, Fun, End, [Ts|Rs])
<a name="885"/>  885:     end.
<a name="886"/>  886: 
<a name="scan_tokens_1-3"/><a name="887"/>  887: <b>scan_tokens_1</b>(String, Fun, Location) -&gt;
<a name="scan_tokens_1-last_expr"/><a name="888"/>  888: <b>    scan_tokens_1</b>({more, []}, String, Fun, Location, []).
<a name="889"/>  889: 
<a name="scan_tokens_1-5"/><a name="890"/>  890: <b>scan_tokens_1</b>({done, {error, _, _}, _}=Error, _Cs, _Fun, _Location, _Rs) -&gt;
<a name="891"/>  891:     Error;
<a name="892"/>  892: <b>scan_tokens_1</b>({done, {ok,Ts,End}, &quot;&quot;}, &quot;&quot;, _Fun, _Location, Rs) -&gt;
<a name="893"/>  893:     {ok,lists:append(lists:reverse([Ts|Rs])),End};
<a name="894"/>  894: <b>scan_tokens_1</b>({done, {ok,Ts,End}, Rest}, Cs, Fun, _Location, Rs) -&gt;
<a name="895"/>  895:     scan_tokens_1({more,[]}, Rest++Cs, Fun, End, [Ts|Rs]);
<a name="896"/>  896: <b>scan_tokens_1</b>({more, Cont}, [C | Cs], Fun, Loc, Rs) -&gt;
<a name="897"/>  897:     R = Fun(Cont, [C], Loc),
<a name="898"/>  898:     scan_tokens_1(R, Cs, Fun, Loc, Rs);
<a name="899"/>  899: <b>scan_tokens_1</b>({more, Cont}, eof, Fun, Loc, Rs) -&gt;
<a name="900"/>  900:     R = Fun(Cont, eof, Loc),
<a name="scan_tokens_1-last_expr"/><a name="901"/>  901: <b>    scan_tokens_1</b>(R, eof, Fun, Loc, Rs).
<a name="902"/>  902: 
<a name="scan_token_1-3"/><a name="903"/>  903: <b>scan_token_1</b>(String, Fun, Location) -&gt;
<a name="scan_token_1-last_expr"/><a name="904"/>  904: <b>    scan_token_1</b>({more, []}, String, Fun, Location, []).
<a name="905"/>  905: 
<a name="scan_token_1-5"/><a name="906"/>  906: <b>scan_token_1</b>({done, {error, _, _}, _}=Error, _Cs, _Fun, _Location, _Rs) -&gt;
<a name="907"/>  907:     Error;
<a name="908"/>  908: <b>scan_token_1</b>({done, {ok,Ts,End}, &quot;&quot;}, &quot;&quot;, _Fun, _Location, Rs) -&gt;
<a name="909"/>  909:     {ok,lists:reverse([Ts|Rs]),End};
<a name="910"/>  910: <b>scan_token_1</b>({done, {ok,Ts,End}, Rest}, Cs, Fun, _Location, Rs) -&gt;
<a name="911"/>  911:     scan_token_1({more,[]}, Rest++Cs, Fun, End, [Ts|Rs]);
<a name="912"/>  912: <b>scan_token_1</b>({more, Cont}, [C | Cs], Fun, Loc, Rs) -&gt;
<a name="913"/>  913:     R = Fun(Cont, [C], Loc),
<a name="scan_token_1-last_expr"/><a name="914"/>  914: <b>    scan_token_1</b>(R, Cs, Fun, Loc, Rs).
<a name="915"/>  915: 
<a name="916"/>  916: <i>%% End of ex2</i>
<a name="917"/>  917: 
<a name="line_wrap-1"/><a name="918"/>  918: <b>line_wrap</b>(doc) -&gt;    &quot;Much more examples.&quot;;
<a name="919"/>  919: <b>line_wrap</b>(suite) -&gt; [];
<a name="920"/>  920: <b>line_wrap</b>(Config) when is_list(Config) -&gt;
<a name="921"/>  921:     Xrl =
<a name="922"/>  922:      &lt;&lt;&quot;
<a name="923"/>  923: Definitions.
<a name="924"/>  924: Rules.
<a name="925"/>  925: [a]+[\\n]*= : {token, {first, TokenLoc}}.
<a name="926"/>  926: [a]+ : {token, {second, TokenLoc}}.
<a name="927"/>  927: [\\s\\r\\n\\t]+ : skip_token.
<a name="928"/>  928: Erlang code.
<a name="929"/>  929:       &quot;&gt;&gt;,
<a name="930"/>  930:     Dir = ?privdir,
<a name="931"/>  931:     XrlFile = filename:join(Dir, &quot;test_line_wrap.xrl&quot;),
<a name="932"/>  932:     ok = file:write_file(XrlFile, Xrl),
<a name="933"/>  933:     ErlFile = filename:join(Dir, &quot;test_line_wrap.erl&quot;),
<a name="934"/>  934:     {ok, _} = leex:file(XrlFile, []),
<a name="935"/>  935:     {ok, _} = compile:file(ErlFile, [{outdir,Dir}]),
<a name="936"/>  936:     code:purge(test_line_wrap),
<a name="937"/>  937:     AbsFile = filename:rootname(ErlFile, &quot;.erl&quot;),
<a name="938"/>  938:     code:load_abs(AbsFile, test_line_wrap),
<a name="939"/>  939:     fun() -&gt;
<a name="940"/>  940:             S = &quot;aaa\naaa&quot;,
<a name="941"/>  941:             {ok,[{second,{1,1}},{second,{2,1}}],2} = test_line_wrap:string(S)
<a name="942"/>  942:     end(),
<a name="943"/>  943:     fun() -&gt;
<a name="944"/>  944:             S = &quot;aaa\naaa&quot;,
<a name="945"/>  945:             {ok,[{second,{3,1}},{second,{4,1}}],4} = test_line_wrap:string(S, 3)
<a name="946"/>  946:     end(),
<a name="947"/>  947:     fun() -&gt;
<a name="948"/>  948:             {done,{ok,{second,{1,1}},1},&quot;\na&quot;} = test_line_wrap:token([], &quot;a\na&quot;),
<a name="949"/>  949:             {more,Cont1} = test_line_wrap:token([], &quot;\na&quot;),
<a name="950"/>  950:             {done,{ok,{second,{2,1}},2},eof} = test_line_wrap:token(Cont1, eof)
<a name="951"/>  951:     end(),
<a name="952"/>  952:     fun() -&gt;
<a name="953"/>  953:             {more,Cont1} = test_line_wrap:tokens([], &quot;a\na&quot;),
<a name="954"/>  954:             {done,{ok,[{second,{1,1}},{second,{2,1}}],2},eof} = test_line_wrap:tokens(Cont1, eof)
<a name="955"/>  955:     end(),
<a name="line_wrap-last_expr"/><a name="956"/>  956:     ok.
<a name="957"/>  957: 
<a name="958"/>  958: <i>%% End of line_wrap</i>
<a name="959"/>  959: 
<a name="not_yet-1"/><a name="960"/>  960: <b>not_yet</b>(doc) -&gt;
<a name="961"/>  961:     &quot;Not yet implemented.&quot;;
<a name="962"/>  962: <b>not_yet</b>(suite) -&gt; [];
<a name="963"/>  963: <b>not_yet</b>(Config) when is_list(Config) -&gt;
<a name="964"/>  964:     Dir = ?privdir,
<a name="965"/>  965:     Filename = filename:join(Dir, &quot;file.xrl&quot;),
<a name="966"/>  966:     Ret = [return, {report, true}],
<a name="967"/>  967:     ok = file:write_file(Filename,
<a name="968"/>  968:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="969"/>  969:                                  &quot;Rules.\n&quot;
<a name="970"/>  970:                                  &quot;$ : .\n&quot;
<a name="971"/>  971:                                  &quot;Erlang code.\n&quot;&gt;&gt;),
<a name="972"/>  972:     {error,[{_,[{3,leex,{regexp,_}}]}],[]} = 
<a name="973"/>  973:         leex:file(Filename, Ret),
<a name="974"/>  974:     ok = file:write_file(Filename,
<a name="975"/>  975:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="976"/>  976:                                  &quot;Rules.\n&quot;
<a name="977"/>  977:                                  &quot;^ : .\n&quot;
<a name="978"/>  978:                                  &quot;Erlang code.\n&quot;&gt;&gt;),
<a name="979"/>  979:     {error,[{_,[{3,leex,{regexp,_}}]}],[]} = 
<a name="980"/>  980:         leex:file(Filename, Ret),
<a name="981"/>  981: 
<a name="not_yet-last_expr"/><a name="982"/>  982:     ok.
<a name="983"/>  983: 
<a name="otp_10302-1"/><a name="984"/>  984: <b>otp_10302</b>(doc) -&gt;
<a name="985"/>  985:     &quot;OTP-10302. Unicode characters scanner/parser.&quot;;
<a name="986"/>  986: <b>otp_10302</b>(suite) -&gt; [];
<a name="987"/>  987: <b>otp_10302</b>(Config) when is_list(Config) -&gt;
<a name="988"/>  988:     Dir = ?privdir,
<a name="989"/>  989:     Filename = filename:join(Dir, &quot;file.xrl&quot;),
<a name="990"/>  990:     Ret = [return, {report, true}],
<a name="991"/>  991: 
<a name="992"/>  992:     ok = file:write_file(Filename,&lt;&lt;
<a name="993"/>  993:          &quot;%% coding: UTF-8\n&quot;
<a name="994"/>  994:          &quot;ä&quot;
<a name="995"/>  995:      &gt;&gt;),
<a name="996"/>  996:     {error,[{_,[{2,leex,cannot_parse}]}],[]} =
<a name="997"/>  997:         leex:file(Filename, Ret),
<a name="998"/>  998: 
<a name="999"/>  999:     ok = file:write_file(Filename,&lt;&lt;
<a name="1000"/> 1000:          &quot;%% coding: UTF-8\n&quot;
<a name="1001"/> 1001:          &quot;Definitions.\n&quot;
<a name="1002"/> 1002:          &quot;ä&quot;
<a name="1003"/> 1003:      &gt;&gt;),
<a name="1004"/> 1004:     {error,[{_,[{3,leex,cannot_parse}]}],[]} = leex:file(Filename, Ret),
<a name="1005"/> 1005: 
<a name="1006"/> 1006:     ok = file:write_file(Filename,&lt;&lt;
<a name="1007"/> 1007:          &quot;%% coding: UTF-8\n&quot;
<a name="1008"/> 1008:          &quot;Definitions.\n&quot;
<a name="1009"/> 1009:          &quot;A = a\n&quot;
<a name="1010"/> 1010:          &quot;L = [{A}-{Z}]\n&quot;
<a name="1011"/> 1011:          &quot;Z = z\n&quot;
<a name="1012"/> 1012:          &quot;Rules.\n&quot;
<a name="1013"/> 1013:          &quot;{L}+ : {token,{list_to_atom(TokenChars),Häpp}}.\n&quot;
<a name="1014"/> 1014:      &gt;&gt;),
<a name="1015"/> 1015:     {error,[{_,[{7,leex,cannot_parse}]}],[]} = leex:file(Filename, Ret),
<a name="1016"/> 1016: 
<a name="1017"/> 1017:     ok = file:write_file(Filename,&lt;&lt;
<a name="1018"/> 1018:          &quot;%% coding: UTF-8\n&quot;
<a name="1019"/> 1019:          &quot;Definitions.\n&quot;
<a name="1020"/> 1020:          &quot;A = a\n&quot;
<a name="1021"/> 1021:          &quot;L = [{A}-{Z}]\n&quot;
<a name="1022"/> 1022:          &quot;Z = z\n&quot;
<a name="1023"/> 1023:          &quot;Rules.\n&quot;
<a name="1024"/> 1024:          &quot;{L}+ : {token,{list_to_atom(TokenChars)}}.\n&quot;
<a name="1025"/> 1025:          &quot;Erlang code.\n&quot;
<a name="1026"/> 1026:          &quot;-export([t/0]).\n&quot;
<a name="1027"/> 1027:          &quot;t() -&gt;\n&quot;
<a name="1028"/> 1028:          &quot;    Häpp\n&quot;
<a name="1029"/> 1029:       &gt;&gt;),
<a name="1030"/> 1030:     {error,[{_,[{11,leex,cannot_parse}]}],[]} = leex:file(Filename, Ret),
<a name="1031"/> 1031: 
<a name="1032"/> 1032:     Mini = &lt;&lt;&quot;Definitions.\n&quot;
<a name="1033"/> 1033:              &quot;D  = [0-9]\n&quot;
<a name="1034"/> 1034:              &quot;Rules.\n&quot;
<a name="1035"/> 1035:              &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n&quot;
<a name="1036"/> 1036:              &quot;Erlang code.\n&quot;&gt;&gt;,
<a name="1037"/> 1037:     LeexPre = filename:join(Dir, &quot;leexinc.hrl&quot;),
<a name="1038"/> 1038:     ok = file:write_file(LeexPre, &lt;&lt;&quot;%% coding: UTF-8\n ä&quot;&gt;&gt;),
<a name="1039"/> 1039:     PreErrors = run_test(Config, Mini, LeexPre),
<a name="1040"/> 1040:     {error,[{IncludeFile,[{2,leex,cannot_parse}]}],[]} = PreErrors,
<a name="1041"/> 1041:     &quot;leexinc.hrl&quot; = filename:basename(IncludeFile),
<a name="1042"/> 1042: 
<a name="1043"/> 1043:     Ts = [{uni_1,
<a name="1044"/> 1044:        &lt;&lt;&quot;%% coding: UTF-8\n&quot;
<a name="1045"/> 1045:          &quot;Definitions.\n&quot;
<a name="1046"/> 1046:          &quot;A = a\n&quot;
<a name="1047"/> 1047:          &quot;L = [{A}-{Z}]\n&quot;
<a name="1048"/> 1048:          &quot;Z = z\n&quot;
<a name="1049"/> 1049:          &quot;Rules.\n&quot;
<a name="1050"/> 1050:          &quot;{L}+ : {token,{list_to_atom(TokenChars),\n&quot;
<a name="1051"/> 1051:          &quot;begin HÃ¤pp = foo, HÃ¤pp end,&quot;
<a name="1052"/> 1052:          &quot; 'HÃ¤pp',\&quot;\\x{400}B\&quot;,\&quot;Ã¶rn_Ð\&quot;}}.\n&quot;
<a name="1053"/> 1053:          &quot;Erlang code.\n&quot;
<a name="1054"/> 1054:          &quot;-export([t/0]).\n&quot;
<a name="1055"/> 1055:          &quot;t() -&gt;\n&quot;
<a name="1056"/> 1056:          &quot;    %% HÃ¤pp, 'HÃ¤pp',\&quot;\\x{400}B\&quot;,\&quot;Ã¶rn_Ð\&quot;\n&quot;
<a name="1057"/> 1057:          &quot;    {ok, [R], {1,4}} = string(\&quot;tip\&quot;),\n&quot;
<a name="1058"/> 1058:          &quot;    {tip,foo,'HÃ¤pp',[1024,66],[246,114,110,95,1024]} = R,\n&quot;
<a name="1059"/> 1059:          &quot;    HÃ¤pp = foo,\n&quot;
<a name="1060"/> 1060:          &quot;    {tip, HÃ¤pp, 'HÃ¤pp',\&quot;\\x{400}B\&quot;,\&quot;Ã¶rn_Ð\&quot;} = R,\n&quot;
<a name="1061"/> 1061:          &quot;    ok.\n&quot;&gt;&gt;,
<a name="1062"/> 1062:           default,
<a name="1063"/> 1063:           ok},
<a name="1064"/> 1064:       {uni_2,
<a name="1065"/> 1065:        &lt;&lt;&quot;%% coding: Latin-1\n&quot;
<a name="1066"/> 1066:          &quot;Definitions.\n&quot;
<a name="1067"/> 1067:          &quot;A = a\n&quot;
<a name="1068"/> 1068:          &quot;L = [{A}-{Z}]\n&quot;
<a name="1069"/> 1069:          &quot;Z = z\n&quot;
<a name="1070"/> 1070:          &quot;Rules.\n&quot;
<a name="1071"/> 1071:          &quot;{L}+ : {token,{list_to_atom(TokenChars),\n&quot;
<a name="1072"/> 1072:          &quot;begin Häpp = foo, Häpp end,&quot;
<a name="1073"/> 1073:          &quot; 'Häpp',\&quot;\\x{400}B\&quot;,\&quot;Ã¶rn_Ð\&quot;}}.\n&quot;
<a name="1074"/> 1074:          &quot;Erlang code.\n&quot;
<a name="1075"/> 1075:          &quot;-export([t/0]).\n&quot;
<a name="1076"/> 1076:          &quot;t() -&gt;\n&quot;
<a name="1077"/> 1077:          &quot;    %% Häpp, 'Häpp',\&quot;\\x{400}B\&quot;,\&quot;Ã¶rn_Ð\&quot;\n&quot;
<a name="1078"/> 1078:          &quot;    {ok, [R], {1,4}} = string(\&quot;tip\&quot;),\n&quot;
<a name="1079"/> 1079:          &quot;    {tip,foo,'Häpp',[1024,66],[195,182,114,110,95,208,128]} = R,\n&quot;
<a name="1080"/> 1080:          &quot;    Häpp = foo,\n&quot;
<a name="1081"/> 1081:          &quot;    {tip, Häpp, 'Häpp',\&quot;\\x{400}B\&quot;,\&quot;Ã¶rn_Ð\&quot;} = R,\n&quot;
<a name="1082"/> 1082:          &quot;    ok.\n&quot;&gt;&gt;,
<a name="1083"/> 1083:           default,
<a name="1084"/> 1084:           ok}],
<a name="1085"/> 1085:     run(Config, Ts),
<a name="1086"/> 1086: 
<a name="otp_10302-last_expr"/><a name="1087"/> 1087:     ok.
<a name="1088"/> 1088: 
<a name="otp_11286-1"/><a name="1089"/> 1089: <b>otp_11286</b>(doc) -&gt;
<a name="1090"/> 1090:     &quot;OTP-11286. A Unicode filename bug; both Leex and Yecc.&quot;;
<a name="1091"/> 1091: <b>otp_11286</b>(suite) -&gt; [];
<a name="1092"/> 1092: <b>otp_11286</b>(Config) when is_list(Config) -&gt;
<a name="1093"/> 1093:     {ok, Peer, Node} = ?CT_PEER([&quot;+fnu&quot;]),
<a name="1094"/> 1094:     Dir = ?privdir,
<a name="1095"/> 1095:     UName = [1024] ++ &quot;u&quot;,
<a name="1096"/> 1096:     UDir = filename:join(Dir, UName),
<a name="1097"/> 1097:     _ = rpc:call(Node, file, make_dir, [UDir]),
<a name="1098"/> 1098: 
<a name="1099"/> 1099:     %% Note: Cannot use UName as filename since the filename is used
<a name="1100"/> 1100:     %% as module name. To be fixed in R18.
<a name="1101"/> 1101:     Filename = filename:join(UDir, 'OTP-11286.xrl'),
<a name="1102"/> 1102:     Scannerfile = filename:join(UDir, 'OTP-11286.erl'),
<a name="1103"/> 1103:     Options = [return, {scannerfile, Scannerfile}],
<a name="1104"/> 1104: 
<a name="1105"/> 1105:     Mini1 = &lt;&lt;&quot;%% coding: utf-8\n&quot;
<a name="1106"/> 1106:               &quot;Definitions.\n&quot;
<a name="1107"/> 1107:               &quot;D  = [0-9]\n&quot;
<a name="1108"/> 1108:               &quot;Rules.\n&quot;
<a name="1109"/> 1109:               &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n&quot;
<a name="1110"/> 1110:               &quot;Erlang code.\n&quot;&gt;&gt;,
<a name="1111"/> 1111:     ok = rpc:call(Node, file, write_file, [Filename, Mini1]),
<a name="1112"/> 1112:     {ok, _, []} = rpc:call(Node, leex, file, [Filename, Options]),
<a name="1113"/> 1113:     {ok,_,_} = rpc:call(Node, compile, file,
<a name="1114"/> 1114:                   [Scannerfile,[basic_validation,return]]),
<a name="1115"/> 1115: 
<a name="1116"/> 1116:     Mini2 = &lt;&lt;&quot;Definitions.\n&quot;
<a name="1117"/> 1117:               &quot;D  = [0-9]\n&quot;
<a name="1118"/> 1118:               &quot;Rules.\n&quot;
<a name="1119"/> 1119:               &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n&quot;
<a name="1120"/> 1120:               &quot;Erlang code.\n&quot;&gt;&gt;,
<a name="1121"/> 1121:     ok = rpc:call(Node, file, write_file, [Filename, Mini2]),
<a name="1122"/> 1122:     {ok, _, []} = rpc:call(Node, leex, file, [Filename, Options]),
<a name="1123"/> 1123:     {ok,_,_} = rpc:call(Node, compile, file,
<a name="1124"/> 1124:                   [Scannerfile,[basic_validation,return]]),
<a name="1125"/> 1125: 
<a name="1126"/> 1126:     Mini3 = &lt;&lt;&quot;%% coding: latin-1\n&quot;
<a name="1127"/> 1127:               &quot;Definitions.\n&quot;
<a name="1128"/> 1128:               &quot;D  = [0-9]\n&quot;
<a name="1129"/> 1129:               &quot;Rules.\n&quot;
<a name="1130"/> 1130:               &quot;{L}+  : {token,{word,TokenLine,TokenChars}}.\n&quot;
<a name="1131"/> 1131:               &quot;Erlang code.\n&quot;&gt;&gt;,
<a name="1132"/> 1132:     ok = rpc:call(Node, file, write_file, [Filename, Mini3]),
<a name="1133"/> 1133:     {ok, _, []} = rpc:call(Node, leex, file, [Filename, Options]),
<a name="1134"/> 1134:     {ok,_,_} = rpc:call(Node, compile, file,
<a name="1135"/> 1135:                   [Scannerfile,[basic_validation,return]]),
<a name="1136"/> 1136: 
<a name="1137"/> 1137:     peer:stop(Peer),
<a name="otp_11286-last_expr"/><a name="1138"/> 1138:     ok.
<a name="1139"/> 1139: 
<a name="otp_13916-1"/><a name="1140"/> 1140: <b>otp_13916</b>(doc) -&gt;
<a name="1141"/> 1141:     &quot;OTP-13916. Leex rules with newlines result in bad line numbers&quot;;
<a name="1142"/> 1142: <b>otp_13916</b>(suite) -&gt; [];
<a name="1143"/> 1143: <b>otp_13916</b>(Config) when is_list(Config) -&gt;
<a name="1144"/> 1144:     Ts = [{otp_13916_1,
<a name="1145"/> 1145:            &lt;&lt;&quot;Definitions.\n&quot;
<a name="1146"/> 1146:              &quot;W = [a-zA-Z0-9]\n&quot;
<a name="1147"/> 1147:              &quot;S = [\\s\\t]\n&quot;
<a name="1148"/> 1148:              &quot;B = [\\n\\r]\n&quot;
<a name="1149"/> 1149:              &quot;Rules.\n&quot;
<a name="1150"/> 1150:              &quot;%% mark line break(s) and empty lines by token 'break'\n&quot;
<a name="1151"/> 1151:              &quot;%% in order to use as delimiters\n&quot;
<a name="1152"/> 1152:              &quot;{B}({S}*{B})+ : {token, {break,   TokenLoc}}.\n&quot;
<a name="1153"/> 1153:              &quot;{B}           : {token, {break,   TokenLoc}}.\n&quot;
<a name="1154"/> 1154:              &quot;{S}+          : {token, {blank,   TokenLoc, TokenChars}}.\n&quot;
<a name="1155"/> 1155:              &quot;{W}+          : {token, {word,    TokenLoc, TokenChars}}.\n&quot;
<a name="1156"/> 1156:              &quot;Erlang code.\n&quot;
<a name="1157"/> 1157:              &quot;-export([t/0]).\n&quot;
<a name="1158"/> 1158:              &quot;t() -&gt;\n&quot;
<a name="1159"/> 1159:              &quot;    {ok,[{break,{1,1}},{blank,{4,1},\&quot;  \&quot;},{word,{4,3},\&quot;breaks\&quot;}],{4,9}} =\n&quot;
<a name="1160"/> 1160:              &quot;        string(\&quot;\\n\\n  \\n  breaks\&quot;),\n&quot;
<a name="1161"/> 1161:              &quot;{ok,[{break,{1,1}},{word,{4,1},\&quot;works\&quot;}],{4,6}} =\n&quot;
<a name="1162"/> 1162:              &quot;        string(\&quot;\\n\\n  \\nworks\&quot;),\n&quot;
<a name="1163"/> 1163:              &quot;    {ok,[{break,{1,1}},{word,{4,1},\&quot;L4\&quot;},{break,{4,3}},\n&quot;
<a name="1164"/> 1164:              &quot;         {word,{5,1},\&quot;L5\&quot;},{break,{5,3}},{word,{7,1},\&quot;L7\&quot;}], {7,3}} =\n&quot;
<a name="1165"/> 1165:              &quot;        string(\&quot;\\n\\n  \\nL4\\nL5\\n\\nL7\&quot;),\n&quot;
<a name="1166"/> 1166:              &quot;{ok,[{break,{1,1}},{blank,{4,1},\&quot; \&quot;},{word,{4,2} ,\&quot;L4\&quot;},\n&quot;
<a name="1167"/> 1167:              &quot;     {break,{4,4}},{blank,{5,1},\&quot; \&quot;},{word,{5,2},\&quot;L5\&quot;},\n&quot;
<a name="1168"/> 1168:              &quot;     {break,{5,4}},{blank,{7,1},\&quot; \&quot;},{word,{7,2},\&quot;L7\&quot;}], {7,4}} =\n&quot;
<a name="1169"/> 1169:              &quot;        string(\&quot;\\n\\n  \\n L4\\n L5\\n\\n L7\&quot;),\n&quot;
<a name="1170"/> 1170:              &quot;    ok.\n&quot;&gt;&gt;,
<a name="1171"/> 1171:            default,
<a name="1172"/> 1172:            ok}],
<a name="1173"/> 1173:     run(Config, Ts),
<a name="otp_13916-last_expr"/><a name="1174"/> 1174:     ok.
<a name="1175"/> 1175: 
<a name="otp_14285-1"/><a name="1176"/> 1176: <b>otp_14285</b>(Config) -&gt;
<a name="1177"/> 1177:     %% x{400} takes 2 bytes to represent
<a name="1178"/> 1178:     Ts = [{otp_14285_1,
<a name="1179"/> 1179:            &lt;&lt;&quot;%% encoding: latin-1\n&quot;
<a name="1180"/> 1180:              &quot;Definitions.\n&quot;
<a name="1181"/> 1181:              &quot;A = a\n&quot;
<a name="1182"/> 1182:              &quot;Z = z\n&quot;
<a name="1183"/> 1183:              &quot;L = [{A}-{Z}]\n&quot;
<a name="1184"/> 1184:              &quot;U = [\\x{400}]\n&quot;
<a name="1185"/> 1185:              &quot;Rules.\n&quot;
<a name="1186"/> 1186:              &quot;{L}+ : {token,l}.\n&quot;
<a name="1187"/> 1187:              &quot;{U}+ : {token,{TokenLine,'\\x{400}'}}.\n&quot;
<a name="1188"/> 1188:              &quot;Erlang code.\n&quot;
<a name="1189"/> 1189:              &quot;-export([t/0]).\n&quot;
<a name="1190"/> 1190:              &quot;t() -&gt;\n&quot;
<a name="1191"/> 1191:              &quot;    {ok,[{1,'\\x{400}'}],{1,3}} = string(\&quot;\\x{400}\&quot;), ok.\n&quot;&gt;&gt;,
<a name="1192"/> 1192:            default,
<a name="1193"/> 1193:            ok},
<a name="1194"/> 1194:           {otp_14285_2,
<a name="1195"/> 1195:            &lt;&lt;&quot;%% encoding: UTF-8\n&quot;
<a name="1196"/> 1196:              &quot;Definitions.\n&quot;
<a name="1197"/> 1197:              &quot;A = a\n&quot;
<a name="1198"/> 1198:              &quot;Z = z\n&quot;
<a name="1199"/> 1199:              &quot;L = [{A}-{Z}]\n&quot;
<a name="1200"/> 1200:              &quot;U = [\x{400}]\n&quot;
<a name="1201"/> 1201:              &quot;Rules.\n&quot;
<a name="1202"/> 1202:              &quot;{L}+ : {token,l}.\n&quot;
<a name="1203"/> 1203:              &quot;{U}+ : {token,'\x{400}'}.\n&quot;
<a name="1204"/> 1204:              &quot;Erlang code.\n&quot;
<a name="1205"/> 1205:              &quot;-export([t/0]).\n&quot;
<a name="1206"/> 1206:              &quot;t() -&gt;\n&quot;
<a name="1207"/> 1207:              &quot;    {ok,['\x{400}'],{1,3}} = string(\&quot;\x{400}\&quot;), ok.\n&quot;/utf8&gt;&gt;,
<a name="1208"/> 1208:            default,
<a name="1209"/> 1209:            ok}],
<a name="1210"/> 1210:     run(Config, Ts),
<a name="otp_14285-last_expr"/><a name="1211"/> 1211:     ok.
<a name="1212"/> 1212: 
<a name="otp_17023-1"/><a name="1213"/> 1213: <b>otp_17023</b>(Config) -&gt;
<a name="1214"/> 1214:     Dir = ?privdir,
<a name="1215"/> 1215:     Filename = filename:join(Dir, &quot;file.xrl&quot;),
<a name="1216"/> 1216:     Ret = [return, {report, true}],
<a name="1217"/> 1217: 
<a name="1218"/> 1218:     {'EXIT', {badarg, _}} = (catch leex:file(Filename, [{noopt,true}])),
<a name="1219"/> 1219:     OldEnv = os:getenv(&quot;ERL_COMPILER_OPTIONS&quot;),
<a name="1220"/> 1220:     true = os:putenv(&quot;ERL_COMPILER_OPTIONS&quot;, &quot;strong_validation&quot;),
<a name="1221"/> 1221:     ok = file:write_file(Filename,
<a name="1222"/> 1222:                                &lt;&lt;&quot;Definitions.\n&quot;
<a name="1223"/> 1223:                                  &quot;Rules.\n&quot;
<a name="1224"/> 1224:                                  &quot;^ : .\n&quot;
<a name="1225"/> 1225:                                  &quot;Erlang code.\n&quot;&gt;&gt;),
<a name="1226"/> 1226:     {error,[{_,[{3,leex,{regexp,_}}]}],[]} = 
<a name="1227"/> 1227:         leex:file(Filename, Ret),
<a name="1228"/> 1228:     true = os:putenv(&quot;ERL_COMPILER_OPTIONS&quot;, &quot;{return, false}&quot;),
<a name="1229"/> 1229:     error = leex:file(Filename, Ret),
<a name="1230"/> 1230:     error = leex:file(Filename, [return | Ret]), % overridden
<a name="1231"/> 1231:     case OldEnv of
<a name="1232"/> 1232:         false -&gt;
<a name="1233"/> 1233:             os:unsetenv(&quot;ERL_COMPILER_OPTIONS&quot;);
<a name="1234"/> 1234:         _ -&gt;
<a name="1235"/> 1235:             os:putenv(&quot;ERL_COMPILER_OPTIONS&quot;, OldEnv)
<a name="1236"/> 1236:     end,
<a name="otp_17023-last_expr"/><a name="1237"/> 1237:     ok.
<a name="1238"/> 1238: 
<a name="1239"/> 1239: <i>%% Additional tests added with column support</i>
<a name="column_support-1"/><a name="1240"/> 1240: <b>column_support</b>(Config) -&gt;
<a name="1241"/> 1241:     Ts = [{token_col_var,
<a name="1242"/> 1242:         &lt;&lt;&quot;Definitions.\n&quot;
<a name="1243"/> 1243:         &quot;D = [0-9]\n&quot;
<a name="1244"/> 1244:         &quot;W = [\\s\\n]\n&quot;
<a name="1245"/> 1245:         &quot;Rules.\n&quot;
<a name="1246"/> 1246:         &quot;{W}+ :\n&quot;
<a name="1247"/> 1247:         &quot;skip_token.\n&quot;
<a name="1248"/> 1248:         &quot;{D}+ :\n&quot;
<a name="1249"/> 1249:         &quot;{token,{integer,{TokenLine,TokenCol},list_to_integer(TokenChars)}}.\n&quot;
<a name="1250"/> 1250:         &quot;{D}+\\.{D}+((E|e)(\\+|\\-)?{D}+)? :\n&quot;
<a name="1251"/> 1251:         &quot;{token,{float,{TokenLine,TokenCol},list_to_float(TokenChars)}}.\n&quot;
<a name="1252"/> 1252:         &quot;Erlang code.\n&quot;
<a name="1253"/> 1253:         &quot;-export([t/0]).\n&quot;
<a name="1254"/> 1254:         &quot;t() -&gt;\n&quot;
<a name="1255"/> 1255:         &quot;{ok,[{float, {2,1}, 4.44},{integer, {3,3}, 5},{integer, {7,3}, 7}],{8,2}}&quot;
<a name="1256"/> 1256:         &quot;= string(\&quot;\n4.44  \n  5 \n  \n\n\n  7 \n \&quot;), ok.\n&quot;&gt;&gt;,
<a name="1257"/> 1257:             default,
<a name="1258"/> 1258:             ok},
<a name="1259"/> 1259:         {tab,
<a name="1260"/> 1260:         &lt;&lt;&quot;Definitions.\n&quot;
<a name="1261"/> 1261:             &quot;Rules.\n&quot;
<a name="1262"/> 1262:             &quot;[a]+[\\n]*= : {token, {first, TokenLoc}}.\n&quot;
<a name="1263"/> 1263:             &quot;[a]+ : {token, {second, TokenLoc}}.\n&quot;
<a name="1264"/> 1264:             &quot;[\\s\\r\\n\\t]+ : skip_token.\n&quot;
<a name="1265"/> 1265:             &quot;Erlang code.\n&quot;
<a name="1266"/> 1266:             &quot;-export([t/0]).\n&quot;
<a name="1267"/> 1267:             &quot;t() -&gt;\n&quot;
<a name="1268"/> 1268:             &quot;{ok,[{second,{1,27}},{second,{2,19}}],{2,25}} = string(\&quot;   \t \t\t  a\\n \t \t  aaa\t\&quot;), ok.\n&quot;&gt;&gt;,
<a name="1269"/> 1269:         default,
<a name="1270"/> 1270:         ok},
<a name="1271"/> 1271:         {tab_custom_size,
<a name="1272"/> 1272:         &lt;&lt;&quot;Definitions.\n&quot;
<a name="1273"/> 1273:             &quot;Rules.\n&quot;
<a name="1274"/> 1274:             &quot;[a]+[\\n]*= : {token, {first, TokenLoc}}.\n&quot;
<a name="1275"/> 1275:             &quot;[a]+ : {token, {second, TokenLoc}}.\n&quot;
<a name="1276"/> 1276:             &quot;[\\s\\r\\n\\t]+ : skip_token.\n&quot;
<a name="1277"/> 1277:             &quot;Erlang code.\n&quot;
<a name="1278"/> 1278:             &quot;-export([t/0]).\n&quot;
<a name="1279"/> 1279:             &quot;t() -&gt;\n&quot;
<a name="1280"/> 1280:             &quot;{ok,[{second,{1,15}},{second,{2,9}}],{2,16}} = string(\&quot;   \t \t\t  a\\n \t \t  aaa\t\&quot;), ok.\n&quot;&gt;&gt;,
<a name="1281"/> 1281:             default,
<a name="1282"/> 1282:             [{tab_size,3}],
<a name="1283"/> 1283:         ok}],
<a name="1284"/> 1284:     run(Config, Ts),
<a name="column_support-last_expr"/><a name="1285"/> 1285:     ok.
<a name="1286"/> 1286: 
<a name="1287"/> 1287: <i>%% OTP-17499. GH-4918.</i>
<a name="compiler_warnings-1"/><a name="1288"/> 1288: <b>compiler_warnings</b>(Config) -&gt;
<a name="1289"/> 1289:     Xrl =
<a name="1290"/> 1290:         &lt;&lt;&quot;
<a name="1291"/> 1291: Definitions.
<a name="1292"/> 1292: Rules.
<a name="1293"/> 1293: /(\\\\.|[^\\\\/]|\\[(/|\\\\.|[^\\\\/])+\\]|\\((\\\\.|/|[^\\\\/])+\\)+)*/ : a.
<a name="1294"/> 1294: /\\*([^*][\\r\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/ : b.
<a name="1295"/> 1295: Erlang code.
<a name="1296"/> 1296:          &quot;&gt;&gt;,
<a name="1297"/> 1297:     Dir = ?privdir,
<a name="1298"/> 1298:     XrlFile = filename:join(Dir, &quot;compiler_warnings.xrl&quot;),
<a name="1299"/> 1299:     ok = file:write_file(XrlFile, Xrl),
<a name="1300"/> 1300:     ErlFile = filename:join(Dir, &quot;compiler_warnings.erl&quot;),
<a name="1301"/> 1301: erlang:display({xrlfile,XrlFile}),
<a name="1302"/> 1302:     {ok, _} = leex:file(XrlFile, []),
<a name="1303"/> 1303: erlang:display({erlfile,ErlFile}),
<a name="1304"/> 1304:     {ok, compiler_warnings, []} = compile:file(ErlFile, [return]),
<a name="compiler_warnings-last_expr"/><a name="1305"/> 1305:     ok.
<a name="1306"/> 1306: 
<a name="unwritable-1"/><a name="1307"/> 1307: <b>unwritable</b>(Fname) -&gt;
<a name="1308"/> 1308:     {ok, Info} = file:read_file_info(Fname),
<a name="1309"/> 1309:     Mode = Info#file_info.mode - 8#00200,
<a name="unwritable-last_expr"/><a name="1310"/> 1310: <b>    ok = file:write_file_info</b>(Fname, Info#file_info{mode = Mode}).
<a name="1311"/> 1311: 
<a name="writable-1"/><a name="1312"/> 1312: <b>writable</b>(Fname) -&gt;
<a name="1313"/> 1313:     {ok, Info} = file:read_file_info(Fname),
<a name="1314"/> 1314:     Mode = Info#file_info.mode bor 8#00200,
<a name="writable-last_expr"/><a name="1315"/> 1315: <b>    ok = file:write_file_info</b>(Fname, Info#file_info{mode = Mode}).
<a name="1316"/> 1316: 
<a name="run-2"/><a name="1317"/> 1317: <b>run</b>(Config, Tests) -&gt;
<a name="1318"/> 1318:     F = fun F({N,P,Pre,E}) -&gt;
<a name="1319"/> 1319:                 F({N,P,Pre,[],E});
<a name="1320"/> 1320:             F({N,P,Pre,Opts,E}) -&gt;
<a name="1321"/> 1321:             case catch run_test(Config,P,Pre,Opts) of
<a name="1322"/> 1322:                 E -&gt;
<a name="1323"/> 1323:                     ok;
<a name="1324"/> 1324:                 Bad -&gt;
<a name="1325"/> 1325:                     ct:fail(&quot;~nTest ~p failed. Expected~n  ~p~n&quot;
<a name="1326"/> 1326:                               &quot;but got~n  ~p~n&quot;, [N, E, Bad])
<a name="1327"/> 1327:             end
<a name="1328"/> 1328:         end,
<a name="run-last_expr"/><a name="1329"/> 1329: <b>    lists:foreach</b>(F, Tests).
<a name="1330"/> 1330: 
<a name="run_test-3"/><a name="1331"/> 1331: <b>run_test</b>(Config, Def, Pre) -&gt;
<a name="run_test-last_expr"/><a name="1332"/> 1332: <b>    run_test</b>(Config, Def, Pre, []).
<a name="1333"/> 1333: 
<a name="run_test-4"/><a name="1334"/> 1334: <b>run_test</b>(Config, Def, Pre, LOpts0) -&gt;
<a name="1335"/> 1335:     %% io:format(&quot;testing ~s~n&quot;, [binary_to_list(Def)]),
<a name="1336"/> 1336:     DefFile = 'leex_test.xrl',
<a name="1337"/> 1337:     Filename = 'leex_test.erl',
<a name="1338"/> 1338:     DataDir = ?privdir,
<a name="1339"/> 1339:     XrlFile = filename:join(DataDir, DefFile),
<a name="1340"/> 1340:     ErlFile = filename:join(DataDir, Filename),
<a name="1341"/> 1341:     Opts = [return, warn_unused_vars,{outdir,DataDir}],
<a name="1342"/> 1342:     ok = file:write_file(XrlFile, Def),
<a name="1343"/> 1343:     LOpts = LOpts0 ++ [return, {report, false} |
<a name="1344"/> 1344:              case Pre of
<a name="1345"/> 1345:                  default -&gt;
<a name="1346"/> 1346:                      [];
<a name="1347"/> 1347:                  _ -&gt;
<a name="1348"/> 1348:                      [{includefile,Pre}]
<a name="1349"/> 1349:              end],
<a name="1350"/> 1350:     XOpts = [verbose, dfa_graph, {error_location, column}], % just to get some code coverage...
<a name="1351"/> 1351:     LRet = leex:file(XrlFile, XOpts ++ LOpts),
<a name="run_test-last_expr"/><a name="1352"/> 1352:     case LRet of
<a name="1353"/> 1353:         {ok, _Outfile, _LWs} -&gt;
<a name="1354"/> 1354:                  CRet = compile:file(ErlFile, Opts),
<a name="1355"/> 1355:                  case CRet of
<a name="1356"/> 1356:                      {ok, _M, _Ws} -&gt; 
<a name="1357"/> 1357:                          AbsFile = filename:rootname(ErlFile, &quot;.erl&quot;),
<a name="1358"/> 1358:                          Mod = leex_test,
<a name="1359"/> 1359:                          code:purge(Mod),
<a name="1360"/> 1360:                          code:load_abs(AbsFile, Mod),
<a name="1361"/> 1361:                          Mod:t();
<a name="1362"/> 1362:                          %% warnings(ErlFile, Ws);
<a name="1363"/> 1363:                      {error, [{ErlFile,Es}], []} -&gt; {error, Es, []};
<a name="1364"/> 1364:                      {error, [{ErlFile,Es}], [{ErlFile,Ws}]} -&gt; {error, Es, Ws};
<a name="1365"/> 1365:                      Error  -&gt; Error
<a name="1366"/> 1366:                  end;
<a name="1367"/> 1367:         {error, [{XrlFile,LEs}], []} -&gt; {error, LEs, []};
<a name="1368"/> 1368:         {error, [{XrlFile,LEs}], [{XrlFile,LWs}]} -&gt; {error, LEs, LWs};
<a name="1369"/> 1369:         LError -&gt; LError
<a name="1370"/> 1370:     end.
<a name="1371"/> 1371: 
<a name="extract-2"/><a name="1372"/> 1372: <b>extract</b>(File, {error, Es, Ws}) -&gt;
<a name="1373"/> 1373:     {errors, extract(File, Es), extract(File, Ws)};    
<a name="1374"/> 1374: <b>extract</b>(File, Ts) -&gt;
<a name="extract-last_expr"/><a name="1375"/> 1375: <b>    lists:append</b>([T || {F, T} &lt;- Ts,  F =:= File]).
<a name="1376"/> 1376: 
<a name="search_for_file_attr-2"/><a name="1377"/> 1377: <b>search_for_file_attr</b>(PartialFilePathRegex, Forms) -&gt;
<a name="search_for_file_attr-last_expr"/><a name="1378"/> 1378: <b>    lists:search</b>(fun
<a name="1379"/> 1379:                    ({attribute, _, file, {FileAttr, _}}) -&gt;
<a name="1380"/> 1380:                       case re:run(FileAttr, PartialFilePathRegex, [unicode]) of
<a name="1381"/> 1381:                         nomatch -&gt; false;
<a name="1382"/> 1382:                         _ -&gt; true
<a name="1383"/> 1383:                       end;
<a name="1384"/> 1384:                    (_) -&gt; false end,
<a name="1385"/> 1385:                  Forms).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
