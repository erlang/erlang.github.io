<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/mnesia/make_test_dir/mnesia_test/mnesia_recovery_test.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1996-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <b>-module</b>(mnesia_recovery_test).
<a name="23"/>   23: <b>-author</b>('hakan@erix.ericsson.se').
<a name="24"/>   24: 
<a name="25"/>   25: <b>-export</b>([init_per_testcase/2, end_per_testcase/2,
<a name="26"/>   26:          init_per_group/2, end_per_group/2,
<a name="27"/>   27:          all/0, groups/0]).
<a name="28"/>   28: 
<a name="29"/>   29: <b>-export</b>([coord_dies/1, after_full_disc_partition/1,
<a name="30"/>   30:          disc_less/1, garb_decision/1,
<a name="31"/>   31:          delete_during_start/1,
<a name="32"/>   32:          no_master_2/1, no_master_3/1, one_master_2/1, one_master_3/1,
<a name="33"/>   33:          two_master_2/1, two_master_3/1, all_master_2/1,
<a name="34"/>   34:          all_master_3/1,
<a name="35"/>   35:          dirty_read_during_down/1, trans_read_during_down/1,
<a name="36"/>   36:          mnesia_down_during_startup_disk_ram/1,
<a name="37"/>   37:          mnesia_down_during_startup_init_ram/1,
<a name="38"/>   38:          mnesia_down_during_startup_init_disc/1,
<a name="39"/>   39:          mnesia_down_during_startup_init_disc_only/1,
<a name="40"/>   40:          mnesia_down_during_startup_tm_ram/1,
<a name="41"/>   41:          mnesia_down_during_startup_tm_disc/1,
<a name="42"/>   42:          mnesia_down_during_startup_tm_disc_only/1,
<a name="43"/>   43:          with_checkpoint_same/1, with_checkpoint_other/1,
<a name="44"/>   44:          explicit_stop_during_snmp/1,
<a name="45"/>   45:          sym_trans_before_commit_kill_coord_node/1,
<a name="46"/>   46:          sym_trans_before_commit_kill_coord_pid/1,
<a name="47"/>   47:          sym_trans_before_commit_kill_part_after_ask/1,
<a name="48"/>   48:          sym_trans_before_commit_kill_part_before_ask/1,
<a name="49"/>   49:          sym_trans_after_commit_kill_coord_node/1,
<a name="50"/>   50:          sym_trans_after_commit_kill_coord_pid/1,
<a name="51"/>   51:          sym_trans_after_commit_kill_part_after_ask/1,
<a name="52"/>   52:          sym_trans_after_commit_kill_part_do_commit_pre/1,
<a name="53"/>   53:          sym_trans_after_commit_kill_part_do_commit_post/1,
<a name="54"/>   54:          sync_dirty_pre_kill_part/1,
<a name="55"/>   55:          sync_dirty_pre_kill_coord_node/1,
<a name="56"/>   56:          sync_dirty_pre_kill_coord_pid/1,
<a name="57"/>   57:          sync_dirty_post_kill_part/1,
<a name="58"/>   58:          sync_dirty_post_kill_coord_node/1,
<a name="59"/>   59:          sync_dirty_post_kill_coord_pid/1,
<a name="60"/>   60:          async_dirty_pre_kill_part/1,
<a name="61"/>   61:          async_dirty_pre_kill_coord_node/1,
<a name="62"/>   62:          async_dirty_pre_kill_coord_pid/1,
<a name="63"/>   63:          async_dirty_post_kill_part/1,
<a name="64"/>   64:          async_dirty_post_kill_coord_node/1,
<a name="65"/>   65:          async_dirty_post_kill_coord_pid/1,
<a name="66"/>   66:          asymtrans_part_ask/1,
<a name="67"/>   67:          asymtrans_part_commit_vote/1,
<a name="68"/>   68:          asymtrans_part_pre_commit/1,
<a name="69"/>   69:          asymtrans_part_log_commit/1,
<a name="70"/>   70:          asymtrans_part_do_commit/1,
<a name="71"/>   71:          asymtrans_coord_got_votes/1,
<a name="72"/>   72:          asymtrans_coord_pid_got_votes/1,
<a name="73"/>   73:          asymtrans_coord_log_commit_rec/1,
<a name="74"/>   74:          asymtrans_coord_pid_log_commit_rec/1,
<a name="75"/>   75:          asymtrans_coord_log_commit_dec/1,
<a name="76"/>   76:          asymtrans_coord_pid_log_commit_dec/1,
<a name="77"/>   77:          asymtrans_coord_rec_acc_pre_commit_log_commit/1,
<a name="78"/>   78:          asymtrans_coord_pid_rec_acc_pre_commit_log_commit/1,
<a name="79"/>   79:          asymtrans_coord_rec_acc_pre_commit_done_commit/1,
<a name="80"/>   80:          asymtrans_coord_pid_rec_acc_pre_commit_done_commit/1,
<a name="81"/>   81:          after_corrupt_files_decision_log_head/1,
<a name="82"/>   82:          after_corrupt_files_decision_log_tail/1,
<a name="83"/>   83:          after_corrupt_files_latest_log_head/1,
<a name="84"/>   84:          after_corrupt_files_latest_log_tail/1,
<a name="85"/>   85:          after_corrupt_files_table_dat_head/1,
<a name="86"/>   86:          after_corrupt_files_table_dat_tail/1,
<a name="87"/>   87:          after_corrupt_files_schema_dat_head/1,
<a name="88"/>   88:          after_corrupt_files_schema_dat_tail/1]).
<a name="89"/>   89: 
<a name="90"/>   90: <b>-export</b>([reader/2, check/0, get_all_retainers/1,
<a name="91"/>   91:          verify_data/2, verify_where2read/1,
<a name="92"/>   92:          do_trans_loop/2,
<a name="93"/>   93:          start_stop/3, do_sym_trans/2, do_sync_dirty/2, do_async_dirty/2,
<a name="94"/>   94:          do_asym_trans/2, garb_handler/1, mymnesia_start/1
<a name="95"/>   95:         ]).
<a name="96"/>   96: 
<a name="97"/>   97: 
<a name="98"/>   98: <b>-include</b>(&quot;mnesia_test_lib.hrl&quot;).
<a name="99"/>   99: <b>-include_lib</b>(&quot;kernel/include/file.hrl&quot;).
<a name="100"/>  100: 
<a name="init_per_testcase-2"/><a name="101"/>  101: <b>init_per_testcase</b>(Func, Conf) -&gt;
<a name="init_per_testcase-last_expr"/><a name="102"/>  102: <b>    mnesia_test_lib:init_per_testcase</b>(Func, Conf).
<a name="103"/>  103: 
<a name="end_per_testcase-2"/><a name="104"/>  104: <b>end_per_testcase</b>(Func, Conf) -&gt;
<a name="end_per_testcase-last_expr"/><a name="105"/>  105: <b>    mnesia_test_lib:end_per_testcase</b>(Func, Conf).
<a name="106"/>  106: 
<a name="107"/>  107: <b>-define</b>(receive_messages(Msgs), receive_messages(Msgs, ?FILE, ?LINE)).
<a name="108"/>  108: 
<a name="109"/>  109: <i>% First Some debug logging </i>
<a name="110"/>  110: <b>-define</b>(dgb, true).
<a name="111"/>  111: <b>-ifdef</b>(dgb).
<a name="112"/>  112: <b>-define</b>(dl(X, Y), ?verbose(&quot;**TRACING: &quot; ++ X ++ &quot;**~n&quot;, Y)).
<a name="113"/>  113: -else. 
<a name="114"/>  114: <b>-define</b>(dl(X, Y), ok).
<a name="115"/>  115: -endif.
<a name="116"/>  116: 
<a name="117"/>  117: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="all-0"/><a name="118"/>  118: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="119"/>  119:     [{group, mnesia_down}, {group, explicit_stop},
<a name="120"/>  120:      coord_dies, {group, schema_trans}, {group, async_dirty},
<a name="121"/>  121:      {group, sync_dirty}, {group, sym_trans},
<a name="122"/>  122:      {group, asym_trans}, %% after_full_disc_partition,
<a name="123"/>  123:      {group, after_corrupt_files}, disc_less, garb_decision
<a name="124"/>  124:     ].
<a name="125"/>  125: 
<a name="groups-0"/><a name="126"/>  126: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="127"/>  127:     [{schema_trans, [],
<a name="128"/>  128:       [{mnesia_schema_recovery_test, all}]},
<a name="129"/>  129:      {mnesia_down, [],
<a name="130"/>  130:       [{group, mnesia_down_during_startup},
<a name="131"/>  131:        {group, master_node_tests}, {group, read_during_down},
<a name="132"/>  132:        {group, with_checkpoint}, delete_during_start]},
<a name="133"/>  133:      {master_node_tests, [],
<a name="134"/>  134:       [no_master_2, no_master_3, one_master_2, one_master_3,
<a name="135"/>  135:        two_master_2, two_master_3, all_master_2,
<a name="136"/>  136:        all_master_3]},
<a name="137"/>  137:      {read_during_down, [],
<a name="138"/>  138:       [dirty_read_during_down, trans_read_during_down]},
<a name="139"/>  139:      {mnesia_down_during_startup, [],
<a name="140"/>  140:       [mnesia_down_during_startup_disk_ram,
<a name="141"/>  141:        mnesia_down_during_startup_init_ram,
<a name="142"/>  142:        mnesia_down_during_startup_init_disc,
<a name="143"/>  143:        mnesia_down_during_startup_init_disc_only,
<a name="144"/>  144:        mnesia_down_during_startup_tm_ram,
<a name="145"/>  145:        mnesia_down_during_startup_tm_disc,
<a name="146"/>  146:        mnesia_down_during_startup_tm_disc_only]},
<a name="147"/>  147:      {with_checkpoint, [],
<a name="148"/>  148:       [with_checkpoint_same, with_checkpoint_other]},
<a name="149"/>  149:      {explicit_stop, [], [explicit_stop_during_snmp]},
<a name="150"/>  150:      {sym_trans, [],
<a name="151"/>  151:       [sym_trans_before_commit_kill_coord_node,
<a name="152"/>  152:        sym_trans_before_commit_kill_coord_pid,
<a name="153"/>  153:        sym_trans_before_commit_kill_part_after_ask,
<a name="154"/>  154:        sym_trans_before_commit_kill_part_before_ask,
<a name="155"/>  155:        sym_trans_after_commit_kill_coord_node,
<a name="156"/>  156:        sym_trans_after_commit_kill_coord_pid,
<a name="157"/>  157:        sym_trans_after_commit_kill_part_after_ask,
<a name="158"/>  158:        sym_trans_after_commit_kill_part_do_commit_pre,
<a name="159"/>  159:        sym_trans_after_commit_kill_part_do_commit_post]},
<a name="160"/>  160:      {sync_dirty, [],
<a name="161"/>  161:       [sync_dirty_pre_kill_part,
<a name="162"/>  162:        sync_dirty_pre_kill_coord_node,
<a name="163"/>  163:        sync_dirty_pre_kill_coord_pid,
<a name="164"/>  164:        sync_dirty_post_kill_part,
<a name="165"/>  165:        sync_dirty_post_kill_coord_node,
<a name="166"/>  166:        sync_dirty_post_kill_coord_pid]},
<a name="167"/>  167:      {async_dirty, [],
<a name="168"/>  168:       [async_dirty_pre_kill_part,
<a name="169"/>  169:        async_dirty_pre_kill_coord_node,
<a name="170"/>  170:        async_dirty_pre_kill_coord_pid,
<a name="171"/>  171:        async_dirty_post_kill_part,
<a name="172"/>  172:        async_dirty_post_kill_coord_node,
<a name="173"/>  173:        async_dirty_post_kill_coord_pid]},
<a name="174"/>  174:      {asym_trans, [],
<a name="175"/>  175:       [asymtrans_part_ask,
<a name="176"/>  176:        asymtrans_part_commit_vote,
<a name="177"/>  177:        asymtrans_part_pre_commit,
<a name="178"/>  178:        asymtrans_part_log_commit,
<a name="179"/>  179:        asymtrans_part_do_commit,
<a name="180"/>  180:        asymtrans_coord_got_votes,
<a name="181"/>  181:        asymtrans_coord_pid_got_votes,
<a name="182"/>  182:        asymtrans_coord_log_commit_rec,
<a name="183"/>  183:        asymtrans_coord_pid_log_commit_rec,
<a name="184"/>  184:        asymtrans_coord_log_commit_dec,
<a name="185"/>  185:        asymtrans_coord_pid_log_commit_dec,
<a name="186"/>  186:        asymtrans_coord_rec_acc_pre_commit_log_commit,
<a name="187"/>  187:        asymtrans_coord_pid_rec_acc_pre_commit_log_commit,
<a name="188"/>  188:        asymtrans_coord_rec_acc_pre_commit_done_commit,
<a name="189"/>  189:        asymtrans_coord_pid_rec_acc_pre_commit_done_commit]},
<a name="190"/>  190:      {after_corrupt_files, [],
<a name="191"/>  191:       [after_corrupt_files_decision_log_head,
<a name="192"/>  192:        after_corrupt_files_decision_log_tail,
<a name="193"/>  193:        after_corrupt_files_latest_log_head,
<a name="194"/>  194:        after_corrupt_files_latest_log_tail,
<a name="195"/>  195:        after_corrupt_files_table_dat_head,
<a name="196"/>  196:        after_corrupt_files_table_dat_tail,
<a name="197"/>  197:        after_corrupt_files_schema_dat_head,
<a name="198"/>  198:        after_corrupt_files_schema_dat_tail]}].
<a name="199"/>  199: 
<a name="init_per_group-2"/><a name="200"/>  200: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="201"/>  201:     Config.
<a name="202"/>  202: 
<a name="end_per_group-2"/><a name="203"/>  203: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="204"/>  204:     Config.
<a name="205"/>  205: 
<a name="tpcb_config-3"/><a name="206"/>  206: <b>tpcb_config</b>(ReplicaType, _NodeConfig, Nodes) -&gt;
<a name="tpcb_config-last_expr"/><a name="207"/>  207:     [{n_branches, 5},
<a name="208"/>  208:      {n_drivers_per_node, 5},
<a name="209"/>  209:      {replica_nodes, Nodes},
<a name="210"/>  210:      {driver_nodes, Nodes},
<a name="211"/>  211:      {use_running_mnesia, true},
<a name="212"/>  212:      {report_interval, infinity},
<a name="213"/>  213:      {n_accounts_per_branch, 20},
<a name="214"/>  214:      {replica_type, ReplicaType}].
<a name="215"/>  215: 
<a name="216"/>  216: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="217"/>  217: 
<a name="218"/>  218: 
<a name="219"/>  219: 
<a name="no_master_2-1"/><a name="220"/>  220: <b>no_master_2</b>(suite) -&gt; [];
<a name="no_master_2-last_expr"/><a name="221"/>  221: <b>no_master_2</b>(Config) when is_list(Config) -&gt;    mnesia_down_2(no, Config).
<a name="222"/>  222:     
<a name="no_master_3-1"/><a name="223"/>  223: <b>no_master_3</b>(suite) -&gt; [];
<a name="no_master_3-last_expr"/><a name="224"/>  224: <b>no_master_3</b>(Config) when is_list(Config) -&gt;    mnesia_down_3(no, Config).
<a name="225"/>  225: 
<a name="one_master_2-1"/><a name="226"/>  226: <b>one_master_2</b>(suite) -&gt; [];
<a name="one_master_2-last_expr"/><a name="227"/>  227: <b>one_master_2</b>(Config) when is_list(Config) -&gt;   mnesia_down_2(one, Config).
<a name="228"/>  228: 
<a name="one_master_3-1"/><a name="229"/>  229: <b>one_master_3</b>(suite) -&gt; [];
<a name="one_master_3-last_expr"/><a name="230"/>  230: <b>one_master_3</b>(Config) when is_list(Config) -&gt;   mnesia_down_3(one, Config).
<a name="231"/>  231: 
<a name="two_master_2-1"/><a name="232"/>  232: <b>two_master_2</b>(suite) -&gt; [];
<a name="two_master_2-last_expr"/><a name="233"/>  233: <b>two_master_2</b>(Config) when is_list(Config) -&gt;   mnesia_down_2(two, Config).
<a name="234"/>  234: 
<a name="two_master_3-1"/><a name="235"/>  235: <b>two_master_3</b>(suite) -&gt; [];
<a name="two_master_3-last_expr"/><a name="236"/>  236: <b>two_master_3</b>(Config) when is_list(Config) -&gt;   mnesia_down_3(two, Config).
<a name="237"/>  237: 
<a name="all_master_2-1"/><a name="238"/>  238: <b>all_master_2</b>(suite) -&gt; [];
<a name="all_master_2-last_expr"/><a name="239"/>  239: <b>all_master_2</b>(Config) when is_list(Config) -&gt;   mnesia_down_2(all, Config).
<a name="240"/>  240: 
<a name="all_master_3-1"/><a name="241"/>  241: <b>all_master_3</b>(suite) -&gt; [];
<a name="all_master_3-last_expr"/><a name="242"/>  242: <b>all_master_3</b>(Config) when is_list(Config) -&gt;   mnesia_down_3(all, Config).
<a name="243"/>  243: 
<a name="mnesia_down_2-2"/><a name="244"/>  244: <b>mnesia_down_2</b>(Masters, Config) -&gt; 
<a name="245"/>  245:     Nodes = [N1, N2] = ?acquire_nodes(2, Config),
<a name="246"/>  246:     ?match({atomic, ok}, mnesia:create_table(tab1, [{ram_copies, Nodes}])),
<a name="247"/>  247:     ?match({atomic, ok}, mnesia:create_table(tab2, [{disc_copies, Nodes}])),
<a name="248"/>  248:     ?match({atomic, ok}, mnesia:create_table(tab3, [{disc_only_copies, Nodes}])),
<a name="249"/>  249:     ?match({atomic, ok}, mnesia:create_table(tab4, [{ram_copies, [N1]}])),
<a name="250"/>  250:     ?match({atomic, ok}, mnesia:create_table(tab5, [{ram_copies, [N2]}])),
<a name="251"/>  251:     ?match({atomic, ok}, mnesia:create_table(tab6, [{disc_copies, [N1]}])),
<a name="252"/>  252:     ?match({atomic, ok}, mnesia:create_table(tab7, [{disc_copies, [N2]}])),
<a name="253"/>  253:     ?match({atomic, ok}, mnesia:create_table(tab8, [{disc_only_copies, [N1]}])),
<a name="254"/>  254:     ?match({atomic, ok}, mnesia:create_table(tab9, [{disc_only_copies, [N2]}])),
<a name="255"/>  255:     ?match({atomic, ok}, mnesia:create_table(tab10, [{ram_copies, [N1]}, {disc_copies, [N2]}])),
<a name="256"/>  256:     ?match({atomic, ok}, mnesia:create_table(tab11, [{ram_copies, [N2]}, {disc_copies, [N1]}])),
<a name="257"/>  257:     ?match({atomic, ok}, mnesia:create_table(tab12, [{ram_copies, [N1]}, {disc_only_copies, [N2]}])),
<a name="258"/>  258:     ?match({atomic, ok}, mnesia:create_table(tab13, [{ram_copies, [N2]}, {disc_only_copies, [N1]}])),
<a name="259"/>  259:     ?match({atomic, ok}, mnesia:create_table(tab14, [{disc_only_copies, [N1]}, {disc_copies, [N2]}])),
<a name="260"/>  260:     ?match({atomic, ok}, mnesia:create_table(tab15, [{disc_only_copies, [N2]}, {disc_copies, [N1]}])),
<a name="261"/>  261: 
<a name="262"/>  262:     Tabs = [tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8, 
<a name="263"/>  263: 	    tab9, tab10, tab11, tab12, tab13, tab14, tab15],
<a name="264"/>  264:     [?match(ok, rpc:call(Node, mnesia, wait_for_tables, [Tabs, 10000])) || Node &lt;- Nodes],
<a name="265"/>  265:     [insert_data(Tab, 20) || Tab &lt;- Tabs],
<a name="266"/>  266: 
<a name="267"/>  267:     VTabs =
<a name="268"/>  268: 	case Masters of
<a name="269"/>  269: 	    no -&gt;
<a name="270"/>  270: 		Tabs -- [tab4, tab5]; % ram copies
<a name="271"/>  271: 	    one -&gt;
<a name="272"/>  272: 		?match(ok, rpc:call(N1, mnesia, set_master_nodes, [[N1]])),
<a name="273"/>  273: 		Tabs -- [tab1, tab4, tab5, tab10, tab12]; % ram_copies
<a name="274"/>  274: 	    two -&gt;
<a name="275"/>  275: 		?match(ok, rpc:call(N1, mnesia, set_master_nodes, [Nodes])),
<a name="276"/>  276: 		Tabs -- [tab4, tab5];
<a name="277"/>  277: 	    all -&gt; 
<a name="278"/>  278: 		[?match(ok, rpc:call(Node, mnesia, set_master_nodes, [[Node]])) || Node &lt;- Nodes],
<a name="279"/>  279: 		Tabs -- [tab1, tab4, tab5, tab10, tab11, tab12, tab13]
<a name="280"/>  280: 	end,
<a name="281"/>  281: 
<a name="282"/>  282:     mnesia_test_lib:kill_mnesia([N1]),
<a name="283"/>  283:     ?match([], mnesia_test_lib:start_mnesia(Nodes, Tabs)),
<a name="284"/>  284: 
<a name="285"/>  285:     ?match([], mnesia_test_lib:kill_mnesia([N2])),
<a name="286"/>  286:     ?match([], mnesia_test_lib:start_mnesia(Nodes, Tabs)),
<a name="287"/>  287: 
<a name="288"/>  288:     [?match(ok, rpc:call(N1, ?MODULE, verify_data, [Tab, 20])) || Tab &lt;- VTabs],
<a name="289"/>  289:     [?match(ok, rpc:call(N2, ?MODULE, verify_data, [Tab, 20])) || Tab &lt;- VTabs],
<a name="mnesia_down_2-last_expr"/><a name="290"/>  290: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="291"/>  291: 
<a name="mnesia_down_3-2"/><a name="292"/>  292: <b>mnesia_down_3</b>(Masters, Config) -&gt; 
<a name="293"/>  293:     Nodes = [N1, N2, N3] = ?acquire_nodes(3, Config),
<a name="294"/>  294:     ?match({atomic, ok}, mnesia:create_table(tab1, [{ram_copies, Nodes}])),
<a name="295"/>  295:     ?match({atomic, ok}, mnesia:create_table(tab2, [{disc_copies, Nodes}])),
<a name="296"/>  296:     ?match({atomic, ok}, mnesia:create_table(tab3, [{disc_only_copies, Nodes}])),
<a name="297"/>  297:     ?match({atomic, ok}, mnesia:create_table(tab4, [{ram_copies, [N1]}])),
<a name="298"/>  298:     ?match({atomic, ok}, mnesia:create_table(tab5, [{ram_copies, [N2]}])),
<a name="299"/>  299:     ?match({atomic, ok}, mnesia:create_table(tab16, [{ram_copies, [N3]}])),
<a name="300"/>  300:     ?match({atomic, ok}, mnesia:create_table(tab6, [{disc_copies, [N1]}])),
<a name="301"/>  301:     ?match({atomic, ok}, mnesia:create_table(tab7, [{disc_copies, [N2]}])),
<a name="302"/>  302:     ?match({atomic, ok}, mnesia:create_table(tab17, [{disc_copies, [N3]}])),
<a name="303"/>  303:     ?match({atomic, ok}, mnesia:create_table(tab8, [{disc_only_copies, [N1]}])),
<a name="304"/>  304:     ?match({atomic, ok}, mnesia:create_table(tab9, [{disc_only_copies, [N2]}])),
<a name="305"/>  305:     ?match({atomic, ok}, mnesia:create_table(tab18, [{disc_only_copies, [N3]}])),
<a name="306"/>  306:     ?match({atomic, ok}, mnesia:create_table(tab10, [{ram_copies, [N1]}, {disc_copies, [N2, N3]}])),
<a name="307"/>  307:     ?match({atomic, ok}, mnesia:create_table(tab11, [{ram_copies, [N2]}, {disc_copies, [N3, N1]}])),
<a name="308"/>  308:     ?match({atomic, ok}, mnesia:create_table(tab19, [{ram_copies, [N3]}, {disc_copies, [N1, N2]}])),
<a name="309"/>  309:     ?match({atomic, ok}, mnesia:create_table(tab12, [{ram_copies, [N1]}, {disc_only_copies, [N2, N3]}])),
<a name="310"/>  310:     ?match({atomic, ok}, mnesia:create_table(tab13, [{ram_copies, [N2]}, {disc_only_copies, [N3, N1]}])),
<a name="311"/>  311:     ?match({atomic, ok}, mnesia:create_table(tab20, [{ram_copies, [N3]}, {disc_only_copies, [N1, N2]}])),
<a name="312"/>  312:     ?match({atomic, ok}, mnesia:create_table(tab14, [{disc_only_copies, [N1]}, {disc_copies, [N2, N3]}])),
<a name="313"/>  313:     ?match({atomic, ok}, mnesia:create_table(tab15, [{disc_only_copies, [N2]}, {disc_copies, [N3, N1]}])),
<a name="314"/>  314:     ?match({atomic, ok}, mnesia:create_table(tab21, [{disc_only_copies, [N3]}, {disc_copies, [N1, N2]}])),
<a name="315"/>  315: 
<a name="316"/>  316:     Tabs = [tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8, 
<a name="317"/>  317: 	    tab9, tab10, tab11, tab12, tab13, tab14, tab15,
<a name="318"/>  318: 	    tab16, tab17, tab18, tab19, tab20, tab21],
<a name="319"/>  319:     [?match(ok, rpc:call(Node, mnesia, wait_for_tables, [Tabs, 10000])) || Node &lt;- Nodes],
<a name="320"/>  320:     [insert_data(Tab, 20) || Tab &lt;- Tabs],
<a name="321"/>  321: 
<a name="322"/>  322:     VTabs = 
<a name="323"/>  323: 	case Masters of
<a name="324"/>  324: 	    no -&gt;
<a name="325"/>  325: 		Tabs -- [tab4, tab5, tab16]; % ram copies
<a name="326"/>  326: 	    one -&gt;
<a name="327"/>  327: 		?match(ok, rpc:call(N1, mnesia, set_master_nodes, [[N1]])),
<a name="328"/>  328: 		Tabs -- [tab1, tab4, tab5, tab16, tab10, tab12]; % ram copies
<a name="329"/>  329: 	    two -&gt;
<a name="330"/>  330: 		?match(ok, rpc:call(N1, mnesia, set_master_nodes, [Nodes])),
<a name="331"/>  331: 		Tabs -- [tab4, tab5, tab16]; % ram copies
<a name="332"/>  332: 	    all -&gt; 
<a name="333"/>  333: 		[?match(ok, rpc:call(Node, mnesia, set_master_nodes, [[Node]])) || Node &lt;- Nodes],
<a name="334"/>  334: 		Tabs -- [tab1, tab4, tab5, tab16, tab10, 
<a name="335"/>  335: 			 tab11, tab19, tab12, tab13, tab20] % ram copies
<a name="336"/>  336: 	end,
<a name="337"/>  337:     
<a name="338"/>  338:     mnesia_test_lib:kill_mnesia([N1]),
<a name="339"/>  339:     ?match([], mnesia_test_lib:start_mnesia(Nodes, Tabs)),
<a name="340"/>  340:     
<a name="341"/>  341:     ?match([], mnesia_test_lib:kill_mnesia([N2])),
<a name="342"/>  342:     ?match([], mnesia_test_lib:start_mnesia(Nodes, Tabs)),
<a name="343"/>  343: 
<a name="344"/>  344:     ?match([], mnesia_test_lib:kill_mnesia([N3])),
<a name="345"/>  345:     ?match([], mnesia_test_lib:start_mnesia(Nodes, Tabs)),
<a name="346"/>  346: 
<a name="347"/>  347:     ?match([], mnesia_test_lib:kill_mnesia([N2, N1])),
<a name="348"/>  348:     ?match([], mnesia_test_lib:start_mnesia(Nodes, Tabs)),
<a name="349"/>  349: 
<a name="350"/>  350:     ?match([], mnesia_test_lib:kill_mnesia([N2, N3])),
<a name="351"/>  351:     ?match([], mnesia_test_lib:start_mnesia(Nodes, Tabs)),
<a name="352"/>  352: 
<a name="353"/>  353:     ?match([], mnesia_test_lib:kill_mnesia([N1, N3])),
<a name="354"/>  354:     ?match([], mnesia_test_lib:start_mnesia(Nodes, Tabs)),
<a name="355"/>  355: 
<a name="356"/>  356:     [?match(ok, rpc:call(N1, ?MODULE, verify_data, [Tab, 20])) || Tab &lt;- VTabs],
<a name="357"/>  357:     [?match(ok, rpc:call(N2, ?MODULE, verify_data, [Tab, 20])) || Tab &lt;- VTabs],
<a name="358"/>  358:     [?match(ok, rpc:call(N3, ?MODULE, verify_data, [Tab, 20])) || Tab &lt;- VTabs],
<a name="359"/>  359:     
<a name="mnesia_down_3-last_expr"/><a name="360"/>  360: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="361"/>  361: 
<a name="362"/>  362: 
<a name="363"/>  363: 
<a name="dirty_read_during_down-1"/><a name="364"/>  364: <b>dirty_read_during_down</b>(suite) -&gt;
<a name="365"/>  365:     [];
<a name="366"/>  366: <b>dirty_read_during_down</b>(Config) when is_list(Config) -&gt;
<a name="dirty_read_during_down-last_expr"/><a name="367"/>  367: <b>    read_during_down</b>(dirty, Config).
<a name="368"/>  368: 
<a name="trans_read_during_down-1"/><a name="369"/>  369: <b>trans_read_during_down</b>(suite) -&gt;
<a name="370"/>  370:     [];
<a name="371"/>  371: <b>trans_read_during_down</b>(Config) when is_list(Config) -&gt;
<a name="trans_read_during_down-last_expr"/><a name="372"/>  372: <b>    read_during_down</b>(trans, Config).
<a name="373"/>  373: 
<a name="374"/>  374: 
<a name="read_during_down-2"/><a name="375"/>  375: <b>read_during_down</b>(Op, Config) when is_list(Config) -&gt;
<a name="376"/>  376:     Ns = [N1|TNs] = ?acquire_nodes(3, Config),
<a name="377"/>  377:     Tabs = [ram, disc, disco],
<a name="378"/>  378:     
<a name="379"/>  379:     ?match({atomic, ok}, mnesia:create_table(ram, [{ram_copies, TNs}])),
<a name="380"/>  380:     ?match({atomic, ok}, mnesia:create_table(disc, [{disc_copies, TNs}])),
<a name="381"/>  381:     ?match({atomic, ok}, mnesia:create_table(disco, [{disc_only_copies, TNs}])),
<a name="382"/>  382: 
<a name="383"/>  383:     %% Create some work for mnesia_controller when a node goes down
<a name="384"/>  384:     [{atomic, ok} = mnesia:create_table(list_to_atom(&quot;temp&quot; ++ integer_to_list(N)),
<a name="385"/>  385: 					[{ram_copies, Ns}]) || N &lt;- lists:seq(1, 50)],    
<a name="386"/>  386:     
<a name="387"/>  387:     Write = fun(Tab) -&gt; mnesia:write({Tab, key, val}) end,
<a name="388"/>  388:     ?match([ok,ok,ok],
<a name="389"/>  389: 	   [mnesia:sync_dirty(Write, [Tab]) || Tab &lt;- Tabs]),
<a name="390"/>  390:     
<a name="391"/>  391:     Readers = [spawn_link(N1, ?MODULE, reader, [Tab, Op]) || Tab &lt;- Tabs],
<a name="392"/>  392:     [_|_] = W2R= [mnesia:table_info(Tab, where_to_read) || Tab &lt;- Tabs],
<a name="393"/>  393:     ?log(&quot;W2R ~p~n&quot;, [W2R]),
<a name="394"/>  394:     loop_and_kill_mnesia(10, hd(W2R), Tabs),
<a name="395"/>  395:     [Pid ! self() || Pid &lt;- Readers],
<a name="396"/>  396:     ?match([ok, ok, ok],
<a name="397"/>  397: 	   [receive ok -&gt; ok after 5000 -&gt; {Pid, mnesia_lib:dist_coredump()} end
<a name="398"/>  398: 	    || Pid &lt;- Readers]),
<a name="read_during_down-last_expr"/><a name="399"/>  399: <b>    ?verify_mnesia</b>(Ns, []).
<a name="400"/>  400: 
<a name="reader-2"/><a name="401"/>  401: <b>reader</b>(Tab, OP) -&gt;
<a name="402"/>  402:     Res = case OP of 
<a name="403"/>  403: 	      dirty -&gt;
<a name="404"/>  404: 		  catch mnesia:dirty_read({Tab, key});
<a name="405"/>  405: 	      trans -&gt;
<a name="406"/>  406: 		  Read = fun() -&gt; mnesia:read({Tab, key}) end,
<a name="407"/>  407: 		  {_, Temp} = mnesia:transaction(Read),
<a name="408"/>  408: 		  Temp
<a name="409"/>  409: 	  end,
<a name="410"/>  410:     case Res of 
<a name="411"/>  411: 	[{Tab, key, val}] -&gt; ok;
<a name="412"/>  412: 	Else -&gt; 
<a name="413"/>  413: 	    ?error(&quot;Expected ~p Got ~p ~n&quot;, [[{Tab, key, val}], Else]),
<a name="414"/>  414: 	    erlang:error(test_failed)
<a name="415"/>  415:     end,
<a name="reader-last_expr"/><a name="416"/>  416:     receive
<a name="417"/>  417: 	Pid when is_pid(Pid) -&gt;
<a name="418"/>  418: 	    Pid ! ok;
<a name="419"/>  419: 	Other -&gt;
<a name="420"/>  420: 	    io:format(&quot;Msg: ~p~n&quot;, [Other]),
<a name="421"/>  421: 	    error(Other)
<a name="422"/>  422:     after 50 -&gt;
<a name="423"/>  423: 	    reader(Tab, OP)
<a name="424"/>  424:     end.
<a name="425"/>  425: 
<a name="loop_and_kill_mnesia-3"/><a name="426"/>  426: <b>loop_and_kill_mnesia</b>(0, _Node, _Tabs) -&gt; ok;
<a name="427"/>  427: <b>loop_and_kill_mnesia</b>(N, Node, Tabs) -&gt;
<a name="428"/>  428:     mnesia_test_lib:kill_mnesia([Node]),
<a name="429"/>  429:     timer:sleep(100), 
<a name="430"/>  430:     ?match([], mnesia_test_lib:start_mnesia([Node], Tabs)),
<a name="431"/>  431:     [KN | _] = W2R= [mnesia:table_info(Tab, where_to_read) || Tab &lt;- Tabs],
<a name="432"/>  432:     ?match([KN, KN,KN], W2R),
<a name="433"/>  433:     timer:sleep(100), 
<a name="loop_and_kill_mnesia-last_expr"/><a name="434"/>  434: <b>    loop_and_kill_mnesia</b>(N-1, KN, Tabs).
<a name="435"/>  435: 
<a name="436"/>  436: 
<a name="mnesia_down_during_startup_disk_ram-1"/><a name="437"/>  437: <b>mnesia_down_during_startup_disk_ram</b>(suite) -&gt; [];
<a name="438"/>  438: <b>mnesia_down_during_startup_disk_ram</b>(Config) when is_list(Config)-&gt;
<a name="439"/>  439:     [Node1, Node2] = ?acquire_nodes(2, Config ++ 
<a name="440"/>  440: 				    [{tc_timeout, timer:minutes(2)}]),
<a name="441"/>  441:     Tab = down_during_startup,
<a name="442"/>  442:     Def = [{ram_copies, [Node2]}, {disc_copies, [Node1]}],
<a name="443"/>  443:     
<a name="444"/>  444:     ?match({atomic, ok}, mnesia:create_table(Tab, Def)),
<a name="445"/>  445:     ?match(ok, mnesia:dirty_write({Tab, 876234, test_ok})),
<a name="446"/>  446:     timer:sleep(500),
<a name="447"/>  447:     mnesia_test_lib:kill_mnesia([Node1, Node2]),
<a name="448"/>  448:     timer:sleep(500),
<a name="449"/>  449:     mnesia_test_lib:start_mnesia([Node1, Node2], [Tab]),
<a name="450"/>  450:     mnesia_test_lib:kill_mnesia([Node1]),
<a name="451"/>  451:     timer:sleep(500),
<a name="452"/>  452:     ?match([], mnesia_test_lib:start_mnesia([Node1], [Tab])),
<a name="453"/>  453:     ?match([{Tab, 876234, test_ok}], mnesia:dirty_read({Tab,876234})),
<a name="mnesia_down_during_startup_disk_ram-last_expr"/><a name="454"/>  454: <b>    ?verify_mnesia</b>([Node1, Node2], []).
<a name="455"/>  455:     
<a name="mnesia_down_during_startup_init_ram-1"/><a name="456"/>  456: <b>mnesia_down_during_startup_init_ram</b>(suite) -&gt; [];
<a name="457"/>  457: <b>mnesia_down_during_startup_init_ram</b>(Config) when is_list(Config) -&gt;
<a name="458"/>  458:     ?is_debug_compiled,
<a name="459"/>  459:     DP = {mnesia_loader, do_get_network_copy},
<a name="460"/>  460:     Type = ram_copies,
<a name="mnesia_down_during_startup_init_ram-last_expr"/><a name="461"/>  461: <b>    mnesia_down_during_startup2</b>(Config, Type, DP, self()).
<a name="462"/>  462: 
<a name="mnesia_down_during_startup_init_disc-1"/><a name="463"/>  463: <b>mnesia_down_during_startup_init_disc</b>(suite)  -&gt; [];
<a name="464"/>  464: <b>mnesia_down_during_startup_init_disc</b>(Config) when is_list(Config) -&gt;
<a name="465"/>  465:     ?is_debug_compiled,
<a name="466"/>  466:     DP = {mnesia_loader, do_get_network_copy},
<a name="467"/>  467:     Type = disc_copies,
<a name="mnesia_down_during_startup_init_disc-last_expr"/><a name="468"/>  468: <b>    mnesia_down_during_startup2</b>(Config, Type, DP, self()).
<a name="469"/>  469: 
<a name="mnesia_down_during_startup_init_disc_only-1"/><a name="470"/>  470: <b>mnesia_down_during_startup_init_disc_only</b>(suite) -&gt; [];
<a name="471"/>  471: <b>mnesia_down_during_startup_init_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="472"/>  472:     ?is_debug_compiled,
<a name="473"/>  473:     DP = {mnesia_loader, do_get_network_copy},
<a name="474"/>  474:     Type = disc_only_copies,
<a name="mnesia_down_during_startup_init_disc_only-last_expr"/><a name="475"/>  475: <b>    mnesia_down_during_startup2</b>(Config, Type, DP, self()).
<a name="476"/>  476: 
<a name="mnesia_down_during_startup_tm_ram-1"/><a name="477"/>  477: <b>mnesia_down_during_startup_tm_ram</b>(suite) -&gt; [];
<a name="478"/>  478: <b>mnesia_down_during_startup_tm_ram</b>(Config) when is_list(Config) -&gt;
<a name="479"/>  479:     ?is_debug_compiled,
<a name="480"/>  480:     DP = {mnesia_tm, init},
<a name="481"/>  481:     Type = ram_copies,
<a name="mnesia_down_during_startup_tm_ram-last_expr"/><a name="482"/>  482: <b>    mnesia_down_during_startup2</b>(Config, Type, DP, self()).
<a name="483"/>  483: 
<a name="mnesia_down_during_startup_tm_disc-1"/><a name="484"/>  484: <b>mnesia_down_during_startup_tm_disc</b>(suite) -&gt; [];
<a name="485"/>  485: <b>mnesia_down_during_startup_tm_disc</b>(Config) when is_list(Config) -&gt;
<a name="486"/>  486:     ?is_debug_compiled,
<a name="487"/>  487:     DP = {mnesia_tm, init},
<a name="488"/>  488:     Type = disc_copies,
<a name="mnesia_down_during_startup_tm_disc-last_expr"/><a name="489"/>  489: <b>    mnesia_down_during_startup2</b>(Config, Type, DP, self()).
<a name="490"/>  490: 
<a name="mnesia_down_during_startup_tm_disc_only-1"/><a name="491"/>  491: <b>mnesia_down_during_startup_tm_disc_only</b>(suite) -&gt; [];
<a name="492"/>  492: <b>mnesia_down_during_startup_tm_disc_only</b>(Config) when is_list(Config) -&gt;
<a name="493"/>  493:     ?is_debug_compiled,
<a name="494"/>  494:     DP = {mnesia_tm, init},
<a name="495"/>  495:     Type = disc_only_copies,
<a name="mnesia_down_during_startup_tm_disc_only-last_expr"/><a name="496"/>  496: <b>    mnesia_down_during_startup2</b>(Config, Type, DP, self()).
<a name="497"/>  497: 
<a name="mnesia_down_during_startup2-4"/><a name="498"/>  498: <b>mnesia_down_during_startup2</b>(Config, ReplicaType, Debug_Point, _Father) -&gt; 
<a name="499"/>  499:     ?log(&quot;TC~n mnesia_down_during_startup with type ~w and stops at ~w~n&quot;,
<a name="500"/>  500: 	 [ReplicaType, Debug_Point]),
<a name="501"/>  501:     Tpcb_tabs = [history,teller,account,branch],
<a name="502"/>  502:     Nodes = ?acquire_nodes(2, Config),
<a name="503"/>  503:     Node1 = hd(Nodes),
<a name="504"/>  504:     {success, [A]} = ?start_activities([Node1]),
<a name="505"/>  505:     TpcbConfig = tpcb_config(ReplicaType, 2, Nodes),
<a name="506"/>  506:     mnesia_tpcb:init(TpcbConfig),
<a name="507"/>  507:     A ! fun () -&gt; mnesia_tpcb:run(TpcbConfig) end,
<a name="508"/>  508:     ?match_receive(timeout),
<a name="509"/>  509:     timer:sleep(timer:seconds(10)),  % Let tpcb run for a while
<a name="510"/>  510:     mnesia_tpcb:stop(),
<a name="511"/>  511:     ?match(ok, mnesia_tpcb:verify_tabs()), 
<a name="512"/>  512:     mnesia_test_lib:kill_mnesia([Node1]),
<a name="513"/>  513:     timer:sleep(timer:seconds(2)),
<a name="514"/>  514:     Self = self(),
<a name="515"/>  515:     TestFun = fun(_MnesiaEnv, _EvalEnv) -&gt;
<a name="516"/>  516: 		      ?deactivate_debug_fun(Debug_Point),
<a name="517"/>  517: 		      Self ! fun_done, 
<a name="518"/>  518: 		      spawn(mnesia_test_lib, kill_mnesia, [[Node1]])
<a name="519"/>  519: 	      end,    
<a name="520"/>  520:     ?activate_debug_fun(Debug_Point, TestFun, []),      % Kill when debug has been reached
<a name="521"/>  521:     mnesia:start(),
<a name="522"/>  522:     Res = receive fun_done -&gt; ok after timer:minutes(3) -&gt; timeout end, % Wait till it's killed
<a name="523"/>  523:     ?match(ok, Res),
<a name="524"/>  524:     ?match(ok, timer:sleep(timer:seconds(2))), % Wait a while, at least till it dies;
<a name="525"/>  525:     ?match([], mnesia_test_lib:start_mnesia([Node1], Tpcb_tabs)),  
<a name="526"/>  526:     ?match(ok, mnesia_tpcb:verify_tabs()), % Verify it
<a name="mnesia_down_during_startup2-last_expr"/><a name="527"/>  527: <b>    ?verify_mnesia</b>(Nodes, []).    	    
<a name="528"/>  528: 
<a name="529"/>  529: 
<a name="530"/>  530: 
<a name="with_checkpoint_same-1"/><a name="531"/>  531: <b>with_checkpoint_same</b>(suite) -&gt; [];
<a name="532"/>  532: <b>with_checkpoint_same</b>(Config) when is_list(Config) -&gt; 
<a name="with_checkpoint_same-last_expr"/><a name="533"/>  533: <b>    with_checkpoint</b>(Config, same).
<a name="534"/>  534: 
<a name="with_checkpoint_other-1"/><a name="535"/>  535: <b>with_checkpoint_other</b>(suite) -&gt; [];
<a name="536"/>  536: <b>with_checkpoint_other</b>(Config) when is_list(Config) -&gt; 
<a name="with_checkpoint_other-last_expr"/><a name="537"/>  537: <b>    with_checkpoint</b>(Config, other).
<a name="538"/>  538: 
<a name="with_checkpoint-2"/><a name="539"/>  539: <b>with_checkpoint</b>(Config, Type) when is_list(Config) -&gt;
<a name="540"/>  540:     Nodes = [Node1, Node2] = ?acquire_nodes(2, Config),
<a name="541"/>  541:     Kill = case Type of
<a name="542"/>  542: 	       same -&gt;    %% Node1 is the one used for creating the checkpoint
<a name="543"/>  543: 		   Node1; %% and which we bring down
<a name="544"/>  544: 	       other -&gt;
<a name="545"/>  545: 		   Node2  %% Here we bring node2 down..
<a name="546"/>  546: 	   end,
<a name="547"/>  547:     
<a name="548"/>  548:     ?match({atomic, ok}, mnesia:create_table(ram, [{ram_copies, Nodes}])),
<a name="549"/>  549:     ?match({atomic, ok}, mnesia:create_table(disc, [{disc_copies, Nodes}])),
<a name="550"/>  550:     ?match({atomic, ok}, mnesia:create_table(disco, [{disc_only_copies, Nodes}])),
<a name="551"/>  551:     Tabs = [ram, disc, disco],
<a name="552"/>  552:     
<a name="553"/>  553:     ?match({ok, sune, _}, mnesia:activate_checkpoint([{name, sune}, 
<a name="554"/>  554: 						      {max, mnesia:system_info(tables)}, 
<a name="555"/>  555: 						      {ram_overrides_dump, true}])),
<a name="556"/>  556: 
<a name="557"/>  557:     ?match([], check_retainers(sune, Nodes)),
<a name="558"/>  558:     
<a name="559"/>  559:     ?match(ok, mnesia:deactivate_checkpoint(sune)),
<a name="560"/>  560:     ?match([], check_chkp(Nodes)),
<a name="561"/>  561:     
<a name="562"/>  562:     timer:sleep(500),  %% Just to help debugging the io:formats now comes in the
<a name="563"/>  563:     %% correct order... :-)    
<a name="564"/>  564: 
<a name="565"/>  565:     ?match({ok, sune, _}, mnesia:activate_checkpoint([{name, sune}, 
<a name="566"/>  566: 	{max, mnesia:system_info(tables)}, 
<a name="567"/>  567: 	{ram_overrides_dump, true}])),
<a name="568"/>  568: 
<a name="569"/>  569:     [[mnesia:dirty_write({Tab,Key,Key}) || Key &lt;- lists:seq(1,10)] || Tab &lt;- Tabs],
<a name="570"/>  570: 
<a name="571"/>  571:     mnesia_test_lib:kill_mnesia([Kill]),
<a name="572"/>  572:     timer:sleep(100),     
<a name="573"/>  573:     mnesia_test_lib:start_mnesia([Kill], Tabs),
<a name="574"/>  574:     io:format(&quot;Mnesia on ~p started~n&quot;, [Kill]),
<a name="575"/>  575:     ?match([], check_retainers(sune, Nodes)),
<a name="576"/>  576:     ?match(ok, mnesia:deactivate_checkpoint(sune)),
<a name="577"/>  577:     ?match([], check_chkp(Nodes)),
<a name="578"/>  578: 
<a name="579"/>  579:     Wait = fun(Loop) -&gt;
<a name="580"/>  580: 		   timer:sleep(300),
<a name="581"/>  581: 		   sys:get_status(mnesia_monitor),
<a name="582"/>  582: 		   case lists:member(Kill, mnesia_lib:val({current, db_nodes})) of
<a name="583"/>  583: 		       true -&gt; Loop(Loop);
<a name="584"/>  584: 		       false -&gt; ok
<a name="585"/>  585: 		   end
<a name="586"/>  586: 	   end,
<a name="587"/>  587: 
<a name="588"/>  588:     case Kill of
<a name="589"/>  589: 	Node1 -&gt; 
<a name="590"/>  590: 	    ignore;
<a name="591"/>  591: 	Node2 -&gt;
<a name="592"/>  592: 	    mnesia_test_lib:kill_mnesia([Kill]),
<a name="593"/>  593: 	    Wait(Wait),
<a name="594"/>  594: 	    ?match({ok, sune, _}, mnesia:activate_checkpoint([{name, sune}, 
<a name="595"/>  595: 		{max, mnesia:system_info(tables)}, 
<a name="596"/>  596: 		{ram_overrides_dump, true}])),
<a name="597"/>  597: 
<a name="598"/>  598: 	    [[mnesia:dirty_write({Tab,Key,Key+2}) || Key &lt;- lists:seq(1,10)] ||
<a name="599"/>  599: 		Tab &lt;- Tabs],
<a name="600"/>  600: 
<a name="601"/>  601: 	    mnesia_test_lib:start_mnesia([Kill], Tabs),
<a name="602"/>  602: 	    io:format(&quot;Mnesia on ~p started ~n&quot;, [Kill]),
<a name="603"/>  603: 	    ?match([], check_retainers(sune, Nodes)),
<a name="604"/>  604: 	    ?match(ok, mnesia:deactivate_checkpoint(sune)),
<a name="605"/>  605: 	    ?match([], check_chkp(Nodes)),	    
<a name="606"/>  606: 	    ok
<a name="607"/>  607:     end,
<a name="with_checkpoint-last_expr"/><a name="608"/>  608: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="609"/>  609: 
<a name="check_chkp-1"/><a name="610"/>  610: <b>check_chkp</b>(Nodes) -&gt;
<a name="611"/>  611:     {Good, Bad} = rpc:multicall(Nodes, ?MODULE, check, []),
<a name="check_chkp-last_expr"/><a name="612"/>  612: <b>    lists:flatten</b>(Good ++ Bad).
<a name="613"/>  613: 
<a name="check-0"/><a name="614"/>  614: <b>check</b>() -&gt;
<a name="615"/>  615:     [PCP] = ets:match_object(mnesia_gvar, {pending_checkpoint_pids, '_'}),
<a name="616"/>  616:     [PC]  = ets:match_object(mnesia_gvar, {pending_checkpoints, '_'}),
<a name="617"/>  617:     [CPN] = ets:match_object(mnesia_gvar, {checkpoints, '_'}),    
<a name="618"/>  618:     F = lists:filter(fun({_, []}) -&gt; false; (_W) -&gt; true end, 
<a name="619"/>  619: 		     [PCP,PC,CPN]),    
<a name="620"/>  620:     CPP = ets:match_object(mnesia_gvar, {{checkpoint, '_'}, '_'}),
<a name="621"/>  621:     Rt  = ets:match_object(mnesia_gvar, {{'_', {retainer, '_'}}, '_'}),
<a name="check-last_expr"/><a name="622"/>  622:     F ++ CPP ++ Rt.
<a name="623"/>  623: 
<a name="624"/>  624: 
<a name="check_retainers-2"/><a name="625"/>  625: <b>check_retainers</b>(CHP, Nodes) -&gt;
<a name="626"/>  626:     {[R1,R2], []} = rpc:multicall(Nodes, ?MODULE, get_all_retainers, [CHP]),
<a name="check_retainers-last_expr"/><a name="627"/>  627: <b>    </b>(R1 -- R2) ++ (R2 -- R1).
<a name="628"/>  628:         
<a name="get_all_retainers-1"/><a name="629"/>  629: <b>get_all_retainers</b>(CHP) -&gt;
<a name="630"/>  630:     Tabs = mnesia:system_info(local_tables),
<a name="631"/>  631:     Iter = fun(Tab) -&gt;
<a name="632"/>  632: 		   {ok, Res} = 
<a name="633"/>  633: 		       mnesia_checkpoint:iterate(CHP, Tab, fun(R, A) -&gt; [R|A] end, [],
<a name="634"/>  634: 						 retainer, checkpoint),
<a name="635"/>  635: <i>%%		   io:format(&quot;Retainer content ~w ~n&quot;, [Res]),</i>
<a name="636"/>  636: 		   Res
<a name="637"/>  637: 	   end,
<a name="638"/>  638:     Elements = [Iter(Tab) || Tab &lt;- Tabs],
<a name="get_all_retainers-last_expr"/><a name="639"/>  639: <b>    lists:sort</b>(lists:flatten(Elements)).
<a name="640"/>  640:     
<a name="delete_during_start-1"/><a name="641"/>  641: <b>delete_during_start</b>(doc) -&gt;
<a name="642"/>  642:     [&quot;Test that tables can be delete during start, hopefully with tables&quot;
<a name="643"/>  643:      &quot; in the loader queue or soon to be&quot;];
<a name="644"/>  644: <b>delete_during_start</b>(suite) -&gt; [];
<a name="645"/>  645: <b>delete_during_start</b>(Config) when is_list(Config) -&gt;
<a name="646"/>  646:     [N1, N2, N3] = Nodes = ?acquire_nodes(3, Config),
<a name="647"/>  647:     Tabs = [list_to_atom(&quot;tab&quot; ++ integer_to_list(I)) || I &lt;- lists:seq(1, 30)],
<a name="648"/>  648:     ?match({atomic, ok}, mnesia:change_table_copy_type(schema, N2, ram_copies)),
<a name="649"/>  649:     ?match({atomic, ok}, mnesia:change_table_copy_type(schema, N3, ram_copies)),
<a name="650"/>  650: 
<a name="651"/>  651:     [?match({atomic, ok},mnesia:create_table(Tab, [{ram_copies,Nodes}])) || Tab &lt;- Tabs],
<a name="652"/>  652:     lists:foldl(fun(Tab, I) -&gt;
<a name="653"/>  653: 			?match({atomic, ok},
<a name="654"/>  654: 			       mnesia:change_table_load_order(Tab,I)),
<a name="655"/>  655: 			I+1
<a name="656"/>  656: 		end, 1, Tabs),
<a name="657"/>  657:     mnesia_test_lib:kill_mnesia([N2,N3]),
<a name="658"/>  658: <i>%%    timer:sleep(500),</i>
<a name="659"/>  659:     ?match({[ok,ok],[]}, rpc:multicall([N2,N3], mnesia,start, 
<a name="660"/>  660: 				       [[{extra_db_nodes,[N1]}, {schema, ?BACKEND}]])),
<a name="661"/>  661:     [Tab1,Tab2,Tab3|_] = Tabs,
<a name="662"/>  662:     ?match({atomic, ok}, mnesia:delete_table(Tab1)),
<a name="663"/>  663:     ?match({atomic, ok}, mnesia:delete_table(Tab2)),
<a name="664"/>  664:     
<a name="665"/>  665:     ?log(&quot;W4T ~p~n&quot;, [rpc:multicall([N2,N3], mnesia, wait_for_tables, [[Tab1,Tab2,Tab3],1])]),
<a name="666"/>  666:     
<a name="667"/>  667:     Remain = Tabs--[Tab1,Tab2],
<a name="668"/>  668:     ?match(ok, rpc:call(N2, mnesia, wait_for_tables, [Remain,10000])),
<a name="669"/>  669:     ?match(ok, rpc:call(N3, mnesia, wait_for_tables, [Remain,10000])),
<a name="670"/>  670: 
<a name="671"/>  671:     ?match(ok, rpc:call(N2, ?MODULE, verify_where2read, [Remain])),
<a name="672"/>  672:     ?match(ok, rpc:call(N3, ?MODULE, verify_where2read, [Remain])),
<a name="673"/>  673: 
<a name="delete_during_start-last_expr"/><a name="674"/>  674: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="675"/>  675:     
<a name="verify_where2read-1"/><a name="676"/>  676: <b>verify_where2read</b>([Tab|Tabs]) -&gt;
<a name="677"/>  677:     true = (node() == mnesia:table_info(Tab,where_to_read)),
<a name="678"/>  678:     verify_where2read(Tabs);
<a name="verify_where2read-last_expr"/><a name="679"/>  679: <b>verify_where2read</b>([]) -&gt; ok.
<a name="680"/>  680: 
<a name="681"/>  681: 
<a name="682"/>  682: <i>%%-------------------------------------------------------------------------------------------</i>
<a name="683"/>  683: <i>%% This is a bad implementation, but at least gives a indication if something is wrong</i>
<a name="explicit_stop_during_snmp-1"/><a name="684"/>  684: <b>explicit_stop_during_snmp</b>(suite) -&gt; [];
<a name="685"/>  685: <b>explicit_stop_during_snmp</b>(Config) when is_list(Config) -&gt;
<a name="686"/>  686:     Nodes = ?acquire_nodes(2, Config),
<a name="687"/>  687:     [Node1, Node2] = Nodes,
<a name="688"/>  688:     Tab = snmp_tab,
<a name="689"/>  689:     Def = [{attributes, [key, value]},
<a name="690"/>  690: 	   {snmp, [{key, integer}]},
<a name="691"/>  691: 	   {mnesia_test_lib:storage_type(disc_copies, Config), 
<a name="692"/>  692: 	    [Node1, Node2]}],
<a name="693"/>  693:     ?match({atomic, ok}, mnesia:create_table(Tab, Def)),
<a name="694"/>  694:     ?match({atomic, ok}, mnesia:transaction(fun() -&gt; mnesia:write({Tab, 1, 1}) end)),
<a name="695"/>  695: 
<a name="696"/>  696:     Do_trans_Pid1 = spawn_link(Node2, ?MODULE, do_trans_loop, [Tab, self()]),
<a name="697"/>  697:     Do_trans_Pid2 = spawn_link(?MODULE, do_trans_loop, [Tab, self()]),
<a name="698"/>  698:     Start_stop_Pid = spawn_link(?MODULE, start_stop, [Node1, 5, self()]),
<a name="699"/>  699:     receive 
<a name="700"/>  700: 	test_done -&gt; 
<a name="701"/>  701: 	    ok
<a name="702"/>  702:     after timer:minutes(5) -&gt;
<a name="703"/>  703: 	    ?error(&quot;test case time out~n&quot;, [])
<a name="704"/>  704:     end,
<a name="705"/>  705:     ?verify_mnesia(Nodes, []),
<a name="706"/>  706:     exit(Do_trans_Pid1, kill),
<a name="707"/>  707:     exit(Do_trans_Pid2, kill),
<a name="708"/>  708:     exit(Start_stop_Pid, kill),
<a name="explicit_stop_during_snmp-last_expr"/><a name="709"/>  709:     ok.
<a name="710"/>  710: 
<a name="do_trans_loop-2"/><a name="711"/>  711: <b>do_trans_loop</b>(Tab, Father) -&gt;
<a name="712"/>  712:     %% Do not trap exit
<a name="do_trans_loop-last_expr"/><a name="713"/>  713: <b>    do_trans_loop2</b>(Tab, Father).
<a name="do_trans_loop2-2"/><a name="714"/>  714: <b>do_trans_loop2</b>(Tab, Father) -&gt;
<a name="715"/>  715:     Trans =
<a name="716"/>  716: 	fun() -&gt;
<a name="717"/>  717: 		[{Tab, 1, Val}] = mnesia:read({Tab, 1}),
<a name="718"/>  718: 		mnesia:write({Tab, 1, Val + 1})
<a name="719"/>  719: 	end,
<a name="do_trans_loop2-last_expr"/><a name="720"/>  720: <b>    case mnesia:transaction</b>(Trans) of
<a name="721"/>  721: 	{atomic, ok} -&gt;
<a name="722"/>  722: 	    timer:sleep(100),
<a name="723"/>  723: 	    do_trans_loop2(Tab, Father);
<a name="724"/>  724: 	{aborted, {node_not_running, N}} when N == node() -&gt;
<a name="725"/>  725: 	    timer:sleep(100),
<a name="726"/>  726: 	    do_trans_loop2(Tab, Father);
<a name="727"/>  727: 	{aborted, {no_exists, Tab}} -&gt;
<a name="728"/>  728: 	    timer:sleep(100),
<a name="729"/>  729: 	    do_trans_loop2(Tab, Father);
<a name="730"/>  730: 	Else -&gt;
<a name="731"/>  731: 	    ?error(&quot;Transaction failed: ~p ~n&quot;, [Else]),
<a name="732"/>  732:             io:format(&quot;INFO: ~p~n&quot;,[erlang:process_info(self())]),
<a name="733"/>  733: 	    Father ! test_done,
<a name="734"/>  734: 	    exit(shutdown)
<a name="735"/>  735:     end.
<a name="736"/>  736: 
<a name="start_stop-3"/><a name="737"/>  737: <b>start_stop</b>(_Node1, 0, Father) -&gt;
<a name="738"/>  738:     Father ! test_done,
<a name="739"/>  739:     exit(shutdown);
<a name="740"/>  740: <b>start_stop</b>(Node1, N, Father) when N &gt; 0-&gt;
<a name="741"/>  741:     timer:sleep(timer:seconds(2)),
<a name="742"/>  742:     ?match(stopped, rpc:call(Node1, mnesia, stop, [])),
<a name="743"/>  743:     timer:sleep(timer:seconds(1)),
<a name="744"/>  744:     ?match([], mnesia_test_lib:start_mnesia([Node1])),
<a name="start_stop-last_expr"/><a name="745"/>  745: <b>    start_stop</b>(Node1, N-1, Father).    
<a name="746"/>  746: 
<a name="coord_dies-1"/><a name="747"/>  747: <b>coord_dies</b>(suite) -&gt; [];
<a name="748"/>  748: <b>coord_dies</b>(doc) -&gt; [&quot;&quot;];
<a name="749"/>  749: <b>coord_dies</b>(Config) when is_list(Config) -&gt;
<a name="750"/>  750:     Nodes = [N1, N2] = ?acquire_nodes(2, Config),
<a name="751"/>  751:     ?match({atomic, ok}, mnesia:create_table(tab1, [{ram_copies, Nodes}])),
<a name="752"/>  752:     ?match({atomic, ok}, mnesia:create_table(tab2, [{ram_copies, [N1]}])),
<a name="753"/>  753:     ?match({atomic, ok}, mnesia:create_table(tab3, [{ram_copies, [N2]}])),
<a name="754"/>  754:     Tester = self(),
<a name="755"/>  755: 
<a name="756"/>  756:     U1 = fun(Tab) -&gt; 
<a name="757"/>  757: 		 [{Tab,key,Val}] = mnesia:read(Tab,key,write),
<a name="758"/>  758: 		 mnesia:write({Tab,key, Val+1}),
<a name="759"/>  759: 		 Tester ! {self(),continue},
<a name="760"/>  760: 		 receive 
<a name="761"/>  761: 		     continue -&gt; exit(crash)
<a name="762"/>  762: 		 end
<a name="763"/>  763: 	 end,
<a name="764"/>  764:     U2 = fun(Tab) -&gt; 
<a name="765"/>  765: 		 [{Tab,key,Val}] = mnesia:read(Tab,key,write),
<a name="766"/>  766: 		 mnesia:write({Tab,key, Val+1}),
<a name="767"/>  767: 		 mnesia:transaction(U1, [Tab])
<a name="768"/>  768: 	 end,
<a name="769"/>  769:     [mnesia:dirty_write(Tab,{Tab,key,0}) || Tab &lt;- [tab1,tab2,tab3]],
<a name="770"/>  770:     Pid1 = spawn(fun() -&gt; mnesia:transaction(U2, [tab1]) end), 
<a name="771"/>  771:     Pid2 = spawn(fun() -&gt; mnesia:transaction(U2, [tab2]) end), 
<a name="772"/>  772:     Pid3 = spawn(fun() -&gt; mnesia:transaction(U2, [tab3]) end), 
<a name="773"/>  773:     [receive {Pid,continue} -&gt; ok end || Pid &lt;- [Pid1,Pid2,Pid3]],
<a name="774"/>  774:     Pid1 ! continue,    Pid2 ! continue,    Pid3 ! continue,
<a name="775"/>  775:     ?match({atomic,[{_,key,1}]}, mnesia:transaction(fun() -&gt; mnesia:read({tab1,key}) end)),
<a name="776"/>  776:     ?match({atomic,[{_,key,1}]}, mnesia:transaction(fun() -&gt; mnesia:read({tab2,key}) end)),
<a name="777"/>  777:     ?match({atomic,[{_,key,1}]}, mnesia:transaction(fun() -&gt; mnesia:read({tab3,key}) end)),
<a name="778"/>  778: 
<a name="779"/>  779:     Pid4 = spawn(fun() -&gt; mnesia:transaction(U2, [tab1]) end), 
<a name="780"/>  780:     Pid5 = spawn(fun() -&gt; mnesia:transaction(U2, [tab2]) end), 
<a name="781"/>  781:     Pid6 = spawn(fun() -&gt; mnesia:transaction(U2, [tab3]) end), 
<a name="782"/>  782:     erlang:monitor(process, Pid4),erlang:monitor(process, Pid5),erlang:monitor(process, Pid6),
<a name="783"/>  783:     
<a name="784"/>  784:     [receive {Pid,continue} -&gt; ok end || Pid &lt;- [Pid4,Pid5,Pid6]],
<a name="785"/>  785:     exit(Pid4,crash),    
<a name="786"/>  786:     ?match_receive({'DOWN',_,_,Pid4, _}),
<a name="787"/>  787:     ?match({atomic,[{_,key,1}]}, mnesia:transaction(fun() -&gt; mnesia:read({tab1,key}) end)),
<a name="788"/>  788:     exit(Pid5,crash),
<a name="789"/>  789:     ?match_receive({'DOWN',_,_,Pid5, _}),
<a name="790"/>  790:     ?match({atomic,[{_,key,1}]}, mnesia:transaction(fun() -&gt; mnesia:read({tab2,key}) end)),
<a name="791"/>  791:     exit(Pid6,crash),
<a name="792"/>  792:     ?match_receive({'DOWN',_,_,Pid6, _}),
<a name="793"/>  793:     ?match({atomic,[{_,key,1}]}, mnesia:transaction(fun() -&gt; mnesia:read({tab3,key}) end)),
<a name="794"/>  794:     
<a name="coord_dies-last_expr"/><a name="795"/>  795: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="796"/>  796: 
<a name="797"/>  797: 
<a name="798"/>  798: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="799"/>  799:  
<a name="800"/>  800: 
<a name="801"/>  801: <i>%kill_after_debug_point(Config, TestCase, {Debug_node, Debug_Point}, TransFun, Tab)</i>
<a name="802"/>  802: 
<a name="sym_trans_before_commit_kill_coord_node-1"/><a name="803"/>  803: <b>sym_trans_before_commit_kill_coord_node</b>(suite) -&gt; [];
<a name="804"/>  804: <b>sym_trans_before_commit_kill_coord_node</b>(Config) when is_list(Config) -&gt;
<a name="805"/>  805:     ?is_debug_compiled,
<a name="806"/>  806:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="807"/>  807:     [Coord, Part1, Part2] = Nodes,
<a name="808"/>  808:     Tab = sym_trans_before_commit_kill_coord,
<a name="809"/>  809:     Def = [{attributes, [key, value]}, {ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="sym_trans_before_commit_kill_coord_node-last_expr"/><a name="810"/>  810: <b>    kill_after_debug_point</b>(Coord, {Coord, {mnesia_tm, multi_commit_sym}},
<a name="811"/>  811: 			   do_sym_trans, [{Tab, Def}], Nodes).
<a name="812"/>  812: 
<a name="sym_trans_before_commit_kill_coord_pid-1"/><a name="813"/>  813: <b>sym_trans_before_commit_kill_coord_pid</b>(suite) -&gt; [];
<a name="814"/>  814: <b>sym_trans_before_commit_kill_coord_pid</b>(Config) when is_list(Config) -&gt;
<a name="815"/>  815:     ?is_debug_compiled,
<a name="816"/>  816:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="817"/>  817:     [Coord, Part1, Part2] = Nodes,
<a name="818"/>  818:     Tab = sym_trans_before_commit_kill_coord,
<a name="819"/>  819:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="sym_trans_before_commit_kill_coord_pid-last_expr"/><a name="820"/>  820: <b>    kill_after_debug_point</b>(coord_pid, {Coord, {mnesia_tm, multi_commit_sym}},
<a name="821"/>  821: 			   do_sym_trans, [{Tab, Def}], Nodes).
<a name="822"/>  822: 
<a name="sym_trans_before_commit_kill_part_after_ask-1"/><a name="823"/>  823: <b>sym_trans_before_commit_kill_part_after_ask</b>(suite) -&gt; [];
<a name="824"/>  824: <b>sym_trans_before_commit_kill_part_after_ask</b>(Config) when is_list(Config) -&gt;
<a name="825"/>  825:     ?is_debug_compiled,
<a name="826"/>  826:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="827"/>  827:     [Coord, Part1, Part2] = Nodes,
<a name="828"/>  828:     Tab = sym_trans_before_commit_kill_part_after_ask,
<a name="829"/>  829:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="sym_trans_before_commit_kill_part_after_ask-last_expr"/><a name="830"/>  830: <b>    kill_after_debug_point</b>(Part1, {Coord, {mnesia_tm, multi_commit_sym}},
<a name="831"/>  831: 			   do_sym_trans, [{Tab, Def}], Nodes).
<a name="832"/>  832: 
<a name="sym_trans_before_commit_kill_part_before_ask-1"/><a name="833"/>  833: <b>sym_trans_before_commit_kill_part_before_ask</b>(suite) -&gt; [];
<a name="834"/>  834: <b>sym_trans_before_commit_kill_part_before_ask</b>(Config) when is_list(Config) -&gt;
<a name="835"/>  835:     ?is_debug_compiled,
<a name="836"/>  836:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="837"/>  837:     [Coord, Part1, Part2] = Nodes,
<a name="838"/>  838:     Tab = sym_trans_before_commit_kill_part_before_ask,
<a name="839"/>  839:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="sym_trans_before_commit_kill_part_before_ask-last_expr"/><a name="840"/>  840: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, doit_ask_commit}},
<a name="841"/>  841: 			   do_sym_trans, [{Tab, Def}], Nodes).
<a name="842"/>  842: 
<a name="sym_trans_after_commit_kill_coord_node-1"/><a name="843"/>  843: <b>sym_trans_after_commit_kill_coord_node</b>(suite) -&gt; [];
<a name="844"/>  844: <b>sym_trans_after_commit_kill_coord_node</b>(Config) when is_list(Config) -&gt;
<a name="845"/>  845:     ?is_debug_compiled,
<a name="846"/>  846:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="847"/>  847:     [Coord, Part1, Part2] = Nodes,
<a name="848"/>  848:     Tab = sym_trans_after_commit_kill_coord,
<a name="849"/>  849:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="sym_trans_after_commit_kill_coord_node-last_expr"/><a name="850"/>  850: <b>    kill_after_debug_point</b>(Coord, {Coord, {mnesia_tm, multi_commit_sym, post}},
<a name="851"/>  851: 			  do_sym_trans, [{Tab, Def}], Nodes).
<a name="852"/>  852: 
<a name="sym_trans_after_commit_kill_coord_pid-1"/><a name="853"/>  853: <b>sym_trans_after_commit_kill_coord_pid</b>(suite) -&gt; [];
<a name="854"/>  854: <b>sym_trans_after_commit_kill_coord_pid</b>(Config) when is_list(Config) -&gt;
<a name="855"/>  855:     ?is_debug_compiled,
<a name="856"/>  856:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="857"/>  857:     [Coord, Part1, Part2] = Nodes,
<a name="858"/>  858:     Tab = sym_trans_after_commit_kill_coord,
<a name="859"/>  859:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="sym_trans_after_commit_kill_coord_pid-last_expr"/><a name="860"/>  860: <b>    kill_after_debug_point</b>(coord_pid, {Coord, {mnesia_tm, multi_commit_sym, post}},
<a name="861"/>  861: 			  do_sym_trans, [{Tab,Def}], Nodes).
<a name="862"/>  862: 
<a name="sym_trans_after_commit_kill_part_after_ask-1"/><a name="863"/>  863: <b>sym_trans_after_commit_kill_part_after_ask</b>(suite) -&gt; [];
<a name="864"/>  864: <b>sym_trans_after_commit_kill_part_after_ask</b>(Config) when is_list(Config) -&gt;
<a name="865"/>  865:     ?is_debug_compiled,
<a name="866"/>  866:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="867"/>  867:     [Coord, Part1, Part2] = Nodes,
<a name="868"/>  868:     Tab =  sym_trans_after_commit_kill_part_after_ask,
<a name="869"/>  869:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="sym_trans_after_commit_kill_part_after_ask-last_expr"/><a name="870"/>  870: <b>    kill_after_debug_point</b>(Part1, {Coord, {mnesia_tm, multi_commit_sym, post}},
<a name="871"/>  871: 			   do_sym_trans, [{Tab, Def}], Nodes).
<a name="872"/>  872: 
<a name="sym_trans_after_commit_kill_part_do_commit_pre-1"/><a name="873"/>  873: <b>sym_trans_after_commit_kill_part_do_commit_pre</b>(suite) -&gt; [];
<a name="874"/>  874: <b>sym_trans_after_commit_kill_part_do_commit_pre</b>(Config) when is_list(Config) -&gt;
<a name="875"/>  875:     ?is_debug_compiled,
<a name="876"/>  876:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="877"/>  877:     [Coord, Part1, Part2] = Nodes,
<a name="878"/>  878:     Tab = sym_trans_after_commit_kill_part_do_commit_pre,
<a name="879"/>  879:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="880"/>  880:     TransFun = do_sym_trans,
<a name="sym_trans_after_commit_kill_part_do_commit_pre-last_expr"/><a name="881"/>  881: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, do_commit, pre}},
<a name="882"/>  882: 			   TransFun, [{Tab, Def}], Nodes).
<a name="883"/>  883: 
<a name="sym_trans_after_commit_kill_part_do_commit_post-1"/><a name="884"/>  884: <b>sym_trans_after_commit_kill_part_do_commit_post</b>(suite) -&gt; [];
<a name="885"/>  885: <b>sym_trans_after_commit_kill_part_do_commit_post</b>(Config) when is_list(Config) -&gt;
<a name="886"/>  886:     ?is_debug_compiled,
<a name="887"/>  887:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="888"/>  888:     [Coord, Part1, Part2] = Nodes,
<a name="889"/>  889:     Tab = sym_trans_after_commit_kill_part_do_commit_post,
<a name="890"/>  890:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="891"/>  891:     TransFun = do_sym_trans,
<a name="sym_trans_after_commit_kill_part_do_commit_post-last_expr"/><a name="892"/>  892: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, do_commit, post}}, 
<a name="893"/>  893: 			   TransFun, [{Tab, Def}], Nodes).
<a name="894"/>  894: 
<a name="do_sym_trans-2"/><a name="895"/>  895: <b>do_sym_trans</b>([Tab], _Fahter) -&gt;
<a name="896"/>  896:     ?dl(&quot;Starting SYM_TRANS with active debug fun &quot;, []),
<a name="897"/>  897:     Trans = fun() -&gt; 
<a name="898"/>  898: 		    [{_,_,Val}] = mnesia:read({Tab, 1}),
<a name="899"/>  899: 		    mnesia:write({Tab, 1, Val+1})
<a name="900"/>  900: 	    end,
<a name="901"/>  901:     Res = mnesia:transaction(Trans),
<a name="902"/>  902:     case Res of
<a name="903"/>  903: 	{atomic, ok} -&gt; ok;
<a name="904"/>  904: 	{aborted, _Reason} -&gt; ok;
<a name="905"/>  905: 	Else -&gt; ?error(&quot;Wrong output from mensia:transaction(FUN):~n ~p~n&quot;,
<a name="906"/>  906: 		       [Else])
<a name="907"/>  907:     end,
<a name="908"/>  908:     ?dl(&quot;SYM_TRANSACTION done: ~p  (deactiv dbgfun) &quot;, [Res]),
<a name="do_sym_trans-last_expr"/><a name="909"/>  909:     ok.
<a name="910"/>  910: 
<a name="911"/>  911: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="912"/>  912: 
<a name="913"/>  913: 
<a name="sync_dirty_pre_kill_part-1"/><a name="914"/>  914: <b>sync_dirty_pre_kill_part</b>(suite) -&gt; [];
<a name="915"/>  915: <b>sync_dirty_pre_kill_part</b>(Config) when is_list(Config) -&gt;
<a name="916"/>  916:     ?is_debug_compiled,
<a name="917"/>  917:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="918"/>  918:     [Coord, Part1, Part2] = Nodes,
<a name="919"/>  919:     Tab = sync_dirty_pre,
<a name="920"/>  920:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="921"/>  921:     TransFun = do_sync_dirty,
<a name="sync_dirty_pre_kill_part-last_expr"/><a name="922"/>  922: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, sync_dirty, pre}}, 
<a name="923"/>  923: 			   TransFun, [{Tab, Def}], Nodes).
<a name="924"/>  924: 
<a name="sync_dirty_pre_kill_coord_node-1"/><a name="925"/>  925: <b>sync_dirty_pre_kill_coord_node</b>(suite) -&gt; [];
<a name="926"/>  926: <b>sync_dirty_pre_kill_coord_node</b>(Config) when is_list(Config) -&gt;
<a name="927"/>  927:     ?is_debug_compiled,
<a name="928"/>  928:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="929"/>  929:     [Coord, Part1, Part2] = Nodes,
<a name="930"/>  930:     Tab = sync_dirty_pre,
<a name="931"/>  931:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="932"/>  932:     TransFun = do_sync_dirty,
<a name="sync_dirty_pre_kill_coord_node-last_expr"/><a name="933"/>  933: <b>    kill_after_debug_point</b>(Coord, {Part1, {mnesia_tm, sync_dirty, pre}}, 
<a name="934"/>  934: 			   TransFun, [{Tab, Def}], Nodes).
<a name="935"/>  935: 
<a name="sync_dirty_pre_kill_coord_pid-1"/><a name="936"/>  936: <b>sync_dirty_pre_kill_coord_pid</b>(suite) -&gt; [];
<a name="937"/>  937: <b>sync_dirty_pre_kill_coord_pid</b>(Config) when is_list(Config) -&gt;
<a name="938"/>  938:     ?is_debug_compiled,
<a name="939"/>  939:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="940"/>  940:     [Coord, Part1, Part2] = Nodes,
<a name="941"/>  941:     Tab = sync_dirty_pre,
<a name="942"/>  942:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="943"/>  943:     TransFun = do_sync_dirty,
<a name="sync_dirty_pre_kill_coord_pid-last_expr"/><a name="944"/>  944: <b>    kill_after_debug_point</b>(coord_pid, {Part1, {mnesia_tm, sync_dirty, pre}}, 
<a name="945"/>  945: 			   TransFun, [{Tab, Def}], Nodes).
<a name="946"/>  946: 
<a name="sync_dirty_post_kill_part-1"/><a name="947"/>  947: <b>sync_dirty_post_kill_part</b>(suite) -&gt; [];
<a name="948"/>  948: <b>sync_dirty_post_kill_part</b>(Config) when is_list(Config) -&gt;
<a name="949"/>  949:     ?is_debug_compiled,
<a name="950"/>  950:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="951"/>  951:     [Coord, Part1, Part2] = Nodes,
<a name="952"/>  952:     Tab = sync_dirty_post,
<a name="953"/>  953:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="954"/>  954:     TransFun = do_sync_dirty,
<a name="sync_dirty_post_kill_part-last_expr"/><a name="955"/>  955: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, sync_dirty, post}}, 
<a name="956"/>  956: 			   TransFun, [{Tab, Def}], Nodes).
<a name="957"/>  957: 
<a name="sync_dirty_post_kill_coord_node-1"/><a name="958"/>  958: <b>sync_dirty_post_kill_coord_node</b>(suite) -&gt; [];
<a name="959"/>  959: <b>sync_dirty_post_kill_coord_node</b>(Config) when is_list(Config) -&gt;
<a name="960"/>  960:     ?is_debug_compiled,
<a name="961"/>  961:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="962"/>  962:     [Coord, Part1, Part2] = Nodes,
<a name="963"/>  963:     Tab = sync_dirty_post,
<a name="964"/>  964:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="965"/>  965:     TransFun = do_sync_dirty,
<a name="sync_dirty_post_kill_coord_node-last_expr"/><a name="966"/>  966: <b>    kill_after_debug_point</b>(Coord, {Part1, {mnesia_tm, sync_dirty, post}}, 
<a name="967"/>  967: 			   TransFun, [{Tab, Def}], Nodes).
<a name="968"/>  968: 
<a name="sync_dirty_post_kill_coord_pid-1"/><a name="969"/>  969: <b>sync_dirty_post_kill_coord_pid</b>(suite) -&gt; [];
<a name="970"/>  970: <b>sync_dirty_post_kill_coord_pid</b>(Config) when is_list(Config) -&gt;
<a name="971"/>  971:     ?is_debug_compiled,
<a name="972"/>  972:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="973"/>  973:     [Coord, Part1, Part2] = Nodes,
<a name="974"/>  974:     Tab = sync_dirty_post,
<a name="975"/>  975:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="976"/>  976:     TransFun = do_sync_dirty,
<a name="sync_dirty_post_kill_coord_pid-last_expr"/><a name="977"/>  977: <b>    kill_after_debug_point</b>(coord_pid, {Part1, {mnesia_tm, sync_dirty, post}}, 
<a name="978"/>  978: 			   TransFun, [{Tab, Def}], Nodes).
<a name="979"/>  979: 
<a name="do_sync_dirty-2"/><a name="980"/>  980: <b>do_sync_dirty</b>([Tab], _Father) -&gt;
<a name="981"/>  981:     ?dl(&quot;Starting SYNC_DIRTY&quot;, []),
<a name="982"/>  982:     SYNC = fun() -&gt; 
<a name="983"/>  983: 		   [{_,_,Val}] = mnesia:read({Tab, 1}),
<a name="984"/>  984: 		   mnesia:write({Tab, 1, Val+1})
<a name="985"/>  985: 	   end,
<a name="986"/>  986:     {_, Res} = ?match(ok, mnesia:sync_dirty(SYNC)),
<a name="987"/>  987:     ?dl(&quot;SYNC_DIRTY done: ~p &quot;, [Res]),
<a name="do_sync_dirty-last_expr"/><a name="988"/>  988:     ok.
<a name="989"/>  989: 
<a name="990"/>  990: 
<a name="async_dirty_pre_kill_part-1"/><a name="991"/>  991: <b>async_dirty_pre_kill_part</b>(suite) -&gt; [];
<a name="992"/>  992: <b>async_dirty_pre_kill_part</b>(Config) when is_list(Config) -&gt;
<a name="993"/>  993:     ?is_debug_compiled,
<a name="994"/>  994:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="995"/>  995:     [Coord, Part1, Part2] = Nodes,
<a name="996"/>  996:     Tab = async_dirty_pre,
<a name="997"/>  997:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="998"/>  998:     TransFun = do_async_dirty,
<a name="async_dirty_pre_kill_part-last_expr"/><a name="999"/>  999: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, async_dirty, pre}}, 
<a name="1000"/> 1000: 			   TransFun, [{Tab, Def}], Nodes).
<a name="1001"/> 1001: 
<a name="async_dirty_pre_kill_coord_node-1"/><a name="1002"/> 1002: <b>async_dirty_pre_kill_coord_node</b>(suite) -&gt; [];
<a name="1003"/> 1003: <b>async_dirty_pre_kill_coord_node</b>(Config) when is_list(Config) -&gt;
<a name="1004"/> 1004:     ?is_debug_compiled,
<a name="1005"/> 1005:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1006"/> 1006:     [Coord, Part1, Part2] = Nodes,
<a name="1007"/> 1007:     Tab = async_dirty_pre,
<a name="1008"/> 1008:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="1009"/> 1009:     TransFun = do_async_dirty,
<a name="async_dirty_pre_kill_coord_node-last_expr"/><a name="1010"/> 1010: <b>    kill_after_debug_point</b>(Coord, {Part1, {mnesia_tm, async_dirty, pre}}, 
<a name="1011"/> 1011: 			   TransFun, [{Tab, Def}], Nodes).
<a name="1012"/> 1012: 
<a name="async_dirty_pre_kill_coord_pid-1"/><a name="1013"/> 1013: <b>async_dirty_pre_kill_coord_pid</b>(suite) -&gt; [];
<a name="1014"/> 1014: <b>async_dirty_pre_kill_coord_pid</b>(Config) when is_list(Config) -&gt;
<a name="1015"/> 1015:     ?is_debug_compiled,
<a name="1016"/> 1016:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1017"/> 1017:     [Coord, Part1, Part2] = Nodes,
<a name="1018"/> 1018:     Tab = async_dirty_pre,
<a name="1019"/> 1019:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="1020"/> 1020:     TransFun = do_async_dirty,
<a name="async_dirty_pre_kill_coord_pid-last_expr"/><a name="1021"/> 1021: <b>    kill_after_debug_point</b>(coord_pid, {Part1, {mnesia_tm, async_dirty, pre}}, 
<a name="1022"/> 1022: 			   TransFun, [{Tab, Def}], Nodes).
<a name="1023"/> 1023: 
<a name="async_dirty_post_kill_part-1"/><a name="1024"/> 1024: <b>async_dirty_post_kill_part</b>(suite) -&gt; [];
<a name="1025"/> 1025: <b>async_dirty_post_kill_part</b>(Config) when is_list(Config) -&gt;
<a name="1026"/> 1026:     ?is_debug_compiled,
<a name="1027"/> 1027:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1028"/> 1028:     [Coord, Part1, Part2] = Nodes,
<a name="1029"/> 1029:     Tab = async_dirty_post,
<a name="1030"/> 1030:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="1031"/> 1031:     TransFun = do_async_dirty,
<a name="async_dirty_post_kill_part-last_expr"/><a name="1032"/> 1032: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, async_dirty, post}}, 
<a name="1033"/> 1033: 			   TransFun, [{Tab, Def}], Nodes).
<a name="1034"/> 1034: 
<a name="async_dirty_post_kill_coord_node-1"/><a name="1035"/> 1035: <b>async_dirty_post_kill_coord_node</b>(suite) -&gt; [];
<a name="1036"/> 1036: <b>async_dirty_post_kill_coord_node</b>(Config) when is_list(Config) -&gt;
<a name="1037"/> 1037:     ?is_debug_compiled,
<a name="1038"/> 1038:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1039"/> 1039:     [Coord, Part1, Part2] = Nodes,
<a name="1040"/> 1040:     Tab = async_dirty_post,
<a name="1041"/> 1041:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="1042"/> 1042:     TransFun = do_async_dirty,
<a name="async_dirty_post_kill_coord_node-last_expr"/><a name="1043"/> 1043: <b>    kill_after_debug_point</b>(Coord, {Part1, {mnesia_tm, async_dirty, post}}, 
<a name="1044"/> 1044: 			   TransFun, [{Tab, Def}], Nodes).
<a name="1045"/> 1045: 
<a name="async_dirty_post_kill_coord_pid-1"/><a name="1046"/> 1046: <b>async_dirty_post_kill_coord_pid</b>(suite) -&gt; [];
<a name="1047"/> 1047: <b>async_dirty_post_kill_coord_pid</b>(Config) when is_list(Config) -&gt;
<a name="1048"/> 1048:     ?is_debug_compiled,
<a name="1049"/> 1049:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1050"/> 1050:     [Coord, Part1, Part2] = Nodes,
<a name="1051"/> 1051:     Tab = async_dirty_post,
<a name="1052"/> 1052:     Def = [{attributes, [key, value]},{ram_copies, [Part2]},{disc_copies, [Coord, Part1]}],
<a name="1053"/> 1053:     TransFun = do_async_dirty,
<a name="async_dirty_post_kill_coord_pid-last_expr"/><a name="1054"/> 1054: <b>    kill_after_debug_point</b>(coord_pid, {Part1, {mnesia_tm, async_dirty, post}}, 
<a name="1055"/> 1055: 			   TransFun, [{Tab, Def}], Nodes).
<a name="1056"/> 1056: 
<a name="do_async_dirty-2"/><a name="1057"/> 1057: <b>do_async_dirty</b>([Tab], _Fahter) -&gt;
<a name="1058"/> 1058:     ?dl(&quot;Starting ASYNC&quot;, []),
<a name="1059"/> 1059:     ASYNC = fun() -&gt; 
<a name="1060"/> 1060: 		    [{_,_,Val}] = mnesia:read({Tab, 1}),
<a name="1061"/> 1061: 		    mnesia:write({Tab, 1, Val+1})
<a name="1062"/> 1062: 	    end,
<a name="1063"/> 1063:     {_, Res} = ?match(ok, mnesia:async_dirty(ASYNC)),
<a name="1064"/> 1064:     ?dl(&quot;ASYNC done: ~p &quot;, [Res]),
<a name="do_async_dirty-last_expr"/><a name="1065"/> 1065:     ok.
<a name="1066"/> 1066: 
<a name="1067"/> 1067: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1068"/> 1068: 
<a name="1069"/> 1069: 
<a name="asymtrans_part_ask-1"/><a name="1070"/> 1070: <b>asymtrans_part_ask</b>(suite) -&gt; [];
<a name="1071"/> 1071: <b>asymtrans_part_ask</b>(Config) when is_list(Config) -&gt; 
<a name="1072"/> 1072:     ?is_debug_compiled,
<a name="1073"/> 1073:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1074"/> 1074:     [Coord, Part1, Part2] = Nodes,
<a name="1075"/> 1075:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1076"/> 1076:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1077"/> 1077:     TransFun = do_asym_trans,
<a name="asymtrans_part_ask-last_expr"/><a name="1078"/> 1078: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, doit_ask_commit}}, 
<a name="1079"/> 1079: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1080"/> 1080: 
<a name="asymtrans_part_commit_vote-1"/><a name="1081"/> 1081: <b>asymtrans_part_commit_vote</b>(suite) -&gt; [];
<a name="1082"/> 1082: <b>asymtrans_part_commit_vote</b>(Config) when is_list(Config) -&gt; 
<a name="1083"/> 1083:     ?is_debug_compiled,
<a name="1084"/> 1084:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1085"/> 1085:     [Coord, Part1, Part2] = Nodes,
<a name="1086"/> 1086:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1087"/> 1087:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1088"/> 1088:     TransFun = do_asym_trans,
<a name="asymtrans_part_commit_vote-last_expr"/><a name="1089"/> 1089: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, commit_participant, vote_yes}}, 
<a name="1090"/> 1090: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1091"/> 1091: 
<a name="asymtrans_part_pre_commit-1"/><a name="1092"/> 1092: <b>asymtrans_part_pre_commit</b>(suite) -&gt; [];
<a name="1093"/> 1093: <b>asymtrans_part_pre_commit</b>(Config) when is_list(Config) -&gt; 
<a name="1094"/> 1094:     ?is_debug_compiled,
<a name="1095"/> 1095:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1096"/> 1096:     [Coord, Part1, Part2] = Nodes,
<a name="1097"/> 1097:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1098"/> 1098:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1099"/> 1099:     TransFun = do_asym_trans,
<a name="asymtrans_part_pre_commit-last_expr"/><a name="1100"/> 1100: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, commit_participant, pre_commit}}, 
<a name="1101"/> 1101: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1102"/> 1102: 
<a name="asymtrans_part_log_commit-1"/><a name="1103"/> 1103: <b>asymtrans_part_log_commit</b>(suite) -&gt; [];
<a name="1104"/> 1104: <b>asymtrans_part_log_commit</b>(Config) when is_list(Config) -&gt; 
<a name="1105"/> 1105:     ?is_debug_compiled,
<a name="1106"/> 1106:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1107"/> 1107:     [Coord, Part1, Part2] = Nodes,
<a name="1108"/> 1108:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1109"/> 1109:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1110"/> 1110:     TransFun = do_asym_trans,
<a name="asymtrans_part_log_commit-last_expr"/><a name="1111"/> 1111: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, commit_participant, log_commit}}, 
<a name="1112"/> 1112: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1113"/> 1113: 
<a name="asymtrans_part_do_commit-1"/><a name="1114"/> 1114: <b>asymtrans_part_do_commit</b>(suite) -&gt; [];
<a name="1115"/> 1115: <b>asymtrans_part_do_commit</b>(Config) when is_list(Config) -&gt; 
<a name="1116"/> 1116:     ?is_debug_compiled,
<a name="1117"/> 1117:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1118"/> 1118:     [Coord, Part1, Part2] = Nodes,
<a name="1119"/> 1119:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1120"/> 1120:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1121"/> 1121:     TransFun = do_asym_trans,
<a name="asymtrans_part_do_commit-last_expr"/><a name="1122"/> 1122: <b>    kill_after_debug_point</b>(Part1, {Part1, {mnesia_tm, commit_participant, do_commit}}, 
<a name="1123"/> 1123: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1124"/> 1124: 
<a name="asymtrans_coord_got_votes-1"/><a name="1125"/> 1125: <b>asymtrans_coord_got_votes</b>(suite) -&gt; [];
<a name="1126"/> 1126: <b>asymtrans_coord_got_votes</b>(Config) when is_list(Config) -&gt; 
<a name="1127"/> 1127:     ?is_debug_compiled,
<a name="1128"/> 1128:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1129"/> 1129:     [Coord, Part1, Part2] = Nodes,
<a name="1130"/> 1130:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1131"/> 1131:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1132"/> 1132:     TransFun = do_asym_trans,
<a name="asymtrans_coord_got_votes-last_expr"/><a name="1133"/> 1133: <b>    kill_after_debug_point</b>(Coord, {Coord, {mnesia_tm, multi_commit_asym_got_votes}}, 
<a name="1134"/> 1134: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1135"/> 1135: 
<a name="asymtrans_coord_pid_got_votes-1"/><a name="1136"/> 1136: <b>asymtrans_coord_pid_got_votes</b>(suite) -&gt; [];
<a name="1137"/> 1137: <b>asymtrans_coord_pid_got_votes</b>(Config) when is_list(Config) -&gt; 
<a name="1138"/> 1138:     ?is_debug_compiled,
<a name="1139"/> 1139:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1140"/> 1140:     [Coord, Part1, Part2] = Nodes,
<a name="1141"/> 1141:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1142"/> 1142:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1143"/> 1143:     TransFun = do_asym_trans,
<a name="asymtrans_coord_pid_got_votes-last_expr"/><a name="1144"/> 1144: <b>    kill_after_debug_point</b>(coord_pid, {Coord, {mnesia_tm, multi_commit_asym_got_votes}}, 
<a name="1145"/> 1145: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1146"/> 1146: 
<a name="asymtrans_coord_log_commit_rec-1"/><a name="1147"/> 1147: <b>asymtrans_coord_log_commit_rec</b>(suite) -&gt; [];
<a name="1148"/> 1148: <b>asymtrans_coord_log_commit_rec</b>(Config) when is_list(Config) -&gt; 
<a name="1149"/> 1149:     ?is_debug_compiled,
<a name="1150"/> 1150:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1151"/> 1151:     [Coord, Part1, Part2] = Nodes,
<a name="1152"/> 1152:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1153"/> 1153:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1154"/> 1154:     TransFun = do_asym_trans,
<a name="asymtrans_coord_log_commit_rec-last_expr"/><a name="1155"/> 1155: <b>    kill_after_debug_point</b>(Coord, {Coord, {mnesia_tm, multi_commit_asym_log_commit_rec}}, 
<a name="1156"/> 1156: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1157"/> 1157: 
<a name="asymtrans_coord_pid_log_commit_rec-1"/><a name="1158"/> 1158: <b>asymtrans_coord_pid_log_commit_rec</b>(suite) -&gt; [];
<a name="1159"/> 1159: <b>asymtrans_coord_pid_log_commit_rec</b>(Config) when is_list(Config) -&gt; 
<a name="1160"/> 1160:     ?is_debug_compiled,
<a name="1161"/> 1161:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1162"/> 1162:     [Coord, Part1, Part2] = Nodes,
<a name="1163"/> 1163:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1164"/> 1164:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1165"/> 1165:     TransFun = do_asym_trans,
<a name="asymtrans_coord_pid_log_commit_rec-last_expr"/><a name="1166"/> 1166: <b>    kill_after_debug_point</b>(coord_pid, {Coord, {mnesia_tm, multi_commit_asym_log_commit_rec}}, 
<a name="1167"/> 1167: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1168"/> 1168: 
<a name="asymtrans_coord_log_commit_dec-1"/><a name="1169"/> 1169: <b>asymtrans_coord_log_commit_dec</b>(suite) -&gt; [];
<a name="1170"/> 1170: <b>asymtrans_coord_log_commit_dec</b>(Config) when is_list(Config) -&gt; 
<a name="1171"/> 1171:     ?is_debug_compiled,
<a name="1172"/> 1172:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1173"/> 1173:     [Coord, Part1, Part2] = Nodes,
<a name="1174"/> 1174:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1175"/> 1175:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1176"/> 1176:     TransFun = do_asym_trans,
<a name="asymtrans_coord_log_commit_dec-last_expr"/><a name="1177"/> 1177: <b>    kill_after_debug_point</b>(Coord, {Coord, {mnesia_tm, multi_commit_asym_log_commit_dec}}, 
<a name="1178"/> 1178: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1179"/> 1179: 
<a name="asymtrans_coord_pid_log_commit_dec-1"/><a name="1180"/> 1180: <b>asymtrans_coord_pid_log_commit_dec</b>(suite) -&gt; [];
<a name="1181"/> 1181: <b>asymtrans_coord_pid_log_commit_dec</b>(Config) when is_list(Config) -&gt; 
<a name="1182"/> 1182:     ?is_debug_compiled,
<a name="1183"/> 1183:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1184"/> 1184:     [Coord, Part1, Part2] = Nodes,
<a name="1185"/> 1185:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1186"/> 1186:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1187"/> 1187:     TransFun = do_asym_trans,
<a name="asymtrans_coord_pid_log_commit_dec-last_expr"/><a name="1188"/> 1188: <b>    kill_after_debug_point</b>(coord_pid, {Coord, {mnesia_tm, multi_commit_asym_log_commit_dec}}, 
<a name="1189"/> 1189: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1190"/> 1190: 
<a name="asymtrans_coord_rec_acc_pre_commit_log_commit-1"/><a name="1191"/> 1191: <b>asymtrans_coord_rec_acc_pre_commit_log_commit</b>(suite) -&gt; [];
<a name="1192"/> 1192: <b>asymtrans_coord_rec_acc_pre_commit_log_commit</b>(Config) when is_list(Config) -&gt; 
<a name="1193"/> 1193:     ?is_debug_compiled,
<a name="1194"/> 1194:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1195"/> 1195:     [Coord, Part1, Part2] = Nodes,
<a name="1196"/> 1196:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1197"/> 1197:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1198"/> 1198:     TransFun = do_asym_trans,
<a name="asymtrans_coord_rec_acc_pre_commit_log_commit-last_expr"/><a name="1199"/> 1199: <b>    kill_after_debug_point</b>(Coord, {Coord, {mnesia_tm, rec_acc_pre_commit_log_commit}}, 
<a name="1200"/> 1200: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1201"/> 1201: 
<a name="asymtrans_coord_pid_rec_acc_pre_commit_log_commit-1"/><a name="1202"/> 1202: <b>asymtrans_coord_pid_rec_acc_pre_commit_log_commit</b>(suite) -&gt; [];
<a name="1203"/> 1203: <b>asymtrans_coord_pid_rec_acc_pre_commit_log_commit</b>(Config) when is_list(Config) -&gt; 
<a name="1204"/> 1204:     ?is_debug_compiled,
<a name="1205"/> 1205:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1206"/> 1206:     [Coord, Part1, Part2] = Nodes,
<a name="1207"/> 1207:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1208"/> 1208:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1209"/> 1209:     TransFun = do_asym_trans,
<a name="asymtrans_coord_pid_rec_acc_pre_commit_log_commit-last_expr"/><a name="1210"/> 1210: <b>    kill_after_debug_point</b>(coord_pid, {Coord, {mnesia_tm, rec_acc_pre_commit_log_commit}}, 
<a name="1211"/> 1211: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1212"/> 1212: 
<a name="asymtrans_coord_rec_acc_pre_commit_done_commit-1"/><a name="1213"/> 1213: <b>asymtrans_coord_rec_acc_pre_commit_done_commit</b>(suite) -&gt; [];
<a name="1214"/> 1214: <b>asymtrans_coord_rec_acc_pre_commit_done_commit</b>(Config) when is_list(Config) -&gt; 
<a name="1215"/> 1215:     ?is_debug_compiled,
<a name="1216"/> 1216:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1217"/> 1217:     [Coord, Part1, Part2] = Nodes,
<a name="1218"/> 1218:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1219"/> 1219:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1220"/> 1220:     TransFun = do_asym_trans,
<a name="asymtrans_coord_rec_acc_pre_commit_done_commit-last_expr"/><a name="1221"/> 1221: <b>    kill_after_debug_point</b>(Coord, {Coord, {mnesia_tm, rec_acc_pre_commit_done_commit}}, 
<a name="1222"/> 1222: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1223"/> 1223: 
<a name="asymtrans_coord_pid_rec_acc_pre_commit_done_commit-1"/><a name="1224"/> 1224: <b>asymtrans_coord_pid_rec_acc_pre_commit_done_commit</b>(suite) -&gt; [];
<a name="1225"/> 1225: <b>asymtrans_coord_pid_rec_acc_pre_commit_done_commit</b>(Config) when is_list(Config) -&gt; 
<a name="1226"/> 1226:     ?is_debug_compiled,
<a name="1227"/> 1227:     Nodes = ?acquire_nodes(3, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1228"/> 1228:     [Coord, Part1, Part2] = Nodes,
<a name="1229"/> 1229:     Tab1 = {asym1, [{ram_copies, [Part2]}, {disc_copies, [Coord]}]},
<a name="1230"/> 1230:     Tab2 = {asym2, [{ram_copies, [Coord]}, {disc_copies, [Part1]}]},
<a name="1231"/> 1231:     TransFun = do_asym_trans,
<a name="asymtrans_coord_pid_rec_acc_pre_commit_done_commit-last_expr"/><a name="1232"/> 1232: <b>    kill_after_debug_point</b>(coord_pid, {Coord, {mnesia_tm, rec_acc_pre_commit_done_commit}}, 
<a name="1233"/> 1233: 			   TransFun, [Tab1, Tab2], Nodes).
<a name="1234"/> 1234: 
<a name="do_asym_trans-2"/><a name="1235"/> 1235: <b>do_asym_trans</b>([Tab1, Tab2 | _R], Garbhandler) -&gt;
<a name="1236"/> 1236:     ?dl(&quot;Starting asym trans &quot;, []),
<a name="1237"/> 1237:     ASym_Trans = fun() -&gt;
<a name="1238"/> 1238: 			 TidTs = {_Mod, Tid, _Store} =
<a name="1239"/> 1239: 			     mnesia:get_activity_id(),
<a name="1240"/> 1240: 			 ?verbose(&quot;===&gt; asym_trans: ~w~n&quot;, [TidTs]),
<a name="1241"/> 1241: 			 Garbhandler ! {trans_id, Tid},
<a name="1242"/> 1242: 			 [{_, _, Val1}] = mnesia:read({Tab1, 1}),
<a name="1243"/> 1243: 			 [{_, _, Val2}] = mnesia:read({Tab2, 1}),
<a name="1244"/> 1244: 			 mnesia:write({Tab1, 1, Val1+1}),
<a name="1245"/> 1245: 			 mnesia:write({Tab2, 1, Val2+1})
<a name="1246"/> 1246: 		 end,
<a name="1247"/> 1247:     Res = mnesia:transaction(ASym_Trans),
<a name="1248"/> 1248:     case Res of
<a name="1249"/> 1249: 	{atomic, ok} -&gt; ok;
<a name="1250"/> 1250: 	{aborted, _Reason} -&gt; ok;
<a name="1251"/> 1251: 	_Else -&gt; ?error(&quot;Wrong output from mensia:transaction(FUN):~n ~p~n&quot;, [Res])
<a name="1252"/> 1252:     end,			
<a name="do_asym_trans-last_expr"/><a name="1253"/> 1253: <b>    ?dl</b>(&quot;Asym trans finished with: ~p &quot;, [Res]).
<a name="1254"/> 1254: 
<a name="1255"/> 1255: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1256"/> 1256: 
<a name="kill_after_debug_point-5"/><a name="1257"/> 1257: <b>kill_after_debug_point</b>(Kill, {DebugNode, Debug_Point}, TransFun, TabsAndDefs, Nodes) -&gt;
<a name="1258"/> 1258:     [Coord | _rest] = Nodes,
<a name="1259"/> 1259: 
<a name="1260"/> 1260:     Create = fun({Tab, Def}) -&gt; ?match({atomic, ok}, mnesia:create_table(Tab, Def)) end,
<a name="1261"/> 1261:     lists:foreach(Create, TabsAndDefs),
<a name="1262"/> 1262:     Tabs = [T || {T, _} &lt;- TabsAndDefs],
<a name="1263"/> 1263:     Write = fun(Tab) -&gt; ?match(ok, mnesia:dirty_write({Tab, 1, 100})) end,
<a name="1264"/> 1264:     lists:foreach(Write, Tabs),
<a name="1265"/> 1265: 
<a name="1266"/> 1266:     Self = self(),    
<a name="1267"/> 1267:     SyncFun = fun(_Env1, _Env2) -&gt;  % Just Sync with test prog
<a name="1268"/> 1268: 		      Self ! {self(), fun_in_position}, 
<a name="1269"/> 1269: 		      ?dl(&quot;SyncFun, sending fun_in_position &quot;, []),
<a name="1270"/> 1270: 		      receive continue -&gt; 
<a name="1271"/> 1271: 			      ?dl(&quot;SyncFun received continue &quot;,[]),
<a name="1272"/> 1272: 			      ok
<a name="1273"/> 1273: 		      after timer:seconds(60) -&gt; 
<a name="1274"/> 1274: 			      ?error(&quot;Timeout in sync_fun on ~p~n&quot;, [node()])
<a name="1275"/> 1275: 		      end
<a name="1276"/> 1276: 	      end,
<a name="1277"/> 1277: 
<a name="1278"/> 1278:     Garb_handler = spawn_link(?MODULE, garb_handler, [[]]),
<a name="1279"/> 1279: 
<a name="1280"/> 1280:     ?remote_activate_debug_fun(DebugNode, Debug_Point, SyncFun, []),
<a name="1281"/> 1281:     ?dl(&quot;fun_in_position activated at ~p with ~p&quot;, [DebugNode, Debug_Point]),
<a name="1282"/> 1282:     %% Spawn and do the transaction
<a name="1283"/> 1283:     Pid = spawn(Coord, ?MODULE, TransFun, [Tabs, Garb_handler]),
<a name="1284"/> 1284:     %% Wait till all the Nodes are in correct position
<a name="1285"/> 1285:     [{StoppedPid,_}] = ?receive_messages([fun_in_position]),
<a name="1286"/> 1286:     ?dl(&quot;Received fun_in_position; Removing the debug funs ~p&quot;, [DebugNode]),
<a name="1287"/> 1287:     ?remote_deactivate_debug_fun(DebugNode, Debug_Point),    
<a name="1288"/> 1288: 
<a name="1289"/> 1289:     case Kill of
<a name="1290"/> 1290: 	coord_pid -&gt; 
<a name="1291"/> 1291: 	    ?dl(&quot;Intentionally killing pid ~p &quot;, [Pid]),
<a name="1292"/> 1292: 	    exit(Pid, normal);
<a name="1293"/> 1293: 	Node -&gt; 		
<a name="1294"/> 1294: 	    mnesia_test_lib:kill_mnesia([Node])
<a name="1295"/> 1295:     end,
<a name="1296"/> 1296: 
<a name="1297"/> 1297:     StoppedPid ! continue,    %% Send continue, it may still be alive
<a name="1298"/> 1298: 
<a name="1299"/> 1299:     %% Start and check that the databases are consistent
<a name="1300"/> 1300:     ?dl(&quot;Done, Restarting and verifying result &quot;,[]),
<a name="1301"/> 1301:     case Kill of
<a name="1302"/> 1302: 	coord_pid -&gt; ok;
<a name="1303"/> 1303: 	_ -&gt;  % Ok, mnesia on some node was killed restart it
<a name="1304"/> 1304: 	    timer:sleep(timer:seconds(3)), %% Just let it have the time to die
<a name="1305"/> 1305: 	    ?match(ok, rpc:call(Kill, mnesia, start, [[]])),
<a name="1306"/> 1306: 	    ?match(ok, rpc:call(Kill, mnesia, wait_for_tables, [Tabs, 60000]))
<a name="1307"/> 1307:     end,
<a name="1308"/> 1308:     Trans_res = verify_tabs(Tabs, Nodes),
<a name="1309"/> 1309:     case TransFun of
<a name="1310"/> 1310: 	do_asym_trans -&gt;
<a name="1311"/> 1311: 	    %% Verifies that decisions are garbed, only valid for asym_tran
<a name="1312"/> 1312: 	    Garb_handler ! {get_tids, self()},
<a name="1313"/> 1313: 	    Tid_list = receive 
<a name="1314"/> 1314: 			   {tids, List} -&gt; 
<a name="1315"/> 1315: 			       ?dl(&quot;Fun rec ~w&quot;, [List]),
<a name="1316"/> 1316: 			       List
<a name="1317"/> 1317: 		       end,
<a name="1318"/> 1318: 	    garb_of_decisions(Kill, Nodes, Tid_list, Trans_res);
<a name="1319"/> 1319: 	_ -&gt;
<a name="1320"/> 1320: 	    ignore
<a name="1321"/> 1321:     end,
<a name="kill_after_debug_point-last_expr"/><a name="1322"/> 1322: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="1323"/> 1323: 
<a name="garb_of_decisions-4"/><a name="1324"/> 1324: <b>garb_of_decisions</b>(Kill, Nodes, Tid_list, Trans_res) -&gt;
<a name="1325"/> 1325:     [Coord, Part1, Part2]  = Nodes,
<a name="1326"/> 1326:     %% Check that decision log is empty on all nodes after the trans is finished
<a name="1327"/> 1327:     verify_garb_decision_log(Nodes, Tid_list),  
<a name="garb_of_decisions-last_expr"/><a name="1328"/> 1328:     case Trans_res of
<a name="1329"/> 1329: 	aborted -&gt;
<a name="1330"/> 1330: 	    %% Check that aborted trans have not been restarted!!
<a name="1331"/> 1331: 	    ?match(1, length(Tid_list)),
<a name="1332"/> 1332: 	    %% Check the transient decision logs
<a name="1333"/> 1333: 	    %% A transaction should only be aborted in an early stage of 
<a name="1334"/> 1334: 	    %% the trans before the any Node have logged anything
<a name="1335"/> 1335: 	    verify_garb_transient_logs(Nodes, Tid_list, aborted),
<a name="1336"/> 1336: 	    %% And only when the coordinator are have died
<a name="1337"/> 1337: 	    %% Else he would have restarted the transaction
<a name="1338"/> 1338: 	    ?match(Kill, Coord);
<a name="1339"/> 1339: 	updated -&gt;
<a name="1340"/> 1340: 	    case length(Tid_list) of
<a name="1341"/> 1341: 		1 -&gt; 
<a name="1342"/> 1342: 		    %% If there was only one transaction, it should be logged as
<a name="1343"/> 1343: 		    %% committed on every node!
<a name="1344"/> 1344: 		    [Tid1] = Tid_list,
<a name="1345"/> 1345: 		    verify_garb_transient_logs(Nodes, [Tid1], committed);
<a name="1346"/> 1346: 		2 -&gt; 
<a name="1347"/> 1347: 		    %% If there is two transaction id, then the first
<a name="1348"/> 1348: 		    %% TID should have been aborted and the transaction
<a name="1349"/> 1349: 		    %% restarted with a new TID
<a name="1350"/> 1350: 		    [Tid1, Tid2] = Tid_list,
<a name="1351"/> 1351: 		    verify_garb_transient_logs(Nodes, [Tid1], aborted),
<a name="1352"/> 1352: 		    %% If mnesia is killed on a node i.e Coord and Part1 than they
<a name="1353"/> 1353: 		    %% won't know about the restarted trans! The rest of the nodes
<a name="1354"/> 1354: 		    %% should know that the trans was committed
<a name="1355"/> 1355: 		    case Kill of 
<a name="1356"/> 1356: 			coord_pid -&gt; 
<a name="1357"/> 1357: 			    verify_garb_transient_logs(Nodes, [Tid2], committed);
<a name="1358"/> 1358: 			Coord -&gt; 
<a name="1359"/> 1359: 			    verify_garb_transient_logs([Part1, Part2], [Tid2], committed),
<a name="1360"/> 1360: 			    verify_garb_transient_logs([Coord], [Tid2], not_found);
<a name="1361"/> 1361: 			Part1 -&gt;
<a name="1362"/> 1362: 			    verify_garb_transient_logs([Coord, Part2], [Tid2], committed),
<a name="1363"/> 1363: 			    verify_garb_transient_logs([Part1], [Tid2], not_found)
<a name="1364"/> 1364: 		    end
<a name="1365"/> 1365: 	    end
<a name="1366"/> 1366:     end.
<a name="1367"/> 1367: 
<a name="verify_garb_decision_log-2"/><a name="1368"/> 1368: <b>verify_garb_decision_log</b>([], _Tids) -&gt; ok;
<a name="1369"/> 1369: <b>verify_garb_decision_log</b>([Node|R], Tids) -&gt; 
<a name="1370"/> 1370:     Check = fun(Tid) -&gt;   %% Node, Tid used in debugging!
<a name="1371"/> 1371: 		    ?match({{not_found, _}, Node, Tid}, 
<a name="1372"/> 1372: 			   {outcome(Tid, [mnesia_decision]), Node, Tid})
<a name="1373"/> 1373: 	    end,
<a name="1374"/> 1374:     rpc:call(Node, lists, foreach, [Check, Tids]),
<a name="verify_garb_decision_log-last_expr"/><a name="1375"/> 1375: <b>    verify_garb_decision_log</b>(R, Tids).
<a name="1376"/> 1376: 
<a name="verify_garb_transient_logs-3"/><a name="1377"/> 1377: <b>verify_garb_transient_logs</b>([], _Tids, _) -&gt; ok;
<a name="1378"/> 1378: <b>verify_garb_transient_logs</b>([Node|R], Tids, Exp_Res) -&gt; 
<a name="1379"/> 1379:     Check = fun(Tid) -&gt; 
<a name="1380"/> 1380: 		    LatestTab = mnesia_lib:val(latest_transient_decision),
<a name="1381"/> 1381: 		    PrevTabs = mnesia_lib:val(previous_transient_decisions),
<a name="1382"/> 1382: 		    case outcome(Tid, [LatestTab | PrevTabs]) of
<a name="1383"/> 1383: 			{found, {_, [{_,_Tid, Exp_Res}]}} -&gt; ok;
<a name="1384"/> 1384: 			{not_found, _} when Exp_Res == not_found -&gt; ok;
<a name="1385"/> 1385: 			{not_found, _} when Exp_Res == aborted -&gt; ok;
<a name="1386"/> 1386: 			Else  -&gt; ?error(&quot;Expected ~p in trans ~p on ~p got ~p~n&quot;,
<a name="1387"/> 1387: 					[Exp_Res, Tid, Node, Else])
<a name="1388"/> 1388: 		    end
<a name="1389"/> 1389: 	    end,    
<a name="1390"/> 1390:     rpc:call(Node, lists, foreach, [Check, Tids]),
<a name="verify_garb_transient_logs-last_expr"/><a name="1391"/> 1391: <b>    verify_garb_transient_logs</b>(R, Tids, Exp_Res). 
<a name="1392"/> 1392:     
<a name="outcome-2"/><a name="1393"/> 1393: <b>outcome</b>(Tid, Tabs) -&gt;
<a name="outcome-last_expr"/><a name="1394"/> 1394: <b>    outcome</b>(Tid, Tabs, Tabs).
<a name="1395"/> 1395: 
<a name="outcome-3"/><a name="1396"/> 1396: <b>outcome</b>(Tid, [Tab | Tabs], AllTabs) -&gt;
<a name="1397"/> 1397:     case catch ets:lookup(Tab, Tid) of
<a name="1398"/> 1398: 	{'EXIT', _} -&gt;
<a name="1399"/> 1399: 	    outcome(Tid, Tabs, AllTabs);
<a name="1400"/> 1400: 	[] -&gt;
<a name="1401"/> 1401: 	    outcome(Tid, Tabs, AllTabs);
<a name="1402"/> 1402: 	Val -&gt;
<a name="1403"/> 1403: 	    {found, {Tab, Val}}
<a name="1404"/> 1404:     end;
<a name="1405"/> 1405: <b>outcome</b>(_Tid, [], AllTabs) -&gt;
<a name="outcome-last_expr"/><a name="1406"/> 1406:     {not_found, AllTabs}.
<a name="1407"/> 1407: 
<a name="1408"/> 1408: 
<a name="verify_tabs-2"/><a name="1409"/> 1409: <b>verify_tabs</b>([Tab|R], Nodes) -&gt; 
<a name="1410"/> 1410:     [_Coord, Part1, Part2 | _rest] = Nodes, 
<a name="1411"/> 1411:     Read = fun() -&gt; mnesia:read({Tab, 1}) end,
<a name="1412"/> 1412:     {success, A} = ?match({atomic, _}, mnesia:transaction(Read)),
<a name="1413"/> 1413:     ?match(A, rpc:call(Part1, mnesia, transaction, [Read])),
<a name="1414"/> 1414:     ?match(A, rpc:call(Part2, mnesia, transaction, [Read])),
<a name="1415"/> 1415:     {atomic, [{Tab, 1, Res}]} = A,
<a name="verify_tabs-last_expr"/><a name="1416"/> 1416: <b>    verify_tabs</b>(R, Nodes, Res).
<a name="1417"/> 1417: 
<a name="verify_tabs-3"/><a name="1418"/> 1418: <b>verify_tabs</b>([], _Nodes, Res) -&gt; 
<a name="1419"/> 1419:     case Res of 
<a name="1420"/> 1420: 	100 -&gt; aborted;
<a name="1421"/> 1421: 	101 -&gt; updated
<a name="1422"/> 1422:     end;
<a name="1423"/> 1423: 
<a name="1424"/> 1424: <b>verify_tabs</b>([Tab | Rest], Nodes, Res) -&gt;
<a name="1425"/> 1425:     [Coord, Part1, Part2 | _rest] = Nodes, 
<a name="1426"/> 1426:     Read = fun() -&gt; mnesia:read({Tab, 1}) end,
<a name="1427"/> 1427:     Exp = {atomic, [{Tab, 1, Res}]},
<a name="1428"/> 1428:     ?match(Exp, rpc:call(Coord, mnesia, transaction, [Read])),
<a name="1429"/> 1429:     ?match(Exp, rpc:call(Part1, mnesia, transaction, [Read])),
<a name="1430"/> 1430:     ?match(Exp, rpc:call(Part2, mnesia, transaction, [Read])),
<a name="verify_tabs-last_expr"/><a name="1431"/> 1431: <b>    verify_tabs</b>(Rest, Nodes, Res).
<a name="1432"/> 1432: 
<a name="1433"/> 1433: <i>%% Gather TIDS and send them to requesting process and exit!</i>
<a name="garb_handler-1"/><a name="1434"/> 1434: <b>garb_handler</b>(List) -&gt; 
<a name="garb_handler-last_expr"/><a name="1435"/> 1435:     receive 
<a name="1436"/> 1436: 	{trans_id, ID} -&gt; garb_handler([ID|List]);
<a name="1437"/> 1437: 	{get_tids, Pid} -&gt; Pid ! {tids, lists:reverse(List)}
<a name="1438"/> 1438:     end.
<a name="1439"/> 1439: 
<a name="1440"/> 1440: <i>%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="receive_messages-3"/><a name="1441"/> 1441: <b>receive_messages</b>([], _File, _Line) -&gt; [];
<a name="1442"/> 1442: <b>receive_messages</b>(ListOfMsgs, File, Line) -&gt;
<a name="receive_messages-last_expr"/><a name="1443"/> 1443:     receive 
<a name="1444"/> 1444: 	{Pid, Msg} -&gt;     
<a name="1445"/> 1445: 	    case lists:member(Msg, ListOfMsgs) of
<a name="1446"/> 1446: 		false -&gt; 
<a name="1447"/> 1447: 		    mnesia_test_lib:log(&quot;&lt;&gt;WARNING&lt;&gt;~n&quot;
<a name="1448"/> 1448: 					&quot;Received unexpected msg~n ~p ~n&quot;
<a name="1449"/> 1449: 					&quot;While waiting for ~p~n&quot;,  
<a name="1450"/> 1450: 					[{Pid, Msg}, ListOfMsgs], File, Line),
<a name="1451"/> 1451: 		    receive_messages(ListOfMsgs, File, Line);
<a name="1452"/> 1452: 		true -&gt; 
<a name="1453"/> 1453: 		    ?dl(&quot;Got msg ~p from ~p &quot;, [Msg, node(Pid)]),
<a name="1454"/> 1454: 		    [{Pid, Msg} | receive_messages(ListOfMsgs -- [Msg], File, Line)]
<a name="1455"/> 1455: 	    end;
<a name="1456"/> 1456: 	Else -&gt; mnesia_test_lib:log(&quot;&lt;&gt;WARNING&lt;&gt;~n&quot;
<a name="1457"/> 1457: 				    &quot;Received unexpected or bad formatted msg~n ~p ~n&quot;
<a name="1458"/> 1458: 				    &quot;While waiting for ~p~n&quot;, 
<a name="1459"/> 1459: 	 			    [Else, ListOfMsgs], File, Line),
<a name="1460"/> 1460: 		receive_messages(ListOfMsgs, File, Line)
<a name="1461"/> 1461:     after timer:minutes(2) -&gt; 
<a name="1462"/> 1462: 	    ?error(&quot;Timeout in receive msgs while waiting for ~p~n&quot;, 
<a name="1463"/> 1463: 		   [ListOfMsgs])
<a name="1464"/> 1464:     end.    
<a name="1465"/> 1465: 
<a name="1466"/> 1466: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1467"/> 1467: 
<a name="after_full_disc_partition-1"/><a name="1468"/> 1468: <b>after_full_disc_partition</b>(doc) -&gt;
<a name="after_full_disc_partition-last_expr"/><a name="1469"/> 1469:     [&quot;Verify that the database does not get corrupt&quot;,
<a name="1470"/> 1470:      &quot;when Mnesia encounters a full disc partition&quot;].
<a name="1471"/> 1471: 
<a name="1472"/> 1472: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1473"/> 1473: <i>%% interrupted_fallback_start </i>
<a name="1474"/> 1474: <i>%% is implemented in consistency interupted_install_fallback!</i>
<a name="1475"/> 1475: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1476"/> 1476: 
<a name="after_corrupt_files_decision_log_head-1"/><a name="1477"/> 1477: <b>after_corrupt_files_decision_log_head</b>(suite) -&gt; [];
<a name="1478"/> 1478: <b>after_corrupt_files_decision_log_head</b>(Config) when is_list(Config) -&gt;
<a name="after_corrupt_files_decision_log_head-last_expr"/><a name="1479"/> 1479: <b>    after_corrupt_files</b>(Config, &quot;DECISION.LOG&quot;, head, repair).
<a name="1480"/> 1480: 
<a name="after_corrupt_files_decision_log_tail-1"/><a name="1481"/> 1481: <b>after_corrupt_files_decision_log_tail</b>(suite) -&gt; [];
<a name="1482"/> 1482: <b>after_corrupt_files_decision_log_tail</b>(Config) when is_list(Config) -&gt;
<a name="after_corrupt_files_decision_log_tail-last_expr"/><a name="1483"/> 1483: <b>    after_corrupt_files</b>(Config, &quot;DECISION.LOG&quot;, tail, repair).
<a name="1484"/> 1484: 
<a name="after_corrupt_files_latest_log_head-1"/><a name="1485"/> 1485: <b>after_corrupt_files_latest_log_head</b>(suite) -&gt; [];
<a name="1486"/> 1486: <b>after_corrupt_files_latest_log_head</b>(Config) when is_list(Config) -&gt;
<a name="after_corrupt_files_latest_log_head-last_expr"/><a name="1487"/> 1487: <b>    after_corrupt_files</b>(Config, &quot;LATEST.LOG&quot;, head, repair).
<a name="1488"/> 1488: 
<a name="after_corrupt_files_latest_log_tail-1"/><a name="1489"/> 1489: <b>after_corrupt_files_latest_log_tail</b>(suite) -&gt; [];
<a name="1490"/> 1490: <b>after_corrupt_files_latest_log_tail</b>(Config) when is_list(Config) -&gt;
<a name="after_corrupt_files_latest_log_tail-last_expr"/><a name="1491"/> 1491: <b>    after_corrupt_files</b>(Config, &quot;LATEST.LOG&quot;, tail, repair).
<a name="1492"/> 1492: 
<a name="after_corrupt_files_table_dat_head-1"/><a name="1493"/> 1493: <b>after_corrupt_files_table_dat_head</b>(suite) -&gt; [];
<a name="1494"/> 1494: <b>after_corrupt_files_table_dat_head</b>(Config) when is_list(Config) -&gt;
<a name="after_corrupt_files_table_dat_head-last_expr"/><a name="1495"/> 1495: <b>    after_corrupt_files</b>(Config, &quot;rec_files.DAT&quot;, head, crash).
<a name="1496"/> 1496: 
<a name="after_corrupt_files_table_dat_tail-1"/><a name="1497"/> 1497: <b>after_corrupt_files_table_dat_tail</b>(suite) -&gt; [];
<a name="1498"/> 1498: <b>after_corrupt_files_table_dat_tail</b>(Config) when is_list(Config) -&gt;
<a name="after_corrupt_files_table_dat_tail-last_expr"/><a name="1499"/> 1499: <b>    after_corrupt_files</b>(Config, &quot;rec_files.DAT&quot;, tail, repair).
<a name="1500"/> 1500: 
<a name="after_corrupt_files_schema_dat_head-1"/><a name="1501"/> 1501: <b>after_corrupt_files_schema_dat_head</b>(suite) -&gt; [];
<a name="1502"/> 1502: <b>after_corrupt_files_schema_dat_head</b>(Config) when is_list(Config) -&gt;
<a name="after_corrupt_files_schema_dat_head-last_expr"/><a name="1503"/> 1503: <b>    after_corrupt_files</b>(Config, &quot;schema.DAT&quot;, head, crash).
<a name="1504"/> 1504: 
<a name="after_corrupt_files_schema_dat_tail-1"/><a name="1505"/> 1505: <b>after_corrupt_files_schema_dat_tail</b>(suite) -&gt; [];
<a name="1506"/> 1506: <b>after_corrupt_files_schema_dat_tail</b>(Config) when is_list(Config) -&gt;
<a name="after_corrupt_files_schema_dat_tail-last_expr"/><a name="1507"/> 1507: <b>    after_corrupt_files</b>(Config, &quot;schema.DAT&quot;, tail, crash).
<a name="1508"/> 1508: 
<a name="1509"/> 1509: 
<a name="1510"/> 1510: 
<a name="1511"/> 1511: <i>%%% BUGBUG: We should also write testcase's for autorepair=false i.e. </i>
<a name="1512"/> 1512: <i>%%% not the standard case!</i>
<a name="after_corrupt_files-4"/><a name="1513"/> 1513: <b>after_corrupt_files</b>(Config, File, Where, Behaviour) -&gt;
<a name="1514"/> 1514:     [Node] = ?acquire_nodes(1, Config ++ [{tc_timeout, timer:minutes(2)}]),
<a name="1515"/> 1515:     Tab = rec_files,
<a name="1516"/> 1516:     Def = [{disc_only_copies, [Node]}],
<a name="1517"/> 1517:     ?match({atomic, ok}, mnesia:create_table(Tab, Def)),
<a name="1518"/> 1518:     insert_data(Tab, 100),
<a name="1519"/> 1519:     Dir = mnesia:system_info(directory),
<a name="1520"/> 1520:     mnesia_test_lib:kill_mnesia([Node]),
<a name="1521"/> 1521:     timer:sleep(timer:seconds(10)),   % Let dets finish whatever it does
<a name="1522"/> 1522: 
<a name="1523"/> 1523:     DirFile = Dir ++ &quot;/&quot; ++ File,
<a name="1524"/> 1524: 
<a name="1525"/> 1525:     {ok, Fd} = file:open(DirFile, read_write),
<a name="1526"/> 1526:     {ok, FileInfo} = file:read_file_info(DirFile),
<a name="1527"/> 1527:     case Where of
<a name="1528"/> 1528: 	head -&gt; 
<a name="1529"/> 1529: 	    ?match({ok, _NewP}, file:position(Fd, {bof, 1})),
<a name="1530"/> 1530: 	    ?match(ok, file:write(Fd, [255, 255, 255, 255, 255, 255, 255, 255, 254])),
<a name="1531"/> 1531: 	    ok;
<a name="1532"/> 1532: 	tail -&gt;
<a name="1533"/> 1533: 	    Size = FileInfo#file_info.size,
<a name="1534"/> 1534: 	    Half = Size div 2,
<a name="1535"/> 1535: 
<a name="1536"/> 1536: 	    ?dl(&quot; Size = ~p Half = ~p &quot;, [Size, Half]),
<a name="1537"/> 1537: 	    ?match({ok, _NewP}, file:position(Fd, {bof, Half})),
<a name="1538"/> 1538: 	    ?match(ok, file:truncate(Fd)),
<a name="1539"/> 1539: 	    ok
<a name="1540"/> 1540:     end,
<a name="1541"/> 1541:     ?match(ok, file:close(Fd)),
<a name="1542"/> 1542: 
<a name="1543"/> 1543:     ?warning(&quot;++++++SOME OF THE after_corrupt* TEST CASES WILL INTENTIONALLY CRASH MNESIA+++++++~n&quot;, []),
<a name="1544"/> 1544:     Pid = spawn_link(?MODULE, mymnesia_start, [self()]),
<a name="after_corrupt_files-last_expr"/><a name="1545"/> 1545:     receive
<a name="1546"/> 1546: 	{Pid, ok} -&gt; 
<a name="1547"/> 1547: 	    ?match(ok, mnesia:wait_for_tables([schema, Tab], 10000)),
<a name="1548"/> 1548: 	    ?match(ok, verify_data(Tab, 100)),
<a name="1549"/> 1549: 	    case mnesia_monitor:get_env(auto_repair) of
<a name="1550"/> 1550: 		false -&gt;
<a name="1551"/> 1551: 		    ?error(&quot;Mnesia should have crashed in ~p ~p ~n&quot;,
<a name="1552"/> 1552: 			   [File, Where]);
<a name="1553"/> 1553: 		true -&gt;
<a name="1554"/> 1554: 		    ok
<a name="1555"/> 1555: 	    end,
<a name="1556"/> 1556: 	    ?verify_mnesia([Node], []);
<a name="1557"/> 1557: 	{Pid, {error, ED}} -&gt;
<a name="1558"/> 1558: 	    case {mnesia_monitor:get_env(auto_repair), Behaviour} of
<a name="1559"/> 1559: 		{true, repair} -&gt;
<a name="1560"/> 1560: 		    ?error(&quot;Mnesia crashed with ~p: in ~p ~p ~n&quot;,
<a name="1561"/> 1561: 			   [ED, File, Where]);
<a name="1562"/> 1562: 		_ -&gt;  %% Every other can crash!
<a name="1563"/> 1563: 		    ok
<a name="1564"/> 1564: 	    end,
<a name="1565"/> 1565: 	    ?verify_mnesia([], [Node]);
<a name="1566"/> 1566: 	Msg -&gt;
<a name="1567"/> 1567: 	    ?error(&quot;~p ~p: Got ~p during start of Mnesia~n&quot;,
<a name="1568"/> 1568: 		   [File, Where, Msg])
<a name="1569"/> 1569:     end.
<a name="1570"/> 1570: 
<a name="mymnesia_start-1"/><a name="1571"/> 1571: <b>mymnesia_start</b>(Tester) -&gt;
<a name="1572"/> 1572:     Res = mnesia:start(),
<a name="1573"/> 1573:     unlink(Tester),
<a name="mymnesia_start-last_expr"/><a name="1574"/> 1574: <b>    Tester ! {self</b>(), Res}.
<a name="1575"/> 1575: 
<a name="verify_data-2"/><a name="1576"/> 1576: <b>verify_data</b>(_, 0) -&gt; ok;
<a name="1577"/> 1577: <b>verify_data</b>(Tab, N) -&gt; 
<a name="1578"/> 1578:     Actual = mnesia:dirty_read({Tab, N}),
<a name="1579"/> 1579:     Expected = [{Tab, N, N}],
<a name="verify_data-last_expr"/><a name="1580"/> 1580:     if
<a name="1581"/> 1581: 	Expected == Actual -&gt;
<a name="1582"/> 1582: 	    verify_data(Tab, N - 1);
<a name="1583"/> 1583: 	true  -&gt;
<a name="1584"/> 1584: 	    mnesia:schema(Tab),
<a name="1585"/> 1585: 	    {not_equal, node(), Expected, Actual}
<a name="1586"/> 1586:     end.
<a name="1587"/> 1587: 
<a name="insert_data-2"/><a name="1588"/> 1588: <b>insert_data</b>(_Tab, 0) -&gt; ok;
<a name="1589"/> 1589: <b>insert_data</b>(Tab, N) -&gt;
<a name="1590"/> 1590:     ok = mnesia:sync_dirty(fun() -&gt; mnesia:write({Tab, N, N}) end),
<a name="insert_data-last_expr"/><a name="1591"/> 1591: <b>    insert_data</b>(Tab, N-1).
<a name="1592"/> 1592: 
<a name="1593"/> 1593: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1594"/> 1594: 
<a name="disc_less-1"/><a name="1595"/> 1595: <b>disc_less</b>(doc) -&gt; 
<a name="1596"/> 1596:     [&quot;Here is a simple test case of a simple recovery of a disc less node. &quot;
<a name="1597"/> 1597:      &quot;However a lot more test cases involving disc less nodes should &quot;
<a name="1598"/> 1598:      &quot;be written&quot;];
<a name="1599"/> 1599: <b>disc_less</b>(suite) -&gt; [];
<a name="1600"/> 1600: <b>disc_less</b>(Config) when is_list(Config) -&gt;
<a name="1601"/> 1601:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="1602"/> 1602:     case mnesia_test_lib:diskless(Config) of
<a name="1603"/> 1603: 	true -&gt; skip;
<a name="1604"/> 1604: 	false -&gt;    
<a name="1605"/> 1605: 	    ?match({atomic, ok}, mnesia:change_table_copy_type(schema, Node3, ram_copies))
<a name="1606"/> 1606:     end,
<a name="1607"/> 1607:     Tab1 = disc_less1,
<a name="1608"/> 1608:     Tab2 = disc_less2,
<a name="1609"/> 1609:     Tab3 = disc_less3,
<a name="1610"/> 1610:     Def1 = [{ram_copies, [Node3]}, {disc_copies, [Node1, Node2]}],
<a name="1611"/> 1611:     Def2 = [{ram_copies, [Node3]}, {disc_copies, [Node1]}],
<a name="1612"/> 1612:     Def3 = [{ram_copies, [Node3]}, {disc_copies, [Node2]}],
<a name="1613"/> 1613:     ?match({atomic, ok}, mnesia:create_table(Tab1, Def1)),
<a name="1614"/> 1614:     ?match({atomic, ok}, mnesia:create_table(Tab2, Def2)),
<a name="1615"/> 1615:     ?match({atomic, ok}, mnesia:create_table(Tab3, Def3)),   
<a name="1616"/> 1616:     insert_data(Tab1, 100),
<a name="1617"/> 1617:     insert_data(Tab2, 100),
<a name="1618"/> 1618:     insert_data(Tab3, 100),
<a name="1619"/> 1619: 
<a name="1620"/> 1620:     mnesia_test_lib:kill_mnesia([Node1, Node2]),
<a name="1621"/> 1621:     timer:sleep(500),
<a name="1622"/> 1622:     mnesia_test_lib:kill_mnesia([Node3]),
<a name="1623"/> 1623:     ?match(ok, rpc:call(Node1, mnesia, start, [])),
<a name="1624"/> 1624:     ?match(ok, rpc:call(Node2, mnesia, start, [])),
<a name="1625"/> 1625: 
<a name="1626"/> 1626:     timer:sleep(500),
<a name="1627"/> 1627:     ?match(ok, rpc:call(Node3, mnesia, start, [[{extra_db_nodes, [Node1, Node2]}, {schema, ?BACKEND}]])),
<a name="1628"/> 1628:     ?match(ok, rpc:call(Node3, mnesia, wait_for_tables, [[Tab1, Tab2, Tab3], 20000])),
<a name="1629"/> 1629:     ?match(ok, rpc:call(Node1, mnesia, wait_for_tables, [[Tab1, Tab2, Tab3], 20000])),
<a name="1630"/> 1630: 
<a name="1631"/> 1631:     ?match(ok, rpc:call(Node3, ?MODULE, verify_data, [Tab1, 100])),
<a name="1632"/> 1632:     ?match(ok, rpc:call(Node3, ?MODULE, verify_data, [Tab2, 100])),
<a name="1633"/> 1633:     ?match(ok, rpc:call(Node3, ?MODULE, verify_data, [Tab3, 100])),
<a name="1634"/> 1634: 
<a name="1635"/> 1635: 
<a name="1636"/> 1636:     ?match(ok, rpc:call(Node2, ?MODULE, verify_data, [Tab1, 100])),
<a name="1637"/> 1637:     ?match(ok, rpc:call(Node2, ?MODULE, verify_data, [Tab2, 100])),
<a name="1638"/> 1638:     ?match(ok, rpc:call(Node2, ?MODULE, verify_data, [Tab3, 100])),
<a name="1639"/> 1639: 
<a name="1640"/> 1640:     ?match(ok, rpc:call(Node1, ?MODULE, verify_data, [Tab1, 100])),
<a name="1641"/> 1641:     ?match(ok, rpc:call(Node1, ?MODULE, verify_data, [Tab2, 100])),
<a name="1642"/> 1642:     ?match(ok, rpc:call(Node1, ?MODULE, verify_data, [Tab3, 100])),
<a name="disc_less-last_expr"/><a name="1643"/> 1643: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="1644"/> 1644: 
<a name="1645"/> 1645: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1646"/> 1646: 
<a name="garb_decision-1"/><a name="1647"/> 1647: <b>garb_decision</b>(doc) -&gt;
<a name="1648"/> 1648:     [&quot;Test that decisions are garbed correctly.&quot;];
<a name="1649"/> 1649: <b>garb_decision</b>(suite) -&gt; [];
<a name="1650"/> 1650: <b>garb_decision</b>(Config) when is_list(Config) -&gt;
<a name="1651"/> 1651:     [Node1, Node2, Node3] = Nodes = ?acquire_nodes(3, Config),
<a name="1652"/> 1652:     check_garb(Nodes),
<a name="1653"/> 1653:     ?match({atomic, ok},mnesia:create_table(a, [{disc_copies, Nodes}])),
<a name="1654"/> 1654:     check_garb(Nodes),
<a name="1655"/> 1655:     ?match({atomic, ok},mnesia:create_table(b, [{ram_copies, Nodes}])),
<a name="1656"/> 1656:     check_garb(Nodes),
<a name="1657"/> 1657:     ?match({atomic, ok},mnesia:create_table(c, [{ram_copies, [Node1, Node3]},
<a name="1658"/> 1658: 						{disc_copies, [Node2]}])),
<a name="1659"/> 1659:     check_garb(Nodes),
<a name="1660"/> 1660:     ?match({atomic, ok},mnesia:create_table(d, [{disc_copies, [Node1, Node3]},
<a name="1661"/> 1661: 						{ram_copies, [Node2]}])),
<a name="1662"/> 1662:     check_garb(Nodes),
<a name="1663"/> 1663: 
<a name="1664"/> 1664:     W = fun(Tab) -&gt;  mnesia:write({Tab,1,1}) end,
<a name="1665"/> 1665:     A = fun(Tab) -&gt;  mnesia:write({Tab,1,1}), exit(1) end,
<a name="1666"/> 1666: 
<a name="1667"/> 1667:     ?match({atomic, ok}, mnesia:transaction(W,[a])),
<a name="1668"/> 1668:     check_garb(Nodes),
<a name="1669"/> 1669:     ?match({atomic, ok}, mnesia:transaction(W,[b])),
<a name="1670"/> 1670:     check_garb(Nodes),
<a name="1671"/> 1671:     ?match({atomic, ok}, mnesia:transaction(W,[c])),
<a name="1672"/> 1672:     check_garb(Nodes),
<a name="1673"/> 1673:     ?match({atomic, ok}, mnesia:transaction(W,[d])),
<a name="1674"/> 1674:     check_garb(Nodes),
<a name="1675"/> 1675:     ?match({aborted,1}, mnesia:transaction(A,[a])),
<a name="1676"/> 1676:     check_garb(Nodes),
<a name="1677"/> 1677:     ?match({aborted,1}, mnesia:transaction(A,[b])),
<a name="1678"/> 1678:     check_garb(Nodes),
<a name="1679"/> 1679:     ?match({aborted,1}, mnesia:transaction(A,[c])),
<a name="1680"/> 1680:     check_garb(Nodes),
<a name="1681"/> 1681:     ?match({aborted,1}, mnesia:transaction(A,[d])),
<a name="1682"/> 1682:     check_garb(Nodes),
<a name="1683"/> 1683: 
<a name="1684"/> 1684:     rpc:call(Node2, mnesia, lkill, []),
<a name="1685"/> 1685:     ?match({atomic, ok}, mnesia:transaction(W,[a])),
<a name="1686"/> 1686:     ?match({atomic, ok}, mnesia:transaction(W,[b])),
<a name="1687"/> 1687:     ?match({atomic, ok}, mnesia:transaction(W,[c])),
<a name="1688"/> 1688:     ?match({atomic, ok}, mnesia:transaction(W,[d])),
<a name="1689"/> 1689:     check_garb(Nodes),
<a name="1690"/> 1690:     ?match([], mnesia_test_lib:start_mnesia([Node2])),    
<a name="1691"/> 1691:     check_garb(Nodes),
<a name="1692"/> 1692:     timer:sleep(2000),
<a name="1693"/> 1693:     check_garb(Nodes),
<a name="1694"/> 1694:     %%%%%% Check transient_decision logs %%%%%
<a name="1695"/> 1695: 
<a name="1696"/> 1696:     ?match(dumped, mnesia:dump_log()), sys:get_status(mnesia_recover), % sync   
<a name="1697"/> 1697:     [{atomic, ok} = mnesia:transaction(W,[a]) || _ &lt;- lists:seq(1,30)],
<a name="1698"/> 1698:     ?match(dumped, mnesia:dump_log()), sys:get_status(mnesia_recover), % sync   
<a name="1699"/> 1699:     TD0 = mnesia_lib:val(latest_transient_decision),
<a name="1700"/> 1700:     ?match(0, ets:info(TD0, size)),
<a name="1701"/> 1701:     {atomic, ok} = mnesia:transaction(W,[a]),
<a name="1702"/> 1702:     ?match(dumped, mnesia:dump_log()), sys:get_status(mnesia_recover), % sync   
<a name="1703"/> 1703:     ?match(TD0, mnesia_lib:val(latest_transient_decision)),
<a name="1704"/> 1704:     [{atomic, ok} = mnesia:transaction(W,[a]) || _ &lt;- lists:seq(1,30)],
<a name="1705"/> 1705:     ?match(dumped, mnesia:dump_log()), sys:get_status(mnesia_recover), % sync   
<a name="1706"/> 1706:     ?match(false, TD0 =:= mnesia_lib:val(latest_transient_decision)),
<a name="1707"/> 1707:     ?match(true, lists:member(TD0, mnesia_lib:val(previous_transient_decisions))),
<a name="garb_decision-last_expr"/><a name="1708"/> 1708: <b>    ?verify_mnesia</b>(Nodes, []).
<a name="1709"/> 1709: 
<a name="check_garb-1"/><a name="1710"/> 1710: <b>check_garb</b>(Nodes) -&gt;
<a name="1711"/> 1711:     rpc:multicall(Nodes, sys, get_status, [mnesia_recover]),
<a name="check_garb-last_expr"/><a name="1712"/> 1712: <b>    ?match</b>({_, []},rpc:multicall(Nodes, erlang, apply, [fun check_garb/0, []])).
<a name="1713"/> 1713: 
<a name="check_garb-0"/><a name="1714"/> 1714: <b>check_garb</b>() -&gt;
<a name="1715"/> 1715:     try 
<a name="1716"/> 1716: 	Ds = ets:tab2list(mnesia_decision),
<a name="1717"/> 1717: 	Check = fun({trans_tid,serial, _}) -&gt; false;
<a name="1718"/> 1718: 		   ({mnesia_down,_,_,_}) -&gt; false;
<a name="1719"/> 1719: 		   (_Else) -&gt; true
<a name="1720"/> 1720: 		end,
<a name="1721"/> 1721: 	Node = node(),
<a name="1722"/> 1722: 	?match({Node, []}, {node(), lists:filter(Check, Ds)})
<a name="1723"/> 1723:     catch _:_ -&gt; ok  
<a name="1724"/> 1724:     end,
<a name="check_garb-last_expr"/><a name="1725"/> 1725:     ok.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
