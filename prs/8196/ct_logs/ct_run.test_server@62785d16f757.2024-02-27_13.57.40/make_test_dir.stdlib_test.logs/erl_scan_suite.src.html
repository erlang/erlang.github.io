<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/erl_scan_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1998-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: 
<a name="20"/>   20: <b>-module</b>(erl_scan_SUITE).
<a name="21"/>   21: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1,
<a name="22"/>   22: 	 init_per_testcase/2, end_per_testcase/2,
<a name="23"/>   23: 	 init_per_group/2,end_per_group/2]).
<a name="24"/>   24: 
<a name="25"/>   25: <b>-export</b>([error_1/1, error_2/1, iso88591/1, otp_7810/1, otp_10302/1,
<a name="26"/>   26: 	 otp_10990/1, otp_10992/1, otp_11807/1, otp_16480/1, otp_17024/1,
<a name="27"/>   27:          text_fun/1, triple_quoted_string/1]).
<a name="28"/>   28: 
<a name="29"/>   29: <b>-import</b>(lists, [nth/2,flatten/1]).
<a name="30"/>   30: <b>-import</b>(io_lib, [print/1]).
<a name="31"/>   31: 
<a name="32"/>   32: <i>%%</i>
<a name="33"/>   33: <i>%% Define to run outside of test server</i>
<a name="34"/>   34: <i>%%</i>
<a name="35"/>   35: <i>%%-define(STANDALONE,1).</i>
<a name="36"/>   36: 
<a name="37"/>   37: <b>-ifdef</b>(STANDALONE).
<a name="38"/>   38: <b>-compile</b>(export_all).
<a name="39"/>   39: <b>-define</b>(line, put(line, ?LINE), ).
<a name="40"/>   40: <b>-define</b>(config(A,B),config(A,B)).
<a name="41"/>   41: <b>-define</b>(t, test_server).
<a name="42"/>   42: <i>%% config(priv_dir, _) -&gt;</i>
<a name="43"/>   43: <i>%%     &quot;.&quot;;</i>
<a name="44"/>   44: <i>%% config(data_dir, _) -&gt;</i>
<a name="45"/>   45: <i>%%     &quot;.&quot;.</i>
<a name="46"/>   46: -else.
<a name="47"/>   47: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="48"/>   48: -endif.
<a name="49"/>   49: 
<a name="init_per_testcase-2"/><a name="50"/>   50: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="51"/>   51:     Config.
<a name="52"/>   52: 
<a name="end_per_testcase-2"/><a name="53"/>   53: <b>end_per_testcase</b>(_Case, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="54"/>   54:     ok.
<a name="55"/>   55: 
<a name="suite-0"/><a name="56"/>   56: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="57"/>   57:     [{ct_hooks,[ts_install_cth]},
<a name="58"/>   58:      {timetrap,{minutes,20}}].
<a name="59"/>   59: 
<a name="all-0"/><a name="60"/>   60: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="61"/>   61:     [{group, error}, iso88591, otp_7810, otp_10302, otp_10990, otp_10992,
<a name="62"/>   62:      otp_11807, otp_16480, otp_17024, text_fun, triple_quoted_string].
<a name="63"/>   63: 
<a name="groups-0"/><a name="64"/>   64: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="65"/>   65:     [{error, [], [error_1, error_2]}].
<a name="66"/>   66: 
<a name="init_per_suite-1"/><a name="67"/>   67: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="68"/>   68:     Config.
<a name="69"/>   69: 
<a name="end_per_suite-1"/><a name="70"/>   70: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="71"/>   71:     ok.
<a name="72"/>   72: 
<a name="init_per_group-2"/><a name="73"/>   73: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="74"/>   74:     Config.
<a name="75"/>   75: 
<a name="end_per_group-2"/><a name="76"/>   76: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="77"/>   77:     Config.
<a name="78"/>   78: 
<a name="79"/>   79: 
<a name="80"/>   80: 
<a name="81"/>   81: <i>%% (OTP-2347)</i>
<a name="error_1-1"/><a name="82"/>   82: <b>error_1</b>(Config) when is_list(Config) -&gt;
<a name="83"/>   83:     {error, _, _} = erl_scan:string(&quot;'a&quot;),
<a name="error_1-last_expr"/><a name="84"/>   84:     ok.
<a name="85"/>   85: 
<a name="86"/>   86: <i>%% Checks that format_error works on the error cases.</i>
<a name="error_2-1"/><a name="87"/>   87: <b>error_2</b>(Config) when is_list(Config) -&gt;
<a name="88"/>   88:     lists:foreach(fun check/1, error_cases()),
<a name="error_2-last_expr"/><a name="89"/>   89:     ok.
<a name="90"/>   90: 
<a name="error_cases-0"/><a name="91"/>   91: <b>error_cases</b>() -&gt;
<a name="error_cases-last_expr"/><a name="92"/>   92:     [&quot;'a&quot;,
<a name="93"/>   93:      &quot;\&quot;a&quot;,%&quot;
<a name="94"/>   94:      &quot;'\\&quot;,
<a name="95"/>   95:      &quot;\&quot;\\&quot;,%&quot;
<a name="96"/>   96:      &quot;$&quot;,
<a name="97"/>   97:      &quot;$\\&quot;,
<a name="98"/>   98:      &quot;2.3e&quot;,
<a name="99"/>   99:      &quot;2.3e-&quot;,
<a name="100"/>  100:      &quot;91#9&quot;,
<a name="101"/>  101:      &quot;\&quot;\&quot;\&quot;x&quot;,%&quot;
<a name="102"/>  102:      &quot;\&quot;\&quot;\&quot;\n\&quot;\&quot;&quot;,%&quot;
<a name="103"/>  103:      &quot;\&quot;\&quot;\&quot;\nx\n \&quot;\&quot;\&quot;&quot;
<a name="104"/>  104:     ].
<a name="105"/>  105: 
<a name="assert_type-2"/><a name="106"/>  106: <b>assert_type</b>(N, integer) when is_integer(N) -&gt;
<a name="107"/>  107:     ok;
<a name="108"/>  108: <b>assert_type</b>(N, atom) when is_atom(N) -&gt;
<a name="assert_type-last_expr"/><a name="109"/>  109:     ok.
<a name="110"/>  110: 
<a name="check-1"/><a name="111"/>  111: <b>check</b>(String) -&gt;
<a name="112"/>  112:     Error = erl_scan:string(String),
<a name="check-last_expr"/><a name="113"/>  113: <b>    check_error</b>(Error, erl_scan).
<a name="114"/>  114: 
<a name="115"/>  115: <i>%%% (This should be useful for all format_error functions.)</i>
<a name="check_error-2"/><a name="116"/>  116: <b>check_error</b>({error, Info, EndLine}, Module0) -&gt;
<a name="117"/>  117:     {ErrorLine, Module, Desc} = Info,
<a name="118"/>  118:     true = (Module == Module0),
<a name="119"/>  119:     assert_type(EndLine, integer),
<a name="120"/>  120:     assert_type(ErrorLine, integer),
<a name="121"/>  121:     true = (ErrorLine =&lt; EndLine),
<a name="122"/>  122:     String = lists:flatten(Module0:format_error(Desc)),
<a name="check_error-last_expr"/><a name="123"/>  123: <b>    true = io_lib:printable_list</b>(String).
<a name="124"/>  124: 
<a name="125"/>  125: <i>%% Tests the support for ISO-8859-1 i.e Latin-1.</i>
<a name="iso88591-1"/><a name="126"/>  126: <b>iso88591</b>(Config) when is_list(Config) -&gt;
<a name="iso88591-last_expr"/><a name="127"/>  127:     ok =
<a name="128"/>  128: 	case catch begin
<a name="129"/>  129: 		       %% Some atom and variable names
<a name="130"/>  130: 		       V1s = [$Á,$á,$é,$ë],
<a name="131"/>  131: 		       V2s = [$N,$ä,$r],
<a name="132"/>  132: 		       A1s = [$h,$ä,$r],
<a name="133"/>  133: 		       A2s = [$ö,$r,$e],
<a name="134"/>  134: 		       %% Test parsing atom and variable characters.
<a name="135"/>  135: 		       {ok,Ts1,_} = erl_scan_string(V1s ++ &quot; &quot; ++ V2s ++
<a name="136"/>  136: 							&quot;\327&quot; ++
<a name="137"/>  137: 							A1s ++ &quot; &quot; ++ A2s),
<a name="138"/>  138: 		       V1s = atom_to_list(element(3, nth(1, Ts1))),
<a name="139"/>  139: 		       V2s = atom_to_list(element(3, nth(2, Ts1))),
<a name="140"/>  140: 		       A1s = atom_to_list(element(3, nth(4, Ts1))),
<a name="141"/>  141: 		       A2s = atom_to_list(element(3, nth(5, Ts1))),
<a name="142"/>  142: 		       %% Test printing atoms
<a name="143"/>  143: 		       A1s = flatten(print(element(3, nth(4, Ts1)))),
<a name="144"/>  144: 		       A2s = flatten(print(element(3, nth(5, Ts1)))),
<a name="145"/>  145: 		       %% Test parsing and printing strings.
<a name="146"/>  146: 		       S1 = V1s ++ &quot;\327&quot; ++ A1s ++ &quot;\250&quot; ++ A2s,
<a name="147"/>  147: 		       S1s = &quot;\&quot;&quot; ++ S1 ++ &quot;\&quot;&quot;,
<a name="148"/>  148: 		       {ok,Ts2,_} = erl_scan_string(S1s),
<a name="149"/>  149: 		       S1 = element(3, nth(1, Ts2)),
<a name="150"/>  150: 		       S1s = flatten(print(element(3, nth(1, Ts2)))),
<a name="151"/>  151: 		       ok				%It all worked
<a name="152"/>  152: 		   end of
<a name="153"/>  153: 	    {'EXIT',R} -&gt;				%Something went wrong!
<a name="154"/>  154: 		{error,R};
<a name="155"/>  155: 	    ok -&gt; ok				%Aok
<a name="156"/>  156: 	end.
<a name="157"/>  157: 
<a name="158"/>  158: <i>%% OTP-7810. White spaces, comments, and more...</i>
<a name="otp_7810-1"/><a name="159"/>  159: <b>otp_7810</b>(Config) when is_list(Config) -&gt;
<a name="160"/>  160:     ok = reserved_words(),
<a name="161"/>  161:     ok = atoms(),
<a name="162"/>  162:     ok = punctuations(),
<a name="163"/>  163:     ok = comments(),
<a name="164"/>  164:     ok = errors(),
<a name="165"/>  165:     ok = integers(),
<a name="166"/>  166:     ok = base_integers(),
<a name="167"/>  167:     ok = floats(),
<a name="168"/>  168:     ok = dots(),
<a name="169"/>  169:     ok = chars(),
<a name="170"/>  170:     ok = variables(),
<a name="171"/>  171:     ok = eof(),
<a name="172"/>  172:     ok = illegal(),
<a name="173"/>  173:     ok = crashes(),
<a name="174"/>  174: 
<a name="175"/>  175:     ok = options(),
<a name="176"/>  176:     ok = token_info(),
<a name="177"/>  177:     ok = column_errors(),
<a name="178"/>  178:     ok = white_spaces(),
<a name="179"/>  179: 
<a name="180"/>  180:     ok = unicode(),
<a name="181"/>  181: 
<a name="182"/>  182:     ok = more_chars(),
<a name="183"/>  183:     ok = more_options(),
<a name="184"/>  184:     ok = anno_info(),
<a name="185"/>  185: 
<a name="otp_7810-last_expr"/><a name="186"/>  186:     ok.
<a name="187"/>  187: 
<a name="reserved_words-0"/><a name="188"/>  188: <b>reserved_words</b>() -&gt;
<a name="189"/>  189:     L = ['after', 'begin', 'case', 'try', 'cond', 'catch',
<a name="190"/>  190:          'andalso', 'orelse', 'end', 'fun', 'if', 'let', 'of',
<a name="191"/>  191:          'receive', 'when', 'bnot', 'not', 'div',
<a name="192"/>  192:          'rem', 'band', 'and', 'bor', 'bxor', 'bsl', 'bsr',
<a name="193"/>  193:          'or', 'xor'],
<a name="194"/>  194:     [begin
<a name="195"/>  195:          {RW, true} = {RW, erl_scan:reserved_word(RW)},
<a name="196"/>  196:          S = atom_to_list(RW),
<a name="197"/>  197:          Ts = [{RW,{1,1}}],
<a name="198"/>  198:          test_string(S, Ts)
<a name="199"/>  199:      end || RW &lt;- L],
<a name="reserved_words-last_expr"/><a name="200"/>  200:     ok.
<a name="201"/>  201: 
<a name="202"/>  202: 
<a name="atoms-0"/><a name="203"/>  203: <b>atoms</b>() -&gt;
<a name="204"/>  204:     test_string(&quot;a
<a name="205"/>  205:                  b&quot;, [{atom,{1,1},a},{atom,{2,18},b}]),
<a name="206"/>  206:     test_string(&quot;'a b'&quot;, [{atom,{1,1},'a b'}]),
<a name="207"/>  207: 		test_string(&quot;a&quot;, [{atom,{1,1},a}]),
<a name="208"/>  208: 		test_string(&quot;a@2&quot;, [{atom,{1,1},a@2}]),
<a name="209"/>  209: 		test_string([39,65,200,39], [{atom,{1,1},'AÈ'}]),
<a name="210"/>  210: 		test_string(&quot;ärlig östen&quot;, [{atom,{1,1},ärlig},{atom,{1,7},östen}]),
<a name="211"/>  211: 		{ok,[{atom,_,'$a'}],{1,6}} =
<a name="212"/>  212: 		    erl_scan_string(&quot;'$\\a'&quot;, {1,1}),
<a name="213"/>  213: 		test(&quot;'$\\a'&quot;),
<a name="atoms-last_expr"/><a name="214"/>  214: 		ok.
<a name="215"/>  215: 
<a name="punctuations-0"/><a name="216"/>  216: <b>punctuations</b>() -&gt;
<a name="217"/>  217:     L = [&quot;&lt;&lt;&quot;, &quot;&lt;-&quot;, &quot;&lt;=&quot;, &quot;&lt;&quot;, &quot;&gt;&gt;&quot;, &quot;&gt;=&quot;, &quot;&gt;&quot;, &quot;-&gt;&quot;, &quot;--&quot;,
<a name="218"/>  218:          &quot;-&quot;, &quot;++&quot;, &quot;+&quot;, &quot;=:=&quot;, &quot;=/=&quot;, &quot;=&lt;&quot;, &quot;=&gt;&quot;, &quot;==&quot;, &quot;=&quot;, &quot;/=&quot;,
<a name="219"/>  219:          &quot;/&quot;, &quot;||&quot;, &quot;|&quot;, &quot;:=&quot;, &quot;::&quot;, &quot;:&quot;],
<a name="220"/>  220:     %% One token at a time:
<a name="221"/>  221:     [begin
<a name="222"/>  222:          W = list_to_atom(S),
<a name="223"/>  223:          Ts = [{W,{1,1}}],
<a name="224"/>  224:          test_string(S, Ts)
<a name="225"/>  225:      end || S &lt;- L],
<a name="226"/>  226:     Three = [&quot;/=:=&quot;, &quot;&lt;=:=&quot;, &quot;==:=&quot;, &quot;&gt;=:=&quot;], % three tokens...
<a name="227"/>  227:     No = Three ++ L,
<a name="228"/>  228:     SL0 = [{S1++S2,{-length(S1),S1,S2}} ||
<a name="229"/>  229:               S1 &lt;- L,
<a name="230"/>  230:               S2 &lt;- L,
<a name="231"/>  231:               not lists:member(S1++S2, No)],
<a name="232"/>  232:     SL = family_list(SL0),
<a name="233"/>  233:     %% Two tokens. When there are several answers, the one with
<a name="234"/>  234:     %% the longest first token is chosen:
<a name="235"/>  235:     %% [the special case &quot;=&lt;&lt;&quot; is among the tested ones]
<a name="236"/>  236:     [begin
<a name="237"/>  237:          W1 = list_to_atom(S1),
<a name="238"/>  238:          W2 = list_to_atom(S2),
<a name="239"/>  239:          Ts = [{W1,{1,1}},{W2,{1,-L2+1}}],
<a name="240"/>  240:          test_string(S, Ts)
<a name="241"/>  241:      end || {S,[{L2,S1,S2}|_]}  &lt;- SL],
<a name="242"/>  242: 
<a name="243"/>  243:     PTs1 = [{'!',{1,1}},{'(',{1,2}},{')',{1,3}},{',',{1,4}},{';',{1,5}},
<a name="244"/>  244:             {'=',{1,6}},{'[',{1,7}},{']',{1,8}},{'{',{1,9}},{'|',{1,10}},
<a name="245"/>  245:             {'}',{1,11}}],
<a name="246"/>  246:     test_string(&quot;!(),;=[]{|}&quot;, PTs1),
<a name="247"/>  247: 
<a name="248"/>  248:     PTs2 = [{'#',{1,1}},{'&amp;',{1,2}},{'*',{1,3}},{'+',{1,4}},{'/',{1,5}},
<a name="249"/>  249:             {':',{1,6}},{'&lt;',{1,7}},{'&gt;',{1,8}},{'?',{1,9}},{'@',{1,10}},
<a name="250"/>  250:             {'\\',{1,11}},{'^',{1,12}},{'`',{1,13}}],
<a name="251"/>  251:     test_string(&quot;#&amp;*+/:&lt;&gt;?@\\^`&quot;, PTs2),
<a name="252"/>  252: 
<a name="253"/>  253:     test_string(&quot;.. &quot;, [{'..',{1,1}}]),
<a name="254"/>  254:     test_string(&quot;1 .. 2&quot;,
<a name="255"/>  255:                 [{integer,{1,1},1},{'..',{1,3}},{integer,{1,6},2}]),
<a name="256"/>  256:     test_string(&quot;...&quot;, [{'...',{1,1}}]),
<a name="punctuations-last_expr"/><a name="257"/>  257:     ok.
<a name="258"/>  258: 
<a name="comments-0"/><a name="259"/>  259: <b>comments</b>() -&gt;
<a name="260"/>  260:     test(&quot;a %%\n b&quot;),
<a name="261"/>  261:     {ok,[],1} = erl_scan_string(&quot;%&quot;),
<a name="262"/>  262:     test(&quot;a %%\n b&quot;),
<a name="263"/>  263:     {ok,[{atom,{1,1},a},{atom,{2,2},b}],{2,3}} =
<a name="264"/>  264:         erl_scan_string(&quot;a %%\n b&quot;, {1,1}),
<a name="265"/>  265:     {ok,[{atom,{1,1},a},{comment,{1,3},&quot;%%&quot;},{atom,{2,2},b}],{2,3}} =
<a name="266"/>  266:         erl_scan_string(&quot;a %%\n b&quot;,{1,1}, [return_comments]),
<a name="267"/>  267:     {ok,[{atom,{1,1},a},
<a name="268"/>  268:          {white_space,{1,2},&quot; &quot;},
<a name="269"/>  269:          {white_space,{1,5},&quot;\n &quot;},
<a name="270"/>  270:          {atom,{2,2},b}],
<a name="271"/>  271:      {2,3}} =
<a name="272"/>  272:         erl_scan_string(&quot;a %%\n b&quot;,{1,1},[return_white_spaces]),
<a name="273"/>  273:     {ok,[{atom,{1,1},a},
<a name="274"/>  274:          {white_space,{1,2},&quot; &quot;},
<a name="275"/>  275:          {comment,{1,3},&quot;%%&quot;},
<a name="276"/>  276:          {white_space,{1,5},&quot;\n &quot;},
<a name="277"/>  277:          {atom,{2,2},b}],
<a name="278"/>  278:      {2,3}} = erl_scan_string(&quot;a %%\n b&quot;,{1,1},[return]),
<a name="comments-last_expr"/><a name="279"/>  279:     ok.
<a name="280"/>  280: 
<a name="errors-0"/><a name="281"/>  281: <b>errors</b>() -&gt;
<a name="282"/>  282:     {error,{1,erl_scan,{unterminated,atom,&quot;qa&quot;}},1} = erl_scan:string(&quot;'qa&quot;), %'
<a name="283"/>  283:     {error,{{1,2},erl_scan,{unterminated,atom,&quot;qa&quot;}},{1,4}} = %'
<a name="284"/>  284:         erl_scan:string(&quot;'qa&quot;, {1,1}, []), %'
<a name="285"/>  285:     {error,{1,erl_scan,{unterminated,string,&quot;str&quot;}},1} = %&quot;
<a name="286"/>  286:         erl_scan:string(&quot;\&quot;str&quot;), %&quot;
<a name="287"/>  287:     {error,{{1,2},erl_scan,{unterminated,string,&quot;str&quot;}},{1,5}} = %&quot;
<a name="288"/>  288:         erl_scan:string(&quot;\&quot;str&quot;, {1,1}, []), %&quot;
<a name="289"/>  289:     {error,{1,erl_scan,{unterminated,char}},1} = erl_scan:string(&quot;$&quot;),
<a name="290"/>  290:     {error,{{1,1},erl_scan,{unterminated,char}},{1,2}} =
<a name="291"/>  291:         erl_scan:string(&quot;$&quot;, {1,1}, []),
<a name="292"/>  292:     test_string([34,65,200,34], [{string,{1,1},&quot;AÈ&quot;}]),
<a name="293"/>  293:     test_string(&quot;\\&quot;, [{'\\',{1,1}}]),
<a name="294"/>  294:     {'EXIT',_} =
<a name="295"/>  295:         (catch {foo, erl_scan:string('$\\a', {1,1})}), % type error
<a name="296"/>  296:     {'EXIT',_} =
<a name="297"/>  297:         (catch {foo, erl_scan:tokens([], '$\\a', {1,1})}), % type error
<a name="298"/>  298: 
<a name="299"/>  299:     &quot;{a,tuple}&quot; = erl_scan:format_error({a,tuple}),
<a name="errors-last_expr"/><a name="300"/>  300:     ok.
<a name="301"/>  301: 
<a name="integers-0"/><a name="302"/>  302: <b>integers</b>() -&gt;
<a name="303"/>  303:     [begin
<a name="304"/>  304:          I = list_to_integer(S),
<a name="305"/>  305:          Ts = [{integer,{1,1},I}],
<a name="306"/>  306:          test_string(S, Ts)
<a name="307"/>  307:      end || S &lt;- [[N] || N &lt;- lists:seq($0, $9)] ++ [&quot;2323&quot;,&quot;000&quot;] ],
<a name="308"/>  308:     UnderscoreSamples =
<a name="309"/>  309:         [{&quot;123_456&quot;, 123456},
<a name="310"/>  310:          {&quot;123_456_789&quot;, 123456789},
<a name="311"/>  311:          {&quot;1_2&quot;, 12}],
<a name="312"/>  312:     lists:foreach(
<a name="313"/>  313:          fun({S, I}) -&gt;
<a name="314"/>  314:                  test_string(S, [{integer, {1, 1}, I}])
<a name="315"/>  315:          end, UnderscoreSamples),
<a name="316"/>  316:     UnderscoreErrors =
<a name="317"/>  317:         [&quot;123_&quot;,
<a name="318"/>  318:          &quot;123__&quot;,
<a name="319"/>  319:          &quot;123_456_&quot;,
<a name="320"/>  320:          &quot;123__456&quot;,
<a name="321"/>  321:          &quot;_123&quot;,
<a name="322"/>  322:          &quot;__123&quot;],
<a name="323"/>  323:     lists:foreach(
<a name="324"/>  324:       fun(S) -&gt;
<a name="325"/>  325:               case erl_scan:string(S) of
<a name="326"/>  326:                   {ok, [{integer, _, _}], _} -&gt;
<a name="327"/>  327:                       error({unexpected_integer, S});
<a name="328"/>  328:                   _ -&gt;
<a name="329"/>  329:                       ok
<a name="330"/>  330:               end
<a name="331"/>  331:       end, UnderscoreErrors),
<a name="332"/>  332:     test_string(&quot;_123&quot;, [{var,{1,1},'_123'}]),
<a name="333"/>  333:     test_string(&quot;123_&quot;, [{integer,{1,1},123},{var,{1,4},'_'}]),
<a name="integers-last_expr"/><a name="334"/>  334:     ok.
<a name="335"/>  335: 
<a name="base_integers-0"/><a name="336"/>  336: <b>base_integers</b>() -&gt;
<a name="337"/>  337:     [begin
<a name="338"/>  338:          B = list_to_integer(BS),
<a name="339"/>  339:          I = erlang:list_to_integer(S, B),
<a name="340"/>  340:          Ts = [{integer,{1,1},I}],
<a name="341"/>  341:          test_string(BS++&quot;#&quot;++S, Ts)
<a name="342"/>  342:      end || {BS,S} &lt;- [{&quot;2&quot;,&quot;11&quot;}, {&quot;5&quot;,&quot;23234&quot;}, {&quot;12&quot;,&quot;05a&quot;},
<a name="343"/>  343:                        {&quot;16&quot;,&quot;abcdef&quot;}, {&quot;16&quot;,&quot;ABCDEF&quot;}] ],
<a name="344"/>  344: 
<a name="345"/>  345:     {error,{1,erl_scan,{base,1}},1} = erl_scan:string(&quot;1#000&quot;),
<a name="346"/>  346:     {error,{{1,1},erl_scan,{base,1}},{1,2}} =
<a name="347"/>  347:         erl_scan:string(&quot;1#000&quot;, {1,1}, []),
<a name="348"/>  348: 
<a name="349"/>  349:     {error,{1,erl_scan,{base,1}},1} = erl_scan:string(&quot;1#000&quot;),
<a name="350"/>  350:     {error,{{1,1},erl_scan,{base,1000}},{1,6}} =
<a name="351"/>  351:         erl_scan:string(&quot;1_000#000&quot;, {1,1}, []),
<a name="352"/>  352: 
<a name="353"/>  353:     test_string(&quot;12#bc&quot;, [{integer,{1,1},11},{atom,{1,5},c}]),
<a name="354"/>  354: 
<a name="355"/>  355:     [begin
<a name="356"/>  356:          Str = BS ++ &quot;#&quot; ++ S,
<a name="357"/>  357:          E = 2 + length(BS),
<a name="358"/>  358:          {error,{{1,1},erl_scan,{illegal,integer}},{1,E}} =
<a name="359"/>  359:              erl_scan:string(Str, {1,1}, [])
<a name="360"/>  360:      end || {BS,S} &lt;- [{&quot;3&quot;,&quot;3&quot;},{&quot;15&quot;,&quot;f&quot;},{&quot;12&quot;,&quot;c&quot;},
<a name="361"/>  361:                        {&quot;1_5&quot;,&quot;f&quot;},{&quot;1_2&quot;,&quot;c&quot;}] ],
<a name="362"/>  362: 
<a name="363"/>  363:     {ok,[{integer,1,239},{'@',1}],1} = erl_scan_string(&quot;16#ef@&quot;),
<a name="364"/>  364:     {ok,[{integer,{1,1},239},{'@',{1,6}}],{1,7}} =
<a name="365"/>  365:         erl_scan_string(&quot;16#ef@&quot;, {1,1}, []),
<a name="366"/>  366:     {ok,[{integer,{1,1},14},{atom,{1,5},g@}],{1,7}} =
<a name="367"/>  367:         erl_scan_string(&quot;16#eg@&quot;, {1,1}, []),
<a name="368"/>  368: 
<a name="369"/>  369:     UnderscoreSamples =
<a name="370"/>  370:         [{&quot;16#1234_ABCD_EF56&quot;, 16#1234abcdef56},
<a name="371"/>  371:          {&quot;2#0011_0101_0011&quot;, 2#001101010011},
<a name="372"/>  372:          {&quot;1_6#123ABC&quot;, 16#123abc},
<a name="373"/>  373:          {&quot;1_6#123_ABC&quot;, 16#123abc},
<a name="374"/>  374:          {&quot;16#abcdef&quot;, 16#ABCDEF}],
<a name="375"/>  375:     lists:foreach(
<a name="376"/>  376:          fun({S, I}) -&gt;
<a name="377"/>  377:                  test_string(S, [{integer, {1, 1}, I}])
<a name="378"/>  378:          end, UnderscoreSamples),
<a name="379"/>  379:     UnderscoreErrors =
<a name="380"/>  380:         [&quot;16_#123ABC&quot;,
<a name="381"/>  381:          &quot;16#123_&quot;,
<a name="382"/>  382:          &quot;16#_123&quot;,
<a name="383"/>  383:          &quot;16#ABC_&quot;,
<a name="384"/>  384:          &quot;16#_ABC&quot;,
<a name="385"/>  385:          &quot;2#_0101&quot;,
<a name="386"/>  386:          &quot;1__6#ABC&quot;,
<a name="387"/>  387:          &quot;16#AB__CD&quot;],
<a name="388"/>  388:     lists:foreach(
<a name="389"/>  389:       fun(S) -&gt;
<a name="390"/>  390:               case erl_scan:string(S) of
<a name="391"/>  391:                   {ok, [{integer, _, _}], _} -&gt;
<a name="392"/>  392:                       error({unexpected_integer, S});
<a name="393"/>  393:                   _ -&gt;
<a name="394"/>  394:                       ok
<a name="395"/>  395:               end
<a name="396"/>  396:       end, UnderscoreErrors),
<a name="397"/>  397:     test_string(&quot;16#123_&quot;, [{integer,{1,1},291},{var,{1,7},'_'}]),
<a name="398"/>  398:     test_string(&quot;_16#ABC&quot;, [{var,{1,1},'_16'},{'#',{1,4}},{var,{1,5},'ABC'}]),
<a name="base_integers-last_expr"/><a name="399"/>  399:     ok.
<a name="400"/>  400: 
<a name="floats-0"/><a name="401"/>  401: <b>floats</b>() -&gt;
<a name="402"/>  402:     [begin
<a name="403"/>  403:          F = list_to_float(FS),
<a name="404"/>  404:          Ts = [{float,{1,1},F}],
<a name="405"/>  405:          test_string(FS, Ts)
<a name="406"/>  406:      end || FS &lt;- [&quot;1.0&quot;,&quot;001.17&quot;,&quot;3.31200&quot;,&quot;1.0e0&quot;,&quot;1.0E17&quot;,
<a name="407"/>  407:                    &quot;34.21E-18&quot;, &quot;17.0E+14&quot;]],
<a name="408"/>  408:     test_string(&quot;1.e2&quot;, [{integer,{1,1},1},{'.',{1,2}},{atom,{1,3},e2}]),
<a name="409"/>  409: 
<a name="410"/>  410:     {error,{1,erl_scan,{illegal,float}},1} =
<a name="411"/>  411:         erl_scan:string(&quot;1.0e400&quot;),
<a name="412"/>  412:     {error,{{1,1},erl_scan,{illegal,float}},{1,8}} =
<a name="413"/>  413:         erl_scan:string(&quot;1.0e400&quot;, {1,1}, []),
<a name="414"/>  414:     {error,{{1,1},erl_scan,{illegal,float}},{1,9}} =
<a name="415"/>  415:         erl_scan:string(&quot;1.0e4_00&quot;, {1,1}, []),
<a name="416"/>  416:     [begin
<a name="417"/>  417:          {error,{1,erl_scan,{illegal,float}},1} = erl_scan:string(S),
<a name="418"/>  418:          {error,{{1,1},erl_scan,{illegal,float}},{1,_}} =
<a name="419"/>  419:              erl_scan:string(S, {1,1}, [])
<a name="420"/>  420:      end || S &lt;- [&quot;1.14Ea&quot;]],
<a name="421"/>  421: 
<a name="422"/>  422:     UnderscoreSamples =
<a name="423"/>  423:         [{&quot;123_456.789&quot;, 123456.789},
<a name="424"/>  424:          {&quot;123.456_789&quot;, 123.456789},
<a name="425"/>  425:          {&quot;1.2_345e10&quot;, 1.2345e10},
<a name="426"/>  426:          {&quot;1.234e1_06&quot;, 1.234e106},
<a name="427"/>  427:          {&quot;12_34.56_78e1_6&quot;, 1234.5678e16},
<a name="428"/>  428:          {&quot;12_34.56_78e-1_8&quot;, 1234.5678e-18}],
<a name="429"/>  429:     lists:foreach(
<a name="430"/>  430:          fun({S, I}) -&gt;
<a name="431"/>  431:                  test_string(S, [{float, {1, 1}, I}])
<a name="432"/>  432:          end, UnderscoreSamples),
<a name="433"/>  433:     UnderscoreErrors =
<a name="434"/>  434:         [&quot;123_.456&quot;,
<a name="435"/>  435:          &quot;123._456&quot;,
<a name="436"/>  436:          &quot;123.456_&quot;,
<a name="437"/>  437:          &quot;123._&quot;,
<a name="438"/>  438:          &quot;1._23e10&quot;,
<a name="439"/>  439:          &quot;1.23e_10&quot;,
<a name="440"/>  440:          &quot;1.23e10_&quot;],
<a name="441"/>  441:     lists:foreach(
<a name="442"/>  442:       fun(S) -&gt;
<a name="443"/>  443:               case erl_scan:string(S) of
<a name="444"/>  444:                   {ok, [{float, _, _}], _} -&gt;
<a name="445"/>  445:                       error({unexpected_float, S});
<a name="446"/>  446:                   _ -&gt;
<a name="447"/>  447:                       ok
<a name="448"/>  448:               end
<a name="449"/>  449:       end, UnderscoreErrors),
<a name="450"/>  450:     test_string(&quot;123._&quot;, [{integer,{1,1},123},{'.',{1,4}},{var,{1,5},'_'}]),
<a name="451"/>  451:     test_string(&quot;1.23_e10&quot;, [{float,{1,1},1.23},{var,{1,5},'_e10'}]),
<a name="floats-last_expr"/><a name="452"/>  452:     ok.
<a name="453"/>  453: 
<a name="dots-0"/><a name="454"/>  454: <b>dots</b>() -&gt;
<a name="455"/>  455:     Dot = [{&quot;.&quot;,    {ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,2}}},
<a name="456"/>  456:            {&quot;. &quot;,   {ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,3}}},
<a name="457"/>  457:            {&quot;.\n&quot;,  {ok,[{dot,1}],2}, {ok,[{dot,{1,1}}],{2,1}}},
<a name="458"/>  458:            {&quot;.%&quot;,   {ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,3}}},
<a name="459"/>  459:            {&quot;.\210&quot;,{ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,3}}},
<a name="460"/>  460:            {&quot;.% öh&quot;,{ok,[{dot,1}],1}, {ok,[{dot,{1,1}}],{1,6}}},
<a name="461"/>  461:            {&quot;.%\n&quot;, {ok,[{dot,1}],2}, {ok,[{dot,{1,1}}],{2,1}}},
<a name="462"/>  462:            {&quot;.$&quot;,   {error,{1,erl_scan,{unterminated,char}},1},
<a name="463"/>  463: 	    {error,{{1,2},erl_scan,{unterminated,char}},{1,3}}},
<a name="464"/>  464:            {&quot;.$\\&quot;, {error,{1,erl_scan,{unterminated,char}},1},
<a name="465"/>  465:                     {error,{{1,2},erl_scan,{unterminated,char}},{1,4}}},
<a name="466"/>  466:            {&quot;.a&quot;,   {ok,[{'.',1},{atom,1,a}],1},
<a name="467"/>  467: 	    {ok,[{'.',{1,1}},{atom,{1,2},a}],{1,3}}}
<a name="468"/>  468:           ],
<a name="469"/>  469:     [begin
<a name="470"/>  470:          R = erl_scan_string(S),
<a name="471"/>  471:          R2 = erl_scan_string(S, {1,1}, [])
<a name="472"/>  472:      end || {S, R, R2} &lt;- Dot],
<a name="473"/>  473: 
<a name="474"/>  474:     {ok,[{dot,_}=T1],{1,2}} = erl_scan:string(&quot;.&quot;, {1,1}, text),
<a name="475"/>  475:     [1, 1, &quot;.&quot;] = token_info(T1),
<a name="476"/>  476:     {ok,[{dot,_}=T2],{1,3}} = erl_scan:string(&quot;.%&quot;, {1,1}, text),
<a name="477"/>  477:     [1, 1, &quot;.&quot;] = token_info(T2),
<a name="478"/>  478:     {ok,[{dot,_}=T3],{1,6}} =
<a name="479"/>  479:         erl_scan:string(&quot;.% öh&quot;, {1,1}, text),
<a name="480"/>  480:     [1, 1, &quot;.&quot;] = token_info(T3),
<a name="481"/>  481:     {error,{{1,2},erl_scan,{unterminated,char}},{1,3}} =
<a name="482"/>  482:         erl_scan:string(&quot;.$&quot;, {1,1}),
<a name="483"/>  483:     {error,{{1,2},erl_scan,{unterminated,char}},{1,4}} =
<a name="484"/>  484:         erl_scan:string(&quot;.$\\&quot;, {1,1}),
<a name="485"/>  485: 
<a name="486"/>  486:     test_string(&quot;. &quot;, [{dot,{1,1}}]),
<a name="487"/>  487:     test_string(&quot;.  &quot;, [{dot,{1,1}}]),
<a name="488"/>  488:     test_string(&quot;.\n&quot;, [{dot,{1,1}}]),
<a name="489"/>  489:     test_string(&quot;.\n\n&quot;, [{dot,{1,1}}]),
<a name="490"/>  490:     test_string(&quot;.\n\r&quot;, [{dot,{1,1}}]),
<a name="491"/>  491:     test_string(&quot;.\n\n\n&quot;, [{dot,{1,1}}]),
<a name="492"/>  492:     test_string(&quot;.\210&quot;, [{dot,{1,1}}]),
<a name="493"/>  493:     test_string(&quot;.%\n&quot;, [{dot,{1,1}}]),
<a name="494"/>  494:     test_string(&quot;.a&quot;, [{'.',{1,1}},{atom,{1,2},a}]),
<a name="495"/>  495: 
<a name="496"/>  496:     test_string(&quot;%. \n. &quot;, [{dot,{2,1}}]),
<a name="497"/>  497:     {more,C} = erl_scan:tokens([], &quot;%. &quot;,{1,1}, return),
<a name="498"/>  498:     {done,{ok,[{comment,{1,1},&quot;%. &quot;},
<a name="499"/>  499:                {white_space,{1,4},&quot;\n&quot;},
<a name="500"/>  500:                {dot,{2,1}}],
<a name="501"/>  501:            {2,3}}, &quot;&quot;} =
<a name="502"/>  502:         erl_scan_tokens(C, &quot;\n. &quot;, {1,1}, return), % any loc, any options
<a name="503"/>  503: 
<a name="504"/>  504:     [test_string(S, R) ||
<a name="505"/>  505:         {S, R} &lt;- [{&quot;.$\n&quot;,   [{'.',{1,1}},{char,{1,2},$\n}]},
<a name="506"/>  506:                    {&quot;$\\\n&quot;,  [{char,{1,1},$\n}]},
<a name="507"/>  507:                    {&quot;'\\\n'&quot;, [{atom,{1,1},'\n'}]},
<a name="508"/>  508:                    {&quot;$\n&quot;,    [{char,{1,1},$\n}]}] ],
<a name="dots-last_expr"/><a name="509"/>  509:     ok.
<a name="510"/>  510: 
<a name="chars-0"/><a name="511"/>  511: <b>chars</b>() -&gt;
<a name="512"/>  512:     [begin
<a name="513"/>  513:          L = lists:flatten(io_lib:format(&quot;$\\~.8b&quot;, [C])),
<a name="514"/>  514:          Ts = [{char,{1,1},C}],
<a name="515"/>  515:          test_string(L, Ts)
<a name="516"/>  516:      end || C &lt;- lists:seq(0, 255)],
<a name="517"/>  517: 
<a name="518"/>  518:     %% Leading zeroes...
<a name="519"/>  519:     [begin
<a name="520"/>  520:          L = lists:flatten(io_lib:format(&quot;$\\~3.8.0b&quot;, [C])),
<a name="521"/>  521:          Ts = [{char,{1,1},C}],
<a name="522"/>  522:          test_string(L, Ts)
<a name="523"/>  523:      end || C &lt;- lists:seq(0, 255)],
<a name="524"/>  524: 
<a name="525"/>  525:     %% GH-6477. Test legal use of caret notation.
<a name="526"/>  526:     [begin
<a name="527"/>  527:          L = &quot;$\\^&quot; ++ [C],
<a name="528"/>  528:          Ts = case C of
<a name="529"/>  529:                   $? -&gt;
<a name="530"/>  530:                       [{char,{1,1},127}];
<a name="531"/>  531:                   _ -&gt;
<a name="532"/>  532:                       [{char,{1,1},C band 2#11111}]
<a name="533"/>  533:               end,
<a name="534"/>  534:          test_string(L, Ts)
<a name="535"/>  535:      end || C &lt;- lists:seq($?, $Z) ++ lists:seq($a, $z)],
<a name="536"/>  536: 
<a name="537"/>  537:     [begin
<a name="538"/>  538:          L = &quot;$\\&quot; ++ [C],
<a name="539"/>  539:          Ts = [{char,{1,1},V}],
<a name="540"/>  540:          test_string(L, Ts)
<a name="541"/>  541:      end || {C,V} &lt;- [{$n,$\n}, {$r,$\r}, {$t,$\t}, {$v,$\v},
<a name="542"/>  542:                       {$b,$\b}, {$f,$\f}, {$e,$\e}, {$s,$\s},
<a name="543"/>  543:                       {$d,$\d}]],
<a name="544"/>  544: 
<a name="545"/>  545:     EC = [$\n,$\r,$\t,$\v,$\b,$\f,$\e,$\s,$\d],
<a name="546"/>  546:     Ds = lists:seq($0, $9),
<a name="547"/>  547:     X = [$^,$n,$r,$t,$v,$b,$f,$e,$s,$d],
<a name="548"/>  548:     New = [${,$x],
<a name="549"/>  549:     No = EC ++ Ds ++ X ++ New,
<a name="550"/>  550:     [begin
<a name="551"/>  551:          L = &quot;$\\&quot; ++ [C],
<a name="552"/>  552:          Ts = [{char,{1,1},C}],
<a name="553"/>  553:          test_string(L, Ts)
<a name="554"/>  554:      end || C &lt;- lists:seq(0, 255) -- No],
<a name="555"/>  555: 
<a name="556"/>  556:     [begin
<a name="557"/>  557:          L = &quot;'$\\&quot; ++ [C] ++ &quot;'&quot;,
<a name="558"/>  558:          Ts = [{atom,{1,1},list_to_atom(&quot;$&quot;++[C])}],
<a name="559"/>  559:          test_string(L, Ts)
<a name="560"/>  560:      end || C &lt;- lists:seq(0, 255) -- No],
<a name="561"/>  561: 
<a name="562"/>  562:     test_string(&quot;\&quot;\\013a\\\n\&quot;&quot;, [{string,{1,1},&quot;\va\n&quot;}]),
<a name="563"/>  563: 
<a name="564"/>  564:     test_string(&quot;'\n'&quot;, [{atom,{1,1},'\n'}]),
<a name="565"/>  565:     test_string(&quot;\&quot;\n\a\&quot;&quot;, [{string,{1,1},&quot;\na&quot;}]),
<a name="566"/>  566: 
<a name="567"/>  567:     %% No escape
<a name="568"/>  568:     [begin
<a name="569"/>  569:          L = &quot;$&quot; ++ [C],
<a name="570"/>  570:          Ts = [{char,{1,1},C}],
<a name="571"/>  571:          test_string(L, Ts)
<a name="572"/>  572:      end || C &lt;- lists:seq(0, 255) -- (No ++ [$\\])],
<a name="573"/>  573:     test_string(&quot;$\n&quot;, [{char,{1,1},$\n}]),
<a name="574"/>  574: 
<a name="575"/>  575:     {error,{{1,1},erl_scan,{unterminated,char}},{1,4}} =
<a name="576"/>  576:         erl_scan:string(&quot;$\\^&quot;,{1,1}),
<a name="577"/>  577:     test_string(&quot;$\\\n&quot;, [{char,{1,1},$\n}]),
<a name="578"/>  578:     %% Robert's scanner returns line 1:
<a name="579"/>  579:     test_string(&quot;$\\\n&quot;, [{char,{1,1},$\n}]),
<a name="580"/>  580:     test_string(&quot;$\n\n&quot;, [{char,{1,1},$\n}]),
<a name="581"/>  581:     test(&quot;$\n\n&quot;),
<a name="chars-last_expr"/><a name="582"/>  582:     ok.
<a name="583"/>  583: 
<a name="584"/>  584: 
<a name="variables-0"/><a name="585"/>  585: <b>variables</b>() -&gt;
<a name="586"/>  586:     test_string(&quot;     \237_Aouåeiyäö&quot;, [{var,{1,7},'_Aouåeiyäö'}]),
<a name="587"/>  587:     test_string(&quot;A_b_c@&quot;, [{var,{1,1},'A_b_c@'}]),
<a name="588"/>  588:     test_string(&quot;V@2&quot;, [{var,{1,1},'V@2'}]),
<a name="589"/>  589:     test_string(&quot;ABDÀ&quot;, [{var,{1,1},'ABDÀ'}]),
<a name="590"/>  590:     test_string(&quot;Ärlig Östen&quot;, [{var,{1,1},'Ärlig'},{var,{1,7},'Östen'}]),
<a name="variables-last_expr"/><a name="591"/>  591:     ok.
<a name="592"/>  592: 
<a name="eof-0"/><a name="593"/>  593: <b>eof</b>() -&gt;
<a name="594"/>  594:     {done,{eof,1},eof} = erl_scan:tokens([], eof, 1),
<a name="595"/>  595:     {more, C1} = erl_scan:tokens([],&quot;    \n&quot;, 1),
<a name="596"/>  596:     {done,{eof,2},eof} = erl_scan:tokens(C1, eof, 1),
<a name="597"/>  597:     {more, C2} = erl_scan:tokens([], &quot;abra&quot;, 1),
<a name="598"/>  598:     %% An error before R13A.
<a name="599"/>  599:     %% {done,Err={error,{1,erl_scan,scan},1},eof} =
<a name="600"/>  600:     {done,{ok,[{atom,1,abra}],1},eof} =
<a name="601"/>  601:         erl_scan_tokens(C2, eof, 1),
<a name="602"/>  602: 
<a name="603"/>  603:     %% With column.
<a name="604"/>  604:     {more, C3} = erl_scan:tokens([],&quot;    \n&quot;,{1,1}),
<a name="605"/>  605:     {done,{eof,{2,1}},eof} = erl_scan:tokens(C3, eof, 1),
<a name="606"/>  606:     {more, C4} = erl_scan:tokens([], &quot;abra&quot;, {1,1}),
<a name="607"/>  607:     %% An error before R13A.
<a name="608"/>  608:     %% {done,{error,{{1,1},erl_scan,scan},{1,5}},eof} =
<a name="609"/>  609:     {done,{ok,[{atom,_,abra}],{1,5}},eof} =
<a name="610"/>  610:         erl_scan_tokens(C4, eof, 1),
<a name="611"/>  611: 
<a name="612"/>  612:     %% Robert's scanner returns &quot;&quot; as LeftoverChars;
<a name="613"/>  613:     %% the R12B scanner returns eof as LeftoverChars: (eof is correct)
<a name="614"/>  614:     {more, C5} = erl_scan:tokens([], &quot;a&quot;, 1),
<a name="615"/>  615:     %% An error before R13A.
<a name="616"/>  616:     %% {done,{error,{1,erl_scan,scan},1},eof} =
<a name="617"/>  617:     {done,{ok,[{atom,1,a}],1},eof} =
<a name="618"/>  618:         erl_scan_tokens(C5,eof,1),
<a name="619"/>  619: 
<a name="620"/>  620:     %% With column.
<a name="621"/>  621:     {more, C6} = erl_scan:tokens([], &quot;a&quot;, {1,1}),
<a name="622"/>  622:     %% An error before R13A.
<a name="623"/>  623:     %% {done,{error,{1,erl_scan,scan},1},eof} =
<a name="624"/>  624:     {done,{ok,[{atom,{1,1},a}],{1,2}},eof} =
<a name="625"/>  625:         erl_scan_tokens(C6,eof,1),
<a name="626"/>  626: 
<a name="627"/>  627:     %% A dot followed by eof is special:
<a name="628"/>  628:     {more, C} = erl_scan:tokens([], &quot;a.&quot;, 1),
<a name="629"/>  629:     {done,{ok,[{atom,1,a},{dot,1}],1},eof} = erl_scan_tokens(C,eof,1),
<a name="630"/>  630:     {ok,[{atom,1,foo},{dot,1}],1} = erl_scan_string(&quot;foo.&quot;),
<a name="631"/>  631: 
<a name="632"/>  632:     %% With column.
<a name="633"/>  633:     {more, CCol} = erl_scan:tokens([], &quot;a.&quot;, {1,1}),
<a name="634"/>  634:     {done,{ok,[{atom,{1,1},a},{dot,{1,2}}],{1,3}},eof} =
<a name="635"/>  635:         erl_scan_tokens(CCol,eof,1),
<a name="636"/>  636:     {ok,[{atom,{1,1},foo},{dot,{1,4}}],{1,5}} =
<a name="637"/>  637:         erl_scan_string(&quot;foo.&quot;, {1,1}, []),
<a name="638"/>  638: 
<a name="eof-last_expr"/><a name="639"/>  639:     ok.
<a name="640"/>  640: 
<a name="illegal-0"/><a name="641"/>  641: <b>illegal</b>() -&gt;
<a name="642"/>  642:     Atom = lists:duplicate(1000, $a),
<a name="643"/>  643:     {error,{1,erl_scan,{illegal,atom}},1} = erl_scan:string(Atom),
<a name="644"/>  644:     {done,{error,{1,erl_scan,{illegal,atom}},1},&quot;. &quot;} =
<a name="645"/>  645:         erl_scan:tokens([], Atom++&quot;. &quot;, 1),
<a name="646"/>  646:     QAtom = &quot;'&quot; ++ Atom ++ &quot;'&quot;,
<a name="647"/>  647:     {error,{1,erl_scan,{illegal,atom}},1} = erl_scan:string(QAtom),
<a name="648"/>  648:     {done,{error,{1,erl_scan,{illegal,atom}},1},&quot;. &quot;} =
<a name="649"/>  649:         erl_scan:tokens([], QAtom++&quot;. &quot;, 1),
<a name="650"/>  650:     Var = lists:duplicate(1000, $A),
<a name="651"/>  651:     {error,{1,erl_scan,{illegal,var}},1} = erl_scan:string(Var),
<a name="652"/>  652:     {done,{error,{1,erl_scan,{illegal,var}},1},&quot;. &quot;} =
<a name="653"/>  653:         erl_scan:tokens([], Var++&quot;. &quot;, 1),
<a name="654"/>  654:     Float = &quot;1&quot; ++ lists:duplicate(400, $0) ++ &quot;.0&quot;,
<a name="655"/>  655:     {error,{1,erl_scan,{illegal,float}},1} = erl_scan:string(Float),
<a name="656"/>  656:     {done,{error,{1,erl_scan,{illegal,float}},1},&quot;. &quot;} =
<a name="657"/>  657:         erl_scan:tokens([], Float++&quot;. &quot;, 1),
<a name="658"/>  658:     String = &quot;\&quot;43\\x{aaaaaa}34\&quot;&quot;,
<a name="659"/>  659:     {error,{1,erl_scan,{illegal,character}},1} = erl_scan:string(String),
<a name="660"/>  660:     {done,{error,{1,erl_scan,{illegal,character}},1},&quot;34\&quot;. &quot;} =
<a name="661"/>  661:         %% Would be nice if `34\&quot;' were skipped...
<a name="662"/>  662:         %% Maybe, but then the LeftOverChars would not be the characters
<a name="663"/>  663:         %% immediately following the end location of the error.
<a name="664"/>  664:         erl_scan:tokens([], String++&quot;. &quot;, 1),
<a name="665"/>  665: 
<a name="666"/>  666:     {error,{{1,1},erl_scan,{illegal,atom}},{1,1001}} =
<a name="667"/>  667:         erl_scan:string(Atom, {1,1}),
<a name="668"/>  668:     {done,{error,{{1,5},erl_scan,{illegal,atom}},{1,1005}},&quot;. &quot;} =
<a name="669"/>  669:         erl_scan:tokens([], &quot;foo &quot;++Atom++&quot;. &quot;, {1,1}),
<a name="670"/>  670:     {error,{{1,1},erl_scan,{illegal,atom}},{1,1003}} =
<a name="671"/>  671:         erl_scan:string(QAtom, {1,1}),
<a name="672"/>  672:     {done,{error,{{1,5},erl_scan,{illegal,atom}},{1,1007}},&quot;. &quot;} =
<a name="673"/>  673:         erl_scan:tokens([], &quot;foo &quot;++QAtom++&quot;. &quot;, {1,1}),
<a name="674"/>  674:     {error,{{1,1},erl_scan,{illegal,var}},{1,1001}} =
<a name="675"/>  675:         erl_scan:string(Var, {1,1}),
<a name="676"/>  676:     {done,{error,{{1,5},erl_scan,{illegal,var}},{1,1005}},&quot;. &quot;} =
<a name="677"/>  677:         erl_scan:tokens([], &quot;foo &quot;++Var++&quot;. &quot;, {1,1}),
<a name="678"/>  678:     {error,{{1,1},erl_scan,{illegal,float}},{1,404}} =
<a name="679"/>  679:         erl_scan:string(Float, {1,1}),
<a name="680"/>  680:     {done,{error,{{1,5},erl_scan,{illegal,float}},{1,408}},&quot;. &quot;} =
<a name="681"/>  681:         erl_scan:tokens([], &quot;foo &quot;++Float++&quot;. &quot;, {1,1}),
<a name="682"/>  682:     {error,{{1,4},erl_scan,{illegal,character}},{1,14}} =
<a name="683"/>  683:         erl_scan:string(String, {1,1}),
<a name="684"/>  684:     {done,{error,{{1,4},erl_scan,{illegal,character}},{1,14}},&quot;34\&quot;. &quot;} =
<a name="685"/>  685:         erl_scan:tokens([], String++&quot;. &quot;, {1,1}),
<a name="686"/>  686: 
<a name="687"/>  687:     %% GH-6477. Test for illegal characters in caret notation.
<a name="688"/>  688:     _ = [begin
<a name="689"/>  689:              S = [$$,$\\,$^,C],
<a name="690"/>  690:              {error,{1,erl_scan,{illegal,character}},1} = erl_scan:string(S)
<a name="691"/>  691:          end || C &lt;- lists:seq(0, 16#3e) ++ [16#60] ++ lists:seq($z+1, 16#10ffff)],
<a name="illegal-last_expr"/><a name="692"/>  692:     ok.
<a name="693"/>  693: 
<a name="crashes-0"/><a name="694"/>  694: <b>crashes</b>() -&gt;
<a name="695"/>  695:     {'EXIT',_} = (catch {foo, erl_scan:string([-1])}), % type error
<a name="696"/>  696:     {'EXIT',_} = (catch erl_scan:string(&quot;'a&quot; ++ [999999999] ++ &quot;c'&quot;)),
<a name="697"/>  697: 
<a name="698"/>  698:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$&quot;++[-1])}),
<a name="699"/>  699:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$\\&quot;++[-1])}),
<a name="700"/>  700:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$\\^&quot;++[-1])}),
<a name="701"/>  701:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,-1,$&quot;],{1,1})}),
<a name="702"/>  702:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;\&quot;\\v&quot;++[-1,$&quot;])}), %$&quot;
<a name="703"/>  703:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,-1,$&quot;])}),
<a name="704"/>  704:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;% foo&quot;++[-1])}),
<a name="705"/>  705:     {'EXIT',_} =
<a name="706"/>  706:          (catch {foo, erl_scan:string(&quot;% foo&quot;++[-1],{1,1})}),
<a name="707"/>  707: 
<a name="708"/>  708:     {'EXIT',_} = (catch {foo, erl_scan:string([a])}), % type error
<a name="709"/>  709:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$&quot;++[a])}),
<a name="710"/>  710:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$\\&quot;++[a])}),
<a name="711"/>  711:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;$\\^&quot;++[a])}),
<a name="712"/>  712:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,a,$&quot;],{1,1})}),
<a name="713"/>  713:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;\&quot;\\v&quot;++[a,$&quot;])}), %$&quot;
<a name="714"/>  714:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,a,$&quot;])}),
<a name="715"/>  715:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;% foo&quot;++[a])}),
<a name="716"/>  716:     {'EXIT',_} =
<a name="717"/>  717:          (catch {foo, erl_scan:string(&quot;% foo&quot;++[a],{1,1})}),
<a name="718"/>  718: 
<a name="719"/>  719:     {'EXIT',_} = (catch {foo, erl_scan:string([3.0])}), % type error
<a name="720"/>  720:     {'EXIT',_} = (catch {foo, erl_scan:string(&quot;A&quot; ++ [999999999])}),
<a name="721"/>  721: 
<a name="crashes-last_expr"/><a name="722"/>  722:     ok.
<a name="723"/>  723: 
<a name="options-0"/><a name="724"/>  724: <b>options</b>() -&gt;
<a name="725"/>  725:     %% line and column are not options, but tested here
<a name="726"/>  726:     {ok,[{atom,1,foo},{white_space,1,&quot; &quot;},{comment,1,&quot;% bar&quot;}], 1} =
<a name="727"/>  727:         erl_scan_string(&quot;foo % bar&quot;, 1, return),
<a name="728"/>  728:     {ok,[{atom,1,foo},{white_space,1,&quot; &quot;}],1} =
<a name="729"/>  729:         erl_scan_string(&quot;foo % bar&quot;, 1, return_white_spaces),
<a name="730"/>  730:     {ok,[{atom,1,foo},{comment,1,&quot;% bar&quot;}],1} =
<a name="731"/>  731:         erl_scan_string(&quot;foo % bar&quot;, 1, return_comments),
<a name="732"/>  732:     {ok,[{atom,17,foo}],17} =
<a name="733"/>  733:         erl_scan_string(&quot;foo % bar&quot;, 17),
<a name="734"/>  734:     {'EXIT',{function_clause,_}} =
<a name="735"/>  735:         (catch {foo,
<a name="736"/>  736:                 erl_scan:string(&quot;foo % bar&quot;, {a,1}, [])}), % type error
<a name="737"/>  737:     {ok,[{atom,_,foo}],{17,18}} =
<a name="738"/>  738:         erl_scan_string(&quot;foo % bar&quot;, {17,9}, []),
<a name="739"/>  739:     {'EXIT',{function_clause,_}} =
<a name="740"/>  740:         (catch {foo,
<a name="741"/>  741:                 erl_scan:string(&quot;foo % bar&quot;, {1,0}, [])}), % type error
<a name="742"/>  742:     {ok,[{foo,1}],1} =
<a name="743"/>  743:         erl_scan_string(&quot;foo % bar&quot;,1, [{reserved_word_fun,
<a name="744"/>  744:                                          fun(W) -&gt; W =:= foo end}]),
<a name="745"/>  745:     {'EXIT',{badarg,_}} =
<a name="746"/>  746:         (catch {foo,
<a name="747"/>  747:                 erl_scan:string(&quot;foo % bar&quot;,1, % type error
<a name="748"/>  748:                                 [{reserved_word_fun,
<a name="749"/>  749:                                   fun(W,_) -&gt; W =:= foo end}])}),
<a name="options-last_expr"/><a name="750"/>  750:     ok.
<a name="751"/>  751: 
<a name="more_options-0"/><a name="752"/>  752: <b>more_options</b>() -&gt;
<a name="753"/>  753:     {ok,[{atom,_,foo}=T1],{19,20}} =
<a name="754"/>  754:         erl_scan:string(&quot;foo&quot;, {19,17},[]),
<a name="755"/>  755:     {19,17} = erl_scan:location(T1),
<a name="756"/>  756:     {done,{ok,[{atom,_,foo}=T2,{dot,_}],{19,22}},[]} =
<a name="757"/>  757:         erl_scan:tokens([], &quot;foo. &quot;, {19,17}, [bad_opt]), % type error
<a name="758"/>  758:     {19,17} = erl_scan:location(T2),
<a name="759"/>  759:     {ok,[{atom,_,foo}=T3],{19,20}} =
<a name="760"/>  760:         erl_scan:string(&quot;foo&quot;, {19,17},[text]),
<a name="761"/>  761:     {19,17} = erl_scan:location(T3),
<a name="762"/>  762:     &quot;foo&quot; = erl_scan:text(T3),
<a name="763"/>  763: 
<a name="764"/>  764:     {ok,[{atom,_,foo}=T4],1} = erl_scan:string(&quot;foo&quot;, 1, [text]),
<a name="765"/>  765:     1 = erl_scan:line(T4),
<a name="766"/>  766:     1 = erl_scan:location(T4),
<a name="767"/>  767:     &quot;foo&quot; = erl_scan:text(T4),
<a name="768"/>  768: 
<a name="more_options-last_expr"/><a name="769"/>  769:     ok.
<a name="770"/>  770: 
<a name="token_info-0"/><a name="771"/>  771: <b>token_info</b>() -&gt;
<a name="772"/>  772:     {ok,[T1],_} = erl_scan:string(&quot;foo&quot;, {1,18}, [text]),
<a name="773"/>  773:     {'EXIT',{badarg,_}} =
<a name="774"/>  774:         (catch {foo, erl_scan:category(foo)}), % type error
<a name="775"/>  775:     {'EXIT',{badarg,_}} =
<a name="776"/>  776:         (catch {foo, erl_scan:symbol(foo)}), % type error
<a name="777"/>  777:     atom = erl_scan:category(T1),
<a name="778"/>  778:     foo = erl_scan:symbol(T1),
<a name="779"/>  779: 
<a name="780"/>  780:     {ok,[T2],_} = erl_scan:string(&quot;foo&quot;, 1, []),
<a name="781"/>  781:     1 = erl_scan:line(T2),
<a name="782"/>  782:     undefined = erl_scan:column(T2),
<a name="783"/>  783:     undefined = erl_scan:text(T2),
<a name="784"/>  784:     1 = erl_scan:location(T2),
<a name="785"/>  785: 
<a name="786"/>  786:     {ok,[T3],_} = erl_scan:string(&quot;=&quot;, 1, []),
<a name="787"/>  787:     '=' = erl_scan:category(T3),
<a name="788"/>  788:     '=' = erl_scan:symbol(T3),
<a name="token_info-last_expr"/><a name="789"/>  789:     ok.
<a name="790"/>  790: 
<a name="anno_info-0"/><a name="791"/>  791: <b>anno_info</b>() -&gt;
<a name="792"/>  792:     {'EXIT',_} =
<a name="793"/>  793:         (catch {foo,erl_scan:line(foo)}), % type error
<a name="794"/>  794:     {ok,[{atom,_,foo}=T0],_} = erl_scan:string(&quot;foo&quot;, 19, [text]),
<a name="795"/>  795:     19 = erl_scan:location(T0),
<a name="796"/>  796:     19 = erl_scan:end_location(T0),
<a name="797"/>  797: 
<a name="798"/>  798:     {ok,[{atom,_,foo}=T3],_} = erl_scan:string(&quot;foo&quot;, {1,3}, [text]),
<a name="799"/>  799:     1 = erl_scan:line(T3),
<a name="800"/>  800:     3 = erl_scan:column(T3),
<a name="801"/>  801:     {1,3} = erl_scan:location(T3),
<a name="802"/>  802:     {1,6} = erl_scan:end_location(T3),
<a name="803"/>  803:     &quot;foo&quot; = erl_scan:text(T3),
<a name="804"/>  804: 
<a name="805"/>  805:     {ok,[{atom,_,foo}=T4],_} = erl_scan:string(&quot;foo&quot;, 2, [text]),
<a name="806"/>  806:     2 = erl_scan:line(T4),
<a name="807"/>  807:     undefined = erl_scan:column(T4),
<a name="808"/>  808:     2 = erl_scan:location(T4),
<a name="809"/>  809:     &quot;foo&quot; = erl_scan:text(T4),
<a name="810"/>  810: 
<a name="811"/>  811:     {ok,[{atom,_,foo}=T5],_} = erl_scan:string(&quot;foo&quot;, {1,3}, []),
<a name="812"/>  812:     1 = erl_scan:line(T5),
<a name="813"/>  813:     3 = erl_scan:column(T5),
<a name="814"/>  814:     {1,3} = erl_scan:location(T5),
<a name="815"/>  815:     undefined = erl_scan:text(T5),
<a name="816"/>  816: 
<a name="anno_info-last_expr"/><a name="817"/>  817:     ok.
<a name="818"/>  818: 
<a name="column_errors-0"/><a name="819"/>  819: <b>column_errors</b>() -&gt;
<a name="820"/>  820:     {error,{{1,2},erl_scan,{unterminated,atom,&quot;&quot;}},{1,3}} = % $'
<a name="821"/>  821:         erl_scan:string(&quot;'\\&quot;,{1,1}),
<a name="822"/>  822:     {error,{{1,2},erl_scan,{unterminated,string,&quot;&quot;}},{1,3}} = % $&quot;
<a name="823"/>  823:         erl_scan:string(&quot;\&quot;\\&quot;,{1,1}),
<a name="824"/>  824: 
<a name="825"/>  825:     {error,{{1,2},erl_scan,{unterminated,atom,&quot;&quot;}},{1,2}} =  % $'
<a name="826"/>  826:         erl_scan:string(&quot;'&quot;,{1,1}),
<a name="827"/>  827:     {error,{{1,2},erl_scan,{unterminated,string,&quot;&quot;}},{1,2}} =  % $&quot;
<a name="828"/>  828:         erl_scan:string(&quot;\&quot;&quot;,{1,1}),
<a name="829"/>  829: 
<a name="830"/>  830:     {error,{{1,1},erl_scan,{unterminated,char}},{1,2}} =
<a name="831"/>  831:         erl_scan:string(&quot;$&quot;,{1,1}),
<a name="832"/>  832: 
<a name="833"/>  833:     {error,{{1,3},erl_scan,
<a name="834"/>  834:             {unterminated,atom,&quot;1234567890123456&quot;}},{1,20}} = %'
<a name="835"/>  835:         erl_scan:string(&quot; '12345678901234567&quot;, {1,1}),
<a name="836"/>  836:     {error,{{1,3},erl_scan,
<a name="837"/>  837:             {unterminated,atom,&quot;123456789012345 &quot;}}, {1,20}} = %'
<a name="838"/>  838:         erl_scan:string(&quot; '123456789012345\\s&quot;, {1,1}),
<a name="839"/>  839:     {error,{{1,3},erl_scan,
<a name="840"/>  840:             {unterminated,string,&quot;1234567890123456&quot;}},{1,20}} = %&quot;
<a name="841"/>  841:         erl_scan:string(&quot; \&quot;12345678901234567&quot;, {1,1}),
<a name="842"/>  842:     {error,{{1,3},erl_scan,
<a name="843"/>  843:             {unterminated,string,&quot;123456789012345 &quot;}}, {1,20}} = %&quot;
<a name="844"/>  844:         erl_scan:string(&quot; \&quot;123456789012345\\s&quot;, {1,1}),
<a name="845"/>  845:     {error,{{1,3},erl_scan,
<a name="846"/>  846:             {unterminated,atom,&quot;1234567890123456&quot;}},{2,1}} = %'
<a name="847"/>  847:         erl_scan:string(&quot; '12345678901234567\n&quot;, {1,1}),
<a name="column_errors-last_expr"/><a name="848"/>  848:     ok.
<a name="849"/>  849: 
<a name="white_spaces-0"/><a name="850"/>  850: <b>white_spaces</b>() -&gt;
<a name="851"/>  851:     {ok,[{white_space,_,&quot;\r&quot;},
<a name="852"/>  852:                {white_space,_,&quot;   &quot;},
<a name="853"/>  853:                {atom,_,a},
<a name="854"/>  854:                {white_space,_,&quot;\n&quot;}],
<a name="855"/>  855:            _} = erl_scan_string(&quot;\r   a\n&quot;, {1,1}, return),
<a name="856"/>  856:     test(&quot;\r   a\n&quot;),
<a name="857"/>  857:     L = &quot;{\&quot;a\nb\&quot;, \&quot;a\\nb\&quot;,\nabc\r,def}.\n\n&quot;,
<a name="858"/>  858:     {ok,[{'{',_},
<a name="859"/>  859:                {string,_,&quot;a\nb&quot;},
<a name="860"/>  860:                {',',_},
<a name="861"/>  861:                {white_space,_,&quot; &quot;},
<a name="862"/>  862:                {string,_,&quot;a\nb&quot;},
<a name="863"/>  863:                {',',_},
<a name="864"/>  864:                {white_space,_,&quot;\n&quot;},
<a name="865"/>  865:                {atom,_,abc},
<a name="866"/>  866:                {white_space,_,&quot;\r&quot;},
<a name="867"/>  867:                {',',_},
<a name="868"/>  868:                {atom,_,def},
<a name="869"/>  869:                {'}',_},
<a name="870"/>  870:                {dot,_},
<a name="871"/>  871:                {white_space,_,&quot;\n&quot;}],
<a name="872"/>  872:            _} = erl_scan_string(L, {1,1}, return),
<a name="873"/>  873:     test(L),
<a name="874"/>  874:     test(&quot;\&quot;\n\&quot;\n&quot;),
<a name="875"/>  875:     test(&quot;\n\r\n&quot;),
<a name="876"/>  876:     test(&quot;\n\r&quot;),
<a name="877"/>  877:     test(&quot;\r\n&quot;),
<a name="878"/>  878:     test(&quot;\n\f&quot;),
<a name="879"/>  879:     [test(lists:duplicate(N, $\t)) || N &lt;- lists:seq(1, 20)],
<a name="880"/>  880:     [test([$\n|lists:duplicate(N, $\t)]) || N &lt;- lists:seq(1, 20)],
<a name="881"/>  881:     [test(lists:duplicate(N, $\s)) || N &lt;- lists:seq(1, 20)],
<a name="882"/>  882:     [test([$\n|lists:duplicate(N, $\s)]) || N &lt;- lists:seq(1, 20)],
<a name="883"/>  883:     test(&quot;\v\f\n\v &quot;),
<a name="884"/>  884:     test(&quot;\n\e\n\b\f\n\da\n&quot;),
<a name="white_spaces-last_expr"/><a name="885"/>  885:     ok.
<a name="886"/>  886: 
<a name="unicode-0"/><a name="887"/>  887: <b>unicode</b>() -&gt;
<a name="888"/>  888:     {ok,[{char,1,83},{integer,1,45}],1} =
<a name="889"/>  889:         erl_scan_string(&quot;$\\12345&quot;), % not unicode
<a name="890"/>  890: 
<a name="891"/>  891:     {error,{1,erl_scan,{illegal,character}},1} =
<a name="892"/>  892:         erl_scan:string([1089]),
<a name="893"/>  893:     {error,{{1,1},erl_scan,{illegal,character}},{1,2}} =
<a name="894"/>  894:         erl_scan:string([1089], {1,1}),
<a name="895"/>  895:     {error,{{1,1},erl_scan,{illegal,character}},{1,2}} =
<a name="896"/>  896:         erl_scan:string([16#D800], {1,1}),
<a name="897"/>  897: 
<a name="898"/>  898:     test(&quot;\&quot;a&quot;++[1089]++&quot;b\&quot;&quot;),
<a name="899"/>  899:     {error,{1,erl_scan,{illegal,character}},1} =
<a name="900"/>  900:         erl_scan_string([$$,$\\,$^,1089], 1),
<a name="901"/>  901: 
<a name="902"/>  902:     {error,{1,erl_scan,Error},1} =
<a name="903"/>  903:         erl_scan:string(&quot;\&quot;qa\x{aaa}&quot;, 1),
<a name="904"/>  904:     &quot;unterminated string starting with \&quot;qa&quot;++[2730]++&quot;\&quot;&quot; =
<a name="905"/>  905:         erl_scan:format_error(Error),
<a name="906"/>  906:     {error,{{1,2},erl_scan,_},{1,11}} =
<a name="907"/>  907:         erl_scan:string(&quot;\&quot;qa\\x{aaa}&quot;,{1,1}),
<a name="908"/>  908:     {error,{{1,2},erl_scan,_},{1,11}} =
<a name="909"/>  909:         erl_scan:string(&quot;'qa\\x{aaa}&quot;,{1,1}),
<a name="910"/>  910: 
<a name="911"/>  911:     {ok,[{char,1,1089}],1} =
<a name="912"/>  912:         erl_scan_string([$$,1089], 1),
<a name="913"/>  913:     {ok,[{char,1,1089}],1} =
<a name="914"/>  914:         erl_scan_string([$$,$\\,1089], 1),
<a name="915"/>  915: 
<a name="916"/>  916:     Qs = &quot;$\\x{aaa}&quot;,
<a name="917"/>  917:     {ok,[{char,1,$\x{aaa}}],1} =
<a name="918"/>  918:         erl_scan_string(Qs, 1),
<a name="919"/>  919:     {ok,[Q2],{1,9}} =
<a name="920"/>  920:         erl_scan:string(&quot;$\\x{aaa}&quot;, {1,1}, [text]),
<a name="921"/>  921:     [{category,char},{column,1},{line,1},{symbol,16#aaa},{text,Qs}] =
<a name="922"/>  922:         token_info_long(Q2),
<a name="923"/>  923: 
<a name="924"/>  924:     U1 = &quot;\&quot;\\x{aaa}\&quot;&quot;,
<a name="925"/>  925:     {ok,[{string,_,[2730]}=T1],{1,10}} = erl_scan:string(U1, {1,1}, [text]),
<a name="926"/>  926:     {1,1} = erl_scan:location(T1),
<a name="927"/>  927:     &quot;\&quot;\\x{aaa}\&quot;&quot; = erl_scan:text(T1),
<a name="928"/>  928:     {ok,[{string,1,[2730]}],1} = erl_scan_string(U1, 1),
<a name="929"/>  929: 
<a name="930"/>  930:     U2 = &quot;\&quot;\\x41\\x{fff}\\x42\&quot;&quot;,
<a name="931"/>  931:     {ok,[{string,1,[$\x41,$\x{fff},$\x42]}],1} = erl_scan_string(U2, 1),
<a name="932"/>  932: 
<a name="933"/>  933:     U3 = &quot;\&quot;a\n\\x{fff}\n\&quot;&quot;,
<a name="934"/>  934:     {ok,[{string,1,[$a,$\n,$\x{fff},$\n]}],3} = erl_scan_string(U3, 1),
<a name="935"/>  935: 
<a name="936"/>  936:     U4 = &quot;\&quot;\n\\x{aaa}\n\&quot;&quot;,
<a name="937"/>  937:     {ok,[{string,1,[$\n,$\x{aaa},$\n]}],3} = erl_scan_string(U4, 1),
<a name="938"/>  938: 
<a name="939"/>  939:     %% Keep these tests:
<a name="940"/>  940:     test(Qs),
<a name="941"/>  941:     test(U1),
<a name="942"/>  942:     test(U2),
<a name="943"/>  943:     test(U3),
<a name="944"/>  944:     test(U4),
<a name="945"/>  945: 
<a name="946"/>  946:     Str1 = &quot;\&quot;ab&quot; ++ [1089] ++ &quot;cd\&quot;&quot;,
<a name="947"/>  947:     {ok,[{string,1,[$a,$b,1089,$c,$d]}],1} = erl_scan_string(Str1, 1),
<a name="948"/>  948:     {ok,[{string,{1,1},[$a,$b,1089,$c,$d]}],{1,8}} =
<a name="949"/>  949:         erl_scan_string(Str1, {1,1}),
<a name="950"/>  950:     test(Str1),
<a name="951"/>  951:     Comment = &quot;%% &quot;++[1089],
<a name="952"/>  952:     {ok,[{comment,1,[$%,$%,$\s,1089]}],1} =
<a name="953"/>  953:         erl_scan_string(Comment, 1, [return]),
<a name="954"/>  954:     {ok,[{comment,{1,1},[$%,$%,$\s,1089]}],{1,5}} =
<a name="955"/>  955:         erl_scan_string(Comment, {1,1}, [return]),
<a name="unicode-last_expr"/><a name="956"/>  956:     ok.
<a name="957"/>  957: 
<a name="more_chars-0"/><a name="958"/>  958: <b>more_chars</b>() -&gt;
<a name="959"/>  959:     %% Due to unicode, the syntax has been incompatibly augmented:
<a name="960"/>  960:     %% $\x{...}, $\xHH
<a name="961"/>  961: 
<a name="962"/>  962:     %% All kinds of tests...
<a name="963"/>  963:     {ok,[{char,_,123}],{1,4}} =
<a name="964"/>  964:         erl_scan_string(&quot;$\\{&quot;,{1,1}),
<a name="965"/>  965:     {more, C1} = erl_scan:tokens([], &quot;$\\{&quot;, {1,1}),
<a name="966"/>  966:     {done,{ok,[{char,_,123}],{1,4}},eof} =
<a name="967"/>  967:         erl_scan_tokens(C1, eof, 1),
<a name="968"/>  968:     {ok,[{char,1,123},{atom,1,a},{'}',1}],1} =
<a name="969"/>  969:         erl_scan_string(&quot;$\\{a}&quot;),
<a name="970"/>  970: 
<a name="971"/>  971:     {error,{{1,1},erl_scan,{unterminated,char}},{1,4}} =
<a name="972"/>  972:         erl_scan:string(&quot;$\\x&quot;, {1,1}),
<a name="973"/>  973:     {error,{{1,1},erl_scan,{unterminated,char}},{1,5}} =
<a name="974"/>  974:         erl_scan:string(&quot;$\\x{&quot;,{1,1}),
<a name="975"/>  975:     {more, C3} = erl_scan:tokens([], &quot;$\\x&quot;, {1,1}),
<a name="976"/>  976:     {done,{error,{{1,1},erl_scan,{unterminated,char}},{1,4}},eof} =
<a name="977"/>  977:         erl_scan:tokens(C3, eof, 1),
<a name="978"/>  978:     {error,{{1,1},erl_scan,{unterminated,char}},{1,5}} =
<a name="979"/>  979:         erl_scan:string(&quot;$\\x{&quot;,{1,1}),
<a name="980"/>  980:     {more, C2} = erl_scan:tokens([], &quot;$\\x{&quot;, {1,1}),
<a name="981"/>  981:     {done,{error,{{1,1},erl_scan,{unterminated,char}},{1,5}},eof} =
<a name="982"/>  982:         erl_scan:tokens(C2, eof, 1),
<a name="983"/>  983:     {error,{1,erl_scan,{illegal,character}},1} =
<a name="984"/>  984:         erl_scan:string(&quot;$\\x{g}&quot;),
<a name="985"/>  985:     {error,{{1,1},erl_scan,{illegal,character}},{1,5}} =
<a name="986"/>  986:         erl_scan:string(&quot;$\\x{g}&quot;, {1,1}),
<a name="987"/>  987:     {error,{{1,1},erl_scan,{illegal,character}},{1,6}} =
<a name="988"/>  988:         erl_scan:string(&quot;$\\x{}&quot;,{1,1}),
<a name="989"/>  989: 
<a name="990"/>  990:     test(&quot;\&quot;\\{0}\&quot;&quot;),
<a name="991"/>  991:     test(&quot;\&quot;\\x{0}\&quot;&quot;),
<a name="992"/>  992:     test(&quot;\'\\{0}\'&quot;),
<a name="993"/>  993:     test(&quot;\'\\x{0}\'&quot;),
<a name="994"/>  994: 
<a name="995"/>  995:     {error,{{2,3},erl_scan,{illegal,character}},{2,6}} =
<a name="996"/>  996:         erl_scan:string(&quot;\&quot;ab \n $\\x{g}\&quot;&quot;,{1,1}),
<a name="997"/>  997:     {error,{{2,3},erl_scan,{illegal,character}},{2,6}} =
<a name="998"/>  998:         erl_scan:string(&quot;\'ab \n $\\x{g}\'&quot;,{1,1}),
<a name="999"/>  999: 
<a name="1000"/> 1000:     test(&quot;$\\{34}&quot;),
<a name="1001"/> 1001:     test(&quot;$\\x{34}&quot;),
<a name="1002"/> 1002:     test(&quot;$\\{377}&quot;),
<a name="1003"/> 1003:     test(&quot;$\\x{FF}&quot;),
<a name="1004"/> 1004:     test(&quot;$\\{400}&quot;),
<a name="1005"/> 1005:     test(&quot;$\\x{100}&quot;),
<a name="1006"/> 1006:     test(&quot;$\\x{10FFFF}&quot;),
<a name="1007"/> 1007:     test(&quot;$\\x{10ffff}&quot;),
<a name="1008"/> 1008:     test(&quot;\&quot;$\n \\{1}\&quot;&quot;),
<a name="1009"/> 1009:     {error,{1,erl_scan,{illegal,character}},1} =
<a name="1010"/> 1010:         erl_scan:string(&quot;$\\x{110000}&quot;),
<a name="1011"/> 1011:     {error,{{1,1},erl_scan,{illegal,character}},{1,12}} =
<a name="1012"/> 1012:         erl_scan:string(&quot;$\\x{110000}&quot;, {1,1}),
<a name="1013"/> 1013: 
<a name="1014"/> 1014:     {error,{{1,1},erl_scan,{illegal,character}},{1,4}} =
<a name="1015"/> 1015:         erl_scan:string(&quot;$\\xfg&quot;, {1,1}),
<a name="1016"/> 1016: 
<a name="1017"/> 1017:     test(&quot;$\\xffg&quot;),
<a name="1018"/> 1018: 
<a name="1019"/> 1019:     {error,{{1,1},erl_scan,{illegal,character}},{1,4}} =
<a name="1020"/> 1020:         erl_scan:string(&quot;$\\xg&quot;, {1,1}),
<a name="more_chars-last_expr"/><a name="1021"/> 1021:     ok.
<a name="1022"/> 1022: 
<a name="1023"/> 1023: <i>%% OTP-10302. Unicode characters scanner/parser.</i>
<a name="otp_10302-1"/><a name="1024"/> 1024: <b>otp_10302</b>(Config) when is_list(Config) -&gt;
<a name="1025"/> 1025:     %% From unicode():
<a name="1026"/> 1026:     {ok,[{atom,1,'aсb'}],1} =
<a name="1027"/> 1027:         erl_scan_string(&quot;'a&quot;++[1089]++&quot;b'&quot;, 1),
<a name="1028"/> 1028:     {ok,[{atom,{1,1},'qaપ'}],{1,12}} =
<a name="1029"/> 1029:         erl_scan_string(&quot;'qa\\x{aaa}'&quot;,{1,1}),
<a name="1030"/> 1030: 
<a name="1031"/> 1031:     {ok,[{char,1,1089}],1} = erl_scan_string([$$,1089], 1),
<a name="1032"/> 1032:     {ok,[{char,1,1089}],1} = erl_scan_string([$$,$\\,1089],1),
<a name="1033"/> 1033: 
<a name="1034"/> 1034:     Qs = &quot;$\\x{aaa}&quot;,
<a name="1035"/> 1035:     {ok,[{char,1,2730}],1} = erl_scan_string(Qs, 1),
<a name="1036"/> 1036:     {ok,[Q2],{1,9}} = erl_scan:string(Qs,{1,1},[text]),
<a name="1037"/> 1037:     [{category,char},{column,1},{line,1},{symbol,16#aaa},{text,Qs}] =
<a name="1038"/> 1038:         token_info_long(Q2),
<a name="1039"/> 1039: 
<a name="1040"/> 1040:     U1 = &quot;\&quot;\\x{aaa}\&quot;&quot;,
<a name="1041"/> 1041:     {ok,[T1],{1,10}} = erl_scan:string(U1, {1,1}, [text]),
<a name="1042"/> 1042:     [{category,string},{column,1},{line,1},{symbol,[16#aaa]},{text,U1}] =
<a name="1043"/> 1043:         token_info_long(T1),
<a name="1044"/> 1044: 
<a name="1045"/> 1045:     U2 = &quot;\&quot;\\x41\\x{fff}\\x42\&quot;&quot;,
<a name="1046"/> 1046:     {ok,[{string,1,[65,4095,66]}],1} = erl_scan_string(U2, 1),
<a name="1047"/> 1047: 
<a name="1048"/> 1048:     U3 = &quot;\&quot;a\n\\x{fff}\n\&quot;&quot;,
<a name="1049"/> 1049:     {ok,[{string,1,[97,10,4095,10]}],3} = erl_scan_string(U3, 1),
<a name="1050"/> 1050: 
<a name="1051"/> 1051:     U4 = &quot;\&quot;\n\\x{aaa}\n\&quot;&quot;,
<a name="1052"/> 1052:     {ok,[{string,1,[10,2730,10]}],3} = erl_scan_string(U4, 1,[]),
<a name="1053"/> 1053: 
<a name="1054"/> 1054:     Str1 = &quot;\&quot;ab&quot; ++ [1089] ++ &quot;cd\&quot;&quot;,
<a name="1055"/> 1055:     {ok,[{string,1,[97,98,1089,99,100]}],1} =
<a name="1056"/> 1056:         erl_scan_string(Str1,1),
<a name="1057"/> 1057:     {ok,[{string,{1,1},[97,98,1089,99,100]}],{1,8}} =
<a name="1058"/> 1058:         erl_scan_string(Str1, {1,1}),
<a name="1059"/> 1059: 
<a name="1060"/> 1060:     OK1 = 16#D800-1,
<a name="1061"/> 1061:     OK2 = 16#DFFF+1,
<a name="1062"/> 1062:     OK3 = 16#FFFE-1,
<a name="1063"/> 1063:     OK4 = 16#FFFF+1,
<a name="1064"/> 1064:     OKL = [OK1,OK2,OK3,OK4],
<a name="1065"/> 1065: 
<a name="1066"/> 1066:     Illegal1 = 16#D800,
<a name="1067"/> 1067:     Illegal2 = 16#DFFF,
<a name="1068"/> 1068:     Illegal3 = 16#FFFE,
<a name="1069"/> 1069:     Illegal4 = 16#FFFF,
<a name="1070"/> 1070:     IllegalL = [Illegal1,Illegal2,Illegal3,Illegal4],
<a name="1071"/> 1071: 
<a name="1072"/> 1072:     [{ok,[{comment,1,[$%,$%,$\s,OK]}],1} =
<a name="1073"/> 1073:          erl_scan_string(&quot;%% &quot;++[OK], 1, [return]) ||
<a name="1074"/> 1074:         OK &lt;- OKL],
<a name="1075"/> 1075:     {ok,[{comment,_,[$%,$%,$\s,OK1]}],{1,5}} =
<a name="1076"/> 1076:         erl_scan_string(&quot;%% &quot;++[OK1], {1,1}, [return]),
<a name="1077"/> 1077:     [{error,{1,erl_scan,{illegal,character}},1} =
<a name="1078"/> 1078:          erl_scan:string(&quot;%% &quot;++[Illegal], 1, [return]) ||
<a name="1079"/> 1079:         Illegal &lt;- IllegalL],
<a name="1080"/> 1080:     {error,{{1,1},erl_scan,{illegal,character}},{1,5}} =
<a name="1081"/> 1081:         erl_scan:string(&quot;%% &quot;++[Illegal1], {1,1}, [return]),
<a name="1082"/> 1082: 
<a name="1083"/> 1083:     [{ok,[],1} = erl_scan_string(&quot;%% &quot;++[OK], 1, []) ||
<a name="1084"/> 1084:         OK &lt;- OKL],
<a name="1085"/> 1085:     {ok,[],{1,5}} = erl_scan_string(&quot;%% &quot;++[OK1], {1,1}, []),
<a name="1086"/> 1086:     [{error,{1,erl_scan,{illegal,character}},1} =
<a name="1087"/> 1087:          erl_scan:string(&quot;%% &quot;++[Illegal], 1, []) ||
<a name="1088"/> 1088:         Illegal &lt;- IllegalL],
<a name="1089"/> 1089:     {error,{{1,1},erl_scan,{illegal,character}},{1,5}} =
<a name="1090"/> 1090:         erl_scan:string(&quot;%% &quot;++[Illegal1], {1,1}, []),
<a name="1091"/> 1091: 
<a name="1092"/> 1092:     [{ok,[{string,{1,1},[OK]}],{1,4}} =
<a name="1093"/> 1093:         erl_scan_string(&quot;\&quot;&quot;++[OK]++&quot;\&quot;&quot;,{1,1}) ||
<a name="1094"/> 1094:         OK &lt;- OKL],
<a name="1095"/> 1095:     [{error,{{1,2},erl_scan,{illegal,character}},{1,3}} =
<a name="1096"/> 1096:          erl_scan:string(&quot;\&quot;&quot;++[OK]++&quot;\&quot;&quot;,{1,1}) ||
<a name="1097"/> 1097:         OK &lt;- IllegalL],
<a name="1098"/> 1098: 
<a name="1099"/> 1099:     [{error,{{1,1},erl_scan,{illegal,character}},{1,2}} =
<a name="1100"/> 1100:         erl_scan:string([Illegal],{1,1}) ||
<a name="1101"/> 1101:         Illegal &lt;- IllegalL],
<a name="1102"/> 1102: 
<a name="1103"/> 1103:     {ok,[{char,{1,1},OK1}],{1,3}} =
<a name="1104"/> 1104:         erl_scan_string([$$,OK1],{1,1}),
<a name="1105"/> 1105:     {error,{{1,1},erl_scan,{illegal,character}},{1,2}} =
<a name="1106"/> 1106:         erl_scan:string([$$,Illegal1],{1,1}),
<a name="1107"/> 1107: 
<a name="1108"/> 1108:     {ok,[{char,{1,1},OK1}],{1,4}} =
<a name="1109"/> 1109:         erl_scan_string([$$,$\\,OK1],{1,1}),
<a name="1110"/> 1110:     {error,{{1,1},erl_scan,{illegal,character}},{1,4}} =
<a name="1111"/> 1111:         erl_scan:string([$$,$\\,Illegal1],{1,1}),
<a name="1112"/> 1112: 
<a name="1113"/> 1113:     {ok,[{string,{1,1},[55295]}],{1,5}} =
<a name="1114"/> 1114:         erl_scan_string(&quot;\&quot;\\&quot;++[OK1]++&quot;\&quot;&quot;,{1,1}),
<a name="1115"/> 1115:     {error,{{1,2},erl_scan,{illegal,character}},{1,4}} =
<a name="1116"/> 1116:         erl_scan:string(&quot;\&quot;\\&quot;++[Illegal1]++&quot;\&quot;&quot;,{1,1}),
<a name="1117"/> 1117: 
<a name="1118"/> 1118:     {ok,[{char,{1,1},OK1}],{1,10}} =
<a name="1119"/> 1119:         erl_scan_string(&quot;$\\x{D7FF}&quot;,{1,1}),
<a name="1120"/> 1120:     {error,{{1,1},erl_scan,{illegal,character}},{1,10}} =
<a name="1121"/> 1121:         erl_scan:string(&quot;$\\x{D800}&quot;,{1,1}),
<a name="1122"/> 1122: 
<a name="1123"/> 1123:     %% Not erl_scan, but erl_parse.
<a name="1124"/> 1124:     {integer,0,1} = erl_parse_abstract(1),
<a name="1125"/> 1125:     Float = 3.14, {float,0,Float} = erl_parse_abstract(Float),
<a name="1126"/> 1126:     {nil,0} = erl_parse_abstract([]),
<a name="1127"/> 1127:     {bin,0,
<a name="1128"/> 1128:      [{bin_element,0,{integer,0,1},default,default},
<a name="1129"/> 1129:       {bin_element,0,{integer,0,2},default,default}]} =
<a name="1130"/> 1130:         erl_parse_abstract(&lt;&lt;1,2&gt;&gt;),
<a name="1131"/> 1131:     {cons,0,{tuple,0,[{atom,0,a}]},{atom,0,b}} =
<a name="1132"/> 1132:         erl_parse_abstract([{a} | b]),
<a name="1133"/> 1133:     {string,0,&quot;str&quot;} = erl_parse_abstract(&quot;str&quot;),
<a name="1134"/> 1134:     {cons,0,
<a name="1135"/> 1135:      {integer,0,$a},
<a name="1136"/> 1136:      {cons,0,{integer,0,55296},{string,0,&quot;c&quot;}}} =
<a name="1137"/> 1137:         erl_parse_abstract(&quot;a&quot;++[55296]++&quot;c&quot;),
<a name="1138"/> 1138: 
<a name="1139"/> 1139:     Line = 17,
<a name="1140"/> 1140:     {integer,Line,1} = erl_parse_abstract(1, Line),
<a name="1141"/> 1141:     Float = 3.14, {float,Line,Float} = erl_parse_abstract(Float, Line),
<a name="1142"/> 1142:     {nil,Line} = erl_parse_abstract([], Line),
<a name="1143"/> 1143:     {bin,Line,
<a name="1144"/> 1144:      [{bin_element,Line,{integer,Line,1},default,default},
<a name="1145"/> 1145:       {bin_element,Line,{integer,Line,2},default,default}]} =
<a name="1146"/> 1146:         erl_parse_abstract(&lt;&lt;1,2&gt;&gt;, Line),
<a name="1147"/> 1147:     {cons,Line,{tuple,Line,[{atom,Line,a}]},{atom,Line,b}} =
<a name="1148"/> 1148:         erl_parse_abstract([{a} | b], Line),
<a name="1149"/> 1149:     {string,Line,&quot;str&quot;} = erl_parse_abstract(&quot;str&quot;, Line),
<a name="1150"/> 1150:     {cons,Line,
<a name="1151"/> 1151:      {integer,Line,$a},
<a name="1152"/> 1152:      {cons,Line,{integer,Line,55296},{string,Line,&quot;c&quot;}}} =
<a name="1153"/> 1153:         erl_parse_abstract(&quot;a&quot;++[55296]++&quot;c&quot;, Line),
<a name="1154"/> 1154: 
<a name="1155"/> 1155:     Opts1 = [{line,17}],
<a name="1156"/> 1156:     {integer,Line,1} = erl_parse_abstract(1, Opts1),
<a name="1157"/> 1157:     Float = 3.14, {float,Line,Float} = erl_parse_abstract(Float, Opts1),
<a name="1158"/> 1158:     {nil,Line} = erl_parse_abstract([], Opts1),
<a name="1159"/> 1159:     {bin,Line,
<a name="1160"/> 1160:      [{bin_element,Line,{integer,Line,1},default,default},
<a name="1161"/> 1161:       {bin_element,Line,{integer,Line,2},default,default}]} =
<a name="1162"/> 1162:         erl_parse_abstract(&lt;&lt;1,2&gt;&gt;, Opts1),
<a name="1163"/> 1163:     {cons,Line,{tuple,Line,[{atom,Line,a}]},{atom,Line,b}} =
<a name="1164"/> 1164:         erl_parse_abstract([{a} | b], Opts1),
<a name="1165"/> 1165:     {string,Line,&quot;str&quot;} = erl_parse_abstract(&quot;str&quot;, Opts1),
<a name="1166"/> 1166:     {cons,Line,
<a name="1167"/> 1167:      {integer,Line,$a},
<a name="1168"/> 1168:      {cons,Line,{integer,Line,55296},{string,Line,&quot;c&quot;}}} =
<a name="1169"/> 1169:         erl_parse_abstract(&quot;a&quot;++[55296]++&quot;c&quot;, Opts1),
<a name="1170"/> 1170: 
<a name="1171"/> 1171:     [begin
<a name="1172"/> 1172:          {integer,Line,1} = erl_parse_abstract(1, Opts2),
<a name="1173"/> 1173:          Float = 3.14, {float,Line,Float} = erl_parse_abstract(Float, Opts2),
<a name="1174"/> 1174:          {nil,Line} = erl_parse_abstract([], Opts2),
<a name="1175"/> 1175:          {bin,Line,
<a name="1176"/> 1176:           [{bin_element,Line,{integer,Line,1},default,default},
<a name="1177"/> 1177:            {bin_element,Line,{integer,Line,2},default,default}]} =
<a name="1178"/> 1178:              erl_parse_abstract(&lt;&lt;1,2&gt;&gt;, Opts2),
<a name="1179"/> 1179:          {cons,Line,{tuple,Line,[{atom,Line,a}]},{atom,Line,b}} =
<a name="1180"/> 1180:              erl_parse_abstract([{a} | b], Opts2),
<a name="1181"/> 1181:          {string,Line,&quot;str&quot;} = erl_parse_abstract(&quot;str&quot;, Opts2),
<a name="1182"/> 1182:          {string,Line,[97,1024,99]} =
<a name="1183"/> 1183:              erl_parse_abstract(&quot;a&quot;++[1024]++&quot;c&quot;, Opts2)
<a name="1184"/> 1184:      end || Opts2 &lt;- [[{encoding,unicode},{line,Line}],
<a name="1185"/> 1185:                       [{encoding,utf8},{line,Line}]]],
<a name="1186"/> 1186: 
<a name="1187"/> 1187:     {cons,0,
<a name="1188"/> 1188:      {integer,0,97},
<a name="1189"/> 1189:      {cons,0,{integer,0,1024},{string,0,&quot;c&quot;}}} =
<a name="1190"/> 1190:         erl_parse_abstract(&quot;a&quot;++[1024]++&quot;c&quot;, [{encoding,latin1}]),
<a name="otp_10302-last_expr"/><a name="1191"/> 1191:     ok.
<a name="1192"/> 1192: 
<a name="1193"/> 1193: <i>%% OTP-10990. Floating point number in input string.</i>
<a name="otp_10990-1"/><a name="1194"/> 1194: <b>otp_10990</b>(Config) when is_list(Config) -&gt;
<a name="1195"/> 1195:     {'EXIT',_} = (catch {foo, erl_scan:string([$&quot;,42.0,$&quot;],1)}),
<a name="otp_10990-last_expr"/><a name="1196"/> 1196:     ok.
<a name="1197"/> 1197: 
<a name="1198"/> 1198: <i>%% OTP-10992. List of floats to abstract format.</i>
<a name="otp_10992-1"/><a name="1199"/> 1199: <b>otp_10992</b>(Config) when is_list(Config) -&gt;
<a name="1200"/> 1200:     {cons,0,{float,0,42.0},{nil,0}} =
<a name="1201"/> 1201:         erl_parse_abstract([42.0], [{encoding,unicode}]),
<a name="1202"/> 1202:     {cons,0,{float,0,42.0},{nil,0}} =
<a name="1203"/> 1203:         erl_parse_abstract([42.0], [{encoding,utf8}]),
<a name="1204"/> 1204:     {cons,0,{integer,0,65},{cons,0,{float,0,42.0},{nil,0}}} =
<a name="1205"/> 1205:         erl_parse_abstract([$A,42.0], [{encoding,unicode}]),
<a name="1206"/> 1206:     {cons,0,{integer,0,65},{cons,0,{float,0,42.0},{nil,0}}} =
<a name="1207"/> 1207:         erl_parse_abstract([$A,42.0], [{encoding,utf8}]),
<a name="otp_10992-last_expr"/><a name="1208"/> 1208:     ok.
<a name="1209"/> 1209: 
<a name="1210"/> 1210: <i>%% OTP-11807. Generalize erl_parse:abstract/2.</i>
<a name="otp_11807-1"/><a name="1211"/> 1211: <b>otp_11807</b>(Config) when is_list(Config) -&gt;
<a name="1212"/> 1212:     {cons,0,{integer,0,97},{cons,0,{integer,0,98},{nil,0}}} =
<a name="1213"/> 1213:         erl_parse_abstract(&quot;ab&quot;, [{encoding,none}]),
<a name="1214"/> 1214:     {cons,0,{integer,0,-1},{nil,0}} =
<a name="1215"/> 1215:         erl_parse_abstract([-1], [{encoding,latin1}]),
<a name="1216"/> 1216:     ASCII = fun(I) -&gt; I &gt;= 0 andalso I &lt; 128 end,
<a name="1217"/> 1217:     {string,0,&quot;xyz&quot;} = erl_parse_abstract(&quot;xyz&quot;, [{encoding,ASCII}]),
<a name="1218"/> 1218:     {cons,0,{integer,0,228},{nil,0}} =
<a name="1219"/> 1219:         erl_parse_abstract([228], [{encoding,ASCII}]),
<a name="1220"/> 1220:     {cons,0,{integer,0,97},{atom,0,a}} =
<a name="1221"/> 1221:         erl_parse_abstract(&quot;a&quot;++a, [{encoding,latin1}]),
<a name="1222"/> 1222:     {'EXIT', {{badarg,bad},_}} = % minor backward incompatibility
<a name="1223"/> 1223:          (catch erl_parse:abstract(&quot;string&quot;, [{encoding,bad}])),
<a name="otp_11807-last_expr"/><a name="1224"/> 1224:    ok.
<a name="1225"/> 1225: 
<a name="otp_16480-1"/><a name="1226"/> 1226: <b>otp_16480</b>(Config) when is_list(Config) -&gt;
<a name="1227"/> 1227:     F = fun mod:func/19,
<a name="1228"/> 1228:     F = erl_parse:normalise(erl_parse_abstract(F)),
<a name="otp_16480-last_expr"/><a name="1229"/> 1229:     ok.
<a name="1230"/> 1230: 
<a name="otp_17024-1"/><a name="1231"/> 1231: <b>otp_17024</b>(Config) when is_list(Config) -&gt;
<a name="1232"/> 1232:     Line = 17,
<a name="1233"/> 1233:     Opts1 = [{location,Line}],
<a name="1234"/> 1234:     {integer,Line,1} = erl_parse_abstract(1, Opts1),
<a name="1235"/> 1235:     Location = {17, 42},
<a name="1236"/> 1236:     {integer,Location,1} = erl_parse_abstract(1, Location),
<a name="1237"/> 1237:     Opts2 = [{location,Location}],
<a name="1238"/> 1238:     {integer,Location,1} = erl_parse_abstract(1, Opts2),
<a name="otp_17024-last_expr"/><a name="1239"/> 1239:     ok.
<a name="1240"/> 1240: 
<a name="text_fun-1"/><a name="1241"/> 1241: <b>text_fun</b>(Config) when is_list(Config) -&gt;
<a name="1242"/> 1242:     KeepClass = fun(Class) -&gt;
<a name="1243"/> 1243:                         fun(C, _) -&gt; C == Class end
<a name="1244"/> 1244:                 end,
<a name="1245"/> 1245: 
<a name="1246"/> 1246:     Join = fun(L, S) -&gt; string:join(L, S) end,
<a name="1247"/> 1247:     String = fun(L) -&gt; Join(L, &quot; &quot;) end,
<a name="1248"/> 1248: 
<a name="1249"/> 1249:     TextAtom = KeepClass(atom),
<a name="1250"/> 1250:     TextInt = KeepClass(integer),
<a name="1251"/> 1251:     %% Keep text for integers written with a base.
<a name="1252"/> 1252:     TextBase = fun(C, S) -&gt;
<a name="1253"/> 1253:                        C == integer andalso string:find(S, &quot;#&quot;) /= nomatch
<a name="1254"/> 1254:                end,
<a name="1255"/> 1255:     %% Keep text for long strings, regardless of class
<a name="1256"/> 1256:     TextLong = fun(_, S) -&gt; length(S) &gt; 10 end,
<a name="1257"/> 1257: 
<a name="1258"/> 1258:     Texts = fun(Toks) -&gt; [erl_scan:text(T) || T &lt;- Toks] end,
<a name="1259"/> 1259:     Values =  fun(Toks) -&gt; [erl_scan:symbol(T) || T &lt;- Toks] end,
<a name="1260"/> 1260: 
<a name="1261"/> 1261:     Atom1 = &quot;foo&quot;,
<a name="1262"/> 1262:     Atom2 = &quot;'this is a long atom'&quot;,
<a name="1263"/> 1263:     Int1 = &quot;42&quot;,
<a name="1264"/> 1264:     Int2 = &quot;16#10&quot;,
<a name="1265"/> 1265:     Int3 = &quot;8#20&quot;,
<a name="1266"/> 1266:     Int4 = &quot;16&quot;,
<a name="1267"/> 1267:     Int5 = &quot;12345678901234567890&quot;,
<a name="1268"/> 1268:     String1 = &quot;\&quot;A String\&quot;&quot;,
<a name="1269"/> 1269:     String2 = &quot;\&quot;guitar string\&quot;&quot;,
<a name="1270"/> 1270:     Name1 = &quot;Short&quot;,
<a name="1271"/> 1271:     Name2 = &quot;LongAndDescriptiveName&quot;,
<a name="1272"/> 1272:     Sep1 = &quot;{&quot;,
<a name="1273"/> 1273:     Sep2 = &quot;+&quot;,
<a name="1274"/> 1274:     Sep3 = &quot;]&quot;,
<a name="1275"/> 1275:     Sep4 = &quot;/&quot;,
<a name="1276"/> 1276: 
<a name="1277"/> 1277:     All = [Atom1, Atom2, Int1, Int2, Int3, Int4, Int5,
<a name="1278"/> 1278:            String1, String2, Name1, Name2,
<a name="1279"/> 1279:            Sep1, Sep2, Sep3, Sep4],
<a name="1280"/> 1280: 
<a name="1281"/> 1281:     {ok, Tokens0, 2} =
<a name="1282"/> 1282:         erl_scan:string(String([Atom1, Int1]), 2, [{text_fun, TextAtom}]),
<a name="1283"/> 1283:     [Atom1, undefined] = Texts(Tokens0),
<a name="1284"/> 1284:     [foo, 42] = Values(Tokens0),
<a name="1285"/> 1285: 
<a name="1286"/> 1286:     {ok, Tokens1, 3} =
<a name="1287"/> 1287:         erl_scan:string(Join([Int2, Int3, Int4], &quot;\n&quot;), 1,
<a name="1288"/> 1288:                         [{text_fun, TextInt}]),
<a name="1289"/> 1289:     [Int2, Int3, Int4] = Texts(Tokens1),
<a name="1290"/> 1290:     [16, 16, 16] = Values(Tokens1),
<a name="1291"/> 1291: 
<a name="1292"/> 1292:     TS = [Int2, String1, Atom1, Int3, Int4, String2],
<a name="1293"/> 1293:     {ok, Tokens2, 6} =
<a name="1294"/> 1294:         %% If text is present, we supply text for *all* tokens.
<a name="1295"/> 1295:         erl_scan:string(Join(TS, &quot;\n&quot;), 1, [{text_fun, TextAtom}, text]),
<a name="1296"/> 1296:     TS = Texts(Tokens2),
<a name="1297"/> 1297:     [16, &quot;A String&quot;, foo, 16, 16, &quot;guitar string&quot;] = Values(Tokens2),
<a name="1298"/> 1298: 
<a name="1299"/> 1299:     Ints = [Int1, Int2, Int3, Int4],
<a name="1300"/> 1300:     {ok, Tokens3, 1} = erl_scan:string(String(Ints), 1, [{text_fun, TextBase}]),
<a name="1301"/> 1301:     [undefined, Int2, Int3, undefined] = Texts(Tokens3),
<a name="1302"/> 1302:     [42, 16, 16, 16] = Values(Tokens3),
<a name="1303"/> 1303: 
<a name="1304"/> 1304:     Longs = lists:filter(fun(S) -&gt; length(S) &gt; 10 end, All),
<a name="1305"/> 1305:     {ok, Tokens4, 1} =
<a name="1306"/> 1306:         erl_scan:string(String(All), 1, [{text_fun, TextLong}]),
<a name="1307"/> 1307:     Longs = lists:filter(fun(T) -&gt; T /= undefined end, Texts(Tokens4)),
<a name="1308"/> 1308: 
<a name="1309"/> 1309:     {ok, Tokens5, 7} =
<a name="1310"/> 1310:         erl_scan:string(String(All), 7, [{text_fun, KeepClass('{')}]),
<a name="text_fun-last_expr"/><a name="1311"/> 1311: <b>    [Sep1] = lists:filter</b>(fun(T) -&gt; T /= undefined end, Texts(Tokens5)).
<a name="1312"/> 1312: 
<a name="triple_quoted_string-1"/><a name="1313"/> 1313: <b>triple_quoted_string</b>(Config) when is_list(Config) -&gt;
<a name="1314"/> 1314:     {ok,[{string,1,&quot;&quot;}],2} =
<a name="1315"/> 1315:         erl_scan:string(
<a name="1316"/> 1316:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1317"/> 1317:           &quot;\&quot;\&quot;\&quot;&quot;),
<a name="1318"/> 1318: 
<a name="1319"/> 1319:     {ok,[{string,1,&quot;&quot;}],3} =
<a name="1320"/> 1320:         erl_scan:string(
<a name="1321"/> 1321:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1322"/> 1322:           &quot;\n&quot;
<a name="1323"/> 1323:           &quot;\&quot;\&quot;\&quot;&quot;),
<a name="1324"/> 1324: 
<a name="1325"/> 1325:     {ok,[{string,1,&quot;&quot;}],3} =
<a name="1326"/> 1326:         erl_scan:string(
<a name="1327"/> 1327:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1328"/> 1328:           &quot; \n&quot;
<a name="1329"/> 1329:           &quot; \&quot;\&quot;\&quot;&quot;),
<a name="1330"/> 1330: 
<a name="1331"/> 1331:     {ok,[{string,1,&quot;&quot;}],3} =
<a name="1332"/> 1332:         erl_scan:string(
<a name="1333"/> 1333:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1334"/> 1334:           &quot;\n&quot;
<a name="1335"/> 1335:           &quot; \&quot;\&quot;\&quot;&quot;),
<a name="1336"/> 1336: 
<a name="1337"/> 1337:     {ok,[{string,1,&quot;&quot;}],3} =
<a name="1338"/> 1338:         erl_scan:string(
<a name="1339"/> 1339:           &quot;\&quot;\&quot;\&quot;\r\n&quot;
<a name="1340"/> 1340:           &quot;  \r\n&quot;
<a name="1341"/> 1341:           &quot;  \&quot;\&quot;\&quot;&quot;),
<a name="1342"/> 1342: 
<a name="1343"/> 1343:     {error,{{2,2},erl_scan,indentation},{3,6}} =
<a name="1344"/> 1344:         erl_scan:string(
<a name="1345"/> 1345:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1346"/> 1346:           &quot; \n&quot; % One space too little indentation
<a name="1347"/> 1347:           &quot;  \&quot;\&quot;\&quot;&quot;, {1,1}, []),
<a name="1348"/> 1348: 
<a name="1349"/> 1349:     {ok,[{string,1,&quot;\n&quot;}],4} =
<a name="1350"/> 1350:         erl_scan:string(
<a name="1351"/> 1351:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1352"/> 1352:           &quot;\n&quot;
<a name="1353"/> 1353:           &quot;\n&quot;
<a name="1354"/> 1354:           &quot;\&quot;\&quot;\&quot;&quot;),
<a name="1355"/> 1355: 
<a name="1356"/> 1356:     {ok,[{string,1,&quot;\r\n&quot;}],4} =
<a name="1357"/> 1357:         erl_scan:string(
<a name="1358"/> 1358:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1359"/> 1359:           &quot;  \r\n&quot;
<a name="1360"/> 1360:           &quot;  \n&quot;
<a name="1361"/> 1361:           &quot;  \&quot;\&quot;\&quot;&quot;),
<a name="1362"/> 1362: 
<a name="1363"/> 1363:     {ok,[{string,1,&quot;\n&quot;}],4} =
<a name="1364"/> 1364:         erl_scan:string(
<a name="1365"/> 1365:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1366"/> 1366:           &quot;  \n&quot;
<a name="1367"/> 1367:           &quot;\r\n&quot;
<a name="1368"/> 1368:           &quot;  \&quot;\&quot;\&quot;&quot;),
<a name="1369"/> 1369: 
<a name="1370"/> 1370:     {ok,[{string,1,&quot;\r\n&quot;}],4} =
<a name="1371"/> 1371:         erl_scan:string(
<a name="1372"/> 1372:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1373"/> 1373:           &quot;\r\n&quot;
<a name="1374"/> 1374:           &quot;  \n&quot;
<a name="1375"/> 1375:           &quot;  \&quot;\&quot;\&quot;&quot;),
<a name="1376"/> 1376: 
<a name="1377"/> 1377:     {error,{{3,2},erl_scan,indentation},{4,6}} =
<a name="1378"/> 1378:         erl_scan:string(
<a name="1379"/> 1379:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1380"/> 1380:           &quot;  \n&quot;
<a name="1381"/> 1381:           &quot; \r\n&quot;
<a name="1382"/> 1382:           &quot;  \&quot;\&quot;\&quot;&quot;, {1,1}, []),
<a name="1383"/> 1383: 
<a name="1384"/> 1384:     {error,{{2,3},erl_scan,indentation},{4,7}} =
<a name="1385"/> 1385:         erl_scan:string(
<a name="1386"/> 1386:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1387"/> 1387:           &quot;  \n&quot; % One space too little indentation
<a name="1388"/> 1388:           &quot;   \r\n&quot;
<a name="1389"/> 1389:           &quot;   \&quot;\&quot;\&quot;&quot;, {1,1}, []),
<a name="1390"/> 1390: 
<a name="1391"/> 1391:     {ok,[{string,1,&quot;CR LF&quot;}],3} =
<a name="1392"/> 1392:         erl_scan:string(
<a name="1393"/> 1393:           &quot;\&quot;\&quot;\&quot; \t\r\n&quot;
<a name="1394"/> 1394:           &quot;CR LF\r\n&quot;
<a name="1395"/> 1395:           &quot;\&quot;\&quot;\&quot;&quot;),
<a name="1396"/> 1396: 
<a name="1397"/> 1397:     {ok,[{string,1,&quot;this is a\nvery long\nstring&quot;}],5} =
<a name="1398"/> 1398:         erl_scan:string(
<a name="1399"/> 1399:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1400"/> 1400:           &quot;this is a\n&quot;
<a name="1401"/> 1401:           &quot;very long\n&quot;
<a name="1402"/> 1402:           &quot;string\n&quot;
<a name="1403"/> 1403:           &quot;\&quot;\&quot;\&quot;&quot;),
<a name="1404"/> 1404: 
<a name="1405"/> 1405:     {ok,[{string,1,&quot;this is a\r\nvery long\r\nstring&quot;}],5} =
<a name="1406"/> 1406:         erl_scan:string(
<a name="1407"/> 1407:           &quot;\&quot;\&quot;\&quot;\r\n&quot;
<a name="1408"/> 1408:           &quot;  this is a\r\n&quot;
<a name="1409"/> 1409:           &quot;  very long\r\n&quot;
<a name="1410"/> 1410:           &quot;  string\r\n&quot;
<a name="1411"/> 1411:           &quot;  \&quot;\&quot;\&quot;&quot;),
<a name="1412"/> 1412: 
<a name="1413"/> 1413:     {ok,
<a name="1414"/> 1414:      [{string,1,
<a name="1415"/> 1415:        &quot;this is a string\r\n&quot;
<a name="1416"/> 1416:        &quot;\n&quot;
<a name="1417"/> 1417:        &quot;\r\n&quot;
<a name="1418"/> 1418:        &quot;with three empty lines\n&quot;
<a name="1419"/> 1419:        &quot;\r\n&quot;}],
<a name="1420"/> 1420:      8} =
<a name="1421"/> 1421:         erl_scan:string(
<a name="1422"/> 1422:           &quot;\&quot;\&quot;\&quot;\r\n&quot;
<a name="1423"/> 1423:           &quot;  this is a string\r\n&quot;
<a name="1424"/> 1424:           &quot;\n&quot;
<a name="1425"/> 1425:           &quot;  \r\n&quot;
<a name="1426"/> 1426:           &quot;  with three empty lines\n&quot;
<a name="1427"/> 1427:           &quot;\r\n&quot;
<a name="1428"/> 1428:           &quot;\n&quot;
<a name="1429"/> 1429:           &quot;  \&quot;\&quot;\&quot;&quot;),
<a name="1430"/> 1430: 
<a name="1431"/> 1431:     {ok,[{string,1,&quot;  this is a\n    very long\n  string&quot;}],5} =
<a name="1432"/> 1432:         erl_scan:string(
<a name="1433"/> 1433:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1434"/> 1434:           &quot;\t  this is a\n&quot;
<a name="1435"/> 1435:           &quot;\t    very long\n&quot;
<a name="1436"/> 1436:           &quot;\t  string\n&quot;
<a name="1437"/> 1437:           &quot;\t\&quot;\&quot;\&quot;&quot;),
<a name="1438"/> 1438: 
<a name="1439"/> 1439:     {ok,[{string,1,&quot;this is a \\\\\nvery long \\\\\nstring\\\\&quot;}],5} =
<a name="1440"/> 1440:         erl_scan:string(
<a name="1441"/> 1441:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1442"/> 1442:           &quot;this is a \\\\\n&quot;
<a name="1443"/> 1443:           &quot;very long \\\\\n&quot;
<a name="1444"/> 1444:           &quot;string\\\\\n&quot;
<a name="1445"/> 1445:           &quot;\&quot;\&quot;\&quot;&quot;),
<a name="1446"/> 1446: 
<a name="1447"/> 1447:     {ok,[{string,1,
<a name="1448"/> 1448:           &quot;this contains \&quot;quotes\&quot;\n&quot;
<a name="1449"/> 1449:           &quot;and \&quot;\&quot;\&quot;triple quotes\&quot;\&quot;\&quot;\n&quot;
<a name="1450"/> 1450:           &quot; \&quot;\&quot; \&quot;\&quot;\&quot; and\n&quot;
<a name="1451"/> 1451:           &quot;ends here&quot;}],6} =
<a name="1452"/> 1452:         erl_scan:string(
<a name="1453"/> 1453:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1454"/> 1454:           &quot;this contains \&quot;quotes\&quot;\n&quot;
<a name="1455"/> 1455:           &quot;and \&quot;\&quot;\&quot;triple quotes\&quot;\&quot;\&quot;\n&quot;
<a name="1456"/> 1456:           &quot; \&quot;\&quot; \&quot;\&quot;\&quot; and\n&quot;
<a name="1457"/> 1457:           &quot;ends here\n&quot;
<a name="1458"/> 1458:           &quot;\&quot;\&quot;\&quot;&quot;),
<a name="1459"/> 1459: 
<a name="1460"/> 1460:     {ok,[{string,{1,1},
<a name="1461"/> 1461:           &quot;```erlang\n&quot;
<a name="1462"/> 1462:           &quot;foo() -&gt;\n&quot;
<a name="1463"/> 1463:           &quot;    \&quot;\&quot;\&quot;\n&quot;
<a name="1464"/> 1464:           &quot;    foo\n&quot;
<a name="1465"/> 1465:           &quot;    bar\n&quot;
<a name="1466"/> 1466:           &quot;    \&quot;\&quot;\&quot;.\n&quot;
<a name="1467"/> 1467:           &quot;```&quot;}],{9,5}} =
<a name="1468"/> 1468:         erl_scan:string(
<a name="1469"/> 1469:           &quot;\&quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1470"/> 1470:           &quot;```erlang\n&quot;
<a name="1471"/> 1471:           &quot;foo() -&gt;\n&quot;
<a name="1472"/> 1472:           &quot;    \&quot;\&quot;\&quot;\n&quot;
<a name="1473"/> 1473:           &quot;    foo\n&quot;
<a name="1474"/> 1474:           &quot;    bar\n&quot;
<a name="1475"/> 1475:           &quot;    \&quot;\&quot;\&quot;.\n&quot;
<a name="1476"/> 1476:           &quot;```\n&quot;
<a name="1477"/> 1477:           &quot;\&quot;\&quot;\&quot;\&quot;&quot;, {1,1}, []),
<a name="1478"/> 1478: 
<a name="1479"/> 1479:     {ok,[{string,{1,1},&quot;5-quoted&quot;}],{3,8}} =
<a name="1480"/> 1480:         erl_scan:string(
<a name="1481"/> 1481:           &quot;\&quot;\&quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1482"/> 1482:           &quot;  5-quoted\n&quot;
<a name="1483"/> 1483:           &quot;  \&quot;\&quot;\&quot;\&quot;\&quot;&quot;, {1,1}, []),
<a name="1484"/> 1484: 
<a name="1485"/> 1485:     {error,{{1,4},erl_scan,white_space},{2,4}} =
<a name="1486"/> 1486:         erl_scan:string(
<a name="1487"/> 1487:           &quot;\&quot;\&quot;\&quot;foo\n&quot; % Only white-space allowed after opening quote seq
<a name="1488"/> 1488:           &quot;\&quot;\&quot;\&quot;&quot;, {1,1}, []),
<a name="1489"/> 1489: 
<a name="1490"/> 1490:     {error,{{2,2},erl_scan,indentation},{3,6}} =
<a name="1491"/> 1491:         erl_scan:string(
<a name="1492"/> 1492:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1493"/> 1493:           &quot; foo\n&quot; % One space too little indentation
<a name="1494"/> 1494:           &quot;  \&quot;\&quot;\&quot;&quot;, {1,1}, []),
<a name="1495"/> 1495: 
<a name="1496"/> 1496:     {error,{{2,8},erl_scan,indentation},{3,12}} =
<a name="1497"/> 1497:         erl_scan:string(
<a name="1498"/> 1498:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1499"/> 1499:           &quot;       \tfoo\n&quot; % The tab shoud be a space
<a name="1500"/> 1500:           &quot;        \&quot;\&quot;\&quot;&quot;, {1,1}, []),
<a name="1501"/> 1501: 
<a name="1502"/> 1502:     {error,{{1,4},erl_scan,{unterminated,{string,3},&quot;\n\tx\n\t\&quot;\&quot;&quot;}},{3,4}} =
<a name="1503"/> 1503:         erl_scan:string(
<a name="1504"/> 1504:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1505"/> 1505:           &quot;\tx\n&quot;
<a name="1506"/> 1506:           &quot;\t\&quot;\&quot;&quot;, % Lacking one double-quote char in closing seq
<a name="1507"/> 1507:           {1,1}, []),
<a name="1508"/> 1508: 
<a name="1509"/> 1509:     {error,{{3,4},erl_scan,string_concat},{3,4}} =
<a name="1510"/> 1510:         erl_scan:string(
<a name="1511"/> 1511:           &quot;\&quot;\&quot;\&quot;\n&quot;
<a name="1512"/> 1512:           &quot;x\n&quot;
<a name="1513"/> 1513:           &quot;\&quot;\&quot;\&quot;\&quot;&quot;,
<a name="1514"/> 1514:           %% Bad end delimiter: adjacent string start without white space
<a name="1515"/> 1515:           {1,1}, []),
<a name="1516"/> 1516: 
<a name="1517"/> 1517:     {error,{{3,2},erl_scan,string_concat},{3,2}} =
<a name="1518"/> 1518:         erl_scan:string(
<a name="1519"/> 1519:           &quot;\&quot;\n&quot;
<a name="1520"/> 1520:           &quot;x\n&quot;
<a name="1521"/> 1521:           &quot;\&quot;\&quot;\&quot;&quot;,
<a name="1522"/> 1522:           %% False triple-quote: adjacent string start without white space
<a name="1523"/> 1523:           {1,1}, []),
<a name="1524"/> 1524: 
<a name="1525"/> 1525:     {error,{{1,6},erl_scan,string_concat},{1,6}} =
<a name="1526"/> 1526:         %% Adjacent string start without white space
<a name="1527"/> 1527:         erl_scan:string(&quot;\&quot;abc\&quot;\&quot;def\&quot;&quot;, {1,1}, []),
<a name="1528"/> 1528: 
<a name="1529"/> 1529:     {ok,[{string,1,[16#D000]}],3} =
<a name="1530"/> 1530:         erl_scan:string(
<a name="1531"/> 1531:           [$&quot;,$&quot;,$&quot;,$\n,
<a name="1532"/> 1532:            16#D000,$\n, % Unicode character
<a name="1533"/> 1533:            $&quot;,$&quot;,$&quot;]),
<a name="1534"/> 1534: 
<a name="1535"/> 1535:     {error,{2,erl_scan,{illegal,character}},2} =
<a name="1536"/> 1536:         erl_scan:string(
<a name="1537"/> 1537:           [$&quot;,$&quot;,$&quot;,$\n,
<a name="1538"/> 1538:            16#FFFF,$\n, % Out of Unicode range
<a name="1539"/> 1539:            $&quot;,$&quot;,$&quot;]),
<a name="1540"/> 1540: 
<a name="1541"/> 1541:     %% Test the real deal in this source code
<a name="1542"/> 1542:     &quot;&quot;&quot;&quot;
<a name="1543"/> 1543:     ```erlang
<a name="1544"/> 1544:     foo() -&gt;
<a name="1545"/> 1545:         &quot;&quot;&quot;
<a name="1546"/> 1546:         \foo
<a name="1547"/> 1547:         \bar
<a name="1548"/> 1548:         &quot;&quot;&quot;.
<a name="1549"/> 1549:     ```
<a name="1550"/> 1550:     &quot;&quot;&quot;&quot;
<a name="1551"/> 1551:         =
<a name="1552"/> 1552:         &quot;```erlang
<a name="1553"/> 1553: foo() -&gt;
<a name="1554"/> 1554:     \&quot;\&quot;\&quot;
<a name="1555"/> 1555:     \\foo
<a name="1556"/> 1556:     \\bar
<a name="1557"/> 1557:     \&quot;\&quot;\&quot;.
<a name="1558"/> 1558: ```&quot;,
<a name="triple_quoted_string-last_expr"/><a name="1559"/> 1559:     ok.
<a name="1560"/> 1560: 
<a name="test_string-2"/><a name="1561"/> 1561: <b>test_string</b>(String, ExpectedWithCol) -&gt;
<a name="1562"/> 1562:     {ok, ExpectedWithCol, _EndWithCol} = erl_scan_string(String, {1, 1}, []),
<a name="1563"/> 1563:     Expected = [ begin
<a name="1564"/> 1564:                      {L,_C} = element(2, T),
<a name="1565"/> 1565:                      setelement(2, T, L)
<a name="1566"/> 1566:                  end
<a name="1567"/> 1567:                     || T &lt;- ExpectedWithCol ],
<a name="1568"/> 1568:     {ok, Expected, _End} = erl_scan_string(String),
<a name="test_string-last_expr"/><a name="1569"/> 1569: <b>    test</b>(String).
<a name="1570"/> 1570: 
<a name="erl_scan_string-1"/><a name="1571"/> 1571: <b>erl_scan_string</b>(String) -&gt;
<a name="erl_scan_string-last_expr"/><a name="1572"/> 1572: <b>    erl_scan_string</b>(String, 1, []).
<a name="1573"/> 1573: 
<a name="erl_scan_string-2"/><a name="1574"/> 1574: <b>erl_scan_string</b>(String, StartLocation) -&gt;
<a name="erl_scan_string-last_expr"/><a name="1575"/> 1575: <b>    erl_scan_string</b>(String, StartLocation, []).
<a name="1576"/> 1576: 
<a name="erl_scan_string-3"/><a name="1577"/> 1577: <b>erl_scan_string</b>(String, StartLocation, Options) -&gt;
<a name="erl_scan_string-last_expr"/><a name="1578"/> 1578: <b>    case erl_scan:string</b>(String, StartLocation, Options) of
<a name="1579"/> 1579:         {ok, Tokens, EndLocation} -&gt;
<a name="1580"/> 1580:             {ok, unopaque_tokens(Tokens), EndLocation};
<a name="1581"/> 1581:         Else -&gt;
<a name="1582"/> 1582:             Else
<a name="1583"/> 1583:     end.
<a name="1584"/> 1584: 
<a name="erl_scan_tokens-3"/><a name="1585"/> 1585: <b>erl_scan_tokens</b>(C, S, L) -&gt;
<a name="erl_scan_tokens-last_expr"/><a name="1586"/> 1586: <b>    erl_scan_tokens</b>(C, S, L, []).
<a name="1587"/> 1587: 
<a name="erl_scan_tokens-4"/><a name="1588"/> 1588: <b>erl_scan_tokens</b>(C, S, L, O) -&gt;
<a name="erl_scan_tokens-last_expr"/><a name="1589"/> 1589: <b>    case erl_scan:tokens</b>(C, S, L, O) of
<a name="1590"/> 1590:         {done, {ok, Ts, End}, R} -&gt;
<a name="1591"/> 1591:             {done, {ok, unopaque_tokens(Ts), End}, R};
<a name="1592"/> 1592:         Else -&gt;
<a name="1593"/> 1593:             Else
<a name="1594"/> 1594:     end.
<a name="1595"/> 1595: 
<a name="unopaque_tokens-1"/><a name="1596"/> 1596: <b>unopaque_tokens</b>([]) -&gt;
<a name="1597"/> 1597:     [];
<a name="1598"/> 1598: <b>unopaque_tokens</b>([Token|Tokens]) -&gt;
<a name="1599"/> 1599:     Attrs = element(2, Token),
<a name="1600"/> 1600:     Term = erl_anno:to_term(Attrs),
<a name="1601"/> 1601:     T = setelement(2, Token, Term),
<a name="unopaque_tokens-last_expr"/><a name="1602"/> 1602: <b>    [T | unopaque_tokens</b>(Tokens)].
<a name="1603"/> 1603: 
<a name="erl_parse_abstract-1"/><a name="1604"/> 1604: <b>erl_parse_abstract</b>(Term) -&gt;
<a name="erl_parse_abstract-last_expr"/><a name="1605"/> 1605: <b>    erl_parse_abstract</b>(Term, []).
<a name="1606"/> 1606: 
<a name="erl_parse_abstract-2"/><a name="1607"/> 1607: <b>erl_parse_abstract</b>(Term, Options) -&gt;
<a name="1608"/> 1608:     Abstr = erl_parse:abstract(Term, Options),
<a name="erl_parse_abstract-last_expr"/><a name="1609"/> 1609: <b>    unopaque_abstract</b>(Abstr).
<a name="1610"/> 1610: 
<a name="unopaque_abstract-1"/><a name="1611"/> 1611: <b>unopaque_abstract</b>(Abstr) -&gt;
<a name="unopaque_abstract-last_expr"/><a name="1612"/> 1612: <b>    erl_parse:anno_to_term</b>(Abstr).
<a name="1613"/> 1613: 
<a name="1614"/> 1614: <i>%% test_string(String, Expected, StartLocation, Options) -&gt;</i>
<a name="1615"/> 1615: <i>%%     {ok, Expected, _End} = erl_scan:string(String, StartLocation, Options),</i>
<a name="1616"/> 1616: <i>%%     test(String).</i>
<a name="1617"/> 1617: 
<a name="1618"/> 1618: <i>%% There are no checks of the tags...</i>
<a name="test-1"/><a name="1619"/> 1619: <b>test</b>(String) -&gt;
<a name="1620"/> 1620:     %% io:format(&quot;Testing `~ts'~n&quot;, [String]),
<a name="1621"/> 1621:     [{Tokens, End},
<a name="1622"/> 1622:      {Wtokens, Wend},
<a name="1623"/> 1623:      {Ctokens, Cend},
<a name="1624"/> 1624:      {CWtokens, CWend},
<a name="1625"/> 1625:      {CWtokens2, _}] =
<a name="1626"/> 1626:         [scan_string_with_column(String, X) ||
<a name="1627"/> 1627:             X &lt;- [[],
<a name="1628"/> 1628:                   [return_white_spaces],
<a name="1629"/> 1629:                   [return_comments],
<a name="1630"/> 1630:                   [return],
<a name="1631"/> 1631:                   [return]]], % for white space compaction test
<a name="1632"/> 1632: 
<a name="1633"/> 1633:     {end1,End,Wend} = {end1,Wend,End},
<a name="1634"/> 1634:     {end2,Wend,Cend} = {end2,Cend,Wend},
<a name="1635"/> 1635:     {end3,Cend,CWend} = {end3,CWend,Cend},
<a name="1636"/> 1636: 
<a name="1637"/> 1637:     %% Test that the tokens that are common to two token lists are identical.
<a name="1638"/> 1638:     {none,Tokens} = {none, filter_tokens(CWtokens, [white_space,comment])},
<a name="1639"/> 1639:     {comments,Ctokens} =
<a name="1640"/> 1640:         {comments,filter_tokens(CWtokens, [white_space])},
<a name="1641"/> 1641:     {white_spaces,Wtokens} =
<a name="1642"/> 1642:         {white_spaces,filter_tokens(CWtokens, [comment])},
<a name="1643"/> 1643: 
<a name="1644"/> 1644:     %% Use token attributes to extract parts from the original string,
<a name="1645"/> 1645:     %% and check that the parts are identical to the token strings.
<a name="1646"/> 1646:     {Line,Column} = test_decorated_tokens(String, CWtokens),
<a name="1647"/> 1647:     {deco,{Line,Column},End} = {deco,End,{Line,Column}},
<a name="1648"/> 1648: 
<a name="1649"/> 1649:     %% Almost the same again: concat texts to get the original:
<a name="1650"/> 1650:     Text = get_text(CWtokens),
<a name="1651"/> 1651:     {text,Text,String} = {text,String,Text},
<a name="1652"/> 1652: 
<a name="1653"/> 1653:     %% Test that white spaces occupy less heap than the worst case.
<a name="1654"/> 1654:     ok = test_white_space_compaction(CWtokens, CWtokens2),
<a name="1655"/> 1655: 
<a name="1656"/> 1656:     %% Test that white newlines are always first in text:
<a name="1657"/> 1657:     WhiteTokens = select_tokens(CWtokens, [white_space]),
<a name="1658"/> 1658:     ok = newlines_first(WhiteTokens),
<a name="1659"/> 1659: 
<a name="1660"/> 1660:     %% Line attribute only:
<a name="1661"/> 1661:     [Simple,Wsimple,Csimple,WCsimple] = Simples =
<a name="1662"/> 1662:         [element(2, erl_scan:string(String, 1, Opts)) ||
<a name="1663"/> 1663:             Opts &lt;- [[],
<a name="1664"/> 1664:                      [return_white_spaces],
<a name="1665"/> 1665:                      [return_comments],
<a name="1666"/> 1666:                      [return]]],
<a name="1667"/> 1667:     {consistent,true} = {consistent,consistent_attributes(Simples)},
<a name="1668"/> 1668:     {simple_wc,WCsimple} = {simple_wc,simplify(CWtokens)},
<a name="1669"/> 1669:     {simple,Simple} = {simple,filter_tokens(WCsimple, [white_space,comment])},
<a name="1670"/> 1670:     {simple_c,Csimple} = {simple_c,filter_tokens(WCsimple, [white_space])},
<a name="1671"/> 1671:     {simple_w,Wsimple} = {simple_w,filter_tokens(WCsimple, [comment])},
<a name="1672"/> 1672: 
<a name="1673"/> 1673:     %% Line attribute only, with text:
<a name="1674"/> 1674:     [SimpleTxt,WsimpleTxt,CsimpleTxt,WCsimpleTxt] = SimplesTxt =
<a name="1675"/> 1675:         [element(2, erl_scan:string(String, 1, [text|Opts])) ||
<a name="1676"/> 1676:             Opts &lt;- [[],
<a name="1677"/> 1677:                      [return_white_spaces],
<a name="1678"/> 1678:                      [return_comments],
<a name="1679"/> 1679:                      [return]]],
<a name="1680"/> 1680:     TextTxt = get_text(WCsimpleTxt),
<a name="1681"/> 1681:     {text_txt,TextTxt,String} = {text_txt,String,TextTxt},
<a name="1682"/> 1682:     {consistent_txt,true} =
<a name="1683"/> 1683:         {consistent_txt,consistent_attributes(SimplesTxt)},
<a name="1684"/> 1684:     {simple_txt,SimpleTxt} =
<a name="1685"/> 1685:         {simple_txt,filter_tokens(WCsimpleTxt, [white_space,comment])},
<a name="1686"/> 1686:     {simple_c_txt,CsimpleTxt} =
<a name="1687"/> 1687:         {simple_c_txt,filter_tokens(WCsimpleTxt, [white_space])},
<a name="1688"/> 1688:     {simple_w_txt,WsimpleTxt} =
<a name="1689"/> 1689:         {simple_w_txt,filter_tokens(WCsimpleTxt, [comment])},
<a name="1690"/> 1690: 
<a name="test-last_expr"/><a name="1691"/> 1691:     ok.
<a name="1692"/> 1692: 
<a name="test_white_space_compaction-2"/><a name="1693"/> 1693: <b>test_white_space_compaction</b>(Tokens, Tokens2) when Tokens =:= Tokens2 -&gt;
<a name="1694"/> 1694:     [WS, WS2] = [select_tokens(Ts, [white_space]) || Ts &lt;- [Tokens, Tokens2]],
<a name="test_white_space_compaction-last_expr"/><a name="1695"/> 1695: <b>    test_wsc</b>(WS, WS2).
<a name="1696"/> 1696: 
<a name="test_wsc-2"/><a name="1697"/> 1697: <b>test_wsc</b>([], []) -&gt;
<a name="1698"/> 1698:     ok;
<a name="1699"/> 1699: <b>test_wsc</b>([Token|Tokens], [Token2|Tokens2]) -&gt;
<a name="1700"/> 1700:     [Text, Text2] = [Text ||
<a name="1701"/> 1701:                         Text &lt;- [erl_scan:text(T) || T &lt;- [Token, Token2]]],
<a name="1702"/> 1702:     Sz = erts_debug:size(Text),
<a name="1703"/> 1703:     Sz2 = erts_debug:size({Text, Text2}),
<a name="1704"/> 1704:     IsCompacted = Sz2 &lt; 2*Sz+erts_debug:size({a,a}),
<a name="1705"/> 1705:     ToBeCompacted = is_compacted(Text),
<a name="test_wsc-last_expr"/><a name="1706"/> 1706:     if
<a name="1707"/> 1707:         IsCompacted =:= ToBeCompacted -&gt;
<a name="1708"/> 1708:             test_wsc(Tokens, Tokens2);
<a name="1709"/> 1709:         true -&gt;
<a name="1710"/> 1710:             {compaction_error, Token}
<a name="1711"/> 1711:     end.
<a name="1712"/> 1712: 
<a name="is_compacted-1"/><a name="1713"/> 1713: <b>is_compacted</b>(&quot;\r&quot;) -&gt;
<a name="1714"/> 1714:     true;
<a name="1715"/> 1715: <b>is_compacted</b>(&quot;\n\r&quot;) -&gt;
<a name="1716"/> 1716:     true;
<a name="1717"/> 1717: <b>is_compacted</b>(&quot;\n\f&quot;) -&gt;
<a name="1718"/> 1718:     true;
<a name="1719"/> 1719: <b>is_compacted</b>([$\n|String]) -&gt;
<a name="1720"/> 1720:       all_spaces(String)
<a name="1721"/> 1721:     orelse
<a name="1722"/> 1722:       all_tabs(String);
<a name="1723"/> 1723: <b>is_compacted</b>(String) -&gt;
<a name="1724"/> 1724:       all_spaces(String)
<a name="is_compacted-last_expr"/><a name="1725"/> 1725:     orelse
<a name="1726"/> 1726:       all_tabs(String).
<a name="1727"/> 1727: 
<a name="all_spaces-1"/><a name="1728"/> 1728: <b>all_spaces</b>(L) -&gt;
<a name="all_spaces-last_expr"/><a name="1729"/> 1729: <b>    all_same</b>(L, $\s).
<a name="1730"/> 1730: 
<a name="all_tabs-1"/><a name="1731"/> 1731: <b>all_tabs</b>(L) -&gt;
<a name="all_tabs-last_expr"/><a name="1732"/> 1732: <b>    all_same</b>(L, $\t).
<a name="1733"/> 1733: 
<a name="all_same-2"/><a name="1734"/> 1734: <b>all_same</b>(L, Char) -&gt;
<a name="all_same-last_expr"/><a name="1735"/> 1735: <b>    lists:all</b>(fun(C) -&gt; C =:= Char end, L).
<a name="1736"/> 1736: 
<a name="newlines_first-1"/><a name="1737"/> 1737: <b>newlines_first</b>([]) -&gt;
<a name="1738"/> 1738:     ok;
<a name="1739"/> 1739: <b>newlines_first</b>([Token|Tokens]) -&gt;
<a name="1740"/> 1740:     Text = erl_scan:text(Token),
<a name="1741"/> 1741:     Nnls = length([C || C &lt;- Text, C =:= $\n]),
<a name="1742"/> 1742:     OK = case Text of
<a name="1743"/> 1743:              [$\n|_] -&gt;
<a name="1744"/> 1744:                  Nnls =:= 1;
<a name="1745"/> 1745:              _ -&gt;
<a name="1746"/> 1746:                  Nnls =:= 0
<a name="1747"/> 1747:          end,
<a name="newlines_first-last_expr"/><a name="1748"/> 1748:     if
<a name="1749"/> 1749:         OK -&gt; newlines_first(Tokens);
<a name="1750"/> 1750:         true -&gt; OK
<a name="1751"/> 1751:     end.
<a name="1752"/> 1752: 
<a name="filter_tokens-2"/><a name="1753"/> 1753: <b>filter_tokens</b>(Tokens, Tags) -&gt;
<a name="filter_tokens-last_expr"/><a name="1754"/> 1754: <b>    lists:filter</b>(fun(T) -&gt; not lists:member(element(1, T), Tags) end, Tokens).
<a name="1755"/> 1755: 
<a name="select_tokens-2"/><a name="1756"/> 1756: <b>select_tokens</b>(Tokens, Tags) -&gt;
<a name="select_tokens-last_expr"/><a name="1757"/> 1757: <b>    lists:filter</b>(fun(T) -&gt; lists:member(element(1, T), Tags) end, Tokens).
<a name="1758"/> 1758: 
<a name="simplify-1"/><a name="1759"/> 1759: <b>simplify</b>([Token|Tokens]) -&gt;
<a name="1760"/> 1760:     Line = erl_scan:line(Token),
<a name="1761"/> 1761:     [setelement(2, Token, erl_anno:new(Line)) | simplify(Tokens)];
<a name="1762"/> 1762: <b>simplify</b>([]) -&gt;
<a name="simplify-last_expr"/><a name="1763"/> 1763:     [].
<a name="1764"/> 1764: 
<a name="get_text-1"/><a name="1765"/> 1765: <b>get_text</b>(Tokens) -&gt;
<a name="get_text-last_expr"/><a name="1766"/> 1766: <b>    lists:flatten</b>(
<a name="1767"/> 1767:       [T ||
<a name="1768"/> 1768:           Token &lt;- Tokens,
<a name="1769"/> 1769:           (T = erl_scan:text(Token)) =/= []]).
<a name="1770"/> 1770: 
<a name="test_decorated_tokens-2"/><a name="1771"/> 1771: <b>test_decorated_tokens</b>(String, Tokens) -&gt;
<a name="1772"/> 1772:     ToksAttrs = token_attrs(Tokens),
<a name="test_decorated_tokens-last_expr"/><a name="1773"/> 1773: <b>    test_strings</b>(ToksAttrs, String, 1, 1).
<a name="1774"/> 1774: 
<a name="token_attrs-1"/><a name="1775"/> 1775: <b>token_attrs</b>(Tokens) -&gt;
<a name="token_attrs-last_expr"/><a name="1776"/> 1776: <b>    [{L,C,length</b>(T),T} ||
<a name="1777"/> 1777:         Token &lt;- Tokens,
<a name="1778"/> 1778:         ([C,L,T] = token_info(Token)) =/= []].
<a name="1779"/> 1779: 
<a name="token_info-1"/><a name="1780"/> 1780: <b>token_info</b>(T) -&gt;
<a name="1781"/> 1781:     Column = erl_scan:column(T),
<a name="1782"/> 1782:     Line = erl_scan:line(T),
<a name="1783"/> 1783:     Text = erl_scan:text(T),
<a name="token_info-last_expr"/><a name="1784"/> 1784:     [Column, Line, Text].
<a name="1785"/> 1785: 
<a name="token_info_long-1"/><a name="1786"/> 1786: <b>token_info_long</b>(T) -&gt;
<a name="1787"/> 1787:     Column = erl_scan:column(T),
<a name="1788"/> 1788:     Line = erl_scan:line(T),
<a name="1789"/> 1789:     Text = erl_scan:text(T),
<a name="1790"/> 1790:     Category = erl_scan:category(T),
<a name="1791"/> 1791:     Symbol = erl_scan:symbol(T),
<a name="token_info_long-last_expr"/><a name="1792"/> 1792:     [{category,Category},{column,Column},{line,Line},
<a name="1793"/> 1793:      {symbol,Symbol},{text,Text}].
<a name="1794"/> 1794: 
<a name="test_strings-4"/><a name="1795"/> 1795: <b>test_strings</b>([], _S, Line, Column) -&gt;
<a name="1796"/> 1796:     {Line,Column};
<a name="1797"/> 1797: <b>test_strings</b>([{L,C,Len,T}=Attr|Attrs], String0, Line0, Column0) -&gt;
<a name="1798"/> 1798:     {String1, Column1} = skip_newlines(String0, L, Line0, Column0),
<a name="1799"/> 1799:     String = skip_chars(String1, C-Column1),
<a name="1800"/> 1800:     {Str,Rest} = lists:split(Len, String),
<a name="test_strings-last_expr"/><a name="1801"/> 1801:     if
<a name="1802"/> 1802:         Str =:= T -&gt;
<a name="1803"/> 1803:             {Line,Column} = string_newlines(T, L, C),
<a name="1804"/> 1804:             test_strings(Attrs, Rest, Line, Column);
<a name="1805"/> 1805:         true -&gt;
<a name="1806"/> 1806:             {token_error, Attr, Str}
<a name="1807"/> 1807:     end.
<a name="1808"/> 1808: 
<a name="skip_newlines-4"/><a name="1809"/> 1809: <b>skip_newlines</b>(String, Line, Line, Column) -&gt;
<a name="1810"/> 1810:     {String, Column};
<a name="1811"/> 1811: <b>skip_newlines</b>([$\n|String], L, Line, _Column) -&gt;
<a name="1812"/> 1812:     skip_newlines(String, L, Line+1, 1);
<a name="1813"/> 1813: <b>skip_newlines</b>([_|String], L, Line, Column) -&gt;
<a name="skip_newlines-last_expr"/><a name="1814"/> 1814: <b>    skip_newlines</b>(String, L, Line, Column+1).
<a name="1815"/> 1815: 
<a name="skip_chars-2"/><a name="1816"/> 1816: <b>skip_chars</b>(String, 0) -&gt;
<a name="1817"/> 1817:     String;
<a name="1818"/> 1818: <b>skip_chars</b>([_|String], N) -&gt;
<a name="skip_chars-last_expr"/><a name="1819"/> 1819: <b>    skip_chars</b>(String, N-1).
<a name="1820"/> 1820: 
<a name="string_newlines-3"/><a name="1821"/> 1821: <b>string_newlines</b>([$\n|String], Line, _Column) -&gt;
<a name="1822"/> 1822:     string_newlines(String, Line+1, 1);
<a name="1823"/> 1823: <b>string_newlines</b>([], Line, Column) -&gt;
<a name="1824"/> 1824:     {Line, Column};
<a name="1825"/> 1825: <b>string_newlines</b>([_|String], Line, Column) -&gt;
<a name="string_newlines-last_expr"/><a name="1826"/> 1826: <b>    string_newlines</b>(String, Line, Column+1).
<a name="1827"/> 1827: 
<a name="scan_string_with_column-2"/><a name="1828"/> 1828: <b>scan_string_with_column</b>(String, Options0) -&gt;
<a name="1829"/> 1829:     Options = [text | Options0],
<a name="1830"/> 1830:     StartLoc = {1, 1},
<a name="1831"/> 1831:     {ok, Ts1, End1} = erl_scan:string(String, StartLoc, Options),
<a name="1832"/> 1832:     TString = String ++ &quot;. &quot;,
<a name="1833"/> 1833:     {ok,Ts2,End2} = scan_tokens(TString, Options, [], StartLoc),
<a name="1834"/> 1834:     {ok, Ts3, End3} =
<a name="1835"/> 1835:         scan_tokens_1({more, []}, TString, Options, [], StartLoc),
<a name="1836"/> 1836:     {end_2,End2,End3} = {end_2,End3,End2},
<a name="1837"/> 1837:     {EndLine1,EndColumn1} = End1,
<a name="1838"/> 1838:     End2 = {EndLine1,EndColumn1+2},
<a name="1839"/> 1839:     {ts_1,Ts2,Ts3} = {ts_1,Ts3,Ts2},
<a name="1840"/> 1840:     Ts2 = Ts1 ++ [lists:last(Ts2)],
<a name="1841"/> 1841: 
<a name="1842"/> 1842:     %% Attributes are keylists, but have no text.
<a name="1843"/> 1843:     {ok, Ts7, End7} = erl_scan:string(String, {1,1}, Options),
<a name="1844"/> 1844:     {ok, Ts8, End8} = scan_tokens(TString, Options, [], {1,1}),
<a name="1845"/> 1845:     {end1, End1} = {end1, End7},
<a name="1846"/> 1846:     {end2, End2} = {end2, End8},
<a name="1847"/> 1847:     Ts8 = Ts7 ++ [lists:last(Ts8)],
<a name="1848"/> 1848:     {cons,true} = {cons,consistent_attributes([Ts1,Ts2,Ts3,Ts7,Ts8])},
<a name="1849"/> 1849: 
<a name="scan_string_with_column-last_expr"/><a name="1850"/> 1850:     {Ts1, End1}.
<a name="1851"/> 1851: 
<a name="scan_tokens-4"/><a name="1852"/> 1852: <b>scan_tokens</b>(String, Options, Rs, Location) -&gt;
<a name="scan_tokens-last_expr"/><a name="1853"/> 1853: <b>    case erl_scan:tokens</b>([], String, Location, Options) of
<a name="1854"/> 1854:         {done, {ok,Ts,End}, &quot;&quot;} -&gt;
<a name="1855"/> 1855:             {ok, lists:append(lists:reverse([Ts|Rs])), End};
<a name="1856"/> 1856:         {done, {ok,Ts,End}, Rest} -&gt;
<a name="1857"/> 1857:             scan_tokens(Rest, Options, [Ts|Rs], End)
<a name="1858"/> 1858:     end.
<a name="1859"/> 1859: 
<a name="scan_tokens_1-5"/><a name="1860"/> 1860: <b>scan_tokens_1</b>({done, {ok,Ts,End}, &quot;&quot;}, &quot;&quot;, _Options, Rs, _Location) -&gt;
<a name="1861"/> 1861:     {ok,lists:append(lists:reverse([Ts|Rs])),End};
<a name="1862"/> 1862: <b>scan_tokens_1</b>({done, {ok,Ts,End}, Rest}, Cs, Options, Rs, _Location) -&gt;
<a name="1863"/> 1863:     scan_tokens_1({more,[]}, Rest++Cs, Options, [Ts|Rs], End);
<a name="1864"/> 1864: <b>scan_tokens_1</b>({more, Cont}, [C | Cs], Options, Rs, Loc) -&gt;
<a name="1865"/> 1865:     R = erl_scan:tokens(Cont, [C], Loc, Options),
<a name="scan_tokens_1-last_expr"/><a name="1866"/> 1866: <b>    scan_tokens_1</b>(R, Cs, Options, Rs, Loc).
<a name="1867"/> 1867: 
<a name="consistent_attributes-1"/><a name="1868"/> 1868: <b>consistent_attributes</b>([]) -&gt;
<a name="1869"/> 1869:     true;
<a name="1870"/> 1870: <b>consistent_attributes</b>([Ts | TsL]) -&gt;
<a name="1871"/> 1871:     L = [T || T &lt;- Ts, is_integer(element(2, T))],
<a name="consistent_attributes-last_expr"/><a name="1872"/> 1872:     case L of
<a name="1873"/> 1873:         [] -&gt;
<a name="1874"/> 1874:             TagsL = [[Tag || {Tag,_} &lt;- defined(token_info_long(T))] ||
<a name="1875"/> 1875:                         T &lt;- Ts],
<a name="1876"/> 1876:             case lists:usort(TagsL) of
<a name="1877"/> 1877:                 [_] -&gt;
<a name="1878"/> 1878:                     consistent_attributes(TsL);
<a name="1879"/> 1879:                 [] when Ts =:= [] -&gt;
<a name="1880"/> 1880:                     consistent_attributes(TsL);
<a name="1881"/> 1881:                 _ -&gt;
<a name="1882"/> 1882:                     Ts
<a name="1883"/> 1883:             end;
<a name="1884"/> 1884:         Ts -&gt;
<a name="1885"/> 1885:             consistent_attributes(TsL);
<a name="1886"/> 1886:         _ -&gt;
<a name="1887"/> 1887:             Ts
<a name="1888"/> 1888:     end.
<a name="1889"/> 1889: 
<a name="defined-1"/><a name="1890"/> 1890: <b>defined</b>(L) -&gt;
<a name="defined-last_expr"/><a name="1891"/> 1891:     [{T,V} || {T,V} &lt;- L, V =/= undefined].
<a name="1892"/> 1892: 
<a name="family_list-1"/><a name="1893"/> 1893: <b>family_list</b>(L) -&gt;
<a name="family_list-last_expr"/><a name="1894"/> 1894: <b>    sofs:to_external</b>(family(L)).
<a name="1895"/> 1895: 
<a name="family-1"/><a name="1896"/> 1896: <b>family</b>(L) -&gt;
<a name="family-last_expr"/><a name="1897"/> 1897: <b>    sofs:relation_to_family</b>(sofs:relation(L)).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
