<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/async_ports_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <b>-module</b>(async_ports_SUITE).
<a name="2"/>    2: 
<a name="3"/>    3: <b>-export</b>([all/0, suite/0]).
<a name="4"/>    4: <b>-export</b>([permanent_busy_test/1]).
<a name="5"/>    5: <b>-export</b>([run_loop/5]).
<a name="6"/>    6: 
<a name="7"/>    7: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="8"/>    8: 
<a name="9"/>    9: <b>-define</b>(PACKET_SIZE, (10 * 1024 * 8)).
<a name="10"/>   10: <b>-define</b>(CPORT_DELAY, 100).
<a name="11"/>   11: <b>-define</b>(TEST_LOOPS_COUNT, 100000).
<a name="12"/>   12: <b>-define</b>(SLEEP_BEFORE_CHECK, 1000).
<a name="13"/>   13: <b>-define</b>(TEST_PROCS_COUNT, 2).
<a name="14"/>   14: <b>-define</b>(TC_TIMETRAP_SECONDS, 10).
<a name="15"/>   15: 
<a name="suite-0"/><a name="16"/>   16: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="17"/>   17:     [{ct_hooks,[ts_install_cth]},
<a name="18"/>   18:      {timetrap, {seconds, ?TC_TIMETRAP_SECONDS}}].
<a name="19"/>   19: 
<a name="all-0"/><a name="20"/>   20: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="21"/>   21:     [permanent_busy_test].
<a name="22"/>   22: 
<a name="permanent_busy_test-1"/><a name="23"/>   23: <b>permanent_busy_test</b>(Config) -&gt;
<a name="24"/>   24:     ExePath = filename:join(proplists:get_value(data_dir, Config), &quot;cport&quot;),
<a name="25"/>   25:     Self = self(),
<a name="26"/>   26:     spawn_link(
<a name="27"/>   27:       fun() -&gt;
<a name="28"/>   28:               Block = &lt;&lt;0:?PACKET_SIZE&gt;&gt;,
<a name="29"/>   29: 
<a name="30"/>   30:               Port = open_port(ExePath),
<a name="31"/>   31:               
<a name="32"/>   32:               Testers = lists:map(
<a name="33"/>   33:                           fun(_) -&gt;
<a name="34"/>   34:                                   spawn_link(?MODULE, run_loop,
<a name="35"/>   35:                                              [Self,
<a name="36"/>   36:                                               Port,
<a name="37"/>   37:                                               Block,
<a name="38"/>   38:                                               ?TEST_LOOPS_COUNT,
<a name="39"/>   39:                                               0])
<a name="40"/>   40:                           end,
<a name="41"/>   41:                           lists:seq(1, ?TEST_PROCS_COUNT)),
<a name="42"/>   42:               Self ! {test_info, Port, Testers},
<a name="43"/>   43:               endless_flush(Port)
<a name="44"/>   44:       end),
<a name="45"/>   45: 
<a name="permanent_busy_test-last_expr"/><a name="46"/>   46:     receive
<a name="47"/>   47:         {test_info, Port, Testers} -&gt;
<a name="48"/>   48:             MaxWaitTime = round(0.7 * ?TC_TIMETRAP_SECONDS * 1000),
<a name="49"/>   49:             ct:log(&quot;wait testers, maximum ~w mcsec~n&quot;, [MaxWaitTime]),
<a name="50"/>   50:             ok = wait_testers(MaxWaitTime, Testers),
<a name="51"/>   51:             timer:sleep(?SLEEP_BEFORE_CHECK),
<a name="52"/>   52:             case erlang:port_command(Port, &lt;&lt;&quot;test&quot;&gt;&gt;, [nosuspend]) of
<a name="53"/>   53:                 false -&gt;
<a name="54"/>   54:                     exit(port_dead);
<a name="55"/>   55:                 true -&gt;
<a name="56"/>   56:                     ok
<a name="57"/>   57:             end
<a name="58"/>   58:     end.
<a name="59"/>   59: 
<a name="wait_testers-2"/><a name="60"/>   60: <b>wait_testers</b>(Timeout, Testers) -&gt;
<a name="61"/>   61:     lists:foldl(
<a name="62"/>   62:       fun(Pid, AccIn) -&gt;
<a name="63"/>   63:               StartWait = os:timestamp(),
<a name="64"/>   64:               receive
<a name="65"/>   65:                   {Pid, port_dead} -&gt;
<a name="66"/>   66:                       recalc_timeout(AccIn, StartWait)
<a name="67"/>   67:               after AccIn -&gt;
<a name="68"/>   68:                       Pid ! stop,
<a name="69"/>   69:                       recalc_timeout(AccIn, StartWait)
<a name="70"/>   70:               end
<a name="71"/>   71:       end, Timeout, Testers),
<a name="wait_testers-last_expr"/><a name="72"/>   72:     ok.
<a name="73"/>   73: 
<a name="recalc_timeout-2"/><a name="74"/>   74: <b>recalc_timeout</b>(TimeoutIn, WaitStart) -&gt;
<a name="recalc_timeout-last_expr"/><a name="75"/>   75: <b>    erlang:max</b>(0, TimeoutIn - round(timer:now_diff(os:timestamp(), WaitStart)) div 1000).
<a name="76"/>   76: 
<a name="open_port-1"/><a name="77"/>   77: <b>open_port</b>(ExePath) -&gt;
<a name="open_port-last_expr"/><a name="78"/>   78: <b>    erlang:open_port</b>({spawn, ExePath ++ &quot; 100&quot;}, [{packet, 4}, eof, exit_status, use_stdio, binary]).
<a name="79"/>   79: 
<a name="run_loop-5"/><a name="80"/>   80: <b>run_loop</b>(RootProc, Port, Block, CheckLimit, BusyCnt) -&gt;
<a name="run_loop-last_expr"/><a name="81"/>   81:     receive
<a name="82"/>   82:         stop -&gt;
<a name="83"/>   83:             ok
<a name="84"/>   84:     after 0 -&gt;
<a name="85"/>   85:             case erlang:port_command(Port, Block, [nosuspend]) of
<a name="86"/>   86:                 true -&gt;
<a name="87"/>   87:                     run_loop(RootProc, Port, Block, CheckLimit, 0);
<a name="88"/>   88:                 false -&gt;
<a name="89"/>   89:                     if
<a name="90"/>   90:                         BusyCnt + 1 &gt; CheckLimit -&gt;
<a name="91"/>   91:                             check_dead(RootProc, Port, Block, CheckLimit);
<a name="92"/>   92:                         true -&gt;
<a name="93"/>   93:                             run_loop(RootProc, Port, Block, CheckLimit, BusyCnt + 1)
<a name="94"/>   94:                     end
<a name="95"/>   95:             end
<a name="96"/>   96:     end.
<a name="97"/>   97: 
<a name="check_dead-4"/><a name="98"/>   98: <b>check_dead</b>(RootProc, Port, Block, CheckLimit) -&gt;
<a name="99"/>   99:     ct:log(&quot;~p: check port dead~n&quot;, [self()]),
<a name="100"/>  100:     timer:sleep(?SLEEP_BEFORE_CHECK),
<a name="check_dead-last_expr"/><a name="101"/>  101: <b>    case erlang:port_command</b>(Port, Block, [nosuspend]) of
<a name="102"/>  102:         true -&gt;
<a name="103"/>  103:             ct:log(&quot;not dead~n&quot;),
<a name="104"/>  104:             run_loop(RootProc, Port, Block, CheckLimit, 0);
<a name="105"/>  105:         false -&gt;
<a name="106"/>  106:             ct:log(&quot;port dead: ~p~n&quot;, [Port]),
<a name="107"/>  107:             RootProc ! {self(), port_dead},
<a name="108"/>  108:             ok
<a name="109"/>  109:     end.
<a name="110"/>  110: 
<a name="endless_flush-1"/><a name="111"/>  111: <b>endless_flush</b>(Port) -&gt;
<a name="endless_flush-last_expr"/><a name="112"/>  112:     receive
<a name="113"/>  113:         {Port, {data, _}} -&gt;
<a name="114"/>  114:             endless_flush(Port);
<a name="115"/>  115:         {Port, SomethingWrong} -&gt;
<a name="116"/>  116:             erlang:error({someting_wrong, SomethingWrong})
<a name="117"/>  117:     end.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
