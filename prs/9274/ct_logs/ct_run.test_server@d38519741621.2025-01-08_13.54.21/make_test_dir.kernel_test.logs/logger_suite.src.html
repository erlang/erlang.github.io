<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/kernel/make_test_dir/kernel_test/logger_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2018-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(logger_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <b>-compile</b>(export_all).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="25"/>   25: <b>-include_lib</b>(&quot;kernel/include/logger.hrl&quot;).
<a name="26"/>   26: <b>-include_lib</b>(&quot;kernel/src/logger_internal.hrl&quot;).
<a name="27"/>   27: <b>-include_lib</b>(&quot;stdlib/include/assert.hrl&quot;).
<a name="28"/>   28: 
<a name="29"/>   29: <b>-define</b>(str,&quot;Log from &quot;++atom_to_list(?FUNCTION_NAME)++
<a name="30"/>   30:             &quot;:&quot;++integer_to_list(?LINE)).
<a name="31"/>   31: <b>-define</b>(map_rep,#{function=&gt;?FUNCTION_NAME, line=&gt;?LINE}).
<a name="32"/>   32: <b>-define</b>(keyval_rep,[{function,?FUNCTION_NAME}, {line,?LINE}]).
<a name="33"/>   33: 
<a name="34"/>   34: <b>-define</b>(MY_LOC(N),#{mfa=&gt;{?MODULE,?FUNCTION_NAME,?FUNCTION_ARITY},
<a name="35"/>   35:                     file=&gt;?FILE, line=&gt;?LINE-N}).
<a name="36"/>   36: 
<a name="37"/>   37: <b>-define</b>(TRY(X), my_try(fun() -&gt; X end)).
<a name="38"/>   38: 
<a name="39"/>   39: 
<a name="suite-0"/><a name="40"/>   40: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="41"/>   41:     [{timetrap,{seconds,30}}].
<a name="42"/>   42: 
<a name="init_per_suite-1"/><a name="43"/>   43: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="44"/>   44: <b>    case logger:get_handler_config</b>(?STANDARD_HANDLER) of
<a name="45"/>   45:         {ok,StdH} -&gt;
<a name="46"/>   46:             ok = logger:remove_handler(?STANDARD_HANDLER),
<a name="47"/>   47:             [{default_handler,StdH}|Config];
<a name="48"/>   48:         _ -&gt;
<a name="49"/>   49:             Config
<a name="50"/>   50:     end.
<a name="51"/>   51: 
<a name="end_per_suite-1"/><a name="52"/>   52: <b>end_per_suite</b>(Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="53"/>   53: <b>    case ?config</b>(default_handler,Config) of
<a name="54"/>   54:         #{module:=HMod} = HConfig -&gt;
<a name="55"/>   55:             ok = logger:add_handler(?STANDARD_HANDLER,HMod,HConfig);
<a name="56"/>   56:         _ -&gt;
<a name="57"/>   57:             ok
<a name="58"/>   58:     end.
<a name="59"/>   59: 
<a name="init_per_group-2"/><a name="60"/>   60: <b>init_per_group</b>(_Group, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="61"/>   61:     Config.
<a name="62"/>   62: 
<a name="end_per_group-2"/><a name="63"/>   63: <b>end_per_group</b>(_Group, _Config) -&gt;
<a name="end_per_group-last_expr"/><a name="64"/>   64:     ok.
<a name="65"/>   65: 
<a name="init_per_testcase-2"/><a name="66"/>   66: <b>init_per_testcase</b>(_TestCase, Config) -&gt;
<a name="67"/>   67:     PC = logger:get_primary_config(),
<a name="init_per_testcase-last_expr"/><a name="68"/>   68:     [{logger_config,PC}|Config].
<a name="69"/>   69: 
<a name="end_per_testcase-2"/><a name="70"/>   70: <b>end_per_testcase</b>(Case, Config) -&gt;
<a name="71"/>   71:     try erlang:apply(?MODULE,Case,[cleanup,Config])
<a name="72"/>   72:     catch error:undef -&gt; ok
<a name="73"/>   73:     end,
<a name="end_per_testcase-last_expr"/><a name="74"/>   74:     ok.
<a name="75"/>   75: 
<a name="groups-0"/><a name="76"/>   76: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="77"/>   77:     [].
<a name="78"/>   78: 
<a name="all-0"/><a name="79"/>   79: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="80"/>   80:     [start_stop,
<a name="81"/>   81:      add_remove_handler,
<a name="82"/>   82:      multiple_handlers,
<a name="83"/>   83:      add_remove_filter,
<a name="84"/>   84:      change_config,
<a name="85"/>   85:      set_formatter,
<a name="86"/>   86:      log_no_levels,
<a name="87"/>   87:      log_all_levels_api,
<a name="88"/>   88:      macros,
<a name="89"/>   89:      set_level,
<a name="90"/>   90:      set_module_level,
<a name="91"/>   91:      set_application_level,
<a name="92"/>   92:      cache_module_level,
<a name="93"/>   93:      format_report,
<a name="94"/>   94:      filter_successful,
<a name="95"/>   95:      filter_failed,
<a name="96"/>   96:      handler_failed,
<a name="97"/>   97:      config_sanity_check,
<a name="98"/>   98:      log_failed,
<a name="99"/>   99:      emulator,
<a name="100"/>  100:      via_logger_process,
<a name="101"/>  101:      other_node,
<a name="102"/>  102:      compare_levels,
<a name="103"/>  103:      process_metadata,
<a name="104"/>  104:      app_config,
<a name="105"/>  105:      kernel_config,
<a name="106"/>  106:      pretty_print,
<a name="107"/>  107:      pathological,
<a name="108"/>  108:      internal_log].
<a name="109"/>  109: 
<a name="start_stop-1"/><a name="110"/>  110: <b>start_stop</b>(_Config) -&gt;
<a name="111"/>  111:     S = whereis(logger),
<a name="112"/>  112:     true = is_pid(S),
<a name="start_stop-last_expr"/><a name="113"/>  113:     ok.
<a name="114"/>  114: 
<a name="add_remove_handler-1"/><a name="115"/>  115: <b>add_remove_handler</b>(_Config) -&gt;
<a name="116"/>  116:     register(callback_receiver,self()),
<a name="117"/>  117:     Hs0 = logger:get_handler_config(),
<a name="118"/>  118:     {error,{not_found,h1}} = logger:get_handler_config(h1),
<a name="119"/>  119:     ok = logger:add_handler(h1,?MODULE,#{}),
<a name="120"/>  120:     [add] = test_server:messages_get(),
<a name="121"/>  121:     Hs = logger:get_handler_config(),
<a name="122"/>  122:     Hs0 = lists:filter(fun(#{id:=h1}) -&gt; false; (_) -&gt; true end, Hs),
<a name="123"/>  123:     {ok,#{module:=?MODULE,level:=all,filters:=[],filter_default:=log}} = %defaults
<a name="124"/>  124:         logger:get_handler_config(h1),
<a name="125"/>  125:     ok = logger:set_handler_config(h1,filter_default,stop),
<a name="126"/>  126:     [changing_config] = test_server:messages_get(),
<a name="127"/>  127:     ?LOG_NOTICE(&quot;hello&quot;,[]),
<a name="128"/>  128:     ok = check_no_log(),
<a name="129"/>  129:     ok = logger:set_handler_config(h1,filter_default,log),
<a name="130"/>  130:     [changing_config] = test_server:messages_get(),
<a name="131"/>  131:     {ok,#{filter_default:=log}} = logger:get_handler_config(h1),
<a name="132"/>  132:     ?LOG_NOTICE(&quot;hello&quot;,[]),
<a name="133"/>  133:     ok = check_logged(notice,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="134"/>  134:     ok = logger:remove_handler(h1),
<a name="135"/>  135:     [remove] = test_server:messages_get(),
<a name="136"/>  136:     Hs0 = logger:get_handler_config(),
<a name="137"/>  137:     {error,{not_found,h1}} = logger:get_handler_config(h1),
<a name="138"/>  138:     {error,{not_found,h1}} = logger:remove_handler(h1),
<a name="139"/>  139:     logger:notice(&quot;hello&quot;,[]),
<a name="140"/>  140:     ok = check_no_log(),
<a name="add_remove_handler-last_expr"/><a name="141"/>  141:     ok.
<a name="142"/>  142: 
<a name="add_remove_handler-2"/><a name="143"/>  143: <b>add_remove_handler</b>(cleanup,_Config) -&gt;
<a name="144"/>  144:     logger:remove_handler(h1),
<a name="add_remove_handler-last_expr"/><a name="145"/>  145:     ok.
<a name="146"/>  146: 
<a name="multiple_handlers-1"/><a name="147"/>  147: <b>multiple_handlers</b>(_Config) -&gt;
<a name="148"/>  148:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log}),
<a name="149"/>  149:     ok = logger:add_handler(h2,?MODULE,#{level=&gt;error,filter_default=&gt;log}),
<a name="150"/>  150:     ?LOG_ERROR(&quot;hello&quot;,[]),
<a name="151"/>  151:     ok = check_logged(error,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="152"/>  152:     ok = check_logged(error,&quot;hello&quot;,[],?MY_LOC(2)),
<a name="153"/>  153:     ?LOG_NOTICE(&quot;hello&quot;,[]),
<a name="154"/>  154:     ok = check_logged(notice,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="155"/>  155:     ok = check_no_log(),
<a name="multiple_handlers-last_expr"/><a name="156"/>  156:     ok.
<a name="157"/>  157: 
<a name="multiple_handlers-2"/><a name="158"/>  158: <b>multiple_handlers</b>(cleanup,_Config) -&gt;
<a name="159"/>  159:     logger:remove_handler(h1),
<a name="160"/>  160:     logger:remove_handler(h2),
<a name="multiple_handlers-last_expr"/><a name="161"/>  161:     ok.
<a name="162"/>  162: 
<a name="add_remove_filter-1"/><a name="163"/>  163: <b>add_remove_filter</b>(_Config) -&gt;
<a name="164"/>  164:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log}),
<a name="165"/>  165:     LF = {fun(Log,_) -&gt; Log#{level=&gt;error} end, []},
<a name="166"/>  166:     ok = logger:add_primary_filter(lf,LF),
<a name="167"/>  167:     {error,{already_exist,lf}} = logger:add_primary_filter(lf,LF),
<a name="168"/>  168:     {error,{already_exist,lf}} = logger:add_primary_filter(lf,{fun(Log,_) -&gt;
<a name="169"/>  169:                                                                        Log
<a name="170"/>  170:                                                                end, []}),
<a name="171"/>  171:     ?LOG_NOTICE(&quot;hello&quot;,[]),
<a name="172"/>  172:     ok = check_logged(error,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="173"/>  173:     ok = check_no_log(),
<a name="174"/>  174: 
<a name="175"/>  175:     ok = logger:add_handler(h2,?MODULE,#{level=&gt;notice,filter_default=&gt;log}),
<a name="176"/>  176:     HF = {fun(#{level:=error}=Log,_) -&gt;
<a name="177"/>  177:                   Log#{level=&gt;mylevel};
<a name="178"/>  178:              (_,_) -&gt;
<a name="179"/>  179:                   ignore
<a name="180"/>  180:           end,
<a name="181"/>  181:           []},
<a name="182"/>  182:     ok = logger:add_handler_filter(h1,hf,HF),
<a name="183"/>  183:     {error,{already_exist,hf}} = logger:add_handler_filter(h1,hf,HF),
<a name="184"/>  184:     {error,{already_exist,hf}} = logger:add_handler_filter(h1,hf,{fun(Log,_) -&gt;
<a name="185"/>  185:                                                                           Log
<a name="186"/>  186:                                                                   end, []}),
<a name="187"/>  187:     ?LOG_NOTICE(&quot;hello&quot;,[]),
<a name="188"/>  188:     ok = check_logged(mylevel,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="189"/>  189:     ok = check_logged(error,&quot;hello&quot;,[],?MY_LOC(2)),
<a name="190"/>  190: 
<a name="191"/>  191:     ok = logger:remove_primary_filter(lf),
<a name="192"/>  192:     {error,{not_found,lf}} = logger:remove_primary_filter(lf),
<a name="193"/>  193: 
<a name="194"/>  194:     ?LOG_NOTICE(&quot;hello&quot;,[]),
<a name="195"/>  195:     ok = check_logged(notice,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="196"/>  196:     ok = check_logged(notice,&quot;hello&quot;,[],?MY_LOC(2)),
<a name="197"/>  197: 
<a name="198"/>  198:     ?LOG_ERROR(&quot;hello&quot;,[]),
<a name="199"/>  199:     ok = check_logged(mylevel,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="200"/>  200:     ok = check_logged(error,&quot;hello&quot;,[],?MY_LOC(2)),
<a name="201"/>  201: 
<a name="202"/>  202:     ok = logger:remove_handler_filter(h1,hf),
<a name="203"/>  203:     {error,{not_found,hf}} = logger:remove_handler_filter(h1,hf),
<a name="204"/>  204:     ?LOG_NOTICE(&quot;hello&quot;,[]),
<a name="205"/>  205:     ok = check_logged(notice,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="206"/>  206:     ok = check_logged(notice,&quot;hello&quot;,[],?MY_LOC(2)),
<a name="207"/>  207: 
<a name="208"/>  208:     ?LOG_ERROR(&quot;hello&quot;,[]),
<a name="209"/>  209:     ok = check_logged(error,&quot;hello&quot;,[],?MY_LOC(1)),
<a name="210"/>  210:     ok = check_logged(error,&quot;hello&quot;,[],?MY_LOC(2)),
<a name="add_remove_filter-last_expr"/><a name="211"/>  211:     ok.
<a name="212"/>  212: 
<a name="add_remove_filter-2"/><a name="213"/>  213: <b>add_remove_filter</b>(cleanup,_Config) -&gt;
<a name="214"/>  214:     logger:remove_primary_filter(lf),
<a name="215"/>  215:     logger:remove_handler(h1),
<a name="216"/>  216:     logger:remove_handler(h2),
<a name="add_remove_filter-last_expr"/><a name="217"/>  217:     ok.
<a name="218"/>  218: 
<a name="change_config-1"/><a name="219"/>  219: <b>change_config</b>(_Config) -&gt;
<a name="220"/>  220:     %% Overwrite handler config - check that defaults are added
<a name="221"/>  221:     {error,{not_found,h1}} = logger:set_handler_config(h1,#{}),
<a name="222"/>  222:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,custom=&gt;custom}),
<a name="223"/>  223:     {ok,#{module:=?MODULE,level:=notice,filter_default:=log,custom:=custom}} =
<a name="224"/>  224:         logger:get_handler_config(h1),
<a name="225"/>  225:     register(callback_receiver,self()),
<a name="226"/>  226:     ok = logger:set_handler_config(h1,#{filter_default=&gt;stop}),
<a name="227"/>  227:     [changing_config] = test_server:messages_get(),
<a name="228"/>  228:     {ok,#{module:=?MODULE,level:=all,filter_default:=stop}=C2} =
<a name="229"/>  229:         logger:get_handler_config(h1),
<a name="230"/>  230:     false = maps:is_key(custom,C2),
<a name="231"/>  231:     {error,fail} = logger:set_handler_config(h1,#{conf_call=&gt;fun() -&gt; {error,fail} end}),
<a name="232"/>  232:     {error,{attempting_syncronous_call_to_self,_}} =
<a name="233"/>  233:         logger:set_handler_config(
<a name="234"/>  234:           h1,#{conf_call=&gt;fun() -&gt; logger:set_handler_config(?MODULE,#{}) end}),
<a name="235"/>  235:     ok =
<a name="236"/>  236:         logger:set_handler_config(
<a name="237"/>  237:           h1,#{conf_call=&gt;fun() -&gt; logger:set_module_level(?MODULE,debug) end}),
<a name="238"/>  238:     {ok,C2} = logger:get_handler_config(h1),
<a name="239"/>  239: 
<a name="240"/>  240:     %% Change handler config: Single key
<a name="241"/>  241:     {error,fail} = logger:set_handler_config(h1,conf_call,fun() -&gt; {error,fail} end),
<a name="242"/>  242:     ok = logger:set_handler_config(h1,custom,custom),
<a name="243"/>  243:     [changing_config] = test_server:messages_get(),
<a name="244"/>  244:     {ok,#{custom:=custom}=C3} = logger:get_handler_config(h1),
<a name="245"/>  245:     C2 = maps:remove(custom,C3),
<a name="246"/>  246: 
<a name="247"/>  247:     %% Change handler config: Map
<a name="248"/>  248:     ok = logger:update_handler_config(h1,#{custom=&gt;new_custom}),
<a name="249"/>  249:     [changing_config] = test_server:messages_get(),
<a name="250"/>  250:     {ok,C4} = logger:get_handler_config(h1),
<a name="251"/>  251:     C4 = C3#{custom:=new_custom},
<a name="252"/>  252: 
<a name="253"/>  253:     %% Change handler config: Id and module can not be changed
<a name="254"/>  254:     {error,{illegal_config_change,Old,New}} =
<a name="255"/>  255:         logger:set_handler_config(h1,id,newid),
<a name="256"/>  256:     %% Check that only the faulty field is included in return
<a name="257"/>  257:     [{id,h1}] = maps:to_list(Old),
<a name="258"/>  258:     [{id,newid}] = maps:to_list(New),
<a name="259"/>  259:     %% Check that both fields are included when both are changed
<a name="260"/>  260:     {error,{illegal_config_change,
<a name="261"/>  261:             #{id:=h1,module:=?MODULE},
<a name="262"/>  262:             #{id:=newid,module:=newmodule}}} =
<a name="263"/>  263:         logger:set_handler_config(h1,#{id=&gt;newid,module=&gt;newmodule}),
<a name="264"/>  264: 
<a name="265"/>  265:     %% Change primary config: Single key
<a name="266"/>  266:     PConfig0 = logger:get_primary_config(),
<a name="267"/>  267:     ok = logger:set_primary_config(level,warning),
<a name="268"/>  268:     PConfig1 = logger:get_primary_config(),
<a name="269"/>  269:     PConfig1 = PConfig0#{level:=warning},
<a name="270"/>  270: 
<a name="271"/>  271:     %% Change primary config: Map
<a name="272"/>  272:     ok = logger:update_primary_config(#{level=&gt;error}),
<a name="273"/>  273:     PConfig2 = logger:get_primary_config(),
<a name="274"/>  274:     PConfig2 = PConfig1#{level:=error},
<a name="275"/>  275: 
<a name="276"/>  276:     %% Overwrite primary config - check that defaults are added
<a name="277"/>  277:     ok = logger:set_primary_config(#{filter_default=&gt;stop}),
<a name="278"/>  278:     #{level:=notice,filters:=[],filter_default:=stop}=PC1 =
<a name="279"/>  279:         logger:get_primary_config(),
<a name="280"/>  280:     4 = maps:size(PC1),
<a name="281"/>  281:     %% Check that internal 'handlers' field has not been changed
<a name="282"/>  282:     MS = [{{{?HANDLER_KEY,'$1'},'_'},[],['$1']}],
<a name="283"/>  283:     HIds1 = lists:sort(ets:select(?LOGGER_TABLE,MS)), % dirty, internal data
<a name="284"/>  284:     HIds2 = lists:sort(logger:get_handler_ids()),
<a name="285"/>  285:     HIds1 = HIds2,
<a name="286"/>  286: 
<a name="287"/>  287:     %% Cleanup
<a name="288"/>  288:     ok = logger:set_primary_config(PConfig0),
<a name="289"/>  289:     [] = test_server:messages_get(),
<a name="290"/>  290: 
<a name="change_config-last_expr"/><a name="291"/>  291:     ok.
<a name="292"/>  292: 
<a name="change_config-2"/><a name="293"/>  293: <b>change_config</b>(cleanup,Config) -&gt;
<a name="294"/>  294:     logger:remove_handler(h1),
<a name="295"/>  295:     PC = ?config(logger_config,Config),
<a name="296"/>  296:     logger:set_primary_config(PC),
<a name="change_config-last_expr"/><a name="297"/>  297:     ok.
<a name="298"/>  298: 
<a name="set_formatter-1"/><a name="299"/>  299: <b>set_formatter</b>(_Config) -&gt;
<a name="300"/>  300:     {error,{not_found,h1}}=logger:set_handler_config(h1,formatter,{?MODULE,[]}),
<a name="301"/>  301:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log}),
<a name="302"/>  302:     ok = logger:set_handler_config(h1,formatter,{?MODULE,[]}),
<a name="303"/>  303:     logger:notice(&quot;hello&quot;,[]),
<a name="304"/>  304:     receive
<a name="305"/>  305:         {_Log,#{formatter:={?MODULE,[]}}} -&gt;
<a name="306"/>  306:             ok
<a name="307"/>  307:     after 500 -&gt;
<a name="308"/>  308:             ct:fail({timeout,no_log,process_info(self(),messages)})
<a name="309"/>  309:     end,
<a name="set_formatter-last_expr"/><a name="310"/>  310:     ok.
<a name="311"/>  311: 
<a name="set_formatter-2"/><a name="312"/>  312: <b>set_formatter</b>(cleanup,_Config) -&gt;
<a name="313"/>  313:     logger:remove_handler(h1),
<a name="set_formatter-last_expr"/><a name="314"/>  314:     ok.
<a name="315"/>  315: 
<a name="log_no_levels-1"/><a name="316"/>  316: <b>log_no_levels</b>(_Config) -&gt;
<a name="317"/>  317:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;all,filter_default=&gt;log}),
<a name="318"/>  318:     logger:notice(M1=?map_rep),
<a name="319"/>  319:     ok = check_logged(notice,M1,#{}),
<a name="320"/>  320: 
<a name="321"/>  321:     Levels = [emergency,alert,critical,error,warning,notice,info,debug],
<a name="322"/>  322:     ok = logger:set_primary_config(level,none),
<a name="323"/>  323:     [logger:Level(#{Level=&gt;rep}) || Level &lt;- Levels],
<a name="324"/>  324:     ok = check_no_log(),
<a name="325"/>  325:     
<a name="326"/>  326:     ok = logger:set_primary_config(level,all),
<a name="327"/>  327:     M2 = ?map_rep,
<a name="328"/>  328:     ?LOG_NOTICE(M2),
<a name="329"/>  329:     ok = check_logged(notice,M2,#{}),
<a name="330"/>  330: 
<a name="331"/>  331:     ok = logger:set_module_level(?MODULE,none),
<a name="332"/>  332:     ?LOG_EMERGENCY(?map_rep),
<a name="333"/>  333:     ?LOG_ALERT(?map_rep),
<a name="334"/>  334:     ?LOG_CRITICAL(?map_rep),
<a name="335"/>  335:     ?LOG_ERROR(?map_rep),
<a name="336"/>  336:     ?LOG_WARNING(?map_rep),
<a name="337"/>  337:     ?LOG_NOTICE(?map_rep),
<a name="338"/>  338:     ?LOG_INFO(?map_rep),
<a name="339"/>  339:     ?LOG_DEBUG(?map_rep),
<a name="340"/>  340:     ok = check_no_log(),
<a name="341"/>  341:     
<a name="342"/>  342:     ok = logger:unset_module_level(?MODULE),
<a name="343"/>  343:     logger:notice(M3=?map_rep),
<a name="344"/>  344:     ok = check_logged(notice,M3,#{}),
<a name="345"/>  345:     
<a name="346"/>  346:     ok = logger:set_handler_config(h1,level,none),
<a name="347"/>  347:     [logger:Level(#{Level=&gt;rep}) || Level &lt;- Levels],
<a name="348"/>  348:     ok = check_no_log(),
<a name="349"/>  349:     
<a name="log_no_levels-last_expr"/><a name="350"/>  350:     ok.
<a name="log_no_levels-2"/><a name="351"/>  351: <b>log_no_levels</b>(cleanup,_Config) -&gt;
<a name="352"/>  352:     logger:remove_handler(h1),
<a name="353"/>  353:     logger:set_primary_config(level,notice),
<a name="354"/>  354:     logger:unset_module_level(?MODULE),
<a name="log_no_levels-last_expr"/><a name="355"/>  355:     ok.
<a name="356"/>  356: 
<a name="log_all_levels_api-1"/><a name="357"/>  357: <b>log_all_levels_api</b>(_Config) -&gt;
<a name="358"/>  358:     ok = logger:set_primary_config(level,all),
<a name="359"/>  359:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;all,filter_default=&gt;log}),
<a name="360"/>  360:     test_api(emergency),
<a name="361"/>  361:     test_api(alert),
<a name="362"/>  362:     test_api(critical),
<a name="363"/>  363:     test_api(error),
<a name="364"/>  364:     test_api(warning),
<a name="365"/>  365:     test_api(notice),
<a name="366"/>  366:     test_api(info),
<a name="367"/>  367:     test_api(debug),
<a name="368"/>  368:     test_log_function(emergency),
<a name="log_all_levels_api-last_expr"/><a name="369"/>  369:     ok.
<a name="370"/>  370: 
<a name="log_all_levels_api-2"/><a name="371"/>  371: <b>log_all_levels_api</b>(cleanup,_Config) -&gt;
<a name="372"/>  372:     logger:remove_handler(h1),
<a name="373"/>  373:     logger:set_primary_config(level,notice),
<a name="log_all_levels_api-last_expr"/><a name="374"/>  374:     ok.
<a name="375"/>  375: 
<a name="macros-1"/><a name="376"/>  376: <b>macros</b>(_Config) -&gt;
<a name="377"/>  377:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;all,filter_default=&gt;log}),
<a name="378"/>  378:     test_macros(emergency),
<a name="379"/>  379:     test_log_macro(alert),
<a name="macros-last_expr"/><a name="380"/>  380:     ok.
<a name="381"/>  381: 
<a name="macros-2"/><a name="382"/>  382: <b>macros</b>(cleanup,_Config) -&gt;
<a name="383"/>  383:     logger:remove_handler(h1),
<a name="384"/>  384:     logger:unset_module_level(?MODULE),
<a name="macros-last_expr"/><a name="385"/>  385:     ok.
<a name="386"/>  386: 
<a name="set_level-1"/><a name="387"/>  387: <b>set_level</b>(_Config) -&gt;
<a name="388"/>  388:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;all,filter_default=&gt;log}),
<a name="389"/>  389:     logger:debug(?map_rep),
<a name="390"/>  390:     ok = check_no_log(),
<a name="391"/>  391:     logger:notice(M1=?map_rep),
<a name="392"/>  392:     ok = check_logged(notice,M1,#{}),
<a name="393"/>  393:     ok = logger:set_primary_config(level,debug),
<a name="394"/>  394:     logger:debug(M2=?map_rep),
<a name="395"/>  395:     ok = check_logged(debug,M2,#{}),
<a name="set_level-last_expr"/><a name="396"/>  396:     ok.
<a name="397"/>  397: 
<a name="set_level-2"/><a name="398"/>  398: <b>set_level</b>(cleanup,_Config) -&gt;
<a name="399"/>  399:     logger:remove_handler(h1),
<a name="400"/>  400:     logger:set_primary_config(level,notice),
<a name="set_level-last_expr"/><a name="401"/>  401:     ok.
<a name="402"/>  402: 
<a name="set_module_level-1"/><a name="403"/>  403: <b>set_module_level</b>(_Config) -&gt;
<a name="404"/>  404:     [] = logger:get_module_level([?MODULE,other]),
<a name="405"/>  405:     [] = logger:get_module_level(?MODULE),
<a name="406"/>  406:     [] = logger:get_module_level(),
<a name="407"/>  407: 
<a name="408"/>  408:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log}),
<a name="409"/>  409:     {error,{invalid_level,bad}} = logger:set_module_level(?MODULE,bad),
<a name="410"/>  410:     {error,{not_a_list_of_modules,{bad}}} =
<a name="411"/>  411:         logger:set_module_level({bad},warning),
<a name="412"/>  412:     {error,{not_a_list_of_modules,[{bad}]}} =
<a name="413"/>  413:         logger:set_module_level([{bad}],warning),
<a name="414"/>  414:     ok = logger:set_module_level(?MODULE,warning),
<a name="415"/>  415:     [{?MODULE,warning}] = logger:get_module_level([?MODULE,other]),
<a name="416"/>  416:     [{?MODULE,warning}] = logger:get_module_level(?MODULE),
<a name="417"/>  417:     [{?MODULE,warning}] = logger:get_module_level(),
<a name="418"/>  418:     logger:notice(?map_rep,?MY_LOC(0)),
<a name="419"/>  419:     ok = check_no_log(),
<a name="420"/>  420:     logger:warning(M1=?map_rep,?MY_LOC(0)),
<a name="421"/>  421:     ok = check_logged(warning,M1,?MY_LOC(1)),
<a name="422"/>  422:     ok = logger:set_module_level(?MODULE,notice),
<a name="423"/>  423:     [{?MODULE,notice}] = logger:get_module_level([?MODULE,other]),
<a name="424"/>  424:     [{?MODULE,notice}] = logger:get_module_level(?MODULE),
<a name="425"/>  425:     [{?MODULE,notice}] = logger:get_module_level(),
<a name="426"/>  426:     logger:notice(M2=?map_rep,?MY_LOC(0)),
<a name="427"/>  427:     ok = check_logged(notice,M2,?MY_LOC(1)),
<a name="428"/>  428: 
<a name="429"/>  429:     {error,{not_a_list_of_modules,{bad}}} = logger:unset_module_level({bad}),
<a name="430"/>  430:     {error,{not_a_list_of_modules,[{bad}]}} = logger:unset_module_level([{bad}]),
<a name="431"/>  431:     ok = logger:unset_module_level(?MODULE),
<a name="432"/>  432:     [] = logger:get_module_level([?MODULE,other]),
<a name="433"/>  433:     [] = logger:get_module_level(?MODULE),
<a name="434"/>  434:     [] = logger:get_module_level(),
<a name="435"/>  435: 
<a name="436"/>  436:     ok = logger:set_module_level([m1,m2,m3],notice),
<a name="437"/>  437:     [{m1,notice},{m2,notice},{m3,notice}] = logger:get_module_level(),
<a name="438"/>  438:     ok = logger:unset_module_level(m2),
<a name="439"/>  439:     [{m1,notice},{m3,notice}] = logger:get_module_level(),
<a name="440"/>  440:     ok = logger:unset_module_level(),
<a name="441"/>  441:     [] = logger:get_module_level(),
<a name="442"/>  442: 
<a name="set_module_level-last_expr"/><a name="443"/>  443:     ok.
<a name="444"/>  444: 
<a name="set_module_level-2"/><a name="445"/>  445: <b>set_module_level</b>(cleanup,_Config) -&gt;
<a name="446"/>  446:     logger:remove_handler(h1),
<a name="447"/>  447:     logger:unset_module_level(?MODULE),
<a name="set_module_level-last_expr"/><a name="448"/>  448:     ok.
<a name="449"/>  449: 
<a name="set_application_level-1"/><a name="450"/>  450: <b>set_application_level</b>(_Config) -&gt;
<a name="451"/>  451: 
<a name="452"/>  452:     {error,{not_loaded,mnesia}} = logger:set_application_level(mnesia, warning),
<a name="453"/>  453:     {error,{not_loaded,mnesia}} = logger:unset_application_level(mnesia),
<a name="454"/>  454: 
<a name="set_application_level-last_expr"/><a name="455"/>  455: <b>    case application:load</b>(mnesia) of
<a name="456"/>  456:         ok -&gt;
<a name="457"/>  457:             {ok, Modules} = application:get_key(mnesia, modules),
<a name="458"/>  458:             [] = logger:get_module_level(Modules),
<a name="459"/>  459: 
<a name="460"/>  460:             {error,{invalid_level,warn}} =
<a name="461"/>  461:                 logger:set_application_level(mnesia, warn),
<a name="462"/>  462: 
<a name="463"/>  463:             ok = logger:set_application_level(mnesia, debug),
<a name="464"/>  464:             DebugModules = lists:sort([{M,debug} || M &lt;- Modules]),
<a name="465"/>  465:             DebugModules = lists:sort(logger:get_module_level(Modules)),
<a name="466"/>  466: 
<a name="467"/>  467:             ok = logger:set_application_level(mnesia, warning),
<a name="468"/>  468: 
<a name="469"/>  469:             WarnModules = lists:sort([{M,warning} || M &lt;- Modules]),
<a name="470"/>  470:             WarnModules = lists:sort(logger:get_module_level(Modules)),
<a name="471"/>  471: 
<a name="472"/>  472:             ok = logger:unset_application_level(mnesia),
<a name="473"/>  473:             [] = logger:get_module_level(Modules);
<a name="474"/>  474:         {error,{&quot;no such file or directory&quot;,&quot;mnesia.app&quot;}} -&gt;
<a name="475"/>  475:             {skip, &quot;Cannot load mnesia, does not exist&quot;}
<a name="476"/>  476:     end.
<a name="477"/>  477: 
<a name="set_application_level-2"/><a name="478"/>  478: <b>set_application_level</b>(cleanup,_Config) -&gt;
<a name="479"/>  479:     _ = logger:unset_application_level(mnesia),
<a name="480"/>  480:     _ = application:unload(mnesia),
<a name="set_application_level-last_expr"/><a name="481"/>  481:     ok.
<a name="482"/>  482: 
<a name="cache_module_level-1"/><a name="483"/>  483: <b>cache_module_level</b>(_Config) -&gt;
<a name="484"/>  484: 
<a name="485"/>  485:     %% This test does a lot of whitebox tests so be prepared for that
<a name="486"/>  486:     persistent_term:erase({logger_config,?MODULE}),
<a name="487"/>  487: 
<a name="488"/>  488:     primary = persistent_term:get({logger_config,?MODULE}, primary),
<a name="489"/>  489:     ?LOG_NOTICE(?map_rep),
<a name="490"/>  490:     5 = persistent_term:get({logger_config,?MODULE}, primary),
<a name="491"/>  491:     logger:set_primary_config(level, info),
<a name="492"/>  492:     6 = persistent_term:get({logger_config,?MODULE}, primary),
<a name="cache_module_level-last_expr"/><a name="493"/>  493:     ok.
<a name="494"/>  494: 
<a name="cache_module_level-2"/><a name="495"/>  495: <b>cache_module_level</b>(cleanup,_Config) -&gt;
<a name="496"/>  496:     logger:unset_module_level(?MODULE),
<a name="cache_module_level-last_expr"/><a name="497"/>  497:     ok.
<a name="498"/>  498: 
<a name="format_report-1"/><a name="499"/>  499: <b>format_report</b>(_Config) -&gt;
<a name="500"/>  500:     {&quot;~ts&quot;,[&quot;string&quot;]} = logger:format_report(&quot;string&quot;),
<a name="501"/>  501:     {&quot;~tp&quot;,[&quot;strin&quot;++$g]} =
<a name="502"/>  502:         logger:format_report(&quot;strin&quot;++$g), %% improper list
<a name="503"/>  503:     {&quot;~tp&quot;,[term]} = logger:format_report(term),
<a name="504"/>  504:     {&quot;~tp&quot;,[[]]} = logger:format_report([]),
<a name="505"/>  505:     {&quot;    ~tp: ~tp&quot;,[key,value]} = logger:format_report([{key,value}]),
<a name="506"/>  506:     {&quot;    ~tp: ~tp&quot;,[key,&quot;strin&quot;++$g]} =
<a name="507"/>  507:         logger:format_report([{key,&quot;strin&quot;++$g}]), %% improper list
<a name="508"/>  508:     KeyVals = [{key1,value1},{key2,&quot;value2&quot;},{key3,[]}],
<a name="509"/>  509:     KeyValRes =
<a name="510"/>  510:         {&quot;    ~tp: ~tp\n    ~tp: ~ts\n    ~tp: ~tp&quot;,
<a name="511"/>  511:          [key1,value1,key2,&quot;value2&quot;,key3,[]]} =
<a name="512"/>  512:         logger:format_report(KeyVals),
<a name="513"/>  513:     KeyValRes = logger:format_report(maps:from_list(KeyVals)),
<a name="514"/>  514:     KeyValRes = logger:format_otp_report(#{label=&gt;{?MODULE,test},report=&gt;KeyVals}),
<a name="515"/>  515:     {&quot;    ~tp: ~tp\n    ~tp: ~tp&quot;,
<a name="516"/>  516:      [label,{?MODULE,test},report,KeyVals]} =
<a name="517"/>  517:         logger:format_report(#{label=&gt;{?MODULE,test},report=&gt;KeyVals}),
<a name="518"/>  518: 
<a name="519"/>  519:     {&quot;    ~tp: ~tp\n    ~tp&quot;,[key1,value1,term]} =
<a name="520"/>  520:         logger:format_report([{key1,value1},term]),
<a name="521"/>  521: 
<a name="522"/>  522:     {&quot;    ~tp: ~tp\n    ~tp&quot;,[key1,value1,[]]} =
<a name="523"/>  523:         logger:format_report([{key1,value1},[]]),
<a name="524"/>  524: 
<a name="525"/>  525:     {&quot;~tp&quot;,[[]]} = logger:format_report([[],[],[]]),
<a name="526"/>  526: 
<a name="format_report-last_expr"/><a name="527"/>  527:     ok.
<a name="528"/>  528: 
<a name="filter_successful-1"/><a name="529"/>  529: <b>filter_successful</b>(_Config) -&gt;
<a name="530"/>  530:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;all,filter_default=&gt;log}),
<a name="531"/>  531:     HF = {fun(#{meta:=#{filter:={set_msg,Msg}}} = Log,_) -&gt;
<a name="532"/>  532:                   Log#{msg:=Msg};
<a name="533"/>  533:              (#{meta:=#{filter:={return,Ret}}},_) -&gt;
<a name="534"/>  534:                   Ret
<a name="535"/>  535:           end,
<a name="536"/>  536:           []},
<a name="537"/>  537:     ok = logger:add_handler_filter(h1,hf,HF),
<a name="538"/>  538: 
<a name="539"/>  539:     ?LOG_NOTICE(&quot;hello&quot;,#{filter=&gt;{return,stop}}),
<a name="540"/>  540:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="541"/>  541:     ok = check_no_log(),
<a name="542"/>  542: 
<a name="543"/>  543:     ?LOG_NOTICE(&quot;hello&quot;,#{filter=&gt;{return,ignore}}),
<a name="544"/>  544:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="545"/>  545:     ok = check_logged(notice,&quot;hello&quot;,?MY_LOC(2)),
<a name="546"/>  546: 
<a name="547"/>  547:     ?LOG_NOTICE(&quot;&quot;,#{filter=&gt;{set_msg,{'hello',[]}}}),
<a name="548"/>  548:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="549"/>  549:     ok = check_logged(notice,'hello',[],?MY_LOC(2)),
<a name="550"/>  550: 
<a name="551"/>  551:     ?LOG_NOTICE(&quot;&quot;,#{filter=&gt;{set_msg,{&quot;hello&quot;,[]}}}),
<a name="552"/>  552:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="553"/>  553:     ok = check_logged(notice,&quot;hello&quot;,[],?MY_LOC(2)),
<a name="554"/>  554: 
<a name="555"/>  555:     ?LOG_NOTICE(&quot;&quot;,#{filter=&gt;{set_msg,{&lt;&lt;&quot;hello&quot;&gt;&gt;,[]}}}),
<a name="556"/>  556:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="557"/>  557:     ok = check_logged(notice,&lt;&lt;&quot;hello&quot;&gt;&gt;,[],?MY_LOC(2)),
<a name="558"/>  558: 
<a name="559"/>  559:     ?LOG_NOTICE(&quot;&quot;,#{filter=&gt;{set_msg,{string,&quot;hello&quot;}}}),
<a name="560"/>  560:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="561"/>  561:     ok = check_logged(notice,&quot;hello&quot;,?MY_LOC(2)),
<a name="562"/>  562: 
<a name="563"/>  563:     ?LOG_NOTICE(&quot;&quot;,#{filter=&gt;{set_msg,{string,&lt;&lt;&quot;hello&quot;&gt;&gt;}}}),
<a name="564"/>  564:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="565"/>  565:     ok = check_logged(notice,&lt;&lt;&quot;hello&quot;&gt;&gt;,?MY_LOC(2)),
<a name="566"/>  566: 
<a name="567"/>  567:     logger:notice(&quot;&quot;,#{filter=&gt;{set_msg,{report,M1=?map_rep}}}),
<a name="568"/>  568:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="569"/>  569:     ok = check_logged(notice,M1,#{}),
<a name="570"/>  570: 
<a name="571"/>  571:     logger:notice(&quot;&quot;,#{filter=&gt;{set_msg,{report,M2=?keyval_rep}}}),
<a name="572"/>  572:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="573"/>  573:     ok = check_logged(notice,M2,#{}),
<a name="574"/>  574: 
<a name="filter_successful-last_expr"/><a name="575"/>  575:     ok.
<a name="576"/>  576: 
<a name="filter_successful-2"/><a name="577"/>  577: <b>filter_successful</b>(cleanup,_Config) -&gt;
<a name="578"/>  578:     logger:remove_handler(h1),
<a name="filter_successful-last_expr"/><a name="579"/>  579:     ok.
<a name="580"/>  580: 
<a name="filter_failed-1"/><a name="581"/>  581: <b>filter_failed</b>(_Config) -&gt;
<a name="582"/>  582:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log}),
<a name="583"/>  583: 
<a name="584"/>  584:     %% Logger filters
<a name="585"/>  585:     {error,{invalid_filter,_}} =
<a name="586"/>  586:         logger:add_primary_filter(lf,{fun(_) -&gt; ok end,args}),
<a name="587"/>  587:     ok = logger:add_primary_filter(lf,
<a name="588"/>  588:                                    {fun(_,_) -&gt;
<a name="589"/>  589:                                             erlang:error({badmatch,b})
<a name="590"/>  590:                                     end,
<a name="591"/>  591:                                     args}),
<a name="592"/>  592:     #{filters:=[_]} = logger:get_primary_config(),
<a name="593"/>  593:     ok = logger:notice(M1=?map_rep),
<a name="594"/>  594:     ok = check_logged(notice,M1,#{}),
<a name="595"/>  595:     {error,{not_found,lf}} = logger:remove_primary_filter(lf),
<a name="596"/>  596: 
<a name="597"/>  597:     ok = logger:add_primary_filter(lf,{fun(_,_) -&gt; faulty_return end,args}),
<a name="598"/>  598:     #{filters:=[_]} = logger:get_primary_config(),
<a name="599"/>  599:     ok = logger:notice(M2=?map_rep),
<a name="600"/>  600:     ok = check_logged(notice,M2,#{}),
<a name="601"/>  601:     {error,{not_found,lf}} = logger:remove_primary_filter(lf),
<a name="602"/>  602: 
<a name="603"/>  603:     %% Handler filters
<a name="604"/>  604:     {error,{not_found,h0}} =
<a name="605"/>  605:         logger:add_handler_filter(h0,hf,{fun(_,_) -&gt; ignore end,args}),
<a name="606"/>  606:     {error,{not_found,h0}} = logger:remove_handler_filter(h0,hf),
<a name="607"/>  607:     {error,{invalid_filter,_}} =
<a name="608"/>  608:         logger:add_handler_filter(h1,hf,{fun(_) -&gt; ok end,args}),
<a name="609"/>  609:     ok = logger:add_handler_filter(h1,hf,
<a name="610"/>  610:                                    {fun(_,_) -&gt;
<a name="611"/>  611:                                             erlang:error({badmatch,b})
<a name="612"/>  612:                                     end,
<a name="613"/>  613:                                     args}),
<a name="614"/>  614:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="615"/>  615:     ok = logger:notice(M3=?map_rep),
<a name="616"/>  616:     ok = check_logged(notice,M3,#{}),
<a name="617"/>  617:     {error,{not_found,hf}} = logger:remove_handler_filter(h1,hf),
<a name="618"/>  618: 
<a name="619"/>  619:     ok = logger:add_handler_filter(h1,hf,{fun(_,_) -&gt; faulty_return end,args}),
<a name="620"/>  620:     {ok,#{filters:=[_]}} = logger:get_handler_config(h1),
<a name="621"/>  621:     ok = logger:notice(M4=?map_rep),
<a name="622"/>  622:     ok = check_logged(notice,M4,#{}),
<a name="623"/>  623:     {error,{not_found,hf}} = logger:remove_handler_filter(h1,hf),
<a name="624"/>  624: 
<a name="filter_failed-last_expr"/><a name="625"/>  625:     ok.
<a name="626"/>  626: 
<a name="filter_failed-2"/><a name="627"/>  627: <b>filter_failed</b>(cleanup,_Config) -&gt;
<a name="628"/>  628:     logger:remove_handler(h1),
<a name="filter_failed-last_expr"/><a name="629"/>  629:     ok.
<a name="630"/>  630: 
<a name="handler_failed-1"/><a name="631"/>  631: <b>handler_failed</b>(_Config) -&gt;
<a name="632"/>  632:     logger:set_primary_config(level,all),
<a name="633"/>  633:     register(callback_receiver,self()),
<a name="634"/>  634:     {error,{invalid_id,1}} = logger:add_handler(1,?MODULE,#{}),
<a name="635"/>  635:     {error,{invalid_module,&quot;nomodule&quot;}} = logger:add_handler(h1,&quot;nomodule&quot;,#{}),
<a name="636"/>  636:     {error,{invalid_config,bad}} = logger:add_handler(h1,?MODULE,bad),
<a name="637"/>  637:     {error,{invalid_filters,false}} =
<a name="638"/>  638:         logger:add_handler(h1,?MODULE,#{filters=&gt;false}),
<a name="639"/>  639:     {error,{invalid_filter_default,true}} =
<a name="640"/>  640:         logger:add_handler(h1,?MODULE,#{filter_default=&gt;true}),
<a name="641"/>  641:     {error,{invalid_formatter,[]}} =
<a name="642"/>  642:         logger:add_handler(h1,?MODULE,#{formatter=&gt;[]}),
<a name="643"/>  643:     {error,{invalid_handler,_}} = logger:add_handler(h1,nomodule,#{filter_default=&gt;log}),
<a name="644"/>  644:     logger:notice(?map_rep),
<a name="645"/>  645:     check_no_log(),
<a name="646"/>  646:     H1 = logger:get_handler_config(),
<a name="647"/>  647:     false = lists:search(fun(#{id:=h1}) -&gt; true; (_) -&gt; false end,H1),
<a name="648"/>  648:     {error,{not_found,h1}} = logger:remove_handler(h1),
<a name="649"/>  649: 
<a name="650"/>  650:     ok = logger:add_handler(h2,?MODULE,
<a name="651"/>  651:                             #{filter_default =&gt; log,
<a name="652"/>  652:                               log_call =&gt; fun() -&gt;
<a name="653"/>  653:                                                   erlang:error({badmatch,b})
<a name="654"/>  654:                                           end}),
<a name="655"/>  655:     {error,{already_exist,h2}} = logger:add_handler(h2,othermodule,#{}),
<a name="656"/>  656:     [add] = test_server:messages_get(),
<a name="657"/>  657: 
<a name="658"/>  658:     logger:notice(?map_rep),
<a name="659"/>  659:     [remove] = test_server:messages_get(),
<a name="660"/>  660:     H2 = logger:get_handler_config(),
<a name="661"/>  661:     false = lists:search(fun(#{id:=h2}) -&gt; true; (_) -&gt; false end,H2),
<a name="662"/>  662:     {error,{not_found,h2}} = logger:remove_handler(h2),
<a name="663"/>  663: 
<a name="664"/>  664:     CallAddHandler = fun() -&gt; logger:add_handler(h2,?MODULE,#{}) end,
<a name="665"/>  665:     CrashHandler = fun() -&gt; erlang:error({badmatch,b}) end,
<a name="666"/>  666:     KillHandler = fun() -&gt; exit(self(), die) end,
<a name="667"/>  667: 
<a name="668"/>  668:     {error,{handler_not_added,{attempting_syncronous_call_to_self,_}}} =
<a name="669"/>  669:         logger:add_handler(h1,?MODULE,#{add_call=&gt;CallAddHandler}),
<a name="670"/>  670:     {error,{handler_not_added,{callback_crashed,_}}} =
<a name="671"/>  671:         logger:add_handler(h1,?MODULE,#{add_call=&gt;CrashHandler}),
<a name="672"/>  672:     {error,{handler_not_added,{logger_process_exited,_,die}}} =
<a name="673"/>  673:         logger:add_handler(h1,?MODULE,#{add_call=&gt;KillHandler}),
<a name="674"/>  674: 
<a name="675"/>  675:     check_no_log(),
<a name="676"/>  676:     ok = logger:add_handler(h1,?MODULE,#{tc_proc=&gt;self()}),
<a name="677"/>  677:     {error,{attempting_syncronous_call_to_self,_}} =
<a name="678"/>  678:         logger:set_handler_config(h1,#{conf_call=&gt;CallAddHandler}),
<a name="679"/>  679:     {error,{callback_crashed,_}} =
<a name="680"/>  680:         logger:set_handler_config(h1,#{conf_call=&gt;CrashHandler}),
<a name="681"/>  681:     {error,{logger_process_exited,_,die}} =
<a name="682"/>  682:         logger:set_handler_config(h1,#{conf_call=&gt;KillHandler}),
<a name="683"/>  683: 
<a name="684"/>  684:     {error,{attempting_syncronous_call_to_self,_}} =
<a name="685"/>  685:         logger:set_handler_config(h1,conf_call,CallAddHandler),
<a name="686"/>  686:     {error,{callback_crashed,_}} =
<a name="687"/>  687:         logger:set_handler_config(h1,conf_call,CrashHandler),
<a name="688"/>  688:     {error,{logger_process_exited,_,die}} =
<a name="689"/>  689:         logger:set_handler_config(h1,conf_call,KillHandler),
<a name="690"/>  690: 
<a name="691"/>  691:     ok = logger:remove_handler(h1),
<a name="692"/>  692:     [add,{#{level:=error},_},{#{level:=error},_},
<a name="693"/>  693:      {#{level:=error},_},{#{level:=error},_},remove] = test_server:messages_get(),
<a name="694"/>  694: 
<a name="695"/>  695:     check_no_log(),
<a name="696"/>  696:     ok = logger:add_handler(h1,?MODULE,#{rem_call=&gt;CallAddHandler}),
<a name="697"/>  697:     ok = logger:remove_handler(h1),
<a name="698"/>  698:     ok = logger:add_handler(h1,?MODULE,#{rem_call=&gt;CrashHandler}),
<a name="699"/>  699:     ok = logger:remove_handler(h1),
<a name="700"/>  700:     ok = logger:add_handler(h1,?MODULE,#{rem_call=&gt;KillHandler}),
<a name="701"/>  701:     ok = logger:remove_handler(h1),
<a name="702"/>  702:     [add,add,add] = test_server:messages_get(),
<a name="703"/>  703: 
<a name="handler_failed-last_expr"/><a name="704"/>  704:     ok.
<a name="705"/>  705: 
<a name="handler_failed-2"/><a name="706"/>  706: <b>handler_failed</b>(cleanup,_Config) -&gt;
<a name="707"/>  707:     logger:remove_handler(h1),
<a name="708"/>  708:     logger:remove_handler(h2),
<a name="709"/>  709:     logger:set_primary_config(level,info),
<a name="handler_failed-last_expr"/><a name="710"/>  710:     ok.
<a name="711"/>  711: 
<a name="config_sanity_check-1"/><a name="712"/>  712: <b>config_sanity_check</b>(_Config) -&gt;
<a name="713"/>  713:     %% Primary config
<a name="714"/>  714:     {error,{invalid_config,bad}} = logger:set_primary_config(bad),
<a name="715"/>  715:     {error,{invalid_filter_default,bad}} =
<a name="716"/>  716:         logger:set_primary_config(filter_default,bad),
<a name="717"/>  717:     {error,{invalid_level,bad}} = logger:set_primary_config(level,bad),
<a name="718"/>  718:     {error,{invalid_filters,bad}} = logger:set_primary_config(filters,bad),
<a name="719"/>  719:     {error,{invalid_filter,bad}} = logger:set_primary_config(filters,[bad]),
<a name="720"/>  720:     {error,{invalid_filter,{_,_}}} =
<a name="721"/>  721:         logger:set_primary_config(filters,[{id,bad}]),
<a name="722"/>  722:     {error,{invalid_filter,{_,{_,_}}}} =
<a name="723"/>  723:         logger:set_primary_config(filters,[{id,{bad,args}}]),
<a name="724"/>  724:     {error,{invalid_filter,{_,{_,_}}}} =
<a name="725"/>  725:         logger:set_primary_config(filters,[{id,{fun() -&gt; ok end,args}}]),
<a name="726"/>  726:     {error,{invalid_primary_config,{bad,bad}}} =
<a name="727"/>  727:         logger:set_primary_config(bad,bad),
<a name="728"/>  728: 
<a name="729"/>  729:     %% Handler config
<a name="730"/>  730:     {error,{not_found,h1}} = logger:set_handler_config(h1,a,b),
<a name="731"/>  731:     ok = logger:add_handler(h1,?MODULE,#{}),
<a name="732"/>  732:     {error,{invalid_filter_default,bad}} =
<a name="733"/>  733:         logger:set_handler_config(h1,filter_default,bad),
<a name="734"/>  734:     {error,{invalid_level,bad}} = logger:set_handler_config(h1,level,bad),
<a name="735"/>  735:     {error,{invalid_filters,bad}} = logger:set_handler_config(h1,filters,bad),
<a name="736"/>  736:     {error,{invalid_filter,bad}} = logger:set_handler_config(h1,filters,[bad]),
<a name="737"/>  737:     {error,{invalid_filter,{_,_}}} =
<a name="738"/>  738:         logger:set_handler_config(h1,filters,[{id,bad}]),
<a name="739"/>  739:     {error,{invalid_filter,{_,{_,_}}}} =
<a name="740"/>  740:         logger:set_handler_config(h1,filters,[{id,{bad,args}}]),
<a name="741"/>  741:     {error,{invalid_filter,{_,{_,_}}}} =
<a name="742"/>  742:         logger:set_handler_config(h1,filters,[{id,{fun() -&gt; ok end,args}}]),
<a name="743"/>  743:     {error,{invalid_formatter,bad}} =
<a name="744"/>  744:         logger:set_handler_config(h1,formatter,bad),
<a name="745"/>  745:     {error,{invalid_module,{bad}}} =
<a name="746"/>  746:         logger:set_handler_config(h1,formatter,{{bad},cfg}),
<a name="747"/>  747:     {error,{invalid_formatter_config,logger_formatter,bad}} =
<a name="748"/>  748:         logger:set_handler_config(h1,formatter,{logger_formatter,bad}),
<a name="749"/>  749:     {error,{invalid_formatter_config,logger_formatter,{bad,bad}}} =
<a name="750"/>  750:         logger:set_handler_config(h1,formatter,{logger_formatter,#{bad=&gt;bad}}),
<a name="751"/>  751:     {error,{invalid_formatter_template,logger_formatter,bad}} =
<a name="752"/>  752:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="753"/>  753:                                                 #{template=&gt;bad}}),
<a name="754"/>  754:     {error,{invalid_formatter_template,logger_formatter,[1]}} =
<a name="755"/>  755:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="756"/>  756:                                                 #{template=&gt;[1]}}),
<a name="757"/>  757:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="758"/>  758:                                                  #{template=&gt;[]}}),
<a name="759"/>  759:     {error,{invalid_formatter_config,logger_formatter,{single_line,bad}}} =
<a name="760"/>  760:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="761"/>  761:                                                 #{single_line=&gt;bad}}),
<a name="762"/>  762:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="763"/>  763:                                                  #{single_line=&gt;true}}),
<a name="764"/>  764:     {error,{invalid_formatter_config,logger_formatter,{legacy_header,bad}}} =
<a name="765"/>  765:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="766"/>  766:                                                 #{legacy_header=&gt;bad}}),
<a name="767"/>  767:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="768"/>  768:                                                  #{legacy_header=&gt;true}}),
<a name="769"/>  769:     {error,{invalid_formatter_config,logger_formatter,{report_cb,bad}}} =
<a name="770"/>  770:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="771"/>  771:                                                 #{report_cb=&gt;bad}}),
<a name="772"/>  772:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="773"/>  773:                                                  #{report_cb=&gt;fun(R) -&gt;
<a name="774"/>  774:                                                                       {&quot;~p&quot;,[R]}
<a name="775"/>  775:                                                               end}}),
<a name="776"/>  776:     {error,{invalid_formatter_config,logger_formatter,{chars_limit,bad}}} =
<a name="777"/>  777:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="778"/>  778:                                                 #{chars_limit=&gt;bad}}),
<a name="779"/>  779:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="780"/>  780:                                                  #{chars_limit=&gt;unlimited}}),
<a name="781"/>  781:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="782"/>  782:                                                  #{chars_limit=&gt;4}}),
<a name="783"/>  783:     {error,{invalid_formatter_config,logger_formatter,{depth,bad}}} =
<a name="784"/>  784:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="785"/>  785:                                                 #{depth=&gt;bad}}),
<a name="786"/>  786:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="787"/>  787:                                                  #{depth=&gt;unlimited}}),
<a name="788"/>  788:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="789"/>  789:                                                  #{depth=&gt;4}}),
<a name="790"/>  790:     {error,{invalid_formatter_config,logger_formatter,{max_size,bad}}} =
<a name="791"/>  791:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="792"/>  792:                                                 #{max_size=&gt;bad}}),
<a name="793"/>  793:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="794"/>  794:                                                  #{max_size=&gt;unlimited}}),
<a name="795"/>  795:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="796"/>  796:                                                  #{max_size=&gt;4}}),
<a name="797"/>  797:     ok = logger:set_handler_config(h1,formatter,{module,config}),
<a name="798"/>  798:     {error,{callback_crashed,{error,{badmatch,3},[{?MODULE,check_config,1,_}]}}} =
<a name="799"/>  799:         logger:set_handler_config(h1,formatter,{?MODULE,crash}),
<a name="800"/>  800:     ok = logger:set_handler_config(h1,custom,custom),
<a name="801"/>  801: 
<a name="802"/>  802:     %% Old utc parameter is no longer allowed (replaced by time_offset)
<a name="803"/>  803:     {error,{invalid_formatter_config,logger_formatter,{utc,true}}} =
<a name="804"/>  804:          logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="805"/>  805:                                                  #{utc=&gt;true}}),
<a name="806"/>  806:     {error,{invalid_formatter_config,logger_formatter,{time_offset,bad}}} =
<a name="807"/>  807:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="808"/>  808:                                                 #{time_offset=&gt;bad}}),
<a name="809"/>  809:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="810"/>  810:                                                  #{time_offset=&gt;0}}),
<a name="811"/>  811:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="812"/>  812:                                                  #{time_offset=&gt;&quot;&quot;}}),
<a name="813"/>  813:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="814"/>  814:                                                  #{time_offset=&gt;&quot;Z&quot;}}),
<a name="815"/>  815:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="816"/>  816:                                                  #{time_offset=&gt;&quot;z&quot;}}),
<a name="817"/>  817:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="818"/>  818:                                                  #{time_offset=&gt;&quot;-0:0&quot;}}),
<a name="819"/>  819:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="820"/>  820:                                                  #{time_offset=&gt;&quot;+10:13&quot;}}),
<a name="821"/>  821: 
<a name="822"/>  822:     {error,{invalid_formatter_config,logger_formatter,{time_offset,&quot;+0&quot;}}} =
<a name="823"/>  823:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="824"/>  824:                                                 #{time_offset=&gt;&quot;+0&quot;}}),
<a name="825"/>  825: 
<a name="826"/>  826:     {error,{invalid_formatter_config,logger_formatter,{time_designator,bad}}} =
<a name="827"/>  827:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="828"/>  828:                                                 #{time_designator=&gt;bad}}),
<a name="829"/>  829:     {error,{invalid_formatter_config,logger_formatter,{time_designator,&quot;s&quot;}}} =
<a name="830"/>  830:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="831"/>  831:                                                 #{time_designator=&gt;&quot;s&quot;}}),
<a name="832"/>  832:     {error,{invalid_formatter_config,logger_formatter,{time_designator,0}}} =
<a name="833"/>  833:         logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="834"/>  834:                                                 #{time_designator=&gt;0}}),
<a name="835"/>  835:     ok = logger:set_handler_config(h1,formatter,{logger_formatter,
<a name="836"/>  836:                                                  #{time_designator=&gt;$\s}}),
<a name="config_sanity_check-last_expr"/><a name="837"/>  837:     ok.
<a name="838"/>  838: 
<a name="config_sanity_check-2"/><a name="839"/>  839: <b>config_sanity_check</b>(cleanup,_Config) -&gt;
<a name="840"/>  840:     logger:remove_handler(h1),
<a name="config_sanity_check-last_expr"/><a name="841"/>  841:     ok.
<a name="842"/>  842: 
<a name="log_failed-1"/><a name="843"/>  843: <b>log_failed</b>(_Config) -&gt;
<a name="844"/>  844:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log}),
<a name="845"/>  845:     {error,function_clause} = ?TRY(logger:log(bad,?map_rep)),
<a name="846"/>  846:     {error,function_clause} = ?TRY(logger:log(notice,?map_rep,bad)),
<a name="847"/>  847:     {error,function_clause} = ?TRY(logger:log(notice,fun() -&gt; ?map_rep end,bad)),
<a name="848"/>  848:     {error,function_clause} = ?TRY(logger:log(notice,fun() -&gt; ?map_rep end,bad,#{})),
<a name="849"/>  849:     {error,function_clause} = ?TRY(logger:log(notice,bad,bad,bad)),
<a name="850"/>  850:     {error,function_clause} = ?TRY(logger:log(notice,bad,bad,#{})),
<a name="851"/>  851:     check_no_log(),
<a name="852"/>  852:     ok = logger:log(notice,M1=?str,#{}),
<a name="853"/>  853:     check_logged(notice,M1,#{}),
<a name="854"/>  854:     ok = logger:log(notice,M2=?map_rep,#{}),
<a name="855"/>  855:     check_logged(notice,M2,#{}),
<a name="856"/>  856:     ok = logger:log(notice,M3=?keyval_rep,#{}),
<a name="857"/>  857:     check_logged(notice,M3,#{}),
<a name="858"/>  858: 
<a name="859"/>  859:     %% Should we check report input more thoroughly?
<a name="860"/>  860:     ok = logger:log(notice,M4=?keyval_rep++[other,stuff,in,list],#{}),
<a name="861"/>  861:     check_logged(notice,M4,#{}),
<a name="862"/>  862: 
<a name="863"/>  863:     %% This might break a handler since it is assumed to be a format
<a name="864"/>  864:     %% string and args, so it depends how the handler protects itself
<a name="865"/>  865:     %% against something like io_lib:format(&quot;ok&quot;,&quot;ok&quot;)
<a name="866"/>  866:     ok = logger:log(notice,&quot;ok&quot;,&quot;ok&quot;,#{}),
<a name="867"/>  867:     check_logged(notice,&quot;ok&quot;,&quot;ok&quot;,#{}),
<a name="868"/>  868: 
<a name="log_failed-last_expr"/><a name="869"/>  869:     ok.
<a name="870"/>  870: 
<a name="log_failed-2"/><a name="871"/>  871: <b>log_failed</b>(cleanup,_Config) -&gt;
<a name="872"/>  872:     logger:remove_handler(h1),
<a name="log_failed-last_expr"/><a name="873"/>  873:     ok.
<a name="874"/>  874: 
<a name="emulator-1"/><a name="875"/>  875: <b>emulator</b>(_Config) -&gt;
<a name="876"/>  876:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log,
<a name="877"/>  877:                                          tc_proc=&gt;self()}),
<a name="878"/>  878:     Msg = &quot;Error in process ~p on node ~p with exit value:~n~p~n&quot;,
<a name="879"/>  879:     Error = {badmatch,4},
<a name="880"/>  880:     Stack = [{module, function, 2, []}],
<a name="881"/>  881:     Pid = spawn(?MODULE, generate_error, [Error, Stack]),
<a name="882"/>  882:     check_logged(error, Msg, [Pid, node(), {Error, Stack}],
<a name="883"/>  883:                  #{gl=&gt;group_leader(),
<a name="884"/>  884:                    error_logger=&gt;#{tag=&gt;error,emulator=&gt;true}}),
<a name="emulator-last_expr"/><a name="885"/>  885:     ok.
<a name="886"/>  886: 
<a name="emulator-2"/><a name="887"/>  887: <b>emulator</b>(cleanup, _Config) -&gt;
<a name="888"/>  888:     logger:remove_handler(h1),
<a name="emulator-last_expr"/><a name="889"/>  889:     ok.
<a name="890"/>  890: 
<a name="generate_error-2"/><a name="891"/>  891: <b>generate_error</b>(Error, Stack) -&gt;
<a name="generate_error-last_expr"/><a name="892"/>  892: <b>    erlang:raise</b>(error, Error, Stack).
<a name="893"/>  893: 
<a name="via_logger_process-1"/><a name="894"/>  894: <b>via_logger_process</b>(Config) -&gt;
<a name="895"/>  895:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log,
<a name="896"/>  896:                                          tc_proc=&gt;self()}),
<a name="897"/>  897: 
<a name="898"/>  898:     %% Explicitly send a message to the logger process
<a name="899"/>  899:     %% This is used by code_server, erl_prim_loader, init, prim_file, ...
<a name="900"/>  900:     Msg = ?str,
<a name="901"/>  901:     logger ! {log,error,Msg,[],#{}},
<a name="902"/>  902:     check_logged(error, Msg, [], #{}),
<a name="903"/>  903: 
<a name="via_logger_process-last_expr"/><a name="904"/>  904: <b>    case os:type</b>() of
<a name="905"/>  905:         {win32,_} -&gt;
<a name="906"/>  906:             %% Skip this part on windows - can't change file mode&quot;
<a name="907"/>  907:             ok;
<a name="908"/>  908:         _ -&gt;
<a name="909"/>  909:             %% This should trigger the same thing from erl_prim_loader
<a name="910"/>  910:             Dir = filename:join(?config(priv_dir,Config),&quot;dummydir&quot;),
<a name="911"/>  911:             ok = file:make_dir(Dir),
<a name="912"/>  912:             ok = file:change_mode(Dir,8#0222),
<a name="913"/>  913:             error = erl_prim_loader:list_dir(Dir),
<a name="914"/>  914:             check_logged(error,
<a name="915"/>  915:                          #{report=&gt;&quot;File operation error: eacces. Target: &quot; ++
<a name="916"/>  916:                                Dir ++&quot;. Function: list_dir. &quot;},
<a name="917"/>  917:                          #{pid=&gt;self(),
<a name="918"/>  918:                            gl=&gt;group_leader(),
<a name="919"/>  919:                            error_logger=&gt;#{tag=&gt;error_report,
<a name="920"/>  920:                                            type=&gt;std_error}}),
<a name="921"/>  921:             ok
<a name="922"/>  922:     end.
<a name="923"/>  923: 
<a name="via_logger_process-2"/><a name="924"/>  924: <b>via_logger_process</b>(cleanup, Config) -&gt;
<a name="925"/>  925:     Dir = filename:join(?config(priv_dir,Config),&quot;dummydir&quot;),
<a name="926"/>  926:     _ = file:change_mode(Dir,8#0664),
<a name="927"/>  927:     _ = file:del_dir(Dir),
<a name="928"/>  928:     logger:remove_handler(h1),
<a name="via_logger_process-last_expr"/><a name="929"/>  929:     ok.
<a name="930"/>  930: 
<a name="other_node-1"/><a name="931"/>  931: <b>other_node</b>(_Config) -&gt;
<a name="932"/>  932:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log,
<a name="933"/>  933:                                          tc_proc=&gt;self()}),
<a name="934"/>  934:     {ok,Peer,Node} = ?CT_PEER(),
<a name="935"/>  935:     rpc:call(Node,logger,error,[Msg=?str,#{}]),
<a name="936"/>  936:     check_logged(error,Msg,#{}),
<a name="937"/>  937:     peer:stop(Peer),
<a name="other_node-last_expr"/><a name="938"/>  938:     ok.
<a name="939"/>  939: 
<a name="other_node-2"/><a name="940"/>  940: <b>other_node</b>(cleanup,_Config) -&gt;
<a name="941"/>  941:     logger:remove_handler(h1),
<a name="other_node-last_expr"/><a name="942"/>  942:     ok.
<a name="943"/>  943: 
<a name="compare_levels-1"/><a name="944"/>  944: <b>compare_levels</b>(_Config) -&gt;
<a name="945"/>  945:     Levels = [none,emergency,alert,critical,error,warning,notice,info,debug,all],
<a name="946"/>  946:     ok = compare(Levels),
<a name="947"/>  947:     {error,badarg} = ?TRY(logger:compare_levels(bad,bad)),
<a name="948"/>  948:     {error,badarg} = ?TRY(logger:compare_levels({bad},notice)),
<a name="949"/>  949:     {error,badarg} = ?TRY(logger:compare_levels(notice,&quot;bad&quot;)),
<a name="compare_levels-last_expr"/><a name="950"/>  950:     ok.
<a name="951"/>  951: 
<a name="compare-1"/><a name="952"/>  952: <b>compare</b>([L|Rest]) -&gt;
<a name="953"/>  953:     eq = logger:compare_levels(L,L),
<a name="954"/>  954:     [gt = logger:compare_levels(L,L1) || L1 &lt;- Rest],
<a name="955"/>  955:     [lt = logger:compare_levels(L1,L) || L1 &lt;- Rest],
<a name="956"/>  956:     compare(Rest);
<a name="957"/>  957: <b>compare</b>([]) -&gt;
<a name="compare-last_expr"/><a name="958"/>  958:     ok.
<a name="959"/>  959: 
<a name="process_metadata-1"/><a name="960"/>  960: <b>process_metadata</b>(_Config) -&gt;
<a name="961"/>  961:     undefined = logger:get_process_metadata(),
<a name="962"/>  962:     {error,badarg} = ?TRY(logger:set_process_metadata(bad)),
<a name="963"/>  963:     ok = logger:add_handler(h1,?MODULE,#{level=&gt;notice,filter_default=&gt;log}),
<a name="964"/>  964:     Time = logger:timestamp(),
<a name="965"/>  965:     ProcMeta = #{time=&gt;Time,line=&gt;0,custom=&gt;proc},
<a name="966"/>  966:     ok = logger:set_process_metadata(ProcMeta),
<a name="967"/>  967:     S1 = ?str,
<a name="968"/>  968:     ?LOG_NOTICE(S1,#{custom=&gt;macro}),
<a name="969"/>  969:     check_logged(notice,S1,#{time=&gt;Time,line=&gt;0,custom=&gt;macro}),
<a name="970"/>  970: 
<a name="971"/>  971:     Time2 = logger:timestamp(),
<a name="972"/>  972:     S2 = ?str,
<a name="973"/>  973:     ?LOG_NOTICE(S2,#{time=&gt;Time2,line=&gt;1,custom=&gt;macro}),
<a name="974"/>  974:     check_logged(notice,S2,#{time=&gt;Time2,line=&gt;1,custom=&gt;macro}),
<a name="975"/>  975: 
<a name="976"/>  976:     logger:notice(S3=?str,#{custom=&gt;func}),
<a name="977"/>  977:     check_logged(notice,S3,#{time=&gt;Time,line=&gt;0,custom=&gt;func}),
<a name="978"/>  978: 
<a name="979"/>  979:     %% Test that primary metadata is overwritten by process metadata
<a name="980"/>  980:     ok = logger:update_primary_config(
<a name="981"/>  981:            #{metadata=&gt;#{time=&gt;Time,custom=&gt;global,global=&gt;added,line=&gt;1}}),
<a name="982"/>  982:     logger:notice(S4=?str),
<a name="983"/>  983:     check_logged(notice,S4,#{time=&gt;Time,line=&gt;0,custom=&gt;proc,global=&gt;added}),
<a name="984"/>  984: 
<a name="985"/>  985:     %% Test that primary metadata is overwritten by func metadata
<a name="986"/>  986:     %% and that primary overwrites location metadata.
<a name="987"/>  987:     ok = logger:unset_process_metadata(),
<a name="988"/>  988:     logger:notice(S5=?str,#{custom=&gt;func}),
<a name="989"/>  989:     check_logged(notice,S5,#{time=&gt;Time,line=&gt;1,custom=&gt;func,global=&gt;added}),
<a name="990"/>  990:     ok = logger:set_process_metadata(ProcMeta),
<a name="991"/>  991:     ok = logger:update_primary_config(#{metadata=&gt;#{}}),
<a name="992"/>  992: 
<a name="993"/>  993:     ProcMeta = logger:get_process_metadata(),
<a name="994"/>  994:     ok = logger:update_process_metadata(#{custom=&gt;changed,custom2=&gt;added}),
<a name="995"/>  995:     Expected = ProcMeta#{custom:=changed,custom2=&gt;added},
<a name="996"/>  996:     Expected = logger:get_process_metadata(),
<a name="997"/>  997:     ok = logger:unset_process_metadata(),
<a name="998"/>  998:     undefined = logger:get_process_metadata(),
<a name="999"/>  999: 
<a name="1000"/> 1000:     ok = logger:update_process_metadata(#{custom=&gt;added_again}),
<a name="1001"/> 1001:     {error,badarg} = ?TRY(logger:update_process_metadata(bad)),
<a name="1002"/> 1002:     #{custom:=added_again} = logger:get_process_metadata(),
<a name="1003"/> 1003: 
<a name="process_metadata-last_expr"/><a name="1004"/> 1004:     ok.
<a name="1005"/> 1005: 
<a name="process_metadata-2"/><a name="1006"/> 1006: <b>process_metadata</b>(cleanup,_Config) -&gt;
<a name="1007"/> 1007:     logger:remove_handler(h1),
<a name="process_metadata-last_expr"/><a name="1008"/> 1008:     ok.
<a name="1009"/> 1009: 
<a name="app_config-1"/><a name="1010"/> 1010: <b>app_config</b>(Config) -&gt;
<a name="1011"/> 1011:     %% Start a node with default configuration
<a name="1012"/> 1012:     {ok, _, Peer, Node} = logger_test_lib:setup(Config,[]),
<a name="1013"/> 1013: 
<a name="1014"/> 1014:     App1Name = app1,
<a name="1015"/> 1015:     App1 = {application, App1Name,
<a name="1016"/> 1016:             [{description, &quot;Test of app with logger config&quot;},
<a name="1017"/> 1017:              {applications, [kernel]}]},
<a name="1018"/> 1018:     ok = rpc:call(Node,application,load,[App1]),
<a name="1019"/> 1019:     ok = rpc:call(Node,application,set_env,
<a name="1020"/> 1020:                   [App1Name,logger,[{handler,default,logger_std_h,#{}}]]),
<a name="1021"/> 1021: 
<a name="1022"/> 1022:     %% Try to add an own default handler
<a name="1023"/> 1023:     {error,{bad_config,{handler,{app1,{already_exist,default}}}}} =
<a name="1024"/> 1024:         rpc:call(Node,logger,add_handlers,[App1Name]),
<a name="1025"/> 1025: 
<a name="1026"/> 1026:     %% Add a different handler
<a name="1027"/> 1027:     ok = rpc:call(Node,application,set_env,[App1Name,logger,
<a name="1028"/> 1028:                                             [{handler,myh,logger_std_h,#{}}]]),
<a name="1029"/> 1029:     ok = rpc:call(Node,logger,add_handlers,[App1Name]),
<a name="1030"/> 1030: 
<a name="1031"/> 1031:     {ok,#{filters:=DF}} = rpc:call(Node,logger,get_handler_config,[default]),
<a name="1032"/> 1032:     {ok,#{filters:=[]}} = rpc:call(Node,logger,get_handler_config,[myh]),
<a name="1033"/> 1033: 
<a name="1034"/> 1034:     ok = peer:stop(Peer),
<a name="1035"/> 1035: 
<a name="1036"/> 1036:     %% Start a node with no default handler, then add an own default handler
<a name="1037"/> 1037:     {ok, #{handlers := [#{id := simple}]}, Peer2, Node2} =
<a name="1038"/> 1038:         logger_test_lib:setup(Config, [{logger, [{handler, default, undefined}]}]),
<a name="1039"/> 1039: 
<a name="1040"/> 1040:     ok = rpc:call(Node2,application,load,[App1]),
<a name="1041"/> 1041:     ok = rpc:call(Node2,application,set_env,
<a name="1042"/> 1042:                   [App1Name,logger,[{handler,default,logger_std_h,#{}}]]),
<a name="1043"/> 1043:     ok = rpc:call(Node2,logger,add_handlers,[App1Name]),
<a name="1044"/> 1044: 
<a name="1045"/> 1045:     #{handlers:=[#{id:=default,filters:=DF}]} =
<a name="1046"/> 1046:         rpc:call(Node2,logger,get_config,[]),
<a name="1047"/> 1047: 
<a name="1048"/> 1048:     ok = peer:stop(Peer2),
<a name="1049"/> 1049: 
<a name="1050"/> 1050:     %% Start a silent node, then add an own default handler
<a name="1051"/> 1051:     {ok,#{handlers:=[]}, Peer3, Node3} =
<a name="1052"/> 1052:         logger_test_lib:setup(Config,[{error_logger,silent}]),
<a name="1053"/> 1053: 
<a name="1054"/> 1054:     {error,{bad_config,{handler,[{some,bad,config}]}}} =
<a name="1055"/> 1055:         rpc:call(Node3,logger,add_handlers,[[{some,bad,config}]]),
<a name="1056"/> 1056:     ok = rpc:call(Node3,logger,add_handlers,
<a name="1057"/> 1057:                   [[{handler,default,logger_std_h,#{}}]]),
<a name="1058"/> 1058: 
<a name="1059"/> 1059:     #{handlers:=[#{id:=default,filters:=DF}]} =
<a name="1060"/> 1060:         rpc:call(Node3,logger,get_config,[]),
<a name="1061"/> 1061: 
<a name="app_config-last_expr"/><a name="1062"/> 1062: <b>    ok = peer:stop</b>(Peer3).
<a name="1063"/> 1063: 
<a name="1064"/> 1064: <i>%% This test case is mainly to see code coverage. Note that</i>
<a name="1065"/> 1065: <i>%% logger_env_var_SUITE tests a lot of the same, and checks the</i>
<a name="1066"/> 1066: <i>%% functionality more thoroughly, but since it all happens at node</i>
<a name="1067"/> 1067: <i>%% start, it is not possible to see code coverage in that test.</i>
<a name="kernel_config-1"/><a name="1068"/> 1068: <b>kernel_config</b>(Config) -&gt;
<a name="1069"/> 1069:     %% Start a node with simple handler only, then simulate kernel
<a name="1070"/> 1070:     %% start by calling logger:reconfigure(). This is to test all
<a name="1071"/> 1071:     %% variants of kernel config, including bad config, and see
<a name="1072"/> 1072:     %% the code coverage.
<a name="1073"/> 1073:     {ok,#{handlers:=[#{id:=simple,filters:=DF}]}=LC, Peer, Node} =
<a name="1074"/> 1074:         logger_test_lib:setup(Config,[{error_logger,false}]),
<a name="1075"/> 1075: 
<a name="1076"/> 1076:     %% Same once more, to get coverage
<a name="1077"/> 1077:     ok = rpc:call(Node,logger,internal_init_logger,[]),
<a name="1078"/> 1078:     LC = rpc:call(Node,logger,get_config,[]),
<a name="1079"/> 1079: 
<a name="1080"/> 1080:     %% This shall mean the same as above, but using 'logger' parameter
<a name="1081"/> 1081:     %% instead of 'error_logger'
<a name="1082"/> 1082:     ok = rpc:call(Node,application,unset_env,[kernel,error_logger]),
<a name="1083"/> 1083:     ok = rpc:call(Node,application,set_env,
<a name="1084"/> 1084:                   [kernel,logger,[{handler,default,undefined}]]),
<a name="1085"/> 1085:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1086"/> 1086:     ?assertEqual(LC, rpc:call(Node,logger,get_config,[])),
<a name="1087"/> 1087: 
<a name="1088"/> 1088:     %% Silent
<a name="1089"/> 1089:     ok = rpc:call(Node,application,unset_env,[kernel,logger]),
<a name="1090"/> 1090:     ok = rpc:call(Node,application,set_env,[kernel,error_logger,silent]),
<a name="1091"/> 1091:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1092"/> 1092:     #{primary:=#{filter_default:=log,filters:=[]},
<a name="1093"/> 1093:       handlers:=[],
<a name="1094"/> 1094:       module_levels:=[]} = rpc:call(Node,logger,get_config,[]),
<a name="1095"/> 1095: 
<a name="1096"/> 1096:     %% Default
<a name="1097"/> 1097:     ok = rpc:call(Node,application,unset_env,[kernel,error_logger]),
<a name="1098"/> 1098:     ok = rpc:call(Node,application,unset_env,[kernel,logger]),
<a name="1099"/> 1099:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1100"/> 1100:     #{primary:=#{filter_default:=log,filters:=[]},
<a name="1101"/> 1101:       handlers:=[#{id:=default,filters:=DF,config:=#{type:=standard_io}}],
<a name="1102"/> 1102:       module_levels:=[]} = rpc:call(Node,logger,get_config,[]),
<a name="1103"/> 1103: 
<a name="1104"/> 1104:     %% error_logger=tty (same as default)
<a name="1105"/> 1105:     ok = rpc:call(Node,application,set_env,[kernel,error_logger,tty]),
<a name="1106"/> 1106:     ok = rpc:call(Node,application,unset_env,[kernel,logger]),
<a name="1107"/> 1107:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1108"/> 1108:     #{primary:=#{filter_default:=log,filters:=[]},
<a name="1109"/> 1109:       handlers:=[#{id:=default,filters:=DF,config:=#{type:=standard_io}}],
<a name="1110"/> 1110:       module_levels:=[]} = rpc:call(Node,logger,get_config,[]),
<a name="1111"/> 1111: 
<a name="1112"/> 1112:     %% error_logger={file,File}
<a name="1113"/> 1113:     F = filename:join(?config(priv_dir,Config),
<a name="1114"/> 1114:                       atom_to_list(?FUNCTION_NAME)++&quot;.log&quot;),
<a name="1115"/> 1115:     ok = rpc:call(Node,application,set_env,[kernel,error_logger,{file,F}]),
<a name="1116"/> 1116:     ok = rpc:call(Node,application,unset_env,[kernel,logger]),
<a name="1117"/> 1117:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1118"/> 1118:     #{primary:=#{filter_default:=log,filters:=[]},
<a name="1119"/> 1119:       handlers:=[#{id:=default,filters:=DF,
<a name="1120"/> 1120:                    config:=#{type:=file,file:=F,modes:=Modes}}],
<a name="1121"/> 1121:       module_levels:=[]} = rpc:call(Node,logger,get_config,[]),
<a name="1122"/> 1122:     [append,delayed_write,raw] = lists:sort(Modes),
<a name="1123"/> 1123: 
<a name="1124"/> 1124: 
<a name="1125"/> 1125:     %% Same, but using 'logger' parameter instead of 'error_logger'
<a name="1126"/> 1126:     ok = rpc:call(Node,application,unset_env,[kernel,error_logger]),
<a name="1127"/> 1127:     ok = rpc:call(Node,application,set_env,[kernel,logger,
<a name="1128"/> 1128:                                             [{handler,default,logger_std_h,
<a name="1129"/> 1129:                                               #{config=&gt;#{type=&gt;{file,F}}}}]]),
<a name="1130"/> 1130:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1131"/> 1131:     #{primary:=#{filter_default:=log,filters:=[]},
<a name="1132"/> 1132:       handlers:=[#{id:=default,filters:=DF,
<a name="1133"/> 1133:                    config:=#{type:=file,file:=F,modes:=Modes}}],
<a name="1134"/> 1134:       module_levels:=[]} = rpc:call(Node,logger,get_config,[]),
<a name="1135"/> 1135: 
<a name="1136"/> 1136:     %% Same, but with type={file,File,Modes}
<a name="1137"/> 1137:     ok = rpc:call(Node,application,unset_env,[kernel,error_logger]),
<a name="1138"/> 1138:     M = [raw,write],
<a name="1139"/> 1139:     ok = rpc:call(Node,application,set_env,[kernel,logger,
<a name="1140"/> 1140:                                             [{handler,default,logger_std_h,
<a name="1141"/> 1141:                                               #{config=&gt;#{type=&gt;{file,F,M}}}}]]),
<a name="1142"/> 1142:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1143"/> 1143:     #{primary:=#{filter_default:=log,filters:=[]},
<a name="1144"/> 1144:       handlers:=[#{id:=default,filters:=DF,
<a name="1145"/> 1145:                    config:=#{type:=file,file:=F,modes:=[delayed_write|M]}}],
<a name="1146"/> 1146:       module_levels:=[]} = rpc:call(Node,logger,get_config,[]),
<a name="1147"/> 1147: 
<a name="1148"/> 1148:     %% Same, but with disk_log handler
<a name="1149"/> 1149:     ok = rpc:call(Node,application,unset_env,[kernel,error_logger]),
<a name="1150"/> 1150:     ok = rpc:call(Node,application,set_env,[kernel,logger,
<a name="1151"/> 1151:                                             [{handler,default,logger_disk_log_h,
<a name="1152"/> 1152:                                               #{config=&gt;#{file=&gt;F}}}]]),
<a name="1153"/> 1153:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1154"/> 1154:     #{primary:=#{filter_default:=log,filters:=[]},
<a name="1155"/> 1155:       handlers:=[#{id:=default,filters:=DF,config:=#{file:=F}}],
<a name="1156"/> 1156:       module_levels:=[]} = rpc:call(Node,logger,get_config,[]),
<a name="1157"/> 1157: 
<a name="1158"/> 1158:     %% Set primary filters and module level. No default handler.
<a name="1159"/> 1159:     ok = rpc:call(Node,application,unset_env,[kernel,error_logger]),
<a name="1160"/> 1160:     ok = rpc:call(Node,application,set_env,
<a name="1161"/> 1161:                   [kernel,logger,[{handler,default,undefined},
<a name="1162"/> 1162:                                   {filters,stop,[{f1,{fun(_,_) -&gt; log end,ok}}]},
<a name="1163"/> 1163:                                   {module_level,debug,[?MODULE]}]]),
<a name="1164"/> 1164:     ok = rpc:call(Node,logger,reconfigure,[]),
<a name="1165"/> 1165:     #{primary:=#{filter_default:=stop,filters:=[_]},
<a name="1166"/> 1166:       handlers:=[#{id:=simple}],
<a name="1167"/> 1167:       module_levels:=[{?MODULE,debug}]} = rpc:call(Node,logger,get_config,[]),
<a name="1168"/> 1168: 
<a name="1169"/> 1169:     %% Bad config
<a name="1170"/> 1170:     ok = rpc:call(Node,application,unset_env,[kernel,logger]),
<a name="1171"/> 1171: 
<a name="1172"/> 1172:     ok = rpc:call(Node,application,set_env,[kernel,error_logger,bad]),
<a name="1173"/> 1173:     {error,{bad_config,{kernel,{error_logger,bad}}}} =
<a name="1174"/> 1174:         rpc:call(Node,logger,reconfigure,[]),
<a name="1175"/> 1175: 
<a name="1176"/> 1176:     ok = rpc:call(Node,application,unset_env,[kernel,error_logger]),
<a name="1177"/> 1177:     ok = rpc:call(Node,application,set_env,[kernel,logger_level,bad]),
<a name="1178"/> 1178:     {error,{bad_config,{kernel,{logger_level,bad}}}} =
<a name="1179"/> 1179:         rpc:call(Node,logger,reconfigure,[]),
<a name="1180"/> 1180: 
<a name="1181"/> 1181:     ok = rpc:call(Node,application,unset_env,[kernel,logger_level]),
<a name="1182"/> 1182:     ok = rpc:call(Node,application,set_env,
<a name="1183"/> 1183:                   [kernel,logger,[{filters,stop,[bad]}]]),
<a name="1184"/> 1184:     {error,{bad_config,{kernel,{invalid_filters,[bad]}}}} =
<a name="1185"/> 1185:         rpc:call(Node,logger,reconfigure,[]),
<a name="1186"/> 1186: 
<a name="1187"/> 1187:     ok = rpc:call(Node,application,set_env,
<a name="1188"/> 1188:                   [kernel,logger,[{filters,stop,[bad]}]]),
<a name="1189"/> 1189:     {error,{bad_config,{kernel,{invalid_filters,[bad]}}}} =
<a name="1190"/> 1190:         rpc:call(Node,logger,reconfigure,[]),
<a name="1191"/> 1191: 
<a name="1192"/> 1192:     ok = rpc:call(Node,application,set_env,
<a name="1193"/> 1193:                   [kernel,logger,[{filters,stop,[{f1,bad}]}]]),
<a name="1194"/> 1194:     {error,{bad_config,{kernel,{invalid_filter,{f1,bad}}}}} =
<a name="1195"/> 1195:         rpc:call(Node,logger,reconfigure,[]),
<a name="1196"/> 1196: 
<a name="1197"/> 1197:     ok = rpc:call(Node,application,set_env,
<a name="1198"/> 1198:                   [kernel,logger,MF=[{filters,stop,[]},{filters,log,[]}]]),
<a name="1199"/> 1199:     {error,{bad_config,{kernel,{multiple_filters,MF}}}} =
<a name="1200"/> 1200:         rpc:call(Node,logger,reconfigure,[]),
<a name="1201"/> 1201: 
<a name="1202"/> 1202:     ok = rpc:call(Node,application,set_env,
<a name="1203"/> 1203:                   [kernel,logger,[{module_level,bad,[?MODULE]}]]),
<a name="1204"/> 1204:     {error,{bad_config,{kernel,{invalid_level,bad}}}} =
<a name="1205"/> 1205:         rpc:call(Node,logger,reconfigure,[]),
<a name="1206"/> 1206: 
<a name="kernel_config-last_expr"/><a name="1207"/> 1207: <b>    ok = peer:stop</b>(Peer).
<a name="1208"/> 1208: 
<a name="pretty_print-1"/><a name="1209"/> 1209: <b>pretty_print</b>(_Config) -&gt;
<a name="1210"/> 1210:     ok = logger:add_handler(?FUNCTION_NAME,logger_std_h,#{}),
<a name="1211"/> 1211:     ok = logger:set_module_level([module1,module2],debug),
<a name="1212"/> 1212: 
<a name="1213"/> 1213:     ct:capture_start(),
<a name="1214"/> 1214:     logger:i(),
<a name="1215"/> 1215:     ct:capture_stop(),
<a name="1216"/> 1216:     I0 = ct:capture_get(),
<a name="1217"/> 1217: 
<a name="1218"/> 1218:     ct:capture_start(),
<a name="1219"/> 1219:     logger:i(primary),
<a name="1220"/> 1220:     ct:capture_stop(),
<a name="1221"/> 1221:     IPrim = ct:capture_get(),
<a name="1222"/> 1222: 
<a name="1223"/> 1223:     ct:capture_start(),
<a name="1224"/> 1224:     logger:i(handlers),
<a name="1225"/> 1225:     ct:capture_stop(),
<a name="1226"/> 1226:     IHs = ct:capture_get(),
<a name="1227"/> 1227: 
<a name="1228"/> 1228:     ct:capture_start(),
<a name="1229"/> 1229:     logger:i(proxy),
<a name="1230"/> 1230:     ct:capture_stop(),
<a name="1231"/> 1231:     IProxy = ct:capture_get(),
<a name="1232"/> 1232: 
<a name="1233"/> 1233:     ct:capture_start(),
<a name="1234"/> 1234:     logger:i(modules),
<a name="1235"/> 1235:     ct:capture_stop(),
<a name="1236"/> 1236:     IMs = ct:capture_get(),
<a name="1237"/> 1237: 
<a name="1238"/> 1238:     I02 = lists:append([IPrim,IHs,IProxy,IMs]),
<a name="1239"/> 1239:     %% ct:log(&quot;~p~n&quot;,[I0]),
<a name="1240"/> 1240:     %% ct:log(&quot;~p~n&quot;,[I02]),
<a name="1241"/> 1241:     I0 = I02,
<a name="1242"/> 1242: 
<a name="1243"/> 1243:     ct:capture_start(),
<a name="1244"/> 1244:     logger:i(handlers),
<a name="1245"/> 1245:     ct:capture_stop(),
<a name="1246"/> 1246:     IHs = ct:capture_get(),
<a name="1247"/> 1247: 
<a name="1248"/> 1248:     Ids = logger:get_handler_ids(),
<a name="1249"/> 1249:     IHs2 =
<a name="1250"/> 1250:         lists:append(
<a name="1251"/> 1251:           [begin
<a name="1252"/> 1252:                ct:capture_start(),
<a name="1253"/> 1253:                logger:i(Id),
<a name="1254"/> 1254:                ct:capture_stop(),
<a name="1255"/> 1255:                [_|IH] = ct:capture_get(),
<a name="1256"/> 1256:                IH
<a name="1257"/> 1257:            end || Id &lt;- Ids]),
<a name="1258"/> 1258: 
<a name="1259"/> 1259:     %% ct:log(&quot;~p~n&quot;,[IHs]),
<a name="1260"/> 1260:     %% ct:log(&quot;~p~n&quot;,[[&quot;Handler configuration: \n&quot;|IHs2]]),
<a name="1261"/> 1261:     IHs = [&quot;Handler configuration: \n&quot;|IHs2],
<a name="pretty_print-last_expr"/><a name="1262"/> 1262:     ok.
<a name="1263"/> 1263: 
<a name="pathological-2"/><a name="1264"/> 1264: <b>pathological</b>(cleanup,_Config) -&gt;
<a name="1265"/> 1265:     logger:remove_handler(p1),
<a name="1266"/> 1266:     logger:set_primary_config(level,notice),
<a name="1267"/> 1267:     logger:unset_module_level(?MODULE),
<a name="pathological-last_expr"/><a name="1268"/> 1268:     ok.
<a name="1269"/> 1269: 
<a name="pathological-1"/><a name="1270"/> 1270: <b>pathological</b>(_Config) -&gt;
<a name="1271"/> 1271:     ok = logger:set_primary_config(level,all),
<a name="1272"/> 1272:     ok = logger:add_handler(p1,?MODULE,#{level=&gt;all,filter_default=&gt;log}),
<a name="1273"/> 1273:     logger:notice(string, []),
<a name="1274"/> 1274:     check_logged(notice,&quot;string&quot;,[],#{}),
<a name="1275"/> 1275:     logger:notice(report, []),
<a name="1276"/> 1276:     check_logged(notice,&quot;report&quot;,[],#{}),
<a name="pathological-last_expr"/><a name="1277"/> 1277:     ok.
<a name="1278"/> 1278: 
<a name="internal_log-1"/><a name="1279"/> 1279: <b>internal_log</b>(_Config) -&gt;
<a name="1280"/> 1280:     register(callback_receiver, self()),
<a name="1281"/> 1281:     {error, {not_found, h1}} = logger:get_handler_config(h1),
<a name="1282"/> 1282:     ok = logger:add_handler(h1, ?MODULE, #{tc_proc =&gt; self()}),
<a name="1283"/> 1283:     OriginalMeta = #{
<a name="1284"/> 1284:         mfa =&gt; {orig_mod, orig_func, 0},
<a name="1285"/> 1285:         line =&gt; 0,
<a name="1286"/> 1286:         file =&gt; &quot;path/to/orig_mod.beam&quot;,
<a name="1287"/> 1287:         pid =&gt; self(),
<a name="1288"/> 1288:         time =&gt; logger:timestamp(),
<a name="1289"/> 1289:         gl =&gt; group_leader()
<a name="1290"/> 1290:     },
<a name="1291"/> 1291:     OriginalLog = #{
<a name="1292"/> 1292:         level =&gt; notice,
<a name="1293"/> 1293:         msg =&gt; &quot;Original log&quot;,
<a name="1294"/> 1294:         meta =&gt; OriginalMeta
<a name="1295"/> 1295:     },
<a name="1296"/> 1296:     Report = [{testing, internal_log}],
<a name="1297"/> 1297: 
<a name="1298"/> 1298:     ?LOG_INTERNAL(notice, OriginalLog, Report),
<a name="1299"/> 1299:     ok = check_logged(notice, Report, ?MY_LOC(1)),
<a name="1300"/> 1300: 
<a name="internal_log-last_expr"/><a name="1301"/> 1301:     ok.
<a name="1302"/> 1302: 
<a name="1303"/> 1303: <i>%%%-----------------------------------------------------------------</i>
<a name="1304"/> 1304: <i>%%% Internal</i>
<a name="check_logged-4"/><a name="1305"/> 1305: <b>check_logged</b>(Level,Format,Args,Meta) -&gt;
<a name="check_logged-last_expr"/><a name="1306"/> 1306: <b>    do_check_logged</b>(Level,{Format,Args},Meta).
<a name="1307"/> 1307: 
<a name="check_logged-3"/><a name="1308"/> 1308: <b>check_logged</b>(Level,Msg,Meta) when ?IS_REPORT(Msg) -&gt;
<a name="1309"/> 1309:     do_check_logged(Level,{report,Msg},Meta);
<a name="1310"/> 1310: <b>check_logged</b>(Level,Msg,Meta) when ?IS_STRING(Msg) -&gt;
<a name="check_logged-last_expr"/><a name="1311"/> 1311: <b>    do_check_logged</b>(Level,{string,Msg},Meta).
<a name="1312"/> 1312: 
<a name="do_check_logged-3"/><a name="1313"/> 1313: <b>do_check_logged</b>(Level,Msg0,Meta0) -&gt;
<a name="do_check_logged-last_expr"/><a name="1314"/> 1314:     receive
<a name="1315"/> 1315:         {#{level:=Level,msg:=Msg,meta:=Meta},_} -&gt;
<a name="1316"/> 1316:             check_msg(Msg0,Msg),
<a name="1317"/> 1317:             check_maps(Meta0,Meta,meta)
<a name="1318"/> 1318:     after 500 -&gt;
<a name="1319"/> 1319:             ct:fail({timeout,no_log,process_info(self(),messages)})
<a name="1320"/> 1320:     end.
<a name="1321"/> 1321: 
<a name="check_no_log-0"/><a name="1322"/> 1322: <b>check_no_log</b>() -&gt;
<a name="check_no_log-last_expr"/><a name="1323"/> 1323:     receive
<a name="1324"/> 1324:         X -&gt; ct:fail({got_unexpected_log,X})
<a name="1325"/> 1325:     after 500 -&gt;
<a name="1326"/> 1326:             ok
<a name="1327"/> 1327:     end.
<a name="1328"/> 1328: 
<a name="check_msg-2"/><a name="1329"/> 1329: <b>check_msg</b>(Msg,Msg) -&gt;
<a name="1330"/> 1330:     ok;
<a name="1331"/> 1331: <b>check_msg</b>({report,Expected},{report,Got}) when is_map(Expected), is_map(Got) -&gt;
<a name="1332"/> 1332:     check_maps(Expected,Got,msg);
<a name="1333"/> 1333: <b>check_msg</b>(Expected,Got) -&gt;
<a name="check_msg-last_expr"/><a name="1334"/> 1334: <b>    ct:fail</b>({unexpected,msg,Expected,Got}).
<a name="1335"/> 1335: 
<a name="check_maps-3"/><a name="1336"/> 1336: <b>check_maps</b>(Expected,Got,What) -&gt;
<a name="check_maps-last_expr"/><a name="1337"/> 1337: <b>    case maps:merge</b>(Got,Expected) of
<a name="1338"/> 1338:         Got -&gt;
<a name="1339"/> 1339:             ok;
<a name="1340"/> 1340:         _ -&gt;
<a name="1341"/> 1341:             ct:fail({unexpected,What,Expected,Got})
<a name="1342"/> 1342:     end.
<a name="1343"/> 1343: 
<a name="1344"/> 1344: <i>%% Handler</i>
<a name="adding_handler-1"/><a name="1345"/> 1345: <b>adding_handler</b>(#{add_call:=Fun}) -&gt;
<a name="1346"/> 1346:     Fun();
<a name="1347"/> 1347: <b>adding_handler</b>(Config) -&gt;
<a name="1348"/> 1348:     maybe_send(add),
<a name="adding_handler-last_expr"/><a name="1349"/> 1349:     {ok,Config}.
<a name="1350"/> 1350: 
<a name="removing_handler-1"/><a name="1351"/> 1351: <b>removing_handler</b>(#{rem_call:=Fun}) -&gt;
<a name="1352"/> 1352:     Fun();
<a name="1353"/> 1353: <b>removing_handler</b>(_Config) -&gt;
<a name="1354"/> 1354:     maybe_send(remove),
<a name="removing_handler-last_expr"/><a name="1355"/> 1355:     ok.
<a name="changing_config-2"/><a name="1356"/> 1356: <b>changing_config</b>(_Old,#{conf_call:=Fun}) -&gt;
<a name="1357"/> 1357:     Fun();
<a name="1358"/> 1358: <b>changing_config</b>(_Old,Config) -&gt;
<a name="1359"/> 1359:     maybe_send(changing_config),
<a name="changing_config-last_expr"/><a name="1360"/> 1360:     {ok,Config}.
<a name="1361"/> 1361: 
<a name="maybe_send-1"/><a name="1362"/> 1362: <b>maybe_send</b>(Msg) -&gt;
<a name="maybe_send-last_expr"/><a name="1363"/> 1363: <b>    case whereis</b>(callback_receiver) of
<a name="1364"/> 1364:         undefined -&gt; ok;
<a name="1365"/> 1365:         Pid -&gt; Pid ! Msg
<a name="1366"/> 1366:     end.
<a name="1367"/> 1367: 
<a name="log-2"/><a name="1368"/> 1368: <b>log</b>(_Log,#{log_call:=Fun}) -&gt;
<a name="1369"/> 1369:     Fun();
<a name="1370"/> 1370: <b>log</b>(Log,Config) -&gt;
<a name="1371"/> 1371:     TcProc  = maps:get(tc_proc,Config,self()),
<a name="1372"/> 1372:     TcProc ! {Log,Config},
<a name="log-last_expr"/><a name="1373"/> 1373:     ok.
<a name="1374"/> 1374: 
<a name="test_api-1"/><a name="1375"/> 1375: <b>test_api</b>(Level) -&gt;
<a name="1376"/> 1376:     logger:Level(#{Level=&gt;rep}),
<a name="1377"/> 1377:     ok = check_logged(Level,#{Level=&gt;rep},#{}),
<a name="1378"/> 1378:     logger:Level(#{Level=&gt;rep},#{my=&gt;meta}),
<a name="1379"/> 1379:     ok = check_logged(Level,#{Level=&gt;rep},#{my=&gt;meta}),
<a name="1380"/> 1380:     logger:Level(&quot;~w: ~w&quot;,[Level,fa]),
<a name="1381"/> 1381:     ok = check_logged(Level,&quot;~w: ~w&quot;,[Level,fa],#{}),
<a name="1382"/> 1382:     logger:Level('~w: ~w',[Level,fa]),
<a name="1383"/> 1383:     ok = check_logged(Level,&quot;~w: ~w&quot;,[Level,fa],#{}),
<a name="1384"/> 1384:     logger:Level(&lt;&lt;&quot;~w: ~w&quot;&gt;&gt;,[Level,fa]),
<a name="1385"/> 1385:     ok = check_logged(Level,&lt;&lt;&quot;~w: ~w&quot;&gt;&gt;,[Level,fa],#{}),
<a name="1386"/> 1386:     logger:Level(&quot;~w: ~w ~w&quot;,[Level,fa,meta],#{my=&gt;meta}),
<a name="1387"/> 1387:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fa,meta],#{my=&gt;meta}),
<a name="1388"/> 1388:     logger:Level(fun(x) -&gt; {&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta]} end,x,
<a name="1389"/> 1389:                  #{my=&gt;meta}),
<a name="1390"/> 1390:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta],#{my=&gt;meta}),
<a name="1391"/> 1391:     logger:Level(fun(x) -&gt; {&lt;&lt;&quot;~w: ~w ~w&quot;&gt;&gt;,[Level,fun_to_fa,meta]} end,x,
<a name="1392"/> 1392:                  #{my=&gt;meta}),
<a name="1393"/> 1393:     ok = check_logged(Level,&lt;&lt;&quot;~w: ~w ~w&quot;&gt;&gt;,[Level,fun_to_fa,meta],#{my=&gt;meta}),
<a name="1394"/> 1394:     logger:Level(fun(x) -&gt; {'~w: ~w ~w',[Level,fun_to_fa,meta]} end,x,
<a name="1395"/> 1395:                  #{my=&gt;meta}),
<a name="1396"/> 1396:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta],#{my=&gt;meta}),
<a name="1397"/> 1397:     logger:Level(fun(x) -&gt; #{Level=&gt;fun_to_r,meta=&gt;true} end,x,
<a name="1398"/> 1398:                      #{my=&gt;meta}),
<a name="1399"/> 1399:     ok = check_logged(Level,#{Level=&gt;fun_to_r,meta=&gt;true},#{my=&gt;meta}),
<a name="1400"/> 1400:     logger:Level(fun(x) -&gt; &lt;&lt;&quot;fun_to_s&quot;&gt;&gt; end,x,#{}),
<a name="1401"/> 1401:     ok = check_logged(Level,&lt;&lt;&quot;fun_to_s&quot;&gt;&gt;,#{}),
<a name="1402"/> 1402:     logger:Level(F1=fun(x) -&gt; {fun_to_bad} end,x,#{}),
<a name="1403"/> 1403:     ok = check_logged(Level,&quot;LAZY_FUN ERROR: ~tp; Returned: ~tp&quot;,
<a name="1404"/> 1404:                       [{F1,x},{fun_to_bad}],#{}),
<a name="1405"/> 1405:     logger:Level(F2=fun(x) -&gt; erlang:error(fun_that_crashes) end,x,#{}),
<a name="1406"/> 1406:     ok = check_logged(Level,&quot;LAZY_FUN CRASH: ~tp; Reason: ~tp&quot;,
<a name="1407"/> 1407:                       [{F2,x},{error,fun_that_crashes}],#{}),
<a name="test_api-last_expr"/><a name="1408"/> 1408:     ok.
<a name="1409"/> 1409: 
<a name="test_log_function-1"/><a name="1410"/> 1410: <b>test_log_function</b>(Level) -&gt;
<a name="1411"/> 1411:     logger:log(Level,#{Level=&gt;rep}),
<a name="1412"/> 1412:     ok = check_logged(Level,#{Level=&gt;rep},#{}),
<a name="1413"/> 1413:     logger:log(Level,#{Level=&gt;rep},#{my=&gt;meta}),
<a name="1414"/> 1414:     ok = check_logged(Level,#{Level=&gt;rep},#{my=&gt;meta}),
<a name="1415"/> 1415:     logger:log(Level,&quot;~w: ~w&quot;,[Level,fa]),
<a name="1416"/> 1416:     ok = check_logged(Level,&quot;~w: ~w&quot;,[Level,fa],#{}),
<a name="1417"/> 1417:     logger:log(Level,&quot;~w: ~w ~w&quot;,[Level,fa,meta],#{my=&gt;meta}),
<a name="1418"/> 1418:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fa,meta],#{my=&gt;meta}),
<a name="1419"/> 1419:     logger:log(Level,fun(x) -&gt; {&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta]} end,
<a name="1420"/> 1420:                x, #{my=&gt;meta}),
<a name="1421"/> 1421:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta],#{my=&gt;meta}),
<a name="1422"/> 1422:     logger:log(Level,fun(x) -&gt; {&lt;&lt;&quot;~w: ~w ~w&quot;&gt;&gt;,[Level,fun_to_fa,meta]} end,
<a name="1423"/> 1423:                x, #{my=&gt;meta}),
<a name="1424"/> 1424:     ok = check_logged(Level,&lt;&lt;&quot;~w: ~w ~w&quot;&gt;&gt;,[Level,fun_to_fa,meta],#{my=&gt;meta}),
<a name="1425"/> 1425:     logger:log(Level,fun(x) -&gt; {'~w: ~w ~w',[Level,fun_to_fa,meta]} end,
<a name="1426"/> 1426:                x, #{my=&gt;meta}),
<a name="1427"/> 1427:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta],#{my=&gt;meta}),
<a name="1428"/> 1428:     logger:log(Level,fun(x) -&gt; #{Level=&gt;fun_to_r,meta=&gt;true} end,
<a name="1429"/> 1429:                x, #{my=&gt;meta}),
<a name="1430"/> 1430:     ok = check_logged(Level,#{Level=&gt;fun_to_r,meta=&gt;true},#{my=&gt;meta}),
<a name="1431"/> 1431:     logger:log(Level,fun(x) -&gt; &lt;&lt;&quot;fun_to_s&quot;&gt;&gt; end,x,#{}),
<a name="1432"/> 1432:     ok = check_logged(Level,&lt;&lt;&quot;fun_to_s&quot;&gt;&gt;,#{}),
<a name="1433"/> 1433:     logger:log(Level,F1=fun(x) -&gt; {fun_to_bad} end,x,#{}),
<a name="1434"/> 1434:     ok = check_logged(Level,&quot;LAZY_FUN ERROR: ~tp; Returned: ~tp&quot;,
<a name="1435"/> 1435:                       [{F1,x},{fun_to_bad}],#{}),
<a name="1436"/> 1436:     logger:log(Level,F2=fun(x) -&gt; erlang:error(fun_that_crashes) end,x,#{}),
<a name="1437"/> 1437:     ok = check_logged(Level,&quot;LAZY_FUN CRASH: ~tp; Reason: ~tp&quot;,
<a name="1438"/> 1438:                       [{F2,x},{error,fun_that_crashes}],#{}),
<a name="1439"/> 1439:     logger:log(Level,fun(x) -&gt; {{&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta]}, #{my=&gt;override}} end,
<a name="1440"/> 1440:                x, #{my=&gt;meta}),
<a name="1441"/> 1441:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta],#{my=&gt;override}),
<a name="1442"/> 1442:     logger:log(Level,fun(x) -&gt; {#{Level=&gt;fun_to_r,meta=&gt;true}, #{my=&gt;override}} end,
<a name="1443"/> 1443:                x, #{my=&gt;meta}),
<a name="1444"/> 1444:     ok = check_logged(Level,#{Level=&gt;fun_to_r,meta=&gt;true},#{my=&gt;override}),
<a name="1445"/> 1445:     logger:log(Level,fun(x) -&gt; {&lt;&lt;&quot;fun_to_s&quot;&gt;&gt;,#{my=&gt;override}} end,x,#{my=&gt;meta}),
<a name="1446"/> 1446:     ok = check_logged(Level,&lt;&lt;&quot;fun_to_s&quot;&gt;&gt;,#{my=&gt;override}),
<a name="1447"/> 1447:     logger:log(Level, fun(x) -&gt; ignore end, x, #{}),
<a name="1448"/> 1448:     ok = check_no_log(),
<a name="test_log_function-last_expr"/><a name="1449"/> 1449:     ok.
<a name="1450"/> 1450: 
<a name="test_macros-1"/><a name="1451"/> 1451: <b>test_macros</b>(emergency=Level) -&gt;
<a name="1452"/> 1452:     ?LOG_EMERGENCY(#{Level=&gt;rep}),
<a name="1453"/> 1453:     ok = check_logged(Level,#{Level=&gt;rep},?MY_LOC(1)),
<a name="1454"/> 1454:     ?LOG_EMERGENCY(#{Level=&gt;rep},#{my=&gt;meta}),
<a name="1455"/> 1455:     ok = check_logged(Level,#{Level=&gt;rep},(?MY_LOC(1))#{my=&gt;meta}),
<a name="1456"/> 1456:     ?LOG_EMERGENCY(&quot;~w: ~w&quot;,[Level,fa]),
<a name="1457"/> 1457:     ok = check_logged(Level,&quot;~w: ~w&quot;,[Level,fa],?MY_LOC(1)),
<a name="1458"/> 1458:     ?LOG_EMERGENCY(&quot;~w: ~w ~w&quot;,[Level,fa,meta],#{my=&gt;meta}),
<a name="1459"/> 1459:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fa,meta],(?MY_LOC(1))#{my=&gt;meta}),
<a name="1460"/> 1460:     ?LOG_EMERGENCY(fun(x) -&gt; {&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta]} end,
<a name="1461"/> 1461:                    x, #{my=&gt;meta}),
<a name="1462"/> 1462:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta],
<a name="1463"/> 1463:                       (?MY_LOC(3))#{my=&gt;meta}),
<a name="1464"/> 1464:     ?LOG_EMERGENCY(fun(x) -&gt; #{Level=&gt;fun_to_r,meta=&gt;true} end, x, #{my=&gt;meta}),
<a name="1465"/> 1465:     ok = check_logged(Level,#{Level=&gt;fun_to_r,meta=&gt;true},
<a name="1466"/> 1466:                       (?MY_LOC(2))#{my=&gt;meta}),
<a name="1467"/> 1467:     ?LOG_EMERGENCY(fun(x) -&gt; &lt;&lt;&quot;fun_to_s&quot;&gt;&gt; end,x,#{}),
<a name="1468"/> 1468:     ok = check_logged(Level,&lt;&lt;&quot;fun_to_s&quot;&gt;&gt;,?MY_LOC(1)),
<a name="1469"/> 1469:     F1=fun(x) -&gt; {fun_to_bad} end,
<a name="1470"/> 1470:     ?LOG_EMERGENCY(F1,x,#{}),
<a name="1471"/> 1471:     ok = check_logged(Level,&quot;LAZY_FUN ERROR: ~tp; Returned: ~tp&quot;,
<a name="1472"/> 1472:                       [{F1,x},{fun_to_bad}],#{}),
<a name="1473"/> 1473:     F2=fun(x) -&gt; erlang:error(fun_that_crashes) end,
<a name="1474"/> 1474:     ?LOG_EMERGENCY(F2,x,#{}),
<a name="1475"/> 1475:     ok = check_logged(Level,&quot;LAZY_FUN CRASH: ~tp; Reason: ~tp&quot;,
<a name="1476"/> 1476:                       [{F2,x},{error,fun_that_crashes}],#{}),
<a name="test_macros-last_expr"/><a name="1477"/> 1477:     ok.
<a name="1478"/> 1478: 
<a name="test_log_macro-1"/><a name="1479"/> 1479: <b>test_log_macro</b>(Level) -&gt;
<a name="1480"/> 1480:     ?LOG(Level,#{Level=&gt;rep}),
<a name="1481"/> 1481:     ok = check_logged(Level,#{Level=&gt;rep},?MY_LOC(1)),
<a name="1482"/> 1482:     ?LOG(Level,#{Level=&gt;rep},#{my=&gt;meta}),
<a name="1483"/> 1483:     ok = check_logged(Level,#{Level=&gt;rep},(?MY_LOC(1))#{my=&gt;meta}),
<a name="1484"/> 1484:     ?LOG(Level,&quot;~w: ~w&quot;,[Level,fa]),
<a name="1485"/> 1485:     ok = check_logged(Level,&quot;~w: ~w&quot;,[Level,fa],?MY_LOC(1)),
<a name="1486"/> 1486:     ?LOG(Level,&quot;~w: ~w ~w&quot;,[Level,fa,meta],#{my=&gt;meta}),
<a name="1487"/> 1487:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fa,meta],(?MY_LOC(1))#{my=&gt;meta}),
<a name="1488"/> 1488:     ?LOG(Level,fun(x) -&gt; {&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta]} end,
<a name="1489"/> 1489:                    x, #{my=&gt;meta}),
<a name="1490"/> 1490:     ok = check_logged(Level,&quot;~w: ~w ~w&quot;,[Level,fun_to_fa,meta],
<a name="1491"/> 1491:                       (?MY_LOC(3))#{my=&gt;meta}),
<a name="1492"/> 1492:     ?LOG(Level,fun(x) -&gt; #{Level=&gt;fun_to_r,meta=&gt;true} end, x, #{my=&gt;meta}),
<a name="1493"/> 1493:     ok = check_logged(Level,#{Level=&gt;fun_to_r,meta=&gt;true},
<a name="1494"/> 1494:                       (?MY_LOC(2))#{my=&gt;meta}),
<a name="1495"/> 1495:     ?LOG(Level,fun(x) -&gt; &lt;&lt;&quot;fun_to_s&quot;&gt;&gt; end,x,#{}),
<a name="1496"/> 1496:     ok = check_logged(Level,&lt;&lt;&quot;fun_to_s&quot;&gt;&gt;,?MY_LOC(1)),
<a name="1497"/> 1497:     F1=fun(x) -&gt; {fun_to_bad} end,
<a name="1498"/> 1498:     ?LOG(Level,F1,x,#{}),
<a name="1499"/> 1499:     ok = check_logged(Level,&quot;LAZY_FUN ERROR: ~tp; Returned: ~tp&quot;,
<a name="1500"/> 1500:                       [{F1,x},{fun_to_bad}],#{}),
<a name="1501"/> 1501:     F2=fun(x) -&gt; erlang:error(fun_that_crashes) end,
<a name="1502"/> 1502:     ?LOG(Level,F2,x,#{}),
<a name="1503"/> 1503:     ok = check_logged(Level,&quot;LAZY_FUN CRASH: ~tp; Reason: ~tp&quot;,
<a name="1504"/> 1504:                       [{F2,x},{error,fun_that_crashes}],#{}),
<a name="test_log_macro-last_expr"/><a name="1505"/> 1505:     ok.
<a name="1506"/> 1506: 
<a name="1507"/> 1507: <i>%%%-----------------------------------------------------------------</i>
<a name="1508"/> 1508: <i>%%% Called by macro ?TRY(X)</i>
<a name="my_try-1"/><a name="1509"/> 1509: <b>my_try</b>(Fun) -&gt;
<a name="my_try-last_expr"/><a name="1510"/> 1510: <b>    try Fun</b>() catch C:R -&gt; {C,R} end.
<a name="1511"/> 1511: 
<a name="check_config-1"/><a name="1512"/> 1512: <b>check_config</b>(crash) -&gt;
<a name="1513"/> 1513:     erlang:error({badmatch,3});
<a name="1514"/> 1514: <b>check_config</b>(_) -&gt;
<a name="check_config-last_expr"/><a name="1515"/> 1515:     ok.
<a name="1516"/> 1516: 
<a name="1517"/> 1517: <i>%% this function is also a test. When logger.hrl used non-qualified</i>
<a name="1518"/> 1518: <i>%%  apply/3 call, any module that was implementing apply/3 could</i>
<a name="1519"/> 1519: <i>%%  not use any logging macro</i>
<a name="apply-3"/><a name="1520"/> 1520: <b>apply</b>(_, _, _) -&gt;
<a name="apply-last_expr"/><a name="1521"/> 1521:     ok.
</pre>
</body>
</html>
