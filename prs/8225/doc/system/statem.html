<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.31.2">
    <meta name="project" content="Erlang System Documentation v27.0-rc1">


    <title>gen_statem Behaviour â€” Erlang System Documentation v27.0-rc1</title>
    <link rel="stylesheet" href="dist/html-erlang-DUKXLSAT.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-A7S2WMC7.js"></script>
    <script src="dist/sidebar_items-1105547A.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-JRPQ5PR6.js"></script>

<style>.dark img { background-color: white; }</style>
  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<div class="background-layer"></div>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="../index.html" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Erlang System Documentation" />
        </a>

      <div>
        <a href="../index.html" class="sidebar-projectName" translate="no">
Erlang System Documentation
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v27.0-rc1
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
Pages
        </button>
      </li>


    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>


</nav>

<main class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">
      <div class="top-search">
        <div class="search-settings">
          <form class="search-bar" action="search.html">
            <label class="search-label">
              <span class="sr-only">Search documentation of Erlang System Documentation</span>
              <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            </label>
            <button type="submit" class="search-button" aria-label="Submit Search">
              <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
            </button>
            <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
              <i class="ri-close-line ri-lg" title="Cancel search"></i>
            </button>
          </form>
          <div class="autocomplete">
          </div>
          <button class="icon-settings display-settings">
            <i class="ri-settings-3-line"></i>
            <span class="sr-only">Settings</span>
          </button>
        </div>

      </div>

<h1>

    <a href="https://github.com/bjorng/otp/blob/bjorn/compiler/optimize-bs-matching/system/doc/design_principles/statem.md#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>gen_statem Behaviour</span>
</h1>

<p>This section is to be read with the <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html"><code class="inline">gen_statem</code></a> manual page in STDLIB, where
all interface functions and callback functions are described in detail.</p><h2 id="event-driven-state-machines" class="section-heading">
  <a href="#event-driven-state-machines" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Event-Driven State Machines</span>
</h2>
<p>Established Automata Theory does not deal much with how a <em>state transition</em> is
triggered, but assumes that the output is a function of the input (and the
state) and that they are some kind of values.</p><p>For an Event-Driven State Machine, the input is an event that triggers a <em>state
transition</em> and the output is actions executed during the <em>state transition</em>.
Analogously to the mathematical model of a Finite State Machine, it can be
described as a set of relations of the following form:</p><pre><code class="makeup erlang" translate="no"><span class="n">State</span><span class="p" data-group-id="0189730571-1">(</span><span class="n">S</span><span class="p" data-group-id="0189730571-1">)</span><span class="w"> </span><span class="ss">x</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="0189730571-2">(</span><span class="n">E</span><span class="p" data-group-id="0189730571-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Actions</span><span class="p" data-group-id="0189730571-3">(</span><span class="n">A</span><span class="p" data-group-id="0189730571-3">)</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0189730571-4">(</span><span class="n">S</span><span class="err">&#39;</span><span class="p" data-group-id="0189730571-4">)</span></code></pre><p>These relations are interpreted as follows: if we are in state <code class="inline">S</code> and event <code class="inline">E</code>
occurs, we are to perform actions <code class="inline">A</code>, and make a transition to state <code class="inline">S'</code>.
Notice that <code class="inline">S'</code> can be equal to <code class="inline">S</code>, and that <code class="inline">A</code> can be empty.</p><p>In <code class="inline">gen_statem</code> we define a <em>state change</em> as a <em>state transition</em> in which the
new state <code class="inline">S'</code> is different from the current state <code class="inline">S</code>, where &quot;different&quot; means
Erlang's strict inequality: <code class="inline">=/=</code> also known as &quot;does not match&quot;. <code class="inline">gen_statem</code>
does more things during <em>state changes</em> than during other <em>state transitions</em>.</p><p>As <code class="inline">A</code> and <code class="inline">S'</code> depend only on <code class="inline">S</code> and <code class="inline">E</code>, the kind of state machine described
here is a Mealy machine (see, for example, the Wikipedia article &quot;Mealy
machine&quot;).</p><p>Like most <code class="inline">gen_</code> behaviours, <code class="inline">gen_statem</code> keeps a server <code class="inline">Data</code> besides the
state. Because of this, and as there is no restriction on the number of states
(assuming that there is enough virtual machine memory) or on the number of
distinct input events, a state machine implemented with this behaviour is in
fact Turing complete. But it feels mostly like an Event-Driven Mealy machine.</p><h2 id="when-to-use-gen_statem" class="section-heading">
  <a href="#when-to-use-gen_statem" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">When to use gen_statem</span>
</h2>
<p>If your process logic is convenient to describe as a state machine, and you want
any of these <code class="inline">gen_statem</code> key features:</p><ul><li>Co-located callback code for each state, for all
<a href="statem.html#event-types-and-event-content"><em>Event Types</em> </a>(such as <em>call</em>,
<em>cast</em> and <em>info</em>)</li><li><a href="statem.html#postponing-events">Postponing Events </a>(a substitute for selective
receive)</li><li><a href="statem.html#inserted-events">Inserted Events </a>(that is, events from the state
machine to itself; for purely internal events in particular)</li><li><a href="statem.html#state-enter-calls"><em>State Enter Calls</em> </a>(callback on state entry
co-located with the rest of each state's callback code)</li><li>Easy-to-use time-outs (<a href="statem.html#state-time-outs">State Time-Outs</a>,
<a href="statem.html#event-time-outs">Event Time-Outs</a> and
<a href="statem.html#generic-time-outs">Generic Time-Outs</a> (named time-outs))</li></ul><p>If so, or if possibly needed in future versions, then you should consider using
<code class="inline">gen_statem</code> over <a href="../../lib/stdlib-5.2.1/doc/html/gen_server.html"><code class="inline">gen_server</code></a>.</p><p>For simple state machines not needing these features <a href="../../lib/stdlib-5.2.1/doc/html/gen_server.html"><code class="inline">gen_server</code></a> works just
fine. It also has got smaller call overhead, but we are talking about something
like 2 vs 3.3 microseconds call roundtrip time here, so if the server callback
does just a little bit more than just replying, or if the call is not extremely
frequent, that difference will be hard to notice.</p><h2 id="callback-module" class="section-heading">
  <a href="#callback-module" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Callback Module</span>
</h2>
<p>The <em>callback module</em> contains functions that implement the state machine. When
an event occurs, the <code class="inline">gen_statem</code> behaviour engine calls a function in the
<em>callback module</em> with the event, current state and server data. This function
performs the actions for this event, and returns the new state and server data
and also actions to be performed by the behaviour engine.</p><p>The behaviour engine holds the state machine state, server data, timer
references, a queue of postponed messages and other metadata. It receives all
process messages, handles the system messages, and calls the <em>callback module</em>
with machine specific events.</p><p>The <em>callback module</em> can be changed for a running server using any of the
<a href="statem.html#transition-actions">transition actions</a>
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">{change_callback_module, NewModule}</code></a>,
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">{push_callback_module, NewModule}</code></a> or
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">pop_callback_module</code></a>. Note that this is a pretty
esoteric thing to do... The origin for this feature is a protocol that after
version negotiation branches off into quite different state machines depending
on the protocol version. There <em>might</em> be other use cases. <em>Beware</em> that the new
callback module completely replaces the previous callback module, so all
relevant callback functions have to handle the state and data from the previous
callback module.</p><h2 id="callback-modes" class="section-heading">
  <a href="#callback-modes" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Callback Modes</span>
</h2>
<p>The <code class="inline">gen_statem</code> behaviour supports two <em>callback modes</em>:</p><ul><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:callback_mode/0"><code class="inline">state_functions</code></a></strong> - Events are handled
by one callback function per state.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:callback_mode/0"><code class="inline">handle_event_function</code></a></strong> - Events are
handled by one single callback function.</p></li></ul><p>The <em>callback mode</em> is a property of the <em>callback module</em> and is set at server
start. It may be changed due to a code upgrade/downgrade, or when changing the
<em>callback module</em>.</p><p>See the section <a href="statem.html#state-callback"><em>State Callback</em></a> that describes the
event handling callback function(s).</p><p>The <em>callback mode</em> is selected by implementing a mandatory callback function
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:callback_mode/0"><code class="inline">Module:callback_mode()</code> </a>that returns one of
the <em>callback modes</em>.</p><p>The <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:callback_mode/0"><code class="inline">Module:callback_mode()</code> </a>function may also
return a list containing the <em>callback mode</em> and the atom <code class="inline">state_enter</code> in which
case <a href="statem.html#state-enter-calls"><em>state enter calls</em> </a>are activated for the
<em>callback mode</em>.</p><h3 id="choosing-the-callback-mode" class="section-heading">
  <a href="#choosing-the-callback-mode" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Choosing the Callback Mode</span>
</h3>
<p>The short version: choose <code class="inline">state_functions</code> - it is the one most like
<code class="inline">gen_fsm</code>. But if you do not want the restriction that the state must be an
atom, or if you do not want to write one <em>state callback</em> function per state;
please read on...</p><p>The two <a href="statem.html#callback-modes"><em>callback modes</em></a> give different
possibilities and restrictions, with one common goal: to handle all possible
combinations of events and states.</p><p>This can be done, for example, by focusing on one state at the time and for
every state ensure that all events are handled. Alternatively, you can focus on
one event at the time and ensure that it is handled in every state. You can also
use a mix of these strategies.</p><p>With <code class="inline">state_functions</code>, you are restricted to use atom-only states, and the
<code class="inline">gen_statem</code> engine branches depending on state name for you. This encourages
the <em>callback module</em> to co-locate the implementation of all event actions
particular to one state in the same place in the code, hence to focus on one
state at the time.</p><p>This mode fits well when you have a regular state diagram, like the ones in this
chapter, which describes all events and actions belonging to a state visually
around that state, and each state has its unique name.</p><p>With <code class="inline">handle_event_function</code>, you are free to mix strategies, as all events and
states are handled in the same callback function.</p><p>This mode works equally well when you want to focus on one event at the time or
on one state at the time, but function
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:handle_event/4"><code class="inline">Module:handle_event/4</code> </a>quickly grows too large
to handle without branching to helper functions.</p><p>The mode enables the use of non-atom states, for example, complex states or even
hierarchical states. See section <a href="statem.html#complex-state">Complex State</a>. If,
for example, a state diagram is largely alike for the client side and the server
side of a protocol, you can have a state <code class="inline">{StateName,server}</code> or
<code class="inline">{StateName,client}</code>, and make <code class="inline">StateName</code> determine where in the code to handle
most events in the state. The second element of the tuple is then used to select
whether to handle special client-side or server-side events.</p><h2 id="state-callback" class="section-heading">
  <a href="#state-callback" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">State Callback</span>
</h2>
<p>The <em>state callback</em> is the callback function that handles an event in the
current state, and which function that is depends on the <em>callback mode</em>:</p><ul><li><p><strong><code class="inline">state_functions</code></strong> - The event is handled by:<br/><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:StateName/3"><code class="inline">Module:StateName(EventType, EventContent, Data)</code></a></p><p>This form is the one mostly used in the <a href="statem.html#example">Example</a> section.</p></li><li><p><strong><code class="inline">handle_event_function</code></strong> - The event is handled by:<br/><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:handle_event/4"><code class="inline">Module:handle_event(EventType, EventContent, State, Data)</code></a></p><p>See section <a href="statem.html#one-state-callback"><em>One State Callback</em> </a>for an
example.</p></li></ul><p>The state is either the name of the function itself or an argument to it. The
other arguments are the <code class="inline">EventType</code> and the event dependent <code class="inline">EventContent</code>, both
described in section
<a href="statem.html#event-types-and-event-content">Event Types and Event Content</a>, and
the current server <code class="inline">Data</code>.</p><p><em>State enter calls</em> are also handled by the event handler and have slightly
different arguments. See section
<a href="statem.html#state-enter-calls">State Enter Calls</a>.</p><p>The <em>state callback</em> return values are defined in the description of
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:StateName/3"><code class="inline">Module:StateName/3</code> </a>in the <code class="inline">gen_statem</code> manual
page, but here is a more readable list:</p><ul><li><p><strong><code class="inline">{next_state, NextState, NewData, Actions}</code><br/><code class="inline">{next_state, NextState, NewData}</code></strong><br/>Set next state and update the server data. If the <code class="inline">Actions</code> field is used,
execute <em>transition actions</em>. An empty <code class="inline">Actions</code> list is equivalent to not
returning the field.</p><p>See section <a href="statem.html#transition-actions"><em>Transition Actions</em> </a>for a list of
possible <em>transition actions</em>.</p><p>If <code class="inline">NextState =/= State</code> this is a <em>state change</em> so the extra things
<code class="inline">gen_statem</code> does are: the event queue is restarted from the oldest
<a href="statem.html#postponing-events">postponed event</a>, any current
<a href="statem.html#state-time-outs">state time-out</a> is cancelled, and a
<a href="statem.html#state-enter-calls">state enter call</a> is performed, if enabled.</p></li><li><p><strong><code class="inline">{keep_state, NewData, Actions}</code><br/><code class="inline">{keep_state, NewData}</code></strong><br/>Same as the <code class="inline">next_state</code> values with <code class="inline">NextState =:= State</code>, that is, no <em>state
change</em>.</p></li><li><p><strong><code class="inline">{keep_state_and_data, Actions}</code><br/><code class="inline">keep_state_and_data</code></strong><br/>Same as the <code class="inline">keep_state</code> values with <code class="inline">NextData =:= Data</code>, that is, no change
in server data.</p></li><li><p><strong><code class="inline">{repeat_state, NewData, Actions}</code><br/><code class="inline">{repeat_state, NewData}</code><br/><code class="inline">{repeat_state_and_data, Actions}</code><br/><code class="inline">repeat_state_and_data</code></strong><br/>Same as the <code class="inline">keep_state</code> or <code class="inline">keep_state_and_data</code> values, and if
<a href="statem.html#state-enter-calls">State Enter Calls </a>are enabled, repeat the
<em>state enter call</em> as if this state was entered again.</p><p>If these return values are used from a <em>state enter call</em> the <code class="inline">OldState</code> does
not change, but if used from an event handling <em>state callback</em> the new <em>state
enter call's</em> <code class="inline">OldState</code> will be the current state.</p></li><li><p><strong><code class="inline">{stop, Reason, NewData}</code><br/><code class="inline">{stop, Reason}</code></strong><br/>Stop the server with reason <code class="inline">Reason</code>. If the <code class="inline">NewData</code> field is used, first
update the server data.</p></li><li><p><strong><code class="inline">{stop_and_reply, Reason, NewData, ReplyActions}</code><br/><code class="inline">{stop_and_reply, Reason, ReplyActions}</code></strong><br/>Same as the <code class="inline">stop</code> values, but first execute the given
<a href="statem.html#transition-actions"><em>transition actions</em> </a>that may only be reply
actions.</p></li></ul><h3 id="the-first-state" class="section-heading">
  <a href="#the-first-state" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">The First State</span>
</h3>
<p>To decide the first state the
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:init/1"><code class="inline">Module:init(Args)</code> </a>callback function is called before
any <a href="statem.html#state-callback"><em>state callback</em></a> is called. This function
behaves like a <em>state callback</em> function, but gets its only argument <code class="inline">Args</code> from
the <code class="inline">gen_statem</code> <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start/3"><code class="inline">start/3,4</code> </a>or
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start_link/3"><code class="inline">start_link/3,4</code> </a>function, and returns
<code class="inline">{ok, State, Data}</code> or <code class="inline">{ok, State, Data, Actions}</code>. If you use the
<a href="statem.html#postponing-events"><code class="inline">postpone</code></a> action from this function, that action
is ignored, since there is no event to postpone.</p><h2 id="transition-actions" class="section-heading">
  <a href="#transition-actions" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Transition Actions</span>
</h2>
<p>In the first section
(<a href="statem.html#event-driven-state-machines">Event-Driven State Machines</a>), actions
were mentioned as a part of the general state machine model. These general
actions are implemented with the code that <em>callback module</em> <code class="inline">gen_statem</code>
executes in an event-handling callback function before returning to the
<code class="inline">gen_statem</code> engine.</p><p>There are more specific <em>transition actions</em> that a callback function can
command the <code class="inline">gen_statem</code> engine to do after the callback function return. These
are commanded by returning a list of <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0">actions</a> in the
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:state_callback_result/1">return value </a>from the
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:StateName/3">callback function</a>. These are the possible
<em>transition actions</em>:</p><ul><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:postpone/0"><code class="inline">postpone</code></a><br/><code class="inline">{postpone, Boolean}</code></strong><br/>If set postpone the current event, see section
<a href="statem.html#postponing-events">Postponing Events</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:hibernate/0"><code class="inline">hibernate</code></a><br/><code class="inline">{hibernate, Boolean}</code></strong><br/>If set hibernate the <code class="inline">gen_statem</code>, treated in section
<a href="statem.html#hibernation">Hibernation</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:state_timeout/0"><code class="inline">{state_timeout, Time, EventContent}</code></a><br/><code class="inline">{state_timeout, Time, EventContent, Opts}</code><br/><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_update_action/0"><code class="inline">{state_timeout, update, EventContent}</code></a><br/><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_cancel_action/0"><code class="inline">{state_timeout, cancel}</code></a></strong><br/>Start, update or cancel a state time-out, read more in sections
<a href="statem.html#time-outs">Time-Outs</a> and
<a href="statem.html#state-time-outs">State Time-Outs</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:generic_timeout/0"><code class="inline">{{timeout, Name}, Time, EventContent}</code></a><br/><code class="inline">{{timeout, Name}, Time, EventContent, Opts}</code><br/><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_update_action/0"><code class="inline">{{timeout, Name}, update, EventContent}</code></a><br/><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_cancel_action/0"><code class="inline">{{timeout, Name}, cancel}</code></a></strong><br/>Start, update or cancel a generic time-out, read more in sections
<a href="statem.html#time-outs">Time-Outs</a> and
<a href="statem.html#generic-time-outs">Generic Time-Outs</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:event_timeout/0"><code class="inline">{timeout, Time, EventContent}</code></a><br/><code class="inline">{timeout, Time, EventContent, Opts}</code><br/><code class="inline">Time</code></strong><br/>Start an event time-out, see more in sections <a href="statem.html#time-outs">Time-Outs</a>
and <a href="statem.html#event-time-outs">Event Time-Outs</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:reply_action/0"><code class="inline">{reply, From, Reply}</code></a></strong> - Reply to a
caller, mentioned at the end of section
<a href="statem.html#all-state-events">All State Events</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">{next_event, EventType, EventContent}</code></a></strong> -
Generate the next event to handle, see section
<a href="statem.html#inserted-events">Inserted Events</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">{change_callback_module, NewModule}</code></a></strong> - Change
the <a href="statem.html#callback-module"><em>callback module</em> </a>for the running server.
This can be done during any <em>state transition</em>, whether it is a <em>state change</em>
or not, but it can <em>not</em> be done from a
<a href="statem.html#state-enter-calls"><em>state enter call</em></a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">{push_callback_module, NewModule}</code></a></strong> - Push the
current <em>callback module</em> to the top of an internal stack of callback modules
and set the new <a href="statem.html#callback-module"><em>callback module</em> </a>for the running
server. Otherwise like <code class="inline">{change_callback_module, NewModule}</code> above.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">pop_callback_module</code></a></strong> - Pop the top module from
the internal stack of callback modules and set it to be the new
<a href="statem.html#callback-module"><em>callback module</em> </a>for the running server. If the
stack is empty the server fails. Otherwise like
<code class="inline">{change_callback_module, NewModule}</code> above.</p></li></ul><p>For details, see the <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html"><code class="inline">gen_statem</code></a> manual page for type
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">action()</code></a>. You can, for example, reply to many
callers, generate multiple next events, and set a time-out to use absolute
instead of relative time (using the <code class="inline">Opts</code> field).</p><p>Among these <em>transition actions</em> only to reply to a caller is an immediate
action. The others are collected and handled later during the <em>state
transition</em>. <a href="statem.html#inserted-events">Inserted Events</a> are stored and
inserted all together, and the rest set transition options where the last of a
specific type override the previous. See the description of a <em>state transition</em>
in the <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html"><code class="inline">gen_statem</code></a> manual page for type
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:transition_option/0"><code class="inline">transition_option()</code></a>.</p><p>The different <a href="statem.html#time-outs">Time-Outs</a> and
<a href="statem.html#inserted-events"><code class="inline">next_event</code></a> actions generate new events with
corresponding
<a href="statem.html#event-types-and-event-content">Event Types and Event Content </a>.</p><h2 id="event-types-and-event-content" class="section-heading">
  <a href="#event-types-and-event-content" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Event Types and Event Content</span>
</h2>
<p>Events are categorized in different
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:event_type/0"><em>event types</em></a>. Events of all types are for a
given state handled in the same callback function, and that function gets
<code class="inline">EventType</code> and <code class="inline">EventContent</code> as arguments. The meaning of the <code class="inline">EventContent</code>
depends on the <code class="inline">EventType</code>.</p><p>The following is a complete list of <em>event types</em> and where they come from:</p><ul><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:external_event_type/0"><code class="inline">cast</code></a></strong> - Generated by
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#cast/2"><code class="inline">gen_statem:cast(ServerRef, Msg)</code> </a>where <code class="inline">Msg</code> becomes
the <code class="inline">EventContent</code>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:external_event_type/0"><code class="inline">{call,From}</code></a></strong> - Generated by
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#call/2"><code class="inline">gen_statem:call(ServerRef, Request)</code> </a>where <code class="inline">Request</code>
becomes the <code class="inline">EventContent</code>. <code class="inline">From</code> is the reply address to use when replying
either through the <em>transition action</em> <code class="inline">{reply,From,Reply}</code> or by calling
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#reply/1"><code class="inline">gen_statem:reply(From, Reply)</code> </a>from the <em>callback
module</em>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:external_event_type/0"><code class="inline">info</code></a></strong> - Generated by any regular
process message sent to the <code class="inline">gen_statem</code> process. The process message becomes
the <code class="inline">EventContent</code>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_event_type/0"><code class="inline">state_timeout</code></a></strong> - Generated by
<em>transition action</em>
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_action/0"><code class="inline">{state_timeout,Time,EventContent}</code> </a>state
timer timing out. Read more in sections <a href="statem.html#time-outs">Time-Outs</a> and
<a href="statem.html#state-time-outs">State Time-Outs</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_event_type/0"><code class="inline">{timeout,Name}</code></a></strong> - Generated by
<em>transition action</em>
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_action/0"><code class="inline">{{timeout,Name},Time,EventContent}</code> </a>generic
timer timing out. Read more in sections <a href="statem.html#time-outs">Time-Outs</a> and
<a href="statem.html#generic-time-outs">Generic Time-Outs</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_event_type/0"><code class="inline">timeout</code></a></strong> - Generated by
<em>transition action</em>
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_action/0"><code class="inline">{timeout,Time,EventContent}</code> </a>(or its short
form <code class="inline">Time</code>) event timer timing out. Read more in sections
<a href="statem.html#time-outs">Time-Outs</a> and
<a href="statem.html#event-time-outs">Event Time-Outs</a>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:event_type/0"><code class="inline">internal</code></a></strong> - Generated by <em>transition
action</em> <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">{next_event,internal,EventContent}</code></a>. All
<em>event types</em> above can also be generated using the <code class="inline">next_event</code> action:
<code class="inline">{next_event,EventType,EventContent}</code>.</p></li></ul><h2 id="state-enter-calls" class="section-heading">
  <a href="#state-enter-calls" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">State Enter Calls</span>
</h2>
<p>The <code class="inline">gen_statem</code> behaviour can if this is enabled, regardless of <em>callback
mode</em>, automatically
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:state_enter/0">call the state callback </a>with special arguments
whenever the state changes so you can write state enter actions near the rest of
the <em>state transition</em> rules. It typically looks like this:</p><pre><code class="makeup erlang" translate="no"><span class="n">StateName</span><span class="p" data-group-id="2906078433-1">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2906078433-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="ss">code</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">state</span><span class="w"> </span><span class="ss">enter</span><span class="w"> </span><span class="ss">actions</span><span class="w"> </span><span class="ss">here</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
    </span><span class="p" data-group-id="2906078433-2">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">NewData</span><span class="p" data-group-id="2906078433-2">}</span><span class="p">;</span><span class="w">
</span><span class="n">StateName</span><span class="p" data-group-id="2906078433-3">(</span><span class="n">EventType</span><span class="p">,</span><span class="w"> </span><span class="n">EventContent</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2906078433-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="ss">code</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">actions</span><span class="w"> </span><span class="ss">here</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
    </span><span class="p" data-group-id="2906078433-4">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="n">NewStateName</span><span class="p">,</span><span class="w"> </span><span class="n">NewData</span><span class="p" data-group-id="2906078433-4">}</span><span class="p">.</span></code></pre><p>Since the <em>state enter call</em> is not an event there are restrictions on the
allowed return value and
<a href="statem.html#transition-actions">State Transition Actions</a>. You may not change the
state, <a href="statem.html#postponing-events">postpone</a> this non-event,
<a href="statem.html#inserted-events">insert any events</a>, or change the
<a href="statem.html#callback-module"><em>callback module</em></a>.</p><p>The first state that is entered will get a <em>state enter call</em> with <code class="inline">OldState</code>
equal to the current state.</p><p>You may repeat the <em>state enter call</em> using the <code class="inline">{repeat_state,...}</code> return
value from the <a href="statem.html#state-callback">state callback</a>. In this case
<code class="inline">OldState</code> will also be equal to the current state.</p><p>Depending on how your state machine is specified, this can be a very useful
feature, but it forces you to handle the <em>state enter calls</em> in all states. See
also the <a href="statem.html#state-enter-actions">State Enter Actions </a>section.</p><h2 id="time-outs" class="section-heading">
  <a href="#time-outs" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Time-Outs</span>
</h2>
<p>Time-outs in <code class="inline">gen_statem</code> are started from a
<a href="statem.html#transition-actions"><em>transition action</em> </a>during a state transition
that is when exiting from the <a href="statem.html#state-callback"><em>state callback</em></a>.</p><p>There are 3 types of time-outs in <code class="inline">gen_statem</code>:</p><ul><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:state_timeout/0"><code class="inline">state_timeout</code></a></strong> - There is one
<a href="statem.html#state-time-outs">State Time-Out</a> that is automatically cancelled by
a <em>state change</em>.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:generic_timeout/0"><code class="inline">{timeout, Name}</code></a></strong> - There are any
number of <a href="statem.html#generic-time-outs">Generic Time-Outs</a> differing by their
<code class="inline">Name</code>. They have no automatic cancelling.</p></li><li><p><strong><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:event_timeout/0"><code class="inline">timeout</code></a></strong> - There is one
<a href="statem.html#event-time-outs">Event Time-Out</a> that is automatically cancelled by
any event. Note that <a href="statem.html#postponing-events">postponed </a>and
<a href="statem.html#inserted-events">inserted</a> events cancel this time-out just as
external events.</p></li></ul><p>When a time-out is started any running time-out of the same type;
<code class="inline">state_timeout</code>, <code class="inline">{timeout, Name}</code> or <code class="inline">timeout</code>, is cancelled, that is, the
time-out is restarted with the new time.</p><p>All time-outs has got an <code class="inline">EventContent</code> that is part of the
<a href="statem.html#transition-actions"><em>transition action</em> </a>that starts the time-out.
Different <code class="inline">EventContent</code>s does not create different time-outs. The
<code class="inline">EventContent</code> is delivered to the <a href="statem.html#state-callback"><em>state callback</em></a>
when the time-out expires.</p><h3 id="cancelling-a-time-out" class="section-heading">
  <a href="#cancelling-a-time-out" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Cancelling a Time-Out</span>
</h3>
<p>If a time-out is started with the time <code class="inline">infinity</code> it will never time out, in
fact it will not even be started, and any running time-out with the same tag
will be cancelled. The <code class="inline">EventContent</code> will in this case be ignored, so why not
set it to <code class="inline">undefined</code>.</p><p>A more explicit way to cancel a timer is to use a
<a href="statem.html#transition-actions"><em>transition action</em> </a>on the form
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_cancel_action/0"><code class="inline">{TimeoutType, cancel}</code> </a>which is a
feature introduced in OTP 22.1.</p><h3 id="updating-a-time-out" class="section-heading">
  <a href="#updating-a-time-out" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Updating a Time-Out</span>
</h3>
<p>While a time-out is running, its <code class="inline">EventContent</code> can be updated using a
<a href="statem.html#transition-actions"><em>transition action</em> </a>on the form
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:timeout_update_action/0"><code class="inline">{TimeoutType, update, NewEventContent}</code> </a>which
is a feature introduced in OTP 22.1.</p><p>If this feature is used while no such <code class="inline">TimeoutType</code> is running then a time-out
event is immediately delivered as when starting a
<a href="statem.html#time-out-zero">Time-Out Zero</a>.</p><h3 id="time-out-zero" class="section-heading">
  <a href="#time-out-zero" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Time-Out Zero</span>
</h3>
<p>If a time-out is started with the time <code class="inline">0</code> it will actually not be started.
Instead the time-out event will immediately be inserted to be processed after
any events already enqueued, and before any not yet received external events.
Note that some time-outs are automatically cancelled so if you for example
combine <a href="statem.html#postponing-events">postponing</a> an event in a <em>state change</em>
with starting an <a href="statem.html#event-time-outs">event time-out</a> with time <code class="inline">0</code> there
will be no time-out event inserted since the event time-out is cancelled by the
postponed event that is delivered due to the state change.</p><h2 id="example" class="section-heading">
  <a href="#example" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Example</span>
</h2>
<p>A door with a code lock can be seen as a state machine. Initially, the door is
locked. When someone presses a button, an event is generated. The pressed
buttons are collected, up to the number of buttons in the correct code. If
correct, the door is unlocked for 10 seconds. If not correct, we wait for a new
button to be pressed.</p><p><img alt="Code Lock State Diagram" src="assets/code_lock.svg" title="Code Lock State Diagram" width="80%"/></p><p>This code lock state machine can be implemented using <code class="inline">gen_statem</code> with the
following <em>callback module</em>:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="4383747011-1">(</span><span class="ss">code_lock</span><span class="p" data-group-id="4383747011-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="4383747011-2">(</span><span class="ss">gen_statem</span><span class="p" data-group-id="4383747011-2">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="4383747011-3">(</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="ss">code_lock</span><span class="p" data-group-id="4383747011-3">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="4383747011-4">(</span><span class="p" data-group-id="4383747011-5">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="4383747011-5">]</span><span class="p" data-group-id="4383747011-4">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="4383747011-6">(</span><span class="p" data-group-id="4383747011-7">[</span><span class="ss">button</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="4383747011-7">]</span><span class="p" data-group-id="4383747011-6">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="4383747011-8">(</span><span class="p" data-group-id="4383747011-9">[</span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">callback_mode</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="ss">terminate</span><span class="p">/</span><span class="mi">3</span><span class="p" data-group-id="4383747011-9">]</span><span class="p" data-group-id="4383747011-8">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="4383747011-10">(</span><span class="p" data-group-id="4383747011-11">[</span><span class="ss">locked</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="ss">open</span><span class="p">/</span><span class="mi">3</span><span class="p" data-group-id="4383747011-11">]</span><span class="p" data-group-id="4383747011-10">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="4383747011-12">(</span><span class="n">Code</span><span class="p" data-group-id="4383747011-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="4383747011-13">(</span><span class="p" data-group-id="4383747011-14">{</span><span class="ss">local</span><span class="p">,</span><span class="o">?</span><span class="n">NAME</span><span class="p" data-group-id="4383747011-14">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4383747011-15">[</span><span class="p" data-group-id="4383747011-15">]</span><span class="p" data-group-id="4383747011-13">)</span><span class="p">.</span><span class="w">

</span><span class="nf">button</span><span class="p" data-group-id="4383747011-16">(</span><span class="n">Button</span><span class="p" data-group-id="4383747011-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="4383747011-17">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4383747011-18">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="4383747011-18">}</span><span class="p" data-group-id="4383747011-17">)</span><span class="p">.</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="4383747011-19">(</span><span class="n">Code</span><span class="p" data-group-id="4383747011-19">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="4383747011-20">(</span><span class="p" data-group-id="4383747011-20">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="4383747011-21">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="4383747011-22">(</span><span class="n">Code</span><span class="p" data-group-id="4383747011-22">)</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4383747011-23">[</span><span class="p" data-group-id="4383747011-23">]</span><span class="p" data-group-id="4383747011-21">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4383747011-24">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="4383747011-24">}</span><span class="p">.</span><span class="w">

</span><span class="nf">callback_mode</span><span class="p" data-group-id="4383747011-25">(</span><span class="p" data-group-id="4383747011-25">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">state_functions</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">locked</span><span class="p" data-group-id="0515086931-1">(</span><span class="w">
  </span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0515086931-2">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="0515086931-2">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="0515086931-3">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="0515086931-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0515086931-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=</span><span class="w">
        </span><span class="k">if</span><span class="w">
            </span><span class="nf">length</span><span class="p" data-group-id="0515086931-4">(</span><span class="n">Buttons</span><span class="p" data-group-id="0515086931-4">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="n">Buttons</span><span class="p">;</span><span class="w">
            </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nf">tl</span><span class="p" data-group-id="0515086931-5">(</span><span class="n">Buttons</span><span class="p" data-group-id="0515086931-5">)</span><span class="w">
        </span><span class="k">end</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="0515086931-6">[</span><span class="n">Button</span><span class="p" data-group-id="0515086931-6">]</span><span class="p">,</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="nf">do_unlock</span><span class="p" data-group-id="0515086931-7">(</span><span class="p" data-group-id="0515086931-7">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="0515086931-8">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0515086931-9">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="0515086931-10">[</span><span class="p" data-group-id="0515086931-10">]</span><span class="p" data-group-id="0515086931-9">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="0515086931-11">[</span><span class="p" data-group-id="0515086931-12">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="0515086931-12">}</span><span class="p" data-group-id="0515086931-11">]</span><span class="p" data-group-id="0515086931-8">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="err">	</span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Incomplete | Incorrect</span><span class="w">
            </span><span class="p" data-group-id="0515086931-13">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0515086931-14">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">NewButtons</span><span class="p" data-group-id="0515086931-14">}</span><span class="p" data-group-id="0515086931-13">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">open</span><span class="p" data-group-id="1830381190-1">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p">,</span><span class="w">  </span><span class="n">Data</span><span class="p" data-group-id="1830381190-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="1830381190-2">(</span><span class="p" data-group-id="1830381190-2">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1830381190-3">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="1830381190-3">}</span><span class="p">;</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="1830381190-4">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1830381190-5">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="1830381190-5">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="1830381190-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1830381190-6">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="1830381190-6">}</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">do_lock</span><span class="p" data-group-id="5506015764-1">(</span><span class="p" data-group-id="5506015764-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="5506015764-2">(</span><span class="s">&quot;Lock</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5506015764-3">[</span><span class="p" data-group-id="5506015764-3">]</span><span class="p" data-group-id="5506015764-2">)</span><span class="p">.</span><span class="w">
</span><span class="nf">do_unlock</span><span class="p" data-group-id="5506015764-4">(</span><span class="p" data-group-id="5506015764-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="5506015764-5">(</span><span class="s">&quot;Unlock</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5506015764-6">[</span><span class="p" data-group-id="5506015764-6">]</span><span class="p" data-group-id="5506015764-5">)</span><span class="p">.</span><span class="w">

</span><span class="nf">terminate</span><span class="p" data-group-id="5506015764-7">(</span><span class="p">_</span><span class="n">Reason</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="5506015764-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">State</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="ss">locked</span><span class="w"> </span><span class="ow">andalso</span><span class="w"> </span><span class="nf">do_lock</span><span class="p" data-group-id="5506015764-8">(</span><span class="p" data-group-id="5506015764-8">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span></code></pre><p>The code is explained in the next sections.</p><h2 id="starting-gen_statem" class="section-heading">
  <a href="#starting-gen_statem" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Starting gen_statem</span>
</h2>
<p>In the example in the previous section, <code class="inline">gen_statem</code> is started by calling
<code class="inline">code_lock:start_link(Code)</code>:</p><pre><code class="makeup erlang" translate="no"><span class="nf">start_link</span><span class="p" data-group-id="1624232342-1">(</span><span class="n">Code</span><span class="p" data-group-id="1624232342-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="1624232342-2">(</span><span class="p" data-group-id="1624232342-3">{</span><span class="ss">local</span><span class="p">,</span><span class="o">?</span><span class="n">NAME</span><span class="p" data-group-id="1624232342-3">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1624232342-4">[</span><span class="p" data-group-id="1624232342-4">]</span><span class="p" data-group-id="1624232342-2">)</span><span class="p">.</span></code></pre><p><code class="inline">start_link</code> calls function <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start_link/4"><code class="inline">gen_statem:start_link/4</code></a>, which spawns and links to
a new process, a <code class="inline">gen_statem</code>.</p><ul><li><p>The first argument, <code class="inline">{local,?NAME}</code>, specifies the name. In this case, the
<code class="inline">gen_statem</code> is locally registered as <code class="inline">code_lock</code> through the macro <code class="inline">?NAME</code>.</p><p>If the name is omitted, the <code class="inline">gen_statem</code> is not registered. Instead its pid
must be used. The name can also be specified as <code class="inline">{global,Name}</code>, then the
<code class="inline">gen_statem</code> is registered using <a href="../../lib/kernel-9.2.2/doc/html/global.html#register_name/2"><code class="inline">global:register_name/2</code></a> in Kernel.</p></li><li><p>The second argument, <code class="inline">?MODULE</code>, is the name of the <em>callback module</em>, that is,
the module where the callback functions are located, which is this module.</p><p>The interface functions (<code class="inline">start_link/1</code> and <code class="inline">button/1</code>) are located in the
same module as the callback functions (<code class="inline">init/1</code>, <code class="inline">locked/3</code>, and <code class="inline">open/3</code>). It
is normally good programming practice to have the client-side code and the
server-side code contained in one module.</p></li><li><p>The third argument, <code class="inline">Code</code>, is a list of digits, which is the correct unlock
code that is passed to callback function <code class="inline">init/1</code>.</p></li><li><p>The fourth argument, <code class="inline">[]</code>, is a list of options. For the available options,
see <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start_link/3"><code class="inline">gen_statem:start_link/3</code></a>.</p></li></ul><p>If name registration succeeds, the new <code class="inline">gen_statem</code> process calls callback
function <code class="inline">code_lock:init(Code)</code>. This function is expected to return
<code class="inline">{ok, State, Data}</code>, where <code class="inline">State</code> is the initial state of the <code class="inline">gen_statem</code>, in
this case <code class="inline">locked</code>; assuming that the door is locked to begin with. <code class="inline">Data</code> is
the internal server data of the <code class="inline">gen_statem</code>. Here the server data is a
<a href="../../lib/stdlib-5.2.1/doc/html/maps.html">map</a> with key <code class="inline">code</code> that stores the correct button sequence, key
<code class="inline">length</code> store its length, and key <code class="inline">buttons</code> that stores the collected buttons
up to the same length.</p><pre><code class="makeup erlang" translate="no"><span class="nf">init</span><span class="p" data-group-id="3479598794-1">(</span><span class="n">Code</span><span class="p" data-group-id="3479598794-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="3479598794-2">(</span><span class="p" data-group-id="3479598794-2">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3479598794-3">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="3479598794-4">(</span><span class="n">Code</span><span class="p" data-group-id="3479598794-4">)</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3479598794-5">[</span><span class="p" data-group-id="3479598794-5">]</span><span class="p" data-group-id="3479598794-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="3479598794-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="3479598794-6">}</span><span class="p">.</span></code></pre><p>Function <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start_link/3"><code class="inline">gen_statem:start_link</code></a> is synchronous. It
does not return until the <code class="inline">gen_statem</code> is initialized and is ready to receive
events.</p><p>Function <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start_link/3"><code class="inline">gen_statem:start_link</code></a> must be used if
the <code class="inline">gen_statem</code> is part of a supervision tree, that is, started by a
supervisor. Another function, <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start/3"><code class="inline">gen_statem:start</code></a> can be
used to start a standalone <code class="inline">gen_statem</code>, that is, a <code class="inline">gen_statem</code> that is not
part of a supervision tree.</p><p>Function <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:callback_mode/0"><code class="inline">Module:callback_mode/0</code></a> selects the
<a href="statem.html#callback-modes"><code class="inline">CallbackMode</code></a> for the <em>callback module</em>, in this
case <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:callback_mode/0"><code class="inline">state_functions</code></a>. That is, each state
has got its own handler function:</p><pre><code class="makeup erlang" translate="no"><span class="nf">callback_mode</span><span class="p" data-group-id="9907033193-1">(</span><span class="p" data-group-id="9907033193-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">state_functions</span><span class="p">.</span></code></pre><h2 id="handling-events" class="section-heading">
  <a href="#handling-events" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Handling Events</span>
</h2>
<p>The function notifying the code lock about a button event is implemented using
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#cast/2"><code class="inline">gen_statem:cast/2</code></a>:</p><pre><code class="makeup erlang" translate="no"><span class="nf">button</span><span class="p" data-group-id="2167037296-1">(</span><span class="n">Button</span><span class="p" data-group-id="2167037296-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="2167037296-2">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2167037296-3">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="2167037296-3">}</span><span class="p" data-group-id="2167037296-2">)</span><span class="p">.</span></code></pre><p>The first argument is the name of the <code class="inline">gen_statem</code> and must agree with the name
used to start it. So, we use the same macro <code class="inline">?NAME</code> as when starting.
<code class="inline">{button,Button}</code> is the event content.</p><p>The event is sent to the <code class="inline">gen_statem</code>. When the event is received, the
<code class="inline">gen_statem</code> calls <code class="inline">StateName(cast, Event, Data)</code>, which is expected to return a
tuple <code class="inline">{next_state, NewStateName, NewData}</code>, or
<code class="inline">{next_state, NewStateName, NewData, Actions}</code>. <code class="inline">StateName</code> is the name of the
current state and <code class="inline">NewStateName</code> is the name of the next state to go to.
<code class="inline">NewData</code> is a new value for the server data of the <code class="inline">gen_statem</code>, and <code class="inline">Actions</code>
is a list of actions to be performed by the <code class="inline">gen_statem</code> engine.</p><pre><code class="makeup erlang" translate="no"><span class="nf">locked</span><span class="p" data-group-id="7449684240-1">(</span><span class="w">
  </span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7449684240-2">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="7449684240-2">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7449684240-3">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="7449684240-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="7449684240-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=</span><span class="w">
        </span><span class="k">if</span><span class="w">
            </span><span class="nf">length</span><span class="p" data-group-id="7449684240-4">(</span><span class="n">Buttons</span><span class="p" data-group-id="7449684240-4">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="n">Buttons</span><span class="p">;</span><span class="w">
            </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nf">tl</span><span class="p" data-group-id="7449684240-5">(</span><span class="n">Buttons</span><span class="p" data-group-id="7449684240-5">)</span><span class="w">
        </span><span class="k">end</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="7449684240-6">[</span><span class="n">Button</span><span class="p" data-group-id="7449684240-6">]</span><span class="p">,</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="nf">do_unlock</span><span class="p" data-group-id="7449684240-7">(</span><span class="p" data-group-id="7449684240-7">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="7449684240-8">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="7449684240-9">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="7449684240-10">[</span><span class="p" data-group-id="7449684240-10">]</span><span class="p" data-group-id="7449684240-9">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="7449684240-11">[</span><span class="p" data-group-id="7449684240-12">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="7449684240-12">}</span><span class="p" data-group-id="7449684240-11">]</span><span class="p" data-group-id="7449684240-8">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="err">	</span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Incomplete | Incorrect</span><span class="w">
            </span><span class="p" data-group-id="7449684240-13">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="7449684240-14">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">NewButtons</span><span class="p" data-group-id="7449684240-14">}</span><span class="p" data-group-id="7449684240-13">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><p>In state <code class="inline">locked</code>, when a button is pressed, it is collected with the last
pressed buttons up to the length of the correct code, and compared with the
correct code. Depending on the result, the door is either unlocked and the
<code class="inline">gen_statem</code> goes to state <code class="inline">open</code>, or the door remains in state <code class="inline">locked</code>.</p><p>When changing to state <code class="inline">open</code>, the collected buttons are reset, the lock
unlocked, and a state timer for 10 s is started.</p><pre><code class="makeup erlang" translate="no"><span class="nf">open</span><span class="p" data-group-id="9366247233-1">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9366247233-2">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="9366247233-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9366247233-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9366247233-3">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9366247233-3">}</span><span class="p">.</span></code></pre><p>In state <code class="inline">open</code>, a button event is ignored by staying in the same state. This
can also be done by returning <code class="inline">{keep_state, Data}</code> or in this case since <code class="inline">Data</code>
unchanged even by returning <code class="inline">keep_state_and_data</code>.</p><h2 id="state-time-outs" class="section-heading">
  <a href="#state-time-outs" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">State Time-Outs</span>
</h2>
<p>When a correct code has been given, the door is unlocked and the following tuple
is returned from <code class="inline">locked/2</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="2418079363-1">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2418079363-2">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="2418079363-3">[</span><span class="p" data-group-id="2418079363-3">]</span><span class="p" data-group-id="2418079363-2">}</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="2418079363-4">[</span><span class="p" data-group-id="2418079363-5">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="2418079363-5">}</span><span class="p" data-group-id="2418079363-4">]</span><span class="p" data-group-id="2418079363-1">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span></code></pre><p>10,000 is a time-out value in milliseconds. After this time (10 seconds), a
time-out occurs. Then, <code class="inline">StateName(state_timeout, lock, Data)</code> is called. The
time-out occurs when the door has been in state <code class="inline">open</code> for 10 seconds. After
that the door is locked again:</p><pre><code class="makeup erlang" translate="no"><span class="nf">open</span><span class="p" data-group-id="0281243232-1">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p">,</span><span class="w">  </span><span class="n">Data</span><span class="p" data-group-id="0281243232-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="0281243232-2">(</span><span class="p" data-group-id="0281243232-2">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0281243232-3">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0281243232-3">}</span><span class="p">;</span></code></pre><p>The timer for a state time-out is automatically cancelled when the state machine
does a <em>state change</em>.</p><p>You can restart, cancel or update a state time-out. See section
<a href="statem.html#time-outs">Time-Outs</a> for details.</p><h2 id="all-state-events" class="section-heading">
  <a href="#all-state-events" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">All State Events</span>
</h2>
<p>Sometimes events can arrive in any state of the <code class="inline">gen_statem</code>. It is convenient
to handle these in a common state handler function that all state functions call
for events not specific to the state.</p><p>Consider a <code class="inline">code_length/0</code> function that returns the length of the correct code.
We dispatch all events that are not state-specific to the common function
<code class="inline">handle_common/3</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="9922130398-1">(</span><span class="p" data-group-id="9922130398-2">[</span><span class="ss">button</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">code_length</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="9922130398-2">]</span><span class="p" data-group-id="9922130398-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">code_length</span><span class="p" data-group-id="9922130398-3">(</span><span class="p" data-group-id="9922130398-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="9922130398-4">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="ss">code_length</span><span class="p" data-group-id="9922130398-4">)</span><span class="p">.</span><span class="w">

</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="9922130398-5">(</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="9922130398-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="9922130398-6">(</span><span class="n">EventType</span><span class="p">,</span><span class="w"> </span><span class="n">EventContent</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9922130398-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">handle_common</span><span class="p" data-group-id="9922130398-7">(</span><span class="n">EventType</span><span class="p">,</span><span class="w"> </span><span class="n">EventContent</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9922130398-7">)</span><span class="p">.</span><span class="w">

</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="9922130398-8">(</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="9922130398-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="9922130398-9">(</span><span class="n">EventType</span><span class="p">,</span><span class="w"> </span><span class="n">EventContent</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9922130398-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">handle_common</span><span class="p" data-group-id="9922130398-10">(</span><span class="n">EventType</span><span class="p">,</span><span class="w"> </span><span class="n">EventContent</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9922130398-10">)</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_common</span><span class="p" data-group-id="9922130398-11">(</span><span class="p" data-group-id="9922130398-12">{</span><span class="ss">call</span><span class="p">,</span><span class="n">From</span><span class="p" data-group-id="9922130398-12">}</span><span class="p">,</span><span class="w"> </span><span class="ss">code_length</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9922130398-13">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p" data-group-id="9922130398-13">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9922130398-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9922130398-14">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="9922130398-15">[</span><span class="p" data-group-id="9922130398-16">{</span><span class="ss">reply</span><span class="p">,</span><span class="n">From</span><span class="p">,</span><span class="nf">length</span><span class="p" data-group-id="9922130398-17">(</span><span class="n">Code</span><span class="p" data-group-id="9922130398-17">)</span><span class="p" data-group-id="9922130398-16">}</span><span class="p" data-group-id="9922130398-15">]</span><span class="p" data-group-id="9922130398-14">}</span><span class="p">.</span></code></pre><p>Another way to do it is through a convenience macro <code class="inline">?HANDLE_COMMON/0</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="9016446930-1">(</span><span class="p" data-group-id="9016446930-2">[</span><span class="ss">button</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">code_length</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="9016446930-2">]</span><span class="p" data-group-id="9016446930-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">code_length</span><span class="p" data-group-id="9016446930-3">(</span><span class="p" data-group-id="9016446930-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="9016446930-4">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="ss">code_length</span><span class="p" data-group-id="9016446930-4">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="9016446930-5">(</span><span class="n">HANDLE_COMMON</span><span class="p">,</span><span class="w">
    </span><span class="o">?</span><span class="n">FUNCTION_NAME</span><span class="p" data-group-id="9016446930-6">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p" data-group-id="9016446930-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_common</span><span class="p" data-group-id="9016446930-7">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p" data-group-id="9016446930-7">)</span><span class="p" data-group-id="9016446930-5">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%%</span><span class="w">
</span><span class="nf">handle_common</span><span class="p" data-group-id="9016446930-8">(</span><span class="p" data-group-id="9016446930-9">{</span><span class="ss">call</span><span class="p">,</span><span class="n">From</span><span class="p" data-group-id="9016446930-9">}</span><span class="p">,</span><span class="w"> </span><span class="ss">code_length</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9016446930-10">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p" data-group-id="9016446930-10">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9016446930-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9016446930-11">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="9016446930-12">[</span><span class="p" data-group-id="9016446930-13">{</span><span class="ss">reply</span><span class="p">,</span><span class="n">From</span><span class="p">,</span><span class="nf">length</span><span class="p" data-group-id="9016446930-14">(</span><span class="n">Code</span><span class="p" data-group-id="9016446930-14">)</span><span class="p" data-group-id="9016446930-13">}</span><span class="p" data-group-id="9016446930-12">]</span><span class="p" data-group-id="9016446930-11">}</span><span class="p">.</span><span class="w">

</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="9016446930-15">(</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="9016446930-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="o">?</span><span class="n">HANDLE_COMMON</span><span class="p">.</span><span class="w">

</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="9016446930-16">(</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="9016446930-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="o">?</span><span class="n">HANDLE_COMMON</span><span class="p">.</span></code></pre><p>This example uses <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#call/2"><code class="inline">gen_statem:call/2</code></a>, which waits for a reply from the server.
The reply is sent with a <code class="inline">{reply,From,Reply}</code> tuple in an action list in the
<code class="inline">{keep_state, ...}</code> tuple that retains the current state. This return form is
convenient when you want to stay in the current state but do not know or care
about what it is.</p><p>If the common <em>state callback</em> needs to know the current state a function
<code class="inline">handle_common/4</code> can be used instead:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="1728278004-1">(</span><span class="n">HANDLE_COMMON</span><span class="p">,</span><span class="w">
    </span><span class="o">?</span><span class="n">FUNCTION_NAME</span><span class="p" data-group-id="1728278004-2">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p" data-group-id="1728278004-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_common</span><span class="p" data-group-id="1728278004-3">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">FUNCTION_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p" data-group-id="1728278004-3">)</span><span class="p" data-group-id="1728278004-1">)</span><span class="p">.</span></code></pre><h2 id="one-state-callback" class="section-heading">
  <a href="#one-state-callback" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">One State Callback</span>
</h2>
<p>If <a href="statem.html#callback-modes"><em>callback mode</em> </a><code class="inline">handle_event_function</code> is used,
all events are handled in
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:handle_event/4"><code class="inline">Module:handle_event/4</code></a> and we can (but do not
have to) use an event-centered approach where we first branch depending on event
and then depending on state:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="0219683124-1">(</span><span class="p" data-group-id="0219683124-2">[</span><span class="ss">handle_event</span><span class="p">/</span><span class="mi">4</span><span class="p" data-group-id="0219683124-2">]</span><span class="p" data-group-id="0219683124-1">)</span><span class="p">.</span><span class="w">

</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">callback_mode</span><span class="p" data-group-id="0219683124-3">(</span><span class="p" data-group-id="0219683124-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">handle_event_function</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_event</span><span class="p" data-group-id="0219683124-4">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0219683124-5">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="0219683124-5">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0219683124-6">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p" data-group-id="0219683124-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0219683124-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="k">of</span><span class="w">
</span><span class="err">	</span><span class="ss">locked</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="0219683124-7">#{</span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="0219683124-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
            </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=</span><span class="w">
                </span><span class="k">if</span><span class="w">
                    </span><span class="nf">length</span><span class="p" data-group-id="0219683124-8">(</span><span class="n">Buttons</span><span class="p" data-group-id="0219683124-8">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                        </span><span class="n">Buttons</span><span class="p">;</span><span class="w">
                    </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                        </span><span class="nf">tl</span><span class="p" data-group-id="0219683124-9">(</span><span class="n">Buttons</span><span class="p" data-group-id="0219683124-9">)</span><span class="w">
                </span><span class="k">end</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="0219683124-10">[</span><span class="n">Button</span><span class="p" data-group-id="0219683124-10">]</span><span class="p">,</span><span class="w">
            </span><span class="k">if</span><span class="w">
                </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
                    </span><span class="nf">do_unlock</span><span class="p" data-group-id="0219683124-11">(</span><span class="p" data-group-id="0219683124-11">)</span><span class="p">,</span><span class="w">
                    </span><span class="p" data-group-id="0219683124-12">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0219683124-13">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="0219683124-14">[</span><span class="p" data-group-id="0219683124-14">]</span><span class="p" data-group-id="0219683124-13">}</span><span class="p">,</span><span class="w">
                     </span><span class="p" data-group-id="0219683124-15">[</span><span class="p" data-group-id="0219683124-16">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="0219683124-16">}</span><span class="p" data-group-id="0219683124-15">]</span><span class="p" data-group-id="0219683124-12">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Incomplete | Incorrect</span><span class="w">
                    </span><span class="p" data-group-id="0219683124-17">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0219683124-18">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">NewButtons</span><span class="p" data-group-id="0219683124-18">}</span><span class="p" data-group-id="0219683124-17">}</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
</span><span class="err">	</span><span class="ss">open</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">keep_state_and_data</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="0219683124-19">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0219683124-19">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="0219683124-20">(</span><span class="p" data-group-id="0219683124-20">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0219683124-21">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0219683124-21">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="0219683124-22">(</span><span class="w">
  </span><span class="p" data-group-id="0219683124-23">{</span><span class="ss">call</span><span class="p">,</span><span class="n">From</span><span class="p" data-group-id="0219683124-23">}</span><span class="p">,</span><span class="w"> </span><span class="ss">code_length</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0219683124-24">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p" data-group-id="0219683124-24">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0219683124-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="0219683124-25">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="0219683124-26">[</span><span class="p" data-group-id="0219683124-27">{</span><span class="ss">reply</span><span class="p">,</span><span class="n">From</span><span class="p">,</span><span class="nf">length</span><span class="p" data-group-id="0219683124-28">(</span><span class="n">Code</span><span class="p" data-group-id="0219683124-28">)</span><span class="p" data-group-id="0219683124-27">}</span><span class="p" data-group-id="0219683124-26">]</span><span class="p" data-group-id="0219683124-25">}</span><span class="p">.</span><span class="w">

</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><h2 id="stopping" class="section-heading">
  <a href="#stopping" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Stopping</span>
</h2>
<h3 id="in-a-supervision-tree" class="section-heading">
  <a href="#in-a-supervision-tree" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">In a Supervision Tree</span>
</h3>
<p>If the <code class="inline">gen_statem</code> is part of a supervision tree, no stop function is needed.
The <code class="inline">gen_statem</code> is automatically terminated by its supervisor. Exactly how this
is done is defined by a <a href="sup_princ.html#shutdown">shutdown strategy</a> set in the
supervisor.</p><p>If it is necessary to clean up before termination, the shutdown strategy must be
a time-out value and the <code class="inline">gen_statem</code> must in function <code class="inline">init/1</code> set itself to
trap exit signals by calling
<a href="../../erts-14.2.3/doc/html/erlang.html#process_flag/2"><code class="inline">process_flag(trap_exit, true)</code></a>:</p><pre><code class="makeup erlang" translate="no"><span class="nf">init</span><span class="p" data-group-id="7270997995-1">(</span><span class="n">Args</span><span class="p" data-group-id="7270997995-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">process_flag</span><span class="p" data-group-id="7270997995-2">(</span><span class="ss">trap_exit</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="7270997995-2">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="7270997995-3">(</span><span class="p" data-group-id="7270997995-3">)</span><span class="p">,</span><span class="w">
    </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p>When ordered to shut down, the <code class="inline">gen_statem</code> then calls callback function
<code class="inline">terminate(shutdown, State, Data)</code>.</p><p>In this example, function <code class="inline">terminate/3</code> locks the door if it is open, so we do
not accidentally leave the door open when the supervision tree terminates:</p><pre><code class="makeup erlang" translate="no"><span class="nf">terminate</span><span class="p" data-group-id="0705126690-1">(</span><span class="p">_</span><span class="n">Reason</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="0705126690-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">State</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="ss">locked</span><span class="w"> </span><span class="ow">andalso</span><span class="w"> </span><span class="nf">do_lock</span><span class="p" data-group-id="0705126690-2">(</span><span class="p" data-group-id="0705126690-2">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span></code></pre><h3 id="standalone-gen_statem" class="section-heading">
  <a href="#standalone-gen_statem" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Standalone gen_statem</span>
</h3>
<p>If the <code class="inline">gen_statem</code> is not part of a supervision tree, it can be stopped using
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#stop/1"><code class="inline">gen_statem:stop</code></a>, preferably through an API function:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="3401373451-1">(</span><span class="p" data-group-id="3401373451-2">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">stop</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="3401373451-2">]</span><span class="p" data-group-id="3401373451-1">)</span><span class="p">.</span><span class="w">

</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">stop</span><span class="p" data-group-id="3401373451-3">(</span><span class="p" data-group-id="3401373451-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">stop</span><span class="p" data-group-id="3401373451-4">(</span><span class="o">?</span><span class="n">NAME</span><span class="p" data-group-id="3401373451-4">)</span><span class="p">.</span></code></pre><p>This makes the <code class="inline">gen_statem</code> call callback function <code class="inline">terminate/3</code> just like for a
supervised server and waits for the process to terminate.</p><h2 id="event-time-outs" class="section-heading">
  <a href="#event-time-outs" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Event Time-Outs</span>
</h2>
<p>A time-out feature inherited from <code class="inline">gen_statem</code>'s predecessor <a href="../../lib/stdlib-5.2.1/doc/html/gen_fsm.html"><code class="inline">gen_fsm</code></a>, is an
event time-out, that is, if an event arrives the timer is cancelled. You get
either an event or a time-out, but not both.</p><p>It is ordered by the
<a href="statem.html#transition-actions"><em>transition action</em> </a><code class="inline">{timeout,Time,EventContent}</code>,
or just an integer <code class="inline">Time</code>, even without the enclosing actions list (the latter
is a form inherited from <code class="inline">gen_fsm</code>.</p><p>This type of time-out is useful for example to act on inactivity. Let us restart
the code sequence if no button is pressed for say 30 seconds:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">locked</span><span class="p" data-group-id="6671143824-1">(</span><span class="ss">timeout</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6671143824-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="6671143824-2">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6671143824-3">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="6671143824-4">[</span><span class="p" data-group-id="6671143824-4">]</span><span class="p" data-group-id="6671143824-3">}</span><span class="p" data-group-id="6671143824-2">}</span><span class="p">;</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="6671143824-5">(</span><span class="w">
  </span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6671143824-6">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="6671143824-6">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6671143824-7">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="6671143824-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6671143824-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="err">	</span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Incomplete | Incorrect</span><span class="w">
            </span><span class="p" data-group-id="6671143824-8">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6671143824-9">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">NewButtons</span><span class="p" data-group-id="6671143824-9">}</span><span class="p">,</span><span class="w">
             </span><span class="mi">30000</span><span class="p" data-group-id="6671143824-8">}</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p>Whenever we receive a button event we start an event time-out of 30 seconds, and
if we get an <em>event type</em> of <code class="inline">timeout</code> we reset the remaining code sequence.</p><p>An event time-out is cancelled by any other event so you either get some other
event or the time-out event. It is therefore not possible nor needed to cancel,
restart or update an event time-out. Whatever event you act on has already
cancelled the event time-out, so there is never a running event time-out while
the <em>state callback</em> executes.</p><p>Note that an event time-out does not work well when you have for example a
status call as in section <a href="statem.html#all-state-events">All State Events</a>, or
handle unknown events, since all kinds of events will cancel the event time-out.</p><h2 id="generic-time-outs" class="section-heading">
  <a href="#generic-time-outs" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Generic Time-Outs</span>
</h2>
<p>The previous example of state time-outs only work if the state machine stays in
the same state during the time-out time. And event time-outs only work if no
disturbing unrelated events occur.</p><p>You may want to start a timer in one state and respond to the time-out in
another, maybe cancel the time-out without changing states, or perhaps run
multiple time-outs in parallel. All this can be accomplished with
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:generic_timeout/0">generic time-outs</a>. They may look a little
bit like <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:event_timeout/0">event time-outs</a> but contain a name to
allow for any number of them simultaneously and they are not automatically
cancelled.</p><p>Here is how to accomplish the state time-out in the previous example by instead
using a generic time-out named for example <code class="inline">open</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="3191169552-1">(</span><span class="w">
  </span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3191169552-2">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="3191169552-2">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="3191169552-3">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="3191169552-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="3191169552-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="nf">do_unlock</span><span class="p" data-group-id="3191169552-4">(</span><span class="p" data-group-id="3191169552-4">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="3191169552-5">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="3191169552-6">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="3191169552-7">[</span><span class="p" data-group-id="3191169552-7">]</span><span class="p" data-group-id="3191169552-6">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="3191169552-8">[</span><span class="p" data-group-id="3191169552-9">{</span><span class="p" data-group-id="3191169552-10">{</span><span class="ss">timeout</span><span class="p">,</span><span class="ss">open</span><span class="p" data-group-id="3191169552-10">}</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="3191169552-9">}</span><span class="p" data-group-id="3191169552-8">]</span><span class="p" data-group-id="3191169552-5">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">open</span><span class="p" data-group-id="3191169552-11">(</span><span class="p" data-group-id="3191169552-12">{</span><span class="ss">timeout</span><span class="p">,</span><span class="ss">open</span><span class="p" data-group-id="3191169552-12">}</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="3191169552-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="3191169552-13">(</span><span class="p" data-group-id="3191169552-13">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="3191169552-14">{</span><span class="ss">next_state</span><span class="p">,</span><span class="ss">locked</span><span class="p">,</span><span class="n">Data</span><span class="p" data-group-id="3191169552-14">}</span><span class="p">;</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="3191169552-15">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3191169552-16">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="3191169552-16">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="3191169552-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="3191169552-17">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="n">Data</span><span class="p" data-group-id="3191169552-17">}</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p>Specific generic time-outs can just as
<a href="statem.html#state-time-outs">state time-outs</a> be restarted or cancelled by
setting it to a new time or <code class="inline">infinity</code>.</p><p>In this particular case we do not need to cancel the time-out since the time-out
event is the only possible reason to do a <em>state change</em> from <code class="inline">open</code> to
<code class="inline">locked</code>.</p><p>Instead of bothering with when to cancel a time-out, a late time-out event can
be handled by ignoring it if it arrives in a state where it is known to be late.</p><p>You can restart, cancel or update a generic time-out. See section
<a href="statem.html#time-outs">Time-Outs</a> for details.</p><h2 id="erlang-timers" class="section-heading">
  <a href="#erlang-timers" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Erlang Timers</span>
</h2>
<p>The most versatile way to handle time-outs is to use Erlang Timers; see
<a href="../../erts-14.2.3/doc/html/erlang.html#start_timer/4"><code class="inline">erlang:start_timer/3,4</code></a>. Most time-out tasks can be
performed with the time-out features in <code class="inline">gen_statem</code>, but an example of one that
cannot is if you should need the return value from
<a href="../../erts-14.2.3/doc/html/erlang.html#cancel_timer/2"><code class="inline">erlang:cancel_timer(Tref)</code></a>, that is; the remaining
time of the timer.</p><p>Here is how to accomplish the state time-out in the previous example by instead
using an Erlang Timer:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="4068466925-1">(</span><span class="w">
  </span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4068466925-2">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="4068466925-2">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4068466925-3">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="4068466925-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="4068466925-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="nf">do_unlock</span><span class="p" data-group-id="4068466925-4">(</span><span class="p" data-group-id="4068466925-4">)</span><span class="p">,</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="n">Tref</span><span class="w"> </span><span class="o">=</span><span class="w">
                 </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">start_timer</span><span class="p" data-group-id="4068466925-5">(</span><span class="w">
                     </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="4068466925-6">(</span><span class="p" data-group-id="4068466925-6">)</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p" data-group-id="4068466925-5">)</span><span class="p">,</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
            </span><span class="p" data-group-id="4068466925-7">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="4068466925-8">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="4068466925-9">[</span><span class="p" data-group-id="4068466925-9">]</span><span class="p">,</span><span class="w"> </span><span class="ss">timer</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Tref</span><span class="p" data-group-id="4068466925-8">}</span><span class="p" data-group-id="4068466925-7">}</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">open</span><span class="p" data-group-id="4068466925-10">(</span><span class="ss">info</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4068466925-11">{</span><span class="ss">timeout</span><span class="p">,</span><span class="n">Tref</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="4068466925-11">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4068466925-12">#{</span><span class="ss">timer</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Tref</span><span class="p" data-group-id="4068466925-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="4068466925-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="4068466925-13">(</span><span class="p" data-group-id="4068466925-13">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4068466925-14">{</span><span class="ss">next_state</span><span class="p">,</span><span class="ss">locked</span><span class="p">,</span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="4068466925-15">(</span><span class="ss">timer</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="4068466925-15">)</span><span class="p" data-group-id="4068466925-14">}</span><span class="p">;</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="4068466925-16">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4068466925-17">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="4068466925-17">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="4068466925-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="4068466925-18">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="n">Data</span><span class="p" data-group-id="4068466925-18">}</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p>Removing the <code class="inline">timer</code> key from the map when we do a <em>state change</em> to <code class="inline">locked</code> is
not strictly necessary since we can only get into state <code class="inline">open</code> with an updated
<code class="inline">timer</code> map value. But it can be nice to not have outdated values in the state
<code class="inline">Data</code>!</p><p>If you need to cancel a timer because of some other event, you can use
<a href="../../erts-14.2.3/doc/html/erlang.html#cancel_timer/2"><code class="inline">erlang:cancel_timer(Tref)</code></a>. Note that no time-out
message will arrive after this (because the timer has been explicitly canceled),
unless you have already postponed one earlier (see the next section), so ensure
that you do not accidentally postpone such messages. Also note that a time-out
message may arrive during a <em>state callback</em> that is cancelling the timer, so
you may have to read out such a message from the process mailbox, depending on
the return value from <a href="../../erts-14.2.3/doc/html/erlang.html#cancel_timer/2"><code class="inline">erlang:cancel_timer(Tref)</code></a>.</p><p>Another way to handle a late time-out can be to not cancel it, but to ignore it
if it arrives in a state where it is known to be late.</p><h2 id="postponing-events" class="section-heading">
  <a href="#postponing-events" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Postponing Events</span>
</h2>
<p>If you want to ignore a particular event in the current state and handle it in a
future state, you can postpone the event. A postponed event is retried after a
<em>state change</em>, that is, <code class="inline">OldState =/= NewState</code>.</p><p>Postponing is ordered by the
<a href="statem.html#transition-actions"><em>transition action</em> </a><code class="inline">postpone</code>.</p><p>In this example, instead of ignoring button events while in the <code class="inline">open</code> state, we
can postpone them and they are queued and later handled in the <code class="inline">locked</code> state:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="0099693547-1">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0099693547-2">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="0099693547-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0099693547-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="0099693547-3">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="n">Data</span><span class="p">,</span><span class="p" data-group-id="0099693547-4">[</span><span class="ss">postpone</span><span class="p" data-group-id="0099693547-4">]</span><span class="p" data-group-id="0099693547-3">}</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p>Since a postponed event is only retried after a <em>state change</em>, you have to
think about where to keep a state data item. You can keep it in the server
<code class="inline">Data</code> or in the <code class="inline">State</code> itself, for example by having two more or less
identical states to keep a boolean value, or by using a complex state (see
section <a href="statem.html#complex-state">Complex State</a>) with
<a href="statem.html#callback-modes"><em>callback mode</em></a>
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:callback_mode/0"><code class="inline">handle_event_function</code></a>. If a change in the
value changes the set of events that is handled, then the value should be kept
in the State. Otherwise no postponed events will be retried since only the
server Data changes.</p><p>This is not important if you do not postpone events. But if you later decide to
start postponing some events, then the design flaw of not having separate states
when they should be, might become a hard-to-find bug.</p><h3 id="fuzzy-state-diagrams" class="section-heading">
  <a href="#fuzzy-state-diagrams" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Fuzzy State Diagrams</span>
</h3>
<p>It is not uncommon that a state diagram does not specify how to handle events
that are not illustrated in a particular state in the diagram. Hopefully this is
described in an associated text or from the context.</p><p>Possible actions: ignore as in drop the event (maybe log it) or deal with the
event in some other state as in postpone it.</p><h3 id="selective-receive" class="section-heading">
  <a href="#selective-receive" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Selective Receive</span>
</h3>
<p>Erlang's selective receive statement is often used to describe simple state
machine examples in straightforward Erlang code. The following is a possible
implementation of the first example:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="6995656431-1">(</span><span class="ss">code_lock</span><span class="p" data-group-id="6995656431-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="6995656431-2">(</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="ss">code_lock_1</span><span class="p" data-group-id="6995656431-2">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="6995656431-3">(</span><span class="p" data-group-id="6995656431-4">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">button</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="6995656431-4">]</span><span class="p" data-group-id="6995656431-3">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="6995656431-5">(</span><span class="n">Code</span><span class="p" data-group-id="6995656431-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">spawn</span><span class="p" data-group-id="6995656431-6">(</span><span class="w">
      </span><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="6995656431-7">(</span><span class="p" data-group-id="6995656431-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err">	</span><span class="w">      </span><span class="ss">true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">register</span><span class="p" data-group-id="6995656431-8">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="6995656431-9">(</span><span class="p" data-group-id="6995656431-9">)</span><span class="p" data-group-id="6995656431-8">)</span><span class="p">,</span><span class="w">
</span><span class="err">	</span><span class="w">      </span><span class="nf">do_lock</span><span class="p" data-group-id="6995656431-10">(</span><span class="p" data-group-id="6995656431-10">)</span><span class="p">,</span><span class="w">
</span><span class="err">	</span><span class="w">      </span><span class="nf">locked</span><span class="p" data-group-id="6995656431-11">(</span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="6995656431-12">(</span><span class="n">Code</span><span class="p" data-group-id="6995656431-12">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6995656431-13">[</span><span class="p" data-group-id="6995656431-13">]</span><span class="p" data-group-id="6995656431-11">)</span><span class="w">
      </span><span class="k">end</span><span class="p" data-group-id="6995656431-6">)</span><span class="p">.</span><span class="w">

</span><span class="nf">button</span><span class="p" data-group-id="6995656431-14">(</span><span class="n">Button</span><span class="p" data-group-id="6995656431-14">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="o">?</span><span class="n">NAME</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="6995656431-15">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="6995656431-15">}</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">locked</span><span class="p" data-group-id="3626511839-1">(</span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="3626511839-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">receive</span><span class="w">
        </span><span class="p" data-group-id="3626511839-2">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="3626511839-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=</span><span class="w">
                </span><span class="k">if</span><span class="w">
                    </span><span class="nf">length</span><span class="p" data-group-id="3626511839-3">(</span><span class="n">Buttons</span><span class="p" data-group-id="3626511839-3">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                        </span><span class="n">Buttons</span><span class="p">;</span><span class="w">
                    </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                        </span><span class="nf">tl</span><span class="p" data-group-id="3626511839-4">(</span><span class="n">Buttons</span><span class="p" data-group-id="3626511839-4">)</span><span class="w">
                </span><span class="k">end</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="3626511839-5">[</span><span class="n">Button</span><span class="p" data-group-id="3626511839-5">]</span><span class="p">,</span><span class="w">
            </span><span class="k">if</span><span class="w">
                </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
                    </span><span class="nf">do_unlock</span><span class="p" data-group-id="3626511839-6">(</span><span class="p" data-group-id="3626511839-6">)</span><span class="p">,</span><span class="w">
</span><span class="err">	</span><span class="err">	</span><span class="w">    </span><span class="nf">open</span><span class="p" data-group-id="3626511839-7">(</span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p" data-group-id="3626511839-7">)</span><span class="p">;</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Incomplete | Incorrect</span><span class="w">
                    </span><span class="nf">locked</span><span class="p" data-group-id="3626511839-8">(</span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="n">NewButtons</span><span class="p" data-group-id="3626511839-8">)</span><span class="w">
            </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">open</span><span class="p" data-group-id="8201251538-1">(</span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p" data-group-id="8201251538-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">receive</span><span class="w">
    </span><span class="k">after</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="nf">do_lock</span><span class="p" data-group-id="8201251538-2">(</span><span class="p" data-group-id="8201251538-2">)</span><span class="p">,</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="nf">locked</span><span class="p" data-group-id="8201251538-3">(</span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8201251538-4">[</span><span class="p" data-group-id="8201251538-4">]</span><span class="p" data-group-id="8201251538-3">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">do_lock</span><span class="p" data-group-id="8201251538-5">(</span><span class="p" data-group-id="8201251538-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="8201251538-6">(</span><span class="s">&quot;Locked</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8201251538-7">[</span><span class="p" data-group-id="8201251538-7">]</span><span class="p" data-group-id="8201251538-6">)</span><span class="p">.</span><span class="w">
</span><span class="nf">do_unlock</span><span class="p" data-group-id="8201251538-8">(</span><span class="p" data-group-id="8201251538-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="8201251538-9">(</span><span class="s">&quot;Open</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8201251538-10">[</span><span class="p" data-group-id="8201251538-10">]</span><span class="p" data-group-id="8201251538-9">)</span><span class="p">.</span></code></pre><p>The selective receive in this case causes <code class="inline">open</code> to implicitly postpone any
events to the <code class="inline">locked</code> state.</p><p>A catch-all receive should never be used from a <code class="inline">gen_statem</code> behaviour (or from
any <code class="inline">gen_*</code> behaviour), as the receive statement is within the <code class="inline">gen_*</code> engine
itself. <a href="../../lib/stdlib-5.2.1/doc/html/sys.html"><code class="inline">sys</code></a> compatible behaviours must respond to system messages and
therefore do that in their engine receive loop, passing non-system messages to
the <em>callback module</em>. Using a catch-all receive may result in system messages
being discarded which in turn may lead to unexpected behaviour. If a selective
receive must be used then great care should be taken to ensure that only
messages pertinent to the operation are received. Likewise, a callback must
return in due time to let the engine receive loop handle system messages, or
they might time out also leading to unexpected behaviour.</p><p>The <a href="statem.html#transition-actions"><em>transition action</em> </a><code class="inline">postpone</code> is designed
to model selective receives. A selective receive implicitly postpones any not
received events, but the <code class="inline">postpone</code> <em>transition action</em> explicitly postpones one
received event.</p><p>Both mechanisms have the same theoretical time and memory complexity, while the
selective receive language construct has smaller constant factors.</p><h2 id="state-enter-actions" class="section-heading">
  <a href="#state-enter-actions" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">State Enter Actions</span>
</h2>
<p>Say you have a state machine specification that uses state enter actions.
Although you can code this using inserted events (described in the next
section), especially if just one or a few states has got state enter actions,
this is a perfect use case for the built in
<a href="statem.html#state-enter-calls"><em>state enter calls</em></a>.</p><p>You return a list containing <code class="inline">state_enter</code> from your
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:callback_mode/0"><code class="inline">callback_mode/0</code> </a>function and the
<code class="inline">gen_statem</code> engine will call your <em>state callback</em> once with an event
<code class="inline">(enter, OldState, ...)</code> whenever it does a <em>state change</em>. Then you just need
to handle these event-like calls in all states.</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">init</span><span class="p" data-group-id="6209357030-1">(</span><span class="n">Code</span><span class="p" data-group-id="6209357030-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">process_flag</span><span class="p" data-group-id="6209357030-2">(</span><span class="ss">trap_exit</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="6209357030-2">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6209357030-3">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="6209357030-4">(</span><span class="n">Code</span><span class="p" data-group-id="6209357030-4">)</span><span class="p" data-group-id="6209357030-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6209357030-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6209357030-5">}</span><span class="p">.</span><span class="w">

</span><span class="nf">callback_mode</span><span class="p" data-group-id="6209357030-6">(</span><span class="p" data-group-id="6209357030-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="6209357030-7">[</span><span class="ss">state_functions</span><span class="p">,</span><span class="ss">state_enter</span><span class="p" data-group-id="6209357030-7">]</span><span class="p">.</span><span class="w">

</span><span class="nf">locked</span><span class="p" data-group-id="6209357030-8">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6209357030-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="6209357030-9">(</span><span class="p" data-group-id="6209357030-9">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6209357030-10">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="n">Data</span><span class="p" data-group-id="6209357030-11">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6209357030-12">[</span><span class="p" data-group-id="6209357030-12">]</span><span class="p" data-group-id="6209357030-11">}</span><span class="p" data-group-id="6209357030-10">}</span><span class="p">;</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="6209357030-13">(</span><span class="w">
  </span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6209357030-14">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="6209357030-14">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6209357030-15">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="6209357030-15">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6209357030-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
            </span><span class="p" data-group-id="6209357030-16">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6209357030-16">}</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">open</span><span class="p" data-group-id="6209357030-17">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="6209357030-17">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_unlock</span><span class="p" data-group-id="6209357030-18">(</span><span class="p" data-group-id="6209357030-18">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6209357030-19">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="6209357030-20">[</span><span class="p" data-group-id="6209357030-21">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="6209357030-21">}</span><span class="p" data-group-id="6209357030-20">]</span><span class="p" data-group-id="6209357030-19">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="6209357030-22">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6209357030-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="6209357030-23">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6209357030-23">}</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p>You can repeat the state enter code by returning one of <code class="inline">{repeat_state, ...}</code>,
<code class="inline">{repeat_state_and_data,_}</code> or <code class="inline">repeat_state_and_data</code> that otherwise behaves
exactly like their <code class="inline">keep_state</code> siblings. See the type
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:state_callback_result/1"><code class="inline">state_callback_result()</code> </a>in the
reference manual.</p><h2 id="inserted-events" class="section-heading">
  <a href="#inserted-events" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Inserted Events</span>
</h2>
<p>It can sometimes be beneficial to be able to generate events to your own state
machine. This can be done with the
<a href="statem.html#transition-actions"><em>transition action</em> </a><a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0"><code class="inline">{next_event,EventType,EventContent}</code></a>.</p><p>You can generate events of any existing <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:action/0">type</a>, but the
<code class="inline">internal</code> type can only be generated through action <code class="inline">next_event</code>. Hence, it
cannot come from an external source, so you can be certain that an <code class="inline">internal</code>
event is an event from your state machine to itself.</p><p>One example for this is to pre-process incoming data, for example decrypting
chunks or collecting characters up to a line break.</p><p>Purists may argue that this should be modelled with a separate state machine
that sends pre-processed events to the main state machine, but to decrease
overhead the small pre-processing state machine can be implemented in the common
state event handling of the main state machine using a few state data variables
that then sends the pre-processed events as internal events to the main state
machine. Using internal events also can make it easier to synchronize the state
machines.</p><p>A variant of this is to use a <a href="statem.html#complex-state">complex state</a> with
<a href="statem.html#one-state-callback"><em>one state callback</em></a>. The state is then modeled
with for example a tuple <code class="inline">{MainFSMState,SubFSMState}</code>.</p><p>To illustrate this we make up an example where the buttons instead generate down
and up (press and release) events, and the lock responds to an up event only
after the corresponding down event.</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="5957357405-1">(</span><span class="p" data-group-id="5957357405-2">[</span><span class="ss">down</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">up</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="5957357405-2">]</span><span class="p" data-group-id="5957357405-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">down</span><span class="p" data-group-id="5957357405-3">(</span><span class="n">Button</span><span class="p" data-group-id="5957357405-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="5957357405-4">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5957357405-5">{</span><span class="ss">down</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="5957357405-5">}</span><span class="p" data-group-id="5957357405-4">)</span><span class="p">.</span><span class="w">

</span><span class="nf">up</span><span class="p" data-group-id="5957357405-6">(</span><span class="n">Button</span><span class="p" data-group-id="5957357405-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="5957357405-7">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5957357405-8">{</span><span class="ss">up</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="5957357405-8">}</span><span class="p" data-group-id="5957357405-7">)</span><span class="p">.</span><span class="w">

</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">locked</span><span class="p" data-group-id="5957357405-9">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5957357405-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="5957357405-10">(</span><span class="p" data-group-id="5957357405-10">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5957357405-11">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="n">Data</span><span class="p" data-group-id="5957357405-12">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5957357405-13">[</span><span class="p" data-group-id="5957357405-13">]</span><span class="p" data-group-id="5957357405-12">}</span><span class="p" data-group-id="5957357405-11">}</span><span class="p">;</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="5957357405-14">(</span><span class="w">
  </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5957357405-15">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="5957357405-15">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="5957357405-16">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="5957357405-16">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5957357405-14">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">handle_common</span><span class="p" data-group-id="5899429938-1">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5899429938-2">{</span><span class="ss">down</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="5899429938-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5899429938-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5899429938-3">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5899429938-4">#{</span><span class="ss">button</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Button</span><span class="p" data-group-id="5899429938-4">}</span><span class="p" data-group-id="5899429938-3">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_common</span><span class="p" data-group-id="5899429938-5">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5899429938-6">{</span><span class="ss">up</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="5899429938-6">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5899429938-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="5899429938-7">#{</span><span class="ss">button</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Button</span><span class="p" data-group-id="5899429938-7">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="5899429938-8">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="5899429938-9">(</span><span class="ss">button</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5899429938-9">)</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="5899429938-10">[</span><span class="p" data-group-id="5899429938-11">{</span><span class="ss">next_event</span><span class="p">,</span><span class="ss">internal</span><span class="p">,</span><span class="p" data-group-id="5899429938-12">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="5899429938-12">}</span><span class="p" data-group-id="5899429938-11">}</span><span class="p" data-group-id="5899429938-10">]</span><span class="p" data-group-id="5899429938-8">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="5899429938-13">#{</span><span class="p" data-group-id="5899429938-13">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">keep_state_and_data</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">open</span><span class="p" data-group-id="5899429938-14">(</span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5899429938-15">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="5899429938-15">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5899429938-14">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5899429938-16">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="n">Data</span><span class="p">,</span><span class="p" data-group-id="5899429938-17">[</span><span class="ss">postpone</span><span class="p" data-group-id="5899429938-17">]</span><span class="p" data-group-id="5899429938-16">}</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p>If you start this program with <code class="inline">code_lock:start([17])</code> you can unlock with
<code class="inline">code_lock:down(17), code_lock:up(17).</code></p><h2 id="example-revisited" class="section-heading">
  <a href="#example-revisited" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Example Revisited</span>
</h2>
<p>This section includes the example after most of the mentioned modifications and
some more using <em>state enter calls</em>, which deserves a new state diagram:</p><p><img alt="Code Lock State Diagram Revisited" src="assets/code_lock_2.svg" title="Code Lock State Diagram Revisited" width="80%"/></p><p>Notice that this state diagram does not specify how to handle a button event in
the state <code class="inline">open</code>. So, you need to read in some side notes, that is, here: that
unspecified events shall be postponed (handled in some later state). Also, the
state diagram does not show that the <code class="inline">code_length/0</code> call must be handled in
every state.</p><h3 id="callback-mode-state_functions" class="section-heading">
  <a href="#callback-mode-state_functions" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Callback Mode: state_functions</span>
</h3>
<p>Using state functions:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="1660112752-1">(</span><span class="ss">code_lock</span><span class="p" data-group-id="1660112752-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="1660112752-2">(</span><span class="ss">gen_statem</span><span class="p" data-group-id="1660112752-2">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="1660112752-3">(</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="ss">code_lock_2</span><span class="p" data-group-id="1660112752-3">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1660112752-4">(</span><span class="p" data-group-id="1660112752-5">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">stop</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="1660112752-5">]</span><span class="p" data-group-id="1660112752-4">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1660112752-6">(</span><span class="p" data-group-id="1660112752-7">[</span><span class="ss">down</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">up</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">code_length</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="1660112752-7">]</span><span class="p" data-group-id="1660112752-6">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1660112752-8">(</span><span class="p" data-group-id="1660112752-9">[</span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">callback_mode</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="ss">terminate</span><span class="p">/</span><span class="mi">3</span><span class="p" data-group-id="1660112752-9">]</span><span class="p" data-group-id="1660112752-8">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1660112752-10">(</span><span class="p" data-group-id="1660112752-11">[</span><span class="ss">locked</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="ss">open</span><span class="p">/</span><span class="mi">3</span><span class="p" data-group-id="1660112752-11">]</span><span class="p" data-group-id="1660112752-10">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="1660112752-12">(</span><span class="n">Code</span><span class="p" data-group-id="1660112752-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="1660112752-13">(</span><span class="p" data-group-id="1660112752-14">{</span><span class="ss">local</span><span class="p">,</span><span class="o">?</span><span class="n">NAME</span><span class="p" data-group-id="1660112752-14">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1660112752-15">[</span><span class="p" data-group-id="1660112752-15">]</span><span class="p" data-group-id="1660112752-13">)</span><span class="p">.</span><span class="w">
</span><span class="nf">stop</span><span class="p" data-group-id="1660112752-16">(</span><span class="p" data-group-id="1660112752-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">stop</span><span class="p" data-group-id="1660112752-17">(</span><span class="o">?</span><span class="n">NAME</span><span class="p" data-group-id="1660112752-17">)</span><span class="p">.</span><span class="w">

</span><span class="nf">down</span><span class="p" data-group-id="1660112752-18">(</span><span class="n">Button</span><span class="p" data-group-id="1660112752-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="1660112752-19">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1660112752-20">{</span><span class="ss">down</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="1660112752-20">}</span><span class="p" data-group-id="1660112752-19">)</span><span class="p">.</span><span class="w">
</span><span class="nf">up</span><span class="p" data-group-id="1660112752-21">(</span><span class="n">Button</span><span class="p" data-group-id="1660112752-21">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="1660112752-22">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1660112752-23">{</span><span class="ss">up</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="1660112752-23">}</span><span class="p" data-group-id="1660112752-22">)</span><span class="p">.</span><span class="w">
</span><span class="nf">code_length</span><span class="p" data-group-id="1660112752-24">(</span><span class="p" data-group-id="1660112752-24">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="1660112752-25">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="ss">code_length</span><span class="p" data-group-id="1660112752-25">)</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">init</span><span class="p" data-group-id="2393762010-1">(</span><span class="n">Code</span><span class="p" data-group-id="2393762010-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">process_flag</span><span class="p" data-group-id="2393762010-2">(</span><span class="ss">trap_exit</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="2393762010-2">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2393762010-3">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="2393762010-4">(</span><span class="n">Code</span><span class="p" data-group-id="2393762010-4">)</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="2393762010-5">[</span><span class="p" data-group-id="2393762010-5">]</span><span class="p" data-group-id="2393762010-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2393762010-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2393762010-6">}</span><span class="p">.</span><span class="w">

</span><span class="nf">callback_mode</span><span class="p" data-group-id="2393762010-7">(</span><span class="p" data-group-id="2393762010-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2393762010-8">[</span><span class="ss">state_functions</span><span class="p">,</span><span class="ss">state_enter</span><span class="p" data-group-id="2393762010-8">]</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2393762010-9">(</span><span class="n">HANDLE_COMMON</span><span class="p">,</span><span class="w">
    </span><span class="o">?</span><span class="n">FUNCTION_NAME</span><span class="p" data-group-id="2393762010-10">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p" data-group-id="2393762010-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_common</span><span class="p" data-group-id="2393762010-11">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p" data-group-id="2393762010-11">)</span><span class="p" data-group-id="2393762010-9">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%%</span><span class="w">
</span><span class="nf">handle_common</span><span class="p" data-group-id="2393762010-12">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2393762010-13">{</span><span class="ss">down</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="2393762010-13">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2393762010-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2393762010-14">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2393762010-15">#{</span><span class="ss">button</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Button</span><span class="p" data-group-id="2393762010-15">}</span><span class="p" data-group-id="2393762010-14">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_common</span><span class="p" data-group-id="2393762010-16">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2393762010-17">{</span><span class="ss">up</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="2393762010-17">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2393762010-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2393762010-18">#{</span><span class="ss">button</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Button</span><span class="p" data-group-id="2393762010-18">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="2393762010-19">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="2393762010-20">(</span><span class="ss">button</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2393762010-20">)</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2393762010-21">[</span><span class="p" data-group-id="2393762010-22">{</span><span class="ss">next_event</span><span class="p">,</span><span class="ss">internal</span><span class="p">,</span><span class="p" data-group-id="2393762010-23">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="2393762010-23">}</span><span class="p" data-group-id="2393762010-22">}</span><span class="p" data-group-id="2393762010-21">]</span><span class="p" data-group-id="2393762010-19">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2393762010-24">#{</span><span class="p" data-group-id="2393762010-24">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">keep_state_and_data</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_common</span><span class="p" data-group-id="2393762010-25">(</span><span class="p" data-group-id="2393762010-26">{</span><span class="ss">call</span><span class="p">,</span><span class="n">From</span><span class="p" data-group-id="2393762010-26">}</span><span class="p">,</span><span class="w"> </span><span class="ss">code_length</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2393762010-27">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p" data-group-id="2393762010-27">}</span><span class="p" data-group-id="2393762010-25">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2393762010-28">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="2393762010-29">[</span><span class="p" data-group-id="2393762010-30">{</span><span class="ss">reply</span><span class="p">,</span><span class="n">From</span><span class="p">,</span><span class="nf">length</span><span class="p" data-group-id="2393762010-31">(</span><span class="n">Code</span><span class="p" data-group-id="2393762010-31">)</span><span class="p" data-group-id="2393762010-30">}</span><span class="p" data-group-id="2393762010-29">]</span><span class="p" data-group-id="2393762010-28">}</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">locked</span><span class="p" data-group-id="6782845017-1">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6782845017-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="6782845017-2">(</span><span class="p" data-group-id="6782845017-2">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6782845017-3">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6782845017-4">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="6782845017-5">[</span><span class="p" data-group-id="6782845017-5">]</span><span class="p" data-group-id="6782845017-4">}</span><span class="p" data-group-id="6782845017-3">}</span><span class="p">;</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="6782845017-6">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">button</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6782845017-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="6782845017-7">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6782845017-8">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="6782845017-9">[</span><span class="p" data-group-id="6782845017-9">]</span><span class="p" data-group-id="6782845017-8">}</span><span class="p" data-group-id="6782845017-7">}</span><span class="p">;</span><span class="w">
</span><span class="nf">locked</span><span class="p" data-group-id="6782845017-10">(</span><span class="w">
  </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6782845017-11">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="6782845017-11">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6782845017-12">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="6782845017-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6782845017-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=</span><span class="w">
        </span><span class="k">if</span><span class="w">
            </span><span class="nf">length</span><span class="p" data-group-id="6782845017-13">(</span><span class="n">Buttons</span><span class="p" data-group-id="6782845017-13">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="n">Buttons</span><span class="p">;</span><span class="w">
            </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nf">tl</span><span class="p" data-group-id="6782845017-14">(</span><span class="n">Buttons</span><span class="p" data-group-id="6782845017-14">)</span><span class="w">
        </span><span class="k">end</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="6782845017-15">[</span><span class="n">Button</span><span class="p" data-group-id="6782845017-15">]</span><span class="p">,</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
            </span><span class="p" data-group-id="6782845017-16">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6782845017-16">}</span><span class="p">;</span><span class="w">
</span><span class="err">	</span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Incomplete | Incorrect</span><span class="w">
            </span><span class="p" data-group-id="6782845017-17">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6782845017-18">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">NewButtons</span><span class="p" data-group-id="6782845017-18">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="6782845017-19">[</span><span class="p" data-group-id="6782845017-20">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">30000</span><span class="p">,</span><span class="ss">button</span><span class="p" data-group-id="6782845017-20">}</span><span class="p" data-group-id="6782845017-19">]</span><span class="p" data-group-id="6782845017-17">}</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">
</span><span class="o">?</span><span class="n">HANDLE_COMMON</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">open</span><span class="p" data-group-id="8540205241-1">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="8540205241-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_unlock</span><span class="p" data-group-id="8540205241-2">(</span><span class="p" data-group-id="8540205241-2">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8540205241-3">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="8540205241-4">[</span><span class="p" data-group-id="8540205241-5">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="8540205241-5">}</span><span class="p" data-group-id="8540205241-4">]</span><span class="p" data-group-id="8540205241-3">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="8540205241-6">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="8540205241-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="8540205241-7">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="8540205241-7">}</span><span class="p">;</span><span class="w">
</span><span class="nf">open</span><span class="p" data-group-id="8540205241-8">(</span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8540205241-9">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="8540205241-9">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="8540205241-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="8540205241-10">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8540205241-11">[</span><span class="ss">postpone</span><span class="p" data-group-id="8540205241-11">]</span><span class="p" data-group-id="8540205241-10">}</span><span class="p">;</span><span class="w">
</span><span class="o">?</span><span class="n">HANDLE_COMMON</span><span class="p">.</span><span class="w">

</span><span class="nf">do_lock</span><span class="p" data-group-id="8540205241-12">(</span><span class="p" data-group-id="8540205241-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="8540205241-13">(</span><span class="s">&quot;Locked</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8540205241-14">[</span><span class="p" data-group-id="8540205241-14">]</span><span class="p" data-group-id="8540205241-13">)</span><span class="p">.</span><span class="w">
</span><span class="nf">do_unlock</span><span class="p" data-group-id="8540205241-15">(</span><span class="p" data-group-id="8540205241-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="8540205241-16">(</span><span class="s">&quot;Open</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8540205241-17">[</span><span class="p" data-group-id="8540205241-17">]</span><span class="p" data-group-id="8540205241-16">)</span><span class="p">.</span><span class="w">

</span><span class="nf">terminate</span><span class="p" data-group-id="8540205241-18">(</span><span class="p">_</span><span class="n">Reason</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="8540205241-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">State</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="ss">locked</span><span class="w"> </span><span class="ow">andalso</span><span class="w"> </span><span class="nf">do_lock</span><span class="p" data-group-id="8540205241-19">(</span><span class="p" data-group-id="8540205241-19">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span></code></pre><h3 id="callback-mode-handle_event_function" class="section-heading">
  <a href="#callback-mode-handle_event_function" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Callback Mode: handle_event_function</span>
</h3>
<p>This section describes what to change in the example to use one <code class="inline">handle_event/4</code>
function. The previously used approach to first branch depending on event does
not work that well here because of the <em>state enter calls</em>, so this example
first branches depending on state:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1703277387-1">(</span><span class="p" data-group-id="1703277387-2">[</span><span class="ss">handle_event</span><span class="p">/</span><span class="mi">4</span><span class="p" data-group-id="1703277387-2">]</span><span class="p" data-group-id="1703277387-1">)</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">callback_mode</span><span class="p" data-group-id="1155765037-1">(</span><span class="p" data-group-id="1155765037-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1155765037-2">[</span><span class="ss">handle_event_function</span><span class="p">,</span><span class="ss">state_enter</span><span class="p" data-group-id="1155765037-2">]</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="c1">%%</span><span class="w">
</span><span class="c1">%% State: locked</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2446481830-1">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2446481830-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="2446481830-2">(</span><span class="p" data-group-id="2446481830-2">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2446481830-3">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2446481830-4">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="2446481830-5">[</span><span class="p" data-group-id="2446481830-5">]</span><span class="p" data-group-id="2446481830-4">}</span><span class="p" data-group-id="2446481830-3">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2446481830-6">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">button</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2446481830-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2446481830-7">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2446481830-8">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="2446481830-9">[</span><span class="p" data-group-id="2446481830-9">]</span><span class="p" data-group-id="2446481830-8">}</span><span class="p" data-group-id="2446481830-7">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2446481830-10">(</span><span class="w">
  </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2446481830-11">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="2446481830-11">}</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2446481830-12">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="2446481830-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2446481830-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=</span><span class="w">
        </span><span class="k">if</span><span class="w">
            </span><span class="nf">length</span><span class="p" data-group-id="2446481830-13">(</span><span class="n">Buttons</span><span class="p" data-group-id="2446481830-13">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="n">Buttons</span><span class="p">;</span><span class="w">
            </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nf">tl</span><span class="p" data-group-id="2446481830-14">(</span><span class="n">Buttons</span><span class="p" data-group-id="2446481830-14">)</span><span class="w">
        </span><span class="k">end</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="2446481830-15">[</span><span class="n">Button</span><span class="p" data-group-id="2446481830-15">]</span><span class="p">,</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
            </span><span class="p" data-group-id="2446481830-16">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2446481830-16">}</span><span class="p">;</span><span class="w">
</span><span class="err">	</span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Incomplete | Incorrect</span><span class="w">
            </span><span class="p" data-group-id="2446481830-17">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2446481830-18">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">NewButtons</span><span class="p" data-group-id="2446481830-18">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2446481830-19">[</span><span class="p" data-group-id="2446481830-20">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">30000</span><span class="p">,</span><span class="ss">button</span><span class="p" data-group-id="2446481830-20">}</span><span class="p" data-group-id="2446481830-19">]</span><span class="p" data-group-id="2446481830-17">}</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="c1">%%</span><span class="w">
</span><span class="c1">%% State: open</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="5222835752-1">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="5222835752-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_unlock</span><span class="p" data-group-id="5222835752-2">(</span><span class="p" data-group-id="5222835752-2">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5222835752-3">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="5222835752-4">[</span><span class="p" data-group-id="5222835752-5">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="5222835752-5">}</span><span class="p" data-group-id="5222835752-4">]</span><span class="p" data-group-id="5222835752-3">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="5222835752-6">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5222835752-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5222835752-7">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">locked</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5222835752-7">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="5222835752-8">(</span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5222835752-9">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="5222835752-9">}</span><span class="p">,</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="5222835752-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5222835752-10">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="p" data-group-id="5222835752-11">[</span><span class="ss">postpone</span><span class="p" data-group-id="5222835752-11">]</span><span class="p" data-group-id="5222835752-10">}</span><span class="p">;</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="c1">%% Common events</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="8615346556-1">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8615346556-2">{</span><span class="ss">down</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="8615346556-2">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="8615346556-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="8615346556-3">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="8615346556-4">#{</span><span class="ss">button</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Button</span><span class="p" data-group-id="8615346556-4">}</span><span class="p" data-group-id="8615346556-3">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="8615346556-5">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8615346556-6">{</span><span class="ss">up</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="8615346556-6">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="8615346556-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="8615346556-7">#{</span><span class="ss">button</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Button</span><span class="p" data-group-id="8615346556-7">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="8615346556-8">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="8615346556-9">(</span><span class="ss">button</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="8615346556-9">)</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="8615346556-10">[</span><span class="p" data-group-id="8615346556-11">{</span><span class="ss">next_event</span><span class="p">,</span><span class="ss">internal</span><span class="p">,</span><span class="p" data-group-id="8615346556-12">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="8615346556-12">}</span><span class="p" data-group-id="8615346556-11">}</span><span class="p">,</span><span class="w">
              </span><span class="p" data-group-id="8615346556-13">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">30000</span><span class="p">,</span><span class="ss">button</span><span class="p" data-group-id="8615346556-13">}</span><span class="p" data-group-id="8615346556-10">]</span><span class="p" data-group-id="8615346556-8">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
        </span><span class="p" data-group-id="8615346556-14">#{</span><span class="p" data-group-id="8615346556-14">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">keep_state_and_data</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="8615346556-15">(</span><span class="p" data-group-id="8615346556-16">{</span><span class="ss">call</span><span class="p">,</span><span class="n">From</span><span class="p" data-group-id="8615346556-16">}</span><span class="p">,</span><span class="w"> </span><span class="ss">code_length</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8615346556-17">#{</span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p" data-group-id="8615346556-17">}</span><span class="p" data-group-id="8615346556-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="8615346556-18">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="8615346556-19">[</span><span class="p" data-group-id="8615346556-20">{</span><span class="ss">reply</span><span class="p">,</span><span class="n">From</span><span class="p">,</span><span class="n">Length</span><span class="p" data-group-id="8615346556-20">}</span><span class="p" data-group-id="8615346556-19">]</span><span class="p" data-group-id="8615346556-18">}</span><span class="p">.</span></code></pre><p>Notice that postponing buttons from the <code class="inline">open</code> state to the <code class="inline">locked</code> state feels
like a strange thing to do for a code lock, but it at least illustrates event
postponing.</p><h2 id="filter-the-state" class="section-heading">
  <a href="#filter-the-state" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Filter the State</span>
</h2>
<p>The example servers so far in this chapter print the full internal state in the
error log, for example, when killed by an exit signal or because of an internal
error. This state contains both the code lock code and which digits that remain
to unlock.</p><p>This state data can be regarded as sensitive, and maybe not what you want in the
error log because of some unpredictable event.</p><p>Another reason to filter the state can be that the state is too large to print,
as it fills the error log with uninteresting details.</p><p>To avoid this, you can format the internal state that gets in the error log and
gets returned from <a href="../../lib/stdlib-5.2.1/doc/html/sys.html#get_status/1"><code class="inline">sys:get_status/1,2</code></a> by implementing
function <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:format_status/2"><code class="inline">Module:format_status/2</code></a>, for example
like this:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1964815600-1">(</span><span class="p" data-group-id="1964815600-2">[</span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">terminate</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="ss">format_status</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="1964815600-2">]</span><span class="p" data-group-id="1964815600-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="nf">format_status</span><span class="p" data-group-id="1964815600-3">(</span><span class="n">Opt</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1964815600-4">[</span><span class="p">_</span><span class="n">PDict</span><span class="p">,</span><span class="n">State</span><span class="p">,</span><span class="n">Data</span><span class="p" data-group-id="1964815600-4">]</span><span class="p" data-group-id="1964815600-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">StateData</span><span class="w"> </span><span class="o">=</span><span class="w">
</span><span class="err">	</span><span class="p" data-group-id="1964815600-5">{</span><span class="n">State</span><span class="p">,</span><span class="w">
</span><span class="err">	</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">filter</span><span class="p" data-group-id="1964815600-6">(</span><span class="w">
</span><span class="err">	</span><span class="w">   </span><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="1964815600-7">(</span><span class="ss">code</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="1964815600-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p">;</span><span class="w">
</span><span class="err">	</span><span class="w">       </span><span class="p" data-group-id="1964815600-8">(</span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="1964815600-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">
</span><span class="err">	</span><span class="w">   </span><span class="k">end</span><span class="p">,</span><span class="w">
</span><span class="err">	</span><span class="w">   </span><span class="n">Data</span><span class="p" data-group-id="1964815600-6">)</span><span class="p" data-group-id="1964815600-5">}</span><span class="p">,</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Opt</span><span class="w"> </span><span class="k">of</span><span class="w">
</span><span class="err">	</span><span class="ss">terminate</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="n">StateData</span><span class="p">;</span><span class="w">
</span><span class="err">	</span><span class="ss">normal</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err">	</span><span class="w">    </span><span class="p" data-group-id="1964815600-9">[</span><span class="p" data-group-id="1964815600-10">{</span><span class="ss">data</span><span class="p">,</span><span class="p" data-group-id="1964815600-11">[</span><span class="p" data-group-id="1964815600-12">{</span><span class="s">&quot;State&quot;</span><span class="p">,</span><span class="n">StateData</span><span class="p" data-group-id="1964815600-12">}</span><span class="p" data-group-id="1964815600-11">]</span><span class="p" data-group-id="1964815600-10">}</span><span class="p" data-group-id="1964815600-9">]</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><p>It is not mandatory to implement a
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#c:format_status/2"><code class="inline">Module:format_status/2</code></a> function. If you do
not, a default implementation is used that does the same as this example
function without filtering the <code class="inline">Data</code> term, that is, <code class="inline">StateData = {State,Data}</code>,
in this example containing sensitive information.</p><h2 id="complex-state" class="section-heading">
  <a href="#complex-state" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Complex State</span>
</h2>
<p>The <em>callback mode</em> <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:callback_mode/0"><code class="inline">handle_event_function</code></a>
enables using a non-atom state as described in section
<a href="statem.html#callback-modes">Callback Modes</a>, for example, a complex state term
like a tuple.</p><p>One reason to use this is when you have a state item that when changed should
cancel the <a href="statem.html#state-time-outs">state time-out</a>, or one that affects the
event handling in combination with postponing events. We will go for the latter
and complicate the previous example by introducing a configurable lock button
(this is the state item in question), which in the <code class="inline">open</code> state immediately
locks the door, and an API function <code class="inline">set_lock_button/1</code> to set the lock button.</p><p>Suppose now that we call <code class="inline">set_lock_button</code> while the door is open, and we have
already postponed a button event that was the new lock button:</p><pre><code class="makeup erlang" translate="no"><span class="gp unselectable">1&gt; </span><span class="nc">code_lock</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="9074380870-1">(</span><span class="p" data-group-id="9074380870-2">[</span><span class="ss">a</span><span class="p">,</span><span class="ss">b</span><span class="p">,</span><span class="ss">c</span><span class="p" data-group-id="9074380870-2">]</span><span class="p">,</span><span class="w"> </span><span class="ss">x</span><span class="p" data-group-id="9074380870-1">)</span><span class="p">.</span><span class="w">
</span><span class="p" data-group-id="9074380870-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="o">&lt;</span><span class="mf">0.666</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p" data-group-id="9074380870-3">}</span><span class="gp unselectable">
2&gt; </span><span class="nc">code_lock</span><span class="p">:</span><span class="nf">button</span><span class="p" data-group-id="9074380870-4">(</span><span class="ss">a</span><span class="p" data-group-id="9074380870-4">)</span><span class="p">.</span><span class="w">
</span><span class="ss">ok</span><span class="gp unselectable">
3&gt; </span><span class="nc">code_lock</span><span class="p">:</span><span class="nf">button</span><span class="p" data-group-id="9074380870-5">(</span><span class="ss">b</span><span class="p" data-group-id="9074380870-5">)</span><span class="p">.</span><span class="w">
</span><span class="ss">ok</span><span class="gp unselectable">
4&gt; </span><span class="nc">code_lock</span><span class="p">:</span><span class="nf">button</span><span class="p" data-group-id="9074380870-6">(</span><span class="ss">c</span><span class="p" data-group-id="9074380870-6">)</span><span class="p">.</span><span class="w">
</span><span class="ss">ok</span><span class="w">
</span><span class="n">Open</span><span class="gp unselectable">
5&gt; </span><span class="nc">code_lock</span><span class="p">:</span><span class="nf">button</span><span class="p" data-group-id="9074380870-7">(</span><span class="ss">y</span><span class="p" data-group-id="9074380870-7">)</span><span class="p">.</span><span class="w">
</span><span class="ss">ok</span><span class="gp unselectable">
6&gt; </span><span class="nc">code_lock</span><span class="p">:</span><span class="nf">set_lock_button</span><span class="p" data-group-id="9074380870-8">(</span><span class="ss">y</span><span class="p" data-group-id="9074380870-8">)</span><span class="p">.</span><span class="w">
</span><span class="ss">x</span><span class="w">
</span><span class="c1">% What should happen here?  Immediate lock or nothing?</span></code></pre><p>We could say that the button was pressed too early so it is not to be recognized
as the lock button. Or we can make the lock button part of the state so when we
then change the lock button in the locked state, the change becomes a <em>state
change</em> and all postponed events are retried, therefore the lock is immediately
locked!</p><p>We define the state as <code class="inline">{StateName,LockButton}</code>, where <code class="inline">StateName</code> is as before
and <code class="inline">LockButton</code> is the current lock button:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="7125968096-1">(</span><span class="ss">code_lock</span><span class="p" data-group-id="7125968096-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="7125968096-2">(</span><span class="ss">gen_statem</span><span class="p" data-group-id="7125968096-2">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="7125968096-3">(</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="ss">code_lock_3</span><span class="p" data-group-id="7125968096-3">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="7125968096-4">(</span><span class="p" data-group-id="7125968096-5">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="ss">stop</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="7125968096-5">]</span><span class="p" data-group-id="7125968096-4">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="7125968096-6">(</span><span class="p" data-group-id="7125968096-7">[</span><span class="ss">button</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">set_lock_button</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="7125968096-7">]</span><span class="p" data-group-id="7125968096-6">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="7125968096-8">(</span><span class="p" data-group-id="7125968096-9">[</span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="ss">callback_mode</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="ss">terminate</span><span class="p">/</span><span class="mi">3</span><span class="p" data-group-id="7125968096-9">]</span><span class="p" data-group-id="7125968096-8">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="7125968096-10">(</span><span class="p" data-group-id="7125968096-11">[</span><span class="ss">handle_event</span><span class="p">/</span><span class="mi">4</span><span class="p" data-group-id="7125968096-11">]</span><span class="p" data-group-id="7125968096-10">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="7125968096-12">(</span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="n">LockButton</span><span class="p" data-group-id="7125968096-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="7125968096-13">(</span><span class="w">
        </span><span class="p" data-group-id="7125968096-14">{</span><span class="ss">local</span><span class="p">,</span><span class="o">?</span><span class="n">NAME</span><span class="p" data-group-id="7125968096-14">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7125968096-15">{</span><span class="n">Code</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="7125968096-15">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7125968096-16">[</span><span class="p" data-group-id="7125968096-16">]</span><span class="p" data-group-id="7125968096-13">)</span><span class="p">.</span><span class="w">
</span><span class="nf">stop</span><span class="p" data-group-id="7125968096-17">(</span><span class="p" data-group-id="7125968096-17">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">stop</span><span class="p" data-group-id="7125968096-18">(</span><span class="o">?</span><span class="n">NAME</span><span class="p" data-group-id="7125968096-18">)</span><span class="p">.</span><span class="w">

</span><span class="nf">button</span><span class="p" data-group-id="7125968096-19">(</span><span class="n">Button</span><span class="p" data-group-id="7125968096-19">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="7125968096-20">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7125968096-21">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="7125968096-21">}</span><span class="p" data-group-id="7125968096-20">)</span><span class="p">.</span><span class="w">
</span><span class="nf">set_lock_button</span><span class="p" data-group-id="7125968096-22">(</span><span class="n">LockButton</span><span class="p" data-group-id="7125968096-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="7125968096-23">(</span><span class="o">?</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7125968096-24">{</span><span class="ss">set_lock_button</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="7125968096-24">}</span><span class="p" data-group-id="7125968096-23">)</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">init</span><span class="p" data-group-id="2941152294-1">(</span><span class="p" data-group-id="2941152294-2">{</span><span class="n">Code</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="2941152294-2">}</span><span class="p" data-group-id="2941152294-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">process_flag</span><span class="p" data-group-id="2941152294-3">(</span><span class="ss">trap_exit</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="2941152294-3">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2941152294-4">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="2941152294-5">(</span><span class="n">Code</span><span class="p" data-group-id="2941152294-5">)</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="2941152294-6">[</span><span class="p" data-group-id="2941152294-6">]</span><span class="p" data-group-id="2941152294-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2941152294-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2941152294-8">{</span><span class="ss">locked</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="2941152294-8">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2941152294-7">}</span><span class="p">.</span><span class="w">

</span><span class="nf">callback_mode</span><span class="p" data-group-id="2941152294-9">(</span><span class="p" data-group-id="2941152294-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2941152294-10">[</span><span class="ss">handle_event_function</span><span class="p">,</span><span class="ss">state_enter</span><span class="p" data-group-id="2941152294-10">]</span><span class="p">.</span><span class="w">

</span><span class="c1">%% State: locked</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2941152294-11">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2941152294-12">{</span><span class="ss">locked</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="2941152294-12">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2941152294-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_lock</span><span class="p" data-group-id="2941152294-13">(</span><span class="p" data-group-id="2941152294-13">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2941152294-14">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2941152294-15">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="2941152294-16">[</span><span class="p" data-group-id="2941152294-16">]</span><span class="p" data-group-id="2941152294-15">}</span><span class="p" data-group-id="2941152294-14">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2941152294-17">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">button</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2941152294-18">{</span><span class="ss">locked</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="2941152294-18">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2941152294-17">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2941152294-19">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2941152294-20">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="2941152294-21">[</span><span class="p" data-group-id="2941152294-21">]</span><span class="p" data-group-id="2941152294-20">}</span><span class="p" data-group-id="2941152294-19">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2941152294-22">(</span><span class="w">
  </span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2941152294-23">{</span><span class="ss">button</span><span class="p">,</span><span class="n">Button</span><span class="p" data-group-id="2941152294-23">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2941152294-24">{</span><span class="ss">locked</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="2941152294-24">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2941152294-25">#{</span><span class="ss">code</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Length</span><span class="p">,</span><span class="w"> </span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Buttons</span><span class="p" data-group-id="2941152294-25">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2941152294-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=</span><span class="w">
        </span><span class="k">if</span><span class="w">
            </span><span class="nf">length</span><span class="p" data-group-id="2941152294-26">(</span><span class="n">Buttons</span><span class="p" data-group-id="2941152294-26">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="n">Buttons</span><span class="p">;</span><span class="w">
            </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nf">tl</span><span class="p" data-group-id="2941152294-27">(</span><span class="n">Buttons</span><span class="p" data-group-id="2941152294-27">)</span><span class="w">
        </span><span class="k">end</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="2941152294-28">[</span><span class="n">Button</span><span class="p" data-group-id="2941152294-28">]</span><span class="p">,</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">NewButtons</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Correct</span><span class="w">
            </span><span class="p" data-group-id="2941152294-29">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2941152294-30">{</span><span class="ss">open</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="2941152294-30">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2941152294-29">}</span><span class="p">;</span><span class="w">
</span><span class="err">	</span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="c1">% Incomplete | Incorrect</span><span class="w">
            </span><span class="p" data-group-id="2941152294-31">{</span><span class="ss">keep_state</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2941152294-32">#{</span><span class="ss">buttons</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">NewButtons</span><span class="p" data-group-id="2941152294-32">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2941152294-33">[</span><span class="p" data-group-id="2941152294-34">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">30000</span><span class="p">,</span><span class="ss">button</span><span class="p" data-group-id="2941152294-34">}</span><span class="p" data-group-id="2941152294-33">]</span><span class="p" data-group-id="2941152294-31">}</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="c1">%%</span><span class="w">
</span><span class="c1">%% State: open</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="1302437184-1">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1302437184-2">{</span><span class="ss">open</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="1302437184-2">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="1302437184-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_unlock</span><span class="p" data-group-id="1302437184-3">(</span><span class="p" data-group-id="1302437184-3">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1302437184-4">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="1302437184-5">[</span><span class="p" data-group-id="1302437184-6">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="1302437184-6">}</span><span class="p" data-group-id="1302437184-5">]</span><span class="p" data-group-id="1302437184-4">}</span><span class="p">;</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="1302437184-7">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">lock</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1302437184-8">{</span><span class="ss">open</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="1302437184-8">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="1302437184-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1302437184-9">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1302437184-10">{</span><span class="ss">locked</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="1302437184-10">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="1302437184-9">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="1302437184-11">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1302437184-12">{</span><span class="ss">button</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="1302437184-12">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1302437184-13">{</span><span class="ss">open</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="1302437184-13">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="1302437184-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1302437184-14">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1302437184-15">{</span><span class="ss">locked</span><span class="p">,</span><span class="n">LockButton</span><span class="p" data-group-id="1302437184-15">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="1302437184-14">}</span><span class="p">;</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="1302437184-16">(</span><span class="ss">cast</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1302437184-17">{</span><span class="ss">button</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="1302437184-17">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1302437184-18">{</span><span class="ss">open</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="1302437184-18">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="1302437184-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1302437184-19">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="p" data-group-id="1302437184-20">[</span><span class="ss">postpone</span><span class="p" data-group-id="1302437184-20">]</span><span class="p" data-group-id="1302437184-19">}</span><span class="p">;</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="c1">%%</span><span class="w">
</span><span class="c1">%% Common events</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2482382114-1">(</span><span class="w">
  </span><span class="p" data-group-id="2482382114-2">{</span><span class="ss">call</span><span class="p">,</span><span class="n">From</span><span class="p" data-group-id="2482382114-2">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2482382114-3">{</span><span class="ss">set_lock_button</span><span class="p">,</span><span class="n">NewLockButton</span><span class="p" data-group-id="2482382114-3">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2482382114-4">{</span><span class="n">StateName</span><span class="p">,</span><span class="n">OldLockButton</span><span class="p" data-group-id="2482382114-4">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2482382114-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2482382114-5">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2482382114-6">{</span><span class="n">StateName</span><span class="p">,</span><span class="n">NewLockButton</span><span class="p" data-group-id="2482382114-6">}</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="2482382114-7">[</span><span class="p" data-group-id="2482382114-8">{</span><span class="ss">reply</span><span class="p">,</span><span class="n">From</span><span class="p">,</span><span class="n">OldLockButton</span><span class="p" data-group-id="2482382114-8">}</span><span class="p" data-group-id="2482382114-7">]</span><span class="p" data-group-id="2482382114-5">}</span><span class="p">.</span></code></pre><pre><code class="makeup erlang" translate="no"><span class="nf">do_lock</span><span class="p" data-group-id="7778559846-1">(</span><span class="p" data-group-id="7778559846-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="7778559846-2">(</span><span class="s">&quot;Locked</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7778559846-3">[</span><span class="p" data-group-id="7778559846-3">]</span><span class="p" data-group-id="7778559846-2">)</span><span class="p">.</span><span class="w">
</span><span class="nf">do_unlock</span><span class="p" data-group-id="7778559846-4">(</span><span class="p" data-group-id="7778559846-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="7778559846-5">(</span><span class="s">&quot;Open</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7778559846-6">[</span><span class="p" data-group-id="7778559846-6">]</span><span class="p" data-group-id="7778559846-5">)</span><span class="p">.</span><span class="w">

</span><span class="nf">terminate</span><span class="p" data-group-id="7778559846-7">(</span><span class="p">_</span><span class="n">Reason</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="7778559846-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">State</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="ss">locked</span><span class="w"> </span><span class="ow">andalso</span><span class="w"> </span><span class="nf">do_lock</span><span class="p" data-group-id="7778559846-8">(</span><span class="p" data-group-id="7778559846-8">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span></code></pre><h2 id="hibernation" class="section-heading">
  <a href="#hibernation" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Hibernation</span>
</h2>
<p>If you have many servers in one node and they have some state(s) in their
lifetime in which the servers can be expected to idle for a while, and the
amount of heap memory all these servers need is a problem, then the memory
footprint of a server can be minimized by hibernating it through
<a href="../../lib/stdlib-5.2.1/doc/html/proc_lib.html#hibernate/3"><code class="inline">proc_lib:hibernate/3</code></a>.</p><blockquote><h4 class="info">Note</h4><p>It is rather costly to hibernate a process; see <a href="../../erts-14.2.3/doc/html/erlang.html#hibernate/3"><code class="inline">erlang:hibernate/3</code></a>. It is
not something you want to do after every event.</p></blockquote><p>We can in this example hibernate in the <code class="inline">{open,_}</code> state, because what normally
occurs in that state is that the state time-out after a while triggers a
transition to <code class="inline">{locked,_}</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="c1">%%</span><span class="w">
</span><span class="c1">%% State: open</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="8931008724-1">(</span><span class="ss">enter</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">OldState</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8931008724-2">{</span><span class="ss">open</span><span class="p">,</span><span class="p">_</span><span class="p" data-group-id="8931008724-2">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Data</span><span class="p" data-group-id="8931008724-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">do_unlock</span><span class="p" data-group-id="8931008724-3">(</span><span class="p" data-group-id="8931008724-3">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8931008724-4">{</span><span class="ss">keep_state_and_data</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="8931008724-5">[</span><span class="p" data-group-id="8931008724-6">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="ss">lock</span><span class="p" data-group-id="8931008724-6">}</span><span class="p">,</span><span class="w"> </span><span class="c1">% Time in milliseconds</span><span class="w">
      </span><span class="ss">hibernate</span><span class="p" data-group-id="8931008724-5">]</span><span class="p" data-group-id="8931008724-4">}</span><span class="p">;</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p>The atom <a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:hibernate/0"><code class="inline">hibernate</code></a> in the action list on the
last line when entering the <code class="inline">{open,_}</code> state is the only change. If any event
arrives in the <code class="inline">{open,_},</code> state, we do not bother to rehibernate, so the server
stays awake after any event.</p><p>To change that we would need to insert action <code class="inline">hibernate</code> in more places. For
example, the state-independent <code class="inline">set_lock_button</code> operation would have to use
<code class="inline">hibernate</code> but only in the <code class="inline">{open,_}</code> state, which would clutter the code.</p><p>Another not uncommon scenario is to use the
<a href="statem.html#event-time-outs">event time-out</a> to trigger hibernation after a
certain time of inactivity. There is also a server start option
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#t:enter_loop_opt/0"><code class="inline">{hibernate_after, Timeout}</code> </a>for
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start/3"><code class="inline">start/3,4</code></a>,
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#start_link/3"><code class="inline">start_link/3,4</code> </a>or
<a href="../../lib/stdlib-5.2.1/doc/html/gen_statem.html#enter_loop/4"><code class="inline">enter_loop/4,5,6</code> </a>that may be used to
automatically hibernate the server.</p><p>This particular server probably does not use heap memory worth hibernating for.
To gain anything from hibernation, your server would have to produce
non-insignificant garbage during callback execution, for which this example
server can serve as a bad example.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="gen_server_concepts.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
gen_server Behaviour
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="events.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page â†’
        </span>
        <span class="title">
gen_event Behaviour
        </span>
      </a>

  </div>
</div>
      <footer class="footer">
        <p>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="Erlang System Documentation.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.31.2) for the

            <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

        </p>
<p>Copyright Â© 1996-2023 <a href="https://www.ericsson.com">Ericsson AB</a></p>
      </footer>
    </div>
  </div>
</main>
</div>


  </body>
</html>
