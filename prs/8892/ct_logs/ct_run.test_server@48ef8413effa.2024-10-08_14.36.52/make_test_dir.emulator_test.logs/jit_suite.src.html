<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/erts/emulator/make_test_dir/emulator_test/jit_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2021-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(jit_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-export</b>([suite/0, groups/0, all/0,
<a name="24"/>   24:          init_per_suite/1, end_per_suite/1,
<a name="25"/>   25:          init_per_group/2, end_per_group/2,
<a name="26"/>   26:          init_per_testcase/2, end_per_testcase/2]).
<a name="27"/>   27: <b>-export</b>([annotate/1, jmsingle/1, named_labels/1, symbols/1]).
<a name="28"/>   28: 
<a name="suite-0"/><a name="29"/>   29: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="30"/>   30:     [{timetrap, {minutes, 4}}].
<a name="31"/>   31: 
<a name="groups-0"/><a name="32"/>   32: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="33"/>   33:     [{perf, [symbols, annotate]}].
<a name="34"/>   34: 
<a name="all-0"/><a name="35"/>   35: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="36"/>   36:     [{group, perf}, jmsingle, named_labels].
<a name="37"/>   37: 
<a name="init_per_suite-1"/><a name="38"/>   38: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="39"/>   39: <b>    case erlang:system_info</b>(emu_flavor) of
<a name="40"/>   40:         jit -&gt;
<a name="41"/>   41:             Config;
<a name="42"/>   42:         _ -&gt;
<a name="43"/>   43:             {skip, &quot;No point in running JIT tests on non-JIT emulator&quot;}
<a name="44"/>   44:     end.
<a name="45"/>   45: 
<a name="end_per_suite-1"/><a name="46"/>   46: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="47"/>   47:     ok.
<a name="48"/>   48: 
<a name="init_per_group-2"/><a name="49"/>   49: <b>init_per_group</b>(perf, Config) -&gt;
<a name="50"/>   50:     case os:find_executable(&quot;perf&quot;) of
<a name="51"/>   51:         false -&gt;
<a name="52"/>   52:             {skip, &quot;perf not found&quot;};
<a name="53"/>   53:         _Perf -&gt;
<a name="54"/>   54:             PerfVsn = os:cmd(&quot;perf version&quot;),
<a name="55"/>   55:             case re:run(PerfVsn, &quot;perf version (\\d+)\\.(\\d+)&quot;,
<a name="56"/>   56:                         [{capture,all_but_first,list}]) of
<a name="57"/>   57:                 {match,[Major0,Minor0]} -&gt;
<a name="58"/>   58:                     Major = list_to_integer(Major0),
<a name="59"/>   59:                     Minor = list_to_integer(Minor0),
<a name="60"/>   60:                     if
<a name="61"/>   61:                         Major &gt; 5; Major =:= 5, Minor &gt;= 11 -&gt;
<a name="62"/>   62:                             BuildIdDir = &quot;--buildid-dir &quot; ++
<a name="63"/>   63:                                 filename:join(
<a name="64"/>   64:                                   proplists:get_value(priv_dir, Config),
<a name="65"/>   65:                                   &quot;.debug&quot;),
<a name="66"/>   66:                             DataFile = filename:join(
<a name="67"/>   67:                                          proplists:get_value(priv_dir, Config),
<a name="68"/>   68:                                          &quot;init_test.data&quot;),
<a name="69"/>   69:                             Cmd = &quot;perf &quot; ++ BuildIdDir ++ &quot; record -q -o &quot; ++ DataFile ++ &quot; ls&quot;,
<a name="70"/>   70:                             os:cmd(Cmd),
<a name="71"/>   71:                             Script = os:cmd(&quot;perf &quot; ++ BuildIdDir ++ &quot; script -i &quot; ++ DataFile),
<a name="72"/>   72:                             ct:log(&quot;~ts&quot;,[Script]),
<a name="73"/>   73:                             case re:run(Script, &quot;^\\W+ls&quot;,[multiline]) of
<a name="74"/>   74:                                 {match, _} -&gt;
<a name="75"/>   75:                                     [{sobefore,get_tmp_so_files()},
<a name="76"/>   76:                                      {buildiddir,BuildIdDir}|Config];
<a name="77"/>   77:                                 nomatch -&gt;
<a name="78"/>   78:                                     {skip, &quot;could not run `&quot;++ Cmd ++&quot;`&quot;}
<a name="79"/>   79:                             end;
<a name="80"/>   80:                         true -&gt;
<a name="81"/>   81:                             {skip,&quot;too old perf version: &quot; ++ PerfVsn}
<a name="82"/>   82:                     end;
<a name="83"/>   83:                 _ -&gt;
<a name="84"/>   84:                     {skip,&quot;unknown old perf version: &quot; ++ PerfVsn}
<a name="85"/>   85:             end
<a name="86"/>   86:     end;
<a name="87"/>   87: <b>init_per_group</b>(_, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="88"/>   88:     Config.
<a name="89"/>   89: 
<a name="end_per_group-2"/><a name="90"/>   90: <b>end_per_group</b>(perf, Config) -&gt;
<a name="91"/>   91:     %% perf inject writes data to /tmp and ~/.debug/tmp so we need to clean
<a name="92"/>   92:     %% that up after the tests are done.
<a name="93"/>   93:     SoToDelete = get_tmp_so_files() -- proplists:get_value(sobefore, Config),
<a name="94"/>   94:     lists:foreach(
<a name="95"/>   95:       fun(File) -&gt;
<a name="96"/>   96:               case file:delete(File) of
<a name="97"/>   97:                   {error,eperm} -&gt;
<a name="98"/>   98:                       ok = file:del_dir_r(File);
<a name="99"/>   99:                   ok -&gt;
<a name="100"/>  100:                       ok
<a name="101"/>  101:               end
<a name="102"/>  102:       end, SoToDelete),
<a name="103"/>  103:     ok;
<a name="104"/>  104: <b>end_per_group</b>(_, _Config) -&gt;
<a name="end_per_group-last_expr"/><a name="105"/>  105:     ok.
<a name="106"/>  106: 
<a name="init_per_testcase-2"/><a name="107"/>  107: <b>init_per_testcase</b>(named_labels, Config) -&gt;
<a name="108"/>  108:     %% Only run named_labels on platforms where we know it works.
<a name="109"/>  109:     case erlang:system_info(system_architecture) of
<a name="110"/>  110: 	&quot;x86&quot; ++ _ -&gt;
<a name="111"/>  111: 	    [{asmbefore,get_tmp_asm_files()}|Config];
<a name="112"/>  112: 	&quot;aarch64&quot; ++ _ -&gt;
<a name="113"/>  113: 	    [{asmbefore,get_tmp_asm_files()}|Config];
<a name="114"/>  114: 	_ -&gt;
<a name="115"/>  115: 	    {skip, &quot;Unsupported architecture&quot;}
<a name="116"/>  116:     end;
<a name="117"/>  117: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="118"/>  118:     Config.
<a name="119"/>  119: 
<a name="end_per_testcase-2"/><a name="120"/>  120: <b>end_per_testcase</b>(named_labels, Config) -&gt;
<a name="121"/>  121:     AsmToDelete = get_tmp_asm_files() -- proplists:get_value(asmbefore, Config),
<a name="122"/>  122:     lists:foreach(
<a name="123"/>  123:       fun(File) -&gt;
<a name="124"/>  124:               ok = file:delete(File)
<a name="125"/>  125:       end, AsmToDelete),
<a name="126"/>  126:     ok;
<a name="127"/>  127: <b>end_per_testcase</b>(_, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="128"/>  128:     ok.
<a name="129"/>  129: 
<a name="get_tmp_so_files-0"/><a name="130"/>  130: <b>get_tmp_so_files</b>() -&gt;
<a name="131"/>  131:     {ok, Home} = init:get_argument(home),
<a name="get_tmp_so_files-last_expr"/><a name="132"/>  132: <b>    filelib:wildcard</b>(&quot;/tmp/jitted-*.so&quot;) ++
<a name="133"/>  133:         filelib:wildcard(filename:join([Home,&quot;.debug&quot;,&quot;tmp&quot;,&quot;jitted-*.so&quot;])).
<a name="134"/>  134: 
<a name="symbols-1"/><a name="135"/>  135: <b>symbols</b>(Config) -&gt;
<a name="136"/>  136:     BuildIdDir = proplists:get_value(buildiddir, Config),
<a name="137"/>  137:     DataFile = filename:join(
<a name="138"/>  138:                  proplists:get_value(priv_dir, Config),
<a name="139"/>  139:                  atom_to_list(?FUNCTION_NAME) ++ &quot;.data&quot;),
<a name="140"/>  140:     os:cmd(&quot;perf &quot;++ BuildIdDir ++&quot; record -q -o &quot; ++ DataFile ++ &quot; &quot; ++
<a name="141"/>  141:            &quot;erl +S 1 +JPperf true -noshell -eval '[lists:seq(1,10000) || _ &lt;- lists:seq(1,1000)].' -s init stop&quot;),
<a name="142"/>  142:     Script = os:cmd(&quot;perf &quot;++ BuildIdDir ++&quot; script -i &quot; ++ DataFile),
<a name="symbols-last_expr"/><a name="143"/>  143: <b>    case re:run</b>(Script,&quot;\\$lists:seq[^/]+/[0-9]&quot;,[global,{capture,first,list}]) of
<a name="144"/>  144:         {match,Matches} -&gt;
<a name="145"/>  145:             ct:log(&quot;Found these symbols: ~p&quot;,[lists:usort(Matches)]),
<a name="146"/>  146:             ok;
<a name="147"/>  147:         nomatch -&gt;
<a name="148"/>  148:             ct:fail(&quot;Did not find lists:seq symbol in:~n~ts&quot;,[Script])
<a name="149"/>  149:     end.
<a name="150"/>  150:     
<a name="annotate-1"/><a name="151"/>  151: <b>annotate</b>(Config) -&gt;
<a name="152"/>  152:     BuildIdDir = proplists:get_value(buildiddir, Config),
<a name="153"/>  153:     DataFile = filename:join(
<a name="154"/>  154:                  proplists:get_value(priv_dir, Config),
<a name="155"/>  155:                  atom_to_list(?FUNCTION_NAME) ++ &quot;.data&quot;),
<a name="156"/>  156:     os:cmd(&quot;perf &quot;++ BuildIdDir ++&quot; record -k mono -q -o &quot; ++ DataFile ++ &quot; &quot; ++
<a name="157"/>  157:            &quot;erl +S 1 +JPperf true -noshell -eval '[lists:seq(1,10000) || _ &lt;- lists:seq(1,1000)].' -s init stop&quot;),
<a name="158"/>  158:     Script = os:cmd(&quot;perf &quot;++ BuildIdDir ++&quot; script -i &quot; ++ DataFile),
<a name="159"/>  159: 
<a name="160"/>  160:     %% When doing &quot;perf inject&quot; the symbol of each function is changed
<a name="161"/>  161:     %% from $lists:seq_loop/3 to lists:seq_loop/3. I don't know why that
<a name="162"/>  162:     %% is, seems like a very odd bug in perf...
<a name="163"/>  163:     {match, Symbols} = re:run(Script, &quot;lists:seq[^/]+/[0-9]+&quot;,
<a name="164"/>  164:                               [global,{capture,first,list}]),
<a name="165"/>  165:     [[Symbol]|_] = lists:usort(Symbols),
<a name="166"/>  166:     JitFile = DataFile ++ &quot;.jit.data&quot;,
<a name="167"/>  167:     &quot;&quot; = os:cmd(&quot;perf &quot;++ BuildIdDir ++&quot; inject --jit -i &quot; ++ DataFile ++ &quot; -o &quot; ++ JitFile),
<a name="168"/>  168:     Anno = os:cmd(&quot;perf &quot;++ BuildIdDir ++&quot; annotate --stdio -i &quot; ++ JitFile ++ &quot; &quot; ++ Symbol ++ &quot;&quot;),
<a name="annotate-last_expr"/><a name="169"/>  169: <b>    case re:run</b>(Anno,&quot;Disassembly of section .text:&quot;) of
<a name="170"/>  170:         {match,_} -&gt;
<a name="171"/>  171:             case re:run(Anno, &quot;lists\\.erl:\\d+&quot;) of
<a name="172"/>  172:                 {match,_} -&gt;
<a name="173"/>  173:                     ok;
<a name="174"/>  174:                 nomatch -&gt;
<a name="175"/>  175:                     ct:fail(&quot;Did not find source line annotation for ~ts.~n~ts&quot;,
<a name="176"/>  176:                             [Symbol, Anno])
<a name="177"/>  177:             end;
<a name="178"/>  178:         nomatch -&gt;
<a name="179"/>  179:             ct:fail(&quot;Did not find disassembly for ~ts.~n~ts&quot;,
<a name="180"/>  180:                     [Symbol, Anno])
<a name="181"/>  181:     end.
<a name="182"/>  182: 
<a name="run_jmsingle_test-3"/><a name="183"/>  183: <b>run_jmsingle_test</b>(Param, ExpectSuccess, ErrorMsg) -&gt;
<a name="184"/>  184:     Cmd = &quot;erl +JMsingle &quot; ++ Param ++ &quot; -noshell &quot; ++
<a name="185"/>  185:         &quot;-eval \&quot;erlang:display(all_is_well),erlang:halt(0).\&quot;&quot;,
<a name="186"/>  186:     Result = os:cmd(Cmd),
<a name="187"/>  187:     SuccessfulEmulatorStart =
<a name="188"/>  188:         case Result of
<a name="189"/>  189:             &quot;all_is_well&quot; ++ _ -&gt;
<a name="190"/>  190:                 true;
<a name="191"/>  191:             _ -&gt;
<a name="192"/>  192:                 Error = &quot;Failed to allocate executable+writable memory&quot;,
<a name="193"/>  193:                 case string:find(Result, Error) of
<a name="194"/>  194:                     nomatch -&gt; false;
<a name="195"/>  195:                     _ -&gt; internal_error
<a name="196"/>  196:                 end
<a name="197"/>  197:         end,
<a name="run_jmsingle_test-last_expr"/><a name="198"/>  198:     case SuccessfulEmulatorStart of
<a name="199"/>  199:         ExpectSuccess -&gt;
<a name="200"/>  200:             ok;
<a name="201"/>  201:         _ -&gt;
<a name="202"/>  202:             ct:fail(ErrorMsg)
<a name="203"/>  203:     end.
<a name="204"/>  204: 
<a name="jmsingle-1"/><a name="205"/>  205: <b>jmsingle</b>(Config) -&gt;
<a name="206"/>  206:     %% Smoke test to check that the emulator starts with the +JMsingle
<a name="207"/>  207:     %% true/false option and fails with a non-boolean, that is, we
<a name="208"/>  208:     %% parse the command line correctly.
<a name="209"/>  209:     case os:type() of
<a name="210"/>  210:         {_, BSD} when BSD =:= netbsd;
<a name="211"/>  211:                       BSD =:= openbsd -&gt;
<a name="212"/>  212:             %% +JMsingle true might not work on these platforms, and dump core
<a name="213"/>  213:             %% because the emulator cannot be started.
<a name="214"/>  214:             %% 
<a name="215"/>  215:             %% Set the cwd to a temporary directory that we'll delete when the
<a name="216"/>  216:             %% test is done.
<a name="217"/>  217:             {ok, Cwd} = file:get_cwd(),
<a name="218"/>  218:             TestDir = filename:join(proplists:get_value(priv_dir, Config),
<a name="219"/>  219:                                     &quot;jmsingle&quot;),
<a name="220"/>  220:             ok = file:make_dir(TestDir),
<a name="221"/>  221:             try
<a name="222"/>  222:                 ok = file:set_cwd(TestDir),
<a name="223"/>  223:                 run_jmsingle_test(&quot;true&quot;, internal_error,
<a name="224"/>  224:                                   &quot;Emulator did not print the correct diagnostic &quot;
<a name="225"/>  225:                                   &quot;(crashed?) with +JMsingle true&quot;)
<a name="226"/>  226:             after
<a name="227"/>  227:                 file:set_cwd(Cwd),
<a name="228"/>  228:                 file:del_dir_r(TestDir)
<a name="229"/>  229:             end;
<a name="230"/>  230:         {_, _} -&gt;
<a name="231"/>  231:             run_jmsingle_test(&quot;true&quot;, true,
<a name="232"/>  232:                               &quot;Emulator did not start with +JMsingle true&quot;)
<a name="233"/>  233:     end,
<a name="234"/>  234:     run_jmsingle_test(&quot;false&quot;, true,
<a name="235"/>  235:                       &quot;Emulator did not start with +JMsingle false&quot;),
<a name="jmsingle-last_expr"/><a name="236"/>  236: <b>    run_jmsingle_test</b>(&quot;broken&quot;, false,
<a name="237"/>  237:                       &quot;Emulator started with bad +JMsingle parameter&quot;).
<a name="238"/>  238: 
<a name="get_tmp_asm_files-0"/><a name="239"/>  239: <b>get_tmp_asm_files</b>() -&gt;
<a name="240"/>  240:     {ok, Cwd} = file:get_cwd(),
<a name="get_tmp_asm_files-last_expr"/><a name="241"/>  241: <b>    filelib:wildcard</b>(filename:join(Cwd, &quot;*.asm&quot;)).
<a name="242"/>  242: 
<a name="named_labels-1"/><a name="243"/>  243: <b>named_labels</b>(_Config) -&gt;
<a name="244"/>  244:     %% Check that pretty printing of named labels is working. We do
<a name="245"/>  245:     %% that by loading this module in an emulator running with +JDdump
<a name="246"/>  246:     %% true and then checking that the produced jit_SUITE.asm contains
<a name="247"/>  247:     %% a label for each exported function. We also check that the
<a name="248"/>  248:     %% label for the non-exported function get_tmp_asm_files/0, which
<a name="249"/>  249:     %% is used by this test, is present.
<a name="250"/>  250:     Exports = proplists:get_value(exports, ?MODULE:module_info()),
<a name="251"/>  251:     ModName = atom_to_list(?MODULE),
<a name="252"/>  252:     ModulePath = filename:dirname(code:which(?MODULE)),
<a name="253"/>  253:     Cmd = &quot;erl +JDdump true -noshell -pa &quot; ++ ModulePath ++ &quot; -eval \&quot;&quot;
<a name="254"/>  254:         ++ ModName ++ &quot;:module_info(),erlang:halt(0).\&quot;&quot;,
<a name="255"/>  255:     os:cmd(Cmd),
<a name="256"/>  256:     {ok, Cwd} = file:get_cwd(),
<a name="257"/>  257:     AsmFile = filename:join(Cwd, ModName ++ &quot;.asm&quot;),
<a name="258"/>  258:     {ok, Data} = file:read_file(AsmFile),
<a name="259"/>  259:     Expected = sets:from_list([ lists:flatten(io_lib:format(&quot;~p/~p&quot;, [N,A]))
<a name="260"/>  260:                                 || {N,A} &lt;- Exports]
<a name="261"/>  261:                               ++ [&quot;get_tmp_asm_files/0&quot;]),
<a name="262"/>  262:     StripSeqNo = fun(Lbl) -&gt;
<a name="263"/>  263:                          %% In the Arm JIT, labels have the form
<a name="264"/>  264:                          %% @Mod:Name/Arity-SequenceNumber, so strip
<a name="265"/>  265:                          %% out the Mod part and the sequence number
<a name="266"/>  266:                          %% as we can't know anything about them.
<a name="267"/>  267:                          case re:run(Lbl, &quot;^.*\:(.*)-[0-9]*$&quot;,
<a name="268"/>  268:                                      [{capture,all_but_first,list}]) of
<a name="269"/>  269:                              {match,[R]} -&gt; R;
<a name="270"/>  270:                              nomatch -&gt; Lbl
<a name="271"/>  271:                          end
<a name="272"/>  272:                  end,
<a name="named_labels-last_expr"/><a name="273"/>  273: <b>    case re:run</b>(Data, &quot;^(.*)\:\n&quot;,
<a name="274"/>  274:                 [global,multiline,{capture,all_but_first,list}]) of
<a name="275"/>  275:         {match,Labels} -&gt;
<a name="276"/>  276:             Found = sets:from_list([ StripSeqNo(NA) || [NA] &lt;- Labels]),
<a name="277"/>  277:             case sets:is_subset(Expected, Found) of
<a name="278"/>  278:                 true -&gt;
<a name="279"/>  279:                     ok;
<a name="280"/>  280:                 false -&gt;
<a name="281"/>  281:                     ct:fail(&quot;Expected ~p, found ~p&quot;,
<a name="282"/>  282:                             [sets:to_list(Expected), sets:to_list(Found)])
<a name="283"/>  283:             end;
<a name="284"/>  284:         _ -&gt;
<a name="285"/>  285:             ct:fail(&quot;No labels found in assembly dump&quot;)
<a name="286"/>  286:     end.
</pre>
</body>
</html>
