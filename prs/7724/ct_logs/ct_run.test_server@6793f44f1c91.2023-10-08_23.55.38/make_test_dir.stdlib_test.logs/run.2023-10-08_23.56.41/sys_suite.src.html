<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/sys_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1996-2018. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(sys_SUITE).
<a name="21"/>   21: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1, 
<a name="22"/>   22: 	 init_per_group/2,end_per_group/2,log/1,log_to_file/1,
<a name="23"/>   23: 	 stats/1,trace/1,suspend/1,install/1,special_process/1]).
<a name="24"/>   24: <b>-export</b>([handle_call/3,terminate/2,init/1]).
<a name="25"/>   25: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="26"/>   26: 
<a name="27"/>   27: <b>-define</b>(server,sys_SUITE_server).
<a name="28"/>   28: 
<a name="29"/>   29: 
<a name="30"/>   30: <i>%% Doesn't look into change_code at all</i>
<a name="31"/>   31: 
<a name="32"/>   32: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="33"/>   33: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="34"/>   34: 
<a name="all-0"/><a name="35"/>   35: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="36"/>   36:     [log, log_to_file, stats, trace, suspend, install, special_process].
<a name="37"/>   37: 
<a name="groups-0"/><a name="38"/>   38: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="39"/>   39:     [].
<a name="40"/>   40: 
<a name="init_per_suite-1"/><a name="41"/>   41: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="42"/>   42:     Config.
<a name="43"/>   43: 
<a name="end_per_suite-1"/><a name="44"/>   44: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="45"/>   45:     ok.
<a name="46"/>   46: 
<a name="init_per_group-2"/><a name="47"/>   47: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="48"/>   48:     Config.
<a name="49"/>   49: 
<a name="end_per_group-2"/><a name="50"/>   50: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="51"/>   51:     Config.
<a name="52"/>   52: 
<a name="53"/>   53: 
<a name="54"/>   54: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="55"/>   55: 
<a name="log-1"/><a name="56"/>   56: <b>log</b>(Config) when is_list(Config) -&gt;
<a name="57"/>   57:     {ok,_Server} = start(),
<a name="58"/>   58:     ok = sys:log(?server,true),
<a name="59"/>   59:     {ok,-44} = public_call(44),
<a name="60"/>   60:     ok = sys:log(?server,false),
<a name="61"/>   61:     ok = sys:log(?server,print),
<a name="62"/>   62:     stop(),
<a name="log-last_expr"/><a name="63"/>   63:     ok.
<a name="64"/>   64: 
<a name="log_to_file-1"/><a name="65"/>   65: <b>log_to_file</b>(Config) when is_list(Config) -&gt;
<a name="66"/>   66:     TempName = test_server:temp_name(proplists:get_value(priv_dir,Config) ++ &quot;sys.&quot;),
<a name="67"/>   67:     {ok,_Server} = start(),
<a name="68"/>   68:     ok = sys:log_to_file(?server,TempName),
<a name="69"/>   69:     {ok,-44} = public_call(44),
<a name="70"/>   70:     ok = sys:log_to_file(?server,false),
<a name="71"/>   71:     {ok,Fd} = file:open(TempName,[read]),
<a name="72"/>   72:     Msg1 = io:get_line(Fd,''),
<a name="73"/>   73:     Msg2 = io:get_line(Fd,''),
<a name="74"/>   74:     file:close(Fd),
<a name="75"/>   75:     &quot;*DBG* sys_SUITE_server got call {req,44} from &quot; ++ _ = Msg1,
<a name="76"/>   76:     &quot;*DBG* sys_SUITE_server sent {ok,-44} to &quot; ++ _ = Msg2,
<a name="77"/>   77:     stop(),
<a name="log_to_file-last_expr"/><a name="78"/>   78:     ok.
<a name="79"/>   79: 
<a name="stats-1"/><a name="80"/>   80: <b>stats</b>(Config) when is_list(Config) -&gt;
<a name="81"/>   81:     Self = self(),
<a name="82"/>   82:     {ok,_Server} = start(),
<a name="83"/>   83:     ok = sys:statistics(?server,true),
<a name="84"/>   84:     {ok,-44} = public_call(44),
<a name="85"/>   85:     {ok,Stats} = sys:statistics(?server,get),
<a name="86"/>   86:     true = lists:member({messages_in,1}, Stats),
<a name="87"/>   87:     true = lists:member({messages_out,1}, Stats),
<a name="88"/>   88:     ok = sys:statistics(?server,false),
<a name="89"/>   89:     {status,_Pid,{module,_Mod},[_PDict,running,Self,_,_]} =
<a name="90"/>   90: 	sys:get_status(?server),
<a name="91"/>   91:     {ok,no_statistics} = sys:statistics(?server,get),
<a name="92"/>   92:     stop(),
<a name="stats-last_expr"/><a name="93"/>   93:     ok.
<a name="94"/>   94: 
<a name="trace-1"/><a name="95"/>   95: <b>trace</b>(Config) when is_list(Config) -&gt;
<a name="96"/>   96:     {ok,_Server} = start(),
<a name="97"/>   97:     ct:sleep(2000),
<a name="98"/>   98:     ct:capture_start(),
<a name="99"/>   99:     sys:trace(?server,true),
<a name="100"/>  100:     {ok,-44} = public_call(44),
<a name="101"/>  101:     %% ho, hum, allow for the io to reach us..
<a name="102"/>  102:     ct:sleep(1000),
<a name="103"/>  103:     ct:capture_stop(),
<a name="104"/>  104:     [Msg1,Msg2] = ct:capture_get(),
<a name="105"/>  105:     &quot;*DBG* sys_SUITE_server got call {req,44} from &quot; ++ _ = Msg1,
<a name="106"/>  106:     &quot;*DBG* sys_SUITE_server sent {ok,-44} to &quot; ++ _ = Msg2,
<a name="107"/>  107:     stop(),
<a name="trace-last_expr"/><a name="108"/>  108:     ok.
<a name="109"/>  109: 
<a name="suspend-1"/><a name="110"/>  110: <b>suspend</b>(Config) when is_list(Config) -&gt;
<a name="111"/>  111:     {ok,_Server} = start(),
<a name="112"/>  112:     sys:suspend(?server,1000),
<a name="113"/>  113:     {'EXIT',_} = (catch public_call(48)),
<a name="114"/>  114:     {status,_,_,[_,suspended,_,_,_]} = sys:get_status(?server),
<a name="115"/>  115:     sys:suspend(?server,1000), %% doing it twice is no error
<a name="116"/>  116:     {'EXIT',_} = (catch public_call(48)),
<a name="117"/>  117:     sys:resume(?server),
<a name="118"/>  118:     {status,_,_,[_,running,_,_,_]} = sys:get_status(?server),
<a name="119"/>  119:     {ok,-48} = (catch public_call(48)),
<a name="120"/>  120:     sys:resume(?server), %% doing it twice is no error
<a name="121"/>  121:     {ok,-48} = (catch public_call(48)),
<a name="122"/>  122:     stop(),
<a name="suspend-last_expr"/><a name="123"/>  123:     ok.
<a name="124"/>  124: 
<a name="install-1"/><a name="125"/>  125: <b>install</b>(Config) when is_list(Config) -&gt;
<a name="126"/>  126:     {ok,_Server} = start(),
<a name="127"/>  127:     Master = self(),
<a name="128"/>  128:     SpyFun =
<a name="129"/>  129: 	fun(func_state,Event,ProcState) -&gt;
<a name="130"/>  130: 		case Event of
<a name="131"/>  131: 		    {in,{'$gen_call',_From,{req,Arg}}} -&gt;
<a name="132"/>  132: 			io:format(&quot;Trigged\n&quot;),
<a name="133"/>  133: 			Master ! {spy_got,{request,Arg},ProcState};
<a name="134"/>  134: 		    Other -&gt;
<a name="135"/>  135: 			io:format(&quot;Trigged other=~p\n&quot;,[Other])
<a name="136"/>  136: 		end,
<a name="137"/>  137:                 func_state
<a name="138"/>  138: 	end,
<a name="139"/>  139:     sys:install(?server,{SpyFun,func_state}),
<a name="140"/>  140:     {ok,-1} = (catch public_call(1)),
<a name="141"/>  141:     sys:no_debug(?server),
<a name="142"/>  142:     {ok,-2} = (catch public_call(2)),
<a name="143"/>  143:     sys:install(?server,{SpyFun,func_state}),
<a name="144"/>  144:     sys:install(?server,{SpyFun,func_state}),
<a name="145"/>  145:     {ok,-3} = (catch public_call(3)),
<a name="146"/>  146:     {ok,-4} = (catch public_call(4)),
<a name="147"/>  147:     sys:remove(?server,SpyFun),
<a name="148"/>  148:     {ok,-5} = (catch public_call(5)),
<a name="149"/>  149:     [{spy_got,{request,1},sys_SUITE_server},
<a name="150"/>  150:      {spy_got,{request,3},sys_SUITE_server},
<a name="151"/>  151:      {spy_got,{request,4},sys_SUITE_server}] = get_messages(),
<a name="152"/>  152: 
<a name="153"/>  153:     sys:install(?server,{id1, SpyFun, func_state}),
<a name="154"/>  154:     sys:install(?server,{id1, SpyFun, func_state}), %% should not be installed
<a name="155"/>  155:     sys:install(?server,{id2, SpyFun, func_state}),    
<a name="156"/>  156:     {ok,-1} = (catch public_call(1)),
<a name="157"/>  157:     %% We have two SpyFun installed:
<a name="158"/>  158:     [{spy_got,{request,1},sys_SUITE_server},
<a name="159"/>  159:      {spy_got,{request,1},sys_SUITE_server}] = get_messages(),
<a name="160"/>  160:     sys:remove(?server, id1),
<a name="161"/>  161:     {ok,-1} = (catch public_call(1)),
<a name="162"/>  162:     %% We have one SpyFun installed:
<a name="163"/>  163:     [{spy_got,{request,1},sys_SUITE_server}] = get_messages(),
<a name="164"/>  164:     sys:no_debug(?server),
<a name="165"/>  165:     {ok,-1} = (catch public_call(1)),
<a name="166"/>  166:     [] = get_messages(),
<a name="167"/>  167:     stop(),
<a name="install-last_expr"/><a name="168"/>  168:     ok.
<a name="169"/>  169: 
<a name="get_messages-0"/><a name="170"/>  170: <b>get_messages</b>() -&gt;
<a name="get_messages-last_expr"/><a name="171"/>  171:     receive
<a name="172"/>  172: 	Msg -&gt; [Msg|get_messages()]
<a name="173"/>  173:     after 1 -&gt; []
<a name="174"/>  174:     end.
<a name="175"/>  175: 
<a name="special_process-1"/><a name="176"/>  176: <b>special_process</b>(Config) when is_list(Config) -&gt;
<a name="177"/>  177:     ok = spec_proc(sys_sp1),
<a name="special_process-last_expr"/><a name="178"/>  178: <b>    ok = spec_proc</b>(sys_sp2).
<a name="179"/>  179: 
<a name="spec_proc-1"/><a name="180"/>  180: <b>spec_proc</b>(Mod) -&gt;
<a name="181"/>  181:     {ok,_} = Mod:start_link(100),
<a name="182"/>  182:     ok = sys:statistics(Mod,true),
<a name="183"/>  183:     ok = sys:trace(Mod,true),
<a name="184"/>  184:     1 = Ch = Mod:alloc(),
<a name="185"/>  185:     Free = lists:seq(2,100),
<a name="186"/>  186:     Replace = case sys:get_state(Mod) of
<a name="187"/>  187: 		  {[Ch],Free} -&gt;
<a name="188"/>  188: 		      fun({A,F}) -&gt;
<a name="189"/>  189: 			      Free = F,
<a name="190"/>  190: 			      {A,[2,3,4]}
<a name="191"/>  191: 		      end;
<a name="192"/>  192: 		  {state,[Ch],Free} -&gt;
<a name="193"/>  193: 		      fun({state,A,F}) -&gt;
<a name="194"/>  194: 			      Free = F,
<a name="195"/>  195: 			      {state,A,[2,3,4]}
<a name="196"/>  196: 		      end
<a name="197"/>  197: 	      end,
<a name="198"/>  198:     case sys:replace_state(Mod, Replace) of
<a name="199"/>  199: 	{[Ch],[2,3,4]} -&gt; ok;
<a name="200"/>  200: 	{state,[Ch],[2,3,4]} -&gt; ok
<a name="201"/>  201:     end,
<a name="202"/>  202:     ok = Mod:free(Ch),
<a name="203"/>  203:     case sys:get_state(Mod) of
<a name="204"/>  204: 	{[],[1,2,3,4]} -&gt; ok;
<a name="205"/>  205: 	{state,[],[1,2,3,4]} -&gt; ok
<a name="206"/>  206:     end,
<a name="207"/>  207:     {ok,[{start_time,_},
<a name="208"/>  208: 	 {current_time,_},
<a name="209"/>  209: 	 {reductions,_},
<a name="210"/>  210: 	 {messages_in,2},
<a name="211"/>  211: 	 {messages_out,1}]} = sys:statistics(Mod,get),
<a name="212"/>  212:     ok = sys:statistics(Mod,false),
<a name="213"/>  213:     [] = sys:replace_state(Mod, fun(_) -&gt; [] end),
<a name="214"/>  214:     process_flag(trap_exit,true),
<a name="215"/>  215:     ok = case catch sys:get_state(Mod) of
<a name="216"/>  216: 	     [] -&gt;
<a name="217"/>  217: 		 ok;
<a name="218"/>  218: 	     {'EXIT',{{callback_failed,
<a name="219"/>  219: 		       {Mod,system_get_state},{throw,fail}},_}} -&gt;
<a name="220"/>  220: 		 ok
<a name="221"/>  221: 	 end,
<a name="222"/>  222:     ok = sync_terminate(Mod),
<a name="223"/>  223:     {ok,_} = Mod:start_link(4),
<a name="224"/>  224:     ok = case catch sys:replace_state(Mod, fun(_) -&gt; {} end) of
<a name="225"/>  225: 	     {} -&gt;
<a name="226"/>  226: 		 ok;
<a name="227"/>  227: 	     {'EXIT',{{callback_failed,
<a name="228"/>  228: 		       {Mod,system_replace_state},{throw,fail}},_}} -&gt;
<a name="229"/>  229: 		 ok
<a name="230"/>  230: 	 end,
<a name="231"/>  231:     ok = sync_terminate(Mod),
<a name="232"/>  232:     {ok,_} = Mod:start_link(4),
<a name="233"/>  233:     StateFun = fun(_) -&gt; error(fail) end,
<a name="234"/>  234:     ok = case catch sys:replace_state(Mod, StateFun) of
<a name="235"/>  235: 	     {} -&gt;
<a name="236"/>  236: 		 ok;
<a name="237"/>  237: 	     {'EXIT',{{callback_failed,
<a name="238"/>  238: 		       {Mod,system_replace_state},{error,fail}},_}} -&gt;
<a name="239"/>  239: 		 ok;
<a name="240"/>  240: 	     {'EXIT',{{callback_failed,StateFun,{error,fail}},_}} -&gt;
<a name="241"/>  241: 		 ok
<a name="242"/>  242: 	 end,
<a name="spec_proc-last_expr"/><a name="243"/>  243: <b>    ok = sync_terminate</b>(Mod).
<a name="244"/>  244: 
<a name="sync_terminate-1"/><a name="245"/>  245: <b>sync_terminate</b>(Mod) -&gt;
<a name="246"/>  246:     P = whereis(Mod),
<a name="247"/>  247:     MRef = erlang:monitor(process,P),
<a name="248"/>  248:     ok = sys:terminate(Mod, normal),
<a name="249"/>  249:     receive
<a name="250"/>  250:         {'DOWN',MRef,_,_,normal} -&gt;
<a name="251"/>  251:             ok
<a name="252"/>  252:     end,
<a name="253"/>  253:     undefined = whereis(Mod),
<a name="sync_terminate-last_expr"/><a name="254"/>  254:     ok.
<a name="255"/>  255: 
<a name="256"/>  256: <i>%%%%%%%%%%%%%%%%%%%%</i>
<a name="257"/>  257: <i>%% Dummy server</i>
<a name="258"/>  258: 
<a name="public_call-1"/><a name="259"/>  259: <b>public_call</b>(Arg) -&gt;
<a name="public_call-last_expr"/><a name="260"/>  260: <b>    gen_server:call</b>(?server,{req,Arg},1000).
<a name="261"/>  261: 
<a name="start-0"/><a name="262"/>  262: <b>start</b>() -&gt;
<a name="start-last_expr"/><a name="263"/>  263: <b>    gen_server:start_link</b>({local,?server},?MODULE,[],[]).
<a name="264"/>  264: 
<a name="stop-0"/><a name="265"/>  265: <b>stop</b>() -&gt;
<a name="stop-last_expr"/><a name="266"/>  266: <b>    gen_server:call</b>(?server,stop,1000).
<a name="267"/>  267: 
<a name="init-1"/><a name="268"/>  268: <b>init</b>([]) -&gt;
<a name="init-last_expr"/><a name="269"/>  269:     {ok,0}.
<a name="270"/>  270: 
<a name="handle_call-3"/><a name="271"/>  271: <b>handle_call</b>({req,Arg},_From,State) -&gt;
<a name="272"/>  272:     NewState = State+1,
<a name="273"/>  273:     {reply,{ok,-Arg},NewState};
<a name="274"/>  274: <b>handle_call</b>(stop,_From,State) -&gt;
<a name="handle_call-last_expr"/><a name="275"/>  275:     {stop,normal,ok,State}.
<a name="276"/>  276: 
<a name="terminate-2"/><a name="277"/>  277: <b>terminate</b>(_Reason, _State) -&gt;
<a name="terminate-last_expr"/><a name="278"/>  278:     ok.
<a name="279"/>  279: 
<a name="280"/>  280: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    </i>
</pre>
</body>
</html>
