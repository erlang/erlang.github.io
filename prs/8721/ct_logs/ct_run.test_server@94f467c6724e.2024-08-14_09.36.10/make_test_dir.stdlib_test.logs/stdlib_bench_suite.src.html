<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/stdlib_bench_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2012-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <b>-module</b>(stdlib_bench_SUITE).
<a name="23"/>   23: <b>-compile</b>([export_all, nowarn_export_all]).
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="25"/>   25: <b>-include_lib</b>(&quot;common_test/include/ct_event.hrl&quot;).
<a name="26"/>   26: 
<a name="27"/>   27: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="suite-0"/><a name="suite-last_expr"/><a name="28"/>   28: <b>suite</b>() -&gt; [{ct_hooks,[{ts_install_cth,[{nodenames,2}]}]}].
<a name="29"/>   29: 
<a name="30"/>   30: 
<a name="all-0"/><a name="31"/>   31: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="32"/>   32:     [{group,unicode},{group,base64},{group,binary},{group, io},
<a name="33"/>   33:      {group,gen_server},{group,gen_statem},
<a name="34"/>   34:      {group,gen_server_comparison},{group,gen_statem_comparison}].
<a name="35"/>   35: 
<a name="groups-0"/><a name="36"/>   36: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="37"/>   37:     [{unicode,[{repeat,5}],
<a name="38"/>   38:       [norm_nfc_list, norm_nfc_deep_l, norm_nfc_binary,
<a name="39"/>   39:        string_lexemes_list, string_lexemes_binary
<a name="40"/>   40:       ]},
<a name="41"/>   41:      %% Only run 1 binary match repeat as it is very slow pre OTP-22.
<a name="42"/>   42:      %% The results seem to be stable enough anyway
<a name="43"/>   43:      {binary, [{repeat, 1}],
<a name="44"/>   44:       [match_single_pattern_no_match,
<a name="45"/>   45:        matches_single_pattern_no_match,
<a name="46"/>   46:        matches_single_pattern_eventual_match,
<a name="47"/>   47:        matches_single_pattern_frequent_match]},
<a name="48"/>   48:      {base64,[{repeat,5}],
<a name="49"/>   49:       [decode_binary, decode_binary_to_string,
<a name="50"/>   50:        decode_list, decode_list_to_string,
<a name="51"/>   51:        encode_binary, encode_binary_to_string,
<a name="52"/>   52:        encode_list, encode_list_to_string,
<a name="53"/>   53:        mime_binary_decode, mime_binary_decode_to_string,
<a name="54"/>   54:        mime_list_decode, mime_list_decode_to_string]},
<a name="55"/>   55:      {io, [{repeat, 5}], [double_random_to_list, double_random_to_list_array]},
<a name="56"/>   56:      {gen_server, [{repeat,5}], cases(gen_server)},
<a name="57"/>   57:      {gen_statem, [{repeat,3}], cases(gen_statem)},
<a name="58"/>   58:      {gen_server_comparison, [],
<a name="59"/>   59:       [single_small, single_medium, single_big,
<a name="60"/>   60:        sched_small, sched_medium, sched_big,
<a name="61"/>   61:        multi_small, multi_medium, multi_big]},
<a name="62"/>   62:      {gen_statem_comparison, [],
<a name="63"/>   63:       [single_small, single_big,
<a name="64"/>   64:        sched_small, sched_big,
<a name="65"/>   65:        multi_small, multi_big]}].
<a name="66"/>   66: 
<a name="cases-1"/><a name="67"/>   67: <b>cases</b>(gen_server) -&gt;
<a name="68"/>   68:       [simple, simple_timer, simple_mon, simple_timer_mon,
<a name="69"/>   69:        generic, generic_timer];
<a name="70"/>   70: <b>cases</b>(gen_statem) -&gt;
<a name="cases-last_expr"/><a name="71"/>   71:     [generic, generic_log, generic_log100, generic_fsm, generic_fsm_transit,
<a name="72"/>   72:      generic_statem, generic_statem_log, generic_statem_log100,
<a name="73"/>   73:      generic_statem_transit, generic_statem_complex].
<a name="74"/>   74: 
<a name="init_per_group-2"/><a name="75"/>   75: <b>init_per_group</b>(gen_server, Config) -&gt;
<a name="76"/>   76:     compile_servers(Config),
<a name="77"/>   77:     [{benchmark_suite,&quot;stdlib_gen_server&quot;}|Config];
<a name="78"/>   78: <b>init_per_group</b>(gen_statem, Config) -&gt;
<a name="79"/>   79:     compile_servers(Config),
<a name="80"/>   80:     [{benchmark_suite,&quot;stdlib_gen_statem&quot;}|Config];
<a name="81"/>   81: <b>init_per_group</b>(gen_server_comparison, Config) -&gt;
<a name="82"/>   82:     compile_servers(Config),
<a name="83"/>   83:     [{cases,cases(gen_server)},
<a name="84"/>   84:      {benchmark_suite,&quot;stdlib_gen_server&quot;}|Config];
<a name="85"/>   85: <b>init_per_group</b>(gen_statem_comparison, Config) -&gt;
<a name="86"/>   86:     compile_servers(Config),
<a name="87"/>   87:     [{cases,cases(gen_statem)},
<a name="88"/>   88:      {benchmark_suite,&quot;stdlib_gen_statem&quot;}|Config];
<a name="89"/>   89: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="90"/>   90:     Config.
<a name="91"/>   91: 
<a name="end_per_group-2"/><a name="92"/>   92: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="93"/>   93:     Config.
<a name="94"/>   94: 
<a name="init_per_suite-1"/><a name="95"/>   95: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="96"/>   96:     Config.
<a name="97"/>   97: 
<a name="end_per_suite-1"/><a name="98"/>   98: <b>end_per_suite</b>(Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="99"/>   99:     Config.
<a name="100"/>  100: 
<a name="init_per_testcase-2"/><a name="101"/>  101: <b>init_per_testcase</b>(_Func, Conf) -&gt;
<a name="init_per_testcase-last_expr"/><a name="102"/>  102:     Conf.
<a name="103"/>  103: 
<a name="end_per_testcase-2"/><a name="104"/>  104: <b>end_per_testcase</b>(_Func, _Conf) -&gt;
<a name="end_per_testcase-last_expr"/><a name="105"/>  105:     ok.
<a name="106"/>  106: 
<a name="107"/>  107: 
<a name="compile_servers-1"/><a name="108"/>  108: <b>compile_servers</b>(Config) -&gt;
<a name="109"/>  109:     DataDir = ?config(data_dir, Config),
<a name="110"/>  110:     Files = filelib:wildcard(filename:join(DataDir, &quot;{simple,generic}*.erl&quot;)),
<a name="111"/>  111:     _ = [{ok, _} = compile:file(File) || File &lt;- Files],
<a name="compile_servers-last_expr"/><a name="112"/>  112:     ok.
<a name="113"/>  113: 
<a name="comment-1"/><a name="114"/>  114: <b>comment</b>(Value) -&gt;
<a name="115"/>  115:     C = lists:flatten(io_lib:format(&quot;~p&quot;, [Value])),
<a name="comment-last_expr"/><a name="116"/>  116:     {comment, C}.
<a name="117"/>  117: 
<a name="118"/>  118: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="119"/>  119: <b>-define</b>(REPEAT_NORM, 5).
<a name="120"/>  120: 
<a name="norm_nfc_list-1"/><a name="121"/>  121: <b>norm_nfc_list</b>(Config) -&gt;
<a name="122"/>  122:     Bin = norm_data(Config),
<a name="123"/>  123:     {_N, Mean, _Stddev, Res} = unicode_util_SUITE:time_count(nfc, list, Bin, ?REPEAT_NORM),
<a name="norm_nfc_list-last_expr"/><a name="124"/>  124: <b>    comment</b>(report(1000.0*Res / Mean)).
<a name="125"/>  125: 
<a name="norm_nfc_deep_l-1"/><a name="126"/>  126: <b>norm_nfc_deep_l</b>(Config) -&gt;
<a name="127"/>  127:     Bin = norm_data(Config),
<a name="128"/>  128:     {_N, Mean, _Stddev, Res} = unicode_util_SUITE:time_count(nfc, deep_l, Bin, ?REPEAT_NORM),
<a name="norm_nfc_deep_l-last_expr"/><a name="129"/>  129: <b>    comment</b>(report(1000.0*Res / Mean)).
<a name="130"/>  130: 
<a name="norm_nfc_binary-1"/><a name="131"/>  131: <b>norm_nfc_binary</b>(Config) -&gt;
<a name="132"/>  132:     Bin = norm_data(Config),
<a name="133"/>  133:     {_N, Mean, _Stddev, Res} = unicode_util_SUITE:time_count(nfc, binary, Bin, ?REPEAT_NORM),
<a name="norm_nfc_binary-last_expr"/><a name="134"/>  134: <b>    comment</b>(report(1000.0*Res / Mean)).
<a name="135"/>  135: 
<a name="136"/>  136: 
<a name="string_lexemes_list-1"/><a name="137"/>  137: <b>string_lexemes_list</b>(Config) -&gt;
<a name="138"/>  138:     %% Use nth_lexeme instead of lexemes to avoid building a result of
<a name="139"/>  139:     %% large lists which causes large differences between test runs, gc?
<a name="140"/>  140:     Bin = norm_data(Config),
<a name="141"/>  141:     Fun = fun(Str) -&gt; string:nth_lexeme(Str, 200000, [$;,$\n,$\r]), 200000 end,
<a name="142"/>  142:     {_N, Mean, _Stddev, Res} = string_SUITE:time_func(Fun, list, Bin, 15),
<a name="string_lexemes_list-last_expr"/><a name="143"/>  143: <b>    comment</b>(report(1000.0*Res / Mean)).
<a name="144"/>  144: 
<a name="string_lexemes_binary-1"/><a name="145"/>  145: <b>string_lexemes_binary</b>(Config) -&gt;
<a name="146"/>  146:     %% Use nth_lexeme instead of lexemes to avoid building a result of
<a name="147"/>  147:     %% large lists which causes large differences between test runs, gc?
<a name="148"/>  148:     Bin = norm_data(Config),
<a name="149"/>  149:     Fun = fun(Str) -&gt; string:nth_lexeme(Str, 200000, [$;,$\n,$\r]), 200000 end,
<a name="150"/>  150:     {_N, Mean, _Stddev, Res} = string_SUITE:time_func(Fun, binary, Bin, ?REPEAT_NORM),
<a name="string_lexemes_binary-last_expr"/><a name="151"/>  151: <b>    comment</b>(report(1000.0*Res / Mean)).
<a name="152"/>  152: 
<a name="153"/>  153: <i>%%%</i>
<a name="report-1"/><a name="154"/>  154: <b>report</b>(Tps) -&gt;
<a name="155"/>  155:     ct_event:notify(#event{name = benchmark_data,
<a name="156"/>  156:                            data = [{suite,&quot;stdlib_unicode&quot;},{value,round(Tps)}]}),
<a name="report-last_expr"/><a name="157"/>  157:     Tps.
<a name="158"/>  158: 
<a name="norm_data-1"/><a name="159"/>  159: <b>norm_data</b>(Config) -&gt;
<a name="160"/>  160:     DataDir0 = proplists:get_value(data_dir, Config),
<a name="161"/>  161:     DataDir = filename:join(lists:droplast(filename:split(DataDir0))),
<a name="162"/>  162:     File = filename:join([DataDir,&quot;unicode_util_SUITE_data&quot;,&quot;NormalizationTest.txt&quot;]),
<a name="163"/>  163:     {ok, Bin} = file:read_file(File),
<a name="norm_data-last_expr"/><a name="164"/>  164:     Bin.
<a name="165"/>  165: 
<a name="166"/>  166: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="167"/>  167: 
<a name="match_single_pattern_no_match-1"/><a name="168"/>  168: <b>match_single_pattern_no_match</b>(_Config) -&gt;
<a name="169"/>  169:     Binary = binary:copy(&lt;&lt;&quot;ugbcfuysabfuqyfikgfsdalpaskfhgjsdgfjwsalp&quot;&gt;&gt;, 1000000),
<a name="match_single_pattern_no_match-last_expr"/><a name="170"/>  170: <b>    comment</b>(test(100, binary, match, [Binary, &lt;&lt;&quot;o&quot;&gt;&gt;])).
<a name="171"/>  171: 
<a name="matches_single_pattern_no_match-1"/><a name="172"/>  172: <b>matches_single_pattern_no_match</b>(_Config) -&gt;
<a name="173"/>  173:     Binary = binary:copy(&lt;&lt;&quot;ugbcfuysabfuqyfikgfsdalpaskfhgjsdgfjwsalp&quot;&gt;&gt;, 1000000),
<a name="matches_single_pattern_no_match-last_expr"/><a name="174"/>  174: <b>    comment</b>(test(100, binary, matches, [Binary, &lt;&lt;&quot;o&quot;&gt;&gt;])).
<a name="175"/>  175: 
<a name="matches_single_pattern_eventual_match-1"/><a name="176"/>  176: <b>matches_single_pattern_eventual_match</b>(_Config) -&gt;
<a name="177"/>  177:     Binary = binary:copy(&lt;&lt;&quot;ugbcfuysabfuqyfikgfsdalpaskfhgjsdgfjwsal\n&quot;&gt;&gt;, 1000000),
<a name="matches_single_pattern_eventual_match-last_expr"/><a name="178"/>  178: <b>    comment</b>(test(100, binary, matches, [Binary, &lt;&lt;&quot;\n&quot;&gt;&gt;])).
<a name="179"/>  179: 
<a name="matches_single_pattern_frequent_match-1"/><a name="180"/>  180: <b>matches_single_pattern_frequent_match</b>(_Config) -&gt;
<a name="181"/>  181:     Binary = binary:copy(&lt;&lt;&quot;abc\n&quot;&gt;&gt;, 1000000),
<a name="matches_single_pattern_frequent_match-last_expr"/><a name="182"/>  182: <b>    comment</b>(test(100, binary, matches, [Binary, &lt;&lt;&quot;abc&quot;&gt;&gt;])).
<a name="183"/>  183: 
<a name="184"/>  184: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="185"/>  185: 
<a name="decode_binary-1"/><a name="186"/>  186: <b>decode_binary</b>(_Config) -&gt;
<a name="decode_binary-last_expr"/><a name="187"/>  187: <b>    comment</b>(test(base64, decode, [encoded_binary()])).
<a name="188"/>  188: 
<a name="decode_binary_to_string-1"/><a name="189"/>  189: <b>decode_binary_to_string</b>(_Config) -&gt;
<a name="decode_binary_to_string-last_expr"/><a name="190"/>  190: <b>    comment</b>(test(base64, decode_to_string, [encoded_binary()])).
<a name="191"/>  191: 
<a name="decode_list-1"/><a name="192"/>  192: <b>decode_list</b>(_Config) -&gt;
<a name="decode_list-last_expr"/><a name="193"/>  193: <b>    comment</b>(test(base64, decode, [encoded_list()])).
<a name="194"/>  194: 
<a name="decode_list_to_string-1"/><a name="195"/>  195: <b>decode_list_to_string</b>(_Config) -&gt;
<a name="decode_list_to_string-last_expr"/><a name="196"/>  196: <b>    comment</b>(test(base64, decode_to_string, [encoded_list()])).
<a name="197"/>  197: 
<a name="encode_binary-1"/><a name="198"/>  198: <b>encode_binary</b>(_Config) -&gt;
<a name="encode_binary-last_expr"/><a name="199"/>  199: <b>    comment</b>(test(base64, encode, [binary()])).
<a name="200"/>  200: 
<a name="encode_binary_to_string-1"/><a name="201"/>  201: <b>encode_binary_to_string</b>(_Config) -&gt;
<a name="encode_binary_to_string-last_expr"/><a name="202"/>  202: <b>    comment</b>(test(base64, encode_to_string, [binary()])).
<a name="203"/>  203: 
<a name="encode_list-1"/><a name="204"/>  204: <b>encode_list</b>(_Config) -&gt;
<a name="encode_list-last_expr"/><a name="205"/>  205: <b>    comment</b>(test(base64, encode, [list()])).
<a name="206"/>  206: 
<a name="encode_list_to_string-1"/><a name="207"/>  207: <b>encode_list_to_string</b>(_Config) -&gt;
<a name="encode_list_to_string-last_expr"/><a name="208"/>  208: <b>    comment</b>(test(base64, encode_to_string, [list()])).
<a name="209"/>  209: 
<a name="mime_binary_decode-1"/><a name="210"/>  210: <b>mime_binary_decode</b>(_Config) -&gt;
<a name="mime_binary_decode-last_expr"/><a name="211"/>  211: <b>    comment</b>(test(base64, mime_decode, [encoded_binary()])).
<a name="212"/>  212: 
<a name="mime_binary_decode_to_string-1"/><a name="213"/>  213: <b>mime_binary_decode_to_string</b>(_Config) -&gt;
<a name="mime_binary_decode_to_string-last_expr"/><a name="214"/>  214: <b>    comment</b>(test(base64, mime_decode_to_string, [encoded_binary()])).
<a name="215"/>  215: 
<a name="mime_list_decode-1"/><a name="216"/>  216: <b>mime_list_decode</b>(_Config) -&gt;
<a name="mime_list_decode-last_expr"/><a name="217"/>  217: <b>    comment</b>(test(base64, mime_decode, [encoded_list()])).
<a name="218"/>  218: 
<a name="mime_list_decode_to_string-1"/><a name="219"/>  219: <b>mime_list_decode_to_string</b>(_Config) -&gt;
<a name="mime_list_decode_to_string-last_expr"/><a name="220"/>  220: <b>    comment</b>(test(base64, mime_decode_to_string, [encoded_list()])).
<a name="221"/>  221: 
<a name="222"/>  222: <b>-define</b>(SIZE, 10000).
<a name="223"/>  223: <b>-define</b>(N, 1000).
<a name="224"/>  224: 
<a name="encoded_binary-0"/><a name="225"/>  225: <b>encoded_binary</b>() -&gt;
<a name="encoded_binary-last_expr"/><a name="226"/>  226: <b>    list_to_binary</b>(encoded_list()).
<a name="227"/>  227: 
<a name="encoded_list-0"/><a name="228"/>  228: <b>encoded_list</b>() -&gt;
<a name="229"/>  229:     L = random_byte_list(round(?SIZE*0.75)),
<a name="encoded_list-last_expr"/><a name="230"/>  230: <b>    base64:encode_to_string</b>(L).
<a name="231"/>  231: 
<a name="binary-0"/><a name="232"/>  232: <b>binary</b>() -&gt;
<a name="binary-last_expr"/><a name="233"/>  233: <b>    list_to_binary</b>(list()).
<a name="234"/>  234: 
<a name="list-0"/><a name="235"/>  235: <b>list</b>() -&gt;
<a name="list-last_expr"/><a name="236"/>  236: <b>    random_byte_list</b>(?SIZE).
<a name="237"/>  237: 
<a name="test-3"/><a name="238"/>  238: <b>test</b>(Mod, Fun, Args) -&gt;
<a name="test-last_expr"/><a name="239"/>  239: <b>    test</b>(?N, Mod, Fun, Args).
<a name="test-4"/><a name="240"/>  240: <b>test</b>(Iter, Mod, Fun, Args) -&gt;
<a name="241"/>  241:     F = fun() -&gt; loop(Iter, Mod, Fun, Args) end,
<a name="242"/>  242:     {Time, ok} = timer:tc(fun() -&gt; lspawn(F) end),
<a name="test-last_expr"/><a name="243"/>  243: <b>    report_mfa</b>(Iter, Time, Mod).
<a name="244"/>  244: 
<a name="loop-4"/><a name="245"/>  245: <b>loop</b>(0, _M, _F, _A) -&gt; garbage_collect(), ok;
<a name="246"/>  246: <b>loop</b>(N, M, F, A) -&gt;
<a name="247"/>  247:     _ = apply(M, F, A),
<a name="loop-last_expr"/><a name="248"/>  248: <b>    loop</b>(N - 1, M, F, A).
<a name="249"/>  249: 
<a name="lspawn-1"/><a name="250"/>  250: <b>lspawn</b>(Fun) -&gt;
<a name="251"/>  251:     {Pid, Ref} = spawn_monitor(fun() -&gt; exit(Fun()) end),
<a name="lspawn-last_expr"/><a name="252"/>  252:     receive
<a name="253"/>  253:         {'DOWN', Ref, process, Pid, Rep} -&gt; Rep
<a name="254"/>  254:     end.
<a name="255"/>  255: 
<a name="report_mfa-3"/><a name="256"/>  256: <b>report_mfa</b>(Iter, Time, Mod) -&gt;
<a name="257"/>  257:     Tps = round((Iter*1000000)/Time),
<a name="258"/>  258:     ct_event:notify(#event{name = benchmark_data,
<a name="259"/>  259:                            data = [{suite, &quot;stdlib_&quot; ++ atom_to_list(Mod)},
<a name="260"/>  260:                                    {value, Tps}]}),
<a name="report_mfa-last_expr"/><a name="261"/>  261:     Tps.
<a name="262"/>  262: 
<a name="263"/>  263: <i>%% Copied from base64_SUITE.erl.</i>
<a name="264"/>  264: 
<a name="random_byte_list-1"/><a name="265"/>  265: <b>random_byte_list</b>(N) -&gt;
<a name="random_byte_list-last_expr"/><a name="266"/>  266: <b>    random_byte_list</b>(N, []).
<a name="267"/>  267: 
<a name="random_byte_list-2"/><a name="268"/>  268: <b>random_byte_list</b>(0, Acc) -&gt;
<a name="269"/>  269:     Acc;
<a name="270"/>  270: <b>random_byte_list</b>(N, Acc) -&gt;
<a name="random_byte_list-last_expr"/><a name="271"/>  271: <b>    random_byte_list</b>(N-1, [rand:uniform(255)|Acc]).
<a name="272"/>  272: 
<a name="make_big_binary-1"/><a name="273"/>  273: <b>make_big_binary</b>(N) -&gt;
<a name="make_big_binary-last_expr"/><a name="274"/>  274: <b>    list_to_binary</b>(mbb(N, [])).
<a name="275"/>  275: 
<a name="mbb-2"/><a name="276"/>  276: <b>mbb</b>(N, Acc) when N &gt; 256 -&gt;
<a name="277"/>  277:     B = list_to_binary(lists:seq(0, 255)),
<a name="278"/>  278:     mbb(N - 256, [B | Acc]);
<a name="279"/>  279: <b>mbb</b>(N, Acc) -&gt;
<a name="280"/>  280:     B = list_to_binary(lists:seq(0, N-1)),
<a name="mbb-last_expr"/><a name="281"/>  281: <b>    lists:reverse</b>(Acc, B).
<a name="282"/>  282: 
<a name="283"/>  283: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="284"/>  284: 
<a name="285"/>  285: <b>-define</b>(MAX_DOUBLE, (1 bsl 62) - 1).
<a name="286"/>  286: <b>-define</b>(DOUBLE_SAMPLE, 100000).
<a name="287"/>  287: <b>-define</b>(SMALL_DIGITS, 6).
<a name="288"/>  288: 
<a name="double_random_to_list-1"/><a name="289"/>  289: <b>double_random_to_list</b>(_Config) -&gt;
<a name="double_random_to_list-last_expr"/><a name="290"/>  290: <b>    comment</b>(test_double(0)).
<a name="291"/>  291: 
<a name="double_random_to_list_array-1"/><a name="292"/>  292: <b>double_random_to_list_array</b>(_Config) -&gt;
<a name="double_random_to_list_array-last_expr"/><a name="293"/>  293: <b>    comment</b>(test_double_array(0)).
<a name="294"/>  294: 
<a name="double_small_digit_to_list-1"/><a name="295"/>  295: <b>double_small_digit_to_list</b>(_Config) -&gt;
<a name="double_small_digit_to_list-last_expr"/><a name="296"/>  296: <b>    comment</b>(test_double(?SMALL_DIGITS)).
<a name="297"/>  297: 
<a name="double-1"/><a name="298"/>  298: <b>double</b>(0) -&gt;
<a name="299"/>  299:     Int = rand:uniform(?MAX_DOUBLE),
<a name="300"/>  300:     &lt;&lt;F:64/float&gt;&gt; = &lt;&lt;Int:64/unsigned-integer&gt;&gt;,
<a name="301"/>  301:     F;
<a name="302"/>  302: <i>% Example:</i>
<a name="303"/>  303: <i>% SmallDigits is 3</i>
<a name="304"/>  304: <i>% Lower is 100</i>
<a name="305"/>  305: <i>% Upper is 1000</i>
<a name="306"/>  306: <i>% R % (1000 - 100) + 100;</i>
<a name="307"/>  307: <i>% R % 900 + 100;</i>
<a name="308"/>  308: <i>% R1 is [0, 899] + 100</i>
<a name="309"/>  309: <i>% R1 is [100, 999]</i>
<a name="310"/>  310: <i>% R1 / 100 is [1.00, 9.99]</i>
<a name="311"/>  311: <b>double</b>(SmallDigits) -&gt;
<a name="312"/>  312:     F = double(0),
<a name="313"/>  313:     Lower = exp10(SmallDigits),
<a name="314"/>  314:     Upper = Lower * 10,
<a name="315"/>  315:     F1 = (F rem (Upper - Lower)) + Lower,
<a name="double-last_expr"/><a name="316"/>  316: <b>    F1 / float</b>(Lower).
<a name="317"/>  317: 
<a name="exp10-1"/><a name="318"/>  318: <b>exp10</b>(X) -&gt;
<a name="exp10-last_expr"/><a name="319"/>  319: <b>    exp10</b>(1, X).
<a name="exp10-2"/><a name="320"/>  320: <b>exp10</b>(Acc, 0) -&gt;
<a name="321"/>  321:     Acc;
<a name="322"/>  322: <b>exp10</b>(Acc, X) -&gt;
<a name="exp10-last_expr"/><a name="323"/>  323: <b>    exp10</b>(Acc, X - 1).
<a name="324"/>  324: 
<a name="test_double-1"/><a name="325"/>  325: <b>test_double</b>(Samples) when is_list(Samples) -&gt;
<a name="326"/>  326:     F = fun() -&gt; loop_double(Samples) end,
<a name="327"/>  327:     {Time, ok} = timer:tc(fun() -&gt; lspawn(F) end),
<a name="328"/>  328:     report_mfa(?DOUBLE_SAMPLE, Time, io_lib_format);
<a name="329"/>  329: <b>test_double</b>(SmallDigits) when is_integer(SmallDigits) -&gt;
<a name="330"/>  330:     rand:seed(exsplus, {1201,855653,380975}),
<a name="331"/>  331:     Samples = [double(SmallDigits) || _ &lt;- lists:seq(1, ?DOUBLE_SAMPLE)],
<a name="test_double-last_expr"/><a name="332"/>  332: <b>    test_double</b>(Samples).
<a name="333"/>  333: 
<a name="loop_double-1"/><a name="334"/>  334: <b>loop_double</b>([]) -&gt; garbage_collect(), ok;
<a name="335"/>  335: <b>loop_double</b>([Sample | Rest]) -&gt;
<a name="336"/>  336:     _ = io_lib_format:fwrite_g(Sample),
<a name="loop_double-last_expr"/><a name="337"/>  337: <b>    loop_double</b>(Rest).
<a name="338"/>  338: 
<a name="test_double_array-1"/><a name="339"/>  339: <b>test_double_array</b>(SmallDigits) when is_integer(SmallDigits) -&gt;
<a name="340"/>  340:     rand:seed(exsplus, {1201,855653,380975}),
<a name="341"/>  341:     Samples = [double(SmallDigits) || _ &lt;- lists:seq(1, ?DOUBLE_SAMPLE)],
<a name="342"/>  342:     Samples_array = array:from_list(Samples),
<a name="test_double_array-last_expr"/><a name="343"/>  343: <b>    test_double_array</b>(?DOUBLE_SAMPLE - 1, Samples_array).
<a name="test_double_array-2"/><a name="344"/>  344: <b>test_double_array</b>(Iter, Samples_array) -&gt;
<a name="345"/>  345:     F = fun() -&gt; loop_double_array(Iter, Samples_array) end,
<a name="346"/>  346:     {Time, ok} = timer:tc(fun() -&gt; lspawn(F) end),
<a name="test_double_array-last_expr"/><a name="347"/>  347: <b>    report_mfa</b>(?DOUBLE_SAMPLE, Time, io_lib_format).
<a name="348"/>  348: 
<a name="loop_double_array-2"/><a name="349"/>  349: <b>loop_double_array</b>(0, _Samples_array) -&gt; garbage_collect(), ok;
<a name="350"/>  350: <b>loop_double_array</b>(Iter, Samples_array) -&gt;
<a name="351"/>  351:     _ = io_lib_format:fwrite_g(array:get(Iter, Samples_array)),
<a name="loop_double_array-last_expr"/><a name="352"/>  352: <b>    loop_double_array</b>(Iter - 1, Samples_array).
<a name="353"/>  353: 
<a name="354"/>  354: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="355"/>  355: 
<a name="simple-1"/><a name="356"/>  356: <b>simple</b>(Config) when is_list(Config) -&gt;
<a name="simple-last_expr"/><a name="357"/>  357: <b>    comment</b>(do_tests(simple, single_small, Config)).
<a name="358"/>  358: 
<a name="simple_timer-1"/><a name="359"/>  359: <b>simple_timer</b>(Config) when is_list(Config) -&gt;
<a name="simple_timer-last_expr"/><a name="360"/>  360: <b>    comment</b>(do_tests(simple_timer, single_small, Config)).
<a name="361"/>  361: 
<a name="simple_mon-1"/><a name="362"/>  362: <b>simple_mon</b>(Config) when is_list(Config) -&gt;
<a name="simple_mon-last_expr"/><a name="363"/>  363: <b>    comment</b>(do_tests(simple_mon, single_small, Config)).
<a name="364"/>  364: 
<a name="simple_timer_mon-1"/><a name="365"/>  365: <b>simple_timer_mon</b>(Config) when is_list(Config) -&gt;
<a name="simple_timer_mon-last_expr"/><a name="366"/>  366: <b>    comment</b>(do_tests(simple_timer_mon, single_small, Config)).
<a name="367"/>  367: 
<a name="generic-1"/><a name="368"/>  368: <b>generic</b>(Config) when is_list(Config) -&gt;
<a name="generic-last_expr"/><a name="369"/>  369: <b>    comment</b>(do_tests(generic, single_small, Config)).
<a name="370"/>  370: 
<a name="generic_log-1"/><a name="371"/>  371: <b>generic_log</b>(Config) when is_list(Config) -&gt;
<a name="generic_log-last_expr"/><a name="372"/>  372: <b>    comment</b>(do_tests(generic_log, single_small, Config)).
<a name="373"/>  373: 
<a name="generic_log100-1"/><a name="374"/>  374: <b>generic_log100</b>(Config) when is_list(Config) -&gt;
<a name="generic_log100-last_expr"/><a name="375"/>  375: <b>    comment</b>(do_tests(generic_log100, single_small, Config)).
<a name="376"/>  376: 
<a name="generic_timer-1"/><a name="377"/>  377: <b>generic_timer</b>(Config) when is_list(Config) -&gt;
<a name="generic_timer-last_expr"/><a name="378"/>  378: <b>    comment</b>(do_tests(generic_timer, single_small, Config)).
<a name="379"/>  379: 
<a name="generic_statem-1"/><a name="380"/>  380: <b>generic_statem</b>(Config) when is_list(Config) -&gt;
<a name="generic_statem-last_expr"/><a name="381"/>  381: <b>    comment</b>(do_tests(generic_statem, single_small, Config)).
<a name="382"/>  382: 
<a name="generic_statem_log-1"/><a name="383"/>  383: <b>generic_statem_log</b>(Config) when is_list(Config) -&gt;
<a name="generic_statem_log-last_expr"/><a name="384"/>  384: <b>    comment</b>(do_tests(generic_statem_log, single_small, Config)).
<a name="385"/>  385: 
<a name="generic_statem_log100-1"/><a name="386"/>  386: <b>generic_statem_log100</b>(Config) when is_list(Config) -&gt;
<a name="generic_statem_log100-last_expr"/><a name="387"/>  387: <b>    comment</b>(do_tests(generic_statem_log100, single_small, Config)).
<a name="388"/>  388: 
<a name="generic_statem_transit-1"/><a name="389"/>  389: <b>generic_statem_transit</b>(Config) when is_list(Config) -&gt;
<a name="generic_statem_transit-last_expr"/><a name="390"/>  390: <b>    comment</b>(do_tests(generic_statem_transit, single_small, Config)).
<a name="391"/>  391: 
<a name="generic_statem_complex-1"/><a name="392"/>  392: <b>generic_statem_complex</b>(Config) when is_list(Config) -&gt;
<a name="generic_statem_complex-last_expr"/><a name="393"/>  393: <b>    comment</b>(do_tests(generic_statem_complex, single_small, Config)).
<a name="394"/>  394: 
<a name="generic_fsm-1"/><a name="395"/>  395: <b>generic_fsm</b>(Config) when is_list(Config) -&gt;
<a name="generic_fsm-last_expr"/><a name="396"/>  396: <b>    comment</b>(do_tests(generic_fsm, single_small, Config)).
<a name="397"/>  397: 
<a name="generic_fsm_transit-1"/><a name="398"/>  398: <b>generic_fsm_transit</b>(Config) when is_list(Config) -&gt;
<a name="generic_fsm_transit-last_expr"/><a name="399"/>  399: <b>    comment</b>(do_tests(generic_fsm_transit, single_small, Config)).
<a name="400"/>  400: 
<a name="single_small-1"/><a name="401"/>  401: <b>single_small</b>(Config) when is_list(Config) -&gt;
<a name="single_small-last_expr"/><a name="402"/>  402: <b>    comparison</b>(?config(cases, Config), single_small, Config).
<a name="403"/>  403: 
<a name="single_medium-1"/><a name="404"/>  404: <b>single_medium</b>(Config) when is_list(Config) -&gt;
<a name="single_medium-last_expr"/><a name="405"/>  405: <b>    comparison</b>(?config(cases, Config), single_medium, Config).
<a name="406"/>  406: 
<a name="single_big-1"/><a name="407"/>  407: <b>single_big</b>(Config) when is_list(Config) -&gt;
<a name="single_big-last_expr"/><a name="408"/>  408: <b>    comparison</b>(?config(cases, Config), single_big, Config).
<a name="409"/>  409: 
<a name="sched_small-1"/><a name="410"/>  410: <b>sched_small</b>(Config) when is_list(Config) -&gt;
<a name="sched_small-last_expr"/><a name="411"/>  411: <b>    comparison</b>(?config(cases, Config), sched_small, Config).
<a name="412"/>  412: 
<a name="sched_medium-1"/><a name="413"/>  413: <b>sched_medium</b>(Config) when is_list(Config) -&gt;
<a name="sched_medium-last_expr"/><a name="414"/>  414: <b>    comparison</b>(?config(cases, Config), sched_medium, Config).
<a name="415"/>  415: 
<a name="sched_big-1"/><a name="416"/>  416: <b>sched_big</b>(Config) when is_list(Config) -&gt;
<a name="sched_big-last_expr"/><a name="417"/>  417: <b>    comparison</b>(?config(cases, Config), sched_big, Config).
<a name="418"/>  418: 
<a name="multi_small-1"/><a name="419"/>  419: <b>multi_small</b>(Config) when is_list(Config) -&gt;
<a name="multi_small-last_expr"/><a name="420"/>  420: <b>    comparison</b>(?config(cases, Config), multi_small, Config).
<a name="421"/>  421: 
<a name="multi_medium-1"/><a name="422"/>  422: <b>multi_medium</b>(Config) when is_list(Config) -&gt;
<a name="multi_medium-last_expr"/><a name="423"/>  423: <b>    comparison</b>(?config(cases, Config), multi_medium, Config).
<a name="424"/>  424: 
<a name="multi_big-1"/><a name="425"/>  425: <b>multi_big</b>(Config) when is_list(Config) -&gt;
<a name="multi_big-last_expr"/><a name="426"/>  426: <b>    comparison</b>(?config(cases, Config), multi_big, Config).
<a name="427"/>  427: 
<a name="comparison-3"/><a name="428"/>  428: <b>comparison</b>(Cases, Kind, Config) -&gt;
<a name="429"/>  429:     Cases = ?config(cases, Config),
<a name="430"/>  430:     [RefResult|_] = Results =
<a name="431"/>  431:         [do_tests(Case, Kind, Config) || Case &lt;- Cases],
<a name="432"/>  432:     Normalized = [norm(Result, RefResult) || Result &lt;- Results],
<a name="433"/>  433:     {Parallelism, Message} = bench_params(Kind),
<a name="434"/>  434:     Wordsize = erlang:system_info(wordsize),
<a name="435"/>  435:     MSize = Wordsize * erts_debug:flat_size(Message),
<a name="436"/>  436:     What = io_lib:format(&quot;#parallel gen_server instances: ~.4w, &quot;
<a name="437"/>  437:                          &quot;message flat size: ~.5w bytes&quot;,
<a name="438"/>  438:                          [Parallelism, MSize]),
<a name="439"/>  439:     Format =
<a name="440"/>  440:         lists:flatten(
<a name="441"/>  441:           [&quot;~s: &quot;] ++
<a name="442"/>  442:               [[atom_to_list(Case),&quot;: ~s &quot;] || Case &lt;- Cases]),
<a name="443"/>  443:     C = lists:flatten(io_lib:format(Format, [What] ++ Normalized)),
<a name="comparison-last_expr"/><a name="444"/>  444:     {comment, C}.
<a name="445"/>  445: 
<a name="norm-2"/><a name="446"/>  446: <b>norm</b>(T, Ref) -&gt;
<a name="norm-last_expr"/><a name="447"/>  447:     try Ref / T of
<a name="448"/>  448:         Norm -&gt;
<a name="449"/>  449:             io_lib:format(&quot;~.2f&quot;, [Norm])
<a name="450"/>  450:     catch error:badarith -&gt;
<a name="451"/>  451:             &quot;---&quot;
<a name="452"/>  452:     end.
<a name="453"/>  453: 
<a name="454"/>  454: <b>-define</b>(MAX_TIME_SECS, 1).   % s
<a name="455"/>  455: <b>-define</b>(MAX_TIME, 1000 * ?MAX_TIME_SECS). % ms
<a name="456"/>  456: <b>-define</b>(CALLS_PER_LOOP, 5).
<a name="457"/>  457: 
<a name="do_tests-3"/><a name="458"/>  458: <b>do_tests</b>(Test, ParamSet, Config) -&gt;
<a name="459"/>  459:     BenchmarkSuite = ?config(benchmark_suite, Config),
<a name="460"/>  460:     {Client, ServerMod, ServerArg} = bench(Test),
<a name="461"/>  461:     {Parallelism, Message} = bench_params(ParamSet),
<a name="462"/>  462:     Fun = create_clients(Message, ServerMod, ServerArg, Client, Parallelism),
<a name="463"/>  463:     {TotalLoops, AllPidTime} = run_test(Fun),
<a name="do_tests-last_expr"/><a name="464"/>  464: <b>    try ?CALLS_PER_LOOP * round</b>((1000 * TotalLoops) / AllPidTime) of
<a name="465"/>  465:         PerSecond -&gt;
<a name="466"/>  466:             ct_event:notify(
<a name="467"/>  467:               #event{
<a name="468"/>  468:                  name = benchmark_data,
<a name="469"/>  469:                  data = [{suite,BenchmarkSuite},{value,PerSecond}]}),
<a name="470"/>  470:             PerSecond
<a name="471"/>  471:     catch error:badarith -&gt;
<a name="472"/>  472:             &quot;Time measurement is not working&quot;
<a name="473"/>  473:     end.
<a name="474"/>  474: 
<a name="475"/>  475: <b>-define</b>(COUNTER, n).
<a name="476"/>  476: 
<a name="simple_client-3"/><a name="477"/>  477: <b>simple_client</b>(N, M, P) -&gt;
<a name="478"/>  478:     put(?COUNTER, N),
<a name="479"/>  479:     _ = simple_server:reply(P, M),
<a name="480"/>  480:     _ = simple_server:reply(P, M),
<a name="481"/>  481:     _ = simple_server:reply(P, M),
<a name="482"/>  482:     _ = simple_server:reply(P, M),
<a name="483"/>  483:     _ = simple_server:reply(P, M),
<a name="simple_client-last_expr"/><a name="484"/>  484: <b>    simple_client</b>(N+1, M, P).
<a name="485"/>  485: 
<a name="simple_client_timer-3"/><a name="486"/>  486: <b>simple_client_timer</b>(N, M, P) -&gt;
<a name="487"/>  487:     put(?COUNTER, N),
<a name="488"/>  488:     _ = simple_server_timer:reply(P, M),
<a name="489"/>  489:     _ = simple_server_timer:reply(P, M),
<a name="490"/>  490:     _ = simple_server_timer:reply(P, M),
<a name="491"/>  491:     _ = simple_server_timer:reply(P, M),
<a name="492"/>  492:     _ = simple_server_timer:reply(P, M),
<a name="simple_client_timer-last_expr"/><a name="493"/>  493: <b>    simple_client_timer</b>(N+1, M, P).
<a name="494"/>  494: 
<a name="simple_client_mon-3"/><a name="495"/>  495: <b>simple_client_mon</b>(N, M, P) -&gt;
<a name="496"/>  496:     put(?COUNTER, N),
<a name="497"/>  497:     _ = simple_server_mon:reply(P, M),
<a name="498"/>  498:     _ = simple_server_mon:reply(P, M),
<a name="499"/>  499:     _ = simple_server_mon:reply(P, M),
<a name="500"/>  500:     _ = simple_server_mon:reply(P, M),
<a name="501"/>  501:     _ = simple_server_mon:reply(P, M),
<a name="simple_client_mon-last_expr"/><a name="502"/>  502: <b>    simple_client_mon</b>(N+1, M, P).
<a name="503"/>  503: 
<a name="simple_client_timer_mon-3"/><a name="504"/>  504: <b>simple_client_timer_mon</b>(N, M, P) -&gt;
<a name="505"/>  505:     put(?COUNTER, N),
<a name="506"/>  506:     _ = simple_server_timer_mon:reply(P, M),
<a name="507"/>  507:     _ = simple_server_timer_mon:reply(P, M),
<a name="508"/>  508:     _ = simple_server_timer_mon:reply(P, M),
<a name="509"/>  509:     _ = simple_server_timer_mon:reply(P, M),
<a name="510"/>  510:     _ = simple_server_timer_mon:reply(P, M),
<a name="simple_client_timer_mon-last_expr"/><a name="511"/>  511: <b>    simple_client_timer_mon</b>(N+1, M, P).
<a name="512"/>  512: 
<a name="generic_client-3"/><a name="513"/>  513: <b>generic_client</b>(N, M, P) -&gt;
<a name="514"/>  514:     put(?COUNTER, N),
<a name="515"/>  515:     _ = generic_server:reply(P, M),
<a name="516"/>  516:     _ = generic_server:reply(P, M),
<a name="517"/>  517:     _ = generic_server:reply(P, M),
<a name="518"/>  518:     _ = generic_server:reply(P, M),
<a name="519"/>  519:     _ = generic_server:reply(P, M),
<a name="generic_client-last_expr"/><a name="520"/>  520: <b>    generic_client</b>(N+1, M, P).
<a name="521"/>  521: 
<a name="generic_timer_client-3"/><a name="522"/>  522: <b>generic_timer_client</b>(N, M, P) -&gt;
<a name="523"/>  523:     put(?COUNTER, N),
<a name="524"/>  524:     _ = generic_server_timer:reply(P, M),
<a name="525"/>  525:     _ = generic_server_timer:reply(P, M),
<a name="526"/>  526:     _ = generic_server_timer:reply(P, M),
<a name="527"/>  527:     _ = generic_server_timer:reply(P, M),
<a name="528"/>  528:     _ = generic_server_timer:reply(P, M),
<a name="generic_timer_client-last_expr"/><a name="529"/>  529: <b>    generic_timer_client</b>(N+1, M, P).
<a name="530"/>  530: 
<a name="generic_statem_client-3"/><a name="531"/>  531: <b>generic_statem_client</b>(N, M, P) -&gt;
<a name="532"/>  532:     put(?COUNTER, N),
<a name="533"/>  533:     _ = generic_statem:reply(P, M),
<a name="534"/>  534:     _ = generic_statem:reply(P, M),
<a name="535"/>  535:     _ = generic_statem:reply(P, M),
<a name="536"/>  536:     _ = generic_statem:reply(P, M),
<a name="537"/>  537:     _ = generic_statem:reply(P, M),
<a name="generic_statem_client-last_expr"/><a name="538"/>  538: <b>    generic_statem_client</b>(N+1, M, P).
<a name="539"/>  539: 
<a name="generic_statem_transit_client-3"/><a name="540"/>  540: <b>generic_statem_transit_client</b>(N, M, P) -&gt;
<a name="541"/>  541:     put(?COUNTER, N),
<a name="542"/>  542:     _ = generic_statem:transit(P, M),
<a name="543"/>  543:     _ = generic_statem:transit(P, M),
<a name="544"/>  544:     _ = generic_statem:transit(P, M),
<a name="545"/>  545:     _ = generic_statem:transit(P, M),
<a name="546"/>  546:     _ = generic_statem:transit(P, M),
<a name="generic_statem_transit_client-last_expr"/><a name="547"/>  547: <b>    generic_statem_transit_client</b>(N+1, M, P).
<a name="548"/>  548: 
<a name="generic_statem_complex_client-3"/><a name="549"/>  549: <b>generic_statem_complex_client</b>(N, M, P) -&gt;
<a name="550"/>  550:     put(?COUNTER, N),
<a name="551"/>  551:     _ = generic_statem:reply(P, M),
<a name="552"/>  552:     _ = generic_statem:reply(P, M),
<a name="553"/>  553:     _ = generic_statem:reply(P, M),
<a name="554"/>  554:     _ = generic_statem:reply(P, M),
<a name="555"/>  555:     _ = generic_statem:reply(P, M),
<a name="generic_statem_complex_client-last_expr"/><a name="556"/>  556: <b>    generic_statem_complex_client</b>(N+1, M, P).
<a name="557"/>  557: 
<a name="generic_fsm_client-3"/><a name="558"/>  558: <b>generic_fsm_client</b>(N, M, P) -&gt;
<a name="559"/>  559:     put(?COUNTER, N),
<a name="560"/>  560:     _ = generic_fsm:reply(P, M),
<a name="561"/>  561:     _ = generic_fsm:reply(P, M),
<a name="562"/>  562:     _ = generic_fsm:reply(P, M),
<a name="563"/>  563:     _ = generic_fsm:reply(P, M),
<a name="564"/>  564:     _ = generic_fsm:reply(P, M),
<a name="generic_fsm_client-last_expr"/><a name="565"/>  565: <b>    generic_fsm_client</b>(N+1, M, P).
<a name="566"/>  566: 
<a name="generic_fsm_transit_client-3"/><a name="567"/>  567: <b>generic_fsm_transit_client</b>(N, M, P) -&gt;
<a name="568"/>  568:     put(?COUNTER, N),
<a name="569"/>  569:     _ = generic_fsm:transit(P, M),
<a name="570"/>  570:     _ = generic_fsm:transit(P, M),
<a name="571"/>  571:     _ = generic_fsm:transit(P, M),
<a name="572"/>  572:     _ = generic_fsm:transit(P, M),
<a name="573"/>  573:     _ = generic_fsm:transit(P, M),
<a name="generic_fsm_transit_client-last_expr"/><a name="574"/>  574: <b>    generic_fsm_transit_client</b>(N+1, M, P).
<a name="575"/>  575: 
<a name="bench-1"/><a name="576"/>  576: <b>bench</b>(simple) -&gt;
<a name="577"/>  577:     {fun simple_client/3, simple_server, term};
<a name="578"/>  578: <b>bench</b>(simple_timer) -&gt;
<a name="579"/>  579:     {fun simple_client_timer/3, simple_server_timer, term};
<a name="580"/>  580: <b>bench</b>(simple_mon) -&gt;
<a name="581"/>  581:     {fun simple_client_mon/3, simple_server_mon, term};
<a name="582"/>  582: <b>bench</b>(simple_timer_mon) -&gt;
<a name="583"/>  583:     {fun simple_client_timer_mon/3, simple_server_timer_mon, term};
<a name="584"/>  584: <b>bench</b>(generic) -&gt;
<a name="585"/>  585:     {fun generic_client/3, generic_server, [term]};
<a name="586"/>  586: <b>bench</b>(generic_log) -&gt;
<a name="587"/>  587:     {fun generic_client/3, generic_server, [term,{debug,[log]}]};
<a name="588"/>  588: <b>bench</b>(generic_log100) -&gt;
<a name="589"/>  589:     {fun generic_client/3, generic_server, [term,{debug,[{log,100}]}]};
<a name="590"/>  590: <b>bench</b>(generic_timer) -&gt;
<a name="591"/>  591:     {fun generic_timer_client/3, generic_server_timer, term};
<a name="592"/>  592: <b>bench</b>(generic_statem) -&gt;
<a name="593"/>  593:     {fun generic_statem_client/3, generic_statem, [term]};
<a name="594"/>  594: <b>bench</b>(generic_statem_log) -&gt;
<a name="595"/>  595:     {fun generic_statem_client/3, generic_statem, [term,{debug,[log]}]};
<a name="596"/>  596: <b>bench</b>(generic_statem_log100) -&gt;
<a name="597"/>  597:     {fun generic_statem_client/3, generic_statem, [term,{debug,[{log,100}]}]};
<a name="598"/>  598: <b>bench</b>(generic_statem_transit) -&gt;
<a name="599"/>  599:     {fun generic_statem_transit_client/3, generic_statem, [term]};
<a name="600"/>  600: <b>bench</b>(generic_statem_complex) -&gt;
<a name="601"/>  601:     {fun generic_statem_complex_client/3, generic_statem_complex, term};
<a name="602"/>  602: <b>bench</b>(generic_fsm) -&gt;
<a name="603"/>  603:     {fun generic_fsm_client/3, generic_fsm, term};
<a name="604"/>  604: <b>bench</b>(generic_fsm_transit) -&gt;
<a name="bench-last_expr"/><a name="605"/>  605:     {fun generic_fsm_transit_client/3, generic_fsm, term}.
<a name="606"/>  606: 
<a name="607"/>  607: <i>%% -&gt; {Parallelism, MessageTerm}</i>
<a name="bench_params-1"/><a name="608"/>  608: <b>bench_params</b>(single_small) -&gt; {1, small()};
<a name="609"/>  609: <b>bench_params</b>(single_medium) -&gt; {1, medium()};
<a name="610"/>  610: <b>bench_params</b>(single_big) -&gt; {1, big()};
<a name="611"/>  611: <b>bench_params</b>(sched_small)  -&gt; {parallelism(), small()};
<a name="612"/>  612: <b>bench_params</b>(sched_medium)  -&gt; {parallelism(), medium()};
<a name="613"/>  613: <b>bench_params</b>(sched_big)  -&gt; {parallelism(), big()};
<a name="614"/>  614: <b>bench_params</b>(multi_small)  -&gt; {400, small()};
<a name="615"/>  615: <b>bench_params</b>(multi_medium)  -&gt; {400, medium()};
<a name="bench_params-last_expr"/><a name="616"/>  616: <b>bench_params</b>(multi_big)  -&gt; {400, big()}.
<a name="617"/>  617: 
<a name="small-0"/><a name="618"/>  618: <b>small</b>() -&gt;
<a name="small-last_expr"/><a name="619"/>  619:     small.
<a name="620"/>  620: 
<a name="medium-0"/><a name="621"/>  621: <b>medium</b>() -&gt;
<a name="medium-last_expr"/><a name="622"/>  622: <b>    lists:seq</b>(1, 50).
<a name="623"/>  623: 
<a name="big-0"/><a name="624"/>  624: <b>big</b>() -&gt;
<a name="big-last_expr"/><a name="625"/>  625: <b>    lists:seq</b>(1, 1000).
<a name="626"/>  626: 
<a name="parallelism-0"/><a name="627"/>  627: <b>parallelism</b>() -&gt;
<a name="parallelism-last_expr"/><a name="628"/>  628: <b>    case erlang:system_info</b>(multi_scheduling) of
<a name="629"/>  629:         enabled -&gt; erlang:system_info(schedulers_online);
<a name="630"/>  630:         _ -&gt; 1
<a name="631"/>  631:     end.
<a name="632"/>  632: 
<a name="create_clients-5"/><a name="633"/>  633: <b>create_clients</b>(M, ServerMod, ServerArg, Client, Parallel) -&gt;
<a name="create_clients-last_expr"/><a name="634"/>  634: <b>    fun</b>() -&gt;
<a name="635"/>  635:             ServerPid = ServerMod:start(ServerArg),
<a name="636"/>  636:             PidRefs = [spawn_monitor(fun() -&gt; Client(0, M, ServerPid) end) ||
<a name="637"/>  637:                           _ &lt;- lists:seq(1, Parallel)],
<a name="638"/>  638:             timer:sleep(?MAX_TIME),
<a name="639"/>  639:             try
<a name="640"/>  640:                 AllPidsN = collect(PidRefs, []),
<a name="641"/>  641:                 TotalLoops = lists:sum(AllPidsN),
<a name="642"/>  642:                 TotalLoops
<a name="643"/>  643:             after
<a name="644"/>  644:                 ok = ServerMod:stop(ServerPid)
<a name="645"/>  645:             end
<a name="646"/>  646:     end.
<a name="647"/>  647: 
<a name="collect-2"/><a name="648"/>  648: <b>collect</b>([], Result) -&gt;
<a name="649"/>  649:     Result;
<a name="650"/>  650: <b>collect</b>([{Pid, Ref}|PidRefs], Result) -&gt;
<a name="651"/>  651:     N = case erlang:process_info(Pid, dictionary) of
<a name="652"/>  652:             {dictionary, Dict} -&gt;
<a name="653"/>  653:                 {?COUNTER, N0} = lists:keyfind(?COUNTER, 1, Dict),
<a name="654"/>  654:                 N0;
<a name="655"/>  655:             undefined -&gt; % Process did not start in ?MAX_TIME_SECS.
<a name="656"/>  656:                 0
<a name="657"/>  657:         end,
<a name="658"/>  658:     exit(Pid, kill),
<a name="659"/>  659:     receive {'DOWN', Ref, _, _, _} -&gt; ok end,
<a name="collect-last_expr"/><a name="660"/>  660: <b>    collect</b>(PidRefs, [N|Result]).
<a name="661"/>  661: 
<a name="run_test-1"/><a name="662"/>  662: <b>run_test</b>(Test) -&gt;
<a name="663"/>  663:     {T1, _} = statistics(runtime),
<a name="664"/>  664:     Result = Test(),
<a name="665"/>  665:     {T2, _} = statistics(runtime),
<a name="run_test-last_expr"/><a name="666"/>  666:     {Result, T2 - T1}.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
