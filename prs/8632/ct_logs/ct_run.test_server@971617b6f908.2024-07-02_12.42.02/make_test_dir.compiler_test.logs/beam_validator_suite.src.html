<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/compiler/make_test_dir/compiler_test/beam_validator_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2004-2024. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(beam_validator_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1, 
<a name="23"/>   23: 	 init_per_group/2,end_per_group/2,
<a name="24"/>   24: 	 init_per_testcase/2,end_per_testcase/2,
<a name="25"/>   25: 	 compiler_bug/1,stupid_but_valid/1,
<a name="26"/>   26: 	 xrange/1,yrange/1,stack/1,call_last/1,merge_undefined/1,
<a name="27"/>   27: 	 uninit/1,unsafe_catch/1,
<a name="28"/>   28: 	 dead_code/1,
<a name="29"/>   29: 	 overwrite_catchtag/1,overwrite_trytag/1,accessing_tags/1,bad_catch_try/1,
<a name="30"/>   30: 	 cons_guard/1,
<a name="31"/>   31: 	 freg_range/1,freg_uninit/1,
<a name="32"/>   32: 	 bad_bin_match/1,bad_dsetel/1,
<a name="33"/>   33: 	 state_after_fault_in_catch/1,no_exception_in_catch/1,
<a name="34"/>   34: 	 undef_label/1,illegal_instruction/1,failing_gc_guard_bif/1,
<a name="35"/>   35: 	 map_field_lists/1,cover_bin_opt/1,
<a name="36"/>   36: 	 val_dsetel/1,bad_tuples/1,bad_try_catch_nesting/1,
<a name="37"/>   37:          receive_stacked/1,aliased_types/1,type_conflict/1,
<a name="38"/>   38:          infer_on_eq/1,infer_dead_value/1,infer_on_ne/1,
<a name="39"/>   39:          branch_to_try_handler/1,call_without_stack/1,
<a name="40"/>   40:          receive_marker/1,safe_instructions/1,
<a name="41"/>   41:          missing_return_type/1,will_succeed/1,
<a name="42"/>   42:          bs_saved_position_units/1,parent_container/1,
<a name="43"/>   43:          container_performance/1,
<a name="44"/>   44:          infer_relops/1,
<a name="45"/>   45:          not_equal_inference/1,bad_bin_unit/1,singleton_inference/1,
<a name="46"/>   46:          inert_update_type/1,range_inference/1,
<a name="47"/>   47:          bif_inference/1]).
<a name="48"/>   48: 
<a name="49"/>   49: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="50"/>   50: 
<a name="init_per_testcase-2"/><a name="51"/>   51: <b>init_per_testcase</b>(Case, Config) when is_atom(Case), is_list(Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="52"/>   52:     Config.
<a name="53"/>   53: 
<a name="end_per_testcase-2"/><a name="54"/>   54: <b>end_per_testcase</b>(Case, Config) when is_atom(Case), is_list(Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="55"/>   55:     ok.
<a name="56"/>   56: 
<a name="suite-0"/><a name="57"/>   57: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="58"/>   58:     [{ct_hooks,[ts_install_cth]},
<a name="59"/>   59:      {timetrap,{minutes,10}}].
<a name="60"/>   60: 
<a name="all-0"/><a name="61"/>   61: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="62"/>   62:     [{group,p}].
<a name="63"/>   63: 
<a name="groups-0"/><a name="64"/>   64: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="65"/>   65: <b>    [{p,test_lib:parallel</b>(),
<a name="66"/>   66:       [compiler_bug,stupid_but_valid,xrange,
<a name="67"/>   67:        yrange,stack,call_last,merge_undefined,uninit,
<a name="68"/>   68:        unsafe_catch,dead_code,
<a name="69"/>   69:        overwrite_catchtag,overwrite_trytag,accessing_tags,
<a name="70"/>   70:        bad_catch_try,cons_guard,freg_range,freg_uninit,
<a name="71"/>   71:        bad_bin_match,bad_dsetel,
<a name="72"/>   72:        state_after_fault_in_catch,no_exception_in_catch,
<a name="73"/>   73:        undef_label,illegal_instruction,failing_gc_guard_bif,
<a name="74"/>   74:        map_field_lists,cover_bin_opt,val_dsetel,
<a name="75"/>   75:        bad_tuples,bad_try_catch_nesting,
<a name="76"/>   76:        receive_stacked,aliased_types,type_conflict,
<a name="77"/>   77:        infer_on_eq,infer_dead_value,infer_on_ne,
<a name="78"/>   78:        branch_to_try_handler,call_without_stack,
<a name="79"/>   79:        receive_marker,safe_instructions,
<a name="80"/>   80:        missing_return_type,will_succeed,
<a name="81"/>   81:        bs_saved_position_units,parent_container,
<a name="82"/>   82:        container_performance,infer_relops,
<a name="83"/>   83:        not_equal_inference,bad_bin_unit,singleton_inference,
<a name="84"/>   84:        inert_update_type,range_inference,
<a name="85"/>   85:        bif_inference]}].
<a name="86"/>   86: 
<a name="init_per_suite-1"/><a name="87"/>   87: <b>init_per_suite</b>(Config) -&gt;
<a name="88"/>   88:     test_lib:recompile(?MODULE),
<a name="init_per_suite-last_expr"/><a name="89"/>   89:     Config.
<a name="90"/>   90: 
<a name="end_per_suite-1"/><a name="91"/>   91: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="92"/>   92:     ok.
<a name="93"/>   93: 
<a name="init_per_group-2"/><a name="94"/>   94: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="95"/>   95: 	Config.
<a name="96"/>   96: 
<a name="end_per_group-2"/><a name="97"/>   97: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="98"/>   98: 	Config.
<a name="99"/>   99: 
<a name="compiler_bug-1"/><a name="100"/>  100: <b>compiler_bug</b>(Config) when is_list(Config) -&gt;
<a name="101"/>  101:     %% Check that the compiler returns an error if we try to
<a name="102"/>  102:     %% assemble one of the bad '.S' files.
<a name="103"/>  103:     Data = proplists:get_value(data_dir, Config),
<a name="104"/>  104:     File = filename:join(Data, &quot;compiler_bug&quot;),
<a name="105"/>  105:     error = compile:file(File, [from_asm,report_errors,time]),
<a name="106"/>  106: 
<a name="107"/>  107:     %% Make sure that the error was reported by
<a name="108"/>  108:     %% the beam_validator module.
<a name="109"/>  109:     {error,
<a name="110"/>  110:      [{&quot;compiler_bug&quot;,
<a name="111"/>  111:        [{_Pos,beam_validator,_}]}],
<a name="112"/>  112:      []} = compile:file(File, [from_asm,return_errors,time]),
<a name="compiler_bug-last_expr"/><a name="113"/>  113:     ok.
<a name="114"/>  114: 
<a name="115"/>  115: <i>%% The following code is stupid but it should compile.</i>
<a name="stupid_but_valid-1"/><a name="116"/>  116: <b>stupid_but_valid</b>(Config) when is_list(Config) -&gt;
<a name="117"/>  117:     AnAtom = nisse,
<a name="118"/>  118:     try setelement(5, setelement(6, AnAtom, value), another_value) of
<a name="119"/>  119: 	Term -&gt; ct:fail({what_happened,Term})
<a name="120"/>  120:     catch
<a name="121"/>  121: 	error:badarg -&gt; ok
<a name="122"/>  122:     end,
<a name="stupid_but_valid-last_expr"/><a name="123"/>  123:     ok.
<a name="124"/>  124: 
<a name="xrange-1"/><a name="125"/>  125: <b>xrange</b>(Config) when is_list(Config) -&gt;
<a name="126"/>  126:     Errors = do_val(xrange, Config),
<a name="127"/>  127:     [{{t,sum_1,2},
<a name="128"/>  128:       {{bif,'+',{f,0},[{x,-1},{x,1}],{x,0}},4,
<a name="129"/>  129:        {bad_register,{x,-1}}}},
<a name="130"/>  130:      {{t,sum_2,2},
<a name="131"/>  131:       {{bif,'+',{f,0},[{x,0},{x,1023}],{x,0}},4,limit}},
<a name="132"/>  132:      {{t,sum_3,2},
<a name="133"/>  133:       {{bif,'+',{f,0},[{x,0},{x,1}],{x,-1}},4,
<a name="134"/>  134:        {bad_register,{x,-1}}}},
<a name="135"/>  135:      {{t,sum_4,2},
<a name="136"/>  136:       {{bif,'+',{f,0},[{x,0},{x,1}],{x,1023}},4,limit}}] = Errors,
<a name="xrange-last_expr"/><a name="137"/>  137:     ok.
<a name="138"/>  138: 
<a name="yrange-1"/><a name="139"/>  139: <b>yrange</b>(Config) when is_list(Config) -&gt;
<a name="140"/>  140:     Errors = do_val(yrange, Config),
<a name="141"/>  141:     [{{t,sum_1,2},
<a name="142"/>  142:       {{move,{x,1},{y,-1}},5,
<a name="143"/>  143:        {bad_register,{y,-1}}}},
<a name="144"/>  144:      {{t,sum_2,2},
<a name="145"/>  145:       {{bif,'+',{f,0},[{x,0},{y,1024}],{x,0}},7,
<a name="146"/>  146:        limit}},
<a name="147"/>  147:      {{t,sum_3,2},
<a name="148"/>  148:       {{move,{x,1},{y,1024}},5,limit}},
<a name="149"/>  149:      {{t,sum_4,2},
<a name="150"/>  150:       {{move,{x,1},{y,-1}},5,
<a name="151"/>  151:        {bad_register,{y,-1}}}}] = Errors,
<a name="yrange-last_expr"/><a name="152"/>  152:     ok.
<a name="153"/>  153: 
<a name="stack-1"/><a name="154"/>  154: <b>stack</b>(Config) when is_list(Config) -&gt;
<a name="155"/>  155:     Errors = do_val(stack, Config),
<a name="156"/>  156:     [{{t,a,2},{return,9,{stack_frame,2}}},
<a name="157"/>  157:      {{t,b,2},{{deallocate,2},4,{allocated,none}}},
<a name="158"/>  158:      {{t,bad_1,0},{{allocate,2,10},4,{{x,9},not_live}}},
<a name="159"/>  159:      {{t,bad_2,0},{{move,{y,0},{x,0}},6,{unassigned,{y,0}}}},
<a name="160"/>  160:      {{t,c,2},{{deallocate,2},10,{allocated,none}}},
<a name="161"/>  161:      {{t,d,2},
<a name="162"/>  162:       {{allocate,2,2},5,{existing_stack_frame,{size,2}}}},
<a name="163"/>  163:      {{t,e,2},{{deallocate,5},6,{allocated,2}}}] = Errors,
<a name="stack-last_expr"/><a name="164"/>  164:     ok.
<a name="165"/>  165: 
<a name="call_last-1"/><a name="166"/>  166: <b>call_last</b>(Config) when is_list(Config) -&gt;
<a name="167"/>  167:     Errors = do_val(call_last, Config),
<a name="168"/>  168:     [{{t,a,1},
<a name="169"/>  169:       {{call_last,1,{f,8},2},9,{allocated,1}}},
<a name="170"/>  170:      {{t,b,1},
<a name="171"/>  171:       {{call_ext_last,2,{extfunc,lists,seq,2},2},10,{allocated,1}}},
<a name="172"/>  172:      {{t,baz,2},
<a name="173"/>  173:       {{call_ext_only,2,{extfunc,erlang,put,2}},5,{allocated,0}}},
<a name="174"/>  174:      {{t,biz,2},
<a name="175"/>  175:       {{call_only,2,{f,10}},5,{allocated,0}}}] = Errors,
<a name="call_last-last_expr"/><a name="176"/>  176:     ok.
<a name="177"/>  177: 
<a name="call_without_stack-1"/><a name="178"/>  178: <b>call_without_stack</b>(Config) when is_list(Config) -&gt;
<a name="179"/>  179:     Errors = do_val(call_without_stack, Config),
<a name="180"/>  180:     [{{t,local,2},
<a name="181"/>  181:         {{call,2,{f,2}},4,{allocated,none}}},
<a name="182"/>  182:      {{t,remote,2},
<a name="183"/>  183:         {{call_ext,2,{extfunc,lists,seq,2}},4,{allocated,none}}}] = Errors,
<a name="call_without_stack-last_expr"/><a name="184"/>  184:     ok.
<a name="185"/>  185: 
<a name="merge_undefined-1"/><a name="186"/>  186: <b>merge_undefined</b>(Config) when is_list(Config) -&gt;
<a name="187"/>  187:     Errors = do_val(merge_undefined, Config),
<a name="188"/>  188:     [{{t,undecided,2},
<a name="189"/>  189:       {{label,11},
<a name="190"/>  190:        19,
<a name="191"/>  191:        {unsafe_stack,{y,1},
<a name="192"/>  192:         #{{y,0} := uninitialized,
<a name="193"/>  193:           {y,1} := uninitialized}}}},
<a name="194"/>  194:      {{t,uninitialized,2},
<a name="195"/>  195:       {{call_ext,2,{extfunc,io,format,2}},
<a name="196"/>  196:        17,
<a name="197"/>  197:        {uninitialized_reg,{y,1}}}}] = Errors,
<a name="merge_undefined-last_expr"/><a name="198"/>  198:     ok.
<a name="199"/>  199: 
<a name="uninit-1"/><a name="200"/>  200: <b>uninit</b>(Config) when is_list(Config) -&gt;
<a name="201"/>  201:     Errors = do_val(uninit, Config),
<a name="202"/>  202:     [{{t,sum_1,2},
<a name="203"/>  203:       {{move,{y,0},{x,0}},5,{uninitialized_reg,{y,0}}}},
<a name="204"/>  204:      {{t,sum_2,2},
<a name="205"/>  205:       {{call,1,{f,8}},5,{uninitialized_reg,{y,0}}}},
<a name="206"/>  206:      {{t,sum_3,2},
<a name="207"/>  207:       {{bif,'+',{f,0},[{x,0},{y,0}],{x,0}},
<a name="208"/>  208:        7,
<a name="209"/>  209:        {unassigned,{y,0}}}}] = Errors,
<a name="uninit-last_expr"/><a name="210"/>  210:     ok.
<a name="211"/>  211: 
<a name="unsafe_catch-1"/><a name="212"/>  212: <b>unsafe_catch</b>(Config) when is_list(Config) -&gt;
<a name="213"/>  213:     Errors = do_val(unsafe_catch, Config),
<a name="214"/>  214:     [{{t,small,2},
<a name="215"/>  215:       {{bs_put_integer,{f,0},{integer,16},1,
<a name="216"/>  216:         {field_flags,[unsigned,big]},{y,0}},
<a name="217"/>  217:        21,
<a name="218"/>  218:        {unassigned,{y,0}}}}] = Errors,
<a name="unsafe_catch-last_expr"/><a name="219"/>  219:     ok.
<a name="220"/>  220: 
<a name="dead_code-1"/><a name="221"/>  221: <b>dead_code</b>(Config) when is_list(Config) -&gt;
<a name="222"/>  222:     [] = do_val(dead_code, Config),
<a name="dead_code-last_expr"/><a name="223"/>  223:     ok.
<a name="224"/>  224: 
<a name="overwrite_catchtag-1"/><a name="225"/>  225: <b>overwrite_catchtag</b>(Config) when is_list(Config) -&gt;
<a name="226"/>  226:     Errors = do_val(overwrite_catchtag, Config),
<a name="227"/>  227:     [{{overwrite_catchtag,foo,1},
<a name="228"/>  228:       {{move,{x,0},{y,0}},6,{catchtag,_}}}] = Errors,
<a name="overwrite_catchtag-last_expr"/><a name="229"/>  229:     ok.
<a name="230"/>  230: 
<a name="overwrite_trytag-1"/><a name="231"/>  231: <b>overwrite_trytag</b>(Config) when is_list(Config) -&gt;
<a name="232"/>  232:     Errors = do_val(overwrite_trytag, Config),
<a name="233"/>  233:     [{{overwrite_trytag,foo,1},
<a name="234"/>  234:       {{init_yregs,{list,[{y,2}]}},9,{trytag,_}}}] = Errors,
<a name="overwrite_trytag-last_expr"/><a name="235"/>  235:     ok.
<a name="236"/>  236: 
<a name="accessing_tags-1"/><a name="237"/>  237: <b>accessing_tags</b>(Config) when is_list(Config) -&gt;
<a name="238"/>  238:     Errors = do_val(accessing_tags, Config),
<a name="239"/>  239:     [{{accessing_tags,bar,1},
<a name="240"/>  240:       {{move,{y,0},{x,0}},6,{trytag,_}}},
<a name="241"/>  241:      {{accessing_tags,foo,1},
<a name="242"/>  242:       {{move,{y,0},{x,0}},6,{catchtag,_}}}] = Errors,
<a name="accessing_tags-last_expr"/><a name="243"/>  243:     ok.
<a name="244"/>  244: 
<a name="bad_catch_try-1"/><a name="245"/>  245: <b>bad_catch_try</b>(Config) when is_list(Config) -&gt;
<a name="246"/>  246:     Errors = do_val(bad_catch_try, Config),
<a name="247"/>  247:     [{{bad_catch_try,bad_1,1},
<a name="248"/>  248:       {{'catch',{x,0},{f,3}},
<a name="249"/>  249:        5,{invalid_tag_register,{x,0}}}},
<a name="250"/>  250:      {{bad_catch_try,bad_2,1},
<a name="251"/>  251:       {{catch_end,{x,9}},
<a name="252"/>  252:        8,{invalid_tag_register,{x,9}}}},
<a name="253"/>  253:      {{bad_catch_try,bad_3,1},
<a name="254"/>  254:       {{catch_end,{y,1}},9,{invalid_tag,{y,1},{t_atom,[kalle]}}}},
<a name="255"/>  255:      {{bad_catch_try,bad_4,1},
<a name="256"/>  256:       {{'try',{x,0},{f,15}},6,{invalid_tag_register,{x,0}}}},
<a name="257"/>  257:      {{bad_catch_try,bad_5,1},
<a name="258"/>  258:       {{try_case,{y,1}},13,{invalid_tag,{y,1},any}}},
<a name="259"/>  259:      {{bad_catch_try,bad_6,1},
<a name="260"/>  260:       {{move,{integer,1},{y,1}},8,
<a name="261"/>  261:        {invalid_store,{y,1}}}}] = Errors,
<a name="bad_catch_try-last_expr"/><a name="262"/>  262:     ok.
<a name="263"/>  263: 
<a name="cons_guard-1"/><a name="264"/>  264: <b>cons_guard</b>(Config) when is_list(Config) -&gt;
<a name="265"/>  265:     Errors = do_val(cons, Config),
<a name="266"/>  266:     [{{cons,foo,1},
<a name="267"/>  267:       {{get_list,{x,0},{x,1},{x,2}},
<a name="268"/>  268:        5,
<a name="269"/>  269:        {bad_type,{needed,{t_cons,any,any}},{actual,any}}}}] = Errors,
<a name="cons_guard-last_expr"/><a name="270"/>  270:     ok.
<a name="271"/>  271: 
<a name="freg_range-1"/><a name="272"/>  272: <b>freg_range</b>(Config) when is_list(Config) -&gt;
<a name="273"/>  273:     Errors = do_val(freg_range, Config),
<a name="274"/>  274:     [{{t,sum_1,2},
<a name="275"/>  275:       {{bif,fadd,{f,0},[{fr,-1},{fr,1}],{fr,0}},
<a name="276"/>  276:        4,
<a name="277"/>  277:        {bad_source,{fr,-1}}}},
<a name="278"/>  278:      {{t,sum_2,2},
<a name="279"/>  279:       {{bif,fadd,{f,0},[{fr,0},{fr,1024}],{fr,0}},
<a name="280"/>  280:        5,
<a name="281"/>  281:        {uninitialized_reg,{fr,1024}}}},
<a name="282"/>  282:      {{t,sum_3,2},
<a name="283"/>  283:       {{bif,fadd,{f,0},[{fr,0},{fr,1}],{fr,-1}},
<a name="284"/>  284:        6,
<a name="285"/>  285:        {bad_register,{fr,-1}}}},
<a name="286"/>  286:      {{t,sum_4,2},
<a name="287"/>  287:       {{bif,fadd,{f,0},[{fr,0},{fr,1}],{fr,1024}},
<a name="288"/>  288:        6,
<a name="289"/>  289:        limit}}] = Errors,
<a name="freg_range-last_expr"/><a name="290"/>  290:     ok.
<a name="291"/>  291: 
<a name="freg_uninit-1"/><a name="292"/>  292: <b>freg_uninit</b>(Config) when is_list(Config) -&gt;
<a name="293"/>  293:     Errors = do_val(freg_uninit, Config),
<a name="294"/>  294:     [{{t,sum_1,2},
<a name="295"/>  295:       {{bif,fadd,{f,0},[{fr,0},{fr,1}],{fr,0}},
<a name="296"/>  296:        5,
<a name="297"/>  297:        {uninitialized_reg,{fr,1}}}},
<a name="298"/>  298:      {{t,sum_2,2},
<a name="299"/>  299:       {{bif,fadd,{f,0},[{fr,0},{fr,1}],{fr,0}},
<a name="300"/>  300:        8,
<a name="301"/>  301:        {uninitialized_reg,{fr,0}}}}] = Errors,
<a name="freg_uninit-last_expr"/><a name="302"/>  302:     ok.
<a name="303"/>  303: 
<a name="bad_bin_match-1"/><a name="304"/>  304: <b>bad_bin_match</b>(Config) when is_list(Config) -&gt;
<a name="305"/>  305:     [{{t,t,1},{return,5,{match_context,{x,0}}}}] =
<a name="306"/>  306: 	do_val(bad_bin_match, Config),
<a name="bad_bin_match-last_expr"/><a name="307"/>  307:     ok.
<a name="308"/>  308: 
<a name="bad_dsetel-1"/><a name="309"/>  309: <b>bad_dsetel</b>(Config) when is_list(Config) -&gt;
<a name="310"/>  310:     Errors = do_val(bad_dsetel, Config),
<a name="311"/>  311:     [{{t,t,1},
<a name="312"/>  312:       {{set_tuple_element,{x,1},{x,0},1},
<a name="313"/>  313:        17,
<a name="314"/>  314:        illegal_context_for_set_tuple_element}}] = Errors,
<a name="bad_dsetel-last_expr"/><a name="315"/>  315:     ok.
<a name="316"/>  316: 
<a name="state_after_fault_in_catch-1"/><a name="317"/>  317: <b>state_after_fault_in_catch</b>(Config) when is_list(Config) -&gt;
<a name="318"/>  318:     Errors = do_val(state_after_fault_in_catch, Config),
<a name="319"/>  319:     [{{state_after_fault_in_catch,badmatch,1},
<a name="320"/>  320:       {{move,{x,1},{x,0}},9,{uninitialized_reg,{x,1}}}},
<a name="321"/>  321:      {{state_after_fault_in_catch,case_end,1},
<a name="322"/>  322:       {{move,{x,1},{x,0}},9,{uninitialized_reg,{x,1}}}},
<a name="323"/>  323:      {{state_after_fault_in_catch,if_end,1},
<a name="324"/>  324:       {{move,{x,1},{x,0}},9,{uninitialized_reg,{x,1}}}},
<a name="325"/>  325:      {{t,foo,1},
<a name="326"/>  326:       {{move,{x,1},{x,0}},10,{uninitialized_reg,{x,1}}}}] = Errors,
<a name="state_after_fault_in_catch-last_expr"/><a name="327"/>  327:     ok.
<a name="328"/>  328: 
<a name="no_exception_in_catch-1"/><a name="329"/>  329: <b>no_exception_in_catch</b>(Config) when is_list(Config) -&gt;
<a name="330"/>  330:     Errors = do_val(no_exception_in_catch, Config),
<a name="331"/>  331:     [{{no_exception_in_catch,nested_of_1,4},
<a name="332"/>  332:       {{try_case_end,{x,0}},152,ambiguous_catch_try_state}}] = Errors,
<a name="no_exception_in_catch-last_expr"/><a name="333"/>  333:     ok.
<a name="334"/>  334: 
<a name="undef_label-1"/><a name="335"/>  335: <b>undef_label</b>(Config) when is_list(Config) -&gt;
<a name="336"/>  336:     M = {undef_label,
<a name="337"/>  337: 	 [{t,1}],
<a name="338"/>  338: 	 [],
<a name="339"/>  339: 	 [{function,t,1,2,
<a name="340"/>  340: 	   [{label,1},
<a name="341"/>  341: 	    {func_info,{atom,undef_label},{atom,t},1},
<a name="342"/>  342: 	    {label,2},
<a name="343"/>  343: 	    {test,is_eq_exact,{f,42},[{x,0},{atom,x}]},
<a name="344"/>  344: 	    {move,{atom,ok},{x,0}},
<a name="345"/>  345: 	    return]},
<a name="346"/>  346: 	  {function,x,1,17,
<a name="347"/>  347: 	   [{label,3},
<a name="348"/>  348: 	    {func_info,{atom,undef_label},{atom,x},1},
<a name="349"/>  349: 	    {label,4},
<a name="350"/>  350: 	    return]}],
<a name="351"/>  351: 	 5},
<a name="352"/>  352:     Errors = beam_val(M),
<a name="353"/>  353:     [{{undef_label,t,1},{undef_labels,[42]}},
<a name="354"/>  354:      {{undef_label,x,1},no_entry_label}] = Errors,
<a name="undef_label-last_expr"/><a name="355"/>  355:     ok.
<a name="356"/>  356: 
<a name="illegal_instruction-1"/><a name="357"/>  357: <b>illegal_instruction</b>(Config) when is_list(Config) -&gt;
<a name="358"/>  358:     M = {illegal_instruction,
<a name="359"/>  359: 	 [{t,1},{x,1},{y,0}],
<a name="360"/>  360: 	 [],
<a name="361"/>  361: 	 [{function,t,1,2,
<a name="362"/>  362: 	   [{label,1},
<a name="363"/>  363: 	    {func_info,{atom,illegal_instruction},{atom,t},1},
<a name="364"/>  364: 	    {label,2},
<a name="365"/>  365: 	    {my_illegal_instruction,{x,0}},
<a name="366"/>  366: 	    return]},
<a name="367"/>  367: 	  {function,x,1,4,
<a name="368"/>  368: 	   [{label,3},
<a name="369"/>  369: 	    bad_func_info,
<a name="370"/>  370: 	    {label,4},
<a name="371"/>  371: 	    {my_illegal_instruction,{x,0}},
<a name="372"/>  372: 	    return]},
<a name="373"/>  373: 	  {function,y,0,17,[]}],
<a name="374"/>  374: 	 5},
<a name="375"/>  375:     Errors = beam_val(M),
<a name="376"/>  376:     [{{illegal_instruction,t,1},
<a name="377"/>  377:       {{my_illegal_instruction,{x,0}},4,unknown_instruction}},
<a name="378"/>  378:      {{illegal_instruction,x,1},invalid_function_header},
<a name="379"/>  379:      {{illegal_instruction,y,0},invalid_function_header}] = Errors,
<a name="illegal_instruction-last_expr"/><a name="380"/>  380:     ok.
<a name="381"/>  381: 
<a name="382"/>  382: <i>%% The beam_validator used to assume that a GC guard BIF could</i>
<a name="383"/>  383: <i>%% do a garbage collection even if it failed. That assumption</i>
<a name="384"/>  384: <i>%% is not correct, and will cause the beam_validator to reject</i>
<a name="385"/>  385: <i>%% valid programs such as this test case.</i>
<a name="386"/>  386: <i>%%</i>
<a name="387"/>  387: <i>%% (Thanks to Kiran Khaladkar.)</i>
<a name="388"/>  388: <i>%%</i>
<a name="failing_gc_guard_bif-1"/><a name="389"/>  389: <b>failing_gc_guard_bif</b>(Config) when is_list(Config) -&gt;
<a name="390"/>  390:     ok = process_request(lists:seq(1, 36)),
<a name="391"/>  391:     error = process_request([]),
<a name="392"/>  392:     error = process_request(not_a_list),
<a name="failing_gc_guard_bif-last_expr"/><a name="393"/>  393:     ok.
<a name="394"/>  394: 
<a name="process_request-1"/><a name="395"/>  395: <b>process_request</b>(ConfId) -&gt;
<a name="396"/>  396:     case process_request_foo(ConfId) of
<a name="397"/>  397: 	false -&gt;
<a name="398"/>  398: 	    if
<a name="399"/>  399: 		length(ConfId) == 36 -&gt;
<a name="400"/>  400: 		    Response = ok;
<a name="401"/>  401: 		true -&gt;
<a name="402"/>  402: 		    Response = error
<a name="403"/>  403: 	    end
<a name="404"/>  404:     end,
<a name="process_request-last_expr"/><a name="405"/>  405: <b>    process_request_bar</b>(self(), [Response]).
<a name="406"/>  406: 
<a name="process_request_foo-1"/><a name="407"/>  407: <b>process_request_foo</b>(_) -&gt;
<a name="process_request_foo-last_expr"/><a name="408"/>  408:     false.
<a name="409"/>  409: 
<a name="process_request_bar-2"/><a name="410"/>  410: <b>process_request_bar</b>(Pid, [Response]) when is_pid(Pid) -&gt;
<a name="process_request_bar-last_expr"/><a name="411"/>  411:     Response.
<a name="412"/>  412: 
<a name="map_field_lists-1"/><a name="413"/>  413: <b>map_field_lists</b>(Config) -&gt;
<a name="414"/>  414:     Errors = do_val(map_field_lists, Config),
<a name="map_field_lists-last_expr"/><a name="415"/>  415:     [{{map_field_lists,x,1},
<a name="416"/>  416:       {{test,has_map_fields,{f,1},{x,0},{list,[{atom,a},{atom,a}]}},
<a name="417"/>  417:        6,
<a name="418"/>  418:        keys_not_unique}},
<a name="419"/>  419:      {{map_field_lists,y,1},
<a name="420"/>  420:       {{test,has_map_fields,{f,3},{x,0},{list,[]}},
<a name="421"/>  421:        6,
<a name="422"/>  422:        empty_field_list}}
<a name="423"/>  423:     ] = Errors.
<a name="424"/>  424: 
<a name="425"/>  425: <i>%% Coverage and smoke test of beam_validator.</i>
<a name="cover_bin_opt-1"/><a name="426"/>  426: <b>cover_bin_opt</b>(_Config) -&gt;
<a name="427"/>  427:     Ms = [beam_utils_SUITE,
<a name="428"/>  428: 	  bs_match_SUITE,
<a name="429"/>  429: 	  bs_bincomp_SUITE,
<a name="430"/>  430: 	  bs_bit_binaries_SUITE,
<a name="431"/>  431: 	  bs_utf_SUITE],
<a name="432"/>  432:     test_lib:p_run(fun try_bin_opt/1, Ms),
<a name="cover_bin_opt-last_expr"/><a name="433"/>  433:     ok.
<a name="434"/>  434: 
<a name="try_bin_opt-1"/><a name="435"/>  435: <b>try_bin_opt</b>(Mod) -&gt;
<a name="try_bin_opt-last_expr"/><a name="436"/>  436:     try
<a name="437"/>  437: 	do_bin_opt(Mod)
<a name="438"/>  438:     catch
<a name="439"/>  439: 	Class:Error:Stk -&gt;
<a name="440"/>  440: 	    io:format(&quot;~p: ~p ~p\n~p\n&quot;,
<a name="441"/>  441: 		      [Mod,Class,Error,Stk]),
<a name="442"/>  442: 	    error
<a name="443"/>  443:     end.
<a name="444"/>  444: 
<a name="do_bin_opt-1"/><a name="445"/>  445: <b>do_bin_opt</b>(Mod) -&gt;
<a name="446"/>  446:     Beam = code:which(Mod),
<a name="447"/>  447:     {ok,{Mod,[{abstract_code,
<a name="448"/>  448: 	       {raw_abstract_v1,Abstr}}]}} =
<a name="449"/>  449: 	beam_lib:chunks(Beam, [abstract_code]),
<a name="450"/>  450:     {ok,Mod,Asm} = compile:forms(Abstr, ['S']),
<a name="do_bin_opt-last_expr"/><a name="451"/>  451: <b>    do_bin_opt</b>(Mod, Asm).
<a name="452"/>  452: 
<a name="do_bin_opt-2"/><a name="453"/>  453: <b>do_bin_opt</b>(Mod, Asm) -&gt;
<a name="454"/>  454:     do_bin_opt(fun enable_bin_opt/1, Mod, Asm),
<a name="455"/>  455:     do_bin_opt(fun remove_bs_start_match/1, Mod, Asm),
<a name="456"/>  456:     do_bin_opt(fun remove_bs_save/1, Mod, Asm),
<a name="457"/>  457:     do_bin_opt(fun destroy_ctxt/1, Mod, Asm),
<a name="458"/>  458:     do_bin_opt(fun destroy_save_point/1, Mod, Asm),
<a name="do_bin_opt-last_expr"/><a name="459"/>  459:     ok.
<a name="460"/>  460: 
<a name="do_bin_opt-3"/><a name="461"/>  461: <b>do_bin_opt</b>(Transform, Mod, Asm0) -&gt;
<a name="462"/>  462:     Asm = Transform(Asm0),
<a name="do_bin_opt-last_expr"/><a name="463"/>  463: <b>    case compile:forms</b>(Asm, [from_asm,no_postopt,return]) of
<a name="464"/>  464: 	{ok,Mod,Code,_Warnings} when is_binary(Code) -&gt;
<a name="465"/>  465: 	    ok;
<a name="466"/>  466: 	{error,Errors0,_} -&gt;
<a name="467"/>  467: 	    %% beam_validator must return errors, not simply crash,
<a name="468"/>  468: 	    %% when illegal code is found.
<a name="469"/>  469: 	    ModString = atom_to_list(Mod),
<a name="470"/>  470: 	    [{ModString,Errors}] = Errors0,
<a name="471"/>  471: 	    _ = [verify_bin_opt_error(E) || E &lt;- Errors],
<a name="472"/>  472: 	    ok
<a name="473"/>  473:     end.
<a name="474"/>  474: 
<a name="verify_bin_opt_error-1"/><a name="475"/>  475: <b>verify_bin_opt_error</b>({beam_validator,_}) -&gt;
<a name="verify_bin_opt_error-last_expr"/><a name="476"/>  476:     ok.
<a name="477"/>  477: 
<a name="enable_bin_opt-1"/><a name="478"/>  478: <b>enable_bin_opt</b>(Module) -&gt;
<a name="enable_bin_opt-last_expr"/><a name="479"/>  479: <b>    transform_is</b>(fun enable_bin_opt_body/1, Module).
<a name="480"/>  480: 
<a name="enable_bin_opt_body-1"/><a name="481"/>  481: <b>enable_bin_opt_body</b>([_,{'%',{no_bin_opt,_Reason,_Anno}}|Is]) -&gt;
<a name="482"/>  482:     enable_bin_opt_body(Is);
<a name="483"/>  483: <b>enable_bin_opt_body</b>([I|Is]) -&gt;
<a name="484"/>  484:     [I|enable_bin_opt_body(Is)];
<a name="485"/>  485: <b>enable_bin_opt_body</b>([]) -&gt;
<a name="enable_bin_opt_body-last_expr"/><a name="486"/>  486:     [].
<a name="487"/>  487: 
<a name="remove_bs_start_match-1"/><a name="488"/>  488: <b>remove_bs_start_match</b>(Module) -&gt;
<a name="remove_bs_start_match-last_expr"/><a name="489"/>  489: <b>    transform_remove</b>(fun({test,bs_start_match2,_,_,_,_}) -&gt; true;
<a name="490"/>  490: 			(_) -&gt; false
<a name="491"/>  491: 		     end, Module).
<a name="492"/>  492: 
<a name="remove_bs_save-1"/><a name="493"/>  493: <b>remove_bs_save</b>(Module) -&gt;
<a name="remove_bs_save-last_expr"/><a name="494"/>  494: <b>    transform_remove</b>(fun({bs_save2,_,_}) -&gt; true;
<a name="495"/>  495: 			(_) -&gt; false
<a name="496"/>  496: 		     end, Module).
<a name="497"/>  497: 
<a name="destroy_save_point-1"/><a name="498"/>  498: <b>destroy_save_point</b>(Module) -&gt;
<a name="destroy_save_point-last_expr"/><a name="499"/>  499: <b>    transform_i</b>(fun do_destroy_save_point/1, Module).
<a name="500"/>  500: 
<a name="do_destroy_save_point-1"/><a name="501"/>  501: <b>do_destroy_save_point</b>({I,Ctx,_Point})
<a name="502"/>  502:   when I =:= bs_save2; I =:= bs_restore2 -&gt;
<a name="503"/>  503:     {I,Ctx,42};
<a name="504"/>  504: <b>do_destroy_save_point</b>(I) -&gt;
<a name="do_destroy_save_point-last_expr"/><a name="505"/>  505:     I.
<a name="506"/>  506: 
<a name="destroy_ctxt-1"/><a name="507"/>  507: <b>destroy_ctxt</b>(Module) -&gt;
<a name="destroy_ctxt-last_expr"/><a name="508"/>  508: <b>    transform_i</b>(fun do_destroy_ctxt/1, Module).
<a name="509"/>  509: 
<a name="do_destroy_ctxt-1"/><a name="510"/>  510: <b>do_destroy_ctxt</b>({bs_save2=I,Ctx,Point}) -&gt;
<a name="511"/>  511:     {I,destroy_reg(Ctx),Point};
<a name="512"/>  512: <b>do_destroy_ctxt</b>({bs_restore2=I,Ctx,Point}) -&gt;
<a name="513"/>  513:     {I,destroy_reg(Ctx),Point};
<a name="514"/>  514: <b>do_destroy_ctxt</b>({bs_context_to_binary=I,Ctx}) -&gt;
<a name="515"/>  515:     {I,destroy_reg(Ctx)};
<a name="516"/>  516: <b>do_destroy_ctxt</b>(I) -&gt;
<a name="do_destroy_ctxt-last_expr"/><a name="517"/>  517:     I.
<a name="518"/>  518: 
<a name="destroy_reg-1"/><a name="519"/>  519: <b>destroy_reg</b>({Tag,N}) -&gt;
<a name="destroy_reg-last_expr"/><a name="520"/>  520: <b>    case rand:uniform</b>() of
<a name="521"/>  521: 	R when R &lt; 0.6 -&gt;
<a name="522"/>  522: 	    {Tag,N+1};
<a name="523"/>  523: 	_ -&gt;
<a name="524"/>  524: 	    {y,N+1}
<a name="525"/>  525:     end.
<a name="526"/>  526: 
<a name="bad_tuples-1"/><a name="527"/>  527: <b>bad_tuples</b>(Config) -&gt;
<a name="528"/>  528:     Errors = do_val(bad_tuples, Config),
<a name="529"/>  529:     [{{bad_tuples,heap_overflow,1},
<a name="530"/>  530:       {{put_tuple2,{x,0},{list,[{atom,ok},{x,0}]}},6,
<a name="531"/>  531:        {heap_overflow,{left,2},{wanted,3}}}}] = Errors,
<a name="532"/>  532: 
<a name="bad_tuples-last_expr"/><a name="533"/>  533:     ok.
<a name="534"/>  534: 
<a name="bad_try_catch_nesting-1"/><a name="535"/>  535: <b>bad_try_catch_nesting</b>(Config) -&gt;
<a name="536"/>  536:     Errors = do_val(bad_try_catch_nesting, Config),
<a name="537"/>  537:     [{{bad_try_catch_nesting,main,2},
<a name="538"/>  538:       {{'try',{y,2},{f,3}},
<a name="539"/>  539:        9,
<a name="540"/>  540:        {bad_try_catch_nesting,{y,2},[{{y,1},{trytag,[5]}}]}}}] = Errors,
<a name="bad_try_catch_nesting-last_expr"/><a name="541"/>  541:     ok.
<a name="542"/>  542: 
<a name="receive_stacked-1"/><a name="543"/>  543: <b>receive_stacked</b>(Config) -&gt;
<a name="544"/>  544:     Mod = ?FUNCTION_NAME,
<a name="545"/>  545:     Errors = do_val(Mod, Config),
<a name="546"/>  546:     [{{receive_stacked,f1,0},
<a name="547"/>  547:       {{loop_rec_end,{f,3}},
<a name="548"/>  548:        19,
<a name="549"/>  549:        {fragile_message_reference,{y,_}}}},
<a name="550"/>  550:      {{receive_stacked,f2,0},
<a name="551"/>  551:       {{test_heap,3,0},12,{fragile_message_reference,{y,_}}}},
<a name="552"/>  552:      {{receive_stacked,f3,0},
<a name="553"/>  553:       {{test_heap,3,0},12,{fragile_message_reference,{y,_}}}},
<a name="554"/>  554:      {{receive_stacked,f4,0},
<a name="555"/>  555:       {{test_heap,3,0},12,{fragile_message_reference,{y,_}}}},
<a name="556"/>  556:      {{receive_stacked,f5,0},
<a name="557"/>  557:       {{loop_rec_end,{f,23}},
<a name="558"/>  558:        23,
<a name="559"/>  559:        {fragile_message_reference,{y,_}}}},
<a name="560"/>  560:      {{receive_stacked,f6,0},
<a name="561"/>  561:       {{gc_bif,byte_size,{f,29},0,[{y,_}],{x,0}},
<a name="562"/>  562:        14,
<a name="563"/>  563:        {fragile_message_reference,{y,_}}}},
<a name="564"/>  564:      {{receive_stacked,f7,0},
<a name="565"/>  565:       {{loop_rec_end,{f,33}},
<a name="566"/>  566:        22,
<a name="567"/>  567:        {fragile_message_reference,{y,_}}}},
<a name="568"/>  568:      {{receive_stacked,f8,0},
<a name="569"/>  569:       {{loop_rec_end,{f,38}},
<a name="570"/>  570:        22,
<a name="571"/>  571:        {fragile_message_reference,{y,_}}}},
<a name="572"/>  572:      {{receive_stacked,m1,0},
<a name="573"/>  573:       {{loop_rec_end,{f,43}},
<a name="574"/>  574:        21,
<a name="575"/>  575:        {fragile_message_reference,{y,_}}}},
<a name="576"/>  576:      {{receive_stacked,m2,0},
<a name="577"/>  577:       {{loop_rec_end,{f,48}},
<a name="578"/>  578:        32,
<a name="579"/>  579:        {fragile_message_reference,{y,_}}}}] = Errors,
<a name="580"/>  580: 
<a name="581"/>  581:     %% Compile the original source code as a smoke test.
<a name="582"/>  582:     Data = proplists:get_value(data_dir, Config),
<a name="583"/>  583:     Base = atom_to_list(Mod),
<a name="584"/>  584:     File = filename:join(Data, Base),
<a name="585"/>  585:     {ok,Mod,_} = compile:file(File, [binary]),
<a name="586"/>  586: 
<a name="receive_stacked-last_expr"/><a name="587"/>  587:     ok.
<a name="588"/>  588: 
<a name="aliased_types-1"/><a name="589"/>  589: <b>aliased_types</b>(Config) -&gt;
<a name="590"/>  590:     Seq = lists:seq(1, 5),
<a name="591"/>  591:     1 = aliased_types_1(Seq, Config),
<a name="592"/>  592: 
<a name="593"/>  593:     {1,1} = aliased_types_2(Seq),
<a name="594"/>  594:     {42,none} = aliased_types_2([]),
<a name="595"/>  595: 
<a name="596"/>  596:     gurka = aliased_types_3([gurka]),
<a name="597"/>  597:     gaffel = aliased_types_3([gaffel]),
<a name="598"/>  598: 
<a name="aliased_types-last_expr"/><a name="599"/>  599:     ok.
<a name="600"/>  600: 
<a name="601"/>  601: <i>%% ERL-735: validator failed to track types on aliased registers, rejecting</i>
<a name="602"/>  602: <i>%% legitimate optimizations.</i>
<a name="603"/>  603: <i>%%</i>
<a name="604"/>  604: <i>%%    move x0 y0</i>
<a name="605"/>  605: <i>%%    bif hd L1 x0</i>
<a name="606"/>  606: <i>%%    get_hd y0     %% The validator failed to see that y0 was a list</i>
<a name="607"/>  607: <i>%%</i>
<a name="aliased_types_1-2"/><a name="608"/>  608: <b>aliased_types_1</b>(Bug, Config) -&gt;
<a name="aliased_types_1-last_expr"/><a name="609"/>  609:     if
<a name="610"/>  610:         Config =/= [gurka, gaffel] -&gt; %% Pointless branch.
<a name="611"/>  611:             _ = hd(Bug),
<a name="612"/>  612:             lists:seq(1, 5),
<a name="613"/>  613:             hd(Bug)
<a name="614"/>  614:     end.
<a name="615"/>  615: 
<a name="616"/>  616: <i>%% ERL-832: validator failed to realize that a Y register was a cons.</i>
<a name="aliased_types_2-1"/><a name="617"/>  617: <b>aliased_types_2</b>(Bug) -&gt;
<a name="618"/>  618:     Res = case Bug of
<a name="619"/>  619:               [] -&gt; id(42);
<a name="620"/>  620:               _ -&gt; hd(Bug)
<a name="621"/>  621:           end,
<a name="aliased_types_2-last_expr"/><a name="622"/>  622:     {Res,case Bug of
<a name="623"/>  623:              [] -&gt; none;
<a name="624"/>  624:              _ -&gt; hd(Bug)
<a name="625"/>  625:          end}.
<a name="626"/>  626: 
<a name="627"/>  627: <i>%% ERL-832 part deux; validator failed to realize that an aliased register was</i>
<a name="628"/>  628: <i>%% a cons.</i>
<a name="aliased_types_3-1"/><a name="629"/>  629: <b>aliased_types_3</b>(Bug) -&gt;
<a name="630"/>  630:     List = [Y || Y &lt;- Bug],
<a name="aliased_types_3-last_expr"/><a name="631"/>  631:     case List of
<a name="632"/>  632:         [] -&gt; Bug;
<a name="633"/>  633:         _ -&gt;
<a name="634"/>  634:             if
<a name="635"/>  635:                 hd(List) -&gt; a:a();
<a name="636"/>  636:                 true -&gt; ok
<a name="637"/>  637:             end,
<a name="638"/>  638:             hd(List)
<a name="639"/>  639:     end.
<a name="640"/>  640: 
<a name="641"/>  641: 
<a name="642"/>  642: <i>%% ERL-867; validation proceeded after a type conflict, causing incorrect types</i>
<a name="643"/>  643: <i>%% to be joined.</i>
<a name="644"/>  644: 
<a name="645"/>  645: <b>-record</b>(r, { e1 = e1, e2 = e2 }).
<a name="646"/>  646: 
<a name="type_conflict-1"/><a name="647"/>  647: <b>type_conflict</b>(Config) when is_list(Config) -&gt;
<a name="648"/>  648:     {e1, e2} = type_conflict_1(#r{}),
<a name="type_conflict-last_expr"/><a name="649"/>  649:     ok.
<a name="650"/>  650: 
<a name="type_conflict_1-1"/><a name="651"/>  651: <b>type_conflict_1</b>(C) -&gt;
<a name="652"/>  652:     Src = id(C#r.e2),
<a name="653"/>  653:     TRes = try id(Src) of
<a name="654"/>  654:                R -&gt; R
<a name="655"/>  655:            catch
<a name="656"/>  656:                %% C:R can never match, yet it assumed that the type of 'C' was
<a name="657"/>  657:                %% an atom from here on.
<a name="658"/>  658:                C:R -&gt; R
<a name="659"/>  659:            end,
<a name="type_conflict_1-last_expr"/><a name="660"/>  660:     {C#r.e1, TRes}.
<a name="661"/>  661: 
<a name="662"/>  662: <i>%% ERL-886; validation failed to infer types on both sides of '=:='</i>
<a name="663"/>  663: 
<a name="infer_on_eq-1"/><a name="664"/>  664: <b>infer_on_eq</b>(Config) when is_list(Config) -&gt;
<a name="665"/>  665:     {ok, gurka} = infer_on_eq_1(id({gurka})),
<a name="666"/>  666:     {ok, gaffel} = infer_on_eq_2(id({gaffel})),
<a name="667"/>  667:     {ok, elefant} = infer_on_eq_3(id({elefant})),
<a name="668"/>  668:     {ok, myra} = infer_on_eq_4(id({myra})),
<a name="infer_on_eq-last_expr"/><a name="669"/>  669:     ok.
<a name="670"/>  670: 
<a name="infer_on_eq_1-1"/><a name="671"/>  671: <b>infer_on_eq_1</b>(T) -&gt;
<a name="672"/>  672:     1 = erlang:tuple_size(T),
<a name="infer_on_eq_1-last_expr"/><a name="673"/>  673: <b>    {ok, erlang:element</b>(1, T)}.
<a name="674"/>  674: 
<a name="infer_on_eq_2-1"/><a name="675"/>  675: <b>infer_on_eq_2</b>(T) -&gt;
<a name="676"/>  676:     Size = erlang:tuple_size(T),
<a name="677"/>  677:     Size = 1,
<a name="infer_on_eq_2-last_expr"/><a name="678"/>  678: <b>    {ok, erlang:element</b>(1, T)}.
<a name="679"/>  679: 
<a name="infer_on_eq_3-1"/><a name="680"/>  680: <b>infer_on_eq_3</b>(T) -&gt;
<a name="681"/>  681:     true = 1 =:= erlang:tuple_size(T),
<a name="infer_on_eq_3-last_expr"/><a name="682"/>  682: <b>    {ok, erlang:element</b>(1, T)}.
<a name="683"/>  683: 
<a name="infer_on_eq_4-1"/><a name="684"/>  684: <b>infer_on_eq_4</b>(T) -&gt;
<a name="685"/>  685:     true = erlang:tuple_size(T) =:= 1,
<a name="infer_on_eq_4-last_expr"/><a name="686"/>  686: <b>    {ok, erlang:element</b>(1, T)}.
<a name="687"/>  687: 
<a name="688"/>  688: <i>%% ERIERL-348; types were inferred for dead values, causing validation to fail.</i>
<a name="689"/>  689: 
<a name="690"/>  690: <b>-record</b>(idv, {key}).
<a name="691"/>  691: 
<a name="infer_dead_value-1"/><a name="692"/>  692: <b>infer_dead_value</b>(Config) when is_list(Config) -&gt;
<a name="693"/>  693:     a = idv_1({a, b, c, d, e, f, g}, {0, 0, 0, 0, 0, 0, 0}),
<a name="694"/>  694:     b = idv_1({a, b, c, d, 0, 0, 0}, {a, b, c, d, 0, 0, 0}),
<a name="695"/>  695:     c = idv_1({0, 0, 0, 0, 0, f, g}, {0, 0, 0, 0, 0, f, g}),
<a name="696"/>  696:     error = idv_1(gurka, gaffel),
<a name="697"/>  697: 
<a name="698"/>  698:     ok = idv_2(id(#idv{})),
<a name="699"/>  699: 
<a name="infer_dead_value-last_expr"/><a name="700"/>  700:     ok.
<a name="701"/>  701: 
<a name="idv_1-2"/><a name="702"/>  702: <b>idv_1</b>({_A, _B, _C, _D, _E, _F, _G},
<a name="703"/>  703:       {0, 0, 0, 0, 0, 0, 0}) -&gt;
<a name="704"/>  704:     a;
<a name="705"/>  705: <b>idv_1</b>({A, B, C, D,_E, _F, _G}=_Tuple1,
<a name="706"/>  706:       {A, B, C, D, 0, 0, 0}=_Tuple2) -&gt;
<a name="707"/>  707:     b;
<a name="708"/>  708: <b>idv_1</b>({_A, _B, _C, _D, _E, F, G},
<a name="709"/>  709:       {0, 0, 0, 0, 0, F, G}) -&gt;
<a name="710"/>  710:     c;
<a name="711"/>  711: <b>idv_1</b>(_A, _B) -&gt;
<a name="idv_1-last_expr"/><a name="712"/>  712:     error.
<a name="713"/>  713: 
<a name="714"/>  714: <i>%% ERL-998; type inference for select_val (#b_switch{}) was more clever than</i>
<a name="715"/>  715: <i>%% that for is_ne_exact (#b_br{}), sometimes failing validation when the type</i>
<a name="716"/>  716: <i>%% optimization pass acted on the former and the validator got the latter.</i>
<a name="717"/>  717: 
<a name="718"/>  718: <b>-record</b>(ion, {state}).
<a name="719"/>  719: 
<a name="infer_on_ne-1"/><a name="720"/>  720: <b>infer_on_ne</b>(Config) when is_list(Config) -&gt;
<a name="721"/>  721:     #ion{state = closing} = ion_1(#ion{ state = id(open) }),
<a name="722"/>  722:     #ion{state = closing} = ion_close(#ion{ state = open }),
<a name="infer_on_ne-last_expr"/><a name="723"/>  723:     ok.
<a name="724"/>  724: 
<a name="ion_1-1"/><a name="725"/>  725: <b>ion_1</b>(State = #ion{state = open}) -&gt; ion_2(State);
<a name="ion_1-last_expr"/><a name="726"/>  726: <b>ion_1</b>(State = #ion{state = closing}) -&gt; ion_2(State).
<a name="727"/>  727: 
<a name="ion_2-1"/><a name="728"/>  728: <b>ion_2</b>(State = #ion{state = open}) -&gt; ion_close(State);
<a name="ion_2-last_expr"/><a name="729"/>  729: <b>ion_2</b>(#ion{state = closing}) -&gt; ok.
<a name="730"/>  730: 
<a name="ion_close-1"/><a name="ion_close-last_expr"/><a name="731"/>  731: <b>ion_close</b>(State = #ion{}) -&gt; State#ion{state = closing}.
<a name="732"/>  732: 
<a name="733"/>  733: <i>%% ERL-995: The first solution to ERIERL-348 was incomplete and caused</i>
<a name="734"/>  734: <i>%% validation to fail when living values depended on delayed type inference on</i>
<a name="735"/>  735: <i>%% &quot;dead&quot; values.</i>
<a name="736"/>  736: 
<a name="idv_2-1"/><a name="737"/>  737: <b>idv_2</b>(State) -&gt;
<a name="738"/>  738:     Flag = (State#idv.key == undefined),
<a name="739"/>  739:     case id(gurka) of
<a name="740"/>  740:         {_} -&gt; id([Flag]);
<a name="741"/>  741:         _ -&gt; ok
<a name="742"/>  742:     end,
<a name="idv_2-last_expr"/><a name="743"/>  743:     if
<a name="744"/>  744:         Flag -&gt; idv_called_once(State);
<a name="745"/>  745:         true -&gt; ok
<a name="746"/>  746:     end.
<a name="747"/>  747: 
<a name="idv_called_once-1"/><a name="idv_called_once-last_expr"/><a name="748"/>  748: <b>idv_called_once</b>(_State) -&gt; ok.
<a name="749"/>  749: 
<a name="750"/>  750: <i>%% Direct jumps to try/catch handlers crash the emulator and must fail</i>
<a name="751"/>  751: <i>%% validation. This is provoked by OTP-15945.</i>
<a name="752"/>  752: 
<a name="branch_to_try_handler-1"/><a name="753"/>  753: <b>branch_to_try_handler</b>(Config) -&gt;
<a name="754"/>  754:     Errors = do_val(branch_to_try_handler, Config),
<a name="755"/>  755:     [{{branch_to_try_handler,main,1},
<a name="756"/>  756:       {{bif,tuple_size,{f,3},[{y,0}],{x,0}},
<a name="757"/>  757:        13,
<a name="758"/>  758:        {illegal_branch,try_handler,3}}}] = Errors,
<a name="branch_to_try_handler-last_expr"/><a name="759"/>  759:     ok.
<a name="760"/>  760: 
<a name="receive_marker-1"/><a name="761"/>  761: <b>receive_marker</b>(Config) when is_list(Config) -&gt;
<a name="762"/>  762:     Errors = do_val(receive_marker, Config),
<a name="763"/>  763: 
<a name="764"/>  764:     [{{receive_marker,t1,1},
<a name="765"/>  765:       {return,_,
<a name="766"/>  766:        {return_in_receive,entered_loop}}},
<a name="767"/>  767:      {{receive_marker,t2,1},
<a name="768"/>  768:       {{call_last,1,{f,2},1},_,
<a name="769"/>  769:        {return_in_receive,entered_loop}}},
<a name="770"/>  770:      {{receive_marker,t3,1},
<a name="771"/>  771:       {return,_,
<a name="772"/>  772:        {return_in_receive,entered_loop}}}] = Errors,
<a name="773"/>  773: 
<a name="receive_marker-last_expr"/><a name="774"/>  774:     ok.
<a name="775"/>  775: 
<a name="776"/>  776: <i>%% ERL-1128: the validator erroneously thought that many non-throwing</i>
<a name="777"/>  777: <i>%% instructions like is_eq_exact could throw.</i>
<a name="safe_instructions-1"/><a name="778"/>  778: <b>safe_instructions</b>(Config) when is_list(Config) -&gt;
<a name="779"/>  779:     Errors = do_val(safe_instructions, Config),
<a name="780"/>  780: 
<a name="781"/>  781:     [] = Errors,
<a name="782"/>  782: 
<a name="safe_instructions-last_expr"/><a name="783"/>  783:     ok.
<a name="784"/>  784: 
<a name="missing_return_type-1"/><a name="785"/>  785: <b>missing_return_type</b>(Config) when is_list(Config) -&gt;
<a name="786"/>  786:     %% ERL-1161: the validator didn't know that is_map_key always returns a
<a name="787"/>  787:     %% bool.
<a name="788"/>  788:     Map = #{ hello =&gt; there },
<a name="789"/>  789:     true = mrt_1(true),
<a name="790"/>  790:     false = mrt_1(false),
<a name="791"/>  791:     true = mrt_1(is_map_key(id(hello), Map)),
<a name="792"/>  792:     false = mrt_1(is_map_key(id(there), Map)),
<a name="793"/>  793: 
<a name="missing_return_type-last_expr"/><a name="794"/>  794:     ok.
<a name="795"/>  795: 
<a name="mrt_1-1"/><a name="796"/>  796: <b>mrt_1</b>(Bool) -&gt;
<a name="797"/>  797:     true = is_boolean(Bool),
<a name="mrt_1-last_expr"/><a name="798"/>  798:     Bool.
<a name="799"/>  799: 
<a name="800"/>  800: <i>%% ERL-1340: the unit of previously saved match positions wasn't updated.</i>
<a name="bs_saved_position_units-1"/><a name="801"/>  801: <b>bs_saved_position_units</b>(Config) when is_list(Config) -&gt;
<a name="802"/>  802:     M = {bs_saved_position_units,
<a name="803"/>  803:          [{no_errors,1},{some_errors,1}],
<a name="804"/>  804:          [],
<a name="805"/>  805:          [{function,ctx_test_8,1,2,
<a name="806"/>  806:               [{label,1},
<a name="807"/>  807:                {func_info,{atom,bs_saved_position_units},{atom,ctx_test_8},1},
<a name="808"/>  808:                {label,2},
<a name="809"/>  809:                {'%',
<a name="810"/>  810:                    {var_info,
<a name="811"/>  811:                        {x,0},
<a name="812"/>  812:                        [{type,{t_bs_context,8}},accepts_match_context]}},
<a name="813"/>  813:                {move,nil,{x,0}},
<a name="814"/>  814:                return]},
<a name="815"/>  815:           {function,no_errors,1,4,
<a name="816"/>  816:               [{label,3},
<a name="817"/>  817:                {func_info,{atom,bs_saved_position_units},{atom,no_errors},1},
<a name="818"/>  818:                {label,4},
<a name="819"/>  819:                {'%',{var_info,{x,0},[accepts_match_context]}},
<a name="820"/>  820:                {test,bs_start_match3,{f,3},1,[{x,0}],{x,1}},
<a name="821"/>  821:                {bs_get_position,{x,1},{x,0},2},
<a name="822"/>  822:                {test,bs_test_unit,{f,5},[{x,1},8]},
<a name="823"/>  823:                {bs_set_position,{x,1},{x,0}},
<a name="824"/>  824:                {test,bs_get_binary2,
<a name="825"/>  825:                    {f,5},
<a name="826"/>  826:                    2,
<a name="827"/>  827:                    [{x,1},{atom,all},1,{field_flags,[unsigned,big]}],
<a name="828"/>  828:                    {x,2}},
<a name="829"/>  829:                {bs_set_position,{x,1},{x,0}},
<a name="830"/>  830:                {bs_get_tail,{x,1},{x,0},3},
<a name="831"/>  831:                {test,is_eq_exact,{f,5},[{x,2},{x,0}]},
<a name="832"/>  832:                {move,{x,1},{x,0}},
<a name="833"/>  833:                %% Context unit should be 8 here.
<a name="834"/>  834:                {call_only,1,{f,2}},
<a name="835"/>  835:                {label,5},
<a name="836"/>  836:                {bs_get_tail,{x,1},{x,0},2},
<a name="837"/>  837:                {jump,{f,3}}]},
<a name="838"/>  838:           {function,some_errors,1,7,
<a name="839"/>  839:               [{label,6},
<a name="840"/>  840:                {func_info,{atom,bs_saved_position_units},{atom,some_errors},1},
<a name="841"/>  841:                {label,7},
<a name="842"/>  842:                {'%',{var_info,{x,0},[accepts_match_context]}},
<a name="843"/>  843:                {test,bs_start_match3,{f,6},1,[{x,0}],{x,1}},
<a name="844"/>  844:                {bs_get_position,{x,1},{x,0},2},
<a name="845"/>  845:                {test,bs_get_binary2,
<a name="846"/>  846:                    {f,8},
<a name="847"/>  847:                    2,
<a name="848"/>  848:                    [{x,1},{atom,all},4,{field_flags,[unsigned,big]}],
<a name="849"/>  849:                    {x,2}},
<a name="850"/>  850:                {bs_set_position,{x,1},{x,0}},
<a name="851"/>  851:                {test,bs_test_unit,{f,9},[{x,1},3]},
<a name="852"/>  852:                {bs_set_position,{x,1},{x,0}},
<a name="853"/>  853:                {bs_get_tail,{x,1},{x,0},3},
<a name="854"/>  854:                {test,is_eq_exact,{f,8},[{x,2},{x,0}]},
<a name="855"/>  855:                {move,{x,1},{x,0}},
<a name="856"/>  856:                %% Context unit should be 12 here, failing validation.
<a name="857"/>  857:                {call_only,1,{f,2}},
<a name="858"/>  858:                {label,8},
<a name="859"/>  859:                {bs_get_tail,{x,1},{x,0},2},
<a name="860"/>  860:                {jump,{f,6}},
<a name="861"/>  861:                {label,9},
<a name="862"/>  862:                %% Context unit should be 4 here.
<a name="863"/>  863:                {move,nil,{x,0}},
<a name="864"/>  864:                return]}],
<a name="865"/>  865:          10},
<a name="866"/>  866: 
<a name="867"/>  867:     Errors = beam_val(M),
<a name="868"/>  868: 
<a name="869"/>  869:     [{{bs_saved_position_units,some_errors,1},
<a name="870"/>  870:       {{call_only,1,{f,2}},
<a name="871"/>  871:        14,
<a name="872"/>  872:        {bad_arg_type,{x,0},
<a name="873"/>  873:                      {t_bs_context,12},
<a name="874"/>  874:                      {t_bs_context,8}}}}] = Errors,
<a name="875"/>  875: 
<a name="bs_saved_position_units-last_expr"/><a name="876"/>  876:     ok.
<a name="877"/>  877: 
<a name="878"/>  878: <i>%%%-------------------------------------------------------------------------</i>
<a name="879"/>  879: 
<a name="transform_remove-2"/><a name="880"/>  880: <b>transform_remove</b>(Remove, Module) -&gt;
<a name="transform_remove-last_expr"/><a name="881"/>  881: <b>    transform_is</b>(fun(Is) -&gt; [I || I &lt;- Is, not Remove(I)] end, Module).
<a name="882"/>  882: 
<a name="transform_i-2"/><a name="883"/>  883: <b>transform_i</b>(Transform, Module) -&gt;
<a name="transform_i-last_expr"/><a name="884"/>  884: <b>    transform_is</b>(fun(Is) -&gt; [Transform(I) || I &lt;- Is] end, Module).
<a name="885"/>  885: 
<a name="transform_is-2"/><a name="886"/>  886: <b>transform_is</b>(Transform, {Mod,Exp,Imp,Fs0,Lc}) -&gt;
<a name="887"/>  887:     Fs = [transform_is_1(Transform, F) || F &lt;- Fs0],
<a name="transform_is-last_expr"/><a name="888"/>  888:     {Mod,Exp,Imp,Fs,Lc}.
<a name="889"/>  889: 
<a name="transform_is_1-2"/><a name="890"/>  890: <b>transform_is_1</b>(Transform, {function,N,A,E,Is0}) -&gt;
<a name="891"/>  891:     Is = Transform(Is0),
<a name="transform_is_1-last_expr"/><a name="892"/>  892:     {function,N,A,E,Is}.
<a name="893"/>  893: 
<a name="do_val-2"/><a name="894"/>  894: <b>do_val</b>(Mod, Config) -&gt;
<a name="895"/>  895:     Data = proplists:get_value(data_dir, Config),
<a name="896"/>  896:     Base = atom_to_list(Mod),
<a name="897"/>  897:     File = filename:join(Data, Base),
<a name="do_val-last_expr"/><a name="898"/>  898: <b>    case compile:file</b>(File, [from_asm,no_postopt,return_errors]) of
<a name="899"/>  899: 	{error,L,[]} -&gt;
<a name="900"/>  900: 	    [{Base,Errors0}] = L,
<a name="901"/>  901: 	    Errors = [E || {_Pos,beam_validator,E} &lt;- Errors0],
<a name="902"/>  902: 	    _ = [io:put_chars(beam_validator:format_error(E)) ||
<a name="903"/>  903: 		    E &lt;- Errors],
<a name="904"/>  904: 	    Errors;
<a name="905"/>  905: 	{ok,Mod} -&gt;
<a name="906"/>  906: 	    []
<a name="907"/>  907:     end.
<a name="908"/>  908: 
<a name="beam_val-1"/><a name="909"/>  909: <b>beam_val</b>(M) -&gt;
<a name="910"/>  910:     Name = atom_to_list(element(1, M)),
<a name="911"/>  911:     {error,[{Name,Errors0}]} = beam_validator:validate(M, strong),
<a name="912"/>  912:     Errors = [E || {_Pos,beam_validator,E} &lt;- Errors0],
<a name="913"/>  913:     _ = [io:put_chars(beam_validator:format_error(E)) ||
<a name="914"/>  914: 	    E &lt;- Errors],
<a name="beam_val-last_expr"/><a name="915"/>  915:     Errors.
<a name="916"/>  916: 
<a name="917"/>  917: <i>%%%-------------------------------------------------------------------------</i>
<a name="918"/>  918: 
<a name="val_dsetel-1"/><a name="919"/>  919: <b>val_dsetel</b>(_Config) -&gt;
<a name="920"/>  920:     self() ! 13,
<a name="921"/>  921:     {'EXIT',{{try_clause,participating},_}} = (catch night(0)),
<a name="val_dsetel-last_expr"/><a name="922"/>  922:     ok.
<a name="923"/>  923: 
<a name="night-1"/><a name="924"/>  924: <b>night</b>(Turned) -&gt;
<a name="925"/>  925:     receive
<a name="926"/>  926: 	13 -&gt;
<a name="927"/>  927: 	    try participating of engine -&gt; 16 after false end
<a name="928"/>  928:     end,
<a name="929"/>  929:     %% The setelement/3 call is unreachable.
<a name="930"/>  930:     Turned(setelement(#{true =&gt; Turned},
<a name="931"/>  931: 		      participating(Turned, &quot;suit&quot;, 40, []),
<a name="932"/>  932: 		      Turned &lt; Turned)),
<a name="night-last_expr"/><a name="933"/>  933:     ok.
<a name="934"/>  934: 
<a name="participating-4"/><a name="participating-last_expr"/><a name="935"/>  935: <b>participating</b>(_, _, _, _) -&gt; ok.
<a name="936"/>  936: 
<a name="will_succeed-1"/><a name="937"/>  937: <b>will_succeed</b>(_Config) -&gt;
<a name="938"/>  938:     ok = will_succeed_1(body),
<a name="939"/>  939: 
<a name="940"/>  940:     self() ! whatever,
<a name="941"/>  941:     error = will_succeed_2(),
<a name="942"/>  942: 
<a name="943"/>  943:     self() ! whatever,
<a name="944"/>  944:     error = will_succeed_3(),
<a name="945"/>  945: 
<a name="will_succeed-last_expr"/><a name="946"/>  946:     ok.
<a name="947"/>  947: 
<a name="948"/>  948: <i>%% map_get was known as returning 'none', but 'will_succeed' still returned</i>
<a name="949"/>  949: <i>%% 'maybe' causing validation to continue, eventually exploding when the 'none'</i>
<a name="950"/>  950: <i>%% value was used.</i>
<a name="951"/>  951: <i>%%</i>
<a name="952"/>  952: <i>%% +no_ssa_opt</i>
<a name="will_succeed_1-1"/><a name="953"/>  953: <b>will_succeed_1</b>(body) when map_get(girl, #{friend =&gt; node()}); [], community -&gt;
<a name="954"/>  954:     case $q and $K of
<a name="955"/>  955:         _V0 -&gt;
<a name="956"/>  956:             0.1825965401179273;
<a name="957"/>  957:         0 -&gt;
<a name="958"/>  958:             state#{[] =&gt; 0.10577334580729858, $J =&gt; 0}
<a name="959"/>  959:     end;
<a name="960"/>  960: <b>will_succeed_1</b>(body) -&gt;
<a name="will_succeed_1-last_expr"/><a name="961"/>  961:     ok.
<a name="962"/>  962: 
<a name="963"/>  963: <i>%% The apply of 42:name/0 was known to fail, but 'will_succeed' still</i>
<a name="964"/>  964: <i>%% returned 'maybe', causing validation to continue and fail because</i>
<a name="965"/>  965: <i>%% of the jump to the try_case instruction.</i>
<a name="will_succeed_2-0"/><a name="966"/>  966: <b>will_succeed_2</b>() -&gt;
<a name="will_succeed_2-last_expr"/><a name="967"/>  967:     try
<a name="968"/>  968:         receive
<a name="969"/>  969:             _ -&gt;
<a name="970"/>  970:                 42
<a name="971"/>  971:         end:name()
<a name="972"/>  972:     catch
<a name="973"/>  973:         _:_ -&gt;
<a name="974"/>  974:             error
<a name="975"/>  975:     end.
<a name="976"/>  976: 
<a name="will_succeed_3-0"/><a name="977"/>  977: <b>will_succeed_3</b>() -&gt;
<a name="will_succeed_3-last_expr"/><a name="978"/>  978:     try
<a name="979"/>  979:         receive
<a name="980"/>  980:             _ -&gt;
<a name="981"/>  981:                 42
<a name="982"/>  982:         end:name(a, b)
<a name="983"/>  983:     catch
<a name="984"/>  984:         _:_ -&gt;
<a name="985"/>  985:             error
<a name="986"/>  986:     end.
<a name="987"/>  987: 
<a name="988"/>  988: <i>%% ERL-1426: When a value was extracted from a tuple, subsequent type tests did</i>
<a name="989"/>  989: <i>%% not update the type of said tuple.</i>
<a name="990"/>  990: 
<a name="991"/>  991: <b>-record</b>(pc, {a}).
<a name="992"/>  992: 
<a name="parent_container-1"/><a name="993"/>  993: <b>parent_container</b>(_Config) -&gt;
<a name="parent_container-last_expr"/><a name="994"/>  994: <b>    ok = pc_1</b>(id(#pc{a=true})).
<a name="995"/>  995: 
<a name="pc_1-1"/><a name="996"/>  996: <b>pc_1</b>(#pc{a=A}=R) -&gt;
<a name="997"/>  997:     case A of
<a name="998"/>  998:         true -&gt; ok;
<a name="999"/>  999:         false -&gt; ok
<a name="1000"/> 1000:     end,
<a name="pc_1-last_expr"/><a name="1001"/> 1001: <b>    ok = pc_2</b>(R).
<a name="1002"/> 1002: 
<a name="pc_2-1"/><a name="1003"/> 1003: <b>pc_2</b>(_R) -&gt;
<a name="pc_2-last_expr"/><a name="1004"/> 1004:     ok.
<a name="1005"/> 1005: 
<a name="1006"/> 1006: <i>%% GH-5915: The following function took an incredibly long time to validate.</i>
<a name="container_performance-1"/><a name="1007"/> 1007: <b>container_performance</b>(Config) -&gt;
<a name="container_performance-last_expr"/><a name="1008"/> 1008:     case Config of
<a name="1009"/> 1009:         ({b,_}) -&gt; {k1};
<a name="1010"/> 1010:         ({a,{b,_}}) -&gt; {k2};
<a name="1011"/> 1011:         ({a,{a,{b,_}}}) -&gt; {k3};
<a name="1012"/> 1012:         ({a,{a,{a,{b,_}}}}) -&gt; {k4};
<a name="1013"/> 1013:         ({a,{a,{a,{a,{b,_}}}}}) -&gt; {k5};
<a name="1014"/> 1014:         ({a,{a,{a,{a,{a,{b,_}}}}}}) -&gt; {k6};
<a name="1015"/> 1015:         ({a,{a,{a,{a,{a,{a,{b,_}}}}}}}) -&gt; {k7};
<a name="1016"/> 1016:         ({a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}) -&gt; {k8};
<a name="1017"/> 1017:         ({a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}) -&gt; {k9};
<a name="1018"/> 1018:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}) -&gt; {k10};
<a name="1019"/> 1019:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}) -&gt; {k11};
<a name="1020"/> 1020:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}) -&gt; {k12};
<a name="1021"/> 1021:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}) -&gt; {k13};
<a name="1022"/> 1022:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}) -&gt; {k14};
<a name="1023"/> 1023:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}) -&gt; {k15};
<a name="1024"/> 1024:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}) -&gt; {k16};
<a name="1025"/> 1025:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}) -&gt; {k17};
<a name="1026"/> 1026:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}) -&gt; {k18};
<a name="1027"/> 1027:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}) -&gt; {k19};
<a name="1028"/> 1028:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}) -&gt; {k20};
<a name="1029"/> 1029:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}) -&gt; {k21};
<a name="1030"/> 1030:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k22};
<a name="1031"/> 1031:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k23};
<a name="1032"/> 1032:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k24};
<a name="1033"/> 1033:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k25};
<a name="1034"/> 1034:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k26};
<a name="1035"/> 1035:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k27};
<a name="1036"/> 1036:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k28};
<a name="1037"/> 1037:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{b,_}}}}}}}}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k29};
<a name="1038"/> 1038:         ({a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,{a,_}}}}}}}}}}}}}}}}}}}}}}}}}}}}}) -&gt; {k30};
<a name="1039"/> 1039:         _ -&gt; ok
<a name="1040"/> 1040:     end.
<a name="1041"/> 1041: 
<a name="1042"/> 1042: <i>%% Type inference was half-broken for relational operators, being implemented</i>
<a name="1043"/> 1043: <i>%% for is_lt/is_ge instructions but not the {bif,RelOp} form.</i>
<a name="infer_relops-1"/><a name="1044"/> 1044: <b>infer_relops</b>(_Config) -&gt;
<a name="1045"/> 1045:     [lt = infer_relops_1(N) || N &lt;- lists:seq(0,3)],
<a name="1046"/> 1046:     [ge = infer_relops_1(N) || N &lt;- lists:seq(4,7)],
<a name="infer_relops-last_expr"/><a name="1047"/> 1047:     ok.
<a name="1048"/> 1048: 
<a name="infer_relops_1-1"/><a name="1049"/> 1049: <b>infer_relops_1</b>(N) -&gt;
<a name="1050"/> 1050:     true = N &gt;= 0,
<a name="1051"/> 1051:     Below4 = N &lt; 4,
<a name="1052"/> 1052:     id(N), %% Force Below4 to use the {bif,'&lt;'} form instead of is_lt
<a name="infer_relops_1-last_expr"/><a name="1053"/> 1053:     case Below4 of
<a name="1054"/> 1054:         true -&gt; infer_relops_true(Below4, N);
<a name="1055"/> 1055:         false -&gt; infer_relops_false(Below4, N)
<a name="1056"/> 1056:     end.
<a name="1057"/> 1057: 
<a name="infer_relops_true-2"/><a name="infer_relops_true-last_expr"/><a name="1058"/> 1058: <b>infer_relops_true</b>(_, _) -&gt; lt.
<a name="infer_relops_false-2"/><a name="infer_relops_false-last_expr"/><a name="1059"/> 1059: <b>infer_relops_false</b>(_, _) -&gt; ge.
<a name="1060"/> 1060: 
<a name="1061"/> 1061: <i>%% OTP-18365: A brainfart in inference for '=/=' inverted the results.</i>
<a name="not_equal_inference-1"/><a name="1062"/> 1062: <b>not_equal_inference</b>(_Config) -&gt;
<a name="1063"/> 1063:     {'EXIT', {function_clause, _}} = (catch not_equal_inference_1(id([0]))),
<a name="not_equal_inference-last_expr"/><a name="1064"/> 1064:     ok.
<a name="1065"/> 1065: 
<a name="not_equal_inference_1-1"/><a name="1066"/> 1066: <b>not_equal_inference_1</b>(X) when (X /= []) /= is_port(0 div 0) -&gt;
<a name="not_equal_inference_1-last_expr"/><a name="1067"/> 1067:     [X || _ &lt;- []].
<a name="1068"/> 1068: 
<a name="bad_bin_unit-1"/><a name="1069"/> 1069: <b>bad_bin_unit</b>(_Config) -&gt;
<a name="1070"/> 1070:     {'EXIT', {function_clause,_}} = catch bad_bin_unit_1(&lt;&lt;1:1&gt;&gt;),
<a name="1071"/> 1071:     [] = bad_bin_unit_2(),
<a name="bad_bin_unit-last_expr"/><a name="1072"/> 1072:     ok.
<a name="1073"/> 1073: 
<a name="bad_bin_unit_1-1"/><a name="1074"/> 1074: <b>bad_bin_unit_1</b>(&lt;&lt;X:((ok &gt; {&lt;&lt;(true andalso ok)&gt;&gt;}) orelse 1)&gt;&gt;) -&gt;
<a name="bad_bin_unit_1-last_expr"/><a name="1075"/> 1075:     try
<a name="1076"/> 1076:         bad_bin_unit_1_a()
<a name="1077"/> 1077:     after
<a name="1078"/> 1078:         -(X + bad_bin_unit_1_b(not ok)),
<a name="1079"/> 1079:         try
<a name="1080"/> 1080:             ok
<a name="1081"/> 1081:         catch
<a name="1082"/> 1082:             _ -&gt;
<a name="1083"/> 1083:                 ok;
<a name="1084"/> 1084:             _ -&gt;
<a name="1085"/> 1085:                 ok;
<a name="1086"/> 1086:             _ -&gt;
<a name="1087"/> 1087:                 ok;
<a name="1088"/> 1088:             _ -&gt;
<a name="1089"/> 1089:                 ok;
<a name="1090"/> 1090:             _ -&gt;
<a name="1091"/> 1091:                 ok;
<a name="1092"/> 1092:             _ -&gt;
<a name="1093"/> 1093:                 ok
<a name="1094"/> 1094:         end
<a name="1095"/> 1095:     end.
<a name="1096"/> 1096: 
<a name="bad_bin_unit_1_a-0"/><a name="bad_bin_unit_1_a-last_expr"/><a name="1097"/> 1097: <b>bad_bin_unit_1_a</b>() -&gt; ok.
<a name="bad_bin_unit_1_b-1"/><a name="bad_bin_unit_1_b-last_expr"/><a name="1098"/> 1098: <b>bad_bin_unit_1_b</b>(_) -&gt; ok.
<a name="1099"/> 1099: 
<a name="bad_bin_unit_2-0"/><a name="1100"/> 1100: <b>bad_bin_unit_2</b>() -&gt;
<a name="bad_bin_unit_2-last_expr"/><a name="1101"/> 1101:    [
<a name="1102"/> 1102:        ok
<a name="1103"/> 1103:        || &lt;&lt;X:(is_number(&lt;&lt;(&lt;&lt;(0 bxor 0)&gt;&gt;)&gt;&gt;) orelse 1)&gt;&gt; &lt;= &lt;&lt;&gt;&gt;,
<a name="1104"/> 1104:        #{X := _} &lt;- ok
<a name="1105"/> 1105:    ].
<a name="1106"/> 1106: 
<a name="1107"/> 1107: <i>%% GH-6962: Type inference with singleton types in registers was weaker than</i>
<a name="1108"/> 1108: <i>%% inference on their corresponding literals.</i>
<a name="singleton_inference-1"/><a name="1109"/> 1109: <b>singleton_inference</b>(Config) -&gt;
<a name="1110"/> 1110:     Mod = ?FUNCTION_NAME,
<a name="1111"/> 1111: 
<a name="1112"/> 1112:     Data = proplists:get_value(data_dir, Config),
<a name="1113"/> 1113:     File = filename:join(Data, &quot;singleton_inference.erl&quot;),
<a name="1114"/> 1114: 
<a name="1115"/> 1115:     {ok, Mod} = compile:file(File, [no_copt, no_bool_opt, no_ssa_opt]),
<a name="1116"/> 1116: 
<a name="1117"/> 1117:     ok = Mod:test(),
<a name="1118"/> 1118: 
<a name="singleton_inference-last_expr"/><a name="1119"/> 1119:     ok.
<a name="1120"/> 1120: 
<a name="1121"/> 1121: <i>%% GH-6969: A type was made concrete even though that added no additional</i>
<a name="1122"/> 1122: <i>%% information.</i>
<a name="inert_update_type-1"/><a name="1123"/> 1123: <b>inert_update_type</b>(_Config) -&gt;
<a name="inert_update_type-last_expr"/><a name="1124"/> 1124: <b>    hello</b>(&lt;&lt;&quot;string&quot;&gt;&gt;, id(42)).
<a name="1125"/> 1125: 
<a name="hello-2"/><a name="1126"/> 1126: <b>hello</b>(A, B) -&gt;
<a name="hello-last_expr"/><a name="1127"/> 1127: <b>    mike</b>([{sys_period, {A, B}}, {some_atom, B}]).
<a name="1128"/> 1128: 
<a name="mike-1"/><a name="mike-last_expr"/><a name="1129"/> 1129: <b>mike</b>([Head | _Rest]) -&gt; joe(Head).
<a name="1130"/> 1130: 
<a name="joe-1"/><a name="1131"/> 1131: <b>joe</b>({Name, 42}) -&gt; Name;
<a name="joe-last_expr"/><a name="1132"/> 1132: <b>joe</b>({sys_period, {A, _B}}) -&gt; {41, 42, A}.
<a name="1133"/> 1133: 
<a name="range_inference-1"/><a name="1134"/> 1134: <b>range_inference</b>(_Config) -&gt;
<a name="1135"/> 1135:     ok = range_inference_1(id(&lt;&lt;$a&gt;&gt;)),
<a name="1136"/> 1136:     ok = range_inference_1(id(&lt;&lt;0&gt;&gt;)),
<a name="1137"/> 1137:     ok = range_inference_1(id(&lt;&lt;1114111/utf8&gt;&gt;)),
<a name="1138"/> 1138: 
<a name="range_inference-last_expr"/><a name="1139"/> 1139:     ok.
<a name="1140"/> 1140: 
<a name="range_inference_1-1"/><a name="1141"/> 1141: <b>range_inference_1</b>(&lt;&lt;X/utf8&gt;&gt;) -&gt;
<a name="range_inference_1-last_expr"/><a name="1142"/> 1142: <b>    case 9223372036854775807 - abs</b>(X) of
<a name="1143"/> 1143:         Y when X &lt; Y -&gt;
<a name="1144"/> 1144:             ok;
<a name="1145"/> 1145:         9223372036854775807 -&gt;
<a name="1146"/> 1146:             ok;
<a name="1147"/> 1147:         -2147483648 -&gt;
<a name="1148"/> 1148:             ok
<a name="1149"/> 1149:     end.
<a name="1150"/> 1150: 
<a name="bif_inference-1"/><a name="1151"/> 1151: <b>bif_inference</b>(_Config) -&gt;
<a name="1152"/> 1152:     ok = bif_inference_is_bitstring(id(&lt;&lt;&gt;&gt;), id(&lt;&lt;&gt;&gt;)),
<a name="1153"/> 1153:     error = bif_inference_is_bitstring(id(a), id(a)),
<a name="1154"/> 1154: 
<a name="1155"/> 1155:     ok = bif_inference_is_function(id(fun id/1), id(fun id/1)),
<a name="1156"/> 1156:     ok = bif_inference_is_function(true, true),
<a name="1157"/> 1157:     error = bif_inference_is_function(id(fun id/1), a),
<a name="1158"/> 1158:     error = bif_inference_is_function(a, a),
<a name="1159"/> 1159: 
<a name="bif_inference-last_expr"/><a name="1160"/> 1160:     ok.
<a name="1161"/> 1161: 
<a name="bif_inference_is_bitstring-2"/><a name="1162"/> 1162: <b>bif_inference_is_bitstring</b>(A, A) when A andalso ok; is_bitstring(A) -&gt;
<a name="1163"/> 1163:     ok;
<a name="1164"/> 1164: <b>bif_inference_is_bitstring</b>(_, _) -&gt;
<a name="bif_inference_is_bitstring-last_expr"/><a name="1165"/> 1165:     error.
<a name="1166"/> 1166: 
<a name="bif_inference_is_function-2"/><a name="1167"/> 1167: <b>bif_inference_is_function</b>(A, A)  when A orelse ok; is_function(A) -&gt;
<a name="1168"/> 1168:     ok;
<a name="1169"/> 1169: <b>bif_inference_is_function</b>(_, _) -&gt;
<a name="bif_inference_is_function-last_expr"/><a name="1170"/> 1170:     error.
<a name="1171"/> 1171: 
<a name="id-1"/><a name="1172"/> 1172: <b>id</b>(I) -&gt;
<a name="id-last_expr"/><a name="1173"/> 1173:     I.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
