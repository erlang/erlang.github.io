<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/compiler/make_test_dir/compiler_test/beam_doc_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: 
<a name="2"/>    2: <b>-module</b>(beam_doc_SUITE).
<a name="3"/>    3: <b>-export</b>([all/0, groups/0, init_per_group/2, end_per_group/2, singleton_moduledoc/1, singleton_doc/1,
<a name="4"/>    4:          docmodule_with_doc_attributes/1, hide_moduledoc/1, docformat/1,
<a name="5"/>    5:          singleton_docformat/1, singleton_meta/1, slogan/1,
<a name="6"/>    6:          types_and_opaques/1, callback/1, hide_moduledoc2/1,
<a name="7"/>    7:          private_types/1, export_all/1, equiv/1, spec/1, deprecated/1, warn_missing_doc/1,
<a name="8"/>    8:          doc_with_file/1, doc_with_file_error/1, all_string_formats/1,
<a name="9"/>    9:          docs_from_ast/1, spec_switch_order/1, user_defined_type/1, skip_doc/1,
<a name="10"/>   10:          no_doc_attributes/1]).
<a name="11"/>   11: 
<a name="12"/>   12: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="13"/>   13: <b>-include_lib</b>(&quot;kernel/include/eep48.hrl&quot;).
<a name="14"/>   14: <b>-include_lib</b>(&quot;stdlib/include/assert.hrl&quot;).
<a name="15"/>   15: 
<a name="16"/>   16: <b>-define</b>(get_name(), atom_to_list(?FUNCTION_NAME)).
<a name="17"/>   17: 
<a name="all-0"/><a name="18"/>   18: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="19"/>   19:     [{group, documentation_generation_tests}, doc_with_file].
<a name="20"/>   20: 
<a name="groups-0"/><a name="21"/>   21: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="22"/>   22: <b>    [{documentation_generation_tests, [parallel], documentation_generation_tests</b>()}].
<a name="23"/>   23: 
<a name="init_per_group-2"/><a name="24"/>   24: <b>init_per_group</b>(_, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="25"/>   25:     Config.
<a name="26"/>   26: 
<a name="end_per_group-2"/><a name="27"/>   27: <b>end_per_group</b>(_, _Config) -&gt;
<a name="end_per_group-last_expr"/><a name="28"/>   28:     ok.
<a name="29"/>   29: 
<a name="documentation_generation_tests-0"/><a name="30"/>   30: <b>documentation_generation_tests</b>() -&gt;
<a name="documentation_generation_tests-last_expr"/><a name="31"/>   31:     [singleton_moduledoc,
<a name="32"/>   32:      singleton_doc,
<a name="33"/>   33:      docmodule_with_doc_attributes,
<a name="34"/>   34:      hide_moduledoc,
<a name="35"/>   35:      hide_moduledoc2,
<a name="36"/>   36:      docformat,
<a name="37"/>   37:      singleton_docformat,
<a name="38"/>   38:      singleton_meta,
<a name="39"/>   39:      slogan,
<a name="40"/>   40:      types_and_opaques,
<a name="41"/>   41:      callback,
<a name="42"/>   42:      private_types,
<a name="43"/>   43:      export_all,
<a name="44"/>   44:      equiv,
<a name="45"/>   45:      spec,
<a name="46"/>   46:      deprecated,
<a name="47"/>   47:      warn_missing_doc,
<a name="48"/>   48:      doc_with_file_error,
<a name="49"/>   49:      all_string_formats,
<a name="50"/>   50:      spec_switch_order,
<a name="51"/>   51:      docs_from_ast,
<a name="52"/>   52:      user_defined_type,
<a name="53"/>   53:      skip_doc,
<a name="54"/>   54:      no_doc_attributes
<a name="55"/>   55:     ].
<a name="56"/>   56: 
<a name="singleton_moduledoc-1"/><a name="57"/>   57: <b>singleton_moduledoc</b>(Conf) -&gt;
<a name="58"/>   58:     ModuleName = &quot;singletonmoduledoc&quot;,
<a name="59"/>   59:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="60"/>   60: 
<a name="61"/>   61:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="62"/>   62:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="63"/>   63:     {ok, {docs_v1, _,_, Mime,ModuleDoc, _,_}} = code:get_doc(ModName),
<a name="singleton_moduledoc-last_expr"/><a name="64"/>   64:     ok.
<a name="65"/>   65: 
<a name="singleton_doc-1"/><a name="66"/>   66: <b>singleton_doc</b>(Conf) -&gt;
<a name="67"/>   67:     ModuleName = &quot;singletondoc&quot;,
<a name="68"/>   68:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="69"/>   69:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="70"/>   70:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="71"/>   71:     FooDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Tests multi-clauses&quot;&gt;&gt;},
<a name="72"/>   72:     {ok, {docs_v1, 1,_, Mime, none, _,
<a name="73"/>   73:           [{{function, foo,1},_, [&lt;&lt;&quot;foo(ok)&quot;&gt;&gt;], FooDoc, _},
<a name="74"/>   74:            {{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], Doc, _}]}} = code:get_doc(ModName),
<a name="singleton_doc-last_expr"/><a name="75"/>   75:     ok.
<a name="76"/>   76: 
<a name="docmodule_with_doc_attributes-1"/><a name="77"/>   77: <b>docmodule_with_doc_attributes</b>(Conf) -&gt;
<a name="78"/>   78:     ModuleName = &quot;docmodule_with_doc_attributes&quot;,
<a name="79"/>   79:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="80"/>   80:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="81"/>   81:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="82"/>   82:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="83"/>   83:     FileDocs =  #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;# README\n\nThis is a test&quot;&gt;&gt;},
<a name="84"/>   84:     {ok, #docs_v1{ anno = ModuleAnno,
<a name="85"/>   85:                    beam_language = erlang,
<a name="86"/>   86:                    format = Mime,
<a name="87"/>   87:                    module_doc = ModuleDoc,
<a name="88"/>   88:                    metadata = #{},
<a name="89"/>   89:                    docs = Docs
<a name="90"/>   90:                  }} = code:get_doc(ModName),
<a name="91"/>   91: 
<a name="92"/>   92:     
<a name="93"/>   93:     [{{function,no_docs_multi,1},NoDocsMultiAnno,[&lt;&lt;&quot;no_docs_multi/1&quot;&gt;&gt;],none,#{}},
<a name="94"/>   94:      {{function,with_file_docs,0},FileDocsAnno, [&lt;&lt;&quot;with_file_docs()&quot;&gt;&gt;],FileDocs,#{}},
<a name="95"/>   95:      {{function,no_docs,0},NoDocsAnno, [&lt;&lt;&quot;no_docs()&quot;&gt;&gt;],none,#{}},
<a name="96"/>   96:      {{function,ok,0}, OkAnno, [&lt;&lt;&quot;ok()&quot;&gt;&gt;],none,#{authors := &quot;Someone&quot;}},
<a name="97"/>   97:      {{function, main,_},MainAnno, _, Doc, _}] = Docs,
<a name="98"/>   98:     
<a name="99"/>   99:     ?assertEqual(5, erl_anno:line(ModuleAnno)),
<a name="100"/>  100:     ?assertEqual(10, erl_anno:line(MainAnno)),
<a name="101"/>  101:     ?assertEqual(18, erl_anno:line(OkAnno)),
<a name="102"/>  102:     ?assertEqual(21, erl_anno:line(NoDocsAnno)),
<a name="103"/>  103:     ?assertEqual(1, erl_anno:line(FileDocsAnno)),
<a name="104"/>  104:     ?assertEqual(&quot;README&quot;, filename:basename(erl_anno:file(FileDocsAnno))),
<a name="105"/>  105:     ?assertEqual(28, erl_anno:line(NoDocsMultiAnno)),
<a name="106"/>  106: 
<a name="docmodule_with_doc_attributes-last_expr"/><a name="107"/>  107:     ok.
<a name="108"/>  108: 
<a name="hide_moduledoc-1"/><a name="109"/>  109: <b>hide_moduledoc</b>(Conf) -&gt;
<a name="110"/>  110:     {ok, ModName} = default_compile_file(Conf, &quot;hide_moduledoc&quot;),
<a name="111"/>  111:     {ok, {docs_v1, _,_, _Mime, hidden, _,
<a name="112"/>  112:           [{{function, main, 0}, _, [&lt;&lt;&quot;main()&quot;&gt;&gt;],
<a name="113"/>  113:             #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt; }, #{}}]}} = code:get_doc(ModName),
<a name="hide_moduledoc-last_expr"/><a name="114"/>  114:     ok.
<a name="115"/>  115: 
<a name="116"/>  116: <i>%% TODO: crashes</i>
<a name="hide_moduledoc2-1"/><a name="117"/>  117: <b>hide_moduledoc2</b>(Conf) -&gt;
<a name="118"/>  118:     ModuleName = ?get_name(),
<a name="119"/>  119:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="120"/>  120:     {ok, {docs_v1, _,_, _Mime, hidden, _,
<a name="121"/>  121:           [{{function,handle_call,1},{19,2},[&lt;&lt;&quot;handle_call/1&quot;&gt;&gt;],hidden,#{}},
<a name="122"/>  122:            {{function, main, 0}, _, [&lt;&lt;&quot;main()&quot;&gt;&gt;], hidden, #{}}]}} = code:get_doc(ModName),
<a name="hide_moduledoc2-last_expr"/><a name="123"/>  123:     ok.
<a name="124"/>  124: 
<a name="docformat-1"/><a name="125"/>  125: <b>docformat</b>(Conf) -&gt;
<a name="126"/>  126:     {ok, ModName} = default_compile_file(Conf, &quot;docformat&quot;),
<a name="127"/>  127:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="128"/>  128:     Meta = #{format =&gt; &quot;text/asciidoc&quot;,
<a name="129"/>  129:              deprecated =&gt; &quot;Use something else&quot;,
<a name="130"/>  130:              otp_doc_vsn =&gt; {1,0,0},
<a name="131"/>  131:              since =&gt; &quot;1.0&quot;},
<a name="132"/>  132:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="133"/>  133:     {ok, {docs_v1, _,_, &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;, ModuleDoc, Meta,
<a name="134"/>  134:           [{{function, main,_},_, _, Doc, _}]}} = code:get_doc(ModName),
<a name="docformat-last_expr"/><a name="135"/>  135:     ok.
<a name="136"/>  136: 
<a name="singleton_docformat-1"/><a name="137"/>  137: <b>singleton_docformat</b>(Conf) -&gt;
<a name="138"/>  138:     {ok, ModName} = default_compile_file(Conf, &quot;singleton_docformat&quot;),
<a name="139"/>  139:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="140"/>  140:     Meta = #{format =&gt; &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;,
<a name="141"/>  141:              deprecated =&gt; &quot;Use something else&quot;,
<a name="142"/>  142:              otp_doc_vsn =&gt; {1,0,0},
<a name="143"/>  143:              since =&gt; &quot;1.0&quot;},
<a name="144"/>  144:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module\n\nMore info here&quot;&gt;&gt;},
<a name="145"/>  145:     FunMeta = #{ authors =&gt; [&lt;&lt;&quot;Beep Bop&quot;&gt;&gt;], equiv =&gt; &lt;&lt;&quot;main/3&quot;&gt;&gt; },
<a name="146"/>  146:     {ok, {docs_v1, _,erlang, &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;, ModuleDoc, Meta,
<a name="147"/>  147:           [{{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], Doc, FunMeta}]}} = code:get_doc(ModName),
<a name="singleton_docformat-last_expr"/><a name="148"/>  148:     ok.
<a name="149"/>  149: 
<a name="singleton_meta-1"/><a name="150"/>  150: <b>singleton_meta</b>(Conf) -&gt;
<a name="151"/>  151:     ModuleName = ?get_name(),
<a name="152"/>  152:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="153"/>  153:     Meta = #{ authors =&gt; [&lt;&lt;&quot;Beep Bop&quot;&gt;&gt;], equiv =&gt; &lt;&lt;&quot;main/3&quot;&gt;&gt;},
<a name="154"/>  154:     DocMain1 = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Returns always ok.&quot;&gt;&gt;},
<a name="155"/>  155:     {ok, {docs_v1, _,erlang, &lt;&lt;&quot;text/markdown&quot;&gt;&gt;, none, _,
<a name="156"/>  156:           [{{function, main1,0},_, [&lt;&lt;&quot;main1()&quot;&gt;&gt;], DocMain1, #{equiv := &lt;&lt;&quot;main(_)&quot;&gt;&gt;}},
<a name="157"/>  157:            {{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], none, Meta}]}}
<a name="158"/>  158:         = code:get_doc(ModName),
<a name="singleton_meta-last_expr"/><a name="159"/>  159:     ok.
<a name="160"/>  160: 
<a name="slogan-1"/><a name="161"/>  161: <b>slogan</b>(Conf) -&gt;
<a name="162"/>  162:   ModuleName = ?get_name(),
<a name="163"/>  163:   {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="164"/>  164:   Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Returns ok.&quot;&gt;&gt;},
<a name="165"/>  165:   BarDoc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;foo()\nNot a slogan since foo =/= bar&quot;&gt;&gt; },
<a name="166"/>  166:   NoSloganDoc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Not a slogan\n\nTests slogans in multi-clause&quot;&gt;&gt;},
<a name="167"/>  167:   {ok, {docs_v1, _,_, _, none, _,
<a name="168"/>  168:           [Connect, MulticlauseSloganIgnored, SpecNoDocSlogan, NoDocSlogan,
<a name="169"/>  169:            Slogan2, Slogan1, NoSlogan, Bar, Main]}} = code:get_doc(ModName),
<a name="170"/>  170: 
<a name="171"/>  171:   {{function,connect,2},_,
<a name="172"/>  172:    [&lt;&lt;&quot;connect(TCPSocket, TLSOptions)&quot;&gt;&gt;],none,#{equiv := &lt;&lt;&quot;connect/3&quot;&gt;&gt;,since := &lt;&lt;&quot;OTP R14B&quot;&gt;&gt;}} = Connect,
<a name="173"/>  173:   {{function,spec_multiclause_slogan_ignored,1},_,[&lt;&lt;&quot;spec_multiclause_slogan_ignored(X)&quot;&gt;&gt;],none,#{}} = MulticlauseSloganIgnored,
<a name="174"/>  174:   {{function, spec_no_doc_slogan, 1}, _, [&lt;&lt;&quot;spec_no_doc_slogan(Y)&quot;&gt;&gt;], none, #{}} = SpecNoDocSlogan,
<a name="175"/>  175:   {{function, no_doc_slogan, 1}, _, [&lt;&lt;&quot;no_doc_slogan(X)&quot;&gt;&gt;], none, #{}}= NoDocSlogan,
<a name="176"/>  176:   {{function, spec_slogan, 2}, _, [&lt;&lt;&quot;spec_slogan(Y, Z)&quot;&gt;&gt;], _, #{}} = Slogan2,
<a name="177"/>  177:   {{function, spec_slogan, 1}, _, [&lt;&lt;&quot;spec_slogan(Y)&quot;&gt;&gt;], _, #{}} = Slogan1,
<a name="178"/>  178:   {{function, no_slogan,1},_,[&lt;&lt;&quot;no_slogan/1&quot;&gt;&gt;], NoSloganDoc, #{}} = NoSlogan,
<a name="179"/>  179:   {{function, bar,0},_,[&lt;&lt;&quot;bar()&quot;&gt;&gt;], BarDoc, #{}} = Bar,
<a name="180"/>  180:   {{function, main,1},_,[&lt;&lt;&quot;main(Foo)&quot;&gt;&gt;], Doc, #{}} = Main,
<a name="slogan-last_expr"/><a name="181"/>  181:   ok.
<a name="182"/>  182: 
<a name="types_and_opaques-1"/><a name="183"/>  183: <b>types_and_opaques</b>(Conf) -&gt;
<a name="184"/>  184:     ModuleName = ?get_name(),
<a name="185"/>  185:     {ok, ModName, Warnings} = default_compile_file(Conf, ModuleName, [return_warnings]),
<a name="186"/>  186:     TypeDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Represents the name of a person.&quot;&gt;&gt;},
<a name="187"/>  187:     GenericsDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Tests generics&quot;&gt;&gt;},
<a name="188"/>  188:     OpaqueDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt;
<a name="189"/>  189:                       &lt;&lt;&quot;Represents the name of a person that cannot be named.&quot;&gt;&gt;},
<a name="190"/>  190:     MaybeOpaqueDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;mmaybe(X) ::= nothing | X.\n\nRepresents a maybe type.&quot;&gt;&gt;},
<a name="191"/>  191:     MaybeMeta = #{ authors =&gt; &quot;Someone else&quot;, exported =&gt; true },
<a name="192"/>  192:     NaturalNumberMeta = #{since =&gt; &quot;1.0&quot;, equiv =&gt; &lt;&lt;&quot;non_neg_integer/0&quot;&gt;&gt;, exported =&gt; true},
<a name="193"/>  193: 
<a name="194"/>  194:     {ok, {docs_v1, _,_, _, none, _,
<a name="195"/>  195:           [%% Type Definitions
<a name="196"/>  196:            Public, Intermediate, HiddenNoWarnType, HiddenType, OtherPrivateType, MyPrivateType,
<a name="197"/>  197:            MyMap, StateEnter, CallbackMode,CallbackResult, EncodingFunc, Three,
<a name="198"/>  198:            Two, One, Hidden, HiddenFalse, MMaybe, Unnamed, Param,NatNumber, Name,
<a name="199"/>  199:            HiddenIncludedType,
<a name="200"/>  200:            %% Functions
<a name="201"/>  201:            UsesPublic, Ignore, MapFun, PrivateEncoding, Foo
<a name="202"/>  202:           ]}} = code:get_doc(ModName),
<a name="203"/>  203: 
<a name="204"/>  204:     {{type,public,0},{128,2},[&lt;&lt;&quot;public()&quot;&gt;&gt;],none,#{exported := true}} = Public,
<a name="205"/>  205:     {{type,intermediate,0},{127,2},[&lt;&lt;&quot;intermediate()&quot;&gt;&gt;],none,#{exported := false}} = Intermediate,
<a name="206"/>  206:     {{type,hidden_nowarn_type,0},{123,2},[&lt;&lt;&quot;hidden_nowarn_type()&quot;&gt;&gt;],hidden,#{exported := false}} = HiddenNoWarnType,
<a name="207"/>  207:     {{type,hidden_type,0},{120,2},[&lt;&lt;&quot;hidden_type()&quot;&gt;&gt;],hidden,#{exported := false}} = HiddenType,
<a name="208"/>  208:     {{type,my_other_private_type,0},MyOtherPrivateTypeLine,
<a name="209"/>  209:               [&lt;&lt;&quot;my_other_private_type()&quot;&gt;&gt;],none,#{exported := false}} = OtherPrivateType,
<a name="210"/>  210:     {{type,my_private_type,0},MyPrivateTypeLine,
<a name="211"/>  211:      [&lt;&lt;&quot;my_private_type()&quot;&gt;&gt;],none,#{exported := false}} = MyPrivateType,
<a name="212"/>  212:     {{type,mymap,0},MyMapLine,[&lt;&lt;&quot;mymap()&quot;&gt;&gt;],none,#{exported := false}} = MyMap,
<a name="213"/>  213:     {{type,state_enter,0},StateEnterLine,[&lt;&lt;&quot;state_enter()&quot;&gt;&gt;],none,#{exported := false}}=StateEnter,
<a name="214"/>  214:     {{type,callback_mode,0},CallbackModeLine, [&lt;&lt;&quot;callback_mode()&quot;&gt;&gt;],none,#{exported := false}} = CallbackMode,
<a name="215"/>  215:     {{type,callback_mode_result,0},CallbackResultLine,
<a name="216"/>  216:                [&lt;&lt;&quot;callback_mode_result()&quot;&gt;&gt;],none,#{exported := true}} = CallbackResult,
<a name="217"/>  217:     {{type,encoding_func,0},_,[&lt;&lt;&quot;encoding_func()&quot;&gt;&gt;],none,#{exported := false}} = EncodingFunc,
<a name="218"/>  218:     {{type,three,0},_,[&lt;&lt;&quot;three()&quot;&gt;&gt;],none,#{exported := false}} = Three,
<a name="219"/>  219:     {{type,two,0},_,[&lt;&lt;&quot;two()&quot;&gt;&gt;],none,#{exported := false}} = Two,
<a name="220"/>  220:     {{type,one,0},_,[&lt;&lt;&quot;one()&quot;&gt;&gt;],none,#{exported := false}} = One,
<a name="221"/>  221:     {{type,hidden,0},_,[&lt;&lt;&quot;hidden()&quot;&gt;&gt;],hidden,#{exported := true}} = Hidden,
<a name="222"/>  222:     {{type,hidden_false,0},_,[&lt;&lt;&quot;hidden_false()&quot;&gt;&gt;],hidden,
<a name="223"/>  223:      #{exported := true, authors := &quot;Someone else&quot;}} = HiddenFalse,
<a name="224"/>  224:     {{type, mmaybe,1},_,[&lt;&lt;&quot;mmaybe(X)&quot;&gt;&gt;], MaybeOpaqueDoc, MaybeMeta} = MMaybe,
<a name="225"/>  225:     {{type, unnamed,0},{30,2},[&lt;&lt;&quot;unnamed()&quot;&gt;&gt;], OpaqueDoc,
<a name="226"/>  226:      #{equiv := &lt;&lt;&quot;non_neg_integer()&quot;&gt;&gt;, exported := true}} = Unnamed,
<a name="227"/>  227:     {{type, param,1},_,[&lt;&lt;&quot;param(X)&quot;&gt;&gt;], GenericsDoc,
<a name="228"/>  228:      #{equiv := &lt;&lt;&quot;madeup()&quot;&gt;&gt;, exported := true}} = Param,
<a name="229"/>  229:     {{type, natural_number,0},_,[&lt;&lt;&quot;natural_number()&quot;&gt;&gt;], none, NaturalNumberMeta} = NatNumber,
<a name="230"/>  230:     {{type, name,1},_,[&lt;&lt;&quot;name(_)&quot;&gt;&gt;], TypeDoc, #{exported := true}} = Name,
<a name="231"/>  231:     {{type, hidden_included_type, 0}, _, _, hidden, #{exported := false }} = HiddenIncludedType,
<a name="232"/>  232: 
<a name="233"/>  233:     {{function,uses_public,0},{131,1},[&lt;&lt;&quot;uses_public()&quot;&gt;&gt;],none,#{}} = UsesPublic,
<a name="234"/>  234:     {{function,ignore_type_from_hidden_fun,0},_,[&lt;&lt;&quot;ignore_type_from_hidden_fun()&quot;&gt;&gt;],hidden,#{}} = Ignore,
<a name="235"/>  235:     {{function,map_fun,0},_,[&lt;&lt;&quot;map_fun()&quot;&gt;&gt;],none,#{}} = MapFun,
<a name="236"/>  236:     {{function,private_encoding_func,2},_,[&lt;&lt;&quot;private_encoding_func(Data, Options)&quot;&gt;&gt;],none,#{}} = PrivateEncoding,
<a name="237"/>  237:     {{function,foo,0},_,[&lt;&lt;&quot;foo()&quot;&gt;&gt;],none,#{}} = Foo,
<a name="238"/>  238: 
<a name="239"/>  239:     ?assertEqual(106, erl_anno:line(MyOtherPrivateTypeLine)),
<a name="240"/>  240:     ?assertEqual(105, erl_anno:line(MyPrivateTypeLine)),
<a name="241"/>  241:     ?assertEqual(102, erl_anno:line(MyMapLine)),
<a name="242"/>  242:     ?assertEqual(99, erl_anno:line(StateEnterLine)),
<a name="243"/>  243:     ?assertEqual(98, erl_anno:line(CallbackModeLine)),
<a name="244"/>  244:     ?assertEqual(96, erl_anno:line(CallbackResultLine)),
<a name="245"/>  245: 
<a name="246"/>  246:     [{File, Ws}, {HrlFile, HrlWs}] = Warnings,
<a name="247"/>  247:     ?assertEqual(&quot;types_and_opaques.erl&quot;, filename:basename(File)),
<a name="248"/>  248:     ?assertEqual({{120,2}, beam_doc,
<a name="249"/>  249:                   {hidden_type_used_in_exported_fun,{hidden_type,0}}}, lists:nth(4, Ws)),
<a name="250"/>  250: 
<a name="251"/>  251:     ?assertEqual(&quot;types_and_opaques.hrl&quot;, filename:basename(HrlFile)),
<a name="252"/>  252:     ?assertEqual({{1,2}, beam_doc,
<a name="253"/>  253:                   {hidden_type_used_in_exported_fun,{hidden_included_type,0}}}, lists:nth(1, HrlWs)),
<a name="254"/>  254: 
<a name="255"/>  255:     {ok, ModName, [_]} =
<a name="256"/>  256:         default_compile_file(Conf, ModuleName, [return_warnings, nowarn_hidden_doc, nowarn_unused_type]),
<a name="257"/>  257: 
<a name="types_and_opaques-last_expr"/><a name="258"/>  258:     ok.
<a name="259"/>  259: 
<a name="callback-1"/><a name="260"/>  260: <b>callback</b>(Conf) -&gt;
<a name="261"/>  261:     ModuleName = ?get_name(),
<a name="262"/>  262:     {ok, ModName, [{File,Warnings}]} =
<a name="263"/>  263:         default_compile_file(Conf, ModuleName, [return_warnings, report]),
<a name="264"/>  264:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Callback fn that always returns ok.&quot;&gt;&gt;},
<a name="265"/>  265:     ImpCallback = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;This is a test&quot;&gt;&gt;},
<a name="266"/>  266:     FunctionDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;all_ok()\n\nCalls all_ok/0&quot;&gt;&gt;},
<a name="267"/>  267:     ChangeOrder = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Test changing order&quot;&gt;&gt;},
<a name="268"/>  268:     {ok, {docs_v1, _,_, _, none, _,
<a name="269"/>  269:           [{{callback,nowarn,1},{39,2},[&lt;&lt;&quot;nowarn(Arg)&quot;&gt;&gt;],hidden,#{}},
<a name="270"/>  270:            {{callback,warn,0},{36,2},[&lt;&lt;&quot;warn()&quot;&gt;&gt;],hidden,#{}},
<a name="271"/>  271:            {{callback,bounded,1},_,[&lt;&lt;&quot;bounded(X)&quot;&gt;&gt;],none,#{}},
<a name="272"/>  272:            {{callback,multi,1},_,[&lt;&lt;&quot;multi(Argument)&quot;&gt;&gt;],
<a name="273"/>  273:             #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;A multiclause callback with slogan docs&quot;&gt;&gt; },#{}},
<a name="274"/>  274:            {{callback,multi_no_slogan,1},_,[&lt;&lt;&quot;multi_no_slogan/1&quot;&gt;&gt;],none,#{}},
<a name="275"/>  275:            {{callback,ann,1},_,[&lt;&lt;&quot;ann(X)&quot;&gt;&gt;],none,#{}},
<a name="276"/>  276:            {{callback,param,1},_,[&lt;&lt;&quot;param(X)&quot;&gt;&gt;],none,#{}},
<a name="277"/>  277:            {{callback, change_order,0},_,[&lt;&lt;&quot;change_order()&quot;&gt;&gt;], ChangeOrder,
<a name="278"/>  278:             #{equiv := &lt;&lt;&quot;ok()&quot;&gt;&gt;}},
<a name="279"/>  279:            {{callback, all_ok,0},_,[&lt;&lt;&quot;all_ok()&quot;&gt;&gt;], Doc, #{}},
<a name="280"/>  280:            {{function, main2,0},_,[&lt;&lt;&quot;main2()&quot;&gt;&gt;], #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Second main&quot;&gt;&gt;},
<a name="281"/>  281:             #{equiv := &lt;&lt;&quot;main()&quot;&gt;&gt;}},
<a name="282"/>  282:            {{function, main,0},_,[&lt;&lt;&quot;main()&quot;&gt;&gt;], FunctionDoc, #{}},
<a name="283"/>  283:            {{function, all_ok,0},_, [&lt;&lt;&quot;all_ok()&quot;&gt;&gt;],ImpCallback,
<a name="284"/>  284:             #{equiv := &lt;&lt;&quot;ok/0&quot;&gt;&gt;}}
<a name="285"/>  285:           ]}} = code:get_doc(ModName),
<a name="286"/>  286: 
<a name="287"/>  287:     ?assertEqual(&quot;callback.erl&quot;, filename:basename(File)),
<a name="288"/>  288:     io:format(&quot;Warnings: ~p~n&quot;, [Warnings]),
<a name="289"/>  289:     ?assertEqual(1, length(Warnings)),
<a name="290"/>  290:     ?assertMatch({{36,2},beam_doc,{hidden_callback,{warn,0}}}, lists:nth(1, Warnings)),
<a name="291"/>  291: 
<a name="292"/>  292:     {ok, ModName, []} =
<a name="293"/>  293:         default_compile_file(Conf, ModuleName, [return_warnings, report, nowarn_hidden_doc]),
<a name="294"/>  294: 
<a name="callback-last_expr"/><a name="295"/>  295:     ok.
<a name="296"/>  296: 
<a name="private_types-1"/><a name="297"/>  297: <b>private_types</b>(Conf) -&gt;
<a name="298"/>  298:     ModuleName = ?get_name(),
<a name="299"/>  299:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="300"/>  300: 
<a name="301"/>  301:     {ok, {docs_v1, _,_, _, none, _,
<a name="302"/>  302:           [
<a name="303"/>  303:            %% Types
<a name="304"/>  304:            RemoteTypeT, TupleT, RecordAT, RecordInlineT,
<a name="305"/>  305:            MapValue2T, MapKey2T, MapValueT, MapKeyT,
<a name="306"/>  306:            FunRet2T, FunRetT, FunT, Complex, BoundedRetT,
<a name="307"/>  307:            ArgT, BoundedArgT, Private, HiddenExportT, PrivateCBT,
<a name="308"/>  308:            OpaqueT, PublicT, PrivateT,
<a name="309"/>  309:            %% Callbacks
<a name="310"/>  310:            CBar,
<a name="311"/>  311:            %% Functions
<a name="312"/>  312:            Bounded, HiddenTypeExposed, Hidden, Bar]}} = code:get_doc(ModName),
<a name="313"/>  313: 
<a name="314"/>  314:     ?assertMatch({{type,remote_type_t,1}, _, _, none, #{exported := false}},RemoteTypeT),
<a name="315"/>  315:     ?assertMatch({{type,tuple_t,0}, _, _, none, #{exported := false}},TupleT),
<a name="316"/>  316:     ?assertMatch({{type,record_a_t,0}, _, _, none, #{exported := false}},RecordAT),
<a name="317"/>  317:     ?assertMatch({{type,record_inline_t,0}, _, _, none, #{exported := false}},RecordInlineT),
<a name="318"/>  318:     ?assertMatch({{type,map_value_2_t,0}, _, _, none, #{exported := false}},MapValue2T),
<a name="319"/>  319:     ?assertMatch({{type,map_key_2_t,0}, _, _, none, #{exported := false}},MapKey2T),
<a name="320"/>  320:     ?assertMatch({{type,map_value_t,0}, _, _, none, #{exported := false}},MapValueT),
<a name="321"/>  321:     ?assertMatch({{type,map_key_t,0}, _, _, none, #{exported := false}},MapKeyT),
<a name="322"/>  322:     ?assertMatch({{type,fun_ret_2_t,0}, _, _, none, #{exported := false}},FunRet2T),
<a name="323"/>  323:     ?assertMatch({{type,fun_ret_t,0}, _, _, none, #{exported := false}},FunRetT),
<a name="324"/>  324:     ?assertMatch({{type,fun_t,0}, _, _, none, #{exported := false}},FunT),
<a name="325"/>  325:     ?assertMatch({{type,complex,1}, _, _, none, #{exported := true}},Complex),
<a name="326"/>  326:     ?assertMatch({{type,bounded_ret_t,0}, _, _, none, #{exported := false}},BoundedRetT),
<a name="327"/>  327:     ?assertMatch({{type,arg_t,0}, _, _, none, #{exported := false}},ArgT),
<a name="328"/>  328:     ?assertMatch({{type,bounded_arg_t,0}, _, _, none, #{exported := false}},BoundedArgT),
<a name="329"/>  329:     ?assertMatch({{type,private,0}, {30,2}, [&lt;&lt;&quot;private()&quot;&gt;&gt;], hidden, #{exported := false}},Private),
<a name="330"/>  330:     ?assertMatch({{type,hidden_export_t,0},_,[&lt;&lt;&quot;hidden_export_t()&quot;&gt;&gt;],hidden,#{exported := true}},HiddenExportT),
<a name="331"/>  331:     ?assertMatch({{type,private_cb_t,0},_,_,none,#{exported := false}},PrivateCBT),
<a name="332"/>  332:     ?assertMatch({{type,opaque_t,0},_, [&lt;&lt;&quot;opaque_t()&quot;&gt;&gt;], none,#{ exported := true}},OpaqueT),
<a name="333"/>  333:     ?assertMatch({{type,public_t,0},_, [&lt;&lt;&quot;public_t()&quot;&gt;&gt;], none,#{ exported := true}},PublicT),
<a name="334"/>  334:     ?assertMatch({{type,private_t,0},_, [&lt;&lt;&quot;private_t()&quot;&gt;&gt;], none,#{ exported := false}},PrivateT),
<a name="335"/>  335:     ?assertMatch({{callback,bar,1},_,_,none,#{}},CBar),
<a name="336"/>  336:     ?assertMatch({{function,bounded,2},_,_,none,#{}},Bounded),
<a name="337"/>  337:     ?assertMatch({{function,hidden_type_exposed,0},{34,1},[&lt;&lt;&quot;hidden_type_exposed()&quot;&gt;&gt;],none,#{}},HiddenTypeExposed),
<a name="338"/>  338:     ?assertMatch({{function,hidden,0},_,[&lt;&lt;&quot;hidden()&quot;&gt;&gt;],hidden,#{}},Hidden),
<a name="339"/>  339:     ?assertMatch({{function,bar,0},_,[&lt;&lt;&quot;bar()&quot;&gt;&gt;],none,#{}},Bar),
<a name="340"/>  340: 
<a name="private_types-last_expr"/><a name="341"/>  341:     ok.
<a name="342"/>  342: 
<a name="343"/>  343: 
<a name="export_all-1"/><a name="344"/>  344: <b>export_all</b>(Conf) -&gt;
<a name="345"/>  345:     ModuleName = ?get_name(),
<a name="346"/>  346:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="347"/>  347:     ImpCallback = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;This is a test&quot;&gt;&gt;},
<a name="348"/>  348:     FunctionDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;all_ok()\n\nCalls all_ok/0&quot;&gt;&gt;},
<a name="349"/>  349:     {ok, {docs_v1, _,_, _, none, _,
<a name="350"/>  350:           [{{function, main2,0},_,[&lt;&lt;&quot;main2()&quot;&gt;&gt;], #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Second main&quot;&gt;&gt;},
<a name="351"/>  351:             #{equiv := &lt;&lt;&quot;main()&quot;&gt;&gt;}},
<a name="352"/>  352:            {{function, main,0},_,[&lt;&lt;&quot;main()&quot;&gt;&gt;], FunctionDoc, #{}},
<a name="353"/>  353:            {{function, all_ok,0},_, [&lt;&lt;&quot;all_ok()&quot;&gt;&gt;],ImpCallback,
<a name="354"/>  354:             #{equiv := &lt;&lt;&quot;ok/0&quot;&gt;&gt;}}
<a name="355"/>  355:           ]}} = code:get_doc(ModName),
<a name="export_all-last_expr"/><a name="356"/>  356:     ok.
<a name="357"/>  357: 
<a name="equiv-1"/><a name="358"/>  358: <b>equiv</b>(Conf) -&gt;
<a name="359"/>  359:     ModuleName = ?get_name(),
<a name="360"/>  360:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="361"/>  361:     {ok, {docs_v1, _,_, _, none, _,
<a name="362"/>  362:           [{{function, main, 2},_,[&lt;&lt;&quot;main(A, B)&quot;&gt;&gt;], none,
<a name="363"/>  363:             #{ }},
<a name="364"/>  364:             {{function, main, 1},_,[&lt;&lt;&quot;main(A)&quot;&gt;&gt;], none,
<a name="365"/>  365:              #{ equiv := &lt;&lt;&quot;main(A, 1)&quot;&gt;&gt; }}
<a name="366"/>  366:           ]}} = code:get_doc(ModName),
<a name="equiv-last_expr"/><a name="367"/>  367:     ok.
<a name="368"/>  368: 
<a name="spec-1"/><a name="369"/>  369: <b>spec</b>(Conf) -&gt;
<a name="370"/>  370:     ModuleName = ?get_name(),
<a name="371"/>  371:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="372"/>  372:     {ok, {docs_v1, _,_, _, #{ ~&quot;en&quot; := ~&quot;&quot; }, _,
<a name="373"/>  373:           [{{type,no,0},_,[&lt;&lt;&quot;no()&quot;&gt;&gt;],none,#{exported := false}},
<a name="374"/>  374:            {{type,yes,0},_,[&lt;&lt;&quot;yes()&quot;&gt;&gt;],none,#{exported := false}},
<a name="375"/>  375:            {{callback,me,1},_,[&lt;&lt;&quot;me/1&quot;&gt;&gt;],none,#{}},
<a name="376"/>  376:            {{function,baz,1},_,[&lt;&lt;&quot;baz(X)&quot;&gt;&gt;],none,#{}},
<a name="377"/>  377:            {{function,foo,1},_,[&lt;&lt;&quot;foo(X)&quot;&gt;&gt;],none,#{}}]}} = code:get_doc(ModName),
<a name="spec-last_expr"/><a name="378"/>  378:     ok.
<a name="379"/>  379: 
<a name="user_defined_type-1"/><a name="380"/>  380: <b>user_defined_type</b>(Conf) -&gt;
<a name="381"/>  381:     ModuleName = ?get_name(),
<a name="382"/>  382:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="383"/>  383:     {ok, {docs_v1, _,_, _, #{ ~&quot;en&quot; := ~&quot;&quot; }, _, []}} = code:get_doc(ModName),
<a name="user_defined_type-last_expr"/><a name="384"/>  384:     ok.
<a name="385"/>  385: 
<a name="deprecated-1"/><a name="386"/>  386: <b>deprecated</b>(Conf) -&gt;
<a name="387"/>  387:     ModuleName = ?get_name(),
<a name="388"/>  388:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="389"/>  389:     {ok, {docs_v1, _,_, _, none, _,
<a name="390"/>  390:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; Deprecation reason&quot;&gt;&gt;}},
<a name="391"/>  391:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="392"/>  392:            {{callback,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the callback deprecated:test(_) is deprecated; Deprecation reason&quot;&gt;&gt;}},
<a name="393"/>  393:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="394"/>  394:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="395"/>  395:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; Deprecation reason&quot;&gt;&gt;}},
<a name="396"/>  396:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="397"/>  397:         code:get_doc(ModName),
<a name="398"/>  398: 
<a name="399"/>  399:     {ok, ModName} = default_compile_file(Conf, ModuleName, [{d,'TEST_WILDCARD'},
<a name="400"/>  400:                                                             {d, 'REASON', next_major_release}]),
<a name="401"/>  401:     {ok, {docs_v1, _,_, _, none, _,
<a name="402"/>  402:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="403"/>  403:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="404"/>  404:            {{callback,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the callback deprecated:test(_) is deprecated; will be removed in the next major release. See the documentation for details&quot;&gt;&gt;}},
<a name="405"/>  405:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="406"/>  406:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="407"/>  407:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; will be removed in the next major release. See the documentation for details&quot;&gt;&gt;}},
<a name="408"/>  408:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="409"/>  409:         code:get_doc(ModName),
<a name="410"/>  410: 
<a name="411"/>  411:     {ok, ModName} = default_compile_file(Conf, ModuleName, [{d,'ALL_WILDCARD'},
<a name="412"/>  412:                                                             {d,'REASON',next_version},
<a name="413"/>  413:                                                             {d,'TREASON',eventually}]),
<a name="414"/>  414:     {ok, {docs_v1, _,_, _, none, _,
<a name="415"/>  415:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; will be removed in a future release. See the documentation for details&quot;&gt;&gt;}},
<a name="416"/>  416:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="417"/>  417:            {{callback,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the callback deprecated:test(_) is deprecated; will be removed in the next version. See the documentation for details&quot;&gt;&gt;}},
<a name="418"/>  418:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="419"/>  419:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="420"/>  420:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; will be removed in the next version. See the documentation for details&quot;&gt;&gt;}},
<a name="421"/>  421:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="422"/>  422:         code:get_doc(ModName),
<a name="deprecated-last_expr"/><a name="423"/>  423:     ok.
<a name="424"/>  424: 
<a name="warn_missing_doc-1"/><a name="425"/>  425: <b>warn_missing_doc</b>(Conf) -&gt;
<a name="426"/>  426: 
<a name="427"/>  427:     warn_missing_doc(Conf, [function, type, callback], [warn_missing_doc]),
<a name="428"/>  428:     warn_missing_doc(Conf, [function], [warn_missing_doc_functions]),
<a name="429"/>  429:     warn_missing_doc(Conf, [function, type], [warn_missing_doc_functions, warn_missing_doc_types]),
<a name="430"/>  430:     warn_missing_doc(Conf, [type, callback], [warn_missing_doc_types, warn_missing_doc_callbacks]),
<a name="431"/>  431:     warn_missing_doc(Conf, [callback], [warn_missing_doc_callbacks]),
<a name="432"/>  432: 
<a name="433"/>  433:     warn_missing_doc(Conf, [type, callback], [warn_missing_doc, nowarn_missing_doc_functions]),
<a name="434"/>  434:     warn_missing_doc(Conf, [function, callback], [warn_missing_doc, nowarn_missing_doc_types]),
<a name="435"/>  435:     warn_missing_doc(Conf, [type], [warn_missing_doc, nowarn_missing_doc_callbacks, nowarn_missing_doc_functions]),
<a name="436"/>  436:     warn_missing_doc(Conf, [], [warn_missing_doc_functions, nowarn_missing_doc]),
<a name="437"/>  437: 
<a name="warn_missing_doc-last_expr"/><a name="438"/>  438:     ok.
<a name="439"/>  439: 
<a name="warn_missing_doc-3"/><a name="440"/>  440: <b>warn_missing_doc</b>(Conf, ExpectedWarnings, Options) -&gt;
<a name="441"/>  441:     ModuleName = ?get_name(),
<a name="442"/>  442:     {ok, ModName, Ws} =
<a name="443"/>  443:         default_compile_file(Conf, ModuleName, [return_warnings, report | Options]),
<a name="444"/>  444: 
<a name="445"/>  445:     {ok, {docs_v1, _,_, _, none, _,
<a name="446"/>  446:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,_},
<a name="447"/>  447:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="448"/>  448:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="449"/>  449:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,_},
<a name="450"/>  450:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="451"/>  451:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,_}]}
<a name="452"/>  452:     } = code:get_doc(ModName),
<a name="453"/>  453: 
<a name="warn_missing_doc-last_expr"/><a name="454"/>  454:     case ExpectedWarnings of
<a name="455"/>  455:         [] -&gt;
<a name="456"/>  456:             ?assertEqual([],Ws);
<a name="457"/>  457:         _ -&gt;
<a name="458"/>  458:             [{File,Warnings} | Hrl] = Ws,
<a name="459"/>  459:             ExpectedWarningCount = 1 + lists:sum(
<a name="460"/>  460:                                          lists:flatten(
<a name="461"/>  461:                                            [[2 || lists:member(type, ExpectedWarnings)],
<a name="462"/>  462:                                             [1 || lists:member(callback, ExpectedWarnings)],
<a name="463"/>  463:                                             [2 || lists:member(function, ExpectedWarnings)]])),
<a name="464"/>  464: 
<a name="465"/>  465:             ?assertEqual(&quot;warn_missing_doc.erl&quot;, filename:basename(File)),
<a name="466"/>  466:             ?assertEqual(ExpectedWarningCount, length(Warnings)),
<a name="467"/>  467:             ?assertMatch({1, beam_doc, missing_moduledoc}, lists:nth(1, Warnings)),
<a name="468"/>  468:             TypePos =
<a name="469"/>  469:                 case lists:member(type, ExpectedWarnings) of
<a name="470"/>  470:                     true -&gt;
<a name="471"/>  471:                         ?assertMatch({{6,2}, beam_doc, {missing_doc, {type,test,0}}}, lists:nth(2, Warnings)),
<a name="472"/>  472:                         ?assertMatch({{7,2}, beam_doc, {missing_doc, {type,test,1}}}, lists:nth(3, Warnings)),
<a name="473"/>  473:                         4;
<a name="474"/>  474:                     false -&gt;
<a name="475"/>  475:                         2
<a name="476"/>  476:                 end,
<a name="477"/>  477: 
<a name="478"/>  478:             CBPos =
<a name="479"/>  479:                 case lists:member(callback, ExpectedWarnings) of
<a name="480"/>  480:                     true -&gt;
<a name="481"/>  481:                         ?assertMatch({{9,2}, beam_doc, {missing_doc, {callback,test,0}}}, lists:nth(TypePos, Warnings)),
<a name="482"/>  482:                         TypePos + 1;
<a name="483"/>  483:                     false -&gt;
<a name="484"/>  484:                         TypePos
<a name="485"/>  485:                 end,
<a name="486"/>  486: 
<a name="487"/>  487:             case lists:member(function, ExpectedWarnings) of
<a name="488"/>  488:                 true -&gt;
<a name="489"/>  489:                     ?assertMatch({{13,1}, beam_doc, {missing_doc, {function,test,0}}}, lists:nth(CBPos, Warnings)),
<a name="490"/>  490:                     ?assertMatch({{14,1}, beam_doc, {missing_doc, {function,test,1}}}, lists:nth(CBPos+1, Warnings)),
<a name="491"/>  491:                     [{HrlFile, HrlWarnings}] = Hrl,
<a name="492"/>  492:                     ?assertEqual(&quot;warn_missing_doc.hrl&quot;, filename:basename(HrlFile)),
<a name="493"/>  493:                     ?assertEqual(1, length(HrlWarnings)),
<a name="494"/>  494:                     ?assertMatch({{2,1}, beam_doc, {missing_doc, {function,test,2}}}, lists:nth(1, HrlWarnings));
<a name="495"/>  495:                 false -&gt;
<a name="496"/>  496:                     ok
<a name="497"/>  497:             end
<a name="498"/>  498:     end.
<a name="499"/>  499: 
<a name="doc_with_file-1"/><a name="500"/>  500: <b>doc_with_file</b>(Conf) -&gt;
<a name="501"/>  501:     ModuleName = ?get_name(),
<a name="502"/>  502:     {ok, Cwd} = file:get_cwd(),
<a name="doc_with_file-last_expr"/><a name="503"/>  503:     try
<a name="504"/>  504:         ok = file:set_cwd(proplists:get_value(data_dir, Conf)),
<a name="505"/>  505:         {ok, ModName} = default_compile_file(Conf, ModuleName, [{i, &quot;./folder&quot;}]),
<a name="506"/>  506:         {ok, {docs_v1, ModuleAnno,_, _, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# README\n\nThis is a test&quot;&gt;&gt;}, _,
<a name="507"/>  507:               [{{type,bar,1},_,[&lt;&lt;&quot;bar(X)&quot;&gt;&gt;],none,#{exported := false}},
<a name="508"/>  508:                {{type,foo,1},_,[&lt;&lt;&quot;foo(X)&quot;&gt;&gt;],none,#{exported := true}},
<a name="509"/>  509:                {{type,private_type_exported,0},_,[&lt;&lt;&quot;private_type_exported()&quot;&gt;&gt;],
<a name="510"/>  510:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# TYPES\n\nTest&quot;&gt;&gt;}, #{exported := false}},
<a name="511"/>  511:                {{function,main2,1},Main2Anno,[&lt;&lt;&quot;main2(I)&quot;&gt;&gt;],
<a name="512"/>  512:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# File\n\ntesting fetching docs from other folders&quot;&gt;&gt;}, #{}},
<a name="513"/>  513:                {{function,main,1},_,[&lt;&lt;&quot;main(Var)&quot;&gt;&gt;],
<a name="514"/>  514:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# Fun\n\nTest importing function&quot;&gt;&gt;},#{}}]}} = code:get_doc(ModName),
<a name="515"/>  515: 
<a name="516"/>  516:         ?assertEqual(1, erl_anno:line(ModuleAnno)),
<a name="517"/>  517:         ?assertEqual(1, erl_anno:line(Main2Anno)),
<a name="518"/>  518:         ?assertEqual(&quot;./folder/FILE&quot;, erl_anno:file(Main2Anno)),
<a name="519"/>  519:         ok
<a name="520"/>  520:     after
<a name="521"/>  521:         ok = file:set_cwd(Cwd)
<a name="522"/>  522:     end.
<a name="523"/>  523: 
<a name="doc_with_file_error-1"/><a name="524"/>  524: <b>doc_with_file_error</b>(Conf) -&gt;
<a name="525"/>  525:     ModuleName = ?get_name(),
<a name="526"/>  526:     {error,
<a name="527"/>  527:      [{_,
<a name="528"/>  528:        [{{6,2},epp,{moduledoc,file,&quot;doesnotexist&quot;}},
<a name="529"/>  529:         {{8,2},epp,{doc,file,&quot;doesnotexist&quot;}},
<a name="530"/>  530:         {{11,2},epp,{doc,file,&quot;doesnotexist&quot;}}]}] = Errors, []} = default_compile_file(Conf, ModuleName),
<a name="531"/>  531:     [[Mod:format_error(Error) || {_Loc, Mod, Error} &lt;- Errs] || {_File, Errs} &lt;- Errors],
<a name="532"/>  532:     {error, _, []} = default_compile_file(Conf, ModuleName, [report]),
<a name="doc_with_file_error-last_expr"/><a name="533"/>  533:     ok.
<a name="534"/>  534: 
<a name="all_string_formats-1"/><a name="535"/>  535: <b>all_string_formats</b>(Conf) -&gt;
<a name="536"/>  536:     ModuleName = ?get_name(),
<a name="537"/>  537:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="538"/>  538: 
<a name="539"/>  539:     {ok, {docs_v1, _ModuleAnno,_, _, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;}, _,
<a name="540"/>  540:               [
<a name="541"/>  541:                {{function,six,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;all_string_formats-all_string_formats&quot;&gt;&gt;}, #{}},
<a name="542"/>  542:                {{function,five,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;all_string_formats-Doc module&quot;&gt;&gt;}, #{}},
<a name="543"/>  543:                {{function,four,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test m√∂dule&quot;/utf8&gt;&gt;}, #{}},
<a name="544"/>  544:                {{function,three,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doctestmodule&quot;&gt;&gt;}, #{}},
<a name="545"/>  545:                {{function,two,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt;}, #{}},
<a name="546"/>  546:                {{function,one,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt;}, #{}}
<a name="547"/>  547:               ]}} = code:get_doc(ModName),
<a name="all_string_formats-last_expr"/><a name="548"/>  548:     ok.
<a name="549"/>  549: 
<a name="spec_switch_order-1"/><a name="550"/>  550: <b>spec_switch_order</b>(Conf) -&gt;
<a name="551"/>  551:   ModuleName = ?get_name(),
<a name="552"/>  552:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="553"/>  553: 
<a name="554"/>  554:     {ok, {docs_v1, _ModuleAnno,_, _, _, _,
<a name="555"/>  555:           [NotFalse, Other, Bar, Foo]}} = code:get_doc(ModName),
<a name="556"/>  556:   {{function,not_false,0}, {53,1}, [&lt;&lt;&quot;not_false()&quot;&gt;&gt;], none,#{}} = NotFalse,
<a name="557"/>  557:   {{function,other,0},{37,2},[&lt;&lt;&quot;other()&quot;&gt;&gt;],hidden,#{}} = Other,
<a name="558"/>  558:   {{function,bar,1},{31,2},[&lt;&lt;&quot;bar(X)&quot;&gt;&gt;],hidden,#{}} = Bar,
<a name="spec_switch_order-last_expr"/><a name="559"/>  559: <b>  {{function,foo,1}, {23, 2}, [&lt;&lt;&quot;foo</b>(Var)&quot;&gt;&gt;], #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Foo does X&quot;&gt;&gt; }, #{}} = Foo.
<a name="560"/>  560: 
<a name="skip_doc-1"/><a name="561"/>  561: <b>skip_doc</b>(Conf) -&gt;
<a name="562"/>  562:   ModuleName =?get_name(),
<a name="563"/>  563:   {ok, ModName} = default_compile_file(Conf, ModuleName, [no_docs]),
<a name="564"/>  564: 
<a name="565"/>  565:   {ok,{docs_v1,0,erlang,&lt;&lt;&quot;application/erlang+html&quot;&gt;&gt;,none,
<a name="566"/>  566:      #{generated := true,
<a name="567"/>  567:        otp_doc_vsn := {1,0,0}},
<a name="568"/>  568:        [{{function,main,0},{8,1},[&lt;&lt;&quot;main/0&quot;&gt;&gt;],none,#{}},
<a name="569"/>  569:         {{function,foo,1},{16,1},[&lt;&lt;&quot;foo/1&quot;&gt;&gt;],none,#{}}]}} = code:get_doc(ModName),
<a name="570"/>  570: 
<a name="571"/>  571:   {error, missing} =
<a name="572"/>  572:       code:get_doc(ModName, #{ sources =&gt; [eep48] }),
<a name="573"/>  573: 
<a name="574"/>  574:   {ok, _ModName} = compile_file(Conf, ModuleName, [report, return_errors, no_docs]),
<a name="575"/>  575:   {error, missing} = code:get_doc(ModName),
<a name="skip_doc-last_expr"/><a name="576"/>  576:   ok.
<a name="577"/>  577: 
<a name="no_doc_attributes-1"/><a name="578"/>  578: <b>no_doc_attributes</b>(Conf) -&gt;
<a name="579"/>  579:   ModuleName =?get_name(),
<a name="580"/>  580:   {ok, ModName} = default_compile_file(Conf, ModuleName, []),
<a name="581"/>  581: 
<a name="582"/>  582:   {error, missing} =
<a name="583"/>  583:       code:get_doc(ModName, #{ sources =&gt; [eep48] }),
<a name="584"/>  584: 
<a name="no_doc_attributes-last_expr"/><a name="585"/>  585:   ok.
<a name="586"/>  586: 
<a name="docs_from_ast-1"/><a name="587"/>  587: <b>docs_from_ast</b>(_Conf) -&gt;
<a name="588"/>  588:     Code = &quot;&quot;&quot;
<a name="589"/>  589:       -module(test).
<a name="590"/>  590:       -moduledoc &quot;moduledoc&quot;.
<a name="591"/>  591:       -export([main/0]).
<a name="592"/>  592:       -doc &quot;main&quot;.
<a name="593"/>  593:       main() -&gt; ok.
<a name="594"/>  594:       &quot;&quot;&quot;,
<a name="595"/>  595: 
<a name="596"/>  596:     {ok, test, BeamCode} = compile:forms(scan_and_parse(Code),[debug_info]),
<a name="597"/>  597:     {ok, {test, [{documentation, Docs }]}} = beam_lib:chunks(BeamCode, [documentation]),
<a name="598"/>  598: 
<a name="599"/>  599:     ?assertMatch(
<a name="600"/>  600:        #docs_v1{ module_doc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;moduledoc&quot;&gt;&gt; },
<a name="601"/>  601:                  anno = 2,
<a name="602"/>  602:                  docs = [{{function,main,0}, 4, _, #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;main&quot;&gt;&gt; }, _}]},
<a name="603"/>  603:        Docs),
<a name="604"/>  604: 
<a name="605"/>  605:     check_no_doc_attributes(BeamCode),
<a name="606"/>  606: 
<a name="607"/>  607:     {ok, test, BeamCodeWSource} = compile:forms(scan_and_parse(Code),[beam_docs, debug_info, {source, &quot;test.erl&quot;}]),
<a name="608"/>  608:     {ok, {test, [{documentation, DocsWSource }]}} = beam_lib:chunks(BeamCodeWSource, [documentation]),
<a name="609"/>  609: 
<a name="610"/>  610:     ?assertMatch(
<a name="611"/>  611:        #docs_v1{ module_doc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;moduledoc&quot;&gt;&gt; },
<a name="612"/>  612:                  anno = 2,
<a name="613"/>  613:                  docs = [{{function,main,0}, 4,
<a name="614"/>  614:                           _, #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;main&quot;&gt;&gt; }, _}]},
<a name="615"/>  615:        DocsWSource),
<a name="616"/>  616:     check_no_doc_attributes(BeamCodeWSource),
<a name="docs_from_ast-last_expr"/><a name="617"/>  617:     ok.
<a name="618"/>  618: 
<a name="scan_and_parse-1"/><a name="619"/>  619: <b>scan_and_parse</b>(Code) -&gt;
<a name="620"/>  620:     {ok, Toks, _} = erl_scan:string(Code),
<a name="scan_and_parse-last_expr"/><a name="621"/>  621: <b>    parse</b>(Toks).
<a name="622"/>  622: 
<a name="parse-1"/><a name="623"/>  623: <b>parse</b>([]) -&gt; [];
<a name="624"/>  624: <b>parse</b>(Toks) -&gt;
<a name="625"/>  625:     {Form, [Dot | Rest]} = lists:splitwith(fun(E) -&gt; element(1,E) =/= dot end, Toks),
<a name="626"/>  626:     {ok, F} = erl_parse:parse_form(Form ++ [Dot]),
<a name="parse-last_expr"/><a name="627"/>  627: <b>    [F | parse</b>(Rest)].
<a name="628"/>  628: 
<a name="compile_file-3"/><a name="629"/>  629: <b>compile_file</b>(Conf, ModuleName, ExtraOpts) -&gt;
<a name="630"/>  630:     ErlModName = ModuleName ++ &quot;.erl&quot;,
<a name="631"/>  631:     Filename = filename:join(proplists:get_value(data_dir, Conf), ErlModName),
<a name="632"/>  632:     io:format(&quot;Compiling: ~ts~n~p~n&quot;,[Filename, ExtraOpts]),
<a name="compile_file-last_expr"/><a name="633"/>  633: <b>    case compile:file</b>(Filename, ExtraOpts) of
<a name="634"/>  634:         Res when element(1, Res) =:= ok -&gt;
<a name="635"/>  635:             ModName = element(2, Res),
<a name="636"/>  636:             case lists:search(fun (X) -&gt; X =:= no_docs end, ExtraOpts) of
<a name="637"/>  637:               false when length(ExtraOpts) &gt; 0 -&gt;
<a name="638"/>  638:                 check_no_doc_attributes(code:which(ModName)),
<a name="639"/>  639:                 Res;
<a name="640"/>  640:               _ -&gt;
<a name="641"/>  641:                 Res
<a name="642"/>  642:             end;
<a name="643"/>  643:         Else -&gt;
<a name="644"/>  644:             Else
<a name="645"/>  645:     end.
<a name="646"/>  646: 
<a name="default_compile_file-2"/><a name="647"/>  647: <b>default_compile_file</b>(Conf, ModuleName) -&gt;
<a name="default_compile_file-last_expr"/><a name="648"/>  648: <b>  default_compile_file</b>(Conf, ModuleName, []).
<a name="default_compile_file-3"/><a name="649"/>  649: <b>default_compile_file</b>(Conf, ModuleName, ExtraOpts) -&gt;
<a name="default_compile_file-last_expr"/><a name="650"/>  650: <b>  compile_file</b>(Conf, ModuleName, [report, return_errors, debug_info] ++ ExtraOpts).
<a name="651"/>  651: 
<a name="652"/>  652: 
<a name="653"/>  653: <i>%% Verify that all doc and moduledoc attributes are stripped from debug_info</i>
<a name="check_no_doc_attributes-1"/><a name="654"/>  654: <b>check_no_doc_attributes</b>(Mod) -&gt;
<a name="655"/>  655:     {ok, {_ModName,
<a name="656"/>  656:           [{debug_info,
<a name="657"/>  657:             {debug_info_v1,erl_abstract_code,
<a name="658"/>  658:              {AST, Opts}}}]}} = beam_lib:chunks(Mod, [debug_info]),
<a name="659"/>  659:     false = lists:search(
<a name="660"/>  660:               fun(E) -&gt;
<a name="661"/>  661:                       element(1,E) == attribute
<a name="662"/>  662:                           andalso
<a name="663"/>  663:                             (element(3,E) == doc orelse element(3,E) == moduledoc)
<a name="664"/>  664:               end, AST),
<a name="665"/>  665:     false = lists:member(no_docs, Opts),
<a name="check_no_doc_attributes-last_expr"/><a name="666"/>  666:     ok.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
