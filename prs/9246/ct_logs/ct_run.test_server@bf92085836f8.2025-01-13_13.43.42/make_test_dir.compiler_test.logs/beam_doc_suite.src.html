<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/compiler/make_test_dir/compiler_test/beam_doc_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: 
<a name="2"/>    2: <b>-module</b>(beam_doc_SUITE).
<a name="3"/>    3: <b>-export</b>([all/0, groups/0, init_per_group/2, end_per_group/2, singleton_moduledoc/1, singleton_doc/1,
<a name="4"/>    4:          docmodule_with_doc_attributes/1, hide_moduledoc/1, docformat/1,
<a name="5"/>    5:          singleton_docformat/1, singleton_meta/1, source_path/1, behaviours/1, slogan/1,
<a name="6"/>    6:          types_and_opaques/1, callback/1, hide_moduledoc2/1,
<a name="7"/>    7:          private_types/1, export_all/1, equiv/1, spec/1, deprecated/1, warn_missing_doc/1,
<a name="8"/>    8:          doc_with_file/1, doc_with_file_error/1, all_string_formats/1,
<a name="9"/>    9:          docs_from_ast/1, spec_switch_order/1, user_defined_type/1, skip_doc/1,
<a name="10"/>   10:          no_doc_attributes/1, converted_metadata/1, converted_metadata_warnings/1]).
<a name="11"/>   11: 
<a name="12"/>   12: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="13"/>   13: <b>-include_lib</b>(&quot;kernel/include/eep48.hrl&quot;).
<a name="14"/>   14: <b>-include_lib</b>(&quot;stdlib/include/assert.hrl&quot;).
<a name="15"/>   15: 
<a name="16"/>   16: <b>-define</b>(get_name(), atom_to_list(?FUNCTION_NAME)).
<a name="17"/>   17: 
<a name="all-0"/><a name="18"/>   18: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="19"/>   19:     [{group, documentation_generation_tests}, doc_with_file].
<a name="20"/>   20: 
<a name="groups-0"/><a name="21"/>   21: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="22"/>   22: <b>    [{documentation_generation_tests, [parallel], documentation_generation_tests</b>()}].
<a name="23"/>   23: 
<a name="init_per_group-2"/><a name="24"/>   24: <b>init_per_group</b>(_, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="25"/>   25:     Config.
<a name="26"/>   26: 
<a name="end_per_group-2"/><a name="27"/>   27: <b>end_per_group</b>(_, _Config) -&gt;
<a name="end_per_group-last_expr"/><a name="28"/>   28:     ok.
<a name="29"/>   29: 
<a name="documentation_generation_tests-0"/><a name="30"/>   30: <b>documentation_generation_tests</b>() -&gt;
<a name="documentation_generation_tests-last_expr"/><a name="31"/>   31:     [singleton_moduledoc,
<a name="32"/>   32:      singleton_doc,
<a name="33"/>   33:      docmodule_with_doc_attributes,
<a name="34"/>   34:      hide_moduledoc,
<a name="35"/>   35:      hide_moduledoc2,
<a name="36"/>   36:      docformat,
<a name="37"/>   37:      singleton_docformat,
<a name="38"/>   38:      singleton_meta,
<a name="39"/>   39:      source_path,
<a name="40"/>   40:      behaviours,
<a name="41"/>   41:      slogan,
<a name="42"/>   42:      types_and_opaques,
<a name="43"/>   43:      callback,
<a name="44"/>   44:      private_types,
<a name="45"/>   45:      export_all,
<a name="46"/>   46:      equiv,
<a name="47"/>   47:      spec,
<a name="48"/>   48:      deprecated,
<a name="49"/>   49:      warn_missing_doc,
<a name="50"/>   50:      doc_with_file_error,
<a name="51"/>   51:      all_string_formats,
<a name="52"/>   52:      spec_switch_order,
<a name="53"/>   53:      docs_from_ast,
<a name="54"/>   54:      user_defined_type,
<a name="55"/>   55:      skip_doc,
<a name="56"/>   56:      no_doc_attributes,
<a name="57"/>   57:      converted_metadata,
<a name="58"/>   58:      converted_metadata_warnings
<a name="59"/>   59:     ].
<a name="60"/>   60: 
<a name="singleton_moduledoc-1"/><a name="61"/>   61: <b>singleton_moduledoc</b>(Conf) -&gt;
<a name="62"/>   62:     ModuleName = &quot;singletonmoduledoc&quot;,
<a name="63"/>   63:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="64"/>   64: 
<a name="65"/>   65:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="66"/>   66:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="67"/>   67:     {ok, {docs_v1, _,_, Mime,ModuleDoc, _,_}} = code:get_doc(ModName),
<a name="singleton_moduledoc-last_expr"/><a name="68"/>   68:     ok.
<a name="69"/>   69: 
<a name="singleton_doc-1"/><a name="70"/>   70: <b>singleton_doc</b>(Conf) -&gt;
<a name="71"/>   71:     ModuleName = &quot;singletondoc&quot;,
<a name="72"/>   72:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="73"/>   73:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="74"/>   74:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="75"/>   75:     FooDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Tests multi-clauses&quot;&gt;&gt;},
<a name="76"/>   76:     {ok, {docs_v1, 1,_, Mime, none, _,
<a name="77"/>   77:           [{{function, foo,1},_, [&lt;&lt;&quot;foo(ok)&quot;&gt;&gt;], FooDoc, _},
<a name="78"/>   78:            {{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], Doc, _}]}} = code:get_doc(ModName),
<a name="singleton_doc-last_expr"/><a name="79"/>   79:     ok.
<a name="80"/>   80: 
<a name="docmodule_with_doc_attributes-1"/><a name="81"/>   81: <b>docmodule_with_doc_attributes</b>(Conf) -&gt;
<a name="82"/>   82:     ModuleName = &quot;docmodule_with_doc_attributes&quot;,
<a name="83"/>   83:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="84"/>   84:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="85"/>   85:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="86"/>   86:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="87"/>   87:     FileDocs =  #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;# README\n\nThis is a test&quot;&gt;&gt;},
<a name="88"/>   88:     {ok, #docs_v1{ anno = ModuleAnno,
<a name="89"/>   89:                    beam_language = erlang,
<a name="90"/>   90:                    format = Mime,
<a name="91"/>   91:                    module_doc = ModuleDoc,
<a name="92"/>   92:                    metadata = #{},
<a name="93"/>   93:                    docs = Docs
<a name="94"/>   94:                  }} = code:get_doc(ModName),
<a name="95"/>   95: 
<a name="96"/>   96:     
<a name="97"/>   97:     [{{function,no_docs_multi,1},NoDocsMultiAnno,[&lt;&lt;&quot;no_docs_multi/1&quot;&gt;&gt;],none,#{}},
<a name="98"/>   98:      {{function,with_file_docs,0},FileDocsAnno, [&lt;&lt;&quot;with_file_docs()&quot;&gt;&gt;],FileDocs,#{}},
<a name="99"/>   99:      {{function,no_docs,0},NoDocsAnno, [&lt;&lt;&quot;no_docs()&quot;&gt;&gt;],none,#{}},
<a name="100"/>  100:      {{function,ok,0}, OkAnno, [&lt;&lt;&quot;ok()&quot;&gt;&gt;],none,#{authors := &quot;Someone&quot;}},
<a name="101"/>  101:      {{function, main,_},MainAnno, _, Doc, _}] = Docs,
<a name="102"/>  102:     
<a name="103"/>  103:     ?assertEqual(5, erl_anno:line(ModuleAnno)),
<a name="104"/>  104:     ?assertEqual(10, erl_anno:line(MainAnno)),
<a name="105"/>  105:     ?assertEqual(18, erl_anno:line(OkAnno)),
<a name="106"/>  106:     ?assertEqual(21, erl_anno:line(NoDocsAnno)),
<a name="107"/>  107:     ?assertEqual(1, erl_anno:line(FileDocsAnno)),
<a name="108"/>  108:     ?assertEqual(&quot;README&quot;, filename:basename(erl_anno:file(FileDocsAnno))),
<a name="109"/>  109:     ?assertEqual(28, erl_anno:line(NoDocsMultiAnno)),
<a name="110"/>  110: 
<a name="docmodule_with_doc_attributes-last_expr"/><a name="111"/>  111:     ok.
<a name="112"/>  112: 
<a name="hide_moduledoc-1"/><a name="113"/>  113: <b>hide_moduledoc</b>(Conf) -&gt;
<a name="114"/>  114:     {ok, ModName} = default_compile_file(Conf, &quot;hide_moduledoc&quot;),
<a name="115"/>  115:     {ok, {docs_v1, _,_, _Mime, hidden, _,
<a name="116"/>  116:           [{{function, main, 0}, _, [&lt;&lt;&quot;main()&quot;&gt;&gt;],
<a name="117"/>  117:             #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt; }, #{}}]}} = code:get_doc(ModName),
<a name="hide_moduledoc-last_expr"/><a name="118"/>  118:     ok.
<a name="119"/>  119: 
<a name="120"/>  120: <i>%% TODO: crashes</i>
<a name="hide_moduledoc2-1"/><a name="121"/>  121: <b>hide_moduledoc2</b>(Conf) -&gt;
<a name="122"/>  122:     ModuleName = ?get_name(),
<a name="123"/>  123:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="124"/>  124:     {ok, {docs_v1, _,_, _Mime, hidden, _,
<a name="125"/>  125:           [{{function,handle_call,1},{16,2},[&lt;&lt;&quot;handle_call/1&quot;&gt;&gt;],hidden,#{}},
<a name="126"/>  126:            {{function, main, 0}, _, [&lt;&lt;&quot;main()&quot;&gt;&gt;], hidden, #{}}]}} = code:get_doc(ModName),
<a name="hide_moduledoc2-last_expr"/><a name="127"/>  127:     ok.
<a name="128"/>  128: 
<a name="docformat-1"/><a name="129"/>  129: <b>docformat</b>(Conf) -&gt;
<a name="130"/>  130:     {ok, ModName} = default_compile_file(Conf, &quot;docformat&quot;),
<a name="131"/>  131:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="132"/>  132:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="133"/>  133:     {ok, {docs_v1, _,_, &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;, ModuleDoc, Meta,
<a name="134"/>  134:           [{{function, main,_},_, _, Doc, _}]}} = code:get_doc(ModName),
<a name="135"/>  135:     #{format := ~&quot;text/asciidoc&quot;, deprecated := ~&quot;Use something else&quot;, otp_doc_vsn := {1,0,0}, since := ~&quot;1.0&quot;} = Meta,
<a name="docformat-last_expr"/><a name="136"/>  136:     ok.
<a name="137"/>  137: 
<a name="singleton_docformat-1"/><a name="138"/>  138: <b>singleton_docformat</b>(Conf) -&gt;
<a name="139"/>  139:     {ok, ModName} = default_compile_file(Conf, &quot;singleton_docformat&quot;),
<a name="140"/>  140:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="141"/>  141:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module\n\nMore info here&quot;&gt;&gt;},
<a name="142"/>  142:     {ok, {docs_v1, _,erlang, &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;, ModuleDoc, Meta,
<a name="143"/>  143:           [{{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], Doc, FunMeta}]}} = code:get_doc(ModName),
<a name="144"/>  144:     #{format := &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;,
<a name="145"/>  145:       deprecated := ~&quot;Use something else&quot;,
<a name="146"/>  146:       otp_doc_vsn := {1,0,0},
<a name="147"/>  147:       since := ~&quot;1.0&quot;} = Meta,
<a name="148"/>  148:     #{authors := [&lt;&lt;&quot;Beep Bop&quot;&gt;&gt;], equiv := &lt;&lt;&quot;main/3&quot;&gt;&gt;, since := ~&quot;1.0&quot;} = FunMeta,
<a name="singleton_docformat-last_expr"/><a name="149"/>  149:     ok.
<a name="150"/>  150: 
<a name="singleton_meta-1"/><a name="151"/>  151: <b>singleton_meta</b>(Conf) -&gt;
<a name="152"/>  152:     ModuleName = ?get_name(),
<a name="153"/>  153:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="154"/>  154:     DocMain1 = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Returns always ok.&quot;&gt;&gt;},
<a name="155"/>  155:     Meta = #{authors =&gt; [&lt;&lt;&quot;Beep Bop&quot;&gt;&gt;], equiv =&gt; &lt;&lt;&quot;main/3&quot;&gt;&gt;, since =&gt; ~&quot;1.0&quot;, source_anno =&gt; {9, 1}},
<a name="156"/>  156:     {ok, {docs_v1, _,erlang, &lt;&lt;&quot;text/markdown&quot;&gt;&gt;, none, #{ since := ~&quot;1.0&quot;, source_anno := {1, 2} },
<a name="157"/>  157:           [{{function, main1,0},_, [&lt;&lt;&quot;main1()&quot;&gt;&gt;], DocMain1, #{equiv := &lt;&lt;&quot;main(_)&quot;&gt;&gt;,
<a name="158"/>  158:                                                                 since := ~&quot;1.1&quot;,
<a name="159"/>  159:                                                                 source_anno := {19, 1}}},
<a name="160"/>  160:            {{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], none, Meta}]}}
<a name="161"/>  161:         = code:get_doc(ModName),
<a name="singleton_meta-last_expr"/><a name="162"/>  162:     ok.
<a name="163"/>  163: 
<a name="source_path-1"/><a name="164"/>  164: <b>source_path</b>(Conf) -&gt;
<a name="165"/>  165:     ModuleName = ?get_name(),
<a name="166"/>  166:     % Includes absolute source path by default
<a name="167"/>  167:     FilePath = filename:absname(data_file_path(Conf, ModuleName)),
<a name="168"/>  168:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="169"/>  169:     {ok, {docs_v1, _, _, _, _, Meta1, _}} = code:get_doc(ModName),
<a name="170"/>  170:     #{source_path := FilePath} = Meta1,
<a name="171"/>  171:     % Excludes source path when deterministic
<a name="172"/>  172:     {ok, ModName} = default_compile_file(Conf, ModuleName, [deterministic]),
<a name="173"/>  173:     {ok, {docs_v1, _, _, _, _, Meta2, _}} = code:get_doc(ModName),
<a name="174"/>  174:     false = is_map_key(source_path, Meta2),
<a name="source_path-last_expr"/><a name="175"/>  175:     ok.
<a name="176"/>  176: 
<a name="behaviours-1"/><a name="177"/>  177: <b>behaviours</b>(Conf) -&gt;
<a name="178"/>  178:     ModuleName = ?get_name(),
<a name="179"/>  179:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="180"/>  180:     {ok, {docs_v1, _, _, _, _, #{behaviours := [gen_event, gen_server]}, _}} = code:get_doc(ModName),
<a name="behaviours-last_expr"/><a name="181"/>  181:     ok.
<a name="182"/>  182: 
<a name="slogan-1"/><a name="183"/>  183: <b>slogan</b>(Conf) -&gt;
<a name="184"/>  184:   ModuleName = ?get_name(),
<a name="185"/>  185:   {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="186"/>  186:   Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Returns ok.&quot;&gt;&gt;},
<a name="187"/>  187:   BarDoc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;foo()\nNot a slogan since foo =/= bar&quot;&gt;&gt; },
<a name="188"/>  188:   NoSloganDoc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Not a slogan\n\nTests slogans in multi-clause&quot;&gt;&gt;},
<a name="189"/>  189:   {ok, {docs_v1, _,_, _, none, _,
<a name="190"/>  190:           [Connect, MulticlauseSloganIgnored, SpecNoDocSlogan, NoDocSlogan,
<a name="191"/>  191:            Slogan2, Slogan1, NoSlogan, Bar, Main]}} = code:get_doc(ModName),
<a name="192"/>  192: 
<a name="193"/>  193:   {{function,connect,2},_,
<a name="194"/>  194:    [&lt;&lt;&quot;connect(TCPSocket, TLSOptions)&quot;&gt;&gt;],none,#{equiv := &lt;&lt;&quot;connect/3&quot;&gt;&gt;,since := &lt;&lt;&quot;OTP R14B&quot;&gt;&gt;}} = Connect,
<a name="195"/>  195:   {{function,spec_multiclause_slogan_ignored,1},_,[&lt;&lt;&quot;spec_multiclause_slogan_ignored(X)&quot;&gt;&gt;],none,#{}} = MulticlauseSloganIgnored,
<a name="196"/>  196:   {{function, spec_no_doc_slogan, 1}, _, [&lt;&lt;&quot;spec_no_doc_slogan(Y)&quot;&gt;&gt;], none, #{}} = SpecNoDocSlogan,
<a name="197"/>  197:   {{function, no_doc_slogan, 1}, _, [&lt;&lt;&quot;no_doc_slogan(X)&quot;&gt;&gt;], none, #{}}= NoDocSlogan,
<a name="198"/>  198:   {{function, spec_slogan, 2}, _, [&lt;&lt;&quot;spec_slogan(Y, Z)&quot;&gt;&gt;], _, #{}} = Slogan2,
<a name="199"/>  199:   {{function, spec_slogan, 1}, _, [&lt;&lt;&quot;spec_slogan(Y)&quot;&gt;&gt;], _, #{}} = Slogan1,
<a name="200"/>  200:   {{function, no_slogan,1},_,[&lt;&lt;&quot;no_slogan/1&quot;&gt;&gt;], NoSloganDoc, #{}} = NoSlogan,
<a name="201"/>  201:   {{function, bar,0},_,[&lt;&lt;&quot;bar()&quot;&gt;&gt;], BarDoc, #{}} = Bar,
<a name="202"/>  202:   {{function, main,1},_,[&lt;&lt;&quot;main(Foo)&quot;&gt;&gt;], Doc, #{}} = Main,
<a name="slogan-last_expr"/><a name="203"/>  203:   ok.
<a name="204"/>  204: 
<a name="types_and_opaques-1"/><a name="205"/>  205: <b>types_and_opaques</b>(Conf) -&gt;
<a name="206"/>  206:     ModuleName = ?get_name(),
<a name="207"/>  207:     {ok, ModName, Warnings} = default_compile_file(Conf, ModuleName, [return_warnings]),
<a name="208"/>  208:     TypeDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Represents the name of a person.&quot;&gt;&gt;},
<a name="209"/>  209:     GenericsDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Tests generics&quot;&gt;&gt;},
<a name="210"/>  210:     OpaqueDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt;
<a name="211"/>  211:                       &lt;&lt;&quot;Represents the name of a person that cannot be named.&quot;&gt;&gt;},
<a name="212"/>  212:     MaybeOpaqueDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;mmaybe(X) ::= nothing | X.\n\nRepresents a maybe type.&quot;&gt;&gt;},
<a name="213"/>  213: 
<a name="214"/>  214:     {ok, {docs_v1, _,_, _, none, _,
<a name="215"/>  215:           [%% Type Definitions
<a name="216"/>  216:            Public, Intermediate, HiddenNoWarnType, HiddenType, OtherPrivateType, MyPrivateType,
<a name="217"/>  217:            MyMap, StateEnter, CallbackMode,CallbackResult, EncodingFunc, Three,
<a name="218"/>  218:            Two, One, Hidden, HiddenFalse, MMaybe, Unnamed, Param,NatNumber, Name,
<a name="219"/>  219:            HiddenIncludedType,
<a name="220"/>  220:            %% Functions
<a name="221"/>  221:            UsesPublic, Ignore, MapFun, PrivateEncoding, Foo
<a name="222"/>  222:           ]}} = code:get_doc(ModName),
<a name="223"/>  223: 
<a name="224"/>  224:     {{type,public,0},{125,2},[&lt;&lt;&quot;public()&quot;&gt;&gt;],none,#{exported := true, source_anno := {125, 2}}} = Public,
<a name="225"/>  225:     {{type,intermediate,0},{124,2},[&lt;&lt;&quot;intermediate()&quot;&gt;&gt;],none,#{exported := false}} = Intermediate,
<a name="226"/>  226:     {{type,hidden_nowarn_type,0},{120,2},[&lt;&lt;&quot;hidden_nowarn_type()&quot;&gt;&gt;],hidden,#{exported := false}} = HiddenNoWarnType,
<a name="227"/>  227:     {{type,hidden_type,0},{117,2},[&lt;&lt;&quot;hidden_type()&quot;&gt;&gt;],hidden,#{exported := false}} = HiddenType,
<a name="228"/>  228:     {{type,my_other_private_type,0},MyOtherPrivateTypeLine,
<a name="229"/>  229:               [&lt;&lt;&quot;my_other_private_type()&quot;&gt;&gt;],none,#{exported := false}} = OtherPrivateType,
<a name="230"/>  230:     {{type,my_private_type,0},MyPrivateTypeLine,
<a name="231"/>  231:      [&lt;&lt;&quot;my_private_type()&quot;&gt;&gt;],none,#{exported := false}} = MyPrivateType,
<a name="232"/>  232:     {{type,mymap,0},MyMapLine,[&lt;&lt;&quot;mymap()&quot;&gt;&gt;],none,#{exported := false}} = MyMap,
<a name="233"/>  233:     {{type,state_enter,0},StateEnterLine,[&lt;&lt;&quot;state_enter()&quot;&gt;&gt;],none,#{exported := false}}=StateEnter,
<a name="234"/>  234:     {{type,callback_mode,0},CallbackModeLine, [&lt;&lt;&quot;callback_mode()&quot;&gt;&gt;],none,#{exported := false}} = CallbackMode,
<a name="235"/>  235:     {{type,callback_mode_result,0},CallbackResultLine,
<a name="236"/>  236:                [&lt;&lt;&quot;callback_mode_result()&quot;&gt;&gt;],none,#{exported := true}} = CallbackResult,
<a name="237"/>  237:     {{type,encoding_func,0},_,[&lt;&lt;&quot;encoding_func()&quot;&gt;&gt;],none,#{exported := false}} = EncodingFunc,
<a name="238"/>  238:     {{type,three,0},_,[&lt;&lt;&quot;three()&quot;&gt;&gt;],none,#{exported := false}} = Three,
<a name="239"/>  239:     {{type,two,0},_,[&lt;&lt;&quot;two()&quot;&gt;&gt;],none,#{exported := false}} = Two,
<a name="240"/>  240:     {{type,one,0},_,[&lt;&lt;&quot;one()&quot;&gt;&gt;],none,#{exported := false}} = One,
<a name="241"/>  241:     {{type,hidden,0},_,[&lt;&lt;&quot;hidden()&quot;&gt;&gt;],hidden,#{exported := true}} = Hidden,
<a name="242"/>  242:     {{type,hidden_false,0},_,[&lt;&lt;&quot;hidden_false()&quot;&gt;&gt;],hidden,
<a name="243"/>  243:      #{exported := true, authors := &quot;Someone else&quot;}} = HiddenFalse,
<a name="244"/>  244:     {{type, mmaybe,1},_,[&lt;&lt;&quot;mmaybe(X)&quot;&gt;&gt;], MaybeOpaqueDoc, #{authors := &quot;Someone else&quot;, exported := true}} = MMaybe,
<a name="245"/>  245:     {{type, unnamed,0},{30,2},[&lt;&lt;&quot;unnamed()&quot;&gt;&gt;], OpaqueDoc,
<a name="246"/>  246:      #{equiv := &lt;&lt;&quot;non_neg_integer()&quot;&gt;&gt;, exported := true}} = Unnamed,
<a name="247"/>  247:     {{type, param,1},_,[&lt;&lt;&quot;param(X)&quot;&gt;&gt;], GenericsDoc,
<a name="248"/>  248:      #{equiv := &lt;&lt;&quot;madeup()&quot;&gt;&gt;, exported := true}} = Param,
<a name="249"/>  249:     {{type, natural_number,0},_,[&lt;&lt;&quot;natural_number()&quot;&gt;&gt;], none, #{since := ~&quot;1.0&quot;, equiv := &lt;&lt;&quot;non_neg_integer/0&quot;&gt;&gt;, exported := true}} = NatNumber,
<a name="250"/>  250:     {{type, name,1},_,[&lt;&lt;&quot;name(_)&quot;&gt;&gt;], TypeDoc, #{exported := true}} = Name,
<a name="251"/>  251:     {{type, hidden_included_type, 0}, _, _, hidden, #{exported := false }} = HiddenIncludedType,
<a name="252"/>  252: 
<a name="253"/>  253:     {{function,uses_public,0},{128,1},[&lt;&lt;&quot;uses_public()&quot;&gt;&gt;],none,#{}} = UsesPublic,
<a name="254"/>  254:     {{function,ignore_type_from_hidden_fun,0},_,[&lt;&lt;&quot;ignore_type_from_hidden_fun()&quot;&gt;&gt;],hidden,#{}} = Ignore,
<a name="255"/>  255:     {{function,map_fun,0},_,[&lt;&lt;&quot;map_fun()&quot;&gt;&gt;],none,#{}} = MapFun,
<a name="256"/>  256:     {{function,private_encoding_func,2},_,[&lt;&lt;&quot;private_encoding_func(Data, Options)&quot;&gt;&gt;],none,#{}} = PrivateEncoding,
<a name="257"/>  257:     {{function,foo,0},_,[&lt;&lt;&quot;foo()&quot;&gt;&gt;],none,#{}} = Foo,
<a name="258"/>  258: 
<a name="259"/>  259:     ?assertEqual(103, erl_anno:line(MyOtherPrivateTypeLine)),
<a name="260"/>  260:     ?assertEqual(102, erl_anno:line(MyPrivateTypeLine)),
<a name="261"/>  261:     ?assertEqual(99, erl_anno:line(MyMapLine)),
<a name="262"/>  262:     ?assertEqual(96, erl_anno:line(StateEnterLine)),
<a name="263"/>  263:     ?assertEqual(95, erl_anno:line(CallbackModeLine)),
<a name="264"/>  264:     ?assertEqual(93, erl_anno:line(CallbackResultLine)),
<a name="265"/>  265: 
<a name="266"/>  266:     [{File, Ws}, {HrlFile, HrlWs}] = Warnings,
<a name="267"/>  267:     ?assertEqual(&quot;types_and_opaques.erl&quot;, filename:basename(File)),
<a name="268"/>  268:     ?assertEqual({{117,2}, beam_doc,
<a name="269"/>  269:                   {hidden_type_used_in_exported_fun,{hidden_type,0}}}, lists:nth(4, Ws)),
<a name="270"/>  270: 
<a name="271"/>  271:     ?assertEqual(&quot;types_and_opaques.hrl&quot;, filename:basename(HrlFile)),
<a name="272"/>  272:     ?assertEqual({{1,2}, beam_doc,
<a name="273"/>  273:                   {hidden_type_used_in_exported_fun,{hidden_included_type,0}}}, lists:nth(1, HrlWs)),
<a name="274"/>  274: 
<a name="275"/>  275:     {ok, ModName, [_]} =
<a name="276"/>  276:         default_compile_file(Conf, ModuleName, [return_warnings, nowarn_hidden_doc, nowarn_unused_type]),
<a name="277"/>  277: 
<a name="types_and_opaques-last_expr"/><a name="278"/>  278:     ok.
<a name="279"/>  279: 
<a name="callback-1"/><a name="280"/>  280: <b>callback</b>(Conf) -&gt;
<a name="281"/>  281:     ModuleName = ?get_name(),
<a name="282"/>  282:     {ok, ModName, [{File,Warnings}]} =
<a name="283"/>  283:         default_compile_file(Conf, ModuleName, [return_warnings, report]),
<a name="284"/>  284:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Callback fn that always returns ok.&quot;&gt;&gt;},
<a name="285"/>  285:     ImpCallback = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;This is a test&quot;&gt;&gt;},
<a name="286"/>  286:     FunctionDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;all_ok()\n\nCalls all_ok/0&quot;&gt;&gt;},
<a name="287"/>  287:     ChangeOrder = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Test changing order&quot;&gt;&gt;},
<a name="288"/>  288:     {ok, {docs_v1, _,_, _, none, _,
<a name="289"/>  289:           [{{callback,nowarn,1},{39,2},[&lt;&lt;&quot;nowarn(Arg)&quot;&gt;&gt;],hidden,#{source_anno := {41, 2}}},
<a name="290"/>  290:            {{callback,warn,0},{36,2},[&lt;&lt;&quot;warn()&quot;&gt;&gt;],hidden,#{}},
<a name="291"/>  291:            {{callback,bounded,1},_,[&lt;&lt;&quot;bounded(X)&quot;&gt;&gt;],none,#{}},
<a name="292"/>  292:            {{callback,multi,1},_,[&lt;&lt;&quot;multi(Argument)&quot;&gt;&gt;],
<a name="293"/>  293:             #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;A multiclause callback with slogan docs&quot;&gt;&gt; },#{}},
<a name="294"/>  294:            {{callback,multi_no_slogan,1},_,[&lt;&lt;&quot;multi_no_slogan/1&quot;&gt;&gt;],none,#{}},
<a name="295"/>  295:            {{callback,ann,1},_,[&lt;&lt;&quot;ann(X)&quot;&gt;&gt;],none,#{}},
<a name="296"/>  296:            {{callback,param,1},_,[&lt;&lt;&quot;param(X)&quot;&gt;&gt;],none,#{}},
<a name="297"/>  297:            {{callback, change_order,0},_,[&lt;&lt;&quot;change_order()&quot;&gt;&gt;], ChangeOrder,
<a name="298"/>  298:             #{equiv := &lt;&lt;&quot;ok()&quot;&gt;&gt;}},
<a name="299"/>  299:            {{callback, all_ok,0},_,[&lt;&lt;&quot;all_ok()&quot;&gt;&gt;], Doc, #{}},
<a name="300"/>  300:            {{function, main2,0},_,[&lt;&lt;&quot;main2()&quot;&gt;&gt;], #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Second main&quot;&gt;&gt;},
<a name="301"/>  301:             #{equiv := &lt;&lt;&quot;main()&quot;&gt;&gt;}},
<a name="302"/>  302:            {{function, main,0},_,[&lt;&lt;&quot;main()&quot;&gt;&gt;], FunctionDoc, #{}},
<a name="303"/>  303:            {{function, all_ok,0},_, [&lt;&lt;&quot;all_ok()&quot;&gt;&gt;],ImpCallback,
<a name="304"/>  304:             #{equiv := &lt;&lt;&quot;ok/0&quot;&gt;&gt;}}
<a name="305"/>  305:           ]}} = code:get_doc(ModName),
<a name="306"/>  306: 
<a name="307"/>  307:     ?assertEqual(&quot;callback.erl&quot;, filename:basename(File)),
<a name="308"/>  308:     io:format(&quot;Warnings: ~p~n&quot;, [Warnings]),
<a name="309"/>  309:     ?assertEqual(1, length(Warnings)),
<a name="310"/>  310:     ?assertMatch({{36,2},beam_doc,{hidden_callback,{warn,0}}}, lists:nth(1, Warnings)),
<a name="311"/>  311: 
<a name="312"/>  312:     {ok, ModName, []} =
<a name="313"/>  313:         default_compile_file(Conf, ModuleName, [return_warnings, report, nowarn_hidden_doc]),
<a name="314"/>  314: 
<a name="callback-last_expr"/><a name="315"/>  315:     ok.
<a name="316"/>  316: 
<a name="private_types-1"/><a name="317"/>  317: <b>private_types</b>(Conf) -&gt;
<a name="318"/>  318:     ModuleName = ?get_name(),
<a name="319"/>  319:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="320"/>  320: 
<a name="321"/>  321:     {ok, {docs_v1, _,_, _, none, _,
<a name="322"/>  322:           [
<a name="323"/>  323:            %% Types
<a name="324"/>  324:            RemoteTypeT, TupleT, RecordAT, RecordInlineT,
<a name="325"/>  325:            MapValue2T, MapKey2T, MapValueT, MapKeyT,
<a name="326"/>  326:            FunRet2T, FunRetT, FunT, Complex, BoundedRetT,
<a name="327"/>  327:            ArgT, BoundedArgT, Private, HiddenExportT, PrivateCBT,
<a name="328"/>  328:            OpaqueT, PublicT, PrivateT,
<a name="329"/>  329:            %% Callbacks
<a name="330"/>  330:            CBar,
<a name="331"/>  331:            %% Functions
<a name="332"/>  332:            Bounded, HiddenTypeExposed, Hidden, Bar]}} = code:get_doc(ModName),
<a name="333"/>  333: 
<a name="334"/>  334:     ?assertMatch({{type,remote_type_t,1}, _, _, none, #{exported := false}},RemoteTypeT),
<a name="335"/>  335:     ?assertMatch({{type,tuple_t,0}, _, _, none, #{exported := false}},TupleT),
<a name="336"/>  336:     ?assertMatch({{type,record_a_t,0}, _, _, none, #{exported := false}},RecordAT),
<a name="337"/>  337:     ?assertMatch({{type,record_inline_t,0}, _, _, none, #{exported := false}},RecordInlineT),
<a name="338"/>  338:     ?assertMatch({{type,map_value_2_t,0}, _, _, none, #{exported := false}},MapValue2T),
<a name="339"/>  339:     ?assertMatch({{type,map_key_2_t,0}, _, _, none, #{exported := false}},MapKey2T),
<a name="340"/>  340:     ?assertMatch({{type,map_value_t,0}, _, _, none, #{exported := false}},MapValueT),
<a name="341"/>  341:     ?assertMatch({{type,map_key_t,0}, _, _, none, #{exported := false}},MapKeyT),
<a name="342"/>  342:     ?assertMatch({{type,fun_ret_2_t,0}, _, _, none, #{exported := false}},FunRet2T),
<a name="343"/>  343:     ?assertMatch({{type,fun_ret_t,0}, _, _, none, #{exported := false}},FunRetT),
<a name="344"/>  344:     ?assertMatch({{type,fun_t,0}, _, _, none, #{exported := false}},FunT),
<a name="345"/>  345:     ?assertMatch({{type,complex,1}, _, _, none, #{exported := true}},Complex),
<a name="346"/>  346:     ?assertMatch({{type,bounded_ret_t,0}, _, _, none, #{exported := false}},BoundedRetT),
<a name="347"/>  347:     ?assertMatch({{type,arg_t,0}, _, _, none, #{exported := false}},ArgT),
<a name="348"/>  348:     ?assertMatch({{type,bounded_arg_t,0}, _, _, none, #{exported := false}},BoundedArgT),
<a name="349"/>  349:     ?assertMatch({{type,private,0}, {30,2}, [&lt;&lt;&quot;private()&quot;&gt;&gt;], hidden, #{exported := false}},Private),
<a name="350"/>  350:     ?assertMatch({{type,hidden_export_t,0},_,[&lt;&lt;&quot;hidden_export_t()&quot;&gt;&gt;],hidden,#{exported := true}},HiddenExportT),
<a name="351"/>  351:     ?assertMatch({{type,private_cb_t,0},_,_,none,#{exported := false}},PrivateCBT),
<a name="352"/>  352:     ?assertMatch({{type,opaque_t,0},_, [&lt;&lt;&quot;opaque_t()&quot;&gt;&gt;], none,#{ exported := true}},OpaqueT),
<a name="353"/>  353:     ?assertMatch({{type,public_t,0},_, [&lt;&lt;&quot;public_t()&quot;&gt;&gt;], none,#{ exported := true}},PublicT),
<a name="354"/>  354:     ?assertMatch({{type,private_t,0},_, [&lt;&lt;&quot;private_t()&quot;&gt;&gt;], none,#{ exported := false}},PrivateT),
<a name="355"/>  355:     ?assertMatch({{callback,bar,1},_,_,none,#{}},CBar),
<a name="356"/>  356:     ?assertMatch({{function,bounded,2},_,_,none,#{}},Bounded),
<a name="357"/>  357:     ?assertMatch({{function,hidden_type_exposed,0},{34,1},[&lt;&lt;&quot;hidden_type_exposed()&quot;&gt;&gt;],none,#{}},HiddenTypeExposed),
<a name="358"/>  358:     ?assertMatch({{function,hidden,0},_,[&lt;&lt;&quot;hidden()&quot;&gt;&gt;],hidden,#{}},Hidden),
<a name="359"/>  359:     ?assertMatch({{function,bar,0},_,[&lt;&lt;&quot;bar()&quot;&gt;&gt;],none,#{}},Bar),
<a name="360"/>  360: 
<a name="private_types-last_expr"/><a name="361"/>  361:     ok.
<a name="362"/>  362: 
<a name="363"/>  363: 
<a name="export_all-1"/><a name="364"/>  364: <b>export_all</b>(Conf) -&gt;
<a name="365"/>  365:     ModuleName = ?get_name(),
<a name="366"/>  366:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="367"/>  367:     ImpCallback = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;This is a test&quot;&gt;&gt;},
<a name="368"/>  368:     FunctionDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;all_ok()\n\nCalls all_ok/0&quot;&gt;&gt;},
<a name="369"/>  369:     {ok, {docs_v1, _,_, _, none, _,
<a name="370"/>  370:           [{{function, main2,0},_,[&lt;&lt;&quot;main2()&quot;&gt;&gt;], #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Second main&quot;&gt;&gt;},
<a name="371"/>  371:             #{equiv := &lt;&lt;&quot;main()&quot;&gt;&gt;}},
<a name="372"/>  372:            {{function, main,0},_,[&lt;&lt;&quot;main()&quot;&gt;&gt;], FunctionDoc, #{}},
<a name="373"/>  373:            {{function, all_ok,0},_, [&lt;&lt;&quot;all_ok()&quot;&gt;&gt;],ImpCallback,
<a name="374"/>  374:             #{equiv := &lt;&lt;&quot;ok/0&quot;&gt;&gt;}}
<a name="375"/>  375:           ]}} = code:get_doc(ModName),
<a name="export_all-last_expr"/><a name="376"/>  376:     ok.
<a name="377"/>  377: 
<a name="equiv-1"/><a name="378"/>  378: <b>equiv</b>(Conf) -&gt;
<a name="379"/>  379:     ModuleName = ?get_name(),
<a name="380"/>  380:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="381"/>  381:     {ok, {docs_v1, _,_, _, none, _,
<a name="382"/>  382:           [{{function, main, 2},_,[&lt;&lt;&quot;main(A, B)&quot;&gt;&gt;], none,
<a name="383"/>  383:             #{ }},
<a name="384"/>  384:             {{function, main, 1},_,[&lt;&lt;&quot;main(A)&quot;&gt;&gt;], none,
<a name="385"/>  385:              #{ equiv := &lt;&lt;&quot;main(A, 1)&quot;&gt;&gt; }}
<a name="386"/>  386:           ]}} = code:get_doc(ModName),
<a name="equiv-last_expr"/><a name="387"/>  387:     ok.
<a name="388"/>  388: 
<a name="spec-1"/><a name="389"/>  389: <b>spec</b>(Conf) -&gt;
<a name="390"/>  390:     ModuleName = ?get_name(),
<a name="391"/>  391:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="392"/>  392:     {ok, {docs_v1, _,_, _, #{ ~&quot;en&quot; := ~&quot;&quot; }, _,
<a name="393"/>  393:           [{{type,no,0},_,[&lt;&lt;&quot;no()&quot;&gt;&gt;],none,#{exported := false}},
<a name="394"/>  394:            {{type,yes,0},_,[&lt;&lt;&quot;yes()&quot;&gt;&gt;],none,#{exported := false}},
<a name="395"/>  395:            {{callback,me,1},_,[&lt;&lt;&quot;me/1&quot;&gt;&gt;],none,#{}},
<a name="396"/>  396:            {{function,baz,1},_,[&lt;&lt;&quot;baz(X)&quot;&gt;&gt;],none,#{}},
<a name="397"/>  397:            {{function,foo,1},_,[&lt;&lt;&quot;foo(X)&quot;&gt;&gt;],none,#{}}]}} = code:get_doc(ModName),
<a name="spec-last_expr"/><a name="398"/>  398:     ok.
<a name="399"/>  399: 
<a name="user_defined_type-1"/><a name="400"/>  400: <b>user_defined_type</b>(Conf) -&gt;
<a name="401"/>  401:     ModuleName = ?get_name(),
<a name="402"/>  402:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="403"/>  403:     {ok, {docs_v1, _,_, _, #{ ~&quot;en&quot; := ~&quot;&quot; }, _, []}} = code:get_doc(ModName),
<a name="user_defined_type-last_expr"/><a name="404"/>  404:     ok.
<a name="405"/>  405: 
<a name="deprecated-1"/><a name="406"/>  406: <b>deprecated</b>(Conf) -&gt;
<a name="407"/>  407:     ModuleName = ?get_name(),
<a name="408"/>  408:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="409"/>  409:     {ok, {docs_v1, _,_, _, none, _,
<a name="410"/>  410:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; Deprecation reason&quot;&gt;&gt;}},
<a name="411"/>  411:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="412"/>  412:            {{callback,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the callback deprecated:test(_) is deprecated; Deprecation reason&quot;&gt;&gt;}},
<a name="413"/>  413:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="414"/>  414:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="415"/>  415:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; Deprecation reason&quot;&gt;&gt;}},
<a name="416"/>  416:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="417"/>  417:         code:get_doc(ModName),
<a name="418"/>  418: 
<a name="419"/>  419:     {ok, ModName} = default_compile_file(Conf, ModuleName, [{d,'TEST_WILDCARD'},
<a name="420"/>  420:                                                             {d, 'REASON', next_major_release}]),
<a name="421"/>  421:     {ok, {docs_v1, _,_, _, none, _,
<a name="422"/>  422:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="423"/>  423:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="424"/>  424:            {{callback,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the callback deprecated:test(_) is deprecated; will be removed in the next major release. See the documentation for details&quot;&gt;&gt;}},
<a name="425"/>  425:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="426"/>  426:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="427"/>  427:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; will be removed in the next major release. See the documentation for details&quot;&gt;&gt;}},
<a name="428"/>  428:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="429"/>  429:         code:get_doc(ModName),
<a name="430"/>  430: 
<a name="431"/>  431:     {ok, ModName} = default_compile_file(Conf, ModuleName, [{d,'ALL_WILDCARD'},
<a name="432"/>  432:                                                             {d,'REASON',next_version},
<a name="433"/>  433:                                                             {d,'TREASON',eventually}]),
<a name="434"/>  434:     {ok, {docs_v1, _,_, _, none, _,
<a name="435"/>  435:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; will be removed in a future release. See the documentation for details&quot;&gt;&gt;}},
<a name="436"/>  436:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="437"/>  437:            {{callback,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the callback deprecated:test(_) is deprecated; will be removed in the next version. See the documentation for details&quot;&gt;&gt;}},
<a name="438"/>  438:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="439"/>  439:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="440"/>  440:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; will be removed in the next version. See the documentation for details&quot;&gt;&gt;}},
<a name="441"/>  441:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="442"/>  442:         code:get_doc(ModName),
<a name="deprecated-last_expr"/><a name="443"/>  443:     ok.
<a name="444"/>  444: 
<a name="warn_missing_doc-1"/><a name="445"/>  445: <b>warn_missing_doc</b>(Conf) -&gt;
<a name="446"/>  446: 
<a name="447"/>  447:     warn_missing_doc(Conf, [function, type, callback], [warn_missing_doc]),
<a name="448"/>  448:     warn_missing_doc(Conf, [function], [warn_missing_doc_functions]),
<a name="449"/>  449:     warn_missing_doc(Conf, [function, type], [warn_missing_doc_functions, warn_missing_doc_types]),
<a name="450"/>  450:     warn_missing_doc(Conf, [type, callback], [warn_missing_doc_types, warn_missing_doc_callbacks]),
<a name="451"/>  451:     warn_missing_doc(Conf, [callback], [warn_missing_doc_callbacks]),
<a name="452"/>  452: 
<a name="453"/>  453:     warn_missing_doc(Conf, [type, callback], [warn_missing_doc, nowarn_missing_doc_functions]),
<a name="454"/>  454:     warn_missing_doc(Conf, [function, callback], [warn_missing_doc, nowarn_missing_doc_types]),
<a name="455"/>  455:     warn_missing_doc(Conf, [type], [warn_missing_doc, nowarn_missing_doc_callbacks, nowarn_missing_doc_functions]),
<a name="456"/>  456:     warn_missing_doc(Conf, [], [warn_missing_doc_functions, nowarn_missing_doc]),
<a name="457"/>  457: 
<a name="warn_missing_doc-last_expr"/><a name="458"/>  458:     ok.
<a name="459"/>  459: 
<a name="warn_missing_doc-3"/><a name="460"/>  460: <b>warn_missing_doc</b>(Conf, ExpectedWarnings, Options) -&gt;
<a name="461"/>  461:     ModuleName = ?get_name(),
<a name="462"/>  462:     {ok, ModName, Ws} =
<a name="463"/>  463:         default_compile_file(Conf, ModuleName, [return_warnings, report | Options]),
<a name="464"/>  464: 
<a name="465"/>  465:     {ok, {docs_v1, _,_, _, none, _,
<a name="466"/>  466:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,_},
<a name="467"/>  467:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="468"/>  468:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="469"/>  469:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,_},
<a name="470"/>  470:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="471"/>  471:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,_}]}
<a name="472"/>  472:     } = code:get_doc(ModName),
<a name="473"/>  473: 
<a name="warn_missing_doc-last_expr"/><a name="474"/>  474:     case ExpectedWarnings of
<a name="475"/>  475:         [] -&gt;
<a name="476"/>  476:             ?assertEqual([],Ws);
<a name="477"/>  477:         _ -&gt;
<a name="478"/>  478:             [{File,Warnings} | Hrl] = Ws,
<a name="479"/>  479:             ExpectedWarningCount = 1 + lists:sum(
<a name="480"/>  480:                                          lists:flatten(
<a name="481"/>  481:                                            [[2 || lists:member(type, ExpectedWarnings)],
<a name="482"/>  482:                                             [1 || lists:member(callback, ExpectedWarnings)],
<a name="483"/>  483:                                             [2 || lists:member(function, ExpectedWarnings)]])),
<a name="484"/>  484: 
<a name="485"/>  485:             ?assertEqual(&quot;warn_missing_doc.erl&quot;, filename:basename(File)),
<a name="486"/>  486:             ?assertEqual(ExpectedWarningCount, length(Warnings)),
<a name="487"/>  487:             ?assertMatch({1, beam_doc, missing_moduledoc}, lists:nth(1, Warnings)),
<a name="488"/>  488:             TypePos =
<a name="489"/>  489:                 case lists:member(type, ExpectedWarnings) of
<a name="490"/>  490:                     true -&gt;
<a name="491"/>  491:                         ?assertMatch({{6,2}, beam_doc, {missing_doc, {type,test,0}}}, lists:nth(2, Warnings)),
<a name="492"/>  492:                         ?assertMatch({{7,2}, beam_doc, {missing_doc, {type,test,1}}}, lists:nth(3, Warnings)),
<a name="493"/>  493:                         4;
<a name="494"/>  494:                     false -&gt;
<a name="495"/>  495:                         2
<a name="496"/>  496:                 end,
<a name="497"/>  497: 
<a name="498"/>  498:             CBPos =
<a name="499"/>  499:                 case lists:member(callback, ExpectedWarnings) of
<a name="500"/>  500:                     true -&gt;
<a name="501"/>  501:                         ?assertMatch({{9,2}, beam_doc, {missing_doc, {callback,test,0}}}, lists:nth(TypePos, Warnings)),
<a name="502"/>  502:                         TypePos + 1;
<a name="503"/>  503:                     false -&gt;
<a name="504"/>  504:                         TypePos
<a name="505"/>  505:                 end,
<a name="506"/>  506: 
<a name="507"/>  507:             case lists:member(function, ExpectedWarnings) of
<a name="508"/>  508:                 true -&gt;
<a name="509"/>  509:                     ?assertMatch({{13,1}, beam_doc, {missing_doc, {function,test,0}}}, lists:nth(CBPos, Warnings)),
<a name="510"/>  510:                     ?assertMatch({{14,1}, beam_doc, {missing_doc, {function,test,1}}}, lists:nth(CBPos+1, Warnings)),
<a name="511"/>  511:                     [{HrlFile, HrlWarnings}] = Hrl,
<a name="512"/>  512:                     ?assertEqual(&quot;warn_missing_doc.hrl&quot;, filename:basename(HrlFile)),
<a name="513"/>  513:                     ?assertEqual(1, length(HrlWarnings)),
<a name="514"/>  514:                     ?assertMatch({{2,1}, beam_doc, {missing_doc, {function,test,2}}}, lists:nth(1, HrlWarnings));
<a name="515"/>  515:                 false -&gt;
<a name="516"/>  516:                     ok
<a name="517"/>  517:             end
<a name="518"/>  518:     end.
<a name="519"/>  519: 
<a name="doc_with_file-1"/><a name="520"/>  520: <b>doc_with_file</b>(Conf) -&gt;
<a name="521"/>  521:     ModuleName = ?get_name(),
<a name="522"/>  522:     {ok, Cwd} = file:get_cwd(),
<a name="doc_with_file-last_expr"/><a name="523"/>  523:     try
<a name="524"/>  524:         ok = file:set_cwd(proplists:get_value(data_dir, Conf)),
<a name="525"/>  525:         {ok, ModName} = default_compile_file(Conf, ModuleName, [{i, &quot;./folder&quot;}]),
<a name="526"/>  526:         {ok, {docs_v1, ModuleAnno,_, _, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# README\n\nThis is a test&quot;&gt;&gt;}, _,
<a name="527"/>  527:               [{{type,bar,1},_,[&lt;&lt;&quot;bar(X)&quot;&gt;&gt;],none,#{exported := false}},
<a name="528"/>  528:                {{type,foo,1},_,[&lt;&lt;&quot;foo(X)&quot;&gt;&gt;],none,#{exported := true}},
<a name="529"/>  529:                {{type,private_type_exported,0},_,[&lt;&lt;&quot;private_type_exported()&quot;&gt;&gt;],
<a name="530"/>  530:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# TYPES\n\nTest&quot;&gt;&gt;}, #{exported := false}},
<a name="531"/>  531:                {{function,main2,1},Main2Anno,[&lt;&lt;&quot;main2(I)&quot;&gt;&gt;],
<a name="532"/>  532:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# File\n\ntesting fetching docs from other folders&quot;&gt;&gt;}, #{}},
<a name="533"/>  533:                {{function,main,1},_,[&lt;&lt;&quot;main(Var)&quot;&gt;&gt;],
<a name="534"/>  534:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# Fun\n\nTest importing function&quot;&gt;&gt;},#{}}]}} = code:get_doc(ModName),
<a name="535"/>  535: 
<a name="536"/>  536:         ?assertEqual(1, erl_anno:line(ModuleAnno)),
<a name="537"/>  537:         ?assertEqual(1, erl_anno:line(Main2Anno)),
<a name="538"/>  538:         ?assertEqual(&quot;./folder/FILE&quot;, erl_anno:file(Main2Anno)),
<a name="539"/>  539:         ok
<a name="540"/>  540:     after
<a name="541"/>  541:         ok = file:set_cwd(Cwd)
<a name="542"/>  542:     end.
<a name="543"/>  543: 
<a name="doc_with_file_error-1"/><a name="544"/>  544: <b>doc_with_file_error</b>(Conf) -&gt;
<a name="545"/>  545:     ModuleName = ?get_name(),
<a name="546"/>  546:     {ok, _, Warnings} = default_compile_file(Conf, ModuleName, [return_warnings]),
<a name="547"/>  547: 
<a name="548"/>  548:     [{File,
<a name="549"/>  549:       [{{6,2},epp,{moduledoc,file,&quot;doesnotexist&quot;}},
<a name="550"/>  550:        {{8,2},epp,{doc,file,&quot;doesnotexist&quot;}},
<a name="551"/>  551:        {{11,2},epp,{doc,file,&quot;doesnotexist&quot;}}]}] = Warnings,
<a name="552"/>  552: 
<a name="553"/>  553:     ?assertEqual(&quot;doc_with_file_error.erl&quot;, filename:basename(File)),
<a name="554"/>  554: 
<a name="555"/>  555:     {ok, _} = default_compile_file(Conf, ModuleName, [report]),
<a name="556"/>  556: 
<a name="doc_with_file_error-last_expr"/><a name="557"/>  557:     ok.
<a name="558"/>  558: 
<a name="all_string_formats-1"/><a name="559"/>  559: <b>all_string_formats</b>(Conf) -&gt;
<a name="560"/>  560:     ModuleName = ?get_name(),
<a name="561"/>  561:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="562"/>  562: 
<a name="563"/>  563:     {ok, {docs_v1, _ModuleAnno,_, _, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;}, _,
<a name="564"/>  564:               [
<a name="565"/>  565:                {{function,six,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;all_string_formats-all_string_formats&quot;&gt;&gt;}, #{}},
<a name="566"/>  566:                {{function,five,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;all_string_formats-Doc module&quot;&gt;&gt;}, #{}},
<a name="567"/>  567:                {{function,four,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test mödule&quot;/utf8&gt;&gt;}, #{}},
<a name="568"/>  568:                {{function,three,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doctestmodule&quot;&gt;&gt;}, #{}},
<a name="569"/>  569:                {{function,two,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt;}, #{}},
<a name="570"/>  570:                {{function,one,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt;}, #{}}
<a name="571"/>  571:               ]}} = code:get_doc(ModName),
<a name="all_string_formats-last_expr"/><a name="572"/>  572:     ok.
<a name="573"/>  573: 
<a name="spec_switch_order-1"/><a name="574"/>  574: <b>spec_switch_order</b>(Conf) -&gt;
<a name="575"/>  575:   ModuleName = ?get_name(),
<a name="576"/>  576:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="577"/>  577: 
<a name="578"/>  578:     {ok, {docs_v1, _ModuleAnno,_, _, _, _,
<a name="579"/>  579:           [NotFalse, Other, Bar, Foo]}} = code:get_doc(ModName),
<a name="580"/>  580:   {{function,not_false,0}, {52,1}, [&lt;&lt;&quot;not_false()&quot;&gt;&gt;], none,#{}} = NotFalse,
<a name="581"/>  581:   {{function,other,0},{36,2},[&lt;&lt;&quot;other()&quot;&gt;&gt;],hidden,#{}} = Other,
<a name="582"/>  582:   {{function,bar,1},{30,2},[&lt;&lt;&quot;bar(X)&quot;&gt;&gt;],hidden,#{}} = Bar,
<a name="spec_switch_order-last_expr"/><a name="583"/>  583: <b>  {{function,foo,1}, {22, 2}, [&lt;&lt;&quot;foo</b>(Var)&quot;&gt;&gt;], #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Foo does X&quot;&gt;&gt; }, #{}} = Foo.
<a name="584"/>  584: 
<a name="skip_doc-1"/><a name="585"/>  585: <b>skip_doc</b>(Conf) -&gt;
<a name="586"/>  586:   ModuleName =?get_name(),
<a name="587"/>  587:   {ok, ModName} = default_compile_file(Conf, ModuleName, [no_docs]),
<a name="588"/>  588: 
<a name="589"/>  589:   {ok,{docs_v1,0,erlang,&lt;&lt;&quot;application/erlang+html&quot;&gt;&gt;,none,
<a name="590"/>  590:      #{generated := true,
<a name="591"/>  591:        otp_doc_vsn := {1,0,0}},
<a name="592"/>  592:        [{{function,main,0},{8,1},[&lt;&lt;&quot;main/0&quot;&gt;&gt;],none,#{}},
<a name="593"/>  593:         {{function,foo,1},{16,1},[&lt;&lt;&quot;foo/1&quot;&gt;&gt;],none,#{}}]}} = code:get_doc(ModName),
<a name="594"/>  594: 
<a name="595"/>  595:   {error, missing} =
<a name="596"/>  596:       code:get_doc(ModName, #{ sources =&gt; [eep48] }),
<a name="597"/>  597: 
<a name="598"/>  598:   {ok, _ModName} = compile_file(Conf, ModuleName, [report, return_errors, no_docs]),
<a name="599"/>  599:   {error, missing} = code:get_doc(ModName),
<a name="skip_doc-last_expr"/><a name="600"/>  600:   ok.
<a name="601"/>  601: 
<a name="no_doc_attributes-1"/><a name="602"/>  602: <b>no_doc_attributes</b>(Conf) -&gt;
<a name="603"/>  603:   ModuleName =?get_name(),
<a name="604"/>  604:   {ok, ModName} = default_compile_file(Conf, ModuleName, []),
<a name="605"/>  605: 
<a name="606"/>  606:   {error, missing} =
<a name="607"/>  607:       code:get_doc(ModName, #{ sources =&gt; [eep48] }),
<a name="608"/>  608: 
<a name="no_doc_attributes-last_expr"/><a name="609"/>  609:   ok.
<a name="610"/>  610: 
<a name="docs_from_ast-1"/><a name="611"/>  611: <b>docs_from_ast</b>(_Conf) -&gt;
<a name="612"/>  612:     Code = &quot;&quot;&quot;
<a name="613"/>  613:       -module(test).
<a name="614"/>  614:       -moduledoc &quot;moduledoc&quot;.
<a name="615"/>  615:       -export([main/0]).
<a name="616"/>  616:       -doc &quot;main&quot;.
<a name="617"/>  617:       main() -&gt; ok.
<a name="618"/>  618:       &quot;&quot;&quot;,
<a name="619"/>  619: 
<a name="620"/>  620:     {ok, test, BeamCode} = compile:forms(scan_and_parse(Code),[debug_info]),
<a name="621"/>  621:     {ok, {test, [{documentation, Docs }]}} = beam_lib:chunks(BeamCode, [documentation]),
<a name="622"/>  622: 
<a name="623"/>  623:     ?assertMatch(
<a name="624"/>  624:        #docs_v1{ module_doc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;moduledoc&quot;&gt;&gt; },
<a name="625"/>  625:                  anno = 2,
<a name="626"/>  626:                  docs = [{{function,main,0}, 4, _, #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;main&quot;&gt;&gt; }, _}]},
<a name="627"/>  627:        Docs),
<a name="628"/>  628: 
<a name="629"/>  629:     check_no_doc_attributes(BeamCode),
<a name="630"/>  630: 
<a name="631"/>  631:     {ok, test, BeamCodeWSource} = compile:forms(scan_and_parse(Code),[beam_docs, debug_info, {source, &quot;test.erl&quot;}]),
<a name="632"/>  632:     {ok, {test, [{documentation, DocsWSource }]}} = beam_lib:chunks(BeamCodeWSource, [documentation]),
<a name="633"/>  633: 
<a name="634"/>  634:     ?assertMatch(
<a name="635"/>  635:        #docs_v1{ module_doc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;moduledoc&quot;&gt;&gt; },
<a name="636"/>  636:                  anno = 2,
<a name="637"/>  637:                  docs = [{{function,main,0}, 4,
<a name="638"/>  638:                           _, #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;main&quot;&gt;&gt; }, _}]},
<a name="639"/>  639:        DocsWSource),
<a name="640"/>  640:     check_no_doc_attributes(BeamCodeWSource),
<a name="docs_from_ast-last_expr"/><a name="641"/>  641:     ok.
<a name="642"/>  642: 
<a name="643"/>  643: <i>%% Test that EEP-48 standardized metadata keys are converted from chardata to binary</i>
<a name="converted_metadata-1"/><a name="644"/>  644: <b>converted_metadata</b>(Config) -&gt;
<a name="645"/>  645:     ModuleName = ?get_name(),
<a name="646"/>  646:     {ok, ModName, []} = default_compile_file(Config, ModuleName, [return_warnings, report]),
<a name="647"/>  647: 
<a name="648"/>  648:     {ok, {docs_v1, _ModuleAnno,_, _, _, DocMetadata,
<a name="649"/>  649:           [Test]}} = code:get_doc(ModName),
<a name="650"/>  650:     ?assertMatch(#{ format := ~&quot;custom&quot; }, DocMetadata),
<a name="651"/>  651:     ?assertMatch(#{ since := ~&quot;1.0&quot; }, DocMetadata),
<a name="652"/>  652:     ?assertMatch(#{ deprecated := ~&quot;yes&quot; }, DocMetadata),
<a name="653"/>  653:     ?assertMatch(#{ authors := [~&quot;me&quot;,~&quot;myself&quot;,~&quot;I&quot;] }, DocMetadata),
<a name="654"/>  654:     {{function,test,0}, _, [_], none,TestMetadata} = Test,
<a name="655"/>  655:     ?assertMatch(#{ since := ~&quot;1.0&quot; }, TestMetadata),
<a name="656"/>  656:     ?assertMatch(#{ deprecated := ~&quot;yes&quot; }, TestMetadata),
<a name="657"/>  657:     ?assertMatch(#{ equiv := ~&quot;other&quot; }, TestMetadata),
<a name="658"/>  658:     ?assertMatch(#{ group := ~&quot;collection&quot; }, TestMetadata),
<a name="659"/>  659: 
<a name="converted_metadata-last_expr"/><a name="660"/>  660:     ok.
<a name="661"/>  661: 
<a name="converted_metadata_warnings-1"/><a name="662"/>  662: <b>converted_metadata_warnings</b>(Config) -&gt;
<a name="663"/>  663:     ModuleName = ?get_name(),
<a name="664"/>  664:     {ok, ModName, Ws} = default_compile_file(Config, ModuleName, [return_warnings, report]),
<a name="665"/>  665: 
<a name="666"/>  666:     {ok, {docs_v1, _ModuleAnno,_, _, _, DocMetadata,
<a name="667"/>  667:           [Test]}} = code:get_doc(ModName),
<a name="668"/>  668:     ?assertMatch(#{ format := custom }, DocMetadata),
<a name="669"/>  669:     ?assertMatch(#{ since := 1.0 }, DocMetadata),
<a name="670"/>  670:     ?assertMatch(#{ deprecated := yes }, DocMetadata),
<a name="671"/>  671:     ?assertMatch(#{ authors := [me,[myself],{'I'}] }, DocMetadata),
<a name="672"/>  672: 
<a name="673"/>  673:     {{function,test,0}, _, [_], none,TestMetadata} = Test,
<a name="674"/>  674:     ?assertMatch(#{ since := 1.0 }, TestMetadata),
<a name="675"/>  675:     ?assertMatch(#{ deprecated := yes }, TestMetadata),
<a name="676"/>  676:     ?assertMatch(#{ equiv := other }, TestMetadata),
<a name="677"/>  677:     ?assertMatch(#{ group := collection }, TestMetadata),
<a name="678"/>  678: 
<a name="679"/>  679:     [{_File,
<a name="680"/>  680:         [Authors, ModDocDeprecated, Format, ModDocSince,
<a name="681"/>  681:          DocDeprecated, Equiv, Group, DocSinse]}] = Ws,
<a name="682"/>  682: 
<a name="683"/>  683:     ModDocAnno = {3,2},
<a name="684"/>  684:     ?assertMatch({ModDocAnno, beam_doc, {invalid_metadata, authors}}, Authors),
<a name="685"/>  685:     ?assertMatch({ModDocAnno, beam_doc, {invalid_metadata, deprecated}}, ModDocDeprecated),
<a name="686"/>  686:     ?assertMatch({ModDocAnno, beam_doc, {invalid_metadata, format}}, Format),
<a name="687"/>  687:     ?assertMatch({ModDocAnno, beam_doc, {invalid_metadata, since}}, ModDocSince),
<a name="688"/>  688: 
<a name="689"/>  689:     DocAnno = {9,2},
<a name="690"/>  690:     ?assertMatch({DocAnno, beam_doc, {invalid_metadata, deprecated}}, DocDeprecated),
<a name="691"/>  691:     ?assertMatch({DocAnno, beam_doc, {invalid_metadata, equiv}}, Equiv),
<a name="692"/>  692:     ?assertMatch({DocAnno, beam_doc, {invalid_metadata, group}}, Group),
<a name="693"/>  693:     ?assertMatch({DocAnno, beam_doc, {invalid_metadata, since}}, DocSinse),
<a name="694"/>  694: 
<a name="converted_metadata_warnings-last_expr"/><a name="695"/>  695:     ok.
<a name="696"/>  696: 
<a name="scan_and_parse-1"/><a name="697"/>  697: <b>scan_and_parse</b>(Code) -&gt;
<a name="698"/>  698:     {ok, Toks, _} = erl_scan:string(Code),
<a name="scan_and_parse-last_expr"/><a name="699"/>  699: <b>    parse</b>(Toks).
<a name="700"/>  700: 
<a name="parse-1"/><a name="701"/>  701: <b>parse</b>([]) -&gt; [];
<a name="702"/>  702: <b>parse</b>(Toks) -&gt;
<a name="703"/>  703:     {Form, [Dot | Rest]} = lists:splitwith(fun(E) -&gt; element(1,E) =/= dot end, Toks),
<a name="704"/>  704:     {ok, F} = erl_parse:parse_form(Form ++ [Dot]),
<a name="parse-last_expr"/><a name="705"/>  705: <b>    [F | parse</b>(Rest)].
<a name="706"/>  706: 
<a name="compile_file-3"/><a name="707"/>  707: <b>compile_file</b>(Conf, ModuleName, ExtraOpts) -&gt;
<a name="708"/>  708:     Filename = data_file_path(Conf, ModuleName),
<a name="709"/>  709:     io:format(&quot;Compiling: ~ts~n~p~n&quot;,[Filename, ExtraOpts]),
<a name="compile_file-last_expr"/><a name="710"/>  710: <b>    case compile:file</b>(Filename, ExtraOpts) of
<a name="711"/>  711:         Res when element(1, Res) =:= ok -&gt;
<a name="712"/>  712:             ModName = element(2, Res),
<a name="713"/>  713:             case lists:search(fun (X) -&gt; X =:= no_docs end, ExtraOpts) of
<a name="714"/>  714:               false when length(ExtraOpts) &gt; 0 -&gt;
<a name="715"/>  715:                 check_no_doc_attributes(code:which(ModName)),
<a name="716"/>  716:                 Res;
<a name="717"/>  717:               _ -&gt;
<a name="718"/>  718:                 Res
<a name="719"/>  719:             end;
<a name="720"/>  720:         Else -&gt;
<a name="721"/>  721:             Else
<a name="722"/>  722:     end.
<a name="723"/>  723: 
<a name="data_file_path-2"/><a name="724"/>  724: <b>data_file_path</b>(Conf, ModuleName) -&gt;
<a name="725"/>  725:     ErlModName = ModuleName ++ &quot;.erl&quot;,
<a name="data_file_path-last_expr"/><a name="726"/>  726: <b>    filename:join</b>(proplists:get_value(data_dir, Conf), ErlModName).
<a name="727"/>  727: 
<a name="default_compile_file-2"/><a name="728"/>  728: <b>default_compile_file</b>(Conf, ModuleName) -&gt;
<a name="default_compile_file-last_expr"/><a name="729"/>  729: <b>  default_compile_file</b>(Conf, ModuleName, []).
<a name="default_compile_file-3"/><a name="730"/>  730: <b>default_compile_file</b>(Conf, ModuleName, ExtraOpts) -&gt;
<a name="default_compile_file-last_expr"/><a name="731"/>  731: <b>  compile_file</b>(Conf, ModuleName, [report, return_errors, debug_info] ++ ExtraOpts).
<a name="732"/>  732: 
<a name="733"/>  733: 
<a name="734"/>  734: <i>%% Verify that all doc and moduledoc attributes are stripped from debug_info</i>
<a name="check_no_doc_attributes-1"/><a name="735"/>  735: <b>check_no_doc_attributes</b>(Mod) -&gt;
<a name="736"/>  736:     {ok, {_ModName,
<a name="737"/>  737:           [{debug_info,
<a name="738"/>  738:             {debug_info_v1,erl_abstract_code,
<a name="739"/>  739:              {AST, Opts}}}]}} = beam_lib:chunks(Mod, [debug_info]),
<a name="740"/>  740:     false = lists:search(
<a name="741"/>  741:               fun(E) -&gt;
<a name="742"/>  742:                       element(1,E) == attribute
<a name="743"/>  743:                           andalso
<a name="744"/>  744:                             (element(3,E) == doc orelse element(3,E) == moduledoc)
<a name="745"/>  745:               end, AST),
<a name="746"/>  746:     false = lists:member(no_docs, Opts),
<a name="check_no_doc_attributes-last_expr"/><a name="747"/>  747:     ok.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
