<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/jinterface/make_test_dir/jinterface_test/nc_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2004-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(nc_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: 
<a name="23"/>   23: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="24"/>   24: 
<a name="25"/>   25: <b>-define</b>(VERSION_MAGIC,       131).
<a name="26"/>   26: 
<a name="27"/>   27: <b>-define</b>(ATOM_EXT,            100).
<a name="28"/>   28: <b>-define</b>(REFERENCE_EXT,       101).
<a name="29"/>   29: <b>-define</b>(PORT_EXT,            102).
<a name="30"/>   30: <b>-define</b>(PID_EXT,             103).
<a name="31"/>   31: <b>-define</b>(NEW_REFERENCE_EXT,   114).
<a name="32"/>   32: <b>-define</b>(ATOM_UTF8_EXT,       118).
<a name="33"/>   33: <b>-define</b>(SMALL_ATOM_UTF8_EXT, 119).
<a name="34"/>   34: <b>-define</b>(NEW_PID_EXT,         $X).
<a name="35"/>   35: <b>-define</b>(NEW_PORT_EXT,        $Y).
<a name="36"/>   36: <b>-define</b>(NEWER_REFERENCE_EXT, $Z).
<a name="37"/>   37: <b>-define</b>(V4_PORT_EXT,        $x).
<a name="38"/>   38: 
<a name="39"/>   39: <b>-define</b>(OLD_MAX_PIDS_PORTS, ((1 bsl 28) - 1)).
<a name="40"/>   40: 
<a name="41"/>   41: <b>-export</b>([all/0, suite/0,groups/0,init_per_group/2,end_per_group/2,
<a name="42"/>   42: 	 init_per_suite/1,
<a name="43"/>   43: 	 end_per_suite/1,
<a name="44"/>   44: 	 init_per_testcase/2,
<a name="45"/>   45: 	 end_per_testcase/2]).
<a name="46"/>   46: 
<a name="47"/>   47: <b>-export</b>([pid_roundtrip/1,
<a name="48"/>   48: 	 port_roundtrip/1,
<a name="49"/>   49: 	 ref_roundtrip/1,
<a name="50"/>   50: 	 new_float/1,
<a name="51"/>   51: 	 old_stuff/1,
<a name="52"/>   52: 	 binary_roundtrip/1,
<a name="53"/>   53: 	 decompress_roundtrip/1,
<a name="54"/>   54: 	 compress_roundtrip/1,
<a name="55"/>   55: 	 integer_roundtrip/1,
<a name="56"/>   56: 	 fun_roundtrip/1,
<a name="57"/>   57: 	 lists_roundtrip/1,
<a name="58"/>   58: 	 lists_roundtrip_2/1,
<a name="59"/>   59: 	 lists_iterator/1,
<a name="60"/>   60: 	 unicode/1,
<a name="61"/>   61: 	 unicode_list_to_string/1,
<a name="62"/>   62: 	 unicode_string_to_list/1,
<a name="63"/>   63: 	 utf8_atom/1,
<a name="64"/>   64: 	 utf8_pid/1,
<a name="65"/>   65: 	 utf8_port/1,
<a name="66"/>   66: 	 utf8_ref/1,
<a name="67"/>   67: 	 connect/1]).
<a name="68"/>   68: 
<a name="69"/>   69: 
<a name="70"/>   70: <i>%% Top of cases</i>
<a name="71"/>   71: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="72"/>   72: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="73"/>   73: 
<a name="all-0"/><a name="74"/>   74: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="75"/>   75:     [pid_roundtrip, port_roundtrip, ref_roundtrip,
<a name="76"/>   76:      new_float, old_stuff, binary_roundtrip,
<a name="77"/>   77:      decompress_roundtrip, compress_roundtrip,
<a name="78"/>   78:      integer_roundtrip, fun_roundtrip, lists_roundtrip,
<a name="79"/>   79:      lists_roundtrip_2, lists_iterator, unicode,
<a name="80"/>   80:      unicode_list_to_string, unicode_string_to_list,
<a name="81"/>   81:      utf8_atom, utf8_pid, utf8_port, utf8_ref,
<a name="82"/>   82:      connect].
<a name="83"/>   83: 
<a name="groups-0"/><a name="84"/>   84: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="85"/>   85:     [].
<a name="86"/>   86: 
<a name="init_per_group-2"/><a name="87"/>   87: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="88"/>   88:     Config.
<a name="89"/>   89: 
<a name="end_per_group-2"/><a name="90"/>   90: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="91"/>   91:     Config.
<a name="92"/>   92: 
<a name="init_per_suite-1"/><a name="93"/>   93: <b>init_per_suite</b>(Config) when is_list(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="94"/>   94: <b>    case case code:priv_dir</b>(jinterface) of
<a name="95"/>   95: 	     {error,bad_name} -&gt; false;
<a name="96"/>   96: 	     P -&gt; filelib:is_dir(P) end of
<a name="97"/>   97: 	true -&gt;
<a name="98"/>   98: 	    jitu:init_all(Config);
<a name="99"/>   99: 	false -&gt;
<a name="100"/>  100: 	    {skip,&quot;No jinterface application&quot;}
<a name="101"/>  101:     end.
<a name="102"/>  102: 
<a name="end_per_suite-1"/><a name="103"/>  103: <b>end_per_suite</b>(Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="104"/>  104: <b>    jitu:finish_all</b>(Config).
<a name="105"/>  105: 
<a name="106"/>  106: 
<a name="107"/>  107: 
<a name="108"/>  108: <i>%% Add/remove watchdog before/after each test case.</i>
<a name="109"/>  109: <i>%%</i>
<a name="init_per_testcase-2"/><a name="110"/>  110: <b>init_per_testcase</b>(Case, Config) -&gt;
<a name="111"/>  111:     T = case atom_to_list(Case) of
<a name="112"/>  112: 	    &quot;unicode&quot;++_ -&gt; 240;
<a name="113"/>  113: 	    _ -&gt; 120
<a name="114"/>  114: 	end,
<a name="115"/>  115:     WatchDog = test_server:timetrap(test_server:seconds(T)),
<a name="init_per_testcase-last_expr"/><a name="116"/>  116:     [{watchdog, WatchDog}| Config].
<a name="117"/>  117: 
<a name="end_per_testcase-2"/><a name="118"/>  118: <b>end_per_testcase</b>(_Case, Config) -&gt;
<a name="119"/>  119:     jitu:kill_all_jnodes(),
<a name="120"/>  120:     WatchDog = ?config(watchdog, Config),
<a name="end_per_testcase-last_expr"/><a name="121"/>  121: <b>    test_server:timetrap_cancel</b>(WatchDog).
<a name="122"/>  122: 
<a name="123"/>  123: 
<a name="124"/>  124: <i>%%</i>
<a name="125"/>  125: <i>%% Test cases</i>
<a name="126"/>  126: <i>%%</i>
<a name="127"/>  127: 
<a name="pid_roundtrip-1"/><a name="128"/>  128: <b>pid_roundtrip</b>(Config) when is_list(Config)-&gt;
<a name="129"/>  129:     ThisNode = {node(), erlang:system_info(creation)},
<a name="130"/>  130:     RemPids = [mk_pid({gurka@sallad, Cr}, Num, Ser)
<a name="131"/>  131: 	       || Cr &lt;- [1,2,3,4,16#adec0ded],
<a name="132"/>  132: 		  {Num, Ser} &lt;- [{4711,4711},{32767, 8191}]],
<a name="pid_roundtrip-last_expr"/><a name="133"/>  133: <b>    do_echo</b>([self(),
<a name="134"/>  134: 	     mk_pid(ThisNode, 4711, 0),
<a name="135"/>  135: 	     mk_pid(ThisNode, 1 bsl 27, 0)
<a name="136"/>  136: 	     | RemPids],
<a name="137"/>  137: 	    Config).
<a name="138"/>  138: 
<a name="fun_roundtrip-1"/><a name="139"/>  139: <b>fun_roundtrip</b>(Config) when is_list(Config)-&gt;
<a name="fun_roundtrip-last_expr"/><a name="140"/>  140: <b>    do_echo</b>([fun(A, B) -&gt; A + B end,
<a name="141"/>  141: 	     fun(A) -&gt; lists:reverse(A) end,
<a name="142"/>  142: 	     fun() -&gt; ok end,
<a name="143"/>  143: 	     fun fun_roundtrip/1,
<a name="144"/>  144:              fun ?MODULE:fun_roundtrip/1],
<a name="145"/>  145: 	    Config).
<a name="146"/>  146: 
<a name="port_roundtrip-1"/><a name="147"/>  147: <b>port_roundtrip</b>(Config) when is_list(Config)-&gt;
<a name="148"/>  148:     ThisNode = {node(), erlang:system_info(creation)},
<a name="149"/>  149:     RemPorts = [mk_port({gurka@sallad, Cr}, Num)
<a name="150"/>  150: 		|| Cr &lt;- [1,2,3,4,16#adec0ded],
<a name="151"/>  151: 		   Num &lt;- [4711, 268435455]]
<a name="152"/>  152:     %% V4 ports
<a name="153"/>  153:         ++ [mk_port({gurka@sallad, Cr}, Num)
<a name="154"/>  154:             || Cr &lt;- [17, 4711, 16#adec0ded],
<a name="155"/>  155:                Num &lt;- [(1 bsl 47) bor (1 bsl 25),
<a name="156"/>  156:                        (1 bsl 57) bor (1 bsl 23)]],
<a name="port_roundtrip-last_expr"/><a name="157"/>  157: <b>    do_echo</b>([hd(erlang:ports()),
<a name="158"/>  158: 	     mk_port(ThisNode, 4711),
<a name="159"/>  159: 	     mk_port(ThisNode, 268435455)
<a name="160"/>  160: 	     | RemPorts],
<a name="161"/>  161: 	    Config).
<a name="162"/>  162: 
<a name="ref_roundtrip-1"/><a name="163"/>  163: <b>ref_roundtrip</b>(Config) when is_list(Config)-&gt;
<a name="164"/>  164:     ThisNode = {node(), erlang:system_info(creation)},
<a name="165"/>  165:     RemRefs = [mk_ref({gurka@sallad, Cr}, Words)
<a name="166"/>  166: 	       || Cr &lt;- [1,2,3,4,16#adec0ded],
<a name="167"/>  167: 		  Words &lt;- [[4711],
<a name="168"/>  168: 			    [4711, 4711, 4711],
<a name="169"/>  169: 			    [262143, 4294967295, 4294967295],
<a name="170"/>  170:                             [262143, 4294967295, 4294967294, 4294967293, 4294967292]]],
<a name="ref_roundtrip-last_expr"/><a name="171"/>  171: <b>    do_echo</b>([make_ref(),
<a name="172"/>  172: 	     mk_ref(ThisNode, [4711]),
<a name="173"/>  173: 	     mk_ref(ThisNode, [4711, 4711, 4711]),
<a name="174"/>  174: 	     mk_ref(ThisNode, [262143, 4294967295, 4294967295])
<a name="175"/>  175: 	     | RemRefs],
<a name="176"/>  176: 	    Config).
<a name="177"/>  177: 
<a name="new_float-1"/><a name="178"/>  178: <b>new_float</b>(Config) when is_list(Config)-&gt;
<a name="179"/>  179:     Two16 = float(1 bsl 16),
<a name="180"/>  180:     X = math:sqrt(2),
<a name="181"/>  181:     Floats = lists:reverse(seq(1/X, 63, fun(Y) -&gt; Y / Two16 end),
<a name="182"/>  182: 			   [0.0|seq(X, 63, fun(Y) -&gt; Y * Two16 end)]),
<a name="183"/>  183:     io:format(&quot;~w&quot;, [Floats]),
<a name="new_float-last_expr"/><a name="184"/>  184: <b>    do_echo</b>(Floats, Config).
<a name="185"/>  185: 
<a name="old_stuff-1"/><a name="186"/>  186: <b>old_stuff</b>(Config) when is_list(Config)-&gt;
<a name="187"/>  187:     Terms = [0.0,math:sqrt(2)],
<a name="188"/>  188:     OutTrans =
<a name="189"/>  189: 	fun (D) -&gt;
<a name="190"/>  190: 		{self(),term_to_binary(D, [{minor_version,0}]),binary}
<a name="191"/>  191: 	end,
<a name="192"/>  192:     InTrans =
<a name="193"/>  193: 	fun (Echoer, D, {Echoer,D,binary}) -&gt;
<a name="194"/>  194: 		ok
<a name="195"/>  195: 	end,
<a name="old_stuff-last_expr"/><a name="196"/>  196: <b>    do_echo</b>(Terms, Config, OutTrans, InTrans).
<a name="197"/>  197: 
<a name="binary_roundtrip-1"/><a name="198"/>  198: <b>binary_roundtrip</b>(Config) when is_list(Config) -&gt;
<a name="binary_roundtrip-last_expr"/><a name="199"/>  199: <b>    do_echo</b>([&lt;&lt;17&gt;&gt;,
<a name="200"/>  200: 	     &lt;&lt;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17&gt;&gt;,
<a name="201"/>  201: 	     &lt;&lt;3:2&gt;&gt;,
<a name="202"/>  202: 	     &lt;&lt;3,7:3&gt;&gt;,
<a name="203"/>  203: 	     &lt;&lt;&gt;&gt;],
<a name="204"/>  204: 	    Config).
<a name="205"/>  205: 
<a name="decompress_roundtrip-1"/><a name="206"/>  206: <b>decompress_roundtrip</b>(Config) when is_list(Config) -&gt;
<a name="207"/>  207: 	RandomBin = erlang:term_to_binary(lists:seq(1, 5 * 1024 * 1024)), % roughly 26MB
<a name="208"/>  208: 	&lt;&lt;RandomBin1k:1024/binary,_/binary&gt;&gt; = RandomBin,
<a name="209"/>  209: 	&lt;&lt;RandomBin1M:1048576/binary,_/binary&gt;&gt; = RandomBin,
<a name="210"/>  210: 	&lt;&lt;RandomBin10M:10485760/binary,_/binary&gt;&gt; = RandomBin,
<a name="211"/>  211:     Terms =
<a name="212"/>  212: 	[{},
<a name="213"/>  213: 	 {a,b,c},
<a name="214"/>  214: 	 [],
<a name="215"/>  215: 	 0.0,
<a name="216"/>  216: 	 math:sqrt(2),
<a name="217"/>  217: 	 &lt;&lt;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,31:5&gt;&gt;,
<a name="218"/>  218: 	 &quot;{}&quot;,
<a name="219"/>  219: 	 RandomBin1k,
<a name="220"/>  220: 	 RandomBin1M,
<a name="221"/>  221: 	 RandomBin10M,
<a name="222"/>  222: 	 RandomBin,
<a name="223"/>  223: 	 make_ref()],
<a name="224"/>  224:     OutTrans =
<a name="225"/>  225: 	fun (D) -&gt;
<a name="226"/>  226: 		{self(),term_to_binary(D, [compressed]),binary}
<a name="227"/>  227: 	end,
<a name="228"/>  228:     InTrans =
<a name="229"/>  229: 	fun (Echoer, D, {Echoer,D,binary}) -&gt;
<a name="230"/>  230: 		ok
<a name="231"/>  231: 	end,
<a name="decompress_roundtrip-last_expr"/><a name="232"/>  232: <b>    do_echo</b>(Terms, Config, OutTrans, InTrans).
<a name="233"/>  233: 
<a name="compress_roundtrip-1"/><a name="234"/>  234: <b>compress_roundtrip</b>(Config) when is_list(Config) -&gt;
<a name="235"/>  235: 	RandomBin = erlang:term_to_binary(lists:seq(1, 5 * 1024 * 1024)), % roughly 26MB
<a name="236"/>  236: 	&lt;&lt;RandomBin1k:1024/binary,_/binary&gt;&gt; = RandomBin,
<a name="237"/>  237: 	&lt;&lt;RandomBin1M:1048576/binary,_/binary&gt;&gt; = RandomBin,
<a name="238"/>  238: 	&lt;&lt;RandomBin10M:10485760/binary,_/binary&gt;&gt; = RandomBin,
<a name="239"/>  239:     Terms =
<a name="240"/>  240: 	[{},
<a name="241"/>  241: 	 {a,b,c},
<a name="242"/>  242: 	 [],
<a name="243"/>  243: 	 0.0,
<a name="244"/>  244: 	 math:sqrt(2),
<a name="245"/>  245: 	 &lt;&lt;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,31:5&gt;&gt;,
<a name="246"/>  246: 	 &quot;{}&quot;,
<a name="247"/>  247: 	 RandomBin1k,
<a name="248"/>  248: 	 RandomBin1M,
<a name="249"/>  249: 	 RandomBin10M,
<a name="250"/>  250: 	 RandomBin,
<a name="251"/>  251: 	 make_ref()],
<a name="252"/>  252:     OutTrans =
<a name="253"/>  253: 	fun (D) -&gt;
<a name="254"/>  254: 		{self(),D,compress}
<a name="255"/>  255: 	end,
<a name="256"/>  256:     InTrans =
<a name="257"/>  257: 	fun (Echoer, D, {Echoer,B,compress}) -&gt;
<a name="258"/>  258: 		D = binary_to_term(B)
<a name="259"/>  259: 	end,
<a name="compress_roundtrip-last_expr"/><a name="260"/>  260: <b>    do_echo</b>(Terms, Config, OutTrans, InTrans).
<a name="261"/>  261: 
<a name="262"/>  262: 
<a name="263"/>  263: 
<a name="integer_roundtrip-1"/><a name="264"/>  264: <b>integer_roundtrip</b>(Config) when is_list(Config) -&gt;
<a name="265"/>  265:     Xs = [1 bsl X || X &lt;- [26,27,28,29,30,31,32,33,
<a name="266"/>  266: 			   62,63,64,65,
<a name="267"/>  267: 			   126,127,128,129]],
<a name="268"/>  268:     Terms = [0,1,-1,-2]
<a name="269"/>  269: 	++lists:flatmap(fun (X) -&gt; [X-2,X-1,X,-X+1,-X,-X-1] end,
<a name="270"/>  270: 			Xs),
<a name="271"/>  271:     io:format(&quot;~w&quot;, [Terms]),
<a name="272"/>  272:     OutTrans =
<a name="273"/>  273: 	fun (V) -&gt;
<a name="274"/>  274: 		{self(),V,bigint}
<a name="275"/>  275: 	end,
<a name="276"/>  276:     InTrans =
<a name="277"/>  277: 	fun (Echoer, V, {Echoer,{V,W,X,L,U},bigint}) -&gt;
<a name="278"/>  278: 		Bitlength = bitlength(V),
<a name="279"/>  279: 		{w,W} = {w,signum(V) * Bitlength},
<a name="280"/>  280: 		Y = V band 16#FFFFffffFFFFffff,
<a name="281"/>  281: 		{y,Y} = {y,X band 16#FFFFffffFFFFffff},
<a name="282"/>  282: 		{l,L} = {l,if  V =:= X, Bitlength &lt; 64 -&gt; 1;
<a name="283"/>  283: 			       true                    -&gt; 0  end},
<a name="284"/>  284: 		{u,U} = {u,if  V =:= Y, V &gt;= 0, Bitlength =&lt; 64 -&gt; 1;
<a name="285"/>  285: 			       true                             -&gt; 0  end}
<a name="286"/>  286: 	end,
<a name="integer_roundtrip-last_expr"/><a name="287"/>  287: <b>    do_echo</b>(Terms, Config, OutTrans, InTrans).
<a name="288"/>  288: 
<a name="signum-1"/><a name="289"/>  289: <b>signum</b>(V) when is_integer(V), V &gt; 0 -&gt;  1;
<a name="290"/>  290: <b>signum</b>(V) when is_integer(V), V &lt; 0 -&gt; -1;
<a name="signum-last_expr"/><a name="291"/>  291: <b>signum</b>(0) -&gt;                            0.
<a name="292"/>  292: 
<a name="bitlength-1"/><a name="293"/>  293: <b>bitlength</b>(0) -&gt;
<a name="294"/>  294:     0;
<a name="295"/>  295: <b>bitlength</b>(-1) -&gt;
<a name="296"/>  296:     0;
<a name="297"/>  297: <b>bitlength</b>(V) when is_integer(V) -&gt;
<a name="bitlength-last_expr"/><a name="298"/>  298: <b>    1 + bitlength</b>(V bsr 1).
<a name="299"/>  299: 
<a name="300"/>  300: 
<a name="301"/>  301: 
<a name="lists_roundtrip-1"/><a name="302"/>  302: <b>lists_roundtrip</b>(Config) when is_list(Config) -&gt;
<a name="303"/>  303:     Ls = [lists:seq(1,10),
<a name="304"/>  304: 	  lists:seq(11,17)++last_tail,
<a name="305"/>  305: 	  [{default}],
<a name="306"/>  306: 	  [car|cdr],
<a name="307"/>  307: 	  [[]],
<a name="308"/>  308: 	  []],
<a name="lists_roundtrip-last_expr"/><a name="309"/>  309: <b>    do_echo</b>(Ls, Config).
<a name="310"/>  310: 
<a name="311"/>  311: 
<a name="312"/>  312: 
<a name="lists_roundtrip_2-1"/><a name="313"/>  313: <b>lists_roundtrip_2</b>(Config) when is_list(Config) -&gt;
<a name="314"/>  314:     Ls = [{[a,b],tail},
<a name="315"/>  315: 	  {[c,d,e],tail},
<a name="316"/>  316: 	  {[],tail},
<a name="317"/>  317: 	  {[f],tail},
<a name="318"/>  318: 	  {[g,h|i],tail},
<a name="319"/>  319: 	  {[j,k,l|m],tail},
<a name="320"/>  320: 	  {[n|o],tail},
<a name="321"/>  321: 	  {[z,1,2,3,4],tail3},
<a name="322"/>  322: 	  {[z,5,6,7],tail3},
<a name="323"/>  323: 	  {[z,8,9],tail3},
<a name="324"/>  324: 	  {[z,10],tail3},
<a name="325"/>  325: 	  {[],tail3},
<a name="326"/>  326: 	  {[z,11,12,13,14|15],tail3},
<a name="327"/>  327: 	  {[z,16,17,18|19],tail3},
<a name="328"/>  328: 	  {[z,20,21|22],tail3},
<a name="329"/>  329: 	  {[z,23|24],tail3},
<a name="330"/>  330: 	  {[z|25],tail3},
<a name="331"/>  331: 	  {&quot;abc123&quot;,sub3atom},
<a name="332"/>  332: 	  {&quot;abc&quot;,sub3atom},
<a name="333"/>  333: 	  {&quot;abcdefg&quot;,codepointBug}
<a name="334"/>  334: 	 ],
<a name="335"/>  335:     Trans =
<a name="336"/>  336: 	fun ([_|T], tail) -&gt;
<a name="337"/>  337: 		T;
<a name="338"/>  338: 	    (L, tail) when is_list(L) -&gt;
<a name="339"/>  339: 		null;
<a name="340"/>  340: 	    ([_,_,_|T], tail3) -&gt;
<a name="341"/>  341: 		T;
<a name="342"/>  342: 	    (L, tail3) when is_list(L) -&gt;
<a name="343"/>  343: 		null;
<a name="344"/>  344: 	    ([_,_,_|L], sub3atom) -&gt;
<a name="345"/>  345: 		list_to_atom(L);
<a name="346"/>  346: 	    (L, codepointBug) -&gt;
<a name="347"/>  347: 		L
<a name="348"/>  348: 	end,
<a name="349"/>  349:     OutTrans =
<a name="350"/>  350: 	fun ({L,Twist}) -&gt;
<a name="351"/>  351: 		{self(),L,Twist}
<a name="352"/>  352: 	end,
<a name="353"/>  353:     InTrans =
<a name="354"/>  354: 	fun (Echoer, {L,Twist}, {Echoer,X,Twist}) -&gt;
<a name="355"/>  355: 		Y = Trans(L, Twist),
<a name="356"/>  356: 		io:format(&quot;## ~w ~w ~w ~w~n&quot;, [L,Twist,X,Y]),
<a name="357"/>  357: 		X = Y
<a name="358"/>  358: 	end,
<a name="lists_roundtrip_2-last_expr"/><a name="359"/>  359: <b>    do_echo</b>(Ls, Config, OutTrans, InTrans).
<a name="360"/>  360: 
<a name="361"/>  361: 
<a name="362"/>  362: 
<a name="363"/>  363: 
<a name="lists_iterator-1"/><a name="364"/>  364: <b>lists_iterator</b>(Config) when is_list(Config) -&gt;
<a name="365"/>  365:     Ls = [[&quot;able &quot;,&quot;was &quot;,&quot;I &quot;,&quot;ere &quot;,&quot;I &quot;,&quot;saw &quot;,&quot;elba&quot;]],
<a name="lists_iterator-last_expr"/><a name="366"/>  366: <b>    do_echo</b>(Ls, Config,
<a name="367"/>  367: 	    fun (L) -&gt; {self(),L,strcat} end,
<a name="368"/>  368: 	    fun (Echoer, L, {Echoer,X,strcat}) -&gt;
<a name="369"/>  369: 		    io:format(&quot;## ~p ~p~n&quot;, [L,X]),
<a name="370"/>  370: 		    X = lists:flatten(L)
<a name="371"/>  371: 	    end).
<a name="372"/>  372: 
<a name="373"/>  373: 
<a name="374"/>  374: 
<a name="unicode-1"/><a name="375"/>  375: <b>unicode</b>(Config) when is_list(Config) -&gt;
<a name="376"/>  376:     S1 = &quot;plain ascii&quot;,
<a name="377"/>  377:     S2 = &quot;iso-latin åäö ñ&quot;,
<a name="378"/>  378:     S3 = &quot;Codepoints... åäö \x{1000}&quot;,
<a name="379"/>  379:     S4 = [0,1,31,32,63,64,127,128,255],
<a name="380"/>  380:     S5 = [0,1,127,128,255,256,16#d7ff,
<a name="381"/>  381: 	  16#e000,16#fffd,16#10000,16#10ffff],
<a name="382"/>  382:     Ss = [S1,S2,S3,S4,S5],
<a name="unicode-last_expr"/><a name="383"/>  383: <b>    do_echo</b>(unicode_cp_gen([{S,valid} || S &lt;- Ss] ++ cp_gen(71)), Config,
<a name="384"/>  384: 	    fun ({L,invalid}) -&gt; {self(),L,utf8};
<a name="385"/>  385: 		({L,Tag}) -&gt; {self(),L,Tag};
<a name="386"/>  386: 		({L})     -&gt; {self(),L}
<a name="387"/>  387: 	    end,
<a name="388"/>  388: 	    fun (Echoer, {L,invalid}=Out, {Echoer,X,utf8}=In) -&gt;
<a name="389"/>  389: 		    case L of
<a name="390"/>  390: 			X -&gt; ok;
<a name="391"/>  391: 			_ -&gt;
<a name="392"/>  392: 			    ct:fail({mismatch,Out,In})
<a name="393"/>  393: 		    end;
<a name="394"/>  394: 		(Echoer, {L,Tag}=Out, {Echoer,X,Tag}=In) -&gt;
<a name="395"/>  395: 		    case unicode:characters_to_binary(L, utf8) of
<a name="396"/>  396: 			X -&gt; ok;
<a name="397"/>  397: 			_ -&gt;
<a name="398"/>  398: 			    ct:fail({mismatch,Out,In})
<a name="399"/>  399: 		    end;
<a name="400"/>  400: 		(Echoer, {L}=Out, {Echoer,X}=In) -&gt;
<a name="401"/>  401: 		    case L of
<a name="402"/>  402: 			X -&gt; ok;
<a name="403"/>  403: 			_ -&gt;
<a name="404"/>  404: 			    ct:fail({mismatch,Out,In})
<a name="405"/>  405: 		    end
<a name="406"/>  406: 	    end, [&quot;unicode&quot;]).
<a name="407"/>  407: 
<a name="408"/>  408: <i>%% Lazy wrapper to lazy list</i>
<a name="unicode_cp_gen-1"/><a name="409"/>  409: <b>unicode_cp_gen</b>([{S,valid}|Ss]) -&gt;
<a name="410"/>  410:     [{S,utf8},{S}|unicode_cp_gen(Ss)];
<a name="411"/>  411: <b>unicode_cp_gen</b>([{S,invalid}=St|Ss]) -&gt;
<a name="412"/>  412:     [St,{S}|unicode_cp_gen(Ss)];
<a name="413"/>  413: <b>unicode_cp_gen</b>([]) -&gt;
<a name="414"/>  414:     [];
<a name="415"/>  415: <b>unicode_cp_gen</b>(Cont) when is_function(Cont, 0) -&gt;
<a name="unicode_cp_gen-last_expr"/><a name="416"/>  416: <b>    fun </b>() -&gt;
<a name="417"/>  417: 	    unicode_cp_gen(Cont())
<a name="418"/>  418:     end.
<a name="419"/>  419: 
<a name="420"/>  420: 
<a name="421"/>  421: 
<a name="unicode_list_to_string-1"/><a name="422"/>  422: <b>unicode_list_to_string</b>(Config) when is_list(Config) -&gt;
<a name="unicode_list_to_string-last_expr"/><a name="423"/>  423: <b>    do_echo</b>(cp_gen(73), Config,
<a name="424"/>  424: 	    fun ({L,_}) -&gt; {self(),L,to_string_neg_int_list} end,
<a name="425"/>  425: 	    fun (Echoer, {L,invalid}=Out, {Echoer,X,_}=In) -&gt;
<a name="426"/>  426: 		    case L of
<a name="427"/>  427: 			X -&gt; ok;
<a name="428"/>  428: 			_ -&gt;
<a name="429"/>  429: 			    ct:fail({mismatch,Out,In})
<a name="430"/>  430: 		    end;
<a name="431"/>  431: 		(Echoer, {L,valid}=Out, {Echoer,X,_}=In) -&gt;
<a name="432"/>  432: 		    B = unicode:characters_to_binary(L, unicode, {utf16,big}),
<a name="433"/>  433: 		    case [-D || &lt;&lt;D:16/big&gt;&gt; &lt;= B] of
<a name="434"/>  434: 			X -&gt; ok;
<a name="435"/>  435: 			_ -&gt;
<a name="436"/>  436: 			    ct:fail({mismatch,Out,In})
<a name="437"/>  437: 		    end
<a name="438"/>  438: 	    end).
<a name="439"/>  439: 
<a name="440"/>  440: 
<a name="441"/>  441: 
<a name="unicode_string_to_list-1"/><a name="442"/>  442: <b>unicode_string_to_list</b>(Config) when is_list(Config) -&gt;
<a name="unicode_string_to_list-last_expr"/><a name="443"/>  443: <b>    do_echo</b>(cp_gen(79), Config,
<a name="444"/>  444: 	    fun ({L,_}) -&gt; {self(),L,to_neg_int_list} end,
<a name="445"/>  445: 	    fun (Echoer, {L,invalid}=Out, {Echoer,X,_}=In) -&gt;
<a name="446"/>  446: 		    case L of
<a name="447"/>  447: 			X -&gt; ok;
<a name="448"/>  448: 			_ -&gt;
<a name="449"/>  449: 			    ct:fail({mismatch,Out,In})
<a name="450"/>  450: 		    end;
<a name="451"/>  451: 		(Echoer, {L,valid}=Out, {Echoer,X,_}=In) -&gt;
<a name="452"/>  452: 		    case [-C || C &lt;- L] of
<a name="453"/>  453: 			X -&gt; ok;
<a name="454"/>  454: 			_ -&gt;
<a name="455"/>  455: 			    ct:fail({mismatch,Out,In})
<a name="456"/>  456: 		    end
<a name="457"/>  457: 	    end, [&quot;unicode&quot;]).
<a name="458"/>  458: 
<a name="459"/>  459: 
<a name="evil_smiley-0"/><a name="460"/>  460: <b>evil_smiley</b>() -&gt;
<a name="evil_smiley-last_expr"/><a name="461"/>  461:     &lt;&lt;240,159,152,136&gt;&gt;.
<a name="462"/>  462: 
<a name="evil_smileys-1"/><a name="463"/>  463: <b>evil_smileys</b>(0) -&gt;
<a name="464"/>  464:     [];
<a name="465"/>  465: <b>evil_smileys</b>(N) -&gt;
<a name="evil_smileys-last_expr"/><a name="466"/>  466: <b>    [evil_smiley</b>() | evil_smileys(N-1)].
<a name="467"/>  467: 
<a name="utf8_atom-1"/><a name="468"/>  468: <b>utf8_atom</b>(Config) when is_list(Config) -&gt;
<a name="469"/>  469:     ES = evil_smiley(),
<a name="470"/>  470:     SmallUA = binary_to_term(list_to_binary([?VERSION_MAGIC,
<a name="471"/>  471: 					     ?SMALL_ATOM_UTF8_EXT,
<a name="472"/>  472: 					     size(ES),
<a name="473"/>  473: 					     ES])),
<a name="474"/>  474:     true = is_atom(SmallUA),
<a name="475"/>  475:     NoESs = 300 div size(ES),
<a name="476"/>  476:     ESs = evil_smileys(NoESs),
<a name="477"/>  477:     LargeUA = binary_to_term(list_to_binary([?VERSION_MAGIC,
<a name="478"/>  478: 					     ?ATOM_UTF8_EXT,
<a name="479"/>  479: 					     uint16_be(NoESs*size(ES)),
<a name="480"/>  480: 					     ESs])),
<a name="481"/>  481:     true = is_atom(LargeUA),
<a name="482"/>  482:     erlang:display({atom, SmallUA, LargeUA}),
<a name="utf8_atom-last_expr"/><a name="483"/>  483: <b>    do_echo</b>([SmallUA, LargeUA], Config).
<a name="484"/>  484: 
<a name="utf8_nodenames_ext-0"/><a name="485"/>  485: <b>utf8_nodenames_ext</b>() -&gt;
<a name="486"/>  486:     H = &quot;@host&quot;,
<a name="487"/>  487:     ES = evil_smiley(),
<a name="488"/>  488:     SmallUANodeExt = list_to_binary([?SMALL_ATOM_UTF8_EXT,
<a name="489"/>  489: 				     size(ES)+length(H),
<a name="490"/>  490: 				     ES,
<a name="491"/>  491: 				     H]),
<a name="492"/>  492:     NoESs = 300 div size(ES),
<a name="493"/>  493:     ESs = evil_smileys(NoESs),
<a name="494"/>  494:     LargeUANodeExt = list_to_binary([?ATOM_UTF8_EXT,
<a name="495"/>  495: 				     uint16_be(NoESs*size(ES)+length(H)),
<a name="496"/>  496: 				     ESs,
<a name="497"/>  497: 				     H]),
<a name="utf8_nodenames_ext-last_expr"/><a name="498"/>  498:     {SmallUANodeExt, LargeUANodeExt}.
<a name="499"/>  499: 
<a name="utf8_pid-1"/><a name="500"/>  500: <b>utf8_pid</b>(Config) when is_list(Config) -&gt;
<a name="501"/>  501:     {SmallUANodeExt, LargeUANodeExt} = utf8_nodenames_ext(),
<a name="502"/>  502:     SmallPid = mk_pid({SmallUANodeExt, 2}, 4711, 4711),
<a name="503"/>  503:     LargePid = mk_pid({LargeUANodeExt, 2}, 4711, 4711),
<a name="504"/>  504:     erlang:display({pid, SmallPid, node(SmallPid)}),
<a name="505"/>  505:     erlang:display({pid, LargePid, node(LargePid)}),
<a name="utf8_pid-last_expr"/><a name="506"/>  506: <b>    do_echo</b>([SmallPid, LargePid], Config).
<a name="507"/>  507: 
<a name="utf8_port-1"/><a name="508"/>  508: <b>utf8_port</b>(Config) when is_list(Config) -&gt;
<a name="509"/>  509:     {SmallUANodeExt, LargeUANodeExt} = utf8_nodenames_ext(),
<a name="510"/>  510:     SmallPort = mk_port({SmallUANodeExt, 2}, 4711),
<a name="511"/>  511:     erlang:display({port, SmallPort, node(SmallPort)}),
<a name="512"/>  512:     LargePort = mk_port({LargeUANodeExt, 2}, 4711),
<a name="513"/>  513:     erlang:display({port, LargePort, node(LargePort)}),
<a name="utf8_port-last_expr"/><a name="514"/>  514: <b>    do_echo</b>([SmallPort, LargePort], Config).
<a name="515"/>  515: 
<a name="utf8_ref-1"/><a name="516"/>  516: <b>utf8_ref</b>(Config) when is_list(Config) -&gt;
<a name="517"/>  517:     {SmallUANodeExt, LargeUANodeExt} = utf8_nodenames_ext(),
<a name="518"/>  518:     SmallRef = mk_ref({SmallUANodeExt, 2}, [4711, 4711, 4711]),
<a name="519"/>  519:     erlang:display({ref, SmallRef, node(SmallRef)}),
<a name="520"/>  520:     LargeRef = mk_ref({LargeUANodeExt, 2}, [4711, 4711, 4711]),
<a name="521"/>  521:     erlang:display({ref, LargeRef, node(LargeRef)}),
<a name="utf8_ref-last_expr"/><a name="522"/>  522: <b>    do_echo</b>([SmallRef, LargeRef], Config).
<a name="523"/>  523:     
<a name="524"/>  524: 
<a name="525"/>  525: <i>%% Lazy list</i>
<a name="cp_gen-1"/><a name="526"/>  526: <b>cp_gen</b>(N) -&gt;
<a name="cp_gen-last_expr"/><a name="527"/>  527: <b>    cp_gen</b>(N, -1, 16#110000).
<a name="528"/>  528: 
<a name="cp_gen-3"/><a name="529"/>  529: <b>cp_gen</b>(N, Start, End) -&gt;
<a name="cp_gen-last_expr"/><a name="530"/>  530: <b>    cp_gen</b>(N, Start, End, cp_validity(Start), [], 0, [], 0).
<a name="531"/>  531: 
<a name="cp_gen-8"/><a name="532"/>  532: <b>cp_gen</b>(N, U, End, PrevValidity, Acc, Len, Ss, Ls) when Len &gt;= N -&gt;
<a name="533"/>  533:     cp_gen(N, U, End, PrevValidity, [], 0, [{Acc,PrevValidity}|Ss], Ls+1);
<a name="534"/>  534: <b>cp_gen</b>(N, U, End, PrevValidity, Acc, Len, Ss, Ls) when Ls &gt;= N -&gt;
<a name="535"/>  535:     Ss ++ fun () -&gt;
<a name="536"/>  536: 		  cp_gen(N, U, End, PrevValidity, Acc, Len, [], 0)
<a name="537"/>  537: 	  end;
<a name="538"/>  538: <b>cp_gen</b>(_, U, End, _, Acc, _, Ss, _) when U &gt; End -&gt;
<a name="539"/>  539:     [{Acc,valid}|Ss];
<a name="540"/>  540: <b>cp_gen</b>(N, U, End, PrevValidity, Acc, Len, Ss, Ls) -&gt;
<a name="541"/>  541:     Validity = cp_validity(U),
<a name="542"/>  542:     NextU = U+1,
<a name="543"/>  543:     {NextAcc,NextLen} =	case Validity of
<a name="544"/>  544: 			    valid -&gt; {[U|Acc],Len+1};
<a name="545"/>  545: 			    invalid -&gt; {Acc,Len}
<a name="546"/>  546: 			end,
<a name="547"/>  547:     {NextSs,NextLs} = case Validity of
<a name="548"/>  548: 			  PrevValidity -&gt; {Ss,Ls};
<a name="549"/>  549: 			  valid -&gt; {[{[U-1],PrevValidity}|Ss],Ls+1};
<a name="550"/>  550: 			  invalid -&gt; {[{[U],Validity}|Ss],Ls+1}
<a name="551"/>  551: 		      end,
<a name="cp_gen-last_expr"/><a name="552"/>  552: <b>    cp_gen</b>(N, NextU, End, Validity, NextAcc, NextLen, NextSs, NextLs).
<a name="553"/>  553: 
<a name="cp_validity-1"/><a name="554"/>  554: <b>cp_validity</b>(UnicodeCP) -&gt;
<a name="cp_validity-last_expr"/><a name="555"/>  555:     try &lt;&lt;UnicodeCP/big-utf32&gt;&gt; of
<a name="556"/>  556: 	_ -&gt; valid
<a name="557"/>  557:     catch
<a name="558"/>  558: 	error:_ -&gt; invalid
<a name="559"/>  559:     end.
<a name="560"/>  560: 
<a name="561"/>  561: 
<a name="562"/>  562: 
<a name="connect-1"/><a name="563"/>  563: <b>connect</b>(Config) when is_list(Config) -&gt;
<a name="564"/>  564:     {ok,Peer,Other} = ?CT_PEER(),
<a name="565"/>  565:     Action =
<a name="566"/>  566: 	fun (Pid) -&gt;
<a name="567"/>  567: 		JName = node(Pid),
<a name="568"/>  568: 		Hidden = [JName],
<a name="569"/>  569: 		Pid ! {self(),Other},
<a name="570"/>  570: 		receive
<a name="571"/>  571: 		    {Pid,Other,true} -&gt;
<a name="572"/>  572: 			ok;
<a name="573"/>  573: 		    Unexpected1 -&gt;
<a name="574"/>  574: 			ct:fail({result,Unexpected1})
<a name="575"/>  575: 		end,
<a name="576"/>  576: 		Hidden = erlang:nodes(hidden),
<a name="577"/>  577: 		Hidden = rpc:call(Other, erlang, nodes, [hidden]),
<a name="578"/>  578: 		true =
<a name="579"/>  579: 		    rpc:call(Other, erlang, disconnect_node, [JName]),
<a name="580"/>  580: 		[] =
<a name="581"/>  581: 		    rpc:call(Other, erlang, nodes, [hidden]),
<a name="582"/>  582: 		Hidden = erlang:nodes(hidden),
<a name="583"/>  583: 		%% Again
<a name="584"/>  584: 		receive after 2000 -&gt; ok end,
<a name="585"/>  585: 		%% We have no way of knowing when the Java node
<a name="586"/>  586: 		%% detects the nodedown.
<a name="587"/>  587: 		Pid ! {self(),Other},
<a name="588"/>  588: 		receive
<a name="589"/>  589: 		    {Pid,Other,true} -&gt;
<a name="590"/>  590: 			ok;
<a name="591"/>  591: 		    Unexpected2-&gt;
<a name="592"/>  592: 			ct:fail({result,Unexpected2})
<a name="593"/>  593: 		end,
<a name="594"/>  594: 		Hidden = rpc:call(Other, erlang, nodes, [hidden])
<a name="595"/>  595: 	end,
<a name="596"/>  596:     run_server(connection_server, Config, Action, []),
<a name="connect-last_expr"/><a name="597"/>  597: <b>    peer:stop</b>(Peer).
<a name="598"/>  598: 
<a name="599"/>  599: 
<a name="600"/>  600: 
<a name="seq-3"/><a name="601"/>  601: <b>seq</b>(_, 0, _) -&gt;
<a name="602"/>  602:     [];
<a name="603"/>  603: <b>seq</b>(X, N, Fun) -&gt;
<a name="seq-last_expr"/><a name="604"/>  604: <b>    [X|seq</b>(Fun(X), N-1, Fun)].
<a name="605"/>  605: 
<a name="do_echo-2"/><a name="606"/>  606: <b>do_echo</b>(DataList, Config) -&gt;
<a name="do_echo-last_expr"/><a name="607"/>  607: <b>    do_echo</b>(DataList, Config,
<a name="608"/>  608: 	    fun (D) -&gt; % OutTrans
<a name="609"/>  609: 		    {self(),D}
<a name="610"/>  610: 	    end,
<a name="611"/>  611: 	    fun (Echoer, D, {Echoer,D}) -&gt; % InTrans
<a name="612"/>  612: 		    ok
<a name="613"/>  613: 	    end, []).
<a name="614"/>  614: 
<a name="do_echo-4"/><a name="615"/>  615: <b>do_echo</b>(DataList, Config, OutTrans, InTrans) -&gt;
<a name="do_echo-last_expr"/><a name="616"/>  616: <b>    do_echo</b>(DataList, Config, OutTrans, InTrans, []).
<a name="617"/>  617: 
<a name="do_echo-5"/><a name="618"/>  618: <b>do_echo</b>(DataList, Config, OutTrans, InTrans, ExtraArgs)
<a name="619"/>  619:   when is_list(DataList), is_list(Config) -&gt;
<a name="do_echo-last_expr"/><a name="620"/>  620: <b>    run_server</b>(echo_server, Config,
<a name="621"/>  621: 	       fun (Echoer) -&gt;
<a name="622"/>  622: 		       echo_loop(DataList, Echoer, OutTrans, InTrans, [])
<a name="623"/>  623: 	       end,
<a name="624"/>  624: 	       ExtraArgs).
<a name="625"/>  625: 
<a name="echo_loop-5"/><a name="626"/>  626: <b>echo_loop</b>([D|Ds], Echoer, OutTrans, InTrans, TermAcc) -&gt;
<a name="627"/>  627:     OutMsg = OutTrans(D),
<a name="628"/>  628:     Echoer ! OutMsg,
<a name="629"/>  629:     %%io:format(&quot;echo_server ~p: ~p ! ~P~n&quot;, [self(),Echoer,OutMsg,10]),
<a name="630"/>  630:     receive
<a name="631"/>  631: 	Reply -&gt;
<a name="632"/>  632: 	    %%io:format(&quot;echo_server ~p: receive ~P~n&quot;, [self(),Reply,10]),
<a name="633"/>  633: 	    InTrans(Echoer, D, Reply)
<a name="634"/>  634:     end,
<a name="635"/>  635:     Term = case OutMsg of
<a name="636"/>  636: 	       {_, T, _} -&gt; T;
<a name="637"/>  637: 	       {_, T} -&gt; T
<a name="638"/>  638: 	   end,
<a name="639"/>  639:     echo_loop(Ds, Echoer, OutTrans, InTrans, [Term | TermAcc]);
<a name="640"/>  640: <b>echo_loop</b>([], Echoer, _, _, TermAcc) -&gt;
<a name="641"/>  641:     check_terms(Echoer, TermAcc);
<a name="642"/>  642: <i>%% Lazy list</i>
<a name="643"/>  643: <b>echo_loop</b>(Cont, Echoer, OutTrans, InTrans, TermAcc)
<a name="644"/>  644:   when is_function(Cont, 0) -&gt;
<a name="645"/>  645:     check_terms(Echoer, TermAcc),
<a name="646"/>  646:     OutMsg = Echoer ! {self(),undefined,hash_clear},
<a name="647"/>  647:     %%io:format(&quot;echo_server ~p: ~p ! ~P~n&quot;, [self(),Echoer,OutMsg,10]),
<a name="648"/>  648:     receive
<a name="649"/>  649: 	{Echoer,hash_cleared,hash_clear}=Reply -&gt;
<a name="650"/>  650: 	    %%io:format(&quot;echo_server ~p: receive ~P~n&quot;, [self(),Reply,10]),
<a name="651"/>  651: 	    ok;
<a name="652"/>  652: 	Other -&gt;
<a name="653"/>  653: 	    io:format(&quot;echo_server_terms unexpected ~p: receive ~P~n&quot;,
<a name="654"/>  654: 		      [self(),Other,10]),
<a name="655"/>  655: 	    ct:fail({unexpected, Other})
<a name="656"/>  656:     end,
<a name="echo_loop-last_expr"/><a name="657"/>  657: <b>    echo_loop</b>(Cont(), Echoer, OutTrans, InTrans, []).
<a name="658"/>  658: 
<a name="check_terms-2"/><a name="659"/>  659: <b>check_terms</b>(Echoer, [Term | Rest]) -&gt;
<a name="660"/>  660:     OutMsg = {self(),Term,hash_lookup},
<a name="661"/>  661:     Echoer ! OutMsg,
<a name="662"/>  662:     %%io:format(&quot;check_terms ~p: ~p ! ~P~n&quot;, [self(),Echoer,OutMsg,10]),
<a name="663"/>  663:     receive
<a name="664"/>  664: 	{Echoer,true,hash_lookup} = ReplyMsg -&gt;
<a name="665"/>  665: 	    %%io:format(&quot;check_terms ~p: receive ~P~n&quot;, [self(),ReplyMsg,10]),
<a name="666"/>  666: 	    check_terms(Echoer, Rest);
<a name="667"/>  667: 	Other -&gt;
<a name="668"/>  668: 	    io:format(&quot;check_terms unexpected ~p: receive ~P~n&quot;,
<a name="669"/>  669: 		      [self(),Other,10]),
<a name="670"/>  670: 	    ct:fail({unexpected, Other})
<a name="671"/>  671:     end;
<a name="672"/>  672: <b>check_terms</b>(_, []) -&gt;
<a name="check_terms-last_expr"/><a name="673"/>  673:     ok.
<a name="674"/>  674: 
<a name="run_server-4"/><a name="675"/>  675: <b>run_server</b>(Server, Config, Action, ExtraArgs) -&gt;
<a name="676"/>  676:     Name = make_name(),
<a name="677"/>  677:     true = register(Name, self()),
<a name="678"/>  678:     JName = make_name(),
<a name="679"/>  679:     spawn_link(fun () -&gt;
<a name="680"/>  680: 		       %% Setting max memory to 256. This is due to
<a name="681"/>  681: 		       %% echo_server sometimes failing with
<a name="682"/>  682: 		       %% OutOfMemoryException one some test machines.
<a name="683"/>  683: 		       ok = jitu:java(?config(java, Config),
<a name="684"/>  684: 				      ?config(data_dir, Config),
<a name="685"/>  685: 				      atom_to_list(Server),
<a name="686"/>  686: 				      [JName,
<a name="687"/>  687: 				       erlang:get_cookie(),
<a name="688"/>  688: 				       node(),
<a name="689"/>  689: 				       Name]++ExtraArgs,
<a name="690"/>  690: 				      &quot; -Xmx256m&quot;),
<a name="691"/>  691: 				      %% &quot; -Xmx256m -DOtpConnection.trace=3&quot;),
<a name="692"/>  692: 		       Name ! {done, JName}
<a name="693"/>  693: 	       end),
<a name="run_server-last_expr"/><a name="694"/>  694:     receive
<a name="695"/>  695: 	{Server, JName, Pid} -&gt;
<a name="696"/>  696: 	    test_server:format(&quot;~w: ~p (~p)~n&quot;,
<a name="697"/>  697: 		      [Server, Pid, node(Pid)]),
<a name="698"/>  698: 	    test_server:format(&quot;nodes(hidden): ~p~n&quot;,
<a name="699"/>  699: 		      [nodes(hidden)]),
<a name="700"/>  700: 	    Action(Pid),
<a name="701"/>  701: 	    Pid ! bye,
<a name="702"/>  702: 	    receive
<a name="703"/>  703: 		{done, JName} -&gt;
<a name="704"/>  704: 		    ok
<a name="705"/>  705: 	    end;
<a name="706"/>  706: 	Other -&gt;
<a name="707"/>  707: 	    ct:fail({unexpected,Other})
<a name="708"/>  708:     end.
<a name="709"/>  709: 
<a name="710"/>  710: <i>%%</i>
<a name="711"/>  711: <i>%% Utils...</i>
<a name="712"/>  712: <i>%%</i>
<a name="713"/>  713: 
<a name="make_name-0"/><a name="714"/>  714: <b>make_name</b>() -&gt;
<a name="715"/>  715:     {A, B, C} = now(),
<a name="make_name-last_expr"/><a name="716"/>  716: <b>    list_to_atom</b>(atom_to_list(?MODULE)
<a name="717"/>  717: 		 ++ &quot;-&quot; ++ integer_to_list(A)
<a name="718"/>  718: 		 ++ &quot;-&quot; ++ integer_to_list(B)
<a name="719"/>  719: 		 ++ &quot;-&quot; ++ integer_to_list(C)).
<a name="720"/>  720: 
<a name="uint64_be-1"/><a name="721"/>  721: <b>uint64_be</b>(Uint) when is_integer(Uint), 0 =&lt; Uint, Uint &lt; 1 bsl 64 -&gt;
<a name="722"/>  722:     [(Uint bsr 56) band 16#ff,
<a name="723"/>  723:      (Uint bsr 48) band 16#ff,
<a name="724"/>  724:      (Uint bsr 40) band 16#ff,
<a name="725"/>  725:      (Uint bsr 32) band 16#ff,
<a name="726"/>  726:      (Uint bsr 24) band 16#ff,
<a name="727"/>  727:      (Uint bsr 16) band 16#ff,
<a name="728"/>  728:      (Uint bsr 8) band 16#ff,
<a name="729"/>  729:      Uint band 16#ff];
<a name="730"/>  730: <b>uint64_be</b>(Uint) -&gt;
<a name="uint64_be-last_expr"/><a name="731"/>  731: <b>    exit</b>({badarg, uint64_be, [Uint]}).
<a name="732"/>  732: 
<a name="uint32_be-1"/><a name="733"/>  733: <b>uint32_be</b>(Uint) when is_integer(Uint), 0 =&lt; Uint, Uint &lt; 1 bsl 32 -&gt;
<a name="734"/>  734:     [(Uint bsr 24) band 16#ff,
<a name="735"/>  735:      (Uint bsr 16) band 16#ff,
<a name="736"/>  736:      (Uint bsr 8) band 16#ff,
<a name="737"/>  737:      Uint band 16#ff];
<a name="738"/>  738: <b>uint32_be</b>(Uint) -&gt;
<a name="uint32_be-last_expr"/><a name="739"/>  739: <b>    exit</b>({badarg, uint32_be, [Uint]}).
<a name="740"/>  740: 
<a name="741"/>  741: 
<a name="uint16_be-1"/><a name="742"/>  742: <b>uint16_be</b>(Uint) when is_integer(Uint), 0 =&lt; Uint, Uint &lt; 1 bsl 16 -&gt;
<a name="743"/>  743:     [(Uint bsr 8) band 16#ff,
<a name="744"/>  744:      Uint band 16#ff];
<a name="745"/>  745: <b>uint16_be</b>(Uint) -&gt;
<a name="uint16_be-last_expr"/><a name="746"/>  746: <b>    exit</b>({badarg, uint16_be, [Uint]}).
<a name="747"/>  747: 
<a name="uint8-1"/><a name="748"/>  748: <b>uint8</b>(Uint) when is_integer(Uint), 0 =&lt; Uint, Uint &lt; 1 bsl 8 -&gt;
<a name="749"/>  749:     Uint band 16#ff;
<a name="750"/>  750: <b>uint8</b>(Uint) -&gt;
<a name="uint8-last_expr"/><a name="751"/>  751: <b>    exit</b>({badarg, uint8, [Uint]}).
<a name="752"/>  752: 
<a name="753"/>  753: 
<a name="pid_tag-1"/><a name="754"/>  754: <b>pid_tag</b>(Creation) when Creation =&lt; 3 -&gt; ?PID_EXT;
<a name="pid_tag-last_expr"/><a name="755"/>  755: <b>pid_tag</b>(_Creation) -&gt; ?NEW_PID_EXT.
<a name="756"/>  756: 
<a name="enc_creation-1"/><a name="757"/>  757: <b>enc_creation</b>(Creation) when Creation =&lt; 3 -&gt; uint8(Creation);
<a name="enc_creation-last_expr"/><a name="758"/>  758: <b>enc_creation</b>(Creation) -&gt; uint32_be(Creation).
<a name="759"/>  759: 
<a name="mk_pid-3"/><a name="760"/>  760: <b>mk_pid</b>({NodeName, Creation}, Number, Serial) when is_atom(NodeName) -&gt;
<a name="761"/>  761:     &lt;&lt;?VERSION_MAGIC, NodeNameExt/binary&gt;&gt; = term_to_binary(NodeName),
<a name="762"/>  762:     mk_pid({NodeNameExt, Creation}, Number, Serial);
<a name="763"/>  763: <b>mk_pid</b>({NodeNameExt, Creation}, Number, Serial) -&gt;
<a name="mk_pid-last_expr"/><a name="764"/>  764: <b>    case catch binary_to_term</b>(list_to_binary([?VERSION_MAGIC,
<a name="765"/>  765: 					      pid_tag(Creation),
<a name="766"/>  766: 					      NodeNameExt,
<a name="767"/>  767: 					      uint32_be(Number),
<a name="768"/>  768: 					      uint32_be(Serial),
<a name="769"/>  769: 					      enc_creation(Creation)])) of
<a name="770"/>  770: 	Pid when is_pid(Pid) -&gt;
<a name="771"/>  771: 	    Pid;
<a name="772"/>  772: 	{'EXIT', {badarg, _}} -&gt;
<a name="773"/>  773: 	    exit({badarg, mk_pid, [{NodeNameExt, Creation}, Number, Serial]});
<a name="774"/>  774: 	Other -&gt;
<a name="775"/>  775: 	    exit({unexpected_binary_to_term_result, Other})
<a name="776"/>  776:     end.
<a name="777"/>  777: 
<a name="port_tag-2"/><a name="778"/>  778: <b>port_tag</b>(Num, Creation) when 0 =&lt; Num, Num =&lt; ?OLD_MAX_PIDS_PORTS, Creation =&lt; 3 -&gt;
<a name="779"/>  779:     ?PORT_EXT;
<a name="780"/>  780: <b>port_tag</b>(Num, _Creation) when 0 =&lt; Num, Num =&lt; ?OLD_MAX_PIDS_PORTS -&gt;
<a name="781"/>  781:     ?NEW_PORT_EXT;
<a name="782"/>  782: <b>port_tag</b>(_Num, _Creation) -&gt;
<a name="port_tag-last_expr"/><a name="783"/>  783:     ?V4_PORT_EXT.
<a name="784"/>  784: 
<a name="mk_port-2"/><a name="785"/>  785: <b>mk_port</b>({NodeName, Creation}, Number) when is_atom(NodeName) -&gt;
<a name="786"/>  786:     &lt;&lt;?VERSION_MAGIC, NodeNameExt/binary&gt;&gt; = term_to_binary(NodeName),
<a name="787"/>  787:     mk_port({NodeNameExt, Creation}, Number);
<a name="788"/>  788: <b>mk_port</b>({NodeNameExt, Creation}, Number) -&gt;
<a name="mk_port-last_expr"/><a name="789"/>  789: <b>    case catch binary_to_term</b>(list_to_binary([?VERSION_MAGIC,
<a name="790"/>  790: 					      port_tag(Number, Creation),
<a name="791"/>  791: 					      NodeNameExt,
<a name="792"/>  792: 					      case Number &gt; ?OLD_MAX_PIDS_PORTS of
<a name="793"/>  793: 						  true -&gt; uint64_be(Number);
<a name="794"/>  794: 						  false -&gt; uint32_be(Number)
<a name="795"/>  795: 					      end,
<a name="796"/>  796: 					      enc_creation(Creation)])) of
<a name="797"/>  797: 	Port when is_port(Port) -&gt;
<a name="798"/>  798: 	    Port;
<a name="799"/>  799: 	{'EXIT', {badarg, _}} -&gt;
<a name="800"/>  800: 	    exit({badarg, mk_port, [{NodeNameExt, Creation}, Number]});
<a name="801"/>  801: 	Other -&gt;
<a name="802"/>  802: 	    exit({unexpected_binary_to_term_result, Other})
<a name="803"/>  803:     end.
<a name="804"/>  804: 
<a name="ref_tag-1"/><a name="805"/>  805: <b>ref_tag</b>(Creation) when Creation =&lt; 3 -&gt; ?NEW_REFERENCE_EXT;
<a name="ref_tag-last_expr"/><a name="806"/>  806: <b>ref_tag</b>(_Creation) -&gt; ?NEWER_REFERENCE_EXT.
<a name="807"/>  807: 
<a name="mk_ref-2"/><a name="808"/>  808: <b>mk_ref</b>({NodeName, Creation}, [Number] = NL) when is_atom(NodeName),
<a name="809"/>  809: 						 is_integer(Creation),
<a name="810"/>  810: 						 is_integer(Number) -&gt;
<a name="811"/>  811:     &lt;&lt;?VERSION_MAGIC, NodeNameExt/binary&gt;&gt; = term_to_binary(NodeName),
<a name="812"/>  812:     mk_ref({NodeNameExt, Creation}, NL);
<a name="813"/>  813: <b>mk_ref</b>({NodeNameExt, Creation}, [Number]) when is_integer(Creation),
<a name="814"/>  814: 					       Creation =&lt; 3,
<a name="815"/>  815: 					       is_integer(Number) -&gt;
<a name="816"/>  816:     case catch binary_to_term(list_to_binary([?VERSION_MAGIC,
<a name="817"/>  817: 					      ?REFERENCE_EXT,
<a name="818"/>  818: 					      NodeNameExt,
<a name="819"/>  819: 					      uint32_be(Number),
<a name="820"/>  820: 					      uint8(Creation)])) of
<a name="821"/>  821: 	Ref when is_reference(Ref) -&gt;
<a name="822"/>  822: 	    Ref;
<a name="823"/>  823: 	{'EXIT', {badarg, _}} -&gt;
<a name="824"/>  824: 	    exit({badarg, mk_ref, [{NodeNameExt, Creation}, [Number]]});
<a name="825"/>  825: 	Other -&gt;
<a name="826"/>  826: 	    exit({unexpected_binary_to_term_result, Other})
<a name="827"/>  827:     end;
<a name="828"/>  828: <b>mk_ref</b>({NodeName, Creation}, Numbers) when is_atom(NodeName),
<a name="829"/>  829: 					   is_integer(Creation),
<a name="830"/>  830: 					   is_list(Numbers) -&gt;
<a name="831"/>  831:     &lt;&lt;?VERSION_MAGIC, NodeNameExt/binary&gt;&gt; = term_to_binary(NodeName),
<a name="832"/>  832:     mk_ref({NodeNameExt, Creation}, Numbers);
<a name="833"/>  833: <b>mk_ref</b>({NodeNameExt, Creation}, Numbers) when is_integer(Creation),
<a name="834"/>  834: 					      is_list(Numbers) -&gt;
<a name="mk_ref-last_expr"/><a name="835"/>  835: <b>    case catch binary_to_term</b>(list_to_binary([?VERSION_MAGIC,
<a name="836"/>  836: 					      ref_tag(Creation),
<a name="837"/>  837: 					      uint16_be(length(Numbers)),
<a name="838"/>  838: 					      NodeNameExt,
<a name="839"/>  839: 					      enc_creation(Creation),
<a name="840"/>  840: 					      lists:map(fun (N) -&gt;
<a name="841"/>  841: 								uint32_be(N)
<a name="842"/>  842: 							end,
<a name="843"/>  843: 							Numbers)])) of
<a name="844"/>  844: 	Ref when is_reference(Ref) -&gt;
<a name="845"/>  845: 	    Ref;
<a name="846"/>  846: 	{'EXIT', {badarg, _}} -&gt;
<a name="847"/>  847: 	    exit({badarg, mk_ref, [{NodeNameExt, Creation}, Numbers]});
<a name="848"/>  848: 	Other -&gt;
<a name="849"/>  849: 	    exit({unexpected_binary_to_term_result, Other})
<a name="850"/>  850:     end.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
