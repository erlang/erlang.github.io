<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/common_test/make_test_dir/common_test_test/test_server_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2010-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <i>%%%-------------------------------------------------------------------</i>
<a name="21"/>   21: <i>%%% Author: Lukas Larsson &lt;lukas@erlang-solutions.com&gt;</i>
<a name="22"/>   22: <i>%%%-------------------------------------------------------------------</i>
<a name="23"/>   23: <b>-module</b>(test_server_SUITE).
<a name="24"/>   24: 
<a name="25"/>   25: <i>%% Note: This directive should only be used in test suites.</i>
<a name="26"/>   26: <b>-compile</b>(export_all).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="29"/>   29: <b>-include</b>(&quot;test_server_test_lib.hrl&quot;).
<a name="30"/>   30: <b>-include_lib</b>(&quot;kernel/include/file.hrl&quot;).
<a name="31"/>   31: 
<a name="32"/>   32: <i>%%--------------------------------------------------------------------</i>
<a name="33"/>   33: <i>%% COMMON TEST CALLBACK FUNCTIONS</i>
<a name="34"/>   34: <i>%%--------------------------------------------------------------------</i>
<a name="35"/>   35: 
<a name="36"/>   36: <i>%% @spec suite() -&gt; Info</i>
<a name="suite-0"/><a name="37"/>   37: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="38"/>   38:     [{ct_hooks,[ts_install_cth,test_server_test_lib]}].
<a name="39"/>   39: 
<a name="40"/>   40: 
<a name="41"/>   41: <i>%% @spec init_per_suite(Config0) -&gt;</i>
<a name="42"/>   42: <i>%%               Config1 | {skip,Reason} | {skip_and_save,Reason,Config1}</i>
<a name="init_per_suite-1"/><a name="43"/>   43: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="44"/>   44: <b>    [{path_dirs,[proplists:get_value</b>(data_dir,Config)]} | Config].
<a name="45"/>   45: 
<a name="46"/>   46: <i>%% @spec end_per_suite(Config) -&gt; _</i>
<a name="end_per_suite-1"/><a name="47"/>   47: <b>end_per_suite</b>(_Config) -&gt;
<a name="48"/>   48:     io:format(&quot;TEST_SERVER_FRAMEWORK: ~p&quot;,[os:getenv(&quot;TEST_SERVER_FRAMEWORK&quot;)]),
<a name="end_per_suite-last_expr"/><a name="49"/>   49:     ok.
<a name="50"/>   50: 
<a name="51"/>   51: <i>%% @spec init_per_group(GroupName, Config0) -&gt;</i>
<a name="52"/>   52: <i>%%               Config1 | {skip,Reason} | {skip_and_save,Reason,Config1}</i>
<a name="init_per_group-2"/><a name="53"/>   53: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="54"/>   54:     Config.
<a name="55"/>   55: 
<a name="56"/>   56: <i>%% @spec end_per_group(GroupName, Config0) -&gt;</i>
<a name="57"/>   57: <i>%%               void() | {save_config,Config1}</i>
<a name="end_per_group-2"/><a name="58"/>   58: <b>end_per_group</b>(_GroupName, _Config) -&gt;
<a name="end_per_group-last_expr"/><a name="59"/>   59:     ok.
<a name="60"/>   60: 
<a name="61"/>   61: <i>%% @spec init_per_testcase(TestCase, Config0) -&gt;</i>
<a name="62"/>   62: <i>%%               Config1 | {skip,Reason} | {skip_and_save,Reason,Config1}</i>
<a name="init_per_testcase-2"/><a name="63"/>   63: <b>init_per_testcase</b>(_TestCase, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="64"/>   64:     Config.
<a name="65"/>   65: 
<a name="66"/>   66: <i>%% @spec end_per_testcase(TestCase, Config0) -&gt;</i>
<a name="67"/>   67: <i>%%               void() | {save_config,Config1} | {fail,Reason}</i>
<a name="end_per_testcase-2"/><a name="68"/>   68: <b>end_per_testcase</b>(test_server_unicode, _Config) -&gt;
<a name="69"/>   69:     [_,Host] = string:lexemes(atom_to_list(node()), &quot;@&quot;),
<a name="70"/>   70:     N1 = list_to_atom(&quot;test_server_tester_latin1&quot; ++ &quot;@&quot; ++ Host),
<a name="71"/>   71:     N2 = list_to_atom(&quot;test_server_tester_utf8&quot; ++ &quot;@&quot; ++ Host),
<a name="72"/>   72:     test_server:stop_node(N1),
<a name="73"/>   73:     test_server:stop_node(N2),
<a name="74"/>   74:     ok;
<a name="75"/>   75: <b>end_per_testcase</b>(_TestCase, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="76"/>   76:     ok.
<a name="77"/>   77: 
<a name="78"/>   78: <i>%% @spec: groups() -&gt; [Group]</i>
<a name="groups-0"/><a name="79"/>   79: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="80"/>   80:     [].
<a name="81"/>   81: 
<a name="82"/>   82: <i>%% @spec all() -&gt; GroupsAndTestCases | {skip,Reason}</i>
<a name="all-0"/><a name="83"/>   83: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="84"/>   84:     [test_server_SUITE, test_server_parallel01_SUITE,
<a name="85"/>   85:      test_server_conf02_SUITE, test_server_conf01_SUITE,
<a name="86"/>   86:      test_server_skip_SUITE, test_server_shuffle01_SUITE,
<a name="87"/>   87:      test_server_break_SUITE, test_server_cover_SUITE,
<a name="88"/>   88:      test_server_unicode].
<a name="89"/>   89: 
<a name="90"/>   90: 
<a name="91"/>   91: <i>%%--------------------------------------------------------------------</i>
<a name="92"/>   92: <i>%% TEST CASES</i>
<a name="93"/>   93: <i>%%--------------------------------------------------------------------</i>
<a name="94"/>   94: <i>%% @spec TestCase(Config0) -&gt;</i>
<a name="95"/>   95: <i>%%           ok | exit() | {skip,Reason} | {comment,Comment} |</i>
<a name="96"/>   96: <i>%%           {save_config,Config1} | {skip_and_save,Reason,Config1}</i>
<a name="test_server_SUITE-1"/><a name="97"/>   97: <b>test_server_SUITE</b>(Config) -&gt;
<a name="98"/>   98: <i>%    rpc:call(Node,dbg, tracer,[]),</i>
<a name="99"/>   99: <i>%    rpc:call(Node,dbg, p,[all,c]),</i>
<a name="100"/>  100: <i>%    rpc:call(Node,dbg, tpl,[test_server_ctrl,x]),</i>
<a name="test_server_SUITE-last_expr"/><a name="101"/>  101: <b>    run_test_server_tests</b>(&quot;test_server_SUITE&quot;,
<a name="102"/>  102: 			  [{test_server_SUITE,skip_case7,&quot;SKIPPED!&quot;}],
<a name="103"/>  103: 			  40, 1, 32, 21, 9, 1, 11, 2, 27, Config).
<a name="104"/>  104: 
<a name="test_server_parallel01_SUITE-1"/><a name="105"/>  105: <b>test_server_parallel01_SUITE</b>(Config) -&gt;
<a name="test_server_parallel01_SUITE-last_expr"/><a name="106"/>  106: <b>    run_test_server_tests</b>(&quot;test_server_parallel01_SUITE&quot;, [],
<a name="107"/>  107: 			  37, 0, 19, 19, 0, 0, 0, 0, 37, Config).
<a name="108"/>  108: 
<a name="test_server_shuffle01_SUITE-1"/><a name="109"/>  109: <b>test_server_shuffle01_SUITE</b>(Config) -&gt;
<a name="test_server_shuffle01_SUITE-last_expr"/><a name="110"/>  110: <b>    run_test_server_tests</b>(&quot;test_server_shuffle01_SUITE&quot;, [],
<a name="111"/>  111: 			  130, 0, 0, 76, 0, 0, 0, 0, 130, Config).
<a name="112"/>  112: 
<a name="test_server_skip_SUITE-1"/><a name="113"/>  113: <b>test_server_skip_SUITE</b>(Config) -&gt;
<a name="test_server_skip_SUITE-last_expr"/><a name="114"/>  114: <b>    run_test_server_tests</b>(&quot;test_server_skip_SUITE&quot;, [],
<a name="115"/>  115: 			  3, 0, 1, 0, 1, 0, 3, 0, 0, Config).
<a name="116"/>  116: 
<a name="test_server_conf01_SUITE-1"/><a name="117"/>  117: <b>test_server_conf01_SUITE</b>(Config) -&gt;
<a name="test_server_conf01_SUITE-last_expr"/><a name="118"/>  118: <b>    run_test_server_tests</b>(&quot;test_server_conf01_SUITE&quot;, [],
<a name="119"/>  119: 			  24, 0, 12, 12, 0, 0, 0, 0, 24, Config).
<a name="120"/>  120: 
<a name="test_server_conf02_SUITE-1"/><a name="121"/>  121: <b>test_server_conf02_SUITE</b>(Config) -&gt;
<a name="test_server_conf02_SUITE-last_expr"/><a name="122"/>  122: <b>    run_test_server_tests</b>(&quot;test_server_conf02_SUITE&quot;, [],
<a name="123"/>  123: 			  26, 0, 12, 12, 0, 0, 0, 0, 26, Config).
<a name="124"/>  124: 
<a name="test_server_break_SUITE-1"/><a name="125"/>  125: <b>test_server_break_SUITE</b>(Config) -&gt;
<a name="test_server_break_SUITE-last_expr"/><a name="126"/>  126: <b>    run_test_server_tests</b>(&quot;test_server_break_SUITE&quot;, [],
<a name="127"/>  127: 			  8, 2, 6, 4, 0, 0, 0, 2, 6, Config).
<a name="128"/>  128: 
<a name="test_server_cover_SUITE-1"/><a name="129"/>  129: <b>test_server_cover_SUITE</b>(Config) -&gt;
<a name="test_server_cover_SUITE-last_expr"/><a name="130"/>  130: <b>    case test_server:is_cover</b>() of
<a name="131"/>  131: 	true -&gt;
<a name="132"/>  132: 	    {skip, &quot;Cover already running&quot;};
<a name="133"/>  133: 	false -&gt;
<a name="134"/>  134: 	    PrivDir = ?config(priv_dir,Config),
<a name="135"/>  135: 
<a name="136"/>  136: 	    %% Test suite has two test cases
<a name="137"/>  137: 	    %%   tc1 calls cover_helper:foo/0
<a name="138"/>  138: 	    %%   tc2 calls cover_helper:bar/0
<a name="139"/>  139: 	    %% Each function in cover_helper is one line.
<a name="140"/>  140: 	    %%
<a name="141"/>  141: 	    %% First test run skips tc2, so only cover_helper:foo/0 is executed.
<a name="142"/>  142: 	    %% Cover file specifies to include cover_helper in this test run.
<a name="143"/>  143: 	    CoverFile1 = filename:join(PrivDir,&quot;t1.cover&quot;),
<a name="144"/>  144: 	    CoverSpec1 = {include,[cover_helper]},
<a name="145"/>  145: 	    file:write_file(CoverFile1,io_lib:format(&quot;~p.~n&quot;,[CoverSpec1])),
<a name="146"/>  146: 	    run_test_server_tests(&quot;test_server_cover_SUITE&quot;,
<a name="147"/>  147: 				  [{test_server_cover_SUITE,tc2,&quot;SKIPPED!&quot;}],
<a name="148"/>  148: 				  4, 0, 2, 1, 1, 0, 1, 0, 3,
<a name="149"/>  149: 				  CoverFile1, Config),
<a name="150"/>  150: 
<a name="151"/>  151: 	    %% Next test run skips tc1, so only cover_helper:bar/0 is executed.
<a name="152"/>  152: 	    %% Cover file specifies cross compilation of cover_helper
<a name="153"/>  153: 	    CoverFile2 = filename:join(PrivDir,&quot;t2.cover&quot;),
<a name="154"/>  154: 	    CoverSpec2 = {cross,[{t1,[cover_helper]}]},
<a name="155"/>  155: 	    file:write_file(CoverFile2,io_lib:format(&quot;~p.~n&quot;,[CoverSpec2])),
<a name="156"/>  156: 	    run_test_server_tests(&quot;test_server_cover_SUITE&quot;,
<a name="157"/>  157: 				  [{test_server_cover_SUITE,tc1,&quot;SKIPPED!&quot;}],
<a name="158"/>  158: 				  4, 0, 2, 1, 1, 0, 1, 0, 3, CoverFile2, Config),
<a name="159"/>  159: 
<a name="160"/>  160: 	    %% Cross cover analyse
<a name="161"/>  161: 	    WorkDir = ?config(work_dir,Config),
<a name="162"/>  162: 	    WC = filename:join([WorkDir,&quot;test_server_cover_SUITE.logs&quot;,&quot;run.*&quot;]),
<a name="163"/>  163: 	    [D2,D1|_] = lists:reverse(lists:sort(filelib:wildcard(WC))),
<a name="164"/>  164: 	    TagDirs = [{t1,D1},{t2,D2}],
<a name="165"/>  165: 	    test_server_ctrl:cross_cover_analyse(details,TagDirs),
<a name="166"/>  166: 
<a name="167"/>  167: 	    %% Check that cover log shows only what is really included
<a name="168"/>  168: 	    %% in the test and cross cover log show the accumulated
<a name="169"/>  169: 	    %% result.
<a name="170"/>  170: 	    {ok,Cover1} = file:read_file(filename:join(D1,&quot;cover.log&quot;)),
<a name="171"/>  171: 	    [{cover_helper,{1,1,_}}] = binary_to_term(Cover1),
<a name="172"/>  172: 	    {ok,Cover2} = file:read_file(filename:join(D2,&quot;cover.log&quot;)),
<a name="173"/>  173: 	    [] = binary_to_term(Cover2),
<a name="174"/>  174: 	    {ok,Cross} = file:read_file(filename:join(D1,&quot;cross_cover.log&quot;)),
<a name="175"/>  175: 	    [{cover_helper,{2,0,_}}] = binary_to_term(Cross),
<a name="176"/>  176: 	    ok
<a name="177"/>  177:     end.
<a name="178"/>  178: 
<a name="test_server_unicode-1"/><a name="179"/>  179: <b>test_server_unicode</b>(Config) -&gt;
<a name="180"/>  180:     run_test_server_tests(&quot;test_server_unicode_SUITE&quot;, [],
<a name="181"/>  181: 			  5, 0, 3, 3, 0, 0, 0, 0, 5, Config),
<a name="182"/>  182: 
<a name="183"/>  183:     %% Create and run two test suites - one with filename and content
<a name="184"/>  184:     %% in latin1 (if the default filename mode is latin1) and one with
<a name="185"/>  185:     %% filename and content in utf8.  Both have name and content
<a name="186"/>  186:     %% including letters äöå.  Check that all logs are generated with
<a name="187"/>  187:     %% utf8 encoded filenames.
<a name="188"/>  188:     case file:native_name_encoding() of
<a name="189"/>  189: 	utf8 -&gt;
<a name="190"/>  190: 	    ok;
<a name="191"/>  191: 	latin1 -&gt;
<a name="192"/>  192: 	    generate_and_run_unicode_test(Config,latin1)
<a name="193"/>  193:     end,
<a name="test_server_unicode-last_expr"/><a name="194"/>  194: <b>    generate_and_run_unicode_test</b>(Config,utf8).
<a name="195"/>  195: 
<a name="196"/>  196: <i>%%%-----------------------------------------------------------------</i>
<a name="run_test_server_tests-12"/><a name="197"/>  197: <b>run_test_server_tests</b>(SuiteName, Skip, NCases, NFail, NExpected, NSucc,
<a name="198"/>  198: 		      NUsrSkip, NAutoSkip, 
<a name="199"/>  199: 		      NActualSkip, NActualFail, NActualSucc, Config) -&gt;
<a name="run_test_server_tests-last_expr"/><a name="200"/>  200: <b>    run_test_server_tests</b>(SuiteName, Skip, NCases, NFail, NExpected, NSucc,
<a name="201"/>  201: 			  NUsrSkip, NAutoSkip,
<a name="202"/>  202: 			  NActualSkip, NActualFail, NActualSucc, false, Config).
<a name="203"/>  203: 
<a name="run_test_server_tests-13"/><a name="204"/>  204: <b>run_test_server_tests</b>(SuiteName, Skip, NCases, NFail, NExpected, NSucc,
<a name="205"/>  205: 		      NUsrSkip, NAutoSkip,
<a name="206"/>  206: 		      NActualSkip, NActualFail, NActualSucc, Cover, Config) -&gt;
<a name="207"/>  207:     Node = proplists:get_value(node, Config),
<a name="208"/>  208:     Encoding = rpc:call(Node,file,native_name_encoding,[]),
<a name="209"/>  209:     WorkDir = proplists:get_value(work_dir, Config),
<a name="210"/>  210:     LogDir = filename:join(WorkDir, SuiteName++&quot;.logs&quot;),
<a name="211"/>  211:     LogDirUri = test_server_ctrl:uri_encode(LogDir, Encoding),
<a name="212"/>  212:     ct:log(&quot;&lt;a href=\&quot;file://~s\&quot;&gt;Test case log files&lt;/a&gt;\n&quot;, [LogDirUri]),
<a name="213"/>  213: 
<a name="214"/>  214:     {ok,_Pid} = rpc:call(Node,test_server_ctrl, start, []),
<a name="215"/>  215:     case Cover of
<a name="216"/>  216: 	false -&gt;
<a name="217"/>  217: 	    ok;
<a name="218"/>  218: 	_ -&gt;
<a name="219"/>  219: 	    rpc:call(Node,test_server_ctrl,cover,[Cover,details])
<a name="220"/>  220:     end,
<a name="221"/>  221:     rpc:call(Node,
<a name="222"/>  222: 	     test_server_ctrl,add_dir_with_skip,
<a name="223"/>  223: 	     [SuiteName, 
<a name="224"/>  224: 	      [proplists:get_value(data_dir,Config)],SuiteName,
<a name="225"/>  225: 	      Skip]),
<a name="226"/>  226: 
<a name="227"/>  227:     until(fun() -&gt;
<a name="228"/>  228: 		  rpc:call(Node,test_server_ctrl,jobs,[]) =:= []
<a name="229"/>  229: 	  end),
<a name="230"/>  230:     
<a name="231"/>  231:     rpc:call(Node,test_server_ctrl, stop, []),
<a name="232"/>  232: 
<a name="233"/>  233:     LogDir1 = translate_filename(LogDir,Encoding),
<a name="234"/>  234:     LastRunDir = get_latest_run_dir(LogDir1),
<a name="235"/>  235:     LastSuiteLog = filename:join(LastRunDir,&quot;suite.log&quot;),
<a name="236"/>  236:     {ok,Data} =	test_server_test_lib:parse_suite(LastSuiteLog),
<a name="237"/>  237:     check([{&quot;Number of cases&quot;,NCases,Data#suite.n_cases},
<a name="238"/>  238: 	   {&quot;Number failed&quot;,NFail,Data#suite.n_cases_failed},
<a name="239"/>  239: 	   {&quot;Number expected&quot;,NExpected,Data#suite.n_cases_expected},
<a name="240"/>  240: 	   {&quot;Number successful&quot;,NSucc,Data#suite.n_cases_succ},
<a name="241"/>  241: 	   {&quot;Number user skipped&quot;,NUsrSkip,Data#suite.n_cases_user_skip},
<a name="242"/>  242: 	   {&quot;Number auto skipped&quot;,NAutoSkip,Data#suite.n_cases_auto_skip}], ok),
<a name="243"/>  243:     {NActualSkip,NActualFail,NActualSucc} = 
<a name="244"/>  244: 	lists:foldl(fun(#tc{ result = skip },{S,F,Su}) -&gt;
<a name="245"/>  245: 			     {S+1,F,Su};
<a name="246"/>  246: 		       (#tc{ result = auto_skip },{S,F,Su}) -&gt;
<a name="247"/>  247: 			    {S+1,F,Su};
<a name="248"/>  248: 		       (#tc{ result = ok },{S,F,Su}) -&gt;
<a name="249"/>  249: 			    {S,F,Su+1};
<a name="250"/>  250: 		       (#tc{ result = failed },{S,F,Su}) -&gt;
<a name="251"/>  251: 			    {S,F+1,Su}
<a name="252"/>  252: 		    end,{0,0,0},Data#suite.cases),
<a name="run_test_server_tests-last_expr"/><a name="253"/>  253:     Data.
<a name="254"/>  254: 
<a name="translate_filename-2"/><a name="255"/>  255: <b>translate_filename</b>(Filename,EncodingOnTestNode) -&gt;
<a name="translate_filename-last_expr"/><a name="256"/>  256: <b>    case {file:native_name_encoding</b>(),EncodingOnTestNode} of
<a name="257"/>  257: 	{X,X} -&gt; Filename;
<a name="258"/>  258: 	{utf8,latin1} -&gt; list_to_binary(Filename);
<a name="259"/>  259: 	{latin1,utf8} -&gt; unicode:characters_to_binary(Filename)
<a name="260"/>  260:     end.
<a name="261"/>  261: 
<a name="get_latest_run_dir-1"/><a name="262"/>  262: <b>get_latest_run_dir</b>(Dir) -&gt;
<a name="263"/>  263:     %% For the time being, filelib:wildcard cannot take a binary
<a name="264"/>  264:     %% argument, so we avoid using this here.
<a name="get_latest_run_dir-last_expr"/><a name="265"/>  265: <b>    case file:list_dir</b>(Dir) of
<a name="266"/>  266: 	{ok,Files} -&gt;
<a name="267"/>  267: 	    {ok,RE} = re:compile(&lt;&lt;&quot;^run.[1-2][-_\.0-9]*$&quot;&gt;&gt;),
<a name="268"/>  268: 	    RunDirs = lists:filter(
<a name="269"/>  269: 			fun(F) -&gt;
<a name="270"/>  270: 				L = l(F),
<a name="271"/>  271: 				case re:run(F,RE) of
<a name="272"/>  272: 				    {match,[{0,L}]} -&gt; true;
<a name="273"/>  273: 				    _ -&gt; false
<a name="274"/>  274: 				end
<a name="275"/>  275: 			end, Files),
<a name="276"/>  276: 	    case RunDirs of
<a name="277"/>  277: 		[] -&gt;
<a name="278"/>  278: 		    Dir;
<a name="279"/>  279: 		[H|T] -&gt;
<a name="280"/>  280: 		    filename:join(Dir,get_latest_dir(T,H))
<a name="281"/>  281: 	    end;
<a name="282"/>  282: 	_ -&gt;
<a name="283"/>  283: 	    Dir
<a name="284"/>  284:     end.
<a name="285"/>  285: 
<a name="l-1"/><a name="286"/>  286: <b>l</b>(X) when is_binary(X) -&gt; size(X);
<a name="l-last_expr"/><a name="287"/>  287: <b>l</b>(X) when is_list(X) -&gt; length(X).
<a name="288"/>  288: 
<a name="get_latest_dir-2"/><a name="289"/>  289: <b>get_latest_dir</b>([H|T],Latest) when H&gt;Latest -&gt;
<a name="290"/>  290:     get_latest_dir(T,H);
<a name="291"/>  291: <b>get_latest_dir</b>([_|T],Latest) -&gt;
<a name="292"/>  292:     get_latest_dir(T,Latest);
<a name="293"/>  293: <b>get_latest_dir</b>([],Latest) -&gt;
<a name="get_latest_dir-last_expr"/><a name="294"/>  294:     Latest.
<a name="295"/>  295: 
<a name="check-2"/><a name="296"/>  296: <b>check</b>([{Str,Same,Same}|T], Status) -&gt;
<a name="297"/>  297:     io:format(&quot;~s: ~p\n&quot;, [Str,Same]),
<a name="298"/>  298:     check(T, Status);
<a name="299"/>  299: <b>check</b>([{Str,Expected,Actual}|T], _) -&gt;
<a name="300"/>  300:     io:format(&quot;~s: expected ~p, actual ~p\n&quot;, [Str,Expected,Actual]),
<a name="301"/>  301:     check(T, error);
<a name="302"/>  302: <b>check</b>([], ok) -&gt; ok;
<a name="check-last_expr"/><a name="303"/>  303: <b>check</b>([], error) -&gt; test_server:fail().
<a name="304"/>  304: 
<a name="until-1"/><a name="305"/>  305: <b>until</b>(Fun) -&gt;
<a name="until-last_expr"/><a name="306"/>  306: <b>    case Fun</b>() of
<a name="307"/>  307: 	true -&gt;
<a name="308"/>  308: 	    ok;
<a name="309"/>  309: 	false -&gt;
<a name="310"/>  310: 	    timer:sleep(100),
<a name="311"/>  311: 	    until(Fun)
<a name="312"/>  312:     end.
<a name="313"/>  313: 
<a name="generate_and_run_unicode_test-2"/><a name="314"/>  314: <b>generate_and_run_unicode_test</b>(Config0,Encoding) -&gt;
<a name="315"/>  315:     DataDir = ?config(data_dir,Config0),
<a name="316"/>  316:     Suite = create_unicode_test_suite(DataDir,Encoding),
<a name="317"/>  317: 
<a name="318"/>  318:     %% We cannot run this test on default node since it must be
<a name="319"/>  319:     %% started with correct file name mode (+fnu/+fnl).
<a name="320"/>  320:     %% OBS: the node are stopped by end_per_testcase/2
<a name="321"/>  321:     Config1 = lists:keydelete(node,1,Config0),
<a name="322"/>  322:     Config2 = lists:keydelete(work_dir,1,Config1),
<a name="323"/>  323:     NodeName = list_to_atom(&quot;test_server_tester_&quot; ++ atom_to_list(Encoding)),
<a name="324"/>  324:     Config = start_node(Config2,NodeName,erts_switch(Encoding)),
<a name="325"/>  325: 
<a name="326"/>  326:     %% Compile the suite
<a name="327"/>  327:     Node = proplists:get_value(node,Config),
<a name="328"/>  328:     {ok,Mod} = rpc:call(Node,compile,file,[Suite,[report,{outdir,DataDir}]]),
<a name="329"/>  329:     ModStr = atom_to_list(Mod),
<a name="330"/>  330: 
<a name="331"/>  331:     %% Clean logdir
<a name="332"/>  332:     LogDir0 = filename:join(DataDir,ModStr++&quot;.logs&quot;),
<a name="333"/>  333:     LogDir = translate_filename(LogDir0,Encoding),
<a name="334"/>  334:     rm_dir(LogDir),
<a name="335"/>  335: 
<a name="336"/>  336:     %% Run the test
<a name="337"/>  337:     run_test_server_tests(ModStr, [], 3, 0, 1, 1, 0, 0, 0, 0, 3, Config),
<a name="338"/>  338: 
<a name="339"/>  339:     %% Check that all logs are created with utf8 encoded filenames
<a name="340"/>  340:     true = filelib:is_dir(LogDir),
<a name="341"/>  341: 
<a name="342"/>  342:     RunDir = get_latest_run_dir(LogDir),
<a name="343"/>  343:     true = filelib:is_dir(RunDir),
<a name="344"/>  344: 
<a name="345"/>  345:     LowerModStr = string:lowercase(ModStr),
<a name="346"/>  346:     SuiteHtml = translate_filename(LowerModStr++&quot;.src.html&quot;,Encoding),
<a name="347"/>  347:     true = filelib:is_regular(filename:join(RunDir,SuiteHtml)),
<a name="348"/>  348: 
<a name="349"/>  349:     TCLog = translate_filename(LowerModStr++&quot;.tc_äöå.html&quot;,Encoding),
<a name="350"/>  350:     true = filelib:is_regular(filename:join(RunDir,TCLog)),
<a name="generate_and_run_unicode_test-last_expr"/><a name="351"/>  351:     ok.
<a name="352"/>  352: 
<a name="353"/>  353: <i>%% Same as test_server_test_lib:start_slave, but starts a peer with</i>
<a name="354"/>  354: <i>%% additional arguments.</i>
<a name="355"/>  355: <i>%% The reason for this is that we need to start nodes with +fnu/+fnl,</i>
<a name="356"/>  356: <i>%% and that will not work well with a slave node since slave nodes run</i>
<a name="357"/>  357: <i>%% remote file system on master - i.e. they will use same file name</i>
<a name="358"/>  358: <i>%% mode as the master.</i>
<a name="start_node-3"/><a name="359"/>  359: <b>start_node</b>(Config,Name,Args) -&gt;
<a name="360"/>  360:     [_,Host] = string:lexemes(atom_to_list(node()), &quot;@&quot;),
<a name="361"/>  361:     ct:log(&quot;Trying to start ~w@~s~n&quot;,[Name,Host]),
<a name="start_node-last_expr"/><a name="362"/>  362: <b>    case test_server:start_node</b>(Name, peer, [{args,Args}]) of
<a name="363"/>  363: 	{error,Reason} -&gt;
<a name="364"/>  364: 	    test_server:fail(Reason);
<a name="365"/>  365: 	{ok,Node} -&gt;
<a name="366"/>  366: 	    ct:log(&quot;Node ~p started~n&quot;, [Node]),
<a name="367"/>  367: 	    test_server_test_lib:prepare_tester_node(Node,Config)
<a name="368"/>  368:     end.
<a name="369"/>  369: 
<a name="create_unicode_test_suite-2"/><a name="370"/>  370: <b>create_unicode_test_suite</b>(Dir,Encoding) -&gt;
<a name="371"/>  371:     ModStr = &quot;test_server_&quot;++atom_to_list(Encoding)++&quot;_äöå_SUITE&quot;,
<a name="372"/>  372:     File = filename:join(Dir,ModStr++&quot;.erl&quot;),
<a name="373"/>  373:     Suite =
<a name="374"/>  374: 	[&quot;%% -*- &quot;,epp:encoding_to_string(Encoding),&quot; -*-\n&quot;,
<a name="375"/>  375: 	 &quot;-module(&quot;,ModStr,&quot;).\n&quot;
<a name="376"/>  376: 	 &quot;\n&quot;
<a name="377"/>  377: 	 &quot;-export([all/1, init_per_suite/1, end_per_suite/1]).\n&quot;
<a name="378"/>  378: 	 &quot;-export([init_per_testcase/2, end_per_testcase/2]).\n&quot;
<a name="379"/>  379: 	 &quot;-export([tc_äöå/1]).\n&quot;
<a name="380"/>  380: 	 &quot;\n&quot;
<a name="381"/>  381: 	 &quot;-include_lib(\&quot;common_test/include/ct.hrl\&quot;).\n&quot;
<a name="382"/>  382: 	 &quot;\n&quot;
<a name="383"/>  383: 	 &quot;all(suite) -&gt;\n&quot;
<a name="384"/>  384: 	 &quot;    [tc_äöå].\n&quot;
<a name="385"/>  385: 	 &quot;\n&quot;
<a name="386"/>  386: 	 &quot;init_per_suite(Config) -&gt;\n&quot;
<a name="387"/>  387: 	 &quot;    Config.\n&quot;
<a name="388"/>  388: 	 &quot;\n&quot;
<a name="389"/>  389: 	 &quot;end_per_suite(_Config) -&gt;\n&quot;
<a name="390"/>  390: 	 &quot;    ok.\n&quot;
<a name="391"/>  391: 	 &quot;\n&quot;
<a name="392"/>  392: 	 &quot;init_per_testcase(_Case,Config) -&gt;\n&quot;
<a name="393"/>  393: 	 &quot;    init_timetrap(500,Config).\n&quot;
<a name="394"/>  394: 	 &quot;\n&quot;
<a name="395"/>  395: 	 &quot;init_timetrap(T,Config) -&gt;\n&quot;
<a name="396"/>  396: 	 &quot;    Dog = test_server:timetrap(T),\n&quot;
<a name="397"/>  397: 	 &quot;    [{watchdog, Dog}|Config].\n&quot;
<a name="398"/>  398: 	 &quot;\n&quot;
<a name="399"/>  399: 	 &quot;end_per_testcase(_Case,Config) -&gt;\n&quot;
<a name="400"/>  400: 	 &quot;    cancel_timetrap(Config).\n&quot;
<a name="401"/>  401: 	 &quot;\n&quot;
<a name="402"/>  402: 	 &quot;cancel_timetrap(Config) -&gt;\n&quot;
<a name="403"/>  403: 	 &quot;    Dog=?config(watchdog, Config),\n&quot;
<a name="404"/>  404: 	 &quot;    test_server:timetrap_cancel(Dog),\n&quot;
<a name="405"/>  405: 	 &quot;    ok.\n&quot;
<a name="406"/>  406: 	 &quot;\n&quot;
<a name="407"/>  407: 	 &quot;tc_äöå(Config) when is_list(Config) -&gt;\n&quot;
<a name="408"/>  408: 	 &quot;    true = filelib:is_dir(?config(priv_dir,Config)),\n&quot;
<a name="409"/>  409: 	 &quot;    ok.\n&quot;],
<a name="410"/>  410:     {ok,Fd} = file:open(raw_filename(File,Encoding),[write,{encoding,Encoding}]),
<a name="411"/>  411:     io:put_chars(Fd,Suite),
<a name="412"/>  412:     ok = file:close(Fd),
<a name="create_unicode_test_suite-last_expr"/><a name="413"/>  413:     File.
<a name="414"/>  414: 
<a name="raw_filename-2"/><a name="415"/>  415: <b>raw_filename</b>(Name,latin1) -&gt; list_to_binary(Name);
<a name="raw_filename-last_expr"/><a name="416"/>  416: <b>raw_filename</b>(Name,utf8)   -&gt; unicode:characters_to_binary(Name).
<a name="417"/>  417: 
<a name="rm_dir-1"/><a name="418"/>  418: <b>rm_dir</b>(Dir) -&gt;
<a name="rm_dir-last_expr"/><a name="419"/>  419: <b>    case file:list_dir</b>(Dir) of
<a name="420"/>  420: 	{error,enoent} -&gt;
<a name="421"/>  421: 	    ok;
<a name="422"/>  422: 	{ok,Files} -&gt;
<a name="423"/>  423: 	    rm_files([filename:join(Dir, F) || F &lt;- Files]),
<a name="424"/>  424: 	    file:del_dir(Dir)
<a name="425"/>  425:     end.
<a name="426"/>  426: 
<a name="rm_files-1"/><a name="427"/>  427: <b>rm_files</b>([F | Fs]) -&gt;
<a name="428"/>  428:     case file:read_file_info(F) of
<a name="429"/>  429: 	{ok,#file_info{type=directory}} -&gt;
<a name="430"/>  430: 	    rm_dir(F),
<a name="431"/>  431: 	    rm_files(Fs);
<a name="432"/>  432: 	{ok,_Regular} -&gt;
<a name="433"/>  433: 	    case file:delete(F) of
<a name="434"/>  434: 		ok -&gt;
<a name="435"/>  435: 		    rm_files(Fs);
<a name="436"/>  436: 		{error,Errno} -&gt;
<a name="437"/>  437: 		    exit({del_failed,F,Errno})
<a name="438"/>  438: 	    end
<a name="439"/>  439:     end;
<a name="440"/>  440: <b>rm_files</b>([]) -&gt;
<a name="rm_files-last_expr"/><a name="441"/>  441:     ok.
<a name="442"/>  442: 
<a name="erts_switch-1"/><a name="443"/>  443: <b>erts_switch</b>(latin1) -&gt; &quot;+fnl&quot;;
<a name="erts_switch-last_expr"/><a name="444"/>  444: <b>erts_switch</b>(utf8)   -&gt; &quot;+fnu&quot;.
</pre>
</body>
</html>
