<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/tools/make_test_dir/tools_test/make_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1996-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(make_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <b>-compile</b>(export_all).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="25"/>   25: 
<a name="26"/>   26: <b>-include_lib</b>(&quot;kernel/include/file.hrl&quot;).
<a name="27"/>   27: 
<a name="28"/>   28: <i>%% in ./make_SUITE_data there are test-files used by this</i>
<a name="29"/>   29: <i>%% test suite. There are 4 files named test1.erl ... test5.erl.</i>
<a name="30"/>   30: <i>%% The test files are attacked in various ways in order to put make on trial.</i>
<a name="31"/>   31: <i>%% </i>
<a name="32"/>   32: <i>%% Also, and Emakefile exists in ./make_SUITE_data. This file specifies</i>
<a name="33"/>   33: <i>%% that the file :&quot;test5.erl&quot; shall be compiled with the 'S' option,</i>
<a name="34"/>   34: <i>%% i.e. produce &quot;test5.S&quot; instead of &quot;test5.&lt;objext&gt;&quot;</i>
<a name="35"/>   35: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="36"/>   36: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="37"/>   37: 
<a name="all-0"/><a name="38"/>   38: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="39"/>   39:     [make_all, make_files, load, netload, recompile_on_changed_include,
<a name="40"/>   40:      emake_opts, {group, otp_6057}].
<a name="41"/>   41: 
<a name="groups-0"/><a name="42"/>   42: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="43"/>   43:     [{otp_6057,[],[otp_6057_a, otp_6057_b,
<a name="44"/>   44:                    otp_6057_c]}].
<a name="45"/>   45: 
<a name="init_per_suite-1"/><a name="46"/>   46: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="47"/>   47:     Config.
<a name="48"/>   48: 
<a name="end_per_suite-1"/><a name="49"/>   49: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="50"/>   50:     ok.
<a name="51"/>   51: 
<a name="init_per_group-2"/><a name="52"/>   52: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="53"/>   53: <b>    otp_6057_init</b>(Config).
<a name="54"/>   54: 
<a name="end_per_group-2"/><a name="55"/>   55: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="56"/>   56: <b>    otp_6057_end</b>(Config).
<a name="57"/>   57: 
<a name="init_per_testcase-2"/><a name="58"/>   58: <b>init_per_testcase</b>(_,Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="59"/>   59:     Config.
<a name="60"/>   60: 
<a name="end_per_testcase-2"/><a name="61"/>   61: <b>end_per_testcase</b>(_,_Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="62"/>   62:     ok.
<a name="63"/>   63: 
<a name="test_files-0"/><a name="test_files-last_expr"/><a name="64"/>   64: <b>test_files</b>() -&gt; [&quot;test1&quot;, &quot;test2&quot;, &quot;test3&quot;, &quot;test4&quot;].
<a name="65"/>   65: 
<a name="make_all-1"/><a name="66"/>   66: <b>make_all</b>(Config) when is_list(Config) -&gt;
<a name="67"/>   67:     Current = prepare_data_dir(Config),
<a name="68"/>   68:     up_to_date = make:all(),
<a name="69"/>   69:     ok = ensure_exists(test_files()),
<a name="70"/>   70:     ok = ensure_exists([&quot;test5&quot;],&quot;.S&quot;), % Emakefile: [{test5,['S']}
<a name="71"/>   71:     file:set_cwd(Current),
<a name="72"/>   72:     ensure_no_messages(),
<a name="make_all-last_expr"/><a name="73"/>   73:     ok.
<a name="74"/>   74: 
<a name="make_files-1"/><a name="75"/>   75: <b>make_files</b>(Config) when is_list(Config) -&gt;
<a name="76"/>   76:     Current = prepare_data_dir(Config),
<a name="77"/>   77: 
<a name="78"/>   78:     %% Make files that exist.
<a name="79"/>   79: 
<a name="80"/>   80:     Files = [test1, test2],
<a name="81"/>   81:     up_to_date = make:files(Files), % ok files
<a name="82"/>   82:     ok = ensure_exists(Files),
<a name="83"/>   83: 
<a name="84"/>   84:     error = make:files([test1,test7]), % non existing file
<a name="85"/>   85:     up_to_date = make:files([test1,test2],[debug_info]), % with option
<a name="86"/>   86: 
<a name="87"/>   87:     file:set_cwd(Current),
<a name="88"/>   88:     ensure_no_messages(),
<a name="make_files-last_expr"/><a name="89"/>   89:     ok.
<a name="90"/>   90: 
<a name="load-1"/><a name="91"/>   91: <b>load</b>(Config) -&gt;
<a name="92"/>   92:     Current = prepare_data_dir(Config),
<a name="93"/>   93:     code:purge(test1),
<a name="94"/>   94:     code:delete(test1),
<a name="95"/>   95:     false = code:is_loaded(test1),
<a name="96"/>   96:     up_to_date = make:files([test1], [load]),
<a name="97"/>   97:     {file,_} = code:is_loaded(test1),
<a name="98"/>   98:     file:set_cwd(Current),
<a name="99"/>   99:     ensure_no_messages(),
<a name="load-last_expr"/><a name="100"/>  100:     ok.
<a name="101"/>  101: 
<a name="netload-1"/><a name="102"/>  102: <b>netload</b>(Config) -&gt;
<a name="103"/>  103:     Current = prepare_data_dir(Config),
<a name="104"/>  104:     code:purge(test1),
<a name="105"/>  105:     code:delete(test1),
<a name="106"/>  106:     false = code:is_loaded(test1),
<a name="107"/>  107:     {ok,Peer,Node} = ?CT_PEER(),
<a name="108"/>  108:     up_to_date = make:files([test1], [netload]),
<a name="109"/>  109:     timer:sleep(1000), % async, so give some time
<a name="110"/>  110:     {file,F} = code:is_loaded(test1),
<a name="111"/>  111:     {file,F} = rpc:call(Node,code,is_loaded,[test1]),
<a name="112"/>  112:     peer:stop(Peer),
<a name="113"/>  113:     file:set_cwd(Current),
<a name="114"/>  114:     ensure_no_messages(),
<a name="netload-last_expr"/><a name="115"/>  115:     ok.
<a name="116"/>  116: 
<a name="recompile_on_changed_include-1"/><a name="117"/>  117: <b>recompile_on_changed_include</b>(Config) -&gt;
<a name="118"/>  118:     Current = prepare_data_dir(Config),
<a name="119"/>  119: 
<a name="120"/>  120:     Files = [test_incl1,&quot;incl_src/test_incl2&quot;],
<a name="121"/>  121:     up_to_date = make:files(Files),
<a name="122"/>  122:     ok = ensure_exists([test_incl1,test_incl2]),
<a name="123"/>  123: 
<a name="124"/>  124:     {ok, FileInfo11} = file:read_file_info(&quot;test_incl1.beam&quot;),
<a name="125"/>  125:     Date11 = FileInfo11#file_info.mtime,
<a name="126"/>  126:     {ok, FileInfo21} = file:read_file_info(&quot;test_incl2.beam&quot;),
<a name="127"/>  127:     Date21 = FileInfo21#file_info.mtime,
<a name="128"/>  128:     timer:sleep(2000),
<a name="129"/>  129: 
<a name="130"/>  130:     %% Touch the include file
<a name="131"/>  131:     {ok,Bin} = file:read_file(&quot;test_incl.hrl&quot;),
<a name="132"/>  132:     ok = file:delete(&quot;test_incl.hrl&quot;),
<a name="133"/>  133:     ok = file:write_file(&quot;test_incl.hrl&quot;,Bin),
<a name="134"/>  134: 
<a name="135"/>  135:     up_to_date = make:files(Files),
<a name="136"/>  136: 
<a name="137"/>  137:     {ok, FileInfo12} = file:read_file_info(&quot;test_incl1.beam&quot;),
<a name="138"/>  138:     case FileInfo12#file_info.mtime of
<a name="139"/>  139:         Date11 -&gt; ct:fail({&quot;file not recompiled&quot;, &quot;test_incl1.beam&quot;});
<a name="140"/>  140:         _Date12 -&gt; ok
<a name="141"/>  141:     end,
<a name="142"/>  142:     {ok, FileInfo22} = file:read_file_info(&quot;test_incl2.beam&quot;),
<a name="143"/>  143:     case FileInfo22#file_info.mtime of
<a name="144"/>  144:         Date21 -&gt; ct:fail({&quot;file not recompiled&quot;, &quot;test_incl2.beam&quot;});
<a name="145"/>  145:         _Date22 -&gt; ok
<a name="146"/>  146:     end,
<a name="147"/>  147: 
<a name="148"/>  148:     file:set_cwd(Current),
<a name="149"/>  149:     ensure_no_messages(),
<a name="recompile_on_changed_include-last_expr"/><a name="150"/>  150:     ok.
<a name="151"/>  151: 
<a name="emake_opts-1"/><a name="152"/>  152: <b>emake_opts</b>(Config) when is_list(Config) -&gt;
<a name="153"/>  153:     Current = prepare_data_dir(Config),
<a name="154"/>  154: 
<a name="155"/>  155:     %% prove that emake is used in opts instead of local Emakefile
<a name="156"/>  156:     Opts = [{emake, [test8, test9]}],
<a name="157"/>  157:     error = make:all(Opts),
<a name="158"/>  158:     error = make:files([test9], Opts),
<a name="159"/>  159:     &quot;test8.beam&quot; = ensure_exists([test8]),
<a name="160"/>  160:     &quot;test9.beam&quot; = ensure_exists([test9]),
<a name="161"/>  161:     &quot;test5.S&quot; = ensure_exists([&quot;test5&quot;],&quot;.S&quot;),
<a name="162"/>  162: 
<a name="163"/>  163:     file:set_cwd(Current),
<a name="164"/>  164:     ensure_no_messages(),
<a name="emake_opts-last_expr"/><a name="165"/>  165:     ok.
<a name="166"/>  166: 
<a name="167"/>  167: <i>%% Moves to the data directory of this suite, clean it from any object</i>
<a name="168"/>  168: <i>%% files (*.jam for a JAM emulator).  Returns the previous directory.</i>
<a name="prepare_data_dir-1"/><a name="169"/>  169: <b>prepare_data_dir</b>(Config) -&gt;
<a name="170"/>  170:     {ok, Current} = file:get_cwd(),
<a name="171"/>  171:     {value, {data_dir, Dir}} = lists:keysearch(data_dir, 1, Config),
<a name="172"/>  172:     file:set_cwd(Dir),
<a name="173"/>  173:     {ok, Files} = file:list_dir(&quot;.&quot;),
<a name="174"/>  174:     delete_obj(Files, code:objfile_extension()),
<a name="175"/>  175:     ensure_no_messages(),
<a name="prepare_data_dir-last_expr"/><a name="176"/>  176:     Current.
<a name="177"/>  177: 
<a name="delete_obj-2"/><a name="178"/>  178: <b>delete_obj</b>([File|Rest], ObjExt) -&gt;
<a name="179"/>  179:     case filename:extension(File) of
<a name="180"/>  180:         ObjExt -&gt; file:delete(File);
<a name="181"/>  181:         &quot;.S&quot; -&gt; file:delete(File);
<a name="182"/>  182:         _ -&gt; ok
<a name="183"/>  183:     end,
<a name="184"/>  184:     delete_obj(Rest, ObjExt);
<a name="185"/>  185: <b>delete_obj</b>([], _) -&gt;
<a name="delete_obj-last_expr"/><a name="186"/>  186:     ok.
<a name="187"/>  187: 
<a name="188"/>  188: 
<a name="189"/>  189: 
<a name="190"/>  190: <i>%% Ensure that the given object files exists.</i>
<a name="ensure_exists-1"/><a name="191"/>  191: <b>ensure_exists</b>(Names) -&gt;
<a name="ensure_exists-last_expr"/><a name="192"/>  192: <b>    ensure_exists</b>(Names, code:objfile_extension()).
<a name="193"/>  193: 
<a name="ensure_exists-2"/><a name="194"/>  194: <b>ensure_exists</b>([Name|Rest], ObjExt) when is_atom(Name) -&gt;
<a name="195"/>  195:     ensure_exists([atom_to_list(Name)|Rest], ObjExt);
<a name="196"/>  196: <b>ensure_exists</b>([Name|Rest], ObjExt) -&gt;
<a name="197"/>  197:     case filelib:is_regular(Name++ObjExt) of
<a name="198"/>  198:         true -&gt;
<a name="199"/>  199:             ensure_exists(Rest, ObjExt);
<a name="200"/>  200:         false -&gt;
<a name="201"/>  201:             Name++ObjExt
<a name="202"/>  202:     end;
<a name="203"/>  203: <b>ensure_exists</b>([], _) -&gt;
<a name="ensure_exists-last_expr"/><a name="204"/>  204:     ok.
<a name="205"/>  205: 
<a name="otp_6057_init-1"/><a name="206"/>  206: <b>otp_6057_init</b>(Config) when is_list(Config) -&gt;
<a name="207"/>  207:     DataDir = proplists:get_value(data_dir, Config),
<a name="208"/>  208:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="209"/>  209: 
<a name="210"/>  210:     %% Create the directories PrivDir/otp_6057/src1, /src2 and /ebin
<a name="211"/>  211:     Src1 = filename:join([PrivDir, otp_6057, src1]),
<a name="212"/>  212:     Src2 = filename:join([PrivDir, otp_6057, src2]),
<a name="213"/>  213:     Ebin = filename:join([PrivDir, otp_6057, ebin]),
<a name="214"/>  214:     ok = file:make_dir(filename:join(PrivDir, otp_6057)),
<a name="215"/>  215:     ok = file:make_dir(Src1),
<a name="216"/>  216:     ok = file:make_dir(Src2),
<a name="217"/>  217:     ok = file:make_dir(Ebin),
<a name="218"/>  218: 
<a name="219"/>  219:     %% Copy test1.erl and test2.erl to src1, and test3.erl to src2
<a name="220"/>  220:     Test1orig = filename:join(DataDir, &quot;test1.erl&quot;),
<a name="221"/>  221:     Test2orig = filename:join(DataDir, &quot;test2.erl&quot;),
<a name="222"/>  222:     Test3orig = filename:join(DataDir, &quot;test3.erl&quot;),
<a name="223"/>  223:     Test1 = filename:join(Src1, &quot;test1.erl&quot;),
<a name="224"/>  224:     Test2 = filename:join(Src1, &quot;test2.erl&quot;),
<a name="225"/>  225:     Test3 = filename:join(Src2, &quot;test3.erl&quot;),
<a name="226"/>  226:     {ok, _} = file:copy(Test1orig, Test1),
<a name="227"/>  227:     {ok, _} = file:copy(Test2orig, Test2),
<a name="228"/>  228:     {ok, _} = file:copy(Test3orig, Test3),
<a name="229"/>  229: 
<a name="230"/>  230:     %% Create an Emakefile in src1
<a name="231"/>  231:     Emakefile = filename:join(Src1, &quot;Emakefile&quot;),
<a name="232"/>  232:     {ok, Fd} = file:open(Emakefile, write),
<a name="233"/>  233:     ok = io:write(Fd, {[&quot;test1.erl&quot;,&quot;test2&quot;,&quot;../src2/test3&quot;],
<a name="234"/>  234:                        [{outdir,&quot;../ebin&quot;}]}),
<a name="235"/>  235:     ok = io:fwrite(Fd, &quot;.~n&quot;, []),
<a name="236"/>  236:     ok = file:close(Fd),
<a name="237"/>  237: 
<a name="238"/>  238:     ensure_no_messages(),
<a name="otp_6057_init-last_expr"/><a name="239"/>  239:     Config.
<a name="240"/>  240: 
<a name="241"/>  241: <i>%% Test that make:all/0, suite/0 looks for object file in correct place</i>
<a name="otp_6057_a-1"/><a name="242"/>  242: <b>otp_6057_a</b>(Config) when is_list(Config) -&gt;
<a name="243"/>  243:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="244"/>  244: 
<a name="245"/>  245:     %% Go to src1, saving old CWD
<a name="246"/>  246:     {ok, CWD} = file:get_cwd(),
<a name="247"/>  247:     Src1 = filename:join([PrivDir, otp_6057, src1]),
<a name="248"/>  248:     ok = file:set_cwd(Src1),
<a name="249"/>  249: 
<a name="250"/>  250:     %% Call make:all()
<a name="251"/>  251:     up_to_date = make:all(),
<a name="252"/>  252: 
<a name="253"/>  253:     %% Ensure that all beam files are created in the ebin directory
<a name="254"/>  254:     Ebin = filename:join([PrivDir, otp_6057, ebin]),
<a name="255"/>  255:     Test1 = filename:join(Ebin, test1),
<a name="256"/>  256:     Test2 = filename:join(Ebin, test2),
<a name="257"/>  257:     Test3 = filename:join(Ebin, test3),
<a name="258"/>  258:     case ensure_exists([Test1, Test2, Test3]) of
<a name="259"/>  259:         ok -&gt; ok;
<a name="260"/>  260:         Missing -&gt;
<a name="261"/>  261:             ct:fail({&quot;missing beam file&quot;, Missing})
<a name="262"/>  262:     end,
<a name="263"/>  263: 
<a name="264"/>  264:     %% Check creation date of test1.beam and make sure it is not
<a name="265"/>  265:     %% recompiled if make:all() is called again.
<a name="266"/>  266:     %% (Sleep a while, if the file is recompiled within a second then
<a name="267"/>  267:     %%  mtime will be the same).
<a name="268"/>  268:     {ok, FileInfo1} = file:read_file_info(Test1++&quot;.beam&quot;),
<a name="269"/>  269:     Date1 = FileInfo1#file_info.mtime,
<a name="270"/>  270:     timer:sleep(2000),
<a name="271"/>  271:     up_to_date = make:all(),
<a name="272"/>  272:     {ok, FileInfo2} = file:read_file_info(Test1++&quot;.beam&quot;),
<a name="273"/>  273:     case FileInfo2#file_info.mtime of
<a name="274"/>  274:         Date1 -&gt; ok;
<a name="275"/>  275:         _Date2 -&gt;
<a name="276"/>  276:             ct:fail({&quot;recompiled beam file&quot;, Test1++&quot;.beam&quot;})
<a name="277"/>  277:     end,
<a name="278"/>  278: 
<a name="279"/>  279:     %% Remove the beam files
<a name="280"/>  280:     ok =
<a name="281"/>  281:     ensure_removed([Test1++&quot;.beam&quot;,Test2++&quot;.beam&quot;,Test2++&quot;.beam&quot;]),
<a name="282"/>  282: 
<a name="283"/>  283:     %% Return to original CWD
<a name="284"/>  284:     ok = file:set_cwd(CWD),
<a name="285"/>  285: 
<a name="286"/>  286:     ensure_no_messages(),
<a name="otp_6057_a-last_expr"/><a name="287"/>  287:     ok.
<a name="288"/>  288: 
<a name="289"/>  289: <i>%% Test that make:files/1 can handle a file in another directory</i>
<a name="otp_6057_b-1"/><a name="290"/>  290: <b>otp_6057_b</b>(Config) when is_list(Config) -&gt;
<a name="291"/>  291:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="292"/>  292: 
<a name="293"/>  293:     %% Go to src1, saving old CWD
<a name="294"/>  294:     {ok, CWD} = file:get_cwd(),
<a name="295"/>  295:     Src1 = filename:join([PrivDir, otp_6057, src1]),
<a name="296"/>  296:     ok = file:set_cwd(Src1),
<a name="297"/>  297: 
<a name="298"/>  298:     %% Ensure there is no beam file already
<a name="299"/>  299:     Ebin = filename:join([PrivDir, otp_6057, ebin]),
<a name="300"/>  300:     Test3 = filename:join(Ebin, &quot;test3&quot;),
<a name="301"/>  301:     ok = ensure_removed([Test3++&quot;.beam&quot;]),
<a name="302"/>  302: 
<a name="303"/>  303:     %% Call make:files/1
<a name="304"/>  304:     up_to_date = make:files([&quot;../src2/test3&quot;]),
<a name="305"/>  305: 
<a name="306"/>  306:     %% Ensure that the beam file is created in the ebin directory
<a name="307"/>  307:     case ensure_exists([Test3]) of
<a name="308"/>  308:         ok -&gt; ok;
<a name="309"/>  309:         Missing -&gt;
<a name="310"/>  310:             ct:fail({&quot;missing beam file&quot;, Missing})
<a name="311"/>  311:     end,
<a name="312"/>  312: 
<a name="313"/>  313:     %% Remove the beam file
<a name="314"/>  314:     ok = ensure_removed([Test3++&quot;.beam&quot;]),
<a name="315"/>  315: 
<a name="316"/>  316:     %% Return to original CWD
<a name="317"/>  317:     ok = file:set_cwd(CWD),
<a name="318"/>  318: 
<a name="319"/>  319:     ensure_no_messages(),
<a name="otp_6057_b-last_expr"/><a name="320"/>  320:     ok.
<a name="321"/>  321: 
<a name="322"/>  322: <i>%% Test that make:files/1 find options in Emakefile if a file is</i>
<a name="323"/>  323: <i>%% given with the .erl extension there</i>
<a name="otp_6057_c-1"/><a name="324"/>  324: <b>otp_6057_c</b>(Config) when is_list(Config) -&gt;
<a name="325"/>  325:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="326"/>  326: 
<a name="327"/>  327:     %% Go to src1, saving old CWD
<a name="328"/>  328:     {ok, CWD} = file:get_cwd(),
<a name="329"/>  329:     Src1 = filename:join([PrivDir, otp_6057, src1]),
<a name="330"/>  330:     ok = file:set_cwd(Src1),
<a name="331"/>  331: 
<a name="332"/>  332:     %% Ensure there are no beam files already
<a name="333"/>  333:     Ebin = filename:join([PrivDir, otp_6057, ebin]),
<a name="334"/>  334:     Test1 = filename:join(Ebin, &quot;test1&quot;),
<a name="335"/>  335:     Test2 = filename:join(Ebin, &quot;test2&quot;),
<a name="336"/>  336:     ok = ensure_removed([Test1++&quot;.beam&quot;,Test2++&quot;.beam&quot;]),
<a name="337"/>  337: 
<a name="338"/>  338:     %% Call make:files/1
<a name="339"/>  339:     up_to_date = make:files([test1, test2]),
<a name="340"/>  340: 
<a name="341"/>  341:     %% Ensure that the beam files are created in the ebin directory
<a name="342"/>  342:     Ebin = filename:join([PrivDir, otp_6057, ebin]),
<a name="343"/>  343:     case ensure_exists([Test1, Test2]) of
<a name="344"/>  344:         ok -&gt; ok;
<a name="345"/>  345:         Missing -&gt;
<a name="346"/>  346:             ct:fail({&quot;missing beam file&quot;, Missing})
<a name="347"/>  347:     end,
<a name="348"/>  348: 
<a name="349"/>  349:     %% Remove the beam files
<a name="350"/>  350:     ok = ensure_removed([Test1++&quot;.beam&quot;, Test2++&quot;.beam&quot;]),
<a name="351"/>  351: 
<a name="352"/>  352:     %% Return to original CWD
<a name="353"/>  353:     ok = file:set_cwd(CWD),
<a name="354"/>  354: 
<a name="355"/>  355:     ensure_no_messages(),
<a name="otp_6057_c-last_expr"/><a name="356"/>  356:     ok.
<a name="357"/>  357: 
<a name="otp_6057_end-1"/><a name="358"/>  358: <b>otp_6057_end</b>(Config) when is_list(Config) -&gt;
<a name="otp_6057_end-last_expr"/><a name="359"/>  359:     Config.
<a name="360"/>  360: 
<a name="ensure_removed-1"/><a name="361"/>  361: <b>ensure_removed</b>([File|Files]) -&gt;
<a name="362"/>  362:     file:delete(File),
<a name="363"/>  363:     ensure_removed(Files);
<a name="364"/>  364: <b>ensure_removed</b>([]) -&gt;
<a name="ensure_removed-last_expr"/><a name="365"/>  365:     ok.
<a name="366"/>  366: 
<a name="ensure_no_messages-0"/><a name="367"/>  367: <b>ensure_no_messages</b>() -&gt;
<a name="ensure_no_messages-last_expr"/><a name="368"/>  368: <b>    ensure_no_messages</b>(0).
<a name="369"/>  369: 
<a name="ensure_no_messages-1"/><a name="370"/>  370: <b>ensure_no_messages</b>(N) -&gt;
<a name="ensure_no_messages-last_expr"/><a name="371"/>  371:     receive
<a name="372"/>  372:         Any -&gt;
<a name="373"/>  373:             io:format(&quot;Unexpected message: ~p&quot;, [Any]),
<a name="374"/>  374:             ensure_no_messages(N+1)
<a name="375"/>  375:     after 0 -&gt;
<a name="376"/>  376:               case N of
<a name="377"/>  377:                   0 -&gt; ok;
<a name="378"/>  378:                   N -&gt; ct:fail(failed)
<a name="379"/>  379:               end
<a name="380"/>  380:     end.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
