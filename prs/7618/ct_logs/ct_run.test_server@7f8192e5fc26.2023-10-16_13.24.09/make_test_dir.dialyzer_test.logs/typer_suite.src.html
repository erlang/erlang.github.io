<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/dialyzer/make_test_dir/dialyzer_test/typer_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2017-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(typer_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <b>-export</b>([all/0,suite/0,
<a name="23"/>   23:          smoke/1,
<a name="24"/>   24:          smoke_incremental_plt/1,
<a name="25"/>   25:          gh_6296_no_spec_flag_does_not_break_records/1,
<a name="26"/>   26:          contract_violation/1]).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="29"/>   29: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="30"/>   30: <b>suite</b>() -&gt; [{ct_hooks,[ts_install_cth]}].
<a name="31"/>   31: 
<a name="all-0"/><a name="32"/>   32: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="33"/>   33:     [smoke,
<a name="34"/>   34:      smoke_incremental_plt,
<a name="35"/>   35:      gh_6296_no_spec_flag_does_not_break_records,
<a name="36"/>   36:      contract_violation].
<a name="37"/>   37: 
<a name="smoke-1"/><a name="38"/>   38: <b>smoke</b>(Config) -&gt;
<a name="39"/>   39:     OutDir = proplists:get_value(priv_dir, Config),
<a name="smoke-last_expr"/><a name="40"/>   40: <b>    case dialyzer_common:check_plt</b>(OutDir) of
<a name="41"/>   41:         fail -&gt; {skip, &quot;Plt creation/check failed.&quot;};
<a name="42"/>   42:         ok -&gt;
<a name="43"/>   43:           Code = &lt;&lt;&quot;-module(typer_test_module).
<a name="44"/>   44:                    -compile([export_all,nowarn_export_all]).
<a name="45"/>   45:                    a(L) -&gt;
<a name="46"/>   46:                      L ++ [1,2,3].&quot;&gt;&gt;,
<a name="47"/>   47:           PrivDir = proplists:get_value(priv_dir, Config),
<a name="48"/>   48:           Src = filename:join(PrivDir, &quot;typer_test_module.erl&quot;),
<a name="49"/>   49:           ok = file:write_file(Src, Code),
<a name="50"/>   50:           Args = &quot;--plt &quot; ++ PrivDir ++ &quot;dialyzer_plt&quot;,
<a name="51"/>   51:           Res = [&quot;^$&quot;,
<a name="52"/>   52:                  &quot;^%% File:&quot;,
<a name="53"/>   53:                  &quot;^%% ----&quot;,
<a name="54"/>   54:                  &quot;^-spec a&quot;,
<a name="55"/>   55:                  &quot;^_OK_&quot;],
<a name="56"/>   56:           run(Config, Args, Src, Res),
<a name="57"/>   57:           ok
<a name="58"/>   58:     end.
<a name="59"/>   59: 
<a name="gh_6296_no_spec_flag_does_not_break_records-1"/><a name="60"/>   60: <b>gh_6296_no_spec_flag_does_not_break_records</b>(Config) -&gt;
<a name="61"/>   61:     Code = &lt;&lt;&quot;-module(gh_6296).
<a name="62"/>   62:               -export([record_pattern/1]).
<a name="63"/>   63: 
<a name="64"/>   64:               -record(my_rec, {is_foo :: boolean(),
<a name="65"/>   65:                                bar :: non_neg_integer()}).
<a name="66"/>   66: 
<a name="67"/>   67:               -spec record_pattern(#my_rec{}) -&gt; atom().
<a name="68"/>   68:               record_pattern(#my_rec{is_foo = IsFoo}) -&gt;
<a name="69"/>   69:                 IsFoo.
<a name="70"/>   70: 
<a name="71"/>   71:               some_other_function_to_trigger_the_issue(undefined) -&gt; ok.&quot;&gt;&gt;,
<a name="72"/>   72:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="73"/>   73:     Src = filename:join(PrivDir, &quot;gh_6296.erl&quot;),
<a name="74"/>   74:     ok = file:write_file(Src, Code),
<a name="75"/>   75:     {ok, Beam} = compile(Config, Code, gh_6296, []),
<a name="76"/>   76:     Plt = PrivDir ++ &quot;dialyzer_iplt&quot;,
<a name="77"/>   77:     _ = dialyzer:run([{analysis_type, incremental},
<a name="78"/>   78:                       {files, [Beam]},
<a name="79"/>   79:                       {apps, [stdlib, kernel, erts]},
<a name="80"/>   80:                       {from, byte_code},
<a name="81"/>   81:                       {init_plt, Plt},
<a name="82"/>   82:                       {output_plt, Plt}]),
<a name="83"/>   83:     Args = io_lib:format(&quot;--no_spec --show --plt ~ts&quot;, [Plt]),
<a name="84"/>   84:     Res = [&quot;^$&quot;,
<a name="85"/>   85:            &quot;^%% File:&quot;,
<a name="86"/>   86:            &quot;^%% ----&quot;,
<a name="87"/>   87:            &quot;^-spec record_pattern&quot;,
<a name="88"/>   88:            &quot;^-spec some_other_function_to_trigger_the_issue&quot;,
<a name="89"/>   89:            &quot;^_OK_&quot;],
<a name="90"/>   90:     run(Config, Args, Src, Res),
<a name="gh_6296_no_spec_flag_does_not_break_records-last_expr"/><a name="91"/>   91:     ok.
<a name="92"/>   92: 
<a name="smoke_incremental_plt-1"/><a name="93"/>   93: <b>smoke_incremental_plt</b>(Config) -&gt;
<a name="94"/>   94:     Code = &lt;&lt;&quot;-module(typer_test_module).
<a name="95"/>   95:              -compile([export_all,nowarn_export_all]).
<a name="96"/>   96:              a(L) -&gt;
<a name="97"/>   97:                L ++ [1,2,3].&quot;&gt;&gt;,
<a name="98"/>   98:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="99"/>   99:     Src = filename:join(PrivDir, &quot;typer_test_module.erl&quot;),
<a name="100"/>  100:     ok = file:write_file(Src, Code),
<a name="101"/>  101:     {ok, Beam} = compile(Config, Code, typer_test_module, []),
<a name="102"/>  102:     Plt = PrivDir ++ &quot;dialyzer_iplt&quot;,
<a name="103"/>  103:     _ = dialyzer:run([{analysis_type, incremental},
<a name="104"/>  104:                       {files, [Beam]},
<a name="105"/>  105:                       {apps, [stdlib, kernel, erts]},
<a name="106"/>  106:                       {from, byte_code},
<a name="107"/>  107:                       {init_plt, Plt},
<a name="108"/>  108:                       {output_plt, Plt}]),
<a name="109"/>  109:     Args = &quot;--plt &quot; ++ Plt,
<a name="110"/>  110:     Res = [&quot;^$&quot;,
<a name="111"/>  111:            &quot;^%% File:&quot;,
<a name="112"/>  112:            &quot;^%% ----&quot;,
<a name="113"/>  113:            &quot;^-spec a&quot;,
<a name="114"/>  114:            &quot;^_OK_&quot;],
<a name="115"/>  115:     run(Config, Args, Src, Res),
<a name="smoke_incremental_plt-last_expr"/><a name="116"/>  116:     ok.
<a name="117"/>  117: 
<a name="contract_violation-1"/><a name="118"/>  118: <b>contract_violation</b>(Config) -&gt;
<a name="119"/>  119:     OutDir = proplists:get_value(priv_dir, Config),
<a name="contract_violation-last_expr"/><a name="120"/>  120: <b>    case dialyzer_common:check_plt</b>(OutDir) of
<a name="121"/>  121:         fail -&gt;
<a name="122"/>  122:             {skip, &quot;Plt creation/check failed.&quot;};
<a name="123"/>  123:         ok -&gt;
<a name="124"/>  124:             Code = &lt;&lt;&quot;-module(typer_test_module).
<a name="125"/>  125:                    -export([foo/1]).
<a name="126"/>  126:                    -spec foo(boolean()) -&gt; string().
<a name="127"/>  127:                    foo(N) -&gt;
<a name="128"/>  128:                        integer_to_list(N).&quot;&gt;&gt;,
<a name="129"/>  129:             PrivDir = proplists:get_value(priv_dir, Config),
<a name="130"/>  130:             Src = filename:join(PrivDir, &quot;typer_test_module.erl&quot;),
<a name="131"/>  131:             ok = file:write_file(Src, Code),
<a name="132"/>  132:             Args = &quot;--plt &quot; ++ PrivDir ++ &quot;dialyzer_plt&quot;,
<a name="133"/>  133:             Res = [&quot;^typer: Error in contract of function typer_test_module:foo/1&quot;,
<a name="134"/>  134:                    &quot;^\t The contract is: \\(boolean\\(\\)\\) -&gt; string\\(\\)&quot;,
<a name="135"/>  135:                    &quot;^\t but the inferred signature is: \\(integer\\(\\)\\) -&gt; string\\(\\)&quot;,
<a name="136"/>  136:                    &quot;_ERROR_&quot;],
<a name="137"/>  137:             run(Config, Args, Src, Res),
<a name="138"/>  138:             ok
<a name="139"/>  139:     end.
<a name="140"/>  140: 
<a name="compile-4"/><a name="141"/>  141: <b>compile</b>(Config, Prog, Module, CompileOpts) -&gt;
<a name="142"/>  142:     Source = lists:concat([Module, &quot;.erl&quot;]),
<a name="143"/>  143:     PrivDir = proplists:get_value(priv_dir,Config),
<a name="144"/>  144:     Filename = filename:join([PrivDir, Source]),
<a name="145"/>  145:     ok = file:write_file(Filename, Prog),
<a name="146"/>  146:     Opts = [{outdir, PrivDir}, debug_info | CompileOpts],
<a name="147"/>  147:     {ok, Module} = compile:file(Filename, Opts),
<a name="compile-last_expr"/><a name="148"/>  148: <b>    {ok, filename:join</b>([PrivDir, lists:concat([Module, &quot;.beam&quot;])])}.
<a name="149"/>  149: 
<a name="typer-0"/><a name="150"/>  150: <b>typer</b>() -&gt;
<a name="typer-last_expr"/><a name="151"/>  151: <b>    case os:find_executable</b>(&quot;typer&quot;) of
<a name="152"/>  152:         false -&gt;
<a name="153"/>  153:             ct:fail(&quot;Can't find typer&quot;);
<a name="154"/>  154:         Typer -&gt;
<a name="155"/>  155:             Typer
<a name="156"/>  156:     end.
<a name="157"/>  157: 
<a name="158"/>  158: <i>%% Runs a command.</i>
<a name="159"/>  159: 
<a name="run-4"/><a name="160"/>  160: <b>run</b>(Config, Args0, Name, Expect) -&gt;
<a name="161"/>  161:     Args = Args0 ++ &quot; &quot; ++ Name,
<a name="162"/>  162:     Result = run_command(Config, Args),
<a name="run-last_expr"/><a name="163"/>  163: <b>    verify_result</b>(Result, Expect).
<a name="164"/>  164: 
<a name="verify_result-2"/><a name="165"/>  165: <b>verify_result</b>(Result, Expect) -&gt;
<a name="166"/>  166:     Messages = split(Result, [], []),
<a name="167"/>  167:     io:format(&quot;Result: ~p&quot;, [Messages]),
<a name="168"/>  168:     io:format(&quot;Expected: ~p&quot;, [Expect]),
<a name="verify_result-last_expr"/><a name="169"/>  169: <b>    match_messages</b>(Messages, Expect).
<a name="170"/>  170: 
<a name="split-3"/><a name="171"/>  171: <b>split</b>([$\n|Rest], Current, Lines) -&gt;
<a name="172"/>  172:     split(Rest, [], [lists:reverse(Current)|Lines]);
<a name="173"/>  173: <b>split</b>([$\r|Rest], Current, Lines) -&gt;
<a name="174"/>  174:     split(Rest, Current, Lines);
<a name="175"/>  175: <b>split</b>([Char|Rest], Current, Lines) -&gt;
<a name="176"/>  176:     split(Rest, [Char|Current], Lines);
<a name="177"/>  177: <b>split</b>([], [], Lines) -&gt;
<a name="178"/>  178:     lists:reverse(Lines);
<a name="179"/>  179: <b>split</b>([], Current, Lines) -&gt;
<a name="split-last_expr"/><a name="180"/>  180: <b>    split</b>([], [], [lists:reverse(Current)|Lines]).
<a name="181"/>  181: 
<a name="match_messages-2"/><a name="182"/>  182: <b>match_messages</b>([Msg|Rest1], [Regexp|Rest2]) -&gt;
<a name="183"/>  183:     case re:run(Msg, Regexp, [{capture,none}, unicode]) of
<a name="184"/>  184:         match -&gt;
<a name="185"/>  185:             ok;
<a name="186"/>  186:         nomatch -&gt;
<a name="187"/>  187:             io:format(&quot;Not matching: ~s\n&quot;, [Msg]),
<a name="188"/>  188:             io:format(&quot;Regexp      : ~s\n&quot;, [Regexp]),
<a name="189"/>  189:             ct:fail(message_mismatch)
<a name="190"/>  190:     end,
<a name="191"/>  191:     match_messages(Rest1, Rest2);
<a name="192"/>  192: <b>match_messages</b>([], [Expect|Rest]) -&gt;
<a name="193"/>  193:     ct:fail({too_few_messages, [Expect|Rest]});
<a name="194"/>  194: <b>match_messages</b>([Msg|Rest], []) -&gt;
<a name="195"/>  195:     ct:fail({too_many_messages, [Msg|Rest]});
<a name="196"/>  196: <b>match_messages</b>([], []) -&gt;
<a name="match_messages-last_expr"/><a name="197"/>  197:     ok.
<a name="198"/>  198: 
<a name="199"/>  199: <i>%% Runs the command using os:cmd/1.</i>
<a name="200"/>  200: <i>%%</i>
<a name="201"/>  201: <i>%% Returns the output from the command (as a list of characters with</i>
<a name="202"/>  202: <i>%% embedded newlines).  The very last line will indicate the</i>
<a name="203"/>  203: <i>%% exit status of the command, where _OK_ means zero, and _ERROR_</i>
<a name="204"/>  204: <i>%% a non-zero exit status.</i>
<a name="205"/>  205: 
<a name="run_command-2"/><a name="206"/>  206: <b>run_command</b>(Config, Args) -&gt;
<a name="207"/>  207:     TmpDir = filename:join(proplists:get_value(priv_dir, Config), &quot;tmp&quot;),
<a name="208"/>  208:     file:make_dir(TmpDir),
<a name="209"/>  209:     {RunFile, Run, Script} = run_command(TmpDir, os:type(), Args),
<a name="210"/>  210:     ok = file:write_file(filename:join(TmpDir, RunFile),
<a name="211"/>  211:                          unicode:characters_to_binary(Script)),
<a name="212"/>  212:     io:format(&quot;~ts\n&quot;, [Script]),
<a name="run_command-last_expr"/><a name="213"/>  213: <b>    os:cmd</b>(Run).
<a name="214"/>  214: 
<a name="run_command-3"/><a name="215"/>  215: <b>run_command</b>(Dir, {win32, _}, Args) -&gt;
<a name="216"/>  216:     BatchFile = filename:join(Dir, &quot;run.bat&quot;),
<a name="217"/>  217:     Run = re:replace(filename:rootname(BatchFile), &quot;/&quot;, &quot;\\&quot;,
<a name="218"/>  218:                      [global,{return,list}]),
<a name="219"/>  219:     Typer = typer(),
<a name="220"/>  220:     {BatchFile,
<a name="221"/>  221:      Run,
<a name="222"/>  222:      [&quot;@echo off\r\n&quot;,
<a name="223"/>  223:       &quot;\&quot;&quot;,Typer,&quot;\&quot; &quot;,Args, &quot;\r\n&quot;,
<a name="224"/>  224:       &quot;if errorlevel 1 echo _ERROR_\r\n&quot;,
<a name="225"/>  225:       &quot;if not errorlevel 1 echo _OK_\r\n&quot;]};
<a name="226"/>  226: <b>run_command</b>(Dir, {unix, _}, Args) -&gt;
<a name="227"/>  227:     TyperDir = filename:dirname(typer()),
<a name="228"/>  228:     Name = filename:join(Dir, &quot;run&quot;),
<a name="229"/>  229:     {Name,
<a name="230"/>  230:      &quot;/bin/sh &quot; ++ Name,
<a name="231"/>  231:      [&quot;#!/bin/sh\n&quot;,
<a name="232"/>  232:       &quot;PATH=\&quot;&quot;,TyperDir,&quot;:$PATH\&quot;\n&quot;,
<a name="233"/>  233:       &quot;typer &quot;,Args,&quot;\n&quot;,
<a name="234"/>  234:       &quot;case $? in\n&quot;,
<a name="235"/>  235:       &quot;  0) echo '_OK_';;\n&quot;,
<a name="236"/>  236:       &quot;  *) echo '_ERROR_';;\n&quot;,
<a name="237"/>  237:       &quot;esac\n&quot;]};
<a name="238"/>  238: <b>run_command</b>(_Dir, Other, _Args) -&gt;
<a name="run_command-last_expr"/><a name="239"/>  239: <b>    ct:fail</b>(&quot;Don't know how to test exit code for ~p&quot;, [Other]).
</pre>
</body>
</html>
