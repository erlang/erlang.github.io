<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/kernel/make_test_dir/kernel_test/socket_api_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2024-2024. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%% There are some environment variables that can be used to &quot;manipulate&quot;</i>
<a name="22"/>   22: <i>%% the test suite: </i>
<a name="23"/>   23: <i>%%</i>
<a name="24"/>   24: <i>%% Variable that controls which 'groups' are to run (with default values)</i>
<a name="25"/>   25: <i>%%</i>
<a name="26"/>   26: <i>%%         ESOCK_TEST_API_MISC     include</i>
<a name="27"/>   27: <i>%%         ESOCK_TEST_API_BASIC    include</i>
<a name="28"/>   28: <i>%%         ESOCK_TEST_API_SENDFILE include</i>
<a name="29"/>   29: <i>%%         ESOCK_TEST_API_FROM_FD  include</i>
<a name="30"/>   30: <i>%%         ESOCK_TEST_API_OPTS     include</i>
<a name="31"/>   31: <i>%%         ESOCK_TEST_API_OPWTO    include</i>
<a name="32"/>   32: <i>%%</i>
<a name="33"/>   33: <i>%% Variable that controls &quot;verbosity&quot; of the test case(s):</i>
<a name="34"/>   34: <i>%%</i>
<a name="35"/>   35: <i>%%         ESOCK_TEST_QUIET: true (default) | false</i>
<a name="36"/>   36: <i>%%</i>
<a name="37"/>   37: 
<a name="38"/>   38: <i>%% Run the entire test suite: </i>
<a name="39"/>   39: <i>%% ts:run(kernel, socket_SUITE, [batch]).</i>
<a name="40"/>   40: <i>%%</i>
<a name="41"/>   41: <i>%% Run a specific group:</i>
<a name="42"/>   42: <i>%% ts:run(kernel, socket_SUITE, {group, foo}, [batch]).</i>
<a name="43"/>   43: <i>%%</i>
<a name="44"/>   44: <i>%% Run a specific test case:</i>
<a name="45"/>   45: <i>%% ts:run(kernel, socket_SUITE, foo, [batch]).</i>
<a name="46"/>   46: <i>%%</i>
<a name="47"/>   47: <i>%% (cd /mnt/c/$LOCAL_TESTS/26/kernel_test/ &amp;&amp; $ERL_TOP/bin/win32/erl.exe -sname kernel-26-tester -pa c:$LOCAL_TESTS/26/test_server)</i>
<a name="48"/>   48: <i>%% application:set_env(kernel, test_inet_backends, true).</i>
<a name="49"/>   49: <i>%% S = fun() -&gt; ts:run(kernel, socket_SUITE, [batch]) end.</i>
<a name="50"/>   50: <i>%% S = fun(SUITE) -&gt; ts:run(kernel, SUITE, [batch]) end.</i>
<a name="51"/>   51: <i>%% S = fun() -&gt; ct:run_test([{suite, socket_SUITE}]) end.</i>
<a name="52"/>   52: <i>%% S = fun(SUITE) -&gt; ct:run_test([{suite, SUITE}]) end.</i>
<a name="53"/>   53: <i>%% G = fun(GROUP) -&gt; ts:run(kernel, socket_SUITE, {group, GROUP}, [batch]) end.</i>
<a name="54"/>   54: <i>%% G = fun(SUITE, GROUP) -&gt; ts:run(kernel, SUITE, {group, GROUP}, [batch]) end.</i>
<a name="55"/>   55: <i>%% G = fun(GROUP) -&gt; ct:run_test([{suite, socket_SUITE}, {group, GROUP}]) end.</i>
<a name="56"/>   56: <i>%% G = fun(SUITE, GROUP) -&gt; ct:run_test([{suite, SUITE}, {group, GROUP}]) end.</i>
<a name="57"/>   57: <i>%% T = fun(TC) -&gt; ts:run(kernel, socket_SUITE, TC, [batch]) end.</i>
<a name="58"/>   58: <i>%% T = fun(TC) -&gt; ct:run_test([{suite, socket_SUITE}, {testcase, TC}]) end.</i>
<a name="59"/>   59: <i>%% T = fun(S, TC) -&gt; ct:run_test([{suite, S}, {testcase, TC}]) end.</i>
<a name="60"/>   60: <i>%% T = fun(S, G, TC) -&gt; ct:run_test([{suite, S}, {group, G}, {testcase, TC}]) end.</i>
<a name="61"/>   61: <i>%%</i>
<a name="62"/>   62: <i>%% Some official info about AF_UNIX</i>
<a name="63"/>   63: <i>%% https://devblogs.microsoft.com/commandline/windowswsl-interop-with-af_unix/</i>
<a name="64"/>   64: 
<a name="65"/>   65: 
<a name="66"/>   66: 
<a name="67"/>   67: <b>-module</b>(socket_api_SUITE).
<a name="68"/>   68: 
<a name="69"/>   69: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="70"/>   70: <b>-include_lib</b>(&quot;common_test/include/ct_event.hrl&quot;).
<a name="71"/>   71: <b>-include</b>(&quot;socket_test_evaluator.hrl&quot;).
<a name="72"/>   72: <b>-include</b>(&quot;kernel_test_lib.hrl&quot;).
<a name="73"/>   73: 
<a name="74"/>   74: <i>%% Suite exports</i>
<a name="75"/>   75: <b>-export</b>([suite/0, all/0, groups/0]).
<a name="76"/>   76: <b>-export</b>([init_per_suite/1,    end_per_suite/1,
<a name="77"/>   77:          init_per_group/2,    end_per_group/2,
<a name="78"/>   78:          init_per_testcase/2, end_per_testcase/2]).
<a name="79"/>   79: 
<a name="80"/>   80: <i>%% Test cases</i>
<a name="81"/>   81: <b>-export</b>([
<a name="82"/>   82:          %% *** API Misc ***
<a name="83"/>   83:          api_m_info/1,
<a name="84"/>   84:          api_m_debug/1,
<a name="85"/>   85:          api_m_error_open/1,
<a name="86"/>   86:          api_m_error_bind/1,
<a name="87"/>   87: 
<a name="88"/>   88:          %% *** API Basic ***
<a name="89"/>   89:          api_b_simple_open_and_close_udp4/1,
<a name="90"/>   90:          api_b_simple_open_and_close_udp6/1,
<a name="91"/>   91:          api_b_simple_open_and_close_tcp4/1,
<a name="92"/>   92:          api_b_simple_open_and_close_tcp6/1,
<a name="93"/>   93:          api_b_open_and_info_udp4/1,
<a name="94"/>   94:          api_b_open_and_info_udp6/1,
<a name="95"/>   95:          api_b_open_and_info_tcp4/1,
<a name="96"/>   96:          api_b_open_and_info_tcp6/1,
<a name="97"/>   97:          api_b_open_and_close_udp4/1,
<a name="98"/>   98:          api_b_open_and_close_udp6/1,
<a name="99"/>   99:          api_b_open_and_close_tcp4/1,
<a name="100"/>  100:          api_b_open_and_close_tcp6/1,
<a name="101"/>  101:          api_b_open_and_close_udpL/1,
<a name="102"/>  102:          api_b_open_and_close_tcpL/1,
<a name="103"/>  103:          api_b_open_and_close_seqpL/1,
<a name="104"/>  104: 	 api_b_open_and_close_seqp_sctp4/1,
<a name="105"/>  105: 	 api_b_open_and_close_seqp_sctp6/1,
<a name="106"/>  106: 	 api_b_open_and_close_stream_sctp4/1,
<a name="107"/>  107: 	 api_b_open_and_close_stream_sctp6/1,
<a name="108"/>  108:          api_b_open_and_maybe_close_raw/1,
<a name="109"/>  109:          api_b_sendto_and_recvfrom_udp4/1,
<a name="110"/>  110:          api_b_sendto_and_recvfrom_udpL/1,
<a name="111"/>  111:          api_b_sendmsg_and_recvmsg_udp4/1,
<a name="112"/>  112:          api_b_sendmsg_and_recvmsg_udpL/1,
<a name="113"/>  113:          api_b_send_and_recv_tcp4/1,
<a name="114"/>  114:          api_b_send_and_recv_stream_sctp4/1,
<a name="115"/>  115:          api_b_sendv_and_recv_tcp4/1,
<a name="116"/>  116:          api_b_send_and_recv_tcpL/1,
<a name="117"/>  117:          api_b_send_and_recv_seqpL/1,
<a name="118"/>  118:          api_b_sendmsg_and_recvmsg_tcp4/1,
<a name="119"/>  119:          api_b_sendmsg_and_recvmsg_tcpL/1,
<a name="120"/>  120:          api_b_sendmsg_and_recvmsg_seqpL/1,
<a name="121"/>  121:          api_b_sendmsg_and_recvmsg_stream_sctp4/1,
<a name="122"/>  122:          api_b_sendmsg_iov_dgram_inet/1,
<a name="123"/>  123:          api_b_sendmsg_iov_dgram_inet6/1,
<a name="124"/>  124:          api_b_sendmsg_iov_dgram_local/1,
<a name="125"/>  125:          api_b_sendmsg_iov_stream_inet/1,
<a name="126"/>  126:          api_b_sendmsg_iov_stream_inet6/1,
<a name="127"/>  127:          api_b_sendmsg_iov_stream_local/1,
<a name="128"/>  128:          api_b_dgram_connect_udp4/1,
<a name="129"/>  129:          api_b_dgram_connect_udp6/1,
<a name="130"/>  130:          api_b_sendv_tcp4/1,
<a name="131"/>  131:          api_b_sendv_tcp6/1,
<a name="132"/>  132: 
<a name="133"/>  133:          %% *** API sendfile ***
<a name="134"/>  134:          api_sendfile_inet/1,
<a name="135"/>  135:          api_sendfile_inet6/1,
<a name="136"/>  136:          api_sendfile_local/1,
<a name="137"/>  137:          api_sendfile_loop_inet/1,
<a name="138"/>  138:          api_sendfile_loop_inet6/1,
<a name="139"/>  139:          api_sendfile_loop_local/1,
<a name="140"/>  140: 
<a name="141"/>  141:          %% *** API socket from FD ***
<a name="142"/>  142:          api_ffd_open_wod_and_info_udp4/1,
<a name="143"/>  143:          api_ffd_open_wod_and_info_udp6/1,
<a name="144"/>  144:          api_ffd_open_wod_and_info_tcp4/1,
<a name="145"/>  145:          api_ffd_open_wod_and_info_tcp6/1,
<a name="146"/>  146:          api_ffd_open_wd_and_info_udp4/1,
<a name="147"/>  147:          api_ffd_open_wd_and_info_udp6/1,
<a name="148"/>  148:          api_ffd_open_wd_and_info_tcp4/1,
<a name="149"/>  149:          api_ffd_open_wd_and_info_tcp6/1,
<a name="150"/>  150:          api_ffd_open_and_open_wod_and_send_udp4/1,
<a name="151"/>  151:          api_ffd_open_and_open_wod_and_send_udp6/1,
<a name="152"/>  152:          api_ffd_open_and_open_wd_and_send_udp4/1,
<a name="153"/>  153:          api_ffd_open_and_open_wd_and_send_udp6/1,
<a name="154"/>  154:          api_ffd_open_connect_and_open_wod_and_send_tcp4/1,
<a name="155"/>  155:          api_ffd_open_connect_and_open_wod_and_send_tcp6/1,
<a name="156"/>  156:          api_ffd_open_connect_and_open_wd_and_send_tcp4/1,
<a name="157"/>  157:          api_ffd_open_connect_and_open_wd_and_send_tcp6/1,
<a name="158"/>  158: 
<a name="159"/>  159: 
<a name="160"/>  160:          %% *** API async ***
<a name="161"/>  161:          api_a_connect_tcp4/1,
<a name="162"/>  162:          api_a_connect_tcp6/1,
<a name="163"/>  163:          api_a_sendto_and_recvfrom_udp4/1,
<a name="164"/>  164:          api_a_sendto_and_recvfrom_udp6/1,
<a name="165"/>  165:          api_a_sendmsg_and_recvmsg_udp4/1,
<a name="166"/>  166:          api_a_sendmsg_and_recvmsg_udp6/1,
<a name="167"/>  167:          api_a_send_and_recv_tcp4/1,
<a name="168"/>  168:          api_a_send_and_recv_tcp6/1,
<a name="169"/>  169:          api_a_send_and_recv_sctp4/1,
<a name="170"/>  170:          api_a_send_and_recv_sctp6/1,
<a name="171"/>  171:          api_a_sendmsg_and_recvmsg_tcp4/1,
<a name="172"/>  172:          api_a_sendmsg_and_recvmsg_tcp6/1,
<a name="173"/>  173:          api_a_recvfrom_cancel_udp4/1,
<a name="174"/>  174:          api_a_recvfrom_cancel_udp6/1,
<a name="175"/>  175:          api_a_recvmsg_cancel_udp4/1,
<a name="176"/>  176:          api_a_recvmsg_cancel_udp6/1,
<a name="177"/>  177:          api_a_accept_cancel_tcp4/1,
<a name="178"/>  178:          api_a_accept_cancel_tcp6/1,
<a name="179"/>  179:          api_a_recv_cancel_tcp4/1,
<a name="180"/>  180:          api_a_recv_cancel_tcp6/1,
<a name="181"/>  181:          api_a_recvmsg_cancel_tcp4/1,
<a name="182"/>  182:          api_a_recvmsg_cancel_tcp6/1,
<a name="183"/>  183:          api_a_mrecvfrom_cancel_udp4/1,
<a name="184"/>  184:          api_a_mrecvfrom_cancel_udp6/1,
<a name="185"/>  185:          api_a_mrecvmsg_cancel_udp4/1,
<a name="186"/>  186:          api_a_mrecvmsg_cancel_udp6/1,
<a name="187"/>  187:          api_a_maccept_cancel_tcp4/1,
<a name="188"/>  188:          api_a_maccept_cancel_tcp6/1,
<a name="189"/>  189:          api_a_mrecv_cancel_tcp4/1,
<a name="190"/>  190:          api_a_mrecv_cancel_tcp6/1,
<a name="191"/>  191:          api_a_mrecvmsg_cancel_tcp4/1,
<a name="192"/>  192:          api_a_mrecvmsg_cancel_tcp6/1,
<a name="193"/>  193: 
<a name="194"/>  194: 
<a name="195"/>  195:          %% *** API Options ***
<a name="196"/>  196:          api_opt_simple_otp_options/1,
<a name="197"/>  197:          api_opt_simple_otp_meta_option/1,
<a name="198"/>  198:          api_opt_simple_otp_rcvbuf_option/1,
<a name="199"/>  199:          api_opt_simple_otp_controlling_process/1,
<a name="200"/>  200:          api_opt_sock_acceptconn_udp/1,
<a name="201"/>  201:          api_opt_sock_acceptconn_tcp/1,
<a name="202"/>  202:          api_opt_sock_acceptfilter/1,
<a name="203"/>  203:          api_opt_sock_bindtodevice/1,
<a name="204"/>  204:          api_opt_sock_broadcast/1,
<a name="205"/>  205:          api_opt_sock_debug/1,
<a name="206"/>  206:          api_opt_sock_domain/1,
<a name="207"/>  207:          api_opt_sock_dontroute/1,
<a name="208"/>  208:          api_opt_sock_error/1,
<a name="209"/>  209:          api_opt_sock_keepalive/1,
<a name="210"/>  210:          api_opt_sock_linger/1,
<a name="211"/>  211:          api_opt_sock_mark/1,
<a name="212"/>  212:          api_opt_sock_maxdg/1,
<a name="213"/>  213:          api_opt_sock_max_msg_size/1,
<a name="214"/>  214:          api_opt_sock_oobinline/1,
<a name="215"/>  215:          api_opt_sock_passcred_tcp4/1,
<a name="216"/>  216:          api_opt_sock_peek_off_tcpL/1,
<a name="217"/>  217:          api_opt_sock_peercred_tcpL/1,
<a name="218"/>  218:          api_opt_sock_priority_udp4/1,
<a name="219"/>  219:          api_opt_sock_priority_tcp4/1,
<a name="220"/>  220:          api_opt_sock_rcvbuf_udp4/1,
<a name="221"/>  221:          api_opt_sock_rcvlowat_udp4/1,
<a name="222"/>  222:          api_opt_sock_rcvtimeo_udp4/1,
<a name="223"/>  223:          api_opt_sock_reuseaddr/1,
<a name="224"/>  224:          api_opt_sock_exclusiveaddruse/1,
<a name="225"/>  225:          api_opt_sock_bsp_state/1,
<a name="226"/>  226:          api_opt_sock_sndbuf_udp4/1,
<a name="227"/>  227:          api_opt_sock_sndlowat_udp4/1,
<a name="228"/>  228:          api_opt_sock_sndtimeo_udp4/1,
<a name="229"/>  229:          api_opt_sock_timestamp_udp4/1,
<a name="230"/>  230:          api_opt_sock_timestamp_tcp4/1,
<a name="231"/>  231:          api_opt_ip_add_drop_membership/0, api_opt_ip_add_drop_membership/1,
<a name="232"/>  232:          api_opt_ip_pktinfo_udp4/1,
<a name="233"/>  233:          api_opt_ip_recvopts_udp4/1,
<a name="234"/>  234:          api_opt_ip_recvorigdstaddr_udp4/1,
<a name="235"/>  235:          api_opt_ip_recvtos_udp4/1,
<a name="236"/>  236:          api_opt_ip_recvttl_udp4/1,
<a name="237"/>  237:          api_opt_ip_tos_udp4/1,
<a name="238"/>  238:          api_opt_ip_recverr_udp4/1,
<a name="239"/>  239:          api_opt_ip_mopts_udp4/1,
<a name="240"/>  240:          api_opt_ipv6_recvpktinfo_udp6/1,
<a name="241"/>  241: 	 api_opt_ipv6_flowinfo_udp6/1,
<a name="242"/>  242: 	 api_opt_ipv6_hoplimit_udp6/1,
<a name="243"/>  243: 	 api_opt_ipv6_tclass_udp6/1,
<a name="244"/>  244:          api_opt_ipv6_recverr_udp6/1,
<a name="245"/>  245: 	 api_opt_ipv6_mopts_udp6/1,
<a name="246"/>  246:          api_opt_tcp_congestion_tcp4/1,
<a name="247"/>  247:          api_opt_tcp_cork_tcp4/1,
<a name="248"/>  248:          api_opt_tcp_maxseg_tcp4/1,
<a name="249"/>  249:          api_opt_tcp_nodelay_tcp4/1,
<a name="250"/>  250:          api_opt_tcp_keepcnt_tcp4/1,
<a name="251"/>  251:          api_opt_tcp_keepidle_tcp4/1,
<a name="252"/>  252:          api_opt_tcp_keepintvl_tcp4/1,
<a name="253"/>  253:          api_opt_udp_cork_udp4/1,
<a name="254"/>  254: 
<a name="255"/>  255:          %% *** API Operation Timeout ***
<a name="256"/>  256:          api_to_connect_tcp4/1,
<a name="257"/>  257:          api_to_connect_tcp6/1,
<a name="258"/>  258:          api_to_accept_tcp4/1,
<a name="259"/>  259:          api_to_accept_tcp6/1,
<a name="260"/>  260:          api_to_maccept_tcp4/1,
<a name="261"/>  261:          api_to_maccept_tcp6/1,
<a name="262"/>  262:          api_to_send_tcp4/1,
<a name="263"/>  263:          api_to_send_tcp6/1,
<a name="264"/>  264:          api_to_sendto_udp4/1,
<a name="265"/>  265:          api_to_sendto_udp6/1,
<a name="266"/>  266:          api_to_sendmsg_tcp4/1,
<a name="267"/>  267:          api_to_sendmsg_tcp6/1,
<a name="268"/>  268:          api_to_recv_udp4/1,
<a name="269"/>  269:          api_to_recv_udp6/1,
<a name="270"/>  270:          api_to_recv_tcp4/1,
<a name="271"/>  271:          api_to_recv_tcp6/1,
<a name="272"/>  272:          api_to_recvfrom_udp4/1,
<a name="273"/>  273:          api_to_recvfrom_udp6/1,
<a name="274"/>  274:          api_to_recvmsg_udp4/1,
<a name="275"/>  275:          api_to_recvmsg_udp6/1,
<a name="276"/>  276:          api_to_recvmsg_tcp4/1,
<a name="277"/>  277:          api_to_recvmsg_tcp6/1
<a name="278"/>  278:         ]).
<a name="279"/>  279: 
<a name="280"/>  280: 
<a name="281"/>  281: 
<a name="282"/>  282: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="283"/>  283: 
<a name="284"/>  284: <b>-define</b>(SLIB,       socket_test_lib).
<a name="285"/>  285: <b>-define</b>(KLIB,       kernel_test_lib).
<a name="286"/>  286: <b>-define</b>(LOGGER,     socket_test_logger).
<a name="287"/>  287: 
<a name="288"/>  288: <b>-define</b>(BASIC_REQ,  &lt;&lt;&quot;hejsan&quot;&gt;&gt;).
<a name="289"/>  289: <b>-define</b>(BASIC_REP,  &lt;&lt;&quot;hoppsan&quot;&gt;&gt;).
<a name="290"/>  290: 
<a name="291"/>  291: <i>%% -define(DATA,       &lt;&lt;&quot;HOPPSAN&quot;&gt;&gt;). % Temporary</i>
<a name="292"/>  292: <b>-define</b>(FAIL(R),    exit(R)).
<a name="293"/>  293: 
<a name="294"/>  294: <i>%% -define(SLEEP(T),   receive after T -&gt; ok end).</i>
<a name="295"/>  295: 
<a name="296"/>  296: <i>%% -define(MINS(M),    timer:minutes(M)).</i>
<a name="297"/>  297: <i>%% -define(SECS(S),    timer:seconds(S)).</i>
<a name="298"/>  298: 
<a name="299"/>  299: <i>%% -define(TT(T),      ct:timetrap(T)).</i>
<a name="300"/>  300: 
<a name="301"/>  301: <i>%% -define(F(F, A),    ?SLIB:f(F, A)).</i>
<a name="302"/>  302: <i>%% -define(P(F),       ?SLIB:print(F)).</i>
<a name="303"/>  303: <i>%% -define(P(F, A),    ?SLIB:print(F, A)).</i>
<a name="304"/>  304: 
<a name="305"/>  305: <i>%% -define(WINDOWS, {win32,nt}).</i>
<a name="306"/>  306: 
<a name="307"/>  307: <i>%% -define(START_NODE(NamePre),</i>
<a name="308"/>  308: <i>%%         ?START_NODE(NamePre, 5000)).</i>
<a name="309"/>  309: <i>%% -define(START_NODE(NamePre, Timeout),</i>
<a name="310"/>  310: <i>%%         start_node(?CT_PEER_NAME(NamePre), Timeout)).</i>
<a name="311"/>  311: 
<a name="312"/>  312: 
<a name="313"/>  313: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="314"/>  314: 
<a name="suite-0"/><a name="315"/>  315: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="316"/>  316:     [{ct_hooks, [ts_install_cth]},
<a name="317"/>  317:      {timetrap, {minutes,1}}].
<a name="318"/>  318: 
<a name="all-0"/><a name="319"/>  319: <b>all</b>() -&gt; 
<a name="320"/>  320:     Groups = [
<a name="321"/>  321:               {misc,                   &quot;ESOCK_TEST_API_MISC&quot;,     include},
<a name="322"/>  322:               {basic,                  &quot;ESOCK_TEST_API_BASIC&quot;,    include},
<a name="323"/>  323:               {sendfile,               &quot;ESOCK_TEST_API_SENDFILE&quot;, include},
<a name="324"/>  324:               {from_fd,                &quot;ESOCK_TEST_API_FROM_FD&quot;,  include},
<a name="325"/>  325:               {options,                &quot;ESOCK_TEST_API_OPTS&quot;,     include},
<a name="326"/>  326:               {operation_with_timeout, &quot;ESOCK_TEST_API_OPWTO&quot;,    include}
<a name="327"/>  327:              ],
<a name="all-last_expr"/><a name="328"/>  328: <b>    [use_group</b>(Group, Env, Default) || {Group, Env, Default} &lt;- Groups].
<a name="329"/>  329: 
<a name="use_group-3"/><a name="330"/>  330: <b>use_group</b>(_Group, undefined, exclude) -&gt;
<a name="331"/>  331:     [];
<a name="332"/>  332: <b>use_group</b>(Group, undefined, _Default) -&gt;
<a name="333"/>  333:     [{group, Group}];
<a name="334"/>  334: <b>use_group</b>(Group, Env, Default) -&gt;
<a name="use_group-last_expr"/><a name="335"/>  335: <b>	case os:getenv</b>(Env) of
<a name="336"/>  336: 	    false when (Default =:= include) -&gt;
<a name="337"/>  337: 		[{group, Group}];
<a name="338"/>  338: 	    false -&gt;
<a name="339"/>  339: 		[];
<a name="340"/>  340: 	    Val -&gt;
<a name="341"/>  341: 		case list_to_atom(string:to_lower(Val)) of
<a name="342"/>  342: 		    Use when (Use =:= include) orelse 
<a name="343"/>  343: 			     (Use =:= enable) orelse 
<a name="344"/>  344: 			     (Use =:= true) -&gt;
<a name="345"/>  345: 			[{group, Group}];
<a name="346"/>  346: 		    _ -&gt;
<a name="347"/>  347: 			[]
<a name="348"/>  348: 		end
<a name="349"/>  349: 	end.
<a name="350"/>  350:     
<a name="351"/>  351: 
<a name="groups-0"/><a name="352"/>  352: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="353"/>  353: <b>    [{misc,                    [], api_misc_cases</b>()},
<a name="354"/>  354:      {basic,                   [], api_basic_cases()},
<a name="355"/>  355:      {sendfile,                [], api_sendfile_cases()},
<a name="356"/>  356:      {from_fd,                 [], api_from_fd_cases()},
<a name="357"/>  357:      {async,                   [], api_async_cases()},
<a name="358"/>  358:      {async_ref,               [], api_async_cases()},
<a name="359"/>  359:      {options,                 [], api_options_cases()},
<a name="360"/>  360:      {options_otp,             [], api_options_otp_cases()},
<a name="361"/>  361:      {options_socket,          [], api_options_socket_cases()},
<a name="362"/>  362:      {option_sock_acceptconn,  [], api_option_sock_acceptconn_cases()},
<a name="363"/>  363:      {option_sock_passcred,    [], api_option_sock_passcred_cases()},
<a name="364"/>  364:      {option_sock_priority,    [], api_option_sock_priority_cases()},
<a name="365"/>  365:      {option_sock_buf,         [], api_option_sock_buf_cases()},
<a name="366"/>  366:      {option_sock_lowat,       [], api_option_sock_lowat_cases()},
<a name="367"/>  367:      {option_sock_timeo,       [], api_option_sock_timeo_cases()},
<a name="368"/>  368:      {option_sock_timestamp,   [], api_option_sock_timestamp_cases()},
<a name="369"/>  369:      {options_ip,              [], api_options_ip_cases()},
<a name="370"/>  370:      {options_ipv6,            [], api_options_ipv6_cases()},
<a name="371"/>  371:      {options_tcp,             [], api_options_tcp_cases()},
<a name="372"/>  372:      {options_udp,             [], api_options_udp_cases()},
<a name="373"/>  373:      %% {options_sctp,            [], api_options_sctp_cases()},
<a name="374"/>  374:      {operation_with_timeout,  [], api_op_with_timeout_cases()}
<a name="375"/>  375:     ].
<a name="376"/>  376:      
<a name="api_misc_cases-0"/><a name="377"/>  377: <b>api_misc_cases</b>() -&gt;
<a name="api_misc_cases-last_expr"/><a name="378"/>  378:     [
<a name="379"/>  379:      api_m_info,
<a name="380"/>  380:      api_m_debug,
<a name="381"/>  381:      api_m_error_open,
<a name="382"/>  382:      api_m_error_bind
<a name="383"/>  383:     ].
<a name="384"/>  384: 
<a name="api_basic_cases-0"/><a name="385"/>  385: <b>api_basic_cases</b>() -&gt;
<a name="api_basic_cases-last_expr"/><a name="386"/>  386:     [
<a name="387"/>  387:      api_b_simple_open_and_close_udp4,
<a name="388"/>  388:      api_b_simple_open_and_close_udp6,
<a name="389"/>  389:      api_b_simple_open_and_close_tcp4,
<a name="390"/>  390:      api_b_simple_open_and_close_tcp6,
<a name="391"/>  391:      api_b_open_and_info_udp4,
<a name="392"/>  392:      api_b_open_and_info_udp6,
<a name="393"/>  393:      api_b_open_and_info_tcp4,
<a name="394"/>  394:      api_b_open_and_info_tcp6,
<a name="395"/>  395:      api_b_open_and_close_udp4,
<a name="396"/>  396:      api_b_open_and_close_udp6,
<a name="397"/>  397:      api_b_open_and_close_tcp4,
<a name="398"/>  398:      api_b_open_and_close_tcp6,
<a name="399"/>  399:      api_b_open_and_close_udpL,
<a name="400"/>  400:      api_b_open_and_close_tcpL,
<a name="401"/>  401:      api_b_open_and_close_seqpL,
<a name="402"/>  402:      api_b_open_and_close_seqp_sctp4,
<a name="403"/>  403:      api_b_open_and_close_seqp_sctp6,
<a name="404"/>  404:      api_b_open_and_close_stream_sctp4,
<a name="405"/>  405:      api_b_open_and_close_stream_sctp6,
<a name="406"/>  406:      api_b_open_and_maybe_close_raw,
<a name="407"/>  407:      api_b_sendto_and_recvfrom_udp4,
<a name="408"/>  408:      api_b_sendto_and_recvfrom_udpL,
<a name="409"/>  409:      api_b_sendmsg_and_recvmsg_udp4,
<a name="410"/>  410:      api_b_sendmsg_and_recvmsg_udpL,
<a name="411"/>  411:      api_b_send_and_recv_tcp4,
<a name="412"/>  412:      api_b_send_and_recv_stream_sctp4,
<a name="413"/>  413:      api_b_sendv_and_recv_tcp4,
<a name="414"/>  414:      api_b_send_and_recv_tcpL,
<a name="415"/>  415:      api_b_send_and_recv_seqpL,
<a name="416"/>  416:      api_b_sendmsg_and_recvmsg_tcp4,
<a name="417"/>  417:      api_b_sendmsg_and_recvmsg_tcpL,
<a name="418"/>  418:      api_b_sendmsg_and_recvmsg_seqpL,
<a name="419"/>  419:      api_b_sendmsg_and_recvmsg_stream_sctp4,
<a name="420"/>  420:      api_b_sendmsg_iov_dgram_inet,
<a name="421"/>  421:      api_b_sendmsg_iov_dgram_inet6,
<a name="422"/>  422:      api_b_sendmsg_iov_dgram_local,
<a name="423"/>  423:      api_b_sendmsg_iov_stream_inet,
<a name="424"/>  424:      api_b_sendmsg_iov_stream_inet6,
<a name="425"/>  425:      api_b_sendmsg_iov_stream_local,
<a name="426"/>  426:      api_b_dgram_connect_udp4,
<a name="427"/>  427:      api_b_dgram_connect_udp6,
<a name="428"/>  428:      api_b_sendv_tcp4,
<a name="429"/>  429:      api_b_sendv_tcp6
<a name="430"/>  430:     ].
<a name="431"/>  431: 
<a name="api_sendfile_cases-0"/><a name="432"/>  432: <b>api_sendfile_cases</b>() -&gt;
<a name="api_sendfile_cases-last_expr"/><a name="433"/>  433:     [
<a name="434"/>  434:      api_sendfile_inet,
<a name="435"/>  435:      api_sendfile_inet6,
<a name="436"/>  436:      api_sendfile_local,
<a name="437"/>  437:      api_sendfile_loop_inet,
<a name="438"/>  438:      api_sendfile_loop_inet6,
<a name="439"/>  439:      api_sendfile_loop_local
<a name="440"/>  440:     ].
<a name="441"/>  441: 
<a name="api_from_fd_cases-0"/><a name="442"/>  442: <b>api_from_fd_cases</b>() -&gt;
<a name="api_from_fd_cases-last_expr"/><a name="443"/>  443:     [
<a name="444"/>  444:      api_ffd_open_wod_and_info_udp4,
<a name="445"/>  445:      api_ffd_open_wod_and_info_udp6,
<a name="446"/>  446:      api_ffd_open_wod_and_info_tcp4,
<a name="447"/>  447:      api_ffd_open_wod_and_info_tcp6,
<a name="448"/>  448:      api_ffd_open_wd_and_info_udp4,
<a name="449"/>  449:      api_ffd_open_wd_and_info_udp6,
<a name="450"/>  450:      api_ffd_open_wd_and_info_tcp4,
<a name="451"/>  451:      api_ffd_open_wd_and_info_tcp6,
<a name="452"/>  452:      api_ffd_open_and_open_wod_and_send_udp4,
<a name="453"/>  453:      api_ffd_open_and_open_wod_and_send_udp6,
<a name="454"/>  454:      api_ffd_open_and_open_wd_and_send_udp4,
<a name="455"/>  455:      api_ffd_open_and_open_wd_and_send_udp6,
<a name="456"/>  456:      api_ffd_open_connect_and_open_wod_and_send_tcp4,
<a name="457"/>  457:      api_ffd_open_connect_and_open_wod_and_send_tcp6,
<a name="458"/>  458:      api_ffd_open_connect_and_open_wd_and_send_tcp4,
<a name="459"/>  459:      api_ffd_open_connect_and_open_wd_and_send_tcp6
<a name="460"/>  460:     ].
<a name="461"/>  461: 
<a name="api_async_cases-0"/><a name="462"/>  462: <b>api_async_cases</b>() -&gt;
<a name="api_async_cases-last_expr"/><a name="463"/>  463:     [
<a name="464"/>  464:      api_a_connect_tcp4,
<a name="465"/>  465:      api_a_connect_tcp6,
<a name="466"/>  466:      api_a_sendto_and_recvfrom_udp4,
<a name="467"/>  467:      api_a_sendto_and_recvfrom_udp6,
<a name="468"/>  468:      api_a_sendmsg_and_recvmsg_udp4,
<a name="469"/>  469:      api_a_sendmsg_and_recvmsg_udp6,
<a name="470"/>  470:      api_a_send_and_recv_tcp4,
<a name="471"/>  471:      api_a_send_and_recv_tcp6,
<a name="472"/>  472:      api_a_send_and_recv_sctp4,
<a name="473"/>  473:      api_a_send_and_recv_sctp6,
<a name="474"/>  474:      api_a_sendmsg_and_recvmsg_tcp4,
<a name="475"/>  475:      api_a_sendmsg_and_recvmsg_tcp6,
<a name="476"/>  476:      api_a_recvfrom_cancel_udp4,
<a name="477"/>  477:      api_a_recvfrom_cancel_udp6,
<a name="478"/>  478:      api_a_recvmsg_cancel_udp4,
<a name="479"/>  479:      api_a_recvmsg_cancel_udp6,
<a name="480"/>  480:      api_a_accept_cancel_tcp4,
<a name="481"/>  481:      api_a_accept_cancel_tcp6,
<a name="482"/>  482:      api_a_recv_cancel_tcp4,
<a name="483"/>  483:      api_a_recv_cancel_tcp6,
<a name="484"/>  484:      api_a_recvmsg_cancel_tcp4,
<a name="485"/>  485:      api_a_recvmsg_cancel_tcp6,
<a name="486"/>  486:      api_a_mrecvfrom_cancel_udp4,
<a name="487"/>  487:      api_a_mrecvfrom_cancel_udp6,
<a name="488"/>  488:      api_a_mrecvmsg_cancel_udp4,
<a name="489"/>  489:      api_a_mrecvmsg_cancel_udp6,
<a name="490"/>  490:      api_a_maccept_cancel_tcp4,
<a name="491"/>  491:      api_a_maccept_cancel_tcp6,
<a name="492"/>  492:      api_a_mrecv_cancel_tcp4,
<a name="493"/>  493:      api_a_mrecv_cancel_tcp6,
<a name="494"/>  494:      api_a_mrecvmsg_cancel_tcp4,
<a name="495"/>  495:      api_a_mrecvmsg_cancel_tcp6
<a name="496"/>  496:     ].
<a name="497"/>  497: 
<a name="api_options_cases-0"/><a name="498"/>  498: <b>api_options_cases</b>() -&gt;
<a name="api_options_cases-last_expr"/><a name="499"/>  499:     [
<a name="500"/>  500:      {group, options_otp},
<a name="501"/>  501:      {group, options_socket},
<a name="502"/>  502:      {group, options_ip},
<a name="503"/>  503:      {group, options_ipv6},
<a name="504"/>  504:      {group, options_tcp},
<a name="505"/>  505:      {group, options_udp}
<a name="506"/>  506:      %% {group, options_sctp}
<a name="507"/>  507:     ].
<a name="508"/>  508: 
<a name="api_options_otp_cases-0"/><a name="509"/>  509: <b>api_options_otp_cases</b>() -&gt;
<a name="api_options_otp_cases-last_expr"/><a name="510"/>  510:     [
<a name="511"/>  511:      api_opt_simple_otp_options,
<a name="512"/>  512:      api_opt_simple_otp_meta_option,
<a name="513"/>  513:      api_opt_simple_otp_rcvbuf_option,
<a name="514"/>  514:      api_opt_simple_otp_controlling_process
<a name="515"/>  515:     ].
<a name="516"/>  516: 
<a name="api_options_socket_cases-0"/><a name="517"/>  517: <b>api_options_socket_cases</b>() -&gt;
<a name="api_options_socket_cases-last_expr"/><a name="518"/>  518:     [
<a name="519"/>  519:      {group, option_sock_acceptconn},
<a name="520"/>  520:      api_opt_sock_acceptfilter,
<a name="521"/>  521:      api_opt_sock_bindtodevice,
<a name="522"/>  522:      api_opt_sock_broadcast,
<a name="523"/>  523:      api_opt_sock_debug,
<a name="524"/>  524:      api_opt_sock_domain,
<a name="525"/>  525:      api_opt_sock_dontroute,
<a name="526"/>  526:      api_opt_sock_error,
<a name="527"/>  527:      api_opt_sock_keepalive,
<a name="528"/>  528:      api_opt_sock_linger,
<a name="529"/>  529:      api_opt_sock_mark,
<a name="530"/>  530:      api_opt_sock_maxdg,
<a name="531"/>  531:      api_opt_sock_max_msg_size,
<a name="532"/>  532:      api_opt_sock_oobinline,
<a name="533"/>  533:      {group, option_sock_passcred},
<a name="534"/>  534:      api_opt_sock_peek_off_tcpL,
<a name="535"/>  535:      api_opt_sock_peercred_tcpL,
<a name="536"/>  536:      {group, option_sock_priority},
<a name="537"/>  537:      {group, option_sock_buf},
<a name="538"/>  538:      {group, option_sock_lowat},
<a name="539"/>  539:      {group, option_sock_timeo},
<a name="540"/>  540:      {group, option_sock_timestamp},
<a name="541"/>  541:      api_opt_sock_reuseaddr,
<a name="542"/>  542:      api_opt_sock_exclusiveaddruse,
<a name="543"/>  543:      api_opt_sock_bsp_state
<a name="544"/>  544: 
<a name="545"/>  545:     ].
<a name="546"/>  546: 
<a name="api_option_sock_acceptconn_cases-0"/><a name="547"/>  547: <b>api_option_sock_acceptconn_cases</b>() -&gt;
<a name="api_option_sock_acceptconn_cases-last_expr"/><a name="548"/>  548:     [
<a name="549"/>  549:      api_opt_sock_acceptconn_udp,
<a name="550"/>  550:      api_opt_sock_acceptconn_tcp
<a name="551"/>  551:     ].
<a name="552"/>  552: 
<a name="api_option_sock_passcred_cases-0"/><a name="553"/>  553: <b>api_option_sock_passcred_cases</b>() -&gt;
<a name="api_option_sock_passcred_cases-last_expr"/><a name="554"/>  554:     [
<a name="555"/>  555:      %% api_opt_sock_passcred_udp4,
<a name="556"/>  556:      api_opt_sock_passcred_tcp4
<a name="557"/>  557:     ].
<a name="558"/>  558: 
<a name="api_option_sock_priority_cases-0"/><a name="559"/>  559: <b>api_option_sock_priority_cases</b>() -&gt;
<a name="api_option_sock_priority_cases-last_expr"/><a name="560"/>  560:     [
<a name="561"/>  561:      api_opt_sock_priority_udp4,
<a name="562"/>  562:      api_opt_sock_priority_tcp4%,
<a name="563"/>  563:      %% api_opt_sock_priority_udp6,
<a name="564"/>  564:      %% api_opt_sock_priority_tcp6
<a name="565"/>  565:     ].
<a name="566"/>  566: 
<a name="api_option_sock_buf_cases-0"/><a name="567"/>  567: <b>api_option_sock_buf_cases</b>() -&gt;
<a name="api_option_sock_buf_cases-last_expr"/><a name="568"/>  568:     [
<a name="569"/>  569:      api_opt_sock_rcvbuf_udp4,
<a name="570"/>  570:      api_opt_sock_sndbuf_udp4
<a name="571"/>  571:     ].
<a name="572"/>  572: 
<a name="api_option_sock_lowat_cases-0"/><a name="573"/>  573: <b>api_option_sock_lowat_cases</b>() -&gt;
<a name="api_option_sock_lowat_cases-last_expr"/><a name="574"/>  574:     [
<a name="575"/>  575:      api_opt_sock_rcvlowat_udp4,
<a name="576"/>  576:      api_opt_sock_sndlowat_udp4
<a name="577"/>  577:     ].
<a name="578"/>  578: 
<a name="api_option_sock_timeo_cases-0"/><a name="579"/>  579: <b>api_option_sock_timeo_cases</b>() -&gt;
<a name="api_option_sock_timeo_cases-last_expr"/><a name="580"/>  580:     [
<a name="581"/>  581:      api_opt_sock_rcvtimeo_udp4,
<a name="582"/>  582:      api_opt_sock_sndtimeo_udp4
<a name="583"/>  583:     ].
<a name="584"/>  584: 
<a name="api_option_sock_timestamp_cases-0"/><a name="585"/>  585: <b>api_option_sock_timestamp_cases</b>() -&gt;
<a name="api_option_sock_timestamp_cases-last_expr"/><a name="586"/>  586:     [
<a name="587"/>  587:      api_opt_sock_timestamp_udp4,
<a name="588"/>  588:      api_opt_sock_timestamp_tcp4
<a name="589"/>  589:     ].
<a name="590"/>  590: 
<a name="api_options_ip_cases-0"/><a name="591"/>  591: <b>api_options_ip_cases</b>() -&gt;
<a name="api_options_ip_cases-last_expr"/><a name="592"/>  592:     [
<a name="593"/>  593:      api_opt_ip_add_drop_membership,
<a name="594"/>  594:      api_opt_ip_pktinfo_udp4,
<a name="595"/>  595:      api_opt_ip_recvopts_udp4,
<a name="596"/>  596:      api_opt_ip_recvorigdstaddr_udp4,
<a name="597"/>  597:      api_opt_ip_recvtos_udp4,
<a name="598"/>  598:      api_opt_ip_recvttl_udp4,
<a name="599"/>  599:      api_opt_ip_tos_udp4,
<a name="600"/>  600:      api_opt_ip_recverr_udp4,
<a name="601"/>  601: 
<a name="602"/>  602:      %% Should be last!
<a name="603"/>  603:      api_opt_ip_mopts_udp4
<a name="604"/>  604:     ].
<a name="605"/>  605: 
<a name="api_options_ipv6_cases-0"/><a name="606"/>  606: <b>api_options_ipv6_cases</b>() -&gt;
<a name="api_options_ipv6_cases-last_expr"/><a name="607"/>  607:     [
<a name="608"/>  608:      api_opt_ipv6_recvpktinfo_udp6,
<a name="609"/>  609:      api_opt_ipv6_flowinfo_udp6,
<a name="610"/>  610:      api_opt_ipv6_hoplimit_udp6,
<a name="611"/>  611:      api_opt_ipv6_tclass_udp6,
<a name="612"/>  612:      api_opt_ipv6_recverr_udp6,
<a name="613"/>  613: 
<a name="614"/>  614:      %% Should be last!
<a name="615"/>  615:      api_opt_ipv6_mopts_udp6
<a name="616"/>  616:     ].
<a name="617"/>  617: 
<a name="api_options_tcp_cases-0"/><a name="618"/>  618: <b>api_options_tcp_cases</b>() -&gt;
<a name="api_options_tcp_cases-last_expr"/><a name="619"/>  619:     [
<a name="620"/>  620:      api_opt_tcp_congestion_tcp4,
<a name="621"/>  621:      %% api_opt_tcp_congestion_tcp6,
<a name="622"/>  622:      api_opt_tcp_cork_tcp4,
<a name="623"/>  623:      %% api_opt_tcp_cork_tcp6,
<a name="624"/>  624:      api_opt_tcp_maxseg_tcp4,
<a name="625"/>  625:      %% api_opt_tcp_maxseg_tcp6,
<a name="626"/>  626:      api_opt_tcp_nodelay_tcp4,
<a name="627"/>  627:      %% api_opt_tcp_nodelay_tcp6
<a name="628"/>  628:      api_opt_tcp_keepcnt_tcp4,
<a name="629"/>  629:      api_opt_tcp_keepidle_tcp4,
<a name="630"/>  630:      api_opt_tcp_keepintvl_tcp4
<a name="631"/>  631:     ].
<a name="632"/>  632: 
<a name="api_options_udp_cases-0"/><a name="633"/>  633: <b>api_options_udp_cases</b>() -&gt;
<a name="api_options_udp_cases-last_expr"/><a name="634"/>  634:     [
<a name="635"/>  635:      api_opt_udp_cork_udp4%,
<a name="636"/>  636:      %% api_opt_udp_cork_udp6
<a name="637"/>  637:     ].
<a name="638"/>  638: 
<a name="api_op_with_timeout_cases-0"/><a name="639"/>  639: <b>api_op_with_timeout_cases</b>() -&gt;
<a name="api_op_with_timeout_cases-last_expr"/><a name="640"/>  640:     [
<a name="641"/>  641:      api_to_connect_tcp4,
<a name="642"/>  642:      api_to_connect_tcp6,
<a name="643"/>  643:      api_to_accept_tcp4,
<a name="644"/>  644:      api_to_accept_tcp6,
<a name="645"/>  645:      api_to_maccept_tcp4,
<a name="646"/>  646:      api_to_maccept_tcp6,
<a name="647"/>  647:      api_to_send_tcp4,
<a name="648"/>  648:      api_to_send_tcp6,
<a name="649"/>  649:      api_to_sendto_udp4,
<a name="650"/>  650:      api_to_sendto_udp6,
<a name="651"/>  651:      api_to_sendmsg_tcp4,
<a name="652"/>  652:      api_to_sendmsg_tcp6,
<a name="653"/>  653:      api_to_recv_udp4,
<a name="654"/>  654:      api_to_recv_udp6,
<a name="655"/>  655:      api_to_recv_tcp4,
<a name="656"/>  656:      api_to_recv_tcp6,
<a name="657"/>  657:      api_to_recvfrom_udp4,
<a name="658"/>  658:      api_to_recvfrom_udp6,
<a name="659"/>  659:      api_to_recvmsg_udp4,
<a name="660"/>  660:      api_to_recvmsg_udp6,
<a name="661"/>  661:      api_to_recvmsg_tcp4,
<a name="662"/>  662:      api_to_recvmsg_tcp6
<a name="663"/>  663:     ].
<a name="664"/>  664: 
<a name="665"/>  665: 
<a name="666"/>  666: 
<a name="667"/>  667: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="668"/>  668: 
<a name="init_per_suite-1"/><a name="669"/>  669: <b>init_per_suite</b>(Config0) -&gt;
<a name="670"/>  670:     os:internal_init_cmd_shell(),
<a name="671"/>  671:     ?P(&quot;init_per_suite -&gt; entry with&quot;
<a name="672"/>  672:        &quot;~n      Config: ~p&quot;
<a name="673"/>  673:        &quot;~n      Nodes:  ~p&quot;, [Config0, erlang:nodes()]),
<a name="674"/>  674:     
<a name="init_per_suite-last_expr"/><a name="675"/>  675: <b>    try socket:info</b>() of
<a name="676"/>  676:         #{} -&gt;
<a name="677"/>  677:             case ?KLIB:init_per_suite(Config0) of
<a name="678"/>  678:                 {skip, _} = SKIP -&gt;
<a name="679"/>  679:                     SKIP;
<a name="680"/>  680: 
<a name="681"/>  681:                 Config1 when is_list(Config1) -&gt;
<a name="682"/>  682: 
<a name="683"/>  683:                     ?P(&quot;init_per_suite -&gt; end when &quot;
<a name="684"/>  684:                        &quot;~n      Config: ~p&quot;, [Config1]),
<a name="685"/>  685: 
<a name="686"/>  686:                     %% We need a monitor on this node also
<a name="687"/>  687:                     kernel_test_sys_monitor:start(),
<a name="688"/>  688: 
<a name="689"/>  689:                     socket:use_registry(false),
<a name="690"/>  690:                     case quiet_mode(Config1) of
<a name="691"/>  691:                         default -&gt;
<a name="692"/>  692:                             case ?LOGGER:start() of
<a name="693"/>  693:                                 ok -&gt;
<a name="694"/>  694:                                     Config1;
<a name="695"/>  695:                                 {error, Reason} -&gt;
<a name="696"/>  696:                                     ?P(&quot;init_per_suite -&gt; &quot;
<a name="697"/>  697:                                        &quot;Failed starting logger&quot;
<a name="698"/>  698:                                        &quot;~n   Reason: ~p&quot;
<a name="699"/>  699:                                        &quot;~n&quot;, [Reason]),
<a name="700"/>  700:                                     {skip, &quot;Failed starting logger&quot;}
<a name="701"/>  701:                             end;
<a name="702"/>  702:                         Quiet -&gt;
<a name="703"/>  703:                             case ?LOGGER:start(Quiet) of
<a name="704"/>  704:                                 ok -&gt;
<a name="705"/>  705:                                     [{esock_test_quiet, Quiet} | Config1];
<a name="706"/>  706:                                 {error, Reason} -&gt;
<a name="707"/>  707:                                     ?P(&quot;init_per_suite -&gt; &quot;
<a name="708"/>  708:                                        &quot;Failed starting logger&quot;
<a name="709"/>  709:                                        &quot;~n   Reason: ~p&quot;
<a name="710"/>  710:                                        &quot;~n&quot;, [Reason]),
<a name="711"/>  711:                                     {skip, &quot;Failed starting logger&quot;}
<a name="712"/>  712:                             end
<a name="713"/>  713:                     end
<a name="714"/>  714:             end
<a name="715"/>  715:     catch
<a name="716"/>  716:         error : notsup -&gt;
<a name="717"/>  717:             {skip, &quot;esock not supported&quot;};
<a name="718"/>  718:         error : undef -&gt;
<a name="719"/>  719:             {skip, &quot;esock not configured&quot;}
<a name="720"/>  720:     end.
<a name="721"/>  721: 
<a name="end_per_suite-1"/><a name="722"/>  722: <b>end_per_suite</b>(Config0) -&gt;
<a name="723"/>  723: 
<a name="724"/>  724:     ?P(&quot;end_per_suite -&gt; entry with&quot;
<a name="725"/>  725:        &quot;~n      Config: ~p&quot;
<a name="726"/>  726:        &quot;~n      Nodes:  ~p&quot;, [Config0, erlang:nodes()]),
<a name="727"/>  727: 
<a name="728"/>  728:     %% Stop the local monitor
<a name="729"/>  729:     kernel_test_sys_monitor:stop(),
<a name="730"/>  730: 
<a name="731"/>  731:     (catch ?LOGGER:stop()),
<a name="732"/>  732: 
<a name="733"/>  733:     Config1 = ?KLIB:end_per_suite(Config0),
<a name="734"/>  734: 
<a name="735"/>  735:     ?P(&quot;end_per_suite -&gt; &quot;
<a name="736"/>  736:        &quot;~n      Nodes: ~p&quot;, [erlang:nodes()]),
<a name="737"/>  737: 
<a name="end_per_suite-last_expr"/><a name="738"/>  738:     Config1.
<a name="739"/>  739: 
<a name="740"/>  740: 
<a name="init_per_group-2"/><a name="741"/>  741: <b>init_per_group</b>(sendfile = GroupName, Config) -&gt;
<a name="742"/>  742:     io:format(&quot;init_per_group(~w) -&gt; entry with&quot;
<a name="743"/>  743:               &quot;~n   Config: ~p&quot;
<a name="744"/>  744:               &quot;~n&quot;, [GroupName, Config]),
<a name="745"/>  745:     case socket:is_supported(sendfile) of
<a name="746"/>  746:         true -&gt;
<a name="747"/>  747:             Dir = proplists:get_value(priv_dir, Config),
<a name="748"/>  748:             HeaderSize = 1021, % I like prime numbers
<a name="749"/>  749:             DataSize = 1031,  Pow2 = 16, % About 64 MB
<a name="750"/>  750:             Header = rand:bytes(HeaderSize),
<a name="751"/>  751:             Filler = rand:bytes(DataSize),
<a name="752"/>  752:             Trailer = rand:bytes(HeaderSize),
<a name="753"/>  753:             FileName = filename:join(Dir, &quot;sendfile.bin&quot;),
<a name="754"/>  754:             file:write_file(
<a name="755"/>  755:               FileName,
<a name="756"/>  756:               [Header, double_data(Pow2, Filler), Trailer]),
<a name="757"/>  757:             N = 1 bsl Pow2,
<a name="758"/>  758:             [{sendfile_file,
<a name="759"/>  759:               {FileName,
<a name="760"/>  760:                HeaderSize + (N * DataSize) + HeaderSize,
<a name="761"/>  761:                [Header, {N, Filler}, Trailer]}}
<a name="762"/>  762:              | Config];
<a name="763"/>  763:         false -&gt;
<a name="764"/>  764:             Config
<a name="765"/>  765:     end;
<a name="766"/>  766: <b>init_per_group</b>(from_fd = _GroupName, Config) -&gt;
<a name="767"/>  767:     has_multi_scheds(),
<a name="768"/>  768:     Config;
<a name="769"/>  769: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="770"/>  770:     Config.
<a name="771"/>  771: 
<a name="end_per_group-2"/><a name="772"/>  772: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="773"/>  773:     Config.
<a name="774"/>  774: 
<a name="775"/>  775: 
<a name="init_per_testcase-2"/><a name="776"/>  776: <b>init_per_testcase</b>(_TC, Config) -&gt;
<a name="777"/>  777:     io:format(&quot;init_per_testcase(~w) -&gt; entry with&quot;
<a name="778"/>  778:               &quot;~n   Config: ~p&quot;
<a name="779"/>  779:               &quot;~n&quot;, [_TC, Config]),
<a name="init_per_testcase-last_expr"/><a name="780"/>  780:     Config.
<a name="781"/>  781: 
<a name="end_per_testcase-2"/><a name="782"/>  782: <b>end_per_testcase</b>(_TC, Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="783"/>  783:     Config.
<a name="784"/>  784: 
<a name="785"/>  785: 
<a name="quiet_mode-1"/><a name="786"/>  786: <b>quiet_mode</b>(Config) -&gt;
<a name="quiet_mode-last_expr"/><a name="787"/>  787: <b>    case lists:keysearch</b>(esock_test_quiet, 1, Config) of
<a name="788"/>  788:         {value, {esock_test_quiet, Quiet}} -&gt;
<a name="789"/>  789:             Quiet;
<a name="790"/>  790:         false -&gt;
<a name="791"/>  791:             case os:getenv(&quot;ESOCK_TEST_QUIET&quot;) of
<a name="792"/>  792:                 &quot;true&quot;  -&gt; true;
<a name="793"/>  793:                 &quot;false&quot; -&gt; false;
<a name="794"/>  794:                 _       -&gt; default
<a name="795"/>  795:             end
<a name="796"/>  796:     end.
<a name="797"/>  797: 
<a name="double_data-2"/><a name="798"/>  798: <b>double_data</b>(0, Data) -&gt;
<a name="799"/>  799:     Data;
<a name="800"/>  800: <b>double_data</b>(N, Data) -&gt;
<a name="double_data-last_expr"/><a name="801"/>  801: <b>    double_data</b>(N - 1, [Data, Data]).
<a name="802"/>  802: 
<a name="803"/>  803: 
<a name="804"/>  804: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="805"/>  805: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="806"/>  806: <i>%%                                                                     %%</i>
<a name="807"/>  807: <i>%%                           API MISC                                  %%</i>
<a name="808"/>  808: <i>%%                                                                     %%</i>
<a name="809"/>  809: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="810"/>  810: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="811"/>  811: 
<a name="812"/>  812: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="813"/>  813: 
<a name="814"/>  814: <i>%% This is an extremely rudimentary test case, that just tests</i>
<a name="815"/>  815: <i>%% that we can call the &quot;global&quot; info function and that it returns</i>
<a name="816"/>  816: <i>%% a non-empty map...</i>
<a name="817"/>  817: 
<a name="api_m_info-1"/><a name="818"/>  818: <b>api_m_info</b>(_Config) when is_list(_Config) -&gt;
<a name="819"/>  819:     ?TT(?SECS(5)),
<a name="api_m_info-last_expr"/><a name="820"/>  820: <b>    tc_try</b>(api_m_info,
<a name="821"/>  821:            fun() -&gt;
<a name="822"/>  822:                    ok = api_m_info()
<a name="823"/>  823:            end).
<a name="824"/>  824: 
<a name="api_m_info-0"/><a name="825"/>  825: <b>api_m_info</b>() -&gt;
<a name="api_m_info-last_expr"/><a name="826"/>  826: <b>    case socket:info</b>() of
<a name="827"/>  827:         Info when is_map(Info) -&gt;
<a name="828"/>  828:             Sz = maps:size(Info),
<a name="829"/>  829:             if
<a name="830"/>  830:                 (Sz &gt; 0) -&gt;
<a name="831"/>  831:                     ok;
<a name="832"/>  832:                 true -&gt;
<a name="833"/>  833:                     ?FAIL(no_info)
<a name="834"/>  834:             end;
<a name="835"/>  835:         Info -&gt;
<a name="836"/>  836:             ?FAIL({invalid_info, Info})
<a name="837"/>  837:     end.
<a name="838"/>  838: 
<a name="839"/>  839: 
<a name="840"/>  840: 
<a name="841"/>  841: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="842"/>  842: 
<a name="843"/>  843: <i>%% A simple test case that tests that the global debug can be changed.</i>
<a name="844"/>  844: <i>%% At the same time, it will test the info function (since it uses it</i>
<a name="845"/>  845: <i>%% for verification).</i>
<a name="846"/>  846: 
<a name="api_m_debug-1"/><a name="847"/>  847: <b>api_m_debug</b>(_Config) when is_list(_Config) -&gt;
<a name="848"/>  848:     ?TT(?SECS(5)),
<a name="api_m_debug-last_expr"/><a name="849"/>  849: <b>    tc_try</b>(api_m_debug,
<a name="850"/>  850:            fun() -&gt; has_bugfree_gcc() end,
<a name="851"/>  851:            fun() -&gt;
<a name="852"/>  852:                    ok = api_m_debug()
<a name="853"/>  853:            end).
<a name="854"/>  854: 
<a name="855"/>  855: <i>%% For some reason this test case triggers a gcc bug, which causes</i>
<a name="856"/>  856: <i>%% a segfault, on an ancient Fedora 16 VM. So, check the version of gcc...</i>
<a name="857"/>  857: <i>%% Not pretty, but the simplest way to skip (without actually testing</i>
<a name="858"/>  858: <i>%% for the host).</i>
<a name="has_bugfree_gcc-0"/><a name="859"/>  859: <b>has_bugfree_gcc</b>() -&gt;
<a name="has_bugfree_gcc-last_expr"/><a name="860"/>  860: <b>    has_bugfree_gcc</b>(os:type()).
<a name="861"/>  861: 
<a name="862"/>  862: <i>%% Make sure we are on linux</i>
<a name="has_bugfree_gcc-1"/><a name="863"/>  863: <b>has_bugfree_gcc</b>({unix, linux}) -&gt;
<a name="864"/>  864:     has_bugfree_gcc2(string:trim(os:cmd(&quot;cat /etc/issue&quot;)));
<a name="865"/>  865: <b>has_bugfree_gcc</b>(_) -&gt;
<a name="has_bugfree_gcc-last_expr"/><a name="866"/>  866:     ok.
<a name="867"/>  867: 
<a name="868"/>  868: <i>%% Make sure we are on Fedora 16</i>
<a name="has_bugfree_gcc2-1"/><a name="869"/>  869: <b>has_bugfree_gcc2</b>(&quot;Fedora release 16 &quot; ++ _) -&gt;
<a name="870"/>  870:     has_bugfree_gcc3(os:cmd(&quot;gcc --version&quot;));
<a name="871"/>  871: <b>has_bugfree_gcc2</b>(&quot;Welcome to SUSE Linux &quot; ++ _) -&gt;
<a name="872"/>  872:     has_bugfree_gcc4(os:cmd(&quot;gcc --version&quot;));
<a name="873"/>  873: <b>has_bugfree_gcc2</b>(_) -&gt;
<a name="has_bugfree_gcc2-last_expr"/><a name="874"/>  874:     ok.
<a name="875"/>  875: 
<a name="has_bugfree_gcc3-1"/><a name="876"/>  876: <b>has_bugfree_gcc3</b>(&quot;gcc (GCC) 4.6.3 20120306 (Red Hat 4.6.3-2&quot; ++ _) -&gt;
<a name="877"/>  877:     skip(&quot;Buggy GCC&quot;);
<a name="878"/>  878: <b>has_bugfree_gcc3</b>(_) -&gt;
<a name="has_bugfree_gcc3-last_expr"/><a name="879"/>  879:     ok.
<a name="880"/>  880: 
<a name="has_bugfree_gcc4-1"/><a name="881"/>  881: <b>has_bugfree_gcc4</b>(&quot;gcc (SUSE Linux) 4.3.2&quot; ++ _) -&gt;
<a name="882"/>  882:     skip(&quot;Buggy GCC&quot;);
<a name="883"/>  883: <b>has_bugfree_gcc4</b>(_) -&gt;
<a name="has_bugfree_gcc4-last_expr"/><a name="884"/>  884:     ok.
<a name="885"/>  885: 
<a name="api_m_debug-0"/><a name="886"/>  886: <b>api_m_debug</b>() -&gt;
<a name="887"/>  887:     i(&quot;get initial info&quot;),
<a name="888"/>  888:     #{debug := D0} = socket:info(),
<a name="889"/>  889:     D1 = not D0,
<a name="890"/>  890:     i(&quot;set new debug (~w =&gt; ~w)&quot;, [D0, D1]),
<a name="891"/>  891:     ok = socket:debug(D1),
<a name="892"/>  892:     i(&quot;get updated info (~w)&quot;, [D1]),
<a name="893"/>  893:     #{debug := D1} = socket:info(),
<a name="894"/>  894:     D2 = not D1,
<a name="895"/>  895:     i(&quot;set new debug (~w =&gt; ~w)&quot;, [D1, D2]),
<a name="896"/>  896:     ok = socket:debug(D2),
<a name="897"/>  897:     i(&quot;get updated info (~w)&quot;, [D2]),
<a name="898"/>  898:     #{debug := D2} = socket:info(),
<a name="899"/>  899:     i(&quot;ok&quot;),
<a name="api_m_debug-last_expr"/><a name="900"/>  900:     ok.
<a name="901"/>  901:     
<a name="902"/>  902: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="903"/>  903: 
<a name="904"/>  904: <i>%% Some tests for API misuses</i>
<a name="905"/>  905: 
<a name="906"/>  906: <b>-define</b>(
<a name="907"/>  907:    EXCEPTION(Code),
<a name="908"/>  908:    exception(fun () -&gt; begin Code end end)).
<a name="909"/>  909: 
<a name="exception-1"/><a name="910"/>  910: <b>exception</b>(Fun) -&gt;
<a name="exception-last_expr"/><a name="911"/>  911: <b>    try Fun</b>() of
<a name="912"/>  912:         Result -&gt;
<a name="913"/>  913:             error({unexpected_return, Result})
<a name="914"/>  914:     catch
<a name="915"/>  915:         Class : Reason -&gt;
<a name="916"/>  916:             {Class, Reason}
<a name="917"/>  917:     end.
<a name="918"/>  918: 
<a name="919"/>  919: 
<a name="api_m_error_open-1"/><a name="920"/>  920: <b>api_m_error_open</b>(Config) when is_list(Config) -&gt;
<a name="921"/>  921:     %%
<a name="922"/>  922:     %% open/1
<a name="923"/>  923:     {error, badarg} =
<a name="924"/>  924:         ?EXCEPTION(
<a name="925"/>  925:            socket:open(should_be_fd) ),
<a name="926"/>  926:     %%
<a name="927"/>  927:     %% open/2
<a name="928"/>  928:     {error, badarg} =
<a name="929"/>  929:         ?EXCEPTION(
<a name="930"/>  930:            socket:open(should_be_fd, #{}) ),
<a name="931"/>  931:     %%
<a name="932"/>  932:     %% A non-atom, non-integer protocol causes an exception
<a name="933"/>  933:     %% in prim_socket, whilst a non-atom, non-integer type
<a name="934"/>  934:     %% or domain causes an error return tuple from the NIF
<a name="935"/>  935:     %% code.  This is a bit inconsistent.  Should we change
<a name="936"/>  936:     %% that, if so - how, and consolidate in tests?
<a name="937"/>  937:     %%
<a name="938"/>  938:     {error,{invalid,{domain,should_be_domain}}} =
<a name="939"/>  939:         socket:open(should_be_domain, dgram),
<a name="940"/>  940:     {error,{invalid,{type,should_be_type}}} =
<a name="941"/>  941:         socket:open(inet, should_be_type),
<a name="942"/>  942:     %%
<a name="943"/>  943:     %% open/3
<a name="944"/>  944:     {error,{invalid,{domain,should_be_domain}}} =
<a name="945"/>  945:         socket:open(should_be_domain, dgram, #{}),
<a name="946"/>  946:     {error,{invalid,{type,should_be_type}}} =
<a name="947"/>  947:         socket:open(inet, should_be_type, #{}),
<a name="948"/>  948:     {error,{invalid,{protocol,should_be_protocol}}} =
<a name="949"/>  949:         socket:open(inet, dgram, should_be_protocol),
<a name="950"/>  950:     %%
<a name="951"/>  951:     %% open/4
<a name="952"/>  952:     {error,{invalid,{domain,should_be_domain}}} =
<a name="953"/>  953:         socket:open(should_be_domain, dgram, default, #{}),
<a name="954"/>  954:     {error,{invalid,{type,should_be_type}}} =
<a name="955"/>  955:         socket:open(inet, should_be_type, default, #{}),
<a name="956"/>  956:     {error,{invalid,{protocol,should_be_protocol}}} =
<a name="957"/>  957:         socket:open(inet, dgram, should_be_protocol, #{}),
<a name="api_m_error_open-last_expr"/><a name="958"/>  958:     {error, badarg} =
<a name="959"/>  959:         ?EXCEPTION(
<a name="960"/>  960:            socket:open(inet, dgram, default, should_be_options) ).
<a name="961"/>  961: 
<a name="962"/>  962: 
<a name="api_m_error_bind-1"/><a name="963"/>  963: <b>api_m_error_bind</b>(Config) when is_list(Config) -&gt;
<a name="964"/>  964:     {ok, S} = socket:open(inet, dgram),
<a name="965"/>  965:     try
<a name="966"/>  966:         %%
<a name="967"/>  967:         %% bind/2
<a name="968"/>  968:         {error, badarg} =
<a name="969"/>  969:             ?EXCEPTION(
<a name="970"/>  970:                socket:bind(should_be_socket, any) ),
<a name="971"/>  971:         {error, badarg} =
<a name="972"/>  972:             ?EXCEPTION(
<a name="973"/>  973:                socket:bind(make_ref(), any) ),
<a name="974"/>  974:         %%
<a name="975"/>  975:         %% A non-map, non-atom Addr causes an {invalid,_}
<a name="976"/>  976:         %% exception.  Should that instead be an error
<a name="977"/>  977:         %% return?
<a name="978"/>  978:         %%
<a name="979"/>  979:         {error,{invalid,{sockaddr,should_be_sockaddr}}} =
<a name="980"/>  980:             socket:bind(S, should_be_sockaddr),
<a name="981"/>  981:         EmptyMap = #{},
<a name="982"/>  982:         {error,{invalid,{sockaddr,family,EmptyMap}}} =
<a name="983"/>  983:             socket:bind(S, EmptyMap),
<a name="984"/>  984:         InvalidKey = #{family =&gt; inet, invalid_key =&gt; []},
<a name="985"/>  985:         {error,{invalid,{sockaddr,{keys,[invalid_key]},InvalidKey}}} =
<a name="986"/>  986:             socket:bind(S, InvalidKey),
<a name="987"/>  987:         InvalidFamily = #{family =&gt; invalid_family},
<a name="988"/>  988:         {error,{invalid,{sockaddr,InvalidFamily}}} =
<a name="989"/>  989:             socket:bind(S, InvalidFamily)
<a name="990"/>  990:     after
<a name="991"/>  991:         _ = socket:close(S)
<a name="992"/>  992:     end,
<a name="api_m_error_bind-last_expr"/><a name="993"/>  993:     ok.
<a name="994"/>  994: 
<a name="995"/>  995: 
<a name="996"/>  996: <i>%% XXX Lots of missing error tests here, for all other API functions...</i>
<a name="997"/>  997: 
<a name="998"/>  998: 
<a name="999"/>  999: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1000"/> 1000: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1001"/> 1001: <i>%%                                                                     %%</i>
<a name="1002"/> 1002: <i>%%                           API BASIC                                 %%</i>
<a name="1003"/> 1003: <i>%%                                                                     %%</i>
<a name="1004"/> 1004: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1005"/> 1005: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1006"/> 1006: 
<a name="1007"/> 1007: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1008"/> 1008: 
<a name="1009"/> 1009: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_udp4-1"/><a name="1010"/> 1010: <b>api_b_simple_open_and_close_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1011"/> 1011:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_udp4-last_expr"/><a name="1012"/> 1012: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1013"/> 1013:            fun() -&gt;
<a name="1014"/> 1014:                    InitState = #{domain   =&gt; inet,
<a name="1015"/> 1015:                                  type     =&gt; dgram,
<a name="1016"/> 1016:                                  protocol =&gt; udp},
<a name="1017"/> 1017:                    ok = api_b_simple_open_and_close(InitState)
<a name="1018"/> 1018:            end).
<a name="1019"/> 1019: 
<a name="1020"/> 1020: 
<a name="1021"/> 1021: 
<a name="1022"/> 1022: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1023"/> 1023: 
<a name="1024"/> 1024: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_udp6-1"/><a name="1025"/> 1025: <b>api_b_simple_open_and_close_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1026"/> 1026:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_udp6-last_expr"/><a name="1027"/> 1027: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1028"/> 1028:            fun() -&gt; has_support_ipv6() end,
<a name="1029"/> 1029:            fun() -&gt;
<a name="1030"/> 1030:                    InitState = #{domain   =&gt; inet6,
<a name="1031"/> 1031:                                  type     =&gt; dgram,
<a name="1032"/> 1032:                                  protocol =&gt; udp},
<a name="1033"/> 1033:                    ok = api_b_simple_open_and_close(InitState)
<a name="1034"/> 1034:            end).
<a name="1035"/> 1035: 
<a name="1036"/> 1036: 
<a name="1037"/> 1037: 
<a name="1038"/> 1038: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1039"/> 1039: 
<a name="1040"/> 1040: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_tcp4-1"/><a name="1041"/> 1041: <b>api_b_simple_open_and_close_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1042"/> 1042:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_tcp4-last_expr"/><a name="1043"/> 1043: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1044"/> 1044:            fun() -&gt;
<a name="1045"/> 1045:                    InitState = #{domain   =&gt; inet,
<a name="1046"/> 1046:                                  type     =&gt; stream,
<a name="1047"/> 1047:                                  protocol =&gt; tcp},
<a name="1048"/> 1048:                    ok = api_b_simple_open_and_close(InitState)
<a name="1049"/> 1049:            end).
<a name="1050"/> 1050: 
<a name="1051"/> 1051: 
<a name="1052"/> 1052: 
<a name="1053"/> 1053: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1054"/> 1054: 
<a name="1055"/> 1055: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_tcp6-1"/><a name="1056"/> 1056: <b>api_b_simple_open_and_close_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1057"/> 1057:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_tcp6-last_expr"/><a name="1058"/> 1058: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1059"/> 1059:            fun() -&gt; has_support_ipv6() end,
<a name="1060"/> 1060:            fun() -&gt;
<a name="1061"/> 1061:                    InitState = #{domain   =&gt; inet6,
<a name="1062"/> 1062:                                  type     =&gt; stream,
<a name="1063"/> 1063:                                  protocol =&gt; tcp},
<a name="1064"/> 1064:                    ok = api_b_simple_open_and_close(InitState)
<a name="1065"/> 1065:            end).
<a name="1066"/> 1066: 
<a name="1067"/> 1067: 
<a name="1068"/> 1068: 
<a name="1069"/> 1069: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1070"/> 1070: 
<a name="api_b_simple_open_and_close-1"/><a name="1071"/> 1071: <b>api_b_simple_open_and_close</b>(InitState) -&gt;
<a name="1072"/> 1072:     Seq = 
<a name="1073"/> 1073:         [
<a name="1074"/> 1074:          #{desc =&gt; &quot;open&quot;,
<a name="1075"/> 1075:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1076"/> 1076:                          type     := Type,
<a name="1077"/> 1077:                          protocol := Protocol} = State) -&gt; 
<a name="1078"/> 1078:                            case socket:open(Domain, Type, Protocol) of
<a name="1079"/> 1079:                                {ok, Sock} -&gt;
<a name="1080"/> 1080:                                    {ok, State#{sock =&gt; Sock}};
<a name="1081"/> 1081:                                {error, _} = ERROR -&gt;
<a name="1082"/> 1082:                                    ERROR
<a name="1083"/> 1083:                            end
<a name="1084"/> 1084:                    end},
<a name="1085"/> 1085: 
<a name="1086"/> 1086:          ?SEV_SLEEP(?SECS(1)),
<a name="1087"/> 1087: 
<a name="1088"/> 1088:          #{desc =&gt; &quot;close socket&quot;,
<a name="1089"/> 1089:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="1090"/> 1090:                            socket:close(Sock)
<a name="1091"/> 1091:                    end},
<a name="1092"/> 1092: 
<a name="1093"/> 1093:          %% *** We are done ***
<a name="1094"/> 1094:          ?SEV_FINISH_NORMAL
<a name="1095"/> 1095:         ],
<a name="1096"/> 1096:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_simple_open_and_close-last_expr"/><a name="1097"/> 1097: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1098"/> 1098: 
<a name="1099"/> 1099: 
<a name="1100"/> 1100: 
<a name="1101"/> 1101: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1102"/> 1102: 
<a name="1103"/> 1103: <i>%% Basically open (create) and info of an IPv4 UDP (dgram) socket.</i>
<a name="1104"/> 1104: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_udp4-1"/><a name="1105"/> 1105: <b>api_b_open_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1106"/> 1106:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_udp4-last_expr"/><a name="1107"/> 1107: <b>    tc_try</b>(api_b_open_and_info_udp4,
<a name="1108"/> 1108:            fun() -&gt;
<a name="1109"/> 1109:                    InitState = #{domain   =&gt; inet,
<a name="1110"/> 1110:                                  type     =&gt; dgram,
<a name="1111"/> 1111:                                  protocol =&gt; udp},
<a name="1112"/> 1112:                    ok = api_b_open_and_info(InitState)
<a name="1113"/> 1113:            end).
<a name="1114"/> 1114: 
<a name="1115"/> 1115: 
<a name="1116"/> 1116: 
<a name="1117"/> 1117: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1118"/> 1118: 
<a name="1119"/> 1119: <i>%% Basically open (create) and info of an IPv6 UDP (dgram) socket.</i>
<a name="1120"/> 1120: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_udp6-1"/><a name="1121"/> 1121: <b>api_b_open_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1122"/> 1122:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_udp6-last_expr"/><a name="1123"/> 1123: <b>    tc_try</b>(api_b_open_and_info_udp6,
<a name="1124"/> 1124:            fun() -&gt; has_support_ipv6() end,
<a name="1125"/> 1125:            fun() -&gt;
<a name="1126"/> 1126:                    InitState = #{domain   =&gt; inet6,
<a name="1127"/> 1127:                                  type     =&gt; dgram,
<a name="1128"/> 1128:                                  protocol =&gt; udp},
<a name="1129"/> 1129:                    ok = api_b_open_and_info(InitState)
<a name="1130"/> 1130:            end).
<a name="1131"/> 1131: 
<a name="1132"/> 1132: 
<a name="1133"/> 1133: 
<a name="1134"/> 1134: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1135"/> 1135: 
<a name="1136"/> 1136: <i>%% Basically open (create) and info of an IPv4 TCP (stream) socket.</i>
<a name="1137"/> 1137: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_tcp4-1"/><a name="1138"/> 1138: <b>api_b_open_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1139"/> 1139:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_tcp4-last_expr"/><a name="1140"/> 1140: <b>    tc_try</b>(api_b_open_and_info_tcp4,
<a name="1141"/> 1141:            fun() -&gt;
<a name="1142"/> 1142:                    InitState = #{domain   =&gt; inet,
<a name="1143"/> 1143:                                  type     =&gt; stream,
<a name="1144"/> 1144:                                  protocol =&gt; tcp},
<a name="1145"/> 1145:                    ok = api_b_open_and_info(InitState)
<a name="1146"/> 1146:            end).
<a name="1147"/> 1147: 
<a name="1148"/> 1148: 
<a name="1149"/> 1149: 
<a name="1150"/> 1150: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1151"/> 1151: 
<a name="1152"/> 1152: <i>%% Basically open (create) and info of an IPv6 TCP (stream) socket.</i>
<a name="1153"/> 1153: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_tcp6-1"/><a name="1154"/> 1154: <b>api_b_open_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1155"/> 1155:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_tcp6-last_expr"/><a name="1156"/> 1156: <b>    tc_try</b>(api_b_open_and_info_tcp6,
<a name="1157"/> 1157:            fun() -&gt; has_support_ipv6() end,
<a name="1158"/> 1158:            fun() -&gt;
<a name="1159"/> 1159:                    InitState = #{domain   =&gt; inet6,
<a name="1160"/> 1160:                                  type     =&gt; stream,
<a name="1161"/> 1161:                                  protocol =&gt; tcp},
<a name="1162"/> 1162:                    ok = api_b_open_and_info(InitState)
<a name="1163"/> 1163:            end).
<a name="1164"/> 1164: 
<a name="1165"/> 1165: 
<a name="1166"/> 1166: 
<a name="1167"/> 1167: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1168"/> 1168: 
<a name="api_b_open_and_info-1"/><a name="1169"/> 1169: <b>api_b_open_and_info</b>(InitState) -&gt;
<a name="1170"/> 1170:     Seq = 
<a name="1171"/> 1171:         [
<a name="1172"/> 1172:          #{desc =&gt; &quot;open&quot;,
<a name="1173"/> 1173:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1174"/> 1174:                          type     := Type,
<a name="1175"/> 1175:                          protocol := Protocol} = State) -&gt; 
<a name="1176"/> 1176:                            case socket:open(Domain, Type, Protocol) of
<a name="1177"/> 1177:                                {ok, Sock} -&gt;
<a name="1178"/> 1178:                                    {ok, State#{sock =&gt; Sock}};
<a name="1179"/> 1179:                                {error, _} = ERROR -&gt;
<a name="1180"/> 1180:                                    ERROR
<a name="1181"/> 1181:                            end
<a name="1182"/> 1182:                    end},
<a name="1183"/> 1183:          #{desc =&gt; &quot;get socket info&quot;,
<a name="1184"/> 1184:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="1185"/> 1185:                            Info = socket:info(Sock),
<a name="1186"/> 1186:                            ?SEV_IPRINT(&quot;Got (some) Info: &quot;
<a name="1187"/> 1187:                                        &quot;~n   ~p&quot;, [Info]),
<a name="1188"/> 1188:                            {ok, State#{info =&gt; Info}}
<a name="1189"/> 1189:                    end},
<a name="1190"/> 1190:          #{desc =&gt; &quot;validate socket info&quot;,
<a name="1191"/> 1191:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1192"/> 1192:                          type     := Type,
<a name="1193"/> 1193:                          protocol := Protocol,
<a name="1194"/> 1194:                          info     := #{domain        := Domain,
<a name="1195"/> 1195:                                        type          := Type,
<a name="1196"/> 1196:                                        protocol      := Protocol,
<a name="1197"/> 1197:                                        counters      := _,
<a name="1198"/> 1198:                                        num_readers   := 0,
<a name="1199"/> 1199:                                        num_writers   := 0,
<a name="1200"/> 1200:                                        num_acceptors := 0}}) -&gt;
<a name="1201"/> 1201:                            ok;
<a name="1202"/> 1202:                       (#{domain   := Domain,
<a name="1203"/> 1203:                          type     := Type,
<a name="1204"/> 1204:                          protocol := Protocol,
<a name="1205"/> 1205:                          info     := Info}) -&gt;
<a name="1206"/> 1206:                            ?SEV_EPRINT(&quot;Unexpected Info: &quot;
<a name="1207"/> 1207:                                        &quot;~n   (expected) Domain:   ~p&quot;
<a name="1208"/> 1208:                                        &quot;~n   (expected) Type:     ~p&quot;
<a name="1209"/> 1209:                                        &quot;~n   (expected) Protocol: ~p&quot;
<a name="1210"/> 1210:                                        &quot;~n   ~p&quot;,
<a name="1211"/> 1211:                                        [Domain, Type, Protocol, Info]),
<a name="1212"/> 1212:                            {error, unexpected_infio}
<a name="1213"/> 1213:                    end},
<a name="1214"/> 1214:          #{desc =&gt; &quot;close socket&quot;,
<a name="1215"/> 1215:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="1216"/> 1216:                            socket:close(Sock)
<a name="1217"/> 1217:                    end},
<a name="1218"/> 1218: 
<a name="1219"/> 1219:          %% *** We are done ***
<a name="1220"/> 1220:          ?SEV_FINISH_NORMAL
<a name="1221"/> 1221:         ],
<a name="1222"/> 1222:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_open_and_info-last_expr"/><a name="1223"/> 1223: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1224"/> 1224: 
<a name="1225"/> 1225: 
<a name="1226"/> 1226: 
<a name="1227"/> 1227: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1228"/> 1228: 
<a name="1229"/> 1229: <i>%% Basically open (create) and close an IPv4 UDP (dgram) socket.</i>
<a name="1230"/> 1230: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udp4-1"/><a name="1231"/> 1231: <b>api_b_open_and_close_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1232"/> 1232:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udp4-last_expr"/><a name="1233"/> 1233: <b>    tc_try</b>(api_b_open_and_close_udp4,
<a name="1234"/> 1234:            fun() -&gt;
<a name="1235"/> 1235:                    InitState = #{domain   =&gt; inet,
<a name="1236"/> 1236:                                  type     =&gt; dgram,
<a name="1237"/> 1237:                                  protocol =&gt; udp},
<a name="1238"/> 1238:                    ok = api_b_open_and_close(InitState)
<a name="1239"/> 1239:            end).
<a name="1240"/> 1240: 
<a name="1241"/> 1241: 
<a name="1242"/> 1242: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1243"/> 1243: 
<a name="1244"/> 1244: <i>%% Basically open (create) and close an IPv6 UDP (dgram) socket.</i>
<a name="1245"/> 1245: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udp6-1"/><a name="1246"/> 1246: <b>api_b_open_and_close_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1247"/> 1247:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udp6-last_expr"/><a name="1248"/> 1248: <b>    tc_try</b>(api_b_open_and_close_udp6,
<a name="1249"/> 1249:            fun() -&gt; has_support_ipv6() end,
<a name="1250"/> 1250:            fun() -&gt;
<a name="1251"/> 1251:                    InitState = #{domain   =&gt; inet6,
<a name="1252"/> 1252:                                  type     =&gt; dgram,
<a name="1253"/> 1253:                                  protocol =&gt; udp},
<a name="1254"/> 1254:                    ok = api_b_open_and_close(InitState)
<a name="1255"/> 1255:            end).
<a name="1256"/> 1256: 
<a name="1257"/> 1257: 
<a name="1258"/> 1258: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1259"/> 1259: 
<a name="1260"/> 1260: <i>%% Basically open (create) and close an IPv4 TCP (stream) socket.</i>
<a name="1261"/> 1261: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcp4-1"/><a name="1262"/> 1262: <b>api_b_open_and_close_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1263"/> 1263:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcp4-last_expr"/><a name="1264"/> 1264: <b>    tc_try</b>(api_b_open_and_close_tcp4,
<a name="1265"/> 1265:            fun() -&gt;
<a name="1266"/> 1266:                    InitState = #{domain   =&gt; inet,
<a name="1267"/> 1267:                                  type     =&gt; stream,
<a name="1268"/> 1268:                                  protocol =&gt; tcp},
<a name="1269"/> 1269:                    ok = api_b_open_and_close(InitState)
<a name="1270"/> 1270:            end).
<a name="1271"/> 1271: 
<a name="1272"/> 1272: 
<a name="1273"/> 1273: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1274"/> 1274: 
<a name="1275"/> 1275: <i>%% Basically open (create) and close an IPv6 TCP (stream) socket.</i>
<a name="1276"/> 1276: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcp6-1"/><a name="1277"/> 1277: <b>api_b_open_and_close_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1278"/> 1278:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcp6-last_expr"/><a name="1279"/> 1279: <b>    tc_try</b>(api_b_open_and_close_tcp6,
<a name="1280"/> 1280:            fun() -&gt; has_support_ipv6() end,
<a name="1281"/> 1281:            fun() -&gt;
<a name="1282"/> 1282:                    InitState = #{domain   =&gt; inet,
<a name="1283"/> 1283:                                  type     =&gt; stream,
<a name="1284"/> 1284:                                  protocol =&gt; tcp},
<a name="1285"/> 1285:                    ok = api_b_open_and_close(InitState)
<a name="1286"/> 1286:            end).
<a name="1287"/> 1287: 
<a name="1288"/> 1288: 
<a name="1289"/> 1289: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1290"/> 1290: 
<a name="1291"/> 1291: <i>%% Basically open (create) and close an Unix Domain dgram (UDP) socket.</i>
<a name="1292"/> 1292: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udpL-1"/><a name="1293"/> 1293: <b>api_b_open_and_close_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1294"/> 1294:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udpL-last_expr"/><a name="1295"/> 1295: <b>    tc_try</b>(api_b_open_and_close_udpL,
<a name="1296"/> 1296:            fun() -&gt;
<a name="1297"/> 1297: 		   has_support_unix_domain_socket(),
<a name="1298"/> 1298: 		   is_not_windows()
<a name="1299"/> 1299: 	   end,
<a name="1300"/> 1300:            fun() -&gt;
<a name="1301"/> 1301:                    InitState = #{domain   =&gt; local,
<a name="1302"/> 1302:                                  type     =&gt; dgram,
<a name="1303"/> 1303:                                  protocol =&gt; default},
<a name="1304"/> 1304:                    ok = api_b_open_and_close(InitState)
<a name="1305"/> 1305:            end).
<a name="1306"/> 1306: 
<a name="1307"/> 1307: 
<a name="1308"/> 1308: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1309"/> 1309: 
<a name="1310"/> 1310: <i>%% Basically open (create) and close an Unix Domain stream (TCP) socket.</i>
<a name="1311"/> 1311: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcpL-1"/><a name="1312"/> 1312: <b>api_b_open_and_close_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1313"/> 1313:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcpL-last_expr"/><a name="1314"/> 1314: <b>    tc_try</b>(api_b_open_and_close_tcpL,
<a name="1315"/> 1315:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="1316"/> 1316:            fun() -&gt;
<a name="1317"/> 1317:                    InitState = #{domain   =&gt; local,
<a name="1318"/> 1318:                                  type     =&gt; stream,
<a name="1319"/> 1319:                                  protocol =&gt; default},
<a name="1320"/> 1320:                    ok = api_b_open_and_close(InitState)
<a name="1321"/> 1321:            end).
<a name="1322"/> 1322: 
<a name="1323"/> 1323: 
<a name="1324"/> 1324: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1325"/> 1325: 
<a name="1326"/> 1326: <i>%% Basically open (create) and close an Unix Domain dgram (UDP) socket.</i>
<a name="1327"/> 1327: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_seqpL-1"/><a name="1328"/> 1328: <b>api_b_open_and_close_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1329"/> 1329:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_seqpL-last_expr"/><a name="1330"/> 1330: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1331"/> 1331:            fun() -&gt;
<a name="1332"/> 1332: 		   has_support_unix_domain_socket(),
<a name="1333"/> 1333:                    is_not_windows()
<a name="1334"/> 1334: 	   end,
<a name="1335"/> 1335:            fun() -&gt;
<a name="1336"/> 1336:                    InitState = #{domain   =&gt; local,
<a name="1337"/> 1337:                                  type     =&gt; seqpacket,
<a name="1338"/> 1338:                                  protocol =&gt; default},
<a name="1339"/> 1339:                    ok = api_b_open_and_close(InitState)
<a name="1340"/> 1340:            end).
<a name="1341"/> 1341: 
<a name="1342"/> 1342: 
<a name="1343"/> 1343: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1344"/> 1344: 
<a name="1345"/> 1345: <i>%% Basically open (create) and close an IPv4 SCTP (seqpacket) socket.</i>
<a name="1346"/> 1346: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_seqp_sctp4-1"/><a name="1347"/> 1347: <b>api_b_open_and_close_seqp_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1348"/> 1348:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_seqp_sctp4-last_expr"/><a name="1349"/> 1349: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1350"/> 1350:            fun() -&gt; has_support_sctp() end,
<a name="1351"/> 1351:            fun() -&gt;
<a name="1352"/> 1352:                    InitState = #{domain   =&gt; inet,
<a name="1353"/> 1353:                                  type     =&gt; seqpacket,
<a name="1354"/> 1354:                                  protocol =&gt; sctp},
<a name="1355"/> 1355:                    ok = api_b_open_and_close(InitState)
<a name="1356"/> 1356:            end).
<a name="1357"/> 1357: 
<a name="1358"/> 1358: 
<a name="1359"/> 1359: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1360"/> 1360: 
<a name="1361"/> 1361: <i>%% Basically open (create) and close an IPv6 SCTP (seqpacket) socket.</i>
<a name="1362"/> 1362: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_seqp_sctp6-1"/><a name="1363"/> 1363: <b>api_b_open_and_close_seqp_sctp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1364"/> 1364:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_seqp_sctp6-last_expr"/><a name="1365"/> 1365: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1366"/> 1366:            fun() -&gt;
<a name="1367"/> 1367:                    has_support_sctp(),
<a name="1368"/> 1368:                    has_support_ipv6()
<a name="1369"/> 1369:            end,
<a name="1370"/> 1370:            fun() -&gt;
<a name="1371"/> 1371:                    InitState = #{domain   =&gt; inet6,
<a name="1372"/> 1372:                                  type     =&gt; seqpacket,
<a name="1373"/> 1373:                                  protocol =&gt; sctp},
<a name="1374"/> 1374:                    ok = api_b_open_and_close(InitState)
<a name="1375"/> 1375:            end).
<a name="1376"/> 1376: 
<a name="1377"/> 1377: 
<a name="1378"/> 1378: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1379"/> 1379: 
<a name="1380"/> 1380: <i>%% Basically open (create) and close an IPv4 SCTP (stream) socket.</i>
<a name="1381"/> 1381: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_stream_sctp4-1"/><a name="1382"/> 1382: <b>api_b_open_and_close_stream_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1383"/> 1383:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_stream_sctp4-last_expr"/><a name="1384"/> 1384: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1385"/> 1385:            fun() -&gt; has_support_sctp() end,
<a name="1386"/> 1386:            fun() -&gt;
<a name="1387"/> 1387:                    InitState = #{domain   =&gt; inet,
<a name="1388"/> 1388:                                  type     =&gt; stream,
<a name="1389"/> 1389:                                  protocol =&gt; sctp},
<a name="1390"/> 1390:                    ok = api_b_open_and_close(InitState)
<a name="1391"/> 1391:            end).
<a name="1392"/> 1392: 
<a name="1393"/> 1393: 
<a name="1394"/> 1394: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1395"/> 1395: 
<a name="1396"/> 1396: <i>%% Basically open (create) and close an IPv6 SCTP (stream) socket.</i>
<a name="1397"/> 1397: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_stream_sctp6-1"/><a name="1398"/> 1398: <b>api_b_open_and_close_stream_sctp6</b>(_Config) when is_list(_Config) -&gt;
<a name="1399"/> 1399:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_stream_sctp6-last_expr"/><a name="1400"/> 1400: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1401"/> 1401:            fun() -&gt;
<a name="1402"/> 1402:                    has_support_sctp(),
<a name="1403"/> 1403:                    has_support_ipv6()
<a name="1404"/> 1404:            end,
<a name="1405"/> 1405:            fun() -&gt;
<a name="1406"/> 1406:                    InitState = #{domain   =&gt; inet6,
<a name="1407"/> 1407:                                  type     =&gt; stream,
<a name="1408"/> 1408:                                  protocol =&gt; sctp},
<a name="1409"/> 1409:                    ok = api_b_open_and_close(InitState)
<a name="1410"/> 1410:            end).
<a name="1411"/> 1411: 
<a name="1412"/> 1412: 
<a name="1413"/> 1413: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1414"/> 1414: 
<a name="api_b_open_and_close-1"/><a name="1415"/> 1415: <b>api_b_open_and_close</b>(InitState) -&gt;
<a name="1416"/> 1416:     Seq = 
<a name="1417"/> 1417:         [
<a name="1418"/> 1418:          #{desc =&gt; &quot;open&quot;,
<a name="1419"/> 1419:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1420"/> 1420:                          type     := Type,
<a name="1421"/> 1421:                          protocol := Protocol} = S) -&gt; 
<a name="1422"/> 1422:                            Res = socket:open(Domain, Type, Protocol), 
<a name="1423"/> 1423:                            {ok, {S, Res}} 
<a name="1424"/> 1424:                    end},
<a name="1425"/> 1425:          #{desc =&gt; &quot;validate open&quot;,
<a name="1426"/> 1426:            cmd  =&gt; fun({S, {ok, Sock}}) -&gt; 
<a name="1427"/> 1427:                            NewS = S#{socket =&gt; Sock},
<a name="1428"/> 1428:                            {ok, NewS};
<a name="1429"/> 1429:                       ({_, {error, epfnosupport = Reason}}) -&gt;
<a name="1430"/> 1430:                            {skip, Reason};
<a name="1431"/> 1431:                       ({_, {error, eprotonosupport = Reason}}) -&gt;
<a name="1432"/> 1432:                            {skip, Reason};
<a name="1433"/> 1433:                       ({_, {error, esocktnosupport = Reason}}) -&gt;
<a name="1434"/> 1434:                            {skip, Reason};
<a name="1435"/> 1435:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1436"/> 1436:                            ERROR
<a name="1437"/> 1437:                    end},
<a name="1438"/> 1438:          #{desc =&gt; &quot;get domain (maybe)&quot;,
<a name="1439"/> 1439:            cmd  =&gt; fun(#{socket := Sock} = S) -&gt;
<a name="1440"/> 1440:                            Res = socket:getopt(Sock, socket, domain),
<a name="1441"/> 1441:                            {ok, {S, Res}}
<a name="1442"/> 1442:                    end},
<a name="1443"/> 1443:          #{desc =&gt; &quot;validate domain (maybe)&quot;,
<a name="1444"/> 1444:            cmd  =&gt; fun({#{domain := Domain} = S, {ok, Domain}}) -&gt; 
<a name="1445"/> 1445:                            ?SEV_IPRINT(&quot;expected domain: ~p&quot;, [Domain]),
<a name="1446"/> 1446:                            {ok, S};
<a name="1447"/> 1447:                       ({#{domain := ExpDomain}, {ok, Domain}}) -&gt;
<a name="1448"/> 1448:                            {error, {unexpected_domain, ExpDomain, Domain}};
<a name="1449"/> 1449:                       %% Some platforms do not support this option
<a name="1450"/> 1450:                       ({S, {error, {invalid, _}} = ERROR}) -&gt;
<a name="1451"/> 1451:                            case
<a name="1452"/> 1452:                                socket:is_supported(options, socket, domain)
<a name="1453"/> 1453:                            of
<a name="1454"/> 1454:                                true -&gt;
<a name="1455"/> 1455:                                    ERROR;
<a name="1456"/> 1456:                                false -&gt;
<a name="1457"/> 1457:                                    ?SEV_IPRINT(&quot;socket option 'domain' &quot;
<a name="1458"/> 1458:                                                &quot;not supported&quot;),
<a name="1459"/> 1459:                                    {ok, S}
<a name="1460"/> 1460:                            end;
<a name="1461"/> 1461:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1462"/> 1462:                            ERROR
<a name="1463"/> 1463:                    end},
<a name="1464"/> 1464:          #{desc =&gt; &quot;get type&quot;,
<a name="1465"/> 1465:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1466"/> 1466:                            Res = socket:getopt(Sock, socket, type), 
<a name="1467"/> 1467:                            {ok, {State, Res}}
<a name="1468"/> 1468:                    end},
<a name="1469"/> 1469:          #{desc =&gt; &quot;validate type&quot;,
<a name="1470"/> 1470:            cmd  =&gt; fun({#{type := Type} = State, {ok, Type}}) -&gt;
<a name="1471"/> 1471:                            ?SEV_IPRINT(&quot;expected type: ~p&quot;, [Type]),
<a name="1472"/> 1472:                            {ok, State};
<a name="1473"/> 1473:                       ({#{type := ExpType}, {ok, Type}}) -&gt;
<a name="1474"/> 1474:                            {error, {unexpected_type, ExpType, Type}};
<a name="1475"/> 1475:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1476"/> 1476:                            ERROR
<a name="1477"/> 1477:                    end},
<a name="1478"/> 1478:          #{desc =&gt; &quot;get protocol (maybe)&quot;,
<a name="1479"/> 1479:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1480"/> 1480:                            Res = socket:getopt(Sock, socket, protocol),
<a name="1481"/> 1481:                            {ok, {State, Res}}
<a name="1482"/> 1482:                    end},
<a name="1483"/> 1483:          #{desc =&gt; &quot;validate protocol&quot;,
<a name="1484"/> 1484:            cmd  =&gt; fun({#{protocol := Protocol} = State, {ok, Protocol}}) -&gt;
<a name="1485"/> 1485:                            ?SEV_IPRINT(&quot;expected protocol: ~p&quot;, [Protocol]),
<a name="1486"/> 1486:                            {ok, State};
<a name="1487"/> 1487:                       ({#{domain   := Domain,
<a name="1488"/> 1488: 			  protocol := ExpProtocol}, {ok, Protocol}}) -&gt;
<a name="1489"/> 1489: 			   %% On OpenBSD (at least 6.6) something screwy happens
<a name="1490"/> 1490: 			   %% when domain = local.
<a name="1491"/> 1491: 			   %% It will report a completely different protocol
<a name="1492"/> 1492: 			   %% (icmp) but everything still works.
<a name="1493"/> 1493:                            %% So we skip if this happens on OpenBSD...
<a name="1494"/> 1494: 			   case os:type() of
<a name="1495"/> 1495: 			       {unix, openbsd} when (Domain =:= local) -&gt;
<a name="1496"/> 1496: 				   {skip, ?F(&quot;Unexpected protocol: ~p instead of ~p&quot;,
<a name="1497"/> 1497: 					     [Protocol, ExpProtocol])};
<a name="1498"/> 1498: 			       _ -&gt;
<a name="1499"/> 1499: 				   {error, {unexpected_protocol,
<a name="1500"/> 1500: 					    ExpProtocol, Protocol}}
<a name="1501"/> 1501: 			   end;
<a name="1502"/> 1502:                       %% Some platforms do not support this option
<a name="1503"/> 1503:                       ({State, {error, {invalid, _}} = ERROR}) -&gt;
<a name="1504"/> 1504: 			   case socket:is_supported(options, socket, protocol) of
<a name="1505"/> 1505: 			       true -&gt;
<a name="1506"/> 1506:                                    ERROR;
<a name="1507"/> 1507: 			       false -&gt;
<a name="1508"/> 1508:                                    ?SEV_IPRINT(&quot;socket option 'protocol' &quot;
<a name="1509"/> 1509:                                                &quot;not supported&quot;),
<a name="1510"/> 1510:                                    {ok, State}
<a name="1511"/> 1511: 			   end;
<a name="1512"/> 1512:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1513"/> 1513:                            ERROR
<a name="1514"/> 1514:                    end},
<a name="1515"/> 1515:          #{desc =&gt; &quot;get controlling-process&quot;,
<a name="1516"/> 1516:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1517"/> 1517:                            Res = socket:getopt(Sock, otp, controlling_process),
<a name="1518"/> 1518:                            {ok, {State, Res}}
<a name="1519"/> 1519:                    end},
<a name="1520"/> 1520:          #{desc =&gt; &quot;validate controlling-process&quot;,
<a name="1521"/> 1521:            cmd  =&gt; fun({State, {ok, Pid}}) -&gt;
<a name="1522"/> 1522:                            case self() of
<a name="1523"/> 1523:                                Pid -&gt;
<a name="1524"/> 1524:                                    {ok, State};
<a name="1525"/> 1525:                                _ -&gt;
<a name="1526"/> 1526:                                    {error, {unexpected_owner, Pid}}
<a name="1527"/> 1527:                            end;
<a name="1528"/> 1528:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1529"/> 1529:                            ERROR
<a name="1530"/> 1530:                    end},
<a name="1531"/> 1531:          #{desc =&gt; &quot;close socket&quot;,
<a name="1532"/> 1532:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1533"/> 1533:                            Res = socket:close(Sock),
<a name="1534"/> 1534:                            {ok, {State, Res}}
<a name="1535"/> 1535:                    end},
<a name="1536"/> 1536:          #{desc =&gt; &quot;validate socket close&quot;,
<a name="1537"/> 1537:            cmd  =&gt; fun({_, ok}) -&gt;
<a name="1538"/> 1538:                            ok;
<a name="1539"/> 1539:                       ({_, {error, _} = ERROR}) -&gt;
<a name="1540"/> 1540:                            ERROR
<a name="1541"/> 1541:                    end},
<a name="1542"/> 1542: 
<a name="1543"/> 1543:          %% *** We are done ***
<a name="1544"/> 1544:          ?SEV_FINISH_NORMAL
<a name="1545"/> 1545:         ],
<a name="1546"/> 1546:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_open_and_close-last_expr"/><a name="1547"/> 1547: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1548"/> 1548: 
<a name="1549"/> 1549: 
<a name="1550"/> 1550: 
<a name="1551"/> 1551: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1552"/> 1552: 
<a name="1553"/> 1553: <i>%% Basically open (create) and (maybe) close an RAW socket.</i>
<a name="1554"/> 1554: 
<a name="api_b_open_and_maybe_close_raw-1"/><a name="1555"/> 1555: <b>api_b_open_and_maybe_close_raw</b>(_Config) when is_list(_Config) -&gt;
<a name="1556"/> 1556:     ?TT(?SECS(5)),
<a name="api_b_open_and_maybe_close_raw-last_expr"/><a name="1557"/> 1557: <b>    tc_try</b>(api_b_open_and_maybe_close_raw,
<a name="1558"/> 1558:            fun() -&gt;
<a name="1559"/> 1559:                    InitState = #{domain   =&gt; inet,
<a name="1560"/> 1560:                                  type     =&gt; raw,
<a name="1561"/> 1561:                                  protocol =&gt; {raw, 255}},
<a name="1562"/> 1562:                    ok = do_api_b_open_and_maybe_close_raw(InitState)
<a name="1563"/> 1563:            end).
<a name="1564"/> 1564: 
<a name="do_api_b_open_and_maybe_close_raw-1"/><a name="1565"/> 1565: <b>do_api_b_open_and_maybe_close_raw</b>(InitState) -&gt;
<a name="1566"/> 1566:     Tester = 
<a name="1567"/> 1567:         [
<a name="1568"/> 1568:          #{desc =&gt; &quot;open&quot;,
<a name="1569"/> 1569:            cmd  =&gt; fun(#{domain   := Domain,
<a name="1570"/> 1570:                          type     := Type,
<a name="1571"/> 1571:                          protocol := Protocol} = State) -&gt; 
<a name="1572"/> 1572:                            ?SEV_IPRINT(&quot;try open with:&quot;
<a name="1573"/> 1573:                                        &quot;~n   Domain:   ~p&quot;
<a name="1574"/> 1574:                                        &quot;~n   Type:     ~p&quot;
<a name="1575"/> 1575:                                        &quot;~n   Protocol: ~p&quot;,
<a name="1576"/> 1576:                                        [Domain, Type, Protocol]),
<a name="1577"/> 1577:                            case socket:open(Domain, Type, Protocol) of
<a name="1578"/> 1578:                                {ok, Sock} -&gt;
<a name="1579"/> 1579:                                    {ok, State#{sock =&gt; Sock}};
<a name="1580"/> 1580:                                {error, Reason} when (Reason =:= eperm) orelse
<a name="1581"/> 1581:                                                     (Reason =:= eacces) -&gt;
<a name="1582"/> 1582:                                    ?SEV_IPRINT(&quot;not allowed (~w) =&gt; SKIP&quot;,
<a name="1583"/> 1583:                                                [Reason]),
<a name="1584"/> 1584:                                    {skip, Reason};
<a name="1585"/> 1585:                                {error, Reason} = ERROR -&gt;
<a name="1586"/> 1586:                                    ?SEV_EPRINT(&quot;open failed:&quot;
<a name="1587"/> 1587:                                                &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="1588"/> 1588:                                    ERROR
<a name="1589"/> 1589:                            end
<a name="1590"/> 1590:                    end},
<a name="1591"/> 1591:          #{desc =&gt; &quot;close socket&quot;,
<a name="1592"/> 1592:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="1593"/> 1593:                            ?SEV_IPRINT(&quot;try socket close&quot;),
<a name="1594"/> 1594:                            case socket:close(Sock) of
<a name="1595"/> 1595:                                ok -&gt;
<a name="1596"/> 1596:                                    ?SEV_IPRINT(&quot;socket closed&quot;),
<a name="1597"/> 1597:                                    {ok, maps:remote(sock, State)};
<a name="1598"/> 1598:                                {error, Reason} = ERROR -&gt;
<a name="1599"/> 1599:                                    ?SEV_EPRINT(&quot;close failed:&quot;
<a name="1600"/> 1600:                                                &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="1601"/> 1601:                                    ERROR
<a name="1602"/> 1602:                            end
<a name="1603"/> 1603:                    end},
<a name="1604"/> 1604: 
<a name="1605"/> 1605:          %% *** We are done ***
<a name="1606"/> 1606:          ?SEV_FINISH_NORMAL
<a name="1607"/> 1607:         ],
<a name="1608"/> 1608:     Evaluator = ?SEV_START(&quot;tester&quot;, Tester, InitState),
<a name="do_api_b_open_and_maybe_close_raw-last_expr"/><a name="1609"/> 1609: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1610"/> 1610: 
<a name="1611"/> 1611: 
<a name="1612"/> 1612: 
<a name="1613"/> 1613: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1614"/> 1614: 
<a name="1615"/> 1615: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="1616"/> 1616: <i>%% sendto and recvfrom..</i>
<a name="api_b_sendto_and_recvfrom_udp4-1"/><a name="1617"/> 1617: <b>api_b_sendto_and_recvfrom_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1618"/> 1618:     ?TT(?SECS(5)),
<a name="api_b_sendto_and_recvfrom_udp4-last_expr"/><a name="1619"/> 1619: <b>    tc_try</b>(api_b_sendto_and_recvfrom_udp4,
<a name="1620"/> 1620:            fun() -&gt; has_support_ipv4() end,
<a name="1621"/> 1621:            fun() -&gt;
<a name="1622"/> 1622:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="1623"/> 1623:                                   socket:sendto(Sock, Data, Dest)
<a name="1624"/> 1624:                           end,
<a name="1625"/> 1625:                    Recv = fun(Sock) -&gt;
<a name="1626"/> 1626:                                   socket:recvfrom(Sock)
<a name="1627"/> 1627:                           end,
<a name="1628"/> 1628:                    InitState = #{domain =&gt; inet,
<a name="1629"/> 1629:                                  proto  =&gt; udp,
<a name="1630"/> 1630:                                  send   =&gt; Send,
<a name="1631"/> 1631:                                  recv   =&gt; Recv},
<a name="1632"/> 1632:                    ok = api_b_send_and_recv_udp(InitState)
<a name="1633"/> 1633:            end).
<a name="1634"/> 1634: 
<a name="1635"/> 1635: 
<a name="1636"/> 1636: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1637"/> 1637: 
<a name="1638"/> 1638: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="1639"/> 1639: <i>%% sendto and recvfrom.</i>
<a name="api_b_sendto_and_recvfrom_udpL-1"/><a name="1640"/> 1640: <b>api_b_sendto_and_recvfrom_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1641"/> 1641:     ?TT(?SECS(5)),
<a name="api_b_sendto_and_recvfrom_udpL-last_expr"/><a name="1642"/> 1642: <b>    tc_try</b>(api_b_sendto_and_recvfrom_udpL,
<a name="1643"/> 1643:            fun() -&gt;
<a name="1644"/> 1644:                    has_support_unix_domain_socket(),
<a name="1645"/> 1645: 		   is_not_windows(),
<a name="1646"/> 1646:                    unix_domain_socket_host_cond()
<a name="1647"/> 1647:            end,
<a name="1648"/> 1648:            fun() -&gt;
<a name="1649"/> 1649:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="1650"/> 1650:                                   socket:sendto(Sock, Data, Dest)
<a name="1651"/> 1651:                           end,
<a name="1652"/> 1652:                    Recv = fun(Sock) -&gt;
<a name="1653"/> 1653:                                   socket:recvfrom(Sock)
<a name="1654"/> 1654:                           end,
<a name="1655"/> 1655:                    InitState = #{domain =&gt; local,
<a name="1656"/> 1656:                                  proto  =&gt; default,
<a name="1657"/> 1657:                                  send   =&gt; Send,
<a name="1658"/> 1658:                                  recv   =&gt; Recv},
<a name="1659"/> 1659:                    ok = api_b_send_and_recv_udp(InitState)
<a name="1660"/> 1660:            end).
<a name="1661"/> 1661: 
<a name="1662"/> 1662: 
<a name="1663"/> 1663: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1664"/> 1664: 
<a name="1665"/> 1665: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket</i>
<a name="1666"/> 1666: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_udp4-1"/><a name="1667"/> 1667: <b>api_b_sendmsg_and_recvmsg_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1668"/> 1668:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_udp4-last_expr"/><a name="1669"/> 1669: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_udp4,
<a name="1670"/> 1670:            fun() -&gt; has_support_ipv4() end,
<a name="1671"/> 1671:            fun() -&gt;
<a name="1672"/> 1672:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="1673"/> 1673:                                   %% We need tests for this,
<a name="1674"/> 1674:                                   %% but this is not the place it.
<a name="1675"/> 1675:                                   %% CMsg  = #{level =&gt; ip,
<a name="1676"/> 1676:                                   %%              type  =&gt; tos,
<a name="1677"/> 1677:                                   %%              data  =&gt; reliability},
<a name="1678"/> 1678:                                   %% CMsgs = [CMsg],
<a name="1679"/> 1679:                                   Msg = #{addr =&gt; Dest,
<a name="1680"/> 1680:                                              %% ctrl =&gt; CMsgs,
<a name="1681"/> 1681:                                              iov  =&gt; [Data]},
<a name="1682"/> 1682:                                   socket:sendmsg(Sock, Msg)
<a name="1683"/> 1683:                           end,
<a name="1684"/> 1684:                    Recv = fun(Sock) -&gt;
<a name="1685"/> 1685:                                   %% We have some issues on old darwin...
<a name="1686"/> 1686:                                   %% ok = socket:setopt(Sock, {otp,debug}, true),
<a name="1687"/> 1687:                                   case socket:recvmsg(Sock) of
<a name="1688"/> 1688:                                       {ok, #{addr  := Source,
<a name="1689"/> 1689:                                              iov   := [Data]}} -&gt;
<a name="1690"/> 1690:                                           %% socket:setopt(Sock, otp, debug, false),
<a name="1691"/> 1691:                                           {ok, {Source, Data}};
<a name="1692"/> 1692:                                       {error, _} = ERROR -&gt;
<a name="1693"/> 1693:                                           ERROR
<a name="1694"/> 1694:                                   end
<a name="1695"/> 1695:                           end,
<a name="1696"/> 1696:                    InitState = #{domain =&gt; inet,
<a name="1697"/> 1697:                                  proto  =&gt; udp,
<a name="1698"/> 1698:                                  send   =&gt; Send,
<a name="1699"/> 1699:                                  recv   =&gt; Recv},
<a name="1700"/> 1700:                    ok = api_b_send_and_recv_udp(InitState)
<a name="1701"/> 1701:            end).
<a name="1702"/> 1702: 
<a name="1703"/> 1703: 
<a name="1704"/> 1704: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1705"/> 1705: 
<a name="1706"/> 1706: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket</i>
<a name="1707"/> 1707: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_udpL-1"/><a name="1708"/> 1708: <b>api_b_sendmsg_and_recvmsg_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1709"/> 1709:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_udpL-last_expr"/><a name="1710"/> 1710: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_udpL,
<a name="1711"/> 1711:            fun() -&gt;
<a name="1712"/> 1712:                    has_support_unix_domain_socket(),
<a name="1713"/> 1713: 		   is_not_windows(),
<a name="1714"/> 1714:                    unix_domain_socket_host_cond()
<a name="1715"/> 1715:            end,
<a name="1716"/> 1716:            fun() -&gt;
<a name="1717"/> 1717:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="1718"/> 1718:                                   %% We need tests for this,
<a name="1719"/> 1719:                                   %% but this is not the place it.
<a name="1720"/> 1720:                                   %% CMsg  = #{level =&gt; ip,
<a name="1721"/> 1721:                                   %%              type  =&gt; tos,
<a name="1722"/> 1722:                                   %%              data  =&gt; reliability},
<a name="1723"/> 1723:                                   %% CMsgs = [CMsg],
<a name="1724"/> 1724:                                   Msg = #{addr =&gt; Dest,
<a name="1725"/> 1725:                                              %% ctrl =&gt; CMsgs,
<a name="1726"/> 1726:                                              iov  =&gt; [Data]},
<a name="1727"/> 1727:                                   socket:sendmsg(Sock, Msg)
<a name="1728"/> 1728:                           end,
<a name="1729"/> 1729:                    Recv = fun(Sock) -&gt;
<a name="1730"/> 1730:                                   %% We have some issues on old darwing...
<a name="1731"/> 1731:                                   %% socket:setopt(Sock, otp, debug, true),
<a name="1732"/> 1732:                                   case socket:recvmsg(Sock) of
<a name="1733"/> 1733:                                       {ok, #{addr  := Source,
<a name="1734"/> 1734:                                              iov   := [Data]}} -&gt;
<a name="1735"/> 1735:                                           %% socket:setopt(Sock, otp, debug, false),
<a name="1736"/> 1736:                                           {ok, {Source, Data}};
<a name="1737"/> 1737:                                       {error, _} = ERROR -&gt;
<a name="1738"/> 1738:                                           ERROR
<a name="1739"/> 1739:                                   end
<a name="1740"/> 1740:                           end,
<a name="1741"/> 1741:                    InitState = #{domain =&gt; local,
<a name="1742"/> 1742:                                  proto  =&gt; default,
<a name="1743"/> 1743:                                  send   =&gt; Send,
<a name="1744"/> 1744:                                  recv   =&gt; Recv},
<a name="1745"/> 1745:                    ok = api_b_send_and_recv_udp(InitState)
<a name="1746"/> 1746:            end).
<a name="1747"/> 1747: 
<a name="1748"/> 1748: 
<a name="1749"/> 1749: 
<a name="1750"/> 1750: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1751"/> 1751: 
<a name="api_b_send_and_recv_udp-1"/><a name="1752"/> 1752: <b>api_b_send_and_recv_udp</b>(InitState) -&gt;
<a name="1753"/> 1753:     Seq = 
<a name="1754"/> 1754:         [
<a name="1755"/> 1755:          #{desc =&gt; &quot;local address&quot;,
<a name="1756"/> 1756:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="1757"/> 1757:                            LSASrc = which_local_socket_addr(Domain),
<a name="1758"/> 1758:                            LSADst = which_local_socket_addr(Domain),
<a name="1759"/> 1759:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="1760"/> 1760:                                        lsa_dst =&gt; LSADst}};
<a name="1761"/> 1761:                       (#{domain := Domain} = State) -&gt;
<a name="1762"/> 1762:                            LSA = which_local_socket_addr(Domain),
<a name="1763"/> 1763:                            {ok, State#{lsa_src =&gt; LSA,
<a name="1764"/> 1764:                                        lsa_dst =&gt; LSA}}
<a name="1765"/> 1765:                    end},
<a name="1766"/> 1766: 
<a name="1767"/> 1767:          #{desc =&gt; &quot;open src socket&quot;,
<a name="1768"/> 1768:            cmd  =&gt; fun(#{domain := Domain,
<a name="1769"/> 1769:                          proto  := Proto} = State) -&gt;
<a name="1770"/> 1770:                            Sock = sock_open(Domain, dgram, Proto),
<a name="1771"/> 1771:                            {ok, State#{sock_src =&gt; Sock}}
<a name="1772"/> 1772:                    end},
<a name="1773"/> 1773:          #{desc =&gt; &quot;bind src socket&quot;,
<a name="1774"/> 1774:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="1775"/> 1775:                            case sock_bind(Sock, LSA) of
<a name="1776"/> 1776:                                ok -&gt;
<a name="1777"/> 1777:                                    Port = sock_port(Sock),
<a name="1778"/> 1778:                                    ?SEV_IPRINT(&quot;src bound (to ~p)&quot;, [Port]),
<a name="1779"/> 1779:                                    ok;
<a name="1780"/> 1780:                                {error, Reason} = ERROR -&gt;
<a name="1781"/> 1781:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="1782"/> 1782:                                    ERROR
<a name="1783"/> 1783:                            end
<a name="1784"/> 1784:                    end},
<a name="1785"/> 1785:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="1786"/> 1786:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="1787"/> 1787:                            SASrc = sock_sockname(Sock),
<a name="1788"/> 1788:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="1789"/> 1789:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="1790"/> 1790:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="1791"/> 1791:                    end},
<a name="1792"/> 1792: 
<a name="1793"/> 1793:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="1794"/> 1794:            cmd  =&gt; fun(#{domain := Domain,
<a name="1795"/> 1795:                          proto  := Proto} = State) -&gt;
<a name="1796"/> 1796:                            Sock = sock_open(Domain, dgram, Proto),
<a name="1797"/> 1797:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="1798"/> 1798:                    end},
<a name="1799"/> 1799:          #{desc =&gt; &quot;bind dst socket&quot;,
<a name="1800"/> 1800:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="1801"/> 1801:                            case sock_bind(Sock, LSA) of
<a name="1802"/> 1802:                                ok -&gt;
<a name="1803"/> 1803:                                    Port = sock_port(Sock),
<a name="1804"/> 1804:                                    ?SEV_IPRINT(&quot;src bound (to ~p)&quot;, [Port]),
<a name="1805"/> 1805:                                    ok;
<a name="1806"/> 1806:                                {error, Reason} = ERROR -&gt;
<a name="1807"/> 1807:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="1808"/> 1808:                                    ERROR
<a name="1809"/> 1809:                            end
<a name="1810"/> 1810:                    end},
<a name="1811"/> 1811:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="1812"/> 1812:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="1813"/> 1813:                            SADst = sock_sockname(Sock),
<a name="1814"/> 1814:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="1815"/> 1815:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="1816"/> 1816:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="1817"/> 1817:                    end},
<a name="1818"/> 1818:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="1819"/> 1819:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="1820"/> 1820:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="1821"/> 1821:                    end},
<a name="1822"/> 1822:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="1823"/> 1823:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="1824"/> 1824:                            case Recv(Sock) of
<a name="1825"/> 1825:                                {ok, {Src, ?BASIC_REQ}} -&gt;
<a name="1826"/> 1826:                                    ok;
<a name="1827"/> 1827:                                {ok, UnexpData} -&gt;
<a name="1828"/> 1828:                                    {error, {unexpected_data, UnexpData}};
<a name="1829"/> 1829:                                {error, _} = ERROR -&gt;
<a name="1830"/> 1830:                                    %% At the moment there is no way to get
<a name="1831"/> 1831:                                    %% status or state for the socket...
<a name="1832"/> 1832:                                    ERROR
<a name="1833"/> 1833:                            end
<a name="1834"/> 1834:                    end},
<a name="1835"/> 1835:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="1836"/> 1836:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="1837"/> 1837:                            Send(Sock, ?BASIC_REP, Src)
<a name="1838"/> 1838:                    end},
<a name="1839"/> 1839:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="1840"/> 1840:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="1841"/> 1841:                            case Recv(Sock) of
<a name="1842"/> 1842:                                {ok, {Dst, ?BASIC_REP}} -&gt;
<a name="1843"/> 1843:                                    ok;
<a name="1844"/> 1844:                                {ok, UnexpData} -&gt;
<a name="1845"/> 1845:                                    {error, {unexpected_data, UnexpData}};
<a name="1846"/> 1846:                                {error, _} = ERROR -&gt;
<a name="1847"/> 1847:                                    %% At the moment there is no way to get
<a name="1848"/> 1848:                                    %% status or state for the socket...
<a name="1849"/> 1849:                                    ERROR
<a name="1850"/> 1850:                            end
<a name="1851"/> 1851:                    end},
<a name="1852"/> 1852:          #{desc =&gt; &quot;close src socket&quot;,
<a name="1853"/> 1853:            cmd  =&gt; fun(#{domain   := local,
<a name="1854"/> 1854:                          sock_src := Sock,
<a name="1855"/> 1855:                          lsa_src  := #{path := Path}} = State) -&gt;
<a name="1856"/> 1856:                            ok = socket:close(Sock),
<a name="1857"/> 1857:                            State1 =
<a name="1858"/> 1858:                                unlink_path(Path,
<a name="1859"/> 1859:                                            fun() -&gt; maps:remove(lsa_src, State) end,
<a name="1860"/> 1860:                                            fun() -&gt; State end),
<a name="1861"/> 1861:                            {ok, maps:remove(sock_src, State1)};
<a name="1862"/> 1862:                       (#{sock_src := Sock} = State) -&gt;
<a name="1863"/> 1863:                            ok = socket:close(Sock),
<a name="1864"/> 1864:                            {ok, maps:remove(sock_src, State)}
<a name="1865"/> 1865:                    end},
<a name="1866"/> 1866:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="1867"/> 1867:            cmd  =&gt; fun(#{domain   := local,
<a name="1868"/> 1868:                          sock_dst := Sock,
<a name="1869"/> 1869:                          lsa_dst  := #{path := Path}} = State) -&gt;
<a name="1870"/> 1870:                            ok = socket:close(Sock),
<a name="1871"/> 1871:                            State1 =
<a name="1872"/> 1872:                                unlink_path(Path,
<a name="1873"/> 1873:                                            fun() -&gt; maps:remove(lsa_dst, State) end,
<a name="1874"/> 1874:                                            fun() -&gt; State end),
<a name="1875"/> 1875:                            {ok, maps:remove(sock_dst, State1)};
<a name="1876"/> 1876:                       (#{sock_dst := Sock} = State) -&gt;
<a name="1877"/> 1877:                            ok = socket:close(Sock),
<a name="1878"/> 1878:                            {ok, maps:remove(sock_dst, State)}
<a name="1879"/> 1879:                    end},
<a name="1880"/> 1880: 
<a name="1881"/> 1881:          %% *** We are done ***
<a name="1882"/> 1882:          ?SEV_FINISH_NORMAL
<a name="1883"/> 1883:         ],
<a name="1884"/> 1884:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_send_and_recv_udp-last_expr"/><a name="1885"/> 1885: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="1886"/> 1886: 
<a name="1887"/> 1887: 
<a name="1888"/> 1888: 
<a name="1889"/> 1889: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1890"/> 1890: 
<a name="1891"/> 1891: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="1892"/> 1892: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_b_send_and_recv_tcp4-1"/><a name="1893"/> 1893: <b>api_b_send_and_recv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1894"/> 1894:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_tcp4-last_expr"/><a name="1895"/> 1895: <b>    tc_try</b>(api_b_send_and_recv_tcp4,
<a name="1896"/> 1896:            fun() -&gt; has_support_ipv4() end,
<a name="1897"/> 1897:            fun() -&gt;
<a name="1898"/> 1898:                    Send = fun(Sock, Data) -&gt;
<a name="1899"/> 1899:                                   socket:send(Sock, Data)
<a name="1900"/> 1900:                           end,
<a name="1901"/> 1901:                    Recv = fun(Sock) -&gt;
<a name="1902"/> 1902:                                   socket:recv(Sock)
<a name="1903"/> 1903:                           end,
<a name="1904"/> 1904:                    InitState = #{domain =&gt; inet,
<a name="1905"/> 1905:                                  type   =&gt; stream,
<a name="1906"/> 1906:                                  proto  =&gt; tcp,
<a name="1907"/> 1907:                                  send   =&gt; Send,
<a name="1908"/> 1908:                                  recv   =&gt; Recv},
<a name="1909"/> 1909:                    ok = api_b_send_and_recv_conn(InitState)
<a name="1910"/> 1910:            end).
<a name="1911"/> 1911: 
<a name="1912"/> 1912: 
<a name="1913"/> 1913: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1914"/> 1914: 
<a name="1915"/> 1915: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="1916"/> 1916: <i>%% on an IPv4 SCTP (stream) socket.</i>
<a name="api_b_send_and_recv_stream_sctp4-1"/><a name="1917"/> 1917: <b>api_b_send_and_recv_stream_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1918"/> 1918:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_stream_sctp4-last_expr"/><a name="1919"/> 1919: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1920"/> 1920:            fun() -&gt;
<a name="1921"/> 1921:                    has_support_sctp(),
<a name="1922"/> 1922:                    has_support_ipv4()
<a name="1923"/> 1923:            end,
<a name="1924"/> 1924:            fun() -&gt;
<a name="1925"/> 1925:                    Send = fun(Sock, Data) -&gt;
<a name="1926"/> 1926:                                   socket:send(Sock, Data)
<a name="1927"/> 1927:                           end,
<a name="1928"/> 1928:                    Recv = fun(Sock) -&gt;
<a name="1929"/> 1929:                                   socket:recv(Sock)
<a name="1930"/> 1930:                           end,
<a name="1931"/> 1931:                    InitState = #{domain =&gt; inet,
<a name="1932"/> 1932:                                  type   =&gt; stream,
<a name="1933"/> 1933:                                  proto  =&gt; sctp,
<a name="1934"/> 1934:                                  send   =&gt; Send,
<a name="1935"/> 1935:                                  recv   =&gt; Recv},
<a name="1936"/> 1936:                    ok = api_b_send_and_recv_conn(InitState)
<a name="1937"/> 1937:            end).
<a name="1938"/> 1938: 
<a name="1939"/> 1939: 
<a name="1940"/> 1940: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1941"/> 1941: 
<a name="1942"/> 1942: <i>%% Basically send and receive using the sendv and recv functions</i>
<a name="1943"/> 1943: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_b_sendv_and_recv_tcp4-1"/><a name="1944"/> 1944: <b>api_b_sendv_and_recv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="1945"/> 1945:     ?TT(?SECS(10)),
<a name="api_b_sendv_and_recv_tcp4-last_expr"/><a name="1946"/> 1946: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="1947"/> 1947:            fun() -&gt; has_support_ipv4() end,
<a name="1948"/> 1948:            fun() -&gt;
<a name="1949"/> 1949:                    Send = fun(Sock, Data) -&gt;
<a name="1950"/> 1950:                                   %% Since we are just reusing this test case,
<a name="1951"/> 1951:                                   %% the I/O vector is just one binary.
<a name="1952"/> 1952:                                   %% _ = socket:setopt(Sock, otp, debug, true),
<a name="1953"/> 1953:                                   Res = socket:sendv(Sock, [Data]),
<a name="1954"/> 1954:                                   %% _ = socket:setopt(Sock, otp, debug, false),
<a name="1955"/> 1955:                                   Res
<a name="1956"/> 1956:                           end,
<a name="1957"/> 1957:                    Recv = fun(Sock) -&gt;
<a name="1958"/> 1958:                                   socket:recv(Sock)
<a name="1959"/> 1959:                           end,
<a name="1960"/> 1960:                    InitState = #{domain =&gt; inet,
<a name="1961"/> 1961:                                  type   =&gt; stream,
<a name="1962"/> 1962:                                  proto  =&gt; tcp,
<a name="1963"/> 1963:                                  send   =&gt; Send,
<a name="1964"/> 1964:                                  recv   =&gt; Recv},
<a name="1965"/> 1965:                    ok = api_b_send_and_recv_conn(InitState)
<a name="1966"/> 1966:            end).
<a name="1967"/> 1967: 
<a name="1968"/> 1968: 
<a name="1969"/> 1969: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1970"/> 1970: 
<a name="1971"/> 1971: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="1972"/> 1972: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_send_and_recv_tcpL-1"/><a name="1973"/> 1973: <b>api_b_send_and_recv_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1974"/> 1974:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_tcpL-last_expr"/><a name="1975"/> 1975: <b>    tc_try</b>(api_b_send_and_recv_tcpL,
<a name="1976"/> 1976:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="1977"/> 1977:            fun() -&gt;
<a name="1978"/> 1978:                    Send = fun(Sock, Data) -&gt;
<a name="1979"/> 1979:                                   socket:send(Sock, Data)
<a name="1980"/> 1980:                           end,
<a name="1981"/> 1981:                    Recv = fun(Sock) -&gt;
<a name="1982"/> 1982:                                   socket:recv(Sock)
<a name="1983"/> 1983:                           end,
<a name="1984"/> 1984:                    InitState = #{domain =&gt; local,
<a name="1985"/> 1985:                                  type   =&gt; stream,
<a name="1986"/> 1986:                                  proto  =&gt; default,
<a name="1987"/> 1987:                                  send   =&gt; Send,
<a name="1988"/> 1988:                                  recv   =&gt; Recv},
<a name="1989"/> 1989:                    ok = api_b_send_and_recv_conn(InitState)
<a name="1990"/> 1990:            end).
<a name="1991"/> 1991: 
<a name="1992"/> 1992: 
<a name="1993"/> 1993: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1994"/> 1994: 
<a name="1995"/> 1995: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="1996"/> 1996: <i>%% on an Unix Domain seqpacket socket.</i>
<a name="api_b_send_and_recv_seqpL-1"/><a name="1997"/> 1997: <b>api_b_send_and_recv_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="1998"/> 1998:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_seqpL-last_expr"/><a name="1999"/> 1999: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2000"/> 2000:            fun() -&gt;
<a name="2001"/> 2001: 		   has_support_unix_domain_socket(),
<a name="2002"/> 2002:                    is_not_windows()
<a name="2003"/> 2003: 	   end,
<a name="2004"/> 2004:            fun() -&gt;
<a name="2005"/> 2005:                    Send = fun(Sock, Data) -&gt;
<a name="2006"/> 2006:                                   socket:send(Sock, Data)
<a name="2007"/> 2007:                           end,
<a name="2008"/> 2008:                    Recv = fun(Sock) -&gt;
<a name="2009"/> 2009:                                   socket:recv(Sock)
<a name="2010"/> 2010:                           end,
<a name="2011"/> 2011:                    InitState = #{domain =&gt; local,
<a name="2012"/> 2012:                                  type   =&gt; seqpacket,
<a name="2013"/> 2013:                                  proto  =&gt; default,
<a name="2014"/> 2014:                                  send   =&gt; Send,
<a name="2015"/> 2015:                                  recv   =&gt; Recv},
<a name="2016"/> 2016:                    ok = api_b_send_and_recv_conn(InitState)
<a name="2017"/> 2017:            end).
<a name="2018"/> 2018: 
<a name="2019"/> 2019: 
<a name="2020"/> 2020: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2021"/> 2021: 
<a name="2022"/> 2022: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="2023"/> 2023: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_b_sendmsg_and_recvmsg_tcp4-1"/><a name="2024"/> 2024: <b>api_b_sendmsg_and_recvmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2025"/> 2025:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="2026"/> 2026: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_tcp4,
<a name="2027"/> 2027:            fun() -&gt;
<a name="2028"/> 2028:                    is_not_windows(),
<a name="2029"/> 2029:                    has_support_ipv4()
<a name="2030"/> 2030:            end,
<a name="2031"/> 2031:            fun() -&gt;
<a name="2032"/> 2032:                    Send = fun(Sock, Data) -&gt;
<a name="2033"/> 2033:                                   Msg = #{%% ctrl =&gt; CMsgs,
<a name="2034"/> 2034:                                           iov =&gt; [Data]},
<a name="2035"/> 2035:                                   socket:sendmsg(Sock, Msg)
<a name="2036"/> 2036:                           end,
<a name="2037"/> 2037:                    Recv = fun(Sock) -&gt;
<a name="2038"/> 2038:                                   case socket:recvmsg(Sock) of
<a name="2039"/> 2039:                                       {ok, #{addr  := _} = Addr} -&gt;
<a name="2040"/> 2040:                                           {error, {addr, Addr}};
<a name="2041"/> 2041:                                       {ok, #{iov   := [Data]}} -&gt;
<a name="2042"/> 2042:                                           {ok, Data};
<a name="2043"/> 2043:                                       {ok, Msg} -&gt;
<a name="2044"/> 2044:                                           {error, {msg, Msg}};
<a name="2045"/> 2045:                                       {error, _} = ERROR -&gt;
<a name="2046"/> 2046:                                           ERROR
<a name="2047"/> 2047:                                   end
<a name="2048"/> 2048:                           end,
<a name="2049"/> 2049:                    InitState = #{domain =&gt; inet,
<a name="2050"/> 2050:                                  type   =&gt; stream,
<a name="2051"/> 2051:                                  proto  =&gt; tcp,
<a name="2052"/> 2052:                                  send   =&gt; Send,
<a name="2053"/> 2053:                                  recv   =&gt; Recv},
<a name="2054"/> 2054:                    ok = api_b_send_and_recv_conn(InitState)
<a name="2055"/> 2055:            end).
<a name="2056"/> 2056: 
<a name="2057"/> 2057: 
<a name="2058"/> 2058: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2059"/> 2059: 
<a name="2060"/> 2060: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="2061"/> 2061: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_sendmsg_and_recvmsg_tcpL-1"/><a name="2062"/> 2062: <b>api_b_sendmsg_and_recvmsg_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="2063"/> 2063:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_tcpL-last_expr"/><a name="2064"/> 2064: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_tcpL,
<a name="2065"/> 2065:            fun() -&gt;
<a name="2066"/> 2066: 		   has_support_unix_domain_socket(),
<a name="2067"/> 2067: 		   is_not_windows()
<a name="2068"/> 2068: 	   end,
<a name="2069"/> 2069:            fun() -&gt;
<a name="2070"/> 2070:                    Send = fun(Sock, Data) -&gt;
<a name="2071"/> 2071:                                   Msg = #{iov =&gt; [Data]},
<a name="2072"/> 2072:                                   socket:sendmsg(Sock, Msg)
<a name="2073"/> 2073:                           end,
<a name="2074"/> 2074:                    Recv = fun(Sock) -&gt;
<a name="2075"/> 2075:                                   case socket:recvmsg(Sock) of
<a name="2076"/> 2076:                                       %% On some platforms, the address
<a name="2077"/> 2077:                                       %% *is* provided (e.g. linux)
<a name="2078"/> 2078:                                       {ok, #{addr  := #{family := local},
<a name="2079"/> 2079:                                              iov   := [Data]}} -&gt;
<a name="2080"/> 2080:                                           socket:setopt(Sock, 
<a name="2081"/> 2081:                                                         otp, 
<a name="2082"/> 2082:                                                         debug, 
<a name="2083"/> 2083:                                                         false),
<a name="2084"/> 2084:                                           {ok, Data};
<a name="2085"/> 2085:                                       {ok, #{addr := _} = Msg} -&gt;
<a name="2086"/> 2086:                                           {error, {msg, Msg}};
<a name="2087"/> 2087:                                       %% On some platforms, the address
<a name="2088"/> 2088:                                       %% is *not* provided (e.g. FreeBSD)
<a name="2089"/> 2089:                                       {ok, #{iov   := [Data]}} -&gt;
<a name="2090"/> 2090:                                           {ok, Data};
<a name="2091"/> 2091:                                       {ok, Msg} -&gt;
<a name="2092"/> 2092:                                           {error, {msg, Msg}};
<a name="2093"/> 2093:                                       {error, _} = ERROR -&gt;
<a name="2094"/> 2094:                                           socket:setopt(Sock, 
<a name="2095"/> 2095:                                                         otp, 
<a name="2096"/> 2096:                                                         debug, 
<a name="2097"/> 2097:                                                         false),
<a name="2098"/> 2098:                                           ERROR
<a name="2099"/> 2099:                                   end
<a name="2100"/> 2100:                           end,
<a name="2101"/> 2101:                    InitState = #{domain =&gt; local,
<a name="2102"/> 2102:                                  type   =&gt; stream,
<a name="2103"/> 2103:                                  proto  =&gt; default,
<a name="2104"/> 2104:                                  send   =&gt; Send,
<a name="2105"/> 2105:                                  recv   =&gt; Recv},
<a name="2106"/> 2106:                    ok = api_b_send_and_recv_conn(InitState)
<a name="2107"/> 2107:            end).
<a name="2108"/> 2108: 
<a name="2109"/> 2109: 
<a name="2110"/> 2110: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2111"/> 2111: 
<a name="2112"/> 2112: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="2113"/> 2113: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_sendmsg_and_recvmsg_seqpL-1"/><a name="2114"/> 2114: <b>api_b_sendmsg_and_recvmsg_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="2115"/> 2115:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_seqpL-last_expr"/><a name="2116"/> 2116: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2117"/> 2117:            fun() -&gt;
<a name="2118"/> 2118: 		   has_support_unix_domain_socket(),
<a name="2119"/> 2119:                    is_not_windows()
<a name="2120"/> 2120: 	   end,
<a name="2121"/> 2121:            fun() -&gt;
<a name="2122"/> 2122:                    Send =
<a name="2123"/> 2123:                        fun(Sock, Data) -&gt;
<a name="2124"/> 2124:                                Msg =
<a name="2125"/> 2125:                                    #{iov =&gt; [Data]},
<a name="2126"/> 2126:                                socket:sendmsg(Sock, Msg)
<a name="2127"/> 2127:                        end,
<a name="2128"/> 2128:                    Recv = fun(Sock) -&gt;
<a name="2129"/> 2129:                                   case socket:recvmsg(Sock) of
<a name="2130"/> 2130:                                       %% On some platforms, the address
<a name="2131"/> 2131:                                       %% *is* provided (e.g. linux)
<a name="2132"/> 2132:                                       {ok,
<a name="2133"/> 2133:                                        #{addr  := #{family := local},
<a name="2134"/> 2134:                                          iov   := [Data]}} -&gt;
<a name="2135"/> 2135:                                           socket:setopt(
<a name="2136"/> 2136:                                             Sock, otp, debug, false),
<a name="2137"/> 2137:                                           {ok, Data};
<a name="2138"/> 2138:                                       {ok, #{addr := _} = Msg} -&gt;
<a name="2139"/> 2139:                                           {error, {msg, Msg}};
<a name="2140"/> 2140:                                       %% On some platforms, the address
<a name="2141"/> 2141:                                       %% is *not* provided (e.g. FreeBSD)
<a name="2142"/> 2142:                                       {ok,
<a name="2143"/> 2143:                                        #{iov   := [Data]}} -&gt;
<a name="2144"/> 2144:                                           {ok, Data};
<a name="2145"/> 2145:                                       {ok, Msg} -&gt;
<a name="2146"/> 2146:                                           {error, {msg, Msg}};
<a name="2147"/> 2147:                                       {error, _} = ERROR -&gt;
<a name="2148"/> 2148:                                           socket:setopt(
<a name="2149"/> 2149:                                             Sock, otp, debug, false),
<a name="2150"/> 2150:                                           ERROR
<a name="2151"/> 2151:                                   end
<a name="2152"/> 2152:                           end,
<a name="2153"/> 2153:                    InitState =
<a name="2154"/> 2154:                        #{domain =&gt; local,
<a name="2155"/> 2155:                          type   =&gt; seqpacket,
<a name="2156"/> 2156:                          proto  =&gt; default,
<a name="2157"/> 2157:                          send   =&gt; Send,
<a name="2158"/> 2158:                          recv   =&gt; Recv},
<a name="2159"/> 2159:                    ok = api_b_send_and_recv_conn(InitState)
<a name="2160"/> 2160:            end).
<a name="2161"/> 2161: 
<a name="2162"/> 2162: 
<a name="2163"/> 2163: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2164"/> 2164: 
<a name="api_b_send_and_recv_conn-1"/><a name="2165"/> 2165: <b>api_b_send_and_recv_conn</b>(InitState) -&gt;
<a name="2166"/> 2166:     process_flag(trap_exit, true),
<a name="2167"/> 2167: 
<a name="2168"/> 2168:     ServerSeq = 
<a name="2169"/> 2169:         [
<a name="2170"/> 2170:          %% *** Wait for start order ***
<a name="2171"/> 2171:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="2172"/> 2172:            cmd  =&gt; fun(State) -&gt;
<a name="2173"/> 2173:                            Tester = ?SEV_AWAIT_START(),
<a name="2174"/> 2174:                            {ok, State#{tester =&gt; Tester}}
<a name="2175"/> 2175:                    end},
<a name="2176"/> 2176:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="2177"/> 2177:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2178"/> 2178:                            _MRef = erlang:monitor(process, Tester),
<a name="2179"/> 2179:                            ok
<a name="2180"/> 2180:                    end},
<a name="2181"/> 2181: 
<a name="2182"/> 2182:          %% *** Init part ***
<a name="2183"/> 2183:          #{desc =&gt; &quot;which local address&quot;,
<a name="2184"/> 2184:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="2185"/> 2185:                            LSA = which_local_socket_addr(Domain),
<a name="2186"/> 2186: 			   ?SEV_IPRINT(&quot;LSA: ~p&quot;, [LSA]),
<a name="2187"/> 2187:                            {ok, State#{lsa =&gt; LSA}}
<a name="2188"/> 2188:                    end},
<a name="2189"/> 2189:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="2190"/> 2190:            cmd  =&gt; fun(#{domain := Domain,
<a name="2191"/> 2191:                          type := Type,
<a name="2192"/> 2192:                          proto  := Proto} = State) -&gt;
<a name="2193"/> 2193:                            case socket:open(Domain, Type, Proto) of
<a name="2194"/> 2194:                                {ok, Sock} -&gt;
<a name="2195"/> 2195:                                    {ok, State#{lsock =&gt; Sock}};
<a name="2196"/> 2196:                                {error, eprotonosupport = Reason} -&gt;
<a name="2197"/> 2197:                                    {skip, Reason};
<a name="2198"/> 2198:                                {error, _} = ERROR -&gt;
<a name="2199"/> 2199:                                    ERROR
<a name="2200"/> 2200:                            end
<a name="2201"/> 2201:                    end},
<a name="2202"/> 2202:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="2203"/> 2203:            cmd  =&gt; fun(#{domain := local,
<a name="2204"/> 2204:                          lsock  := LSock,
<a name="2205"/> 2205:                          lsa    := LSA} = _State) -&gt;
<a name="2206"/> 2206: 			   ?SEV_IPRINT(&quot;try bind to: &quot;
<a name="2207"/> 2207: 				       &quot;~n   ~p&quot;, [LSA]),
<a name="2208"/> 2208: 			   %% _ = socket:setopt(LSock, otp, debug, true),
<a name="2209"/> 2209:                            case socket:bind(LSock, LSA) of
<a name="2210"/> 2210:                                ok -&gt;
<a name="2211"/> 2211:                                    %% We do not care about the port for local
<a name="2212"/> 2212: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2213"/> 2213:                                    ok;
<a name="2214"/> 2214:                                {error, Reason} = ERROR -&gt;
<a name="2215"/> 2215: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2216"/> 2216: 				   ?SEV_EPRINT(&quot;failed binding: &quot;
<a name="2217"/> 2217: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="2218"/> 2218:                                    ERROR
<a name="2219"/> 2219:                            end;
<a name="2220"/> 2220:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="2221"/> 2221:                            case sock_bind(LSock, LSA) of
<a name="2222"/> 2222:                                ok -&gt;
<a name="2223"/> 2223:                                    Port = sock_port(LSock),
<a name="2224"/> 2224:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="2225"/> 2225:                                    {ok, State#{lport =&gt; Port}};
<a name="2226"/> 2226:                                {error, _} = ERROR -&gt;
<a name="2227"/> 2227:                                    ERROR
<a name="2228"/> 2228:                            end
<a name="2229"/> 2229:                    end},
<a name="2230"/> 2230:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="2231"/> 2231:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="2232"/> 2232:                            socket:listen(LSock)
<a name="2233"/> 2233:                    end},
<a name="2234"/> 2234:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="2235"/> 2235:            cmd  =&gt; fun(#{domain := local,
<a name="2236"/> 2236:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="2237"/> 2237:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="2238"/> 2238:                            ok;
<a name="2239"/> 2239:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="2240"/> 2240:                            %% This is actually not used for unix domain socket
<a name="2241"/> 2241:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="2242"/> 2242:                            ok
<a name="2243"/> 2243:                    end},
<a name="2244"/> 2244: 
<a name="2245"/> 2245:          %% The actual test
<a name="2246"/> 2246:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="2247"/> 2247:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2248"/> 2248:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="2249"/> 2249:                    end},
<a name="2250"/> 2250:          #{desc =&gt; &quot;await connection&quot;,
<a name="2251"/> 2251:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="2252"/> 2252: 			   ?SEV_IPRINT(&quot;try accept&quot;),
<a name="2253"/> 2253:                            case socket:accept(LSock) of
<a name="2254"/> 2254:                                {ok, Sock} -&gt;
<a name="2255"/> 2255:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="2256"/> 2256:                                    {ok, State#{csock =&gt; Sock}};
<a name="2257"/> 2257:                                {error, Reason} = ERROR -&gt;
<a name="2258"/> 2258:                                    ?SEV_EPRINT(&quot;accept failed: &quot;
<a name="2259"/> 2259: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="2260"/> 2260:                                    ERROR
<a name="2261"/> 2261:                            end
<a name="2262"/> 2262:                    end},
<a name="2263"/> 2263:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="2264"/> 2264:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2265"/> 2265:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="2266"/> 2266:                            ok
<a name="2267"/> 2267:                    end},
<a name="2268"/> 2268:          #{desc =&gt; &quot;await (recv) request&quot;,
<a name="2269"/> 2269:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="2270"/> 2270:                            case Recv(Sock) of
<a name="2271"/> 2271:                                {ok, ?BASIC_REQ} -&gt;
<a name="2272"/> 2272:                                    ok;
<a name="2273"/> 2273:                                {error, _} = ERROR -&gt;
<a name="2274"/> 2274:                                    ERROR
<a name="2275"/> 2275:                            end
<a name="2276"/> 2276:                    end},
<a name="2277"/> 2277:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="2278"/> 2278:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2279"/> 2279:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="2280"/> 2280:                            ok
<a name="2281"/> 2281:                    end},
<a name="2282"/> 2282:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="2283"/> 2283:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2284"/> 2284:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="2285"/> 2285:                    end},
<a name="2286"/> 2286:          #{desc =&gt; &quot;send reply&quot;,
<a name="2287"/> 2287:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="2288"/> 2288:                            Send(Sock, ?BASIC_REP)
<a name="2289"/> 2289:                    end},
<a name="2290"/> 2290:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="2291"/> 2291:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2292"/> 2292:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="2293"/> 2293:                            ok
<a name="2294"/> 2294:                    end},
<a name="2295"/> 2295: 
<a name="2296"/> 2296:          %% *** Termination ***
<a name="2297"/> 2297:          #{desc =&gt; &quot;await terminate&quot;,
<a name="2298"/> 2298:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="2299"/> 2299:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="2300"/> 2300:                                ok -&gt;
<a name="2301"/> 2301:                                    {ok, maps:remove(tester, State)};
<a name="2302"/> 2302:                                {error, _} = ERROR -&gt;
<a name="2303"/> 2303:                                    ERROR
<a name="2304"/> 2304:                            end
<a name="2305"/> 2305:                    end},
<a name="2306"/> 2306:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="2307"/> 2307:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="2308"/> 2308:                            ok = socket:close(Sock),
<a name="2309"/> 2309:                            {ok, maps:remove(csock, State)}
<a name="2310"/> 2310:                    end},
<a name="2311"/> 2311:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="2312"/> 2312:            cmd  =&gt; fun(#{domain   := local,
<a name="2313"/> 2313:                          lsock    := Sock,
<a name="2314"/> 2314:                          local_sa := #{path := Path}} = State) -&gt;
<a name="2315"/> 2315:                            ok = socket:close(Sock),
<a name="2316"/> 2316:                            State1 =
<a name="2317"/> 2317:                                unlink_path(Path,
<a name="2318"/> 2318:                                            fun() -&gt;
<a name="2319"/> 2319:                                                    maps:remove(local_sa, State)
<a name="2320"/> 2320:                                            end,
<a name="2321"/> 2321:                                            fun() -&gt; State end),
<a name="2322"/> 2322:                            {ok, maps:remove(lsock, State1)};
<a name="2323"/> 2323:                       (#{lsock := LSock} = State) -&gt;
<a name="2324"/> 2324:                            case socket:close(LSock) of
<a name="2325"/> 2325:                                ok -&gt;
<a name="2326"/> 2326:                                    {ok, maps:remove(lsock, State)};
<a name="2327"/> 2327:                                {error, _} = ERROR -&gt;
<a name="2328"/> 2328:                                    ERROR
<a name="2329"/> 2329:                            end
<a name="2330"/> 2330:                    end},
<a name="2331"/> 2331: 
<a name="2332"/> 2332:          %% *** We are done ***
<a name="2333"/> 2333:          ?SEV_FINISH_NORMAL
<a name="2334"/> 2334:         ],
<a name="2335"/> 2335: 
<a name="2336"/> 2336:     ClientSeq =
<a name="2337"/> 2337:         [
<a name="2338"/> 2338:          %% *** Wait for start order ***
<a name="2339"/> 2339:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="2340"/> 2340:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="2341"/> 2341:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="2342"/> 2342:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="2343"/> 2343:                       (State) -&gt;
<a name="2344"/> 2344:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="2345"/> 2345:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="2346"/> 2346:                    end},
<a name="2347"/> 2347:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="2348"/> 2348:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2349"/> 2349:                            _MRef = erlang:monitor(process, Tester),
<a name="2350"/> 2350:                            ok
<a name="2351"/> 2351:                    end},
<a name="2352"/> 2352: 
<a name="2353"/> 2353:          %% *** The init part ***
<a name="2354"/> 2354:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="2355"/> 2355:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="2356"/> 2356:                          server_path := Path} = State) -&gt;
<a name="2357"/> 2357:                            LSA = which_local_socket_addr(Domain),
<a name="2358"/> 2358:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="2359"/> 2359:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="2360"/> 2360:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="2361"/> 2361:                            LSA = which_local_socket_addr(Domain),
<a name="2362"/> 2362:                            SSA = LSA#{port =&gt; Port},
<a name="2363"/> 2363:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="2364"/> 2364:                    end},
<a name="2365"/> 2365:          #{desc =&gt; &quot;create socket&quot;,
<a name="2366"/> 2366:            cmd  =&gt; fun(#{domain := Domain,
<a name="2367"/> 2367:                          type := Type,
<a name="2368"/> 2368:                          proto  := Proto} = State) -&gt;
<a name="2369"/> 2369:                            case socket:open(Domain, Type, Proto) of
<a name="2370"/> 2370:                                {ok, Sock} -&gt;
<a name="2371"/> 2371:                                    {ok, State#{sock =&gt; Sock}};
<a name="2372"/> 2372:                                {error, _} = ERROR -&gt;
<a name="2373"/> 2373:                                    ERROR
<a name="2374"/> 2374:                            end
<a name="2375"/> 2375:                    end},
<a name="2376"/> 2376:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="2377"/> 2377:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="2378"/> 2378:                            case sock_bind(Sock, LSA) of
<a name="2379"/> 2379:                                ok -&gt;
<a name="2380"/> 2380:                                    ok;
<a name="2381"/> 2381:                                {error, _} = ERROR -&gt;
<a name="2382"/> 2382:                                    ERROR
<a name="2383"/> 2383:                            end
<a name="2384"/> 2384:                    end},
<a name="2385"/> 2385:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="2386"/> 2386:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2387"/> 2387:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="2388"/> 2388:                            ok
<a name="2389"/> 2389:                    end},
<a name="2390"/> 2390: 
<a name="2391"/> 2391:          %% *** The actual test ***
<a name="2392"/> 2392:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="2393"/> 2393:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="2394"/> 2394:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="2395"/> 2395:                    end},
<a name="2396"/> 2396:          #{desc =&gt; &quot;connect to server&quot;,
<a name="2397"/> 2397:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="2398"/> 2398:                            socket:connect(Sock, SSA)
<a name="2399"/> 2399:                    end},
<a name="2400"/> 2400:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="2401"/> 2401:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2402"/> 2402:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="2403"/> 2403:                            ok
<a name="2404"/> 2404:                    end},
<a name="2405"/> 2405:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="2406"/> 2406:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="2407"/> 2407:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="2408"/> 2408:                    end},
<a name="2409"/> 2409:          #{desc =&gt; &quot;send request (to server)&quot;,
<a name="2410"/> 2410:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="2411"/> 2411:                            Send(Sock, ?BASIC_REQ)
<a name="2412"/> 2412:                    end},
<a name="2413"/> 2413:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="2414"/> 2414:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2415"/> 2415:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="2416"/> 2416:                            ok
<a name="2417"/> 2417:                    end},
<a name="2418"/> 2418:          #{desc =&gt; &quot;await recv reply (from server)&quot;,
<a name="2419"/> 2419:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="2420"/> 2420:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="2421"/> 2421:                            ok
<a name="2422"/> 2422:                    end},
<a name="2423"/> 2423:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="2424"/> 2424:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2425"/> 2425:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="2426"/> 2426:                            ok
<a name="2427"/> 2427:                    end},
<a name="2428"/> 2428: 
<a name="2429"/> 2429:          %% *** Termination ***
<a name="2430"/> 2430:          #{desc =&gt; &quot;await terminate&quot;,
<a name="2431"/> 2431:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="2432"/> 2432:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="2433"/> 2433:                                ok -&gt;
<a name="2434"/> 2434:                                    {ok, maps:remove(tester, State)};
<a name="2435"/> 2435:                                {error, _} = ERROR -&gt;
<a name="2436"/> 2436:                                    ERROR
<a name="2437"/> 2437:                            end
<a name="2438"/> 2438:                    end},
<a name="2439"/> 2439:          #{desc =&gt; &quot;close socket&quot;,
<a name="2440"/> 2440:            cmd  =&gt; fun(#{domain   := local,
<a name="2441"/> 2441:                          sock     := Sock,
<a name="2442"/> 2442:                          local_sa := #{path := Path}} = State) -&gt;
<a name="2443"/> 2443:                            ok = socket:close(Sock),
<a name="2444"/> 2444:                            State1 =
<a name="2445"/> 2445:                                unlink_path(Path,
<a name="2446"/> 2446:                                            fun() -&gt;
<a name="2447"/> 2447:                                                    maps:remove(local_sa, State)
<a name="2448"/> 2448:                                            end,
<a name="2449"/> 2449:                                            fun() -&gt; State end),
<a name="2450"/> 2450:                            {ok, maps:remove(sock, State1)};
<a name="2451"/> 2451:                       (#{sock := Sock} = State) -&gt;
<a name="2452"/> 2452:                            ok = socket:close(Sock),
<a name="2453"/> 2453:                            {ok, maps:remove(sock, State)}
<a name="2454"/> 2454:                    end},
<a name="2455"/> 2455: 
<a name="2456"/> 2456:          %% *** We are done ***
<a name="2457"/> 2457:          ?SEV_FINISH_NORMAL
<a name="2458"/> 2458:         ],
<a name="2459"/> 2459: 
<a name="2460"/> 2460:     TesterSeq =
<a name="2461"/> 2461:         [
<a name="2462"/> 2462:          %% *** Init part ***
<a name="2463"/> 2463:          #{desc =&gt; &quot;monitor server&quot;,
<a name="2464"/> 2464:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="2465"/> 2465:                            _MRef = erlang:monitor(process, Pid),
<a name="2466"/> 2466:                            ok
<a name="2467"/> 2467:                    end},
<a name="2468"/> 2468:          #{desc =&gt; &quot;monitor client&quot;,
<a name="2469"/> 2469:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="2470"/> 2470:                            _MRef = erlang:monitor(process, Pid),
<a name="2471"/> 2471:                            ok
<a name="2472"/> 2472:                    end},
<a name="2473"/> 2473: 
<a name="2474"/> 2474:          %% Start the server
<a name="2475"/> 2475:          #{desc =&gt; &quot;order server start&quot;,
<a name="2476"/> 2476:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="2477"/> 2477:                            ?SEV_ANNOUNCE_START(Pid),
<a name="2478"/> 2478:                            ok
<a name="2479"/> 2479:                    end},
<a name="2480"/> 2480:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="2481"/> 2481:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="2482"/> 2482:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="2483"/> 2483:                            {ok, State#{server_port =&gt; Port}}
<a name="2484"/> 2484:                    end},
<a name="2485"/> 2485: 
<a name="2486"/> 2486:          %% Start the client
<a name="2487"/> 2487:          #{desc =&gt; &quot;order client start&quot;,
<a name="2488"/> 2488:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="2489"/> 2489:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="2490"/> 2490:                            ok
<a name="2491"/> 2491:                    end},
<a name="2492"/> 2492:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="2493"/> 2493:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="2494"/> 2494:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="2495"/> 2495:                    end},
<a name="2496"/> 2496: 
<a name="2497"/> 2497:          %% *** The actual test ***
<a name="2498"/> 2498:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="2499"/> 2499:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2500"/> 2500:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="2501"/> 2501:                            ok
<a name="2502"/> 2502:                    end},
<a name="2503"/> 2503:          ?SEV_SLEEP(?SECS(1)),
<a name="2504"/> 2504:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="2505"/> 2505:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2506"/> 2506:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="2507"/> 2507:                            ok
<a name="2508"/> 2508:                    end},
<a name="2509"/> 2509:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="2510"/> 2510:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2511"/> 2511:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="2512"/> 2512:                    end},
<a name="2513"/> 2513:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="2514"/> 2514:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2515"/> 2515:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="2516"/> 2516:                    end},
<a name="2517"/> 2517:          #{desc =&gt; &quot;order client to continue (with send request)&quot;,
<a name="2518"/> 2518:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2519"/> 2519:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="2520"/> 2520:                            ok
<a name="2521"/> 2521:                    end},
<a name="2522"/> 2522:          #{desc =&gt; &quot;await client ready (with send request)&quot;,
<a name="2523"/> 2523:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2524"/> 2524:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="2525"/> 2525:                    end},
<a name="2526"/> 2526:          #{desc =&gt; &quot;await server ready (request recv)&quot;,
<a name="2527"/> 2527:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2528"/> 2528:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="2529"/> 2529:                    end},
<a name="2530"/> 2530:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="2531"/> 2531:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2532"/> 2532:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="2533"/> 2533:                            ok
<a name="2534"/> 2534:                    end},
<a name="2535"/> 2535:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="2536"/> 2536:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2537"/> 2537:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="2538"/> 2538:                    end},
<a name="2539"/> 2539:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="2540"/> 2540:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2541"/> 2541:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="2542"/> 2542:                    end},
<a name="2543"/> 2543: 
<a name="2544"/> 2544: 
<a name="2545"/> 2545:          %% *** Termination ***
<a name="2546"/> 2546:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="2547"/> 2547:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="2548"/> 2548:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="2549"/> 2549:                            ok
<a name="2550"/> 2550:                    end},
<a name="2551"/> 2551:          #{desc =&gt; &quot;await client termination&quot;,
<a name="2552"/> 2552:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="2553"/> 2553:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="2554"/> 2554:                            State1 = maps:remove(client, State),
<a name="2555"/> 2555:                            {ok, State1}
<a name="2556"/> 2556:                    end},
<a name="2557"/> 2557:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="2558"/> 2558:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="2559"/> 2559:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="2560"/> 2560:                            ok
<a name="2561"/> 2561:                    end},
<a name="2562"/> 2562:          #{desc =&gt; &quot;await server termination&quot;,
<a name="2563"/> 2563:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="2564"/> 2564:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="2565"/> 2565:                            State1 = maps:remove(server, State),
<a name="2566"/> 2566:                            {ok, State1}
<a name="2567"/> 2567:                    end},
<a name="2568"/> 2568: 
<a name="2569"/> 2569:          %% *** We are done ***
<a name="2570"/> 2570:          ?SEV_FINISH_NORMAL
<a name="2571"/> 2571:         ],
<a name="2572"/> 2572: 
<a name="2573"/> 2573:     i(&quot;start server evaluator&quot;),
<a name="2574"/> 2574:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="2575"/> 2575: 
<a name="2576"/> 2576:     i(&quot;start client evaluator&quot;),
<a name="2577"/> 2577:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="2578"/> 2578:     i(&quot;await evaluator(s)&quot;),
<a name="2579"/> 2579: 
<a name="2580"/> 2580:     i(&quot;start tester evaluator&quot;),
<a name="2581"/> 2581:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="2582"/> 2582:                         client =&gt; Client#ev.pid},
<a name="2583"/> 2583:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="2584"/> 2584: 
<a name="api_b_send_and_recv_conn-last_expr"/><a name="2585"/> 2585: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="2586"/> 2586: 
<a name="2587"/> 2587: 
<a name="2588"/> 2588: 
<a name="2589"/> 2589: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2590"/> 2590: 
<a name="2591"/> 2591: <b>-define</b>(REQ_IOV_SND, [&lt;&lt;0:32&gt;&gt;,
<a name="2592"/> 2592:                       &lt;&lt;1:32&gt;&gt;,
<a name="2593"/> 2593:                       &lt;&lt;2:32&gt;&gt;,
<a name="2594"/> 2594:                       &lt;&lt;3:32&gt;&gt;,
<a name="2595"/> 2595:                       &lt;&lt;4:32&gt;&gt;,
<a name="2596"/> 2596:                       &lt;&lt;5:32&gt;&gt;,
<a name="2597"/> 2597:                       &lt;&lt;6:32&gt;&gt;,
<a name="2598"/> 2598:                       &lt;&lt;7:32&gt;&gt;,
<a name="2599"/> 2599:                       &lt;&lt;8:32&gt;&gt;,
<a name="2600"/> 2600:                       &lt;&lt;9:32&gt;&gt;]).
<a name="2601"/> 2601: <b>-define</b>(REQ_IOV_RCV, erlang:iolist_to_binary(?REQ_IOV_SND)).
<a name="2602"/> 2602: <b>-define</b>(REP_IOV_SND, [&lt;&lt;10:32&gt;&gt;,
<a name="2603"/> 2603:                       &lt;&lt;11:32&gt;&gt;,
<a name="2604"/> 2604:                       &lt;&lt;12:32&gt;&gt;,
<a name="2605"/> 2605:                       &lt;&lt;13:32&gt;&gt;,
<a name="2606"/> 2606:                       &lt;&lt;14:32&gt;&gt;,
<a name="2607"/> 2607:                       &lt;&lt;15:32&gt;&gt;,
<a name="2608"/> 2608:                       &lt;&lt;16:32&gt;&gt;,
<a name="2609"/> 2609:                       &lt;&lt;17:32&gt;&gt;,
<a name="2610"/> 2610:                       &lt;&lt;18:32&gt;&gt;,
<a name="2611"/> 2611:                       &lt;&lt;19:32&gt;&gt;]).
<a name="2612"/> 2612: <b>-define</b>(REP_IOV_RCV, erlang:iolist_to_binary(?REP_IOV_SND)).
<a name="2613"/> 2613: 
<a name="ensure_sufficient_iov_max-0"/><a name="2614"/> 2614: <b>ensure_sufficient_iov_max</b>() -&gt;
<a name="ensure_sufficient_iov_max-last_expr"/><a name="2615"/> 2615: <b>    case socket:info</b>() of
<a name="2616"/> 2616:         #{iov_max := IOVMax} -&gt;
<a name="2617"/> 2617:             IOVUsed = length(?REQ_IOV_SND),
<a name="2618"/> 2618:             if
<a name="2619"/> 2619:                 IOVMax &gt;= IOVUsed -&gt;
<a name="2620"/> 2620:                     ok;
<a name="2621"/> 2621:                 true -&gt;
<a name="2622"/> 2622:                     skip({iov_max, IOVMax, IOVUsed})
<a name="2623"/> 2623:             end;
<a name="2624"/> 2624:         _ -&gt;
<a name="2625"/> 2625:             skip(no_info)
<a name="2626"/> 2626:     end.
<a name="2627"/> 2627:     
<a name="2628"/> 2628: 
<a name="2629"/> 2629: <i>%% Basically send a I/O vector and receive using the sendv and recv</i>
<a name="2630"/> 2630: <i>%% functions on an IPv4 TCP (stream) socket.</i>
<a name="api_b_sendv_tcp4-1"/><a name="2631"/> 2631: <b>api_b_sendv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2632"/> 2632:     ?TT(?SECS(10)),
<a name="api_b_sendv_tcp4-last_expr"/><a name="2633"/> 2633: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2634"/> 2634:            fun() -&gt;
<a name="2635"/> 2635:                    has_support_ipv4(),
<a name="2636"/> 2636:                    ensure_sufficient_iov_max()
<a name="2637"/> 2637:            end,
<a name="2638"/> 2638:            fun() -&gt;
<a name="2639"/> 2639:                    Send = fun(Sock, IOV) when is_list(IOV) -&gt;
<a name="2640"/> 2640:                                   %% Since we are just reusing this test case,
<a name="2641"/> 2641:                                   %% the I/O vector is just one binary.
<a name="2642"/> 2642:                                   %% _ = socket:setopt(Sock, otp, debug, true),
<a name="2643"/> 2643:                                   Res = socket:sendv(Sock, IOV),
<a name="2644"/> 2644:                                   %% _ = socket:setopt(Sock, otp, debug, false),
<a name="2645"/> 2645:                                   Res
<a name="2646"/> 2646:                           end,
<a name="2647"/> 2647:                    Recv = fun(Sock) -&gt;
<a name="2648"/> 2648:                                   socket:recv(Sock)
<a name="2649"/> 2649:                           end,
<a name="2650"/> 2650:                    InitState = #{domain =&gt; inet,
<a name="2651"/> 2651:                                  type   =&gt; stream,
<a name="2652"/> 2652:                                  proto  =&gt; tcp,
<a name="2653"/> 2653:                                  send   =&gt; Send,
<a name="2654"/> 2654:                                  recv   =&gt; Recv},
<a name="2655"/> 2655:                    ok = api_b_sendv(InitState)
<a name="2656"/> 2656:            end).
<a name="2657"/> 2657: 
<a name="2658"/> 2658: 
<a name="2659"/> 2659: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2660"/> 2660: 
<a name="2661"/> 2661: <i>%% Basically send a I/O vector and receive using the sendv and recv</i>
<a name="2662"/> 2662: <i>%% functions on an IPv6 TCP (stream) socket.</i>
<a name="api_b_sendv_tcp6-1"/><a name="2663"/> 2663: <b>api_b_sendv_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="2664"/> 2664:     ?TT(?SECS(10)),
<a name="api_b_sendv_tcp6-last_expr"/><a name="2665"/> 2665: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2666"/> 2666:            fun() -&gt;
<a name="2667"/> 2667:                    has_support_ipv6(),
<a name="2668"/> 2668:                    ensure_sufficient_iov_max()
<a name="2669"/> 2669:            end,
<a name="2670"/> 2670:            fun() -&gt;
<a name="2671"/> 2671:                    Send = fun(Sock, IOV) when is_list(IOV) -&gt;
<a name="2672"/> 2672:                                   %% Since we are just reusing this test case,
<a name="2673"/> 2673:                                   %% the I/O vector is just one binary.
<a name="2674"/> 2674:                                   %% _ = socket:setopt(Sock, otp, debug, true),
<a name="2675"/> 2675:                                   Res = socket:sendv(Sock, IOV),
<a name="2676"/> 2676:                                   %% _ = socket:setopt(Sock, otp, debug, false),
<a name="2677"/> 2677:                                   Res
<a name="2678"/> 2678:                           end,
<a name="2679"/> 2679:                    Recv = fun(Sock) -&gt;
<a name="2680"/> 2680:                                   socket:recv(Sock)
<a name="2681"/> 2681:                           end,
<a name="2682"/> 2682:                    InitState = #{domain =&gt; inet6,
<a name="2683"/> 2683:                                  type   =&gt; stream,
<a name="2684"/> 2684:                                  proto  =&gt; tcp,
<a name="2685"/> 2685:                                  send   =&gt; Send,
<a name="2686"/> 2686:                                  recv   =&gt; Recv},
<a name="2687"/> 2687:                    ok = api_b_sendv(InitState)
<a name="2688"/> 2688:            end).
<a name="2689"/> 2689: 
<a name="2690"/> 2690: 
<a name="2691"/> 2691: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2692"/> 2692: 
<a name="api_b_sendv-1"/><a name="2693"/> 2693: <b>api_b_sendv</b>(InitState) -&gt;
<a name="2694"/> 2694:     process_flag(trap_exit, true),
<a name="2695"/> 2695: 
<a name="2696"/> 2696:     ServerSeq = 
<a name="2697"/> 2697:         [
<a name="2698"/> 2698:          %% *** Wait for start order ***
<a name="2699"/> 2699:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="2700"/> 2700:            cmd  =&gt; fun(State) -&gt;
<a name="2701"/> 2701:                            Tester = ?SEV_AWAIT_START(),
<a name="2702"/> 2702:                            {ok, State#{tester =&gt; Tester}}
<a name="2703"/> 2703:                    end},
<a name="2704"/> 2704:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="2705"/> 2705:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2706"/> 2706:                            _MRef = erlang:monitor(process, Tester),
<a name="2707"/> 2707:                            ok
<a name="2708"/> 2708:                    end},
<a name="2709"/> 2709: 
<a name="2710"/> 2710:          %% *** Init part ***
<a name="2711"/> 2711:          #{desc =&gt; &quot;which local address&quot;,
<a name="2712"/> 2712:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="2713"/> 2713:                            LSA = which_local_socket_addr(Domain),
<a name="2714"/> 2714: 			   ?SEV_IPRINT(&quot;LSA: ~p&quot;, [LSA]),
<a name="2715"/> 2715:                            {ok, State#{lsa =&gt; LSA}}
<a name="2716"/> 2716:                    end},
<a name="2717"/> 2717:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="2718"/> 2718:            cmd  =&gt; fun(#{domain := Domain,
<a name="2719"/> 2719:                          type   := Type,
<a name="2720"/> 2720:                          proto  := Proto} = State) -&gt;
<a name="2721"/> 2721:                            case socket:open(Domain, Type, Proto) of
<a name="2722"/> 2722:                                {ok, Sock} -&gt;
<a name="2723"/> 2723:                                    {ok, State#{lsock =&gt; Sock}};
<a name="2724"/> 2724:                                {error, eprotonosupport = Reason} -&gt;
<a name="2725"/> 2725:                                    {skip, Reason};
<a name="2726"/> 2726:                                {error, _} = ERROR -&gt;
<a name="2727"/> 2727:                                    ERROR
<a name="2728"/> 2728:                            end
<a name="2729"/> 2729:                    end},
<a name="2730"/> 2730:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="2731"/> 2731:            cmd  =&gt; fun(#{domain := local,
<a name="2732"/> 2732:                          lsock  := LSock,
<a name="2733"/> 2733:                          lsa    := LSA} = _State) -&gt;
<a name="2734"/> 2734: 			   ?SEV_IPRINT(&quot;try bind to: &quot;
<a name="2735"/> 2735: 				       &quot;~n   ~p&quot;, [LSA]),
<a name="2736"/> 2736: 			   %% _ = socket:setopt(LSock, otp, debug, true),
<a name="2737"/> 2737:                            case socket:bind(LSock, LSA) of
<a name="2738"/> 2738:                                ok -&gt;
<a name="2739"/> 2739:                                    %% We do not care about the port for local
<a name="2740"/> 2740: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2741"/> 2741:                                    ok;
<a name="2742"/> 2742:                                {error, Reason} = ERROR -&gt;
<a name="2743"/> 2743: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2744"/> 2744: 				   ?SEV_EPRINT(&quot;failed binding: &quot;
<a name="2745"/> 2745: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="2746"/> 2746:                                    ERROR
<a name="2747"/> 2747:                            end;
<a name="2748"/> 2748:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="2749"/> 2749:                            case sock_bind(LSock, LSA) of
<a name="2750"/> 2750:                                ok -&gt;
<a name="2751"/> 2751:                                    Port = sock_port(LSock),
<a name="2752"/> 2752:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="2753"/> 2753:                                    {ok, State#{lport =&gt; Port}};
<a name="2754"/> 2754:                                {error, _} = ERROR -&gt;
<a name="2755"/> 2755:                                    ERROR
<a name="2756"/> 2756:                            end
<a name="2757"/> 2757:                    end},
<a name="2758"/> 2758:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="2759"/> 2759:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="2760"/> 2760:                            socket:listen(LSock)
<a name="2761"/> 2761:                    end},
<a name="2762"/> 2762:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="2763"/> 2763:            cmd  =&gt; fun(#{domain := local,
<a name="2764"/> 2764:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="2765"/> 2765:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="2766"/> 2766:                            ok;
<a name="2767"/> 2767:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="2768"/> 2768:                            %% This is actually not used for unix domain socket
<a name="2769"/> 2769:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="2770"/> 2770:                            ok
<a name="2771"/> 2771:                    end},
<a name="2772"/> 2772: 
<a name="2773"/> 2773:          %% The actual test
<a name="2774"/> 2774:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="2775"/> 2775:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2776"/> 2776:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="2777"/> 2777:                    end},
<a name="2778"/> 2778:          #{desc =&gt; &quot;await connection&quot;,
<a name="2779"/> 2779:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="2780"/> 2780: 			   %% _ = socket:setopt(LSock, otp, debug, true),
<a name="2781"/> 2781: 			   ?SEV_IPRINT(&quot;try accept&quot;),
<a name="2782"/> 2782:                            case socket:accept(LSock) of
<a name="2783"/> 2783:                                {ok, Sock} -&gt;
<a name="2784"/> 2784: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2785"/> 2785:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="2786"/> 2786:                                    {ok, State#{csock =&gt; Sock}};
<a name="2787"/> 2787:                                {error, Reason} = ERROR -&gt;
<a name="2788"/> 2788: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="2789"/> 2789:                                    ?SEV_EPRINT(&quot;accept failed: &quot;
<a name="2790"/> 2790: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="2791"/> 2791:                                    ERROR
<a name="2792"/> 2792:                            end
<a name="2793"/> 2793:                    end},
<a name="2794"/> 2794:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="2795"/> 2795:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2796"/> 2796:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="2797"/> 2797:                            ok
<a name="2798"/> 2798:                    end},
<a name="2799"/> 2799: 
<a name="2800"/> 2800:          #{desc =&gt; &quot;await (recv) request&quot;,
<a name="2801"/> 2801:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="2802"/> 2802:                            Rep = ?REQ_IOV_RCV,
<a name="2803"/> 2803:                            case Recv(Sock) of
<a name="2804"/> 2804:                                {ok, Rep} -&gt;
<a name="2805"/> 2805:                                    ok;
<a name="2806"/> 2806:                                {error, _} = ERROR -&gt;
<a name="2807"/> 2807:                                    ERROR
<a name="2808"/> 2808:                            end
<a name="2809"/> 2809:                    end},
<a name="2810"/> 2810: 
<a name="2811"/> 2811:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="2812"/> 2812:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2813"/> 2813:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="2814"/> 2814:                            ok
<a name="2815"/> 2815:                    end},
<a name="2816"/> 2816:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="2817"/> 2817:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2818"/> 2818:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="2819"/> 2819:                    end},
<a name="2820"/> 2820:          #{desc =&gt; &quot;send reply&quot;,
<a name="2821"/> 2821:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="2822"/> 2822:                            Send(Sock, ?REP_IOV_SND)
<a name="2823"/> 2823:                    end},
<a name="2824"/> 2824:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="2825"/> 2825:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2826"/> 2826:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="2827"/> 2827:                            ok
<a name="2828"/> 2828:                    end},
<a name="2829"/> 2829: 
<a name="2830"/> 2830:          %% *** Termination ***
<a name="2831"/> 2831:          #{desc =&gt; &quot;await terminate&quot;,
<a name="2832"/> 2832:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="2833"/> 2833:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="2834"/> 2834:                                ok -&gt;
<a name="2835"/> 2835:                                    {ok, maps:remove(tester, State)};
<a name="2836"/> 2836:                                {error, _} = ERROR -&gt;
<a name="2837"/> 2837:                                    ERROR
<a name="2838"/> 2838:                            end
<a name="2839"/> 2839:                    end},
<a name="2840"/> 2840:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="2841"/> 2841:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="2842"/> 2842:                            ok = socket:close(Sock),
<a name="2843"/> 2843:                            {ok, maps:remove(csock, State)}
<a name="2844"/> 2844:                    end},
<a name="2845"/> 2845:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="2846"/> 2846:            cmd  =&gt; fun(#{domain   := local,
<a name="2847"/> 2847:                          lsock    := Sock,
<a name="2848"/> 2848:                          local_sa := #{path := Path}} = State) -&gt;
<a name="2849"/> 2849:                            ok = socket:close(Sock),
<a name="2850"/> 2850:                            State1 =
<a name="2851"/> 2851:                                unlink_path(Path,
<a name="2852"/> 2852:                                            fun() -&gt;
<a name="2853"/> 2853:                                                    maps:remove(local_sa, State)
<a name="2854"/> 2854:                                            end,
<a name="2855"/> 2855:                                            fun() -&gt; State end),
<a name="2856"/> 2856:                            {ok, maps:remove(lsock, State1)};
<a name="2857"/> 2857:                       (#{lsock := LSock} = State) -&gt;
<a name="2858"/> 2858:                            case socket:close(LSock) of
<a name="2859"/> 2859:                                ok -&gt;
<a name="2860"/> 2860:                                    {ok, maps:remove(lsock, State)};
<a name="2861"/> 2861:                                {error, _} = ERROR -&gt;
<a name="2862"/> 2862:                                    ERROR
<a name="2863"/> 2863:                            end
<a name="2864"/> 2864:                    end},
<a name="2865"/> 2865: 
<a name="2866"/> 2866:          %% *** We are done ***
<a name="2867"/> 2867:          ?SEV_FINISH_NORMAL
<a name="2868"/> 2868:         ],
<a name="2869"/> 2869: 
<a name="2870"/> 2870:     ClientSeq =
<a name="2871"/> 2871:         [
<a name="2872"/> 2872:          %% *** Wait for start order ***
<a name="2873"/> 2873:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="2874"/> 2874:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="2875"/> 2875:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="2876"/> 2876:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="2877"/> 2877:                       (State) -&gt;
<a name="2878"/> 2878:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="2879"/> 2879:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="2880"/> 2880:                    end},
<a name="2881"/> 2881:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="2882"/> 2882:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2883"/> 2883:                            _MRef = erlang:monitor(process, Tester),
<a name="2884"/> 2884:                            ok
<a name="2885"/> 2885:                    end},
<a name="2886"/> 2886: 
<a name="2887"/> 2887:          %% *** The init part ***
<a name="2888"/> 2888:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="2889"/> 2889:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="2890"/> 2890:                          server_path := Path} = State) -&gt;
<a name="2891"/> 2891:                            LSA = which_local_socket_addr(Domain),
<a name="2892"/> 2892:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="2893"/> 2893:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="2894"/> 2894:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="2895"/> 2895:                            LSA = which_local_socket_addr(Domain),
<a name="2896"/> 2896:                            SSA = LSA#{port =&gt; Port},
<a name="2897"/> 2897:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="2898"/> 2898:                    end},
<a name="2899"/> 2899:          #{desc =&gt; &quot;create socket&quot;,
<a name="2900"/> 2900:            cmd  =&gt; fun(#{domain := Domain,
<a name="2901"/> 2901:                          type := Type,
<a name="2902"/> 2902:                          proto  := Proto} = State) -&gt;
<a name="2903"/> 2903:                            case socket:open(Domain, Type, Proto) of
<a name="2904"/> 2904:                                {ok, Sock} -&gt;
<a name="2905"/> 2905:                                    {ok, State#{sock =&gt; Sock}};
<a name="2906"/> 2906:                                {error, _} = ERROR -&gt;
<a name="2907"/> 2907:                                    ERROR
<a name="2908"/> 2908:                            end
<a name="2909"/> 2909:                    end},
<a name="2910"/> 2910:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="2911"/> 2911:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="2912"/> 2912:                            case sock_bind(Sock, LSA) of
<a name="2913"/> 2913:                                ok -&gt;
<a name="2914"/> 2914:                                    ok;
<a name="2915"/> 2915:                                {error, _} = ERROR -&gt;
<a name="2916"/> 2916:                                    ERROR
<a name="2917"/> 2917:                            end
<a name="2918"/> 2918:                    end},
<a name="2919"/> 2919:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="2920"/> 2920:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2921"/> 2921:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="2922"/> 2922:                            ok
<a name="2923"/> 2923:                    end},
<a name="2924"/> 2924: 
<a name="2925"/> 2925:          %% *** The actual test ***
<a name="2926"/> 2926:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="2927"/> 2927:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="2928"/> 2928:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="2929"/> 2929:                    end},
<a name="2930"/> 2930:          #{desc =&gt; &quot;connect to server&quot;,
<a name="2931"/> 2931:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="2932"/> 2932:                            socket:connect(Sock, SSA)
<a name="2933"/> 2933:                    end},
<a name="2934"/> 2934:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="2935"/> 2935:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2936"/> 2936:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="2937"/> 2937:                            ok
<a name="2938"/> 2938:                    end},
<a name="2939"/> 2939:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="2940"/> 2940:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="2941"/> 2941:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="2942"/> 2942:                    end},
<a name="2943"/> 2943: 
<a name="2944"/> 2944:          #{desc =&gt; &quot;send request (to server)&quot;,
<a name="2945"/> 2945:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="2946"/> 2946:                            Send(Sock, ?REQ_IOV_SND)
<a name="2947"/> 2947:                    end},
<a name="2948"/> 2948: 
<a name="2949"/> 2949:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="2950"/> 2950:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2951"/> 2951:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="2952"/> 2952:                            ok
<a name="2953"/> 2953:                    end},
<a name="2954"/> 2954:          #{desc =&gt; &quot;await recv reply (from server)&quot;,
<a name="2955"/> 2955:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="2956"/> 2956:                            Rep = ?REP_IOV_RCV,
<a name="2957"/> 2957:                            {ok, Rep} = Recv(Sock),
<a name="2958"/> 2958:                            ok
<a name="2959"/> 2959:                    end},
<a name="2960"/> 2960:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="2961"/> 2961:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="2962"/> 2962:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="2963"/> 2963:                            ok
<a name="2964"/> 2964:                    end},
<a name="2965"/> 2965: 
<a name="2966"/> 2966:          %% *** Termination ***
<a name="2967"/> 2967:          #{desc =&gt; &quot;await terminate&quot;,
<a name="2968"/> 2968:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="2969"/> 2969:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="2970"/> 2970:                                ok -&gt;
<a name="2971"/> 2971:                                    {ok, maps:remove(tester, State)};
<a name="2972"/> 2972:                                {error, _} = ERROR -&gt;
<a name="2973"/> 2973:                                    ERROR
<a name="2974"/> 2974:                            end
<a name="2975"/> 2975:                    end},
<a name="2976"/> 2976:          #{desc =&gt; &quot;close socket&quot;,
<a name="2977"/> 2977:            cmd  =&gt; fun(#{domain   := local,
<a name="2978"/> 2978:                          sock     := Sock,
<a name="2979"/> 2979:                          local_sa := #{path := Path}} = State) -&gt;
<a name="2980"/> 2980:                            ok = socket:close(Sock),
<a name="2981"/> 2981:                            State1 =
<a name="2982"/> 2982:                                unlink_path(Path,
<a name="2983"/> 2983:                                            fun() -&gt;
<a name="2984"/> 2984:                                                    maps:remove(local_sa, State)
<a name="2985"/> 2985:                                            end,
<a name="2986"/> 2986:                                            fun() -&gt; State end),
<a name="2987"/> 2987:                            {ok, maps:remove(sock, State1)};
<a name="2988"/> 2988:                       (#{sock := Sock} = State) -&gt;
<a name="2989"/> 2989:                            ok = socket:close(Sock),
<a name="2990"/> 2990:                            {ok, maps:remove(sock, State)}
<a name="2991"/> 2991:                    end},
<a name="2992"/> 2992: 
<a name="2993"/> 2993:          %% *** We are done ***
<a name="2994"/> 2994:          ?SEV_FINISH_NORMAL
<a name="2995"/> 2995:         ],
<a name="2996"/> 2996: 
<a name="2997"/> 2997:     TesterSeq =
<a name="2998"/> 2998:         [
<a name="2999"/> 2999:          %% *** Init part ***
<a name="3000"/> 3000:          #{desc =&gt; &quot;monitor server&quot;,
<a name="3001"/> 3001:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="3002"/> 3002:                            _MRef = erlang:monitor(process, Pid),
<a name="3003"/> 3003:                            ok
<a name="3004"/> 3004:                    end},
<a name="3005"/> 3005:          #{desc =&gt; &quot;monitor client&quot;,
<a name="3006"/> 3006:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="3007"/> 3007:                            _MRef = erlang:monitor(process, Pid),
<a name="3008"/> 3008:                            ok
<a name="3009"/> 3009:                    end},
<a name="3010"/> 3010: 
<a name="3011"/> 3011:          %% Start the server
<a name="3012"/> 3012:          #{desc =&gt; &quot;order server start&quot;,
<a name="3013"/> 3013:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="3014"/> 3014:                            ?SEV_ANNOUNCE_START(Pid),
<a name="3015"/> 3015:                            ok
<a name="3016"/> 3016:                    end},
<a name="3017"/> 3017:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="3018"/> 3018:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="3019"/> 3019:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="3020"/> 3020:                            {ok, State#{server_port =&gt; Port}}
<a name="3021"/> 3021:                    end},
<a name="3022"/> 3022: 
<a name="3023"/> 3023:          %% Start the client
<a name="3024"/> 3024:          #{desc =&gt; &quot;order client start&quot;,
<a name="3025"/> 3025:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="3026"/> 3026:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="3027"/> 3027:                            ok
<a name="3028"/> 3028:                    end},
<a name="3029"/> 3029:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="3030"/> 3030:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="3031"/> 3031:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="3032"/> 3032:                    end},
<a name="3033"/> 3033: 
<a name="3034"/> 3034:          %% *** The actual test ***
<a name="3035"/> 3035:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="3036"/> 3036:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3037"/> 3037:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="3038"/> 3038:                            ok
<a name="3039"/> 3039:                    end},
<a name="3040"/> 3040:          ?SEV_SLEEP(?SECS(1)),
<a name="3041"/> 3041:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="3042"/> 3042:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3043"/> 3043:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="3044"/> 3044:                            ok
<a name="3045"/> 3045:                    end},
<a name="3046"/> 3046:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="3047"/> 3047:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3048"/> 3048:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="3049"/> 3049:                    end},
<a name="3050"/> 3050:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="3051"/> 3051:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3052"/> 3052:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="3053"/> 3053:                    end},
<a name="3054"/> 3054:          #{desc =&gt; &quot;order client to continue (with send request)&quot;,
<a name="3055"/> 3055:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3056"/> 3056:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="3057"/> 3057:                            ok
<a name="3058"/> 3058:                    end},
<a name="3059"/> 3059:          #{desc =&gt; &quot;await client ready (with send request)&quot;,
<a name="3060"/> 3060:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3061"/> 3061:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="3062"/> 3062:                    end},
<a name="3063"/> 3063:          #{desc =&gt; &quot;await server ready (request recv)&quot;,
<a name="3064"/> 3064:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3065"/> 3065:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="3066"/> 3066:                    end},
<a name="3067"/> 3067:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="3068"/> 3068:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3069"/> 3069:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="3070"/> 3070:                            ok
<a name="3071"/> 3071:                    end},
<a name="3072"/> 3072:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="3073"/> 3073:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3074"/> 3074:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="3075"/> 3075:                    end},
<a name="3076"/> 3076:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="3077"/> 3077:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3078"/> 3078:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="3079"/> 3079:                    end},
<a name="3080"/> 3080: 
<a name="3081"/> 3081: 
<a name="3082"/> 3082:          %% *** Termination ***
<a name="3083"/> 3083:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="3084"/> 3084:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="3085"/> 3085:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="3086"/> 3086:                            ok
<a name="3087"/> 3087:                    end},
<a name="3088"/> 3088:          #{desc =&gt; &quot;await client termination&quot;,
<a name="3089"/> 3089:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="3090"/> 3090:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="3091"/> 3091:                            State1 = maps:remove(client, State),
<a name="3092"/> 3092:                            {ok, State1}
<a name="3093"/> 3093:                    end},
<a name="3094"/> 3094:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="3095"/> 3095:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="3096"/> 3096:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="3097"/> 3097:                            ok
<a name="3098"/> 3098:                    end},
<a name="3099"/> 3099:          #{desc =&gt; &quot;await server termination&quot;,
<a name="3100"/> 3100:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="3101"/> 3101:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="3102"/> 3102:                            State1 = maps:remove(server, State),
<a name="3103"/> 3103:                            {ok, State1}
<a name="3104"/> 3104:                    end},
<a name="3105"/> 3105: 
<a name="3106"/> 3106:          %% *** We are done ***
<a name="3107"/> 3107:          ?SEV_FINISH_NORMAL
<a name="3108"/> 3108:         ],
<a name="3109"/> 3109: 
<a name="3110"/> 3110:     i(&quot;start server evaluator&quot;),
<a name="3111"/> 3111:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="3112"/> 3112: 
<a name="3113"/> 3113:     i(&quot;start client evaluator&quot;),
<a name="3114"/> 3114:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="3115"/> 3115:     i(&quot;await evaluator(s)&quot;),
<a name="3116"/> 3116: 
<a name="3117"/> 3117:     i(&quot;start tester evaluator&quot;),
<a name="3118"/> 3118:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="3119"/> 3119:                         client =&gt; Client#ev.pid},
<a name="3120"/> 3120:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="3121"/> 3121: 
<a name="api_b_sendv-last_expr"/><a name="3122"/> 3122: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="3123"/> 3123: 
<a name="3124"/> 3124: 
<a name="3125"/> 3125: 
<a name="3126"/> 3126: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3127"/> 3127: 
<a name="3128"/> 3128: <i>%% Basically send and receive on an IPv4 SCTP (stream) socket</i>
<a name="3129"/> 3129: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_stream_sctp4-1"/><a name="3130"/> 3130: <b>api_b_sendmsg_and_recvmsg_stream_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3131"/> 3131:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_stream_sctp4-last_expr"/><a name="3132"/> 3132: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3133"/> 3133:            fun() -&gt;
<a name="3134"/> 3134: 		   has_support_sctp(),
<a name="3135"/> 3135:                    has_support_ipv4()%% ,
<a name="3136"/> 3136: 		   %% not_yet_implemented()
<a name="3137"/> 3137: 	   end,
<a name="3138"/> 3138:            fun() -&gt;
<a name="3139"/> 3139:                    Send = fun(Sock, Data) -&gt;
<a name="3140"/> 3140:                                   %% CMsg  = #{level =&gt; sctp,
<a name="3141"/> 3141:                                   %%              type  =&gt; tos,
<a name="3142"/> 3142:                                   %%              data  =&gt; reliability},
<a name="3143"/> 3143:                                   %% CMsgs = [CMsg],
<a name="3144"/> 3144:                                   Msg = #{%% ctrl =&gt; CMsgs,
<a name="3145"/> 3145:                                           iov  =&gt; [Data]},
<a name="3146"/> 3146:                                   socket:sendmsg(Sock, Msg)
<a name="3147"/> 3147:                           end,
<a name="3148"/> 3148:                    Recv = fun(Sock) -&gt;
<a name="3149"/> 3149:                                   case socket:recvmsg(Sock) of
<a name="3150"/> 3150:                                       {ok, #{flags := [eor],
<a name="3151"/> 3151:                                              addr  := _,
<a name="3152"/> 3152:                                              iov   := [Data]}} -&gt;
<a name="3153"/> 3153:                                           {ok, Data};
<a name="3154"/> 3154:                                       {ok, Msg} -&gt;
<a name="3155"/> 3155:                                           {error, {msg, Msg}};
<a name="3156"/> 3156:                                       %% {ok, #{addr  := Source,
<a name="3157"/> 3157:                                       %%        iov   := [Data]}} -&gt;
<a name="3158"/> 3158:                                       %%     {ok, {Source, Data}};
<a name="3159"/> 3159:                                       {error, _} = ERROR -&gt;
<a name="3160"/> 3160:                                           ERROR
<a name="3161"/> 3161:                                   end
<a name="3162"/> 3162:                           end,
<a name="3163"/> 3163:                    InitState = #{domain =&gt; inet,
<a name="3164"/> 3164:                                  type   =&gt; stream,
<a name="3165"/> 3165:                                  proto  =&gt; sctp,
<a name="3166"/> 3166:                                  send   =&gt; Send,
<a name="3167"/> 3167:                                  recv   =&gt; Recv},
<a name="3168"/> 3168:                    %% ok = api_b_send_and_recv_sctp(InitState)
<a name="3169"/> 3169:                    ok = api_b_send_and_recv_conn(InitState)
<a name="3170"/> 3170:            end).
<a name="3171"/> 3171: 
<a name="3172"/> 3172: 
<a name="3173"/> 3173: 
<a name="3174"/> 3174: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3175"/> 3175: 
<a name="3176"/> 3176: <i>%% api_b_send_and_recv_sctp(_InitState) -&gt;</i>
<a name="3177"/> 3177: <i>%%     Seq = </i>
<a name="3178"/> 3178: <i>%%         [</i>
<a name="3179"/> 3179: <i>%%          #{desc =&gt; &quot;local address&quot;,</i>
<a name="3180"/> 3180: <i>%%            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;</i>
<a name="3181"/> 3181: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="3182"/> 3182: <i>%%                            {ok, State#{lsa_src =&gt; LSA,</i>
<a name="3183"/> 3183: <i>%%                                        lsa_dst =&gt; LSA}}</i>
<a name="3184"/> 3184: <i>%%                    end},</i>
<a name="3185"/> 3185: 
<a name="3186"/> 3186: <i>%%          #{desc =&gt; &quot;open src socket&quot;,</i>
<a name="3187"/> 3187: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="3188"/> 3188: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="3189"/> 3189: <i>%%                            Sock = sock_open(Domain, seqpacket, Proto),</i>
<a name="3190"/> 3190: <i>%%                            {ok, State#{sock_src =&gt; Sock}}</i>
<a name="3191"/> 3191: <i>%%                    end},</i>
<a name="3192"/> 3192: <i>%%          #{desc =&gt; &quot;bind src&quot;,</i>
<a name="3193"/> 3193: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;</i>
<a name="3194"/> 3194: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="3195"/> 3195: <i>%%                                ok -&gt;</i>
<a name="3196"/> 3196: <i>%%                                    ?SEV_IPRINT(&quot;src bound&quot;),</i>
<a name="3197"/> 3197: <i>%%                                    ok;</i>
<a name="3198"/> 3198: <i>%%                                {error, Reason} = ERROR -&gt;</i>
<a name="3199"/> 3199: <i>%%                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),</i>
<a name="3200"/> 3200: <i>%%                                    ERROR</i>
<a name="3201"/> 3201: <i>%%                            end</i>
<a name="3202"/> 3202: <i>%%                    end},</i>
<a name="3203"/> 3203: <i>%%          #{desc =&gt; &quot;sockname src socket&quot;,</i>
<a name="3204"/> 3204: <i>%%            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;</i>
<a name="3205"/> 3205: <i>%%                            SASrc = sock_sockname(Sock),</i>
<a name="3206"/> 3206: <i>%%                            ?SEV_IPRINT(&quot;src sockaddr: &quot;</i>
<a name="3207"/> 3207: <i>%%                                        &quot;~n   ~p&quot;, [SASrc]),</i>
<a name="3208"/> 3208: <i>%%                            {ok, State#{sa_src =&gt; SASrc}}</i>
<a name="3209"/> 3209: <i>%%                    end},</i>
<a name="3210"/> 3210: 
<a name="3211"/> 3211: <i>%%          #{desc =&gt; &quot;open dst socket&quot;,</i>
<a name="3212"/> 3212: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="3213"/> 3213: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="3214"/> 3214: <i>%%                            Sock = sock_open(Domain, seqpacket, Proto),</i>
<a name="3215"/> 3215: <i>%%                            {ok, State#{sock_dst =&gt; Sock}}</i>
<a name="3216"/> 3216: <i>%%                    end},</i>
<a name="3217"/> 3217: <i>%%          #{desc =&gt; &quot;bind dst&quot;,</i>
<a name="3218"/> 3218: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;</i>
<a name="3219"/> 3219: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="3220"/> 3220: <i>%%                                ok -&gt;</i>
<a name="3221"/> 3221: <i>%%                                    ?SEV_IPRINT(&quot;src bound&quot;),</i>
<a name="3222"/> 3222: <i>%%                                    ok;</i>
<a name="3223"/> 3223: <i>%%                                {error, Reason} = ERROR -&gt;</i>
<a name="3224"/> 3224: <i>%%                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),</i>
<a name="3225"/> 3225: <i>%%                                    ERROR</i>
<a name="3226"/> 3226: <i>%%                            end</i>
<a name="3227"/> 3227: <i>%%                    end},</i>
<a name="3228"/> 3228: <i>%%          #{desc =&gt; &quot;sockname dst socket&quot;,</i>
<a name="3229"/> 3229: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;</i>
<a name="3230"/> 3230: <i>%%                            SADst = sock_sockname(Sock),</i>
<a name="3231"/> 3231: <i>%%                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;</i>
<a name="3232"/> 3232: <i>%%                                        &quot;~n   ~p&quot;, [SADst]),</i>
<a name="3233"/> 3233: <i>%%                            {ok, State#{sa_dst =&gt; SADst}}</i>
<a name="3234"/> 3234: <i>%%                    end},</i>
<a name="3235"/> 3235: <i>%%          #{desc =&gt; &quot;send req (to dst)&quot;,</i>
<a name="3236"/> 3236: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;</i>
<a name="3237"/> 3237: <i>%%                            Send(Sock, ?BASIC_REQ, Dst)</i>
<a name="3238"/> 3238: <i>%%                    end},</i>
<a name="3239"/> 3239: <i>%%          #{desc =&gt; &quot;recv req (from src)&quot;,</i>
<a name="3240"/> 3240: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;</i>
<a name="3241"/> 3241: <i>%%                            case Recv(Sock) of</i>
<a name="3242"/> 3242: <i>%%                                {ok, {Src, ?BASIC_REQ}} -&gt;</i>
<a name="3243"/> 3243: <i>%%                                    ok;</i>
<a name="3244"/> 3244: <i>%%                                {ok, UnexpData} -&gt;</i>
<a name="3245"/> 3245: <i>%%                                    {error, {unexpected_data, UnexpData}};</i>
<a name="3246"/> 3246: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3247"/> 3247: <i>%%                                    %% At the moment there is no way to get</i>
<a name="3248"/> 3248: <i>%%                                    %% status or state for the socket...</i>
<a name="3249"/> 3249: <i>%%                                    ERROR</i>
<a name="3250"/> 3250: <i>%%                            end</i>
<a name="3251"/> 3251: <i>%%                    end},</i>
<a name="3252"/> 3252: <i>%%          #{desc =&gt; &quot;send rep (to src)&quot;,</i>
<a name="3253"/> 3253: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;</i>
<a name="3254"/> 3254: <i>%%                            Send(Sock, ?BASIC_REP, Src)</i>
<a name="3255"/> 3255: <i>%%                    end},</i>
<a name="3256"/> 3256: <i>%%          #{desc =&gt; &quot;recv rep (from dst)&quot;,</i>
<a name="3257"/> 3257: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;</i>
<a name="3258"/> 3258: <i>%%                            case Recv(Sock) of</i>
<a name="3259"/> 3259: <i>%%                                {ok, {Dst, ?BASIC_REP}} -&gt;</i>
<a name="3260"/> 3260: <i>%%                                    ok;</i>
<a name="3261"/> 3261: <i>%%                                {ok, UnexpData} -&gt;</i>
<a name="3262"/> 3262: <i>%%                                    {error, {unexpected_data, UnexpData}};</i>
<a name="3263"/> 3263: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3264"/> 3264: <i>%%                                    %% At the moment there is no way to get</i>
<a name="3265"/> 3265: <i>%%                                    %% status or state for the socket...</i>
<a name="3266"/> 3266: <i>%%                                    ERROR</i>
<a name="3267"/> 3267: <i>%%                            end</i>
<a name="3268"/> 3268: <i>%%                    end},</i>
<a name="3269"/> 3269: <i>%%          #{desc =&gt; &quot;close src socket&quot;,</i>
<a name="3270"/> 3270: <i>%%            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;</i>
<a name="3271"/> 3271: <i>%%                            ok = socket:close(Sock),</i>
<a name="3272"/> 3272: <i>%%                            {ok, maps:remove(sock_src, State)}</i>
<a name="3273"/> 3273: <i>%%                    end},</i>
<a name="3274"/> 3274: <i>%%          #{desc =&gt; &quot;close dst socket&quot;,</i>
<a name="3275"/> 3275: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;</i>
<a name="3276"/> 3276: <i>%%                            ok = socket:close(Sock),</i>
<a name="3277"/> 3277: <i>%%                            {ok, maps:remove(sock_dst, State)}</i>
<a name="3278"/> 3278: <i>%%                    end},</i>
<a name="3279"/> 3279: 
<a name="3280"/> 3280: <i>%%          %% *** We are done ***</i>
<a name="3281"/> 3281: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="3282"/> 3282: <i>%%         ],</i>
<a name="3283"/> 3283: <i>%%     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),</i>
<a name="3284"/> 3284: <i>%%     ok = ?SEV_AWAIT_FINISH([Evaluator]).</i>
<a name="3285"/> 3285: 
<a name="3286"/> 3286: <i>%%     process_flag(trap_exit, true),</i>
<a name="3287"/> 3287: <i>%%     ServerSeq = </i>
<a name="3288"/> 3288: <i>%%         [</i>
<a name="3289"/> 3289: <i>%%          %% *** Wait for start order ***</i>
<a name="3290"/> 3290: <i>%%          #{desc =&gt; &quot;await start (from tester)&quot;,</i>
<a name="3291"/> 3291: <i>%%            cmd  =&gt; fun(State) -&gt;</i>
<a name="3292"/> 3292: <i>%%                            Tester = ?SEV_AWAIT_START(),</i>
<a name="3293"/> 3293: <i>%%                            {ok, State#{tester =&gt; Tester}}</i>
<a name="3294"/> 3294: <i>%%                    end},</i>
<a name="3295"/> 3295: <i>%%          #{desc =&gt; &quot;monitor tester&quot;,</i>
<a name="3296"/> 3296: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3297"/> 3297: <i>%%                            _MRef = erlang:monitor(process, Tester),</i>
<a name="3298"/> 3298: <i>%%                            ok</i>
<a name="3299"/> 3299: <i>%%                    end},</i>
<a name="3300"/> 3300: 
<a name="3301"/> 3301: <i>%%          %% *** Init part ***</i>
<a name="3302"/> 3302: <i>%%          #{desc =&gt; &quot;which local address&quot;,</i>
<a name="3303"/> 3303: <i>%%            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;</i>
<a name="3304"/> 3304: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="3305"/> 3305: <i>%%                            {ok, State#{lsa =&gt; LSA}}</i>
<a name="3306"/> 3306: <i>%%                    end},</i>
<a name="3307"/> 3307: <i>%%          #{desc =&gt; &quot;create (listen) socket&quot;,</i>
<a name="3308"/> 3308: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="3309"/> 3309: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="3310"/> 3310: <i>%%                            case socket:open(Domain, seqpacket, Proto) of</i>
<a name="3311"/> 3311: <i>%%                                {ok, Sock} -&gt;</i>
<a name="3312"/> 3312: <i>%%                                    {ok, State#{lsock =&gt; Sock}};</i>
<a name="3313"/> 3313: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3314"/> 3314: <i>%%                                    ERROR</i>
<a name="3315"/> 3315: <i>%%                            end</i>
<a name="3316"/> 3316: <i>%%                    end},</i>
<a name="3317"/> 3317: <i>%%          #{desc =&gt; &quot;bind to local address&quot;,</i>
<a name="3318"/> 3318: <i>%%            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;</i>
<a name="3319"/> 3319: <i>%%                            case socket:bind(LSock, LSA) of</i>
<a name="3320"/> 3320: <i>%%                                ok -&gt;</i>
<a name="3321"/> 3321: <i>%%                                    Port = sock_port(LSock),</i>
<a name="3322"/> 3322: <i>%%                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),</i>
<a name="3323"/> 3323: <i>%%                                    {ok, State#{lport =&gt; Port}};</i>
<a name="3324"/> 3324: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3325"/> 3325: <i>%%                                    ERROR</i>
<a name="3326"/> 3326: <i>%%                            end</i>
<a name="3327"/> 3327: <i>%%                    end},</i>
<a name="3328"/> 3328: <i>%%          #{desc =&gt; &quot;make listen socket&quot;,</i>
<a name="3329"/> 3329: <i>%%            cmd  =&gt; fun(#{lsock := LSock}) -&gt;</i>
<a name="3330"/> 3330: <i>%%                            socket:listen(LSock)</i>
<a name="3331"/> 3331: <i>%%                    end},</i>
<a name="3332"/> 3332: <i>%%          #{desc =&gt; &quot;announce ready (init)&quot;,</i>
<a name="3333"/> 3333: <i>%%            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;</i>
<a name="3334"/> 3334: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, init, Port),</i>
<a name="3335"/> 3335: <i>%%                            ok</i>
<a name="3336"/> 3336: <i>%%                    end},</i>
<a name="3337"/> 3337: 
<a name="3338"/> 3338: <i>%%          %% The actual test</i>
<a name="3339"/> 3339: <i>%%          #{desc =&gt; &quot;await continue (accept)&quot;,</i>
<a name="3340"/> 3340: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3341"/> 3341: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)</i>
<a name="3342"/> 3342: <i>%%                    end},</i>
<a name="3343"/> 3343: <i>%%          #{desc =&gt; &quot;accepting (await connection) FAKE&quot;,</i>
<a name="3344"/> 3344: <i>%%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="3345"/> 3345: <i>%% 			   {ok, State#{csock =&gt; LSock}}</i>
<a name="3346"/> 3346: <i>%%                    end},</i>
<a name="3347"/> 3347: <i>%% %%          #{desc =&gt; &quot;accepting (await connection)&quot;,</i>
<a name="3348"/> 3348: <i>%% %%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="3349"/> 3349: <i>%% %% 			   socket:setopt(LSock, otp, debug, true),</i>
<a name="3350"/> 3350: <i>%% %%                            case socket:accept(LSock) of</i>
<a name="3351"/> 3351: <i>%% %%                                {ok, Sock} -&gt;</i>
<a name="3352"/> 3352: <i>%% %% 				   socket:setopt(LSock, otp, debug, false),</i>
<a name="3353"/> 3353: <i>%% %%                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),</i>
<a name="3354"/> 3354: <i>%% %%                                    {ok, State#{csock =&gt; Sock}};</i>
<a name="3355"/> 3355: <i>%% %%                                {error, Reason} = ERROR -&gt;</i>
<a name="3356"/> 3356: <i>%% %% 				   socket:setopt(LSock, otp, debug, false),</i>
<a name="3357"/> 3357: <i>%% %% 				   ?SEV_EPRINT(&quot;Failed accepting: &quot;</i>
<a name="3358"/> 3358: <i>%% %% 					       &quot;~n   ~p&quot;, [Reason]),</i>
<a name="3359"/> 3359: <i>%% %%                                    ERROR</i>
<a name="3360"/> 3360: <i>%% %%                            end</i>
<a name="3361"/> 3361: <i>%% %%                    end},</i>
<a name="3362"/> 3362: <i>%%          #{desc =&gt; &quot;announce ready (accept)&quot;,</i>
<a name="3363"/> 3363: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3364"/> 3364: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, accept),</i>
<a name="3365"/> 3365: <i>%%                            ok</i>
<a name="3366"/> 3366: <i>%%                    end},</i>
<a name="3367"/> 3367: <i>%%          #{desc =&gt; &quot;await (recv) request&quot;,</i>
<a name="3368"/> 3368: <i>%%            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;</i>
<a name="3369"/> 3369: <i>%%                            case Recv(Sock) of</i>
<a name="3370"/> 3370: <i>%%                                {ok, ?BASIC_REQ} -&gt;</i>
<a name="3371"/> 3371: <i>%%                                    ok;</i>
<a name="3372"/> 3372: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3373"/> 3373: <i>%%                                    ERROR</i>
<a name="3374"/> 3374: <i>%%                            end</i>
<a name="3375"/> 3375: <i>%%                    end},</i>
<a name="3376"/> 3376: <i>%%          #{desc =&gt; &quot;announce ready (recv request)&quot;,</i>
<a name="3377"/> 3377: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3378"/> 3378: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, recv_req),</i>
<a name="3379"/> 3379: <i>%%                            ok</i>
<a name="3380"/> 3380: <i>%%                    end},</i>
<a name="3381"/> 3381: <i>%%          #{desc =&gt; &quot;await continue (with send reply)&quot;,</i>
<a name="3382"/> 3382: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3383"/> 3383: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)</i>
<a name="3384"/> 3384: <i>%%                    end},</i>
<a name="3385"/> 3385: <i>%%          #{desc =&gt; &quot;send reply&quot;,</i>
<a name="3386"/> 3386: <i>%%            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;</i>
<a name="3387"/> 3387: <i>%%                            Send(Sock, ?BASIC_REP)</i>
<a name="3388"/> 3388: <i>%%                    end},</i>
<a name="3389"/> 3389: <i>%%          #{desc =&gt; &quot;announce ready (send reply)&quot;,</i>
<a name="3390"/> 3390: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3391"/> 3391: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, send_reply),</i>
<a name="3392"/> 3392: <i>%%                            ok</i>
<a name="3393"/> 3393: <i>%%                    end},</i>
<a name="3394"/> 3394: 
<a name="3395"/> 3395: <i>%%          %% *** Termination ***</i>
<a name="3396"/> 3396: <i>%%          #{desc =&gt; &quot;await terminate&quot;,</i>
<a name="3397"/> 3397: <i>%%            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;</i>
<a name="3398"/> 3398: <i>%%                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of</i>
<a name="3399"/> 3399: <i>%%                                ok -&gt;</i>
<a name="3400"/> 3400: <i>%%                                    {ok, maps:remove(tester, State)};</i>
<a name="3401"/> 3401: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3402"/> 3402: <i>%%                                    ERROR</i>
<a name="3403"/> 3403: <i>%%                            end</i>
<a name="3404"/> 3404: <i>%%                    end},</i>
<a name="3405"/> 3405: <i>%%          #{desc =&gt; &quot;close connection socket&quot;,</i>
<a name="3406"/> 3406: <i>%%            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;</i>
<a name="3407"/> 3407: <i>%%                            ok = socket:close(Sock),</i>
<a name="3408"/> 3408: <i>%%                            {ok, maps:remove(csock, State)}</i>
<a name="3409"/> 3409: <i>%%                    end},</i>
<a name="3410"/> 3410: <i>%%          #{desc =&gt; &quot;close listen socket&quot;,</i>
<a name="3411"/> 3411: <i>%%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="3412"/> 3412: <i>%%                            case socket:close(LSock) of</i>
<a name="3413"/> 3413: <i>%%                                ok -&gt;</i>
<a name="3414"/> 3414: <i>%%                                    {ok, maps:remove(lsock, State)};</i>
<a name="3415"/> 3415: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3416"/> 3416: <i>%%                                    ERROR</i>
<a name="3417"/> 3417: <i>%%                            end</i>
<a name="3418"/> 3418: <i>%%                    end},</i>
<a name="3419"/> 3419: 
<a name="3420"/> 3420: <i>%%          %% *** We are done ***</i>
<a name="3421"/> 3421: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="3422"/> 3422: <i>%%         ],</i>
<a name="3423"/> 3423: 
<a name="3424"/> 3424: <i>%%     ClientSeq = </i>
<a name="3425"/> 3425: <i>%%         [</i>
<a name="3426"/> 3426: <i>%%          %% *** Wait for start order ***</i>
<a name="3427"/> 3427: <i>%%          #{desc =&gt; &quot;await start (from tester)&quot;,</i>
<a name="3428"/> 3428: <i>%%            cmd  =&gt; fun(State) -&gt;</i>
<a name="3429"/> 3429: <i>%%                            {Tester, Port} = ?SEV_AWAIT_START(),</i>
<a name="3430"/> 3430: <i>%%                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}</i>
<a name="3431"/> 3431: <i>%%                    end},</i>
<a name="3432"/> 3432: <i>%%          #{desc =&gt; &quot;monitor tester&quot;,</i>
<a name="3433"/> 3433: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3434"/> 3434: <i>%%                            _MRef = erlang:monitor(process, Tester),</i>
<a name="3435"/> 3435: <i>%%                            ok</i>
<a name="3436"/> 3436: <i>%%                    end},</i>
<a name="3437"/> 3437: 
<a name="3438"/> 3438: <i>%%          %% *** The init part ***</i>
<a name="3439"/> 3439: <i>%%          #{desc =&gt; &quot;which server (local) address&quot;,</i>
<a name="3440"/> 3440: <i>%%            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;</i>
<a name="3441"/> 3441: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="3442"/> 3442: <i>%%                            SSA = LSA#{port =&gt; Port},</i>
<a name="3443"/> 3443: <i>%%                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}</i>
<a name="3444"/> 3444: <i>%%                    end},</i>
<a name="3445"/> 3445: <i>%%          #{desc =&gt; &quot;create socket&quot;,</i>
<a name="3446"/> 3446: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="3447"/> 3447: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="3448"/> 3448: <i>%%                            case socket:open(Domain, seqpacket, Proto) of</i>
<a name="3449"/> 3449: <i>%%                                {ok, Sock} -&gt;</i>
<a name="3450"/> 3450: <i>%%                                    {ok, State#{sock =&gt; Sock}};</i>
<a name="3451"/> 3451: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3452"/> 3452: <i>%%                                    ERROR</i>
<a name="3453"/> 3453: <i>%%                            end</i>
<a name="3454"/> 3454: <i>%%                    end},</i>
<a name="3455"/> 3455: <i>%%          #{desc =&gt; &quot;bind to local address&quot;,</i>
<a name="3456"/> 3456: <i>%%            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;</i>
<a name="3457"/> 3457: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="3458"/> 3458: <i>%%                                ok -&gt;</i>
<a name="3459"/> 3459: <i>%%                                    ok;</i>
<a name="3460"/> 3460: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3461"/> 3461: <i>%%                                    ERROR</i>
<a name="3462"/> 3462: <i>%%                            end</i>
<a name="3463"/> 3463: <i>%%                    end},</i>
<a name="3464"/> 3464: <i>%%          #{desc =&gt; &quot;announce ready (init)&quot;,</i>
<a name="3465"/> 3465: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3466"/> 3466: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, init),</i>
<a name="3467"/> 3467: <i>%%                            ok</i>
<a name="3468"/> 3468: <i>%%                    end},</i>
<a name="3469"/> 3469: 
<a name="3470"/> 3470: <i>%%          %% *** The actual test ***</i>
<a name="3471"/> 3471: <i>%%          #{desc =&gt; &quot;await continue (connect)&quot;,</i>
<a name="3472"/> 3472: <i>%%            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;</i>
<a name="3473"/> 3473: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)</i>
<a name="3474"/> 3474: <i>%%                    end},</i>
<a name="3475"/> 3475: <i>%%          #{desc =&gt; &quot;connect to server&quot;,</i>
<a name="3476"/> 3476: <i>%%            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;</i>
<a name="3477"/> 3477: <i>%%                            case socket:connect(Sock, SSA) of</i>
<a name="3478"/> 3478: <i>%% 			       ok -&gt;</i>
<a name="3479"/> 3479: <i>%% 				   ?SEV_IPRINT(&quot;connected&quot;),</i>
<a name="3480"/> 3480: <i>%% 				   ok;</i>
<a name="3481"/> 3481: <i>%% 			       {error, Reason} = ERROR -&gt;</i>
<a name="3482"/> 3482: <i>%% 				   ?SEV_EPRINT(&quot;Failed connect: &quot;</i>
<a name="3483"/> 3483: <i>%% 					       &quot;~n   ~p&quot;, [Reason]),</i>
<a name="3484"/> 3484: <i>%% 				   ERROR</i>
<a name="3485"/> 3485: <i>%% 			   end</i>
<a name="3486"/> 3486: <i>%%                    end},</i>
<a name="3487"/> 3487: <i>%%          #{desc =&gt; &quot;announce ready (connect)&quot;,</i>
<a name="3488"/> 3488: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3489"/> 3489: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, connect),</i>
<a name="3490"/> 3490: <i>%%                            ok</i>
<a name="3491"/> 3491: <i>%%                    end},</i>
<a name="3492"/> 3492: <i>%%          #{desc =&gt; &quot;await continue (send request)&quot;,</i>
<a name="3493"/> 3493: <i>%%            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;</i>
<a name="3494"/> 3494: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)</i>
<a name="3495"/> 3495: <i>%%                    end},</i>
<a name="3496"/> 3496: <i>%%          #{desc =&gt; &quot;send request (to server)&quot;,</i>
<a name="3497"/> 3497: <i>%%            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;</i>
<a name="3498"/> 3498: <i>%%                            Send(Sock, ?BASIC_REQ)</i>
<a name="3499"/> 3499: <i>%%                    end},</i>
<a name="3500"/> 3500: <i>%%          #{desc =&gt; &quot;announce ready (send request)&quot;,</i>
<a name="3501"/> 3501: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3502"/> 3502: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, send_req),</i>
<a name="3503"/> 3503: <i>%%                            ok</i>
<a name="3504"/> 3504: <i>%%                    end},</i>
<a name="3505"/> 3505: <i>%%          #{desc =&gt; &quot;await recv reply (from server)&quot;,</i>
<a name="3506"/> 3506: <i>%%            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;</i>
<a name="3507"/> 3507: <i>%%                            {ok, ?BASIC_REP} = Recv(Sock),</i>
<a name="3508"/> 3508: <i>%%                            ok</i>
<a name="3509"/> 3509: <i>%%                    end},</i>
<a name="3510"/> 3510: <i>%%          #{desc =&gt; &quot;announce ready (recv reply)&quot;,</i>
<a name="3511"/> 3511: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="3512"/> 3512: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),</i>
<a name="3513"/> 3513: <i>%%                            ok</i>
<a name="3514"/> 3514: <i>%%                    end},</i>
<a name="3515"/> 3515: 
<a name="3516"/> 3516: <i>%%          %% *** Termination ***</i>
<a name="3517"/> 3517: <i>%%          #{desc =&gt; &quot;await terminate&quot;,</i>
<a name="3518"/> 3518: <i>%%            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;</i>
<a name="3519"/> 3519: <i>%%                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of</i>
<a name="3520"/> 3520: <i>%%                                ok -&gt;</i>
<a name="3521"/> 3521: <i>%%                                    {ok, maps:remove(tester, State)};</i>
<a name="3522"/> 3522: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="3523"/> 3523: <i>%%                                    ERROR</i>
<a name="3524"/> 3524: <i>%%                            end</i>
<a name="3525"/> 3525: <i>%%                    end},</i>
<a name="3526"/> 3526: <i>%%          #{desc =&gt; &quot;close socket&quot;,</i>
<a name="3527"/> 3527: <i>%%            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;</i>
<a name="3528"/> 3528: <i>%%                            ok = socket:close(Sock),</i>
<a name="3529"/> 3529: <i>%%                            {ok, maps:remove(sock, State)}</i>
<a name="3530"/> 3530: <i>%%                    end},</i>
<a name="3531"/> 3531: 
<a name="3532"/> 3532: <i>%%          %% *** We are done ***</i>
<a name="3533"/> 3533: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="3534"/> 3534: <i>%%         ],</i>
<a name="3535"/> 3535: 
<a name="3536"/> 3536: <i>%%     TesterSeq =</i>
<a name="3537"/> 3537: <i>%%         [</i>
<a name="3538"/> 3538: <i>%%          %% *** Init part ***</i>
<a name="3539"/> 3539: <i>%%          #{desc =&gt; &quot;monitor server&quot;,</i>
<a name="3540"/> 3540: <i>%%            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;</i>
<a name="3541"/> 3541: <i>%%                            _MRef = erlang:monitor(process, Pid),</i>
<a name="3542"/> 3542: <i>%%                            ok</i>
<a name="3543"/> 3543: <i>%%                    end},</i>
<a name="3544"/> 3544: <i>%%          #{desc =&gt; &quot;monitor client&quot;,</i>
<a name="3545"/> 3545: <i>%%            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;</i>
<a name="3546"/> 3546: <i>%%                            _MRef = erlang:monitor(process, Pid),</i>
<a name="3547"/> 3547: <i>%%                            ok</i>
<a name="3548"/> 3548: <i>%%                    end},</i>
<a name="3549"/> 3549: 
<a name="3550"/> 3550: <i>%%          %% Start the server</i>
<a name="3551"/> 3551: <i>%%          #{desc =&gt; &quot;order server start&quot;,</i>
<a name="3552"/> 3552: <i>%%            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;</i>
<a name="3553"/> 3553: <i>%%                            ?SEV_ANNOUNCE_START(Pid),</i>
<a name="3554"/> 3554: <i>%%                            ok</i>
<a name="3555"/> 3555: <i>%%                    end},</i>
<a name="3556"/> 3556: <i>%%          #{desc =&gt; &quot;await server ready (init)&quot;,</i>
<a name="3557"/> 3557: <i>%%            cmd  =&gt; fun(#{server := Pid} = State) -&gt;</i>
<a name="3558"/> 3558: <i>%%                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),</i>
<a name="3559"/> 3559: <i>%%                            {ok, State#{server_port =&gt; Port}}</i>
<a name="3560"/> 3560: <i>%%                    end},</i>
<a name="3561"/> 3561: 
<a name="3562"/> 3562: <i>%%          %% Start the client</i>
<a name="3563"/> 3563: <i>%%          #{desc =&gt; &quot;order client start&quot;,</i>
<a name="3564"/> 3564: <i>%%            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;</i>
<a name="3565"/> 3565: <i>%%                            ?SEV_ANNOUNCE_START(Pid, Port),</i>
<a name="3566"/> 3566: <i>%%                            ok</i>
<a name="3567"/> 3567: <i>%%                    end},</i>
<a name="3568"/> 3568: <i>%%          #{desc =&gt; &quot;await client ready (init)&quot;,</i>
<a name="3569"/> 3569: <i>%%            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;</i>
<a name="3570"/> 3570: <i>%%                            ok = ?SEV_AWAIT_READY(Pid, client, init)</i>
<a name="3571"/> 3571: <i>%%                    end},</i>
<a name="3572"/> 3572: 
<a name="3573"/> 3573: <i>%%          %% *** The actual test ***</i>
<a name="3574"/> 3574: <i>%%          #{desc =&gt; &quot;order server to continue (with accept)&quot;,</i>
<a name="3575"/> 3575: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3576"/> 3576: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),</i>
<a name="3577"/> 3577: <i>%%                            ok</i>
<a name="3578"/> 3578: <i>%%                    end},</i>
<a name="3579"/> 3579: <i>%%          ?SEV_SLEEP(?SECS(1)),</i>
<a name="3580"/> 3580: <i>%%          #{desc =&gt; &quot;order client to continue (with connect)&quot;,</i>
<a name="3581"/> 3581: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3582"/> 3582: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),</i>
<a name="3583"/> 3583: <i>%%                            ok</i>
<a name="3584"/> 3584: <i>%%                    end},</i>
<a name="3585"/> 3585: <i>%%          #{desc =&gt; &quot;await client ready (connect)&quot;,</i>
<a name="3586"/> 3586: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3587"/> 3587: <i>%%                            ?SEV_AWAIT_READY(Client, client, connect)</i>
<a name="3588"/> 3588: <i>%%                    end},</i>
<a name="3589"/> 3589: <i>%%          #{desc =&gt; &quot;await server ready (accept)&quot;,</i>
<a name="3590"/> 3590: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3591"/> 3591: <i>%%                            ?SEV_AWAIT_READY(Server, server, accept)</i>
<a name="3592"/> 3592: <i>%%                    end},</i>
<a name="3593"/> 3593: <i>%%          #{desc =&gt; &quot;order client to continue (with send request)&quot;,</i>
<a name="3594"/> 3594: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3595"/> 3595: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),</i>
<a name="3596"/> 3596: <i>%%                            ok</i>
<a name="3597"/> 3597: <i>%%                    end},</i>
<a name="3598"/> 3598: <i>%%          #{desc =&gt; &quot;await client ready (with send request)&quot;,</i>
<a name="3599"/> 3599: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3600"/> 3600: <i>%%                            ?SEV_AWAIT_READY(Client, client, send_req)</i>
<a name="3601"/> 3601: <i>%%                    end},</i>
<a name="3602"/> 3602: <i>%%          #{desc =&gt; &quot;await server ready (request recv)&quot;,</i>
<a name="3603"/> 3603: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3604"/> 3604: <i>%%                            ?SEV_AWAIT_READY(Server, server, recv_req)</i>
<a name="3605"/> 3605: <i>%%                    end},</i>
<a name="3606"/> 3606: <i>%%          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,</i>
<a name="3607"/> 3607: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3608"/> 3608: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),</i>
<a name="3609"/> 3609: <i>%%                            ok</i>
<a name="3610"/> 3610: <i>%%                    end},</i>
<a name="3611"/> 3611: <i>%%          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,</i>
<a name="3612"/> 3612: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3613"/> 3613: <i>%%                            ?SEV_AWAIT_READY(Server, server, send_reply)</i>
<a name="3614"/> 3614: <i>%%                    end},</i>
<a name="3615"/> 3615: <i>%%          #{desc =&gt; &quot;await client ready (reply recv)&quot;,</i>
<a name="3616"/> 3616: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3617"/> 3617: <i>%%                            ?SEV_AWAIT_READY(Client, client, recv_reply)</i>
<a name="3618"/> 3618: <i>%%                    end},</i>
<a name="3619"/> 3619: 
<a name="3620"/> 3620: 
<a name="3621"/> 3621: <i>%%          %% *** Termination ***</i>
<a name="3622"/> 3622: <i>%%          #{desc =&gt; &quot;order client to terminate&quot;,</i>
<a name="3623"/> 3623: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="3624"/> 3624: <i>%%                            ?SEV_ANNOUNCE_TERMINATE(Client),</i>
<a name="3625"/> 3625: <i>%%                            ok</i>
<a name="3626"/> 3626: <i>%%                    end},</i>
<a name="3627"/> 3627: <i>%%          #{desc =&gt; &quot;await client termination&quot;,</i>
<a name="3628"/> 3628: <i>%%            cmd  =&gt; fun(#{client := Client} = State) -&gt;</i>
<a name="3629"/> 3629: <i>%%                            ?SEV_AWAIT_TERMINATION(Client),</i>
<a name="3630"/> 3630: <i>%%                            State1 = maps:remove(client, State),</i>
<a name="3631"/> 3631: <i>%%                            {ok, State1}</i>
<a name="3632"/> 3632: <i>%%                    end},</i>
<a name="3633"/> 3633: <i>%%          #{desc =&gt; &quot;order server to terminate&quot;,</i>
<a name="3634"/> 3634: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="3635"/> 3635: <i>%%                            ?SEV_ANNOUNCE_TERMINATE(Server),</i>
<a name="3636"/> 3636: <i>%%                            ok</i>
<a name="3637"/> 3637: <i>%%                    end},</i>
<a name="3638"/> 3638: <i>%%          #{desc =&gt; &quot;await server termination&quot;,</i>
<a name="3639"/> 3639: <i>%%            cmd  =&gt; fun(#{server := Server} = State) -&gt;</i>
<a name="3640"/> 3640: <i>%%                            ?SEV_AWAIT_TERMINATION(Server),</i>
<a name="3641"/> 3641: <i>%%                            State1 = maps:remove(server, State),</i>
<a name="3642"/> 3642: <i>%%                            {ok, State1}</i>
<a name="3643"/> 3643: <i>%%                    end},</i>
<a name="3644"/> 3644: 
<a name="3645"/> 3645: <i>%%          %% *** We are done ***</i>
<a name="3646"/> 3646: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="3647"/> 3647: <i>%%         ],</i>
<a name="3648"/> 3648: 
<a name="3649"/> 3649: <i>%%     i(&quot;start server evaluator&quot;),</i>
<a name="3650"/> 3650: <i>%%     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),</i>
<a name="3651"/> 3651: 
<a name="3652"/> 3652: <i>%%     i(&quot;start client evaluator&quot;),</i>
<a name="3653"/> 3653: <i>%%     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),</i>
<a name="3654"/> 3654: <i>%%     i(&quot;await evaluator(s)&quot;),</i>
<a name="3655"/> 3655: 
<a name="3656"/> 3656: <i>%%     i(&quot;start tester evaluator&quot;),</i>
<a name="3657"/> 3657: <i>%%     TesterInitState = #{server =&gt; Server#ev.pid,</i>
<a name="3658"/> 3658: <i>%%                         client =&gt; Client#ev.pid},</i>
<a name="3659"/> 3659: <i>%%     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),</i>
<a name="3660"/> 3660: 
<a name="3661"/> 3661: <i>%%     ok = ?SEV_AWAIT_FINISH([Server, Client, Tester]).</i>
<a name="3662"/> 3662: 
<a name="3663"/> 3663: <i>%%     ok.</i>
<a name="3664"/> 3664: 
<a name="3665"/> 3665: 
<a name="3666"/> 3666: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3667"/> 3667: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3668"/> 3668: <i>%%                                                                     %%</i>
<a name="3669"/> 3669: <i>%%                           API IOV                                   %%</i>
<a name="3670"/> 3670: <i>%%                                                                     %%</i>
<a name="3671"/> 3671: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3672"/> 3672: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3673"/> 3673: 
<a name="api_b_sendmsg_iov_dgram_inet-1"/><a name="3674"/> 3674: <b>api_b_sendmsg_iov_dgram_inet</b>(Config) when is_list(Config) -&gt;
<a name="3675"/> 3675:     has_support_ipv4(),
<a name="api_b_sendmsg_iov_dgram_inet-last_expr"/><a name="3676"/> 3676: <b>    api_b_sendmsg_iov_dgram</b>(inet).
<a name="3677"/> 3677: <i>%%</i>
<a name="api_b_sendmsg_iov_dgram_inet6-1"/><a name="3678"/> 3678: <b>api_b_sendmsg_iov_dgram_inet6</b>(Config) when is_list(Config) -&gt;
<a name="3679"/> 3679:     has_support_ipv6(),
<a name="api_b_sendmsg_iov_dgram_inet6-last_expr"/><a name="3680"/> 3680: <b>    api_b_sendmsg_iov_dgram</b>(inet6).
<a name="3681"/> 3681: <i>%%</i>
<a name="api_b_sendmsg_iov_dgram_local-1"/><a name="3682"/> 3682: <b>api_b_sendmsg_iov_dgram_local</b>(Config) when is_list(Config) -&gt;
<a name="3683"/> 3683:     has_support_unix_domain_socket(),
<a name="3684"/> 3684:     is_not_windows(), % on Windows, local only works for stream sockets
<a name="api_b_sendmsg_iov_dgram_local-last_expr"/><a name="3685"/> 3685: <b>    api_b_sendmsg_iov_dgram</b>(local).
<a name="3686"/> 3686: 
<a name="api_b_sendmsg_iov_stream_inet-1"/><a name="3687"/> 3687: <b>api_b_sendmsg_iov_stream_inet</b>(Config) when is_list(Config) -&gt;
<a name="3688"/> 3688:     has_support_ipv4(),
<a name="3689"/> 3689:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_inet-last_expr"/><a name="3690"/> 3690: <b>    api_b_sendmsg_iov_stream</b>(inet).
<a name="3691"/> 3691: <i>%%</i>
<a name="api_b_sendmsg_iov_stream_inet6-1"/><a name="3692"/> 3692: <b>api_b_sendmsg_iov_stream_inet6</b>(Config) when is_list(Config) -&gt;
<a name="3693"/> 3693:     has_support_ipv6(),
<a name="3694"/> 3694:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_inet6-last_expr"/><a name="3695"/> 3695: <b>    api_b_sendmsg_iov_stream</b>(inet6).
<a name="3696"/> 3696: <i>%%</i>
<a name="api_b_sendmsg_iov_stream_local-1"/><a name="3697"/> 3697: <b>api_b_sendmsg_iov_stream_local</b>(Config) when is_list(Config) -&gt;
<a name="3698"/> 3698:     has_support_unix_domain_socket(),
<a name="3699"/> 3699:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_local-last_expr"/><a name="3700"/> 3700: <b>    api_b_sendmsg_iov_stream</b>(local).
<a name="3701"/> 3701: 
<a name="3702"/> 3702: 
<a name="api_b_sendmsg_iov_dgram-1"/><a name="3703"/> 3703: <b>api_b_sendmsg_iov_dgram</b>(Domain) -&gt;
<a name="3704"/> 3704:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; entry with&quot;
<a name="3705"/> 3705:        &quot;~n   Domain: ~p&quot;, [Domain]),
<a name="3706"/> 3706:     ?TT(?SECS(5)),
<a name="3707"/> 3707:     #{iov_max := IOVMax} = socket:info(),
<a name="3708"/> 3708:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; IOVMax: ~p&quot;, [IOVMax]),
<a name="3709"/> 3709:     IOV =
<a name="3710"/> 3710:         lists:map(
<a name="3711"/> 3711:           fun (N) -&gt; &lt;&lt;(rand:uniform(N) - 1)&gt;&gt; end,
<a name="3712"/> 3712:           lists:duplicate(IOVMax, 256)),
<a name="3713"/> 3713:     IOVTooLarge = IOV ++ IOV,
<a name="3714"/> 3714:     Data = erlang:iolist_to_binary(IOV),
<a name="3715"/> 3715:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: create socket&quot;),
<a name="3716"/> 3716:     {ok, Sa} = socket:open(Domain, dgram, #{debug =&gt; true}),
<a name="api_b_sendmsg_iov_dgram-last_expr"/><a name="3717"/> 3717:     try
<a name="3718"/> 3718: 	?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: create socket&quot;),
<a name="3719"/> 3719:         {ok, Sb} = socket:open(Domain, dgram),
<a name="3720"/> 3720:         try
<a name="3721"/> 3721: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: bind socket&quot;),
<a name="3722"/> 3722:             ok = socket:bind(Sa, which_local_socket_addr(Domain)),
<a name="3723"/> 3723: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: bind socket&quot;),
<a name="3724"/> 3724:             ok = socket:bind(Sb, which_local_socket_addr(Domain)),
<a name="3725"/> 3725: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: get sockname&quot;),
<a name="3726"/> 3726:             {ok, Aa} = socket:sockname(Sa),
<a name="3727"/> 3727: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: get sockname&quot;),
<a name="3728"/> 3728:             {ok, Ab} = socket:sockname(Sb),
<a name="3729"/> 3729:             %%
<a name="3730"/> 3730: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: sendmsg&quot;),
<a name="3731"/> 3731:             ok = socket:sendmsg(Sa, #{addr =&gt; Ab, iov =&gt; IOV}),
<a name="3732"/> 3732: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: recvfrom&quot;),
<a name="3733"/> 3733:             {ok, {Aa, Data}} = socket:recvfrom(Sb),
<a name="3734"/> 3734:             %%
<a name="3735"/> 3735: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: sendmsg (too large =&gt; fail)&quot;),
<a name="3736"/> 3736:             {error, {invalid, _}} =
<a name="3737"/> 3737:                 socket:sendmsg(Sb, #{addr =&gt; Aa, iov =&gt; IOVTooLarge}),
<a name="3738"/> 3738: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; done&quot;),
<a name="3739"/> 3739:             ok
<a name="3740"/> 3740:         after
<a name="3741"/> 3741: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: close socket&quot;),
<a name="3742"/> 3742:             socket:close(Sb)
<a name="3743"/> 3743:         end
<a name="3744"/> 3744:     after
<a name="3745"/> 3745: 	?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: close socket&quot;),
<a name="3746"/> 3746:         socket:close(Sa)
<a name="3747"/> 3747:     end.
<a name="3748"/> 3748: 
<a name="api_b_sendmsg_iov_stream-1"/><a name="3749"/> 3749: <b>api_b_sendmsg_iov_stream</b>(Domain) -&gt;
<a name="3750"/> 3750:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; entry with&quot;
<a name="3751"/> 3751:        &quot;~n   Domain: ~p&quot;, [Domain]),
<a name="3752"/> 3752:     ?TT(?SECS(5)),
<a name="3753"/> 3753:     #{iov_max := IOVMax} = socket:info(),
<a name="3754"/> 3754:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; IOVMax: ~p&quot;, [IOVMax]),
<a name="3755"/> 3755:     IOV =
<a name="3756"/> 3756:         lists:map(
<a name="3757"/> 3757:           fun (N) -&gt; &lt;&lt;(rand:uniform(N) - 1)&gt;&gt; end,
<a name="3758"/> 3758:           lists:duplicate(IOVMax, 256)),
<a name="3759"/> 3759:     IOVTooLarge = IOV ++ IOV,
<a name="3760"/> 3760:     Data = erlang:iolist_to_binary(IOV),
<a name="3761"/> 3761:     DataTooLarge = erlang:iolist_to_binary(IOVTooLarge),
<a name="3762"/> 3762:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; create stream socket a&quot;),
<a name="3763"/> 3763:     {ok, Sa} = socket:open(Domain, stream),
<a name="api_b_sendmsg_iov_stream-last_expr"/><a name="3764"/> 3764:     try
<a name="3765"/> 3765:         case os:type() of
<a name="3766"/> 3766:             {win32,nt} -&gt;
<a name="3767"/> 3767: 		?P(&quot;api_b_sendmsg_iov_stream-&gt; [win] a: bind socket&quot;),
<a name="3768"/> 3768:                 ok = socket:bind(Sa, which_local_socket_addr(Domain));
<a name="3769"/> 3769:             _ -&gt;
<a name="3770"/> 3770:                 ok
<a name="3771"/> 3771:         end,
<a name="3772"/> 3772: 	?P(&quot;api_b_sendmsg_iov_stream -&gt; create stream socket b&quot;),
<a name="3773"/> 3773:         {ok, Sb} = socket:open(Domain, stream),
<a name="3774"/> 3774:         try
<a name="3775"/> 3775: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: bind socket&quot;),
<a name="3776"/> 3776:             ok = socket:bind(Sb, which_local_socket_addr(Domain)),
<a name="3777"/> 3777: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: get sockname&quot;),
<a name="3778"/> 3778:             {ok, Ab} = socket:sockname(Sb),
<a name="3779"/> 3779: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: make socket listen&quot;),
<a name="3780"/> 3780:             ok = socket:listen(Sb),
<a name="3781"/> 3781: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: connect socket to b&quot;),
<a name="3782"/> 3782:             ok = socket:connect(Sa, Ab),
<a name="3783"/> 3783: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: get sockname&quot;),
<a name="3784"/> 3784:             {ok, Aa} = socket:sockname(Sa),
<a name="3785"/> 3785: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: get peername&quot;),
<a name="3786"/> 3786:             {ok, Ab} = socket:peername(Sa),
<a name="3787"/> 3787: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; accept connection (=&gt; c)&quot;),
<a name="3788"/> 3788:             {ok, Sc} = socket:accept(Sb),
<a name="3789"/> 3789:             try
<a name="3790"/> 3790: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: get sockname&quot;),
<a name="3791"/> 3791:                 {ok, Ab} = socket:sockname(Sc),
<a name="3792"/> 3792: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: get peername&quot;),
<a name="3793"/> 3793:                 {ok, Aa} = socket:peername(Sc),
<a name="3794"/> 3794:                 %%
<a name="3795"/> 3795: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; a: sendmsg&quot;),
<a name="3796"/> 3796:                 ok = socket:sendmsg(Sa, #{iov =&gt; IOV}),
<a name="3797"/> 3797: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: recv&quot;),
<a name="3798"/> 3798:                 {ok, Data} =
<a name="3799"/> 3799:                     socket:recv(Sc, byte_size(Data)),
<a name="3800"/> 3800: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: sendmsg (too large)&quot;),
<a name="3801"/> 3801:                 ok = socket:sendmsg(Sc, #{iov =&gt; IOVTooLarge}),
<a name="3802"/> 3802: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; a: recv&quot;),
<a name="3803"/> 3803:                 {ok, DataTooLarge} =
<a name="3804"/> 3804:                     socket:recv(Sa, byte_size(DataTooLarge)),
<a name="3805"/> 3805: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; done&quot;),
<a name="3806"/> 3806:                 ok
<a name="3807"/> 3807:             catch
<a name="3808"/> 3808:                 error:notsup = Reason:_ -&gt;
<a name="3809"/> 3809: 		    ?P(&quot;api_b_sendmsg_iov_stream -&gt; notsup&quot;),
<a name="3810"/> 3810:                     exit({skip, Reason})
<a name="3811"/> 3811:             after
<a name="3812"/> 3812:                 socket:close(Sc)
<a name="3813"/> 3813:             end
<a name="3814"/> 3814:         after
<a name="3815"/> 3815: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; after - b: close socket&quot;),
<a name="3816"/> 3816:             socket:close(Sb)
<a name="3817"/> 3817:         end
<a name="3818"/> 3818:     after
<a name="3819"/> 3819: 	?P(&quot;api_b_sendmsg_iov_stream -&gt; after - a: close socket&quot;),
<a name="3820"/> 3820:         socket:close(Sa)
<a name="3821"/> 3821:     end.
<a name="3822"/> 3822: 
<a name="3823"/> 3823: 
<a name="3824"/> 3824: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3825"/> 3825: 
<a name="3826"/> 3826: <i>%% Basically connect, send and receive using the &quot;common&quot; functions</i>
<a name="3827"/> 3827: <i>%% (send and recv) on an IPv4 UDP (dgram) socket.</i>
<a name="api_b_dgram_connect_udp4-1"/><a name="3828"/> 3828: <b>api_b_dgram_connect_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3829"/> 3829:     ?TT(?SECS(10)),
<a name="api_b_dgram_connect_udp4-last_expr"/><a name="3830"/> 3830: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3831"/> 3831:            fun() -&gt; has_support_ipv4() end,
<a name="3832"/> 3832:            fun() -&gt;
<a name="3833"/> 3833:                    InitState = #{domain =&gt; inet,
<a name="3834"/> 3834:                                  type   =&gt; dgram,
<a name="3835"/> 3835:                                  proto  =&gt; udp},
<a name="3836"/> 3836:                    ok = api_b_dgram_connect(InitState)
<a name="3837"/> 3837:            end).
<a name="3838"/> 3838: 
<a name="3839"/> 3839: 
<a name="3840"/> 3840: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3841"/> 3841: 
<a name="3842"/> 3842: <i>%% Basically connect, send and receive using the &quot;common&quot; functions</i>
<a name="3843"/> 3843: <i>%% (send and recv) on an IPv6 UDP (dgram) socket.</i>
<a name="api_b_dgram_connect_udp6-1"/><a name="3844"/> 3844: <b>api_b_dgram_connect_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="3845"/> 3845:     ?TT(?SECS(10)),
<a name="api_b_dgram_connect_udp6-last_expr"/><a name="3846"/> 3846: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3847"/> 3847:            fun() -&gt; has_support_ipv6() end,
<a name="3848"/> 3848:            fun() -&gt;
<a name="3849"/> 3849:                    InitState = #{domain =&gt; inet6,
<a name="3850"/> 3850:                                  type   =&gt; dgram,
<a name="3851"/> 3851:                                  proto  =&gt; udp},
<a name="3852"/> 3852:                    ok = api_b_dgram_connect(InitState)
<a name="3853"/> 3853:            end).
<a name="3854"/> 3854: 
<a name="3855"/> 3855: 
<a name="3856"/> 3856: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3857"/> 3857: 
<a name="api_b_dgram_connect-1"/><a name="3858"/> 3858: <b>api_b_dgram_connect</b>(InitState) -&gt;
<a name="3859"/> 3859:     PeerSeq = 
<a name="3860"/> 3860:         [
<a name="3861"/> 3861:          %% *** Wait for start order part ***
<a name="3862"/> 3862:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="3863"/> 3863:            cmd  =&gt; fun(State) -&gt;
<a name="3864"/> 3864:                            Tester = ?SEV_AWAIT_START(),
<a name="3865"/> 3865:                            {ok, State#{tester =&gt; Tester}}
<a name="3866"/> 3866:                    end},
<a name="3867"/> 3867:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="3868"/> 3868:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="3869"/> 3869:                            _MRef = erlang:monitor(process, Tester),
<a name="3870"/> 3870:                            ok
<a name="3871"/> 3871:                    end},
<a name="3872"/> 3872: 
<a name="3873"/> 3873:          %% *** Init part ***
<a name="3874"/> 3874:          #{desc =&gt; &quot;which local address&quot;,
<a name="3875"/> 3875:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="3876"/> 3876:                            LSA = which_local_socket_addr(Domain),
<a name="3877"/> 3877:                            {ok, State#{local_sa =&gt; LSA}}
<a name="3878"/> 3878:                    end},
<a name="3879"/> 3879: 
<a name="3880"/> 3880:          #{desc =&gt; &quot;open&quot;,
<a name="3881"/> 3881:            cmd  =&gt; fun(#{domain := Domain,
<a name="3882"/> 3882:                          type   := Type,
<a name="3883"/> 3883:                          proto  := Protocol} = State) -&gt;
<a name="3884"/> 3884:                            case socket:open(Domain, Type, Protocol) of
<a name="3885"/> 3885:                                {ok, Sock} -&gt;
<a name="3886"/> 3886:                                    {ok, State#{sock =&gt; Sock}};
<a name="3887"/> 3887:                                {error, eprotonosupport = Reason}
<a name="3888"/> 3888:                                  when (Reason =:= epfnosupport)    orelse
<a name="3889"/> 3889:                                       (Reason =:= eprotonosupport) orelse
<a name="3890"/> 3890:                                       (Reason =:= esocktnosupport) -&gt;
<a name="3891"/> 3891:                                    ?SEV_IPRINT(&quot;failed open: ~p =&gt; SKIP&quot;,
<a name="3892"/> 3892:                                                [Reason]),
<a name="3893"/> 3893:                                    {skip, Reason};
<a name="3894"/> 3894:                                {error, _} = ERROR -&gt;
<a name="3895"/> 3895:                                    ERROR
<a name="3896"/> 3896:                            end
<a name="3897"/> 3897:                    end},
<a name="3898"/> 3898: 
<a name="3899"/> 3899:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="3900"/> 3900:            cmd  =&gt; fun(#{domain   := local,
<a name="3901"/> 3901:                          sock     := Sock,
<a name="3902"/> 3902:                          local_sa := LSA} = State) -&gt;
<a name="3903"/> 3903:                            case socket:bind(Sock, LSA) of
<a name="3904"/> 3904:                                ok -&gt;
<a name="3905"/> 3905:                                    {ok, State#{sock_sa =&gt; LSA}};
<a name="3906"/> 3906:                                {error, Reason} = ERROR -&gt;
<a name="3907"/> 3907: 				   ?SEV_EPRINT(&quot;failed binding: &quot;
<a name="3908"/> 3908: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="3909"/> 3909:                                    ERROR
<a name="3910"/> 3910:                            end;
<a name="3911"/> 3911:                       (#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="3912"/> 3912:                            case sock_bind(Sock, LSA#{port =&gt; 0}) of
<a name="3913"/> 3913:                                ok -&gt;
<a name="3914"/> 3914:                                    Port = sock_port(Sock),
<a name="3915"/> 3915:                                    {ok, State#{sock_sa =&gt; LSA#{port =&gt; Port}}};
<a name="3916"/> 3916:                                {error, _} = ERROR -&gt;
<a name="3917"/> 3917:                                    ERROR
<a name="3918"/> 3918:                            end
<a name="3919"/> 3919:                    end},
<a name="3920"/> 3920: 
<a name="3921"/> 3921:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="3922"/> 3922:            cmd  =&gt; fun(#{tester := Tester, sock_sa := SSA}) -&gt;
<a name="3923"/> 3923:                            ?SEV_ANNOUNCE_READY(Tester, init, SSA),
<a name="3924"/> 3924:                            ok
<a name="3925"/> 3925:                    end},
<a name="3926"/> 3926: 
<a name="3927"/> 3927:          %% The actual test
<a name="3928"/> 3928:          #{desc =&gt; &quot;await continue (peer sa)&quot;,
<a name="3929"/> 3929:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="3930"/> 3930:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, connect) of
<a name="3931"/> 3931:                                {ok, PeerSA} -&gt;
<a name="3932"/> 3932:                                    ?SEV_IPRINT(&quot;Peer SA:&quot;
<a name="3933"/> 3933:                                                &quot;~n   ~p&quot;, [PeerSA]),
<a name="3934"/> 3934:                                    {ok, State#{peer_sa =&gt; PeerSA}};
<a name="3935"/> 3935:                                {error, _} = ERROR -&gt;
<a name="3936"/> 3936:                                    ERROR
<a name="3937"/> 3937:                            end
<a name="3938"/> 3938:                    end},
<a name="3939"/> 3939: 
<a name="3940"/> 3940:          #{desc =&gt; &quot;connect&quot;,
<a name="3941"/> 3941:            cmd  =&gt; fun(#{sock := Sock, peer_sa := PSA}) -&gt;
<a name="3942"/> 3942:                            ?SEV_IPRINT(&quot;try connect&quot;),
<a name="3943"/> 3943:                            socket:connect(Sock, PSA)
<a name="3944"/> 3944:                    end},
<a name="3945"/> 3945: 
<a name="3946"/> 3946:          #{desc =&gt; &quot;announce ready (connected)&quot;,
<a name="3947"/> 3947:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3948"/> 3948:                            ?SEV_ANNOUNCE_READY(Tester, connected),
<a name="3949"/> 3949:                            ok
<a name="3950"/> 3950:                    end},
<a name="3951"/> 3951: 
<a name="3952"/> 3952:          %% The actual test
<a name="3953"/> 3953:          #{desc =&gt; &quot;await continue (send and recv)&quot;,
<a name="3954"/> 3954:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="3955"/> 3955:                            case ?SEV_AWAIT_CONTINUE(Tester,
<a name="3956"/> 3956:                                                     tester, send_and_recv) of
<a name="3957"/> 3957:                                {ok, Role} -&gt;
<a name="3958"/> 3958:                                    ?SEV_IPRINT(&quot;role: ~p&quot;, [Role]),
<a name="3959"/> 3959:                                    {ok, State#{role =&gt; Role}};
<a name="3960"/> 3960:                                {error, _} = ERROR -&gt;
<a name="3961"/> 3961:                                    ERROR
<a name="3962"/> 3962:                            end
<a name="3963"/> 3963:                    end},
<a name="3964"/> 3964: 
<a name="3965"/> 3965:          #{desc =&gt; &quot;send (client) or recv (server) request&quot;,
<a name="3966"/> 3966:            cmd  =&gt; fun(#{sock := Sock, role := client}) -&gt;
<a name="3967"/> 3967:                            ?SEV_IPRINT(&quot;[client] try send request&quot;),
<a name="3968"/> 3968:                            socket:send(Sock, ?BASIC_REQ);
<a name="3969"/> 3969:                       (#{sock := Sock, role := server}) -&gt;
<a name="3970"/> 3970:                            ?SEV_IPRINT(&quot;[server] try recv request&quot;),
<a name="3971"/> 3971:                            case socket:recv(Sock) of
<a name="3972"/> 3972:                                {ok, ?BASIC_REQ} -&gt;
<a name="3973"/> 3973:                                    ok;
<a name="3974"/> 3974:                                {error, _} = ERROR -&gt;
<a name="3975"/> 3975:                                    ERROR
<a name="3976"/> 3976:                            end
<a name="3977"/> 3977:                    end},
<a name="3978"/> 3978: 
<a name="3979"/> 3979:          #{desc =&gt; &quot;recv (client) send (server) reply&quot;,
<a name="3980"/> 3980:            cmd  =&gt; fun(#{sock := Sock, role := client}) -&gt;
<a name="3981"/> 3981:                            ?SEV_IPRINT(&quot;[client] try recv reply&quot;),
<a name="3982"/> 3982:                            case socket:recv(Sock) of
<a name="3983"/> 3983:                                {ok, ?BASIC_REP} -&gt;
<a name="3984"/> 3984:                                    ok;
<a name="3985"/> 3985:                                {error, _} = ERROR -&gt;
<a name="3986"/> 3986:                                    ERROR
<a name="3987"/> 3987:                            end;
<a name="3988"/> 3988:                       (#{sock := Sock, role := server}) -&gt;
<a name="3989"/> 3989:                            ?SEV_IPRINT(&quot;[server] try send reply&quot;),
<a name="3990"/> 3990:                            socket:send(Sock, ?BASIC_REP)
<a name="3991"/> 3991:                    end},
<a name="3992"/> 3992: 
<a name="3993"/> 3993:          #{desc =&gt; &quot;announce ready (send_and_recv)&quot;,
<a name="3994"/> 3994:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3995"/> 3995:                            ?SEV_ANNOUNCE_READY(Tester, send_and_recv),
<a name="3996"/> 3996:                            ok
<a name="3997"/> 3997:                    end},
<a name="3998"/> 3998: 
<a name="3999"/> 3999: 
<a name="4000"/> 4000:          %% *** Termination ***
<a name="4001"/> 4001:          #{desc =&gt; &quot;await terminate&quot;,
<a name="4002"/> 4002:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4003"/> 4003:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="4004"/> 4004:                                ok -&gt;
<a name="4005"/> 4005:                                    {ok, maps:remove(tester, State)};
<a name="4006"/> 4006:                                {error, _} = ERROR -&gt;
<a name="4007"/> 4007:                                    ERROR
<a name="4008"/> 4008:                            end
<a name="4009"/> 4009:                    end},
<a name="4010"/> 4010:          #{desc =&gt; &quot;close socket&quot;,
<a name="4011"/> 4011:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="4012"/> 4012:                            socket:close(Sock),
<a name="4013"/> 4013:                            {ok, maps:remove(sock, State)}
<a name="4014"/> 4014:                    end},
<a name="4015"/> 4015: 
<a name="4016"/> 4016:          %% *** We are done ***
<a name="4017"/> 4017:          ?SEV_FINISH_NORMAL
<a name="4018"/> 4018:         ],
<a name="4019"/> 4019: 
<a name="4020"/> 4020: 
<a name="4021"/> 4021:     TesterSeq =
<a name="4022"/> 4022:         [
<a name="4023"/> 4023:          %% *** Init part ***
<a name="4024"/> 4024:          #{desc =&gt; &quot;monitor peer 1&quot;,
<a name="4025"/> 4025:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4026"/> 4026:                            _MRef = erlang:monitor(process, Pid),
<a name="4027"/> 4027:                            ok
<a name="4028"/> 4028:                    end},
<a name="4029"/> 4029:          #{desc =&gt; &quot;monitor peer 2&quot;,
<a name="4030"/> 4030:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4031"/> 4031:                            _MRef = erlang:monitor(process, Pid),
<a name="4032"/> 4032:                            ok
<a name="4033"/> 4033:                    end},
<a name="4034"/> 4034: 
<a name="4035"/> 4035:          #{desc =&gt; &quot;order peer 1 start&quot;,
<a name="4036"/> 4036:            cmd  =&gt; fun(#{peer_1 := Pid}) -&gt;
<a name="4037"/> 4037:                            ?SEV_ANNOUNCE_START(Pid)
<a name="4038"/> 4038:                    end},
<a name="4039"/> 4039:          #{desc =&gt; &quot;order peer 2 start&quot;,
<a name="4040"/> 4040:            cmd  =&gt; fun(#{peer_2 := Pid}) -&gt;
<a name="4041"/> 4041:                            ?SEV_ANNOUNCE_START(Pid)
<a name="4042"/> 4042:                    end},
<a name="4043"/> 4043: 
<a name="4044"/> 4044:          #{desc =&gt; &quot;await peer 1 ready (init)&quot;,
<a name="4045"/> 4045:            cmd  =&gt; fun(#{peer_1 := Pid} = State) -&gt;
<a name="4046"/> 4046:                            {ok, PeerSA} = ?SEV_AWAIT_READY(Pid, peer1, init),
<a name="4047"/> 4047:                            {ok, State#{peer_1_sa =&gt; PeerSA}}
<a name="4048"/> 4048:                    end},
<a name="4049"/> 4049:          #{desc =&gt; &quot;await peer 2 ready (init)&quot;,
<a name="4050"/> 4050:            cmd  =&gt; fun(#{peer_2 := Pid} = State) -&gt;
<a name="4051"/> 4051:                            {ok, PeerSA} = ?SEV_AWAIT_READY(Pid, peer2, init),
<a name="4052"/> 4052:                            {ok, State#{peer_2_sa =&gt; PeerSA}}
<a name="4053"/> 4053:                    end},
<a name="4054"/> 4054: 
<a name="4055"/> 4055: 
<a name="4056"/> 4056:          #{desc =&gt; &quot;order peer 1 to continue (with connect)&quot;,
<a name="4057"/> 4057:            cmd  =&gt; fun(#{peer_1 := Pid, peer_2_sa := PeerSA} = _State) -&gt;
<a name="4058"/> 4058:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect, PeerSA),
<a name="4059"/> 4059:                            ok
<a name="4060"/> 4060:                    end},
<a name="4061"/> 4061:          #{desc =&gt; &quot;order peer 2 to continue (with connect)&quot;,
<a name="4062"/> 4062:            cmd  =&gt; fun(#{peer_2 := Pid, peer_1_sa := PeerSA} = _State) -&gt;
<a name="4063"/> 4063:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect, PeerSA),
<a name="4064"/> 4064:                            ok
<a name="4065"/> 4065:                    end},
<a name="4066"/> 4066: 
<a name="4067"/> 4067: 
<a name="4068"/> 4068:          #{desc =&gt; &quot;await peer 1 ready (connected)&quot;,
<a name="4069"/> 4069:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4070"/> 4070:                            ?SEV_AWAIT_READY(Pid, peer1, connected)
<a name="4071"/> 4071:                    end},
<a name="4072"/> 4072:          #{desc =&gt; &quot;await peer 2 ready (connected)&quot;,
<a name="4073"/> 4073:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4074"/> 4074:                            ?SEV_AWAIT_READY(Pid, peer2, connected)
<a name="4075"/> 4075:                    end},
<a name="4076"/> 4076: 
<a name="4077"/> 4077: 
<a name="4078"/> 4078: 
<a name="4079"/> 4079:          %% We should pick one to issue the request
<a name="4080"/> 4080:          %% (and the other is then to *await* the request
<a name="4081"/> 4081:          %%  and respond).
<a name="4082"/> 4082: 
<a name="4083"/> 4083: 
<a name="4084"/> 4084: 
<a name="4085"/> 4085:          #{desc =&gt; &quot;order peer 1 to continue (with send_and_recv)&quot;,
<a name="4086"/> 4086:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4087"/> 4087:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_and_recv, client),
<a name="4088"/> 4088:                            ok
<a name="4089"/> 4089:                    end},
<a name="4090"/> 4090:          #{desc =&gt; &quot;order peer 2 to continue (with send_and_recv)&quot;,
<a name="4091"/> 4091:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4092"/> 4092:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_and_recv, server),
<a name="4093"/> 4093:                            ok
<a name="4094"/> 4094:                    end},
<a name="4095"/> 4095: 
<a name="4096"/> 4096: 
<a name="4097"/> 4097:          #{desc =&gt; &quot;await peer 1 ready (send_and_recv)&quot;,
<a name="4098"/> 4098:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4099"/> 4099:                            ?SEV_AWAIT_READY(Pid, peer1, send_and_recv)
<a name="4100"/> 4100:                    end},
<a name="4101"/> 4101:          #{desc =&gt; &quot;await peer 2 ready (send_and_recv)&quot;,
<a name="4102"/> 4102:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4103"/> 4103:                            ?SEV_AWAIT_READY(Pid, peer2, send_and_recv)
<a name="4104"/> 4104:                    end},
<a name="4105"/> 4105: 
<a name="4106"/> 4106: 
<a name="4107"/> 4107:          ?SEV_SLEEP(?SECS(1)),
<a name="4108"/> 4108: 
<a name="4109"/> 4109: 
<a name="4110"/> 4110:          %% *** Termination ***
<a name="4111"/> 4111:          #{desc =&gt; &quot;order peer 1 to terminate&quot;,
<a name="4112"/> 4112:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="4113"/> 4113:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="4114"/> 4114:                            ok
<a name="4115"/> 4115:                    end},
<a name="4116"/> 4116:          #{desc =&gt; &quot;await peer 1 termination&quot;,
<a name="4117"/> 4117:            cmd  =&gt; fun(#{peer_1 := Pid} = State) -&gt;
<a name="4118"/> 4118:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="4119"/> 4119:                            State1 = maps:remove(peer_1, State),
<a name="4120"/> 4120:                            {ok, State1}
<a name="4121"/> 4121:                    end},
<a name="4122"/> 4122:          #{desc =&gt; &quot;order peer 2 to terminate&quot;,
<a name="4123"/> 4123:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="4124"/> 4124:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="4125"/> 4125:                            ok
<a name="4126"/> 4126:                    end},
<a name="4127"/> 4127:          #{desc =&gt; &quot;await peer 2 termination&quot;,
<a name="4128"/> 4128:            cmd  =&gt; fun(#{peer_2 := Pid} = State) -&gt;
<a name="4129"/> 4129:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="4130"/> 4130:                            State1 = maps:remove(peer_2, State),
<a name="4131"/> 4131:                            {ok, State1}
<a name="4132"/> 4132:                    end},
<a name="4133"/> 4133: 
<a name="4134"/> 4134: 
<a name="4135"/> 4135:          %% *** We are done ***
<a name="4136"/> 4136:          ?SEV_FINISH_NORMAL
<a name="4137"/> 4137:         ],
<a name="4138"/> 4138: 
<a name="4139"/> 4139: 
<a name="4140"/> 4140:     Peer1  = ?SEV_START(&quot;peer 1&quot;, PeerSeq,   InitState),
<a name="4141"/> 4141:     Peer2  = ?SEV_START(&quot;peer 2&quot;, PeerSeq,   InitState),
<a name="4142"/> 4142:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, #{peer_1 =&gt; Peer1#ev.pid,
<a name="4143"/> 4143:                                                peer_2 =&gt; Peer2#ev.pid}),
<a name="api_b_dgram_connect-last_expr"/><a name="4144"/> 4144: <b>    ok = ?SEV_AWAIT_FINISH</b>([Peer1, Peer2, Tester]).
<a name="4145"/> 4145: 
<a name="4146"/> 4146: 
<a name="4147"/> 4147: 
<a name="4148"/> 4148: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4149"/> 4149: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4150"/> 4150: <i>%%                                                                     %%</i>
<a name="4151"/> 4151: <i>%%                           API SENDFILE                              %%</i>
<a name="4152"/> 4152: <i>%%                                                                     %%</i>
<a name="4153"/> 4153: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4154"/> 4154: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4155"/> 4155: 
<a name="api_sendfile_inet-1"/><a name="4156"/> 4156: <b>api_sendfile_inet</b>(Config) when is_list(Config) -&gt;
<a name="4157"/> 4157:     has_support_sendfile(),
<a name="4158"/> 4158:     has_support_ipv4(),
<a name="api_sendfile_inet-last_expr"/><a name="4159"/> 4159: <b>    api_sendfile</b>(inet, Config, fun socket:sendfile/2).
<a name="4160"/> 4160: 
<a name="api_sendfile_inet6-1"/><a name="4161"/> 4161: <b>api_sendfile_inet6</b>(Config) when is_list(Config) -&gt;
<a name="4162"/> 4162:     has_support_sendfile(),
<a name="4163"/> 4163:     has_support_ipv6(),
<a name="api_sendfile_inet6-last_expr"/><a name="4164"/> 4164: <b>    api_sendfile</b>(inet6, Config, fun socket:sendfile/2).
<a name="4165"/> 4165: 
<a name="api_sendfile_local-1"/><a name="4166"/> 4166: <b>api_sendfile_local</b>(Config) when is_list(Config) -&gt;
<a name="4167"/> 4167:     has_support_sendfile(),
<a name="4168"/> 4168:     has_support_unix_domain_socket(),
<a name="api_sendfile_local-last_expr"/><a name="4169"/> 4169: <b>    api_sendfile</b>(local, Config, fun socket:sendfile/2).
<a name="4170"/> 4170: 
<a name="4171"/> 4171: 
<a name="4172"/> 4172: 
<a name="api_sendfile_loop_inet-1"/><a name="4173"/> 4173: <b>api_sendfile_loop_inet</b>(Config) when is_list(Config) -&gt;
<a name="4174"/> 4174:     has_support_sendfile(),
<a name="4175"/> 4175:     has_support_ipv4(),
<a name="api_sendfile_loop_inet-last_expr"/><a name="4176"/> 4176: <b>    api_sendfile</b>(inet, Config, fun sendfile_loop/2).
<a name="4177"/> 4177: 
<a name="api_sendfile_loop_inet6-1"/><a name="4178"/> 4178: <b>api_sendfile_loop_inet6</b>(Config) when is_list(Config) -&gt;
<a name="4179"/> 4179:     has_support_sendfile(),
<a name="4180"/> 4180:     has_support_ipv6(),
<a name="api_sendfile_loop_inet6-last_expr"/><a name="4181"/> 4181: <b>    api_sendfile</b>(inet6, Config, fun sendfile_loop/2).
<a name="4182"/> 4182: 
<a name="api_sendfile_loop_local-1"/><a name="4183"/> 4183: <b>api_sendfile_loop_local</b>(Config) when is_list(Config) -&gt;
<a name="4184"/> 4184:     has_support_sendfile(),
<a name="4185"/> 4185:     has_support_unix_domain_socket(),
<a name="api_sendfile_loop_local-last_expr"/><a name="4186"/> 4186: <b>    api_sendfile</b>(local, Config, fun sendfile_loop/2).
<a name="4187"/> 4187: 
<a name="4188"/> 4188: 
<a name="sendfile_loop-2"/><a name="4189"/> 4189: <b>sendfile_loop</b>(Sa, F) -&gt;
<a name="sendfile_loop-last_expr"/><a name="4190"/> 4190: <b>    sendfile_loop</b>(Sa, F, 0).
<a name="4191"/> 4191: 
<a name="sendfile_loop-3"/><a name="4192"/> 4192: <b>sendfile_loop</b>(Sa, Cont, Offset) -&gt;
<a name="4193"/> 4193:     SelectHandle = make_ref(),
<a name="sendfile_loop-last_expr"/><a name="4194"/> 4194: <b>    case socket:sendfile</b>(Sa, Cont, Offset, 0, SelectHandle) of
<a name="4195"/> 4195:         {select, Select} -&gt;
<a name="4196"/> 4196:             receive
<a name="4197"/> 4197:                 {'$socket', Sa, select, SelectHandle} -&gt;
<a name="4198"/> 4198:                     case Select of
<a name="4199"/> 4199:                         {{select_info, _, _} = Cont_1, BytesSent} -&gt;
<a name="4200"/> 4200:                             sendfile_loop(Sa, Cont_1, Offset + BytesSent);
<a name="4201"/> 4201:                         {select_info, _, _} = Cont_1 -&gt;
<a name="4202"/> 4202:                             sendfile_loop(Sa, Cont_1, Offset)
<a name="4203"/> 4203:                     end;
<a name="4204"/> 4204:                 {'$socket', Sa, abort, {SelectHandle, Reason}} -&gt;
<a name="4205"/> 4205:                     {error, {Reason, Offset}}
<a name="4206"/> 4206:             end;
<a name="4207"/> 4207:         {ok, BytesSent} -&gt;
<a name="4208"/> 4208:             {ok, Offset + BytesSent};
<a name="4209"/> 4209:         {error, Reason} = Error -&gt;
<a name="4210"/> 4210:             io:format(
<a name="4211"/> 4211:               &quot;sendfile_loop(~p, ~p, ~p) -&gt; ~p.~n&quot;,
<a name="4212"/> 4212:               [Sa, Cont, Offset, Error]),
<a name="4213"/> 4213:             {error, {Reason, Offset}}
<a name="4214"/> 4214:     end.
<a name="4215"/> 4215: 
<a name="4216"/> 4216: 
<a name="4217"/> 4217: 
<a name="api_sendfile-3"/><a name="4218"/> 4218: <b>api_sendfile</b>(Domain, Config, Sendfile) -&gt;
<a name="api_sendfile-last_expr"/><a name="4219"/> 4219: <b>    case proplists:get_value</b>(sendfile_file, Config) of
<a name="4220"/> 4220:         undefined -&gt;
<a name="4221"/> 4221:             {skip, sendfile_not_supported};
<a name="4222"/> 4222:         {File, Size, Data} -&gt;
<a name="4223"/> 4223:             api_sendfile(Domain, File, Size, Data, Sendfile)
<a name="4224"/> 4224:     end.
<a name="4225"/> 4225: 
<a name="api_sendfile-5"/><a name="4226"/> 4226: <b>api_sendfile</b>(Domain, File, Size, Data, Sendfile) -&gt;
<a name="4227"/> 4227:     ?TT(?SECS(10)),
<a name="4228"/> 4228:     TC = self(),
<a name="4229"/> 4229:     BufSize = Size bsr 10, % /1k
<a name="4230"/> 4230:     BindAddr = which_local_socket_addr(Domain),
<a name="4231"/> 4231:     case BindAddr of
<a name="4232"/> 4232:         #{family := local, path := Path} -&gt;
<a name="4233"/> 4233:             _ =
<a name="4234"/> 4234:                 spawn(
<a name="4235"/> 4235:                   fun () -&gt;
<a name="4236"/> 4236:                           Mref = monitor(process, TC),
<a name="4237"/> 4237:                           receive
<a name="4238"/> 4238:                               {'DOWN', Mref, _, _, _} -&gt;
<a name="4239"/> 4239:                                   unlink_path(Path)
<a name="4240"/> 4240:                           end
<a name="4241"/> 4241:                   end),
<a name="4242"/> 4242:             ok;
<a name="4243"/> 4243:         #{family := _} -&gt;
<a name="4244"/> 4244:             ok
<a name="4245"/> 4245:     end,
<a name="4246"/> 4246:     io:format(&quot;BindAddr = ~p~n&quot;, [BindAddr]),
<a name="4247"/> 4247:     {ok, F} = file:open(File, [raw, read, binary]),
<a name="4248"/> 4248:     io:format(&quot;F = ~p~n&quot;, [F]),
<a name="4249"/> 4249:     {ok, L} = socket:open(Domain, stream),
<a name="4250"/> 4250:     io:format(&quot;L = ~p~n&quot;, [L]),
<a name="4251"/> 4251:     ok = socket:bind(L, BindAddr),
<a name="4252"/> 4252:     ok = socket:listen(L),
<a name="4253"/> 4253:     {ok, Addr} = socket:sockname(L),
<a name="4254"/> 4254:     io:format(&quot;Addr = ~p~n&quot;, [Addr]),
<a name="4255"/> 4255:     {ok, Sa} = socket:open(Domain, stream),
<a name="4256"/> 4256:     io:format(&quot;Sa = ~p~n&quot;, [Sa]),
<a name="4257"/> 4257:     ok = socket:setopt(Sa, {socket,sndbuf}, BufSize),
<a name="4258"/> 4258:     ok = socket:connect(Sa, Addr),
<a name="4259"/> 4259:     {ok, Sb} = socket:accept(L),
<a name="4260"/> 4260:     io:format(&quot;Sb = ~p~n&quot;, [Sb]),
<a name="4261"/> 4261:     ok = socket:setopt(Sb, {socket,rcvbuf}, BufSize),
<a name="4262"/> 4262:     Verifyer =
<a name="4263"/> 4263:         spawn_link(
<a name="4264"/> 4264:           fun () -&gt;
<a name="4265"/> 4265:                   TC ! {self(), api_sendfile_verify(Sb, Data, 0)}
<a name="4266"/> 4266:           end),
<a name="4267"/> 4267:     io:format(&quot;Verifyer = ~p~n&quot;, [Verifyer]),
<a name="4268"/> 4268:     %%
<a name="4269"/> 4269:     SendfileResult = Sendfile(Sa, F),
<a name="4270"/> 4270:     io:format(&quot;SendfileResult = ~p~n&quot;, [SendfileResult]),
<a name="4271"/> 4271:     %%
<a name="api_sendfile-last_expr"/><a name="4272"/> 4272:     receive
<a name="4273"/> 4273:         {Verifyer, VerifyerResult} -&gt;
<a name="4274"/> 4274:             io:format(&quot;VerifyerResult = ~p~n&quot;, [VerifyerResult]),
<a name="4275"/> 4275:             case {SendfileResult, VerifyerResult} of
<a name="4276"/> 4276:                 {{ok, Size}, {ok, Size}} -&gt;
<a name="4277"/> 4277:                     ok;
<a name="4278"/> 4278:                 Other -&gt;
<a name="4279"/> 4279:                     ?FAIL({bad_result, Other})
<a name="4280"/> 4280:             end
<a name="4281"/> 4281:     end.
<a name="4282"/> 4282: 
<a name="api_sendfile_verify-3"/><a name="4283"/> 4283: <b>api_sendfile_verify</b>(_S, [], M) -&gt;
<a name="4284"/> 4284:     {ok, M};
<a name="4285"/> 4285: <b>api_sendfile_verify</b>(S, [Block | Data], M) when is_binary(Block) -&gt;
<a name="4286"/> 4286:     api_sendfile_verify_block(S, Data, M, Block, 1);
<a name="4287"/> 4287: <b>api_sendfile_verify</b>(S, [{N, Block} | Data], M) -&gt;
<a name="api_sendfile_verify-last_expr"/><a name="4288"/> 4288: <b>    api_sendfile_verify_block</b>(S, Data, M, Block, N).
<a name="4289"/> 4289: 
<a name="api_sendfile_verify_block-5"/><a name="4290"/> 4290: <b>api_sendfile_verify_block</b>(S, Data, M, Block, N) -&gt;
<a name="api_sendfile_verify_block-last_expr"/><a name="4291"/> 4291:     if
<a name="4292"/> 4292:         0 &lt; N -&gt;
<a name="4293"/> 4293:             ByteSize = byte_size(Block),
<a name="4294"/> 4294:             case socket:recv(S, ByteSize, 2000) of
<a name="4295"/> 4295:                 {ok, Block} -&gt;
<a name="4296"/> 4296:                     api_sendfile_verify_block(
<a name="4297"/> 4297:                       S, Data, M + ByteSize, Block, N - 1);
<a name="4298"/> 4298:                 Other -&gt;
<a name="4299"/> 4299:                     {error_at, M, Other}
<a name="4300"/> 4300:             end;
<a name="4301"/> 4301:         true -&gt;
<a name="4302"/> 4302:             api_sendfile_verify(S, Data, M)
<a name="4303"/> 4303:     end.
<a name="4304"/> 4304: 
<a name="4305"/> 4305: 
<a name="4306"/> 4306: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4307"/> 4307: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4308"/> 4308: <i>%%                                                                     %%</i>
<a name="4309"/> 4309: <i>%%                           API FROM FD                               %%</i>
<a name="4310"/> 4310: <i>%%                                                                     %%</i>
<a name="4311"/> 4311: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4312"/> 4312: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4313"/> 4313: 
<a name="4314"/> 4314: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4315"/> 4315: 
<a name="4316"/> 4316: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4317"/> 4317: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="4318"/> 4318: <i>%% With some extra checks...</i>
<a name="4319"/> 4319: <i>%% IPv4</i>
<a name="4320"/> 4320: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_udp4-1"/><a name="4321"/> 4321: <b>api_ffd_open_wod_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4322"/> 4322:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_udp4-last_expr"/><a name="4323"/> 4323: <b>    tc_try</b>(api_ffd_open_wod_and_info_udp4,
<a name="4324"/> 4324:            fun() -&gt;
<a name="4325"/> 4325:                    has_support_ipv4()
<a name="4326"/> 4326:            end,
<a name="4327"/> 4327:            fun() -&gt;
<a name="4328"/> 4328:                    InitState = #{domain   =&gt; inet,
<a name="4329"/> 4329:                                  type     =&gt; dgram,
<a name="4330"/> 4330:                                  protocol =&gt; udp,
<a name="4331"/> 4331:                                  dup      =&gt; false},
<a name="4332"/> 4332:                    ok = api_ffd_open_and_info(InitState)
<a name="4333"/> 4333:            end).
<a name="4334"/> 4334: 
<a name="4335"/> 4335: 
<a name="4336"/> 4336: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4337"/> 4337: 
<a name="4338"/> 4338: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4339"/> 4339: <i>%% file descriptor (FD) and info of an IPv6 UDP (dgram) socket.</i>
<a name="4340"/> 4340: <i>%% With some extra checks...</i>
<a name="4341"/> 4341: <i>%% IPv6</i>
<a name="4342"/> 4342: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_udp6-1"/><a name="4343"/> 4343: <b>api_ffd_open_wod_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4344"/> 4344:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_udp6-last_expr"/><a name="4345"/> 4345: <b>    tc_try</b>(api_ffd_open_wod_and_info_udp6,
<a name="4346"/> 4346:            fun() -&gt;
<a name="4347"/> 4347:                    has_support_ipv6()
<a name="4348"/> 4348:            end,
<a name="4349"/> 4349:            fun() -&gt;
<a name="4350"/> 4350:                    InitState = #{domain   =&gt; inet6,
<a name="4351"/> 4351:                                  type     =&gt; dgram,
<a name="4352"/> 4352:                                  protocol =&gt; udp,
<a name="4353"/> 4353:                                  dup      =&gt; false},
<a name="4354"/> 4354:                    ok = api_ffd_open_and_info(InitState)
<a name="4355"/> 4355:            end).
<a name="4356"/> 4356: 
<a name="4357"/> 4357: 
<a name="4358"/> 4358: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4359"/> 4359: 
<a name="4360"/> 4360: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4361"/> 4361: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="4362"/> 4362: <i>%% With some extra checks...</i>
<a name="4363"/> 4363: <i>%% IPv4</i>
<a name="4364"/> 4364: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_udp4-1"/><a name="4365"/> 4365: <b>api_ffd_open_wd_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4366"/> 4366:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_udp4-last_expr"/><a name="4367"/> 4367: <b>    tc_try</b>(api_ffd_wd_open_and_info_udp4,
<a name="4368"/> 4368:            fun() -&gt; has_support_ipv4() end,
<a name="4369"/> 4369:            fun() -&gt;
<a name="4370"/> 4370:                    InitState = #{domain   =&gt; inet,
<a name="4371"/> 4371:                                  type     =&gt; dgram,
<a name="4372"/> 4372:                                  protocol =&gt; udp,
<a name="4373"/> 4373:                                  dup      =&gt; true},
<a name="4374"/> 4374:                    ok = api_ffd_open_and_info(InitState)
<a name="4375"/> 4375:            end).
<a name="4376"/> 4376: 
<a name="4377"/> 4377: 
<a name="4378"/> 4378: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4379"/> 4379: 
<a name="4380"/> 4380: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4381"/> 4381: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="4382"/> 4382: <i>%% With some extra checks...</i>
<a name="4383"/> 4383: <i>%% IPv6</i>
<a name="4384"/> 4384: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_udp6-1"/><a name="4385"/> 4385: <b>api_ffd_open_wd_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4386"/> 4386:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_udp6-last_expr"/><a name="4387"/> 4387: <b>    tc_try</b>(api_ffd_wd_open_and_info_udp6,
<a name="4388"/> 4388:            fun() -&gt; has_support_ipv6() end,
<a name="4389"/> 4389:            fun() -&gt;
<a name="4390"/> 4390:                    InitState = #{domain   =&gt; inet,
<a name="4391"/> 4391:                                  type     =&gt; dgram,
<a name="4392"/> 4392:                                  protocol =&gt; udp,
<a name="4393"/> 4393:                                  dup      =&gt; true},
<a name="4394"/> 4394:                    ok = api_ffd_open_and_info(InitState)
<a name="4395"/> 4395:            end).
<a name="4396"/> 4396: 
<a name="4397"/> 4397: 
<a name="4398"/> 4398: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4399"/> 4399: 
<a name="4400"/> 4400: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4401"/> 4401: <i>%% file descriptor (FD) and info of an IPv4 TCP (stream) socket.</i>
<a name="4402"/> 4402: <i>%% With some extra checks...</i>
<a name="4403"/> 4403: <i>%% IPv6</i>
<a name="4404"/> 4404: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_tcp4-1"/><a name="4405"/> 4405: <b>api_ffd_open_wod_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4406"/> 4406:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_tcp4-last_expr"/><a name="4407"/> 4407: <b>    tc_try</b>(api_ffd_open_wod_and_info_tcp4,
<a name="4408"/> 4408:            fun() -&gt;
<a name="4409"/> 4409:                    has_support_ipv4()
<a name="4410"/> 4410:            end,
<a name="4411"/> 4411:            fun() -&gt;
<a name="4412"/> 4412:                    InitState = #{domain   =&gt; inet,
<a name="4413"/> 4413:                                  type     =&gt; stream,
<a name="4414"/> 4414:                                  protocol =&gt; tcp,
<a name="4415"/> 4415:                                  dup      =&gt; false},
<a name="4416"/> 4416:                    ok = api_ffd_open_and_info(InitState)
<a name="4417"/> 4417:            end).
<a name="4418"/> 4418: 
<a name="4419"/> 4419: 
<a name="4420"/> 4420: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4421"/> 4421: 
<a name="4422"/> 4422: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4423"/> 4423: <i>%% file descriptor (FD) and info of an IPv6 TCP (stream) socket.</i>
<a name="4424"/> 4424: <i>%% With some extra checks...</i>
<a name="4425"/> 4425: <i>%% IPv6</i>
<a name="4426"/> 4426: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_tcp6-1"/><a name="4427"/> 4427: <b>api_ffd_open_wod_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4428"/> 4428:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_tcp6-last_expr"/><a name="4429"/> 4429: <b>    tc_try</b>(api_ffd_open_wod_and_info_tcp6,
<a name="4430"/> 4430:            fun() -&gt; has_support_ipv6() end,
<a name="4431"/> 4431:            fun() -&gt;
<a name="4432"/> 4432:                    InitState = #{domain   =&gt; inet6,
<a name="4433"/> 4433:                                  type     =&gt; stream,
<a name="4434"/> 4434:                                  protocol =&gt; tcp,
<a name="4435"/> 4435:                                  dup      =&gt; false},
<a name="4436"/> 4436:                    ok = api_ffd_open_and_info(InitState)
<a name="4437"/> 4437:            end).
<a name="4438"/> 4438: 
<a name="4439"/> 4439: 
<a name="4440"/> 4440: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4441"/> 4441: 
<a name="4442"/> 4442: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4443"/> 4443: <i>%% file descriptor (FD) and info of an IPv4 TCP (stream) socket.</i>
<a name="4444"/> 4444: <i>%% With some extra checks...</i>
<a name="4445"/> 4445: <i>%% IPv6</i>
<a name="4446"/> 4446: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_tcp4-1"/><a name="4447"/> 4447: <b>api_ffd_open_wd_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4448"/> 4448:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_tcp4-last_expr"/><a name="4449"/> 4449: <b>    tc_try</b>(api_ffd_open_wd_and_info_tcp4,
<a name="4450"/> 4450:            fun() -&gt;
<a name="4451"/> 4451:                    has_support_ipv4()
<a name="4452"/> 4452:            end,
<a name="4453"/> 4453:            fun() -&gt;
<a name="4454"/> 4454:                    InitState = #{domain   =&gt; inet,
<a name="4455"/> 4455:                                  type     =&gt; stream,
<a name="4456"/> 4456:                                  protocol =&gt; tcp,
<a name="4457"/> 4457:                                  dup      =&gt; true},
<a name="4458"/> 4458:                    ok = api_ffd_open_and_info(InitState)
<a name="4459"/> 4459:            end).
<a name="4460"/> 4460: 
<a name="4461"/> 4461: 
<a name="4462"/> 4462: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4463"/> 4463: 
<a name="4464"/> 4464: <i>%% Basically open (create) a socket from an already existing </i>
<a name="4465"/> 4465: <i>%% file descriptor (FD) and info of an IPv6 TCP (stream) socket.</i>
<a name="4466"/> 4466: <i>%% With some extra checks...</i>
<a name="4467"/> 4467: <i>%% IPv6</i>
<a name="4468"/> 4468: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_tcp6-1"/><a name="4469"/> 4469: <b>api_ffd_open_wd_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4470"/> 4470:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_tcp6-last_expr"/><a name="4471"/> 4471: <b>    tc_try</b>(api_ffd_open_wd_and_info_tcp6,
<a name="4472"/> 4472:            fun() -&gt; has_support_ipv6() end,
<a name="4473"/> 4473:            fun() -&gt;
<a name="4474"/> 4474:                    InitState = #{domain   =&gt; inet6,
<a name="4475"/> 4475:                                  type     =&gt; stream,
<a name="4476"/> 4476:                                  protocol =&gt; tcp,
<a name="4477"/> 4477:                                  dup      =&gt; true},
<a name="4478"/> 4478:                    ok = api_ffd_open_and_info(InitState)
<a name="4479"/> 4479:            end).
<a name="4480"/> 4480: 
<a name="4481"/> 4481: 
<a name="4482"/> 4482: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4483"/> 4483: 
<a name="api_ffd_open_and_info-1"/><a name="4484"/> 4484: <b>api_ffd_open_and_info</b>(InitState) -&gt;
<a name="4485"/> 4485:     Seq = 
<a name="4486"/> 4486:         [
<a name="4487"/> 4487:          #{desc =&gt; &quot;open&quot;,
<a name="4488"/> 4488:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4489"/> 4489:                          type     := Type,
<a name="4490"/> 4490:                          protocol := Protocol} = State) -&gt; 
<a name="4491"/> 4491:                            case socket:open(Domain, Type, Protocol) of
<a name="4492"/> 4492:                                {ok, Sock1} -&gt;
<a name="4493"/> 4493:                                    {ok, State#{sock1 =&gt; Sock1}};
<a name="4494"/> 4494:                                {error, _} = ERROR -&gt;
<a name="4495"/> 4495:                                    ERROR
<a name="4496"/> 4496:                            end
<a name="4497"/> 4497:                    end},
<a name="4498"/> 4498:          #{desc =&gt; &quot;get socket (1) FD&quot;,
<a name="4499"/> 4499:            cmd  =&gt; fun(#{sock1 := Sock1} = State) -&gt;
<a name="4500"/> 4500:                            case socket:getopt(Sock1, otp, fd) of
<a name="4501"/> 4501:                                {ok, FD} -&gt;
<a name="4502"/> 4502:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="4503"/> 4503:                                    {ok, State#{fd =&gt; FD}};
<a name="4504"/> 4504:                                {error, Reason} = ERROR -&gt;
<a name="4505"/> 4505:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="4506"/> 4506:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="4507"/> 4507:                                    ERROR
<a name="4508"/> 4508:                            end
<a name="4509"/> 4509:                    end},
<a name="4510"/> 4510:          #{desc =&gt; &quot;check if we need to provide domain or not&quot;,
<a name="4511"/> 4511:            cmd  =&gt; fun(#{sock1 := Sock1} = State) -&gt;
<a name="4512"/> 4512:                            case socket:getopt(Sock1, socket, domain) of
<a name="4513"/> 4513:                                {ok, _} -&gt;
<a name="4514"/> 4514:                                    ?SEV_IPRINT(&quot;domain accessible&quot;),
<a name="4515"/> 4515:                                    {ok, State#{provide_domain =&gt; false}};
<a name="4516"/> 4516:                                {error, Reason} -&gt;
<a name="4517"/> 4517:                                    ?SEV_IPRINT(&quot;failed get domain: &quot;
<a name="4518"/> 4518:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="4519"/> 4519:                                    {ok, State#{provide_domain =&gt; true}}
<a name="4520"/> 4520:                            end
<a name="4521"/> 4521:                    end},
<a name="4522"/> 4522:          #{desc =&gt; &quot;check if we need to provide protocol or not&quot;,
<a name="4523"/> 4523:            cmd  =&gt; fun(#{sock1 := Sock1} = State) -&gt;
<a name="4524"/> 4524:                            case socket:getopt(Sock1, socket, protocol) of
<a name="4525"/> 4525:                                {ok, _} -&gt;
<a name="4526"/> 4526:                                    ?SEV_IPRINT(&quot;protocol accessible&quot;),
<a name="4527"/> 4527:                                    {ok, State#{provide_protocol =&gt; false}};
<a name="4528"/> 4528:                                {error, Reason} -&gt;
<a name="4529"/> 4529:                                    ?SEV_IPRINT(&quot;failed get protocol: &quot;
<a name="4530"/> 4530:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="4531"/> 4531:                                    {ok, State#{provide_protocol =&gt; true}}
<a name="4532"/> 4532:                            end
<a name="4533"/> 4533:                    end},
<a name="4534"/> 4534:          #{desc =&gt; &quot;open with FD&quot;,
<a name="4535"/> 4535:            cmd  =&gt; fun(#{fd               := FD,
<a name="4536"/> 4536:                          dup              := DUP,
<a name="4537"/> 4537:                          provide_domain   := PD,
<a name="4538"/> 4538:                          domain           := Domain,
<a name="4539"/> 4539:                          provide_protocol := PP,
<a name="4540"/> 4540:                          protocol         := Protocol} = State) -&gt;
<a name="4541"/> 4541:                            Opts =
<a name="4542"/> 4542:                                case {PD, PP} of
<a name="4543"/> 4543:                                    {true, true} -&gt;
<a name="4544"/> 4544:                                        #{dup      =&gt; DUP,
<a name="4545"/> 4545:                                          domain   =&gt; Domain,
<a name="4546"/> 4546:                                          protocol =&gt; Protocol};
<a name="4547"/> 4547:                                    {true, false} -&gt;
<a name="4548"/> 4548:                                        #{dup      =&gt; DUP,
<a name="4549"/> 4549:                                          domain   =&gt; Domain};
<a name="4550"/> 4550:                                    {false, true} -&gt;
<a name="4551"/> 4551:                                        #{dup      =&gt; DUP,
<a name="4552"/> 4552:                                          protocol =&gt; Protocol};
<a name="4553"/> 4553:                                    {false, false} -&gt;
<a name="4554"/> 4554:                                        #{dup      =&gt; DUP}
<a name="4555"/> 4555:                                end,
<a name="4556"/> 4556:                            ?SEV_IPRINT(&quot;try open socket with&quot;
<a name="4557"/> 4557:                                        &quot;~n   FD:   ~p&quot;
<a name="4558"/> 4558:                                        &quot;~n   Opts: ~p&quot;, [FD, Opts]),
<a name="4559"/> 4559:                            case socket:open(FD, Opts) of
<a name="4560"/> 4560:                                {ok, Sock2} -&gt;
<a name="4561"/> 4561:                                    ?SEV_IPRINT(&quot;socket 2 open&quot;),
<a name="4562"/> 4562:                                    {ok, State#{sock2 =&gt; Sock2}};
<a name="4563"/> 4563:                                {error, Reason} = ERROR -&gt;
<a name="4564"/> 4564:                                    ?SEV_EPRINT(&quot;failed open socket with FD &quot;
<a name="4565"/> 4565:                                                  &quot;(p, ~w): &quot;
<a name="4566"/> 4566:                                                &quot;~n   ~p&quot;, [FD, Reason]),
<a name="4567"/> 4567:                                    ERROR
<a name="4568"/> 4568:                            end
<a name="4569"/> 4569:                    end},
<a name="4570"/> 4570:          #{desc =&gt; &quot;get socket (1) info&quot;,
<a name="4571"/> 4571:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="4572"/> 4572:                            %% socket:setopt(Sock, otp, debug, true),
<a name="4573"/> 4573:                            Info = socket:info(Sock),
<a name="4574"/> 4574:                            %% socket:setopt(Sock, otp, debug, false),
<a name="4575"/> 4575:                            ?SEV_IPRINT(&quot;Got Info: &quot;
<a name="4576"/> 4576:                                        &quot;~n   ~p&quot;, [Info]),
<a name="4577"/> 4577:                            {ok, State#{info1 =&gt; Info}}
<a name="4578"/> 4578:                    end},
<a name="4579"/> 4579:          #{desc =&gt; &quot;get socket (2) info&quot;,
<a name="4580"/> 4580:            cmd  =&gt; fun(#{sock2 := Sock} = State) -&gt;
<a name="4581"/> 4581:                            %% socket:setopt(Sock, otp, debug, true),
<a name="4582"/> 4582:                            Info = socket:info(Sock),
<a name="4583"/> 4583:                            %% socket:setopt(Sock, otp, debug, false),
<a name="4584"/> 4584:                            ?SEV_IPRINT(&quot;Got Info: &quot;
<a name="4585"/> 4585:                                        &quot;~n   ~p&quot;, [Info]),
<a name="4586"/> 4586:                            {ok, State#{info2 =&gt; Info}}
<a name="4587"/> 4587:                    end},
<a name="4588"/> 4588:          #{desc =&gt; &quot;validate socket (1) info&quot;,
<a name="4589"/> 4589:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4590"/> 4590:                          type     := Type,
<a name="4591"/> 4591:                          protocol := Protocol,
<a name="4592"/> 4592:                          info1    := #{domain        := Domain,
<a name="4593"/> 4593:                                        type          := Type,
<a name="4594"/> 4594:                                        protocol      := Protocol,
<a name="4595"/> 4595:                                        ctype         := normal,
<a name="4596"/> 4596:                                        counters      := _,
<a name="4597"/> 4597:                                        num_readers   := 0,
<a name="4598"/> 4598:                                        num_writers   := 0,
<a name="4599"/> 4599:                                        num_acceptors := 0}}) -&gt;
<a name="4600"/> 4600:                            ok;
<a name="4601"/> 4601:                       (#{domain   := Domain,
<a name="4602"/> 4602:                          type     := Type,
<a name="4603"/> 4603:                          protocol := Protocol,
<a name="4604"/> 4604:                          info     := Info}) -&gt;
<a name="4605"/> 4605:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 1: &quot;
<a name="4606"/> 4606:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="4607"/> 4607:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="4608"/> 4608:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="4609"/> 4609:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="4610"/> 4610:                                        &quot;~n   ~p&quot;,
<a name="4611"/> 4611:                                        [Domain, Type, Protocol, normal, Info]),
<a name="4612"/> 4612:                            {error, unexpected_infio}
<a name="4613"/> 4613:                    end},
<a name="4614"/> 4614:          #{desc =&gt; &quot;validate socket (2) info&quot;,
<a name="4615"/> 4615:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4616"/> 4616:                          type     := Type,
<a name="4617"/> 4617:                          protocol := Protocol,
<a name="4618"/> 4618:                          fd       := _FD,
<a name="4619"/> 4619:                          dup      := false,
<a name="4620"/> 4620:                          info2    := #{domain        := Domain,
<a name="4621"/> 4621:                                        type          := Type,
<a name="4622"/> 4622:                                        protocol      := Protocol,
<a name="4623"/> 4623:                                        ctype         := fromfd,
<a name="4624"/> 4624:                                        counters      := _,
<a name="4625"/> 4625:                                        num_readers   := 0,
<a name="4626"/> 4626:                                        num_writers   := 0,
<a name="4627"/> 4627:                                        num_acceptors := 0}}) -&gt;
<a name="4628"/> 4628:                            ok;
<a name="4629"/> 4629:                       (#{domain   := Domain,
<a name="4630"/> 4630:                          type     := Type,
<a name="4631"/> 4631:                          protocol := Protocol,
<a name="4632"/> 4632:                          fd       := _FD,
<a name="4633"/> 4633:                          dup      := false,
<a name="4634"/> 4634:                          info     := Info}) -&gt;
<a name="4635"/> 4635:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 2: &quot;
<a name="4636"/> 4636:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="4637"/> 4637:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="4638"/> 4638:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="4639"/> 4639:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="4640"/> 4640:                                        &quot;~n   ~p&quot;,
<a name="4641"/> 4641:                                        [Domain, Type, Protocol,
<a name="4642"/> 4642:                                         fromfd, Info]),
<a name="4643"/> 4643:                            {error, unexpected_info};
<a name="4644"/> 4644:                       (#{domain   := Domain,
<a name="4645"/> 4645:                          type     := Type,
<a name="4646"/> 4646:                          protocol := Protocol,
<a name="4647"/> 4647:                          fd       := FD,
<a name="4648"/> 4648:                          dup      := true,
<a name="4649"/> 4649:                          info2    := #{domain        := Domain,
<a name="4650"/> 4650:                                        type          := Type,
<a name="4651"/> 4651:                                        protocol      := Protocol,
<a name="4652"/> 4652:                                        ctype         := {fromfd, FD},
<a name="4653"/> 4653:                                        counters      := _,
<a name="4654"/> 4654:                                        num_readers   := 0,
<a name="4655"/> 4655:                                        num_writers   := 0,
<a name="4656"/> 4656:                                        num_acceptors := 0}}) -&gt;
<a name="4657"/> 4657:                            ok;
<a name="4658"/> 4658:                       (#{domain   := Domain,
<a name="4659"/> 4659:                          type     := Type,
<a name="4660"/> 4660:                          protocol := Protocol,
<a name="4661"/> 4661:                          fd       := FD,
<a name="4662"/> 4662:                          dup      := true,
<a name="4663"/> 4663:                          info     := Info}) -&gt;
<a name="4664"/> 4664:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 2: &quot;
<a name="4665"/> 4665:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="4666"/> 4666:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="4667"/> 4667:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="4668"/> 4668:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="4669"/> 4669:                                        &quot;~n   ~p&quot;,
<a name="4670"/> 4670:                                        [Domain, Type, Protocol,
<a name="4671"/> 4671:                                         {fromfd, FD}, Info]),
<a name="4672"/> 4672:                            {error, unexpected_info}
<a name="4673"/> 4673:                    end},
<a name="4674"/> 4674:          #{desc =&gt; &quot;close socket (1)&quot;,
<a name="4675"/> 4675:            cmd  =&gt; fun(#{sock1 := Sock} = _State) -&gt;
<a name="4676"/> 4676:                            socket:close(Sock)
<a name="4677"/> 4677:                    end},
<a name="4678"/> 4678:          #{desc =&gt; &quot;close socket (2)&quot;,
<a name="4679"/> 4679:            cmd  =&gt; fun(#{sock2 := Sock} = _State) -&gt;
<a name="4680"/> 4680:                            socket:close(Sock)
<a name="4681"/> 4681:                    end},
<a name="4682"/> 4682: 
<a name="4683"/> 4683:          %% *** We are done ***
<a name="4684"/> 4684:          ?SEV_FINISH_NORMAL
<a name="4685"/> 4685:         ],
<a name="4686"/> 4686:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_ffd_open_and_info-last_expr"/><a name="4687"/> 4687: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="4688"/> 4688: 
<a name="4689"/> 4689: 
<a name="4690"/> 4690: 
<a name="4691"/> 4691: 
<a name="4692"/> 4692: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4693"/> 4693: 
<a name="4694"/> 4694: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="4695"/> 4695: <i>%% its file descriptor *without* dup.</i>
<a name="4696"/> 4696: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="4697"/> 4697: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="4698"/> 4698: <i>%% has not been closed (test by sending some data).</i>
<a name="4699"/> 4699: <i>%% IPv4 UDP (dgram) socket.</i>
<a name="4700"/> 4700: <i>%%</i>
<a name="4701"/> 4701: <i>%% &lt;WARNING&gt;</i>
<a name="4702"/> 4702: <i>%%</i>
<a name="4703"/> 4703: <i>%% This is *not* how its intended to be used.</i>
<a name="4704"/> 4704: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="4705"/> 4705: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="4706"/> 4706: <i>%% to test it!</i>
<a name="4707"/> 4707: <i>%%</i>
<a name="4708"/> 4708: <i>%% &lt;/WARNING&gt;</i>
<a name="4709"/> 4709: <i>%%</i>
<a name="api_ffd_open_and_open_wod_and_send_udp4-1"/><a name="4710"/> 4710: <b>api_ffd_open_and_open_wod_and_send_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4711"/> 4711:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wod_and_send_udp4-last_expr"/><a name="4712"/> 4712: <b>    tc_try</b>(api_ffd_open_and_open_wod_and_send_udp4,
<a name="4713"/> 4713:            fun() -&gt;
<a name="4714"/> 4714:                    has_support_ipv4()
<a name="4715"/> 4715:            end,
<a name="4716"/> 4716:            fun() -&gt;
<a name="4717"/> 4717:                    InitState = #{domain   =&gt; inet,
<a name="4718"/> 4718:                                  type     =&gt; dgram,
<a name="4719"/> 4719:                                  protocol =&gt; udp,
<a name="4720"/> 4720:                                  dup      =&gt; false},
<a name="4721"/> 4721:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="4722"/> 4722:            end).
<a name="4723"/> 4723: 
<a name="4724"/> 4724: 
<a name="4725"/> 4725: 
<a name="4726"/> 4726: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4727"/> 4727: 
<a name="4728"/> 4728: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="4729"/> 4729: <i>%% its file descriptor *without* dup.</i>
<a name="4730"/> 4730: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="4731"/> 4731: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="4732"/> 4732: <i>%% has not been closed (test by sending some data).</i>
<a name="4733"/> 4733: <i>%% IPv6 UDP (dgram) socket.</i>
<a name="4734"/> 4734: <i>%%</i>
<a name="4735"/> 4735: <i>%% &lt;WARNING&gt;</i>
<a name="4736"/> 4736: <i>%%</i>
<a name="4737"/> 4737: <i>%% This is *not* how its intended to be used.</i>
<a name="4738"/> 4738: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="4739"/> 4739: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="4740"/> 4740: <i>%% to test it!</i>
<a name="4741"/> 4741: <i>%%</i>
<a name="4742"/> 4742: <i>%% &lt;/WARNING&gt;</i>
<a name="4743"/> 4743: <i>%%</i>
<a name="api_ffd_open_and_open_wod_and_send_udp6-1"/><a name="4744"/> 4744: <b>api_ffd_open_and_open_wod_and_send_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4745"/> 4745:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wod_and_send_udp6-last_expr"/><a name="4746"/> 4746: <b>    tc_try</b>(api_ffd_open_and_open_wod_and_send_udp6,
<a name="4747"/> 4747:            fun() -&gt;
<a name="4748"/> 4748:                    has_support_ipv6()
<a name="4749"/> 4749:            end,
<a name="4750"/> 4750:            fun() -&gt;
<a name="4751"/> 4751:                    InitState = #{domain   =&gt; inet6,
<a name="4752"/> 4752:                                  type     =&gt; dgram,
<a name="4753"/> 4753:                                  protocol =&gt; udp,
<a name="4754"/> 4754:                                  dup      =&gt; false},
<a name="4755"/> 4755:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="4756"/> 4756:            end).
<a name="4757"/> 4757: 
<a name="4758"/> 4758: 
<a name="4759"/> 4759: 
<a name="4760"/> 4760: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4761"/> 4761: 
<a name="4762"/> 4762: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="4763"/> 4763: <i>%% its file descriptor *with* dup.</i>
<a name="4764"/> 4764: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="4765"/> 4765: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="4766"/> 4766: <i>%% has not been closed (test by sending some data).</i>
<a name="4767"/> 4767: <i>%% IPv4 UDP (dgram) socket.</i>
<a name="4768"/> 4768: <i>%%</i>
<a name="api_ffd_open_and_open_wd_and_send_udp4-1"/><a name="4769"/> 4769: <b>api_ffd_open_and_open_wd_and_send_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4770"/> 4770:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wd_and_send_udp4-last_expr"/><a name="4771"/> 4771: <b>    tc_try</b>(api_ffd_open_and_open_wd_and_send_udp4,
<a name="4772"/> 4772:            fun() -&gt;
<a name="4773"/> 4773:                    has_support_ipv4()
<a name="4774"/> 4774:            end,
<a name="4775"/> 4775:            fun() -&gt;
<a name="4776"/> 4776:                    InitState = #{domain   =&gt; inet,
<a name="4777"/> 4777:                                  type     =&gt; dgram,
<a name="4778"/> 4778:                                  protocol =&gt; udp,
<a name="4779"/> 4779:                                  dup      =&gt; true},
<a name="4780"/> 4780:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="4781"/> 4781:            end).
<a name="4782"/> 4782: 
<a name="4783"/> 4783: 
<a name="4784"/> 4784: 
<a name="4785"/> 4785: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4786"/> 4786: 
<a name="4787"/> 4787: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="4788"/> 4788: <i>%% its file descriptor *with* dup.</i>
<a name="4789"/> 4789: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="4790"/> 4790: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="4791"/> 4791: <i>%% has not been closed (test by sending some data).</i>
<a name="4792"/> 4792: <i>%% IPv6 UDP (dgram) socket.</i>
<a name="4793"/> 4793: <i>%%</i>
<a name="api_ffd_open_and_open_wd_and_send_udp6-1"/><a name="4794"/> 4794: <b>api_ffd_open_and_open_wd_and_send_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4795"/> 4795:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wd_and_send_udp6-last_expr"/><a name="4796"/> 4796: <b>    tc_try</b>(api_ffd_open_and_open_wd_and_send_udp6,
<a name="4797"/> 4797:            fun() -&gt; has_support_ipv6() end,
<a name="4798"/> 4798:            fun() -&gt;
<a name="4799"/> 4799:                    InitState = #{domain   =&gt; inet6,
<a name="4800"/> 4800:                                  type     =&gt; dgram,
<a name="4801"/> 4801:                                  protocol =&gt; udp,
<a name="4802"/> 4802:                                  dup      =&gt; true},
<a name="4803"/> 4803:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="4804"/> 4804:            end).
<a name="4805"/> 4805: 
<a name="4806"/> 4806: 
<a name="4807"/> 4807: 
<a name="4808"/> 4808: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4809"/> 4809: 
<a name="api_ffd_open_and_open_and_send_udp-1"/><a name="4810"/> 4810: <b>api_ffd_open_and_open_and_send_udp</b>(InitState) -&gt;
<a name="4811"/> 4811:     Send = fun(Sock, Data, Dest) -&gt;
<a name="4812"/> 4812:                    socket:sendto(Sock, Data, Dest)
<a name="4813"/> 4813:            end,
<a name="4814"/> 4814:     Recv = fun(Sock) -&gt;
<a name="4815"/> 4815:                    socket:recvfrom(Sock)
<a name="4816"/> 4816:            end,
<a name="api_ffd_open_and_open_and_send_udp-last_expr"/><a name="4817"/> 4817: <b>    api_ffd_open_and_open_and_send_udp2</b>(InitState#{send   =&gt; Send,
<a name="4818"/> 4818:                                                            recv   =&gt; Recv}).
<a name="4819"/> 4819: 
<a name="api_ffd_open_and_open_and_send_udp2-1"/><a name="4820"/> 4820: <b>api_ffd_open_and_open_and_send_udp2</b>(InitState) -&gt;
<a name="4821"/> 4821:     process_flag(trap_exit, true),
<a name="4822"/> 4822:     ServerSeq = 
<a name="4823"/> 4823:         [
<a name="4824"/> 4824:          %% *** Wait for start order ***
<a name="4825"/> 4825:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="4826"/> 4826:            cmd  =&gt; fun(State) -&gt;
<a name="4827"/> 4827:                            Tester = ?SEV_AWAIT_START(),
<a name="4828"/> 4828:                            {ok, State#{tester =&gt; Tester}}
<a name="4829"/> 4829:                    end},
<a name="4830"/> 4830:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="4831"/> 4831:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4832"/> 4832:                            _MRef = erlang:monitor(process, Tester),
<a name="4833"/> 4833:                            ok
<a name="4834"/> 4834:                    end},
<a name="4835"/> 4835: 
<a name="4836"/> 4836:          %% *** Init part ***
<a name="4837"/> 4837:          #{desc =&gt; &quot;which local address&quot;,
<a name="4838"/> 4838:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="4839"/> 4839:                            LSA = which_local_socket_addr(Domain),
<a name="4840"/> 4840:                            {ok, State#{lsa =&gt; LSA}}
<a name="4841"/> 4841:                    end},
<a name="4842"/> 4842:          #{desc =&gt; &quot;create socket&quot;,
<a name="4843"/> 4843:            cmd  =&gt; fun(#{domain   := Domain,
<a name="4844"/> 4844:                          protocol := Proto} = State) -&gt;
<a name="4845"/> 4845:                            case socket:open(Domain, dgram, Proto) of
<a name="4846"/> 4846:                                {ok, Sock} -&gt;
<a name="4847"/> 4847:                                    {ok, State#{sock =&gt; Sock}};
<a name="4848"/> 4848:                                {error, _} = ERROR -&gt;
<a name="4849"/> 4849:                                    ERROR
<a name="4850"/> 4850:                            end
<a name="4851"/> 4851:                    end},
<a name="4852"/> 4852:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="4853"/> 4853:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = State) -&gt;
<a name="4854"/> 4854:                            case sock_bind(Sock, LSA) of
<a name="4855"/> 4855:                                ok -&gt;
<a name="4856"/> 4856:                                    Port = sock_port(Sock),
<a name="4857"/> 4857:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="4858"/> 4858:                                    {ok, State#{port =&gt; Port}};
<a name="4859"/> 4859:                                {error, _} = ERROR -&gt;
<a name="4860"/> 4860:                                    ERROR
<a name="4861"/> 4861:                            end
<a name="4862"/> 4862:                    end},
<a name="4863"/> 4863:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="4864"/> 4864:            cmd  =&gt; fun(#{tester := Tester, port := Port}) -&gt;
<a name="4865"/> 4865:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="4866"/> 4866:                            ok
<a name="4867"/> 4867:                    end},
<a name="4868"/> 4868: 
<a name="4869"/> 4869:          #{desc =&gt; &quot;await request 1 (recv)&quot;,
<a name="4870"/> 4870:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="4871"/> 4871:                            case Recv(Sock) of
<a name="4872"/> 4872:                                {ok, {Source, ?BASIC_REQ}} -&gt;
<a name="4873"/> 4873:                                    ?SEV_IPRINT(&quot;received request (1) from: &quot;
<a name="4874"/> 4874:                                                &quot;~n   ~p&quot;, [Source]),
<a name="4875"/> 4875:                                    {ok, State#{source =&gt; Source}};
<a name="4876"/> 4876:                                {error, _} = ERROR -&gt;
<a name="4877"/> 4877:                                    ERROR
<a name="4878"/> 4878:                            end
<a name="4879"/> 4879:                    end},
<a name="4880"/> 4880:          #{desc =&gt; &quot;announce ready 1 (recv request)&quot;,
<a name="4881"/> 4881:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4882"/> 4882:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="4883"/> 4883:                            ok
<a name="4884"/> 4884:                    end},
<a name="4885"/> 4885:          #{desc =&gt; &quot;await continue 1 (with send reply)&quot;,
<a name="4886"/> 4886:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4887"/> 4887:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="4888"/> 4888:                    end},
<a name="4889"/> 4889:          #{desc =&gt; &quot;send reply 1&quot;,
<a name="4890"/> 4890:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="4891"/> 4891:                            Send(Sock, ?BASIC_REP, Source)
<a name="4892"/> 4892:                    end},
<a name="4893"/> 4893:          #{desc =&gt; &quot;announce ready 1 (send reply)&quot;,
<a name="4894"/> 4894:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4895"/> 4895:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="4896"/> 4896:                            {ok, maps:remove(source, State)}
<a name="4897"/> 4897:                    end},
<a name="4898"/> 4898: 
<a name="4899"/> 4899:          #{desc =&gt; &quot;await request 2 (recv)&quot;,
<a name="4900"/> 4900:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="4901"/> 4901:                            case Recv(Sock) of
<a name="4902"/> 4902:                                {ok, {Source, ?BASIC_REQ}} -&gt; 
<a name="4903"/> 4903:                                    ?SEV_IPRINT(&quot;received request (2) from: &quot;
<a name="4904"/> 4904:                                                &quot;~n   ~p&quot;, [Source]),
<a name="4905"/> 4905:                                    {ok, State#{source =&gt; Source}};
<a name="4906"/> 4906:                                {error, _} = ERROR -&gt;
<a name="4907"/> 4907:                                    ERROR
<a name="4908"/> 4908:                            end
<a name="4909"/> 4909:                    end},
<a name="4910"/> 4910:          #{desc =&gt; &quot;announce ready 2 (recv request)&quot;,
<a name="4911"/> 4911:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4912"/> 4912:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="4913"/> 4913:                            ok
<a name="4914"/> 4914:                    end},
<a name="4915"/> 4915:          #{desc =&gt; &quot;await continue 2 (with send reply)&quot;,
<a name="4916"/> 4916:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4917"/> 4917:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="4918"/> 4918:                    end},
<a name="4919"/> 4919:          #{desc =&gt; &quot;send reply 2&quot;,
<a name="4920"/> 4920:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="4921"/> 4921:                            Send(Sock, ?BASIC_REP, Source)
<a name="4922"/> 4922:                    end},
<a name="4923"/> 4923:          #{desc =&gt; &quot;announce ready 2 (send reply)&quot;,
<a name="4924"/> 4924:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4925"/> 4925:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="4926"/> 4926:                            {ok, maps:remove(source, State)}
<a name="4927"/> 4927:                    end},
<a name="4928"/> 4928: 
<a name="4929"/> 4929:          #{desc =&gt; &quot;await request 3 (recv)&quot;,
<a name="4930"/> 4930:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="4931"/> 4931:                            case Recv(Sock) of
<a name="4932"/> 4932:                                {ok, {Source, ?BASIC_REQ}} -&gt;
<a name="4933"/> 4933:                                    ?SEV_IPRINT(&quot;received request (2) from: &quot;
<a name="4934"/> 4934:                                                &quot;~n   ~p&quot;, [Source]),
<a name="4935"/> 4935:                                    {ok, State#{source =&gt; Source}};
<a name="4936"/> 4936:                                {error, _} = ERROR -&gt;
<a name="4937"/> 4937:                                    ERROR
<a name="4938"/> 4938:                            end
<a name="4939"/> 4939:                    end},
<a name="4940"/> 4940:          #{desc =&gt; &quot;announce ready 3 (recv request)&quot;,
<a name="4941"/> 4941:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4942"/> 4942:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="4943"/> 4943:                            ok
<a name="4944"/> 4944:                    end},
<a name="4945"/> 4945:          #{desc =&gt; &quot;await continue 3 (with send reply)&quot;,
<a name="4946"/> 4946:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4947"/> 4947:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="4948"/> 4948:                    end},
<a name="4949"/> 4949:          #{desc =&gt; &quot;send reply 3&quot;,
<a name="4950"/> 4950:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="4951"/> 4951:                            Send(Sock, ?BASIC_REP, Source)
<a name="4952"/> 4952:                    end},
<a name="4953"/> 4953:          #{desc =&gt; &quot;announce ready 3 (send reply)&quot;,
<a name="4954"/> 4954:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4955"/> 4955:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="4956"/> 4956:                            {ok, maps:remove(source, State)}
<a name="4957"/> 4957:                    end},
<a name="4958"/> 4958: 
<a name="4959"/> 4959:          %% *** Termination ***
<a name="4960"/> 4960:          #{desc =&gt; &quot;await terminate&quot;,
<a name="4961"/> 4961:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4962"/> 4962:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="4963"/> 4963:                                ok -&gt;
<a name="4964"/> 4964:                                    {ok, maps:remove(tester, State)};
<a name="4965"/> 4965:                                {error, _} = ERROR -&gt;
<a name="4966"/> 4966:                                    ERROR
<a name="4967"/> 4967:                            end
<a name="4968"/> 4968:                    end},
<a name="4969"/> 4969:          #{desc =&gt; &quot;close socket&quot;,
<a name="4970"/> 4970:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="4971"/> 4971:                            ok = socket:close(Sock),
<a name="4972"/> 4972:                            {ok, maps:remove(sock, State)}
<a name="4973"/> 4973:                    end},
<a name="4974"/> 4974: 
<a name="4975"/> 4975:          %% *** We are done ***
<a name="4976"/> 4976:          ?SEV_FINISH_NORMAL
<a name="4977"/> 4977:         ],
<a name="4978"/> 4978: 
<a name="4979"/> 4979: 
<a name="4980"/> 4980:     Client1Seq =
<a name="4981"/> 4981:         [
<a name="4982"/> 4982:          %% *** Wait for start order ***
<a name="4983"/> 4983:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="4984"/> 4984:            cmd  =&gt; fun(State) -&gt;
<a name="4985"/> 4985:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="4986"/> 4986:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="4987"/> 4987:                    end},
<a name="4988"/> 4988:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="4989"/> 4989:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4990"/> 4990:                            _MRef = erlang:monitor(process, Tester),
<a name="4991"/> 4991:                            ok
<a name="4992"/> 4992:                    end},
<a name="4993"/> 4993: 
<a name="4994"/> 4994:          %% *** The init part ***
<a name="4995"/> 4995:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="4996"/> 4996:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="4997"/> 4997:                            LSA = which_local_socket_addr(Domain),
<a name="4998"/> 4998:                            SSA = LSA#{port =&gt; Port},
<a name="4999"/> 4999:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="5000"/> 5000:                    end},
<a name="5001"/> 5001:          #{desc =&gt; &quot;create socket&quot;,
<a name="5002"/> 5002:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5003"/> 5003:                          protocol := Proto} = State) -&gt;
<a name="5004"/> 5004:                            case socket:open(Domain, dgram, Proto) of
<a name="5005"/> 5005:                                {ok, Sock} -&gt;
<a name="5006"/> 5006:                                    {ok, State#{sock =&gt; Sock}};
<a name="5007"/> 5007:                                {error, _} = ERROR -&gt;
<a name="5008"/> 5008:                                    ERROR
<a name="5009"/> 5009:                            end
<a name="5010"/> 5010:                    end},
<a name="5011"/> 5011:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="5012"/> 5012:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="5013"/> 5013:                            case sock_bind(Sock, LSA) of
<a name="5014"/> 5014:                                ok -&gt;
<a name="5015"/> 5015:                                    ok;
<a name="5016"/> 5016:                                {error, _} = ERROR -&gt;
<a name="5017"/> 5017:                                    ERROR
<a name="5018"/> 5018:                            end
<a name="5019"/> 5019:                    end},
<a name="5020"/> 5020:          #{desc =&gt; &quot;get socket FD&quot;,
<a name="5021"/> 5021:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5022"/> 5022:                            case socket:getopt(Sock, otp, fd) of
<a name="5023"/> 5023:                                {ok, FD} -&gt;
<a name="5024"/> 5024:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="5025"/> 5025:                                    {ok, State#{fd =&gt; FD}};
<a name="5026"/> 5026:                                {error, Reason} = ERROR -&gt;
<a name="5027"/> 5027:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="5028"/> 5028:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5029"/> 5029:                                    ERROR
<a name="5030"/> 5030:                            end
<a name="5031"/> 5031:                    end},
<a name="5032"/> 5032:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5033"/> 5033:            cmd  =&gt; fun(#{tester := Tester,
<a name="5034"/> 5034:                          fd     := FD}) -&gt;
<a name="5035"/> 5035:                            ?SEV_ANNOUNCE_READY(Tester, init, FD),
<a name="5036"/> 5036:                            ok
<a name="5037"/> 5037:                    end},
<a name="5038"/> 5038: 
<a name="5039"/> 5039:          %% *** The actual test ***
<a name="5040"/> 5040:          #{desc =&gt; &quot;await continue (send request 1)&quot;,
<a name="5041"/> 5041:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5042"/> 5042:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5043"/> 5043:                    end},
<a name="5044"/> 5044:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="5045"/> 5045:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="5046"/> 5046:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="5047"/> 5047:                    end},
<a name="5048"/> 5048:          #{desc =&gt; &quot;announce ready (send request 1)&quot;,
<a name="5049"/> 5049:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5050"/> 5050:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5051"/> 5051:                            ok
<a name="5052"/> 5052:                    end},
<a name="5053"/> 5053:          #{desc =&gt; &quot;await recv reply 1 (from server)&quot;,
<a name="5054"/> 5054:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5055"/> 5055:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="5056"/> 5056:                            ok
<a name="5057"/> 5057:                    end},
<a name="5058"/> 5058:          #{desc =&gt; &quot;announce ready (recv reply 1)&quot;,
<a name="5059"/> 5059:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5060"/> 5060:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5061"/> 5061:                            ok
<a name="5062"/> 5062:                    end},
<a name="5063"/> 5063: 
<a name="5064"/> 5064:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="5065"/> 5065:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5066"/> 5066:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5067"/> 5067:                    end},
<a name="5068"/> 5068:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="5069"/> 5069:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="5070"/> 5070:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="5071"/> 5071:                    end},
<a name="5072"/> 5072:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="5073"/> 5073:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5074"/> 5074:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5075"/> 5075:                            ok
<a name="5076"/> 5076:                    end},
<a name="5077"/> 5077:          #{desc =&gt; &quot;await recv reply 3 (from server)&quot;,
<a name="5078"/> 5078:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5079"/> 5079:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="5080"/> 5080:                            ok
<a name="5081"/> 5081:                    end},
<a name="5082"/> 5082:          #{desc =&gt; &quot;announce ready (recv reply 3)&quot;,
<a name="5083"/> 5083:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5084"/> 5084:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5085"/> 5085:                            ok
<a name="5086"/> 5086:                    end},
<a name="5087"/> 5087: 
<a name="5088"/> 5088:          %% *** Termination ***
<a name="5089"/> 5089:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5090"/> 5090:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5091"/> 5091:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5092"/> 5092:                                ok -&gt;
<a name="5093"/> 5093:                                    {ok, maps:remove(tester, State)};
<a name="5094"/> 5094:                                {error, _} = ERROR -&gt;
<a name="5095"/> 5095:                                    ERROR
<a name="5096"/> 5096:                            end
<a name="5097"/> 5097:                    end},
<a name="5098"/> 5098:          #{desc =&gt; &quot;close socket&quot;,
<a name="5099"/> 5099:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5100"/> 5100:                            ok = socket:close(Sock),
<a name="5101"/> 5101:                            {ok, maps:remove(sock, State)}
<a name="5102"/> 5102:                    end},
<a name="5103"/> 5103: 
<a name="5104"/> 5104:          %% *** We are done ***
<a name="5105"/> 5105:          ?SEV_FINISH_NORMAL
<a name="5106"/> 5106:         ],
<a name="5107"/> 5107: 
<a name="5108"/> 5108: 
<a name="5109"/> 5109:     Client2Seq =
<a name="5110"/> 5110:         [
<a name="5111"/> 5111:          %% *** Wait for start order ***
<a name="5112"/> 5112:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5113"/> 5113:            cmd  =&gt; fun(State) -&gt;
<a name="5114"/> 5114:                            {Tester, {Port, FD}} = ?SEV_AWAIT_START(),
<a name="5115"/> 5115:                            {ok, State#{tester      =&gt; Tester,
<a name="5116"/> 5116:                                        server_port =&gt; Port,
<a name="5117"/> 5117:                                        fd          =&gt; FD}}
<a name="5118"/> 5118:                    end},
<a name="5119"/> 5119:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5120"/> 5120:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5121"/> 5121:                            _MRef = erlang:monitor(process, Tester),
<a name="5122"/> 5122:                            ok
<a name="5123"/> 5123:                    end},
<a name="5124"/> 5124: 
<a name="5125"/> 5125:          %% *** The init part ***
<a name="5126"/> 5126:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="5127"/> 5127:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="5128"/> 5128:                            LSA = which_local_socket_addr(Domain),
<a name="5129"/> 5129:                            SSA = LSA#{port =&gt; Port},
<a name="5130"/> 5130:                            {ok, State#{server_sa =&gt; SSA}}
<a name="5131"/> 5131:                    end},
<a name="5132"/> 5132:          #{desc =&gt; &quot;create socket&quot;,
<a name="5133"/> 5133:            cmd  =&gt; fun(#{fd     := FD,
<a name="5134"/> 5134:                          dup    := DUP,
<a name="5135"/> 5135:                          domain := Domain} = State) -&gt;
<a name="5136"/> 5136:                            ?SEV_IPRINT(&quot;try create socket with: &quot;
<a name="5137"/> 5137:                                        &quot;~n   FD:     ~p&quot;
<a name="5138"/> 5138:                                        &quot;~n   DUP:    ~p&quot;
<a name="5139"/> 5139:                                        &quot;~n   Domain: ~p&quot;, [FD, DUP, Domain]),
<a name="5140"/> 5140:                            %% On some platforms (Darwin and NetBSD) domain
<a name="5141"/> 5141:                            %% is needed...
<a name="5142"/> 5142:                            case socket:open(FD, #{dup    =&gt; DUP,
<a name="5143"/> 5143:                                                   domain =&gt; Domain}) of
<a name="5144"/> 5144:                                {ok, Sock} -&gt;
<a name="5145"/> 5145:                                    {ok, State#{sock =&gt; Sock}};
<a name="5146"/> 5146:                                {error,
<a name="5147"/> 5147:                                 {invalid,{options,domain,#{dup := DUP}}} = R} -&gt;
<a name="5148"/> 5148:                                    ?SEV_EPRINT(&quot;failed create socket:&quot;
<a name="5149"/> 5149:                                                &quot;~n   ~p&quot;, [R]),
<a name="5150"/> 5150:                                    {skip, domain};
<a name="5151"/> 5151:                                {error, Reason} = ERROR -&gt;
<a name="5152"/> 5152:                                    ?SEV_EPRINT(&quot;failed create socket:&quot;
<a name="5153"/> 5153:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5154"/> 5154:                                    ERROR
<a name="5155"/> 5155:                            end
<a name="5156"/> 5156:                    end},
<a name="5157"/> 5157:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5158"/> 5158:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5159"/> 5159:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="5160"/> 5160:                            ok
<a name="5161"/> 5161:                    end},
<a name="5162"/> 5162: 
<a name="5163"/> 5163:          %% *** The actual test ***
<a name="5164"/> 5164:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="5165"/> 5165:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5166"/> 5166:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5167"/> 5167:                    end},
<a name="5168"/> 5168:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="5169"/> 5169:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="5170"/> 5170:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="5171"/> 5171:                    end},
<a name="5172"/> 5172:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="5173"/> 5173:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5174"/> 5174:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5175"/> 5175:                            ok
<a name="5176"/> 5176:                    end},
<a name="5177"/> 5177:          #{desc =&gt; &quot;await recv reply 2 (from server)&quot;,
<a name="5178"/> 5178:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5179"/> 5179:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="5180"/> 5180:                            ok
<a name="5181"/> 5181:                    end},
<a name="5182"/> 5182:          #{desc =&gt; &quot;announce ready (recv reply 2)&quot;,
<a name="5183"/> 5183:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5184"/> 5184:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5185"/> 5185:                            ok
<a name="5186"/> 5186:                    end},
<a name="5187"/> 5187: 
<a name="5188"/> 5188:          %% *** Termination ***
<a name="5189"/> 5189:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5190"/> 5190:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5191"/> 5191:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5192"/> 5192:                                ok -&gt;
<a name="5193"/> 5193:                                    {ok, maps:remove(tester, State)};
<a name="5194"/> 5194:                                {error, _} = ERROR -&gt;
<a name="5195"/> 5195:                                    ERROR
<a name="5196"/> 5196:                            end
<a name="5197"/> 5197:                    end},
<a name="5198"/> 5198:          #{desc =&gt; &quot;close socket&quot;,
<a name="5199"/> 5199:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5200"/> 5200:                            ok = socket:close(Sock),
<a name="5201"/> 5201:                            {ok, maps:remove(sock, State)}
<a name="5202"/> 5202:                    end},
<a name="5203"/> 5203: 
<a name="5204"/> 5204:          %% *** We are done ***
<a name="5205"/> 5205:          ?SEV_FINISH_NORMAL
<a name="5206"/> 5206:         ],
<a name="5207"/> 5207: 
<a name="5208"/> 5208: 
<a name="5209"/> 5209:     TesterSeq =
<a name="5210"/> 5210:         [
<a name="5211"/> 5211:          %% *** Init part ***
<a name="5212"/> 5212:          #{desc =&gt; &quot;monitor server&quot;,
<a name="5213"/> 5213:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="5214"/> 5214:                            _MRef = erlang:monitor(process, Pid),
<a name="5215"/> 5215:                            ok
<a name="5216"/> 5216:                    end},
<a name="5217"/> 5217:          #{desc =&gt; &quot;monitor client 1&quot;,
<a name="5218"/> 5218:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="5219"/> 5219:                            _MRef = erlang:monitor(process, Pid),
<a name="5220"/> 5220:                            ok
<a name="5221"/> 5221:                    end},
<a name="5222"/> 5222:          #{desc =&gt; &quot;monitor client 2&quot;,
<a name="5223"/> 5223:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="5224"/> 5224:                            _MRef = erlang:monitor(process, Pid),
<a name="5225"/> 5225:                            ok
<a name="5226"/> 5226:                    end},
<a name="5227"/> 5227: 
<a name="5228"/> 5228:          %% Start the server
<a name="5229"/> 5229:          #{desc =&gt; &quot;order server start&quot;,
<a name="5230"/> 5230:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="5231"/> 5231:                            ?SEV_ANNOUNCE_START(Pid),
<a name="5232"/> 5232:                            ok
<a name="5233"/> 5233:                    end},
<a name="5234"/> 5234:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="5235"/> 5235:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="5236"/> 5236:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="5237"/> 5237:                            {ok, State#{server_port =&gt; Port}}
<a name="5238"/> 5238:                    end},
<a name="5239"/> 5239: 
<a name="5240"/> 5240:          %% Start the client 1
<a name="5241"/> 5241:          #{desc =&gt; &quot;order client 1 start&quot;,
<a name="5242"/> 5242:            cmd  =&gt; fun(#{client1 := Pid, server_port := Port} = _State) -&gt;
<a name="5243"/> 5243:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="5244"/> 5244:                            ok
<a name="5245"/> 5245:                    end},
<a name="5246"/> 5246:          #{desc =&gt; &quot;await client 1 ready (init)&quot;,
<a name="5247"/> 5247:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="5248"/> 5248:                            case ?SEV_AWAIT_READY(Pid, client1, init) of
<a name="5249"/> 5249:                                {ok, FD} -&gt;
<a name="5250"/> 5250:                                    {ok, State#{fd =&gt; FD}};
<a name="5251"/> 5251:                                {error, Reason} = ERROR -&gt;
<a name="5252"/> 5252:                                    ?SEV_EPRINT(&quot;Client 1 init error: &quot;
<a name="5253"/> 5253:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5254"/> 5254:                                    ERROR
<a name="5255"/> 5255:                            end
<a name="5256"/> 5256:                    end},
<a name="5257"/> 5257: 
<a name="5258"/> 5258:          ?SEV_SLEEP(?SECS(1)),
<a name="5259"/> 5259: 
<a name="5260"/> 5260:          %% Start the client 2
<a name="5261"/> 5261:          #{desc =&gt; &quot;order client 2 start&quot;,
<a name="5262"/> 5262:            cmd  =&gt; fun(#{client2     := Pid,
<a name="5263"/> 5263:                          server_port := Port,
<a name="5264"/> 5264:                          fd          := FD} = _State) -&gt;
<a name="5265"/> 5265:                            ?SEV_ANNOUNCE_START(Pid, {Port, FD}),
<a name="5266"/> 5266:                            ok
<a name="5267"/> 5267:                    end},
<a name="5268"/> 5268:          #{desc =&gt; &quot;await client 2 ready (init)&quot;,
<a name="5269"/> 5269:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="5270"/> 5270:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="5271"/> 5271:                    end},
<a name="5272"/> 5272: 
<a name="5273"/> 5273:          %% *** The actual test ***
<a name="5274"/> 5274: 
<a name="5275"/> 5275:          #{desc =&gt; &quot;order client 1 to continue (with send request 1)&quot;,
<a name="5276"/> 5276:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5277"/> 5277:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="5278"/> 5278:                            ok
<a name="5279"/> 5279:                    end},
<a name="5280"/> 5280:          #{desc =&gt; &quot;await client 1 ready (with send request 1)&quot;,
<a name="5281"/> 5281:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5282"/> 5282:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="5283"/> 5283:                    end},
<a name="5284"/> 5284:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="5285"/> 5285:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5286"/> 5286:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="5287"/> 5287:                    end},
<a name="5288"/> 5288:          #{desc =&gt; &quot;order server to continue (with send reply 1)&quot;,
<a name="5289"/> 5289:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5290"/> 5290:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="5291"/> 5291:                            ok
<a name="5292"/> 5292:                    end},
<a name="5293"/> 5293:          #{desc =&gt; &quot;await server ready (with reply 1 sent)&quot;,
<a name="5294"/> 5294:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5295"/> 5295:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="5296"/> 5296:                    end},
<a name="5297"/> 5297:          #{desc =&gt; &quot;await client 1 ready (reply recv 1)&quot;,
<a name="5298"/> 5298:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5299"/> 5299:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="5300"/> 5300:                    end},
<a name="5301"/> 5301: 
<a name="5302"/> 5302: 
<a name="5303"/> 5303:          #{desc =&gt; &quot;order client 2 to continue (with send request 2)&quot;,
<a name="5304"/> 5304:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="5305"/> 5305:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="5306"/> 5306:                            ok
<a name="5307"/> 5307:                    end},
<a name="5308"/> 5308:          #{desc =&gt; &quot;await client 2 ready (with send request 2)&quot;,
<a name="5309"/> 5309:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="5310"/> 5310:                            ?SEV_AWAIT_READY(Client, client2, send_req)
<a name="5311"/> 5311:                    end},
<a name="5312"/> 5312:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="5313"/> 5313:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5314"/> 5314:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="5315"/> 5315:                    end},
<a name="5316"/> 5316:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="5317"/> 5317:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5318"/> 5318:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="5319"/> 5319:                            ok
<a name="5320"/> 5320:                    end},
<a name="5321"/> 5321:          #{desc =&gt; &quot;await server ready (with reply 2 sent)&quot;,
<a name="5322"/> 5322:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5323"/> 5323:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="5324"/> 5324:                    end},
<a name="5325"/> 5325:          #{desc =&gt; &quot;await client 2 ready (reply recv 2)&quot;,
<a name="5326"/> 5326:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="5327"/> 5327:                            ?SEV_AWAIT_READY(Client, client2, recv_reply)
<a name="5328"/> 5328:                    end},
<a name="5329"/> 5329: 
<a name="5330"/> 5330: 
<a name="5331"/> 5331:          #{desc =&gt; &quot;order client 2 to terminate&quot;,
<a name="5332"/> 5332:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="5333"/> 5333:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="5334"/> 5334:                            ok
<a name="5335"/> 5335:                    end},
<a name="5336"/> 5336:          #{desc =&gt; &quot;await client 2 termination&quot;,
<a name="5337"/> 5337:            cmd  =&gt; fun(#{client2 := Client} = State) -&gt;
<a name="5338"/> 5338:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="5339"/> 5339:                            State1 = maps:remove(client2, State),
<a name="5340"/> 5340:                            {ok, State1}
<a name="5341"/> 5341:                    end},
<a name="5342"/> 5342: 
<a name="5343"/> 5343: 
<a name="5344"/> 5344:          #{desc =&gt; &quot;order client 1 to continue (with send request 3)&quot;,
<a name="5345"/> 5345:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5346"/> 5346:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="5347"/> 5347:                            ok
<a name="5348"/> 5348:                    end},
<a name="5349"/> 5349:          #{desc =&gt; &quot;await client 1 ready (with send request 3)&quot;,
<a name="5350"/> 5350:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5351"/> 5351:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="5352"/> 5352:                    end},
<a name="5353"/> 5353:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="5354"/> 5354:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5355"/> 5355:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="5356"/> 5356:                    end},
<a name="5357"/> 5357:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="5358"/> 5358:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5359"/> 5359:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="5360"/> 5360:                            ok
<a name="5361"/> 5361:                    end},
<a name="5362"/> 5362:          #{desc =&gt; &quot;await server ready (with reply 3 sent)&quot;,
<a name="5363"/> 5363:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5364"/> 5364:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="5365"/> 5365:                    end},
<a name="5366"/> 5366:          #{desc =&gt; &quot;await client 1 ready (reply recv 3)&quot;,
<a name="5367"/> 5367:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5368"/> 5368:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="5369"/> 5369:                    end},
<a name="5370"/> 5370: 
<a name="5371"/> 5371: 
<a name="5372"/> 5372:          %% *** Termination ***
<a name="5373"/> 5373:          #{desc =&gt; &quot;order client 1 to terminate&quot;,
<a name="5374"/> 5374:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="5375"/> 5375:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="5376"/> 5376:                            ok
<a name="5377"/> 5377:                    end},
<a name="5378"/> 5378:          #{desc =&gt; &quot;await client 1 termination&quot;,
<a name="5379"/> 5379:            cmd  =&gt; fun(#{client1 := Client} = State) -&gt;
<a name="5380"/> 5380:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="5381"/> 5381:                            State1 = maps:remove(client1, State),
<a name="5382"/> 5382:                            {ok, State1}
<a name="5383"/> 5383:                    end},
<a name="5384"/> 5384:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="5385"/> 5385:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="5386"/> 5386:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="5387"/> 5387:                            ok
<a name="5388"/> 5388:                    end},
<a name="5389"/> 5389:          #{desc =&gt; &quot;await server termination&quot;,
<a name="5390"/> 5390:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="5391"/> 5391:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="5392"/> 5392:                            State1 = maps:remove(server, State),
<a name="5393"/> 5393:                            {ok, State1}
<a name="5394"/> 5394:                    end},
<a name="5395"/> 5395: 
<a name="5396"/> 5396:          %% *** We are done ***
<a name="5397"/> 5397:          ?SEV_FINISH_NORMAL
<a name="5398"/> 5398:         ],
<a name="5399"/> 5399: 
<a name="5400"/> 5400:     i(&quot;start server evaluator&quot;),
<a name="5401"/> 5401:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, maps:remove(dup, InitState)),
<a name="5402"/> 5402: 
<a name="5403"/> 5403:     i(&quot;start (socket origin) client 1 evaluator&quot;),
<a name="5404"/> 5404:     Client1 = ?SEV_START(&quot;client-1&quot;, Client1Seq, maps:remove(dup, InitState)),
<a name="5405"/> 5405:     i(&quot;await evaluator(s)&quot;),
<a name="5406"/> 5406: 
<a name="5407"/> 5407:     i(&quot;start client 2 evaluator&quot;),
<a name="5408"/> 5408:     Client2 = ?SEV_START(&quot;client-2&quot;, Client2Seq, InitState),
<a name="5409"/> 5409:     i(&quot;await evaluator(s)&quot;),
<a name="5410"/> 5410: 
<a name="5411"/> 5411:     i(&quot;start tester evaluator&quot;),
<a name="5412"/> 5412:     TesterInitState = #{server  =&gt; Server#ev.pid,
<a name="5413"/> 5413:                         client1 =&gt; Client1#ev.pid,
<a name="5414"/> 5414:                         client2 =&gt; Client2#ev.pid},
<a name="5415"/> 5415:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="5416"/> 5416: 
<a name="api_ffd_open_and_open_and_send_udp2-last_expr"/><a name="5417"/> 5417: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client1, Client2, Tester]).
<a name="5418"/> 5418: 
<a name="5419"/> 5419: 
<a name="5420"/> 5420: 
<a name="5421"/> 5421: 
<a name="5422"/> 5422: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5423"/> 5423: 
<a name="5424"/> 5424: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="5425"/> 5425: <i>%% another socket (2) from its file descriptor *without* dup.</i>
<a name="5426"/> 5426: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5427"/> 5427: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5428"/> 5428: <i>%% has not been closed (test by sending some data).</i>
<a name="5429"/> 5429: <i>%% IPv4 TCP (stream) socket.</i>
<a name="5430"/> 5430: <i>%%</i>
<a name="5431"/> 5431: <i>%% &lt;WARNING&gt;</i>
<a name="5432"/> 5432: <i>%%</i>
<a name="5433"/> 5433: <i>%% This is *not* how its intended to be used.</i>
<a name="5434"/> 5434: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="5435"/> 5435: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="5436"/> 5436: <i>%% to test it!</i>
<a name="5437"/> 5437: <i>%%</i>
<a name="5438"/> 5438: <i>%% &lt;/WARNING&gt;</i>
<a name="5439"/> 5439: <i>%%</i>
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp4-1"/><a name="5440"/> 5440: <b>api_ffd_open_connect_and_open_wod_and_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5441"/> 5441:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp4-last_expr"/><a name="5442"/> 5442: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="5443"/> 5443:            fun() -&gt;
<a name="5444"/> 5444:                    has_support_ipv4()
<a name="5445"/> 5445:            end,
<a name="5446"/> 5446:            fun() -&gt;
<a name="5447"/> 5447:                    InitState = #{domain   =&gt; inet,
<a name="5448"/> 5448:                                  type     =&gt; stream,
<a name="5449"/> 5449:                                  protocol =&gt; tcp,
<a name="5450"/> 5450:                                  dup      =&gt; false},
<a name="5451"/> 5451:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="5452"/> 5452:            end).
<a name="5453"/> 5453: 
<a name="5454"/> 5454: 
<a name="5455"/> 5455: 
<a name="5456"/> 5456: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5457"/> 5457: 
<a name="5458"/> 5458: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="5459"/> 5459: <i>%% another socket (2) from its file descriptor *without* dup.</i>
<a name="5460"/> 5460: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5461"/> 5461: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5462"/> 5462: <i>%% has not been closed (test by sending some data).</i>
<a name="5463"/> 5463: <i>%% IPv6 TCP (stream) socket.</i>
<a name="5464"/> 5464: <i>%%</i>
<a name="5465"/> 5465: <i>%% &lt;WARNING&gt;</i>
<a name="5466"/> 5466: <i>%%</i>
<a name="5467"/> 5467: <i>%% This is *not* how its intended to be used.</i>
<a name="5468"/> 5468: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="5469"/> 5469: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="5470"/> 5470: <i>%% to test it!</i>
<a name="5471"/> 5471: <i>%%</i>
<a name="5472"/> 5472: <i>%% &lt;/WARNING&gt;</i>
<a name="5473"/> 5473: <i>%%</i>
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp6-1"/><a name="5474"/> 5474: <b>api_ffd_open_connect_and_open_wod_and_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5475"/> 5475:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp6-last_expr"/><a name="5476"/> 5476: <b>    tc_try</b>(api_ffd_open_connect_and_open_wod_and_send_tcp6,
<a name="5477"/> 5477:            fun() -&gt;
<a name="5478"/> 5478:                    has_support_ipv6()
<a name="5479"/> 5479:            end,
<a name="5480"/> 5480:            fun() -&gt;
<a name="5481"/> 5481:                    InitState = #{domain   =&gt; inet6,
<a name="5482"/> 5482:                                  type     =&gt; stream,
<a name="5483"/> 5483:                                  protocol =&gt; tcp,
<a name="5484"/> 5484:                                  dup      =&gt; false},
<a name="5485"/> 5485:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="5486"/> 5486:            end).
<a name="5487"/> 5487: 
<a name="5488"/> 5488: 
<a name="5489"/> 5489: 
<a name="5490"/> 5490: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5491"/> 5491: 
<a name="5492"/> 5492: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="5493"/> 5493: <i>%% another socket (2) from its file descriptor *with* dup.</i>
<a name="5494"/> 5494: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5495"/> 5495: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5496"/> 5496: <i>%% has not been closed (test by sending some data).</i>
<a name="5497"/> 5497: <i>%% IPv4 TCP (stream) socket.</i>
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp4-1"/><a name="5498"/> 5498: <b>api_ffd_open_connect_and_open_wd_and_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5499"/> 5499:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp4-last_expr"/><a name="5500"/> 5500: <b>    tc_try</b>(api_ffd_open_connect_and_open_wd_and_send_tcp4,
<a name="5501"/> 5501:            fun() -&gt;
<a name="5502"/> 5502:                    InitState = #{domain   =&gt; inet,
<a name="5503"/> 5503:                                  type     =&gt; stream,
<a name="5504"/> 5504:                                  protocol =&gt; tcp,
<a name="5505"/> 5505:                                  dup      =&gt; true},
<a name="5506"/> 5506:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="5507"/> 5507:            end).
<a name="5508"/> 5508: 
<a name="5509"/> 5509: 
<a name="5510"/> 5510: 
<a name="5511"/> 5511: 
<a name="5512"/> 5512: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5513"/> 5513: 
<a name="5514"/> 5514: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="5515"/> 5515: <i>%% another socket (2) from its file descriptor *with* dup.</i>
<a name="5516"/> 5516: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5517"/> 5517: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5518"/> 5518: <i>%% has not been closed (test by sending some data).</i>
<a name="5519"/> 5519: <i>%% IPv6 TCP (stream) socket.</i>
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp6-1"/><a name="5520"/> 5520: <b>api_ffd_open_connect_and_open_wd_and_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5521"/> 5521:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp6-last_expr"/><a name="5522"/> 5522: <b>    tc_try</b>(api_ffd_open_connect_and_open_wd_and_send_tcp6,
<a name="5523"/> 5523:            fun() -&gt; has_support_ipv6() end,
<a name="5524"/> 5524:            fun() -&gt;
<a name="5525"/> 5525:                    InitState = #{domain   =&gt; inet6,
<a name="5526"/> 5526:                                  type     =&gt; stream,
<a name="5527"/> 5527:                                  protocol =&gt; tcp,
<a name="5528"/> 5528:                                  dup      =&gt; true},
<a name="5529"/> 5529:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="5530"/> 5530:            end).
<a name="5531"/> 5531: 
<a name="5532"/> 5532: 
<a name="5533"/> 5533: 
<a name="5534"/> 5534: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5535"/> 5535: 
<a name="api_ffd_open_connect_and_open_and_send_tcp-1"/><a name="5536"/> 5536: <b>api_ffd_open_connect_and_open_and_send_tcp</b>(InitState) -&gt;
<a name="5537"/> 5537:     Send = fun(Sock, Data) -&gt;
<a name="5538"/> 5538:                    socket:send(Sock, Data)
<a name="5539"/> 5539:            end,
<a name="5540"/> 5540:     Recv = fun(Sock) -&gt;
<a name="5541"/> 5541:                    socket:recv(Sock)
<a name="5542"/> 5542:            end,
<a name="api_ffd_open_connect_and_open_and_send_tcp-last_expr"/><a name="5543"/> 5543: <b>    api_ffd_open_connect_and_open_and_send_tcp2</b>(InitState#{send   =&gt; Send,
<a name="5544"/> 5544:                                                            recv   =&gt; Recv}).
<a name="5545"/> 5545: 
<a name="api_ffd_open_connect_and_open_and_send_tcp2-1"/><a name="5546"/> 5546: <b>api_ffd_open_connect_and_open_and_send_tcp2</b>(InitState) -&gt;
<a name="5547"/> 5547:     process_flag(trap_exit, true),
<a name="5548"/> 5548:     ServerSeq = 
<a name="5549"/> 5549:         [
<a name="5550"/> 5550:          %% *** Wait for start order ***
<a name="5551"/> 5551:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5552"/> 5552:            cmd  =&gt; fun(State) -&gt;
<a name="5553"/> 5553:                            Tester = ?SEV_AWAIT_START(),
<a name="5554"/> 5554:                            {ok, State#{tester =&gt; Tester}}
<a name="5555"/> 5555:                    end},
<a name="5556"/> 5556:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5557"/> 5557:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5558"/> 5558:                            _MRef = erlang:monitor(process, Tester),
<a name="5559"/> 5559:                            ok
<a name="5560"/> 5560:                    end},
<a name="5561"/> 5561: 
<a name="5562"/> 5562:          %% *** Init part ***
<a name="5563"/> 5563:          #{desc =&gt; &quot;which local address&quot;,
<a name="5564"/> 5564:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="5565"/> 5565:                            LSA = which_local_socket_addr(Domain),
<a name="5566"/> 5566:                            {ok, State#{lsa =&gt; LSA}}
<a name="5567"/> 5567:                    end},
<a name="5568"/> 5568:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="5569"/> 5569:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5570"/> 5570:                          protocol := Proto} = State) -&gt;
<a name="5571"/> 5571:                            case socket:open(Domain, stream, Proto) of
<a name="5572"/> 5572:                                {ok, Sock} -&gt;
<a name="5573"/> 5573:                                    {ok, State#{lsock =&gt; Sock}};
<a name="5574"/> 5574:                                {error, _} = ERROR -&gt;
<a name="5575"/> 5575:                                    ERROR
<a name="5576"/> 5576:                            end
<a name="5577"/> 5577:                    end},
<a name="5578"/> 5578:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="5579"/> 5579:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="5580"/> 5580:                            case sock_bind(LSock, LSA) of
<a name="5581"/> 5581:                                ok -&gt;
<a name="5582"/> 5582:                                    Port = sock_port(LSock),
<a name="5583"/> 5583:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="5584"/> 5584:                                    {ok, State#{lport =&gt; Port}};
<a name="5585"/> 5585:                                {error, _} = ERROR -&gt;
<a name="5586"/> 5586:                                    ERROR
<a name="5587"/> 5587:                            end
<a name="5588"/> 5588:                    end},
<a name="5589"/> 5589:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="5590"/> 5590:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="5591"/> 5591:                            socket:listen(LSock)
<a name="5592"/> 5592:                    end},
<a name="5593"/> 5593:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5594"/> 5594:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="5595"/> 5595:                            %% This is actually not used for unix domain socket
<a name="5596"/> 5596:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="5597"/> 5597:                            ok
<a name="5598"/> 5598:                    end},
<a name="5599"/> 5599: 
<a name="5600"/> 5600:          %% The actual test
<a name="5601"/> 5601:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="5602"/> 5602:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5603"/> 5603:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="5604"/> 5604:                    end},
<a name="5605"/> 5605:          #{desc =&gt; &quot;await connection&quot;,
<a name="5606"/> 5606:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="5607"/> 5607:                            case socket:accept(LSock) of
<a name="5608"/> 5608:                                {ok, Sock} -&gt;
<a name="5609"/> 5609:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="5610"/> 5610:                                    {ok, State#{csock =&gt; Sock}};
<a name="5611"/> 5611:                                {error, _} = ERROR -&gt;
<a name="5612"/> 5612:                                    ERROR
<a name="5613"/> 5613:                            end
<a name="5614"/> 5614:                    end},
<a name="5615"/> 5615:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="5616"/> 5616:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5617"/> 5617:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="5618"/> 5618:                            ok
<a name="5619"/> 5619:                    end},
<a name="5620"/> 5620: 
<a name="5621"/> 5621:          #{desc =&gt; &quot;await request 1 (recv)&quot;,
<a name="5622"/> 5622:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="5623"/> 5623:                            case Recv(Sock) of
<a name="5624"/> 5624:                                {ok, ?BASIC_REQ} -&gt;
<a name="5625"/> 5625:                                    ok;
<a name="5626"/> 5626:                                {error, _} = ERROR -&gt;
<a name="5627"/> 5627:                                    ERROR
<a name="5628"/> 5628:                            end
<a name="5629"/> 5629:                    end},
<a name="5630"/> 5630:          #{desc =&gt; &quot;announce ready 1 (recv request)&quot;,
<a name="5631"/> 5631:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5632"/> 5632:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="5633"/> 5633:                            ok
<a name="5634"/> 5634:                    end},
<a name="5635"/> 5635:          #{desc =&gt; &quot;await continue 1 (with send reply)&quot;,
<a name="5636"/> 5636:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5637"/> 5637:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="5638"/> 5638:                    end},
<a name="5639"/> 5639:          #{desc =&gt; &quot;send reply 1&quot;,
<a name="5640"/> 5640:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="5641"/> 5641:                            Send(Sock, ?BASIC_REP)
<a name="5642"/> 5642:                    end},
<a name="5643"/> 5643:          #{desc =&gt; &quot;announce ready 1 (send reply)&quot;,
<a name="5644"/> 5644:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5645"/> 5645:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="5646"/> 5646:                            ok
<a name="5647"/> 5647:                    end},
<a name="5648"/> 5648: 
<a name="5649"/> 5649:          #{desc =&gt; &quot;await request 2 (recv)&quot;,
<a name="5650"/> 5650:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="5651"/> 5651:                            case Recv(Sock) of
<a name="5652"/> 5652:                                {ok, ?BASIC_REQ} -&gt;
<a name="5653"/> 5653:                                    ok;
<a name="5654"/> 5654:                                {error, _} = ERROR -&gt;
<a name="5655"/> 5655:                                    ERROR
<a name="5656"/> 5656:                            end
<a name="5657"/> 5657:                    end},
<a name="5658"/> 5658:          #{desc =&gt; &quot;announce ready 2 (recv request)&quot;,
<a name="5659"/> 5659:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5660"/> 5660:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="5661"/> 5661:                            ok
<a name="5662"/> 5662:                    end},
<a name="5663"/> 5663:          #{desc =&gt; &quot;await continue 2 (with send reply)&quot;,
<a name="5664"/> 5664:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5665"/> 5665:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="5666"/> 5666:                    end},
<a name="5667"/> 5667:          #{desc =&gt; &quot;send reply 2&quot;,
<a name="5668"/> 5668:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="5669"/> 5669:                            Send(Sock, ?BASIC_REP)
<a name="5670"/> 5670:                    end},
<a name="5671"/> 5671:          #{desc =&gt; &quot;announce ready 2 (send reply)&quot;,
<a name="5672"/> 5672:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5673"/> 5673:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="5674"/> 5674:                            ok
<a name="5675"/> 5675:                    end},
<a name="5676"/> 5676: 
<a name="5677"/> 5677:          #{desc =&gt; &quot;await request 3 (recv)&quot;,
<a name="5678"/> 5678:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="5679"/> 5679:                            case Recv(Sock) of
<a name="5680"/> 5680:                                {ok, ?BASIC_REQ} -&gt;
<a name="5681"/> 5681:                                    ok;
<a name="5682"/> 5682:                                {error, _} = ERROR -&gt;
<a name="5683"/> 5683:                                    ERROR
<a name="5684"/> 5684:                            end
<a name="5685"/> 5685:                    end},
<a name="5686"/> 5686:          #{desc =&gt; &quot;announce ready 3 (recv request)&quot;,
<a name="5687"/> 5687:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5688"/> 5688:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="5689"/> 5689:                            ok
<a name="5690"/> 5690:                    end},
<a name="5691"/> 5691:          #{desc =&gt; &quot;await continue 3 (with send reply)&quot;,
<a name="5692"/> 5692:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5693"/> 5693:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="5694"/> 5694:                    end},
<a name="5695"/> 5695:          #{desc =&gt; &quot;send reply 3&quot;,
<a name="5696"/> 5696:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="5697"/> 5697:                            Send(Sock, ?BASIC_REP)
<a name="5698"/> 5698:                    end},
<a name="5699"/> 5699:          #{desc =&gt; &quot;announce ready 3 (send reply)&quot;,
<a name="5700"/> 5700:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5701"/> 5701:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="5702"/> 5702:                            ok
<a name="5703"/> 5703:                    end},
<a name="5704"/> 5704: 
<a name="5705"/> 5705:          %% *** Termination ***
<a name="5706"/> 5706:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5707"/> 5707:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5708"/> 5708:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5709"/> 5709:                                ok -&gt;
<a name="5710"/> 5710:                                    {ok, maps:remove(tester, State)};
<a name="5711"/> 5711:                                {error, _} = ERROR -&gt;
<a name="5712"/> 5712:                                    ERROR
<a name="5713"/> 5713:                            end
<a name="5714"/> 5714:                    end},
<a name="5715"/> 5715:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="5716"/> 5716:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="5717"/> 5717:                            ok = socket:close(Sock),
<a name="5718"/> 5718:                            {ok, maps:remove(csock, State)}
<a name="5719"/> 5719:                    end},
<a name="5720"/> 5720:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="5721"/> 5721:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="5722"/> 5722:                            case socket:close(LSock) of
<a name="5723"/> 5723:                                ok -&gt;
<a name="5724"/> 5724:                                    {ok, maps:remove(lsock, State)};
<a name="5725"/> 5725:                                {error, _} = ERROR -&gt;
<a name="5726"/> 5726:                                    ERROR
<a name="5727"/> 5727:                            end
<a name="5728"/> 5728:                    end},
<a name="5729"/> 5729: 
<a name="5730"/> 5730:          %% *** We are done ***
<a name="5731"/> 5731:          ?SEV_FINISH_NORMAL
<a name="5732"/> 5732:         ],
<a name="5733"/> 5733: 
<a name="5734"/> 5734: 
<a name="5735"/> 5735:     Client1Seq =
<a name="5736"/> 5736:         [
<a name="5737"/> 5737:          %% *** Wait for start order ***
<a name="5738"/> 5738:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5739"/> 5739:            cmd  =&gt; fun(State) -&gt;
<a name="5740"/> 5740:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="5741"/> 5741:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="5742"/> 5742:                    end},
<a name="5743"/> 5743:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5744"/> 5744:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5745"/> 5745:                            _MRef = erlang:monitor(process, Tester),
<a name="5746"/> 5746:                            ok
<a name="5747"/> 5747:                    end},
<a name="5748"/> 5748: 
<a name="5749"/> 5749:          %% *** The init part ***
<a name="5750"/> 5750:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="5751"/> 5751:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="5752"/> 5752:                            LSA = which_local_socket_addr(Domain),
<a name="5753"/> 5753:                            SSA = LSA#{port =&gt; Port},
<a name="5754"/> 5754:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="5755"/> 5755:                    end},
<a name="5756"/> 5756:          #{desc =&gt; &quot;create socket&quot;,
<a name="5757"/> 5757:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5758"/> 5758:                          protocol := Proto} = State) -&gt;
<a name="5759"/> 5759:                            case socket:open(Domain, stream, Proto) of
<a name="5760"/> 5760:                                {ok, Sock} -&gt;
<a name="5761"/> 5761:                                    {ok, State#{sock =&gt; Sock}};
<a name="5762"/> 5762:                                {error, _} = ERROR -&gt;
<a name="5763"/> 5763:                                    ERROR
<a name="5764"/> 5764:                            end
<a name="5765"/> 5765:                    end},
<a name="5766"/> 5766:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="5767"/> 5767:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="5768"/> 5768:                            case sock_bind(Sock, LSA) of
<a name="5769"/> 5769:                                ok -&gt;
<a name="5770"/> 5770:                                    ok;
<a name="5771"/> 5771:                                {error, _} = ERROR -&gt;
<a name="5772"/> 5772:                                    ERROR
<a name="5773"/> 5773:                            end
<a name="5774"/> 5774:                    end},
<a name="5775"/> 5775:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5776"/> 5776:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5777"/> 5777:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="5778"/> 5778:                            ok
<a name="5779"/> 5779:                    end},
<a name="5780"/> 5780: 
<a name="5781"/> 5781: 
<a name="5782"/> 5782:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="5783"/> 5783:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5784"/> 5784:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="5785"/> 5785:                    end},
<a name="5786"/> 5786:          #{desc =&gt; &quot;connect to server&quot;,
<a name="5787"/> 5787:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="5788"/> 5788:                            socket:connect(Sock, SSA)
<a name="5789"/> 5789:                    end},
<a name="5790"/> 5790:          #{desc =&gt; &quot;get socket FD&quot;,
<a name="5791"/> 5791:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5792"/> 5792:                            case socket:getopt(Sock, otp, fd) of
<a name="5793"/> 5793:                                {ok, FD} -&gt;
<a name="5794"/> 5794:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="5795"/> 5795:                                    {ok, State#{fd =&gt; FD}};
<a name="5796"/> 5796:                                {error, Reason} = ERROR -&gt;
<a name="5797"/> 5797:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="5798"/> 5798:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5799"/> 5799:                                    ERROR
<a name="5800"/> 5800:                            end
<a name="5801"/> 5801:                    end},
<a name="5802"/> 5802:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="5803"/> 5803:            cmd  =&gt; fun(#{tester := Tester,
<a name="5804"/> 5804:                          fd     := FD}) -&gt;
<a name="5805"/> 5805:                            ?SEV_ANNOUNCE_READY(Tester, connect, FD),
<a name="5806"/> 5806:                            ok
<a name="5807"/> 5807:                    end},
<a name="5808"/> 5808: 
<a name="5809"/> 5809: 
<a name="5810"/> 5810:          %% *** The actual test ***
<a name="5811"/> 5811:          #{desc =&gt; &quot;await continue (send request 1)&quot;,
<a name="5812"/> 5812:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5813"/> 5813:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5814"/> 5814:                    end},
<a name="5815"/> 5815:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="5816"/> 5816:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="5817"/> 5817:                            Send(Sock, ?BASIC_REQ)
<a name="5818"/> 5818:                    end},
<a name="5819"/> 5819:          #{desc =&gt; &quot;announce ready (send request 1)&quot;,
<a name="5820"/> 5820:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5821"/> 5821:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5822"/> 5822:                            ok
<a name="5823"/> 5823:                    end},
<a name="5824"/> 5824:          #{desc =&gt; &quot;await recv reply 1 (from server)&quot;,
<a name="5825"/> 5825:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5826"/> 5826:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="5827"/> 5827:                            ok
<a name="5828"/> 5828:                    end},
<a name="5829"/> 5829:          #{desc =&gt; &quot;announce ready (recv reply 1)&quot;,
<a name="5830"/> 5830:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5831"/> 5831:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5832"/> 5832:                            ok
<a name="5833"/> 5833:                    end},
<a name="5834"/> 5834: 
<a name="5835"/> 5835:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="5836"/> 5836:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5837"/> 5837:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5838"/> 5838:                    end},
<a name="5839"/> 5839:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="5840"/> 5840:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="5841"/> 5841:                            Send(Sock, ?BASIC_REQ)
<a name="5842"/> 5842:                    end},
<a name="5843"/> 5843:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="5844"/> 5844:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5845"/> 5845:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5846"/> 5846:                            ok
<a name="5847"/> 5847:                    end},
<a name="5848"/> 5848:          #{desc =&gt; &quot;await recv reply 3 (from server)&quot;,
<a name="5849"/> 5849:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5850"/> 5850:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="5851"/> 5851:                            ok
<a name="5852"/> 5852:                    end},
<a name="5853"/> 5853:          #{desc =&gt; &quot;announce ready (recv reply 3)&quot;,
<a name="5854"/> 5854:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5855"/> 5855:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5856"/> 5856:                            ok
<a name="5857"/> 5857:                    end},
<a name="5858"/> 5858: 
<a name="5859"/> 5859:          %% *** Termination ***
<a name="5860"/> 5860:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5861"/> 5861:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5862"/> 5862:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5863"/> 5863:                                ok -&gt;
<a name="5864"/> 5864:                                    {ok, maps:remove(tester, State)};
<a name="5865"/> 5865:                                {error, _} = ERROR -&gt;
<a name="5866"/> 5866:                                    ERROR
<a name="5867"/> 5867:                            end
<a name="5868"/> 5868:                    end},
<a name="5869"/> 5869:          #{desc =&gt; &quot;close socket&quot;,
<a name="5870"/> 5870:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5871"/> 5871:                            ok = socket:close(Sock),
<a name="5872"/> 5872:                            {ok, maps:remove(sock, State)}
<a name="5873"/> 5873:                    end},
<a name="5874"/> 5874: 
<a name="5875"/> 5875:          %% *** We are done ***
<a name="5876"/> 5876:          ?SEV_FINISH_NORMAL
<a name="5877"/> 5877:         ],
<a name="5878"/> 5878: 
<a name="5879"/> 5879: 
<a name="5880"/> 5880:     Client2Seq =
<a name="5881"/> 5881:         [
<a name="5882"/> 5882:          %% *** Wait for start order ***
<a name="5883"/> 5883:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5884"/> 5884:            cmd  =&gt; fun(State) -&gt;
<a name="5885"/> 5885:                            {Tester, FD} = ?SEV_AWAIT_START(),
<a name="5886"/> 5886:                            {ok, State#{tester =&gt; Tester, fd =&gt; FD}}
<a name="5887"/> 5887:                    end},
<a name="5888"/> 5888:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5889"/> 5889:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5890"/> 5890:                            _MRef = erlang:monitor(process, Tester),
<a name="5891"/> 5891:                            ok
<a name="5892"/> 5892:                    end},
<a name="5893"/> 5893: 
<a name="5894"/> 5894:          %% *** The init part ***
<a name="5895"/> 5895:          #{desc =&gt; &quot;create socket&quot;,
<a name="5896"/> 5896:            cmd  =&gt; fun(#{fd     := FD,
<a name="5897"/> 5897:                          dup    := DUP,
<a name="5898"/> 5898:                          domain := Domain} = State) -&gt;
<a name="5899"/> 5899:                            ?SEV_IPRINT(&quot;try create socket with: &quot;
<a name="5900"/> 5900:                                        &quot;~n   FD:     ~p&quot;
<a name="5901"/> 5901:                                        &quot;~n   DUP:    ~p&quot;
<a name="5902"/> 5902:                                        &quot;~n   Domain: ~p&quot;, [FD, DUP, Domain]),
<a name="5903"/> 5903:                            case socket:open(FD, #{dup    =&gt; DUP,
<a name="5904"/> 5904:                                                   domain =&gt; Domain}) of
<a name="5905"/> 5905:                                {ok, Sock} -&gt;
<a name="5906"/> 5906:                                    {ok, State#{sock =&gt; Sock}};
<a name="5907"/> 5907:                                {error,
<a name="5908"/> 5908:                                 {invalid,{options,domain,#{dup := DUP}}} = R} -&gt;
<a name="5909"/> 5909:                                    ?SEV_EPRINT(&quot;failed create socket:&quot;
<a name="5910"/> 5910:                                                &quot;~n   ~p&quot;, [R]),
<a name="5911"/> 5911:                                    {skip, domain};
<a name="5912"/> 5912:                                {error, Reason} = ERROR -&gt;
<a name="5913"/> 5913:                                    ?SEV_EPRINT(&quot;failed create socket:&quot;
<a name="5914"/> 5914:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5915"/> 5915:                                    ERROR
<a name="5916"/> 5916:                            end
<a name="5917"/> 5917:                    end},
<a name="5918"/> 5918:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5919"/> 5919:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5920"/> 5920:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="5921"/> 5921:                            ok
<a name="5922"/> 5922:                    end},
<a name="5923"/> 5923: 
<a name="5924"/> 5924:          %% *** The actual test ***
<a name="5925"/> 5925:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="5926"/> 5926:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="5927"/> 5927:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="5928"/> 5928:                    end},
<a name="5929"/> 5929:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="5930"/> 5930:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="5931"/> 5931:                            Send(Sock, ?BASIC_REQ)
<a name="5932"/> 5932:                    end},
<a name="5933"/> 5933:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="5934"/> 5934:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5935"/> 5935:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="5936"/> 5936:                            ok
<a name="5937"/> 5937:                    end},
<a name="5938"/> 5938:          #{desc =&gt; &quot;await recv reply 2 (from server)&quot;,
<a name="5939"/> 5939:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="5940"/> 5940:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="5941"/> 5941:                            ok
<a name="5942"/> 5942:                    end},
<a name="5943"/> 5943:          #{desc =&gt; &quot;announce ready (recv reply 2)&quot;,
<a name="5944"/> 5944:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5945"/> 5945:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="5946"/> 5946:                            ok
<a name="5947"/> 5947:                    end},
<a name="5948"/> 5948: 
<a name="5949"/> 5949:          %% *** Termination ***
<a name="5950"/> 5950:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5951"/> 5951:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5952"/> 5952:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5953"/> 5953:                                ok -&gt;
<a name="5954"/> 5954:                                    {ok, maps:remove(tester, State)};
<a name="5955"/> 5955:                                {error, _} = ERROR -&gt;
<a name="5956"/> 5956:                                    ERROR
<a name="5957"/> 5957:                            end
<a name="5958"/> 5958:                    end},
<a name="5959"/> 5959:          #{desc =&gt; &quot;close socket&quot;,
<a name="5960"/> 5960:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5961"/> 5961:                            ok = socket:close(Sock),
<a name="5962"/> 5962:                            {ok, maps:remove(sock, State)}
<a name="5963"/> 5963:                    end},
<a name="5964"/> 5964: 
<a name="5965"/> 5965:          %% *** We are done ***
<a name="5966"/> 5966:          ?SEV_FINISH_NORMAL
<a name="5967"/> 5967:         ],
<a name="5968"/> 5968: 
<a name="5969"/> 5969: 
<a name="5970"/> 5970:     TesterSeq =
<a name="5971"/> 5971:         [
<a name="5972"/> 5972:          %% *** Init part ***
<a name="5973"/> 5973:          #{desc =&gt; &quot;monitor server&quot;,
<a name="5974"/> 5974:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="5975"/> 5975:                            _MRef = erlang:monitor(process, Pid),
<a name="5976"/> 5976:                            ok
<a name="5977"/> 5977:                    end},
<a name="5978"/> 5978:          #{desc =&gt; &quot;monitor client 1&quot;,
<a name="5979"/> 5979:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="5980"/> 5980:                            _MRef = erlang:monitor(process, Pid),
<a name="5981"/> 5981:                            ok
<a name="5982"/> 5982:                    end},
<a name="5983"/> 5983:          #{desc =&gt; &quot;monitor client 2&quot;,
<a name="5984"/> 5984:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="5985"/> 5985:                            _MRef = erlang:monitor(process, Pid),
<a name="5986"/> 5986:                            ok
<a name="5987"/> 5987:                    end},
<a name="5988"/> 5988: 
<a name="5989"/> 5989:          %% Start the server
<a name="5990"/> 5990:          #{desc =&gt; &quot;order server start&quot;,
<a name="5991"/> 5991:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="5992"/> 5992:                            ?SEV_ANNOUNCE_START(Pid),
<a name="5993"/> 5993:                            ok
<a name="5994"/> 5994:                    end},
<a name="5995"/> 5995:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="5996"/> 5996:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="5997"/> 5997:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="5998"/> 5998:                            {ok, State#{server_port =&gt; Port}}
<a name="5999"/> 5999:                    end},
<a name="6000"/> 6000: 
<a name="6001"/> 6001:          %% Start the client 1
<a name="6002"/> 6002:          #{desc =&gt; &quot;order client 1 start&quot;,
<a name="6003"/> 6003:            cmd  =&gt; fun(#{client1 := Pid, server_port := Port} = _State) -&gt;
<a name="6004"/> 6004:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="6005"/> 6005:                            ok
<a name="6006"/> 6006:                    end},
<a name="6007"/> 6007:          #{desc =&gt; &quot;await client 1 ready (init)&quot;,
<a name="6008"/> 6008:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="6009"/> 6009:                            ok = ?SEV_AWAIT_READY(Pid, client1, init)
<a name="6010"/> 6010:                    end},
<a name="6011"/> 6011: 
<a name="6012"/> 6012:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="6013"/> 6013:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6014"/> 6014:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="6015"/> 6015:                            ok
<a name="6016"/> 6016:                    end},
<a name="6017"/> 6017:          ?SEV_SLEEP(?SECS(1)),
<a name="6018"/> 6018:          #{desc =&gt; &quot;order client 1 to continue (with connect)&quot;,
<a name="6019"/> 6019:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6020"/> 6020:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="6021"/> 6021:                            ok
<a name="6022"/> 6022:                    end},
<a name="6023"/> 6023:          #{desc =&gt; &quot;await client 1 ready (connect)&quot;,
<a name="6024"/> 6024:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="6025"/> 6025:                            {ok, FD} = ?SEV_AWAIT_READY(Pid, client1, connect),
<a name="6026"/> 6026:                            {ok, State#{fd =&gt; FD}}
<a name="6027"/> 6027:                    end},
<a name="6028"/> 6028:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="6029"/> 6029:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6030"/> 6030:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="6031"/> 6031:                    end},         
<a name="6032"/> 6032: 
<a name="6033"/> 6033:          %% Start the client 2
<a name="6034"/> 6034:          #{desc =&gt; &quot;order client 2 start&quot;,
<a name="6035"/> 6035:            cmd  =&gt; fun(#{client2 := Pid, fd := FD} = _State) -&gt;
<a name="6036"/> 6036:                            ?SEV_ANNOUNCE_START(Pid, FD),
<a name="6037"/> 6037:                            ok
<a name="6038"/> 6038:                    end},
<a name="6039"/> 6039:          #{desc =&gt; &quot;await client 2 ready (init)&quot;,
<a name="6040"/> 6040:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="6041"/> 6041:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="6042"/> 6042:                    end},
<a name="6043"/> 6043: 
<a name="6044"/> 6044:          %% *** The actual test ***
<a name="6045"/> 6045: 
<a name="6046"/> 6046:          #{desc =&gt; &quot;order client 1 to continue (with send request 1)&quot;,
<a name="6047"/> 6047:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6048"/> 6048:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6049"/> 6049:                            ok
<a name="6050"/> 6050:                    end},
<a name="6051"/> 6051:          #{desc =&gt; &quot;await client 1 ready (with send request 1)&quot;,
<a name="6052"/> 6052:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6053"/> 6053:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="6054"/> 6054:                    end},
<a name="6055"/> 6055:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="6056"/> 6056:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6057"/> 6057:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6058"/> 6058:                    end},
<a name="6059"/> 6059:          #{desc =&gt; &quot;order server to continue (with send reply 1)&quot;,
<a name="6060"/> 6060:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6061"/> 6061:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6062"/> 6062:                            ok
<a name="6063"/> 6063:                    end},
<a name="6064"/> 6064:          #{desc =&gt; &quot;await server ready (with reply 1 sent)&quot;,
<a name="6065"/> 6065:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6066"/> 6066:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6067"/> 6067:                    end},
<a name="6068"/> 6068:          #{desc =&gt; &quot;await client 1 ready (reply recv 1)&quot;,
<a name="6069"/> 6069:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6070"/> 6070:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="6071"/> 6071:                    end},
<a name="6072"/> 6072: 
<a name="6073"/> 6073: 
<a name="6074"/> 6074:          #{desc =&gt; &quot;order client 2 to continue (with send request 2)&quot;,
<a name="6075"/> 6075:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6076"/> 6076:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6077"/> 6077:                            ok
<a name="6078"/> 6078:                    end},
<a name="6079"/> 6079:          #{desc =&gt; &quot;await client 2 ready (with send request 2)&quot;,
<a name="6080"/> 6080:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6081"/> 6081:                            ?SEV_AWAIT_READY(Client, client2, send_req)
<a name="6082"/> 6082:                    end},
<a name="6083"/> 6083:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="6084"/> 6084:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6085"/> 6085:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6086"/> 6086:                    end},
<a name="6087"/> 6087:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="6088"/> 6088:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6089"/> 6089:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6090"/> 6090:                            ok
<a name="6091"/> 6091:                    end},
<a name="6092"/> 6092:          #{desc =&gt; &quot;await server ready (with reply 2 sent)&quot;,
<a name="6093"/> 6093:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6094"/> 6094:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6095"/> 6095:                    end},
<a name="6096"/> 6096:          #{desc =&gt; &quot;await client 2 ready (reply recv 2)&quot;,
<a name="6097"/> 6097:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6098"/> 6098:                            ?SEV_AWAIT_READY(Client, client2, recv_reply)
<a name="6099"/> 6099:                    end},
<a name="6100"/> 6100: 
<a name="6101"/> 6101: 
<a name="6102"/> 6102:          #{desc =&gt; &quot;order client 2 to terminate&quot;,
<a name="6103"/> 6103:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6104"/> 6104:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="6105"/> 6105:                            ok
<a name="6106"/> 6106:                    end},
<a name="6107"/> 6107:          #{desc =&gt; &quot;await client 2 termination&quot;,
<a name="6108"/> 6108:            cmd  =&gt; fun(#{client2 := Client} = State) -&gt;
<a name="6109"/> 6109:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="6110"/> 6110:                            State1 = maps:remove(client2, State),
<a name="6111"/> 6111:                            {ok, State1}
<a name="6112"/> 6112:                    end},
<a name="6113"/> 6113: 
<a name="6114"/> 6114: 
<a name="6115"/> 6115:          #{desc =&gt; &quot;order client 1 to continue (with send request 3)&quot;,
<a name="6116"/> 6116:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6117"/> 6117:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6118"/> 6118:                            ok
<a name="6119"/> 6119:                    end},
<a name="6120"/> 6120:          #{desc =&gt; &quot;await client 1 ready (with send request 3)&quot;,
<a name="6121"/> 6121:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6122"/> 6122:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="6123"/> 6123:                    end},
<a name="6124"/> 6124:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="6125"/> 6125:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6126"/> 6126:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6127"/> 6127:                    end},
<a name="6128"/> 6128:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="6129"/> 6129:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6130"/> 6130:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6131"/> 6131:                            ok
<a name="6132"/> 6132:                    end},
<a name="6133"/> 6133:          #{desc =&gt; &quot;await server ready (with reply 3 sent)&quot;,
<a name="6134"/> 6134:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6135"/> 6135:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6136"/> 6136:                    end},
<a name="6137"/> 6137:          #{desc =&gt; &quot;await client 1 ready (reply recv 3)&quot;,
<a name="6138"/> 6138:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6139"/> 6139:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="6140"/> 6140:                    end},
<a name="6141"/> 6141: 
<a name="6142"/> 6142: 
<a name="6143"/> 6143:          %% *** Termination ***
<a name="6144"/> 6144:          #{desc =&gt; &quot;order client 1 to terminate&quot;,
<a name="6145"/> 6145:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6146"/> 6146:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="6147"/> 6147:                            ok
<a name="6148"/> 6148:                    end},
<a name="6149"/> 6149:          #{desc =&gt; &quot;await client 1 termination&quot;,
<a name="6150"/> 6150:            cmd  =&gt; fun(#{client1 := Client} = State) -&gt;
<a name="6151"/> 6151:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="6152"/> 6152:                            State1 = maps:remove(client1, State),
<a name="6153"/> 6153:                            {ok, State1}
<a name="6154"/> 6154:                    end},
<a name="6155"/> 6155:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="6156"/> 6156:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6157"/> 6157:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="6158"/> 6158:                            ok
<a name="6159"/> 6159:                    end},
<a name="6160"/> 6160:          #{desc =&gt; &quot;await server termination&quot;,
<a name="6161"/> 6161:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="6162"/> 6162:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="6163"/> 6163:                            State1 = maps:remove(server, State),
<a name="6164"/> 6164:                            {ok, State1}
<a name="6165"/> 6165:                    end},
<a name="6166"/> 6166: 
<a name="6167"/> 6167:          %% *** We are done ***
<a name="6168"/> 6168:          ?SEV_FINISH_NORMAL
<a name="6169"/> 6169:         ],
<a name="6170"/> 6170: 
<a name="6171"/> 6171:     i(&quot;start server evaluator&quot;),
<a name="6172"/> 6172:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, maps:remove(dup, InitState)),
<a name="6173"/> 6173: 
<a name="6174"/> 6174:     i(&quot;start (socket origin) client 1 evaluator&quot;),
<a name="6175"/> 6175:     Client1 = ?SEV_START(&quot;client-1&quot;, Client1Seq, maps:remove(dup, InitState)),
<a name="6176"/> 6176:     i(&quot;await evaluator(s)&quot;),
<a name="6177"/> 6177: 
<a name="6178"/> 6178:     i(&quot;start client 2 evaluator&quot;),
<a name="6179"/> 6179:     Client2 = ?SEV_START(&quot;client-2&quot;, Client2Seq, InitState),
<a name="6180"/> 6180:     i(&quot;await evaluator(s)&quot;),
<a name="6181"/> 6181: 
<a name="6182"/> 6182:     i(&quot;start tester evaluator&quot;),
<a name="6183"/> 6183:     TesterInitState = #{server  =&gt; Server#ev.pid,
<a name="6184"/> 6184:                         client1 =&gt; Client1#ev.pid,
<a name="6185"/> 6185:                         client2 =&gt; Client2#ev.pid},
<a name="6186"/> 6186:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="6187"/> 6187: 
<a name="api_ffd_open_connect_and_open_and_send_tcp2-last_expr"/><a name="6188"/> 6188: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client1, Client2, Tester]).
<a name="6189"/> 6189: 
<a name="6190"/> 6190: 
<a name="6191"/> 6191: 
<a name="6192"/> 6192: 
<a name="6193"/> 6193: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6194"/> 6194: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6195"/> 6195: <i>%%                                                                     %%</i>
<a name="6196"/> 6196: <i>%%                           API ASYNC                                 %%</i>
<a name="6197"/> 6197: <i>%%                                                                     %%</i>
<a name="6198"/> 6198: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6199"/> 6199: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6200"/> 6200: 
<a name="6201"/> 6201: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6202"/> 6202: 
<a name="6203"/> 6203: <i>%% Basically establish a TCP connection via an async connect. IPv4.</i>
<a name="api_a_connect_tcp4-1"/><a name="6204"/> 6204: <b>api_a_connect_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="6205"/> 6205:     ?TT(?SECS(10)),
<a name="api_a_connect_tcp4-last_expr"/><a name="6206"/> 6206: <b>    tc_try</b>(api_a_connect_tcp4,
<a name="6207"/> 6207:            fun() -&gt; has_support_ipv4() end,
<a name="6208"/> 6208:            fun() -&gt;
<a name="6209"/> 6209:                    ok = api_a_connect_tcpD(inet, nowait(Config))
<a name="6210"/> 6210:            end).
<a name="6211"/> 6211: 
<a name="6212"/> 6212: 
<a name="6213"/> 6213: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6214"/> 6214: 
<a name="6215"/> 6215: <i>%% Basically establish a TCP connection via an async connect. IPv6.</i>
<a name="api_a_connect_tcp6-1"/><a name="6216"/> 6216: <b>api_a_connect_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="6217"/> 6217:     ?TT(?SECS(10)),
<a name="api_a_connect_tcp6-last_expr"/><a name="6218"/> 6218: <b>    tc_try</b>(api_a_connect_tcp6,
<a name="6219"/> 6219:            fun() -&gt; has_support_ipv6() end,
<a name="6220"/> 6220:            fun() -&gt;
<a name="6221"/> 6221:                    ok = api_a_connect_tcpD(inet6, nowait(Config))
<a name="6222"/> 6222:            end).
<a name="6223"/> 6223: 
<a name="6224"/> 6224: 
<a name="6225"/> 6225: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6226"/> 6226: 
<a name="api_a_connect_tcpD-2"/><a name="6227"/> 6227: <b>api_a_connect_tcpD</b>(Domain, Nowait) -&gt;
<a name="6228"/> 6228:     Connect = fun(Sock, SockAddr) -&gt;
<a name="6229"/> 6229:                       socket:connect(Sock, SockAddr, Nowait)
<a name="6230"/> 6230:               end,
<a name="6231"/> 6231:     Send = fun(Sock, Data) -&gt;
<a name="6232"/> 6232:                    socket:send(Sock, Data)
<a name="6233"/> 6233:            end,
<a name="6234"/> 6234:     Recv = fun(Sock) -&gt;
<a name="6235"/> 6235:                    socket:recv(Sock)
<a name="6236"/> 6236:            end,
<a name="6237"/> 6237:     InitState = #{domain =&gt; Domain,
<a name="6238"/> 6238:                   connect =&gt; Connect,
<a name="6239"/> 6239:                   send =&gt; Send,
<a name="6240"/> 6240:                   recv =&gt; Recv,
<a name="6241"/> 6241:                   connect_ref =&gt; Nowait},
<a name="api_a_connect_tcpD-last_expr"/><a name="6242"/> 6242: <b>    api_a_connect_tcp</b>(InitState).
<a name="6243"/> 6243: 
<a name="6244"/> 6244: 
<a name="6245"/> 6245: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6246"/> 6246: 
<a name="api_a_connect_tcp-1"/><a name="6247"/> 6247: <b>api_a_connect_tcp</b>(InitState) -&gt;
<a name="6248"/> 6248:     process_flag(trap_exit, true),
<a name="6249"/> 6249:     ServerSeq = 
<a name="6250"/> 6250:         [
<a name="6251"/> 6251:          %% *** Wait for start order ***
<a name="6252"/> 6252:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6253"/> 6253:            cmd  =&gt; fun(State) -&gt;
<a name="6254"/> 6254:                            Tester = ?SEV_AWAIT_START(),
<a name="6255"/> 6255:                            {ok, State#{tester =&gt; Tester}}
<a name="6256"/> 6256:                    end},
<a name="6257"/> 6257:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6258"/> 6258:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6259"/> 6259:                            _MRef = erlang:monitor(process, Tester),
<a name="6260"/> 6260:                            ok
<a name="6261"/> 6261:                    end},
<a name="6262"/> 6262: 
<a name="6263"/> 6263:          %% *** Init part ***
<a name="6264"/> 6264:          #{desc =&gt; &quot;which local address&quot;,
<a name="6265"/> 6265:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6266"/> 6266:                            LSA = which_local_socket_addr(Domain),
<a name="6267"/> 6267:                            {ok, State#{lsa =&gt; LSA}}
<a name="6268"/> 6268:                    end},
<a name="6269"/> 6269:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="6270"/> 6270:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6271"/> 6271:                            case socket:open(Domain, stream, tcp) of
<a name="6272"/> 6272:                                {ok, Sock} -&gt;
<a name="6273"/> 6273:                                    {ok, State#{lsock =&gt; Sock}};
<a name="6274"/> 6274:                                {error, _} = ERROR -&gt;
<a name="6275"/> 6275:                                    ERROR
<a name="6276"/> 6276:                            end
<a name="6277"/> 6277:                    end},
<a name="6278"/> 6278:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="6279"/> 6279:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="6280"/> 6280:                            case sock_bind(LSock, LSA) of
<a name="6281"/> 6281:                                ok -&gt;
<a name="6282"/> 6282:                                    Port = sock_port(LSock),
<a name="6283"/> 6283:                                    {ok, State#{lport =&gt; Port}};
<a name="6284"/> 6284:                                {error, _} = ERROR -&gt;
<a name="6285"/> 6285:                                    ERROR
<a name="6286"/> 6286:                            end
<a name="6287"/> 6287:                    end},
<a name="6288"/> 6288:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="6289"/> 6289:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="6290"/> 6290:                            socket:listen(LSock)
<a name="6291"/> 6291:                    end},
<a name="6292"/> 6292:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6293"/> 6293:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="6294"/> 6294:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="6295"/> 6295:                            ok
<a name="6296"/> 6296:                    end},
<a name="6297"/> 6297: 
<a name="6298"/> 6298:          %% The actual test
<a name="6299"/> 6299:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="6300"/> 6300:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6301"/> 6301:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="6302"/> 6302:                    end},
<a name="6303"/> 6303:          #{desc =&gt; &quot;await connection&quot;,
<a name="6304"/> 6304:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="6305"/> 6305:                            case socket:accept(LSock) of
<a name="6306"/> 6306:                                {ok, Sock} -&gt;
<a name="6307"/> 6307:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="6308"/> 6308:                                    {ok, State#{csock =&gt; Sock}};
<a name="6309"/> 6309:                                {error, _} = ERROR -&gt;
<a name="6310"/> 6310:                                    ERROR
<a name="6311"/> 6311:                            end
<a name="6312"/> 6312:                    end},
<a name="6313"/> 6313:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="6314"/> 6314:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6315"/> 6315:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="6316"/> 6316:                            ok
<a name="6317"/> 6317:                    end},
<a name="6318"/> 6318: 
<a name="6319"/> 6319:          #{desc =&gt; &quot;await continue (recv_req)&quot;,
<a name="6320"/> 6320:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6321"/> 6321:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_req)
<a name="6322"/> 6322:                    end},
<a name="6323"/> 6323:          #{desc =&gt; &quot;recv req&quot;,
<a name="6324"/> 6324:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="6325"/> 6325:                            case Recv(Sock) of
<a name="6326"/> 6326:                                {ok, ?BASIC_REQ} -&gt;
<a name="6327"/> 6327:                                    ok;
<a name="6328"/> 6328:                                {ok, UnexpData} -&gt;
<a name="6329"/> 6329:                                    {error, {unexpected_data, UnexpData}};
<a name="6330"/> 6330:                                {error, _} = ERROR -&gt;
<a name="6331"/> 6331:                                    %% At the moment there is no way to get
<a name="6332"/> 6332:                                    %% status or state for the socket...
<a name="6333"/> 6333:                                    ERROR
<a name="6334"/> 6334:                            end
<a name="6335"/> 6335:                    end},
<a name="6336"/> 6336:          #{desc =&gt; &quot;announce ready (recv_req)&quot;,
<a name="6337"/> 6337:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6338"/> 6338:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="6339"/> 6339:                            ok
<a name="6340"/> 6340:                    end},
<a name="6341"/> 6341:          #{desc =&gt; &quot;await continue (send_rep)&quot;,
<a name="6342"/> 6342:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6343"/> 6343:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_rep)
<a name="6344"/> 6344:                    end},
<a name="6345"/> 6345:          #{desc =&gt; &quot;send rep&quot;,
<a name="6346"/> 6346:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="6347"/> 6347:                            Send(Sock, ?BASIC_REP)
<a name="6348"/> 6348:                    end},
<a name="6349"/> 6349:          #{desc =&gt; &quot;announce ready (send_rep)&quot;,
<a name="6350"/> 6350:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6351"/> 6351:                            ?SEV_ANNOUNCE_READY(Tester, send_rep),
<a name="6352"/> 6352:                            ok
<a name="6353"/> 6353:                    end},
<a name="6354"/> 6354: 	 
<a name="6355"/> 6355: 
<a name="6356"/> 6356:          %% *** Termination ***
<a name="6357"/> 6357:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6358"/> 6358:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6359"/> 6359:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6360"/> 6360:                                ok -&gt;
<a name="6361"/> 6361:                                    {ok, maps:remove(tester, State)};
<a name="6362"/> 6362:                                {error, _} = ERROR -&gt;
<a name="6363"/> 6363:                                    ERROR
<a name="6364"/> 6364:                            end
<a name="6365"/> 6365:                    end},
<a name="6366"/> 6366:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="6367"/> 6367:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="6368"/> 6368:                            ok = socket:close(Sock),
<a name="6369"/> 6369:                            {ok, maps:remove(csock, State)}
<a name="6370"/> 6370:                    end},
<a name="6371"/> 6371:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="6372"/> 6372:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="6373"/> 6373:                            ok = socket:close(Sock),
<a name="6374"/> 6374:                            {ok, maps:remove(lsock, State)}
<a name="6375"/> 6375:                    end},
<a name="6376"/> 6376: 
<a name="6377"/> 6377:          %% *** We are done ***
<a name="6378"/> 6378:          ?SEV_FINISH_NORMAL
<a name="6379"/> 6379:         ],
<a name="6380"/> 6380: 
<a name="6381"/> 6381:     ClientSeq = 
<a name="6382"/> 6382:         [
<a name="6383"/> 6383:          %% *** Wait for start order ***
<a name="6384"/> 6384:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6385"/> 6385:            cmd  =&gt; fun(State) -&gt;
<a name="6386"/> 6386:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="6387"/> 6387:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="6388"/> 6388:                    end},
<a name="6389"/> 6389:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6390"/> 6390:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6391"/> 6391:                            _MRef = erlang:monitor(process, Tester),
<a name="6392"/> 6392:                            ok
<a name="6393"/> 6393:                    end},
<a name="6394"/> 6394: 
<a name="6395"/> 6395:          %% *** The init part ***
<a name="6396"/> 6396:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="6397"/> 6397:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="6398"/> 6398:                            LSA = which_local_socket_addr(Domain),
<a name="6399"/> 6399:                            SSA = LSA#{port =&gt; Port},
<a name="6400"/> 6400:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="6401"/> 6401:                    end},
<a name="6402"/> 6402:          #{desc =&gt; &quot;create socket&quot;,
<a name="6403"/> 6403:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6404"/> 6404:                            case socket:open(Domain, stream, tcp) of
<a name="6405"/> 6405:                                {ok, Sock} -&gt;
<a name="6406"/> 6406:                                    {ok, State#{sock =&gt; Sock}};
<a name="6407"/> 6407:                                {error, _} = ERROR -&gt;
<a name="6408"/> 6408:                                    ERROR
<a name="6409"/> 6409:                            end
<a name="6410"/> 6410:                    end},
<a name="6411"/> 6411:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="6412"/> 6412:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="6413"/> 6413:                            case sock_bind(Sock, LSA) of
<a name="6414"/> 6414:                                ok -&gt;
<a name="6415"/> 6415:                                    ok;
<a name="6416"/> 6416:                                {error, _} = ERROR -&gt;
<a name="6417"/> 6417:                                    ERROR
<a name="6418"/> 6418:                            end
<a name="6419"/> 6419:                    end},
<a name="6420"/> 6420:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6421"/> 6421:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6422"/> 6422:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="6423"/> 6423:                            ok
<a name="6424"/> 6424:                    end},
<a name="6425"/> 6425: 
<a name="6426"/> 6426:          %% *** The actual test ***
<a name="6427"/> 6427:          #{desc =&gt; &quot;await continue (async connect)&quot;,
<a name="6428"/> 6428:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6429"/> 6429:                            ?SEV_AWAIT_CONTINUE(Tester, tester, async_connect)
<a name="6430"/> 6430:                    end},
<a name="6431"/> 6431:          #{desc =&gt; &quot;connect (async) to server&quot;,
<a name="6432"/> 6432:            cmd  =&gt; fun(#{sock        := Sock,
<a name="6433"/> 6433:                          server_sa   := SSA,
<a name="6434"/> 6434:                          connect     := Connect,
<a name="6435"/> 6435:                          connect_ref := SR} = State) -&gt;
<a name="6436"/> 6436:                            case Connect(Sock, SSA) of
<a name="6437"/> 6437:                                ok -&gt;
<a name="6438"/> 6438:                                    ?SEV_IPRINT(&quot;ok -&gt; &quot;
<a name="6439"/> 6439: 					       &quot;unexpected success =&gt; SKIP&quot;, 
<a name="6440"/> 6440:                                                []),
<a name="6441"/> 6441:                                    {skip, unexpected_success};
<a name="6442"/> 6442: 
<a name="6443"/> 6443:                                {select, {select_info, ST, SelectRef}}
<a name="6444"/> 6444:                                  when SR =:= nowait -&gt;
<a name="6445"/> 6445:                                    ?SEV_IPRINT(&quot;select nowait -&gt;&quot;
<a name="6446"/> 6446:                                                &quot;~n   tag: ~p&quot;
<a name="6447"/> 6447:                                                &quot;~n   ref: ~p&quot;,
<a name="6448"/> 6448:                                                [ST, SelectRef]),
<a name="6449"/> 6449:                                    {ok, State#{asynch_tag  =&gt; select,
<a name="6450"/> 6450:                                                connect_tag =&gt; ST,
<a name="6451"/> 6451:                                                connect_ref =&gt; SelectRef}};
<a name="6452"/> 6452:                                {select, {select_info, ST, SR}}
<a name="6453"/> 6453:                                  when is_reference(SR) -&gt;
<a name="6454"/> 6454:                                    ?SEV_IPRINT(&quot;select ref -&gt;&quot;
<a name="6455"/> 6455:                                                &quot;~n   tag: ~p&quot;
<a name="6456"/> 6456:                                                &quot;~n   ref: ~p&quot;, [ST, SR]),
<a name="6457"/> 6457:                                    {ok, State#{asynch_tag  =&gt; select,
<a name="6458"/> 6458:                                                connect_tag =&gt; ST}};
<a name="6459"/> 6459: 
<a name="6460"/> 6460:                                {completion,
<a name="6461"/> 6461:                                 {completion_info, CT, CompletionRef}}
<a name="6462"/> 6462:                                  when SR =:= nowait -&gt;
<a name="6463"/> 6463:                                    ?SEV_IPRINT(&quot;completion nowait -&gt;&quot;
<a name="6464"/> 6464:                                                &quot;~n   tag: ~p&quot;
<a name="6465"/> 6465:                                                &quot;~n   ref: ~p&quot;,
<a name="6466"/> 6466:                                                [CT, CompletionRef]),
<a name="6467"/> 6467:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="6468"/> 6468:                                                connect_tag =&gt; CT,
<a name="6469"/> 6469:                                                connect_ref =&gt; CompletionRef}};
<a name="6470"/> 6470:                                {completion,
<a name="6471"/> 6471:                                 {completion_info, CT, CR}}
<a name="6472"/> 6472:                                  when is_reference(CR) -&gt;
<a name="6473"/> 6473:                                    ?SEV_IPRINT(&quot;completion ref -&gt;&quot;
<a name="6474"/> 6474:                                                &quot;~n   tag: ~p&quot;
<a name="6475"/> 6475:                                                &quot;~n   ref: ~p&quot;, [CT, CR]),
<a name="6476"/> 6476:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="6477"/> 6477:                                                connect_tag =&gt; CT}};
<a name="6478"/> 6478: 
<a name="6479"/> 6479:                                {error, _} = ERROR -&gt;
<a name="6480"/> 6480:                                    ERROR
<a name="6481"/> 6481:                            end
<a name="6482"/> 6482:                    end},
<a name="6483"/> 6483:          #{desc =&gt; &quot;announce ready (connect select|completion)&quot;,
<a name="6484"/> 6484:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6485"/> 6485:                            ?SEV_ANNOUNCE_READY(Tester, connect_select),
<a name="6486"/> 6486:                            ok
<a name="6487"/> 6487:                    end},
<a name="6488"/> 6488:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="6489"/> 6489:            cmd  =&gt; fun(#{sock        := Sock,
<a name="6490"/> 6490:                          asynch_tag  := select,
<a name="6491"/> 6491:                          connect_tag := connect,
<a name="6492"/> 6492:                          connect_ref := Ref}) -&gt;
<a name="6493"/> 6493:                            receive
<a name="6494"/> 6494:                                {'$socket', Sock, select, Ref} -&gt;
<a name="6495"/> 6495:                                    ?SEV_IPRINT(&quot;select message -&gt;&quot;
<a name="6496"/> 6496:                                                &quot;~n   ref: ~p&quot;, [Ref]),
<a name="6497"/> 6497:                                    ok
<a name="6498"/> 6498:                            after 5000 -&gt;
<a name="6499"/> 6499:                                    ?SEV_EPRINT(&quot;timeout: &quot;
<a name="6500"/> 6500:                                                &quot;~n   message queue: ~p&quot;,
<a name="6501"/> 6501:                                                [?MQ()]),
<a name="6502"/> 6502:                                    {error, timeout}
<a name="6503"/> 6503:                            end;
<a name="6504"/> 6504:                       (#{sock        := Sock,
<a name="6505"/> 6505:                          asynch_tag  := completion,
<a name="6506"/> 6506:                          connect_tag := connect,
<a name="6507"/> 6507:                          connect_ref := Ref}) -&gt;
<a name="6508"/> 6508:                            receive
<a name="6509"/> 6509:                                {'$socket', Sock, completion, {Ref, ok = Res}} -&gt;
<a name="6510"/> 6510:                                    ?SEV_IPRINT(&quot;completion message -&gt;&quot;
<a name="6511"/> 6511:                                                &quot;~n   ref: ~p&quot;
<a name="6512"/> 6512:                                                &quot;~n   res: ~p&quot;, [Ref, Res]),
<a name="6513"/> 6513:                                    ok
<a name="6514"/> 6514:                            after 5000 -&gt;
<a name="6515"/> 6515:                                    ?SEV_EPRINT(&quot;timeout: &quot;
<a name="6516"/> 6516:                                                &quot;~n   message queue: ~p&quot;,
<a name="6517"/> 6517:                                                [?MQ()]),
<a name="6518"/> 6518:                                    {error, timeout}
<a name="6519"/> 6519:                            end
<a name="6520"/> 6520:                    end},
<a name="6521"/> 6521:          #{desc =&gt; &quot;announce ready (select|completion)&quot;,
<a name="6522"/> 6522:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6523"/> 6523:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="6524"/> 6524:                            ok
<a name="6525"/> 6525:                    end},
<a name="6526"/> 6526:          #{desc =&gt; &quot;(maybe) connect (async) to server&quot;,
<a name="6527"/> 6527:            cmd  =&gt; fun(#{sock        := Sock,
<a name="6528"/> 6528:                          server_sa   := SSA,
<a name="6529"/> 6529:                          asynch_tag  := select,
<a name="6530"/> 6530:                          connect_tag := connect,
<a name="6531"/> 6531:                          connect     := Connect}) -&gt;
<a name="6532"/> 6532:                            case Connect(Sock, SSA) of
<a name="6533"/> 6533:                                ok -&gt;
<a name="6534"/> 6534:                                    ok;
<a name="6535"/> 6535:                                {select, SelectInfo} -&gt;
<a name="6536"/> 6536:                                    {error, {unexpected_select, SelectInfo}};
<a name="6537"/> 6537:                                {error, _} = ERROR -&gt;
<a name="6538"/> 6538:                                    ERROR
<a name="6539"/> 6539:                            end;
<a name="6540"/> 6540:                       (#{sock        := _Sock,
<a name="6541"/> 6541:                          server_sa   := _SSA,
<a name="6542"/> 6542:                          asynch_tag  := completion,
<a name="6543"/> 6543:                          connect_tag := connect,
<a name="6544"/> 6544:                          connect     := _Connect}) -&gt;
<a name="6545"/> 6545:                            ok
<a name="6546"/> 6546:                    end},
<a name="6547"/> 6547:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="6548"/> 6548:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6549"/> 6549:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="6550"/> 6550:                            ok
<a name="6551"/> 6551:                    end},
<a name="6552"/> 6552:          #{desc =&gt; &quot;get peername&quot;,
<a name="6553"/> 6553:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="6554"/> 6554:                            case socket:peername(Sock) of
<a name="6555"/> 6555:                                {ok, SockAddr} -&gt;
<a name="6556"/> 6556:                                    ?SEV_IPRINT(&quot;Peer Name: ~p&quot;, [SockAddr]),
<a name="6557"/> 6557:                                    ok;
<a name="6558"/> 6558:                                 {error, _} = ERROR -&gt;
<a name="6559"/> 6559:                                    ERROR
<a name="6560"/> 6560:                            end
<a name="6561"/> 6561:                    end},
<a name="6562"/> 6562: 
<a name="6563"/> 6563:          #{desc =&gt; &quot;await continue (send_req)&quot;,
<a name="6564"/> 6564:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6565"/> 6565:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="6566"/> 6566:                    end},
<a name="6567"/> 6567:          #{desc =&gt; &quot;send req&quot;,
<a name="6568"/> 6568:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="6569"/> 6569:                            Send(Sock, ?BASIC_REQ)
<a name="6570"/> 6570:                    end},
<a name="6571"/> 6571:          #{desc =&gt; &quot;announce ready (send_req)&quot;,
<a name="6572"/> 6572:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6573"/> 6573:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="6574"/> 6574:                            ok
<a name="6575"/> 6575:                    end},
<a name="6576"/> 6576:          #{desc =&gt; &quot;await continue (recv_rep)&quot;,
<a name="6577"/> 6577:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6578"/> 6578:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_rep)
<a name="6579"/> 6579:                    end},
<a name="6580"/> 6580:          #{desc =&gt; &quot;recv rep&quot;,
<a name="6581"/> 6581:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="6582"/> 6582:                            case Recv(Sock) of
<a name="6583"/> 6583:                                {ok, ?BASIC_REP} -&gt;
<a name="6584"/> 6584:                                    ok;
<a name="6585"/> 6585:                                {ok, UnexpData} -&gt;
<a name="6586"/> 6586:                                    {error, {unexpected_data, UnexpData}};
<a name="6587"/> 6587:                                {error, _} = ERROR -&gt;
<a name="6588"/> 6588:                                    %% At the moment there is no way to get
<a name="6589"/> 6589:                                    %% status or state for the socket...
<a name="6590"/> 6590:                                    ERROR
<a name="6591"/> 6591:                            end
<a name="6592"/> 6592:                    end},
<a name="6593"/> 6593:          #{desc =&gt; &quot;announce ready (recv_rep)&quot;,
<a name="6594"/> 6594:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6595"/> 6595:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="6596"/> 6596:                            ok
<a name="6597"/> 6597:                    end},
<a name="6598"/> 6598: 
<a name="6599"/> 6599:          %% *** Termination ***
<a name="6600"/> 6600:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6601"/> 6601:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6602"/> 6602:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6603"/> 6603:                                ok -&gt;
<a name="6604"/> 6604:                                    {ok, maps:remove(tester, State)};
<a name="6605"/> 6605:                                {error, _} = ERROR -&gt;
<a name="6606"/> 6606:                                    ERROR
<a name="6607"/> 6607:                            end
<a name="6608"/> 6608:                    end},
<a name="6609"/> 6609:          #{desc =&gt; &quot;close socket&quot;,
<a name="6610"/> 6610:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6611"/> 6611:                            ok = socket:close(Sock),
<a name="6612"/> 6612:                            State2 = maps:remove(sock,         State),
<a name="6613"/> 6613:                            State3 = maps:remove(connect_stag, State2),
<a name="6614"/> 6614:                            State4 = maps:remove(connect_sref, State3),
<a name="6615"/> 6615:                            {ok, State4}
<a name="6616"/> 6616:                    end},
<a name="6617"/> 6617: 
<a name="6618"/> 6618:          %% *** We are done ***
<a name="6619"/> 6619:          ?SEV_FINISH_NORMAL
<a name="6620"/> 6620:         ],
<a name="6621"/> 6621: 
<a name="6622"/> 6622:     TesterSeq =
<a name="6623"/> 6623:         [
<a name="6624"/> 6624:          %% *** Init part ***
<a name="6625"/> 6625:          #{desc =&gt; &quot;monitor server&quot;,
<a name="6626"/> 6626:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="6627"/> 6627:                            _MRef = erlang:monitor(process, Pid),
<a name="6628"/> 6628:                            ok
<a name="6629"/> 6629:                    end},
<a name="6630"/> 6630:          #{desc =&gt; &quot;monitor client&quot;,
<a name="6631"/> 6631:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="6632"/> 6632:                            _MRef = erlang:monitor(process, Pid),
<a name="6633"/> 6633:                            ok
<a name="6634"/> 6634:                    end},
<a name="6635"/> 6635: 
<a name="6636"/> 6636:          %% Start the server
<a name="6637"/> 6637:          #{desc =&gt; &quot;order server start&quot;,
<a name="6638"/> 6638:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="6639"/> 6639:                            ?SEV_ANNOUNCE_START(Pid),
<a name="6640"/> 6640:                            ok
<a name="6641"/> 6641:                    end},
<a name="6642"/> 6642:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="6643"/> 6643:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="6644"/> 6644:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="6645"/> 6645:                            {ok, State#{server_port =&gt; Port}}
<a name="6646"/> 6646:                    end},
<a name="6647"/> 6647: 
<a name="6648"/> 6648:          %% Start the client
<a name="6649"/> 6649:          #{desc =&gt; &quot;order client start&quot;,
<a name="6650"/> 6650:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="6651"/> 6651:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="6652"/> 6652:                            ok
<a name="6653"/> 6653:                    end},
<a name="6654"/> 6654:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="6655"/> 6655:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="6656"/> 6656:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="6657"/> 6657:                    end},
<a name="6658"/> 6658: 
<a name="6659"/> 6659: 
<a name="6660"/> 6660:          %% *** The actual test ***
<a name="6661"/> 6661:          #{desc =&gt; &quot;order client to continue (async connect)&quot;,
<a name="6662"/> 6662:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6663"/> 6663:                            ?SEV_ANNOUNCE_CONTINUE(Client, async_connect),
<a name="6664"/> 6664:                            ok
<a name="6665"/> 6665:                    end},
<a name="6666"/> 6666:          #{desc =&gt; &quot;await client ready (connect select)&quot;,
<a name="6667"/> 6667:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6668"/> 6668:                            ?SEV_AWAIT_READY(Client, client, connect_select)
<a name="6669"/> 6669:                    end},
<a name="6670"/> 6670: 
<a name="6671"/> 6671:          ?SEV_SLEEP(?SECS(1)),
<a name="6672"/> 6672: 
<a name="6673"/> 6673:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="6674"/> 6674:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6675"/> 6675:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="6676"/> 6676:                            ok
<a name="6677"/> 6677:                    end},
<a name="6678"/> 6678:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="6679"/> 6679:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6680"/> 6680:                            ?SEV_AWAIT_READY(Client, client, select)
<a name="6681"/> 6681:                    end},
<a name="6682"/> 6682:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="6683"/> 6683:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6684"/> 6684:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="6685"/> 6685:                    end},
<a name="6686"/> 6686:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="6687"/> 6687:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6688"/> 6688:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="6689"/> 6689:                    end},
<a name="6690"/> 6690: 
<a name="6691"/> 6691:          ?SEV_SLEEP(?SECS(1)),
<a name="6692"/> 6692: 
<a name="6693"/> 6693:          #{desc =&gt; &quot;order server to recv test req (recv req)&quot;,
<a name="6694"/> 6694:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6695"/> 6695:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv_req),
<a name="6696"/> 6696:                            ok
<a name="6697"/> 6697:                    end},
<a name="6698"/> 6698:          #{desc =&gt; &quot;order client to send test req (send req)&quot;,
<a name="6699"/> 6699:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6700"/> 6700:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6701"/> 6701:                            ok
<a name="6702"/> 6702:                    end},
<a name="6703"/> 6703:          #{desc =&gt; &quot;await client ready (send_req)&quot;,
<a name="6704"/> 6704:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6705"/> 6705:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="6706"/> 6706:                    end},
<a name="6707"/> 6707:          #{desc =&gt; &quot;await server ready (recv_req)&quot;,
<a name="6708"/> 6708:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6709"/> 6709:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6710"/> 6710:                    end},
<a name="6711"/> 6711:          #{desc =&gt; &quot;order client to recv test rep (send rep)&quot;,
<a name="6712"/> 6712:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6713"/> 6713:                            ?SEV_ANNOUNCE_CONTINUE(Client, recv_rep),
<a name="6714"/> 6714:                            ok
<a name="6715"/> 6715:                    end},
<a name="6716"/> 6716:          #{desc =&gt; &quot;order server to send test rep (send rep)&quot;,
<a name="6717"/> 6717:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6718"/> 6718:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_rep),
<a name="6719"/> 6719:                            ok
<a name="6720"/> 6720:                    end},
<a name="6721"/> 6721:          #{desc =&gt; &quot;await server ready (send_rep)&quot;,
<a name="6722"/> 6722:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6723"/> 6723:                            ?SEV_AWAIT_READY(Server, server, send_rep)
<a name="6724"/> 6724:                    end},
<a name="6725"/> 6725:          #{desc =&gt; &quot;await client ready (recv_rep)&quot;,
<a name="6726"/> 6726:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6727"/> 6727:                            ?SEV_AWAIT_READY(Client, client, recv_rep)
<a name="6728"/> 6728:                    end},
<a name="6729"/> 6729: 
<a name="6730"/> 6730: 
<a name="6731"/> 6731:          %% *** Termination ***
<a name="6732"/> 6732:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="6733"/> 6733:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="6734"/> 6734:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="6735"/> 6735:                            ok
<a name="6736"/> 6736:                    end},
<a name="6737"/> 6737:          #{desc =&gt; &quot;await client termination&quot;,
<a name="6738"/> 6738:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="6739"/> 6739:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="6740"/> 6740:                            State1 = maps:remove(client, State),
<a name="6741"/> 6741:                            {ok, State1}
<a name="6742"/> 6742:                    end},
<a name="6743"/> 6743:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="6744"/> 6744:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6745"/> 6745:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="6746"/> 6746:                            ok
<a name="6747"/> 6747:                    end},
<a name="6748"/> 6748:          #{desc =&gt; &quot;await server termination&quot;,
<a name="6749"/> 6749:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="6750"/> 6750:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="6751"/> 6751:                            State1 = maps:remove(server, State),
<a name="6752"/> 6752:                            {ok, State1}
<a name="6753"/> 6753:                    end},
<a name="6754"/> 6754: 
<a name="6755"/> 6755:          %% *** We are done ***
<a name="6756"/> 6756:          ?SEV_FINISH_NORMAL
<a name="6757"/> 6757:         ],
<a name="6758"/> 6758: 
<a name="6759"/> 6759:     i(&quot;start server evaluator&quot;),
<a name="6760"/> 6760:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="6761"/> 6761: 
<a name="6762"/> 6762:     i(&quot;start client evaluator&quot;),
<a name="6763"/> 6763:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="6764"/> 6764:     i(&quot;await evaluator(s)&quot;),
<a name="6765"/> 6765: 
<a name="6766"/> 6766:     i(&quot;start tester evaluator&quot;),
<a name="6767"/> 6767:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="6768"/> 6768:                         client =&gt; Client#ev.pid},
<a name="6769"/> 6769:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="6770"/> 6770: 
<a name="api_a_connect_tcp-last_expr"/><a name="6771"/> 6771: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="6772"/> 6772: 
<a name="6773"/> 6773: 
<a name="6774"/> 6774: 
<a name="6775"/> 6775: 
<a name="6776"/> 6776: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6777"/> 6777: 
<a name="6778"/> 6778: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="6779"/> 6779: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="6780"/> 6780: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="6781"/> 6781: <i>%% select message). Note that we only do this for the recvfrom,</i>
<a name="6782"/> 6782: <i>%% since its much more difficult to &quot;arrange&quot; for sendto.</i>
<a name="6783"/> 6783: <i>%%</i>
<a name="api_a_sendto_and_recvfrom_udp4-1"/><a name="6784"/> 6784: <b>api_a_sendto_and_recvfrom_udp4</b>(Config) when is_list(Config) -&gt;
<a name="6785"/> 6785:     ?TT(?SECS(5)),
<a name="6786"/> 6786:     Nowait = nowait(Config),
<a name="api_a_sendto_and_recvfrom_udp4-last_expr"/><a name="6787"/> 6787: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="6788"/> 6788:            fun() -&gt; has_support_ipv4() end,
<a name="6789"/> 6789:            fun() -&gt;
<a name="6790"/> 6790:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="6791"/> 6791:                                   socket:sendto(Sock, Data, Dest)
<a name="6792"/> 6792:                           end,
<a name="6793"/> 6793:                    Recv = fun(Sock) -&gt;
<a name="6794"/> 6794:                                   socket:recvfrom(Sock, 0, Nowait)
<a name="6795"/> 6795:                           end,
<a name="6796"/> 6796:                    InitState = #{domain   =&gt; inet,
<a name="6797"/> 6797:                                  send     =&gt; Send,
<a name="6798"/> 6798:                                  recv     =&gt; Recv,
<a name="6799"/> 6799:                                  recv_ref =&gt; Nowait},
<a name="6800"/> 6800:                    ok = api_a_send_and_recv_udp(InitState)
<a name="6801"/> 6801:            end).
<a name="6802"/> 6802: 
<a name="6803"/> 6803: 
<a name="6804"/> 6804: 
<a name="6805"/> 6805: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6806"/> 6806: 
<a name="6807"/> 6807: <i>%% Basically send and receive on an IPv6 UDP (dgram) socket using</i>
<a name="6808"/> 6808: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="6809"/> 6809: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="6810"/> 6810: <i>%% select message). Note that we only do this for the recvfrom,</i>
<a name="6811"/> 6811: <i>%% since its much more difficult to &quot;arrange&quot; for sendto.</i>
<a name="6812"/> 6812: <i>%%</i>
<a name="api_a_sendto_and_recvfrom_udp6-1"/><a name="6813"/> 6813: <b>api_a_sendto_and_recvfrom_udp6</b>(Config) when is_list(Config) -&gt;
<a name="6814"/> 6814:     ?TT(?SECS(5)),
<a name="6815"/> 6815:     Nowait = nowait(Config),
<a name="api_a_sendto_and_recvfrom_udp6-last_expr"/><a name="6816"/> 6816: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="6817"/> 6817:            fun() -&gt; has_support_ipv6() end,
<a name="6818"/> 6818:            fun() -&gt;
<a name="6819"/> 6819:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="6820"/> 6820:                                   socket:sendto(Sock, Data, Dest)
<a name="6821"/> 6821:                           end,
<a name="6822"/> 6822:                    Recv = fun(Sock) -&gt;
<a name="6823"/> 6823:                                   socket:recvfrom(Sock, 0, Nowait)
<a name="6824"/> 6824:                           end,
<a name="6825"/> 6825:                    InitState = #{domain   =&gt; inet6,
<a name="6826"/> 6826:                                  send     =&gt; Send,
<a name="6827"/> 6827:                                  recv     =&gt; Recv,
<a name="6828"/> 6828:                                  recv_ref =&gt; Nowait},
<a name="6829"/> 6829:                    ok = api_a_send_and_recv_udp(InitState)
<a name="6830"/> 6830:            end).
<a name="6831"/> 6831: 
<a name="6832"/> 6832: 
<a name="6833"/> 6833: 
<a name="6834"/> 6834: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6835"/> 6835: 
<a name="6836"/> 6836: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="6837"/> 6837: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="6838"/> 6838: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="6839"/> 6839: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="6840"/> 6840: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="6841"/> 6841: <i>%%</i>
<a name="api_a_sendmsg_and_recvmsg_udp4-1"/><a name="6842"/> 6842: <b>api_a_sendmsg_and_recvmsg_udp4</b>(Config) when is_list(Config) -&gt;
<a name="6843"/> 6843:     ?TT(?SECS(5)),
<a name="6844"/> 6844:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_udp4-last_expr"/><a name="6845"/> 6845: <b>    tc_try</b>(api_a_sendmsg_and_recvmsg_udp4,
<a name="6846"/> 6846:            fun() -&gt; has_support_ipv4() end,
<a name="6847"/> 6847:            fun() -&gt;
<a name="6848"/> 6848:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="6849"/> 6849:                                   Msg = #{addr =&gt; Dest,
<a name="6850"/> 6850:                                              %% ctrl =&gt; CMsgs,
<a name="6851"/> 6851:                                              iov  =&gt; [Data]},
<a name="6852"/> 6852:                                   socket:sendmsg(Sock, Msg)
<a name="6853"/> 6853:                           end,
<a name="6854"/> 6854:                    Recv = fun(Sock) -&gt;
<a name="6855"/> 6855:                                   case socket:recvmsg(Sock, Nowait) of
<a name="6856"/> 6856:                                       {ok, #{addr  := Source,
<a name="6857"/> 6857:                                              iov   := [Data]}} -&gt;
<a name="6858"/> 6858:                                           {ok, {Source, Data}};
<a name="6859"/> 6859:                                       {ok, _} = OK -&gt;
<a name="6860"/> 6860:                                           OK;
<a name="6861"/> 6861:                                       {select, _} = SELECT -&gt;
<a name="6862"/> 6862:                                           SELECT;
<a name="6863"/> 6863:                                       {completion, _} = COMPLETION -&gt;
<a name="6864"/> 6864:                                           COMPLETION;
<a name="6865"/> 6865:                                       {error, _} = ERROR -&gt;
<a name="6866"/> 6866:                                           ERROR
<a name="6867"/> 6867:                                   end
<a name="6868"/> 6868:                           end,
<a name="6869"/> 6869:                    InitState = #{domain   =&gt; inet,
<a name="6870"/> 6870:                                  send     =&gt; Send,
<a name="6871"/> 6871:                                  recv     =&gt; Recv,
<a name="6872"/> 6872:                                  recv_ref =&gt; Nowait},
<a name="6873"/> 6873:                    ok = api_a_send_and_recv_udp(InitState)
<a name="6874"/> 6874:            end).
<a name="6875"/> 6875: 
<a name="6876"/> 6876: 
<a name="6877"/> 6877: 
<a name="6878"/> 6878: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6879"/> 6879: 
<a name="6880"/> 6880: <i>%% Basically send and receive on an IPv6 UDP (dgram) socket using</i>
<a name="6881"/> 6881: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="6882"/> 6882: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="6883"/> 6883: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="6884"/> 6884: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="6885"/> 6885: <i>%%</i>
<a name="api_a_sendmsg_and_recvmsg_udp6-1"/><a name="6886"/> 6886: <b>api_a_sendmsg_and_recvmsg_udp6</b>(Config) when is_list(Config) -&gt;
<a name="6887"/> 6887:     ?TT(?SECS(5)),
<a name="6888"/> 6888:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_udp6-last_expr"/><a name="6889"/> 6889: <b>    tc_try</b>(api_a_sendmsg_and_recvmsg_udp6,
<a name="6890"/> 6890:            fun() -&gt; has_support_ipv6() end,
<a name="6891"/> 6891:            fun() -&gt;
<a name="6892"/> 6892:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="6893"/> 6893:                                   Msg = #{addr =&gt; Dest,
<a name="6894"/> 6894:                                              %% ctrl =&gt; CMsgs,
<a name="6895"/> 6895:                                              iov  =&gt; [Data]},
<a name="6896"/> 6896:                                   socket:sendmsg(Sock, Msg)
<a name="6897"/> 6897:                           end,
<a name="6898"/> 6898:                    Recv = fun(Sock) -&gt;
<a name="6899"/> 6899:                                   case socket:recvmsg(Sock, Nowait) of
<a name="6900"/> 6900:                                       {ok, #{addr  := Source,
<a name="6901"/> 6901:                                              iov   := [Data]}} -&gt;
<a name="6902"/> 6902:                                           {ok, {Source, Data}};
<a name="6903"/> 6903:                                       {ok, _} = OK -&gt;
<a name="6904"/> 6904:                                           OK;
<a name="6905"/> 6905:                                       {select, _} = SELECT -&gt;
<a name="6906"/> 6906:                                           SELECT;
<a name="6907"/> 6907:                                       {completion, _} = COMPLETION -&gt;
<a name="6908"/> 6908:                                           COMPLETION;
<a name="6909"/> 6909:                                       {error, _} = ERROR -&gt;
<a name="6910"/> 6910:                                           ERROR
<a name="6911"/> 6911:                                   end
<a name="6912"/> 6912:                           end,
<a name="6913"/> 6913:                    InitState = #{domain   =&gt; inet6,
<a name="6914"/> 6914:                                  send     =&gt; Send,
<a name="6915"/> 6915:                                  recv     =&gt; Recv,
<a name="6916"/> 6916:                                  recv_ref =&gt; Nowait},
<a name="6917"/> 6917:                    ok = api_a_send_and_recv_udp(InitState)
<a name="6918"/> 6918:            end).
<a name="6919"/> 6919: 
<a name="6920"/> 6920: 
<a name="6921"/> 6921: 
<a name="6922"/> 6922: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6923"/> 6923: 
<a name="api_a_send_and_recv_udp-1"/><a name="6924"/> 6924: <b>api_a_send_and_recv_udp</b>(InitState) -&gt;
<a name="6925"/> 6925:     ServerSeq = 
<a name="6926"/> 6926:         [
<a name="6927"/> 6927:          %% *** Wait for start order part ***
<a name="6928"/> 6928:          #{desc =&gt; &quot;await start&quot;,
<a name="6929"/> 6929:            cmd  =&gt; fun(State) -&gt;
<a name="6930"/> 6930:                            Tester = ?SEV_AWAIT_START(),
<a name="6931"/> 6931:                            {ok, State#{tester =&gt; Tester}}
<a name="6932"/> 6932:                    end},
<a name="6933"/> 6933:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6934"/> 6934:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6935"/> 6935:                            _MRef = erlang:monitor(process, Tester),
<a name="6936"/> 6936:                            ok
<a name="6937"/> 6937:                    end},
<a name="6938"/> 6938: 
<a name="6939"/> 6939:          %% *** Init part ***
<a name="6940"/> 6940:          #{desc =&gt; &quot;which local address&quot;,
<a name="6941"/> 6941:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6942"/> 6942:                            LSA = which_local_socket_addr(Domain),
<a name="6943"/> 6943:                            {ok, State#{local_sa =&gt; LSA}}
<a name="6944"/> 6944:                    end},
<a name="6945"/> 6945:          #{desc =&gt; &quot;create socket&quot;,
<a name="6946"/> 6946:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6947"/> 6947:                            case socket:open(Domain, dgram, udp) of
<a name="6948"/> 6948:                                {ok, Sock} -&gt;
<a name="6949"/> 6949:                                    {ok, State#{sock =&gt; Sock}};
<a name="6950"/> 6950:                                {error, _} = ERROR -&gt;
<a name="6951"/> 6951:                                    ERROR
<a name="6952"/> 6952:                            end
<a name="6953"/> 6953:                    end},
<a name="6954"/> 6954:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="6955"/> 6955:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="6956"/> 6956:                            case sock_bind(Sock, LSA) of
<a name="6957"/> 6957:                                ok -&gt;
<a name="6958"/> 6958:                                    Port = sock_port(Sock),
<a name="6959"/> 6959:                                    {ok, State#{port =&gt; Port}};
<a name="6960"/> 6960:                                {error, _} = ERROR -&gt;
<a name="6961"/> 6961:                                    ERROR
<a name="6962"/> 6962:                            end
<a name="6963"/> 6963:                    end},
<a name="6964"/> 6964:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6965"/> 6965:            cmd  =&gt; fun(#{tester := Tester, local_sa := LSA, port := Port}) -&gt;
<a name="6966"/> 6966:                            ServerSA = LSA#{port =&gt; Port},
<a name="6967"/> 6967:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="6968"/> 6968:                            ok
<a name="6969"/> 6969:                    end},
<a name="6970"/> 6970: 
<a name="6971"/> 6971:          %% The actual test
<a name="6972"/> 6972:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="6973"/> 6973:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6974"/> 6974:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="6975"/> 6975:                    end},
<a name="6976"/> 6976:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="6977"/> 6977:            cmd  =&gt; fun(#{sock     := Sock,
<a name="6978"/> 6978:                          recv     := Recv,
<a name="6979"/> 6979:                          recv_ref := Ref} = State) -&gt;
<a name="6980"/> 6980:                            case Recv(Sock) of
<a name="6981"/> 6981:                                {select, {select_info, Tag, RecvRef}}
<a name="6982"/> 6982:                                  when Ref =:= nowait -&gt;
<a name="6983"/> 6983:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="6984"/> 6984:                                                &quot;~n   Tag: ~p&quot;
<a name="6985"/> 6985:                                                &quot;~n   Ref: ~p&quot;, [Tag, RecvRef]),
<a name="6986"/> 6986:                                    {ok, State#{async_tag =&gt; select,
<a name="6987"/> 6987:                                                recv_tag  =&gt; Tag,
<a name="6988"/> 6988:                                                recv_ref  =&gt; RecvRef}};
<a name="6989"/> 6989:                                {select, {select_info, Tag, Ref}}
<a name="6990"/> 6990:                                  when is_reference(Ref) -&gt;
<a name="6991"/> 6991:                                    ?SEV_IPRINT(&quot;expected select ref: &quot;
<a name="6992"/> 6992:                                                &quot;~n   Tag: ~p&quot;
<a name="6993"/> 6993:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="6994"/> 6994:                                    {ok, State#{async_tag =&gt; select,
<a name="6995"/> 6995:                                                recv_tag  =&gt; Tag}};
<a name="6996"/> 6996: 
<a name="6997"/> 6997:                                {completion, {completion_info, Tag, RecvRef}}
<a name="6998"/> 6998:                                  when Ref =:= nowait -&gt;
<a name="6999"/> 6999:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="7000"/> 7000:                                                &quot;~n   Tag: ~p&quot;
<a name="7001"/> 7001:                                                &quot;~n   Ref: ~p&quot;, [Tag, RecvRef]),
<a name="7002"/> 7002:                                    {ok, State#{async_tag =&gt; completion,
<a name="7003"/> 7003:                                                recv_tag  =&gt; Tag,
<a name="7004"/> 7004:                                                recv_ref  =&gt; RecvRef}};
<a name="7005"/> 7005:                                {completion, {completion_info, Tag, Ref}}
<a name="7006"/> 7006:                                  when is_reference(Ref) -&gt;
<a name="7007"/> 7007:                                    ?SEV_IPRINT(&quot;expected completion ref: &quot;
<a name="7008"/> 7008:                                                &quot;~n   Tag: ~p&quot;
<a name="7009"/> 7009:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7010"/> 7010:                                    {ok, State#{async_tag =&gt; completion,
<a name="7011"/> 7011:                                                recv_tag  =&gt; Tag}};
<a name="7012"/> 7012: 
<a name="7013"/> 7013:                                {ok, X} -&gt;
<a name="7014"/> 7014:                                    {error, {unexpected_success, X}};
<a name="7015"/> 7015: 
<a name="7016"/> 7016:                                {error, _} = ERROR -&gt;
<a name="7017"/> 7017:                                    ERROR
<a name="7018"/> 7018:                            end
<a name="7019"/> 7019:                    end},
<a name="7020"/> 7020:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="7021"/> 7021:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7022"/> 7022:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="7023"/> 7023:                            ok
<a name="7024"/> 7024:                    end},
<a name="7025"/> 7025:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="7026"/> 7026:            cmd  =&gt; fun(#{async_tag := select,
<a name="7027"/> 7027:                          sock      := Sock,
<a name="7028"/> 7028:                          recv_ref  := RecvRef}) -&gt;
<a name="7029"/> 7029:                            receive
<a name="7030"/> 7030:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="7031"/> 7031:                                    ok
<a name="7032"/> 7032:                            after 5000 -&gt;
<a name="7033"/> 7033:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="7034"/> 7034:                                                &quot;~n   Socket Info:   ~p&quot;
<a name="7035"/> 7035:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="7036"/> 7036:                                                [socket:info(Sock), ?MQ()]),
<a name="7037"/> 7037:                                    {error, timeout}
<a name="7038"/> 7038:                            end;
<a name="7039"/> 7039:                       (#{async_tag := completion,
<a name="7040"/> 7040:                          sock      := Sock,
<a name="7041"/> 7041:                          recv_ref  := RecvRef} = State) -&gt;
<a name="7042"/> 7042:                            receive
<a name="7043"/> 7043:                                %% Recvfrom
<a name="7044"/> 7044:                                {'$socket', Sock, completion,
<a name="7045"/> 7045:                                 {RecvRef, {ok, {Src, ?BASIC_REQ}}}} -&gt;
<a name="7046"/> 7046:                                    {ok, State#{req_src =&gt; Src}};
<a name="7047"/> 7047:                                %% Recvmsg
<a name="7048"/> 7048:                                {'$socket', Sock, completion,
<a name="7049"/> 7049:                                 {RecvRef, {ok, #{addr := Src,
<a name="7050"/> 7050:                                                  iov  := [?BASIC_REQ]}}}} -&gt;
<a name="7051"/> 7051:                                    {ok, State#{req_src =&gt; Src}};
<a name="7052"/> 7052:                                {'$socket', Sock, completion,
<a name="7053"/> 7053:                                 {RecvRef, {ok, Unexpected}}} -&gt;
<a name="7054"/> 7054:                                    ?SEV_EPRINT(&quot;Unexpected success result: &quot;
<a name="7055"/> 7055:                                                &quot;~n   ~p&quot;, [Unexpected]),
<a name="7056"/> 7056:                                    {error, {unexpected_success_result,
<a name="7057"/> 7057:                                             Unexpected}};
<a name="7058"/> 7058:                                {'$socket', Sock, completion,
<a name="7059"/> 7059:                                 {RecvRef, {error, Reason} = ERROR}} -&gt;
<a name="7060"/> 7060:                                    ?SEV_EPRINT(&quot;completion with error: &quot;
<a name="7061"/> 7061:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="7062"/> 7062:                                    ERROR
<a name="7063"/> 7063:                            after 5000 -&gt;
<a name="7064"/> 7064:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="7065"/> 7065:                                                &quot;~n   Socket Info:   ~p&quot;
<a name="7066"/> 7066:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="7067"/> 7067:                                                [socket:info(Sock), ?MQ()]),
<a name="7068"/> 7068:                                    {error, timeout}
<a name="7069"/> 7069:                            end
<a name="7070"/> 7070:                    end},
<a name="7071"/> 7071:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="7072"/> 7072:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7073"/> 7073:                            %% We are actually done *if* this was
<a name="7074"/> 7074:                            %% a completion event, but to make the
<a name="7075"/> 7075:                            %% test case simple...
<a name="7076"/> 7076:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7077"/> 7077:                            ok
<a name="7078"/> 7078:                    end},
<a name="7079"/> 7079:          #{desc =&gt; &quot;now read the data (request), for select&quot;,
<a name="7080"/> 7080:            cmd  =&gt; fun(#{async_tag := select,
<a name="7081"/> 7081:                          sock      := Sock,
<a name="7082"/> 7082:                          recv      := Recv} = State) -&gt;
<a name="7083"/> 7083:                            case Recv(Sock) of
<a name="7084"/> 7084:                                {ok, {Src, ?BASIC_REQ}} -&gt;
<a name="7085"/> 7085:                                    {ok, State#{req_src =&gt; Src}};
<a name="7086"/> 7086:                                {error, _} = ERROR -&gt;
<a name="7087"/> 7087:                                    ERROR
<a name="7088"/> 7088:                            end;
<a name="7089"/> 7089:                       (#{async_tag := completion} = _State) -&gt;
<a name="7090"/> 7090:                            %% We are already done!
<a name="7091"/> 7091:                            ?SEV_IPRINT(&quot;Already done!&quot;),
<a name="7092"/> 7092:                            ok
<a name="7093"/> 7093:                    end},
<a name="7094"/> 7094:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="7095"/> 7095:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7096"/> 7096:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="7097"/> 7097:                            ok
<a name="7098"/> 7098:                    end},
<a name="7099"/> 7099: 
<a name="7100"/> 7100:          #{desc =&gt; &quot;await continue (send reply)&quot;,
<a name="7101"/> 7101:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7102"/> 7102:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="7103"/> 7103:                    end},
<a name="7104"/> 7104:          #{desc =&gt; &quot;send reply&quot;,
<a name="7105"/> 7105:            cmd  =&gt; fun(#{sock := Sock, req_src := Src, send := Send}) -&gt;
<a name="7106"/> 7106:                            Send(Sock, ?BASIC_REP, Src)
<a name="7107"/> 7107:                    end},
<a name="7108"/> 7108:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="7109"/> 7109:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7110"/> 7110:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="7111"/> 7111:                            ok
<a name="7112"/> 7112:                    end},
<a name="7113"/> 7113: 
<a name="7114"/> 7114:          %% Termination
<a name="7115"/> 7115:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="7116"/> 7116:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="7117"/> 7117:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="7118"/> 7118:                                ok -&gt;
<a name="7119"/> 7119:                                    State2 = maps:remove(tester,    State),
<a name="7120"/> 7120:                                    State3 = maps:remove(async_tag, State2),
<a name="7121"/> 7121:                                    State4 = maps:remove(recv_tag,  State3),
<a name="7122"/> 7122:                                    State5 = maps:remove(recv_ref,  State4),
<a name="7123"/> 7123:                                    State6 = maps:remove(req_src,   State5),
<a name="7124"/> 7124:                                    {ok, State6};
<a name="7125"/> 7125:                                {error, _} = ERROR -&gt;
<a name="7126"/> 7126:                                    ERROR
<a name="7127"/> 7127:                            end
<a name="7128"/> 7128:                    end},
<a name="7129"/> 7129:          #{desc =&gt; &quot;close socket&quot;,
<a name="7130"/> 7130:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="7131"/> 7131:                            ok = socket:close(Sock),
<a name="7132"/> 7132:                            {ok, maps:remove(sock, State)}
<a name="7133"/> 7133:                    end},
<a name="7134"/> 7134: 
<a name="7135"/> 7135:          %% *** We are done ***
<a name="7136"/> 7136:          ?SEV_FINISH_NORMAL
<a name="7137"/> 7137:         ],
<a name="7138"/> 7138: 
<a name="7139"/> 7139: 
<a name="7140"/> 7140:     ClientSeq = 
<a name="7141"/> 7141:         [
<a name="7142"/> 7142:          %% *** Wait for start order part ***
<a name="7143"/> 7143:          #{desc =&gt; &quot;await start&quot;,
<a name="7144"/> 7144:            cmd  =&gt; fun(State) -&gt;
<a name="7145"/> 7145:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="7146"/> 7146:                            {ok, State#{tester    =&gt; Tester, 
<a name="7147"/> 7147:                                        server_sa =&gt; ServerSA}}
<a name="7148"/> 7148:                    end},
<a name="7149"/> 7149:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7150"/> 7150:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7151"/> 7151:                            _MRef = erlang:monitor(process, Tester),
<a name="7152"/> 7152:                            ok
<a name="7153"/> 7153:                    end},
<a name="7154"/> 7154: 
<a name="7155"/> 7155:          %% *** Init part ***
<a name="7156"/> 7156:          #{desc =&gt; &quot;local address&quot;,
<a name="7157"/> 7157:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7158"/> 7158:                            LSA = which_local_socket_addr(Domain),
<a name="7159"/> 7159:                            {ok, State#{lsa =&gt; LSA}}
<a name="7160"/> 7160:                    end},
<a name="7161"/> 7161:          #{desc =&gt; &quot;open socket&quot;,
<a name="7162"/> 7162:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7163"/> 7163:                            Sock = sock_open(Domain, dgram, udp),
<a name="7164"/> 7164:                            {ok, State#{sock =&gt; Sock}}
<a name="7165"/> 7165:                    end},
<a name="7166"/> 7166:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="7167"/> 7167:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="7168"/> 7168:                           case sock_bind(Sock, LSA) of
<a name="7169"/> 7169:                                ok -&gt;
<a name="7170"/> 7170:                                    ok;
<a name="7171"/> 7171:                                {error, _} = ERROR -&gt;
<a name="7172"/> 7172:                                    ERROR
<a name="7173"/> 7173:                            end
<a name="7174"/> 7174:                    end},
<a name="7175"/> 7175:          #{desc =&gt; &quot;sockname&quot;,
<a name="7176"/> 7176:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="7177"/> 7177:                            SA = sock_sockname(Sock),
<a name="7178"/> 7178:                            {ok, State#{sa =&gt; SA}}
<a name="7179"/> 7179:                    end},
<a name="7180"/> 7180:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7181"/> 7181:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7182"/> 7182:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="7183"/> 7183:                            ok
<a name="7184"/> 7184:                    end},
<a name="7185"/> 7185: 
<a name="7186"/> 7186:          %% The actual test
<a name="7187"/> 7187:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="7188"/> 7188:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7189"/> 7189:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="7190"/> 7190:                    end},
<a name="7191"/> 7191:          #{desc =&gt; &quot;send request&quot;,
<a name="7192"/> 7192:            cmd  =&gt; fun(#{sock := Sock, server_sa := Server, send := Send}) -&gt;
<a name="7193"/> 7193:                            Send(Sock, ?BASIC_REQ, Server)
<a name="7194"/> 7194:                    end},
<a name="7195"/> 7195:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="7196"/> 7196:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7197"/> 7197:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="7198"/> 7198:                            ok
<a name="7199"/> 7199:                    end},
<a name="7200"/> 7200:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="7201"/> 7201:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7202"/> 7202:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="7203"/> 7203:                    end},
<a name="7204"/> 7204:          #{desc =&gt; &quot;try recv reply (with nowait)&quot;,
<a name="7205"/> 7205:            cmd  =&gt; fun(#{sock     := Sock,
<a name="7206"/> 7206:                          recv     := Recv,
<a name="7207"/> 7207:                          recv_ref := Ref} = State) -&gt;
<a name="7208"/> 7208:                            case Recv(Sock) of
<a name="7209"/> 7209:                                {select, {select_info, Tag, RecvRef}}
<a name="7210"/> 7210:                                  when Ref =:= nowait -&gt;
<a name="7211"/> 7211:                                    {ok, State#{async_tag =&gt; select,
<a name="7212"/> 7212:                                                recv_tag  =&gt; Tag,
<a name="7213"/> 7213:                                                recv_ref  =&gt; RecvRef}};
<a name="7214"/> 7214:                                {select, {select_info, Tag, Ref}}
<a name="7215"/> 7215:                                  when is_reference(Ref) -&gt;
<a name="7216"/> 7216:                                    {ok, State#{async_tag =&gt; select,
<a name="7217"/> 7217:                                                recv_tag  =&gt; Tag}};
<a name="7218"/> 7218:                                {completion, {completion_info, Tag, RecvRef}}
<a name="7219"/> 7219:                                  when Ref =:= nowait -&gt;
<a name="7220"/> 7220:                                    {ok, State#{async_tag =&gt; completion,
<a name="7221"/> 7221:                                                recv_tag  =&gt; Tag,
<a name="7222"/> 7222:                                                recv_ref  =&gt; RecvRef}};
<a name="7223"/> 7223:                                {completion, {completion_info, Tag, Ref}}
<a name="7224"/> 7224:                                  when is_reference(Ref) -&gt;
<a name="7225"/> 7225:                                    {ok, State#{async_tag =&gt; completion,
<a name="7226"/> 7226:                                                recv_tag  =&gt; Tag}};
<a name="7227"/> 7227:                                {ok, X} -&gt;
<a name="7228"/> 7228:                                    {error, {unexpected_select_info, X}};
<a name="7229"/> 7229:                                {error, _} = ERROR -&gt;
<a name="7230"/> 7230:                                    ERROR
<a name="7231"/> 7231:                            end
<a name="7232"/> 7232:                    end},
<a name="7233"/> 7233:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="7234"/> 7234:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7235"/> 7235:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="7236"/> 7236:                            ok
<a name="7237"/> 7237:                    end},
<a name="7238"/> 7238:          #{desc =&gt; &quot;await select message&quot;,
<a name="7239"/> 7239:            cmd  =&gt; fun(#{async_tag := select,
<a name="7240"/> 7240:                          sock      := Sock,
<a name="7241"/> 7241:                          recv_ref  := RecvRef}) -&gt;
<a name="7242"/> 7242:                            receive
<a name="7243"/> 7243:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="7244"/> 7244:                                    ok
<a name="7245"/> 7245:                            end;
<a name="7246"/> 7246:                       (#{async_tag := completion,
<a name="7247"/> 7247:                          sock      := Sock,
<a name="7248"/> 7248:                          recv_ref  := RecvRef}) -&gt;
<a name="7249"/> 7249:                            receive
<a name="7250"/> 7250:                                {'$socket', Sock, completion,
<a name="7251"/> 7251:                                 {RecvRef, {ok, _}}} -&gt;
<a name="7252"/> 7252:                                    ok
<a name="7253"/> 7253:                            end
<a name="7254"/> 7254:                    end},
<a name="7255"/> 7255:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="7256"/> 7256:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7257"/> 7257:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7258"/> 7258:                            ok
<a name="7259"/> 7259:                    end},
<a name="7260"/> 7260:          #{desc =&gt; &quot;now read the data (reply)&quot;,
<a name="7261"/> 7261:            cmd  =&gt; fun(#{async_tag := select,
<a name="7262"/> 7262:                          sock      := Sock,
<a name="7263"/> 7263:                          recv      := Recv}) -&gt;
<a name="7264"/> 7264:                            case Recv(Sock) of
<a name="7265"/> 7265:                                {ok, {_Src, ?BASIC_REP}} -&gt;
<a name="7266"/> 7266:                                    ok;
<a name="7267"/> 7267:                                {error, _} = ERROR -&gt;
<a name="7268"/> 7268:                                    ERROR
<a name="7269"/> 7269:                            end;
<a name="7270"/> 7270:                       (#{async_tag := completion}) -&gt;
<a name="7271"/> 7271:                            ?SEV_IPRINT(&quot;Already read!&quot;),
<a name="7272"/> 7272:                            ok
<a name="7273"/> 7273:                    end},
<a name="7274"/> 7274:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="7275"/> 7275:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7276"/> 7276:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="7277"/> 7277:                            ok
<a name="7278"/> 7278:                    end},
<a name="7279"/> 7279: 
<a name="7280"/> 7280:          %% Termination
<a name="7281"/> 7281:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="7282"/> 7282:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="7283"/> 7283:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="7284"/> 7284:                                ok -&gt;
<a name="7285"/> 7285:                                    State2 = maps:remove(tester,    State),
<a name="7286"/> 7286:                                    State3 = maps:remove(async_tag, State2),
<a name="7287"/> 7287:                                    State4 = maps:remove(recv_tag,  State3),
<a name="7288"/> 7288:                                    State5 = maps:remove(recv_ref,  State4),
<a name="7289"/> 7289:                                    {ok, State5};
<a name="7290"/> 7290:                                {error, _} = ERROR -&gt;
<a name="7291"/> 7291:                                    ERROR
<a name="7292"/> 7292:                            end
<a name="7293"/> 7293:                    end},
<a name="7294"/> 7294:          #{desc =&gt; &quot;close socket&quot;,
<a name="7295"/> 7295:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="7296"/> 7296:                            ok = socket:close(Sock),
<a name="7297"/> 7297:                            {ok, maps:remove(sock, State)}
<a name="7298"/> 7298:                    end},
<a name="7299"/> 7299: 
<a name="7300"/> 7300:          %% *** We are done ***
<a name="7301"/> 7301:          ?SEV_FINISH_NORMAL
<a name="7302"/> 7302:         ],
<a name="7303"/> 7303: 
<a name="7304"/> 7304: 
<a name="7305"/> 7305:     TesterSeq = 
<a name="7306"/> 7306:         [
<a name="7307"/> 7307:          %% *** Init part ***
<a name="7308"/> 7308:          #{desc =&gt; &quot;monitor server&quot;,
<a name="7309"/> 7309:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7310"/> 7310:                            _MRef = erlang:monitor(process, Pid),
<a name="7311"/> 7311:                            ok
<a name="7312"/> 7312:                    end},
<a name="7313"/> 7313:          #{desc =&gt; &quot;monitor client&quot;,
<a name="7314"/> 7314:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7315"/> 7315:                            _MRef = erlang:monitor(process, Pid),
<a name="7316"/> 7316:                            ok
<a name="7317"/> 7317:                    end},
<a name="7318"/> 7318: 
<a name="7319"/> 7319:          %% Start the server
<a name="7320"/> 7320:          #{desc =&gt; &quot;order server start&quot;,
<a name="7321"/> 7321:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7322"/> 7322:                            ?SEV_ANNOUNCE_START(Pid),
<a name="7323"/> 7323:                            ok
<a name="7324"/> 7324:                    end},
<a name="7325"/> 7325:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="7326"/> 7326:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="7327"/> 7327:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="7328"/> 7328:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="7329"/> 7329:                    end},
<a name="7330"/> 7330: 
<a name="7331"/> 7331:          %% Start the client
<a name="7332"/> 7332:          #{desc =&gt; &quot;order client start&quot;,
<a name="7333"/> 7333:            cmd  =&gt; fun(#{client    := Pid, 
<a name="7334"/> 7334:                          server_sa := ServerSA} = _State) -&gt;
<a name="7335"/> 7335:                            ?SEV_ANNOUNCE_START(Pid, ServerSA),
<a name="7336"/> 7336:                            ok
<a name="7337"/> 7337:                    end},
<a name="7338"/> 7338:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="7339"/> 7339:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7340"/> 7340:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="7341"/> 7341:                    end},
<a name="7342"/> 7342:  
<a name="7343"/> 7343:          %% The actual test
<a name="7344"/> 7344:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="7345"/> 7345:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7346"/> 7346:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="7347"/> 7347:                            ok
<a name="7348"/> 7348:                    end},
<a name="7349"/> 7349:          #{desc =&gt; &quot;await server ready (recv_select)&quot;,
<a name="7350"/> 7350:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7351"/> 7351:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="7352"/> 7352:                    end},
<a name="7353"/> 7353: 
<a name="7354"/> 7354:          #{desc =&gt; &quot;order client continue (send request)&quot;,
<a name="7355"/> 7355:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7356"/> 7356:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_req),
<a name="7357"/> 7357:                            ok
<a name="7358"/> 7358:                    end},
<a name="7359"/> 7359:          #{desc =&gt; &quot;await client ready (send request)&quot;,
<a name="7360"/> 7360:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7361"/> 7361:                            ok = ?SEV_AWAIT_READY(Pid, client, send_req)
<a name="7362"/> 7362:                    end},
<a name="7363"/> 7363:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="7364"/> 7364:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7365"/> 7365:                            ok = ?SEV_AWAIT_READY(Pid, server, select)
<a name="7366"/> 7366:                    end},
<a name="7367"/> 7367:          #{desc =&gt; &quot;await server ready (recv request)&quot;,
<a name="7368"/> 7368:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7369"/> 7369:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_req)
<a name="7370"/> 7370:                    end},
<a name="7371"/> 7371: 
<a name="7372"/> 7372:          #{desc =&gt; &quot;order client continue (recv)&quot;,
<a name="7373"/> 7373:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7374"/> 7374:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="7375"/> 7375:                            ok
<a name="7376"/> 7376:                    end},
<a name="7377"/> 7377:          #{desc =&gt; &quot;await client ready (recv_select)&quot;,
<a name="7378"/> 7378:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7379"/> 7379:                            ok = ?SEV_AWAIT_READY(Pid, client, recv_select)
<a name="7380"/> 7380:                    end},
<a name="7381"/> 7381:          #{desc =&gt; &quot;order server continue (send reply)&quot;,
<a name="7382"/> 7382:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7383"/> 7383:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_reply),
<a name="7384"/> 7384:                            ok
<a name="7385"/> 7385:                    end},
<a name="7386"/> 7386:          #{desc =&gt; &quot;await server ready (send)&quot;,
<a name="7387"/> 7387:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7388"/> 7388:                            ok = ?SEV_AWAIT_READY(Pid, server, send)
<a name="7389"/> 7389:                    end},
<a name="7390"/> 7390:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="7391"/> 7391:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7392"/> 7392:                            ok = ?SEV_AWAIT_READY(Pid, client, select)
<a name="7393"/> 7393:                    end},
<a name="7394"/> 7394:          #{desc =&gt; &quot;await client ready (recv reply)&quot;,
<a name="7395"/> 7395:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7396"/> 7396:                            ok = ?SEV_AWAIT_READY(Pid, client, recv_rep)
<a name="7397"/> 7397:                    end},
<a name="7398"/> 7398: 
<a name="7399"/> 7399:          %% Terminations
<a name="7400"/> 7400:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="7401"/> 7401:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7402"/> 7402:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="7403"/> 7403:                            ok
<a name="7404"/> 7404:                    end},
<a name="7405"/> 7405:          #{desc =&gt; &quot;await client termination&quot;,
<a name="7406"/> 7406:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="7407"/> 7407:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="7408"/> 7408:                                ok -&gt;
<a name="7409"/> 7409:                                    State1 = maps:remove(client, State),
<a name="7410"/> 7410:                                    {ok, State1};
<a name="7411"/> 7411:                                {error, _} = ERROR -&gt;
<a name="7412"/> 7412:                                    ERROR
<a name="7413"/> 7413:                            end
<a name="7414"/> 7414:                    end},
<a name="7415"/> 7415:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="7416"/> 7416:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7417"/> 7417:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="7418"/> 7418:                            ok
<a name="7419"/> 7419:                    end},
<a name="7420"/> 7420:          #{desc =&gt; &quot;await server termination&quot;,
<a name="7421"/> 7421:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="7422"/> 7422:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="7423"/> 7423:                                ok -&gt;
<a name="7424"/> 7424:                                    State1 = maps:remove(server, State),
<a name="7425"/> 7425:                                    {ok, State1};
<a name="7426"/> 7426:                                {error, _} = ERROR -&gt;
<a name="7427"/> 7427:                                    ERROR
<a name="7428"/> 7428:                            end
<a name="7429"/> 7429:                    end},
<a name="7430"/> 7430: 
<a name="7431"/> 7431: 
<a name="7432"/> 7432:          %% *** We are done ***
<a name="7433"/> 7433:          ?SEV_FINISH_NORMAL
<a name="7434"/> 7434:         ],
<a name="7435"/> 7435: 
<a name="7436"/> 7436:     i(&quot;start server evaluator&quot;),
<a name="7437"/> 7437:     ServerInitState = InitState,
<a name="7438"/> 7438:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="7439"/> 7439: 
<a name="7440"/> 7440:     i(&quot;start client evaluator(s)&quot;),
<a name="7441"/> 7441:     ClientInitState = InitState,
<a name="7442"/> 7442:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="7443"/> 7443: 
<a name="7444"/> 7444:     i(&quot;start 'tester' evaluator&quot;),
<a name="7445"/> 7445:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="7446"/> 7446:                         client =&gt; Client#ev.pid},
<a name="7447"/> 7447:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="7448"/> 7448: 
<a name="7449"/> 7449:     i(&quot;await evaluator&quot;),
<a name="api_a_send_and_recv_udp-last_expr"/><a name="7450"/> 7450: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="7451"/> 7451: 
<a name="7452"/> 7452: 
<a name="7453"/> 7453: 
<a name="7454"/> 7454: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7455"/> 7455: 
<a name="7456"/> 7456: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="7457"/> 7457: <i>%% on an IPv4 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="7458"/> 7458: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7459"/> 7459: <i>%% select message). Note that we only do this for the recv,</i>
<a name="7460"/> 7460: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="7461"/> 7461: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_tcp4-1"/><a name="7462"/> 7462: <b>api_a_send_and_recv_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="7463"/> 7463:     ?TT(?SECS(10)),
<a name="7464"/> 7464:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_tcp4-last_expr"/><a name="7465"/> 7465: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7466"/> 7466:            fun() -&gt; has_support_ipv4() end,
<a name="7467"/> 7467:            fun() -&gt;
<a name="7468"/> 7468:                    Send = fun(Sock, Data) -&gt;
<a name="7469"/> 7469:                                   socket:send(Sock, Data)
<a name="7470"/> 7470:                           end,
<a name="7471"/> 7471:                    Recv = fun(Sock) -&gt;
<a name="7472"/> 7472:                                   socket:recv(Sock, 0, Nowait)
<a name="7473"/> 7473:                           end,
<a name="7474"/> 7474:                    InitState = #{domain    =&gt; inet,
<a name="7475"/> 7475:                                  proto     =&gt; tcp,
<a name="7476"/> 7476:                                  send      =&gt; Send,
<a name="7477"/> 7477:                                  recv      =&gt; Recv,
<a name="7478"/> 7478:                                  recv_sref =&gt; Nowait},
<a name="7479"/> 7479:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7480"/> 7480:            end).
<a name="7481"/> 7481: 
<a name="7482"/> 7482: 
<a name="7483"/> 7483: 
<a name="7484"/> 7484: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7485"/> 7485: 
<a name="7486"/> 7486: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="7487"/> 7487: <i>%% on an IPv6 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="7488"/> 7488: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7489"/> 7489: <i>%% select message). Note that we only do this for the recv,</i>
<a name="7490"/> 7490: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="7491"/> 7491: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_tcp6-1"/><a name="7492"/> 7492: <b>api_a_send_and_recv_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="7493"/> 7493:     ?TT(?SECS(10)),
<a name="7494"/> 7494:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_tcp6-last_expr"/><a name="7495"/> 7495: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7496"/> 7496:            fun() -&gt; has_support_ipv6() end,
<a name="7497"/> 7497:            fun() -&gt;
<a name="7498"/> 7498:                    Send = fun(Sock, Data) -&gt;
<a name="7499"/> 7499:                                   socket:send(Sock, Data)
<a name="7500"/> 7500:                           end,
<a name="7501"/> 7501:                    Recv = fun(Sock) -&gt;
<a name="7502"/> 7502:                                   socket:recv(Sock, 0, Nowait)
<a name="7503"/> 7503:                           end,
<a name="7504"/> 7504:                    InitState = #{domain    =&gt; inet6,
<a name="7505"/> 7505:                                  proto     =&gt; tcp,
<a name="7506"/> 7506:                                  send      =&gt; Send,
<a name="7507"/> 7507:                                  recv      =&gt; Recv,
<a name="7508"/> 7508:                                  recv_sref =&gt; Nowait},
<a name="7509"/> 7509:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7510"/> 7510:            end).
<a name="7511"/> 7511: 
<a name="7512"/> 7512: 
<a name="7513"/> 7513: 
<a name="7514"/> 7514: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7515"/> 7515: 
<a name="7516"/> 7516: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="7517"/> 7517: <i>%% on an IPv4 SCTP (stream) socket. But we try to be async. That is, we use</i>
<a name="7518"/> 7518: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7519"/> 7519: <i>%% select message). Note that we only do this for the recv,</i>
<a name="7520"/> 7520: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="7521"/> 7521: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_sctp4-1"/><a name="7522"/> 7522: <b>api_a_send_and_recv_sctp4</b>(Config) when is_list(Config) -&gt;
<a name="7523"/> 7523:     ?TT(?SECS(10)),
<a name="7524"/> 7524:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_sctp4-last_expr"/><a name="7525"/> 7525: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7526"/> 7526:            fun() -&gt;
<a name="7527"/> 7527:                    has_support_sctp(),
<a name="7528"/> 7528:                    has_support_ipv4()
<a name="7529"/> 7529:            end,
<a name="7530"/> 7530:            fun() -&gt;
<a name="7531"/> 7531:                    Send = fun(Sock, Data) -&gt;
<a name="7532"/> 7532:                                   socket:send(Sock, Data)
<a name="7533"/> 7533:                           end,
<a name="7534"/> 7534:                    Recv = fun(Sock) -&gt;
<a name="7535"/> 7535:                                   socket:recv(Sock, 0, Nowait)
<a name="7536"/> 7536:                           end,
<a name="7537"/> 7537:                    InitState = #{domain    =&gt; inet,
<a name="7538"/> 7538:                                  proto     =&gt; sctp,
<a name="7539"/> 7539:                                  send      =&gt; Send,
<a name="7540"/> 7540:                                  recv      =&gt; Recv,
<a name="7541"/> 7541:                                  recv_sref =&gt; Nowait},
<a name="7542"/> 7542:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7543"/> 7543:            end).
<a name="7544"/> 7544: 
<a name="7545"/> 7545: 
<a name="7546"/> 7546: 
<a name="7547"/> 7547: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7548"/> 7548: 
<a name="7549"/> 7549: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="7550"/> 7550: <i>%% on an IPv4 SCTP (stream) socket. But we try to be async. That is, we use</i>
<a name="7551"/> 7551: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7552"/> 7552: <i>%% select message). Note that we only do this for the recv,</i>
<a name="7553"/> 7553: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="7554"/> 7554: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_sctp6-1"/><a name="7555"/> 7555: <b>api_a_send_and_recv_sctp6</b>(Config) when is_list(Config) -&gt;
<a name="7556"/> 7556:     ?TT(?SECS(10)),
<a name="7557"/> 7557:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_sctp6-last_expr"/><a name="7558"/> 7558: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7559"/> 7559:            fun() -&gt;
<a name="7560"/> 7560:                    has_support_sctp(),
<a name="7561"/> 7561:                    has_support_ipv6()
<a name="7562"/> 7562:            end,
<a name="7563"/> 7563:            fun() -&gt;
<a name="7564"/> 7564:                    Send = fun(Sock, Data) -&gt;
<a name="7565"/> 7565:                                   socket:send(Sock, Data)
<a name="7566"/> 7566:                           end,
<a name="7567"/> 7567:                    Recv = fun(Sock) -&gt;
<a name="7568"/> 7568:                                   socket:recv(Sock, 0, Nowait)
<a name="7569"/> 7569:                           end,
<a name="7570"/> 7570:                    InitState = #{domain    =&gt; inet6,
<a name="7571"/> 7571:                                  proto     =&gt; sctp,
<a name="7572"/> 7572:                                  send      =&gt; Send,
<a name="7573"/> 7573:                                  recv      =&gt; Recv,
<a name="7574"/> 7574:                                  recv_sref =&gt; Nowait},
<a name="7575"/> 7575:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7576"/> 7576:            end).
<a name="7577"/> 7577: 
<a name="7578"/> 7578: 
<a name="7579"/> 7579: 
<a name="7580"/> 7580: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7581"/> 7581: 
<a name="7582"/> 7582: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="7583"/> 7583: <i>%% on an IPv4 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="7584"/> 7584: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7585"/> 7585: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="7586"/> 7586: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="7587"/> 7587: <i>%% We *also* test async for accept.</i>
<a name="api_a_sendmsg_and_recvmsg_tcp4-1"/><a name="7588"/> 7588: <b>api_a_sendmsg_and_recvmsg_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="7589"/> 7589:     ?TT(?SECS(10)),
<a name="7590"/> 7590:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="7591"/> 7591: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7592"/> 7592:            fun() -&gt;
<a name="7593"/> 7593:                    is_not_windows(),
<a name="7594"/> 7594:                    has_support_ipv4()
<a name="7595"/> 7595:            end,
<a name="7596"/> 7596:            fun() -&gt;
<a name="7597"/> 7597:                    Send = fun(Sock, Data) -&gt;
<a name="7598"/> 7598:                                   Msg = #{iov =&gt; [Data]},
<a name="7599"/> 7599:                                   socket:sendmsg(Sock, Msg)
<a name="7600"/> 7600:                           end,
<a name="7601"/> 7601:                    Recv = fun(Sock) -&gt;
<a name="7602"/> 7602:                                   case socket:recvmsg(Sock, Nowait) of
<a name="7603"/> 7603:                                       {ok, #{iov := [Data]}} -&gt;
<a name="7604"/> 7604:                                           {ok, Data};
<a name="7605"/> 7605:                                       {select, _} = SELECT -&gt;
<a name="7606"/> 7606:                                           SELECT;
<a name="7607"/> 7607: 				      {error, _} = ERROR -&gt;
<a name="7608"/> 7608:                                           ERROR
<a name="7609"/> 7609:                                   end
<a name="7610"/> 7610:                           end,
<a name="7611"/> 7611:                    InitState = #{domain    =&gt; inet,
<a name="7612"/> 7612:                                  proto     =&gt; tcp,
<a name="7613"/> 7613:                                  send      =&gt; Send,
<a name="7614"/> 7614:                                  recv      =&gt; Recv,
<a name="7615"/> 7615:                                  recv_sref =&gt; Nowait},
<a name="7616"/> 7616:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7617"/> 7617:            end).
<a name="7618"/> 7618: 
<a name="7619"/> 7619: 
<a name="7620"/> 7620: 
<a name="7621"/> 7621: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7622"/> 7622: 
<a name="7623"/> 7623: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="7624"/> 7624: <i>%% on an IPv6 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="7625"/> 7625: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7626"/> 7626: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="7627"/> 7627: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="7628"/> 7628: <i>%% We *also* test async for accept.</i>
<a name="api_a_sendmsg_and_recvmsg_tcp6-1"/><a name="7629"/> 7629: <b>api_a_sendmsg_and_recvmsg_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="7630"/> 7630:     ?TT(?SECS(10)),
<a name="7631"/> 7631:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_tcp6-last_expr"/><a name="7632"/> 7632: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7633"/> 7633:            fun() -&gt; has_support_ipv6() end,
<a name="7634"/> 7634:            fun() -&gt;
<a name="7635"/> 7635:                    Send = fun(Sock, Data) -&gt;
<a name="7636"/> 7636:                                   Msg = #{iov =&gt; [Data]},
<a name="7637"/> 7637:                                   socket:sendmsg(Sock, Msg)
<a name="7638"/> 7638:                           end,
<a name="7639"/> 7639:                    Recv = fun(Sock) -&gt;
<a name="7640"/> 7640:                                   case socket:recvmsg(Sock, Nowait) of
<a name="7641"/> 7641:                                       {ok, #{iov := [Data]}} -&gt;
<a name="7642"/> 7642:                                           {ok, Data};
<a name="7643"/> 7643:                                       {select, _} = SELECT -&gt;
<a name="7644"/> 7644:                                           SELECT;
<a name="7645"/> 7645: 				      {error, _} = ERROR -&gt;
<a name="7646"/> 7646:                                           ERROR
<a name="7647"/> 7647:                                   end
<a name="7648"/> 7648:                           end,
<a name="7649"/> 7649:                    InitState = #{domain    =&gt; inet6,
<a name="7650"/> 7650:                                  proto     =&gt; tcp,
<a name="7651"/> 7651:                                  send      =&gt; Send,
<a name="7652"/> 7652:                                  recv      =&gt; Recv,
<a name="7653"/> 7653:                                  recv_sref =&gt; Nowait},
<a name="7654"/> 7654:                    ok = api_a_send_and_recv_stream(Config, InitState)
<a name="7655"/> 7655:            end).
<a name="7656"/> 7656: 
<a name="7657"/> 7657: 
<a name="7658"/> 7658: 
<a name="7659"/> 7659: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7660"/> 7660: 
<a name="api_a_send_and_recv_stream-2"/><a name="7661"/> 7661: <b>api_a_send_and_recv_stream</b>(Config, InitState) -&gt;
<a name="7662"/> 7662:     process_flag(trap_exit, true),
<a name="7663"/> 7663:     ServerSeq = 
<a name="7664"/> 7664:         [
<a name="7665"/> 7665:          %% *** Wait for start order ***
<a name="7666"/> 7666:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="7667"/> 7667:            cmd  =&gt; fun(State) -&gt;
<a name="7668"/> 7668:                            Tester = ?SEV_AWAIT_START(),
<a name="7669"/> 7669:                            {ok, State#{tester =&gt; Tester}}
<a name="7670"/> 7670:                    end},
<a name="7671"/> 7671:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7672"/> 7672:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7673"/> 7673:                            _MRef = erlang:monitor(process, Tester),
<a name="7674"/> 7674:                            ok
<a name="7675"/> 7675:                    end},
<a name="7676"/> 7676: 
<a name="7677"/> 7677:          %% *** Init part ***
<a name="7678"/> 7678:          #{desc =&gt; &quot;which local address&quot;,
<a name="7679"/> 7679:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7680"/> 7680:                            LSA = which_local_socket_addr(Domain),
<a name="7681"/> 7681:                            {ok, State#{lsa =&gt; LSA}}
<a name="7682"/> 7682:                    end},
<a name="7683"/> 7683:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="7684"/> 7684:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="7685"/> 7685:                            ?SEV_IPRINT(&quot;try create (open) ~w (~w) socket&quot;,
<a name="7686"/> 7686:                                        [Proto, Domain]),
<a name="7687"/> 7687:                            case socket:open(Domain, stream, Proto) of
<a name="7688"/> 7688:                                {ok, Sock} -&gt;
<a name="7689"/> 7689:                                    {ok, State#{lsock =&gt; Sock}};
<a name="7690"/> 7690:                                {error, eprotonosupport = Reason} -&gt;
<a name="7691"/> 7691:                                    {skip, Reason};
<a name="7692"/> 7692:                                {error, _} = ERROR -&gt;
<a name="7693"/> 7693:                                    ERROR
<a name="7694"/> 7694:                            end
<a name="7695"/> 7695:                    end},
<a name="7696"/> 7696:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="7697"/> 7697:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="7698"/> 7698:                            case sock_bind(LSock, LSA) of
<a name="7699"/> 7699:                                ok -&gt;
<a name="7700"/> 7700:                                    Port = sock_port(LSock),
<a name="7701"/> 7701:                                    {ok, State#{lport =&gt; Port}};
<a name="7702"/> 7702:                                {error, _} = ERROR -&gt;
<a name="7703"/> 7703:                                    ERROR
<a name="7704"/> 7704:                            end
<a name="7705"/> 7705:                    end},
<a name="7706"/> 7706:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="7707"/> 7707:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="7708"/> 7708:                            socket:listen(LSock)
<a name="7709"/> 7709:                    end},
<a name="7710"/> 7710:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7711"/> 7711:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="7712"/> 7712:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="7713"/> 7713:                            ok
<a name="7714"/> 7714:                    end},
<a name="7715"/> 7715: 
<a name="7716"/> 7716:          %% The actual test
<a name="7717"/> 7717:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="7718"/> 7718:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7719"/> 7719:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="7720"/> 7720:                    end},
<a name="7721"/> 7721:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="7722"/> 7722:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="7723"/> 7723:                            Nowait = nowait(Config),
<a name="7724"/> 7724:                            case socket:accept(LSock, Nowait) of
<a name="7725"/> 7725:                                {select, {select_info, Tag, Ref}}
<a name="7726"/> 7726:                                  when Nowait =:= nowait -&gt;
<a name="7727"/> 7727:                                    ?SEV_IPRINT(&quot;select accept message: &quot;
<a name="7728"/> 7728:                                                &quot;~n   Tag: ~p&quot;
<a name="7729"/> 7729:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7730"/> 7730:                                    {ok, State#{sorc        =&gt; select,
<a name="7731"/> 7731:                                                accept_stag =&gt; Tag,
<a name="7732"/> 7732:                                                accept_sref =&gt; Ref}};
<a name="7733"/> 7733:                                {select, {select_info, Tag, Nowait}}
<a name="7734"/> 7734:                                  when is_reference(Nowait) -&gt;
<a name="7735"/> 7735:                                    ?SEV_IPRINT(&quot;select accept result: &quot;
<a name="7736"/> 7736:                                                &quot;~n   Tag: ~p&quot;
<a name="7737"/> 7737:                                                &quot;~n   Ref: ~p&quot;, [Tag, Nowait]),
<a name="7738"/> 7738:                                    {ok, State#{sorc        =&gt; select,
<a name="7739"/> 7739:                                                accept_stag =&gt; Tag,
<a name="7740"/> 7740:                                                accept_sref =&gt; Nowait}};
<a name="7741"/> 7741: 
<a name="7742"/> 7742:                                {completion, {completion_info, Tag, Ref}}
<a name="7743"/> 7743:                                  when Nowait =:= nowait -&gt;
<a name="7744"/> 7744:                                    ?SEV_IPRINT(&quot;completion accept result: &quot;
<a name="7745"/> 7745:                                                &quot;~n   Tag: ~p&quot;
<a name="7746"/> 7746:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7747"/> 7747:                                    {ok, State#{sorc        =&gt; completion,
<a name="7748"/> 7748:                                                accept_stag =&gt; Tag,
<a name="7749"/> 7749:                                                accept_sref =&gt; Ref}};
<a name="7750"/> 7750:                                {completion, {completion_info, Tag, Nowait}}
<a name="7751"/> 7751:                                  when is_reference(Nowait) -&gt;
<a name="7752"/> 7752:                                    ?SEV_IPRINT(&quot;completion accept result: &quot;
<a name="7753"/> 7753:                                                &quot;~n   Tag: ~p&quot;
<a name="7754"/> 7754:                                                &quot;~n   Ref: ~p&quot;, [Tag, Nowait]),
<a name="7755"/> 7755:                                    {ok, State#{sorc        =&gt; completion,
<a name="7756"/> 7756:                                                accept_stag =&gt; Tag,
<a name="7757"/> 7757:                                                accept_sref =&gt; Nowait}};
<a name="7758"/> 7758: 
<a name="7759"/> 7759:                                {ok, X} -&gt;
<a name="7760"/> 7760:                                    {error, {unexpected_success, X}};
<a name="7761"/> 7761:                                {error, _} = ERROR -&gt;
<a name="7762"/> 7762:                                    ERROR
<a name="7763"/> 7763:                            end
<a name="7764"/> 7764:                    end},
<a name="7765"/> 7765:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="7766"/> 7766:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7767"/> 7767:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="7768"/> 7768:                            ok
<a name="7769"/> 7769:                    end},
<a name="7770"/> 7770:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="7771"/> 7771:            cmd  =&gt; fun(#{lsock := Sock, accept_sref := Ref} = State) -&gt;
<a name="7772"/> 7772:                            receive
<a name="7773"/> 7773:                                {'$socket', Sock, select, Ref} -&gt;
<a name="7774"/> 7774:                                    ?SEV_IPRINT(&quot;select message: &quot;
<a name="7775"/> 7775:                                                &quot;ready for accept&quot;),
<a name="7776"/> 7776:                                    ok;
<a name="7777"/> 7777:                                {'$socket', Sock, completion,
<a name="7778"/> 7778:                                 {Ref, {ok, CSock}}} -&gt;
<a name="7779"/> 7779:                                    ?SEV_IPRINT(&quot;completion message: accepted: &quot;
<a name="7780"/> 7780:                                                &quot;~n   CSock: ~p&quot;, [Sock]),
<a name="7781"/> 7781:                                    {ok, State#{csock =&gt; CSock}}
<a name="7782"/> 7782:                            after 5000 -&gt;
<a name="7783"/> 7783:                                    ?SEV_EPRINT(&quot;select|completion message timeout:&quot;
<a name="7784"/> 7784:                                                &quot;~n   Sock:          ~p&quot;
<a name="7785"/> 7785:                                                &quot;~n   Ref:           ~p&quot;
<a name="7786"/> 7786:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="7787"/> 7787:                                                [Sock, Ref, ?MQ()]),
<a name="7788"/> 7788:                                    {error, timeout}
<a name="7789"/> 7789:                            end
<a name="7790"/> 7790:                    end},
<a name="7791"/> 7791:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="7792"/> 7792:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7793"/> 7793:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7794"/> 7794:                            ok
<a name="7795"/> 7795:                    end},
<a name="7796"/> 7796:          #{desc =&gt; &quot;try accept (again)&quot;,
<a name="7797"/> 7797:            cmd  =&gt; fun(#{lsock := LSock, sorc := select} = State) -&gt;
<a name="7798"/> 7798:                            ?SEV_IPRINT(&quot;try accept again&quot;),
<a name="7799"/> 7799:                            case socket:accept(LSock, nowait) of
<a name="7800"/> 7800:                                {ok, Sock} -&gt;
<a name="7801"/> 7801:                                    ?SEV_IPRINT(&quot;accepted: &quot;
<a name="7802"/> 7802:                                                &quot;~n   Sock: ~p&quot;, [Sock]),
<a name="7803"/> 7803:                                    {ok, State#{csock =&gt; Sock}};
<a name="7804"/> 7804:                                {error, _} = ERROR -&gt;
<a name="7805"/> 7805:                                    ERROR
<a name="7806"/> 7806:                            end;
<a name="7807"/> 7807:                        (#{sorc := completion})-&gt;
<a name="7808"/> 7808:                            ?SEV_IPRINT(&quot;already accepted&quot;),
<a name="7809"/> 7809:                            ok
<a name="7810"/> 7810:                    end},
<a name="7811"/> 7811:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="7812"/> 7812:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7813"/> 7813:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="7814"/> 7814:                            ok
<a name="7815"/> 7815:                    end},
<a name="7816"/> 7816: 
<a name="7817"/> 7817:          #{desc =&gt; &quot;await continue (recv request)&quot;,
<a name="7818"/> 7818:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7819"/> 7819:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_req)
<a name="7820"/> 7820:                    end},
<a name="7821"/> 7821:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="7822"/> 7822:            cmd  =&gt; fun(#{csock     := Sock,
<a name="7823"/> 7823:                          recv      := Recv,
<a name="7824"/> 7824:                          recv_sref := SR} = State) -&gt;
<a name="7825"/> 7825:                            case Recv(Sock) of
<a name="7826"/> 7826:                                {select, {select_info, Tag, Ref}}
<a name="7827"/> 7827:                                  when SR =:= nowait -&gt;
<a name="7828"/> 7828:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="7829"/> 7829:                                                &quot;~n   Tag: ~p&quot;
<a name="7830"/> 7830:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7831"/> 7831:                                    {ok, State#{recv_stag =&gt; Tag,
<a name="7832"/> 7832:                                                recv_sref =&gt; Ref}};
<a name="7833"/> 7833:                                {select, {select_info, Tag, SR}}
<a name="7834"/> 7834:                                  when is_reference(SR) -&gt;
<a name="7835"/> 7835:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="7836"/> 7836:                                                &quot;~n   Tag: ~p&quot;
<a name="7837"/> 7837:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="7838"/> 7838:                                    {ok, State#{recv_stag =&gt; Tag}};
<a name="7839"/> 7839: 
<a name="7840"/> 7840:                                {completion, {completion_info, Tag, Ref}}
<a name="7841"/> 7841:                                  when SR =:= nowait -&gt;
<a name="7842"/> 7842:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="7843"/> 7843:                                                &quot;~n   Tag: ~p&quot;
<a name="7844"/> 7844:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="7845"/> 7845:                                    {ok, State#{recv_stag =&gt; Tag,
<a name="7846"/> 7846:                                                recv_sref =&gt; Ref}};
<a name="7847"/> 7847:                                {completion, {completion_info, Tag, SR}}
<a name="7848"/> 7848:                                  when is_reference(SR) -&gt;
<a name="7849"/> 7849:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="7850"/> 7850:                                                &quot;~n   Tag: ~p&quot;
<a name="7851"/> 7851:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="7852"/> 7852:                                    {ok, State#{recv_stag =&gt; Tag}};
<a name="7853"/> 7853: 
<a name="7854"/> 7854:                                {ok, X} -&gt;
<a name="7855"/> 7855:                                    {error, {unexpected_success, X}};
<a name="7856"/> 7856:                                {error, _} = ERROR -&gt;
<a name="7857"/> 7857:                                    ERROR
<a name="7858"/> 7858:                            end
<a name="7859"/> 7859:                    end},
<a name="7860"/> 7860:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="7861"/> 7861:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7862"/> 7862:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="7863"/> 7863:                            ok
<a name="7864"/> 7864:                    end},
<a name="7865"/> 7865:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="7866"/> 7866:            cmd  =&gt; fun(#{csock := Sock, recv_sref := RecvRef}) -&gt;
<a name="7867"/> 7867:                            receive
<a name="7868"/> 7868:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="7869"/> 7869:                                    ok;
<a name="7870"/> 7870:                                {'$socket', Sock, completion,
<a name="7871"/> 7871:                                 {RecvRef, {ok, ?BASIC_REQ}}} -&gt;
<a name="7872"/> 7872:                                    ?SEV_IPRINT(&quot;received expected data&quot;),
<a name="7873"/> 7873:                                    ok;
<a name="7874"/> 7874:                                {'$socket', Sock, completion,
<a name="7875"/> 7875:                                 {RecvRef, {error, Reason} = ERROR}} -&gt;
<a name="7876"/> 7876:                                    ?SEV_EPRINT(&quot;received unexpected error: &quot;
<a name="7877"/> 7877:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="7878"/> 7878:                                    ERROR
<a name="7879"/> 7879:                            end
<a name="7880"/> 7880:                    end},
<a name="7881"/> 7881:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="7882"/> 7882:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7883"/> 7883:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7884"/> 7884:                            ok
<a name="7885"/> 7885:                    end},
<a name="7886"/> 7886:          #{desc =&gt; &quot;now read the data (request)&quot;,
<a name="7887"/> 7887:            cmd  =&gt; fun(#{sorc  := select,
<a name="7888"/> 7888:                          csock := Sock,
<a name="7889"/> 7889:                          recv  := Recv} = _State) -&gt;
<a name="7890"/> 7890:                            case Recv(Sock) of
<a name="7891"/> 7891:                                {ok, ?BASIC_REQ} -&gt;
<a name="7892"/> 7892:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="7893"/> 7893:                                    ok;
<a name="7894"/> 7894:                                {error, _} = ERROR -&gt;
<a name="7895"/> 7895:                                    ERROR
<a name="7896"/> 7896:                            end;
<a name="7897"/> 7897:                       (#{sorc := completion}) -&gt;
<a name="7898"/> 7898:                            ?SEV_IPRINT(&quot;already received&quot;),
<a name="7899"/> 7899:                            ok
<a name="7900"/> 7900:                    end},
<a name="7901"/> 7901:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="7902"/> 7902:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7903"/> 7903:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="7904"/> 7904:                            ok
<a name="7905"/> 7905:                    end},
<a name="7906"/> 7906: 
<a name="7907"/> 7907:          #{desc =&gt; &quot;await continue (send reply)&quot;,
<a name="7908"/> 7908:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7909"/> 7909:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_rep)
<a name="7910"/> 7910:                    end},
<a name="7911"/> 7911:          #{desc =&gt; &quot;send reply&quot;,
<a name="7912"/> 7912:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="7913"/> 7913:                            Send(Sock, ?BASIC_REP)
<a name="7914"/> 7914:                    end},
<a name="7915"/> 7915:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="7916"/> 7916:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7917"/> 7917:                            ?SEV_ANNOUNCE_READY(Tester, send_rep),
<a name="7918"/> 7918:                            ok
<a name="7919"/> 7919:                    end},
<a name="7920"/> 7920: 
<a name="7921"/> 7921:          %% *** Termination ***
<a name="7922"/> 7922:          #{desc =&gt; &quot;await terminate&quot;,
<a name="7923"/> 7923:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="7924"/> 7924:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="7925"/> 7925:                                ok -&gt;
<a name="7926"/> 7926:                                    {ok, maps:remove(tester, State)};
<a name="7927"/> 7927:                                {error, _} = ERROR -&gt;
<a name="7928"/> 7928:                                    ERROR
<a name="7929"/> 7929:                            end
<a name="7930"/> 7930:                    end},
<a name="7931"/> 7931:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="7932"/> 7932:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="7933"/> 7933:                            socket:close(Sock)
<a name="7934"/> 7934:                    end},
<a name="7935"/> 7935:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="7936"/> 7936:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="7937"/> 7937:                            socket:close(Sock)
<a name="7938"/> 7938:                    end},
<a name="7939"/> 7939: 
<a name="7940"/> 7940:          %% *** We are done ***
<a name="7941"/> 7941:          ?SEV_FINISH_NORMAL
<a name="7942"/> 7942:         ],
<a name="7943"/> 7943: 
<a name="7944"/> 7944: 
<a name="7945"/> 7945:     ClientSeq = 
<a name="7946"/> 7946:         [
<a name="7947"/> 7947:          %% *** Wait for start order ***
<a name="7948"/> 7948:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="7949"/> 7949:            cmd  =&gt; fun(State) -&gt;
<a name="7950"/> 7950:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="7951"/> 7951:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="7952"/> 7952:                    end},
<a name="7953"/> 7953:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7954"/> 7954:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7955"/> 7955:                            _MRef = erlang:monitor(process, Tester),
<a name="7956"/> 7956:                            ok
<a name="7957"/> 7957:                    end},
<a name="7958"/> 7958: 
<a name="7959"/> 7959:          %% *** The init part ***
<a name="7960"/> 7960:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="7961"/> 7961:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="7962"/> 7962:                            LSA = which_local_socket_addr(Domain),
<a name="7963"/> 7963:                            SSA = LSA#{port =&gt; Port},
<a name="7964"/> 7964:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="7965"/> 7965:                    end},
<a name="7966"/> 7966:          #{desc =&gt; &quot;create socket&quot;,
<a name="7967"/> 7967:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="7968"/> 7968:                            ?SEV_IPRINT(&quot;try create (open) ~w (~w) socket&quot;,
<a name="7969"/> 7969:                                        [Proto, Domain]),
<a name="7970"/> 7970:                            case socket:open(Domain, stream, Proto) of
<a name="7971"/> 7971:                                {ok, Sock} -&gt;
<a name="7972"/> 7972:                                    {ok, State#{sock =&gt; Sock}};
<a name="7973"/> 7973:                                {error, _} = ERROR -&gt;
<a name="7974"/> 7974:                                    ERROR
<a name="7975"/> 7975:                            end
<a name="7976"/> 7976:                    end},
<a name="7977"/> 7977:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="7978"/> 7978:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="7979"/> 7979:                            case sock_bind(Sock, LSA) of
<a name="7980"/> 7980:                                ok -&gt;
<a name="7981"/> 7981:                                    ok;
<a name="7982"/> 7982:                                {error, _} = ERROR -&gt;
<a name="7983"/> 7983:                                    ERROR
<a name="7984"/> 7984:                            end
<a name="7985"/> 7985:                    end},
<a name="7986"/> 7986:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7987"/> 7987:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7988"/> 7988:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="7989"/> 7989:                            ok
<a name="7990"/> 7990:                    end},
<a name="7991"/> 7991: 
<a name="7992"/> 7992:          %% *** The actual test ***
<a name="7993"/> 7993:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="7994"/> 7994:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7995"/> 7995:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="7996"/> 7996:                    end},
<a name="7997"/> 7997:          #{desc =&gt; &quot;connect to server&quot;,
<a name="7998"/> 7998:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="7999"/> 7999:                            socket:connect(Sock, SSA)
<a name="8000"/> 8000:                    end},
<a name="8001"/> 8001:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="8002"/> 8002:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8003"/> 8003:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="8004"/> 8004:                            ok
<a name="8005"/> 8005:                    end},
<a name="8006"/> 8006: 
<a name="8007"/> 8007:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="8008"/> 8008:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8009"/> 8009:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="8010"/> 8010:                    end},
<a name="8011"/> 8011:          #{desc =&gt; &quot;send request (to server)&quot;,
<a name="8012"/> 8012:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="8013"/> 8013:                            ok = Send(Sock, ?BASIC_REQ)
<a name="8014"/> 8014:                    end},
<a name="8015"/> 8015:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="8016"/> 8016:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8017"/> 8017:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="8018"/> 8018:                            ok
<a name="8019"/> 8019:                    end},
<a name="8020"/> 8020: 
<a name="8021"/> 8021:          #{desc =&gt; &quot;try recv reply (with nowait, expect select|completion)&quot;,
<a name="8022"/> 8022:            cmd  =&gt; fun(#{sock := Sock,
<a name="8023"/> 8023:                          recv := Recv,
<a name="8024"/> 8024:                          recv_sref := SR} = State) -&gt;
<a name="8025"/> 8025:                            case Recv(Sock) of
<a name="8026"/> 8026:                                {select, {select_info, Tag, Ref}}
<a name="8027"/> 8027:                                  when SR =:= nowait -&gt;
<a name="8028"/> 8028:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="8029"/> 8029:                                                &quot;~n   Tag: ~p&quot;
<a name="8030"/> 8030:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8031"/> 8031:                                    {ok, State#{sorc      =&gt; select,
<a name="8032"/> 8032:                                                recv_stag =&gt; Tag,
<a name="8033"/> 8033:                                                recv_sref =&gt; Ref}};
<a name="8034"/> 8034:                                {select, {select_info, Tag, SR}}
<a name="8035"/> 8035:                                  when is_reference(SR) -&gt;
<a name="8036"/> 8036:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="8037"/> 8037:                                                &quot;~n   Tag: ~p&quot;
<a name="8038"/> 8038:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="8039"/> 8039:                                    {ok, State#{sorc      =&gt; select,
<a name="8040"/> 8040:                                                recv_stag =&gt; Tag}};
<a name="8041"/> 8041: 
<a name="8042"/> 8042:                                {completion, {completion_info, Tag, Ref}}
<a name="8043"/> 8043:                                  when SR =:= nowait -&gt;
<a name="8044"/> 8044:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="8045"/> 8045:                                                &quot;~n   Tag: ~p&quot;
<a name="8046"/> 8046:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8047"/> 8047:                                    {ok, State#{sorc      =&gt; completion,
<a name="8048"/> 8048:                                                recv_stag =&gt; Tag,
<a name="8049"/> 8049:                                                recv_sref =&gt; Ref}};
<a name="8050"/> 8050:                                {completion, {completion_info, Tag, SR}}
<a name="8051"/> 8051:                                  when is_reference(SR) -&gt;
<a name="8052"/> 8052:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="8053"/> 8053:                                                &quot;~n   Tag: ~p&quot;
<a name="8054"/> 8054:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="8055"/> 8055:                                    {ok, State#{sorc      =&gt; completion,
<a name="8056"/> 8056:                                                recv_stag =&gt; Tag}};
<a name="8057"/> 8057: 
<a name="8058"/> 8058:                                {ok, X} -&gt;
<a name="8059"/> 8059:                                    {error, {unexpected_success, X}};
<a name="8060"/> 8060:                                {error, _} = ERROR -&gt;
<a name="8061"/> 8061:                                    ERROR
<a name="8062"/> 8062:                            end
<a name="8063"/> 8063:                    end},
<a name="8064"/> 8064:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="8065"/> 8065:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8066"/> 8066:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="8067"/> 8067:                            ok
<a name="8068"/> 8068:                    end},
<a name="8069"/> 8069:          #{desc =&gt; &quot;await select message&quot;,
<a name="8070"/> 8070:            cmd  =&gt; fun(#{sock := Sock, recv_sref := RecvRef}) -&gt;
<a name="8071"/> 8071:                            receive
<a name="8072"/> 8072:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="8073"/> 8073:                                    ok;
<a name="8074"/> 8074:                                {'$socket', Sock, completion,
<a name="8075"/> 8075:                                 {RecvRef, {ok, ?BASIC_REP}}} -&gt;
<a name="8076"/> 8076:                                    ?SEV_IPRINT(&quot;received expected reply&quot;),
<a name="8077"/> 8077:                                    ok
<a name="8078"/> 8078:                            end
<a name="8079"/> 8079:                    end},
<a name="8080"/> 8080:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="8081"/> 8081:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8082"/> 8082:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="8083"/> 8083:                            ok
<a name="8084"/> 8084:                    end},
<a name="8085"/> 8085:          #{desc =&gt; &quot;now read the data (reply)&quot;,
<a name="8086"/> 8086:            cmd  =&gt; fun(#{sorc := select, sock := Sock, recv := Recv}) -&gt;
<a name="8087"/> 8087:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="8088"/> 8088:                            ?SEV_IPRINT(&quot;[select] received expected reply&quot;),
<a name="8089"/> 8089:                            ok;
<a name="8090"/> 8090:                       (#{sorc := completion}) -&gt;
<a name="8091"/> 8091:                            ?SEV_IPRINT(&quot;[completion] &quot;
<a name="8092"/> 8092:                                        &quot;expected reply already received&quot;),
<a name="8093"/> 8093:                            ok
<a name="8094"/> 8094:                    end},
<a name="8095"/> 8095:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="8096"/> 8096:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8097"/> 8097:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="8098"/> 8098:                            ok
<a name="8099"/> 8099:                    end},
<a name="8100"/> 8100: 
<a name="8101"/> 8101:          %% *** Termination ***
<a name="8102"/> 8102:          #{desc =&gt; &quot;await terminate&quot;,
<a name="8103"/> 8103:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8104"/> 8104:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8105"/> 8105:                                ok -&gt;
<a name="8106"/> 8106:                                    {ok, maps:remove(tester, State)};
<a name="8107"/> 8107:                                {error, _} = ERROR -&gt;
<a name="8108"/> 8108:                                    ERROR
<a name="8109"/> 8109:                            end
<a name="8110"/> 8110:                    end},
<a name="8111"/> 8111:          #{desc =&gt; &quot;close socket&quot;,
<a name="8112"/> 8112:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="8113"/> 8113:                            socket:close(Sock)
<a name="8114"/> 8114:                    end},
<a name="8115"/> 8115: 
<a name="8116"/> 8116:          %% *** We are done ***
<a name="8117"/> 8117:          ?SEV_FINISH_NORMAL
<a name="8118"/> 8118:         ],
<a name="8119"/> 8119: 
<a name="8120"/> 8120:     TesterSeq =
<a name="8121"/> 8121:         [
<a name="8122"/> 8122:          %% *** Init part ***
<a name="8123"/> 8123:          #{desc =&gt; &quot;monitor server&quot;,
<a name="8124"/> 8124:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8125"/> 8125:                            _MRef = erlang:monitor(process, Pid),
<a name="8126"/> 8126:                            ok
<a name="8127"/> 8127:                    end},
<a name="8128"/> 8128:          #{desc =&gt; &quot;monitor client&quot;,
<a name="8129"/> 8129:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8130"/> 8130:                            _MRef = erlang:monitor(process, Pid),
<a name="8131"/> 8131:                            ok
<a name="8132"/> 8132:                    end},
<a name="8133"/> 8133: 
<a name="8134"/> 8134:          %% Start the server
<a name="8135"/> 8135:          #{desc =&gt; &quot;order server start&quot;,
<a name="8136"/> 8136:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8137"/> 8137:                            ?SEV_ANNOUNCE_START(Pid),
<a name="8138"/> 8138:                            ok
<a name="8139"/> 8139:                    end},
<a name="8140"/> 8140:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="8141"/> 8141:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8142"/> 8142:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="8143"/> 8143:                            {ok, State#{server_port =&gt; Port}}
<a name="8144"/> 8144:                    end},
<a name="8145"/> 8145: 
<a name="8146"/> 8146:          %% Start the client
<a name="8147"/> 8147:          #{desc =&gt; &quot;order client start&quot;,
<a name="8148"/> 8148:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="8149"/> 8149:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="8150"/> 8150:                            ok
<a name="8151"/> 8151:                    end},
<a name="8152"/> 8152:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="8153"/> 8153:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8154"/> 8154:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="8155"/> 8155:                    end},
<a name="8156"/> 8156: 
<a name="8157"/> 8157:          %% *** The actual test ***
<a name="8158"/> 8158:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="8159"/> 8159:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="8160"/> 8160:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="8161"/> 8161:                            ok
<a name="8162"/> 8162:                    end},
<a name="8163"/> 8163:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="8164"/> 8164:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8165"/> 8165:                            ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="8166"/> 8166:                    end},
<a name="8167"/> 8167:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="8168"/> 8168:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8169"/> 8169:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="8170"/> 8170:                            ok
<a name="8171"/> 8171:                    end},
<a name="8172"/> 8172:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="8173"/> 8173:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8174"/> 8174:                            ?SEV_AWAIT_READY(Pid, server, select)
<a name="8175"/> 8175:                    end},
<a name="8176"/> 8176:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="8177"/> 8177:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8178"/> 8178:                            ?SEV_AWAIT_READY(Pid, server, accept)
<a name="8179"/> 8179:                    end},
<a name="8180"/> 8180:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="8181"/> 8181:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8182"/> 8182:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="8183"/> 8183:                    end},
<a name="8184"/> 8184: 
<a name="8185"/> 8185:          #{desc =&gt; &quot;order server to continue (recv request)&quot;,
<a name="8186"/> 8186:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8187"/> 8187:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv_req),
<a name="8188"/> 8188:                            ok
<a name="8189"/> 8189:                    end},
<a name="8190"/> 8190:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="8191"/> 8191:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8192"/> 8192:                            ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="8193"/> 8193:                    end},
<a name="8194"/> 8194:          #{desc =&gt; &quot;order client to continue (send request)&quot;,
<a name="8195"/> 8195:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8196"/> 8196:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_req),
<a name="8197"/> 8197:                            ok
<a name="8198"/> 8198:                    end},
<a name="8199"/> 8199:          #{desc =&gt; &quot;await client ready (send request)&quot;,
<a name="8200"/> 8200:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="8201"/> 8201:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="8202"/> 8202:                    end},
<a name="8203"/> 8203:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="8204"/> 8204:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8205"/> 8205:                            ?SEV_AWAIT_READY(Pid, server, select)
<a name="8206"/> 8206:                    end},
<a name="8207"/> 8207:          #{desc =&gt; &quot;await server ready (recv request)&quot;,
<a name="8208"/> 8208:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8209"/> 8209:                            ?SEV_AWAIT_READY(Pid, server, recv_req)
<a name="8210"/> 8210:                    end},
<a name="8211"/> 8211: 
<a name="8212"/> 8212:          #{desc =&gt; &quot;order client to continue (recv reply)&quot;,
<a name="8213"/> 8213:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8214"/> 8214:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv_rep),
<a name="8215"/> 8215:                            ok
<a name="8216"/> 8216:                    end},
<a name="8217"/> 8217:          #{desc =&gt; &quot;await client ready (recv select)&quot;,
<a name="8218"/> 8218:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8219"/> 8219:                            ?SEV_AWAIT_READY(Pid, client, recv_select)
<a name="8220"/> 8220:                    end},
<a name="8221"/> 8221:          #{desc =&gt; &quot;order server to continue (send reply)&quot;,
<a name="8222"/> 8222:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8223"/> 8223:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_rep),
<a name="8224"/> 8224:                            ok
<a name="8225"/> 8225:                    end},
<a name="8226"/> 8226:          #{desc =&gt; &quot;await server ready (send reply)&quot;,
<a name="8227"/> 8227:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8228"/> 8228:                            ?SEV_AWAIT_READY(Pid, server, send_rep)
<a name="8229"/> 8229:                    end},
<a name="8230"/> 8230:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="8231"/> 8231:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8232"/> 8232:                            ?SEV_AWAIT_READY(Pid, client, select)
<a name="8233"/> 8233:                    end},
<a name="8234"/> 8234:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="8235"/> 8235:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="8236"/> 8236:                            ?SEV_AWAIT_READY(Client, client, recv_rep)
<a name="8237"/> 8237:                    end},
<a name="8238"/> 8238: 
<a name="8239"/> 8239: 
<a name="8240"/> 8240:          %% *** Termination ***
<a name="8241"/> 8241:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="8242"/> 8242:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="8243"/> 8243:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="8244"/> 8244:                            ok
<a name="8245"/> 8245:                    end},
<a name="8246"/> 8246:          #{desc =&gt; &quot;await client termination&quot;,
<a name="8247"/> 8247:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="8248"/> 8248:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="8249"/> 8249:                            State1 = maps:remove(client, State),
<a name="8250"/> 8250:                            {ok, State1}
<a name="8251"/> 8251:                    end},
<a name="8252"/> 8252:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="8253"/> 8253:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="8254"/> 8254:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="8255"/> 8255:                            ok
<a name="8256"/> 8256:                    end},
<a name="8257"/> 8257:          #{desc =&gt; &quot;await server termination&quot;,
<a name="8258"/> 8258:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="8259"/> 8259:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="8260"/> 8260:                            State1 = maps:remove(server, State),
<a name="8261"/> 8261:                            {ok, State1}
<a name="8262"/> 8262:                    end},
<a name="8263"/> 8263: 
<a name="8264"/> 8264:          %% *** We are done ***
<a name="8265"/> 8265:          ?SEV_FINISH_NORMAL
<a name="8266"/> 8266:         ],
<a name="8267"/> 8267: 
<a name="8268"/> 8268:     i(&quot;start server evaluator&quot;),
<a name="8269"/> 8269:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="8270"/> 8270: 
<a name="8271"/> 8271:     i(&quot;start client evaluator&quot;),
<a name="8272"/> 8272:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="8273"/> 8273: 
<a name="8274"/> 8274:     i(&quot;start tester evaluator&quot;),
<a name="8275"/> 8275:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="8276"/> 8276:                         client =&gt; Client#ev.pid},
<a name="8277"/> 8277:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="8278"/> 8278: 
<a name="8279"/> 8279:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_send_and_recv_stream-last_expr"/><a name="8280"/> 8280: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="8281"/> 8281: 
<a name="8282"/> 8282: 
<a name="8283"/> 8283: 
<a name="8284"/> 8284: 
<a name="8285"/> 8285: 
<a name="8286"/> 8286: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8287"/> 8287: 
<a name="8288"/> 8288: <i>%% Basically we make an async (Timeout = nowait) call to recvfrom,</i>
<a name="8289"/> 8289: <i>%% wait some time and then cancel. IPv4</i>
<a name="8290"/> 8290: <i>%%</i>
<a name="api_a_recvfrom_cancel_udp4-1"/><a name="8291"/> 8291: <b>api_a_recvfrom_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="8292"/> 8292:     ?TT(?SECS(10)),
<a name="8293"/> 8293:     Nowait = nowait(Config),
<a name="api_a_recvfrom_cancel_udp4-last_expr"/><a name="8294"/> 8294: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8295"/> 8295:            fun() -&gt; has_support_ipv4() end,
<a name="8296"/> 8296:            fun() -&gt;
<a name="8297"/> 8297:                    Recv = fun(Sock) -&gt;
<a name="8298"/> 8298:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="8299"/> 8299:                                       {ok, _} = OK -&gt;
<a name="8300"/> 8300:                                           OK;
<a name="8301"/> 8301:                                       {select, _} = SELECT -&gt;
<a name="8302"/> 8302:                                           SELECT;
<a name="8303"/> 8303:                                       {completion, _} = COMPLETION -&gt;
<a name="8304"/> 8304:                                           COMPLETION;
<a name="8305"/> 8305:                                       {error, _} = ERROR -&gt;
<a name="8306"/> 8306:                                           ERROR
<a name="8307"/> 8307:                                   end
<a name="8308"/> 8308:                           end,
<a name="8309"/> 8309:                    InitState = #{domain   =&gt; inet,
<a name="8310"/> 8310:                                  recv     =&gt; Recv,
<a name="8311"/> 8311:                                  recv_ref =&gt; Nowait},
<a name="8312"/> 8312:                    ok = api_a_recv_cancel_udp(InitState)
<a name="8313"/> 8313:            end).
<a name="8314"/> 8314: 
<a name="8315"/> 8315: 
<a name="8316"/> 8316: 
<a name="8317"/> 8317: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8318"/> 8318: 
<a name="8319"/> 8319: <i>%% Basically we make an async (Timeout = nowait) call to recvfrom,</i>
<a name="8320"/> 8320: <i>%% wait some time and then cancel. IPv6</i>
<a name="8321"/> 8321: <i>%%</i>
<a name="api_a_recvfrom_cancel_udp6-1"/><a name="8322"/> 8322: <b>api_a_recvfrom_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="8323"/> 8323:     ?TT(?SECS(10)),
<a name="8324"/> 8324:     Nowait = nowait(Config),
<a name="api_a_recvfrom_cancel_udp6-last_expr"/><a name="8325"/> 8325: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8326"/> 8326:            fun() -&gt; has_support_ipv6() end,
<a name="8327"/> 8327:            fun() -&gt;
<a name="8328"/> 8328:                    Recv = fun(Sock) -&gt;
<a name="8329"/> 8329:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="8330"/> 8330:                                       {ok, _} = OK -&gt;
<a name="8331"/> 8331:                                           OK;
<a name="8332"/> 8332:                                       {select, _} = SELECT -&gt;
<a name="8333"/> 8333:                                           SELECT;
<a name="8334"/> 8334:                                       {completion, _} = COMPLETION -&gt;
<a name="8335"/> 8335:                                           COMPLETION;
<a name="8336"/> 8336:                                       {error, _} = ERROR -&gt;
<a name="8337"/> 8337:                                           ERROR
<a name="8338"/> 8338:                                   end
<a name="8339"/> 8339:                           end,
<a name="8340"/> 8340:                    InitState = #{domain   =&gt; inet6,
<a name="8341"/> 8341:                                  recv     =&gt; Recv,
<a name="8342"/> 8342:                                  recv_ref =&gt; Nowait},
<a name="8343"/> 8343:                    ok = api_a_recv_cancel_udp(InitState)
<a name="8344"/> 8344:            end).
<a name="8345"/> 8345: 
<a name="8346"/> 8346: 
<a name="8347"/> 8347: 
<a name="8348"/> 8348: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8349"/> 8349: 
<a name="8350"/> 8350: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="8351"/> 8351: <i>%% wait some time and then cancel. IPv4</i>
<a name="8352"/> 8352: <i>%%</i>
<a name="api_a_recvmsg_cancel_udp4-1"/><a name="8353"/> 8353: <b>api_a_recvmsg_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="8354"/> 8354:     ?TT(?SECS(10)),
<a name="8355"/> 8355:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_udp4-last_expr"/><a name="8356"/> 8356: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8357"/> 8357:            fun() -&gt; has_support_ipv4() end,
<a name="8358"/> 8358:            fun() -&gt;
<a name="8359"/> 8359:                    Recv = fun(Sock) -&gt;
<a name="8360"/> 8360:                                   case socket:recvmsg(Sock, Nowait) of
<a name="8361"/> 8361:                                       {ok, _} = OK -&gt;
<a name="8362"/> 8362:                                           OK;
<a name="8363"/> 8363:                                       {select, _} = SELECT -&gt;
<a name="8364"/> 8364:                                           SELECT;
<a name="8365"/> 8365:                                       {completion, _} = COMPLETION -&gt;
<a name="8366"/> 8366:                                           COMPLETION;
<a name="8367"/> 8367:                                       {error, _} = ERROR -&gt;
<a name="8368"/> 8368:                                           ERROR
<a name="8369"/> 8369:                                   end
<a name="8370"/> 8370:                           end,
<a name="8371"/> 8371:                    InitState = #{domain   =&gt; inet,
<a name="8372"/> 8372:                                  recv     =&gt; Recv,
<a name="8373"/> 8373:                                  recv_ref =&gt; Nowait},
<a name="8374"/> 8374:                    ok = api_a_recv_cancel_udp(InitState)
<a name="8375"/> 8375:            end).
<a name="8376"/> 8376: 
<a name="8377"/> 8377: 
<a name="8378"/> 8378: 
<a name="8379"/> 8379: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8380"/> 8380: 
<a name="8381"/> 8381: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="8382"/> 8382: <i>%% wait some time and then cancel. IPv6</i>
<a name="8383"/> 8383: <i>%%</i>
<a name="api_a_recvmsg_cancel_udp6-1"/><a name="8384"/> 8384: <b>api_a_recvmsg_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="8385"/> 8385:     ?TT(?SECS(10)),
<a name="8386"/> 8386:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_udp6-last_expr"/><a name="8387"/> 8387: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8388"/> 8388:            fun() -&gt; has_support_ipv6() end,
<a name="8389"/> 8389:            fun() -&gt;
<a name="8390"/> 8390:                    Recv = fun(Sock) -&gt;
<a name="8391"/> 8391:                                   case socket:recvmsg(Sock, Nowait) of
<a name="8392"/> 8392:                                       {ok, _} = OK -&gt;
<a name="8393"/> 8393:                                           OK;
<a name="8394"/> 8394:                                       {select, _} = SELECT -&gt;
<a name="8395"/> 8395:                                           SELECT;
<a name="8396"/> 8396:                                       {completion, _} = COMPLETION -&gt;
<a name="8397"/> 8397:                                           COMPLETION;
<a name="8398"/> 8398:                                       {error, _} = ERROR -&gt;
<a name="8399"/> 8399:                                           ERROR
<a name="8400"/> 8400:                                   end
<a name="8401"/> 8401:                           end,
<a name="8402"/> 8402:                    InitState = #{domain   =&gt; inet6,
<a name="8403"/> 8403:                                  recv     =&gt; Recv,
<a name="8404"/> 8404:                                  recv_ref =&gt; Nowait},
<a name="8405"/> 8405:                    ok = api_a_recv_cancel_udp(InitState)
<a name="8406"/> 8406:            end).
<a name="8407"/> 8407: 
<a name="8408"/> 8408: 
<a name="8409"/> 8409: 
<a name="8410"/> 8410: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8411"/> 8411: 
<a name="api_a_recv_cancel_udp-1"/><a name="8412"/> 8412: <b>api_a_recv_cancel_udp</b>(InitState) -&gt;
<a name="8413"/> 8413:     ServerSeq = 
<a name="8414"/> 8414:         [
<a name="8415"/> 8415:          %% *** Wait for start order part ***
<a name="8416"/> 8416:          #{desc =&gt; &quot;await start&quot;,
<a name="8417"/> 8417:            cmd  =&gt; fun(State) -&gt;
<a name="8418"/> 8418:                            Tester = ?SEV_AWAIT_START(),
<a name="8419"/> 8419:                            {ok, State#{tester =&gt; Tester}}
<a name="8420"/> 8420:                    end},
<a name="8421"/> 8421:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="8422"/> 8422:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8423"/> 8423:                            _MRef = erlang:monitor(process, Tester),
<a name="8424"/> 8424:                            ok
<a name="8425"/> 8425:                    end},
<a name="8426"/> 8426: 
<a name="8427"/> 8427:          %% *** Init part ***
<a name="8428"/> 8428:          #{desc =&gt; &quot;which local address&quot;,
<a name="8429"/> 8429:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8430"/> 8430:                            LSA = which_local_socket_addr(Domain),
<a name="8431"/> 8431:                            {ok, State#{local_sa =&gt; LSA}}
<a name="8432"/> 8432:                    end},
<a name="8433"/> 8433:          #{desc =&gt; &quot;create socket&quot;,
<a name="8434"/> 8434:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8435"/> 8435:                            case socket:open(Domain, dgram, udp) of
<a name="8436"/> 8436:                                {ok, Sock} -&gt;
<a name="8437"/> 8437:                                    {ok, State#{sock =&gt; Sock}};
<a name="8438"/> 8438:                                {error, _} = ERROR -&gt;
<a name="8439"/> 8439:                                    ERROR
<a name="8440"/> 8440:                            end
<a name="8441"/> 8441:                    end},
<a name="8442"/> 8442:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="8443"/> 8443:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="8444"/> 8444:                            case sock_bind(Sock, LSA) of
<a name="8445"/> 8445:                                ok -&gt;
<a name="8446"/> 8446:                                    Port = sock_port(Sock),
<a name="8447"/> 8447:                                    {ok, State#{port =&gt; Port}};
<a name="8448"/> 8448:                                {error, _} = ERROR -&gt;
<a name="8449"/> 8449:                                    ERROR
<a name="8450"/> 8450:                            end
<a name="8451"/> 8451:                    end},
<a name="8452"/> 8452:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="8453"/> 8453:            cmd  =&gt; fun(#{tester := Tester, local_sa := LSA, port := Port}) -&gt;
<a name="8454"/> 8454:                            ServerSA = LSA#{port =&gt; Port},
<a name="8455"/> 8455:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="8456"/> 8456:                            ok
<a name="8457"/> 8457:                    end},
<a name="8458"/> 8458: 
<a name="8459"/> 8459:          %% The actual test
<a name="8460"/> 8460:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="8461"/> 8461:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8462"/> 8462:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="8463"/> 8463:                    end},
<a name="8464"/> 8464:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="8465"/> 8465:            cmd  =&gt; fun(#{sock     := Sock,
<a name="8466"/> 8466:                          recv     := Recv,
<a name="8467"/> 8467:                          recv_ref := Ref} = State) -&gt;
<a name="8468"/> 8468:                            case Recv(Sock) of
<a name="8469"/> 8469:                                {select, SI} when Ref =:= nowait -&gt;
<a name="8470"/> 8470:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="8471"/> 8471:                                {select,
<a name="8472"/> 8472:                                 {select_info, _Tag, Ref} = SI}
<a name="8473"/> 8473:                                  when is_reference(Ref) -&gt;
<a name="8474"/> 8474:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="8475"/> 8475: 
<a name="8476"/> 8476:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="8477"/> 8477:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="8478"/> 8478:                                {completion,
<a name="8479"/> 8479:                                 {completion_info, _Tag, Ref} = CI}
<a name="8480"/> 8480:                                  when is_reference(Ref) -&gt;
<a name="8481"/> 8481:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="8482"/> 8482: 
<a name="8483"/> 8483:                                {ok, X} -&gt;
<a name="8484"/> 8484:                                    {error, {unexpected_success, X}};
<a name="8485"/> 8485: 
<a name="8486"/> 8486:                                {error, _} = ERROR -&gt;
<a name="8487"/> 8487:                                    ERROR
<a name="8488"/> 8488:                            end
<a name="8489"/> 8489:                    end},
<a name="8490"/> 8490:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="8491"/> 8491:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8492"/> 8492:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="8493"/> 8493:                            ok
<a name="8494"/> 8494:                    end},
<a name="8495"/> 8495:          #{desc =&gt; &quot;wait for select message - without success&quot;,
<a name="8496"/> 8496:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="8497"/> 8497:                            receive
<a name="8498"/> 8498:                                {'$socket', Sock, select, Ref} -&gt;
<a name="8499"/> 8499:                                    {error, {unexpected_select, Ref}};
<a name="8500"/> 8500: 
<a name="8501"/> 8501:                                {'$socket', Sock, completion, C} -&gt;
<a name="8502"/> 8502:                                    {error, {unexpected_completion, C}}
<a name="8503"/> 8503: 
<a name="8504"/> 8504:                            after 5000 -&gt;
<a name="8505"/> 8505:                                    ok
<a name="8506"/> 8506:                            end
<a name="8507"/> 8507:                    end},
<a name="8508"/> 8508:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="8509"/> 8509:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8510"/> 8510:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="8511"/> 8511:                            ok
<a name="8512"/> 8512:                    end},
<a name="8513"/> 8513:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="8514"/> 8514:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8515"/> 8515:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="8516"/> 8516:                    end},
<a name="8517"/> 8517:          #{desc =&gt; &quot;cancel&quot;,
<a name="8518"/> 8518:            cmd  =&gt; fun(#{sock := Sock, recv_select_info := SI}) -&gt;
<a name="8519"/> 8519:                            ok = socket:cancel(Sock, SI);
<a name="8520"/> 8520:                       (#{sock := Sock, recv_completion_info := CI}) -&gt;
<a name="8521"/> 8521:                            ok = socket:cancel(Sock, CI)
<a name="8522"/> 8522:                    end},
<a name="8523"/> 8523: 
<a name="8524"/> 8524:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="8525"/> 8525:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8526"/> 8526:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="8527"/> 8527:                            ok
<a name="8528"/> 8528:                    end},
<a name="8529"/> 8529: 
<a name="8530"/> 8530:          %% Termination
<a name="8531"/> 8531:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="8532"/> 8532:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8533"/> 8533:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8534"/> 8534:                                ok -&gt;
<a name="8535"/> 8535:                                    State2 = maps:remove(tester,   State),
<a name="8536"/> 8536:                                    State3 = maps:remove(recv_ref, State2),
<a name="8537"/> 8537:                                    State4 = maps:remove(req_src,  State3),
<a name="8538"/> 8538:                                    {ok, State4};
<a name="8539"/> 8539:                                {error, _} = ERROR -&gt;
<a name="8540"/> 8540:                                    ERROR
<a name="8541"/> 8541:                            end
<a name="8542"/> 8542:                    end},
<a name="8543"/> 8543:          #{desc =&gt; &quot;close socket&quot;,
<a name="8544"/> 8544:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="8545"/> 8545:                            ok = socket:close(Sock),
<a name="8546"/> 8546:                            {ok, maps:remove(sock, State)}
<a name="8547"/> 8547:                    end},
<a name="8548"/> 8548: 
<a name="8549"/> 8549:          %% *** We are done ***
<a name="8550"/> 8550:          ?SEV_FINISH_NORMAL
<a name="8551"/> 8551:         ],
<a name="8552"/> 8552: 
<a name="8553"/> 8553: 
<a name="8554"/> 8554:     TesterSeq = 
<a name="8555"/> 8555:         [
<a name="8556"/> 8556:          %% *** Init part ***
<a name="8557"/> 8557:          #{desc =&gt; &quot;monitor server&quot;,
<a name="8558"/> 8558:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8559"/> 8559:                            _MRef = erlang:monitor(process, Pid),
<a name="8560"/> 8560:                            ok
<a name="8561"/> 8561:                    end},
<a name="8562"/> 8562: 
<a name="8563"/> 8563:          %% Start the server
<a name="8564"/> 8564:          #{desc =&gt; &quot;order server start&quot;,
<a name="8565"/> 8565:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8566"/> 8566:                            ?SEV_ANNOUNCE_START(Pid),
<a name="8567"/> 8567:                            ok
<a name="8568"/> 8568:                    end},
<a name="8569"/> 8569:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="8570"/> 8570:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8571"/> 8571:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="8572"/> 8572:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="8573"/> 8573:                    end},
<a name="8574"/> 8574: 
<a name="8575"/> 8575:          %% The actual test
<a name="8576"/> 8576:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="8577"/> 8577:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8578"/> 8578:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="8579"/> 8579:                            ok
<a name="8580"/> 8580:                    end},
<a name="8581"/> 8581:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="8582"/> 8582:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8583"/> 8583:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="8584"/> 8584:                    end},
<a name="8585"/> 8585:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="8586"/> 8586:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8587"/> 8587:                            ok = ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="8588"/> 8588:                    end},
<a name="8589"/> 8589:          #{desc =&gt; &quot;order server continue (cancel)&quot;,
<a name="8590"/> 8590:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8591"/> 8591:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="8592"/> 8592:                            ok
<a name="8593"/> 8593:                    end},
<a name="8594"/> 8594:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="8595"/> 8595:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8596"/> 8596:                            ok = ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="8597"/> 8597:                    end},
<a name="8598"/> 8598: 
<a name="8599"/> 8599:          %% Terminations
<a name="8600"/> 8600:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="8601"/> 8601:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8602"/> 8602:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="8603"/> 8603:                            ok
<a name="8604"/> 8604:                    end},
<a name="8605"/> 8605:          #{desc =&gt; &quot;await server termination&quot;,
<a name="8606"/> 8606:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8607"/> 8607:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="8608"/> 8608:                                ok -&gt;
<a name="8609"/> 8609:                                    State1 = maps:remove(server, State),
<a name="8610"/> 8610:                                    {ok, State1};
<a name="8611"/> 8611:                                {error, _} = ERROR -&gt;
<a name="8612"/> 8612:                                    ERROR
<a name="8613"/> 8613:                            end
<a name="8614"/> 8614:                    end},
<a name="8615"/> 8615: 
<a name="8616"/> 8616: 
<a name="8617"/> 8617:          %% *** We are done ***
<a name="8618"/> 8618:          ?SEV_FINISH_NORMAL
<a name="8619"/> 8619:         ],
<a name="8620"/> 8620: 
<a name="8621"/> 8621:     i(&quot;start server evaluator&quot;),
<a name="8622"/> 8622:     ServerInitState = InitState,
<a name="8623"/> 8623:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="8624"/> 8624: 
<a name="8625"/> 8625:     i(&quot;start 'tester' evaluator&quot;),
<a name="8626"/> 8626:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="8627"/> 8627:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="8628"/> 8628: 
<a name="8629"/> 8629:     i(&quot;await evaluator&quot;),
<a name="api_a_recv_cancel_udp-last_expr"/><a name="8630"/> 8630: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="8631"/> 8631: 
<a name="8632"/> 8632: 
<a name="8633"/> 8633: 
<a name="8634"/> 8634: 
<a name="8635"/> 8635: 
<a name="8636"/> 8636: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8637"/> 8637: 
<a name="8638"/> 8638: <i>%% Basically we make an async (Timeout = nowait) call to accept,</i>
<a name="8639"/> 8639: <i>%% wait some time and then cancel. IPv4</i>
<a name="8640"/> 8640: <i>%%</i>
<a name="api_a_accept_cancel_tcp4-1"/><a name="8641"/> 8641: <b>api_a_accept_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="8642"/> 8642:     ?TT(?SECS(10)),
<a name="8643"/> 8643:     Nowait = nowait(Config),
<a name="api_a_accept_cancel_tcp4-last_expr"/><a name="8644"/> 8644: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8645"/> 8645:            fun() -&gt; has_support_ipv4() end,
<a name="8646"/> 8646:            fun() -&gt;
<a name="8647"/> 8647:                    Accept = fun(Sock) -&gt;
<a name="8648"/> 8648:                                     case socket:accept(Sock, Nowait) of
<a name="8649"/> 8649:                                         {ok, _} = OK -&gt;
<a name="8650"/> 8650:                                             OK;
<a name="8651"/> 8651:                                         {select, _} = SELECT -&gt;
<a name="8652"/> 8652:                                             SELECT;
<a name="8653"/> 8653:                                         {completion, _} = COMPLETION -&gt;
<a name="8654"/> 8654:                                             COMPLETION;
<a name="8655"/> 8655:                                         {error, _} = ERROR -&gt;
<a name="8656"/> 8656:                                             ERROR
<a name="8657"/> 8657:                                     end
<a name="8658"/> 8658:                             end,
<a name="8659"/> 8659:                    InitState = #{domain     =&gt; inet,
<a name="8660"/> 8660:                                  accept     =&gt; Accept,
<a name="8661"/> 8661:                                  accept_ref =&gt; Nowait},
<a name="8662"/> 8662:                    ok = api_a_accept_cancel_tcp(InitState)
<a name="8663"/> 8663:            end).
<a name="8664"/> 8664: 
<a name="8665"/> 8665: 
<a name="8666"/> 8666: 
<a name="8667"/> 8667: 
<a name="8668"/> 8668: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8669"/> 8669: 
<a name="8670"/> 8670: <i>%% Basically we make an async (Timeout = nowait) call to accept,</i>
<a name="8671"/> 8671: <i>%% wait some time and then cancel. IPv6</i>
<a name="8672"/> 8672: <i>%%</i>
<a name="api_a_accept_cancel_tcp6-1"/><a name="8673"/> 8673: <b>api_a_accept_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="8674"/> 8674:     ?TT(?SECS(10)),
<a name="8675"/> 8675:     Nowait = nowait(Config),
<a name="api_a_accept_cancel_tcp6-last_expr"/><a name="8676"/> 8676: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8677"/> 8677:            fun() -&gt; has_support_ipv6() end,
<a name="8678"/> 8678:            fun() -&gt;
<a name="8679"/> 8679:                    Accept = fun(Sock) -&gt;
<a name="8680"/> 8680:                                     case socket:accept(Sock, Nowait) of
<a name="8681"/> 8681:                                         {ok, _} = OK -&gt;
<a name="8682"/> 8682:                                             OK;
<a name="8683"/> 8683:                                         {select, _} = SELECT -&gt;
<a name="8684"/> 8684:                                             SELECT;
<a name="8685"/> 8685:                                         {completion, _} = COMPLETION -&gt;
<a name="8686"/> 8686:                                             COMPLETION;
<a name="8687"/> 8687:                                         {error, _} = ERROR -&gt;
<a name="8688"/> 8688:                                             ERROR
<a name="8689"/> 8689:                                     end
<a name="8690"/> 8690:                             end,
<a name="8691"/> 8691:                    InitState = #{domain     =&gt; inet6,
<a name="8692"/> 8692:                                  accept     =&gt; Accept,
<a name="8693"/> 8693:                                  accept_ref =&gt; Nowait},
<a name="8694"/> 8694:                    ok = api_a_accept_cancel_tcp(InitState)
<a name="8695"/> 8695:            end).
<a name="8696"/> 8696: 
<a name="8697"/> 8697: 
<a name="8698"/> 8698: 
<a name="8699"/> 8699: 
<a name="8700"/> 8700: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8701"/> 8701: 
<a name="api_a_accept_cancel_tcp-1"/><a name="8702"/> 8702: <b>api_a_accept_cancel_tcp</b>(InitState) -&gt;
<a name="8703"/> 8703:     process_flag(trap_exit, true),
<a name="8704"/> 8704:     ServerSeq = 
<a name="8705"/> 8705:         [
<a name="8706"/> 8706:          %% *** Wait for start order ***
<a name="8707"/> 8707:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="8708"/> 8708:            cmd  =&gt; fun(State) -&gt;
<a name="8709"/> 8709:                            Tester = ?SEV_AWAIT_START(),
<a name="8710"/> 8710:                            {ok, State#{tester =&gt; Tester}}
<a name="8711"/> 8711:                    end},
<a name="8712"/> 8712:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="8713"/> 8713:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8714"/> 8714:                            _MRef = erlang:monitor(process, Tester),
<a name="8715"/> 8715:                            ok
<a name="8716"/> 8716:                    end},
<a name="8717"/> 8717: 
<a name="8718"/> 8718:          %% *** Init part ***
<a name="8719"/> 8719:          #{desc =&gt; &quot;which local address&quot;,
<a name="8720"/> 8720:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8721"/> 8721:                            LSA = which_local_socket_addr(Domain),
<a name="8722"/> 8722:                            {ok, State#{lsa =&gt; LSA}}
<a name="8723"/> 8723:                    end},
<a name="8724"/> 8724:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="8725"/> 8725:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8726"/> 8726:                            case socket:open(Domain, stream, tcp) of
<a name="8727"/> 8727:                                {ok, Sock} -&gt;
<a name="8728"/> 8728:                                    {ok, State#{lsock =&gt; Sock}};
<a name="8729"/> 8729:                                {error, _} = ERROR -&gt;
<a name="8730"/> 8730:                                    ERROR
<a name="8731"/> 8731:                            end
<a name="8732"/> 8732:                    end},
<a name="8733"/> 8733:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="8734"/> 8734:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="8735"/> 8735:                            case sock_bind(LSock, LSA) of
<a name="8736"/> 8736:                                ok -&gt;
<a name="8737"/> 8737:                                    Port = sock_port(LSock),
<a name="8738"/> 8738:                                    {ok, State#{lport =&gt; Port}};
<a name="8739"/> 8739:                                {error, _} = ERROR -&gt;
<a name="8740"/> 8740:                                    ERROR
<a name="8741"/> 8741:                            end
<a name="8742"/> 8742:                    end},
<a name="8743"/> 8743:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="8744"/> 8744:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="8745"/> 8745:                            socket:listen(LSock)
<a name="8746"/> 8746:                    end},
<a name="8747"/> 8747:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="8748"/> 8748:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="8749"/> 8749:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="8750"/> 8750:                            ok
<a name="8751"/> 8751:                    end},
<a name="8752"/> 8752: 
<a name="8753"/> 8753:          %% The actual test
<a name="8754"/> 8754:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="8755"/> 8755:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8756"/> 8756:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="8757"/> 8757:                    end},
<a name="8758"/> 8758:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="8759"/> 8759:            cmd  =&gt; fun(#{lsock      := LSock,
<a name="8760"/> 8760:                          accept     := Accept,
<a name="8761"/> 8761:                          accept_ref := Ref} = State) -&gt;
<a name="8762"/> 8762:                            case Accept(LSock) of
<a name="8763"/> 8763:                                {select, {select_info, T, R} = SI}
<a name="8764"/> 8764:                                  when Ref =:= nowait -&gt;
<a name="8765"/> 8765:                                    ?SEV_IPRINT(&quot;accept select nowait: &quot;
<a name="8766"/> 8766:                                                &quot;~n   T: ~p&quot;
<a name="8767"/> 8767:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="8768"/> 8768:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="8769"/> 8769:                                {select, {select_info, T, Ref} = SI}
<a name="8770"/> 8770:                                  when is_reference(Ref) -&gt;
<a name="8771"/> 8771:                                    ?SEV_IPRINT(&quot;accept select ref: &quot;
<a name="8772"/> 8772:                                                &quot;~n   T: ~p&quot;
<a name="8773"/> 8773:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="8774"/> 8774:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="8775"/> 8775: 
<a name="8776"/> 8776:                                {completion, {completion_info, T, R} = CI}
<a name="8777"/> 8777:                                  when Ref =:= nowait -&gt;
<a name="8778"/> 8778:                                    ?SEV_IPRINT(&quot;accept completion nowait: &quot;
<a name="8779"/> 8779:                                                &quot;~n   T: ~p&quot;
<a name="8780"/> 8780:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="8781"/> 8781:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="8782"/> 8782:                                {completion, {completion_info, T, Ref} = CI}
<a name="8783"/> 8783:                                  when is_reference(Ref) -&gt;
<a name="8784"/> 8784:                                    ?SEV_IPRINT(&quot;accept completion ref: &quot;
<a name="8785"/> 8785:                                                &quot;~n   T: ~p&quot;
<a name="8786"/> 8786:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="8787"/> 8787:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="8788"/> 8788: 
<a name="8789"/> 8789:                                {ok, X} -&gt;
<a name="8790"/> 8790:                                    {error, {unexpected_success, X}};
<a name="8791"/> 8791: 
<a name="8792"/> 8792:                                {error, _} = ERROR -&gt;
<a name="8793"/> 8793:                                    ERROR
<a name="8794"/> 8794:                            end
<a name="8795"/> 8795:                    end},
<a name="8796"/> 8796:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="8797"/> 8797:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8798"/> 8798:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="8799"/> 8799:                            ok
<a name="8800"/> 8800:                    end},
<a name="8801"/> 8801:          #{desc =&gt; &quot;await select message (without success)&quot;,
<a name="8802"/> 8802:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="8803"/> 8803:                            receive
<a name="8804"/> 8804:                                {'$socket', Sock, select, Ref} -&gt;
<a name="8805"/> 8805:                                    {error, {unexpected_select, Ref}};
<a name="8806"/> 8806: 
<a name="8807"/> 8807:                                {'$socket', Sock, completion, C} -&gt;
<a name="8808"/> 8808:                                    {error, {unexpected_completion, C}}
<a name="8809"/> 8809: 
<a name="8810"/> 8810:                            after 5000 -&gt;
<a name="8811"/> 8811:                                    ok
<a name="8812"/> 8812:                            end
<a name="8813"/> 8813:                    end},
<a name="8814"/> 8814:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="8815"/> 8815:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8816"/> 8816:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="8817"/> 8817:                            ok
<a name="8818"/> 8818:                    end},
<a name="8819"/> 8819:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="8820"/> 8820:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8821"/> 8821:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="8822"/> 8822:                    end},
<a name="8823"/> 8823:          #{desc =&gt; &quot;cancel&quot;,
<a name="8824"/> 8824:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="8825"/> 8825:                          accept_select_info := SelectInfo}) -&gt;
<a name="8826"/> 8826:                            ok = socket:cancel(Sock, SelectInfo);
<a name="8827"/> 8827:                       (#{lsock                  := Sock,
<a name="8828"/> 8828:                          accept_completion_info := CompletionInfo}) -&gt;
<a name="8829"/> 8829:                            ok = socket:cancel(Sock, CompletionInfo)
<a name="8830"/> 8830:                    end},
<a name="8831"/> 8831:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="8832"/> 8832:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8833"/> 8833:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="8834"/> 8834:                            ok
<a name="8835"/> 8835:                    end},
<a name="8836"/> 8836: 
<a name="8837"/> 8837:          %% *** Termination ***
<a name="8838"/> 8838:          #{desc =&gt; &quot;await terminate&quot;,
<a name="8839"/> 8839:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8840"/> 8840:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8841"/> 8841:                                ok -&gt;
<a name="8842"/> 8842:                                    {ok, maps:remove(tester, State)};
<a name="8843"/> 8843:                                {error, _} = ERROR -&gt;
<a name="8844"/> 8844:                                    ERROR
<a name="8845"/> 8845:                            end
<a name="8846"/> 8846:                    end},
<a name="8847"/> 8847:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="8848"/> 8848:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="8849"/> 8849:                            socket:close(Sock)
<a name="8850"/> 8850:                    end},
<a name="8851"/> 8851: 
<a name="8852"/> 8852:          %% *** We are done ***
<a name="8853"/> 8853:          ?SEV_FINISH_NORMAL
<a name="8854"/> 8854:         ],
<a name="8855"/> 8855: 
<a name="8856"/> 8856: 
<a name="8857"/> 8857:     TesterSeq =
<a name="8858"/> 8858:         [
<a name="8859"/> 8859:          %% *** Init part ***
<a name="8860"/> 8860:          #{desc =&gt; &quot;monitor server&quot;,
<a name="8861"/> 8861:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8862"/> 8862:                            _MRef = erlang:monitor(process, Pid),
<a name="8863"/> 8863:                            ok
<a name="8864"/> 8864:                    end},
<a name="8865"/> 8865: 
<a name="8866"/> 8866:          %% Start the server
<a name="8867"/> 8867:          #{desc =&gt; &quot;order server start&quot;,
<a name="8868"/> 8868:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8869"/> 8869:                            ?SEV_ANNOUNCE_START(Pid),
<a name="8870"/> 8870:                            ok
<a name="8871"/> 8871:                    end},
<a name="8872"/> 8872:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="8873"/> 8873:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8874"/> 8874:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="8875"/> 8875:                            {ok, State#{server_port =&gt; Port}}
<a name="8876"/> 8876:                    end},
<a name="8877"/> 8877: 
<a name="8878"/> 8878:          %% *** The actual test ***
<a name="8879"/> 8879:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="8880"/> 8880:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="8881"/> 8881:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="8882"/> 8882:                            ok
<a name="8883"/> 8883:                    end},
<a name="8884"/> 8884:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="8885"/> 8885:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8886"/> 8886:                            ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="8887"/> 8887:                    end},
<a name="8888"/> 8888:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="8889"/> 8889:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8890"/> 8890:                            ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="8891"/> 8891:                    end},
<a name="8892"/> 8892:          #{desc =&gt; &quot;order server to continue (cancel)&quot;,
<a name="8893"/> 8893:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8894"/> 8894:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="8895"/> 8895:                            ok
<a name="8896"/> 8896:                    end},
<a name="8897"/> 8897:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="8898"/> 8898:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8899"/> 8899:                            ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="8900"/> 8900:                    end},
<a name="8901"/> 8901: 
<a name="8902"/> 8902:          %% *** Termination ***
<a name="8903"/> 8903:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="8904"/> 8904:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="8905"/> 8905:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="8906"/> 8906:                            ok
<a name="8907"/> 8907:                    end},
<a name="8908"/> 8908:          #{desc =&gt; &quot;await server termination&quot;,
<a name="8909"/> 8909:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="8910"/> 8910:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="8911"/> 8911:                            State1 = maps:remove(server, State),
<a name="8912"/> 8912:                            {ok, State1}
<a name="8913"/> 8913:                    end},
<a name="8914"/> 8914: 
<a name="8915"/> 8915:          %% *** We are done ***
<a name="8916"/> 8916:          ?SEV_FINISH_NORMAL
<a name="8917"/> 8917:         ],
<a name="8918"/> 8918: 
<a name="8919"/> 8919:     i(&quot;start server evaluator&quot;),
<a name="8920"/> 8920:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="8921"/> 8921: 
<a name="8922"/> 8922:     i(&quot;start tester evaluator&quot;),
<a name="8923"/> 8923:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="8924"/> 8924:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="8925"/> 8925: 
<a name="8926"/> 8926:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_accept_cancel_tcp-last_expr"/><a name="8927"/> 8927: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="8928"/> 8928: 
<a name="8929"/> 8929: 
<a name="8930"/> 8930: 
<a name="8931"/> 8931: 
<a name="8932"/> 8932: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8933"/> 8933: 
<a name="8934"/> 8934: <i>%% Basically we make an async (Timeout = nowait) call to recv,</i>
<a name="8935"/> 8935: <i>%% wait some time and then cancel. IPv4</i>
<a name="8936"/> 8936: <i>%%</i>
<a name="api_a_recv_cancel_tcp4-1"/><a name="8937"/> 8937: <b>api_a_recv_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="8938"/> 8938:     ?TT(?SECS(10)),
<a name="8939"/> 8939:     Nowait = nowait(Config),
<a name="api_a_recv_cancel_tcp4-last_expr"/><a name="8940"/> 8940: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8941"/> 8941:            fun() -&gt; has_support_ipv4() end,
<a name="8942"/> 8942:            fun() -&gt;
<a name="8943"/> 8943:                    Recv = fun(Sock) -&gt;
<a name="8944"/> 8944:                                   socket:recv(Sock, 0, Nowait)
<a name="8945"/> 8945:                           end,
<a name="8946"/> 8946:                    InitState = #{domain   =&gt; inet,
<a name="8947"/> 8947:                                  recv     =&gt; Recv,
<a name="8948"/> 8948:                                  recv_ref =&gt; Nowait},
<a name="8949"/> 8949:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="8950"/> 8950:            end).
<a name="8951"/> 8951: 
<a name="8952"/> 8952: 
<a name="8953"/> 8953: 
<a name="8954"/> 8954: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8955"/> 8955: 
<a name="8956"/> 8956: <i>%% Basically we make an async (Timeout = nowait) call to recv,</i>
<a name="8957"/> 8957: <i>%% wait some time and then cancel. IPv6</i>
<a name="8958"/> 8958: <i>%%</i>
<a name="api_a_recv_cancel_tcp6-1"/><a name="8959"/> 8959: <b>api_a_recv_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="8960"/> 8960:     ?TT(?SECS(10)),
<a name="8961"/> 8961:     Nowait = nowait(Config),
<a name="api_a_recv_cancel_tcp6-last_expr"/><a name="8962"/> 8962: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8963"/> 8963:            fun() -&gt; has_support_ipv6() end,
<a name="8964"/> 8964:            fun() -&gt;
<a name="8965"/> 8965:                    Recv = fun(Sock) -&gt;
<a name="8966"/> 8966:                                   socket:recv(Sock, 0, Nowait)
<a name="8967"/> 8967:                           end,
<a name="8968"/> 8968:                    InitState = #{domain   =&gt; inet6,
<a name="8969"/> 8969:                                  recv     =&gt; Recv,
<a name="8970"/> 8970:                                  recv_ref =&gt; Nowait},
<a name="8971"/> 8971:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="8972"/> 8972:            end).
<a name="8973"/> 8973: 
<a name="8974"/> 8974: 
<a name="8975"/> 8975: 
<a name="8976"/> 8976: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8977"/> 8977: 
<a name="8978"/> 8978: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="8979"/> 8979: <i>%% wait some time and then cancel. IPv4</i>
<a name="8980"/> 8980: <i>%%</i>
<a name="api_a_recvmsg_cancel_tcp4-1"/><a name="8981"/> 8981: <b>api_a_recvmsg_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="8982"/> 8982:     ?TT(?SECS(10)),
<a name="8983"/> 8983:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_tcp4-last_expr"/><a name="8984"/> 8984: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="8985"/> 8985:            fun() -&gt;
<a name="8986"/> 8986:                    is_not_windows(),
<a name="8987"/> 8987:                    has_support_ipv4()
<a name="8988"/> 8988:            end,
<a name="8989"/> 8989:            fun() -&gt;
<a name="8990"/> 8990:                    Recv = fun(Sock) -&gt;
<a name="8991"/> 8991:                                   socket:recvmsg(Sock, Nowait)
<a name="8992"/> 8992:                           end,
<a name="8993"/> 8993:                    InitState = #{domain   =&gt; inet,
<a name="8994"/> 8994:                                  recv     =&gt; Recv,
<a name="8995"/> 8995:                                  recv_ref =&gt; Nowait},
<a name="8996"/> 8996:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="8997"/> 8997:            end).
<a name="8998"/> 8998: 
<a name="8999"/> 8999: 
<a name="9000"/> 9000: 
<a name="9001"/> 9001: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9002"/> 9002: 
<a name="9003"/> 9003: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="9004"/> 9004: <i>%% wait some time and then cancel. IPv6</i>
<a name="9005"/> 9005: <i>%%</i>
<a name="api_a_recvmsg_cancel_tcp6-1"/><a name="9006"/> 9006: <b>api_a_recvmsg_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="9007"/> 9007:     ?TT(?SECS(10)),
<a name="9008"/> 9008:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_tcp6-last_expr"/><a name="9009"/> 9009: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9010"/> 9010:            fun() -&gt;
<a name="9011"/> 9011:                    is_not_windows(),
<a name="9012"/> 9012:                    has_support_ipv6()
<a name="9013"/> 9013:            end,
<a name="9014"/> 9014:            fun() -&gt;
<a name="9015"/> 9015:                    Recv = fun(Sock) -&gt;
<a name="9016"/> 9016:                                   socket:recvmsg(Sock, Nowait)
<a name="9017"/> 9017:                           end,
<a name="9018"/> 9018:                    InitState = #{domain   =&gt; inet6,
<a name="9019"/> 9019:                                  recv     =&gt; Recv,
<a name="9020"/> 9020:                                  recv_ref =&gt; Nowait},
<a name="9021"/> 9021:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="9022"/> 9022:            end).
<a name="9023"/> 9023: 
<a name="9024"/> 9024: 
<a name="9025"/> 9025: 
<a name="9026"/> 9026: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9027"/> 9027: 
<a name="api_a_recv_cancel_tcp-1"/><a name="9028"/> 9028: <b>api_a_recv_cancel_tcp</b>(InitState) -&gt;
<a name="9029"/> 9029:     process_flag(trap_exit, true),
<a name="9030"/> 9030:     ServerSeq = 
<a name="9031"/> 9031:         [
<a name="9032"/> 9032:          %% *** Wait for start order ***
<a name="9033"/> 9033:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="9034"/> 9034:            cmd  =&gt; fun(State) -&gt;
<a name="9035"/> 9035:                            Tester = ?SEV_AWAIT_START(),
<a name="9036"/> 9036:                            {ok, State#{tester =&gt; Tester}}
<a name="9037"/> 9037:                    end},
<a name="9038"/> 9038:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9039"/> 9039:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9040"/> 9040:                            _MRef = erlang:monitor(process, Tester),
<a name="9041"/> 9041:                            ok
<a name="9042"/> 9042:                    end},
<a name="9043"/> 9043: 
<a name="9044"/> 9044:          %% *** Init part ***
<a name="9045"/> 9045:          #{desc =&gt; &quot;which local address&quot;,
<a name="9046"/> 9046:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9047"/> 9047:                            LSA = which_local_socket_addr(Domain),
<a name="9048"/> 9048:                            {ok, State#{lsa =&gt; LSA}}
<a name="9049"/> 9049:                    end},
<a name="9050"/> 9050:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="9051"/> 9051:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9052"/> 9052:                            case socket:open(Domain, stream, tcp) of
<a name="9053"/> 9053:                                {ok, Sock} -&gt;
<a name="9054"/> 9054:                                    {ok, State#{lsock =&gt; Sock}};
<a name="9055"/> 9055:                                {error, _} = ERROR -&gt;
<a name="9056"/> 9056:                                    ERROR
<a name="9057"/> 9057:                            end
<a name="9058"/> 9058:                    end},
<a name="9059"/> 9059:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="9060"/> 9060:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="9061"/> 9061:                            case sock_bind(LSock, LSA) of
<a name="9062"/> 9062:                                ok -&gt;
<a name="9063"/> 9063:                                    Port = sock_port(LSock),
<a name="9064"/> 9064:                                    {ok, State#{lport =&gt; Port}};
<a name="9065"/> 9065:                                {error, _} = ERROR -&gt;
<a name="9066"/> 9066:                                    ERROR
<a name="9067"/> 9067:                            end
<a name="9068"/> 9068:                    end},
<a name="9069"/> 9069:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="9070"/> 9070:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="9071"/> 9071:                            socket:listen(LSock)
<a name="9072"/> 9072:                    end},
<a name="9073"/> 9073:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9074"/> 9074:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="9075"/> 9075:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="9076"/> 9076:                            ok
<a name="9077"/> 9077:                    end},
<a name="9078"/> 9078: 
<a name="9079"/> 9079:          %% The actual test
<a name="9080"/> 9080:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="9081"/> 9081:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9082"/> 9082:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="9083"/> 9083:                    end},
<a name="9084"/> 9084:          #{desc =&gt; &quot;await connection&quot;,
<a name="9085"/> 9085:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="9086"/> 9086:                            case socket:accept(LSock) of
<a name="9087"/> 9087:                                {ok, CSock} -&gt;
<a name="9088"/> 9088:                                    {ok, State#{csock =&gt; CSock}};
<a name="9089"/> 9089:                                {error, _} = ERROR -&gt;
<a name="9090"/> 9090:                                    ERROR
<a name="9091"/> 9091:                            end
<a name="9092"/> 9092:                    end},
<a name="9093"/> 9093:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="9094"/> 9094:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9095"/> 9095:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="9096"/> 9096:                            ok
<a name="9097"/> 9097:                    end},
<a name="9098"/> 9098: 
<a name="9099"/> 9099:          #{desc =&gt; &quot;await continue (nowait recv)&quot;,
<a name="9100"/> 9100:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9101"/> 9101:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="9102"/> 9102:                    end},
<a name="9103"/> 9103: 
<a name="9104"/> 9104:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="9105"/> 9105:            cmd  =&gt; fun(#{csock    := Sock,
<a name="9106"/> 9106:                          recv     := Recv,
<a name="9107"/> 9107:                          recv_ref := Ref} = State) -&gt;
<a name="9108"/> 9108:                            case Recv(Sock) of
<a name="9109"/> 9109:                                {select, {select_info, T, R} = SI}
<a name="9110"/> 9110:                                  when Ref =:= nowait -&gt;
<a name="9111"/> 9111:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="9112"/> 9112:                                                &quot;~n   Tag: ~p&quot;
<a name="9113"/> 9113:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="9114"/> 9114:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9115"/> 9115:                                {select, {select_info, T, Ref} = SI}
<a name="9116"/> 9116:                                  when is_reference(Ref) -&gt;
<a name="9117"/> 9117:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="9118"/> 9118:                                                &quot;~n   Tag: ~p&quot;
<a name="9119"/> 9119:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="9120"/> 9120:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9121"/> 9121: 
<a name="9122"/> 9122:                                {completion,
<a name="9123"/> 9123:                                 {completion_info, T, R} = CI}
<a name="9124"/> 9124:                                  when Ref =:= nowait -&gt;
<a name="9125"/> 9125:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="9126"/> 9126:                                                &quot;~n   Tag: ~p&quot;
<a name="9127"/> 9127:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="9128"/> 9128:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9129"/> 9129:                                {completion,
<a name="9130"/> 9130:                                 {completion_info, T, Ref} = CI}
<a name="9131"/> 9131:                                  when is_reference(Ref) -&gt;
<a name="9132"/> 9132:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="9133"/> 9133:                                                &quot;~n   Tag: ~p&quot;
<a name="9134"/> 9134:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="9135"/> 9135:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9136"/> 9136: 
<a name="9137"/> 9137:                                {ok, X} -&gt;
<a name="9138"/> 9138:                                    {error, {unexpected_success, X}};
<a name="9139"/> 9139: 
<a name="9140"/> 9140:                                {error, _} = ERROR -&gt;
<a name="9141"/> 9141:                                    ERROR
<a name="9142"/> 9142:                            end
<a name="9143"/> 9143:                    end},
<a name="9144"/> 9144:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="9145"/> 9145:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9146"/> 9146:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="9147"/> 9147:                            ok
<a name="9148"/> 9148:                    end},
<a name="9149"/> 9149:          #{desc =&gt; &quot;await select message&quot;,
<a name="9150"/> 9150:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="9151"/> 9151:                            receive
<a name="9152"/> 9152:                                {'$socket', Sock, select, Ref} -&gt;
<a name="9153"/> 9153:                                    {error, {unexpected_select, Ref}};
<a name="9154"/> 9154: 
<a name="9155"/> 9155:                                {'$socket', Sock, completion, C} -&gt;
<a name="9156"/> 9156:                                    {error, {unexpected_completion, C}}
<a name="9157"/> 9157: 
<a name="9158"/> 9158:                            after 5000 -&gt;
<a name="9159"/> 9159:                                    ok
<a name="9160"/> 9160:                            end
<a name="9161"/> 9161:                    end},
<a name="9162"/> 9162:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="9163"/> 9163:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9164"/> 9164:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="9165"/> 9165:                            ok
<a name="9166"/> 9166:                    end},
<a name="9167"/> 9167:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="9168"/> 9168:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9169"/> 9169:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="9170"/> 9170:                    end},
<a name="9171"/> 9171:          #{desc =&gt; &quot;cancel&quot;,
<a name="9172"/> 9172:            cmd  =&gt; fun(#{csock := Sock, recv_select_info := SI}) -&gt;
<a name="9173"/> 9173:                            ok = socket:cancel(Sock, SI);
<a name="9174"/> 9174: 
<a name="9175"/> 9175:                       (#{csock := Sock, recv_completion_info := CI}) -&gt;
<a name="9176"/> 9176:                            ok = socket:cancel(Sock, CI)
<a name="9177"/> 9177:                    end},
<a name="9178"/> 9178:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="9179"/> 9179:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9180"/> 9180:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="9181"/> 9181:                            ok
<a name="9182"/> 9182:                    end},
<a name="9183"/> 9183: 
<a name="9184"/> 9184:          %% *** Termination ***
<a name="9185"/> 9185:          #{desc =&gt; &quot;await terminate&quot;,
<a name="9186"/> 9186:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9187"/> 9187:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9188"/> 9188:                                ok -&gt;
<a name="9189"/> 9189:                                    {ok, maps:remove(tester, State)};
<a name="9190"/> 9190:                                {error, _} = ERROR -&gt;
<a name="9191"/> 9191:                                    ERROR
<a name="9192"/> 9192:                            end
<a name="9193"/> 9193:                    end},
<a name="9194"/> 9194:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="9195"/> 9195:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="9196"/> 9196:                            socket:close(Sock)
<a name="9197"/> 9197:                    end},
<a name="9198"/> 9198:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="9199"/> 9199:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="9200"/> 9200:                            socket:close(Sock)
<a name="9201"/> 9201:                    end},
<a name="9202"/> 9202: 
<a name="9203"/> 9203:          %% *** We are done ***
<a name="9204"/> 9204:          ?SEV_FINISH_NORMAL
<a name="9205"/> 9205:         ],
<a name="9206"/> 9206: 
<a name="9207"/> 9207: 
<a name="9208"/> 9208:     ClientSeq = 
<a name="9209"/> 9209:         [
<a name="9210"/> 9210:          %% *** Wait for start order ***
<a name="9211"/> 9211:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="9212"/> 9212:            cmd  =&gt; fun(State) -&gt;
<a name="9213"/> 9213:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="9214"/> 9214:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="9215"/> 9215:                    end},
<a name="9216"/> 9216:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9217"/> 9217:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9218"/> 9218:                            _MRef = erlang:monitor(process, Tester),
<a name="9219"/> 9219:                            ok
<a name="9220"/> 9220:                    end},
<a name="9221"/> 9221: 
<a name="9222"/> 9222:          %% *** The init part ***
<a name="9223"/> 9223:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="9224"/> 9224:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="9225"/> 9225:                            LSA = which_local_socket_addr(Domain),
<a name="9226"/> 9226:                            SSA = LSA#{port =&gt; Port},
<a name="9227"/> 9227:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="9228"/> 9228:                    end},
<a name="9229"/> 9229:          #{desc =&gt; &quot;create socket&quot;,
<a name="9230"/> 9230:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9231"/> 9231:                            case socket:open(Domain, stream, tcp) of
<a name="9232"/> 9232:                                {ok, Sock} -&gt;
<a name="9233"/> 9233:                                    {ok, State#{sock =&gt; Sock}};
<a name="9234"/> 9234:                                {error, _} = ERROR -&gt;
<a name="9235"/> 9235:                                    ERROR
<a name="9236"/> 9236:                            end
<a name="9237"/> 9237:                    end},
<a name="9238"/> 9238:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="9239"/> 9239:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="9240"/> 9240:                            case sock_bind(Sock, LSA) of
<a name="9241"/> 9241:                                ok -&gt;
<a name="9242"/> 9242:                                    ok;
<a name="9243"/> 9243:                                {error, _} = ERROR -&gt;
<a name="9244"/> 9244:                                    ERROR
<a name="9245"/> 9245:                            end
<a name="9246"/> 9246:                    end},
<a name="9247"/> 9247:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9248"/> 9248:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9249"/> 9249:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="9250"/> 9250:                            ok
<a name="9251"/> 9251:                    end},
<a name="9252"/> 9252: 
<a name="9253"/> 9253:          %% *** The actual test ***
<a name="9254"/> 9254:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="9255"/> 9255:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9256"/> 9256:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="9257"/> 9257:                    end},
<a name="9258"/> 9258:          #{desc =&gt; &quot;connect to server&quot;,
<a name="9259"/> 9259:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="9260"/> 9260:                            socket:connect(Sock, SSA)
<a name="9261"/> 9261:                    end},
<a name="9262"/> 9262:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="9263"/> 9263:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9264"/> 9264:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="9265"/> 9265:                            ok
<a name="9266"/> 9266:                    end},
<a name="9267"/> 9267: 
<a name="9268"/> 9268:          %% *** Termination ***
<a name="9269"/> 9269:          #{desc =&gt; &quot;await terminate&quot;,
<a name="9270"/> 9270:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9271"/> 9271:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9272"/> 9272:                                ok -&gt;
<a name="9273"/> 9273:                                    {ok, maps:remove(tester, State)};
<a name="9274"/> 9274:                                {error, _} = ERROR -&gt;
<a name="9275"/> 9275:                                    ERROR
<a name="9276"/> 9276:                            end
<a name="9277"/> 9277:                    end},
<a name="9278"/> 9278:          #{desc =&gt; &quot;close socket&quot;,
<a name="9279"/> 9279:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="9280"/> 9280:                            socket:close(Sock)
<a name="9281"/> 9281:                    end},
<a name="9282"/> 9282: 
<a name="9283"/> 9283:          %% *** We are done ***
<a name="9284"/> 9284:          ?SEV_FINISH_NORMAL
<a name="9285"/> 9285:         ],
<a name="9286"/> 9286: 
<a name="9287"/> 9287:     TesterSeq =
<a name="9288"/> 9288:         [
<a name="9289"/> 9289:          %% *** Init part ***
<a name="9290"/> 9290:          #{desc =&gt; &quot;monitor server&quot;,
<a name="9291"/> 9291:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9292"/> 9292:                            _MRef = erlang:monitor(process, Pid),
<a name="9293"/> 9293:                            ok
<a name="9294"/> 9294:                    end},
<a name="9295"/> 9295:          #{desc =&gt; &quot;monitor client&quot;,
<a name="9296"/> 9296:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9297"/> 9297:                            _MRef = erlang:monitor(process, Pid),
<a name="9298"/> 9298:                            ok
<a name="9299"/> 9299:                    end},
<a name="9300"/> 9300: 
<a name="9301"/> 9301:          %% Start the server
<a name="9302"/> 9302:          #{desc =&gt; &quot;order server start&quot;,
<a name="9303"/> 9303:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9304"/> 9304:                            ?SEV_ANNOUNCE_START(Pid),
<a name="9305"/> 9305:                            ok
<a name="9306"/> 9306:                    end},
<a name="9307"/> 9307:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="9308"/> 9308:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9309"/> 9309:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="9310"/> 9310:                            {ok, State#{server_port =&gt; Port}}
<a name="9311"/> 9311:                    end},
<a name="9312"/> 9312: 
<a name="9313"/> 9313:          %% Start the client
<a name="9314"/> 9314:          #{desc =&gt; &quot;order client start&quot;,
<a name="9315"/> 9315:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="9316"/> 9316:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="9317"/> 9317:                            ok
<a name="9318"/> 9318:                    end},
<a name="9319"/> 9319:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="9320"/> 9320:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9321"/> 9321:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="9322"/> 9322:                    end},
<a name="9323"/> 9323: 
<a name="9324"/> 9324:          %% *** The actual test ***
<a name="9325"/> 9325:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="9326"/> 9326:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="9327"/> 9327:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="9328"/> 9328:                            ok
<a name="9329"/> 9329:                    end},
<a name="9330"/> 9330:          #{desc =&gt; &quot;order client to continue (connect)&quot;,
<a name="9331"/> 9331:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9332"/> 9332:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="9333"/> 9333:                            ok
<a name="9334"/> 9334:                    end},
<a name="9335"/> 9335:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="9336"/> 9336:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9337"/> 9337:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="9338"/> 9338:                    end},
<a name="9339"/> 9339:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="9340"/> 9340:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9341"/> 9341:                            ?SEV_AWAIT_READY(Pid, server, accept)
<a name="9342"/> 9342:                    end},
<a name="9343"/> 9343: 
<a name="9344"/> 9344:          #{desc =&gt; &quot;order server to continue (recv)&quot;,
<a name="9345"/> 9345:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9346"/> 9346:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9347"/> 9347:                            ok
<a name="9348"/> 9348:                    end},
<a name="9349"/> 9349:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="9350"/> 9350:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9351"/> 9351:                            ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="9352"/> 9352:                    end},
<a name="9353"/> 9353:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="9354"/> 9354:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9355"/> 9355:                            ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="9356"/> 9356:                    end},
<a name="9357"/> 9357:          #{desc =&gt; &quot;order server to continue (send request)&quot;,
<a name="9358"/> 9358:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9359"/> 9359:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="9360"/> 9360:                            ok
<a name="9361"/> 9361:                    end},
<a name="9362"/> 9362:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="9363"/> 9363:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9364"/> 9364:                            ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="9365"/> 9365:                    end},
<a name="9366"/> 9366: 
<a name="9367"/> 9367:          %% *** Termination ***
<a name="9368"/> 9368:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="9369"/> 9369:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="9370"/> 9370:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="9371"/> 9371:                            ok
<a name="9372"/> 9372:                    end},
<a name="9373"/> 9373:          #{desc =&gt; &quot;await client termination&quot;,
<a name="9374"/> 9374:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="9375"/> 9375:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="9376"/> 9376:                            State1 = maps:remove(client, State),
<a name="9377"/> 9377:                            {ok, State1}
<a name="9378"/> 9378:                    end},
<a name="9379"/> 9379:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="9380"/> 9380:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="9381"/> 9381:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="9382"/> 9382:                            ok
<a name="9383"/> 9383:                    end},
<a name="9384"/> 9384:          #{desc =&gt; &quot;await server termination&quot;,
<a name="9385"/> 9385:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="9386"/> 9386:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="9387"/> 9387:                            State1 = maps:remove(server, State),
<a name="9388"/> 9388:                            {ok, State1}
<a name="9389"/> 9389:                    end},
<a name="9390"/> 9390: 
<a name="9391"/> 9391:          %% *** We are done ***
<a name="9392"/> 9392:          ?SEV_FINISH_NORMAL
<a name="9393"/> 9393:         ],
<a name="9394"/> 9394: 
<a name="9395"/> 9395:     i(&quot;start server evaluator&quot;),
<a name="9396"/> 9396:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="9397"/> 9397: 
<a name="9398"/> 9398:     i(&quot;start client evaluator&quot;),
<a name="9399"/> 9399:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="9400"/> 9400: 
<a name="9401"/> 9401:     i(&quot;start tester evaluator&quot;),
<a name="9402"/> 9402:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="9403"/> 9403:                         client =&gt; Client#ev.pid},
<a name="9404"/> 9404:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="9405"/> 9405: 
<a name="9406"/> 9406:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_recv_cancel_tcp-last_expr"/><a name="9407"/> 9407: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="9408"/> 9408: 
<a name="9409"/> 9409: 
<a name="9410"/> 9410: 
<a name="9411"/> 9411: 
<a name="9412"/> 9412: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9413"/> 9413: 
<a name="9414"/> 9414: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvfrom</i>
<a name="9415"/> 9415: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="9416"/> 9416: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="9417"/> 9417: <i>%%</i>
<a name="api_a_mrecvfrom_cancel_udp4-1"/><a name="9418"/> 9418: <b>api_a_mrecvfrom_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="9419"/> 9419:     ?TT(?SECS(20)),
<a name="9420"/> 9420:     Nowait = nowait(Config),
<a name="api_a_mrecvfrom_cancel_udp4-last_expr"/><a name="9421"/> 9421: <b>    tc_try</b>(api_a_mrecvfrom_cancel_udp4,
<a name="9422"/> 9422:            fun() -&gt; has_support_ipv4() end,
<a name="9423"/> 9423:            fun() -&gt;
<a name="9424"/> 9424:                    Recv = fun(Sock) -&gt;
<a name="9425"/> 9425:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="9426"/> 9426:                                       {ok, _} = OK -&gt;
<a name="9427"/> 9427:                                           OK;
<a name="9428"/> 9428:                                       {select, _} = SELECT -&gt;
<a name="9429"/> 9429:                                           SELECT;
<a name="9430"/> 9430:                                       {completion, _} = COMPLETION -&gt;
<a name="9431"/> 9431:                                           COMPLETION;
<a name="9432"/> 9432:                                       {error, _} = ERROR -&gt;
<a name="9433"/> 9433:                                           ERROR
<a name="9434"/> 9434:                                   end
<a name="9435"/> 9435:                           end,
<a name="9436"/> 9436:                    InitState = #{domain   =&gt; inet,
<a name="9437"/> 9437:                                  recv     =&gt; Recv,
<a name="9438"/> 9438:                                  recv_ref =&gt; Nowait},
<a name="9439"/> 9439:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="9440"/> 9440:            end).
<a name="9441"/> 9441: 
<a name="9442"/> 9442: 
<a name="9443"/> 9443: 
<a name="9444"/> 9444: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9445"/> 9445: 
<a name="9446"/> 9446: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvfrom</i>
<a name="9447"/> 9447: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="9448"/> 9448: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="9449"/> 9449: <i>%%</i>
<a name="api_a_mrecvfrom_cancel_udp6-1"/><a name="9450"/> 9450: <b>api_a_mrecvfrom_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="9451"/> 9451:     ?TT(?SECS(20)),
<a name="9452"/> 9452:     Nowait = nowait(Config),
<a name="api_a_mrecvfrom_cancel_udp6-last_expr"/><a name="9453"/> 9453: <b>    tc_try</b>(api_a_mrecvfrom_cancel_udp6,
<a name="9454"/> 9454:            fun() -&gt; has_support_ipv6() end,
<a name="9455"/> 9455:            fun() -&gt;
<a name="9456"/> 9456:                    Recv = fun(Sock) -&gt;
<a name="9457"/> 9457:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="9458"/> 9458:                                       {ok, _} = OK -&gt;
<a name="9459"/> 9459:                                           OK;
<a name="9460"/> 9460:                                       {select, _} = SELECT -&gt;
<a name="9461"/> 9461:                                           SELECT;
<a name="9462"/> 9462:                                       {completion, _} = COMPLETION -&gt;
<a name="9463"/> 9463:                                           COMPLETION;
<a name="9464"/> 9464:                                       {error, _} = ERROR -&gt;
<a name="9465"/> 9465:                                           ERROR
<a name="9466"/> 9466:                                   end
<a name="9467"/> 9467:                           end,
<a name="9468"/> 9468:                    InitState = #{domain   =&gt; inet6,
<a name="9469"/> 9469:                                  recv     =&gt; Recv,
<a name="9470"/> 9470:                                  recv_ref =&gt; Nowait},
<a name="9471"/> 9471:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="9472"/> 9472:            end).
<a name="9473"/> 9473: 
<a name="9474"/> 9474: 
<a name="9475"/> 9475: 
<a name="9476"/> 9476: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9477"/> 9477: 
<a name="9478"/> 9478: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="9479"/> 9479: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="9480"/> 9480: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="9481"/> 9481: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_udp4-1"/><a name="9482"/> 9482: <b>api_a_mrecvmsg_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="9483"/> 9483:     ?TT(?SECS(20)),
<a name="9484"/> 9484:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_udp4-last_expr"/><a name="9485"/> 9485: <b>    tc_try</b>(api_a_mrecvmsg_cancel_udp4,
<a name="9486"/> 9486:            fun() -&gt; has_support_ipv4() end,
<a name="9487"/> 9487:            fun() -&gt;
<a name="9488"/> 9488:                    Recv = fun(Sock) -&gt;
<a name="9489"/> 9489:                                   case socket:recvmsg(Sock, Nowait) of
<a name="9490"/> 9490:                                       {ok, _} = OK -&gt;
<a name="9491"/> 9491:                                           OK;
<a name="9492"/> 9492:                                       {select, _} = SELECT -&gt;
<a name="9493"/> 9493:                                           SELECT;
<a name="9494"/> 9494:                                       {completion, _} = COMPLETION -&gt;
<a name="9495"/> 9495:                                           COMPLETION;
<a name="9496"/> 9496:                                       {error, _} = ERROR -&gt;
<a name="9497"/> 9497:                                           ERROR
<a name="9498"/> 9498:                                   end
<a name="9499"/> 9499:                           end,
<a name="9500"/> 9500:                    InitState = #{domain   =&gt; inet,
<a name="9501"/> 9501:                                  recv     =&gt; Recv,
<a name="9502"/> 9502:                                  recv_ref =&gt; Nowait},
<a name="9503"/> 9503:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="9504"/> 9504:            end).
<a name="9505"/> 9505: 
<a name="9506"/> 9506: 
<a name="9507"/> 9507: 
<a name="9508"/> 9508: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9509"/> 9509: 
<a name="9510"/> 9510: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="9511"/> 9511: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="9512"/> 9512: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="9513"/> 9513: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_udp6-1"/><a name="9514"/> 9514: <b>api_a_mrecvmsg_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="9515"/> 9515:     ?TT(?SECS(20)),
<a name="9516"/> 9516:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_udp6-last_expr"/><a name="9517"/> 9517: <b>    tc_try</b>(api_a_mrecvmsg_cancel_udp6,
<a name="9518"/> 9518:            fun() -&gt; has_support_ipv6() end,
<a name="9519"/> 9519:            fun() -&gt;
<a name="9520"/> 9520:                    Recv = fun(Sock) -&gt;
<a name="9521"/> 9521:                                   case socket:recvmsg(Sock, Nowait) of
<a name="9522"/> 9522:                                       {ok, _} = OK -&gt;
<a name="9523"/> 9523:                                           OK;
<a name="9524"/> 9524:                                       {select, _} = SELECT -&gt;
<a name="9525"/> 9525:                                           SELECT;
<a name="9526"/> 9526:                                       {completion, _} = COMPLETION -&gt;
<a name="9527"/> 9527:                                           COMPLETION;
<a name="9528"/> 9528:                                       {error, _} = ERROR -&gt;
<a name="9529"/> 9529:                                           ERROR
<a name="9530"/> 9530:                                   end
<a name="9531"/> 9531:                           end,
<a name="9532"/> 9532:                    InitState = #{domain   =&gt; inet6,
<a name="9533"/> 9533:                                  recv     =&gt; Recv,
<a name="9534"/> 9534:                                  recv_ref =&gt; Nowait},
<a name="9535"/> 9535:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="9536"/> 9536:            end).
<a name="9537"/> 9537: 
<a name="9538"/> 9538: 
<a name="9539"/> 9539: 
<a name="9540"/> 9540: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9541"/> 9541: 
<a name="api_a_mrecv_cancel_udp-1"/><a name="9542"/> 9542: <b>api_a_mrecv_cancel_udp</b>(InitState) -&gt;
<a name="9543"/> 9543:     ServerSeq = 
<a name="9544"/> 9544:         [
<a name="9545"/> 9545:          %% *** Wait for start order part ***
<a name="9546"/> 9546:          #{desc =&gt; &quot;await start&quot;,
<a name="9547"/> 9547:            cmd  =&gt; fun(State) -&gt;
<a name="9548"/> 9548:                            Tester = ?SEV_AWAIT_START(),
<a name="9549"/> 9549:                            {ok, State#{tester =&gt; Tester}}
<a name="9550"/> 9550:                    end},
<a name="9551"/> 9551:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9552"/> 9552:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9553"/> 9553:                            _MRef = erlang:monitor(process, Tester),
<a name="9554"/> 9554:                            ok
<a name="9555"/> 9555:                    end},
<a name="9556"/> 9556: 
<a name="9557"/> 9557:          %% *** Init part ***
<a name="9558"/> 9558:          #{desc =&gt; &quot;which local address&quot;,
<a name="9559"/> 9559:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9560"/> 9560:                            LSA = which_local_socket_addr(Domain),
<a name="9561"/> 9561:                            {ok, State#{local_sa =&gt; LSA}}
<a name="9562"/> 9562:                    end},
<a name="9563"/> 9563:          #{desc =&gt; &quot;create socket&quot;,
<a name="9564"/> 9564:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9565"/> 9565:                            case socket:open(Domain, dgram, udp) of
<a name="9566"/> 9566:                                {ok, Sock} -&gt;
<a name="9567"/> 9567:                                    {ok, State#{sock =&gt; Sock}};
<a name="9568"/> 9568:                                {error, _} = ERROR -&gt;
<a name="9569"/> 9569:                                    ERROR
<a name="9570"/> 9570:                            end
<a name="9571"/> 9571:                    end},
<a name="9572"/> 9572:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="9573"/> 9573:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="9574"/> 9574:                            case sock_bind(Sock, LSA) of
<a name="9575"/> 9575:                                ok -&gt;
<a name="9576"/> 9576:                                    Port = sock_port(Sock),
<a name="9577"/> 9577:                                    {ok, State#{port =&gt; Port}};
<a name="9578"/> 9578:                                {error, _} = ERROR -&gt;
<a name="9579"/> 9579:                                    ERROR
<a name="9580"/> 9580:                            end
<a name="9581"/> 9581:                    end},
<a name="9582"/> 9582:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9583"/> 9583:            cmd  =&gt; fun(#{tester := Tester, sock := Sock}) -&gt;
<a name="9584"/> 9584:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="9585"/> 9585:                            ok
<a name="9586"/> 9586:                    end},
<a name="9587"/> 9587: 
<a name="9588"/> 9588:          %% The actual test
<a name="9589"/> 9589:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="9590"/> 9590:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9591"/> 9591:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="9592"/> 9592:                    end},
<a name="9593"/> 9593:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="9594"/> 9594:            cmd  =&gt; fun(#{sock     := Sock,
<a name="9595"/> 9595:                          recv     := Recv,
<a name="9596"/> 9596:                          recv_ref := Ref} = State) -&gt;
<a name="9597"/> 9597:                            case Recv(Sock) of
<a name="9598"/> 9598:                                {select, SI}
<a name="9599"/> 9599:                                  when Ref =:= nowait -&gt;
<a name="9600"/> 9600:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9601"/> 9601:                                {select, {select_info, _Tag, Ref} = SI}
<a name="9602"/> 9602:                                  when is_reference(Ref) -&gt;
<a name="9603"/> 9603:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9604"/> 9604: 
<a name="9605"/> 9605:                                {completion, CI}
<a name="9606"/> 9606:                                  when Ref =:= nowait -&gt;
<a name="9607"/> 9607:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9608"/> 9608:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="9609"/> 9609:                                  when is_reference(Ref) -&gt;
<a name="9610"/> 9610:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9611"/> 9611: 
<a name="9612"/> 9612:                                {ok, X} -&gt;
<a name="9613"/> 9613:                                    {error, {unexpected_success, X}};
<a name="9614"/> 9614: 
<a name="9615"/> 9615:                                {error, _} = ERROR -&gt;
<a name="9616"/> 9616:                                    ERROR
<a name="9617"/> 9617:                            end
<a name="9618"/> 9618:                    end},
<a name="9619"/> 9619:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="9620"/> 9620:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9621"/> 9621:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="9622"/> 9622:                            ok
<a name="9623"/> 9623:                    end},
<a name="9624"/> 9624:          #{desc =&gt; &quot;await abort message&quot;,
<a name="9625"/> 9625:            cmd  =&gt; fun(#{sock             := Sock,
<a name="9626"/> 9626:                          recv_select_info := {select_info, _, Ref}} =
<a name="9627"/> 9627:                            State) -&gt;
<a name="9628"/> 9628:                            receive
<a name="9629"/> 9629:                                {'$socket', Sock, select, Ref} -&gt;
<a name="9630"/> 9630:                                    {error, {unexpected_select, Ref}};
<a name="9631"/> 9631:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="9632"/> 9632:                                    {ok, maps:remove(sock, State)}
<a name="9633"/> 9633:                            after 5000 -&gt;
<a name="9634"/> 9634:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="9635"/> 9635:                                    {error, timeout}
<a name="9636"/> 9636:                            end;
<a name="9637"/> 9637:                       (#{sock                 := Sock,
<a name="9638"/> 9638:                          recv_completion_info := {completion_info, _, Ref}} = 
<a name="9639"/> 9639:                            State) -&gt;
<a name="9640"/> 9640:                            receive
<a name="9641"/> 9641:                                {'$socket', Sock, completion, {Ref, CS}} -&gt;
<a name="9642"/> 9642:                                    {error, {unexpected_completion, CS}};
<a name="9643"/> 9643:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="9644"/> 9644:                                    {ok, maps:remove(sock, State)}
<a name="9645"/> 9645:                            after 5000 -&gt;
<a name="9646"/> 9646:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="9647"/> 9647:                                    {error, timeout}
<a name="9648"/> 9648:                            end
<a name="9649"/> 9649:                    end},
<a name="9650"/> 9650:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="9651"/> 9651:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9652"/> 9652:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="9653"/> 9653:                            ok
<a name="9654"/> 9654:                    end},
<a name="9655"/> 9655: 
<a name="9656"/> 9656:          %% Termination
<a name="9657"/> 9657:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="9658"/> 9658:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9659"/> 9659:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9660"/> 9660:                                ok -&gt;
<a name="9661"/> 9661:                                    State2 = maps:remove(tester,   State),
<a name="9662"/> 9662:                                    State3 = maps:remove(recv_ref, State2),
<a name="9663"/> 9663:                                    {ok, State3};
<a name="9664"/> 9664:                                {error, _} = ERROR -&gt;
<a name="9665"/> 9665:                                    ERROR
<a name="9666"/> 9666:                            end
<a name="9667"/> 9667:                    end},
<a name="9668"/> 9668: 
<a name="9669"/> 9669:          %% *** We are done ***
<a name="9670"/> 9670:          ?SEV_FINISH_NORMAL
<a name="9671"/> 9671:         ],
<a name="9672"/> 9672: 
<a name="9673"/> 9673: 
<a name="9674"/> 9674:     AltServerSeq = 
<a name="9675"/> 9675:         [
<a name="9676"/> 9676:          %% *** Wait for start order part ***
<a name="9677"/> 9677:          #{desc =&gt; &quot;await start&quot;,
<a name="9678"/> 9678:            cmd  =&gt; fun(State) -&gt;
<a name="9679"/> 9679:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="9680"/> 9680:                            {ok, State#{tester =&gt; Tester, sock =&gt; Sock}}
<a name="9681"/> 9681:                    end},
<a name="9682"/> 9682:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9683"/> 9683:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9684"/> 9684:                            _MRef = erlang:monitor(process, Tester),
<a name="9685"/> 9685:                            ok
<a name="9686"/> 9686:                    end},
<a name="9687"/> 9687:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9688"/> 9688:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9689"/> 9689:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="9690"/> 9690:                            ok
<a name="9691"/> 9691:                    end},
<a name="9692"/> 9692: 
<a name="9693"/> 9693:          %% The actual test
<a name="9694"/> 9694:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="9695"/> 9695:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9696"/> 9696:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="9697"/> 9697:                    end},
<a name="9698"/> 9698:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="9699"/> 9699:            cmd  =&gt; fun(#{sock     := Sock,
<a name="9700"/> 9700:                          recv     := Recv,
<a name="9701"/> 9701:                          recv_ref := Ref} = State) -&gt;
<a name="9702"/> 9702:                            case Recv(Sock) of
<a name="9703"/> 9703:                                {select, SI} when Ref =:= nowait -&gt;
<a name="9704"/> 9704:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9705"/> 9705:                                {select,
<a name="9706"/> 9706:                                 {select_info, _Tag, Ref} = SI}
<a name="9707"/> 9707:                                  when is_reference(Ref) -&gt;
<a name="9708"/> 9708:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9709"/> 9709: 
<a name="9710"/> 9710:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="9711"/> 9711:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9712"/> 9712:                                {completion,
<a name="9713"/> 9713:                                 {completion_info, _Tag, Ref} = CI}
<a name="9714"/> 9714:                                  when is_reference(Ref) -&gt;
<a name="9715"/> 9715:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9716"/> 9716: 
<a name="9717"/> 9717:                                {ok, X} -&gt;
<a name="9718"/> 9718:                                    {error, {unexpected_success, X}};
<a name="9719"/> 9719: 
<a name="9720"/> 9720:                                {error, _} = ERROR -&gt;
<a name="9721"/> 9721:                                    ERROR
<a name="9722"/> 9722:                            end
<a name="9723"/> 9723:                    end},
<a name="9724"/> 9724:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="9725"/> 9725:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9726"/> 9726:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="9727"/> 9727:                            ok
<a name="9728"/> 9728:                    end},
<a name="9729"/> 9729:          #{desc =&gt; &quot;await abort message&quot;,
<a name="9730"/> 9730:            cmd  =&gt; fun(#{sock             := Sock,
<a name="9731"/> 9731:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="9732"/> 9732:                            receive
<a name="9733"/> 9733:                                {'$socket', Sock, select, Ref} -&gt;
<a name="9734"/> 9734:                                    {error, {unexpected_select, Ref}};
<a name="9735"/> 9735:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="9736"/> 9736:                                    {ok, maps:remove(sock, State)}
<a name="9737"/> 9737:                            after 5000 -&gt;
<a name="9738"/> 9738:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="9739"/> 9739:                                    {error, timeout}
<a name="9740"/> 9740:                            end;
<a name="9741"/> 9741: 
<a name="9742"/> 9742:                       (#{sock                 := Sock,
<a name="9743"/> 9743:                          recv_completion_info := {completion_info, _, Ref}} =
<a name="9744"/> 9744:                            State) -&gt;
<a name="9745"/> 9745:                            receive
<a name="9746"/> 9746:                                {'$socket', Sock, completion, {Ref, CS}} -&gt;
<a name="9747"/> 9747:                                    {error, {unexpected_completion, CS}};
<a name="9748"/> 9748:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="9749"/> 9749:                                    {ok, maps:remove(sock, State)}
<a name="9750"/> 9750:                            after 5000 -&gt;
<a name="9751"/> 9751:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="9752"/> 9752:                                    {error, timeout}
<a name="9753"/> 9753:                            end
<a name="9754"/> 9754:                    end},
<a name="9755"/> 9755:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="9756"/> 9756:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9757"/> 9757:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="9758"/> 9758:                            ok
<a name="9759"/> 9759:                    end},
<a name="9760"/> 9760: 
<a name="9761"/> 9761:          %% Termination
<a name="9762"/> 9762:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="9763"/> 9763:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9764"/> 9764:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9765"/> 9765:                                ok -&gt;
<a name="9766"/> 9766:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="9767"/> 9767:                                    State1 = maps:remove(recv_select_info, State),
<a name="9768"/> 9768:                                    State2 = maps:remove(recv_completion_info, State1),
<a name="9769"/> 9769:                                    State3 = maps:remove(tester,           State2),
<a name="9770"/> 9770:                                    State4 = maps:remove(sock,             State3),
<a name="9771"/> 9771:                                    {ok, State4};
<a name="9772"/> 9772:                                {error, _} = ERROR -&gt;
<a name="9773"/> 9773:                                    ERROR
<a name="9774"/> 9774:                            end
<a name="9775"/> 9775:                    end},
<a name="9776"/> 9776: 
<a name="9777"/> 9777:          %% *** We are done ***
<a name="9778"/> 9778:          ?SEV_FINISH_NORMAL
<a name="9779"/> 9779:         ],
<a name="9780"/> 9780: 
<a name="9781"/> 9781: 
<a name="9782"/> 9782: 
<a name="9783"/> 9783:     TesterSeq = 
<a name="9784"/> 9784:         [
<a name="9785"/> 9785:          %% *** Init part ***
<a name="9786"/> 9786:          #{desc =&gt; &quot;monitor server&quot;,
<a name="9787"/> 9787:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9788"/> 9788:                            _MRef = erlang:monitor(process, Pid),
<a name="9789"/> 9789:                            ok
<a name="9790"/> 9790:                    end},
<a name="9791"/> 9791:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="9792"/> 9792:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9793"/> 9793:                            _MRef = erlang:monitor(process, Pid),
<a name="9794"/> 9794:                            ok
<a name="9795"/> 9795:                    end},
<a name="9796"/> 9796:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="9797"/> 9797:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9798"/> 9798:                            _MRef = erlang:monitor(process, Pid),
<a name="9799"/> 9799:                            ok
<a name="9800"/> 9800:                    end},
<a name="9801"/> 9801: 
<a name="9802"/> 9802:          %% Start the server
<a name="9803"/> 9803:          #{desc =&gt; &quot;order server start&quot;,
<a name="9804"/> 9804:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9805"/> 9805:                            ?SEV_ANNOUNCE_START(Pid),
<a name="9806"/> 9806:                            ok
<a name="9807"/> 9807:                    end},
<a name="9808"/> 9808:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="9809"/> 9809:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9810"/> 9810:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="9811"/> 9811:                            {ok, State#{sock =&gt; Sock}}
<a name="9812"/> 9812:                    end},
<a name="9813"/> 9813: 
<a name="9814"/> 9814:          %% Start the alt-server 1
<a name="9815"/> 9815:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="9816"/> 9816:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="9817"/> 9817:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="9818"/> 9818:                            ok
<a name="9819"/> 9819:                    end},
<a name="9820"/> 9820:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="9821"/> 9821:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9822"/> 9822:                            ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="9823"/> 9823:                    end},
<a name="9824"/> 9824: 
<a name="9825"/> 9825:          %% Start the alt-server 2
<a name="9826"/> 9826:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="9827"/> 9827:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="9828"/> 9828:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="9829"/> 9829:                            ok
<a name="9830"/> 9830:                    end},
<a name="9831"/> 9831:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="9832"/> 9832:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9833"/> 9833:                            ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="9834"/> 9834:                    end},
<a name="9835"/> 9835: 
<a name="9836"/> 9836: 
<a name="9837"/> 9837:          %% The actual test
<a name="9838"/> 9838:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="9839"/> 9839:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9840"/> 9840:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9841"/> 9841:                            ok
<a name="9842"/> 9842:                    end},
<a name="9843"/> 9843:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="9844"/> 9844:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9845"/> 9845:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="9846"/> 9846:                    end},
<a name="9847"/> 9847: 
<a name="9848"/> 9848:          #{desc =&gt; &quot;order alt-server 1 continue (recv)&quot;,
<a name="9849"/> 9849:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9850"/> 9850:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9851"/> 9851:                            ok
<a name="9852"/> 9852:                    end},
<a name="9853"/> 9853:          #{desc =&gt; &quot;await alt-server 1 ready (recv select)&quot;,
<a name="9854"/> 9854:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9855"/> 9855:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, recv_select)
<a name="9856"/> 9856:                    end},
<a name="9857"/> 9857: 
<a name="9858"/> 9858:          #{desc =&gt; &quot;order alt-server 2 continue (recv)&quot;,
<a name="9859"/> 9859:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9860"/> 9860:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9861"/> 9861:                            ok
<a name="9862"/> 9862:                    end},
<a name="9863"/> 9863:          #{desc =&gt; &quot;await alt-server 2 ready (recv select)&quot;,
<a name="9864"/> 9864:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9865"/> 9865:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, recv_select)
<a name="9866"/> 9866:                    end},
<a name="9867"/> 9867: 
<a name="9868"/> 9868:          ?SEV_SLEEP(?SECS(1)),
<a name="9869"/> 9869: 
<a name="9870"/> 9870:          #{desc =&gt; &quot;close the socket&quot;,
<a name="9871"/> 9871:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="9872"/> 9872:                            socket:close(Sock)
<a name="9873"/> 9873:                    end},
<a name="9874"/> 9874: 
<a name="9875"/> 9875:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="9876"/> 9876:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9877"/> 9877:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="9878"/> 9878:                    end},
<a name="9879"/> 9879:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="9880"/> 9880:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9881"/> 9881:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="9882"/> 9882:                    end},
<a name="9883"/> 9883:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="9884"/> 9884:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9885"/> 9885:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="9886"/> 9886:                    end},
<a name="9887"/> 9887: 
<a name="9888"/> 9888:          %% Terminations
<a name="9889"/> 9889:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="9890"/> 9890:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="9891"/> 9891:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="9892"/> 9892:                            ok
<a name="9893"/> 9893:                    end},
<a name="9894"/> 9894:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="9895"/> 9895:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="9896"/> 9896:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="9897"/> 9897:                                ok -&gt;
<a name="9898"/> 9898:                                    State1 = maps:remove(alt_server2, State),
<a name="9899"/> 9899:                                    {ok, State1};
<a name="9900"/> 9900:                                {error, _} = ERROR -&gt;
<a name="9901"/> 9901:                                    ERROR
<a name="9902"/> 9902:                            end
<a name="9903"/> 9903:                    end},
<a name="9904"/> 9904: 
<a name="9905"/> 9905:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="9906"/> 9906:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="9907"/> 9907:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="9908"/> 9908:                            ok
<a name="9909"/> 9909:                    end},
<a name="9910"/> 9910:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="9911"/> 9911:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="9912"/> 9912:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="9913"/> 9913:                                ok -&gt;
<a name="9914"/> 9914:                                    State1 = maps:remove(alt_server1, State),
<a name="9915"/> 9915:                                    {ok, State1};
<a name="9916"/> 9916:                                {error, _} = ERROR -&gt;
<a name="9917"/> 9917:                                    ERROR
<a name="9918"/> 9918:                            end
<a name="9919"/> 9919:                    end},
<a name="9920"/> 9920: 
<a name="9921"/> 9921:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="9922"/> 9922:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9923"/> 9923:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="9924"/> 9924:                            ok
<a name="9925"/> 9925:                    end},
<a name="9926"/> 9926:          #{desc =&gt; &quot;await server termination&quot;,
<a name="9927"/> 9927:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9928"/> 9928:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="9929"/> 9929:                                ok -&gt;
<a name="9930"/> 9930:                                    State1 = maps:remove(server, State),
<a name="9931"/> 9931:                                    {ok, State1};
<a name="9932"/> 9932:                                {error, _} = ERROR -&gt;
<a name="9933"/> 9933:                                    ERROR
<a name="9934"/> 9934:                            end
<a name="9935"/> 9935:                    end},
<a name="9936"/> 9936: 
<a name="9937"/> 9937: 
<a name="9938"/> 9938:          %% *** We are done ***
<a name="9939"/> 9939:          ?SEV_FINISH_NORMAL
<a name="9940"/> 9940:         ],
<a name="9941"/> 9941: 
<a name="9942"/> 9942:     i(&quot;start server evaluator&quot;),
<a name="9943"/> 9943:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="9944"/> 9944: 
<a name="9945"/> 9945:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="9946"/> 9946:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="9947"/> 9947: 
<a name="9948"/> 9948:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="9949"/> 9949:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="9950"/> 9950: 
<a name="9951"/> 9951:     i(&quot;start 'tester' evaluator&quot;),
<a name="9952"/> 9952:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="9953"/> 9953:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="9954"/> 9954:                         alt_server2 =&gt; AltServer2#ev.pid},
<a name="9955"/> 9955:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="9956"/> 9956: 
<a name="9957"/> 9957:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_mrecv_cancel_udp-last_expr"/><a name="9958"/> 9958: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Tester]).
<a name="9959"/> 9959: 
<a name="9960"/> 9960: 
<a name="9961"/> 9961: 
<a name="9962"/> 9962: 
<a name="9963"/> 9963: 
<a name="9964"/> 9964: 
<a name="9965"/> 9965: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9966"/> 9966: 
<a name="9967"/> 9967: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to accept</i>
<a name="9968"/> 9968: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="9969"/> 9969: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="9970"/> 9970: <i>%%</i>
<a name="api_a_maccept_cancel_tcp4-1"/><a name="9971"/> 9971: <b>api_a_maccept_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="9972"/> 9972:     ?TT(?SECS(20)),
<a name="9973"/> 9973:     Nowait = nowait(Config),
<a name="api_a_maccept_cancel_tcp4-last_expr"/><a name="9974"/> 9974: <b>    tc_try</b>(api_a_maccept_cancel_tcp4,
<a name="9975"/> 9975:            fun() -&gt; has_support_ipv4() end,
<a name="9976"/> 9976:            fun() -&gt;
<a name="9977"/> 9977:                    Accept = fun(Sock) -&gt;
<a name="9978"/> 9978:                                     case socket:accept(Sock, Nowait) of
<a name="9979"/> 9979:                                         {ok, _} = OK -&gt;
<a name="9980"/> 9980:                                             OK;
<a name="9981"/> 9981:                                         {select, _} = SELECT -&gt;
<a name="9982"/> 9982:                                             SELECT;
<a name="9983"/> 9983:                                         {completion, _} = COMPLETION -&gt;
<a name="9984"/> 9984:                                             COMPLETION;
<a name="9985"/> 9985:                                         {error, _} = ERROR -&gt;
<a name="9986"/> 9986:                                             ERROR
<a name="9987"/> 9987:                                     end
<a name="9988"/> 9988:                             end,
<a name="9989"/> 9989:                    InitState = #{domain     =&gt; inet,
<a name="9990"/> 9990:                                  accept     =&gt; Accept,
<a name="9991"/> 9991:                                  accept_ref =&gt; Nowait},
<a name="9992"/> 9992:                    ok = api_a_maccept_cancel_tcp(InitState)
<a name="9993"/> 9993:            end).
<a name="9994"/> 9994: 
<a name="9995"/> 9995: 
<a name="9996"/> 9996: 
<a name="9997"/> 9997: 
<a name="9998"/> 9998: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9999"/> 9999: 
<a name="10000"/>10000: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to accept</i>
<a name="10001"/>10001: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10002"/>10002: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="10003"/>10003: <i>%%</i>
<a name="api_a_maccept_cancel_tcp6-1"/><a name="10004"/>10004: <b>api_a_maccept_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="10005"/>10005:     ?TT(?SECS(20)),
<a name="10006"/>10006:     Nowait = nowait(Config),
<a name="api_a_maccept_cancel_tcp6-last_expr"/><a name="10007"/>10007: <b>    tc_try</b>(api_a_maccept_cancel_tcp6,
<a name="10008"/>10008:            fun() -&gt; has_support_ipv6() end,
<a name="10009"/>10009:            fun() -&gt;
<a name="10010"/>10010:                    Accept = fun(Sock) -&gt;
<a name="10011"/>10011:                                     case socket:accept(Sock, Nowait) of
<a name="10012"/>10012:                                         {ok, _} = OK -&gt;
<a name="10013"/>10013:                                             OK;
<a name="10014"/>10014:                                         {select, _} = SELECT -&gt;
<a name="10015"/>10015:                                             SELECT;
<a name="10016"/>10016:                                         {completion, _} = COMPLETION -&gt;
<a name="10017"/>10017:                                             COMPLETION;
<a name="10018"/>10018:                                         {error, _} = ERROR -&gt;
<a name="10019"/>10019:                                             ERROR
<a name="10020"/>10020:                                     end
<a name="10021"/>10021:                             end,
<a name="10022"/>10022:                    InitState = #{domain     =&gt; inet6,
<a name="10023"/>10023:                                  accept     =&gt; Accept,
<a name="10024"/>10024:                                  accept_ref =&gt; Nowait},
<a name="10025"/>10025:                    ok = api_a_maccept_cancel_tcp(InitState)
<a name="10026"/>10026:            end).
<a name="10027"/>10027: 
<a name="10028"/>10028: 
<a name="10029"/>10029: 
<a name="10030"/>10030: 
<a name="10031"/>10031: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10032"/>10032: 
<a name="api_a_maccept_cancel_tcp-1"/><a name="10033"/>10033: <b>api_a_maccept_cancel_tcp</b>(InitState) -&gt;
<a name="10034"/>10034:     process_flag(trap_exit, true),
<a name="10035"/>10035:     ServerSeq = 
<a name="10036"/>10036:         [
<a name="10037"/>10037:          %% *** Wait for start order ***
<a name="10038"/>10038:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="10039"/>10039:            cmd  =&gt; fun(State) -&gt;
<a name="10040"/>10040:                            Tester = ?SEV_AWAIT_START(),
<a name="10041"/>10041:                            {ok, State#{tester =&gt; Tester}}
<a name="10042"/>10042:                    end},
<a name="10043"/>10043:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10044"/>10044:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10045"/>10045:                            _MRef = erlang:monitor(process, Tester),
<a name="10046"/>10046:                            ok
<a name="10047"/>10047:                    end},
<a name="10048"/>10048: 
<a name="10049"/>10049:          %% *** Init part ***
<a name="10050"/>10050:          #{desc =&gt; &quot;which local address&quot;,
<a name="10051"/>10051:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10052"/>10052:                            LSA = which_local_socket_addr(Domain),
<a name="10053"/>10053:                            {ok, State#{lsa =&gt; LSA}}
<a name="10054"/>10054:                    end},
<a name="10055"/>10055:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="10056"/>10056:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10057"/>10057:                            case socket:open(Domain, stream, tcp) of
<a name="10058"/>10058:                                {ok, Sock} -&gt;
<a name="10059"/>10059:                                    {ok, State#{lsock =&gt; Sock}};
<a name="10060"/>10060:                                {error, _} = ERROR -&gt;
<a name="10061"/>10061:                                    ERROR
<a name="10062"/>10062:                            end
<a name="10063"/>10063:                    end},
<a name="10064"/>10064:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="10065"/>10065:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="10066"/>10066:                            case sock_bind(LSock, LSA) of
<a name="10067"/>10067:                                ok -&gt;
<a name="10068"/>10068:                                    Port = sock_port(LSock),
<a name="10069"/>10069:                                    {ok, State#{lport =&gt; Port}};
<a name="10070"/>10070:                                {error, _} = ERROR -&gt;
<a name="10071"/>10071:                                    ERROR
<a name="10072"/>10072:                            end
<a name="10073"/>10073:                    end},
<a name="10074"/>10074:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="10075"/>10075:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="10076"/>10076:                            socket:listen(LSock)
<a name="10077"/>10077:                    end},
<a name="10078"/>10078:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10079"/>10079:            cmd  =&gt; fun(#{tester := Tester, lsock := Sock}) -&gt;
<a name="10080"/>10080:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="10081"/>10081:                            ok
<a name="10082"/>10082:                    end},
<a name="10083"/>10083: 
<a name="10084"/>10084:          %% The actual test
<a name="10085"/>10085:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="10086"/>10086:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10087"/>10087:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="10088"/>10088:                    end},
<a name="10089"/>10089:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="10090"/>10090:            cmd  =&gt; fun(#{lsock      := LSock,
<a name="10091"/>10091:                          accept     := Accept,
<a name="10092"/>10092:                          accept_ref := Ref} = State) -&gt;
<a name="10093"/>10093:                            case Accept(LSock) of
<a name="10094"/>10094:                                {select, {select_info, T, R} = SI}
<a name="10095"/>10095:                                  when Ref =:= nowait -&gt;
<a name="10096"/>10096:                                    ?SEV_IPRINT(&quot;accept select nowait: &quot;
<a name="10097"/>10097:                                                &quot;~n   T: ~p&quot;
<a name="10098"/>10098:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="10099"/>10099:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="10100"/>10100:                                {select, {select_info, T, Ref} = SI}
<a name="10101"/>10101:                                  when is_reference(Ref) -&gt;
<a name="10102"/>10102:                                    ?SEV_IPRINT(&quot;accept select ref: &quot;
<a name="10103"/>10103:                                                &quot;~n   T: ~p&quot;
<a name="10104"/>10104:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="10105"/>10105:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="10106"/>10106: 
<a name="10107"/>10107:                                {completion, {completion_info, T, R} = CI}
<a name="10108"/>10108:                                  when Ref =:= nowait -&gt;
<a name="10109"/>10109:                                    ?SEV_IPRINT(&quot;accept completion nowait: &quot;
<a name="10110"/>10110:                                                &quot;~n   T: ~p&quot;
<a name="10111"/>10111:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="10112"/>10112:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="10113"/>10113:                                {completion, {completion_info, T, Ref} = CI}
<a name="10114"/>10114:                                  when is_reference(Ref) -&gt;
<a name="10115"/>10115:                                    ?SEV_IPRINT(&quot;accept completion ref: &quot;
<a name="10116"/>10116:                                                &quot;~n   T: ~p&quot;
<a name="10117"/>10117:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="10118"/>10118:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="10119"/>10119: 
<a name="10120"/>10120:                                {ok, X} -&gt;
<a name="10121"/>10121:                                    {error, {unexpected_success, X}};
<a name="10122"/>10122: 
<a name="10123"/>10123:                                {error, _} = ERROR -&gt;
<a name="10124"/>10124:                                    ERROR
<a name="10125"/>10125:                            end
<a name="10126"/>10126:                    end},
<a name="10127"/>10127:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="10128"/>10128:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10129"/>10129:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="10130"/>10130:                            ok
<a name="10131"/>10131:                    end},
<a name="10132"/>10132:          #{desc =&gt; &quot;await select message (without success)&quot;,
<a name="10133"/>10133:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="10134"/>10134:                          accept_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10135"/>10135:                            receive
<a name="10136"/>10136:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10137"/>10137:                                    {error, {unexpected_select, Ref}};
<a name="10138"/>10138:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10139"/>10139:                                    {ok, maps:remove(lsock, State)}
<a name="10140"/>10140:                            after 5000 -&gt;
<a name="10141"/>10141:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="10142"/>10142:                                                &quot;~n   Sock:          ~p&quot;
<a name="10143"/>10143:                                                &quot;~n   Ref:           ~p&quot;
<a name="10144"/>10144:                                                &quot;~n   message queue: ~p&quot;,
<a name="10145"/>10145:                                                [Sock, Ref, ?MQ()]),
<a name="10146"/>10146:                                    {error, timeout}
<a name="10147"/>10147:                            end;
<a name="10148"/>10148:                       (#{lsock                  := Sock,
<a name="10149"/>10149:                          accept_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="10150"/>10150:                            receive
<a name="10151"/>10151:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="10152"/>10152:                                    {error, {unexpected_completion, C}};
<a name="10153"/>10153:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10154"/>10154:                                    {ok, maps:remove(lsock, State)}
<a name="10155"/>10155:                            after 5000 -&gt;
<a name="10156"/>10156:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="10157"/>10157:                                                &quot;~n   Sock:          ~p&quot;
<a name="10158"/>10158:                                                &quot;~n   Ref:           ~p&quot;
<a name="10159"/>10159:                                                &quot;~n   message queue: ~p&quot;,
<a name="10160"/>10160:                                                [Sock, Ref, ?MQ()]),
<a name="10161"/>10161:                                    {error, timeout}
<a name="10162"/>10162:                            end
<a name="10163"/>10163:                    end},
<a name="10164"/>10164:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10165"/>10165:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10166"/>10166:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10167"/>10167:                            ok
<a name="10168"/>10168:                    end},
<a name="10169"/>10169: 
<a name="10170"/>10170:          %% *** Termination ***
<a name="10171"/>10171:          #{desc =&gt; &quot;await terminate&quot;,
<a name="10172"/>10172:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10173"/>10173:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10174"/>10174:                                ok -&gt;
<a name="10175"/>10175:                                    {ok, maps:remove(tester, State)};
<a name="10176"/>10176:                                {error, _} = ERROR -&gt;
<a name="10177"/>10177:                                    ERROR
<a name="10178"/>10178:                            end
<a name="10179"/>10179:                    end},
<a name="10180"/>10180: 
<a name="10181"/>10181:          %% *** We are done ***
<a name="10182"/>10182:          ?SEV_FINISH_NORMAL
<a name="10183"/>10183:         ],
<a name="10184"/>10184: 
<a name="10185"/>10185: 
<a name="10186"/>10186:     AltServerSeq =
<a name="10187"/>10187:         [
<a name="10188"/>10188:          %% *** Wait for start order part ***
<a name="10189"/>10189:          #{desc =&gt; &quot;await start&quot;,
<a name="10190"/>10190:            cmd  =&gt; fun(State) -&gt;
<a name="10191"/>10191:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="10192"/>10192:                            {ok, State#{tester =&gt; Tester, lsock =&gt; Sock}}
<a name="10193"/>10193:                    end},
<a name="10194"/>10194:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10195"/>10195:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10196"/>10196:                            _MRef = erlang:monitor(process, Tester),
<a name="10197"/>10197:                            ok
<a name="10198"/>10198:                    end},
<a name="10199"/>10199:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10200"/>10200:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10201"/>10201:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="10202"/>10202:                            ok
<a name="10203"/>10203:                    end},
<a name="10204"/>10204: 
<a name="10205"/>10205:          %% The actual test
<a name="10206"/>10206:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="10207"/>10207:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10208"/>10208:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="10209"/>10209:                    end},
<a name="10210"/>10210:          #{desc =&gt; &quot;try accept request (with nowait, expect select)&quot;,
<a name="10211"/>10211:            cmd  =&gt; fun(#{lsock      := Sock,
<a name="10212"/>10212:                          accept     := Accept,
<a name="10213"/>10213:                          accept_ref := Ref} = State) -&gt;
<a name="10214"/>10214:                            case Accept(Sock) of
<a name="10215"/>10215:                                {select, SI} when Ref =:= nowait -&gt;
<a name="10216"/>10216:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="10217"/>10217:                                {select, {select_info, _Tag, Ref} = SI}
<a name="10218"/>10218:                                  when is_reference(Ref) -&gt;
<a name="10219"/>10219:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="10220"/>10220: 
<a name="10221"/>10221:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="10222"/>10222:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="10223"/>10223:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="10224"/>10224:                                  when is_reference(Ref) -&gt;
<a name="10225"/>10225:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="10226"/>10226: 
<a name="10227"/>10227:                                {ok, X} -&gt;
<a name="10228"/>10228:                                    {error, {unexpected_success, X}};
<a name="10229"/>10229: 
<a name="10230"/>10230:                                {error, _} = ERROR -&gt;
<a name="10231"/>10231:                                    ERROR
<a name="10232"/>10232:                            end
<a name="10233"/>10233:                    end},
<a name="10234"/>10234:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="10235"/>10235:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10236"/>10236:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="10237"/>10237:                            ok
<a name="10238"/>10238:                    end},
<a name="10239"/>10239:          #{desc =&gt; &quot;await abort message&quot;,
<a name="10240"/>10240:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="10241"/>10241:                          accept_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10242"/>10242:                            receive
<a name="10243"/>10243:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10244"/>10244:                                    {error, {unexpected_select, Ref}};
<a name="10245"/>10245:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10246"/>10246:                                    {ok, maps:remove(sock, State)}
<a name="10247"/>10247:                            after 5000 -&gt;
<a name="10248"/>10248:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="10249"/>10249:                                                &quot;~n   Sock:          ~p&quot;
<a name="10250"/>10250:                                                &quot;~n   Ref:           ~p&quot;
<a name="10251"/>10251:                                                &quot;~n   message queue: ~p&quot;,
<a name="10252"/>10252:                                                [Sock, Ref, ?MQ()]),
<a name="10253"/>10253:                                    {error, timeout}
<a name="10254"/>10254:                            end;
<a name="10255"/>10255:                       (#{lsock              := Sock,
<a name="10256"/>10256:                          accept_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="10257"/>10257:                            receive
<a name="10258"/>10258:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="10259"/>10259:                                    {error, {unexpected_completion, C}};
<a name="10260"/>10260:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10261"/>10261:                                    {ok, maps:remove(sock, State)}
<a name="10262"/>10262:                            after 5000 -&gt;
<a name="10263"/>10263:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="10264"/>10264:                                                &quot;~n   Sock:          ~p&quot;
<a name="10265"/>10265:                                                &quot;~n   Ref:           ~p&quot;
<a name="10266"/>10266:                                                &quot;~n   message queue: ~p&quot;,
<a name="10267"/>10267:                                                [Sock, Ref, ?MQ()]),
<a name="10268"/>10268:                                    {error, timeout}
<a name="10269"/>10269:                            end
<a name="10270"/>10270:                    end},
<a name="10271"/>10271:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10272"/>10272:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10273"/>10273:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10274"/>10274:                            ok
<a name="10275"/>10275:                    end},
<a name="10276"/>10276: 
<a name="10277"/>10277:          %% Termination
<a name="10278"/>10278:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="10279"/>10279:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10280"/>10280:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10281"/>10281:                                ok -&gt;
<a name="10282"/>10282:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="10283"/>10283:                                    State1 = maps:remove(tester,             State),
<a name="10284"/>10284:                                    State2 = maps:remove(accept_select_info, State1),
<a name="10285"/>10285:                                    State3 = maps:remove(accept_completion_info, State2),
<a name="10286"/>10286:                                    State4 = maps:remove(lsock,              State3),
<a name="10287"/>10287:                                    {ok, State4};
<a name="10288"/>10288:                                {error, _} = ERROR -&gt;
<a name="10289"/>10289:                                    ERROR
<a name="10290"/>10290:                            end
<a name="10291"/>10291:                    end},
<a name="10292"/>10292: 
<a name="10293"/>10293:          %% *** We are done ***
<a name="10294"/>10294:          ?SEV_FINISH_NORMAL
<a name="10295"/>10295:         ],
<a name="10296"/>10296: 
<a name="10297"/>10297: 
<a name="10298"/>10298:     TesterSeq =
<a name="10299"/>10299:         [
<a name="10300"/>10300:          %% *** Init part ***
<a name="10301"/>10301:          #{desc =&gt; &quot;monitor server&quot;,
<a name="10302"/>10302:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10303"/>10303:                            _MRef = erlang:monitor(process, Pid),
<a name="10304"/>10304:                            ok
<a name="10305"/>10305:                    end},
<a name="10306"/>10306:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="10307"/>10307:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10308"/>10308:                            _MRef = erlang:monitor(process, Pid),
<a name="10309"/>10309:                            ok
<a name="10310"/>10310:                    end},
<a name="10311"/>10311:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="10312"/>10312:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10313"/>10313:                            _MRef = erlang:monitor(process, Pid),
<a name="10314"/>10314:                            ok
<a name="10315"/>10315:                    end},
<a name="10316"/>10316: 
<a name="10317"/>10317:          %% Start the server
<a name="10318"/>10318:          #{desc =&gt; &quot;order server start&quot;,
<a name="10319"/>10319:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10320"/>10320:                            ?SEV_ANNOUNCE_START(Pid),
<a name="10321"/>10321:                            ok
<a name="10322"/>10322:                    end},
<a name="10323"/>10323:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="10324"/>10324:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10325"/>10325:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="10326"/>10326:                            {ok, State#{sock =&gt; Sock}}
<a name="10327"/>10327:                    end},
<a name="10328"/>10328: 
<a name="10329"/>10329:          %% Start the alt-server 1
<a name="10330"/>10330:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="10331"/>10331:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="10332"/>10332:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10333"/>10333:                            ok
<a name="10334"/>10334:                    end},
<a name="10335"/>10335:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="10336"/>10336:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10337"/>10337:                            ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="10338"/>10338:                    end},
<a name="10339"/>10339: 
<a name="10340"/>10340:          %% Start the alt-server 2
<a name="10341"/>10341:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="10342"/>10342:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="10343"/>10343:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10344"/>10344:                            ok
<a name="10345"/>10345:                    end},
<a name="10346"/>10346:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="10347"/>10347:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10348"/>10348:                            ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="10349"/>10349:                    end},
<a name="10350"/>10350: 
<a name="10351"/>10351: 
<a name="10352"/>10352:          %% *** The actual test ***
<a name="10353"/>10353:          #{desc =&gt; &quot;order server continue (accept)&quot;,
<a name="10354"/>10354:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10355"/>10355:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="10356"/>10356:                            ok
<a name="10357"/>10357:                    end},
<a name="10358"/>10358:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="10359"/>10359:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10360"/>10360:                            ok = ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="10361"/>10361:                    end},
<a name="10362"/>10362: 
<a name="10363"/>10363:          #{desc =&gt; &quot;order alt-server 1 continue (accept)&quot;,
<a name="10364"/>10364:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10365"/>10365:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="10366"/>10366:                            ok
<a name="10367"/>10367:                    end},
<a name="10368"/>10368:          #{desc =&gt; &quot;await alt-server 1 ready (accept select)&quot;,
<a name="10369"/>10369:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10370"/>10370:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, accept_select)
<a name="10371"/>10371:                    end},
<a name="10372"/>10372: 
<a name="10373"/>10373:          #{desc =&gt; &quot;order alt-server 2 continue (accept)&quot;,
<a name="10374"/>10374:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10375"/>10375:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="10376"/>10376:                            ok
<a name="10377"/>10377:                    end},
<a name="10378"/>10378:          #{desc =&gt; &quot;await alt-server 2 ready (accept select)&quot;,
<a name="10379"/>10379:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10380"/>10380:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, accept_select)
<a name="10381"/>10381:                    end},
<a name="10382"/>10382: 
<a name="10383"/>10383:          ?SEV_SLEEP(?SECS(1)),
<a name="10384"/>10384: 
<a name="10385"/>10385:          #{desc =&gt; &quot;close the socket&quot;,
<a name="10386"/>10386:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="10387"/>10387:                            socket:close(Sock)
<a name="10388"/>10388:                    end},
<a name="10389"/>10389: 
<a name="10390"/>10390:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="10391"/>10391:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10392"/>10392:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="10393"/>10393:                    end},
<a name="10394"/>10394:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="10395"/>10395:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10396"/>10396:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="10397"/>10397:                    end},
<a name="10398"/>10398:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="10399"/>10399:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10400"/>10400:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="10401"/>10401:                    end},
<a name="10402"/>10402: 
<a name="10403"/>10403: 
<a name="10404"/>10404:          %% *** Termination ***
<a name="10405"/>10405:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="10406"/>10406:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10407"/>10407:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="10408"/>10408:                            ok
<a name="10409"/>10409:                    end},
<a name="10410"/>10410:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="10411"/>10411:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="10412"/>10412:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="10413"/>10413:                                ok -&gt;
<a name="10414"/>10414:                                    State1 = maps:remove(alt_server2, State),
<a name="10415"/>10415:                                    {ok, State1};
<a name="10416"/>10416:                                {error, _} = ERROR -&gt;
<a name="10417"/>10417:                                    ERROR
<a name="10418"/>10418:                            end
<a name="10419"/>10419:                    end},
<a name="10420"/>10420: 
<a name="10421"/>10421:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="10422"/>10422:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10423"/>10423:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="10424"/>10424:                            ok
<a name="10425"/>10425:                    end},
<a name="10426"/>10426:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="10427"/>10427:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="10428"/>10428:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="10429"/>10429:                                ok -&gt;
<a name="10430"/>10430:                                    State1 = maps:remove(alt_server1, State),
<a name="10431"/>10431:                                    {ok, State1};
<a name="10432"/>10432:                                {error, _} = ERROR -&gt;
<a name="10433"/>10433:                                    ERROR
<a name="10434"/>10434:                            end
<a name="10435"/>10435:                    end},
<a name="10436"/>10436: 
<a name="10437"/>10437:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="10438"/>10438:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="10439"/>10439:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="10440"/>10440:                            ok
<a name="10441"/>10441:                    end},
<a name="10442"/>10442:          #{desc =&gt; &quot;await server termination&quot;,
<a name="10443"/>10443:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="10444"/>10444:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="10445"/>10445:                            State1 = maps:remove(server, State),
<a name="10446"/>10446:                            {ok, State1}
<a name="10447"/>10447:                    end},
<a name="10448"/>10448: 
<a name="10449"/>10449:          %% *** We are done ***
<a name="10450"/>10450:          ?SEV_FINISH_NORMAL
<a name="10451"/>10451:         ],
<a name="10452"/>10452: 
<a name="10453"/>10453:     i(&quot;start server evaluator&quot;),
<a name="10454"/>10454:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="10455"/>10455: 
<a name="10456"/>10456:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="10457"/>10457:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="10458"/>10458: 
<a name="10459"/>10459:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="10460"/>10460:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="10461"/>10461: 
<a name="10462"/>10462:     i(&quot;start tester evaluator&quot;),
<a name="10463"/>10463:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="10464"/>10464:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="10465"/>10465:                         alt_server2 =&gt; AltServer2#ev.pid},
<a name="10466"/>10466:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="10467"/>10467: 
<a name="10468"/>10468:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_maccept_cancel_tcp-last_expr"/><a name="10469"/>10469: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Tester]).
<a name="10470"/>10470: 
<a name="10471"/>10471: 
<a name="10472"/>10472: 
<a name="10473"/>10473: 
<a name="10474"/>10474: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10475"/>10475: 
<a name="10476"/>10476: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recv</i>
<a name="10477"/>10477: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10478"/>10478: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="10479"/>10479: <i>%%</i>
<a name="api_a_mrecv_cancel_tcp4-1"/><a name="10480"/>10480: <b>api_a_mrecv_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="10481"/>10481:     ?TT(?SECS(20)),
<a name="10482"/>10482:     Nowait = nowait(Config),
<a name="api_a_mrecv_cancel_tcp4-last_expr"/><a name="10483"/>10483: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="10484"/>10484:            fun() -&gt; has_support_ipv4() end,
<a name="10485"/>10485:            fun() -&gt;
<a name="10486"/>10486:                    Recv = fun(Sock) -&gt;
<a name="10487"/>10487:                                   socket:recv(Sock, 0, Nowait)
<a name="10488"/>10488:                           end,
<a name="10489"/>10489:                    InitState = #{domain   =&gt; inet,
<a name="10490"/>10490:                                  recv     =&gt; Recv,
<a name="10491"/>10491:                                  recv_ref =&gt; Nowait},
<a name="10492"/>10492:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="10493"/>10493:            end).
<a name="10494"/>10494: 
<a name="10495"/>10495: 
<a name="10496"/>10496: 
<a name="10497"/>10497: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10498"/>10498: 
<a name="10499"/>10499: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recv</i>
<a name="10500"/>10500: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10501"/>10501: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="10502"/>10502: <i>%%</i>
<a name="api_a_mrecv_cancel_tcp6-1"/><a name="10503"/>10503: <b>api_a_mrecv_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="10504"/>10504:     ?TT(?SECS(20)),
<a name="10505"/>10505:     Nowait = nowait(Config),
<a name="api_a_mrecv_cancel_tcp6-last_expr"/><a name="10506"/>10506: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="10507"/>10507:            fun() -&gt; has_support_ipv6() end,
<a name="10508"/>10508:            fun() -&gt;
<a name="10509"/>10509:                    Recv = fun(Sock) -&gt;
<a name="10510"/>10510:                                   socket:recv(Sock, 0, Nowait)
<a name="10511"/>10511:                           end,
<a name="10512"/>10512:                    InitState = #{domain   =&gt; inet6,
<a name="10513"/>10513:                                  recv     =&gt; Recv,
<a name="10514"/>10514:                                  recv_ref =&gt; Nowait},
<a name="10515"/>10515:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="10516"/>10516:            end).
<a name="10517"/>10517: 
<a name="10518"/>10518: 
<a name="10519"/>10519: 
<a name="10520"/>10520: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10521"/>10521: 
<a name="10522"/>10522: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="10523"/>10523: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10524"/>10524: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="10525"/>10525: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_tcp4-1"/><a name="10526"/>10526: <b>api_a_mrecvmsg_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="10527"/>10527:     ?TT(?SECS(20)),
<a name="10528"/>10528:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_tcp4-last_expr"/><a name="10529"/>10529: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="10530"/>10530:            fun() -&gt;
<a name="10531"/>10531:                    is_not_windows(),
<a name="10532"/>10532:                    has_support_ipv4()
<a name="10533"/>10533:            end,
<a name="10534"/>10534:            fun() -&gt;
<a name="10535"/>10535:                    Recv = fun(Sock) -&gt;
<a name="10536"/>10536:                                   socket:recvmsg(Sock, Nowait)
<a name="10537"/>10537:                           end,
<a name="10538"/>10538:                    InitState = #{domain   =&gt; inet,
<a name="10539"/>10539:                                  recv     =&gt; Recv,
<a name="10540"/>10540:                                  recv_ref =&gt; Nowait},
<a name="10541"/>10541:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="10542"/>10542:            end).
<a name="10543"/>10543: 
<a name="10544"/>10544: 
<a name="10545"/>10545: 
<a name="10546"/>10546: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10547"/>10547: 
<a name="10548"/>10548: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="10549"/>10549: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10550"/>10550: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="10551"/>10551: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_tcp6-1"/><a name="10552"/>10552: <b>api_a_mrecvmsg_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="10553"/>10553:     ?TT(?SECS(20)),
<a name="10554"/>10554:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_tcp6-last_expr"/><a name="10555"/>10555: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="10556"/>10556:            fun() -&gt;
<a name="10557"/>10557:                    is_not_windows(),
<a name="10558"/>10558:                    has_support_ipv6()
<a name="10559"/>10559:            end,
<a name="10560"/>10560:            fun() -&gt;
<a name="10561"/>10561:                    Recv = fun(Sock) -&gt;
<a name="10562"/>10562:                                   socket:recvmsg(Sock, Nowait)
<a name="10563"/>10563:                           end,
<a name="10564"/>10564:                    InitState = #{domain   =&gt; inet6,
<a name="10565"/>10565:                                  recv     =&gt; Recv,
<a name="10566"/>10566:                                  recv_ref =&gt; Nowait},
<a name="10567"/>10567:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="10568"/>10568:            end).
<a name="10569"/>10569: 
<a name="10570"/>10570: 
<a name="10571"/>10571: 
<a name="10572"/>10572: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10573"/>10573: 
<a name="api_a_mrecv_cancel_tcp-1"/><a name="10574"/>10574: <b>api_a_mrecv_cancel_tcp</b>(InitState) -&gt;
<a name="10575"/>10575:     process_flag(trap_exit, true),
<a name="10576"/>10576:     ServerSeq = 
<a name="10577"/>10577:         [
<a name="10578"/>10578:          %% *** Wait for start order ***
<a name="10579"/>10579:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="10580"/>10580:            cmd  =&gt; fun(State) -&gt;
<a name="10581"/>10581:                            Tester = ?SEV_AWAIT_START(),
<a name="10582"/>10582:                            {ok, State#{tester =&gt; Tester}}
<a name="10583"/>10583:                    end},
<a name="10584"/>10584:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10585"/>10585:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10586"/>10586:                            _MRef = erlang:monitor(process, Tester),
<a name="10587"/>10587:                            ok
<a name="10588"/>10588:                    end},
<a name="10589"/>10589: 
<a name="10590"/>10590:          %% *** Init part ***
<a name="10591"/>10591:          #{desc =&gt; &quot;which local address&quot;,
<a name="10592"/>10592:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10593"/>10593:                            LSA = which_local_socket_addr(Domain),
<a name="10594"/>10594:                            {ok, State#{lsa =&gt; LSA}}
<a name="10595"/>10595:                    end},
<a name="10596"/>10596:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="10597"/>10597:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10598"/>10598:                            case socket:open(Domain, stream, tcp) of
<a name="10599"/>10599:                                {ok, Sock} -&gt;
<a name="10600"/>10600:                                    {ok, State#{lsock =&gt; Sock}};
<a name="10601"/>10601:                                {error, _} = ERROR -&gt;
<a name="10602"/>10602:                                    ERROR
<a name="10603"/>10603:                            end
<a name="10604"/>10604:                    end},
<a name="10605"/>10605:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="10606"/>10606:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="10607"/>10607:                            case sock_bind(LSock, LSA) of
<a name="10608"/>10608:                                ok -&gt;
<a name="10609"/>10609:                                    Port = sock_port(LSock),
<a name="10610"/>10610:                                    {ok, State#{lport =&gt; Port}};
<a name="10611"/>10611:                                {error, _} = ERROR -&gt;
<a name="10612"/>10612:                                    ERROR
<a name="10613"/>10613:                            end
<a name="10614"/>10614:                    end},
<a name="10615"/>10615:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="10616"/>10616:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="10617"/>10617:                            socket:listen(LSock)
<a name="10618"/>10618:                    end},
<a name="10619"/>10619:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10620"/>10620:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="10621"/>10621:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="10622"/>10622:                            ok
<a name="10623"/>10623:                    end},
<a name="10624"/>10624: 
<a name="10625"/>10625:          %% The actual test
<a name="10626"/>10626:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="10627"/>10627:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10628"/>10628:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="10629"/>10629:                    end},
<a name="10630"/>10630:          #{desc =&gt; &quot;await connection&quot;,
<a name="10631"/>10631:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="10632"/>10632:                            case socket:accept(LSock) of
<a name="10633"/>10633:                                {ok, CSock} -&gt;
<a name="10634"/>10634:                                    {ok, State#{csock =&gt; CSock}};
<a name="10635"/>10635:                                {error, _} = ERROR -&gt;
<a name="10636"/>10636:                                    ERROR
<a name="10637"/>10637:                            end
<a name="10638"/>10638:                    end},
<a name="10639"/>10639:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="10640"/>10640:            cmd  =&gt; fun(#{tester := Tester, csock := Sock}) -&gt;
<a name="10641"/>10641:                            ?SEV_ANNOUNCE_READY(Tester, accept, Sock),
<a name="10642"/>10642:                            ok
<a name="10643"/>10643:                    end},
<a name="10644"/>10644: 
<a name="10645"/>10645:          #{desc =&gt; &quot;await continue (nowait recv)&quot;,
<a name="10646"/>10646:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10647"/>10647:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="10648"/>10648:                    end},
<a name="10649"/>10649:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="10650"/>10650:            cmd  =&gt; fun(#{csock    := Sock,
<a name="10651"/>10651:                          recv     := Recv,
<a name="10652"/>10652:                          recv_ref := Ref} = State) -&gt;
<a name="10653"/>10653:                            case Recv(Sock) of
<a name="10654"/>10654:                                {select, {select_info, T, R} = SI}
<a name="10655"/>10655:                                  when Ref =:= nowait -&gt;
<a name="10656"/>10656:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="10657"/>10657:                                                &quot;~n   Tag: ~p&quot;
<a name="10658"/>10658:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="10659"/>10659:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10660"/>10660:                                {select, {select_info, T, Ref} = SI}
<a name="10661"/>10661:                                  when is_reference(Ref) -&gt;
<a name="10662"/>10662:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="10663"/>10663:                                                &quot;~n   Tag: ~p&quot;
<a name="10664"/>10664:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="10665"/>10665:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10666"/>10666: 
<a name="10667"/>10667:                                {completion, {completion_info, T, R} = CI}
<a name="10668"/>10668:                                  when Ref =:= nowait -&gt;
<a name="10669"/>10669:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="10670"/>10670:                                                &quot;~n   Tag: ~p&quot;
<a name="10671"/>10671:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="10672"/>10672:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10673"/>10673:                                {completion, {completion_info, T, Ref} = CI}
<a name="10674"/>10674:                                  when is_reference(Ref) -&gt;
<a name="10675"/>10675:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="10676"/>10676:                                                &quot;~n   Tag: ~p&quot;
<a name="10677"/>10677:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="10678"/>10678:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10679"/>10679: 
<a name="10680"/>10680:                                {ok, X} -&gt;
<a name="10681"/>10681:                                    {error, {unexpected_success, X}};
<a name="10682"/>10682: 
<a name="10683"/>10683:                                {error, _} = ERROR -&gt;
<a name="10684"/>10684:                                    ERROR
<a name="10685"/>10685:                            end
<a name="10686"/>10686:                    end},
<a name="10687"/>10687:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="10688"/>10688:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10689"/>10689:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="10690"/>10690:                            ok
<a name="10691"/>10691:                    end},
<a name="10692"/>10692:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="10693"/>10693:            cmd  =&gt; fun(#{csock            := Sock,
<a name="10694"/>10694:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10695"/>10695:                            receive
<a name="10696"/>10696:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10697"/>10697:                                    {error, {unexpected_select, Ref}};
<a name="10698"/>10698:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10699"/>10699:                                    {ok, maps:remove(sock, State)}
<a name="10700"/>10700:                            after 5000 -&gt;
<a name="10701"/>10701:                                    ok
<a name="10702"/>10702:                            end;
<a name="10703"/>10703:                       (#{csock                := Sock,
<a name="10704"/>10704:                          recv_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="10705"/>10705:                            receive
<a name="10706"/>10706:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="10707"/>10707:                                    {error, {unexpected_completion, C}};
<a name="10708"/>10708:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10709"/>10709:                                    {ok, maps:remove(sock, State)}
<a name="10710"/>10710:                            after 5000 -&gt;
<a name="10711"/>10711:                                    ok
<a name="10712"/>10712:                            end
<a name="10713"/>10713:                    end},
<a name="10714"/>10714:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10715"/>10715:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10716"/>10716:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10717"/>10717:                            ok
<a name="10718"/>10718:                    end},
<a name="10719"/>10719: 
<a name="10720"/>10720:          %% *** Termination ***
<a name="10721"/>10721:          #{desc =&gt; &quot;await terminate&quot;,
<a name="10722"/>10722:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10723"/>10723:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10724"/>10724:                                ok -&gt;
<a name="10725"/>10725:                                    {ok, maps:remove(tester, State)};
<a name="10726"/>10726:                                {error, _} = ERROR -&gt;
<a name="10727"/>10727:                                    ERROR
<a name="10728"/>10728:                            end
<a name="10729"/>10729:                    end},
<a name="10730"/>10730:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="10731"/>10731:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="10732"/>10732:                            socket:close(Sock)
<a name="10733"/>10733:                    end},
<a name="10734"/>10734: 
<a name="10735"/>10735:          %% *** We are done ***
<a name="10736"/>10736:          ?SEV_FINISH_NORMAL
<a name="10737"/>10737:         ],
<a name="10738"/>10738: 
<a name="10739"/>10739:     AltServerSeq =
<a name="10740"/>10740:         [
<a name="10741"/>10741:          %% *** Wait for start order part ***
<a name="10742"/>10742:          #{desc =&gt; &quot;await start&quot;,
<a name="10743"/>10743:            cmd  =&gt; fun(State) -&gt;
<a name="10744"/>10744:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="10745"/>10745:                            {ok, State#{tester =&gt; Tester, sock =&gt; Sock}}
<a name="10746"/>10746:                    end},
<a name="10747"/>10747:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10748"/>10748:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10749"/>10749:                            _MRef = erlang:monitor(process, Tester),
<a name="10750"/>10750:                            ok
<a name="10751"/>10751:                    end},
<a name="10752"/>10752:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10753"/>10753:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10754"/>10754:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="10755"/>10755:                            ok
<a name="10756"/>10756:                    end},
<a name="10757"/>10757: 
<a name="10758"/>10758:          %% The actual test
<a name="10759"/>10759:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="10760"/>10760:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10761"/>10761:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="10762"/>10762:                    end},
<a name="10763"/>10763:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="10764"/>10764:            cmd  =&gt; fun(#{sock     := Sock,
<a name="10765"/>10765:                          recv     := Recv,
<a name="10766"/>10766:                          recv_ref := Ref} = State) -&gt;
<a name="10767"/>10767:                            case Recv(Sock) of
<a name="10768"/>10768:                                {select, SI} when Ref =:= nowait -&gt;
<a name="10769"/>10769:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10770"/>10770:                                {select, {select_info, _Tag, Ref} = SI}
<a name="10771"/>10771:                                  when is_reference(Ref) -&gt;
<a name="10772"/>10772:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10773"/>10773: 
<a name="10774"/>10774:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="10775"/>10775:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10776"/>10776:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="10777"/>10777:                                  when is_reference(Ref) -&gt;
<a name="10778"/>10778:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10779"/>10779: 
<a name="10780"/>10780:                                {ok, X} -&gt;
<a name="10781"/>10781:                                    {error, {unexpected_success, X}};
<a name="10782"/>10782: 
<a name="10783"/>10783:                                {error, _} = ERROR -&gt;
<a name="10784"/>10784:                                    ERROR
<a name="10785"/>10785:                            end
<a name="10786"/>10786:                    end},
<a name="10787"/>10787:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="10788"/>10788:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10789"/>10789:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="10790"/>10790:                            ok
<a name="10791"/>10791:                    end},
<a name="10792"/>10792:          #{desc =&gt; &quot;await abort message&quot;,
<a name="10793"/>10793:            cmd  =&gt; fun(#{sock             := Sock,
<a name="10794"/>10794:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10795"/>10795:                            receive
<a name="10796"/>10796:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10797"/>10797:                                    {error, {unexpected_select, Ref}};
<a name="10798"/>10798:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10799"/>10799:                                    {ok, maps:remove(sock, State)}
<a name="10800"/>10800:                            after 5000 -&gt;
<a name="10801"/>10801:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="10802"/>10802:                                    {error, timeout}
<a name="10803"/>10803:                            end;
<a name="10804"/>10804:                       (#{sock             := Sock,
<a name="10805"/>10805:                          recv_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="10806"/>10806:                            receive
<a name="10807"/>10807:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="10808"/>10808:                                    {error, {unexpected_completion, C}};
<a name="10809"/>10809:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10810"/>10810:                                    {ok, maps:remove(sock, State)}
<a name="10811"/>10811:                            after 5000 -&gt;
<a name="10812"/>10812:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [?MQ()]),
<a name="10813"/>10813:                                    {error, timeout}
<a name="10814"/>10814:                            end
<a name="10815"/>10815:                    end},
<a name="10816"/>10816:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10817"/>10817:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10818"/>10818:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10819"/>10819:                            ok
<a name="10820"/>10820:                    end},
<a name="10821"/>10821: 
<a name="10822"/>10822:          %% Termination
<a name="10823"/>10823:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="10824"/>10824:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10825"/>10825:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10826"/>10826:                                ok -&gt;
<a name="10827"/>10827:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="10828"/>10828:                                    State1 = maps:remove(recv_select_info, State),
<a name="10829"/>10829:                                    State2 = maps:remove(recv_completion_info, State1),
<a name="10830"/>10830:                                    State3 = maps:remove(tester,           State2),
<a name="10831"/>10831:                                    State4 = maps:remove(sock,             State3),
<a name="10832"/>10832:                                    {ok, State4};
<a name="10833"/>10833:                                {error, _} = ERROR -&gt;
<a name="10834"/>10834:                                    ERROR
<a name="10835"/>10835:                            end
<a name="10836"/>10836:                    end},
<a name="10837"/>10837: 
<a name="10838"/>10838:          %% *** We are done ***
<a name="10839"/>10839:          ?SEV_FINISH_NORMAL
<a name="10840"/>10840:         ],
<a name="10841"/>10841: 
<a name="10842"/>10842:     ClientSeq = 
<a name="10843"/>10843:         [
<a name="10844"/>10844:          %% *** Wait for start order ***
<a name="10845"/>10845:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="10846"/>10846:            cmd  =&gt; fun(State) -&gt;
<a name="10847"/>10847:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="10848"/>10848:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="10849"/>10849:                    end},
<a name="10850"/>10850:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10851"/>10851:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10852"/>10852:                            _MRef = erlang:monitor(process, Tester),
<a name="10853"/>10853:                            ok
<a name="10854"/>10854:                    end},
<a name="10855"/>10855: 
<a name="10856"/>10856:          %% *** The init part ***
<a name="10857"/>10857:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="10858"/>10858:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="10859"/>10859:                            LSA = which_local_socket_addr(Domain),
<a name="10860"/>10860:                            SSA = LSA#{port =&gt; Port},
<a name="10861"/>10861:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="10862"/>10862:                    end},
<a name="10863"/>10863:          #{desc =&gt; &quot;create socket&quot;,
<a name="10864"/>10864:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10865"/>10865:                            case socket:open(Domain, stream, tcp) of
<a name="10866"/>10866:                                {ok, Sock} -&gt;
<a name="10867"/>10867:                                    {ok, State#{sock =&gt; Sock}};
<a name="10868"/>10868:                                {error, _} = ERROR -&gt;
<a name="10869"/>10869:                                    ERROR
<a name="10870"/>10870:                            end
<a name="10871"/>10871:                    end},
<a name="10872"/>10872:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="10873"/>10873:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="10874"/>10874:                            case sock_bind(Sock, LSA) of
<a name="10875"/>10875:                                ok -&gt;
<a name="10876"/>10876:                                    ok;
<a name="10877"/>10877:                                {error, _} = ERROR -&gt;
<a name="10878"/>10878:                                    ERROR
<a name="10879"/>10879:                            end
<a name="10880"/>10880:                    end},
<a name="10881"/>10881:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10882"/>10882:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10883"/>10883:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="10884"/>10884:                            ok
<a name="10885"/>10885:                    end},
<a name="10886"/>10886: 
<a name="10887"/>10887:          %% *** The actual test ***
<a name="10888"/>10888:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="10889"/>10889:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10890"/>10890:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="10891"/>10891:                    end},
<a name="10892"/>10892:          #{desc =&gt; &quot;connect to server&quot;,
<a name="10893"/>10893:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="10894"/>10894:                            socket:connect(Sock, SSA)
<a name="10895"/>10895:                    end},
<a name="10896"/>10896:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="10897"/>10897:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10898"/>10898:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="10899"/>10899:                            ok
<a name="10900"/>10900:                    end},
<a name="10901"/>10901: 
<a name="10902"/>10902:          %% *** Termination ***
<a name="10903"/>10903:          #{desc =&gt; &quot;await terminate&quot;,
<a name="10904"/>10904:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10905"/>10905:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10906"/>10906:                                ok -&gt;
<a name="10907"/>10907:                                    {ok, maps:remove(tester, State)};
<a name="10908"/>10908:                                {error, _} = ERROR -&gt;
<a name="10909"/>10909:                                    ERROR
<a name="10910"/>10910:                            end
<a name="10911"/>10911:                    end},
<a name="10912"/>10912:          #{desc =&gt; &quot;close socket&quot;,
<a name="10913"/>10913:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="10914"/>10914:                            socket:close(Sock)
<a name="10915"/>10915:                    end},
<a name="10916"/>10916: 
<a name="10917"/>10917:          %% *** We are done ***
<a name="10918"/>10918:          ?SEV_FINISH_NORMAL
<a name="10919"/>10919:         ],
<a name="10920"/>10920: 
<a name="10921"/>10921:     TesterSeq =
<a name="10922"/>10922:         [
<a name="10923"/>10923:          %% *** Init part ***
<a name="10924"/>10924:          #{desc =&gt; &quot;monitor server&quot;,
<a name="10925"/>10925:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10926"/>10926:                            _MRef = erlang:monitor(process, Pid),
<a name="10927"/>10927:                            ok
<a name="10928"/>10928:                    end},
<a name="10929"/>10929:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="10930"/>10930:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10931"/>10931:                            _MRef = erlang:monitor(process, Pid),
<a name="10932"/>10932:                            ok
<a name="10933"/>10933:                    end},
<a name="10934"/>10934:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="10935"/>10935:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10936"/>10936:                            _MRef = erlang:monitor(process, Pid),
<a name="10937"/>10937:                            ok
<a name="10938"/>10938:                    end},
<a name="10939"/>10939:          #{desc =&gt; &quot;monitor client&quot;,
<a name="10940"/>10940:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10941"/>10941:                            _MRef = erlang:monitor(process, Pid),
<a name="10942"/>10942:                            ok
<a name="10943"/>10943:                    end},
<a name="10944"/>10944: 
<a name="10945"/>10945:          %% Start the server
<a name="10946"/>10946:          #{desc =&gt; &quot;order server start&quot;,
<a name="10947"/>10947:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10948"/>10948:                            ?SEV_ANNOUNCE_START(Pid),
<a name="10949"/>10949:                            ok
<a name="10950"/>10950:                    end},
<a name="10951"/>10951:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="10952"/>10952:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10953"/>10953:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="10954"/>10954:                            {ok, State#{server_port =&gt; Port}}
<a name="10955"/>10955:                    end},
<a name="10956"/>10956: 
<a name="10957"/>10957:          %% Start the client
<a name="10958"/>10958:          #{desc =&gt; &quot;order client start&quot;,
<a name="10959"/>10959:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="10960"/>10960:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="10961"/>10961:                            ok
<a name="10962"/>10962:                    end},
<a name="10963"/>10963:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="10964"/>10964:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10965"/>10965:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="10966"/>10966:                    end},
<a name="10967"/>10967: 
<a name="10968"/>10968:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="10969"/>10969:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="10970"/>10970:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="10971"/>10971:                            ok
<a name="10972"/>10972:                    end},
<a name="10973"/>10973:          #{desc =&gt; &quot;order client to continue (connect)&quot;,
<a name="10974"/>10974:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10975"/>10975:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="10976"/>10976:                            ok
<a name="10977"/>10977:                    end},
<a name="10978"/>10978:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="10979"/>10979:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10980"/>10980:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="10981"/>10981:                    end},
<a name="10982"/>10982:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="10983"/>10983:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10984"/>10984:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, accept),
<a name="10985"/>10985:                            {ok, State#{sock =&gt; Sock}}
<a name="10986"/>10986:                    end},
<a name="10987"/>10987: 
<a name="10988"/>10988:          %% Start the alt server 1
<a name="10989"/>10989:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="10990"/>10990:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="10991"/>10991:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10992"/>10992:                            ok
<a name="10993"/>10993:                    end},
<a name="10994"/>10994:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="10995"/>10995:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10996"/>10996:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="10997"/>10997:                    end},
<a name="10998"/>10998: 
<a name="10999"/>10999:          %% Start the alt server 2
<a name="11000"/>11000:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="11001"/>11001:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="11002"/>11002:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="11003"/>11003:                            ok
<a name="11004"/>11004:                    end},
<a name="11005"/>11005:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="11006"/>11006:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11007"/>11007:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="11008"/>11008:                    end},
<a name="11009"/>11009: 
<a name="11010"/>11010: 
<a name="11011"/>11011:          %% *** The actual test ***
<a name="11012"/>11012:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="11013"/>11013:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11014"/>11014:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="11015"/>11015:                            ok
<a name="11016"/>11016:                    end},
<a name="11017"/>11017:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="11018"/>11018:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11019"/>11019:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="11020"/>11020:                    end},
<a name="11021"/>11021: 
<a name="11022"/>11022:          #{desc =&gt; &quot;order alt-server 1 continue (recv)&quot;,
<a name="11023"/>11023:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11024"/>11024:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="11025"/>11025:                            ok
<a name="11026"/>11026:                    end},
<a name="11027"/>11027:          #{desc =&gt; &quot;await alt-server 1 ready (recv select)&quot;,
<a name="11028"/>11028:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11029"/>11029:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, recv_select)
<a name="11030"/>11030:                    end},
<a name="11031"/>11031: 
<a name="11032"/>11032:          #{desc =&gt; &quot;order alt-server 2 continue (recv)&quot;,
<a name="11033"/>11033:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11034"/>11034:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="11035"/>11035:                            ok
<a name="11036"/>11036:                    end},
<a name="11037"/>11037:          #{desc =&gt; &quot;await alt-server 2 ready (recv select)&quot;,
<a name="11038"/>11038:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11039"/>11039:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, recv_select)
<a name="11040"/>11040:                    end},
<a name="11041"/>11041: 
<a name="11042"/>11042:          ?SEV_SLEEP(?SECS(1)),
<a name="11043"/>11043: 
<a name="11044"/>11044:          #{desc =&gt; &quot;close the socket&quot;,
<a name="11045"/>11045:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="11046"/>11046:                            socket:close(Sock)
<a name="11047"/>11047:                    end},
<a name="11048"/>11048: 
<a name="11049"/>11049:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="11050"/>11050:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11051"/>11051:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="11052"/>11052:                    end},
<a name="11053"/>11053:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="11054"/>11054:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11055"/>11055:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="11056"/>11056:                    end},
<a name="11057"/>11057:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="11058"/>11058:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11059"/>11059:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="11060"/>11060:                    end},
<a name="11061"/>11061: 
<a name="11062"/>11062:          %% Terminations
<a name="11063"/>11063:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="11064"/>11064:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="11065"/>11065:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="11066"/>11066:                            ok
<a name="11067"/>11067:                    end},
<a name="11068"/>11068:          #{desc =&gt; &quot;await client termination&quot;,
<a name="11069"/>11069:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="11070"/>11070:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="11071"/>11071:                            State1 = maps:remove(client, State),
<a name="11072"/>11072:                            {ok, State1}
<a name="11073"/>11073:                    end},
<a name="11074"/>11074: 
<a name="11075"/>11075:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="11076"/>11076:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11077"/>11077:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="11078"/>11078:                            ok
<a name="11079"/>11079:                    end},
<a name="11080"/>11080:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="11081"/>11081:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="11082"/>11082:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="11083"/>11083:                                ok -&gt;
<a name="11084"/>11084:                                    State1 = maps:remove(alt_server2, State),
<a name="11085"/>11085:                                    {ok, State1};
<a name="11086"/>11086:                                {error, _} = ERROR -&gt;
<a name="11087"/>11087:                                    ERROR
<a name="11088"/>11088:                            end
<a name="11089"/>11089:                    end},
<a name="11090"/>11090: 
<a name="11091"/>11091:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="11092"/>11092:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11093"/>11093:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="11094"/>11094:                            ok
<a name="11095"/>11095:                    end},
<a name="11096"/>11096:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="11097"/>11097:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="11098"/>11098:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="11099"/>11099:                                ok -&gt;
<a name="11100"/>11100:                                    State1 = maps:remove(alt_server1, State),
<a name="11101"/>11101:                                    {ok, State1};
<a name="11102"/>11102:                                {error, _} = ERROR -&gt;
<a name="11103"/>11103:                                    ERROR
<a name="11104"/>11104:                            end
<a name="11105"/>11105:                    end},
<a name="11106"/>11106: 
<a name="11107"/>11107:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="11108"/>11108:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11109"/>11109:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="11110"/>11110:                            ok
<a name="11111"/>11111:                    end},
<a name="11112"/>11112:          #{desc =&gt; &quot;await server termination&quot;,
<a name="11113"/>11113:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="11114"/>11114:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="11115"/>11115:                                ok -&gt;
<a name="11116"/>11116:                                    State1 = maps:remove(server, State),
<a name="11117"/>11117:                                    {ok, State1};
<a name="11118"/>11118:                                {error, _} = ERROR -&gt;
<a name="11119"/>11119:                                    ERROR
<a name="11120"/>11120:                            end
<a name="11121"/>11121:                    end},
<a name="11122"/>11122: 
<a name="11123"/>11123: 
<a name="11124"/>11124:          %% *** We are done ***
<a name="11125"/>11125:          ?SEV_FINISH_NORMAL
<a name="11126"/>11126:         ],
<a name="11127"/>11127: 
<a name="11128"/>11128:     i(&quot;start server evaluator&quot;),
<a name="11129"/>11129:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="11130"/>11130: 
<a name="11131"/>11131:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="11132"/>11132:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="11133"/>11133: 
<a name="11134"/>11134:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="11135"/>11135:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="11136"/>11136: 
<a name="11137"/>11137:     i(&quot;start client evaluator&quot;),
<a name="11138"/>11138:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="11139"/>11139: 
<a name="11140"/>11140:     i(&quot;start tester evaluator&quot;),
<a name="11141"/>11141:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="11142"/>11142:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="11143"/>11143:                         alt_server2 =&gt; AltServer2#ev.pid,
<a name="11144"/>11144:                         client      =&gt; Client#ev.pid},
<a name="11145"/>11145:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="11146"/>11146: 
<a name="11147"/>11147:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_mrecv_cancel_tcp-last_expr"/><a name="11148"/>11148: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Client, Tester]).
<a name="11149"/>11149: 
<a name="11150"/>11150: 
<a name="11151"/>11151: 
<a name="11152"/>11152: 
<a name="11153"/>11153: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11154"/>11154: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11155"/>11155: <i>%%                                                                     %%</i>
<a name="11156"/>11156: <i>%%                           API OPTIONS                               %%</i>
<a name="11157"/>11157: <i>%%                                                                     %%</i>
<a name="11158"/>11158: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11159"/>11159: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11160"/>11160: 
<a name="11161"/>11161: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11162"/>11162: 
<a name="11163"/>11163: <i>%% Perform some simple getopt and setopt with the level = otp options</i>
<a name="api_opt_simple_otp_options-1"/><a name="11164"/>11164: <b>api_opt_simple_otp_options</b>(_Config) when is_list(_Config) -&gt;
<a name="11165"/>11165:     ?TT(?SECS(5)),
<a name="api_opt_simple_otp_options-last_expr"/><a name="11166"/>11166: <b>    tc_try</b>(api_opt_simple_otp_options,
<a name="11167"/>11167:            fun() -&gt; api_opt_simple_otp_options() end).
<a name="11168"/>11168: 
<a name="api_opt_simple_otp_options-0"/><a name="11169"/>11169: <b>api_opt_simple_otp_options</b>() -&gt;
<a name="11170"/>11170:     Get = fun(S, Key) -&gt;
<a name="11171"/>11171:                   socket:getopt(S, otp, Key)
<a name="11172"/>11172:           end,
<a name="11173"/>11173:     Set = fun(S, Key, Val) -&gt;
<a name="11174"/>11174:                   socket:setopt(S, otp, Key, Val)
<a name="11175"/>11175:           end,
<a name="11176"/>11176: 
<a name="11177"/>11177:     Seq = 
<a name="11178"/>11178:         [
<a name="11179"/>11179:          %% *** Init part ***
<a name="11180"/>11180:          #{desc =&gt; &quot;create socket&quot;,
<a name="11181"/>11181:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="11182"/>11182:                          type     := Type,
<a name="11183"/>11183:                          protocol := Protocol} = State) -&gt;
<a name="11184"/>11184:                            Sock = sock_open(Domain, Type, Protocol),
<a name="11185"/>11185:                            {ok, State#{sock =&gt; Sock}}
<a name="11186"/>11186:                    end},
<a name="11187"/>11187:          #{desc =&gt; &quot;create dummy process&quot;,
<a name="11188"/>11188:            cmd  =&gt; fun(State) -&gt;
<a name="11189"/>11189:                            Pid =  spawn_link(fun() -&gt; 
<a name="11190"/>11190:                                                      put(sname, &quot;dummy&quot;),
<a name="11191"/>11191:                                                      receive
<a name="11192"/>11192:                                                          die -&gt; 
<a name="11193"/>11193:                                                              exit(normal) 
<a name="11194"/>11194:                                                      end 
<a name="11195"/>11195:                                              end),
<a name="11196"/>11196:                            {ok, State#{dummy =&gt; Pid}}
<a name="11197"/>11197:                    end},
<a name="11198"/>11198: 
<a name="11199"/>11199:          %% *** Check iow part ***
<a name="11200"/>11200:          #{desc =&gt; &quot;get iow&quot;,
<a name="11201"/>11201:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11202"/>11202:                            case Get(Sock, iow) of
<a name="11203"/>11203:                                {ok, IOW} when is_boolean(IOW) -&gt;
<a name="11204"/>11204:                                    {ok, State#{iow =&gt; IOW}};
<a name="11205"/>11205:                                {ok, _} = OK -&gt;
<a name="11206"/>11206:                                    {error, OK};
<a name="11207"/>11207:                                {error, _} = ERROR -&gt;
<a name="11208"/>11208:                                    ERROR
<a name="11209"/>11209:                            end
<a name="11210"/>11210:                    end},
<a name="11211"/>11211: 
<a name="11212"/>11212:          %% #{desc =&gt; &quot;enable debug&quot;,
<a name="11213"/>11213:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="11214"/>11214:          %%                   ok = socket:setopt(Sock, otp, debug, true)
<a name="11215"/>11215:          %%           end},
<a name="11216"/>11216: 
<a name="11217"/>11217:          #{desc =&gt; &quot;set (new) iow&quot;,
<a name="11218"/>11218:            cmd  =&gt; fun(#{sock := Sock, iow := OldIOW} = State) -&gt;
<a name="11219"/>11219:                            NewIOW = not OldIOW,
<a name="11220"/>11220:                            case Set(Sock, iow, NewIOW) of
<a name="11221"/>11221:                                ok -&gt;
<a name="11222"/>11222:                                    {ok, State#{iow =&gt; NewIOW}};
<a name="11223"/>11223:                                {error, _} = ERROR -&gt;
<a name="11224"/>11224:                                    ERROR
<a name="11225"/>11225:                            end
<a name="11226"/>11226:                    end},
<a name="11227"/>11227:          #{desc =&gt; &quot;get (new) iow&quot;,
<a name="11228"/>11228:            cmd  =&gt; fun(#{sock := Sock, iow := IOW}) -&gt;
<a name="11229"/>11229:                            case Get(Sock, iow) of
<a name="11230"/>11230:                                {ok, IOW} -&gt;
<a name="11231"/>11231:                                    ok;
<a name="11232"/>11232:                                {ok, _} = OK-&gt;
<a name="11233"/>11233:                                    {error, OK};
<a name="11234"/>11234:                                {error, _} = ERROR -&gt;
<a name="11235"/>11235:                                    ERROR
<a name="11236"/>11236:                            end
<a name="11237"/>11237:                    end},
<a name="11238"/>11238: 
<a name="11239"/>11239:          %% *** Check rcvbuf part ***
<a name="11240"/>11240:          #{desc =&gt; &quot;get rcvbuf&quot;,
<a name="11241"/>11241:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11242"/>11242:                            case Get(Sock, rcvbuf) of
<a name="11243"/>11243:                                {ok, RcvBuf} when is_integer(RcvBuf) -&gt;
<a name="11244"/>11244:                                    {ok, State#{rcvbuf =&gt; RcvBuf}};
<a name="11245"/>11245:                                {ok, {N, RcvBuf} = V} when is_integer(N) andalso 
<a name="11246"/>11246:                                                           is_integer(RcvBuf) -&gt;
<a name="11247"/>11247:                                    {ok, State#{rcvbuf =&gt; V}};
<a name="11248"/>11248:                                {ok, _} = OK -&gt;
<a name="11249"/>11249:                                    {error, OK};
<a name="11250"/>11250:                                {error, _} = ERROR -&gt;
<a name="11251"/>11251:                                    ERROR
<a name="11252"/>11252:                            end
<a name="11253"/>11253:                    end},
<a name="11254"/>11254:          #{desc =&gt; &quot;set (new) rcvbuf&quot;,
<a name="11255"/>11255:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := {OldN, OldRcvBuf}} = State) -&gt;
<a name="11256"/>11256:                            NewRcvBuf = {OldN+2, OldRcvBuf + 1024},
<a name="11257"/>11257:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="11258"/>11258:                                ok -&gt;
<a name="11259"/>11259:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11260"/>11260:                                {error, _} = ERROR -&gt;
<a name="11261"/>11261:                                    ERROR
<a name="11262"/>11262:                            end;
<a name="11263"/>11263:                       (#{sock := Sock, rcvbuf := OldRcvBuf} = State) when is_integer(OldRcvBuf) -&gt;
<a name="11264"/>11264:                            NewRcvBuf = 2 * OldRcvBuf,
<a name="11265"/>11265:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="11266"/>11266:                                ok -&gt;
<a name="11267"/>11267:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11268"/>11268:                                {error, _} = ERROR -&gt;
<a name="11269"/>11269:                                    ERROR
<a name="11270"/>11270:                            end;
<a name="11271"/>11271:                       (#{sock := Sock, rcvbuf := OldRcvBuf,
<a name="11272"/>11272:                          type := stream,
<a name="11273"/>11273:                          protocol := tcp} = State) when is_integer(OldRcvBuf) -&gt;
<a name="11274"/>11274:                            NewRcvBuf = {2, OldRcvBuf},
<a name="11275"/>11275:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="11276"/>11276:                                ok -&gt;
<a name="11277"/>11277:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11278"/>11278:                                {error, _} = ERROR -&gt;
<a name="11279"/>11279:                                    ERROR
<a name="11280"/>11280:                            end
<a name="11281"/>11281:                    end},
<a name="11282"/>11282:          #{desc =&gt; &quot;get (new) rcvbuf&quot;,
<a name="11283"/>11283:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := RcvBuf}) -&gt;
<a name="11284"/>11284:                            case Get(Sock, rcvbuf) of
<a name="11285"/>11285:                                {ok, RcvBuf} -&gt;
<a name="11286"/>11286:                                    ok;
<a name="11287"/>11287:                                {ok, _} = OK -&gt;
<a name="11288"/>11288:                                    {error, OK};
<a name="11289"/>11289:                                {error, _} = ERROR -&gt;
<a name="11290"/>11290:                                    ERROR
<a name="11291"/>11291:                            end
<a name="11292"/>11292:                    end},
<a name="11293"/>11293: 
<a name="11294"/>11294:          %% *** Check rcvctrlbuf part ***
<a name="11295"/>11295:          #{desc =&gt; &quot;get rcvctrlbuf&quot;,
<a name="11296"/>11296:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11297"/>11297:                            case Get(Sock, rcvctrlbuf) of
<a name="11298"/>11298:                                {ok, RcvCtrlBuf} when is_integer(RcvCtrlBuf) -&gt;
<a name="11299"/>11299:                                    {ok, State#{rcvctrlbuf =&gt; RcvCtrlBuf}};
<a name="11300"/>11300:                                {ok, _} = OK -&gt;
<a name="11301"/>11301:                                    {error, OK};
<a name="11302"/>11302:                                {error, _} = ERROR -&gt;
<a name="11303"/>11303:                                    ERROR
<a name="11304"/>11304:                            end
<a name="11305"/>11305:                    end},
<a name="11306"/>11306:          #{desc =&gt; &quot;set (new) rcvctrlbuf&quot;,
<a name="11307"/>11307:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := OldRcvCtrlBuf} = State) -&gt;
<a name="11308"/>11308:                            NewRcvCtrlBuf = 2 * OldRcvCtrlBuf,
<a name="11309"/>11309:                            case Set(Sock, rcvctrlbuf, NewRcvCtrlBuf) of
<a name="11310"/>11310:                                ok -&gt;
<a name="11311"/>11311:                                    {ok, State#{rcvctrlbuf =&gt; NewRcvCtrlBuf}};
<a name="11312"/>11312:                                {error, _} = ERROR -&gt;
<a name="11313"/>11313:                                    ERROR
<a name="11314"/>11314:                            end
<a name="11315"/>11315:                    end},
<a name="11316"/>11316:          #{desc =&gt; &quot;get (new) rcvctrlbuf&quot;,
<a name="11317"/>11317:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := RcvCtrlBuf}) -&gt;
<a name="11318"/>11318:                            case Get(Sock, rcvctrlbuf) of
<a name="11319"/>11319:                                {ok, RcvCtrlBuf} -&gt;
<a name="11320"/>11320:                                    ok;
<a name="11321"/>11321:                                {ok, _} = OK -&gt;
<a name="11322"/>11322:                                    {error, OK};
<a name="11323"/>11323:                                {error, _} = ERROR -&gt;
<a name="11324"/>11324:                                    ERROR
<a name="11325"/>11325:                            end
<a name="11326"/>11326:                    end},
<a name="11327"/>11327:          %% *** Check rcvctrlbuf part ***
<a name="11328"/>11328:          #{desc =&gt; &quot;get rcvctrlbuf&quot;,
<a name="11329"/>11329:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11330"/>11330:                            case Get(Sock, rcvctrlbuf) of
<a name="11331"/>11331:                                {ok, RcvCtrlBuf} when is_integer(RcvCtrlBuf) -&gt;
<a name="11332"/>11332:                                    {ok, State#{rcvctrlbuf =&gt; RcvCtrlBuf}};
<a name="11333"/>11333:                                {ok, _} = OK -&gt;
<a name="11334"/>11334:                                    {error, OK};
<a name="11335"/>11335:                                {error, _} = ERROR -&gt;
<a name="11336"/>11336:                                    ERROR
<a name="11337"/>11337:                            end
<a name="11338"/>11338:                    end},
<a name="11339"/>11339:          #{desc =&gt; &quot;set (new) rcvctrlbuf&quot;,
<a name="11340"/>11340:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := OldRcvCtrlBuf} = State) -&gt;
<a name="11341"/>11341:                            NewRcvCtrlBuf = 2 * OldRcvCtrlBuf,
<a name="11342"/>11342:                            case Set(Sock, rcvctrlbuf, NewRcvCtrlBuf) of
<a name="11343"/>11343:                                ok -&gt;
<a name="11344"/>11344:                                    {ok, State#{rcvctrlbuf =&gt; NewRcvCtrlBuf}};
<a name="11345"/>11345:                                {error, _} = ERROR -&gt;
<a name="11346"/>11346:                                    ERROR
<a name="11347"/>11347:                            end
<a name="11348"/>11348:                    end},
<a name="11349"/>11349:          #{desc =&gt; &quot;get (new) rcvctrlbuf&quot;,
<a name="11350"/>11350:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := RcvCtrlBuf}) -&gt;
<a name="11351"/>11351:                            case Get(Sock, rcvctrlbuf) of
<a name="11352"/>11352:                                {ok, RcvCtrlBuf} -&gt;
<a name="11353"/>11353:                                    ok;
<a name="11354"/>11354:                                {ok, _} = OK -&gt;
<a name="11355"/>11355:                                    {error, OK};
<a name="11356"/>11356:                                {error, _} = ERROR -&gt;
<a name="11357"/>11357:                                    ERROR
<a name="11358"/>11358:                            end
<a name="11359"/>11359:                    end},
<a name="11360"/>11360: 
<a name="11361"/>11361: 
<a name="11362"/>11362:          %% *** Check sndctrlbuf part ***
<a name="11363"/>11363:          #{desc =&gt; &quot;get sndctrlbuf&quot;,
<a name="11364"/>11364:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11365"/>11365:                            case Get(Sock, sndctrlbuf) of
<a name="11366"/>11366:                                {ok, SndCtrlBuf} when is_integer(SndCtrlBuf) -&gt;
<a name="11367"/>11367:                                    {ok, State#{sndctrlbuf =&gt; SndCtrlBuf}};
<a name="11368"/>11368:                                {ok, _} = OK -&gt;
<a name="11369"/>11369:                                    {error, OK};
<a name="11370"/>11370:                                {error, _} = ERROR -&gt;
<a name="11371"/>11371:                                    ERROR
<a name="11372"/>11372:                            end
<a name="11373"/>11373:                    end},
<a name="11374"/>11374:          #{desc =&gt; &quot;set (new) sndctrlbuf&quot;,
<a name="11375"/>11375:            cmd  =&gt; fun(#{sock := Sock, sndctrlbuf := OldSndCtrlBuf} = State) -&gt;
<a name="11376"/>11376:                            NewSndCtrlBuf = 2 * OldSndCtrlBuf,
<a name="11377"/>11377:                            case Set(Sock, sndctrlbuf, NewSndCtrlBuf) of
<a name="11378"/>11378:                                ok -&gt;
<a name="11379"/>11379:                                    {ok, State#{sndctrlbuf =&gt; NewSndCtrlBuf}};
<a name="11380"/>11380:                                {error, _} = ERROR -&gt;
<a name="11381"/>11381:                                    ERROR
<a name="11382"/>11382:                            end
<a name="11383"/>11383:                    end},
<a name="11384"/>11384:          #{desc =&gt; &quot;get (new) sndctrlbuf&quot;,
<a name="11385"/>11385:            cmd  =&gt; fun(#{sock := Sock, sndctrlbuf := SndCtrlBuf}) -&gt;
<a name="11386"/>11386:                            case Get(Sock, sndctrlbuf) of
<a name="11387"/>11387:                                {ok, SndCtrlBuf} -&gt;
<a name="11388"/>11388:                                    ok;
<a name="11389"/>11389:                                {ok, _} = OK-&gt;
<a name="11390"/>11390:                                    {error, OK};
<a name="11391"/>11391:                                {error, _} = ERROR -&gt;
<a name="11392"/>11392:                                    ERROR
<a name="11393"/>11393:                            end
<a name="11394"/>11394:                    end},
<a name="11395"/>11395: 
<a name="11396"/>11396:          %% *** Check controlling-process part ***
<a name="11397"/>11397:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="11398"/>11398:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="11399"/>11399:                            Self = self(),
<a name="11400"/>11400:                            case Get(Sock, controlling_process) of
<a name="11401"/>11401:                                {ok, Self} -&gt;
<a name="11402"/>11402:                                    ok;
<a name="11403"/>11403:                                {ok, _} = OK -&gt;
<a name="11404"/>11404:                                    {error, OK};
<a name="11405"/>11405:                                {error, _} = ERROR -&gt;
<a name="11406"/>11406:                                    ERROR
<a name="11407"/>11407:                            end
<a name="11408"/>11408:                    end},
<a name="11409"/>11409:          #{desc =&gt; &quot;set dummy as controlling-process&quot;,
<a name="11410"/>11410:            cmd  =&gt; fun(#{sock := Sock, dummy := Dummy}) -&gt;
<a name="11411"/>11411:                            Set(Sock, controlling_process, Dummy)
<a name="11412"/>11412:                    end},
<a name="11413"/>11413:          #{desc =&gt; &quot;verify dummy as controlling-process&quot;,
<a name="11414"/>11414:            cmd  =&gt; fun(#{sock := Sock, dummy := Dummy}) -&gt;
<a name="11415"/>11415:                            case Get(Sock, controlling_process) of
<a name="11416"/>11416:                                {ok, Dummy} -&gt;
<a name="11417"/>11417:                                    ok;
<a name="11418"/>11418:                                {ok, _} = OK -&gt;
<a name="11419"/>11419:                                    {error, OK};
<a name="11420"/>11420:                                {error, _} = ERROR -&gt;
<a name="11421"/>11421:                                    ERROR
<a name="11422"/>11422:                            end
<a name="11423"/>11423:                    end},
<a name="11424"/>11424: 
<a name="11425"/>11425:          %% *** We are done ***
<a name="11426"/>11426:          #{desc =&gt; &quot;finish&quot;,
<a name="11427"/>11427:            cmd  =&gt; fun(#{ dummy := Dummy }) -&gt;
<a name="11428"/>11428:                            Dummy ! die,
<a name="11429"/>11429:                            {ok, normal}
<a name="11430"/>11430:                    end}
<a name="11431"/>11431:         ],
<a name="11432"/>11432: 
<a name="11433"/>11433:     i(&quot;start tcp (stream) evaluator&quot;),
<a name="11434"/>11434:     InitState1 = #{domain =&gt; inet, type =&gt; stream, protocol =&gt; tcp},
<a name="11435"/>11435:     Tester1 = ?SEV_START(&quot;tcp-tester&quot;, Seq, InitState1),
<a name="11436"/>11436:     i(&quot;await tcp evaluator&quot;),
<a name="11437"/>11437:     ok = ?SEV_AWAIT_FINISH([Tester1]),
<a name="11438"/>11438: 
<a name="11439"/>11439:     i(&quot;start udp (dgram) socket&quot;),
<a name="11440"/>11440:     InitState2 = #{domain =&gt; inet, type =&gt; dgram, protocol =&gt; udp},
<a name="11441"/>11441:     Tester2 = ?SEV_START(&quot;udp-tester&quot;, Seq, InitState2),
<a name="11442"/>11442:     i(&quot;await udp evaluator&quot;),
<a name="api_opt_simple_otp_options-last_expr"/><a name="11443"/>11443: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester2]).
<a name="11444"/>11444: 
<a name="11445"/>11445: 
<a name="11446"/>11446: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11447"/>11447: 
<a name="11448"/>11448: <i>%% Perform some simple getopt and setopt otp meta option</i>
<a name="api_opt_simple_otp_meta_option-1"/><a name="11449"/>11449: <b>api_opt_simple_otp_meta_option</b>(_Config) when is_list(_Config) -&gt;
<a name="11450"/>11450:     ?TT(?SECS(5)),
<a name="api_opt_simple_otp_meta_option-last_expr"/><a name="11451"/>11451: <b>    tc_try</b>(api_opt_simple_otp_meta_option,
<a name="11452"/>11452:            fun() -&gt; api_opt_simple_otp_meta_option() end).
<a name="11453"/>11453: 
<a name="api_opt_simple_otp_meta_option-0"/><a name="11454"/>11454: <b>api_opt_simple_otp_meta_option</b>() -&gt;
<a name="11455"/>11455:     Get = fun(S) -&gt;
<a name="11456"/>11456:                   socket:getopt(S, otp, meta)
<a name="11457"/>11457:           end,
<a name="11458"/>11458:     Set = fun(S, Val) -&gt;
<a name="11459"/>11459:                   socket:setopt(S, otp, meta, Val)
<a name="11460"/>11460:           end,
<a name="11461"/>11461: 
<a name="11462"/>11462:     MainSeq =
<a name="11463"/>11463:         [
<a name="11464"/>11464:          #{desc =&gt; &quot;monitor helper&quot;,
<a name="11465"/>11465:            cmd =&gt; fun(#{helper := Pid}) -&gt;
<a name="11466"/>11466:                           _ = erlang:monitor(process, Pid),
<a name="11467"/>11467:                           ok
<a name="11468"/>11468:                   end},
<a name="11469"/>11469: 
<a name="11470"/>11470:          #{desc =&gt; &quot;create socket&quot;,
<a name="11471"/>11471:            cmd  =&gt; fun(#{domain   := Domain,
<a name="11472"/>11472:                          type     := Type,
<a name="11473"/>11473:                          protocol := Protocol} = State) -&gt;
<a name="11474"/>11474:                            Sock = sock_open(Domain, Type, Protocol),
<a name="11475"/>11475:                            {ok, State#{sock =&gt; Sock}}
<a name="11476"/>11476:                    end},
<a name="11477"/>11477: 
<a name="11478"/>11478:          #{desc =&gt; &quot;get default&quot;,
<a name="11479"/>11479:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="11480"/>11480:                           case Get(Sock) of
<a name="11481"/>11481:                               {ok, undefined} -&gt;
<a name="11482"/>11482:                                   ok;
<a name="11483"/>11483:                               {ok, _} = OK -&gt;
<a name="11484"/>11484:                                   {error, OK};
<a name="11485"/>11485:                               {error, _} = ERROR -&gt;
<a name="11486"/>11486:                                   ERROR
<a name="11487"/>11487:                           end
<a name="11488"/>11488:                   end},
<a name="11489"/>11489: 
<a name="11490"/>11490:          #{desc =&gt; &quot;set value&quot;,
<a name="11491"/>11491:            cmd =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11492"/>11492:                           Value = make_ref(),
<a name="11493"/>11493:                           case Set(Sock, Value) of
<a name="11494"/>11494:                               ok -&gt;
<a name="11495"/>11495:                                   {ok, State#{value =&gt; Value}};
<a name="11496"/>11496:                               {error, _} = ERROR -&gt;
<a name="11497"/>11497:                                   ERROR
<a name="11498"/>11498:                           end
<a name="11499"/>11499:                   end},
<a name="11500"/>11500: 
<a name="11501"/>11501:          #{desc =&gt; &quot;get value&quot;,
<a name="11502"/>11502:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="11503"/>11503:                           case Get(Sock) of
<a name="11504"/>11504:                               {ok, Value} -&gt;
<a name="11505"/>11505:                                   ok;
<a name="11506"/>11506:                               {ok, _} = OK -&gt;
<a name="11507"/>11507:                                   {error, OK};
<a name="11508"/>11508:                               {error, _} = ERROR -&gt;
<a name="11509"/>11509:                                   ERROR
<a name="11510"/>11510:                           end
<a name="11511"/>11511:                   end},
<a name="11512"/>11512: 
<a name="11513"/>11513:          #{desc =&gt; &quot;set complex value&quot;,
<a name="11514"/>11514:            cmd =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="11515"/>11515:                           Value =
<a name="11516"/>11516:                               #{a =&gt; 1,
<a name="11517"/>11517:                                 b =&gt; {2, 3},
<a name="11518"/>11518:                                 c =&gt; make_ref(),
<a name="11519"/>11519:                                 d =&gt; self(),
<a name="11520"/>11520:                                 e =&gt; State},
<a name="11521"/>11521:                           case Set(Sock, Value) of
<a name="11522"/>11522:                               ok -&gt;
<a name="11523"/>11523:                                   {ok, State#{value := Value}};
<a name="11524"/>11524:                               {error, _} = ERROR -&gt;
<a name="11525"/>11525:                                   ERROR
<a name="11526"/>11526:                           end
<a name="11527"/>11527:                   end},
<a name="11528"/>11528: 
<a name="11529"/>11529:          #{desc =&gt; &quot;get complex value&quot;,
<a name="11530"/>11530:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="11531"/>11531:                           case Get(Sock) of
<a name="11532"/>11532:                               {ok, Value} -&gt;
<a name="11533"/>11533:                                   ok;
<a name="11534"/>11534:                               {ok, _} = OK-&gt;
<a name="11535"/>11535:                                   {error, OK};
<a name="11536"/>11536:                               {error, _} = ERROR -&gt;
<a name="11537"/>11537:                                   ERROR
<a name="11538"/>11538:                           end
<a name="11539"/>11539:                   end},
<a name="11540"/>11540: 
<a name="11541"/>11541:          #{desc =&gt; &quot;start helper&quot;,
<a name="11542"/>11542:            cmd =&gt; fun(#{helper := Pid,  sock := Sock, value := Value}) -&gt;
<a name="11543"/>11543:                           ?SEV_ANNOUNCE_START(Pid, {Sock, Value}),
<a name="11544"/>11544:                           ok
<a name="11545"/>11545:                   end},
<a name="11546"/>11546: 
<a name="11547"/>11547:          #{desc =&gt; &quot;wait for helper ready&quot;,
<a name="11548"/>11548:            cmd =&gt; fun(#{helper := Pid}) -&gt;
<a name="11549"/>11549:                           ?SEV_AWAIT_READY(Pid, helper, test)
<a name="11550"/>11550:                   end},
<a name="11551"/>11551: 
<a name="11552"/>11552:          #{desc =&gt; &quot;socket close&quot;,
<a name="11553"/>11553:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="11554"/>11554:                           socket:close(Sock)
<a name="11555"/>11555:                   end},
<a name="11556"/>11556: 
<a name="11557"/>11557:         ?SEV_FINISH_NORMAL],
<a name="11558"/>11558: 
<a name="11559"/>11559:     HelperSeq =
<a name="11560"/>11560:         [#{desc =&gt; &quot;await start&quot;,
<a name="11561"/>11561:            cmd =&gt; fun (State) -&gt;
<a name="11562"/>11562:                           {Main, {Sock, Value}} = ?SEV_AWAIT_START(),
<a name="11563"/>11563:                           {ok, State#{main =&gt; Main,
<a name="11564"/>11564:                                       sock =&gt; Sock,
<a name="11565"/>11565:                                       value =&gt; Value}}
<a name="11566"/>11566:                   end},
<a name="11567"/>11567:          #{desc =&gt; &quot;monitor main&quot;,
<a name="11568"/>11568:            cmd =&gt; fun(#{main := Main}) -&gt;
<a name="11569"/>11569:                           _ = erlang:monitor(process, Main),
<a name="11570"/>11570:                           ok
<a name="11571"/>11571:                   end},
<a name="11572"/>11572: 
<a name="11573"/>11573:          #{desc =&gt; &quot;get value&quot;,
<a name="11574"/>11574:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="11575"/>11575:                           case Get(Sock) of
<a name="11576"/>11576:                               {ok, Value} -&gt;
<a name="11577"/>11577:                                   ok;
<a name="11578"/>11578:                               {ok, _} = OK-&gt;
<a name="11579"/>11579:                                   {error, OK};
<a name="11580"/>11580:                               {error, _} = ERROR -&gt;
<a name="11581"/>11581:                                   ERROR
<a name="11582"/>11582:                           end
<a name="11583"/>11583:                   end},
<a name="11584"/>11584: 
<a name="11585"/>11585:          #{desc =&gt; &quot;set and fail&quot;,
<a name="11586"/>11586:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="11587"/>11587:                           Value = self(),
<a name="11588"/>11588:                           case Set(Sock, Value) of
<a name="11589"/>11589:                               ok -&gt;
<a name="11590"/>11590:                                   {error, only_owner_may_set};
<a name="11591"/>11591:                               {error, {invalid, not_owner}} -&gt;
<a name="11592"/>11592:                                   ok;
<a name="11593"/>11593:                               {error, _} = ERROR -&gt;
<a name="11594"/>11594:                                   ERROR
<a name="11595"/>11595:                           end
<a name="11596"/>11596:                   end},
<a name="11597"/>11597: 
<a name="11598"/>11598:          #{desc =&gt; &quot;announce ready (test)&quot;,
<a name="11599"/>11599:            cmd  =&gt; fun(#{main := Main}) -&gt;
<a name="11600"/>11600:                            ?SEV_ANNOUNCE_READY(Main, test),
<a name="11601"/>11601:                            ok
<a name="11602"/>11602:                    end},
<a name="11603"/>11603: 
<a name="11604"/>11604:          ?SEV_FINISH_NORMAL],
<a name="11605"/>11605: 
<a name="11606"/>11606: 
<a name="11607"/>11607:     i(&quot;start tcp helper evaluator&quot;),
<a name="11608"/>11608:     Helper = ?SEV_START(&quot;tcp-helper&quot;, HelperSeq, #{}),
<a name="11609"/>11609: 
<a name="11610"/>11610:     i(&quot;start tcp main evaluator&quot;),
<a name="11611"/>11611:     MainState = #{domain =&gt; inet, type =&gt; stream, protocol =&gt; tcp,
<a name="11612"/>11612:                   helper =&gt; Helper#ev.pid},
<a name="11613"/>11613:     Main = ?SEV_START(&quot;tcp-main&quot;, MainSeq, MainState),
<a name="11614"/>11614: 
<a name="11615"/>11615:     i(&quot;await tcp evaluators&quot;),
<a name="api_opt_simple_otp_meta_option-last_expr"/><a name="11616"/>11616: <b>    ok = ?SEV_AWAIT_FINISH</b>([Helper, Main]).
<a name="11617"/>11617: 
<a name="11618"/>11618: 
<a name="11619"/>11619: 
<a name="11620"/>11620: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11621"/>11621: 
<a name="11622"/>11622: <i>%% Perform some simple operations with the rcvbuf otp option</i>
<a name="11623"/>11623: <i>%% The operations we test here are only for type = stream and</i>
<a name="11624"/>11624: <i>%% protocol = tcp.</i>
<a name="api_opt_simple_otp_rcvbuf_option-1"/><a name="11625"/>11625: <b>api_opt_simple_otp_rcvbuf_option</b>(_Config) when is_list(_Config) -&gt;
<a name="11626"/>11626:     ?TT(?SECS(15)),
<a name="api_opt_simple_otp_rcvbuf_option-last_expr"/><a name="11627"/>11627: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="11628"/>11628:            fun() -&gt;
<a name="11629"/>11629:                    api_opt_simple_otp_rcvbuf_option()
<a name="11630"/>11630:            end).
<a name="11631"/>11631: 
<a name="api_opt_simple_otp_rcvbuf_option-0"/><a name="11632"/>11632: <b>api_opt_simple_otp_rcvbuf_option</b>() -&gt;
<a name="11633"/>11633:     Get = fun(S) -&gt;
<a name="11634"/>11634:                   socket:getopt(S, otp, rcvbuf)
<a name="11635"/>11635:           end,
<a name="11636"/>11636:     Set = fun(S, Val) -&gt;
<a name="11637"/>11637:                   socket:setopt(S, otp, rcvbuf, Val)
<a name="11638"/>11638:           end,
<a name="11639"/>11639: 
<a name="11640"/>11640:     ServerSeq = 
<a name="11641"/>11641:         [
<a name="11642"/>11642:          %% *** Wait for start order part ***
<a name="11643"/>11643:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="11644"/>11644:            cmd  =&gt; fun(State) -&gt;
<a name="11645"/>11645:                            Tester = ?SEV_AWAIT_START(),
<a name="11646"/>11646:                            {ok, State#{tester =&gt; Tester}}
<a name="11647"/>11647:                    end},
<a name="11648"/>11648:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11649"/>11649:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11650"/>11650:                            _MRef = erlang:monitor(process, Tester),
<a name="11651"/>11651:                            ok
<a name="11652"/>11652:                    end},
<a name="11653"/>11653: 
<a name="11654"/>11654:          %% *** Init part ***
<a name="11655"/>11655:          #{desc =&gt; &quot;which local address&quot;,
<a name="11656"/>11656:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11657"/>11657:                            LSA = which_local_socket_addr(Domain),
<a name="11658"/>11658:                            {ok, State#{local_sa =&gt; LSA}}
<a name="11659"/>11659:                    end},
<a name="11660"/>11660:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="11661"/>11661:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11662"/>11662:                            case socket:open(Domain, stream, tcp) of
<a name="11663"/>11663:                                {ok, Sock} -&gt;
<a name="11664"/>11664:                                    {ok, State#{lsock =&gt; Sock}};
<a name="11665"/>11665:                                {error, _} = ERROR -&gt;
<a name="11666"/>11666:                                    ERROR
<a name="11667"/>11667:                            end
<a name="11668"/>11668:                    end},
<a name="11669"/>11669:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="11670"/>11670:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="11671"/>11671:                            case sock_bind(LSock, LSA) of
<a name="11672"/>11672:                                ok -&gt;
<a name="11673"/>11673:                                    Port = sock_port(LSock),
<a name="11674"/>11674:                                    {ok, State#{lport =&gt; Port}};
<a name="11675"/>11675:                                {error, _} = ERROR -&gt;
<a name="11676"/>11676:                                    ERROR
<a name="11677"/>11677:                            end
<a name="11678"/>11678:                    end},
<a name="11679"/>11679:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="11680"/>11680:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="11681"/>11681:                            socket:listen(LSock)
<a name="11682"/>11682:                    end},
<a name="11683"/>11683:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11684"/>11684:            cmd  =&gt; fun(#{tester   := Tester,
<a name="11685"/>11685:                          local_sa := LocalSA,
<a name="11686"/>11686:                          lport    := Port}) -&gt;
<a name="11687"/>11687:                            ServerSA = LocalSA#{port =&gt; Port},
<a name="11688"/>11688:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="11689"/>11689:                            ok
<a name="11690"/>11690:                    end},
<a name="11691"/>11691: 
<a name="11692"/>11692: 
<a name="11693"/>11693:          %% *** The actual test part ***
<a name="11694"/>11694:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="11695"/>11695:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11696"/>11696:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="11697"/>11697:                    end},
<a name="11698"/>11698:          #{desc =&gt; &quot;attempt to accept&quot;,
<a name="11699"/>11699:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="11700"/>11700:                            case socket:accept(LSock) of
<a name="11701"/>11701:                                {ok, Sock} -&gt;
<a name="11702"/>11702:                                    {ok, State#{sock =&gt; Sock}};
<a name="11703"/>11703:                                {error, _} = ERROR -&gt;
<a name="11704"/>11704:                                    ERROR
<a name="11705"/>11705:                            end
<a name="11706"/>11706:                    end},
<a name="11707"/>11707:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="11708"/>11708:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11709"/>11709:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="11710"/>11710:                            ok
<a name="11711"/>11711:                    end},
<a name="11712"/>11712: 
<a name="11713"/>11713:          %% Recv with default size for (otp) rcvbuf
<a name="11714"/>11714:          #{desc =&gt; &quot;await continue (recv initial)&quot;,
<a name="11715"/>11715:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11716"/>11716:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="11717"/>11717:                                {ok, MsgSz} -&gt;
<a name="11718"/>11718:                                    ?SEV_IPRINT(&quot;MsgSz: ~p&quot;, [MsgSz]),
<a name="11719"/>11719:                                    {ok, State#{msg_sz =&gt; MsgSz}};
<a name="11720"/>11720:                                {error, _} = ERROR -&gt;
<a name="11721"/>11721:                                    ERROR
<a name="11722"/>11722:                            end
<a name="11723"/>11723:                    end},
<a name="11724"/>11724:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="11725"/>11725:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="11726"/>11726:                            ?SEV_IPRINT(&quot;try recv ~w bytes when rcvbuf is ~s&quot;, 
<a name="11727"/>11727:                                        [MsgSz,
<a name="11728"/>11728:                                         case Get(Sock) of
<a name="11729"/>11729:                                             {ok, RcvBuf} -&gt; ?F(&quot;~w&quot;, [RcvBuf]);
<a name="11730"/>11730:                                             {error, _}   -&gt; &quot;-&quot;
<a name="11731"/>11731:                                         end]),
<a name="11732"/>11732:                            case socket:recv(Sock) of
<a name="11733"/>11733:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="11734"/>11734:                                    ok;
<a name="11735"/>11735:                                {ok, Data} -&gt;
<a name="11736"/>11736:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="11737"/>11737:                                {error, _} = ERROR -&gt;
<a name="11738"/>11738:                                    ERROR
<a name="11739"/>11739:                            end
<a name="11740"/>11740:                    end},
<a name="11741"/>11741:          #{desc =&gt; &quot;announce ready (recv initial)&quot;,
<a name="11742"/>11742:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11743"/>11743:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="11744"/>11744:                            ok
<a name="11745"/>11745:                    end},
<a name="11746"/>11746: 
<a name="11747"/>11747:          %% Recv with new size (1) for (otp) rcvbuf
<a name="11748"/>11748:          #{desc =&gt; &quot;await continue (recv 1)&quot;,
<a name="11749"/>11749:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11750"/>11750:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="11751"/>11751:                                {ok, NewRcvBuf} -&gt;
<a name="11752"/>11752:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;, [NewRcvBuf]),
<a name="11753"/>11753:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11754"/>11754:                                {error, _} = ERROR -&gt;
<a name="11755"/>11755:                                    ERROR
<a name="11756"/>11756:                            end
<a name="11757"/>11757:                    end},
<a name="11758"/>11758:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="11759"/>11759:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="11760"/>11760:                            case Set(Sock, NewRcvBuf) of
<a name="11761"/>11761:                                ok -&gt;
<a name="11762"/>11762:                                    ok;
<a name="11763"/>11763:                                {error, _} = ERROR -&gt;
<a name="11764"/>11764:                                    ERROR
<a name="11765"/>11765:                            end
<a name="11766"/>11766:                    end},
<a name="11767"/>11767:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="11768"/>11768:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="11769"/>11769:                            ?SEV_IPRINT(&quot;try recv ~w bytes when rcvbuf is ~s&quot;, 
<a name="11770"/>11770:                                        [MsgSz,
<a name="11771"/>11771:                                         case Get(Sock) of
<a name="11772"/>11772:                                             {ok, RcvBuf} -&gt; ?F(&quot;~w&quot;, [RcvBuf]);
<a name="11773"/>11773:                                             {error, _}   -&gt; &quot;-&quot;
<a name="11774"/>11774:                                         end]),
<a name="11775"/>11775:                            case socket:recv(Sock) of
<a name="11776"/>11776:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="11777"/>11777:                                    ok;
<a name="11778"/>11778:                                {ok, Data} -&gt;
<a name="11779"/>11779:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="11780"/>11780:                                {error, _} = ERROR -&gt;
<a name="11781"/>11781:                                    ERROR
<a name="11782"/>11782:                            end
<a name="11783"/>11783:                    end},
<a name="11784"/>11784:          #{desc =&gt; &quot;announce ready (recv 1)&quot;,
<a name="11785"/>11785:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11786"/>11786:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="11787"/>11787:                            ok
<a name="11788"/>11788:                    end},
<a name="11789"/>11789: 
<a name="11790"/>11790:          %% Recv with new size (2) for (otp) rcvbuf
<a name="11791"/>11791:          #{desc =&gt; &quot;await continue (recv 2)&quot;,
<a name="11792"/>11792:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11793"/>11793:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="11794"/>11794:                                {ok, NewRcvBuf} -&gt;
<a name="11795"/>11795:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;, [NewRcvBuf]),
<a name="11796"/>11796:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="11797"/>11797:                                {error, _} = ERROR -&gt;
<a name="11798"/>11798:                                    ERROR
<a name="11799"/>11799:                            end
<a name="11800"/>11800:                    end},
<a name="11801"/>11801:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="11802"/>11802:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="11803"/>11803:                            case Set(Sock, NewRcvBuf) of
<a name="11804"/>11804:                                ok -&gt;
<a name="11805"/>11805:                                    ok;
<a name="11806"/>11806:                                {error, _} = ERROR -&gt;
<a name="11807"/>11807:                                    ERROR
<a name="11808"/>11808:                            end
<a name="11809"/>11809:                    end},
<a name="11810"/>11810:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="11811"/>11811:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="11812"/>11812:                            case socket:recv(Sock) of
<a name="11813"/>11813:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="11814"/>11814:                                    ok;
<a name="11815"/>11815:                                {ok, Data} -&gt;
<a name="11816"/>11816:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="11817"/>11817:                                {error, _} = ERROR -&gt;
<a name="11818"/>11818:                                    ERROR
<a name="11819"/>11819:                            end
<a name="11820"/>11820:                    end},
<a name="11821"/>11821:          #{desc =&gt; &quot;announce ready (recv 2)&quot;,
<a name="11822"/>11822:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11823"/>11823:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="11824"/>11824:                            ok
<a name="11825"/>11825:                    end},
<a name="11826"/>11826: 
<a name="11827"/>11827:          %% Recv with new size (3) for (otp) rcvbuf
<a name="11828"/>11828:          #{desc =&gt; &quot;await continue (recv 3, truncated)&quot;,
<a name="11829"/>11829:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11830"/>11830:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="11831"/>11831:                                {ok, {ExpSz, NewRcvBuf}} -&gt;
<a name="11832"/>11832:                                    ?SEV_IPRINT(&quot;set new rcvbuf:&quot;
<a name="11833"/>11833:                                                &quot;~n   New RcvBuf:  ~p&quot;
<a name="11834"/>11834:                                                &quot;~n   Expect Size: ~p&quot;,
<a name="11835"/>11835:                                                [ExpSz, NewRcvBuf]),
<a name="11836"/>11836:                                    {ok, State#{msg_sz =&gt; ExpSz,
<a name="11837"/>11837:                                                rcvbuf =&gt; NewRcvBuf}};
<a name="11838"/>11838:                                {error, _} = ERROR -&gt;
<a name="11839"/>11839:                                    ERROR
<a name="11840"/>11840:                            end
<a name="11841"/>11841:                    end},
<a name="11842"/>11842:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="11843"/>11843:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="11844"/>11844:                            case Set(Sock, NewRcvBuf) of
<a name="11845"/>11845:                                ok -&gt;
<a name="11846"/>11846:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;,
<a name="11847"/>11847:                                                [NewRcvBuf]),
<a name="11848"/>11848:                                    ok;
<a name="11849"/>11849:                                {error, _} = ERROR -&gt;
<a name="11850"/>11850:                                    ERROR
<a name="11851"/>11851:                            end
<a name="11852"/>11852:                    end},
<a name="11853"/>11853:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="11854"/>11854:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="11855"/>11855:                            ?SEV_IPRINT(&quot;try recv ~w bytes of data&quot;, [MsgSz]),
<a name="11856"/>11856:                            case socket:recv(Sock) of
<a name="11857"/>11857:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="11858"/>11858:                                    ok;
<a name="11859"/>11859:                                {ok, Data} -&gt;
<a name="11860"/>11860:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="11861"/>11861:                                {error, _} = ERROR -&gt;
<a name="11862"/>11862:                                    ERROR
<a name="11863"/>11863:                            end
<a name="11864"/>11864:                    end},
<a name="11865"/>11865:          #{desc =&gt; &quot;announce ready (recv)&quot;,
<a name="11866"/>11866:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11867"/>11867:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="11868"/>11868:                            ok
<a name="11869"/>11869:                    end},
<a name="11870"/>11870: 
<a name="11871"/>11871: 
<a name="11872"/>11872:          %% Termination
<a name="11873"/>11873:          #{desc =&gt; &quot;await terminate&quot;,
<a name="11874"/>11874:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11875"/>11875:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="11876"/>11876:                                ok -&gt;
<a name="11877"/>11877:                                    {ok, maps:remove(tester, State)};
<a name="11878"/>11878:                                {error, _} = ERROR -&gt;
<a name="11879"/>11879:                                    ERROR
<a name="11880"/>11880:                            end
<a name="11881"/>11881:                    end},
<a name="11882"/>11882:          #{desc =&gt; &quot;close socket(s)&quot;,
<a name="11883"/>11883:            cmd  =&gt; fun(#{lsock := LSock, sock := Sock} = State) -&gt;
<a name="11884"/>11884:                            sock_close(Sock),
<a name="11885"/>11885:                            sock_close(LSock),
<a name="11886"/>11886:                            State1 = maps:remove(sock,  State),
<a name="11887"/>11887:                            State2 = maps:remove(lport, State1),
<a name="11888"/>11888:                            State3 = maps:remove(lsock, State2),
<a name="11889"/>11889:                            {ok, State3}
<a name="11890"/>11890:                    end},
<a name="11891"/>11891: 
<a name="11892"/>11892:          %% *** We are done ***
<a name="11893"/>11893:          ?SEV_FINISH_NORMAL
<a name="11894"/>11894:         ],
<a name="11895"/>11895: 
<a name="11896"/>11896:     ClientSeq =
<a name="11897"/>11897:         [
<a name="11898"/>11898:          %% *** Wait for start order part ***
<a name="11899"/>11899:          #{desc =&gt; &quot;await start&quot;,
<a name="11900"/>11900:            cmd  =&gt; fun(State) -&gt;
<a name="11901"/>11901:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="11902"/>11902:                            {ok, State#{tester    =&gt; Tester,
<a name="11903"/>11903:                                        server_sa =&gt; ServerSA}}
<a name="11904"/>11904:                    end},
<a name="11905"/>11905:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11906"/>11906:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11907"/>11907:                            _MRef = erlang:monitor(process, Tester),
<a name="11908"/>11908:                            ok
<a name="11909"/>11909:                    end},
<a name="11910"/>11910: 
<a name="11911"/>11911:          %% *** Init part ***
<a name="11912"/>11912:          #{desc =&gt; &quot;which local address&quot;,
<a name="11913"/>11913:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11914"/>11914:                            LSA = which_local_socket_addr(Domain),
<a name="11915"/>11915:                            {ok, State#{local_sa =&gt; LSA}}
<a name="11916"/>11916:                    end},
<a name="11917"/>11917:          #{desc =&gt; &quot;create socket&quot;,
<a name="11918"/>11918:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11919"/>11919:                            case socket:open(Domain, stream, tcp) of
<a name="11920"/>11920:                                {ok, Sock} -&gt;
<a name="11921"/>11921:                                    {ok, State#{sock =&gt; Sock}};
<a name="11922"/>11922:                                {error, _} = ERROR -&gt;
<a name="11923"/>11923:                                    ERROR
<a name="11924"/>11924:                            end
<a name="11925"/>11925:                    end},
<a name="11926"/>11926:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="11927"/>11927:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="11928"/>11928:                            case sock_bind(Sock, LSA) of
<a name="11929"/>11929:                                ok -&gt;
<a name="11930"/>11930:                                    ok;
<a name="11931"/>11931:                                {error, _} = ERROR -&gt;
<a name="11932"/>11932:                                    ERROR
<a name="11933"/>11933:                            end
<a name="11934"/>11934:                    end},
<a name="11935"/>11935:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11936"/>11936:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11937"/>11937:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="11938"/>11938:                            ok
<a name="11939"/>11939:                    end},
<a name="11940"/>11940: 
<a name="11941"/>11941:          %% The actual test
<a name="11942"/>11942:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="11943"/>11943:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11944"/>11944:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="11945"/>11945:                    end},
<a name="11946"/>11946:          #{desc =&gt; &quot;connect to server&quot;,
<a name="11947"/>11947:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="11948"/>11948:                            socket:connect(Sock, SSA)
<a name="11949"/>11949:                    end},
<a name="11950"/>11950:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="11951"/>11951:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11952"/>11952:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="11953"/>11953:                            ok
<a name="11954"/>11954:                    end},
<a name="11955"/>11955: 
<a name="11956"/>11956:          #{desc =&gt; &quot;await continue (send initial)&quot;,
<a name="11957"/>11957:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11958"/>11958:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, send) of
<a name="11959"/>11959:                                {ok, Data} -&gt;
<a name="11960"/>11960:                                    {ok, State#{data =&gt; Data}};
<a name="11961"/>11961:                                {error, _} = ERROR -&gt;
<a name="11962"/>11962:                                    ERROR
<a name="11963"/>11963:                            end
<a name="11964"/>11964:                    end},
<a name="11965"/>11965:          #{desc =&gt; &quot;send (initial) data to server&quot;,
<a name="11966"/>11966:            cmd  =&gt; fun(#{sock := Sock, data := Data} = _State) -&gt;
<a name="11967"/>11967:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="11968"/>11968:                            socket:send(Sock, Data)
<a name="11969"/>11969:                    end},
<a name="11970"/>11970:          #{desc =&gt; &quot;announce ready (send initial)&quot;,
<a name="11971"/>11971:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11972"/>11972:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="11973"/>11973:                            ok
<a name="11974"/>11974:                    end},
<a name="11975"/>11975: 
<a name="11976"/>11976:          #{desc =&gt; &quot;await continue (send 1)&quot;,
<a name="11977"/>11977:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11978"/>11978:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="11979"/>11979:                    end},
<a name="11980"/>11980:          #{desc =&gt; &quot;send (1) data to server&quot;,
<a name="11981"/>11981:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="11982"/>11982:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="11983"/>11983:                            socket:send(Sock, Data)
<a name="11984"/>11984:                    end},
<a name="11985"/>11985:          #{desc =&gt; &quot;announce ready (send 1)&quot;,
<a name="11986"/>11986:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11987"/>11987:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="11988"/>11988:                            ok
<a name="11989"/>11989:                    end},
<a name="11990"/>11990: 
<a name="11991"/>11991:          #{desc =&gt; &quot;await continue (send 2)&quot;,
<a name="11992"/>11992:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11993"/>11993:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="11994"/>11994:                    end},
<a name="11995"/>11995:          #{desc =&gt; &quot;send (2) data to server&quot;,
<a name="11996"/>11996:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="11997"/>11997:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="11998"/>11998:                            socket:send(Sock, Data)
<a name="11999"/>11999:                    end},
<a name="12000"/>12000:          #{desc =&gt; &quot;announce ready (send 2)&quot;,
<a name="12001"/>12001:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12002"/>12002:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="12003"/>12003:                            ok
<a name="12004"/>12004:                    end},
<a name="12005"/>12005: 
<a name="12006"/>12006:          #{desc =&gt; &quot;await continue (send 3)&quot;,
<a name="12007"/>12007:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12008"/>12008:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="12009"/>12009:                    end},
<a name="12010"/>12010:          #{desc =&gt; &quot;send (3) data to server&quot;,
<a name="12011"/>12011:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="12012"/>12012:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="12013"/>12013:                            socket:send(Sock, Data)
<a name="12014"/>12014:                    end},
<a name="12015"/>12015:          #{desc =&gt; &quot;announce ready (send 3)&quot;,
<a name="12016"/>12016:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12017"/>12017:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="12018"/>12018:                            ok
<a name="12019"/>12019:                    end},
<a name="12020"/>12020: 
<a name="12021"/>12021: 
<a name="12022"/>12022:          %% Termination
<a name="12023"/>12023:          #{desc =&gt; &quot;await terminate&quot;,
<a name="12024"/>12024:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12025"/>12025:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="12026"/>12026:                                ok -&gt;
<a name="12027"/>12027:                                    {ok, maps:remove(tester, State)};
<a name="12028"/>12028:                                {error, _} = ERROR -&gt;
<a name="12029"/>12029:                                    ERROR
<a name="12030"/>12030:                            end
<a name="12031"/>12031:                    end},
<a name="12032"/>12032:          #{desc =&gt; &quot;close socket&quot;,
<a name="12033"/>12033:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="12034"/>12034:                            socket:close(Sock)
<a name="12035"/>12035:                    end},
<a name="12036"/>12036: 
<a name="12037"/>12037:          %% *** We are done ***
<a name="12038"/>12038:          ?SEV_FINISH_NORMAL
<a name="12039"/>12039:         ],
<a name="12040"/>12040: 
<a name="12041"/>12041:     TesterSeq =
<a name="12042"/>12042:         [
<a name="12043"/>12043:          %% *** Init part ***
<a name="12044"/>12044:          #{desc =&gt; &quot;monitor server&quot;,
<a name="12045"/>12045:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="12046"/>12046:                            _MRef = erlang:monitor(process, Server),
<a name="12047"/>12047:                            ok
<a name="12048"/>12048:                    end},
<a name="12049"/>12049:          #{desc =&gt; &quot;monitor client&quot;,
<a name="12050"/>12050:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12051"/>12051:                            _MRef = erlang:monitor(process, Client),
<a name="12052"/>12052:                            ok
<a name="12053"/>12053:                    end},
<a name="12054"/>12054:          #{desc =&gt; &quot;order server start&quot;,
<a name="12055"/>12055:            cmd  =&gt; fun(#{server := Server}) -&gt;
<a name="12056"/>12056:                            ?SEV_ANNOUNCE_START(Server)
<a name="12057"/>12057:                    end},
<a name="12058"/>12058:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="12059"/>12059:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="12060"/>12060:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Server, server, init),
<a name="12061"/>12061:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="12062"/>12062:                    end},
<a name="12063"/>12063:          #{desc =&gt; &quot;order client start&quot;,
<a name="12064"/>12064:            cmd  =&gt; fun(#{client    := Client,
<a name="12065"/>12065:                          server_sa := ServerSA}) -&gt;
<a name="12066"/>12066:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="12067"/>12067:                            ok
<a name="12068"/>12068:                    end},
<a name="12069"/>12069:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="12070"/>12070:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12071"/>12071:                            ?SEV_AWAIT_READY(Client, client, init)
<a name="12072"/>12072:                    end},
<a name="12073"/>12073: 
<a name="12074"/>12074: 
<a name="12075"/>12075:          %% The actual test (connecting)
<a name="12076"/>12076:          #{desc =&gt; &quot;order server accept (accept)&quot;,
<a name="12077"/>12077:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="12078"/>12078:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="12079"/>12079:                            ok
<a name="12080"/>12080:                    end},
<a name="12081"/>12081:          ?SEV_SLEEP(?SECS(1)),
<a name="12082"/>12082:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="12083"/>12083:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12084"/>12084:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="12085"/>12085:                            ok
<a name="12086"/>12086:                    end},
<a name="12087"/>12087:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="12088"/>12088:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12089"/>12089:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="12090"/>12090:                    end},
<a name="12091"/>12091:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="12092"/>12092:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="12093"/>12093:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="12094"/>12094:                    end},
<a name="12095"/>12095: 
<a name="12096"/>12096:          %% The actual test (initial part)
<a name="12097"/>12097:          #{desc =&gt; &quot;order client continue (send initial)&quot;,
<a name="12098"/>12098:            cmd  =&gt; fun(#{client := Client, data := Data} = _State) -&gt;
<a name="12099"/>12099:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Data),
<a name="12100"/>12100:                            ok
<a name="12101"/>12101:                    end},
<a name="12102"/>12102:          ?SEV_SLEEP(?SECS(1)),
<a name="12103"/>12103:          #{desc =&gt; &quot;order server continue (recv initial)&quot;,
<a name="12104"/>12104:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="12105"/>12105:                            ExpMsgSz = size(Data),
<a name="12106"/>12106:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, ExpMsgSz),
<a name="12107"/>12107:                            ok
<a name="12108"/>12108:                    end},
<a name="12109"/>12109:          #{desc =&gt; &quot;await client ready (send initial)&quot;,
<a name="12110"/>12110:            cmd  =&gt; fun(#{server := Server,
<a name="12111"/>12111:                          client := Client} = _State) -&gt;
<a name="12112"/>12112:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="12113"/>12113:                                                  [{server, Server}]) of
<a name="12114"/>12114:                                ok -&gt;
<a name="12115"/>12115:                                    ok;
<a name="12116"/>12116:                                {error, _} = ERROR -&gt;
<a name="12117"/>12117:                                    ERROR
<a name="12118"/>12118:                            end
<a name="12119"/>12119:                    end},
<a name="12120"/>12120:          #{desc =&gt; &quot;await server ready (recv initial)&quot;,
<a name="12121"/>12121:            cmd  =&gt; fun(#{server := Server,
<a name="12122"/>12122:                          client := Client} = _State) -&gt;
<a name="12123"/>12123:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="12124"/>12124:                                                  [{client, Client}]) of
<a name="12125"/>12125:                                ok -&gt;
<a name="12126"/>12126:                                    ok;
<a name="12127"/>12127:                                {error, _} = ERROR -&gt;
<a name="12128"/>12128:                                    ERROR
<a name="12129"/>12129:                            end
<a name="12130"/>12130:                    end},
<a name="12131"/>12131: 
<a name="12132"/>12132:          %% The actual test (part 1)
<a name="12133"/>12133:          #{desc =&gt; &quot;order client continue (send 1)&quot;,
<a name="12134"/>12134:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12135"/>12135:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="12136"/>12136:                            ok
<a name="12137"/>12137:                    end},
<a name="12138"/>12138:          ?SEV_SLEEP(?SECS(1)),
<a name="12139"/>12139:          #{desc =&gt; &quot;order server continue (recv 1)&quot;,
<a name="12140"/>12140:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="12141"/>12141:                            MsgSz     = size(Data),
<a name="12142"/>12142:                            NewRcvBuf =
<a name="12143"/>12143:                                case os:type() of
<a name="12144"/>12144:                                    {win32, nt} -&gt;
<a name="12145"/>12145:                                        (((2 * MsgSz) div 1024) + 1) * 1024;
<a name="12146"/>12146:                                    _ -&gt;
<a name="12147"/>12147:                                        {2 + (MsgSz div 1024), 1024}
<a name="12148"/>12148:                                end,
<a name="12149"/>12149:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, NewRcvBuf),
<a name="12150"/>12150:                            ok
<a name="12151"/>12151:                    end},
<a name="12152"/>12152:          #{desc =&gt; &quot;await client ready (send 1)&quot;,
<a name="12153"/>12153:            cmd  =&gt; fun(#{server := Server,
<a name="12154"/>12154:                          client := Client} = _State) -&gt;
<a name="12155"/>12155:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="12156"/>12156:                                                  [{server, Server}]) of
<a name="12157"/>12157:                                ok -&gt;
<a name="12158"/>12158:                                    ok;
<a name="12159"/>12159:                                {error, _} = ERROR -&gt;
<a name="12160"/>12160:                                    ERROR
<a name="12161"/>12161:                            end
<a name="12162"/>12162:                    end},
<a name="12163"/>12163:          #{desc =&gt; &quot;await server ready (recv 1)&quot;,
<a name="12164"/>12164:            cmd  =&gt; fun(#{server := Server,
<a name="12165"/>12165:                          client := Client} = _State) -&gt;
<a name="12166"/>12166:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="12167"/>12167:                                                  [{client, Client}]) of
<a name="12168"/>12168:                                ok -&gt;
<a name="12169"/>12169:                                    ok;
<a name="12170"/>12170:                                {error, _} = ERROR -&gt;
<a name="12171"/>12171:                                    ERROR
<a name="12172"/>12172:                            end
<a name="12173"/>12173:                    end},
<a name="12174"/>12174: 
<a name="12175"/>12175:          %% The actual test (part 2)
<a name="12176"/>12176:          #{desc =&gt; &quot;order client continue (send 2)&quot;,
<a name="12177"/>12177:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12178"/>12178:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="12179"/>12179:                            ok
<a name="12180"/>12180:                    end},
<a name="12181"/>12181:          ?SEV_SLEEP(?SECS(1)),
<a name="12182"/>12182:          #{desc =&gt; &quot;order server continue (recv 2)&quot;,
<a name="12183"/>12183:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="12184"/>12184:                            MsgSz     = size(Data),
<a name="12185"/>12185:                            NewRcvBuf = 
<a name="12186"/>12186:                                case os:type() of
<a name="12187"/>12187:                                    {win32, nt} -&gt;
<a name="12188"/>12188:                                        (((3 * MsgSz) div 1024) + 1) * 1024;
<a name="12189"/>12189:                                    _ -&gt;
<a name="12190"/>12190:                                        {2 + (MsgSz div 2048), 2048}
<a name="12191"/>12191:                                end,
<a name="12192"/>12192:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, NewRcvBuf),
<a name="12193"/>12193:                            ok
<a name="12194"/>12194:                    end},
<a name="12195"/>12195:          #{desc =&gt; &quot;await client ready (send 2)&quot;,
<a name="12196"/>12196:            cmd  =&gt; fun(#{server := Server,
<a name="12197"/>12197:                          client := Client} = _State) -&gt;
<a name="12198"/>12198:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="12199"/>12199:                                                  [{server, Server}]) of
<a name="12200"/>12200:                                ok -&gt;
<a name="12201"/>12201:                                    ok;
<a name="12202"/>12202:                                {error, _} = ERROR -&gt;
<a name="12203"/>12203:                                    ERROR
<a name="12204"/>12204:                            end
<a name="12205"/>12205:                    end},
<a name="12206"/>12206:          #{desc =&gt; &quot;await server ready (recv 2)&quot;,
<a name="12207"/>12207:            cmd  =&gt; fun(#{server := Server,
<a name="12208"/>12208:                          client := Client} = _State) -&gt;
<a name="12209"/>12209:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="12210"/>12210:                                                  [{client, Client}]) of
<a name="12211"/>12211:                                ok -&gt;
<a name="12212"/>12212:                                    ok;
<a name="12213"/>12213:                                {error, _} = ERROR -&gt;
<a name="12214"/>12214:                                    ERROR
<a name="12215"/>12215:                            end
<a name="12216"/>12216:                    end},
<a name="12217"/>12217: 
<a name="12218"/>12218: 
<a name="12219"/>12219:          %% The actual test (part 3)
<a name="12220"/>12220:          #{desc =&gt; &quot;order client continue (send 3)&quot;,
<a name="12221"/>12221:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12222"/>12222:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="12223"/>12223:                            ok
<a name="12224"/>12224:                    end},
<a name="12225"/>12225:          ?SEV_SLEEP(?SECS(1)),
<a name="12226"/>12226:          #{desc =&gt; &quot;order server continue (recv 3)&quot;,
<a name="12227"/>12227:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="12228"/>12228:                            MsgSz = size(Data),
<a name="12229"/>12229:                            BufSz = 2048,
<a name="12230"/>12230:                            N     = MsgSz div BufSz - 1,
<a name="12231"/>12231:                            {ExpSz, NewRcvBuf} =
<a name="12232"/>12232:                                case os:type() of
<a name="12233"/>12233:                                    {win32, nt} -&gt;
<a name="12234"/>12234:                                        {N*BufSz, N*BufSz};
<a name="12235"/>12235:                                    _ -&gt;
<a name="12236"/>12236:                                        {N*BufSz, {N, BufSz}}
<a name="12237"/>12237:                                end,
<a name="12238"/>12238:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv,
<a name="12239"/>12239:                                                   {ExpSz, NewRcvBuf})
<a name="12240"/>12240:                    end},
<a name="12241"/>12241:          #{desc =&gt; &quot;await client ready (send 3)&quot;,
<a name="12242"/>12242:            cmd  =&gt; fun(#{server := Server,
<a name="12243"/>12243:                          client := Client} = _State) -&gt;
<a name="12244"/>12244:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="12245"/>12245:                                                  [{server, Server}]) of
<a name="12246"/>12246:                                ok -&gt;
<a name="12247"/>12247:                                    ok;
<a name="12248"/>12248:                                {error, _} = ERROR -&gt;
<a name="12249"/>12249:                                    ERROR
<a name="12250"/>12250:                            end
<a name="12251"/>12251:                    end},
<a name="12252"/>12252:          #{desc =&gt; &quot;await server ready (recv 3)&quot;,
<a name="12253"/>12253:            cmd  =&gt; fun(#{server := Server,
<a name="12254"/>12254:                          client := Client} = _State) -&gt;
<a name="12255"/>12255:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="12256"/>12256:                                                  [{client, Client}]) of
<a name="12257"/>12257:                                ok -&gt;
<a name="12258"/>12258:                                    ok;
<a name="12259"/>12259:                                {error, _} = ERROR -&gt;
<a name="12260"/>12260:                                    ERROR
<a name="12261"/>12261:                            end
<a name="12262"/>12262:                    end},
<a name="12263"/>12263: 
<a name="12264"/>12264: 
<a name="12265"/>12265:          ?SEV_SLEEP(?SECS(1)),
<a name="12266"/>12266: 
<a name="12267"/>12267:          %% *** Terminate server ***
<a name="12268"/>12268:          #{desc =&gt; &quot;order client terminate&quot;,
<a name="12269"/>12269:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12270"/>12270:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="12271"/>12271:                            ok
<a name="12272"/>12272:                    end},
<a name="12273"/>12273:          #{desc =&gt; &quot;await client down&quot;,
<a name="12274"/>12274:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="12275"/>12275:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="12276"/>12276:                            State1 = maps:remove(client,    State),
<a name="12277"/>12277:                            {ok, State1}
<a name="12278"/>12278:                    end},
<a name="12279"/>12279:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="12280"/>12280:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="12281"/>12281:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="12282"/>12282:                            ok
<a name="12283"/>12283:                    end},
<a name="12284"/>12284:          #{desc =&gt; &quot;await server down&quot;,
<a name="12285"/>12285:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="12286"/>12286:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="12287"/>12287:                            State1 = maps:remove(server,    State),
<a name="12288"/>12288:                            State2 = maps:remove(server_sa, State1),
<a name="12289"/>12289:                            {ok, State2}
<a name="12290"/>12290:                    end},
<a name="12291"/>12291: 
<a name="12292"/>12292:          %% *** We are done ***
<a name="12293"/>12293:          ?SEV_FINISH_NORMAL
<a name="12294"/>12294:         ],
<a name="12295"/>12295: 
<a name="12296"/>12296:     %% Create a data binary of 6*1024 bytes
<a name="12297"/>12297:     Data      = list_to_binary(lists:duplicate(6*4, lists:seq(0, 255))),
<a name="12298"/>12298:     InitState = #{domain =&gt; inet_or_inet6(),
<a name="12299"/>12299:                   data   =&gt; Data},
<a name="12300"/>12300: 
<a name="12301"/>12301:     i(&quot;create server evaluator&quot;),
<a name="12302"/>12302:     ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="12303"/>12303:     Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="12304"/>12304: 
<a name="12305"/>12305:     i(&quot;create client evaluator&quot;),
<a name="12306"/>12306:     ClientInitState = #{host   =&gt; local_host(),
<a name="12307"/>12307:                         domain =&gt; maps:get(domain, InitState)},
<a name="12308"/>12308:     Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="12309"/>12309: 
<a name="12310"/>12310:     i(&quot;create tester evaluator&quot;),
<a name="12311"/>12311:     TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="12312"/>12312:                                  client =&gt; Client#ev.pid},
<a name="12313"/>12313:     Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="12314"/>12314: 
<a name="12315"/>12315:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_simple_otp_rcvbuf_option-last_expr"/><a name="12316"/>12316: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="12317"/>12317: 
<a name="12318"/>12318: 
<a name="12319"/>12319: 
<a name="12320"/>12320: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12321"/>12321: 
<a name="12322"/>12322: <i>%% Perform some simple getopt and setopt with the level = otp options</i>
<a name="api_opt_simple_otp_controlling_process-1"/><a name="12323"/>12323: <b>api_opt_simple_otp_controlling_process</b>(_Config) when is_list(_Config) -&gt;
<a name="12324"/>12324:     ?TT(?SECS(30)),
<a name="api_opt_simple_otp_controlling_process-last_expr"/><a name="12325"/>12325: <b>    tc_try</b>(api_opt_simple_otp_controlling_process,
<a name="12326"/>12326:            fun() -&gt; api_opt_simple_otp_controlling_process() end).
<a name="12327"/>12327: 
<a name="api_opt_simple_otp_controlling_process-0"/><a name="12328"/>12328: <b>api_opt_simple_otp_controlling_process</b>() -&gt;
<a name="12329"/>12329:     Get = fun(S, Key) -&gt;
<a name="12330"/>12330:                   socket:getopt(S, otp, Key)
<a name="12331"/>12331:           end,
<a name="12332"/>12332:     Set = fun(S, Key, Val) -&gt;
<a name="12333"/>12333:                   socket:setopt(S, otp, Key, Val)
<a name="12334"/>12334:           end,
<a name="12335"/>12335: 
<a name="12336"/>12336:     ClientSeq =
<a name="12337"/>12337:         [
<a name="12338"/>12338:          %% *** Init part ***
<a name="12339"/>12339:          #{desc =&gt; &quot;await start&quot;,
<a name="12340"/>12340:            cmd  =&gt; fun(State) -&gt;
<a name="12341"/>12341:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="12342"/>12342:                            {ok, State#{tester =&gt; Tester,
<a name="12343"/>12343:                                        sock   =&gt; Sock}}
<a name="12344"/>12344:                    end},
<a name="12345"/>12345:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="12346"/>12346:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12347"/>12347:                            _MRef = erlang:monitor(process, Tester),
<a name="12348"/>12348:                            ok
<a name="12349"/>12349:                    end},
<a name="12350"/>12350: 
<a name="12351"/>12351:          %% *** The actual test ***
<a name="12352"/>12352:          #{desc =&gt; &quot;verify tester as controlling-process&quot;,
<a name="12353"/>12353:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="12354"/>12354:                            case Get(Sock, controlling_process) of
<a name="12355"/>12355:                                {ok, Tester} -&gt;
<a name="12356"/>12356:                                    ok;
<a name="12357"/>12357:                                {ok, _} = OK -&gt;
<a name="12358"/>12358:                                    {error, OK};
<a name="12359"/>12359:                                {error, _} = ERROR -&gt;
<a name="12360"/>12360:                                    ERROR
<a name="12361"/>12361:                            end
<a name="12362"/>12362:                    end},
<a name="12363"/>12363:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="12364"/>12364:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12365"/>12365:                            case Set(Sock, controlling_process, self()) of
<a name="12366"/>12366:                                {error, {invalid, not_owner}} -&gt;
<a name="12367"/>12367:                                    ok;
<a name="12368"/>12368:                                ok -&gt;
<a name="12369"/>12369:                                    {error, unexpected_success};
<a name="12370"/>12370:                                {error, _} = ERROR -&gt;
<a name="12371"/>12371:                                    ERROR
<a name="12372"/>12372:                            end
<a name="12373"/>12373:                    end},
<a name="12374"/>12374:          #{desc =&gt; &quot;announce ready (not owner)&quot;,
<a name="12375"/>12375:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12376"/>12376:                            ?SEV_ANNOUNCE_READY(Tester, not_owner),
<a name="12377"/>12377:                            ok
<a name="12378"/>12378:                    end},
<a name="12379"/>12379:          #{desc =&gt; &quot;await continue (owner)&quot;,
<a name="12380"/>12380:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12381"/>12381:                            ?SEV_AWAIT_CONTINUE(Tester, tester, owner)
<a name="12382"/>12382:                    end},
<a name="12383"/>12383:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="12384"/>12384:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12385"/>12385:                            Self = self(),
<a name="12386"/>12386:                            case Get(Sock, controlling_process) of
<a name="12387"/>12387:                                {ok, Self} -&gt;
<a name="12388"/>12388:                                    ok;
<a name="12389"/>12389:                                {ok, _} = OK -&gt;
<a name="12390"/>12390:                                    {error, OK};
<a name="12391"/>12391:                                {error, _} = ERROR -&gt;
<a name="12392"/>12392:                                    ERROR
<a name="12393"/>12393:                            end
<a name="12394"/>12394:                    end},
<a name="12395"/>12395:          #{desc =&gt; &quot;attempt controlling-process transfer to tester&quot;,
<a name="12396"/>12396:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="12397"/>12397:                            Set(Sock, controlling_process, Tester)
<a name="12398"/>12398:                    end},
<a name="12399"/>12399:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="12400"/>12400:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12401"/>12401:                            case Set(Sock, controlling_process, self()) of
<a name="12402"/>12402:                                {error, {invalid, not_owner}} -&gt;
<a name="12403"/>12403:                                    ok;
<a name="12404"/>12404:                                ok -&gt;
<a name="12405"/>12405:                                    {error, unexpected_success};
<a name="12406"/>12406:                                {error, _} = ERROR -&gt;
<a name="12407"/>12407:                                    ERROR
<a name="12408"/>12408:                            end
<a name="12409"/>12409:                    end},
<a name="12410"/>12410:          #{desc =&gt; &quot;announce ready (owner)&quot;,
<a name="12411"/>12411:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12412"/>12412:                            ?SEV_ANNOUNCE_READY(Tester, owner),
<a name="12413"/>12413:                            ok
<a name="12414"/>12414: 
<a name="12415"/>12415:                    end},
<a name="12416"/>12416:          
<a name="12417"/>12417:          %% *** Termination ***
<a name="12418"/>12418:          #{desc =&gt; &quot;await termination&quot;,
<a name="12419"/>12419:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12420"/>12420:                            ?SEV_AWAIT_TERMINATE(Tester, tester),
<a name="12421"/>12421:                            State1 = maps:remove(tester, State),
<a name="12422"/>12422:                            State2 = maps:remove(sock, State1),
<a name="12423"/>12423:                            {ok, State2}
<a name="12424"/>12424:                    end},
<a name="12425"/>12425: 
<a name="12426"/>12426:          %% *** We are done ***
<a name="12427"/>12427:          ?SEV_FINISH_NORMAL
<a name="12428"/>12428:         ],
<a name="12429"/>12429: 
<a name="12430"/>12430:     TesterSeq =
<a name="12431"/>12431:         [
<a name="12432"/>12432:          %% *** Init part ***
<a name="12433"/>12433:          #{desc =&gt; &quot;create socket&quot;,
<a name="12434"/>12434:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="12435"/>12435:                          type     := Type,
<a name="12436"/>12436:                          protocol := Protocol} = State) -&gt;
<a name="12437"/>12437:                            Sock = sock_open(Domain, Type, Protocol),
<a name="12438"/>12438:                            {ok, State#{sock =&gt; Sock}}
<a name="12439"/>12439:                    end},
<a name="12440"/>12440:          #{desc =&gt; &quot;monitor client&quot;,
<a name="12441"/>12441:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12442"/>12442:                            _MRef = erlang:monitor(process, Client),
<a name="12443"/>12443:                            ok
<a name="12444"/>12444:                    end},
<a name="12445"/>12445: 
<a name="12446"/>12446:          %% *** The actual test ***
<a name="12447"/>12447:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="12448"/>12448:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12449"/>12449:                            Self = self(),
<a name="12450"/>12450:                            case Get(Sock, controlling_process) of
<a name="12451"/>12451:                                {ok, Self} -&gt;
<a name="12452"/>12452:                                    ok;
<a name="12453"/>12453:                                {ok, _} = OK -&gt;
<a name="12454"/>12454:                                    {error, OK};
<a name="12455"/>12455:                                {error, _} = ERROR -&gt;
<a name="12456"/>12456:                                    ERROR
<a name="12457"/>12457:                            end
<a name="12458"/>12458:                    end},
<a name="12459"/>12459:          #{desc =&gt; &quot;order (client) start&quot;,
<a name="12460"/>12460:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="12461"/>12461:                            ?SEV_ANNOUNCE_START(Client, Sock),
<a name="12462"/>12462:                            ok
<a name="12463"/>12463:                    end},
<a name="12464"/>12464:          #{desc =&gt; &quot;await (client) ready (not owner)&quot;,
<a name="12465"/>12465:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12466"/>12466:                            ?SEV_AWAIT_READY(Client, client, not_owner)
<a name="12467"/>12467:                    end},
<a name="12468"/>12468:          #{desc =&gt; &quot;attempt controlling-process transfer to client&quot;,
<a name="12469"/>12469:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="12470"/>12470:                            Set(Sock, controlling_process, Client)
<a name="12471"/>12471:                    end},
<a name="12472"/>12472:          #{desc =&gt; &quot;verify client as controlling-process&quot;,
<a name="12473"/>12473:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="12474"/>12474:                            case Get(Sock, controlling_process) of
<a name="12475"/>12475:                                {ok, Client} -&gt;
<a name="12476"/>12476:                                    ok;
<a name="12477"/>12477:                                {ok, _} = OK -&gt;
<a name="12478"/>12478:                                    {error, OK};
<a name="12479"/>12479:                                {error, _} = ERROR -&gt;
<a name="12480"/>12480:                                    ERROR
<a name="12481"/>12481:                            end
<a name="12482"/>12482:                    end},
<a name="12483"/>12483:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="12484"/>12484:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12485"/>12485:                            case Set(Sock, controlling_process, self()) of
<a name="12486"/>12486:                                {error, {invalid, not_owner}} -&gt;
<a name="12487"/>12487:                                    ok;
<a name="12488"/>12488:                                ok -&gt;
<a name="12489"/>12489:                                    {error, unexpected_success};
<a name="12490"/>12490:                                {error, _} = ERROR -&gt;
<a name="12491"/>12491:                                    ERROR
<a name="12492"/>12492:                            end
<a name="12493"/>12493:                    end},
<a name="12494"/>12494:          #{desc =&gt; &quot;order (client) continue (owner)&quot;,
<a name="12495"/>12495:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12496"/>12496:                            ?SEV_ANNOUNCE_CONTINUE(Client, owner),
<a name="12497"/>12497:                            ok
<a name="12498"/>12498:                    end},
<a name="12499"/>12499:          #{desc =&gt; &quot;await (client) ready (2)&quot;,
<a name="12500"/>12500:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12501"/>12501:                            ?SEV_AWAIT_READY(Client, client, owner),
<a name="12502"/>12502:                            ok
<a name="12503"/>12503:                    end},
<a name="12504"/>12504:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="12505"/>12505:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12506"/>12506:                            Self = self(),
<a name="12507"/>12507:                            case Get(Sock, controlling_process) of
<a name="12508"/>12508:                                {ok, Self} -&gt;
<a name="12509"/>12509:                                    ok;
<a name="12510"/>12510:                                {ok, _} = OK -&gt;
<a name="12511"/>12511:                                    {error, OK};
<a name="12512"/>12512:                                {error, _} = ERROR -&gt;
<a name="12513"/>12513:                                    ERROR
<a name="12514"/>12514:                            end
<a name="12515"/>12515:                    end},
<a name="12516"/>12516: 
<a name="12517"/>12517:          %% *** Termination ***
<a name="12518"/>12518:          #{desc =&gt; &quot;order (client) terminate&quot;,
<a name="12519"/>12519:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12520"/>12520:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="12521"/>12521:                            ok
<a name="12522"/>12522:                    end},
<a name="12523"/>12523:          #{desc =&gt; &quot;await client termination&quot;,
<a name="12524"/>12524:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="12525"/>12525:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="12526"/>12526:                            {ok, maps:remove(client, State)}
<a name="12527"/>12527:                    end},
<a name="12528"/>12528:          #{desc =&gt; &quot;close socket&quot;,
<a name="12529"/>12529:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12530"/>12530:                            sock_close(Sock),
<a name="12531"/>12531:                            {ok, maps:remove(sock, State)}
<a name="12532"/>12532:                    end},
<a name="12533"/>12533: 
<a name="12534"/>12534:          %% *** We are done ***
<a name="12535"/>12535:          ?SEV_FINISH_NORMAL
<a name="12536"/>12536:         ],
<a name="12537"/>12537: 
<a name="12538"/>12538:     i(&quot;start tcp (stream) client evaluator&quot;),
<a name="12539"/>12539:     ClientInitState1 = #{},
<a name="12540"/>12540:     Client1 = ?SEV_START(&quot;tcp-client&quot;, ClientSeq, ClientInitState1),
<a name="12541"/>12541: 
<a name="12542"/>12542:     i(&quot;start tcp (stream) tester evaluator&quot;),
<a name="12543"/>12543:     TesterInitState1 = #{domain   =&gt; inet,
<a name="12544"/>12544:                          type     =&gt; stream, 
<a name="12545"/>12545:                          protocol =&gt; tcp,
<a name="12546"/>12546:                          client   =&gt; Client1#ev.pid},
<a name="12547"/>12547:     Tester1 = ?SEV_START(&quot;tcp-tester&quot;, TesterSeq, TesterInitState1),
<a name="12548"/>12548: 
<a name="12549"/>12549:     i(&quot;await tcp evaluator(s)&quot;),
<a name="12550"/>12550:     ok = ?SEV_AWAIT_FINISH([Tester1, Client1]),
<a name="12551"/>12551: 
<a name="12552"/>12552:     i(&quot;start udp (dgram) client evaluator&quot;),
<a name="12553"/>12553:     ClientInitState2 = #{},
<a name="12554"/>12554:     Client2 = ?SEV_START(&quot;udp-client&quot;, ClientSeq, ClientInitState2),
<a name="12555"/>12555: 
<a name="12556"/>12556:     i(&quot;start udp (dgram) tester evaluator&quot;),
<a name="12557"/>12557:     TesterInitState2 = #{domain   =&gt; inet,
<a name="12558"/>12558:                          type     =&gt; dgram, 
<a name="12559"/>12559:                          protocol =&gt; udp,
<a name="12560"/>12560:                          client   =&gt; Client2#ev.pid},
<a name="12561"/>12561:     Tester2 = ?SEV_START(&quot;udp-tester&quot;, TesterSeq, TesterInitState2),
<a name="12562"/>12562: 
<a name="12563"/>12563:     i(&quot;await udp evaluator(s)&quot;),
<a name="api_opt_simple_otp_controlling_process-last_expr"/><a name="12564"/>12564: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester2, Client2]).
<a name="12565"/>12565: 
<a name="12566"/>12566: 
<a name="12567"/>12567: 
<a name="12568"/>12568: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12569"/>12569: 
<a name="12570"/>12570: <i>%% Tests the socket option acceptconn for UDP.</i>
<a name="12571"/>12571: <i>%% This should be possible to get but not set.</i>
<a name="12572"/>12572: 
<a name="api_opt_sock_acceptconn_udp-1"/><a name="12573"/>12573: <b>api_opt_sock_acceptconn_udp</b>(_Config) when is_list(_Config) -&gt;
<a name="12574"/>12574:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptconn_udp-last_expr"/><a name="12575"/>12575: <b>    tc_try</b>(api_opt_sock_acceptconn_udp,
<a name="12576"/>12576:            fun() -&gt;
<a name="12577"/>12577:                    has_support_sock_acceptconn()
<a name="12578"/>12578:            end,
<a name="12579"/>12579:            fun() -&gt; api_opt_sock_acceptconn_udp() end).
<a name="12580"/>12580: 
<a name="12581"/>12581: 
<a name="12582"/>12582: 
<a name="api_opt_sock_acceptconn_udp-0"/><a name="12583"/>12583: <b>api_opt_sock_acceptconn_udp</b>() -&gt;
<a name="12584"/>12584:     Opt = acceptconn,
<a name="12585"/>12585:     Set = fun(S, Val) -&gt;
<a name="12586"/>12586:                   socket:setopt(S, socket, Opt, Val)
<a name="12587"/>12587:           end,
<a name="12588"/>12588:     Get = fun(S) -&gt;
<a name="12589"/>12589:                   socket:getopt(S, socket, Opt)
<a name="12590"/>12590:           end,
<a name="12591"/>12591: 
<a name="12592"/>12592:     TesterSeq =
<a name="12593"/>12593:         [
<a name="12594"/>12594:          #{desc =&gt; &quot;which local address&quot;,
<a name="12595"/>12595:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12596"/>12596:                            LSA = which_local_socket_addr(Domain),
<a name="12597"/>12597:                            {ok, State#{local_sa =&gt; LSA}}
<a name="12598"/>12598:                    end},
<a name="12599"/>12599:          #{desc =&gt; &quot;create socket&quot;,
<a name="12600"/>12600:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12601"/>12601:                            case socket:open(Domain, dgram, udp) of
<a name="12602"/>12602:                                {ok, Sock} -&gt;
<a name="12603"/>12603:                                    {ok, State#{sock =&gt; Sock}};
<a name="12604"/>12604:                                {error, _} = ERROR -&gt;
<a name="12605"/>12605:                                    ERROR
<a name="12606"/>12606:                            end
<a name="12607"/>12607:                    end},
<a name="12608"/>12608: 
<a name="12609"/>12609:          #{desc =&gt; &quot;[get] verify socket (before bind)&quot;,
<a name="12610"/>12610:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12611"/>12611:                            case Get(Sock) of
<a name="12612"/>12612:                                {ok, false} -&gt;
<a name="12613"/>12613:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12614"/>12614:                                                &quot;Not accepting connections&quot;),
<a name="12615"/>12615:                                    ok;
<a name="12616"/>12616:                                {ok, true} -&gt;
<a name="12617"/>12617:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12618"/>12618:                                                &quot;Accepting connections&quot;),
<a name="12619"/>12619:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12620"/>12620:                                {error, enoprotoopt = Reason} -&gt;
<a name="12621"/>12621:                                    %% On some platforms this is not accepted
<a name="12622"/>12622:                                    %% for UDP, so skip this part (UDP).
<a name="12623"/>12623:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="12624"/>12624:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="12625"/>12625:                                    (catch socket:close(Sock)),
<a name="12626"/>12626:                                    {skip, Reason};
<a name="12627"/>12627:                                {error, Reason} = ERROR -&gt;
<a name="12628"/>12628:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="12629"/>12629:                                                [Reason]),
<a name="12630"/>12630:                                    ERROR
<a name="12631"/>12631:                            end
<a name="12632"/>12632:                    end},
<a name="12633"/>12633:          #{desc =&gt; &quot;[set] verify socket (before bind)&quot;,
<a name="12634"/>12634:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12635"/>12635:                            case Set(Sock, true) of
<a name="12636"/>12636:                                {error, Reason} -&gt;
<a name="12637"/>12637:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;,
<a name="12638"/>12638:                                                [Reason]),
<a name="12639"/>12639:                                    ok;
<a name="12640"/>12640:                                ok -&gt;
<a name="12641"/>12641:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12642"/>12642:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12643"/>12643:                                    {error, unexpected_success}
<a name="12644"/>12644:                            end
<a name="12645"/>12645:                    end},
<a name="12646"/>12646: 
<a name="12647"/>12647:          #{desc =&gt; &quot;bind socket to local address&quot;,
<a name="12648"/>12648:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="12649"/>12649:                            case sock_bind(Sock, LSA) of
<a name="12650"/>12650:                                ok -&gt;
<a name="12651"/>12651:                                    ok;
<a name="12652"/>12652:                                {error, _} = ERROR -&gt;
<a name="12653"/>12653:                                    ERROR
<a name="12654"/>12654:                            end
<a name="12655"/>12655:                    end},
<a name="12656"/>12656: 
<a name="12657"/>12657:          ?SEV_SLEEP(?SECS(1)),
<a name="12658"/>12658: 
<a name="12659"/>12659:          #{desc =&gt; &quot;[get] verify socket (after bind)&quot;,
<a name="12660"/>12660:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12661"/>12661:                            case Get(Sock) of
<a name="12662"/>12662:                                {ok, false} -&gt;
<a name="12663"/>12663:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12664"/>12664:                                                &quot;Not accepting connections&quot;),
<a name="12665"/>12665:                                    ok;
<a name="12666"/>12666:                                {ok, true} -&gt;
<a name="12667"/>12667:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12668"/>12668:                                                &quot;Accepting connections&quot;),
<a name="12669"/>12669:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12670"/>12670:                                {error, Reason} = ERROR -&gt;
<a name="12671"/>12671:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="12672"/>12672:                                                [Reason]),
<a name="12673"/>12673:                                    ERROR
<a name="12674"/>12674:                            end
<a name="12675"/>12675:                    end},
<a name="12676"/>12676:          #{desc =&gt; &quot;[set] verify socket (after bind)&quot;,
<a name="12677"/>12677:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12678"/>12678:                            case Set(Sock, true) of
<a name="12679"/>12679:                                {error, Reason} -&gt;
<a name="12680"/>12680:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;,
<a name="12681"/>12681:                                                [Reason]),
<a name="12682"/>12682:                                    ok;
<a name="12683"/>12683:                                ok -&gt;
<a name="12684"/>12684:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12685"/>12685:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12686"/>12686:                                    {error, unexpected_success}
<a name="12687"/>12687:                            end
<a name="12688"/>12688:                    end},
<a name="12689"/>12689: 
<a name="12690"/>12690:          %% *** Termination ***
<a name="12691"/>12691:          #{desc =&gt; &quot;close socket&quot;,
<a name="12692"/>12692:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12693"/>12693:                            socket:close(Sock),
<a name="12694"/>12694:                            {ok, maps:remove(sock, State)}
<a name="12695"/>12695:                    end},
<a name="12696"/>12696: 
<a name="12697"/>12697:          %% *** We are done ***
<a name="12698"/>12698:          ?SEV_FINISH_NORMAL
<a name="12699"/>12699:         ],
<a name="12700"/>12700: 
<a name="12701"/>12701:     Domain = inet_or_inet6(),
<a name="12702"/>12702: 
<a name="12703"/>12703:     i(&quot;start tester evaluator&quot;),
<a name="12704"/>12704:     InitState = #{domain  =&gt; Domain},
<a name="12705"/>12705:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="12706"/>12706: 
<a name="12707"/>12707:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_acceptconn_udp-last_expr"/><a name="12708"/>12708: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="12709"/>12709: 
<a name="12710"/>12710: 
<a name="12711"/>12711: 
<a name="12712"/>12712: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12713"/>12713: 
<a name="12714"/>12714: <i>%% Tests the socket option acceptconn for TCP.</i>
<a name="12715"/>12715: <i>%% This should be possible to get but not set.</i>
<a name="12716"/>12716: 
<a name="api_opt_sock_acceptconn_tcp-1"/><a name="12717"/>12717: <b>api_opt_sock_acceptconn_tcp</b>(_Config) when is_list(_Config) -&gt;
<a name="12718"/>12718:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptconn_tcp-last_expr"/><a name="12719"/>12719: <b>    tc_try</b>(api_opt_sock_acceptconn_tcp,
<a name="12720"/>12720:            fun() -&gt;
<a name="12721"/>12721:                    has_support_sock_acceptconn()
<a name="12722"/>12722:            end,
<a name="12723"/>12723:            fun() -&gt; api_opt_sock_acceptconn_tcp() end).
<a name="12724"/>12724: 
<a name="12725"/>12725: 
<a name="12726"/>12726: 
<a name="api_opt_sock_acceptconn_tcp-0"/><a name="12727"/>12727: <b>api_opt_sock_acceptconn_tcp</b>() -&gt;
<a name="12728"/>12728:     Opt = acceptconn,
<a name="12729"/>12729:     Set = fun(S, Val) -&gt;
<a name="12730"/>12730:                   socket:setopt(S, socket, Opt, Val)
<a name="12731"/>12731:           end,
<a name="12732"/>12732:     Get = fun(S) -&gt;
<a name="12733"/>12733:                   socket:getopt(S, socket, Opt)
<a name="12734"/>12734:           end,
<a name="12735"/>12735: 
<a name="12736"/>12736:     TesterSeq =
<a name="12737"/>12737:         [
<a name="12738"/>12738:          #{desc =&gt; &quot;which local address&quot;,
<a name="12739"/>12739:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12740"/>12740:                            LSA = which_local_socket_addr(Domain),
<a name="12741"/>12741:                            {ok, State#{local_sa =&gt; LSA}}
<a name="12742"/>12742:                    end},
<a name="12743"/>12743: 
<a name="12744"/>12744:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="12745"/>12745:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12746"/>12746:                            case socket:open(Domain, stream, tcp) of
<a name="12747"/>12747:                                {ok, Sock} -&gt;
<a name="12748"/>12748:                                    {ok, State#{lsock =&gt; Sock}};
<a name="12749"/>12749:                                {error, _} = ERROR -&gt;
<a name="12750"/>12750:                                    ERROR
<a name="12751"/>12751:                            end
<a name="12752"/>12752:                    end},
<a name="12753"/>12753: 
<a name="12754"/>12754:          #{desc =&gt; &quot;[get] verify listen socket (before bind)&quot;,
<a name="12755"/>12755:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12756"/>12756:                            case Get(Sock) of
<a name="12757"/>12757:                                {ok, false} -&gt;
<a name="12758"/>12758:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12759"/>12759:                                                &quot;Not accepting connections&quot;),
<a name="12760"/>12760:                                    ok;
<a name="12761"/>12761:                                {ok, true} -&gt;
<a name="12762"/>12762:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12763"/>12763:                                                &quot;Accepting connections&quot;),
<a name="12764"/>12764:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12765"/>12765:                                {error, enoprotoopt = Reason} -&gt;
<a name="12766"/>12766:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="12767"/>12767:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="12768"/>12768:                                    (catch socket:close(Sock)),
<a name="12769"/>12769:                                    {skip, Reason};
<a name="12770"/>12770:                                {error, Reason} = ERROR -&gt;
<a name="12771"/>12771:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="12772"/>12772:                                                [Reason]),
<a name="12773"/>12773:                                    ERROR
<a name="12774"/>12774:                            end
<a name="12775"/>12775:                    end},
<a name="12776"/>12776:          #{desc =&gt; &quot;[set] verify listen socket (before bind)&quot;,
<a name="12777"/>12777:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12778"/>12778:                            case Set(Sock, true) of
<a name="12779"/>12779:                                {error, Reason} -&gt;
<a name="12780"/>12780:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12781"/>12781:                                    ok;
<a name="12782"/>12782:                                ok -&gt;
<a name="12783"/>12783:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12784"/>12784:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12785"/>12785:                                    {error, unexpected_success}
<a name="12786"/>12786:                            end
<a name="12787"/>12787:                    end},
<a name="12788"/>12788: 
<a name="12789"/>12789:          ?SEV_SLEEP(?SECS(1)),
<a name="12790"/>12790: 
<a name="12791"/>12791:          #{desc =&gt; &quot;bind listen socket to local address&quot;,
<a name="12792"/>12792:            cmd  =&gt; fun(#{lsock := Sock, local_sa := LSA} = State) -&gt;
<a name="12793"/>12793:                            case sock_bind(Sock, LSA) of
<a name="12794"/>12794:                                ok -&gt;
<a name="12795"/>12795:                                    Port = sock_port(Sock),
<a name="12796"/>12796:                                    {ok, State#{server_sa =&gt; LSA#{port =&gt; Port}}};
<a name="12797"/>12797:                                {error, _} = ERROR -&gt;
<a name="12798"/>12798:                                    ERROR
<a name="12799"/>12799:                            end
<a name="12800"/>12800:                    end},
<a name="12801"/>12801: 
<a name="12802"/>12802:          #{desc =&gt; &quot;[get] verify listen socket (after bind)&quot;,
<a name="12803"/>12803:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12804"/>12804:                            case Get(Sock) of
<a name="12805"/>12805:                                {ok, false} -&gt;
<a name="12806"/>12806:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12807"/>12807:                                                &quot;Not accepting connections&quot;),
<a name="12808"/>12808:                                    ok;
<a name="12809"/>12809:                                {ok, true} -&gt;
<a name="12810"/>12810:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12811"/>12811:                                                &quot;Accepting connections&quot;),
<a name="12812"/>12812:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12813"/>12813:                                {error, Reason} = ERROR -&gt;
<a name="12814"/>12814:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12815"/>12815:                                    ERROR
<a name="12816"/>12816:                            end
<a name="12817"/>12817:                    end},
<a name="12818"/>12818:          #{desc =&gt; &quot;[set] verify listen socket (after bind)&quot;,
<a name="12819"/>12819:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12820"/>12820:                            case Set(Sock, true) of
<a name="12821"/>12821:                                {error, Reason} -&gt;
<a name="12822"/>12822:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12823"/>12823:                                    ok;
<a name="12824"/>12824:                                ok -&gt;
<a name="12825"/>12825:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12826"/>12826:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12827"/>12827:                                    {error, unexpected_success}
<a name="12828"/>12828:                            end
<a name="12829"/>12829:                    end},
<a name="12830"/>12830: 
<a name="12831"/>12831:          ?SEV_SLEEP(?SECS(1)),
<a name="12832"/>12832: 
<a name="12833"/>12833:          #{desc =&gt; &quot;make listen socket accept connections&quot;,
<a name="12834"/>12834:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12835"/>12835:                            case socket:listen(Sock) of
<a name="12836"/>12836:                                ok -&gt;
<a name="12837"/>12837:                                    ok;
<a name="12838"/>12838:                                {error, _} = ERROR -&gt;
<a name="12839"/>12839:                                    ERROR
<a name="12840"/>12840:                            end
<a name="12841"/>12841:                    end},
<a name="12842"/>12842: 
<a name="12843"/>12843:          #{desc =&gt; &quot;[get] verify listen socket (after listen)&quot;,
<a name="12844"/>12844:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12845"/>12845:                            case Get(Sock) of
<a name="12846"/>12846:                                {ok, true} -&gt;
<a name="12847"/>12847:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12848"/>12848:                                                &quot;Accepting connections&quot;),
<a name="12849"/>12849:                                    ok;
<a name="12850"/>12850:                                {ok, false} -&gt;
<a name="12851"/>12851:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12852"/>12852:                                                &quot;Not accepting connections&quot;),
<a name="12853"/>12853:                                    {error, {unexpected_success, {Opt, false}}};
<a name="12854"/>12854:                                {error, Reason} = ERROR -&gt;
<a name="12855"/>12855:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12856"/>12856:                                    ERROR
<a name="12857"/>12857:                            end
<a name="12858"/>12858:                    end},
<a name="12859"/>12859:          #{desc =&gt; &quot;[set] verify listen socket (after listen)&quot;,
<a name="12860"/>12860:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="12861"/>12861:                            case Set(Sock, false) of
<a name="12862"/>12862:                                {error, Reason} -&gt;
<a name="12863"/>12863:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12864"/>12864:                                    ok;
<a name="12865"/>12865:                                ok -&gt;
<a name="12866"/>12866:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12867"/>12867:                                                &quot;Set acceptconn (=false)&quot;),
<a name="12868"/>12868:                                    {error, unexpected_success}
<a name="12869"/>12869:                            end
<a name="12870"/>12870:                    end},
<a name="12871"/>12871: 
<a name="12872"/>12872:          ?SEV_SLEEP(?SECS(1)),
<a name="12873"/>12873: 
<a name="12874"/>12874:          #{desc =&gt; &quot;create (connecting) socket&quot;,
<a name="12875"/>12875:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12876"/>12876:                            case socket:open(Domain, stream, tcp) of
<a name="12877"/>12877:                                {ok, Sock} -&gt;
<a name="12878"/>12878:                                    {ok, State#{csockc =&gt; Sock}};
<a name="12879"/>12879:                                {error, _} = ERROR -&gt;
<a name="12880"/>12880:                                    ERROR
<a name="12881"/>12881:                            end
<a name="12882"/>12882:                    end},
<a name="12883"/>12883: 
<a name="12884"/>12884:          #{desc =&gt; &quot;bind connecting socket to local address&quot;,
<a name="12885"/>12885:            cmd  =&gt; fun(#{csockc := Sock, local_sa := LSA} = _State) -&gt;
<a name="12886"/>12886:                            case sock_bind(Sock, LSA) of
<a name="12887"/>12887:                                ok -&gt;
<a name="12888"/>12888:                                    ok;
<a name="12889"/>12889:                                {error, _} = ERROR -&gt;
<a name="12890"/>12890:                                    ERROR
<a name="12891"/>12891:                            end
<a name="12892"/>12892:                    end},
<a name="12893"/>12893: 
<a name="12894"/>12894:          ?SEV_SLEEP(?SECS(1)),
<a name="12895"/>12895: 
<a name="12896"/>12896:          #{desc =&gt; &quot;[get] verify connecting socket (before connect)&quot;,
<a name="12897"/>12897:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="12898"/>12898:                            case Get(Sock) of
<a name="12899"/>12899:                                {ok, false} -&gt;
<a name="12900"/>12900:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12901"/>12901:                                                &quot;Not accepting connections&quot;),
<a name="12902"/>12902:                                    ok;
<a name="12903"/>12903:                                {ok, true} -&gt;
<a name="12904"/>12904:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12905"/>12905:                                                &quot;Accepting connections&quot;),
<a name="12906"/>12906:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12907"/>12907:                                {error, Reason} = ERROR -&gt;
<a name="12908"/>12908:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12909"/>12909:                                    ERROR
<a name="12910"/>12910:                            end
<a name="12911"/>12911:                    end},
<a name="12912"/>12912:          #{desc =&gt; &quot;[set] verify connecting socket (before connect)&quot;,
<a name="12913"/>12913:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="12914"/>12914:                            case Set(Sock, true) of
<a name="12915"/>12915:                                {error, Reason} -&gt;
<a name="12916"/>12916:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12917"/>12917:                                    ok;
<a name="12918"/>12918:                                ok -&gt;
<a name="12919"/>12919:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12920"/>12920:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12921"/>12921:                                    {error, unexpected_success}
<a name="12922"/>12922:                            end
<a name="12923"/>12923:                    end},
<a name="12924"/>12924: 
<a name="12925"/>12925:          ?SEV_SLEEP(?SECS(1)),
<a name="12926"/>12926: 
<a name="12927"/>12927:          #{desc =&gt; &quot;connect to server&quot;,
<a name="12928"/>12928:            cmd  =&gt; fun(#{csockc := Sock, server_sa := SSA} = _State) -&gt;
<a name="12929"/>12929:                            case socket:connect(Sock, SSA) of
<a name="12930"/>12930:                                ok -&gt;
<a name="12931"/>12931:                                    ok;
<a name="12932"/>12932:                                {error, _} = ERROR -&gt;
<a name="12933"/>12933:                                    ERROR
<a name="12934"/>12934:                            end
<a name="12935"/>12935:                    end},
<a name="12936"/>12936: 
<a name="12937"/>12937:          #{desc =&gt; &quot;accept connection&quot;,
<a name="12938"/>12938:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="12939"/>12939:                            case socket:accept(Sock) of
<a name="12940"/>12940:                                {ok, CSock} -&gt;
<a name="12941"/>12941:                                    {ok, State#{csocks =&gt; CSock}};
<a name="12942"/>12942:                                {error, _} = ERROR -&gt;
<a name="12943"/>12943:                                    ERROR
<a name="12944"/>12944:                            end
<a name="12945"/>12945:                    end},
<a name="12946"/>12946: 
<a name="12947"/>12947:          #{desc =&gt; &quot;[get] verify connecting socket (after connect)&quot;,
<a name="12948"/>12948:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="12949"/>12949:                            case Get(Sock) of
<a name="12950"/>12950:                                {ok, false} -&gt;
<a name="12951"/>12951:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12952"/>12952:                                                &quot;Not accepting connections&quot;),
<a name="12953"/>12953:                                    ok;
<a name="12954"/>12954:                                {ok, true} -&gt;
<a name="12955"/>12955:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12956"/>12956:                                                &quot;Accepting connections&quot;),
<a name="12957"/>12957:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12958"/>12958:                                {error, Reason} = ERROR -&gt;
<a name="12959"/>12959:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12960"/>12960:                                    ERROR
<a name="12961"/>12961:                            end
<a name="12962"/>12962:                    end},
<a name="12963"/>12963:          #{desc =&gt; &quot;[set] verify connecting socket (after connect)&quot;,
<a name="12964"/>12964:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="12965"/>12965:                            case Set(Sock, true) of
<a name="12966"/>12966:                                {error, Reason} -&gt;
<a name="12967"/>12967:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12968"/>12968:                                    ok;
<a name="12969"/>12969:                                ok -&gt;
<a name="12970"/>12970:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12971"/>12971:                                                &quot;Set acceptconn (=true)&quot;),
<a name="12972"/>12972:                                    {error, unexpected_success}
<a name="12973"/>12973:                            end
<a name="12974"/>12974:                    end},
<a name="12975"/>12975: 
<a name="12976"/>12976:          #{desc =&gt; &quot;[get] verify connected socket&quot;,
<a name="12977"/>12977:            cmd  =&gt; fun(#{csocks := Sock} = _State) -&gt;
<a name="12978"/>12978:                            case Get(Sock) of
<a name="12979"/>12979:                                {ok, false} -&gt;
<a name="12980"/>12980:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="12981"/>12981:                                                &quot;Not accepting connections&quot;),
<a name="12982"/>12982:                                    ok;
<a name="12983"/>12983:                                {ok, true} -&gt;
<a name="12984"/>12984:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="12985"/>12985:                                                &quot;Accepting connections&quot;),
<a name="12986"/>12986:                                    {error, {unexpected_success, {Opt, true}}};
<a name="12987"/>12987:                                {error, Reason} = ERROR -&gt;
<a name="12988"/>12988:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="12989"/>12989:                                    ERROR
<a name="12990"/>12990:                            end
<a name="12991"/>12991:                    end},
<a name="12992"/>12992:          #{desc =&gt; &quot;[set] verify connected socket&quot;,
<a name="12993"/>12993:            cmd  =&gt; fun(#{csocks := Sock} = _State) -&gt;
<a name="12994"/>12994:                            case Set(Sock, true) of
<a name="12995"/>12995:                                {error, Reason} -&gt;
<a name="12996"/>12996:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="12997"/>12997:                                    ok;
<a name="12998"/>12998:                                ok -&gt;
<a name="12999"/>12999:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13000"/>13000:                                                &quot;Set acceptconn (=true)&quot;),
<a name="13001"/>13001:                                    {error, unexpected_success}
<a name="13002"/>13002:                            end
<a name="13003"/>13003:                    end},
<a name="13004"/>13004: 
<a name="13005"/>13005:          #{desc =&gt; &quot;[get] verify listen socket (after connect)&quot;,
<a name="13006"/>13006:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13007"/>13007:                            case Get(Sock) of
<a name="13008"/>13008:                                {ok, true} -&gt;
<a name="13009"/>13009:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13010"/>13010:                                                &quot;Accepting connections&quot;),
<a name="13011"/>13011:                                    ok;
<a name="13012"/>13012:                                {ok, false} -&gt;
<a name="13013"/>13013:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13014"/>13014:                                                &quot;Not accepting connections&quot;),
<a name="13015"/>13015:                                    {error, {unexpected_success, {Opt, false}}};
<a name="13016"/>13016:                                {error, Reason} = ERROR -&gt;
<a name="13017"/>13017:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13018"/>13018:                                    ERROR
<a name="13019"/>13019:                            end
<a name="13020"/>13020:                    end},
<a name="13021"/>13021:          #{desc =&gt; &quot;[set] verify listen socket (after connect)&quot;,
<a name="13022"/>13022:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13023"/>13023:                            case Set(Sock, false) of
<a name="13024"/>13024:                                {error, Reason} -&gt;
<a name="13025"/>13025:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13026"/>13026:                                    ok;
<a name="13027"/>13027:                                ok -&gt;
<a name="13028"/>13028:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13029"/>13029:                                                &quot;Set acceptconn (=false)&quot;),
<a name="13030"/>13030:                                    {error, unexpected_success}
<a name="13031"/>13031:                            end
<a name="13032"/>13032:                    end},
<a name="13033"/>13033: 
<a name="13034"/>13034:          %% *** Termination ***
<a name="13035"/>13035:          #{desc =&gt; &quot;close connecting socket(s)&quot;,
<a name="13036"/>13036:            cmd  =&gt; fun(#{csockc := Sock} = State0) -&gt;
<a name="13037"/>13037:                            socket:close(Sock),
<a name="13038"/>13038:                            State1 = maps:remove(csockc, State0),
<a name="13039"/>13039:                            State2 = maps:remove(csocks, State1), %% Auto-close
<a name="13040"/>13040:                            {ok, maps:remove(csockc, State2)}
<a name="13041"/>13041:                    end},
<a name="13042"/>13042:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="13043"/>13043:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="13044"/>13044:                            socket:close(Sock),
<a name="13045"/>13045:                            {ok, maps:remove(lsock, State)}
<a name="13046"/>13046:                    end},
<a name="13047"/>13047: 
<a name="13048"/>13048:          %% *** We are done ***
<a name="13049"/>13049:          ?SEV_FINISH_NORMAL
<a name="13050"/>13050:         ],
<a name="13051"/>13051: 
<a name="13052"/>13052: 
<a name="13053"/>13053:     Domain = inet_or_inet6(),
<a name="13054"/>13054: 
<a name="13055"/>13055:     i(&quot;start tester evaluator&quot;),
<a name="13056"/>13056:     InitState = #{domain  =&gt; Domain},
<a name="13057"/>13057:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13058"/>13058: 
<a name="13059"/>13059:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_acceptconn_tcp-last_expr"/><a name="13060"/>13060: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13061"/>13061: 
<a name="13062"/>13062: 
<a name="13063"/>13063: 
<a name="13064"/>13064: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13065"/>13065: 
<a name="13066"/>13066: <i>%% Tests the socket option acceptfilter. PLACEHOLDER!</i>
<a name="13067"/>13067: 
<a name="api_opt_sock_acceptfilter-1"/><a name="13068"/>13068: <b>api_opt_sock_acceptfilter</b>(_Config) when is_list(_Config) -&gt;
<a name="13069"/>13069:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptfilter-last_expr"/><a name="13070"/>13070: <b>    tc_try</b>(api_opt_sock_acceptfilter,
<a name="13071"/>13071:            fun() -&gt; not_yet_implemented() end,
<a name="13072"/>13072:            fun() -&gt; ok end).
<a name="13073"/>13073: 
<a name="13074"/>13074: 
<a name="13075"/>13075: 
<a name="13076"/>13076: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13077"/>13077: 
<a name="13078"/>13078: <i>%% Tests the socket option bindtodevice.</i>
<a name="13079"/>13079: <i>%% It has not always been possible to 'get' this option</i>
<a name="13080"/>13080: <i>%% (at least on linux).</i>
<a name="13081"/>13081: 
<a name="api_opt_sock_bindtodevice-1"/><a name="13082"/>13082: <b>api_opt_sock_bindtodevice</b>(_Config) when is_list(_Config) -&gt;
<a name="13083"/>13083:     ?TT(?SECS(30)),
<a name="api_opt_sock_bindtodevice-last_expr"/><a name="13084"/>13084: <b>    tc_try</b>(api_opt_sock_bindtodevice,
<a name="13085"/>13085:            fun() -&gt; has_support_sock_bindtodevice() end,
<a name="13086"/>13086:            fun() -&gt; api_opt_sock_bindtodevice() end).
<a name="13087"/>13087: 
<a name="13088"/>13088: 
<a name="api_opt_sock_bindtodevice-0"/><a name="13089"/>13089: <b>api_opt_sock_bindtodevice</b>() -&gt;
<a name="13090"/>13090:     Opt = bindtodevice,
<a name="13091"/>13091:     Set = fun(S, Val) -&gt;
<a name="13092"/>13092:                   socket:setopt(S, socket, Opt, Val)
<a name="13093"/>13093:           end,
<a name="13094"/>13094:     Get = fun(S) -&gt;
<a name="13095"/>13095:                   socket:getopt(S, socket, Opt)
<a name="13096"/>13096:           end,
<a name="13097"/>13097: 
<a name="13098"/>13098:     TesterSeq =
<a name="13099"/>13099:         [
<a name="13100"/>13100:          #{desc =&gt; &quot;which local address&quot;,
<a name="13101"/>13101:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13102"/>13102:                            case which_local_host_info(Domain) of
<a name="13103"/>13103:                                {ok, #{name := Name, addr := Addr}} -&gt;
<a name="13104"/>13104:                                    ?SEV_IPRINT(&quot;local host info (~p): &quot;
<a name="13105"/>13105:                                                &quot;~n   Name: ~p&quot;
<a name="13106"/>13106:                                                &quot;~n   Addr: ~p&quot;,
<a name="13107"/>13107:                                                [Domain, Name, Addr]),
<a name="13108"/>13108:                                    LSA = #{family =&gt; Domain,
<a name="13109"/>13109:                                            addr   =&gt; Addr},
<a name="13110"/>13110:                                    {ok, State#{dev      =&gt; Name,
<a name="13111"/>13111:                                                local_sa =&gt; LSA}};
<a name="13112"/>13112:                                {error, _} = ERROR -&gt;
<a name="13113"/>13113:                                    ERROR
<a name="13114"/>13114:                            end
<a name="13115"/>13115:                    end},
<a name="13116"/>13116:          #{desc =&gt; &quot;create UDP socket 1&quot;,
<a name="13117"/>13117:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13118"/>13118:                            case socket:open(Domain, dgram, udp) of
<a name="13119"/>13119:                                {ok, Sock} -&gt;
<a name="13120"/>13120:                                    {ok, State#{usock1 =&gt; Sock}};
<a name="13121"/>13121:                                {error, _} = ERROR -&gt;
<a name="13122"/>13122:                                    ERROR
<a name="13123"/>13123:                            end
<a name="13124"/>13124:                    end},
<a name="13125"/>13125:          #{desc =&gt; &quot;create UDP socket 2&quot;,
<a name="13126"/>13126:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13127"/>13127:                            case socket:open(Domain, dgram, udp) of
<a name="13128"/>13128:                                {ok, Sock} -&gt;
<a name="13129"/>13129:                                    {ok, State#{usock2 =&gt; Sock}};
<a name="13130"/>13130:                                {error, _} = ERROR -&gt;
<a name="13131"/>13131:                                    ERROR
<a name="13132"/>13132:                            end
<a name="13133"/>13133:                    end},
<a name="13134"/>13134:          #{desc =&gt; &quot;create TCP socket 1&quot;,
<a name="13135"/>13135:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13136"/>13136:                            case socket:open(Domain, stream, tcp) of
<a name="13137"/>13137:                                {ok, Sock} -&gt;
<a name="13138"/>13138:                                    {ok, State#{tsock1 =&gt; Sock}};
<a name="13139"/>13139:                                {error, _} = ERROR -&gt;
<a name="13140"/>13140:                                    ERROR
<a name="13141"/>13141:                            end
<a name="13142"/>13142:                    end},
<a name="13143"/>13143:          #{desc =&gt; &quot;create TCP socket 2&quot;,
<a name="13144"/>13144:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13145"/>13145:                            case socket:open(Domain, stream, tcp) of
<a name="13146"/>13146:                                {ok, Sock} -&gt;
<a name="13147"/>13147:                                    {ok, State#{tsock2 =&gt; Sock}};
<a name="13148"/>13148:                                {error, _} = ERROR -&gt;
<a name="13149"/>13149:                                    ERROR
<a name="13150"/>13150:                            end
<a name="13151"/>13151:                    end},
<a name="13152"/>13152: 
<a name="13153"/>13153:          #{desc =&gt; &quot;[get] verify UDP socket 1 (before bindtodevice)&quot;,
<a name="13154"/>13154:            cmd  =&gt; fun(#{usock1 := Sock} = _State) -&gt;
<a name="13155"/>13155:                            case Get(Sock) of
<a name="13156"/>13156:                                {ok, Dev} -&gt;
<a name="13157"/>13157:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13158"/>13158:                                    ok;
<a name="13159"/>13159:                                {error, enoprotoopt = Reason} -&gt;
<a name="13160"/>13160:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="13161"/>13161: 					       [Reason]),
<a name="13162"/>13162:                                    {skip, Reason};
<a name="13163"/>13163:                                {error, Reason} = ERROR -&gt;
<a name="13164"/>13164:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13165"/>13165: 					       [Reason]),
<a name="13166"/>13166:                                    ERROR
<a name="13167"/>13167:                            end
<a name="13168"/>13168:                    end},
<a name="13169"/>13169:          #{desc =&gt; &quot;[get] verify UDP socket 2 (before bind)&quot;,
<a name="13170"/>13170:            cmd  =&gt; fun(#{usock2 := Sock} = _State) -&gt;
<a name="13171"/>13171:                            case Get(Sock) of
<a name="13172"/>13172:                                {ok, Dev} -&gt;
<a name="13173"/>13173:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13174"/>13174:                                    ok;
<a name="13175"/>13175:                                {error, Reason} = ERROR -&gt;
<a name="13176"/>13176:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13177"/>13177:                                    ERROR
<a name="13178"/>13178:                            end
<a name="13179"/>13179:                    end},
<a name="13180"/>13180:          #{desc =&gt; &quot;[get] verify TCP socket 1 (before bindtodevice)&quot;,
<a name="13181"/>13181:            cmd  =&gt; fun(#{tsock1 := Sock} = _State) -&gt;
<a name="13182"/>13182:                            case Get(Sock) of
<a name="13183"/>13183:                                {ok, Dev} -&gt;
<a name="13184"/>13184:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13185"/>13185:                                    ok;
<a name="13186"/>13186:                                {error, Reason} = ERROR -&gt;
<a name="13187"/>13187:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13188"/>13188:                                    ERROR
<a name="13189"/>13189:                            end
<a name="13190"/>13190:                    end},
<a name="13191"/>13191:          #{desc =&gt; &quot;[get] verify TCP socket 2 (before bind)&quot;,
<a name="13192"/>13192:            cmd  =&gt; fun(#{tsock2 := Sock} = _State) -&gt;
<a name="13193"/>13193:                            case Get(Sock) of
<a name="13194"/>13194:                                {ok, Dev} -&gt;
<a name="13195"/>13195:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13196"/>13196:                                    ok;
<a name="13197"/>13197:                                {error, Reason} = ERROR -&gt;
<a name="13198"/>13198:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13199"/>13199:                                    ERROR
<a name="13200"/>13200:                            end
<a name="13201"/>13201:                    end},
<a name="13202"/>13202: 
<a name="13203"/>13203:          ?SEV_SLEEP(?SECS(1)),
<a name="13204"/>13204: 
<a name="13205"/>13205:          #{desc =&gt; &quot;Bind UDP socket 1 to device&quot;,
<a name="13206"/>13206:            cmd  =&gt; fun(#{usock1 := Sock, dev := Dev} = State) -&gt;
<a name="13207"/>13207:                            case Set(Sock, Dev) of
<a name="13208"/>13208:                                ok -&gt;
<a name="13209"/>13209:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13210"/>13210:                                    ok;
<a name="13211"/>13211:                                {error, eperm = Reason} -&gt;
<a name="13212"/>13212:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13213"/>13213:                                    (catch socket:close(Sock)),
<a name="13214"/>13214:                                    {ok, State#{usock1 =&gt; skip}};
<a name="13215"/>13215:                                {error, Reason} = ERROR -&gt;
<a name="13216"/>13216:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13217"/>13217:                                    ERROR
<a name="13218"/>13218:                            end
<a name="13219"/>13219:                    end},
<a name="13220"/>13220:          #{desc =&gt; &quot;Bind UDP socket 2 to local address&quot;,
<a name="13221"/>13221:            cmd  =&gt; fun(#{usock2 := Sock, local_sa := LSA} = _State) -&gt;
<a name="13222"/>13222:                            case sock_bind(Sock, LSA) of
<a name="13223"/>13223:                                ok -&gt;
<a name="13224"/>13224:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13225"/>13225:                                    ok;
<a name="13226"/>13226:                                {error, Reason} = ERROR -&gt;
<a name="13227"/>13227:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13228"/>13228:                                    ERROR
<a name="13229"/>13229:                            end
<a name="13230"/>13230:                    end},
<a name="13231"/>13231:          #{desc =&gt; &quot;Bind TCP socket 1 to device&quot;,
<a name="13232"/>13232:            cmd  =&gt; fun(#{usock1 := USock1,
<a name="13233"/>13233:                          tsock1 := Sock, dev := Dev} = State) -&gt;
<a name="13234"/>13234:                            case Set(Sock, Dev) of
<a name="13235"/>13235:                                ok -&gt;
<a name="13236"/>13236:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13237"/>13237:                                    ok;
<a name="13238"/>13238:                                {error, eperm = Reason} when (USock1 =:= skip) -&gt;
<a name="13239"/>13239:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13240"/>13240:                                    {skip, Reason};
<a name="13241"/>13241:                                {error, eperm = Reason} -&gt;
<a name="13242"/>13242:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13243"/>13243:                                    (catch socket:close(Sock)),
<a name="13244"/>13244:                                    {ok, State#{tsock1 =&gt; skip}};
<a name="13245"/>13245:                                {error, Reason} = ERROR -&gt;
<a name="13246"/>13246:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13247"/>13247:                                    ERROR
<a name="13248"/>13248:                            end
<a name="13249"/>13249:                    end},
<a name="13250"/>13250:          #{desc =&gt; &quot;Bind TCP socket 2 to local address&quot;,
<a name="13251"/>13251:            cmd  =&gt; fun(#{tsock2 := Sock, local_sa := LSA} = _State) -&gt;
<a name="13252"/>13252:                            case sock_bind(Sock, LSA) of
<a name="13253"/>13253:                                ok -&gt;
<a name="13254"/>13254:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13255"/>13255:                                    ok;
<a name="13256"/>13256:                                {error, Reason} = ERROR -&gt;
<a name="13257"/>13257:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13258"/>13258:                                    ERROR
<a name="13259"/>13259:                            end
<a name="13260"/>13260:                    end},
<a name="13261"/>13261: 
<a name="13262"/>13262:          ?SEV_SLEEP(?SECS(1)),
<a name="13263"/>13263: 
<a name="13264"/>13264:          #{desc =&gt; &quot;[get] verify UDP socket 1 (after bindtodevice)&quot;,
<a name="13265"/>13265:            cmd  =&gt; fun(#{usock1 := skip} = _State) -&gt;
<a name="13266"/>13266:                            ?SEV_IPRINT(&quot;SKIP'ed (previous eperm)&quot;),
<a name="13267"/>13267:                            ok;
<a name="13268"/>13268:                       (#{usock1 := Sock} = _State) -&gt;
<a name="13269"/>13269:                            case Get(Sock) of
<a name="13270"/>13270:                                {ok, Dev} -&gt;
<a name="13271"/>13271:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13272"/>13272:                                    ok;
<a name="13273"/>13273:                                {error, Reason} = ERROR -&gt;
<a name="13274"/>13274:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13275"/>13275:                                    ERROR
<a name="13276"/>13276:                            end
<a name="13277"/>13277:                    end},
<a name="13278"/>13278:          #{desc =&gt; &quot;[get] verify UDP socket 2 (after bind)&quot;,
<a name="13279"/>13279:            cmd  =&gt; fun(#{usock2 := Sock} = _State) -&gt;
<a name="13280"/>13280:                            case Get(Sock) of
<a name="13281"/>13281:                                {ok, Dev} -&gt;
<a name="13282"/>13282:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13283"/>13283:                                    ok;
<a name="13284"/>13284:                                {error, Reason} = ERROR -&gt;
<a name="13285"/>13285:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13286"/>13286:                                    ERROR
<a name="13287"/>13287:                            end
<a name="13288"/>13288:                    end},
<a name="13289"/>13289:          #{desc =&gt; &quot;[get] verify TCP socket 1 (after bindtodevice)&quot;,
<a name="13290"/>13290:            cmd  =&gt; fun(#{tsock1 := skip} = _State) -&gt;
<a name="13291"/>13291:                            ?SEV_IPRINT(&quot;SKIP'ed (previous eperm)&quot;),
<a name="13292"/>13292:                            ok;
<a name="13293"/>13293:                       (#{tsock1 := Sock} = _State) -&gt;
<a name="13294"/>13294:                            case Get(Sock) of
<a name="13295"/>13295:                                {ok, Dev} -&gt;
<a name="13296"/>13296:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13297"/>13297:                                    ok;
<a name="13298"/>13298:                                {error, Reason} = ERROR -&gt;
<a name="13299"/>13299:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13300"/>13300:                                    ERROR
<a name="13301"/>13301:                            end
<a name="13302"/>13302:                    end},
<a name="13303"/>13303:          #{desc =&gt; &quot;[get] verify TCP socket 2 (after bind)&quot;,
<a name="13304"/>13304:            cmd  =&gt; fun(#{tsock2 := Sock} = _State) -&gt;
<a name="13305"/>13305:                            case Get(Sock) of
<a name="13306"/>13306:                                {ok, Dev} -&gt;
<a name="13307"/>13307:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="13308"/>13308:                                    ok;
<a name="13309"/>13309:                                {error, Reason} = ERROR -&gt;
<a name="13310"/>13310:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13311"/>13311:                                    ERROR
<a name="13312"/>13312:                            end
<a name="13313"/>13313:                    end},
<a name="13314"/>13314: 
<a name="13315"/>13315:          ?SEV_SLEEP(?SECS(1)),
<a name="13316"/>13316: 
<a name="13317"/>13317:          %% *** Termination ***
<a name="13318"/>13318:          #{desc =&gt; &quot;close UDP socket 1&quot;,
<a name="13319"/>13319:            cmd  =&gt; fun(#{usock1 := skip} = State) -&gt;
<a name="13320"/>13320:                            ?SEV_IPRINT(&quot;SKIP'ed (already closed)&quot;),
<a name="13321"/>13321:                            {ok, maps:remove(usock1, State)};
<a name="13322"/>13322:                       (#{usock1 := Sock} = State) -&gt;
<a name="13323"/>13323:                            socket:close(Sock),
<a name="13324"/>13324:                            {ok, maps:remove(usock1, State)}
<a name="13325"/>13325:                    end},
<a name="13326"/>13326:          #{desc =&gt; &quot;close UDP socket 2&quot;,
<a name="13327"/>13327:            cmd  =&gt; fun(#{usock2 := Sock} = State) -&gt;
<a name="13328"/>13328:                            socket:close(Sock),
<a name="13329"/>13329:                            {ok, maps:remove(usock2, State)}
<a name="13330"/>13330:                    end},
<a name="13331"/>13331:          #{desc =&gt; &quot;close TCP socket 1&quot;,
<a name="13332"/>13332:            cmd  =&gt; fun(#{tsock1 := skip} = State) -&gt;
<a name="13333"/>13333:                            ?SEV_IPRINT(&quot;SKIP'ed (already closed)&quot;),
<a name="13334"/>13334:                            {ok, maps:remove(tsock1, State)};
<a name="13335"/>13335:                       (#{tsock1 := Sock} = State) -&gt;
<a name="13336"/>13336:                            socket:close(Sock),
<a name="13337"/>13337:                            {ok, maps:remove(tsock1, State)}
<a name="13338"/>13338:                    end},
<a name="13339"/>13339:          #{desc =&gt; &quot;close TCP socket 2&quot;,
<a name="13340"/>13340:            cmd  =&gt; fun(#{tsock2 := Sock} = State) -&gt;
<a name="13341"/>13341:                            socket:close(Sock),
<a name="13342"/>13342:                            {ok, maps:remove(tsock2, State)}
<a name="13343"/>13343:                    end},
<a name="13344"/>13344: 
<a name="13345"/>13345:          %% *** We are done ***
<a name="13346"/>13346:          ?SEV_FINISH_NORMAL
<a name="13347"/>13347:         ],
<a name="13348"/>13348: 
<a name="13349"/>13349:     Domain = inet_or_inet6(),
<a name="13350"/>13350: 
<a name="13351"/>13351:     i(&quot;start tester evaluator&quot;),
<a name="13352"/>13352:     InitState = #{domain  =&gt; Domain},
<a name="13353"/>13353:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13354"/>13354: 
<a name="13355"/>13355:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_bindtodevice-last_expr"/><a name="13356"/>13356: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13357"/>13357: 
<a name="13358"/>13358: 
<a name="13359"/>13359: 
<a name="13360"/>13360: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13361"/>13361: 
<a name="13362"/>13362: <i>%% Tests the socket option broadcast.</i>
<a name="13363"/>13363: <i>%% Make it possible for datagram sockets to send packets to a broadcast</i>
<a name="13364"/>13364: <i>%% address (IPv4 only).</i>
<a name="13365"/>13365: 
<a name="api_opt_sock_broadcast-1"/><a name="13366"/>13366: <b>api_opt_sock_broadcast</b>(_Config) when is_list(_Config) -&gt;
<a name="13367"/>13367:     ?TT(?SECS(30)),
<a name="api_opt_sock_broadcast-last_expr"/><a name="13368"/>13368: <b>    tc_try</b>(api_opt_sock_broadcast,
<a name="13369"/>13369:            fun() -&gt; has_support_sock_broadcast() end,
<a name="13370"/>13370:            fun() -&gt; api_opt_sock_broadcast() end).
<a name="13371"/>13371: 
<a name="13372"/>13372: 
<a name="api_opt_sock_broadcast-0"/><a name="13373"/>13373: <b>api_opt_sock_broadcast</b>() -&gt;
<a name="13374"/>13374:     Opt    = broadcast,
<a name="13375"/>13375:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="13376"/>13376:                      socket:setopt(S, socket, Opt, Val)
<a name="13377"/>13377:              end,
<a name="13378"/>13378:     Get    = fun(S) -&gt;
<a name="13379"/>13379:                      socket:getopt(S, socket, Opt)
<a name="13380"/>13380:              end,
<a name="13381"/>13381: 
<a name="13382"/>13382:     TesterSeq =
<a name="13383"/>13383:         [
<a name="13384"/>13384:          #{desc =&gt; &quot;which local address&quot;,
<a name="13385"/>13385:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13386"/>13386:                            case which_local_host_info(Domain) of
<a name="13387"/>13387:                                {ok, #{name      := Name,
<a name="13388"/>13388:                                       addr      := Addr,
<a name="13389"/>13389:                                       broadaddr := BAddr}}
<a name="13390"/>13390: 				 when (BAddr =/= undefined) -&gt;
<a name="13391"/>13391:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="13392"/>13392:                                                &quot;~n   Name:           ~p&quot;
<a name="13393"/>13393:                                                &quot;~n   Addr:           ~p&quot;
<a name="13394"/>13394:                                                &quot;~n   Broadcast Addr: ~p&quot;,
<a name="13395"/>13395:                                                [Name, Addr, BAddr]),
<a name="13396"/>13396:                                    LSA = #{family =&gt; Domain,
<a name="13397"/>13397:                                            addr   =&gt; Addr},
<a name="13398"/>13398:                                    BSA = #{family =&gt; Domain,
<a name="13399"/>13399:                                            addr   =&gt; BAddr},
<a name="13400"/>13400:                                    {ok, State#{lsa =&gt; LSA,
<a name="13401"/>13401:                                                bsa =&gt; BSA}};
<a name="13402"/>13402: 			       {ok, _} -&gt;
<a name="13403"/>13403: 				   {skip, no_broadcast_address};
<a name="13404"/>13404:                                {error, _} = ERROR -&gt;
<a name="13405"/>13405:                                    ERROR
<a name="13406"/>13406:                            end
<a name="13407"/>13407:                    end},
<a name="13408"/>13408: 
<a name="13409"/>13409:          #{desc =&gt; &quot;[socket 1] create UDP socket (listening 1)&quot;,
<a name="13410"/>13410:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13411"/>13411:                            case socket:open(Domain, dgram, udp) of
<a name="13412"/>13412:                                {ok, Sock} -&gt;
<a name="13413"/>13413:                                    {ok, State#{sock1 =&gt; Sock}};
<a name="13414"/>13414:                                {error, _} = ERROR -&gt;
<a name="13415"/>13415:                                    ERROR
<a name="13416"/>13416:                            end
<a name="13417"/>13417:                    end},
<a name="13418"/>13418:          #{desc =&gt; &quot;[socket 1] Bind UDP socket (to limited broadcast address)&quot;,
<a name="13419"/>13419:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="13420"/>13420: 			   BSA = #{family =&gt; inet,
<a name="13421"/>13421: 				   addr   =&gt; broadcast},
<a name="13422"/>13422:                            ?SEV_IPRINT(&quot;Try bind (socket 1) to: &quot;
<a name="13423"/>13423:                                        &quot;~n   ~p&quot;, [BSA]),
<a name="13424"/>13424:                            case socket:bind(Sock, BSA) of
<a name="13425"/>13425:                                ok -&gt;
<a name="13426"/>13426:                                    Port = sock_port(Sock),
<a name="13427"/>13427:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="13428"/>13428:                                                [Port]),
<a name="13429"/>13429:                                    {ok, State#{sa1 =&gt; BSA#{port =&gt; Port}}};
<a name="13430"/>13430:                                {error, eaddrnotavail = Reason} -&gt;
<a name="13431"/>13431:                                    ?SEV_IPRINT(&quot;~p =&gt; &quot;
<a name="13432"/>13432: 					       &quot;SKIP limited broadcast test&quot;,
<a name="13433"/>13433: 					       [Reason]),
<a name="13434"/>13434:                                    {ok, State#{sa1 =&gt; skip}};
<a name="13435"/>13435:                                {error, Reason} = ERROR -&gt;
<a name="13436"/>13436:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13437"/>13437: 					       [Reason]),
<a name="13438"/>13438:                                    ERROR
<a name="13439"/>13439:                            end
<a name="13440"/>13440:                    end},
<a name="13441"/>13441:          #{desc =&gt; &quot;[socket 1] UDP socket sockname&quot;,
<a name="13442"/>13442:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="13443"/>13443:                            ?SEV_IPRINT(&quot;SKIP limited broadcast test&quot;),
<a name="13444"/>13444:                            ok;
<a name="13445"/>13445: 		      (#{sock1 := Sock} = _State) -&gt;
<a name="13446"/>13446: 			   case socket:sockname(Sock) of
<a name="13447"/>13447: 			       {ok, SA} -&gt;
<a name="13448"/>13448: 				   ?SEV_IPRINT(&quot;SA: ~p&quot;, [SA]),
<a name="13449"/>13449: 				   ok;
<a name="13450"/>13450: 			       {error, _} = ERROR -&gt;
<a name="13451"/>13451: 				   ERROR
<a name="13452"/>13452: 			   end
<a name="13453"/>13453:                    end},
<a name="13454"/>13454: 
<a name="13455"/>13455:          ?SEV_SLEEP(?SECS(1)),
<a name="13456"/>13456: 
<a name="13457"/>13457:          #{desc =&gt; &quot;[socket 2] create UDP socket (listening 2)&quot;,
<a name="13458"/>13458:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13459"/>13459:                            case socket:open(Domain, dgram, udp) of
<a name="13460"/>13460:                                {ok, Sock} -&gt;
<a name="13461"/>13461:                                    {ok, State#{sock2 =&gt; Sock}};
<a name="13462"/>13462:                                {error, _} = ERROR -&gt;
<a name="13463"/>13463:                                    ERROR
<a name="13464"/>13464:                            end
<a name="13465"/>13465:                    end},
<a name="13466"/>13466:          #{desc =&gt; &quot;[socket 2] Bind UDP socket (to subnet-directed broadcast address)&quot;,
<a name="13467"/>13467:            cmd  =&gt; fun(#{sock2 := Sock,
<a name="13468"/>13468: 			 bsa   := BSA} = State) -&gt;
<a name="13469"/>13469:                            ?SEV_IPRINT(&quot;Try bind (socket 1) to: &quot;
<a name="13470"/>13470:                                        &quot;~n   ~p&quot;, [BSA]),
<a name="13471"/>13471:                            case socket:bind(Sock, BSA) of
<a name="13472"/>13472:                                ok -&gt;
<a name="13473"/>13473:                                    Port = sock_port(Sock),
<a name="13474"/>13474:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="13475"/>13475:                                                [Port]),
<a name="13476"/>13476:                                    {ok, State#{sa2 =&gt; BSA#{port =&gt; Port}}};
<a name="13477"/>13477:                                {error, eaddrnotavail = Reason} -&gt;
<a name="13478"/>13478:                                    ?SEV_IPRINT(&quot;~p =&gt; &quot;
<a name="13479"/>13479: 					       &quot;SKIP subnet-directed broadcast test&quot;,
<a name="13480"/>13480: 					       [Reason]),
<a name="13481"/>13481:                                    {ok, State#{sa2 =&gt; skip}};
<a name="13482"/>13482:                                {error, Reason} = ERROR -&gt;
<a name="13483"/>13483:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13484"/>13484: 					       [Reason]),
<a name="13485"/>13485:                                    ERROR
<a name="13486"/>13486:                            end
<a name="13487"/>13487:                    end},
<a name="13488"/>13488:          #{desc =&gt; &quot;[socket 2] UDP socket sockname&quot;,
<a name="13489"/>13489:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="13490"/>13490:                            ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test&quot;),
<a name="13491"/>13491:                            ok;
<a name="13492"/>13492: 		      (#{sock2 := Sock} = _State) -&gt;
<a name="13493"/>13493:                            case socket:sockname(Sock) of
<a name="13494"/>13494:                                {ok, SA} -&gt;
<a name="13495"/>13495: 				   ?SEV_IPRINT(&quot;SA: ~p&quot;, [SA]),
<a name="13496"/>13496:                                    ok;
<a name="13497"/>13497:                                {error, _} = ERROR -&gt;
<a name="13498"/>13498:                                    ERROR
<a name="13499"/>13499:                            end
<a name="13500"/>13500:                    end},
<a name="13501"/>13501: 
<a name="13502"/>13502:          ?SEV_SLEEP(?SECS(1)),
<a name="13503"/>13503: 
<a name="13504"/>13504:          #{desc =&gt; &quot;[socket 3] create UDP socket (sender)&quot;,
<a name="13505"/>13505:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13506"/>13506:                            case socket:open(Domain, dgram, udp) of
<a name="13507"/>13507:                                {ok, Sock} -&gt;
<a name="13508"/>13508:                                    {ok, State#{sock3 =&gt; Sock}};
<a name="13509"/>13509:                                {error, _} = ERROR -&gt;
<a name="13510"/>13510:                                    ERROR
<a name="13511"/>13511:                            end
<a name="13512"/>13512:                    end},
<a name="13513"/>13513:          #{desc =&gt; &quot;[socket 3][get] verify UDP socket (before bind and set)&quot;,
<a name="13514"/>13514:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="13515"/>13515:                            case Get(Sock) of
<a name="13516"/>13516:                                {ok, false} -&gt;
<a name="13517"/>13517:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13518"/>13518:                                                &quot;broadcast not allowed&quot;),
<a name="13519"/>13519:                                    ok;
<a name="13520"/>13520:                                {ok, true} -&gt;
<a name="13521"/>13521:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="13522"/>13522:                                                &quot;broadcast already allowed&quot;),
<a name="13523"/>13523:                                    ok;
<a name="13524"/>13524:                                {error, Reason} = ERROR -&gt;
<a name="13525"/>13525:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13526"/>13526: 					       [Reason]),
<a name="13527"/>13527:                                    ERROR
<a name="13528"/>13528:                            end
<a name="13529"/>13529:                    end},
<a name="13530"/>13530:          #{desc =&gt; &quot;[socket 3] Try make broadcast allowed&quot;,
<a name="13531"/>13531:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="13532"/>13532:                            case Set(Sock, true) of
<a name="13533"/>13533:                                ok -&gt;
<a name="13534"/>13534:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13535"/>13535:                                                &quot;broadcast now allowed&quot;),
<a name="13536"/>13536:                                    ok;
<a name="13537"/>13537:                                {error, Reason} = ERROR -&gt;
<a name="13538"/>13538:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13539"/>13539: 					       [Reason]),
<a name="13540"/>13540:                                    ERROR
<a name="13541"/>13541:                            end
<a name="13542"/>13542:                    end},
<a name="13543"/>13543:          #{desc =&gt; &quot;[socket 3] verify UDP socket broadcast allowed&quot;,
<a name="13544"/>13544:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="13545"/>13545:                            case Get(Sock) of
<a name="13546"/>13546:                                {ok, true} -&gt;
<a name="13547"/>13547:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13548"/>13548:                                                &quot;broadcast allowed&quot;),
<a name="13549"/>13549:                                    ok;
<a name="13550"/>13550:                                {ok, false} -&gt;
<a name="13551"/>13551:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="13552"/>13552:                                                &quot;broadcast *not* allowed&quot;),
<a name="13553"/>13553:                                    ok;
<a name="13554"/>13554:                                {error, Reason} = ERROR -&gt;
<a name="13555"/>13555:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13556"/>13556: 					       [Reason]),
<a name="13557"/>13557:                                    ERROR
<a name="13558"/>13558:                            end
<a name="13559"/>13559:                    end},
<a name="13560"/>13560:          #{desc =&gt; &quot;[socket 3] Bind UDP socket (to local address)&quot;,
<a name="13561"/>13561:            cmd  =&gt; fun(#{sock3 := Sock, lsa := LSA} = State) -&gt;
<a name="13562"/>13562:                            ?SEV_IPRINT(&quot;Try bind (socket 2) to: &quot;
<a name="13563"/>13563:                                        &quot;~n   ~p&quot;, [LSA]),
<a name="13564"/>13564:                            case socket:bind(Sock, LSA) of
<a name="13565"/>13565:                                ok -&gt;
<a name="13566"/>13566:                                    Port = sock_port(Sock),
<a name="13567"/>13567:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="13568"/>13568:                                                [Port]),
<a name="13569"/>13569:                                    {ok, State#{sa3 =&gt; LSA#{port =&gt; Port}}};
<a name="13570"/>13570:                                {error, Reason} = ERROR -&gt;
<a name="13571"/>13571:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13572"/>13572: 					       [Reason]),
<a name="13573"/>13573:                                    ERROR
<a name="13574"/>13574:                            end
<a name="13575"/>13575:                    end},
<a name="13576"/>13576:          #{desc =&gt; &quot;[socket 3] verify UDP socket (after set)&quot;,
<a name="13577"/>13577:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="13578"/>13578:                            case Get(Sock) of
<a name="13579"/>13579:                                {ok, true} -&gt;
<a name="13580"/>13580:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13581"/>13581:                                                &quot;broadcast allowed&quot;),
<a name="13582"/>13582:                                    ok;
<a name="13583"/>13583:                                {ok, false} -&gt;
<a name="13584"/>13584:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="13585"/>13585:                                                &quot;broadcast not allowed&quot;),
<a name="13586"/>13586:                                    {error, not_allowed};
<a name="13587"/>13587:                                {error, Reason} = ERROR -&gt;
<a name="13588"/>13588:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13589"/>13589: 					       [Reason]),
<a name="13590"/>13590:                                    ERROR
<a name="13591"/>13591:                            end
<a name="13592"/>13592:                    end},
<a name="13593"/>13593: 
<a name="13594"/>13594: 	 ?SEV_SLEEP(?SECS(1)),
<a name="13595"/>13595: 
<a name="13596"/>13596:          #{desc =&gt; &quot;[socket 3] try send to limited broadcast address&quot;,
<a name="13597"/>13597:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="13598"/>13598:                            ?SEV_IPRINT(&quot;SKIP limited broadcast test (send)&quot;),
<a name="13599"/>13599: 			   ok;
<a name="13600"/>13600: 		      (#{sock3 := Sock,
<a name="13601"/>13601: 			 sa1   := Dest} = _State) -&gt;
<a name="13602"/>13602: 			   Data = list_to_binary(&quot;hejsan&quot;),
<a name="13603"/>13603: 			   ?SEV_IPRINT(&quot;try send to broadcast address: &quot;
<a name="13604"/>13604: 				       &quot;~n   ~p&quot;, [Dest]),
<a name="13605"/>13605: 			   case socket:sendto(Sock, Data, Dest) of
<a name="13606"/>13606: 			       ok -&gt;
<a name="13607"/>13607: 				   ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13608"/>13608: 					       &quot;broadcast message sent&quot;),
<a name="13609"/>13609: 				   ok;
<a name="13610"/>13610: 			       {error, Reason} = ERROR -&gt;
<a name="13611"/>13611: 				   ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13612"/>13612: 					       [Reason]),
<a name="13613"/>13613: 				   ERROR
<a name="13614"/>13614: 			   end
<a name="13615"/>13615: 		   end},
<a name="13616"/>13616:          #{desc =&gt; &quot;[socket 1] try recv&quot;,
<a name="13617"/>13617:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="13618"/>13618: 			   ?SEV_IPRINT(&quot;SKIP limited broadcast test (recv)&quot;),
<a name="13619"/>13619: 			   ok;
<a name="13620"/>13620: 		      (#{sock1 := Sock} = State) -&gt;
<a name="13621"/>13621:                            case socket:recvfrom(Sock, 0, 5000) of
<a name="13622"/>13622:                                {ok, _} -&gt;
<a name="13623"/>13623:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13624"/>13624:                                                &quot;received message&quot;),
<a name="13625"/>13625:                                    ok;
<a name="13626"/>13626:                                {error, timeout = Reason} -&gt;
<a name="13627"/>13627:                                    %% Some platforms seem to balk at this.
<a name="13628"/>13628:                                    %% It spossible to bind to this, and
<a name="13629"/>13629:                                    %% send to it, but no data is received.
<a name="13630"/>13630:                                    %% At some point we should investigate...
<a name="13631"/>13631:                                    %% For now, we just skip this part of
<a name="13632"/>13632:                                    %% the test...
<a name="13633"/>13633:                                    ?SEV_IPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13634"/>13634: 					       [Reason]),
<a name="13635"/>13635:                                    {ok, State#{sa1 =&gt; skip}};
<a name="13636"/>13636:                                {error, Reason} = ERROR -&gt;
<a name="13637"/>13637:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13638"/>13638: 					       [Reason]),
<a name="13639"/>13639:                                    ERROR
<a name="13640"/>13640:                            end
<a name="13641"/>13641:                    end},
<a name="13642"/>13642: 
<a name="13643"/>13643: 	 ?SEV_SLEEP(?SECS(1)),
<a name="13644"/>13644: 
<a name="13645"/>13645:          #{desc =&gt; &quot;[socket 2] try send to subnet-directed broadcast address&quot;,
<a name="13646"/>13646:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="13647"/>13647: 			   ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test &quot;
<a name="13648"/>13648:                                        &quot;(send)&quot;),
<a name="13649"/>13649: 			   ok;
<a name="13650"/>13650: 		      (#{sock2 := Sock,
<a name="13651"/>13651:                          sa2   := Dest} = _State) -&gt;
<a name="13652"/>13652:                            Data = list_to_binary(&quot;hejsan&quot;),
<a name="13653"/>13653:                            ?SEV_IPRINT(&quot;try send to broadcast address: &quot;
<a name="13654"/>13654:                                        &quot;~n   ~p&quot;, [Dest]),
<a name="13655"/>13655:                            case socket:sendto(Sock, Data, Dest) of
<a name="13656"/>13656:                                ok -&gt;
<a name="13657"/>13657:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13658"/>13658:                                                &quot;broadcast message sent&quot;),
<a name="13659"/>13659:                                    ok;
<a name="13660"/>13660:                                {error, eaddrnotavail = Reason} -&gt;
<a name="13661"/>13661:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="13662"/>13662:                                                [Reason]),
<a name="13663"/>13663:                                    {skip, Reason};
<a name="13664"/>13664:                                {error, eacces = Reason} -&gt;
<a name="13665"/>13665:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="13666"/>13666: 					       [Reason]),
<a name="13667"/>13667:                                    {skip, Reason};
<a name="13668"/>13668:                                {error, Reason} = ERROR -&gt;
<a name="13669"/>13669:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13670"/>13670: 					       [Reason]),
<a name="13671"/>13671:                                    ERROR
<a name="13672"/>13672:                            end
<a name="13673"/>13673:                    end},
<a name="13674"/>13674:          #{desc =&gt; &quot;[socket 2] try recv&quot;,
<a name="13675"/>13675:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="13676"/>13676: 			   ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test &quot;
<a name="13677"/>13677:                                          &quot;(recv)&quot;),
<a name="13678"/>13678: 			   ok;
<a name="13679"/>13679: 		      (#{sock2 := Sock, sa2 := SA2} = _State) -&gt;
<a name="13680"/>13680:                            case socket:recvfrom(Sock, 0, 5000) of
<a name="13681"/>13681:                                {ok, _} -&gt;
<a name="13682"/>13682:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13683"/>13683:                                                &quot;received message&quot;),
<a name="13684"/>13684:                                    ok;
<a name="13685"/>13685:                                {error, timeout = Reason} when (SA2 =:= skip) -&gt;
<a name="13686"/>13686:                                    ?SEV_IPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13687"/>13687: 					       [Reason]),
<a name="13688"/>13688:                                    {skip, &quot;receive timeout&quot;};
<a name="13689"/>13689:                                {error, Reason} = ERROR -&gt;
<a name="13690"/>13690:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13691"/>13691: 					       [Reason]),
<a name="13692"/>13692:                                    ERROR
<a name="13693"/>13693:                            end
<a name="13694"/>13694:                    end},
<a name="13695"/>13695: 
<a name="13696"/>13696:          %% *** Termination ***
<a name="13697"/>13697:          #{desc =&gt; &quot;[socket 3] close UDP socket (sender)&quot;,
<a name="13698"/>13698:            cmd  =&gt; fun(#{sock3 := Sock} = State0) -&gt;
<a name="13699"/>13699:                            socket:close(Sock),
<a name="13700"/>13700: 			   State1 = maps:remove(sock3, State0),
<a name="13701"/>13701: 			   State2 = maps:remove(sa3,   State1),
<a name="13702"/>13702: 			   {ok, State2}
<a name="13703"/>13703:                    end},
<a name="13704"/>13704:          #{desc =&gt; &quot;[socket 2] close UDP socket (listener 2)&quot;,
<a name="13705"/>13705:            cmd  =&gt; fun(#{sock2 := Sock} = State0) -&gt;
<a name="13706"/>13706:                            socket:close(Sock),
<a name="13707"/>13707: 			   State1 = maps:remove(sock2, State0),
<a name="13708"/>13708: 			   State2 = maps:remove(sa2,   State1),
<a name="13709"/>13709:                            {ok, State2}
<a name="13710"/>13710:                    end},
<a name="13711"/>13711:          #{desc =&gt; &quot;[socket 1] close UDP socket (listener 1)&quot;,
<a name="13712"/>13712:            cmd  =&gt; fun(#{sock1 := Sock} = State0) -&gt;
<a name="13713"/>13713:                            socket:close(Sock),
<a name="13714"/>13714: 			   State1 = maps:remove(sock1, State0),
<a name="13715"/>13715: 			   State2 = maps:remove(sa1,   State1),
<a name="13716"/>13716:                            {ok, State2}
<a name="13717"/>13717:                    end},
<a name="13718"/>13718: 
<a name="13719"/>13719:          %% *** We are done ***
<a name="13720"/>13720:          ?SEV_FINISH_NORMAL
<a name="13721"/>13721:         ],
<a name="13722"/>13722: 
<a name="13723"/>13723:     Domain = inet_or_inet6(),
<a name="13724"/>13724: 
<a name="13725"/>13725:     i(&quot;start tester evaluator&quot;),
<a name="13726"/>13726:     InitState = #{domain =&gt; Domain},
<a name="13727"/>13727:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13728"/>13728: 
<a name="13729"/>13729:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_broadcast-last_expr"/><a name="13730"/>13730: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13731"/>13731: 
<a name="13732"/>13732: 
<a name="13733"/>13733: 
<a name="13734"/>13734: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13735"/>13735: 
<a name="13736"/>13736: <i>%% Tests the socket option debug.</i>
<a name="13737"/>13737: <i>%% On linux, this test requires that the user running the test to have</i>
<a name="13738"/>13738: <i>%% CAP_NET_ADMIN capabilities or be root (effective user ID of 0), </i>
<a name="13739"/>13739: <i>%% therefore we explicitly test for the result eacces when attempting to</i>
<a name="13740"/>13740: <i>%% set, and skip if we get it.</i>
<a name="13741"/>13741: 
<a name="api_opt_sock_debug-1"/><a name="13742"/>13742: <b>api_opt_sock_debug</b>(_Config) when is_list(_Config) -&gt;
<a name="13743"/>13743:     ?TT(?SECS(10)),
<a name="api_opt_sock_debug-last_expr"/><a name="13744"/>13744: <b>    tc_try</b>(api_opt_sock_debug,
<a name="13745"/>13745:            fun() -&gt; has_support_sock_debug() end,
<a name="13746"/>13746:            fun() -&gt; api_opt_sock_debug() end).
<a name="13747"/>13747: 
<a name="13748"/>13748: 
<a name="api_opt_sock_debug-0"/><a name="13749"/>13749: <b>api_opt_sock_debug</b>() -&gt;
<a name="13750"/>13750:     Opt    = debug,
<a name="13751"/>13751:     Set    = fun(S, Val) when is_integer(Val) -&gt;
<a name="13752"/>13752:                      socket:setopt(S, socket, Opt, Val)
<a name="13753"/>13753:              end,
<a name="13754"/>13754:     Get    = fun(S) -&gt;
<a name="13755"/>13755:                      socket:getopt(S, socket, Opt)
<a name="13756"/>13756:              end,
<a name="13757"/>13757: 
<a name="13758"/>13758:     TesterSeq =
<a name="13759"/>13759:         [
<a name="13760"/>13760:          #{desc =&gt; &quot;which local address&quot;,
<a name="13761"/>13761:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13762"/>13762:                            case which_local_host_info(Domain) of
<a name="13763"/>13763:                                {ok, #{name      := Name,
<a name="13764"/>13764:                                       addr      := Addr}} -&gt;
<a name="13765"/>13765:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="13766"/>13766:                                                &quot;~n   Name:           ~p&quot;
<a name="13767"/>13767:                                                &quot;~n   Addr:           ~p&quot;,
<a name="13768"/>13768:                                                [Name, Addr]),
<a name="13769"/>13769:                                    LSA = #{family =&gt; Domain,
<a name="13770"/>13770:                                            addr   =&gt; Addr},
<a name="13771"/>13771:                                    {ok, State#{lsa =&gt; LSA}};
<a name="13772"/>13772:                                {error, _} = ERROR -&gt;
<a name="13773"/>13773:                                    ERROR
<a name="13774"/>13774:                            end
<a name="13775"/>13775:                    end},
<a name="13776"/>13776: 
<a name="13777"/>13777:          #{desc =&gt; &quot;create UDP socket&quot;,
<a name="13778"/>13778:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13779"/>13779:                            case socket:open(Domain, dgram, udp) of
<a name="13780"/>13780:                                {ok, Sock} -&gt;
<a name="13781"/>13781:                                    {ok, State#{sock =&gt; Sock}};
<a name="13782"/>13782:                                {error, _} = ERROR -&gt;
<a name="13783"/>13783:                                    ERROR
<a name="13784"/>13784:                            end
<a name="13785"/>13785:                    end},
<a name="13786"/>13786:          #{desc =&gt; &quot;Get current debug value&quot;,
<a name="13787"/>13787:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="13788"/>13788:                            case Get(Sock) of
<a name="13789"/>13789:                                {ok, Debug} when is_integer(Debug) -&gt;
<a name="13790"/>13790:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Debug]),
<a name="13791"/>13791:                                    {ok, State#{debug =&gt; Debug}};
<a name="13792"/>13792:                                {error, Reason} = ERROR -&gt;
<a name="13793"/>13793:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="13794"/>13794:                                                [Reason]),
<a name="13795"/>13795:                                    ERROR
<a name="13796"/>13796:                            end
<a name="13797"/>13797:                    end},
<a name="13798"/>13798:          #{desc =&gt; &quot;Try enable socket debug&quot;,
<a name="13799"/>13799:            cmd  =&gt; fun(#{sock := Sock, debug := Debug} = State) -&gt;
<a name="13800"/>13800: 			   NewDebug = Debug + 1,
<a name="13801"/>13801:                            case Set(Sock, NewDebug) of
<a name="13802"/>13802:                                ok -&gt;
<a name="13803"/>13803:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="13804"/>13804:                                    {ok, State#{debug =&gt; NewDebug}};
<a name="13805"/>13805:                                {error, eacces = Reason} -&gt;
<a name="13806"/>13806:                                    ?SEV_EPRINT(&quot;NO ACCESS =&gt; SKIP&quot;),
<a name="13807"/>13807:                                    {skip, Reason};
<a name="13808"/>13808:                                {error, Reason} = ERROR -&gt;
<a name="13809"/>13809:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13810"/>13810: 					       [Reason]),
<a name="13811"/>13811:                                    ERROR
<a name="13812"/>13812:                            end
<a name="13813"/>13813:                    end},
<a name="13814"/>13814:          #{desc =&gt; &quot;Get current (new) debug value&quot;,
<a name="13815"/>13815:            cmd  =&gt; fun(#{sock := Sock, debug := Debug} = _State) -&gt;
<a name="13816"/>13816:                            case Get(Sock) of
<a name="13817"/>13817:                                {ok, Debug} when is_integer(Debug) -&gt;
<a name="13818"/>13818:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Debug]),
<a name="13819"/>13819:                                    ok;
<a name="13820"/>13820:                                {error, Reason} = ERROR -&gt;
<a name="13821"/>13821:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="13822"/>13822:                                                [Reason]),
<a name="13823"/>13823:                                    ERROR
<a name="13824"/>13824:                            end
<a name="13825"/>13825:                    end},
<a name="13826"/>13826: 
<a name="13827"/>13827:          %% *** Termination ***
<a name="13828"/>13828:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="13829"/>13829:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="13830"/>13830:                            socket:close(Sock),
<a name="13831"/>13831: 			   State1 = maps:remove(sock, State0),
<a name="13832"/>13832:                            {ok, State1}
<a name="13833"/>13833:                    end},
<a name="13834"/>13834: 
<a name="13835"/>13835:          %% *** We are done ***
<a name="13836"/>13836:          ?SEV_FINISH_NORMAL
<a name="13837"/>13837:         ],
<a name="13838"/>13838: 
<a name="13839"/>13839:     Domain = inet_or_inet6(),
<a name="13840"/>13840: 
<a name="13841"/>13841:     i(&quot;start tester evaluator&quot;),
<a name="13842"/>13842:     InitState = #{domain =&gt; Domain},
<a name="13843"/>13843:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13844"/>13844: 
<a name="13845"/>13845:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_debug-last_expr"/><a name="13846"/>13846: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13847"/>13847: 
<a name="13848"/>13848: 
<a name="13849"/>13849: 
<a name="13850"/>13850: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13851"/>13851: 
<a name="13852"/>13852: <i>%% Tests the socket option domain.</i>
<a name="13853"/>13853: <i>%% This is a read only option. Also not available on all platforms.</i>
<a name="13854"/>13854: 
<a name="api_opt_sock_domain-1"/><a name="13855"/>13855: <b>api_opt_sock_domain</b>(_Config) when is_list(_Config) -&gt;
<a name="13856"/>13856:     ?TT(?SECS(10)),
<a name="api_opt_sock_domain-last_expr"/><a name="13857"/>13857: <b>    tc_try</b>(api_opt_sock_domain,
<a name="13858"/>13858:            fun() -&gt; has_support_sock_domain() end,
<a name="13859"/>13859:            fun() -&gt; api_opt_sock_domain() end).
<a name="13860"/>13860: 
<a name="13861"/>13861: 
<a name="api_opt_sock_domain-0"/><a name="13862"/>13862: <b>api_opt_sock_domain</b>() -&gt;
<a name="13863"/>13863:     Opt = domain,
<a name="13864"/>13864:     Get = fun(S) -&gt;
<a name="13865"/>13865:                   socket:getopt(S, socket, Opt)
<a name="13866"/>13866:           end,
<a name="13867"/>13867: 
<a name="13868"/>13868:     TesterSeq =
<a name="13869"/>13869:         [
<a name="13870"/>13870:          #{desc =&gt; &quot;which local address&quot;,
<a name="13871"/>13871:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13872"/>13872:                            case which_local_host_info(Domain) of
<a name="13873"/>13873:                                {ok, #{name := Name,
<a name="13874"/>13874:                                       addr := Addr}} -&gt;
<a name="13875"/>13875:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="13876"/>13876:                                                &quot;~n   Name: ~p&quot;
<a name="13877"/>13877:                                                &quot;~n   Addr: ~p&quot;,
<a name="13878"/>13878:                                                [Name, Addr]),
<a name="13879"/>13879:                                    LSA = #{family =&gt; Domain,
<a name="13880"/>13880:                                            addr   =&gt; Addr},
<a name="13881"/>13881:                                    {ok, State#{lsa =&gt; LSA}};
<a name="13882"/>13882:                                {error, _} = ERROR -&gt;
<a name="13883"/>13883:                                    ERROR
<a name="13884"/>13884:                            end
<a name="13885"/>13885:                    end},
<a name="13886"/>13886: 
<a name="13887"/>13887:          #{desc =&gt; &quot;create IPv4 UDP socket&quot;,
<a name="13888"/>13888:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13889"/>13889:                            case socket:open(Domain, dgram, udp) of
<a name="13890"/>13890:                                {ok, Sock} -&gt;
<a name="13891"/>13891:                                    {ok, State#{usock =&gt; Sock}};
<a name="13892"/>13892:                                {error, _} = ERROR -&gt;
<a name="13893"/>13893:                                    ERROR
<a name="13894"/>13894:                            end
<a name="13895"/>13895:                    end},
<a name="13896"/>13896:          #{desc =&gt; &quot;Get domain for the UDP socket&quot;,
<a name="13897"/>13897:            cmd  =&gt; fun(#{domain := Domain, usock := Sock} = _State) -&gt;
<a name="13898"/>13898:                            case Get(Sock) of
<a name="13899"/>13899:                                {ok, Domain} -&gt;
<a name="13900"/>13900:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Domain]),
<a name="13901"/>13901:                                    ok;
<a name="13902"/>13902:                                {error, Reason} = ERROR -&gt;
<a name="13903"/>13903:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="13904"/>13904:                                                [Reason]),
<a name="13905"/>13905:                                    ERROR
<a name="13906"/>13906:                            end
<a name="13907"/>13907:                    end},
<a name="13908"/>13908:          #{desc =&gt; &quot;create TCP socket&quot;,
<a name="13909"/>13909:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13910"/>13910:                            case socket:open(Domain, stream, tcp) of
<a name="13911"/>13911:                                {ok, Sock} -&gt;
<a name="13912"/>13912:                                    {ok, State#{tsock =&gt; Sock}};
<a name="13913"/>13913:                                {error, _} = ERROR -&gt;
<a name="13914"/>13914:                                    ERROR
<a name="13915"/>13915:                            end
<a name="13916"/>13916:                    end},
<a name="13917"/>13917:          #{desc =&gt; &quot;Get domain for the TCP socket&quot;,
<a name="13918"/>13918:            cmd  =&gt; fun(#{domain := Domain, tsock := Sock} = _State) -&gt;
<a name="13919"/>13919:                            case Get(Sock) of
<a name="13920"/>13920:                                {ok, Domain} -&gt;
<a name="13921"/>13921:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Domain]),
<a name="13922"/>13922:                                    ok;
<a name="13923"/>13923:                                {error, Reason} = ERROR -&gt;
<a name="13924"/>13924:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="13925"/>13925:                                                [Reason]),
<a name="13926"/>13926:                                    ERROR
<a name="13927"/>13927:                            end
<a name="13928"/>13928:                    end},
<a name="13929"/>13929: 
<a name="13930"/>13930:          %% *** Termination ***
<a name="13931"/>13931:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="13932"/>13932:            cmd  =&gt; fun(#{usock := Sock} = State0) -&gt;
<a name="13933"/>13933:                            socket:close(Sock),
<a name="13934"/>13934: 			   State1 = maps:remove(usock, State0),
<a name="13935"/>13935:                            {ok, State1}
<a name="13936"/>13936:                    end},
<a name="13937"/>13937:          #{desc =&gt; &quot;close TCP socket&quot;,
<a name="13938"/>13938:            cmd  =&gt; fun(#{tsock := Sock} = State0) -&gt;
<a name="13939"/>13939:                            socket:close(Sock),
<a name="13940"/>13940: 			   State1 = maps:remove(tsock, State0),
<a name="13941"/>13941:                            {ok, State1}
<a name="13942"/>13942:                    end},
<a name="13943"/>13943: 
<a name="13944"/>13944:          %% *** We are done ***
<a name="13945"/>13945:          ?SEV_FINISH_NORMAL
<a name="13946"/>13946:         ],
<a name="13947"/>13947: 
<a name="13948"/>13948:     Domain = inet_or_inet6(),
<a name="13949"/>13949: 
<a name="13950"/>13950:     i(&quot;start tester evaluator&quot;),
<a name="13951"/>13951:     InitState = #{domain =&gt; Domain},
<a name="13952"/>13952:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13953"/>13953: 
<a name="13954"/>13954:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_domain-last_expr"/><a name="13955"/>13955: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13956"/>13956: 
<a name="13957"/>13957: 
<a name="13958"/>13958: 
<a name="13959"/>13959: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13960"/>13960: 
<a name="13961"/>13961: <i>%% Tests the socket option dontroute.</i>
<a name="13962"/>13962: <i>%% The man page has the following to say:</i>
<a name="13963"/>13963: <i>%% &quot;Don't send via a gateway, send only to directly connected hosts.</i>
<a name="13964"/>13964: <i>%%  The same effect can be achieved by setting the MSG_DONTROUTE</i>
<a name="13965"/>13965: <i>%%  flag on a socket send(2) operation.&quot;</i>
<a name="13966"/>13966: <i>%% Since its &quot;kind of&quot; difficult to check if it actually takes an </i>
<a name="13967"/>13967: <i>%% effect (you would need a gateway for that and a machine &quot;on the</i>
<a name="13968"/>13968: <i>%% other side&quot;), we only test if we can set and get the value.</i>
<a name="13969"/>13969: <i>%% Better then nothing.</i>
<a name="13970"/>13970: 
<a name="api_opt_sock_dontroute-1"/><a name="13971"/>13971: <b>api_opt_sock_dontroute</b>(_Config) when is_list(_Config) -&gt;
<a name="13972"/>13972:     ?TT(?SECS(10)),
<a name="api_opt_sock_dontroute-last_expr"/><a name="13973"/>13973: <b>    tc_try</b>(api_opt_sock_dontroute,
<a name="13974"/>13974:            fun() -&gt; has_support_sock_dontroute() end,
<a name="13975"/>13975:            fun() -&gt; api_opt_sock_dontroute() end).
<a name="13976"/>13976: 
<a name="13977"/>13977: 
<a name="api_opt_sock_dontroute-0"/><a name="13978"/>13978: <b>api_opt_sock_dontroute</b>() -&gt;
<a name="13979"/>13979:     Opt    = dontroute,
<a name="13980"/>13980:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="13981"/>13981:                      socket:setopt(S, socket, Opt, Val)
<a name="13982"/>13982:              end,
<a name="13983"/>13983:     Get    = fun(S) -&gt;
<a name="13984"/>13984:                      socket:getopt(S, socket, Opt)
<a name="13985"/>13985:              end,
<a name="13986"/>13986: 
<a name="13987"/>13987:     TesterSeq =
<a name="13988"/>13988:         [
<a name="13989"/>13989:          #{desc =&gt; &quot;which local address&quot;,
<a name="13990"/>13990:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13991"/>13991:                            case which_local_host_info(Domain) of
<a name="13992"/>13992:                                {ok, #{name := Name,
<a name="13993"/>13993:                                       addr := Addr}} -&gt;
<a name="13994"/>13994:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="13995"/>13995:                                                &quot;~n   Name: ~p&quot;
<a name="13996"/>13996:                                                &quot;~n   Addr: ~p&quot;,
<a name="13997"/>13997:                                                [Name, Addr]),
<a name="13998"/>13998:                                    LSA = #{family =&gt; Domain,
<a name="13999"/>13999:                                            addr   =&gt; Addr},
<a name="14000"/>14000:                                    {ok, State#{lsa =&gt; LSA}};
<a name="14001"/>14001:                                {error, _} = ERROR -&gt;
<a name="14002"/>14002:                                    ERROR
<a name="14003"/>14003:                            end
<a name="14004"/>14004:                    end},
<a name="14005"/>14005: 
<a name="14006"/>14006:          #{desc =&gt; &quot;create UDP socket&quot;,
<a name="14007"/>14007:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14008"/>14008:                            case socket:open(Domain, dgram, udp) of
<a name="14009"/>14009:                                {ok, Sock} -&gt;
<a name="14010"/>14010:                                    {ok, State#{sock =&gt; Sock}};
<a name="14011"/>14011:                                {error, _} = ERROR -&gt;
<a name="14012"/>14012:                                    ERROR
<a name="14013"/>14013:                            end
<a name="14014"/>14014:                    end},
<a name="14015"/>14015:          #{desc =&gt; &quot;Get current value&quot;,
<a name="14016"/>14016:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14017"/>14017:                            case Get(Sock) of
<a name="14018"/>14018:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="14019"/>14019:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="14020"/>14020:                                    {ok, State#{dontroute =&gt; Val}};
<a name="14021"/>14021:                                {error, Reason} = ERROR -&gt;
<a name="14022"/>14022:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14023"/>14023:                                                [Reason]),
<a name="14024"/>14024:                                    ERROR
<a name="14025"/>14025:                            end
<a name="14026"/>14026:                    end},
<a name="14027"/>14027:          #{desc =&gt; &quot;Try change value&quot;,
<a name="14028"/>14028:            cmd  =&gt; fun(#{sock := Sock, dontroute := Current} = State) -&gt;
<a name="14029"/>14029: 			   New = not Current,
<a name="14030"/>14030:                            ?SEV_IPRINT(&quot;Change from ~p to ~p&quot;, [Current, New]),
<a name="14031"/>14031:                            case Set(Sock, New) of
<a name="14032"/>14032:                                ok -&gt;
<a name="14033"/>14033:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14034"/>14034:                                    {ok, State#{dontroute =&gt; New}};
<a name="14035"/>14035:                                {error, eopnotsupp = Reason} -&gt;
<a name="14036"/>14036:                                    ?SEV_EPRINT(&quot;Expected Failure: ~p&quot;,
<a name="14037"/>14037: 					       [Reason]),
<a name="14038"/>14038:                                    {skip, Reason};
<a name="14039"/>14039:                                {error, Reason} = ERROR -&gt;
<a name="14040"/>14040:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14041"/>14041: 					       [Reason]),
<a name="14042"/>14042:                                    ERROR
<a name="14043"/>14043:                            end
<a name="14044"/>14044:                    end},
<a name="14045"/>14045:          #{desc =&gt; &quot;Verify changed value&quot;,
<a name="14046"/>14046:            cmd  =&gt; fun(#{sock := Sock, dontroute := Val} = _State) -&gt;
<a name="14047"/>14047:                            case Get(Sock) of
<a name="14048"/>14048:                                {ok, Val} -&gt;
<a name="14049"/>14049:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14050"/>14050:                                    ok;
<a name="14051"/>14051:                                {error, Reason} = ERROR -&gt;
<a name="14052"/>14052:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14053"/>14053:                                                [Reason]),
<a name="14054"/>14054:                                    ERROR
<a name="14055"/>14055:                            end
<a name="14056"/>14056:                    end},
<a name="14057"/>14057: 
<a name="14058"/>14058:          %% *** Termination ***
<a name="14059"/>14059:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="14060"/>14060:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="14061"/>14061:                            socket:close(Sock),
<a name="14062"/>14062: 			   State1 = maps:remove(sock, State0),
<a name="14063"/>14063:                            {ok, State1}
<a name="14064"/>14064:                    end},
<a name="14065"/>14065: 
<a name="14066"/>14066:          %% *** We are done ***
<a name="14067"/>14067:          ?SEV_FINISH_NORMAL
<a name="14068"/>14068:         ],
<a name="14069"/>14069: 
<a name="14070"/>14070:     Domain = inet_or_inet6(),
<a name="14071"/>14071: 
<a name="14072"/>14072:     i(&quot;start tester evaluator&quot;),
<a name="14073"/>14073:     InitState = #{domain =&gt; Domain},
<a name="14074"/>14074:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14075"/>14075: 
<a name="14076"/>14076:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_dontroute-last_expr"/><a name="14077"/>14077: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14078"/>14078: 
<a name="14079"/>14079: 
<a name="14080"/>14080: 
<a name="14081"/>14081: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14082"/>14082: 
<a name="14083"/>14083: <i>%% Tests the socket option error. PLACEHOLDER!</i>
<a name="14084"/>14084: 
<a name="api_opt_sock_error-1"/><a name="14085"/>14085: <b>api_opt_sock_error</b>(_Config) when is_list(_Config) -&gt;
<a name="14086"/>14086:     ?TT(?SECS(10)),
<a name="api_opt_sock_error-last_expr"/><a name="14087"/>14087: <b>    tc_try</b>(api_opt_sock_error,
<a name="14088"/>14088:            fun() -&gt; not_yet_implemented() end,
<a name="14089"/>14089:            fun() -&gt; ok end).
<a name="14090"/>14090: 
<a name="14091"/>14091: 
<a name="14092"/>14092: 
<a name="14093"/>14093: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14094"/>14094: 
<a name="14095"/>14095: <i>%% Tests the socket option keepalive.</i>
<a name="14096"/>14096: <i>%% This is bit tricky to test, partly because we have no control over</i>
<a name="14097"/>14097: <i>%% the underlying TCP timeouts. So, for now, we just test that we can</i>
<a name="14098"/>14098: <i>%% change the value.</i>
<a name="14099"/>14099: 
<a name="api_opt_sock_keepalive-1"/><a name="14100"/>14100: <b>api_opt_sock_keepalive</b>(_Config) when is_list(_Config) -&gt;
<a name="14101"/>14101:     ?TT(?SECS(10)),
<a name="api_opt_sock_keepalive-last_expr"/><a name="14102"/>14102: <b>    tc_try</b>(api_opt_sock_keepalive,
<a name="14103"/>14103:            fun() -&gt; has_support_sock_keepalive() end,
<a name="14104"/>14104:            fun() -&gt; api_opt_sock_keepalive() end).
<a name="14105"/>14105: 
<a name="14106"/>14106: 
<a name="api_opt_sock_keepalive-0"/><a name="14107"/>14107: <b>api_opt_sock_keepalive</b>() -&gt;
<a name="14108"/>14108:     Opt    = keepalive,
<a name="14109"/>14109:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="14110"/>14110:                      socket:setopt(S, socket, Opt, Val)
<a name="14111"/>14111:              end,
<a name="14112"/>14112:     Get    = fun(S) -&gt;
<a name="14113"/>14113:                      socket:getopt(S, socket, Opt)
<a name="14114"/>14114:              end,
<a name="14115"/>14115: 
<a name="14116"/>14116:     TesterSeq =
<a name="14117"/>14117:         [
<a name="14118"/>14118:          #{desc =&gt; &quot;which local address&quot;,
<a name="14119"/>14119:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14120"/>14120:                            case which_local_host_info(Domain) of
<a name="14121"/>14121:                                {ok, #{name      := Name,
<a name="14122"/>14122:                                       addr      := Addr}} -&gt;
<a name="14123"/>14123:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="14124"/>14124:                                                &quot;~n   Name: ~p&quot;
<a name="14125"/>14125:                                                &quot;~n   Addr: ~p&quot;,
<a name="14126"/>14126:                                                [Name, Addr]),
<a name="14127"/>14127:                                    LSA = #{family =&gt; Domain,
<a name="14128"/>14128:                                            addr   =&gt; Addr},
<a name="14129"/>14129:                                    {ok, State#{lsa =&gt; LSA}};
<a name="14130"/>14130:                                {error, _} = ERROR -&gt;
<a name="14131"/>14131:                                    ERROR
<a name="14132"/>14132:                            end
<a name="14133"/>14133:                    end},
<a name="14134"/>14134: 
<a name="14135"/>14135:          #{desc =&gt; &quot;create TCP socket&quot;,
<a name="14136"/>14136:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14137"/>14137:                            case socket:open(Domain, stream, tcp) of
<a name="14138"/>14138:                                {ok, Sock} -&gt;
<a name="14139"/>14139:                                    {ok, State#{sock =&gt; Sock}};
<a name="14140"/>14140:                                {error, _} = ERROR -&gt;
<a name="14141"/>14141:                                    ERROR
<a name="14142"/>14142:                            end
<a name="14143"/>14143:                    end},
<a name="14144"/>14144:          #{desc =&gt; &quot;Get current value&quot;,
<a name="14145"/>14145:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14146"/>14146:                            case Get(Sock) of
<a name="14147"/>14147:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="14148"/>14148:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="14149"/>14149:                                    {ok, State#{keepalive =&gt; Val}};
<a name="14150"/>14150:                                {error, Reason} = ERROR -&gt;
<a name="14151"/>14151:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14152"/>14152:                                                [Reason]),
<a name="14153"/>14153:                                    ERROR
<a name="14154"/>14154:                            end
<a name="14155"/>14155:                    end},
<a name="14156"/>14156:          #{desc =&gt; &quot;Try change the value&quot;,
<a name="14157"/>14157:            cmd  =&gt; fun(#{sock := Sock, keepalive := Current} = State) -&gt;
<a name="14158"/>14158: 			   New = not Current,
<a name="14159"/>14159:                            ?SEV_IPRINT(&quot;Try change value from ~p to ~p&quot;, 
<a name="14160"/>14160:                                        [Current, New]),
<a name="14161"/>14161:                            case Set(Sock, New) of
<a name="14162"/>14162:                                ok -&gt;
<a name="14163"/>14163:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14164"/>14164:                                    {ok, State#{keepalive =&gt; New}};
<a name="14165"/>14165:                                {error, Reason} = ERROR -&gt;
<a name="14166"/>14166:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14167"/>14167: 					       [Reason]),
<a name="14168"/>14168:                                    ERROR
<a name="14169"/>14169:                            end
<a name="14170"/>14170:                    end},
<a name="14171"/>14171:          #{desc =&gt; &quot;Verify (new) current value&quot;,
<a name="14172"/>14172:            cmd  =&gt; fun(#{sock := Sock, keepalive := Val} = _State) -&gt;
<a name="14173"/>14173:                            case Get(Sock) of
<a name="14174"/>14174:                                {ok, Val} -&gt;
<a name="14175"/>14175:                                    ?SEV_IPRINT(&quot;Expected Success (~p)&quot;, [Val]),
<a name="14176"/>14176:                                    ok;
<a name="14177"/>14177:                                {ok, OtherVal} -&gt;
<a name="14178"/>14178:                                    ?SEV_IPRINT(&quot;Unexpected Success: ~p&quot;,
<a name="14179"/>14179:                                                [OtherVal]),
<a name="14180"/>14180:                                    {error, {unexpected_success_value,
<a name="14181"/>14181:                                             Val, OtherVal}};
<a name="14182"/>14182:                                {error, Reason} = ERROR -&gt;
<a name="14183"/>14183:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14184"/>14184:                                                [Reason]),
<a name="14185"/>14185:                                    ERROR
<a name="14186"/>14186:                            end
<a name="14187"/>14187:                    end},
<a name="14188"/>14188: 
<a name="14189"/>14189:          %% *** Termination ***
<a name="14190"/>14190:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="14191"/>14191:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="14192"/>14192:                            socket:close(Sock),
<a name="14193"/>14193: 			   State1 = maps:remove(sock, State0),
<a name="14194"/>14194:                            {ok, State1}
<a name="14195"/>14195:                    end},
<a name="14196"/>14196: 
<a name="14197"/>14197:          %% *** We are done ***
<a name="14198"/>14198:          ?SEV_FINISH_NORMAL
<a name="14199"/>14199:         ],
<a name="14200"/>14200: 
<a name="14201"/>14201:     Domain = inet_or_inet6(),
<a name="14202"/>14202: 
<a name="14203"/>14203:     i(&quot;start tester evaluator&quot;),
<a name="14204"/>14204:     InitState = #{domain =&gt; Domain},
<a name="14205"/>14205:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14206"/>14206: 
<a name="14207"/>14207:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_keepalive-last_expr"/><a name="14208"/>14208: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14209"/>14209: 
<a name="14210"/>14210: 
<a name="14211"/>14211: 
<a name="14212"/>14212: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14213"/>14213: 
<a name="14214"/>14214: <i>%% Tests the socket option reuseaddr.</i>
<a name="14215"/>14215: <i>%% This is the most basic of tests. We only test that we can set the</i>
<a name="14216"/>14216: <i>%% option and then read back.</i>
<a name="14217"/>14217: 
<a name="api_opt_sock_reuseaddr-1"/><a name="14218"/>14218: <b>api_opt_sock_reuseaddr</b>(_Config) when is_list(_Config) -&gt;
<a name="14219"/>14219:     ?TT(?SECS(10)),
<a name="api_opt_sock_reuseaddr-last_expr"/><a name="14220"/>14220: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14221"/>14221:            fun() -&gt;
<a name="14222"/>14222:                    %% [IPv4] Nothing to do with the option,
<a name="14223"/>14223:                    %% [IPv4] but we use it the test so make
<a name="14224"/>14224:                    %% [IPv4] use we have it.
<a name="14225"/>14225:                    has_support_ipv4(),
<a name="14226"/>14226:                    has_support_sock_reuseaddr()
<a name="14227"/>14227:            end,
<a name="14228"/>14228:            fun() -&gt; api_opt_sock_reuseaddr() end).
<a name="14229"/>14229: 
<a name="14230"/>14230: 
<a name="api_opt_sock_reuseaddr-0"/><a name="14231"/>14231: <b>api_opt_sock_reuseaddr</b>() -&gt;
<a name="api_opt_sock_reuseaddr-last_expr"/><a name="14232"/>14232: <b>    api_opt_simple_bool</b>(inet, socket, stream, reuseaddr,
<a name="14233"/>14233:                        #{bind =&gt; false}).
<a name="14234"/>14234: 
<a name="14235"/>14235: 
<a name="14236"/>14236: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14237"/>14237: 
<a name="14238"/>14238: <i>%% Tests the socket option exclusiveaddruse.</i>
<a name="14239"/>14239: <i>%% This is the most basic of tests. We only test that we can set the</i>
<a name="14240"/>14240: <i>%% option and then read back.</i>
<a name="14241"/>14241: 
<a name="api_opt_sock_exclusiveaddruse-1"/><a name="14242"/>14242: <b>api_opt_sock_exclusiveaddruse</b>(_Config) when is_list(_Config) -&gt;
<a name="14243"/>14243:     ?TT(?SECS(10)),
<a name="api_opt_sock_exclusiveaddruse-last_expr"/><a name="14244"/>14244: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14245"/>14245:            fun() -&gt;
<a name="14246"/>14246:                    %% [IPv4] Nothing to do with the option,
<a name="14247"/>14247:                    %% [IPv4] but we use it the test so make
<a name="14248"/>14248:                    %% [IPv4] use we have it.
<a name="14249"/>14249:                    has_support_ipv4(),
<a name="14250"/>14250:                    has_support_sock_exclusiveaddruse()
<a name="14251"/>14251:            end,
<a name="14252"/>14252:            fun() -&gt; api_opt_sock_exclusiveaddruse() end).
<a name="14253"/>14253: 
<a name="14254"/>14254: 
<a name="api_opt_sock_exclusiveaddruse-0"/><a name="14255"/>14255: <b>api_opt_sock_exclusiveaddruse</b>() -&gt;
<a name="api_opt_sock_exclusiveaddruse-last_expr"/><a name="14256"/>14256: <b>    api_opt_simple_bool</b>(inet, socket, stream, exclusiveaddruse,
<a name="14257"/>14257: 			#{bind =&gt; false}).
<a name="14258"/>14258: 
<a name="14259"/>14259: 
<a name="14260"/>14260: 
<a name="14261"/>14261: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14262"/>14262: 
<a name="14263"/>14263: <i>%% *Simple* test for a bool option.</i>
<a name="14264"/>14264: <i>%% This basically just tests that we can set and get the option.</i>
<a name="14265"/>14265: <i>%% This assumes that the option is supported.</i>
<a name="14266"/>14266: <i>%% What if its required that the socket is bound before set/get?</i>
<a name="14267"/>14267: <i>%% What if its required that set/get is done before bind?</i>
<a name="14268"/>14268: 
<a name="api_opt_simple_bool-5"/><a name="14269"/>14269: <b>api_opt_simple_bool</b>(Domain, Level, Type, Option, InitState) -&gt;
<a name="14270"/>14270: 
<a name="14271"/>14271:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="14272"/>14272:                      socket:setopt(S, Level, Option, Val)
<a name="14273"/>14273:              end,
<a name="14274"/>14274:     Get    = fun(S) -&gt;
<a name="14275"/>14275:                      socket:getopt(S, Level, Option)
<a name="14276"/>14276:              end,
<a name="14277"/>14277: 
<a name="14278"/>14278:     TesterSeq =
<a name="14279"/>14279:         [
<a name="14280"/>14280:          #{desc =&gt; &quot;(maybe) which local address&quot;,
<a name="14281"/>14281:            cmd  =&gt; fun(#{bind := true} = State) -&gt;
<a name="14282"/>14282:                            case ?SLIB:which_local_host_info(Domain) of
<a name="14283"/>14283:                                {ok, #{name      := Name,
<a name="14284"/>14284:                                       addr      := Addr}} -&gt;
<a name="14285"/>14285:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="14286"/>14286:                                                &quot;~n   Name: ~p&quot;
<a name="14287"/>14287:                                                &quot;~n   Addr: ~p&quot;,
<a name="14288"/>14288:                                                [Name, Addr]),
<a name="14289"/>14289:                                    LSA = #{family =&gt; Domain,
<a name="14290"/>14290:                                            addr   =&gt; Addr},
<a name="14291"/>14291:                                    {ok, State#{lsa =&gt; LSA}};
<a name="14292"/>14292:                                {error, _} = ERROR -&gt;
<a name="14293"/>14293:                                    ERROR
<a name="14294"/>14294:                            end;
<a name="14295"/>14295:                       (_State) -&gt;
<a name="14296"/>14296:                            ?SEV_IPRINT(&quot;ignore get local address&quot;),
<a name="14297"/>14297:                            ok
<a name="14298"/>14298:                    end},
<a name="14299"/>14299: 
<a name="14300"/>14300:          #{desc =&gt; &quot;create socket&quot;,
<a name="14301"/>14301:            cmd  =&gt; fun(State) -&gt;
<a name="14302"/>14302:                            case socket:open(Domain, Type) of
<a name="14303"/>14303:                                {ok, Sock} -&gt;
<a name="14304"/>14304:                                    {ok, State#{sock =&gt; Sock}};
<a name="14305"/>14305:                                {error, _} = ERROR -&gt;
<a name="14306"/>14306:                                    ERROR
<a name="14307"/>14307:                            end
<a name="14308"/>14308:                    end},
<a name="14309"/>14309: 
<a name="14310"/>14310:          #{desc =&gt; &quot;(maybe) bind&quot;,
<a name="14311"/>14311:            cmd  =&gt; fun(#{bind := true, lsa := LSA, sock := Sock} = _State) -&gt;
<a name="14312"/>14312:                            ?SEV_IPRINT(&quot;try binding&quot;),
<a name="14313"/>14313:                            socket:bind(Sock, LSA);
<a name="14314"/>14314:                       (_State) -&gt;
<a name="14315"/>14315:                            ?SEV_IPRINT(&quot;ignore binding&quot;),
<a name="14316"/>14316:                            ok
<a name="14317"/>14317:                    end},
<a name="14318"/>14318: 
<a name="14319"/>14319:          #{desc =&gt; &quot;Get current value&quot;,
<a name="14320"/>14320:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14321"/>14321:                            case Get(Sock) of
<a name="14322"/>14322:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="14323"/>14323:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="14324"/>14324:                                    {ok, State#{Option =&gt; Val}};
<a name="14325"/>14325:                                {error, Reason} = ERROR -&gt;
<a name="14326"/>14326:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14327"/>14327:                                                [Reason]),
<a name="14328"/>14328:                                    ERROR
<a name="14329"/>14329:                            end
<a name="14330"/>14330:                    end},
<a name="14331"/>14331:          #{desc =&gt; &quot;Try change the value&quot;,
<a name="14332"/>14332:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14333"/>14333:                            Current = maps:get(Option, State),
<a name="14334"/>14334: 			   New     = not Current,
<a name="14335"/>14335:                            ?SEV_IPRINT(&quot;Try change value from ~p to ~p&quot;, 
<a name="14336"/>14336:                                        [Current, New]),
<a name="14337"/>14337:                            case Set(Sock, New) of
<a name="14338"/>14338:                                ok -&gt;
<a name="14339"/>14339:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14340"/>14340:                                    {ok, State#{Option =&gt; New}};
<a name="14341"/>14341:                                {error, Reason} = ERROR -&gt;
<a name="14342"/>14342:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14343"/>14343: 					       [Reason]),
<a name="14344"/>14344:                                    ERROR
<a name="14345"/>14345:                            end
<a name="14346"/>14346:                    end},
<a name="14347"/>14347:          #{desc =&gt; &quot;Verify (new) current value&quot;,
<a name="14348"/>14348:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14349"/>14349:                            Val = maps:get(Option, State),
<a name="14350"/>14350:                            case Get(Sock) of
<a name="14351"/>14351:                                {ok, Val} -&gt;
<a name="14352"/>14352:                                    ?SEV_IPRINT(&quot;Expected Success (~p)&quot;, [Val]),
<a name="14353"/>14353:                                    ok;
<a name="14354"/>14354:                                {ok, OtherVal} -&gt;
<a name="14355"/>14355:                                    ?SEV_IPRINT(&quot;Unexpected Success: ~p&quot;,
<a name="14356"/>14356:                                                [OtherVal]),
<a name="14357"/>14357:                                    {error, {unexpected_success_value,
<a name="14358"/>14358:                                             Val, OtherVal}};
<a name="14359"/>14359:                                {error, Reason} = ERROR -&gt;
<a name="14360"/>14360:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14361"/>14361:                                                [Reason]),
<a name="14362"/>14362:                                    ERROR
<a name="14363"/>14363:                            end
<a name="14364"/>14364:                    end},
<a name="14365"/>14365: 
<a name="14366"/>14366:          %% *** Termination ***
<a name="14367"/>14367:          #{desc =&gt; &quot;close socket&quot;,
<a name="14368"/>14368:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="14369"/>14369:                            socket:close(Sock),
<a name="14370"/>14370: 			   State1 = maps:remove(sock, State0),
<a name="14371"/>14371:                            {ok, State1}
<a name="14372"/>14372:                    end},
<a name="14373"/>14373: 
<a name="14374"/>14374:          %% *** We are done ***
<a name="14375"/>14375:          ?SEV_FINISH_NORMAL
<a name="14376"/>14376:         ],
<a name="14377"/>14377: 
<a name="14378"/>14378:     i(&quot;start tester evaluator&quot;),
<a name="14379"/>14379:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14380"/>14380: 
<a name="14381"/>14381:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_simple_bool-last_expr"/><a name="14382"/>14382: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14383"/>14383: 
<a name="14384"/>14384: 
<a name="14385"/>14385: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14386"/>14386: 
<a name="14387"/>14387: <i>%% Tests the socket option bsp_state.</i>
<a name="14388"/>14388: <i>%% This is the most basic of tests. We test that we can,</i>
<a name="14389"/>14389: <i>%% create sockets, bind and connect and extract bsp-state</i>
<a name="14390"/>14390: <i>%% in the various state(s) of the socket.</i>
<a name="14391"/>14391: <i>%% For both dgram and stream sockets.</i>
<a name="14392"/>14392: 
<a name="api_opt_sock_bsp_state-1"/><a name="14393"/>14393: <b>api_opt_sock_bsp_state</b>(_Config) when is_list(_Config) -&gt;
<a name="14394"/>14394:     ?TT(?SECS(10)),
<a name="api_opt_sock_bsp_state-last_expr"/><a name="14395"/>14395: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14396"/>14396:            fun() -&gt;
<a name="14397"/>14397: 		   %% This is not a 'IPv4' option,
<a name="14398"/>14398: 		   %% but since we used it in the test...
<a name="14399"/>14399:                    has_support_ipv4(),
<a name="14400"/>14400:                    has_support_sock_bsp_state()
<a name="14401"/>14401:            end,
<a name="14402"/>14402:            fun() -&gt; api_opt_sock_bsp_state() end).
<a name="14403"/>14403: 
<a name="14404"/>14404: 
<a name="api_opt_sock_bsp_state-0"/><a name="14405"/>14405: <b>api_opt_sock_bsp_state</b>() -&gt;
<a name="14406"/>14406:     LSA        = which_local_socket_addr(inet),
<a name="14407"/>14407:     BspState   = fun(S) -&gt;
<a name="14408"/>14408: 			 case socket:getopt(S, socket, bsp_state) of
<a name="14409"/>14409: 			     {ok, BS} -&gt;
<a name="14410"/>14410: 				 BS;
<a name="14411"/>14411: 			     {error, Reason} -&gt;
<a name="14412"/>14412: 				 ?FAIL({getopt_bsp_state, Reason})
<a name="14413"/>14413: 			 end
<a name="14414"/>14414: 		 end,
<a name="14415"/>14415:     CreateSock = fun(T, P) -&gt;
<a name="14416"/>14416: 			 case socket:open(inet, T, P) of
<a name="14417"/>14417: 			     {ok, Sock}      -&gt;
<a name="14418"/>14418: 				 Sock;
<a name="14419"/>14419: 			     {error, Reason} -&gt;
<a name="14420"/>14420: 				 skip({socket_create_fail, Reason})
<a name="14421"/>14421: 			 end
<a name="14422"/>14422: 		 end,
<a name="14423"/>14423:     CloseSock = fun(S) -&gt;
<a name="14424"/>14424: 			socket:close(S)
<a name="14425"/>14425: 		end,
<a name="14426"/>14426:     BindSock   = fun(S, SA) -&gt;
<a name="14427"/>14427: 			 case socket:bind(S, SA) of
<a name="14428"/>14428: 			     ok -&gt;
<a name="14429"/>14429: 				 ok;
<a name="14430"/>14430: 			     {error, Reason} -&gt;
<a name="14431"/>14431: 				 ?FAIL({bind, Reason})
<a name="14432"/>14432: 			 end
<a name="14433"/>14433: 		 end,
<a name="14434"/>14434:     Sockname   = fun(S) -&gt;
<a name="14435"/>14435: 			 case socket:sockname(S) of
<a name="14436"/>14436: 			     {ok, SA} -&gt;
<a name="14437"/>14437: 				 SA;
<a name="14438"/>14438: 			     {error, Reason} -&gt;
<a name="14439"/>14439: 				 ?FAIL({sockname, Reason})
<a name="14440"/>14440: 			 end
<a name="14441"/>14441: 		 end,
<a name="14442"/>14442:     %% Setopt      = fun(S, L, O, V) -&gt;
<a name="14443"/>14443:     %% 			  socket:setopt(S, L, O, V)
<a name="14444"/>14444:     %% 		  end,
<a name="14445"/>14445:     %% SetOtpOpt = fun(S, O, V) -&gt; Setopt(S, otp, O, V) end,
<a name="14446"/>14446:     %% SetDebug  = fun(S, D) when is_boolean(D) -&gt; SetOptOpt(S, debug, D) end,
<a name="14447"/>14447:     %% EnableDebug = fun(S) -&gt; SetDebug(S, true) end,
<a name="14448"/>14448:     ConnectSock = fun(S, SA) -&gt;
<a name="14449"/>14449: 			  case socket:connect(S, SA) of
<a name="14450"/>14450: 			      ok -&gt;
<a name="14451"/>14451: 				  ok;
<a name="14452"/>14452: 			      {error, Reason} -&gt;
<a name="14453"/>14453: 				  ?FAIL({connect, Reason})
<a name="14454"/>14454: 			  end
<a name="14455"/>14455: 		  end,
<a name="14456"/>14456:     ListenSock = fun(S) -&gt;
<a name="14457"/>14457: 			 case socket:listen(S) of
<a name="14458"/>14458: 			     ok -&gt;
<a name="14459"/>14459: 				 ok;
<a name="14460"/>14460: 			     {error, Reason} -&gt;
<a name="14461"/>14461: 				 ?FAIL({listen, Reason})
<a name="14462"/>14462: 			 end
<a name="14463"/>14463: 		 end,
<a name="14464"/>14464:     AcceptSock = fun(S) -&gt;
<a name="14465"/>14465: 			 case socket:accept(S) of
<a name="14466"/>14466: 			     {ok, A} -&gt;
<a name="14467"/>14467: 				 A;
<a name="14468"/>14468: 			     {error, Reason} -&gt;
<a name="14469"/>14469: 				 ?FAIL({accept, Reason})
<a name="14470"/>14470: 			 end
<a name="14471"/>14471: 		 end,
<a name="14472"/>14472: 
<a name="14473"/>14473:     VerifyBspState = fun(S, Type, Proto,
<a name="14474"/>14474: 			 Bound, Connected) -&gt;
<a name="14475"/>14475: 			     verify_bsp_state(S, Type, Proto,
<a name="14476"/>14476: 					      Bound, Connected)
<a name="14477"/>14477: 		     end,
<a name="14478"/>14478: 
<a name="14479"/>14479:     ?P(&quot;Create UDP socket 1:&quot;),
<a name="14480"/>14480:     US1 = CreateSock(dgram, udp),
<a name="14481"/>14481:     ?P(&quot;UDP[1] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(US1)]),
<a name="14482"/>14482:     VerifyBspState(BspState(US1), dgram, udp, false, false),
<a name="14483"/>14483: 
<a name="14484"/>14484:     ?P(&quot;Create UDP socket 2:&quot;),
<a name="14485"/>14485:     US2 = CreateSock(dgram, udp),
<a name="14486"/>14486:     ?P(&quot;UDP[2] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(US2)]),
<a name="14487"/>14487:     VerifyBspState(BspState(US2), dgram, udp, false, false),
<a name="14488"/>14488: 
<a name="14489"/>14489:     ?P(&quot;Bind UDP socket 1&quot;),
<a name="14490"/>14490:     BindSock(US1, LSA),
<a name="14491"/>14491:     ?P(&quot;UDP[1] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(US1)]),
<a name="14492"/>14492:     VerifyBspState(BspState(US1), dgram, udp, true, false),
<a name="14493"/>14493: 
<a name="14494"/>14494:     ?P(&quot;Bind UDP socket 2&quot;),
<a name="14495"/>14495:     BindSock(US2, LSA),
<a name="14496"/>14496:     ?P(&quot;UDP[2] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(US2)]),
<a name="14497"/>14497:     VerifyBspState(BspState(US2), dgram, udp, true, false),
<a name="14498"/>14498: 
<a name="14499"/>14499:     %% We have not yet implemented 'connect' for UDP on Windows,
<a name="14500"/>14500:     %% so we leave this commented for now:
<a name="14501"/>14501: 
<a name="14502"/>14502:     %% ?P(&quot;socknames&quot;),
<a name="14503"/>14503:     %% USN1 = Sockname(US1),
<a name="14504"/>14504:     %% USN2 = Sockname(US2),
<a name="14505"/>14505: 
<a name="14506"/>14506:     %% ?P(&quot;enable debug for US1&quot;),
<a name="14507"/>14507:     %% EnableDebug(US1),
<a name="14508"/>14508: 
<a name="14509"/>14509:     %% ?P(&quot;Connect UDP socket 1 to&quot;
<a name="14510"/>14510:     %%    &quot;~n   ~p&quot;, [USN2]),
<a name="14511"/>14511:     %% ConnectSock(US1, USN2),
<a name="14512"/>14512:     %% ?P(&quot;UDP[1] [Bound | Connected]     =&gt; ~p&quot;, [BspState(US1)]),
<a name="14513"/>14513: 
<a name="14514"/>14514:     %% ?P(&quot;Connect UDP socket 2 to&quot;
<a name="14515"/>14515:     %%    &quot;~n   ~p&quot;, [USN1]),
<a name="14516"/>14516:     %% ConnectSock(US2, USN1),
<a name="14517"/>14517:     %% ?P(&quot;UDP[2] [Bound | Connected]     =&gt; ~p&quot;, [BspState(US2)]),
<a name="14518"/>14518: 
<a name="14519"/>14519: 
<a name="14520"/>14520:     ?P(&quot;Create TCP socket 1:&quot;),
<a name="14521"/>14521:     TS1 = CreateSock(stream, tcp),
<a name="14522"/>14522:     ?P(&quot;TCP[1] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(TS1)]),
<a name="14523"/>14523:     VerifyBspState(BspState(TS1), stream, tcp, false, false),
<a name="14524"/>14524: 
<a name="14525"/>14525:     ?P(&quot;Create TCP socket 2 (listen):&quot;),
<a name="14526"/>14526:     TS2 = CreateSock(stream, tcp),
<a name="14527"/>14527:     ?P(&quot;TCP[2] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(TS2)]),
<a name="14528"/>14528:     VerifyBspState(BspState(TS2), stream, tcp, false, false),
<a name="14529"/>14529: 
<a name="14530"/>14530:     ?P(&quot;Bind TCP socket 1&quot;),
<a name="14531"/>14531:     BindSock(TS1, LSA),
<a name="14532"/>14532:     ?P(&quot;TCP[1] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(TS1)]),
<a name="14533"/>14533:     VerifyBspState(BspState(TS1), stream, tcp, true, false),
<a name="14534"/>14534: 
<a name="14535"/>14535:     ?P(&quot;Bind TCP socket 2&quot;),
<a name="14536"/>14536:     BindSock(TS2, LSA),
<a name="14537"/>14537:     ?P(&quot;TCP[2] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(TS2)]),
<a name="14538"/>14538:     VerifyBspState(BspState(TS2), stream, tcp, true, false),
<a name="14539"/>14539: 
<a name="14540"/>14540:     ?P(&quot;Make TCP socket 2 listen&quot;),
<a name="14541"/>14541:     ListenSock(TS2),
<a name="14542"/>14542: 
<a name="14543"/>14543:     ?P(&quot;socknames&quot;),
<a name="14544"/>14544:     TSN2 = Sockname(TS2),
<a name="14545"/>14545: 
<a name="14546"/>14546:     ?P(&quot;Connect TCP socket 1 to&quot;
<a name="14547"/>14547:        &quot;~n   ~p&quot;, [TSN2]),
<a name="14548"/>14548:     ConnectSock(TS1, TSN2),
<a name="14549"/>14549:     ?P(&quot;TCP[1] [Bound | Connected]   =&gt; ~p&quot;, [BspState(TS1)]),
<a name="14550"/>14550:     VerifyBspState(BspState(TS1), stream, tcp, true, true),
<a name="14551"/>14551: 
<a name="14552"/>14552:     ?P(&quot;Accept TCP socket 3&quot;),
<a name="14553"/>14553:     TS3 = AcceptSock(TS2),
<a name="14554"/>14554:     ?P(&quot;TCP[3] [Bound | Connected]   =&gt; ~p&quot;, [BspState(TS3)]),
<a name="14555"/>14555:     VerifyBspState(BspState(TS3), stream, tcp, true, true),
<a name="14556"/>14556: 
<a name="14557"/>14557:     ?P(&quot;Close socket(s)&quot;),
<a name="14558"/>14558:     CloseSock(TS3),
<a name="14559"/>14559:     CloseSock(TS2),
<a name="14560"/>14560:     CloseSock(TS1),
<a name="14561"/>14561: 
<a name="14562"/>14562:     ?P(&quot;done&quot;),
<a name="api_opt_sock_bsp_state-last_expr"/><a name="14563"/>14563:     ok.
<a name="14564"/>14564: 
<a name="14565"/>14565: 
<a name="verify_bsp_state-5"/><a name="14566"/>14566: <b>verify_bsp_state</b>(#{type        := T,
<a name="14567"/>14567: 		   protocol    := P,
<a name="14568"/>14568: 		   local_addr  := LA,
<a name="14569"/>14569: 		   remote_addr := RA},
<a name="14570"/>14570: 		 Type, Proto,
<a name="14571"/>14571: 		 Bound, Connected) when (T =:= Type) andalso (P =:= Proto) -&gt;
<a name="14572"/>14572:     case {Bound, LA} of
<a name="14573"/>14573: 	{false, undefined} -&gt;
<a name="14574"/>14574: 	    ok;
<a name="14575"/>14575: 	{true, _} when (LA =/= undefined) -&gt;
<a name="14576"/>14576: 	    ok;
<a name="14577"/>14577: 	_ -&gt;
<a name="14578"/>14578: 	    ?FAIL({invalid_bound_la, Bound, LA})
<a name="14579"/>14579:     end,
<a name="14580"/>14580:     case {Connected, RA} of
<a name="14581"/>14581: 	{false, undefined} -&gt;
<a name="14582"/>14582: 	    ok;
<a name="14583"/>14583: 	{true, _} when (RA =/= undefined) -&gt;
<a name="14584"/>14584: 	    ok;
<a name="14585"/>14585: 	_ -&gt;
<a name="14586"/>14586: 	    ?FAIL({invalid_connected_ra, Connected, RA})
<a name="14587"/>14587:     end,
<a name="14588"/>14588:     ok;
<a name="14589"/>14589: <b>verify_bsp_state</b>(#{type     := T,
<a name="14590"/>14590: 		   protocol := P},
<a name="14591"/>14591: 		 Type, Proto,
<a name="14592"/>14592: 		 _Bound, _Connected) -&gt;
<a name="verify_bsp_state-last_expr"/><a name="14593"/>14593: <b>    ?FAIL</b>({invalid_type_or_proto, {T, Type}, {P, Proto}}).
<a name="14594"/>14594: 
<a name="14595"/>14595: 
<a name="14596"/>14596:     
<a name="14597"/>14597: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14598"/>14598: 
<a name="14599"/>14599: <i>%% Tests the socket option linger. PLACEHOLDER!</i>
<a name="14600"/>14600: 
<a name="api_opt_sock_linger-1"/><a name="14601"/>14601: <b>api_opt_sock_linger</b>(_Config) when is_list(_Config) -&gt;
<a name="14602"/>14602:     ?TT(?SECS(10)),
<a name="api_opt_sock_linger-last_expr"/><a name="14603"/>14603: <b>    tc_try</b>(api_opt_sock_linger,
<a name="14604"/>14604:            fun() -&gt; not_yet_implemented() end,
<a name="14605"/>14605:            fun() -&gt; ok end).
<a name="14606"/>14606: 
<a name="14607"/>14607: 
<a name="14608"/>14608: 
<a name="14609"/>14609: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14610"/>14610: 
<a name="14611"/>14611: <i>%% Tests the socket option mark. PLACEHOLDER!</i>
<a name="14612"/>14612: 
<a name="api_opt_sock_mark-1"/><a name="14613"/>14613: <b>api_opt_sock_mark</b>(_Config) when is_list(_Config) -&gt;
<a name="14614"/>14614:     ?TT(?SECS(10)),
<a name="api_opt_sock_mark-last_expr"/><a name="14615"/>14615: <b>    tc_try</b>(api_opt_sock_mark,
<a name="14616"/>14616:            fun() -&gt; not_yet_implemented() end,
<a name="14617"/>14617:            fun() -&gt; ok end).
<a name="14618"/>14618: 
<a name="14619"/>14619: 
<a name="14620"/>14620: 
<a name="14621"/>14621: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14622"/>14622: 
<a name="14623"/>14623: <i>%% Tests the socket option maxdg.</i>
<a name="14624"/>14624: 
<a name="api_opt_sock_maxdg-1"/><a name="14625"/>14625: <b>api_opt_sock_maxdg</b>(_Config) when is_list(_Config) -&gt;
<a name="14626"/>14626:     ?TT(?SECS(10)),
<a name="api_opt_sock_maxdg-last_expr"/><a name="14627"/>14627: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14628"/>14628: 	   fun() -&gt;
<a name="14629"/>14629: 		   %% This is not a 'IPv4' option,
<a name="14630"/>14630: 		   %% but since we used it in the test...
<a name="14631"/>14631:                    has_support_ipv4(),
<a name="14632"/>14632:                    has_support_sock_maxdg()
<a name="14633"/>14633:            end,
<a name="14634"/>14634:            fun() -&gt; do_api_opt_sock_maxdg() end).
<a name="14635"/>14635: 
<a name="do_api_opt_sock_maxdg-0"/><a name="14636"/>14636: <b>do_api_opt_sock_maxdg</b>() -&gt;
<a name="14637"/>14637:     ?P(&quot;create DGRAM socket&quot;),
<a name="14638"/>14638:     {ok, S} = socket:open(inet, dgram),
<a name="14639"/>14639:     ?P(&quot;get maxdg&quot;),
<a name="do_api_opt_sock_maxdg-last_expr"/><a name="14640"/>14640: <b>    case socket:getopt</b>(S, socket, maxdg) of
<a name="14641"/>14641: 	{ok, Sz} -&gt;
<a name="14642"/>14642: 	    ?P(&quot;success: Sz = ~p&quot;, [Sz]),
<a name="14643"/>14643: 	    ok;
<a name="14644"/>14644: 	{error, Reason} -&gt;
<a name="14645"/>14645: 	    ?FAIL({failed_get_maxdg, Reason})
<a name="14646"/>14646:     end.
<a name="14647"/>14647: 
<a name="14648"/>14648: 
<a name="14649"/>14649: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14650"/>14650: 
<a name="14651"/>14651: <i>%% Tests the socket option max_msg_size.</i>
<a name="14652"/>14652: 
<a name="api_opt_sock_max_msg_size-1"/><a name="14653"/>14653: <b>api_opt_sock_max_msg_size</b>(_Config) when is_list(_Config) -&gt;
<a name="14654"/>14654:     ?TT(?SECS(10)),
<a name="api_opt_sock_max_msg_size-last_expr"/><a name="14655"/>14655: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="14656"/>14656: 	   fun() -&gt;
<a name="14657"/>14657: 		   %% This is not a 'IPv4' option,
<a name="14658"/>14658: 		   %% but since we used it in the test...
<a name="14659"/>14659:                    has_support_ipv4(),
<a name="14660"/>14660:                    has_support_sock_max_msg_size()
<a name="14661"/>14661:            end,
<a name="14662"/>14662:            fun() -&gt; do_api_opt_sock_max_msg_size() end).
<a name="14663"/>14663: 
<a name="do_api_opt_sock_max_msg_size-0"/><a name="14664"/>14664: <b>do_api_opt_sock_max_msg_size</b>() -&gt;
<a name="14665"/>14665:     {ok, S} = socket:open(inet, dgram),
<a name="do_api_opt_sock_max_msg_size-last_expr"/><a name="14666"/>14666: <b>    case socket:getopt</b>(S, socket, max_msg_size) of
<a name="14667"/>14667: 	{ok, Sz} -&gt;
<a name="14668"/>14668: 	    ?P(&quot;success: Sz = ~p&quot;, [Sz]),
<a name="14669"/>14669: 	    ok;
<a name="14670"/>14670: 	{error, Reason} -&gt;
<a name="14671"/>14671: 	    ?FAIL({failed_get_max_msg_size, Reason})
<a name="14672"/>14672:     end.
<a name="14673"/>14673: 
<a name="14674"/>14674: 
<a name="14675"/>14675: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14676"/>14676: 
<a name="14677"/>14677: <i>%% This test case tries to test that the oobinline socket 'socket' option</i>
<a name="14678"/>14678: <i>%% works.</i>
<a name="14679"/>14679: <i>%% So, this is done on the receiving side: </i>
<a name="14680"/>14680: <i>%%</i>
<a name="14681"/>14681: <i>%%               socket:setopt(Sock, socket, oobinline, boolean()).</i>
<a name="14682"/>14682: <i>%%</i>
<a name="14683"/>14683: <i>%% This works on linux of some version (at least linux kernel 4.15.0),</i>
<a name="14684"/>14684: <i>%% but not on FreeBSD (12) for some reason. Until we have figured out</i>
<a name="14685"/>14685: <i>%% exctly why, we skip a bunch of OSs...</i>
<a name="14686"/>14686: <i>%%</i>
<a name="14687"/>14687: <i>%% Do we need to make sure the two entities does not run in the same</i>
<a name="14688"/>14688: <i>%% process? This test case does not currently do that (which works in'</i>
<a name="14689"/>14689: <i>%% linux but maybe not in, say, FreeBSD).</i>
<a name="14690"/>14690: <i>%%</i>
<a name="14691"/>14691: 
<a name="api_opt_sock_oobinline-1"/><a name="14692"/>14692: <b>api_opt_sock_oobinline</b>(_Config) when is_list(_Config) -&gt;
<a name="14693"/>14693:     ?TT(?SECS(5)),
<a name="api_opt_sock_oobinline-last_expr"/><a name="14694"/>14694: <b>    tc_try</b>(api_opt_sock_ooinline,
<a name="14695"/>14695:            fun() -&gt;
<a name="14696"/>14696:                    has_support_sock_oobinline(),
<a name="14697"/>14697:                    has_support_msg_flag(oob),
<a name="14698"/>14698:                    is_valid_oobinline_platform()
<a name="14699"/>14699:            end,
<a name="14700"/>14700:            fun() -&gt;
<a name="14701"/>14701:                    Set  = fun(Sock, Value) -&gt;
<a name="14702"/>14702:                                   socket:setopt(Sock, socket, oobinline, Value)
<a name="14703"/>14703:                           end,
<a name="14704"/>14704:                    Get  = fun(Sock) -&gt;
<a name="14705"/>14705:                                   socket:getopt(Sock, socket, oobinline)
<a name="14706"/>14706:                           end,
<a name="14707"/>14707:                    Send = fun(Sock, Data, true) -&gt;
<a name="14708"/>14708:                                   socket:send(Sock, Data, [oob]);
<a name="14709"/>14709:                              (Sock, Data, false) -&gt;
<a name="14710"/>14710:                                      socket:send(Sock, Data)
<a name="14711"/>14711:                           end,
<a name="14712"/>14712:                    Recv = fun(Sock, true) -&gt;
<a name="14713"/>14713:                                   socket:recv(Sock, 0, [oob]);
<a name="14714"/>14714:                              (Sock, false) -&gt;
<a name="14715"/>14715:                                   socket:recv(Sock)
<a name="14716"/>14716:                           end,
<a name="14717"/>14717:                    InitState = #{domain =&gt; inet_or_inet6(),
<a name="14718"/>14718:                                  proto  =&gt; tcp,
<a name="14719"/>14719:                                  send   =&gt; Send,
<a name="14720"/>14720:                                  recv   =&gt; Recv,
<a name="14721"/>14721:                                  set    =&gt; Set,
<a name="14722"/>14722:                                  get    =&gt; Get},
<a name="14723"/>14723:                    ok = do_api_opt_sock_oobinline(InitState)
<a name="14724"/>14724:            end).
<a name="14725"/>14725: 
<a name="14726"/>14726: <i>%% Hopefully this is a temporary solution...</i>
<a name="is_valid_oobinline_platform-0"/><a name="14727"/>14727: <b>is_valid_oobinline_platform</b>() -&gt;
<a name="is_valid_oobinline_platform-last_expr"/><a name="14728"/>14728: <b>    case os:type</b>() of
<a name="14729"/>14729:         {unix, linux} -&gt;
<a name="14730"/>14730:             ok;
<a name="14731"/>14731: 
<a name="14732"/>14732:         Type -&gt;
<a name="14733"/>14733:             %% Actually, all we know is that the
<a name="14734"/>14734:             %% test case only work for linux, but
<a name="14735"/>14735:             %% it *should* for FreeBSD and Solaris
<a name="14736"/>14736:             %% also...
<a name="14737"/>14737:             not_supported(Type)
<a name="14738"/>14738:     end.
<a name="14739"/>14739:     
<a name="14740"/>14740: 
<a name="14741"/>14741: 
<a name="14742"/>14742: 
<a name="14743"/>14743: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14744"/>14744: 
<a name="do_api_opt_sock_oobinline-1"/><a name="14745"/>14745: <b>do_api_opt_sock_oobinline</b>(InitState) -&gt;
<a name="14746"/>14746:     process_flag(trap_exit, true),
<a name="14747"/>14747:     ServerSeq =
<a name="14748"/>14748:         [
<a name="14749"/>14749:          %% *** Wait for start order ***
<a name="14750"/>14750:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="14751"/>14751:            cmd  =&gt; fun(State) -&gt;
<a name="14752"/>14752:                            Tester = ?SEV_AWAIT_START(),
<a name="14753"/>14753:                            {ok, State#{tester =&gt; Tester}}
<a name="14754"/>14754:                    end},
<a name="14755"/>14755:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="14756"/>14756:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14757"/>14757:                            _MRef = erlang:monitor(process, Tester),
<a name="14758"/>14758:                            ok
<a name="14759"/>14759:                    end},
<a name="14760"/>14760: 
<a name="14761"/>14761:          %% *** Init part ***
<a name="14762"/>14762:          #{desc =&gt; &quot;which local address&quot;,
<a name="14763"/>14763:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14764"/>14764:                            LSA = which_local_socket_addr(Domain),
<a name="14765"/>14765:                            {ok, State#{lsa =&gt; LSA}}
<a name="14766"/>14766:                    end},
<a name="14767"/>14767:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="14768"/>14768:            cmd  =&gt; fun(#{domain := Domain,
<a name="14769"/>14769:                          proto  := Proto} = State) -&gt;
<a name="14770"/>14770:                            case socket:open(Domain, stream, Proto) of
<a name="14771"/>14771:                                {ok, Sock} -&gt;
<a name="14772"/>14772:                                    {ok, State#{lsock =&gt; Sock}};
<a name="14773"/>14773:                                {error, _} = ERROR -&gt;
<a name="14774"/>14774:                                    ERROR
<a name="14775"/>14775:                            end
<a name="14776"/>14776:                    end},
<a name="14777"/>14777:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="14778"/>14778:            cmd  =&gt; fun(#{domain := local,
<a name="14779"/>14779:                          lsock  := LSock,
<a name="14780"/>14780:                          lsa    := LSA} = _State) -&gt;
<a name="14781"/>14781:                            case socket:bind(LSock, LSA) of
<a name="14782"/>14782:                                ok -&gt;
<a name="14783"/>14783:                                    ok; % We do not care about the port for local
<a name="14784"/>14784:                                {error, _} = ERROR -&gt;
<a name="14785"/>14785:                                    ERROR
<a name="14786"/>14786:                            end;
<a name="14787"/>14787:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="14788"/>14788:                            case sock_bind(LSock, LSA) of
<a name="14789"/>14789:                                ok -&gt;
<a name="14790"/>14790:                                    Port = sock_port(LSock),
<a name="14791"/>14791:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="14792"/>14792:                                    {ok, State#{lport =&gt; Port}};
<a name="14793"/>14793:                                {error, _} = ERROR -&gt;
<a name="14794"/>14794:                                    ERROR
<a name="14795"/>14795:                            end
<a name="14796"/>14796:                    end},
<a name="14797"/>14797:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="14798"/>14798:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="14799"/>14799:                            socket:listen(LSock)
<a name="14800"/>14800:                    end},
<a name="14801"/>14801:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="14802"/>14802:            cmd  =&gt; fun(#{domain := local,
<a name="14803"/>14803:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="14804"/>14804:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="14805"/>14805:                            ok;
<a name="14806"/>14806:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="14807"/>14807:                            %% This is actually not used for unix domain socket
<a name="14808"/>14808:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="14809"/>14809:                            ok
<a name="14810"/>14810:                    end},
<a name="14811"/>14811: 
<a name="14812"/>14812: 
<a name="14813"/>14813:          %% The actual test
<a name="14814"/>14814:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="14815"/>14815:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14816"/>14816:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="14817"/>14817:                    end},
<a name="14818"/>14818:          #{desc =&gt; &quot;await connection&quot;,
<a name="14819"/>14819:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="14820"/>14820:                            case socket:accept(LSock) of
<a name="14821"/>14821:                                {ok, Sock} -&gt;
<a name="14822"/>14822:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="14823"/>14823:                                    {ok, State#{csock =&gt; Sock}};
<a name="14824"/>14824:                                {error, _} = ERROR -&gt;
<a name="14825"/>14825:                                    ERROR
<a name="14826"/>14826:                            end
<a name="14827"/>14827:                    end},
<a name="14828"/>14828:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="14829"/>14829:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14830"/>14830:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="14831"/>14831:                            ok
<a name="14832"/>14832:                    end},
<a name="14833"/>14833: 
<a name="14834"/>14834:          %% *** no oobinline ***
<a name="14835"/>14835: 
<a name="14836"/>14836:          #{desc =&gt; &quot;await continue (verify no oobinline)&quot;,
<a name="14837"/>14837:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="14838"/>14838:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_oobinline)
<a name="14839"/>14839:                    end},
<a name="14840"/>14840:          #{desc =&gt; &quot;verify no oobinline&quot;,
<a name="14841"/>14841:            cmd  =&gt; fun(#{csock := Sock, get := Get} = _State) -&gt;
<a name="14842"/>14842:                            case Get(Sock) of
<a name="14843"/>14843:                                {ok, false = _Value} -&gt;
<a name="14844"/>14844:                                    ?SEV_IPRINT(&quot;oobinline: ~p&quot;, [_Value]),
<a name="14845"/>14845:                                    ok;
<a name="14846"/>14846:                                {ok, Unexpected} -&gt;
<a name="14847"/>14847:                                    ?SEV_EPRINT(&quot;Unexpected oobinline: ~p&quot;,
<a name="14848"/>14848:                                                [Unexpected]),
<a name="14849"/>14849:                                    {error, {unexpected_oobinline, Unexpected}};
<a name="14850"/>14850:                                {error, Reason} = ERROR -&gt;
<a name="14851"/>14851:                                    ?SEV_EPRINT(&quot;Failed getting oobinline:&quot;
<a name="14852"/>14852:                                                &quot;   ~p&quot;, [Reason]),
<a name="14853"/>14853:                                    ERROR
<a name="14854"/>14854:                            end                                   
<a name="14855"/>14855:                    end},
<a name="14856"/>14856:          #{desc =&gt; &quot;announce ready (no oobinline)&quot;,
<a name="14857"/>14857:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14858"/>14858:                            ?SEV_ANNOUNCE_READY(Tester, no_oobinline),
<a name="14859"/>14859:                            ok
<a name="14860"/>14860:                    end},
<a name="14861"/>14861: 
<a name="14862"/>14862:          #{desc =&gt; &quot;await continue (recv no oobinline)&quot;,
<a name="14863"/>14863:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14864"/>14864:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="14865"/>14865:                    end},
<a name="14866"/>14866:          #{desc =&gt; &quot;await plain data&quot;,
<a name="14867"/>14867:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="14868"/>14868:                            case Recv(Sock, false) of
<a name="14869"/>14869:                                {ok, &lt;&lt;&quot;a&quot;&gt;&gt;} -&gt;
<a name="14870"/>14870:                                    ?SEV_IPRINT(&quot;received plain data&quot;),
<a name="14871"/>14871:                                    ok;
<a name="14872"/>14872:                                {error, _} = ERROR -&gt;
<a name="14873"/>14873:                                    ERROR
<a name="14874"/>14874:                            end
<a name="14875"/>14875:                    end},
<a name="14876"/>14876:          #{desc =&gt; &quot;announce ready (plain data)&quot;,
<a name="14877"/>14877:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14878"/>14878:                            ?SEV_ANNOUNCE_READY(Tester, recv_plain),
<a name="14879"/>14879:                            ok
<a name="14880"/>14880:                    end},
<a name="14881"/>14881:          #{desc =&gt; &quot;await oob data&quot;,
<a name="14882"/>14882:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="14883"/>14883:                            case Recv(Sock, true) of
<a name="14884"/>14884:                                {ok, &lt;&lt;&quot;b&quot;&gt;&gt;} -&gt;
<a name="14885"/>14885:                                    ?SEV_IPRINT(&quot;received oob data&quot;),
<a name="14886"/>14886:                                    ok;
<a name="14887"/>14887:                                {error, _} = ERROR -&gt;
<a name="14888"/>14888:                                    ERROR
<a name="14889"/>14889:                            end
<a name="14890"/>14890:                    end},
<a name="14891"/>14891:          #{desc =&gt; &quot;announce ready (oob data)&quot;,
<a name="14892"/>14892:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14893"/>14893:                            ?SEV_ANNOUNCE_READY(Tester, recv_oob),
<a name="14894"/>14894:                            ok
<a name="14895"/>14895:                    end},
<a name="14896"/>14896: 
<a name="14897"/>14897:          %% *** oobinline ***
<a name="14898"/>14898: 
<a name="14899"/>14899:           #{desc =&gt; &quot;await continue (enable oobinline)&quot;,
<a name="14900"/>14900:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="14901"/>14901:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_oobinline)
<a name="14902"/>14902:                    end},
<a name="14903"/>14903:          #{desc =&gt; &quot;enable oobinline&quot;,
<a name="14904"/>14904:            cmd  =&gt; fun(#{csock := Sock, set := Set} = _State) -&gt;
<a name="14905"/>14905:                            case Set(Sock, true) of
<a name="14906"/>14906:                                ok -&gt;
<a name="14907"/>14907:                                    ?SEV_IPRINT(&quot;oobinline enabled&quot;),
<a name="14908"/>14908:                                    ok;
<a name="14909"/>14909:                                {error, Reason} = ERROR -&gt;
<a name="14910"/>14910:                                    ?SEV_EPRINT(&quot;Failed enable oobinline:&quot;
<a name="14911"/>14911:                                                &quot;   ~p&quot;, [Reason]),
<a name="14912"/>14912:                                    ERROR
<a name="14913"/>14913:                            end                                   
<a name="14914"/>14914:                    end},
<a name="14915"/>14915:          #{desc =&gt; &quot;announce ready (oobinline)&quot;,
<a name="14916"/>14916:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14917"/>14917:                            ?SEV_ANNOUNCE_READY(Tester, oobinline),
<a name="14918"/>14918:                            ok
<a name="14919"/>14919:                    end},
<a name="14920"/>14920: 
<a name="14921"/>14921:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="14922"/>14922:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="14923"/>14923:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="14924"/>14924:                    end},
<a name="14925"/>14925:        #{desc =&gt; &quot;await (recv) data&quot;,
<a name="14926"/>14926:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="14927"/>14927:                            case Recv(Sock, false) of
<a name="14928"/>14928:                                {ok, &lt;&lt;&quot;ba&quot;&gt;&gt;} -&gt;
<a name="14929"/>14929:                                    ?SEV_IPRINT(&quot;received expected message: &quot;
<a name="14930"/>14930:                                                &quot;both plain and oob data&quot;),
<a name="14931"/>14931:                                    ok;
<a name="14932"/>14932:                                {ok, BadMsg} -&gt;
<a name="14933"/>14933:                                    ?SEV_EPRINT(&quot;received unexpected message: ~p&quot;,
<a name="14934"/>14934:                                                [BadMsg]),
<a name="14935"/>14935:                                    {error, {unexpected_msg, BadMsg}};
<a name="14936"/>14936:                                {error, _} = ERROR -&gt;
<a name="14937"/>14937:                                    ERROR
<a name="14938"/>14938:                            end
<a name="14939"/>14939:                    end},
<a name="14940"/>14940:          #{desc =&gt; &quot;announce ready (recv)&quot;,
<a name="14941"/>14941:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="14942"/>14942:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="14943"/>14943:                            ok
<a name="14944"/>14944:                    end},
<a name="14945"/>14945: 
<a name="14946"/>14946:          %% *** Termination ***
<a name="14947"/>14947:          #{desc =&gt; &quot;await terminate&quot;,
<a name="14948"/>14948:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="14949"/>14949:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="14950"/>14950:                                ok -&gt;
<a name="14951"/>14951:                                    {ok, maps:remove(tester, State)};
<a name="14952"/>14952:                                {error, _} = ERROR -&gt;
<a name="14953"/>14953:                                    ERROR
<a name="14954"/>14954:                            end
<a name="14955"/>14955:                    end},
<a name="14956"/>14956:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="14957"/>14957:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="14958"/>14958:                            ok = socket:close(Sock),
<a name="14959"/>14959:                            {ok, maps:remove(csock, State)}
<a name="14960"/>14960:                    end},
<a name="14961"/>14961:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="14962"/>14962:            cmd  =&gt; fun(#{domain   := local,
<a name="14963"/>14963:                          lsock    := Sock,
<a name="14964"/>14964:                          local_sa := #{path := Path}} = State) -&gt;
<a name="14965"/>14965:                            ok = socket:close(Sock),
<a name="14966"/>14966:                            State1 =
<a name="14967"/>14967:                                unlink_path(Path,
<a name="14968"/>14968:                                            fun() -&gt;
<a name="14969"/>14969:                                                    maps:remove(local_sa, State)
<a name="14970"/>14970:                                            end,
<a name="14971"/>14971:                                            fun() -&gt; State end),
<a name="14972"/>14972:                            {ok, maps:remove(lsock, State1)};
<a name="14973"/>14973:                       (#{lsock := LSock} = State) -&gt;
<a name="14974"/>14974:                            case socket:close(LSock) of
<a name="14975"/>14975:                                ok -&gt;
<a name="14976"/>14976:                                    {ok, maps:remove(lsock, State)};
<a name="14977"/>14977:                                {error, _} = ERROR -&gt;
<a name="14978"/>14978:                                    ERROR
<a name="14979"/>14979:                            end
<a name="14980"/>14980:                    end},
<a name="14981"/>14981: 
<a name="14982"/>14982:          %% *** We are done ***
<a name="14983"/>14983:          ?SEV_FINISH_NORMAL
<a name="14984"/>14984:         ],
<a name="14985"/>14985: 
<a name="14986"/>14986: 
<a name="14987"/>14987:     ClientSeq =
<a name="14988"/>14988:         [
<a name="14989"/>14989:          %% *** Wait for start order ***
<a name="14990"/>14990:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="14991"/>14991:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="14992"/>14992:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="14993"/>14993:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="14994"/>14994:                       (State) -&gt;
<a name="14995"/>14995:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="14996"/>14996:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="14997"/>14997:                    end},
<a name="14998"/>14998:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="14999"/>14999:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15000"/>15000:                            _MRef = erlang:monitor(process, Tester),
<a name="15001"/>15001:                            ok
<a name="15002"/>15002:                    end},
<a name="15003"/>15003: 
<a name="15004"/>15004:          %% *** The init part ***
<a name="15005"/>15005:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="15006"/>15006:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="15007"/>15007:                          server_path := Path} = State) -&gt;
<a name="15008"/>15008:                            LSA = which_local_socket_addr(Domain),
<a name="15009"/>15009:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="15010"/>15010:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="15011"/>15011:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="15012"/>15012:                            LSA = which_local_socket_addr(Domain),
<a name="15013"/>15013:                            SSA = LSA#{port =&gt; Port},
<a name="15014"/>15014:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="15015"/>15015:                    end},
<a name="15016"/>15016:          #{desc =&gt; &quot;create socket&quot;,
<a name="15017"/>15017:            cmd  =&gt; fun(#{domain := Domain,
<a name="15018"/>15018:                          proto  := Proto} = State) -&gt;
<a name="15019"/>15019:                            case socket:open(Domain, stream, Proto) of
<a name="15020"/>15020:                                {ok, Sock} -&gt;
<a name="15021"/>15021:                                    {ok, State#{sock =&gt; Sock}};
<a name="15022"/>15022:                                {error, _} = ERROR -&gt;
<a name="15023"/>15023:                                    ERROR
<a name="15024"/>15024:                            end
<a name="15025"/>15025:                    end},
<a name="15026"/>15026:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="15027"/>15027:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="15028"/>15028:                            case sock_bind(Sock, LSA) of
<a name="15029"/>15029:                                ok -&gt;
<a name="15030"/>15030:                                    ok;
<a name="15031"/>15031:                                {error, _} = ERROR -&gt;
<a name="15032"/>15032:                                    ERROR
<a name="15033"/>15033:                            end
<a name="15034"/>15034:                    end},
<a name="15035"/>15035:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="15036"/>15036:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15037"/>15037:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="15038"/>15038:                            ok
<a name="15039"/>15039:                    end},
<a name="15040"/>15040: 
<a name="15041"/>15041:          %% *** The actual test ***
<a name="15042"/>15042:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="15043"/>15043:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15044"/>15044:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="15045"/>15045:                    end},
<a name="15046"/>15046:          #{desc =&gt; &quot;connect to server&quot;,
<a name="15047"/>15047:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="15048"/>15048:                            socket:connect(Sock, SSA)
<a name="15049"/>15049:                    end},
<a name="15050"/>15050:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="15051"/>15051:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15052"/>15052:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="15053"/>15053:                            ok
<a name="15054"/>15054:                    end},
<a name="15055"/>15055: 
<a name="15056"/>15056:          %% *** First batch of data (no oobinline) ***
<a name="15057"/>15057: 
<a name="15058"/>15058:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="15059"/>15059:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15060"/>15060:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="15061"/>15061:                    end},
<a name="15062"/>15062:          #{desc =&gt; &quot;send plain data&quot;,
<a name="15063"/>15063:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15064"/>15064:                            Send(Sock, &lt;&lt;&quot;a&quot;&gt;&gt;, false)
<a name="15065"/>15065:                    end},
<a name="15066"/>15066:          %% #{desc =&gt; &quot;enable (socket &amp; global) debug&quot;,
<a name="15067"/>15067:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="15068"/>15068:          %%                   ok = socket:setopt(Sock, otp, debug, true),
<a name="15069"/>15069:          %%                   ok = socket:debug(true)
<a name="15070"/>15070:          %%           end},
<a name="15071"/>15071:          #{desc =&gt; &quot;send oob data&quot;,
<a name="15072"/>15072:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15073"/>15073:                            Send(Sock, &lt;&lt;&quot;b&quot;&gt;&gt;, true)
<a name="15074"/>15074:                    end},
<a name="15075"/>15075:          %% #{desc =&gt; &quot;disable (socket) debug&quot;,
<a name="15076"/>15076:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="15077"/>15077:          %%                   ok = socket:debug(true),
<a name="15078"/>15078:          %%                   ok = socket:setopt(Sock, otp, debug, false)
<a name="15079"/>15079:          %%           end},
<a name="15080"/>15080:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="15081"/>15081:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15082"/>15082:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="15083"/>15083:                            ok
<a name="15084"/>15084:                    end},
<a name="15085"/>15085: 
<a name="15086"/>15086:          %% *** Second batch of data (oobinline) ***
<a name="15087"/>15087: 
<a name="15088"/>15088:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="15089"/>15089:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15090"/>15090:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="15091"/>15091:                    end},
<a name="15092"/>15092:          #{desc =&gt; &quot;send plain data&quot;,
<a name="15093"/>15093:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15094"/>15094:                            Send(Sock, &lt;&lt;&quot;a&quot;&gt;&gt;, false)
<a name="15095"/>15095:                    end},
<a name="15096"/>15096:          #{desc =&gt; &quot;send oob data&quot;,
<a name="15097"/>15097:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15098"/>15098:                            Send(Sock, &lt;&lt;&quot;b&quot;&gt;&gt;, true)
<a name="15099"/>15099:                    end},
<a name="15100"/>15100:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="15101"/>15101:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15102"/>15102:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="15103"/>15103:                            ok
<a name="15104"/>15104:                    end},
<a name="15105"/>15105: 
<a name="15106"/>15106:          %% *** Termination ***
<a name="15107"/>15107:          #{desc =&gt; &quot;await terminate&quot;,
<a name="15108"/>15108:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="15109"/>15109:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="15110"/>15110:                                ok -&gt;
<a name="15111"/>15111:                                    {ok, maps:remove(tester, State)};
<a name="15112"/>15112:                                {error, _} = ERROR -&gt;
<a name="15113"/>15113:                                    ERROR
<a name="15114"/>15114:                            end
<a name="15115"/>15115:                    end},
<a name="15116"/>15116:          #{desc =&gt; &quot;close socket&quot;,
<a name="15117"/>15117:            cmd  =&gt; fun(#{domain   := local,
<a name="15118"/>15118:                          sock     := Sock,
<a name="15119"/>15119:                          local_sa := #{path := Path}} = State) -&gt;
<a name="15120"/>15120:                            ok = socket:close(Sock),
<a name="15121"/>15121:                            State1 =
<a name="15122"/>15122:                                unlink_path(Path,
<a name="15123"/>15123:                                            fun() -&gt;
<a name="15124"/>15124:                                                    maps:remove(local_sa, State)
<a name="15125"/>15125:                                            end,
<a name="15126"/>15126:                                            fun() -&gt; State end),
<a name="15127"/>15127:                            {ok, maps:remove(sock, State1)};
<a name="15128"/>15128:                       (#{sock := Sock} = State) -&gt;
<a name="15129"/>15129:                            ok = socket:close(Sock),
<a name="15130"/>15130:                            {ok, maps:remove(sock, State)}
<a name="15131"/>15131:                    end},
<a name="15132"/>15132: 
<a name="15133"/>15133:          %% *** We are done ***
<a name="15134"/>15134:          ?SEV_FINISH_NORMAL
<a name="15135"/>15135:         ],
<a name="15136"/>15136: 
<a name="15137"/>15137: 
<a name="15138"/>15138:     TesterSeq =
<a name="15139"/>15139:         [
<a name="15140"/>15140:          %% *** Init part ***
<a name="15141"/>15141:          #{desc =&gt; &quot;monitor server&quot;,
<a name="15142"/>15142:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="15143"/>15143:                            _MRef = erlang:monitor(process, Pid),
<a name="15144"/>15144:                            ok
<a name="15145"/>15145:                    end},
<a name="15146"/>15146:          #{desc =&gt; &quot;monitor client&quot;,
<a name="15147"/>15147:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="15148"/>15148:                            _MRef = erlang:monitor(process, Pid),
<a name="15149"/>15149:                            ok
<a name="15150"/>15150:                    end},
<a name="15151"/>15151: 
<a name="15152"/>15152:          %% Start the server
<a name="15153"/>15153:          #{desc =&gt; &quot;order server start&quot;,
<a name="15154"/>15154:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="15155"/>15155:                            ?SEV_ANNOUNCE_START(Pid),
<a name="15156"/>15156:                            ok
<a name="15157"/>15157:                    end},
<a name="15158"/>15158:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="15159"/>15159:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="15160"/>15160:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="15161"/>15161:                            {ok, State#{server_port =&gt; Port}}
<a name="15162"/>15162:                    end},
<a name="15163"/>15163: 
<a name="15164"/>15164:          %% Start the client
<a name="15165"/>15165:          #{desc =&gt; &quot;order client start&quot;,
<a name="15166"/>15166:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="15167"/>15167:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="15168"/>15168:                            ok
<a name="15169"/>15169:                    end},
<a name="15170"/>15170:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="15171"/>15171:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="15172"/>15172:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="15173"/>15173:                    end},
<a name="15174"/>15174: 
<a name="15175"/>15175:          %% *** The actual test ***
<a name="15176"/>15176:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="15177"/>15177:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15178"/>15178:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="15179"/>15179:                            ok
<a name="15180"/>15180:                    end},
<a name="15181"/>15181:          ?SEV_SLEEP(?SECS(1)),
<a name="15182"/>15182:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="15183"/>15183:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15184"/>15184:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="15185"/>15185:                            ok
<a name="15186"/>15186:                    end},
<a name="15187"/>15187:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="15188"/>15188:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15189"/>15189:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="15190"/>15190:                    end},
<a name="15191"/>15191:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="15192"/>15192:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15193"/>15193:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="15194"/>15194:                    end},
<a name="15195"/>15195: 
<a name="15196"/>15196:          %% *** First batch of data (no oobinline) ***
<a name="15197"/>15197: 
<a name="15198"/>15198:          #{desc =&gt; &quot;order server to continue (with verify no oobinline)&quot;,
<a name="15199"/>15199:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15200"/>15200:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_oobinline),
<a name="15201"/>15201:                            ok
<a name="15202"/>15202:                    end},
<a name="15203"/>15203:          #{desc =&gt; &quot;await server ready (no oobinline)&quot;,
<a name="15204"/>15204:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15205"/>15205:                            ?SEV_AWAIT_READY(Server, server, no_oobinline)
<a name="15206"/>15206:                    end},
<a name="15207"/>15207: 
<a name="15208"/>15208:          #{desc =&gt; &quot;order client to continue (with send)&quot;,
<a name="15209"/>15209:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15210"/>15210:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="15211"/>15211:                            ok
<a name="15212"/>15212:                    end},
<a name="15213"/>15213:          #{desc =&gt; &quot;await client ready (with send)&quot;,
<a name="15214"/>15214:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15215"/>15215:                            ?SEV_AWAIT_READY(Client, client, send)
<a name="15216"/>15216:                    end},
<a name="15217"/>15217:          #{desc =&gt; &quot;order server to continue (with recv plain)&quot;,
<a name="15218"/>15218:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15219"/>15219:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv),
<a name="15220"/>15220:                            ok
<a name="15221"/>15221:                    end},
<a name="15222"/>15222:          #{desc =&gt; &quot;await server ready (recv plain)&quot;,
<a name="15223"/>15223:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15224"/>15224:                            ?SEV_AWAIT_READY(Server, server, recv_plain)
<a name="15225"/>15225:                    end},
<a name="15226"/>15226:          #{desc =&gt; &quot;await server ready (recv oob)&quot;,
<a name="15227"/>15227:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15228"/>15228:                            ?SEV_AWAIT_READY(Server, server, recv_oob)
<a name="15229"/>15229:                    end},
<a name="15230"/>15230: 
<a name="15231"/>15231:          %% Second message (w timestamp)
<a name="15232"/>15232: 
<a name="15233"/>15233:          #{desc =&gt; &quot;order server to continue (with enable oobinline)&quot;,
<a name="15234"/>15234:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15235"/>15235:                            ?SEV_ANNOUNCE_CONTINUE(Server, enable_oobinline),
<a name="15236"/>15236:                            ok
<a name="15237"/>15237:                    end},
<a name="15238"/>15238:          #{desc =&gt; &quot;await server ready (oobinline)&quot;,
<a name="15239"/>15239:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15240"/>15240:                            ?SEV_AWAIT_READY(Server, server, oobinline)
<a name="15241"/>15241:                    end},
<a name="15242"/>15242: 
<a name="15243"/>15243:          #{desc =&gt; &quot;order client to continue (with send)&quot;,
<a name="15244"/>15244:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15245"/>15245:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="15246"/>15246:                            ok
<a name="15247"/>15247:                    end},
<a name="15248"/>15248:          #{desc =&gt; &quot;await client ready (with send)&quot;,
<a name="15249"/>15249:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15250"/>15250:                            ?SEV_AWAIT_READY(Client, client, send)
<a name="15251"/>15251:                    end},
<a name="15252"/>15252:          #{desc =&gt; &quot;order server to continue (with recv)&quot;,
<a name="15253"/>15253:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15254"/>15254:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv),
<a name="15255"/>15255:                            ok
<a name="15256"/>15256:                    end},
<a name="15257"/>15257:          #{desc =&gt; &quot;await server ready (recv plain)&quot;,
<a name="15258"/>15258:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15259"/>15259:                            ?SEV_AWAIT_READY(Server, server, recv)
<a name="15260"/>15260:                    end},
<a name="15261"/>15261: 
<a name="15262"/>15262: 
<a name="15263"/>15263:          %% *** Termination ***
<a name="15264"/>15264:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="15265"/>15265:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15266"/>15266:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="15267"/>15267:                            ok
<a name="15268"/>15268:                    end},
<a name="15269"/>15269:          #{desc =&gt; &quot;await client termination&quot;,
<a name="15270"/>15270:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="15271"/>15271:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="15272"/>15272:                            State1 = maps:remove(client, State),
<a name="15273"/>15273:                            {ok, State1}
<a name="15274"/>15274:                    end},
<a name="15275"/>15275:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="15276"/>15276:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15277"/>15277:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="15278"/>15278:                            ok
<a name="15279"/>15279:                    end},
<a name="15280"/>15280:          #{desc =&gt; &quot;await server termination&quot;,
<a name="15281"/>15281:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="15282"/>15282:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="15283"/>15283:                            State1 = maps:remove(server, State),
<a name="15284"/>15284:                            {ok, State1}
<a name="15285"/>15285:                    end},
<a name="15286"/>15286: 
<a name="15287"/>15287:          %% *** We are done ***
<a name="15288"/>15288:          ?SEV_FINISH_NORMAL
<a name="15289"/>15289:         ],
<a name="15290"/>15290: 
<a name="15291"/>15291: 
<a name="15292"/>15292:     i(&quot;start server evaluator&quot;),
<a name="15293"/>15293:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="15294"/>15294: 
<a name="15295"/>15295:     i(&quot;start client evaluator&quot;),
<a name="15296"/>15296:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="15297"/>15297: 
<a name="15298"/>15298:     i(&quot;start tester evaluator&quot;),
<a name="15299"/>15299:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="15300"/>15300:                         client =&gt; Client#ev.pid},
<a name="15301"/>15301:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="15302"/>15302: 
<a name="do_api_opt_sock_oobinline-last_expr"/><a name="15303"/>15303: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="15304"/>15304: 
<a name="15305"/>15305: 
<a name="15306"/>15306: 
<a name="15307"/>15307: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15308"/>15308: 
<a name="15309"/>15309: <i>%% Tests that the credentials control message header is received when</i>
<a name="15310"/>15310: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="15311"/>15311: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="15312"/>15312: <i>%% So, this is done on the receiving side: </i>
<a name="15313"/>15313: <i>%%</i>
<a name="15314"/>15314: <i>%%               socket:setopt(Sock, socket, passcred, boolean()).</i>
<a name="15315"/>15315: <i>%%</i>
<a name="15316"/>15316: <i>%% We *may* need to run the different entities (server and client) in </i>
<a name="15317"/>15317: <i>%% separate VM (os processes) for this to actually work.</i>
<a name="15318"/>15318: <i>%% As it is now, the client does *not* get any credentials!</i>
<a name="15319"/>15319: <i>%% Until this has been done, this case is skipped!.</i>
<a name="15320"/>15320: 
<a name="api_opt_sock_passcred_tcp4-1"/><a name="15321"/>15321: <b>api_opt_sock_passcred_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="15322"/>15322:     ?TT(?SECS(5)),
<a name="api_opt_sock_passcred_tcp4-last_expr"/><a name="15323"/>15323: <b>    tc_try</b>(api_opt_sock_passcred_tcp4,
<a name="15324"/>15324:            fun() -&gt; has_support_sock_passcred(),
<a name="15325"/>15325:                     not_yet_implemented()
<a name="15326"/>15326:            end,
<a name="15327"/>15327:            fun() -&gt;
<a name="15328"/>15328:                    Set  = fun(Sock, Value) -&gt;
<a name="15329"/>15329:                                   socket:setopt(Sock, socket, passcred, Value)
<a name="15330"/>15330:                           end,
<a name="15331"/>15331:                    Get  = fun(Sock) -&gt;
<a name="15332"/>15332:                                   socket:getopt(Sock, socket, passcred)
<a name="15333"/>15333:                           end,
<a name="15334"/>15334:                    Send = fun(Sock, Data) -&gt;
<a name="15335"/>15335:                                   Msg = #{iov  =&gt; [Data]},
<a name="15336"/>15336:                                   socket:sendmsg(Sock, Msg)
<a name="15337"/>15337:                           end,
<a name="15338"/>15338:                    Recv = fun(Sock) -&gt;
<a name="15339"/>15339:                                   case socket:recvmsg(Sock) of
<a name="15340"/>15340:                                       {ok, #{ctrl := CMsgs,
<a name="15341"/>15341:                                              iov  := [Data]}} -&gt;
<a name="15342"/>15342:                                           {ok, {CMsgs, Data}};
<a name="15343"/>15343:                                       {error, _} = ERROR -&gt;
<a name="15344"/>15344:                                           ERROR
<a name="15345"/>15345:                                   end
<a name="15346"/>15346:                           end,
<a name="15347"/>15347:                    InitState = #{domain =&gt; inet,
<a name="15348"/>15348:                                  proto  =&gt; tcp,
<a name="15349"/>15349:                                  send   =&gt; Send,
<a name="15350"/>15350:                                  recv   =&gt; Recv,
<a name="15351"/>15351:                                  set    =&gt; Set,
<a name="15352"/>15352:                                  get    =&gt; Get},
<a name="15353"/>15353:                    ok = api_opt_sock_passcred_tcp(InitState)
<a name="15354"/>15354:            end).
<a name="15355"/>15355: 
<a name="15356"/>15356: 
<a name="15357"/>15357: 
<a name="15358"/>15358: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15359"/>15359: 
<a name="api_opt_sock_passcred_tcp-1"/><a name="15360"/>15360: <b>api_opt_sock_passcred_tcp</b>(InitState) -&gt;
<a name="15361"/>15361:     process_flag(trap_exit, true),
<a name="15362"/>15362:     ServerSeq =
<a name="15363"/>15363:         [
<a name="15364"/>15364:          %% *** Wait for start order ***
<a name="15365"/>15365:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="15366"/>15366:            cmd  =&gt; fun(State) -&gt;
<a name="15367"/>15367:                            Tester = ?SEV_AWAIT_START(),
<a name="15368"/>15368:                            {ok, State#{tester =&gt; Tester}}
<a name="15369"/>15369:                    end},
<a name="15370"/>15370:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="15371"/>15371:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15372"/>15372:                            _MRef = erlang:monitor(process, Tester),
<a name="15373"/>15373:                            ok
<a name="15374"/>15374:                    end},
<a name="15375"/>15375: 
<a name="15376"/>15376:          %% *** Init part ***
<a name="15377"/>15377:          #{desc =&gt; &quot;which local address&quot;,
<a name="15378"/>15378:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="15379"/>15379:                            LSA = which_local_socket_addr(Domain),
<a name="15380"/>15380:                            {ok, State#{lsa =&gt; LSA}}
<a name="15381"/>15381:                    end},
<a name="15382"/>15382:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="15383"/>15383:            cmd  =&gt; fun(#{domain := Domain,
<a name="15384"/>15384:                          proto  := Proto} = State) -&gt;
<a name="15385"/>15385:                            case socket:open(Domain, stream, Proto) of
<a name="15386"/>15386:                                {ok, Sock} -&gt;
<a name="15387"/>15387:                                    {ok, State#{lsock =&gt; Sock}};
<a name="15388"/>15388:                                {error, _} = ERROR -&gt;
<a name="15389"/>15389:                                    ERROR
<a name="15390"/>15390:                            end
<a name="15391"/>15391:                    end},
<a name="15392"/>15392:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="15393"/>15393:            cmd  =&gt; fun(#{domain := local,
<a name="15394"/>15394:                          lsock  := LSock,
<a name="15395"/>15395:                          lsa    := LSA} = _State) -&gt;
<a name="15396"/>15396:                            case socket:bind(LSock, LSA) of
<a name="15397"/>15397:                                ok -&gt;
<a name="15398"/>15398:                                    ok; % We do not care about the port for local
<a name="15399"/>15399:                                {error, _} = ERROR -&gt;
<a name="15400"/>15400:                                    ERROR
<a name="15401"/>15401:                            end;
<a name="15402"/>15402:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="15403"/>15403:                            case sock_bind(LSock, LSA) of
<a name="15404"/>15404:                                ok -&gt;
<a name="15405"/>15405:                                    Port = sock_port(LSock),
<a name="15406"/>15406:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="15407"/>15407:                                    {ok, State#{lport =&gt; Port}};
<a name="15408"/>15408:                                {error, _} = ERROR -&gt;
<a name="15409"/>15409:                                    ERROR
<a name="15410"/>15410:                            end
<a name="15411"/>15411:                    end},
<a name="15412"/>15412:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="15413"/>15413:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="15414"/>15414:                            socket:listen(LSock)
<a name="15415"/>15415:                    end},
<a name="15416"/>15416:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="15417"/>15417:            cmd  =&gt; fun(#{domain := local,
<a name="15418"/>15418:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="15419"/>15419:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="15420"/>15420:                            ok;
<a name="15421"/>15421:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="15422"/>15422:                            %% This is actually not used for unix domain socket
<a name="15423"/>15423:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="15424"/>15424:                            ok
<a name="15425"/>15425:                    end},
<a name="15426"/>15426: 
<a name="15427"/>15427: 
<a name="15428"/>15428:          %% The actual test
<a name="15429"/>15429:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="15430"/>15430:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15431"/>15431:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="15432"/>15432:                    end},
<a name="15433"/>15433:          #{desc =&gt; &quot;await connection&quot;,
<a name="15434"/>15434:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="15435"/>15435:                            case socket:accept(LSock) of
<a name="15436"/>15436:                                {ok, Sock} -&gt;
<a name="15437"/>15437:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="15438"/>15438:                                    {ok, State#{csock =&gt; Sock}};
<a name="15439"/>15439:                                {error, _} = ERROR -&gt;
<a name="15440"/>15440:                                    ERROR
<a name="15441"/>15441:                            end
<a name="15442"/>15442:                    end},
<a name="15443"/>15443:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="15444"/>15444:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15445"/>15445:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="15446"/>15446:                            ok
<a name="15447"/>15447:                    end},
<a name="15448"/>15448: 
<a name="15449"/>15449:          %% *** First message ***
<a name="15450"/>15450: 
<a name="15451"/>15451:          #{desc =&gt; &quot;await (recv) request 1&quot;,
<a name="15452"/>15452:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15453"/>15453:                            case Recv(Sock) of
<a name="15454"/>15454:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="15455"/>15455:                                    ok;
<a name="15456"/>15456:                                {error, _} = ERROR -&gt;
<a name="15457"/>15457:                                    ERROR
<a name="15458"/>15458:                            end
<a name="15459"/>15459:                    end},
<a name="15460"/>15460:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="15461"/>15461:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15462"/>15462:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="15463"/>15463:                            ok
<a name="15464"/>15464:                    end},
<a name="15465"/>15465:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="15466"/>15466:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15467"/>15467:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="15468"/>15468:                    end},
<a name="15469"/>15469:          #{desc =&gt; &quot;send reply&quot;,
<a name="15470"/>15470:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="15471"/>15471:                            Send(Sock, ?BASIC_REP)
<a name="15472"/>15472:                    end},
<a name="15473"/>15473:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="15474"/>15474:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15475"/>15475:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="15476"/>15476:                            ok
<a name="15477"/>15477:                    end},
<a name="15478"/>15478: 
<a name="15479"/>15479:          %% *** Second message ***
<a name="15480"/>15480: 
<a name="15481"/>15481:          #{desc =&gt; &quot;await (recv) request 2&quot;,
<a name="15482"/>15482:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15483"/>15483:                            case Recv(Sock) of
<a name="15484"/>15484:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="15485"/>15485:                                    ok;
<a name="15486"/>15486:                                {error, _} = ERROR -&gt;
<a name="15487"/>15487:                                    ERROR
<a name="15488"/>15488:                            end
<a name="15489"/>15489:                    end},
<a name="15490"/>15490:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="15491"/>15491:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15492"/>15492:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="15493"/>15493:                            ok
<a name="15494"/>15494:                    end},
<a name="15495"/>15495:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="15496"/>15496:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15497"/>15497:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="15498"/>15498:                    end},
<a name="15499"/>15499:          #{desc =&gt; &quot;send reply&quot;,
<a name="15500"/>15500:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="15501"/>15501:                            Send(Sock, ?BASIC_REP)
<a name="15502"/>15502:                    end},
<a name="15503"/>15503:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="15504"/>15504:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15505"/>15505:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="15506"/>15506:                            ok
<a name="15507"/>15507:                    end},
<a name="15508"/>15508: 
<a name="15509"/>15509:          %% *** Third message ***
<a name="15510"/>15510: 
<a name="15511"/>15511:          #{desc =&gt; &quot;await (recv) request 3&quot;,
<a name="15512"/>15512:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15513"/>15513:                            case Recv(Sock) of
<a name="15514"/>15514:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="15515"/>15515:                                    ok;
<a name="15516"/>15516:                                {error, _} = ERROR -&gt;
<a name="15517"/>15517:                                    ERROR
<a name="15518"/>15518:                            end
<a name="15519"/>15519:                    end},
<a name="15520"/>15520:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="15521"/>15521:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15522"/>15522:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="15523"/>15523:                            ok
<a name="15524"/>15524:                    end},
<a name="15525"/>15525:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="15526"/>15526:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15527"/>15527:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="15528"/>15528:                    end},
<a name="15529"/>15529:          #{desc =&gt; &quot;send reply&quot;,
<a name="15530"/>15530:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="15531"/>15531:                            Send(Sock, ?BASIC_REP)
<a name="15532"/>15532:                    end},
<a name="15533"/>15533:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="15534"/>15534:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15535"/>15535:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="15536"/>15536:                            ok
<a name="15537"/>15537:                    end},
<a name="15538"/>15538: 
<a name="15539"/>15539:          %% *** Termination ***
<a name="15540"/>15540:          #{desc =&gt; &quot;await terminate&quot;,
<a name="15541"/>15541:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="15542"/>15542:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="15543"/>15543:                                ok -&gt;
<a name="15544"/>15544:                                    {ok, maps:remove(tester, State)};
<a name="15545"/>15545:                                {error, _} = ERROR -&gt;
<a name="15546"/>15546:                                    ERROR
<a name="15547"/>15547:                            end
<a name="15548"/>15548:                    end},
<a name="15549"/>15549:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="15550"/>15550:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="15551"/>15551:                            ok = socket:close(Sock),
<a name="15552"/>15552:                            {ok, maps:remove(csock, State)}
<a name="15553"/>15553:                    end},
<a name="15554"/>15554:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="15555"/>15555:            cmd  =&gt; fun(#{domain   := local,
<a name="15556"/>15556:                          lsock    := Sock,
<a name="15557"/>15557:                          local_sa := #{path := Path}} = State) -&gt;
<a name="15558"/>15558:                            ok = socket:close(Sock),
<a name="15559"/>15559:                            State1 =
<a name="15560"/>15560:                                unlink_path(Path,
<a name="15561"/>15561:                                            fun() -&gt;
<a name="15562"/>15562:                                                    maps:remove(local_sa, State)
<a name="15563"/>15563:                                            end,
<a name="15564"/>15564:                                            fun() -&gt; State end),
<a name="15565"/>15565:                            {ok, maps:remove(lsock, State1)};
<a name="15566"/>15566:                       (#{lsock := LSock} = State) -&gt;
<a name="15567"/>15567:                            case socket:close(LSock) of
<a name="15568"/>15568:                                ok -&gt;
<a name="15569"/>15569:                                    {ok, maps:remove(lsock, State)};
<a name="15570"/>15570:                                {error, _} = ERROR -&gt;
<a name="15571"/>15571:                                    ERROR
<a name="15572"/>15572:                            end
<a name="15573"/>15573:                    end},
<a name="15574"/>15574: 
<a name="15575"/>15575:          %% *** We are done ***
<a name="15576"/>15576:          ?SEV_FINISH_NORMAL
<a name="15577"/>15577:         ],
<a name="15578"/>15578: 
<a name="15579"/>15579: 
<a name="15580"/>15580:     ClientSeq =
<a name="15581"/>15581:         [
<a name="15582"/>15582:          %% *** Wait for start order ***
<a name="15583"/>15583:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="15584"/>15584:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="15585"/>15585:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="15586"/>15586:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="15587"/>15587:                       (State) -&gt;
<a name="15588"/>15588:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="15589"/>15589:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="15590"/>15590:                    end},
<a name="15591"/>15591:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="15592"/>15592:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15593"/>15593:                            _MRef = erlang:monitor(process, Tester),
<a name="15594"/>15594:                            ok
<a name="15595"/>15595:                    end},
<a name="15596"/>15596: 
<a name="15597"/>15597:          %% *** The init part ***
<a name="15598"/>15598:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="15599"/>15599:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="15600"/>15600:                          server_path := Path} = State) -&gt;
<a name="15601"/>15601:                            LSA = which_local_socket_addr(Domain),
<a name="15602"/>15602:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="15603"/>15603:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="15604"/>15604:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="15605"/>15605:                            LSA = which_local_socket_addr(Domain),
<a name="15606"/>15606:                            SSA = LSA#{port =&gt; Port},
<a name="15607"/>15607:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="15608"/>15608:                    end},
<a name="15609"/>15609:          #{desc =&gt; &quot;create socket&quot;,
<a name="15610"/>15610:            cmd  =&gt; fun(#{domain := Domain,
<a name="15611"/>15611:                          proto  := Proto} = State) -&gt;
<a name="15612"/>15612:                            case socket:open(Domain, stream, Proto) of
<a name="15613"/>15613:                                {ok, Sock} -&gt;
<a name="15614"/>15614:                                    {ok, State#{sock =&gt; Sock}};
<a name="15615"/>15615:                                {error, _} = ERROR -&gt;
<a name="15616"/>15616:                                    ERROR
<a name="15617"/>15617:                            end
<a name="15618"/>15618:                    end},
<a name="15619"/>15619:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="15620"/>15620:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="15621"/>15621:                            case sock_bind(Sock, LSA) of
<a name="15622"/>15622:                                ok -&gt;
<a name="15623"/>15623:                                    ok;
<a name="15624"/>15624:                                {error, _} = ERROR -&gt;
<a name="15625"/>15625:                                    ERROR
<a name="15626"/>15626:                            end
<a name="15627"/>15627:                    end},
<a name="15628"/>15628:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="15629"/>15629:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15630"/>15630:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="15631"/>15631:                            ok
<a name="15632"/>15632:                    end},
<a name="15633"/>15633: 
<a name="15634"/>15634:          %% *** The actual test ***
<a name="15635"/>15635:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="15636"/>15636:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15637"/>15637:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="15638"/>15638:                    end},
<a name="15639"/>15639:          #{desc =&gt; &quot;connect to server&quot;,
<a name="15640"/>15640:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="15641"/>15641:                            socket:connect(Sock, SSA)
<a name="15642"/>15642:                    end},
<a name="15643"/>15643:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="15644"/>15644:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15645"/>15645:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="15646"/>15646:                            ok
<a name="15647"/>15647:                    end},
<a name="15648"/>15648: 
<a name="15649"/>15649:          %% *** First message (default=wo passcred) ***
<a name="15650"/>15650: 
<a name="15651"/>15651:          #{desc =&gt; &quot;await continue (verify timestamp off)&quot;,
<a name="15652"/>15652:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15653"/>15653:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_passcred)
<a name="15654"/>15654:                    end},
<a name="15655"/>15655:          #{desc =&gt; &quot;verify passcred off&quot;,
<a name="15656"/>15656:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="15657"/>15657:                            case Get(Sock) of
<a name="15658"/>15658:                                {ok, false = _Value} -&gt;
<a name="15659"/>15659:                                    ?SEV_IPRINT(&quot;passcred: ~p&quot;, [_Value]),
<a name="15660"/>15660:                                    ok;
<a name="15661"/>15661:                                {ok, Unexpected} -&gt;
<a name="15662"/>15662:                                    ?SEV_EPRINT(&quot;Unexpected passcred: ~p&quot;,
<a name="15663"/>15663:                                                [Unexpected]),
<a name="15664"/>15664:                                    {error, {unexpected_passcred, Unexpected}};
<a name="15665"/>15665:                                {error, Reason} = ERROR -&gt;
<a name="15666"/>15666:                                    ?SEV_EPRINT(&quot;Failed getting passcred:&quot;
<a name="15667"/>15667:                                                &quot;   ~p&quot;, [Reason]),
<a name="15668"/>15668:                                    ERROR
<a name="15669"/>15669:                            end                                   
<a name="15670"/>15670:                    end},
<a name="15671"/>15671:          #{desc =&gt; &quot;announce ready (passcred off)&quot;,
<a name="15672"/>15672:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15673"/>15673:                            ?SEV_ANNOUNCE_READY(Tester, passcred_off),
<a name="15674"/>15674:                            ok
<a name="15675"/>15675:                    end},
<a name="15676"/>15676: 
<a name="15677"/>15677:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="15678"/>15678:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15679"/>15679:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="15680"/>15680:                    end},
<a name="15681"/>15681:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="15682"/>15682:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15683"/>15683:                            Send(Sock, ?BASIC_REQ)
<a name="15684"/>15684:                    end},
<a name="15685"/>15685:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="15686"/>15686:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15687"/>15687:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="15688"/>15688:                            ok
<a name="15689"/>15689:                    end},
<a name="15690"/>15690:          #{desc =&gt; &quot;await recv reply 1 (from server, wo passcred)&quot;,
<a name="15691"/>15691:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="15692"/>15692:                            case Recv(Sock) of
<a name="15693"/>15693:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="15694"/>15694:                                    ok;
<a name="15695"/>15695:                                {ok, {[], UnexpData}} -&gt;
<a name="15696"/>15696:                                    {error, {unexpected_reply_data, UnexpData}};
<a name="15697"/>15697:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="15698"/>15698:                                    {error, {unexpected_reply_cmsgs,
<a name="15699"/>15699:                                             BadCMsgs}};
<a name="15700"/>15700:                                {ok, BadReply} -&gt;
<a name="15701"/>15701:                                    {error, {unexpected_reply, BadReply}};
<a name="15702"/>15702:                                {error, _} = ERROR -&gt;
<a name="15703"/>15703:                                    ERROR
<a name="15704"/>15704:                            end
<a name="15705"/>15705:                    end},
<a name="15706"/>15706:          #{desc =&gt; &quot;announce ready 1 (recv reply)&quot;,
<a name="15707"/>15707:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15708"/>15708:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="15709"/>15709:                            ok
<a name="15710"/>15710:                    end},
<a name="15711"/>15711: 
<a name="15712"/>15712:          %% *** Second message (w passcred) ***
<a name="15713"/>15713: 
<a name="15714"/>15714:          #{desc =&gt; &quot;await continue (enable passcred)&quot;,
<a name="15715"/>15715:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15716"/>15716:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_passcred)
<a name="15717"/>15717:                    end},
<a name="15718"/>15718:          #{desc =&gt; &quot;enable passcred&quot;,
<a name="15719"/>15719:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="15720"/>15720:                            case Set(Sock, true) of
<a name="15721"/>15721:                                ok -&gt;
<a name="15722"/>15722:                                    ?SEV_IPRINT(&quot;passcred enabled&quot;),
<a name="15723"/>15723:                                    ok;
<a name="15724"/>15724:                                {error, Reason} = ERROR -&gt;
<a name="15725"/>15725:                                    ?SEV_EPRINT(&quot;Failed enable passcred:&quot;
<a name="15726"/>15726:                                                &quot;   ~p&quot;, [Reason]),
<a name="15727"/>15727:                                    ERROR
<a name="15728"/>15728:                            end                                   
<a name="15729"/>15729:                    end},
<a name="15730"/>15730:          #{desc =&gt; &quot;announce ready (passcred on)&quot;,
<a name="15731"/>15731:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15732"/>15732:                            ?SEV_ANNOUNCE_READY(Tester, passcred_on),
<a name="15733"/>15733:                            ok
<a name="15734"/>15734:                    end},
<a name="15735"/>15735: 
<a name="15736"/>15736:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="15737"/>15737:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15738"/>15738:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="15739"/>15739:                    end},
<a name="15740"/>15740:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="15741"/>15741:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15742"/>15742:                            Send(Sock, ?BASIC_REQ)
<a name="15743"/>15743:                    end},
<a name="15744"/>15744:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="15745"/>15745:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15746"/>15746:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="15747"/>15747:                            ok
<a name="15748"/>15748:                    end},
<a name="15749"/>15749:          #{desc =&gt; &quot;await recv reply 2 (from server, w passcred)&quot;,
<a name="15750"/>15750:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="15751"/>15751:                            %% socket:setopt(Sock, otp, debug, true),
<a name="15752"/>15752:                            case Recv(Sock) of
<a name="15753"/>15753:                                {ok, {[#{level := socket,
<a name="15754"/>15754:                                         type  := passcred,
<a name="15755"/>15755:                                         value := Cred}], ?BASIC_REP}} -&gt;
<a name="15756"/>15756:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15757"/>15757:                                    ?SEV_IPRINT(&quot;received reply *with* &quot;
<a name="15758"/>15758:                                                &quot;expected passcred: &quot;
<a name="15759"/>15759:                                                &quot;~n   ~p&quot;, [Cred]),
<a name="15760"/>15760:                                    ok;
<a name="15761"/>15761:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="15762"/>15762:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15763"/>15763:                                    {error, {unexpected_reply_cmsgs,
<a name="15764"/>15764:                                             BadCMsgs}};
<a name="15765"/>15765:                                {ok, {[#{level := socket,
<a name="15766"/>15766:                                         type  := passcred,
<a name="15767"/>15767:                                         value := _Cred}], BadData}} -&gt;
<a name="15768"/>15768:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15769"/>15769:                                    {error, {unexpected_reply_data,
<a name="15770"/>15770:                                             BadData}};
<a name="15771"/>15771:                                {ok, BadReply} -&gt;
<a name="15772"/>15772:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15773"/>15773:                                    {error, {unexpected_reply, BadReply}};
<a name="15774"/>15774:                                {error, _} = ERROR -&gt;
<a name="15775"/>15775:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="15776"/>15776:                                    ERROR
<a name="15777"/>15777:                            end
<a name="15778"/>15778:                    end},
<a name="15779"/>15779:          #{desc =&gt; &quot;announce ready 2 (recv reply)&quot;,
<a name="15780"/>15780:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15781"/>15781:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="15782"/>15782:                            ok
<a name="15783"/>15783:                    end},
<a name="15784"/>15784: 
<a name="15785"/>15785:          %% *** Third message (wo passcred) ***
<a name="15786"/>15786: 
<a name="15787"/>15787:          #{desc =&gt; &quot;await continue (disable passcred)&quot;,
<a name="15788"/>15788:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15789"/>15789:                            ?SEV_AWAIT_CONTINUE(Tester, tester, disable_passcred)
<a name="15790"/>15790:                    end},
<a name="15791"/>15791:          #{desc =&gt; &quot;disable passcred&quot;,
<a name="15792"/>15792:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="15793"/>15793:                            case Set(Sock, false) of
<a name="15794"/>15794:                                ok -&gt;
<a name="15795"/>15795:                                    ?SEV_IPRINT(&quot;passcred disabled&quot;),
<a name="15796"/>15796:                                    ok;
<a name="15797"/>15797:                                {error, Reason} = ERROR -&gt;
<a name="15798"/>15798:                                    ?SEV_EPRINT(&quot;Failed disable timestamp:&quot;
<a name="15799"/>15799:                                                &quot;   ~p&quot;, [Reason]),
<a name="15800"/>15800:                                    ERROR
<a name="15801"/>15801:                            end                                   
<a name="15802"/>15802:                    end},
<a name="15803"/>15803:          #{desc =&gt; &quot;announce ready (passcred off)&quot;,
<a name="15804"/>15804:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15805"/>15805:                            ?SEV_ANNOUNCE_READY(Tester, passcred_off),
<a name="15806"/>15806:                            ok
<a name="15807"/>15807:                    end},
<a name="15808"/>15808: 
<a name="15809"/>15809:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="15810"/>15810:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15811"/>15811:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="15812"/>15812:                    end},
<a name="15813"/>15813:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="15814"/>15814:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="15815"/>15815:                            Send(Sock, ?BASIC_REQ)
<a name="15816"/>15816:                    end},
<a name="15817"/>15817:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="15818"/>15818:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15819"/>15819:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="15820"/>15820:                            ok
<a name="15821"/>15821:                    end},
<a name="15822"/>15822:          #{desc =&gt; &quot;await recv reply 3 (from server, wo passcred)&quot;,
<a name="15823"/>15823:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="15824"/>15824:                            case Recv(Sock) of
<a name="15825"/>15825:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="15826"/>15826:                                    ?SEV_IPRINT(&quot;received reply *without* &quot;
<a name="15827"/>15827:                                                &quot;passcred&quot;),
<a name="15828"/>15828:                                    ok;
<a name="15829"/>15829:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="15830"/>15830:                                    {error, {unexpected_reply_cmsgs,
<a name="15831"/>15831:                                             BadCMsgs}};
<a name="15832"/>15832:                                {ok, {[], BadData}} -&gt;
<a name="15833"/>15833:                                    {error, {unexpected_reply_data,
<a name="15834"/>15834:                                             BadData}};
<a name="15835"/>15835:                                {ok, BadReply} -&gt;
<a name="15836"/>15836:                                    {error, {unexpected_reply, BadReply}};
<a name="15837"/>15837:                                {error, _} = ERROR -&gt;
<a name="15838"/>15838:                                    ERROR
<a name="15839"/>15839:                            end
<a name="15840"/>15840:                    end},
<a name="15841"/>15841:          #{desc =&gt; &quot;announce ready 3 (recv reply)&quot;,
<a name="15842"/>15842:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15843"/>15843:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="15844"/>15844:                            ok
<a name="15845"/>15845:                    end},
<a name="15846"/>15846: 
<a name="15847"/>15847:          %% *** Termination ***
<a name="15848"/>15848:          #{desc =&gt; &quot;await terminate&quot;,
<a name="15849"/>15849:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="15850"/>15850:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="15851"/>15851:                                ok -&gt;
<a name="15852"/>15852:                                    {ok, maps:remove(tester, State)};
<a name="15853"/>15853:                                {error, _} = ERROR -&gt;
<a name="15854"/>15854:                                    ERROR
<a name="15855"/>15855:                            end
<a name="15856"/>15856:                    end},
<a name="15857"/>15857:          #{desc =&gt; &quot;close socket&quot;,
<a name="15858"/>15858:            cmd  =&gt; fun(#{domain   := local,
<a name="15859"/>15859:                          sock     := Sock,
<a name="15860"/>15860:                          local_sa := #{path := Path}} = State) -&gt;
<a name="15861"/>15861:                            ok = socket:close(Sock),
<a name="15862"/>15862:                            State1 =
<a name="15863"/>15863:                                unlink_path(Path,
<a name="15864"/>15864:                                            fun() -&gt;
<a name="15865"/>15865:                                                    maps:remove(local_sa, State)
<a name="15866"/>15866:                                            end,
<a name="15867"/>15867:                                            fun() -&gt; State end),
<a name="15868"/>15868:                            {ok, maps:remove(sock, State1)};
<a name="15869"/>15869:                       (#{sock := Sock} = State) -&gt;
<a name="15870"/>15870:                            ok = socket:close(Sock),
<a name="15871"/>15871:                            {ok, maps:remove(sock, State)}
<a name="15872"/>15872:                    end},
<a name="15873"/>15873: 
<a name="15874"/>15874:          %% *** We are done ***
<a name="15875"/>15875:          ?SEV_FINISH_NORMAL
<a name="15876"/>15876:         ],
<a name="15877"/>15877: 
<a name="15878"/>15878: 
<a name="15879"/>15879:     TesterSeq =
<a name="15880"/>15880:         [
<a name="15881"/>15881:          %% *** Init part ***
<a name="15882"/>15882:          #{desc =&gt; &quot;monitor server&quot;,
<a name="15883"/>15883:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="15884"/>15884:                            _MRef = erlang:monitor(process, Pid),
<a name="15885"/>15885:                            ok
<a name="15886"/>15886:                    end},
<a name="15887"/>15887:          #{desc =&gt; &quot;monitor client&quot;,
<a name="15888"/>15888:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="15889"/>15889:                            _MRef = erlang:monitor(process, Pid),
<a name="15890"/>15890:                            ok
<a name="15891"/>15891:                    end},
<a name="15892"/>15892: 
<a name="15893"/>15893:          %% Start the server
<a name="15894"/>15894:          #{desc =&gt; &quot;order server start&quot;,
<a name="15895"/>15895:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="15896"/>15896:                            ?SEV_ANNOUNCE_START(Pid),
<a name="15897"/>15897:                            ok
<a name="15898"/>15898:                    end},
<a name="15899"/>15899:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="15900"/>15900:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="15901"/>15901:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="15902"/>15902:                            {ok, State#{server_port =&gt; Port}}
<a name="15903"/>15903:                    end},
<a name="15904"/>15904: 
<a name="15905"/>15905:          %% Start the client
<a name="15906"/>15906:          #{desc =&gt; &quot;order client start&quot;,
<a name="15907"/>15907:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="15908"/>15908:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="15909"/>15909:                            ok
<a name="15910"/>15910:                    end},
<a name="15911"/>15911:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="15912"/>15912:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="15913"/>15913:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="15914"/>15914:                    end},
<a name="15915"/>15915: 
<a name="15916"/>15916:          %% *** The actual test ***
<a name="15917"/>15917:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="15918"/>15918:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15919"/>15919:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="15920"/>15920:                            ok
<a name="15921"/>15921:                    end},
<a name="15922"/>15922:          ?SEV_SLEEP(?SECS(1)),
<a name="15923"/>15923:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="15924"/>15924:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15925"/>15925:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="15926"/>15926:                            ok
<a name="15927"/>15927:                    end},
<a name="15928"/>15928:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="15929"/>15929:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15930"/>15930:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="15931"/>15931:                    end},
<a name="15932"/>15932:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="15933"/>15933:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15934"/>15934:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="15935"/>15935:                    end},
<a name="15936"/>15936: 
<a name="15937"/>15937:          %% *** First message (default=wo passcred) ***
<a name="15938"/>15938: 
<a name="15939"/>15939:          #{desc =&gt; &quot;order client to continue (with verify timestamp off)&quot;,
<a name="15940"/>15940:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15941"/>15941:                            ?SEV_ANNOUNCE_CONTINUE(Client, verify_passcred),
<a name="15942"/>15942:                            ok
<a name="15943"/>15943:                    end},
<a name="15944"/>15944:          #{desc =&gt; &quot;await client ready (passcred off)&quot;,
<a name="15945"/>15945:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15946"/>15946:                            ?SEV_AWAIT_READY(Client, client, passcred_off)
<a name="15947"/>15947:                    end},
<a name="15948"/>15948: 
<a name="15949"/>15949:          #{desc =&gt; &quot;order client to continue (with send request 1)&quot;,
<a name="15950"/>15950:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15951"/>15951:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="15952"/>15952:                            ok
<a name="15953"/>15953:                    end},
<a name="15954"/>15954:          #{desc =&gt; &quot;await client ready (with send request 1)&quot;,
<a name="15955"/>15955:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15956"/>15956:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="15957"/>15957:                    end},
<a name="15958"/>15958:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="15959"/>15959:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15960"/>15960:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="15961"/>15961:                    end},
<a name="15962"/>15962:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="15963"/>15963:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15964"/>15964:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="15965"/>15965:                            ok
<a name="15966"/>15966:                    end},
<a name="15967"/>15967:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="15968"/>15968:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15969"/>15969:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="15970"/>15970:                    end},
<a name="15971"/>15971:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="15972"/>15972:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15973"/>15973:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="15974"/>15974:                    end},
<a name="15975"/>15975: 
<a name="15976"/>15976:          %% Second message (w passcred)
<a name="15977"/>15977: 
<a name="15978"/>15978:          #{desc =&gt; &quot;order client to continue (with enable passcred)&quot;,
<a name="15979"/>15979:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15980"/>15980:                            ?SEV_ANNOUNCE_CONTINUE(Client, enable_passcred),
<a name="15981"/>15981:                            ok
<a name="15982"/>15982:                    end},
<a name="15983"/>15983:          #{desc =&gt; &quot;await client ready (passcred on)&quot;,
<a name="15984"/>15984:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15985"/>15985:                            ?SEV_AWAIT_READY(Client, client, passcred_on)
<a name="15986"/>15986:                    end},
<a name="15987"/>15987: 
<a name="15988"/>15988:          #{desc =&gt; &quot;order client to continue (with send request 2)&quot;,
<a name="15989"/>15989:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15990"/>15990:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="15991"/>15991:                            ok
<a name="15992"/>15992:                    end},
<a name="15993"/>15993:          #{desc =&gt; &quot;await client ready (with send request 2)&quot;,
<a name="15994"/>15994:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="15995"/>15995:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="15996"/>15996:                    end},
<a name="15997"/>15997:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="15998"/>15998:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="15999"/>15999:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="16000"/>16000:                    end},
<a name="16001"/>16001:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="16002"/>16002:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16003"/>16003:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="16004"/>16004:                            ok
<a name="16005"/>16005:                    end},
<a name="16006"/>16006:          #{desc =&gt; &quot;await server ready (with reply sent 2)&quot;,
<a name="16007"/>16007:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16008"/>16008:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="16009"/>16009:                    end},
<a name="16010"/>16010:          #{desc =&gt; &quot;await client ready (reply recv 2)&quot;,
<a name="16011"/>16011:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16012"/>16012:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="16013"/>16013:                    end},
<a name="16014"/>16014: 
<a name="16015"/>16015:          %% Third message (wo passcred)
<a name="16016"/>16016: 
<a name="16017"/>16017:          #{desc =&gt; &quot;order client to continue (with disable passcred)&quot;,
<a name="16018"/>16018:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16019"/>16019:                            ?SEV_ANNOUNCE_CONTINUE(Client, disable_passcred),
<a name="16020"/>16020:                            ok
<a name="16021"/>16021:                    end},
<a name="16022"/>16022:          #{desc =&gt; &quot;await client ready (passcred off)&quot;,
<a name="16023"/>16023:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16024"/>16024:                            ?SEV_AWAIT_READY(Client, client, passcred_off)
<a name="16025"/>16025:                    end},
<a name="16026"/>16026: 
<a name="16027"/>16027:          #{desc =&gt; &quot;order client to continue (with send request 3)&quot;,
<a name="16028"/>16028:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16029"/>16029:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="16030"/>16030:                            ok
<a name="16031"/>16031:                    end},
<a name="16032"/>16032:          #{desc =&gt; &quot;await client ready (with send request 3)&quot;,
<a name="16033"/>16033:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16034"/>16034:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="16035"/>16035:                    end},
<a name="16036"/>16036:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="16037"/>16037:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16038"/>16038:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="16039"/>16039:                    end},
<a name="16040"/>16040:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="16041"/>16041:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16042"/>16042:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="16043"/>16043:                            ok
<a name="16044"/>16044:                    end},
<a name="16045"/>16045:          #{desc =&gt; &quot;await server ready (with reply sent 3)&quot;,
<a name="16046"/>16046:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16047"/>16047:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="16048"/>16048:                    end},
<a name="16049"/>16049:          #{desc =&gt; &quot;await client ready (reply recv 3)&quot;,
<a name="16050"/>16050:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16051"/>16051:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="16052"/>16052:                    end},
<a name="16053"/>16053: 
<a name="16054"/>16054: 
<a name="16055"/>16055:          %% *** Termination ***
<a name="16056"/>16056:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="16057"/>16057:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16058"/>16058:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="16059"/>16059:                            ok
<a name="16060"/>16060:                    end},
<a name="16061"/>16061:          #{desc =&gt; &quot;await client termination&quot;,
<a name="16062"/>16062:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="16063"/>16063:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="16064"/>16064:                            State1 = maps:remove(client, State),
<a name="16065"/>16065:                            {ok, State1}
<a name="16066"/>16066:                    end},
<a name="16067"/>16067:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="16068"/>16068:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16069"/>16069:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="16070"/>16070:                            ok
<a name="16071"/>16071:                    end},
<a name="16072"/>16072:          #{desc =&gt; &quot;await server termination&quot;,
<a name="16073"/>16073:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="16074"/>16074:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="16075"/>16075:                            State1 = maps:remove(server, State),
<a name="16076"/>16076:                            {ok, State1}
<a name="16077"/>16077:                    end},
<a name="16078"/>16078: 
<a name="16079"/>16079:          %% *** We are done ***
<a name="16080"/>16080:          ?SEV_FINISH_NORMAL
<a name="16081"/>16081:         ],
<a name="16082"/>16082: 
<a name="16083"/>16083: 
<a name="16084"/>16084:     i(&quot;start server evaluator&quot;),
<a name="16085"/>16085:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="16086"/>16086: 
<a name="16087"/>16087:     i(&quot;start client evaluator&quot;),
<a name="16088"/>16088:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="16089"/>16089: 
<a name="16090"/>16090:     i(&quot;start tester evaluator&quot;),
<a name="16091"/>16091:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="16092"/>16092:                         client =&gt; Client#ev.pid},
<a name="16093"/>16093:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="16094"/>16094: 
<a name="api_opt_sock_passcred_tcp-last_expr"/><a name="16095"/>16095: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="16096"/>16096: 
<a name="16097"/>16097: 
<a name="16098"/>16098: 
<a name="16099"/>16099: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="16100"/>16100: 
<a name="16101"/>16101: <i>%% Tests the the peek-off socket option for a unix domain socket</i>
<a name="16102"/>16102: <i>%% (stream TCP in this case).</i>
<a name="16103"/>16103: <i>%%</i>
<a name="16104"/>16104: <i>%% THIS IS A PLACEHOLDER!!</i>
<a name="16105"/>16105: <i>%%</i>
<a name="16106"/>16106: <i>%%</i>
<a name="16107"/>16107: 
<a name="api_opt_sock_peek_off_tcpL-1"/><a name="16108"/>16108: <b>api_opt_sock_peek_off_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="16109"/>16109:     ?TT(?SECS(5)),
<a name="api_opt_sock_peek_off_tcpL-last_expr"/><a name="16110"/>16110: <b>    tc_try</b>(api_opt_sock_peek_off_tcpL,
<a name="16111"/>16111:            fun() -&gt;
<a name="16112"/>16112:                    has_support_unix_domain_socket(),
<a name="16113"/>16113:                    has_support_sock_peek_off(),
<a name="16114"/>16114:                    has_support_msg_flag(peek)
<a name="16115"/>16115:            end,
<a name="16116"/>16116:            fun() -&gt;
<a name="16117"/>16117:                    Set  = fun(Sock, Val) when is_integer(Val) -&gt;
<a name="16118"/>16118:                                   socket:setopt(Sock, socket, peek_off, Val)
<a name="16119"/>16119:                           end,
<a name="16120"/>16120:                    Get  = fun(Sock) -&gt;
<a name="16121"/>16121:                                   socket:getopt(Sock, socket, peek_off)
<a name="16122"/>16122:                           end,
<a name="16123"/>16123:                    Send = fun(Sock, Data) -&gt;
<a name="16124"/>16124:                                   socket:send(Sock, Data)
<a name="16125"/>16125:                           end,
<a name="16126"/>16126:                    Recv = fun(Sock, L, false) -&gt;
<a name="16127"/>16127:                                   socket:recv(Sock, L);
<a name="16128"/>16128:                              (Sock, L, true) -&gt;
<a name="16129"/>16129:                                   socket:recv(Sock, L, [peek])
<a name="16130"/>16130:                           end,
<a name="16131"/>16131:                    InitState = #{domain =&gt; local,
<a name="16132"/>16132:                                  proto  =&gt; default, % Type = stream =&gt; tcp
<a name="16133"/>16133:                                  set    =&gt; Set,
<a name="16134"/>16134:                                  get    =&gt; Get,
<a name="16135"/>16135:                                  send   =&gt; Send,
<a name="16136"/>16136:                                  recv   =&gt; Recv},
<a name="16137"/>16137:                    ok = api_opt_sock_peek_off(InitState)
<a name="16138"/>16138:            end).
<a name="16139"/>16139: 
<a name="api_opt_sock_peek_off-1"/><a name="16140"/>16140: <b>api_opt_sock_peek_off</b>(InitState) -&gt;
<a name="16141"/>16141:     process_flag(trap_exit, true),
<a name="16142"/>16142:     ServerSeq = 
<a name="16143"/>16143:         [
<a name="16144"/>16144:          %% *** Wait for start order ***
<a name="16145"/>16145:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="16146"/>16146:            cmd  =&gt; fun(State) -&gt;
<a name="16147"/>16147:                            Tester = ?SEV_AWAIT_START(),
<a name="16148"/>16148:                            {ok, State#{tester =&gt; Tester}}
<a name="16149"/>16149:                    end},
<a name="16150"/>16150:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="16151"/>16151:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16152"/>16152:                            _MRef = erlang:monitor(process, Tester),
<a name="16153"/>16153:                            ok
<a name="16154"/>16154:                    end},
<a name="16155"/>16155: 
<a name="16156"/>16156:          %% *** Init part ***
<a name="16157"/>16157:          #{desc =&gt; &quot;which local address&quot;,
<a name="16158"/>16158:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="16159"/>16159:                            LSA = which_local_socket_addr(Domain),
<a name="16160"/>16160:                            {ok, State#{lsa =&gt; LSA}}
<a name="16161"/>16161:                    end},
<a name="16162"/>16162:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="16163"/>16163:            cmd  =&gt; fun(#{domain := Domain,
<a name="16164"/>16164:                          proto  := Proto} = State) -&gt;
<a name="16165"/>16165:                            case socket:open(Domain, stream, Proto) of
<a name="16166"/>16166:                                {ok, Sock} -&gt;
<a name="16167"/>16167:                                    {ok, State#{lsock =&gt; Sock}};
<a name="16168"/>16168:                                {error, _} = ERROR -&gt;
<a name="16169"/>16169:                                    ERROR
<a name="16170"/>16170:                            end
<a name="16171"/>16171:                    end},
<a name="16172"/>16172:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="16173"/>16173:            cmd  =&gt; fun(#{lsock := LSock,
<a name="16174"/>16174:                          lsa   := LSA} = _State) -&gt;
<a name="16175"/>16175:                            case sock_bind(LSock, LSA) of
<a name="16176"/>16176:                                ok -&gt;
<a name="16177"/>16177:                                    %% We do not care about the port for local
<a name="16178"/>16178:                                    ok;
<a name="16179"/>16179:                                {error, _} = ERROR -&gt;
<a name="16180"/>16180:                                    ERROR
<a name="16181"/>16181:                            end
<a name="16182"/>16182:                    end},
<a name="16183"/>16183:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="16184"/>16184:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="16185"/>16185:                            socket:listen(LSock)
<a name="16186"/>16186:                    end},
<a name="16187"/>16187:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="16188"/>16188:            cmd  =&gt; fun(#{tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="16189"/>16189:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="16190"/>16190:                            ok
<a name="16191"/>16191:                    end},
<a name="16192"/>16192: 
<a name="16193"/>16193:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="16194"/>16194:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16195"/>16195:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="16196"/>16196:                    end},
<a name="16197"/>16197:          #{desc =&gt; &quot;await connection&quot;,
<a name="16198"/>16198:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="16199"/>16199:                            case socket:accept(LSock) of
<a name="16200"/>16200:                                {ok, Sock} -&gt;
<a name="16201"/>16201:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="16202"/>16202:                                    {ok, State#{csock =&gt; Sock}};
<a name="16203"/>16203:                                {error, _} = ERROR -&gt;
<a name="16204"/>16204:                                    ERROR
<a name="16205"/>16205:                            end
<a name="16206"/>16206:                    end},
<a name="16207"/>16207:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="16208"/>16208:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16209"/>16209:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="16210"/>16210:                            ok
<a name="16211"/>16211:                    end},
<a name="16212"/>16212: 
<a name="16213"/>16213: 
<a name="16214"/>16214:          %% The actual test
<a name="16215"/>16215: 
<a name="16216"/>16216:          %% 1) peek (0 = everything: 1,2,3,4,5,6,7,8)
<a name="16217"/>16217:          #{desc =&gt; &quot;1a: await continue (peek)&quot;,
<a name="16218"/>16218:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16219"/>16219:                            ?SEV_AWAIT_CONTINUE(Tester, tester, peek)
<a name="16220"/>16220:                    end},
<a name="16221"/>16221:          #{desc =&gt; &quot;1a: peek read&quot;,
<a name="16222"/>16222:            cmd  =&gt; fun(#{csock := Sock,
<a name="16223"/>16223:                          recv  := Recv} = _State) -&gt;
<a name="16224"/>16224:                            case Recv(Sock, 0, true) of
<a name="16225"/>16225:                                {ok, &lt;&lt;1,2,3,4,5,6,7,8&gt;&gt;} -&gt;
<a name="16226"/>16226:                                    ?SEV_IPRINT(&quot;peek'ed expected data&quot;),
<a name="16227"/>16227:                                    ok;
<a name="16228"/>16228:                                {error, _} = ERROR -&gt;
<a name="16229"/>16229:                                    ERROR
<a name="16230"/>16230:                            end
<a name="16231"/>16231:                    end},
<a name="16232"/>16232:          #{desc =&gt; &quot;1a: announce ready (peek)&quot;,
<a name="16233"/>16233:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16234"/>16234:                            ?SEV_ANNOUNCE_READY(Tester, peek),
<a name="16235"/>16235:                            ok
<a name="16236"/>16236:                    end},
<a name="16237"/>16237: 
<a name="16238"/>16238:          #{desc =&gt; &quot;1b: await continue (verify peek-off)&quot;,
<a name="16239"/>16239:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16240"/>16240:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16241"/>16241:                    end},
<a name="16242"/>16242:          #{desc =&gt; &quot;1b: verify peek-off&quot;,
<a name="16243"/>16243:            cmd  =&gt; fun(#{csock := Sock,
<a name="16244"/>16244:                          get   := Get} = _State) -&gt;
<a name="16245"/>16245:                            case Get(Sock) of
<a name="16246"/>16246:                                {ok, DefaultPeekOff} -&gt;
<a name="16247"/>16247:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;,
<a name="16248"/>16248:                                                [DefaultPeekOff]),
<a name="16249"/>16249:                                    ok;
<a name="16250"/>16250:                                {error, {not_supported, {socket, peek_off}}} -&gt;
<a name="16251"/>16251:                                    {skip, &quot;Not supported&quot;};
<a name="16252"/>16252:                                {error, _} = ERROR -&gt;
<a name="16253"/>16253:                                    ERROR
<a name="16254"/>16254:                            end
<a name="16255"/>16255:                    end},
<a name="16256"/>16256:          #{desc =&gt; &quot;1b: announce ready (verify peek-off)&quot;,
<a name="16257"/>16257:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16258"/>16258:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16259"/>16259:                            ok
<a name="16260"/>16260:                    end},
<a name="16261"/>16261: 
<a name="16262"/>16262: 
<a name="16263"/>16263:          %% 2) set peek-off to 4
<a name="16264"/>16264:          #{desc =&gt; &quot;2a: await continue (set peek-off: 4)&quot;,
<a name="16265"/>16265:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16266"/>16266:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_peek_off)
<a name="16267"/>16267:                    end},
<a name="16268"/>16268:          #{desc =&gt; &quot;2a: set peek-off: 4&quot;,
<a name="16269"/>16269:            cmd  =&gt; fun(#{csock := Sock,
<a name="16270"/>16270:                          set   := Set} = _State) -&gt;
<a name="16271"/>16271:                            case Set(Sock, 4) of
<a name="16272"/>16272:                                ok -&gt;
<a name="16273"/>16273:                                    ok;
<a name="16274"/>16274:                                {error, _} = ERROR -&gt;
<a name="16275"/>16275:                                    ERROR
<a name="16276"/>16276:                            end
<a name="16277"/>16277:                    end},
<a name="16278"/>16278:          #{desc =&gt; &quot;2a: announce ready (set peek-off: 4)&quot;,
<a name="16279"/>16279:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16280"/>16280:                            ?SEV_ANNOUNCE_READY(Tester, set_peek_off),
<a name="16281"/>16281:                            ok
<a name="16282"/>16282:                    end},
<a name="16283"/>16283: 
<a name="16284"/>16284:          #{desc =&gt; &quot;2b: await continue (verify peek-off)&quot;,
<a name="16285"/>16285:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16286"/>16286:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16287"/>16287:                    end},
<a name="16288"/>16288:          #{desc =&gt; &quot;2b: verify peek-off&quot;,
<a name="16289"/>16289:            cmd  =&gt; fun(#{csock := Sock,
<a name="16290"/>16290:                          get   := Get} = _State) -&gt;
<a name="16291"/>16291:                            case Get(Sock) of
<a name="16292"/>16292:                                {ok, 4 = PeekOff} -&gt;
<a name="16293"/>16293:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="16294"/>16294:                                    ok;
<a name="16295"/>16295:                                {error, _} = ERROR -&gt;
<a name="16296"/>16296:                                    ERROR
<a name="16297"/>16297:                            end
<a name="16298"/>16298:                    end},
<a name="16299"/>16299:          #{desc =&gt; &quot;2b: announce ready (verify peek-off)&quot;,
<a name="16300"/>16300:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16301"/>16301:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16302"/>16302:                            ok
<a name="16303"/>16303:                    end},
<a name="16304"/>16304: 
<a name="16305"/>16305: 
<a name="16306"/>16306:          %% 3) peek (0 = everything: 5,6,7,8)
<a name="16307"/>16307:          %%    NOTE THAT THIS WILL MOVE THE PEEK-OFF &quot;POINTER&quot; TO THE END OF 
<a name="16308"/>16308:          %%    THE *CURRENT* DATA POSITION IN THE BUFFER (READY FOR NEXT BATCH
<a name="16309"/>16309:          %%    OF DATA).
<a name="16310"/>16310:          #{desc =&gt; &quot;3a: await continue (peek)&quot;,
<a name="16311"/>16311:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16312"/>16312:                            ?SEV_AWAIT_CONTINUE(Tester, tester, peek)
<a name="16313"/>16313:                    end},
<a name="16314"/>16314:          #{desc =&gt; &quot;3a: peek read&quot;,
<a name="16315"/>16315:            cmd  =&gt; fun(#{csock := Sock,
<a name="16316"/>16316:                          recv  := Recv} = _State) -&gt;
<a name="16317"/>16317:                            case Recv(Sock, 0, true) of
<a name="16318"/>16318:                                {ok, &lt;&lt;5,6,7,8&gt;&gt;} -&gt;
<a name="16319"/>16319:                                    ?SEV_IPRINT(&quot;peek'ed expected data&quot;),
<a name="16320"/>16320:                                    ok;
<a name="16321"/>16321:                                {error, _} = ERROR -&gt;
<a name="16322"/>16322:                                    ERROR
<a name="16323"/>16323:                            end
<a name="16324"/>16324:                    end},
<a name="16325"/>16325:          #{desc =&gt; &quot;3a: announce ready (peek)&quot;,
<a name="16326"/>16326:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16327"/>16327:                            ?SEV_ANNOUNCE_READY(Tester, peek),
<a name="16328"/>16328:                            ok
<a name="16329"/>16329:                    end},
<a name="16330"/>16330: 
<a name="16331"/>16331:          #{desc =&gt; &quot;3b: await continue (verify peek-off)&quot;,
<a name="16332"/>16332:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16333"/>16333:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16334"/>16334:                    end},
<a name="16335"/>16335:          #{desc =&gt; &quot;3b: verify peek-off&quot;,
<a name="16336"/>16336:            cmd  =&gt; fun(#{csock := Sock,
<a name="16337"/>16337:                          get   := Get} = _State) -&gt;
<a name="16338"/>16338:                            case Get(Sock) of
<a name="16339"/>16339:                                {ok, 8 = PeekOff} -&gt;
<a name="16340"/>16340:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="16341"/>16341:                                    ok;
<a name="16342"/>16342:                                {error, _} = ERROR -&gt;
<a name="16343"/>16343:                                    ERROR
<a name="16344"/>16344:                            end
<a name="16345"/>16345:                    end},
<a name="16346"/>16346:          #{desc =&gt; &quot;3b: announce ready (verify peek-off)&quot;,
<a name="16347"/>16347:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16348"/>16348:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16349"/>16349:                            ok
<a name="16350"/>16350:                    end},
<a name="16351"/>16351: 
<a name="16352"/>16352: 
<a name="16353"/>16353:          %% 4) read two byte(s): 1,2
<a name="16354"/>16354:          #{desc =&gt; &quot;4a: await continue (read 2 byte)&quot;,
<a name="16355"/>16355:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16356"/>16356:                            ?SEV_AWAIT_CONTINUE(Tester, tester, read)
<a name="16357"/>16357:                    end},
<a name="16358"/>16358:          #{desc =&gt; &quot;4a: read (2 bytes)&quot;,
<a name="16359"/>16359:            cmd  =&gt; fun(#{csock := Sock,
<a name="16360"/>16360:                          recv  := Recv} = _State) -&gt;
<a name="16361"/>16361:                            case Recv(Sock, 2, false) of
<a name="16362"/>16362:                                {ok, &lt;&lt;1,2&gt;&gt;} -&gt;
<a name="16363"/>16363:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="16364"/>16364:                                    ok;
<a name="16365"/>16365:                                {error, _} = ERROR -&gt;
<a name="16366"/>16366:                                    ERROR
<a name="16367"/>16367:                            end
<a name="16368"/>16368:                    end},
<a name="16369"/>16369:          #{desc =&gt; &quot;4a: announce ready (read)&quot;,
<a name="16370"/>16370:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16371"/>16371:                            ?SEV_ANNOUNCE_READY(Tester, read),
<a name="16372"/>16372:                            ok
<a name="16373"/>16373:                    end},
<a name="16374"/>16374: 
<a name="16375"/>16375:          #{desc =&gt; &quot;4b: await continue (verify peek-off)&quot;,
<a name="16376"/>16376:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16377"/>16377:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16378"/>16378:                    end},
<a name="16379"/>16379:          #{desc =&gt; &quot;4b: verify peek-off&quot;,
<a name="16380"/>16380:            cmd  =&gt; fun(#{csock := Sock,
<a name="16381"/>16381:                          get   := Get} = _State) -&gt;
<a name="16382"/>16382:                            case Get(Sock) of
<a name="16383"/>16383:                                {ok, 6 = PeekOff} -&gt;
<a name="16384"/>16384:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="16385"/>16385:                                    ok;
<a name="16386"/>16386:                                {error, _} = ERROR -&gt;
<a name="16387"/>16387:                                    ERROR
<a name="16388"/>16388:                            end
<a name="16389"/>16389:                    end},
<a name="16390"/>16390:          #{desc =&gt; &quot;4b: announce ready (verify peek-off)&quot;,
<a name="16391"/>16391:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16392"/>16392:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16393"/>16393:                            ok
<a name="16394"/>16394:                    end},
<a name="16395"/>16395: 
<a name="16396"/>16396: 
<a name="16397"/>16397:          %% 5) read the rest: 3,4,5,6,7,8)
<a name="16398"/>16398:          #{desc =&gt; &quot;5a: await continue (read the rest)&quot;,
<a name="16399"/>16399:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16400"/>16400:                            ?SEV_AWAIT_CONTINUE(Tester, tester, read)
<a name="16401"/>16401:                    end},
<a name="16402"/>16402:          #{desc =&gt; &quot;5a: read (the rest)&quot;,
<a name="16403"/>16403:            cmd  =&gt; fun(#{csock := Sock,
<a name="16404"/>16404:                          recv  := Recv} = _State) -&gt;
<a name="16405"/>16405:                            case Recv(Sock, 0, false) of
<a name="16406"/>16406:                                {ok, &lt;&lt;3,4,5,6,7,8&gt;&gt;} -&gt;
<a name="16407"/>16407:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="16408"/>16408:                                    ok;
<a name="16409"/>16409:                                {error, _} = ERROR -&gt;
<a name="16410"/>16410:                                    ERROR
<a name="16411"/>16411:                            end
<a name="16412"/>16412:                    end},
<a name="16413"/>16413:          #{desc =&gt; &quot;5a: announce ready (read)&quot;,
<a name="16414"/>16414:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16415"/>16415:                            ?SEV_ANNOUNCE_READY(Tester, read),
<a name="16416"/>16416:                            ok
<a name="16417"/>16417:                    end},
<a name="16418"/>16418: 
<a name="16419"/>16419:          #{desc =&gt; &quot;5b: await continue (verify peek-off)&quot;,
<a name="16420"/>16420:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16421"/>16421:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="16422"/>16422:                    end},
<a name="16423"/>16423:          #{desc =&gt; &quot;5b: verify peek-off&quot;,
<a name="16424"/>16424:            cmd  =&gt; fun(#{csock := Sock,
<a name="16425"/>16425:                          get   := Get} = _State) -&gt;
<a name="16426"/>16426:                            case Get(Sock) of
<a name="16427"/>16427:                                {ok, PeekOff} -&gt;
<a name="16428"/>16428:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="16429"/>16429:                                    ok;
<a name="16430"/>16430:                                {error, _} = ERROR -&gt;
<a name="16431"/>16431:                                    ERROR
<a name="16432"/>16432:                            end
<a name="16433"/>16433:                    end},
<a name="16434"/>16434:          #{desc =&gt; &quot;5b: announce ready (verify peek-off)&quot;,
<a name="16435"/>16435:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16436"/>16436:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="16437"/>16437:                            ok
<a name="16438"/>16438:                    end},
<a name="16439"/>16439: 
<a name="16440"/>16440: 
<a name="16441"/>16441:          %% *** Termination ***
<a name="16442"/>16442:          #{desc =&gt; &quot;await terminate&quot;,
<a name="16443"/>16443:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16444"/>16444:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16445"/>16445:                                ok -&gt;
<a name="16446"/>16446:                                    {ok, maps:remove(tester, State)};
<a name="16447"/>16447:                                {error, _} = ERROR -&gt;
<a name="16448"/>16448:                                    ERROR
<a name="16449"/>16449:                            end
<a name="16450"/>16450:                    end},
<a name="16451"/>16451:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="16452"/>16452:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="16453"/>16453:                            ok = socket:close(Sock),
<a name="16454"/>16454:                            {ok, maps:remove(csock, State)}
<a name="16455"/>16455:                    end},
<a name="16456"/>16456:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="16457"/>16457:            cmd  =&gt; fun(#{lsock := Sock,
<a name="16458"/>16458:                          lsa   := #{path := Path}} = State) -&gt;
<a name="16459"/>16459:                            ok = socket:close(Sock),
<a name="16460"/>16460:                            State1 =
<a name="16461"/>16461:                                unlink_path(Path,
<a name="16462"/>16462:                                            fun() -&gt;
<a name="16463"/>16463:                                                    maps:remove(local_sa, State)
<a name="16464"/>16464:                                            end,
<a name="16465"/>16465:                                            fun() -&gt; State end),
<a name="16466"/>16466:                            {ok, maps:remove(lsock, State1)}
<a name="16467"/>16467:                    end},
<a name="16468"/>16468: 
<a name="16469"/>16469:          %% *** We are done ***
<a name="16470"/>16470:          ?SEV_FINISH_NORMAL
<a name="16471"/>16471:         ],
<a name="16472"/>16472: 
<a name="16473"/>16473:     ClientSeq = 
<a name="16474"/>16474:         [
<a name="16475"/>16475:          %% *** Wait for start order ***
<a name="16476"/>16476:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="16477"/>16477:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="16478"/>16478:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="16479"/>16479:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}}
<a name="16480"/>16480:                    end},
<a name="16481"/>16481:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="16482"/>16482:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16483"/>16483:                            _MRef = erlang:monitor(process, Tester),
<a name="16484"/>16484:                            ok
<a name="16485"/>16485:                    end},
<a name="16486"/>16486: 
<a name="16487"/>16487:          %% *** The init part ***
<a name="16488"/>16488:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="16489"/>16489:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="16490"/>16490:                          server_path := Path} = State) -&gt;
<a name="16491"/>16491:                            LSA = which_local_socket_addr(Domain),
<a name="16492"/>16492:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="16493"/>16493:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="16494"/>16494:                    end},
<a name="16495"/>16495:          #{desc =&gt; &quot;create socket&quot;,
<a name="16496"/>16496:            cmd  =&gt; fun(#{domain := Domain,
<a name="16497"/>16497:                          proto  := Proto} = State) -&gt;
<a name="16498"/>16498:                            case socket:open(Domain, stream, Proto) of
<a name="16499"/>16499:                                {ok, Sock} -&gt;
<a name="16500"/>16500:                                    {ok, State#{sock =&gt; Sock}};
<a name="16501"/>16501:                                {error, _} = ERROR -&gt;
<a name="16502"/>16502:                                    ERROR
<a name="16503"/>16503:                            end
<a name="16504"/>16504:                    end},
<a name="16505"/>16505:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="16506"/>16506:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="16507"/>16507:                            case sock_bind(Sock, LSA) of
<a name="16508"/>16508:                                ok -&gt;
<a name="16509"/>16509:                                    ok;
<a name="16510"/>16510:                                {error, _} = ERROR -&gt;
<a name="16511"/>16511:                                    ERROR
<a name="16512"/>16512:                            end
<a name="16513"/>16513:                    end},
<a name="16514"/>16514:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="16515"/>16515:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16516"/>16516:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="16517"/>16517:                            ok
<a name="16518"/>16518:                    end},
<a name="16519"/>16519: 
<a name="16520"/>16520:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="16521"/>16521:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16522"/>16522:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="16523"/>16523:                    end},
<a name="16524"/>16524:          #{desc =&gt; &quot;connect to server&quot;,
<a name="16525"/>16525:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="16526"/>16526:                            socket:connect(Sock, SSA)
<a name="16527"/>16527:                    end},
<a name="16528"/>16528:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="16529"/>16529:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16530"/>16530:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="16531"/>16531:                            ok
<a name="16532"/>16532:                    end},
<a name="16533"/>16533: 
<a name="16534"/>16534: 
<a name="16535"/>16535:          %% *** The actual test ***
<a name="16536"/>16536:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="16537"/>16537:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16538"/>16538:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_data)
<a name="16539"/>16539:                    end},
<a name="16540"/>16540:          #{desc =&gt; &quot;send data (to server)&quot;,
<a name="16541"/>16541:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16542"/>16542:                            Send(Sock, &lt;&lt;1:8/integer,
<a name="16543"/>16543:                                         2:8/integer,
<a name="16544"/>16544:                                         3:8/integer,
<a name="16545"/>16545:                                         4:8/integer,
<a name="16546"/>16546:                                         5:8/integer,
<a name="16547"/>16547:                                         6:8/integer,
<a name="16548"/>16548:                                         7:8/integer,
<a name="16549"/>16549:                                         8:8/integer&gt;&gt;)
<a name="16550"/>16550:                    end},
<a name="16551"/>16551:          #{desc =&gt; &quot;announce ready (send data)&quot;,
<a name="16552"/>16552:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16553"/>16553:                            ?SEV_ANNOUNCE_READY(Tester, send_data),
<a name="16554"/>16554:                            ok
<a name="16555"/>16555:                    end},
<a name="16556"/>16556: 
<a name="16557"/>16557:          %% *** Termination ***
<a name="16558"/>16558:          #{desc =&gt; &quot;await terminate&quot;,
<a name="16559"/>16559:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16560"/>16560:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16561"/>16561:                                ok -&gt;
<a name="16562"/>16562:                                    {ok, maps:remove(tester, State)};
<a name="16563"/>16563:                                {error, _} = ERROR -&gt;
<a name="16564"/>16564:                                    ERROR
<a name="16565"/>16565:                            end
<a name="16566"/>16566:                    end},
<a name="16567"/>16567:          #{desc =&gt; &quot;close socket&quot;,
<a name="16568"/>16568:            cmd  =&gt; fun(#{sock     := Sock,
<a name="16569"/>16569:                          local_sa := #{path := Path}} = State) -&gt;
<a name="16570"/>16570:                            ok = socket:close(Sock),
<a name="16571"/>16571:                            State1 =
<a name="16572"/>16572:                                unlink_path(Path,
<a name="16573"/>16573:                                            fun() -&gt;
<a name="16574"/>16574:                                                    maps:remove(local_sa, State)
<a name="16575"/>16575:                                            end,
<a name="16576"/>16576:                                            fun() -&gt; State end),
<a name="16577"/>16577:                            {ok, maps:remove(sock, State1)}
<a name="16578"/>16578:                    end},
<a name="16579"/>16579: 
<a name="16580"/>16580:          %% *** We are done ***
<a name="16581"/>16581:          ?SEV_FINISH_NORMAL
<a name="16582"/>16582:         ],
<a name="16583"/>16583: 
<a name="16584"/>16584:     TesterSeq =
<a name="16585"/>16585:         [
<a name="16586"/>16586:          %% *** Init part ***
<a name="16587"/>16587:          #{desc =&gt; &quot;monitor server&quot;,
<a name="16588"/>16588:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="16589"/>16589:                            _MRef = erlang:monitor(process, Pid),
<a name="16590"/>16590:                            ok
<a name="16591"/>16591:                    end},
<a name="16592"/>16592:          #{desc =&gt; &quot;monitor client&quot;,
<a name="16593"/>16593:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="16594"/>16594:                            _MRef = erlang:monitor(process, Pid),
<a name="16595"/>16595:                            ok
<a name="16596"/>16596:                    end},
<a name="16597"/>16597: 
<a name="16598"/>16598:          %% Start the server
<a name="16599"/>16599:          #{desc =&gt; &quot;order server start&quot;,
<a name="16600"/>16600:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="16601"/>16601:                            ?SEV_ANNOUNCE_START(Pid),
<a name="16602"/>16602:                            ok
<a name="16603"/>16603:                    end},
<a name="16604"/>16604:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="16605"/>16605:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="16606"/>16606:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="16607"/>16607:                            {ok, State#{server_port =&gt; Port}}
<a name="16608"/>16608:                    end},
<a name="16609"/>16609: 
<a name="16610"/>16610:          %% Start the client
<a name="16611"/>16611:          #{desc =&gt; &quot;order client start&quot;,
<a name="16612"/>16612:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="16613"/>16613:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="16614"/>16614:                            ok
<a name="16615"/>16615:                    end},
<a name="16616"/>16616:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="16617"/>16617:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="16618"/>16618:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="16619"/>16619:                    end},
<a name="16620"/>16620: 
<a name="16621"/>16621:          %% Establish the connection
<a name="16622"/>16622:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="16623"/>16623:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16624"/>16624:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="16625"/>16625:                            ok
<a name="16626"/>16626:                    end},
<a name="16627"/>16627:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="16628"/>16628:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16629"/>16629:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="16630"/>16630:                            ok
<a name="16631"/>16631:                    end},
<a name="16632"/>16632:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="16633"/>16633:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16634"/>16634:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="16635"/>16635:                    end},
<a name="16636"/>16636:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="16637"/>16637:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16638"/>16638:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="16639"/>16639:                    end},
<a name="16640"/>16640: 
<a name="16641"/>16641: 
<a name="16642"/>16642:          %% *** The actual test ***
<a name="16643"/>16643:          #{desc =&gt; &quot;order client to continue (with send data)&quot;,
<a name="16644"/>16644:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16645"/>16645:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_data),
<a name="16646"/>16646:                            ok
<a name="16647"/>16647:                    end},
<a name="16648"/>16648:          #{desc =&gt; &quot;await client ready (with send data)&quot;,
<a name="16649"/>16649:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16650"/>16650:                            ?SEV_AWAIT_READY(Client, client, send_data)
<a name="16651"/>16651:                    end},
<a name="16652"/>16652: 
<a name="16653"/>16653:          %% There is no way to be sure that the data has actually arrived,
<a name="16654"/>16654:          %% and with no data on the server side, the peek will fail.
<a name="16655"/>16655:          %% Hopefully a sleep will take care of this...
<a name="16656"/>16656:          ?SEV_SLEEP(?SECS(1)),
<a name="16657"/>16657: 
<a name="16658"/>16658:          %% 1) peek
<a name="16659"/>16659:          #{desc =&gt; &quot;1a: order server to continue (peek)&quot;,
<a name="16660"/>16660:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16661"/>16661:                            ?SEV_ANNOUNCE_CONTINUE(Server, peek),
<a name="16662"/>16662:                            ok
<a name="16663"/>16663:                    end},
<a name="16664"/>16664:          #{desc =&gt; &quot;1a: await server ready (peek)&quot;,
<a name="16665"/>16665:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16666"/>16666:                            ?SEV_AWAIT_READY(Server, server, peek)
<a name="16667"/>16667:                    end},
<a name="16668"/>16668: 
<a name="16669"/>16669:          #{desc =&gt; &quot;1b: order server to continue (verify peek-off)&quot;,
<a name="16670"/>16670:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16671"/>16671:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16672"/>16672:                            ok
<a name="16673"/>16673:                    end},
<a name="16674"/>16674:          #{desc =&gt; &quot;1b: await server ready (verify peek-off)&quot;,
<a name="16675"/>16675:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16676"/>16676:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16677"/>16677:                    end},
<a name="16678"/>16678: 
<a name="16679"/>16679: 
<a name="16680"/>16680:          %% 2) set peek-off
<a name="16681"/>16681:          #{desc =&gt; &quot;2a: order server to continue (set peek-off)&quot;,
<a name="16682"/>16682:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16683"/>16683:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_peek_off),
<a name="16684"/>16684:                            ok
<a name="16685"/>16685:                    end},
<a name="16686"/>16686:          #{desc =&gt; &quot;2a: await server ready (set peek-off)&quot;,
<a name="16687"/>16687:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16688"/>16688:                            ?SEV_AWAIT_READY(Server, server, set_peek_off)
<a name="16689"/>16689:                    end},
<a name="16690"/>16690: 
<a name="16691"/>16691:          #{desc =&gt; &quot;2b: order server to continue (verify peek-off)&quot;,
<a name="16692"/>16692:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16693"/>16693:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16694"/>16694:                            ok
<a name="16695"/>16695:                    end},
<a name="16696"/>16696:          #{desc =&gt; &quot;2b: await server ready (verify peek-off)&quot;,
<a name="16697"/>16697:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16698"/>16698:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16699"/>16699:                    end},
<a name="16700"/>16700: 
<a name="16701"/>16701: 
<a name="16702"/>16702: 
<a name="16703"/>16703:          %% 3) peek
<a name="16704"/>16704:          #{desc =&gt; &quot;3a: order server to continue (peek)&quot;,
<a name="16705"/>16705:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16706"/>16706:                            ?SEV_ANNOUNCE_CONTINUE(Server, peek),
<a name="16707"/>16707:                            ok
<a name="16708"/>16708:                    end},
<a name="16709"/>16709:          #{desc =&gt; &quot;3a: await server ready (peek)&quot;,
<a name="16710"/>16710:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16711"/>16711:                            ?SEV_AWAIT_READY(Server, server, peek)
<a name="16712"/>16712:                    end},
<a name="16713"/>16713: 
<a name="16714"/>16714:          #{desc =&gt; &quot;3b: order server to continue (verify peek-off)&quot;,
<a name="16715"/>16715:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16716"/>16716:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16717"/>16717:                            ok
<a name="16718"/>16718:                    end},
<a name="16719"/>16719:          #{desc =&gt; &quot;3b: await server ready (verify peek-off)&quot;,
<a name="16720"/>16720:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16721"/>16721:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16722"/>16722:                    end},
<a name="16723"/>16723: 
<a name="16724"/>16724: 
<a name="16725"/>16725: 
<a name="16726"/>16726:          %% 4) read part
<a name="16727"/>16727:          #{desc =&gt; &quot;4a: order server to continue (read part)&quot;,
<a name="16728"/>16728:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16729"/>16729:                            ?SEV_ANNOUNCE_CONTINUE(Server, read),
<a name="16730"/>16730:                            ok
<a name="16731"/>16731:                    end},
<a name="16732"/>16732:          #{desc =&gt; &quot;4a: await server ready (peek)&quot;,
<a name="16733"/>16733:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16734"/>16734:                            ?SEV_AWAIT_READY(Server, server, read)
<a name="16735"/>16735:                    end},
<a name="16736"/>16736: 
<a name="16737"/>16737:          #{desc =&gt; &quot;4b: order server to continue (verify peek-off)&quot;,
<a name="16738"/>16738:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16739"/>16739:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16740"/>16740:                            ok
<a name="16741"/>16741:                    end},
<a name="16742"/>16742:          #{desc =&gt; &quot;4b: await server ready (verify peek-off)&quot;,
<a name="16743"/>16743:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16744"/>16744:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16745"/>16745:                    end},
<a name="16746"/>16746: 
<a name="16747"/>16747: 
<a name="16748"/>16748:          %% 5) read (the rest)
<a name="16749"/>16749:          #{desc =&gt; &quot;5a: order server to continue (read the rest)&quot;,
<a name="16750"/>16750:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16751"/>16751:                            ?SEV_ANNOUNCE_CONTINUE(Server, read),
<a name="16752"/>16752:                            ok
<a name="16753"/>16753:                    end},
<a name="16754"/>16754:          #{desc =&gt; &quot;5a: await server ready (peek)&quot;,
<a name="16755"/>16755:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16756"/>16756:                            ?SEV_AWAIT_READY(Server, server, read)
<a name="16757"/>16757:                    end},
<a name="16758"/>16758: 
<a name="16759"/>16759:          #{desc =&gt; &quot;5b: order server to continue (verify peek-off)&quot;,
<a name="16760"/>16760:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16761"/>16761:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="16762"/>16762:                            ok
<a name="16763"/>16763:                    end},
<a name="16764"/>16764:          #{desc =&gt; &quot;5b: await server ready (verify peek-off)&quot;,
<a name="16765"/>16765:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16766"/>16766:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="16767"/>16767:                    end},
<a name="16768"/>16768: 
<a name="16769"/>16769: 
<a name="16770"/>16770:          %% *** Termination ***
<a name="16771"/>16771:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="16772"/>16772:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16773"/>16773:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="16774"/>16774:                            ok
<a name="16775"/>16775:                    end},
<a name="16776"/>16776:          #{desc =&gt; &quot;await client termination&quot;,
<a name="16777"/>16777:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="16778"/>16778:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="16779"/>16779:                            State1 = maps:remove(client, State),
<a name="16780"/>16780:                            {ok, State1}
<a name="16781"/>16781:                    end},
<a name="16782"/>16782:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="16783"/>16783:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16784"/>16784:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="16785"/>16785:                            ok
<a name="16786"/>16786:                    end},
<a name="16787"/>16787:          #{desc =&gt; &quot;await server termination&quot;,
<a name="16788"/>16788:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="16789"/>16789:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="16790"/>16790:                            State1 = maps:remove(server, State),
<a name="16791"/>16791:                            {ok, State1}
<a name="16792"/>16792:                    end},
<a name="16793"/>16793: 
<a name="16794"/>16794:          %% *** We are done ***
<a name="16795"/>16795:          ?SEV_FINISH_NORMAL
<a name="16796"/>16796:         ],
<a name="16797"/>16797: 
<a name="16798"/>16798:     i(&quot;start server evaluator&quot;),
<a name="16799"/>16799:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="16800"/>16800: 
<a name="16801"/>16801:     i(&quot;start client evaluator&quot;),
<a name="16802"/>16802:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="16803"/>16803:     i(&quot;await evaluator(s)&quot;),
<a name="16804"/>16804: 
<a name="16805"/>16805:     i(&quot;start tester evaluator&quot;),
<a name="16806"/>16806:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="16807"/>16807:                         client =&gt; Client#ev.pid},
<a name="16808"/>16808:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="16809"/>16809: 
<a name="api_opt_sock_peek_off-last_expr"/><a name="16810"/>16810: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="16811"/>16811: 
<a name="16812"/>16812: 
<a name="16813"/>16813: 
<a name="16814"/>16814: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="16815"/>16815: 
<a name="16816"/>16816: <i>%% Tests that we get the peer credentials for a connected unix domain</i>
<a name="16817"/>16817: <i>%% TCP (stream) socket.</i>
<a name="16818"/>16818: <i>%% That is, all we need to do is to create a node, and have </i>
<a name="16819"/>16819: <i>%% process connect from that to a local (unix domain socket) socket.</i>
<a name="16820"/>16820: <i>%%</i>
<a name="16821"/>16821: <i>%% THIS IS A PLACEHOLDER!!</i>
<a name="16822"/>16822: <i>%%</i>
<a name="16823"/>16823: <i>%% We need to figure out what the ucred structure looks like,</i>
<a name="16824"/>16824: <i>%% and decode it...</i>
<a name="16825"/>16825: <i>%%</i>
<a name="16826"/>16826: 
<a name="api_opt_sock_peercred_tcpL-1"/><a name="16827"/>16827: <b>api_opt_sock_peercred_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="16828"/>16828:     ?TT(?SECS(5)),
<a name="api_opt_sock_peercred_tcpL-last_expr"/><a name="16829"/>16829: <b>    tc_try</b>(api_opt_sock_peercred_tcpL,
<a name="16830"/>16830:            fun() -&gt;
<a name="16831"/>16831:                    has_support_unix_domain_socket(),
<a name="16832"/>16832:                    has_support_sock_peercred(),
<a name="16833"/>16833:                    not_yet_implemented()
<a name="16834"/>16834:            end,
<a name="16835"/>16835:            fun() -&gt;
<a name="16836"/>16836:                    Get  = fun(Sock) -&gt;
<a name="16837"/>16837:                                   socket:getopt(Sock, socket, peercred)
<a name="16838"/>16838:                           end,
<a name="16839"/>16839:                    InitState = #{domain =&gt; local,
<a name="16840"/>16840:                                  proto  =&gt; default, % Type = stream =&gt; tcp
<a name="16841"/>16841:                                  get    =&gt; Get},
<a name="16842"/>16842:                    ok = api_opt_sock_peercred_tcp(InitState)
<a name="16843"/>16843:            end).
<a name="16844"/>16844: 
<a name="16845"/>16845: 
<a name="api_opt_sock_peercred_tcp-1"/><a name="16846"/>16846: <b>api_opt_sock_peercred_tcp</b>(_InitState) -&gt;
<a name="16847"/>16847:     %% ServerSeq =
<a name="16848"/>16848:     %%     [
<a name="16849"/>16849:     %%      %% *** Wait for start order part ***
<a name="16850"/>16850:     %%      #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="16851"/>16851:     %%        cmd  =&gt; fun(State) -&gt;
<a name="16852"/>16852:     %%                        {Tester, Backlog} = ?SEV_AWAIT_START(),
<a name="16853"/>16853:     %%                        {ok, State#{tester  =&gt; Tester,
<a name="16854"/>16854:     %%                                    backlog =&gt; Backlog}}
<a name="16855"/>16855:     %%                end},
<a name="16856"/>16856:     %%      #{desc =&gt; &quot;monitor tester&quot;,
<a name="16857"/>16857:     %%        cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16858"/>16858:     %%                        _MRef = erlang:monitor(process, Tester),
<a name="16859"/>16859:     %%                        ok
<a name="16860"/>16860:     %%                end},
<a name="16861"/>16861: 
<a name="16862"/>16862:     %%      %% *** Init part ***
<a name="16863"/>16863:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="16864"/>16864:     %%        cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="16865"/>16865:     %%                        LSA = which_local_socket_addr(Domain),
<a name="16866"/>16866:     %%                        {ok, State#{lsa =&gt; LSA}}
<a name="16867"/>16867:     %%                end},
<a name="16868"/>16868:     %%      #{desc =&gt; &quot;create listen socket&quot;,
<a name="16869"/>16869:     %%        cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="16870"/>16870:     %%                        case socket:open(Domain, stream, Proto) of
<a name="16871"/>16871:     %%                            {ok, Sock} -&gt;
<a name="16872"/>16872:     %%                                {ok, State#{lsock =&gt; Sock}};
<a name="16873"/>16873:     %%                            {error, _} = ERROR -&gt;
<a name="16874"/>16874:     %%                                ERROR
<a name="16875"/>16875:     %%                        end
<a name="16876"/>16876:     %%                end},
<a name="16877"/>16877:     %%      #{desc =&gt; &quot;bind to local address&quot;,
<a name="16878"/>16878:     %%        cmd  =&gt; fun(#{domain := local,
<a name="16879"/>16879:     %%                      lsock  := LSock,
<a name="16880"/>16880:     %%                      lsa    := LSA} = _State) -&gt;
<a name="16881"/>16881:     %%                        case socket:bind(LSock, LSA) of
<a name="16882"/>16882:     %%                            ok -&gt;
<a name="16883"/>16883:     %%                                ok;
<a name="16884"/>16884:     %%                            {error, _} = ERROR -&gt;
<a name="16885"/>16885:     %%                                ERROR
<a name="16886"/>16886:     %%                        end
<a name="16887"/>16887:     %%                end},
<a name="16888"/>16888:     %%      #{desc =&gt; &quot;make listen socket&quot;,
<a name="16889"/>16889:     %%        cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="16890"/>16890:     %%                        socket:listen(LSock)
<a name="16891"/>16891:     %%                end},
<a name="16892"/>16892:     %%      #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="16893"/>16893:     %%        cmd  =&gt; fun(#{domain := local,
<a name="16894"/>16894:     %%                      tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="16895"/>16895:     %%                        ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="16896"/>16896:     %%                        ok
<a name="16897"/>16897:     %%                end},
<a name="16898"/>16898: 
<a name="16899"/>16899: 
<a name="16900"/>16900:     %%      %% The actual test
<a name="16901"/>16901:     %%      #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="16902"/>16902:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16903"/>16903:     %%                        ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="16904"/>16904:     %%                end},
<a name="16905"/>16905:     %%      #{desc =&gt; &quot;await connection&quot;,
<a name="16906"/>16906:     %%        cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="16907"/>16907:     %%                        case socket:accept(LSock) of
<a name="16908"/>16908:     %%                            {ok, Sock} -&gt;
<a name="16909"/>16909:     %%                                ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="16910"/>16910:     %%                                {ok, State#{csock =&gt; Sock}};
<a name="16911"/>16911:     %%                            {error, _} = ERROR -&gt;
<a name="16912"/>16912:     %%                                ERROR
<a name="16913"/>16913:     %%                        end
<a name="16914"/>16914:     %%                end},
<a name="16915"/>16915:     %%      #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="16916"/>16916:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16917"/>16917:     %%                        ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="16918"/>16918:     %%                        ok
<a name="16919"/>16919:     %%                end},
<a name="16920"/>16920: 
<a name="16921"/>16921:     %%      #{desc =&gt; &quot;await continue (peercred)&quot;,
<a name="16922"/>16922:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16923"/>16923:     %%                        ?SEV_AWAIT_CONTINUE(Tester, tester, peercred)
<a name="16924"/>16924:     %%                end},
<a name="16925"/>16925:     %%      #{desc =&gt; &quot;get peercred&quot;,
<a name="16926"/>16926:     %%        cmd  =&gt; fun(#{csock := Sock, get := Get} = _State) -&gt;
<a name="16927"/>16927:     %%                        case Get(Sock) of
<a name="16928"/>16928:     %%                            {ok, PeerCred} -&gt;
<a name="16929"/>16929:     %%                                ?SEV_IPRINT(&quot;PeerCred: ~n   ~p&quot;, [PeerCred]),
<a name="16930"/>16930:     %%                                ok;
<a name="16931"/>16931:     %%                            {error, _} = ERROR -&gt;
<a name="16932"/>16932:     %%                                ERROR
<a name="16933"/>16933:     %%                        end
<a name="16934"/>16934:     %%                end},
<a name="16935"/>16935:     %%      #{desc =&gt; &quot;announce ready (peercred)&quot;,
<a name="16936"/>16936:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16937"/>16937:     %%                        ?SEV_ANNOUNCE_READY(Tester, peercred),
<a name="16938"/>16938:     %%                        ok
<a name="16939"/>16939:     %%                end},
<a name="16940"/>16940: 
<a name="16941"/>16941: 
<a name="16942"/>16942:     %%      %% Termination
<a name="16943"/>16943:     %%      #{desc =&gt; &quot;await terminate&quot;,
<a name="16944"/>16944:     %%        cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16945"/>16945:     %%                        case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16946"/>16946:     %%                            ok -&gt;
<a name="16947"/>16947:     %%                                {ok, maps:remove(tester, State)};
<a name="16948"/>16948:     %%                            {error, _} = ERROR -&gt;
<a name="16949"/>16949:     %%                                ERROR
<a name="16950"/>16950:     %%                        end
<a name="16951"/>16951:     %%                end},
<a name="16952"/>16952:     %%      #{desc =&gt; &quot;close connection socket&quot;,
<a name="16953"/>16953:     %%        cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="16954"/>16954:     %%                        ok = socket:close(Sock),
<a name="16955"/>16955:     %%                        {ok, maps:remove(csock, State)}
<a name="16956"/>16956:     %%                end},
<a name="16957"/>16957:     %%      #{desc =&gt; &quot;close listen socket&quot;,
<a name="16958"/>16958:     %%        cmd  =&gt; fun(#{domain := local,
<a name="16959"/>16959:     %%                      lsock  := Sock,
<a name="16960"/>16960:     %%                      lsa    := #{path := Path}} = State) -&gt;
<a name="16961"/>16961:     %%                        ok = socket:close(Sock),
<a name="16962"/>16962:     %%                        State1 =
<a name="16963"/>16963:     %%                            unlink_path(Path,
<a name="16964"/>16964:     %%                                        fun() -&gt;
<a name="16965"/>16965:     %%                                                maps:remove(lsa, State)
<a name="16966"/>16966:     %%                                        end,
<a name="16967"/>16967:     %%                                        fun() -&gt; State end),
<a name="16968"/>16968:     %%                        {ok, maps:remove(lsock, State1)}
<a name="16969"/>16969:     %%                end},
<a name="16970"/>16970: 
<a name="16971"/>16971:     %%      %% *** We are done ***
<a name="16972"/>16972:     %%      ?SEV_FINISH_NORMAL
<a name="16973"/>16973:     %%     ],
<a name="16974"/>16974: 
<a name="16975"/>16975: 
<a name="16976"/>16976:     %% ClientSeq =
<a name="16977"/>16977:     %%     [
<a name="16978"/>16978:     %%      %% *** Wait for start order part ***
<a name="16979"/>16979:     %%      #{desc =&gt; &quot;await start&quot;,
<a name="16980"/>16980:     %%        cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="16981"/>16981:     %%                        {Tester, Path} = ?SEV_AWAIT_START(),
<a name="16982"/>16982:     %%                        {ok, State#{tester    =&gt; Tester,
<a name="16983"/>16983:     %%                                    server_path =&gt; Path}}
<a name="16984"/>16984:     %%                end},
<a name="16985"/>16985:     %%      #{desc =&gt; &quot;monitor tester&quot;,
<a name="16986"/>16986:     %%        cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16987"/>16987:     %%                        _MRef = erlang:monitor(process, Tester),
<a name="16988"/>16988:     %%                        ok
<a name="16989"/>16989:     %%                end},
<a name="16990"/>16990: 
<a name="16991"/>16991: 
<a name="16992"/>16992:     %%      %% *** Init part ***
<a name="16993"/>16993:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="16994"/>16994:     %%        cmd  =&gt; fun(#{domain      := local = Domain,
<a name="16995"/>16995:     %%                      server_path := Path} = State) -&gt;
<a name="16996"/>16996:     %%                        LSA = which_local_socket_addr(Domain),
<a name="16997"/>16997:     %%                        SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="16998"/>16998:     %%                        {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="16999"/>16999:     %%                end},
<a name="17000"/>17000:     %%      #{desc =&gt; &quot;create node&quot;,
<a name="17001"/>17001:     %%        cmd  =&gt; fun(#{host := Host} = State) -&gt;
<a name="17002"/>17002:     %%     		   ?SEV_IPRINT(&quot;try create node on ~p&quot;, [Host]),
<a name="17003"/>17003:     %%                        case ?CT_PEER() of
<a name="17004"/>17004:     %%                            {ok, Peer, Node} -&gt;
<a name="17005"/>17005:     %%                                ?SEV_IPRINT(&quot;client node ~p started&quot;,
<a name="17006"/>17006:     %%                                            [Node]),
<a name="17007"/>17007:     %%                                {ok, State#{node =&gt; Node, peer =&gt; Peer}};
<a name="17008"/>17008:     %%                            {error, Reason} -&gt;
<a name="17009"/>17009:     %%                                {skip, Reason}
<a name="17010"/>17010:     %%                        end
<a name="17011"/>17011:     %%                end},
<a name="17012"/>17012:     %%       #{desc =&gt; &quot;monitor client node&quot;,
<a name="17013"/>17013:     %%        cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="17014"/>17014:     %%                        true = erlang:monitor_node(Node, true),
<a name="17015"/>17015:     %%                        ok
<a name="17016"/>17016:     %%                end},
<a name="17017"/>17017:     %%      #{desc =&gt; &quot;start remote client on client node&quot;,
<a name="17018"/>17018:     %%        cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="17019"/>17019:     %%                        Pid = api_opt_sock_peercred_tcp_client_start(Node),
<a name="17020"/>17020:     %%                        ?SEV_IPRINT(&quot;remote client ~p started&quot;, [Pid]),
<a name="17021"/>17021:     %%                        {ok, State#{rclient =&gt; Pid}}
<a name="17022"/>17022:     %%                end},
<a name="17023"/>17023:     %%      #{desc =&gt; &quot;monitor remote client&quot;,
<a name="17024"/>17024:     %%        cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="17025"/>17025:     %%                        _MRef = erlang:monitor(process, Pid),
<a name="17026"/>17026:     %%                        ok
<a name="17027"/>17027:     %%                end},
<a name="17028"/>17028:     %%      #{desc =&gt; &quot;order remote client to start&quot;,
<a name="17029"/>17029:     %%        cmd  =&gt; fun(#{rclient   := Client,
<a name="17030"/>17030:     %%                     proto      := Proto,
<a name="17031"/>17031:     %%                      server_sa := ServerSA}) -&gt;
<a name="17032"/>17032:     %%                        ?SEV_ANNOUNCE_START(Client, {Proto, ServerSA}),
<a name="17033"/>17033:     %%                        ok
<a name="17034"/>17034:     %%                end},
<a name="17035"/>17035:     %%      #{desc =&gt; &quot;await remote client ready&quot;,
<a name="17036"/>17036:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17037"/>17037:     %%                      rclient := Client} = _State) -&gt;
<a name="17038"/>17038:     %%                        ?SEV_AWAIT_READY(Client, rclient, init,
<a name="17039"/>17039:     %%                                         [{tester, Tester}])
<a name="17040"/>17040:     %%                end},
<a name="17041"/>17041:     %%      #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="17042"/>17042:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17043"/>17043:     %%                        ?SEV_ANNOUNCE_READY(Tester, init),
<a name="17044"/>17044:     %%                        ok
<a name="17045"/>17045:     %%                end},
<a name="17046"/>17046: 
<a name="17047"/>17047: 
<a name="17048"/>17048:     %%      %% The actual test
<a name="17049"/>17049:     %%      #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="17050"/>17050:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17051"/>17051:     %%                      rclient := Client} = State) -&gt;
<a name="17052"/>17052:     %%                        case ?SEV_AWAIT_CONTINUE(Tester, tester, connect,
<a name="17053"/>17053:     %%                                                 [{rclient, Client}]) of
<a name="17054"/>17054:     %%                            {ok, {ConTimeout, ConLimit}} -&gt;
<a name="17055"/>17055:     %%                                {ok, State#{connect_timeout =&gt; ConTimeout,
<a name="17056"/>17056:     %%                                            connect_limit   =&gt; ConLimit}};
<a name="17057"/>17057:     %%                            {error, _} = ERROR -&gt;
<a name="17058"/>17058:     %%                                ERROR
<a name="17059"/>17059:     %%                        end
<a name="17060"/>17060:     %%                end},
<a name="17061"/>17061:     %%      #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="17062"/>17062:     %%        cmd  =&gt; fun(#{rclient         := RClient,
<a name="17063"/>17063:     %%                      connect_timeout := ConTimeout,
<a name="17064"/>17064:     %%                      connect_limit   := ConLimit}) -&gt;
<a name="17065"/>17065:     %%                        ?SEV_ANNOUNCE_CONTINUE(RClient, connect,
<a name="17066"/>17066:     %%                                               {ConTimeout, ConLimit}),
<a name="17067"/>17067:     %%                        ok
<a name="17068"/>17068:     %%                end},
<a name="17069"/>17069:     %%      #{desc =&gt; &quot;await remote client ready (connect)&quot;,
<a name="17070"/>17070:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17071"/>17071:     %%                      rclient := RClient} = State) -&gt;
<a name="17072"/>17072:     %%                        case ?SEV_AWAIT_READY(RClient, rclient, connect,
<a name="17073"/>17073:     %%                                              [{tester, Tester}]) of
<a name="17074"/>17074:     %%                            {ok, ok = _Result} -&gt;
<a name="17075"/>17075:     %%                                {ok, maps:remove(connect_limit, State)};
<a name="17076"/>17076:     %%                            {ok, {error, {connect_limit_reached,R,L}}} -&gt;
<a name="17077"/>17077:     %%                                {skip,
<a name="17078"/>17078:     %%                                 ?SLIB:f(&quot;Connect limit reached ~w: ~w&quot;,
<a name="17079"/>17079:     %%                                        [L, R])};
<a name="17080"/>17080:     %%                            {ok, Result} -&gt;
<a name="17081"/>17081:     %%                                Result;
<a name="17082"/>17082:     %%                            {error, _} = ERROR -&gt;
<a name="17083"/>17083:     %%                                ERROR
<a name="17084"/>17084:     %%                        end
<a name="17085"/>17085:     %%                end},
<a name="17086"/>17086:     %%      #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="17087"/>17087:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17088"/>17088:     %%                        ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="17089"/>17089:     %%                        ok
<a name="17090"/>17090:     %%                end},
<a name="17091"/>17091: 
<a name="17092"/>17092:     %%      %% Termination
<a name="17093"/>17093:     %%      #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="17094"/>17094:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17095"/>17095:     %%                      rclient := RClient} = State) -&gt;
<a name="17096"/>17096:     %%                        case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="17097"/>17097:     %%                                                  [{rclient, RClient}]) of
<a name="17098"/>17098:     %%                            ok -&gt;
<a name="17099"/>17099:     %%                                {ok, maps:remove(tester, State)};
<a name="17100"/>17100:     %%                            {error, _} = ERROR -&gt;
<a name="17101"/>17101:     %%                                ERROR
<a name="17102"/>17102:     %%                        end
<a name="17103"/>17103:     %%                end},
<a name="17104"/>17104:     %%      #{desc =&gt; &quot;kill remote client&quot;,
<a name="17105"/>17105:     %%        cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="17106"/>17106:     %%                        ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="17107"/>17107:     %%                        ok
<a name="17108"/>17108:     %%                end},
<a name="17109"/>17109:     %%      #{desc =&gt; &quot;await remote client termination&quot;,
<a name="17110"/>17110:     %%        cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="17111"/>17111:     %%                        ?SEV_AWAIT_TERMINATION(Client),
<a name="17112"/>17112:     %%                        State1 = maps:remove(rclient, State),
<a name="17113"/>17113:     %%                        {ok, State1}
<a name="17114"/>17114:     %%                end},
<a name="17115"/>17115:     %%      #{desc =&gt; &quot;stop client node&quot;,
<a name="17116"/>17116:     %%        cmd  =&gt; fun(#{peer := Peer} = _State) -&gt;
<a name="17117"/>17117:     %%                        peer:stop(Peer)
<a name="17118"/>17118:     %%                end},
<a name="17119"/>17119:     %%      #{desc =&gt; &quot;await client node termination&quot;,
<a name="17120"/>17120:     %%        cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="17121"/>17121:     %%                        receive
<a name="17122"/>17122:     %%                            {nodedown, Node} -&gt;
<a name="17123"/>17123:     %%                                State1 = maps:remove(node_id, State),
<a name="17124"/>17124:     %%                                State2 = maps:remove(node,    State1),
<a name="17125"/>17125:     %%                                {ok, State2}
<a name="17126"/>17126:     %%                        end
<a name="17127"/>17127:     %%                end},
<a name="17128"/>17128: 
<a name="17129"/>17129:     %%      %% *** We are done ***
<a name="17130"/>17130:     %%      ?SEV_FINISH_NORMAL
<a name="17131"/>17131:     %%    ],
<a name="17132"/>17132: 
<a name="17133"/>17133:     %% TesterSeq =
<a name="17134"/>17134:     %%     [
<a name="17135"/>17135:     %%      %% *** Init part ***
<a name="17136"/>17136:     %%      #{desc =&gt; &quot;monitor server&quot;,
<a name="17137"/>17137:     %%        cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17138"/>17138:     %%                        _MRef = erlang:monitor(process, Server),
<a name="17139"/>17139:     %%                        ok
<a name="17140"/>17140:     %%                end},
<a name="17141"/>17141:     %%      #{desc =&gt; &quot;monitor client&quot;,
<a name="17142"/>17142:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17143"/>17143:     %%                        _MRef = erlang:monitor(process, Client),
<a name="17144"/>17144:     %%                        ok
<a name="17145"/>17145:     %%                end},
<a name="17146"/>17146:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="17147"/>17147:     %%        cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17148"/>17148:     %%                        LSA = which_local_socket_addr(Domain),
<a name="17149"/>17149:     %%                        {ok, State#{local_sa =&gt; LSA}}
<a name="17150"/>17150:     %%                end},
<a name="17151"/>17151:     %%      #{desc =&gt; &quot;order server start&quot;,
<a name="17152"/>17152:     %%        cmd  =&gt; fun(#{server  := Server,
<a name="17153"/>17153:     %%                      backlog := Backlog}) -&gt;
<a name="17154"/>17154:     %%                        ?SEV_ANNOUNCE_START(Server, Backlog),
<a name="17155"/>17155:     %%                        ok
<a name="17156"/>17156:     %%                end},
<a name="17157"/>17157:     %%      #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="17158"/>17158:     %%        cmd  =&gt; fun(#{server := Server, local_sa := LSA} = State) -&gt;
<a name="17159"/>17159:     %%                        {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="17160"/>17160:     %%                        ServerSA = LSA#{port =&gt; Port},
<a name="17161"/>17161:     %%                        {ok, State#{server_sa =&gt; ServerSA}}
<a name="17162"/>17162:     %%                end},
<a name="17163"/>17163:     %%      #{desc =&gt; &quot;order client start&quot;,
<a name="17164"/>17164:     %%        cmd  =&gt; fun(#{client    := Client,
<a name="17165"/>17165:     %%                      server_sa := ServerSA}) -&gt;
<a name="17166"/>17166:     %%                        ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="17167"/>17167:     %%                        ok
<a name="17168"/>17168:     %%                end},
<a name="17169"/>17169:     %%      #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="17170"/>17170:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17171"/>17171:     %%                        ?SEV_AWAIT_READY(Client, client, init),
<a name="17172"/>17172:     %%                        ok
<a name="17173"/>17173:     %%                end},
<a name="17174"/>17174: 
<a name="17175"/>17175: 
<a name="17176"/>17176:     %%      %% The actual test
<a name="17177"/>17177:     %%      %% The server accepts the connect from the client, announces
<a name="17178"/>17178:     %%      %% this to us (accept) and then attempts to get peercred.
<a name="17179"/>17179:     %%      #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="17180"/>17180:     %%        cmd  =&gt; fun(#{client        := Client,
<a name="17181"/>17181:     %%                      timeout       := Timeout,
<a name="17182"/>17182:     %%                      connect_limit := ConLimit} = _State) -&gt;
<a name="17183"/>17183:     %%                        ?SEV_ANNOUNCE_CONTINUE(Client, connect,
<a name="17184"/>17184:     %%                                               {Timeout, ConLimit}),
<a name="17185"/>17185:     %%                        ok
<a name="17186"/>17186:     %%                end},
<a name="17187"/>17187:     %%      #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="17188"/>17188:     %%        cmd  =&gt; fun(#{server := Server,
<a name="17189"/>17189:     %%                      client := Client} = _State) -&gt;
<a name="17190"/>17190:     %%                        case ?SEV_AWAIT_READY(Client, client, connect,
<a name="17191"/>17191:     %%                                              [{server, Server}]) of
<a name="17192"/>17192:     %%                            ok -&gt;
<a name="17193"/>17193:     %%                                ok;
<a name="17194"/>17194:     %%                            {error, _} = ERROR -&gt;
<a name="17195"/>17195:     %%                                ERROR
<a name="17196"/>17196:     %%                        end
<a name="17197"/>17197:     %%                end},
<a name="17198"/>17198:     %%      #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="17199"/>17199:     %%        cmd  =&gt; fun(#{server := Server,
<a name="17200"/>17200:     %%                      client := Client} = _State) -&gt;
<a name="17201"/>17201:     %%                        case ?SEV_AWAIT_READY(Server, server, accept,
<a name="17202"/>17202:     %%                                              [{client, Client}]) of
<a name="17203"/>17203:     %%                            ok -&gt;
<a name="17204"/>17204:     %%                                ok;
<a name="17205"/>17205:     %%                            {error, _} = ERROR -&gt;
<a name="17206"/>17206:     %%                                ERROR
<a name="17207"/>17207:     %%                        end
<a name="17208"/>17208:     %%                end},
<a name="17209"/>17209:     %%      #{desc =&gt; &quot;await server ready (peercred)&quot;,
<a name="17210"/>17210:     %%        cmd  =&gt; fun(#{server := Server,
<a name="17211"/>17211:     %%                      client := Client} = _State) -&gt;
<a name="17212"/>17212:     %%                        case ?SEV_AWAIT_READY(Server, server, peercred,
<a name="17213"/>17213:     %%                                              [{client, Client}]) of
<a name="17214"/>17214:     %%                            ok -&gt;
<a name="17215"/>17215:     %%                                ok;
<a name="17216"/>17216:     %%                            {error, _} = ERROR -&gt;
<a name="17217"/>17217:     %%                                ERROR
<a name="17218"/>17218:     %%                        end
<a name="17219"/>17219:     %%                end},
<a name="17220"/>17220: 
<a name="17221"/>17221: 
<a name="17222"/>17222:     %%      %% *** Terminate server ***
<a name="17223"/>17223:     %%      #{desc =&gt; &quot;order client terminate&quot;,
<a name="17224"/>17224:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17225"/>17225:     %%                        ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="17226"/>17226:     %%                        ok
<a name="17227"/>17227:     %%                end},
<a name="17228"/>17228:     %%      #{desc =&gt; &quot;await client down&quot;,
<a name="17229"/>17229:     %%        cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="17230"/>17230:     %%                        ?SEV_AWAIT_TERMINATION(Client),
<a name="17231"/>17231:     %%                        State1 = maps:remove(client,    State),
<a name="17232"/>17232:     %%                        {ok, State1}
<a name="17233"/>17233:     %%                end},
<a name="17234"/>17234:     %%      #{desc =&gt; &quot;order server terminate&quot;,
<a name="17235"/>17235:     %%        cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17236"/>17236:     %%                        ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="17237"/>17237:     %%                        ok
<a name="17238"/>17238:     %%                end},
<a name="17239"/>17239:     %%      #{desc =&gt; &quot;await server down&quot;,
<a name="17240"/>17240:     %%        cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="17241"/>17241:     %%                        ?SEV_AWAIT_TERMINATION(Server),
<a name="17242"/>17242:     %%                        State1 = maps:remove(server,    State),
<a name="17243"/>17243:     %%                        State2 = maps:remove(server_sa, State1),
<a name="17244"/>17244:     %%                        {ok, State2}
<a name="17245"/>17245:     %%                end},
<a name="17246"/>17246: 
<a name="17247"/>17247:     %%      %% *** We are done ***
<a name="17248"/>17248:     %%      ?SEV_FINISH_NORMAL
<a name="17249"/>17249:     %%     ],
<a name="17250"/>17250: 
<a name="17251"/>17251:     %% i(&quot;create server evaluator&quot;),
<a name="17252"/>17252:     %% ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="17253"/>17253:     %% Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="17254"/>17254: 
<a name="17255"/>17255:     %% i(&quot;create client evaluator&quot;),
<a name="17256"/>17256:     %% ClientInitState = #{host   =&gt; local_host(),
<a name="17257"/>17257:     %%                     domain =&gt; maps:get(domain, InitState)},
<a name="17258"/>17258:     %% Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="17259"/>17259: 
<a name="17260"/>17260:     %% i(&quot;create tester evaluator&quot;),
<a name="17261"/>17261:     %% TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="17262"/>17262:     %%                              client =&gt; Client#ev.pid},
<a name="17263"/>17263:     %% Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="17264"/>17264: 
<a name="17265"/>17265:     %% i(&quot;await evaluator(s)&quot;),
<a name="17266"/>17266:     %% ok = ?SEV_AWAIT_FINISH([Server, Client, Tester]).
<a name="17267"/>17267: 
<a name="17268"/>17268: 
<a name="17269"/>17269:     %% This should actually never be called (the conditions should cause a skip),
<a name="17270"/>17270:     %% but just to be on the safe side...
<a name="api_opt_sock_peercred_tcp-last_expr"/><a name="17271"/>17271:     skip.
<a name="17272"/>17272: 
<a name="17273"/>17273: 
<a name="17274"/>17274: <i>%% api_opt_sock_peercred_tcp_client_start(Node) -&gt;</i>
<a name="17275"/>17275: <i>%%     Self = self(),</i>
<a name="17276"/>17276: <i>%%     Fun  = fun() -&gt; api_opt_sock_peercred_tcp_client(Self) end,</i>
<a name="17277"/>17277: <i>%%     erlang:spawn(Node, Fun).</i>
<a name="17278"/>17278: 
<a name="17279"/>17279: <i>%% api_opt_sock_peercred_tcp_client(Parent) -&gt;</i>
<a name="17280"/>17280: <i>%%     api_opt_sock_peercred_tcp_client_init(Parent),</i>
<a name="17281"/>17281: <i>%%     {Proto, ServerSA} = api_opt_sock_peercred_tcp_client_await_start(Parent),</i>
<a name="17282"/>17282: <i>%%     Domain   = maps:get(family, ServerSA),</i>
<a name="17283"/>17283: <i>%%     api_opt_sock_peercred_tcp_client_announce_ready(Parent, init),</i>
<a name="17284"/>17284: <i>%%     api_opt_sock_peercred_tcp_client_await_continue(Parent, connect),</i>
<a name="17285"/>17285: <i>%%     Result = api_opt_sock_peercred_tcp_client_connect(Domain, Proto, ServerSA),</i>
<a name="17286"/>17286: <i>%%     ?SEV_IPRINT(&quot;result: ~p&quot;, [Result]),</i>
<a name="17287"/>17287: <i>%%     api_opt_sock_peercred_tcp_client_announce_ready(Parent, connect, Result),</i>
<a name="17288"/>17288: <i>%%     Reason = api_opt_sock_peercred_tcp_client_await_terminate(Parent),</i>
<a name="17289"/>17289: <i>%%     api_opt_sock_peercred_tcp_client_close(Result),</i>
<a name="17290"/>17290: <i>%%     exit(Reason).</i>
<a name="17291"/>17291: 
<a name="17292"/>17292: <i>%% api_opt_sock_peercred_tcp_client_init(Parent) -&gt;</i>
<a name="17293"/>17293: <i>%%     put(sname, &quot;rclient&quot;),</i>
<a name="17294"/>17294: <i>%%     _MRef = erlang:monitor(process, Parent),</i>
<a name="17295"/>17295: <i>%%     ok.</i>
<a name="17296"/>17296: 
<a name="17297"/>17297: <i>%% api_opt_sock_peercred_tcp_client_await_start(Parent) -&gt;</i>
<a name="17298"/>17298: <i>%%     ?SEV_AWAIT_START(Parent).</i>
<a name="17299"/>17299: 
<a name="17300"/>17300: <i>%% api_opt_sock_peercred_tcp_client_announce_ready(Parent, Slogan) -&gt;</i>
<a name="17301"/>17301: <i>%%     ?SEV_ANNOUNCE_READY(Parent, Slogan).</i>
<a name="17302"/>17302: <i>%% api_opt_sock_peercred_tcp_client_announce_ready(Parent, Slogan, Result) -&gt;</i>
<a name="17303"/>17303: <i>%%     ?SEV_ANNOUNCE_READY(Parent, Slogan, Result).</i>
<a name="17304"/>17304: 
<a name="17305"/>17305: <i>%% api_opt_sock_peercred_tcp_client_await_continue(Parent, Slogan) -&gt;</i>
<a name="17306"/>17306: <i>%%     case ?SEV_AWAIT_CONTINUE(Parent, parent, Slogan) of</i>
<a name="17307"/>17307: <i>%%         ok -&gt;</i>
<a name="17308"/>17308: <i>%%             ok;</i>
<a name="17309"/>17309: <i>%%         {ok, Extra} -&gt;</i>
<a name="17310"/>17310: <i>%%             Extra;</i>
<a name="17311"/>17311: <i>%%         {error, Reason} -&gt;</i>
<a name="17312"/>17312: <i>%%             exit({await_continue, Slogan, Reason})</i>
<a name="17313"/>17313: <i>%%     end.</i>
<a name="17314"/>17314: 
<a name="17315"/>17315: <i>%% api_opt_sock_peercred_tcp_client_await_terminate(Parent) -&gt;</i>
<a name="17316"/>17316: <i>%%     case ?SEV_AWAIT_TERMINATE(Parent, parent) of</i>
<a name="17317"/>17317: <i>%%         ok -&gt;</i>
<a name="17318"/>17318: <i>%%             ok;</i>
<a name="17319"/>17319: <i>%%         {error, Reason} -&gt;</i>
<a name="17320"/>17320: <i>%%             Reason</i>
<a name="17321"/>17321: <i>%%     end.</i>
<a name="17322"/>17322: 
<a name="17323"/>17323: <i>%% api_opt_sock_peercred_tcp_client_connect(Domain, Proto, ServerSA) -&gt;</i>
<a name="17324"/>17324: <i>%%     LSA  = which_local_socket_addr(Domain),</i>
<a name="17325"/>17325: <i>%%     Sock = case socket:open(Domain, stream, Proto) of</i>
<a name="17326"/>17326: <i>%%                {ok, S} -&gt;</i>
<a name="17327"/>17327: <i>%%                    S;</i>
<a name="17328"/>17328: <i>%%                {error, OReason} -&gt;</i>
<a name="17329"/>17329: <i>%%                    ?FAIL({open, OReason})</i>
<a name="17330"/>17330: <i>%%            end,</i>
<a name="17331"/>17331: <i>%%     case socket:bind(Sock, LSA) of</i>
<a name="17332"/>17332: <i>%%         ok -&gt;</i>
<a name="17333"/>17333: <i>%%             ok;</i>
<a name="17334"/>17334: <i>%%         {error, BReason} -&gt;</i>
<a name="17335"/>17335: <i>%%             (catch socket:close(Sock)),</i>
<a name="17336"/>17336: <i>%%             ?FAIL({bind, BReason})</i>
<a name="17337"/>17337: <i>%%     end,</i>
<a name="17338"/>17338: <i>%%     case socket:connect(Sock, ServerSA) of</i>
<a name="17339"/>17339: <i>%%         ok -&gt;</i>
<a name="17340"/>17340: <i>%%             {ok, Sock};</i>
<a name="17341"/>17341: <i>%%         {error, Reason} -&gt;</i>
<a name="17342"/>17342: <i>%%             (catch socket:close(Sock)),</i>
<a name="17343"/>17343: <i>%%             ?FAIL({connect, Reason})</i>
<a name="17344"/>17344: <i>%%     end.</i>
<a name="17345"/>17345: 
<a name="17346"/>17346: <i>%% api_opt_sock_peercred_tcp_client_close({ok, Sock}) -&gt;</i>
<a name="17347"/>17347: <i>%%     (catch socket:close(Sock));</i>
<a name="17348"/>17348: <i>%% api_opt_sock_peercred_tcp_client_close(_) -&gt;</i>
<a name="17349"/>17349: <i>%%     ok.</i>
<a name="17350"/>17350: 
<a name="17351"/>17351: 
<a name="17352"/>17352: 
<a name="17353"/>17353: 
<a name="17354"/>17354: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17355"/>17355: 
<a name="17356"/>17356: <i>%% Tests the 'PRIORITY' socket 'socket' option with IPv4 UDP:</i>
<a name="17357"/>17357: <i>%%</i>
<a name="17358"/>17358: <i>%%               socket:setopt(Sock, socket, priority, integer()).</i>
<a name="17359"/>17359: <i>%%</i>
<a name="17360"/>17360: <i>%%</i>
<a name="17361"/>17361: 
<a name="api_opt_sock_priority_udp4-1"/><a name="17362"/>17362: <b>api_opt_sock_priority_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17363"/>17363:     ?TT(?SECS(5)),
<a name="api_opt_sock_priority_udp4-last_expr"/><a name="17364"/>17364: <b>    tc_try</b>(api_opt_sock_priority_udp4,
<a name="17365"/>17365:            fun() -&gt; has_support_ipv4(), has_support_sock_priority() end,
<a name="17366"/>17366:            fun() -&gt;
<a name="17367"/>17367:                    Set  = fun(Sock, Value) -&gt;
<a name="17368"/>17368:                                   socket:setopt(Sock, socket, priority, Value)
<a name="17369"/>17369:                           end,
<a name="17370"/>17370:                    Get  = fun(Sock) -&gt;
<a name="17371"/>17371:                                   socket:getopt(Sock, socket, priority)
<a name="17372"/>17372:                           end,
<a name="17373"/>17373:                    InitState = #{domain =&gt; inet,
<a name="17374"/>17374:                                  type   =&gt; dgram,
<a name="17375"/>17375:                                  proto  =&gt; udp,
<a name="17376"/>17376:                                  set    =&gt; Set,
<a name="17377"/>17377:                                  get    =&gt; Get},
<a name="17378"/>17378:                    ok = api_opt_sock_priority(InitState)
<a name="17379"/>17379:            end).
<a name="17380"/>17380: 
<a name="17381"/>17381: 
<a name="17382"/>17382: 
<a name="17383"/>17383: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17384"/>17384: 
<a name="17385"/>17385: <i>%% Tests the 'PRIORITY' socket 'socket' option with IPv4 TCP:</i>
<a name="17386"/>17386: <i>%%</i>
<a name="17387"/>17387: <i>%%               socket:setopt(Sock, socket, priority, integer()).</i>
<a name="17388"/>17388: <i>%%</i>
<a name="17389"/>17389: <i>%%</i>
<a name="17390"/>17390: 
<a name="api_opt_sock_priority_tcp4-1"/><a name="17391"/>17391: <b>api_opt_sock_priority_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17392"/>17392:     ?TT(?SECS(5)),
<a name="api_opt_sock_priority_tcp4-last_expr"/><a name="17393"/>17393: <b>    tc_try</b>(api_opt_sock_priority_tcp4,
<a name="17394"/>17394:            fun() -&gt; has_support_ipv4(), has_support_sock_priority() end,
<a name="17395"/>17395:            fun() -&gt;
<a name="17396"/>17396:                    Set  = fun(Sock, Value) -&gt;
<a name="17397"/>17397:                                   socket:setopt(Sock, socket, priority, Value)
<a name="17398"/>17398:                           end,
<a name="17399"/>17399:                    Get  = fun(Sock) -&gt;
<a name="17400"/>17400:                                   socket:getopt(Sock, socket, priority)
<a name="17401"/>17401:                           end,
<a name="17402"/>17402:                    InitState = #{domain =&gt; inet,
<a name="17403"/>17403:                                  type   =&gt; stream,
<a name="17404"/>17404:                                  proto  =&gt; tcp,
<a name="17405"/>17405:                                  set    =&gt; Set,
<a name="17406"/>17406:                                  get    =&gt; Get},
<a name="17407"/>17407:                    ok = api_opt_sock_priority(InitState)
<a name="17408"/>17408:            end).
<a name="17409"/>17409: 
<a name="17410"/>17410: 
<a name="17411"/>17411: 
<a name="17412"/>17412: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17413"/>17413: 
<a name="api_opt_sock_priority-1"/><a name="17414"/>17414: <b>api_opt_sock_priority</b>(InitState) -&gt;
<a name="17415"/>17415:     Seq = 
<a name="17416"/>17416:         [
<a name="17417"/>17417:          #{desc =&gt; &quot;local address&quot;,
<a name="17418"/>17418:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17419"/>17419:                            LSA = which_local_socket_addr(Domain),
<a name="17420"/>17420:                            {ok, State#{lsa =&gt; LSA}}
<a name="17421"/>17421:                    end},
<a name="17422"/>17422: 
<a name="17423"/>17423:          #{desc =&gt; &quot;open socket&quot;,
<a name="17424"/>17424:            cmd  =&gt; fun(#{domain := Domain,
<a name="17425"/>17425:                          type   := Type,
<a name="17426"/>17426:                          proto  := Proto} = State) -&gt;
<a name="17427"/>17427:                            Sock = sock_open(Domain, Type, Proto),
<a name="17428"/>17428:                            {ok, State#{sock =&gt; Sock}}
<a name="17429"/>17429:                    end},
<a name="17430"/>17430:          #{desc =&gt; &quot;bind&quot;,
<a name="17431"/>17431:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="17432"/>17432:                            case sock_bind(Sock, LSA) of
<a name="17433"/>17433:                                ok -&gt;
<a name="17434"/>17434:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="17435"/>17435:                                    ok;
<a name="17436"/>17436:                                {error, Reason} = ERROR -&gt;
<a name="17437"/>17437:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="17438"/>17438:                                    ERROR
<a name="17439"/>17439:                            end
<a name="17440"/>17440:                    end},
<a name="17441"/>17441:          #{desc =&gt; &quot;get current (default) priority&quot;,
<a name="17442"/>17442:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="17443"/>17443:                            case Get(Sock) of
<a name="17444"/>17444:                                {ok, Prio} -&gt;
<a name="17445"/>17445:                                    ?SEV_IPRINT(&quot;(default) priority: ~p&quot;,
<a name="17446"/>17446:                                                [Prio]),
<a name="17447"/>17447:                                    {ok, State#{default =&gt; Prio}};
<a name="17448"/>17448:                                {error, Reason} = ERROR -&gt;
<a name="17449"/>17449:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="17450"/>17450:                                                &quot;priority:&quot;
<a name="17451"/>17451:                                                &quot;   ~p&quot;, [Reason]),
<a name="17452"/>17452:                                    ERROR
<a name="17453"/>17453:                            end
<a name="17454"/>17454:                    end},
<a name="17455"/>17455: 
<a name="17456"/>17456:          #{desc =&gt; &quot;change priority (to within non-root range)&quot;,
<a name="17457"/>17457:            cmd  =&gt; fun(#{sock    := Sock,
<a name="17458"/>17458:                          default := DefaultPrio,
<a name="17459"/>17459:                          set     := Set} = _State) -&gt;
<a name="17460"/>17460:                            NewPrio =
<a name="17461"/>17461:                                if
<a name="17462"/>17462:                                    (DefaultPrio =&lt; 0) andalso
<a name="17463"/>17463:                                    (DefaultPrio &lt; 6) -&gt;
<a name="17464"/>17464:                                        DefaultPrio+1;
<a name="17465"/>17465:                                    (DefaultPrio =:= 6) -&gt;
<a name="17466"/>17466:                                        DefaultPrio-1;
<a name="17467"/>17467:                                    true -&gt;
<a name="17468"/>17468:                                        3 % ...
<a name="17469"/>17469:                                end,
<a name="17470"/>17470:                            ?SEV_IPRINT(&quot;try set new priority (to ~p)&quot;,
<a name="17471"/>17471:                                        [NewPrio]),
<a name="17472"/>17472:                            case Set(Sock, NewPrio) of
<a name="17473"/>17473:                                ok -&gt;
<a name="17474"/>17474:                                    ?SEV_IPRINT(&quot;priority changed (to ~p)&quot;,
<a name="17475"/>17475:                                                [NewPrio]),
<a name="17476"/>17476:                                    ok;
<a name="17477"/>17477:                                {error, Reason} = ERROR -&gt;
<a name="17478"/>17478:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="17479"/>17479:                                                &quot;   ~p&quot;, [Reason]),
<a name="17480"/>17480:                                    ERROR
<a name="17481"/>17481:                            end
<a name="17482"/>17482:                    end},
<a name="17483"/>17483: 
<a name="17484"/>17484:          #{desc =&gt; &quot;change priority (to outside root-range)&quot;,
<a name="17485"/>17485:            cmd  =&gt; fun(#{sock := Sock,
<a name="17486"/>17486:                          set  := Set} = _State) -&gt;
<a name="17487"/>17487:                            NewPrio = 42,
<a name="17488"/>17488:                            ?SEV_IPRINT(&quot;try set new priority (to ~p)&quot;,
<a name="17489"/>17489:                                        [NewPrio]),
<a name="17490"/>17490:                            case Set(Sock, NewPrio) of
<a name="17491"/>17491:                                ok -&gt;
<a name="17492"/>17492:                                    ?SEV_IPRINT(&quot;priority changed (to ~p)&quot;,
<a name="17493"/>17493:                                                [NewPrio]),
<a name="17494"/>17494:                                    ok;
<a name="17495"/>17495:                                {error, eperm} -&gt;
<a name="17496"/>17496:                                    ?SEV_IPRINT(&quot;priority change not allowed&quot;),
<a name="17497"/>17497:                                    ok;
<a name="17498"/>17498:                                {error, Reason} = ERROR -&gt;
<a name="17499"/>17499:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="17500"/>17500:                                                &quot;   ~p&quot;, [Reason]),
<a name="17501"/>17501:                                    ERROR
<a name="17502"/>17502:                            end
<a name="17503"/>17503:                    end},
<a name="17504"/>17504: 
<a name="17505"/>17505:          #{desc =&gt; &quot;close socket&quot;,
<a name="17506"/>17506:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="17507"/>17507:                            ok = socket:close(Sock),
<a name="17508"/>17508:                            {ok, maps:remove(sock, State)}
<a name="17509"/>17509:                    end},
<a name="17510"/>17510: 
<a name="17511"/>17511:          %% *** We are done ***
<a name="17512"/>17512:          ?SEV_FINISH_NORMAL
<a name="17513"/>17513:         ],
<a name="17514"/>17514:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_priority-last_expr"/><a name="17515"/>17515: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="17516"/>17516: 
<a name="17517"/>17517: 
<a name="17518"/>17518: 
<a name="17519"/>17519: 
<a name="17520"/>17520: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17521"/>17521: 
<a name="17522"/>17522: <i>%% Tests the 'SNDBUF' socket 'socket' option with IPv4 UDP:</i>
<a name="17523"/>17523: <i>%%</i>
<a name="17524"/>17524: <i>%%               socket:setopt(Sock, socket, sndbuf, integer()).</i>
<a name="17525"/>17525: <i>%%</i>
<a name="17526"/>17526: <i>%%</i>
<a name="17527"/>17527: 
<a name="api_opt_sock_rcvbuf_udp4-1"/><a name="17528"/>17528: <b>api_opt_sock_rcvbuf_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17529"/>17529:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvbuf_udp4-last_expr"/><a name="17530"/>17530: <b>    tc_try</b>(api_opt_sock_rcvbuf_udp4,
<a name="17531"/>17531:            fun() -&gt; has_support_ipv4(), has_support_sock_rcvbuf() end,
<a name="17532"/>17532:            fun() -&gt;
<a name="17533"/>17533:                    ok = api_opt_sock_buf_udp4(rcvbuf)
<a name="17534"/>17534:            end).
<a name="17535"/>17535: 
<a name="17536"/>17536: 
<a name="17537"/>17537: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17538"/>17538: 
<a name="17539"/>17539: <i>%% Tests the 'RCVBUF' socket 'socket' option with IPv4 UDP:</i>
<a name="17540"/>17540: <i>%%</i>
<a name="17541"/>17541: <i>%%               socket:setopt(Sock, socket, rcvbuf, integer()).</i>
<a name="17542"/>17542: <i>%%</i>
<a name="17543"/>17543: <i>%%</i>
<a name="17544"/>17544: 
<a name="api_opt_sock_sndbuf_udp4-1"/><a name="17545"/>17545: <b>api_opt_sock_sndbuf_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17546"/>17546:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndbuf_udp4-last_expr"/><a name="17547"/>17547: <b>    tc_try</b>(api_opt_sock_sndbuf_udp4,
<a name="17548"/>17548:            fun() -&gt; has_support_ipv4(), has_support_sock_sndbuf() end,
<a name="17549"/>17549:            fun() -&gt;
<a name="17550"/>17550:                    ok = api_opt_sock_buf_udp4(sndbuf)
<a name="17551"/>17551:            end).
<a name="17552"/>17552: 
<a name="17553"/>17553: 
<a name="17554"/>17554: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17555"/>17555: 
<a name="api_opt_sock_buf_udp4-1"/><a name="17556"/>17556: <b>api_opt_sock_buf_udp4</b>(Opt) -&gt;
<a name="17557"/>17557:     Set  = fun(Sock, Value) -&gt;
<a name="17558"/>17558:                    socket:setopt(Sock, socket, Opt, Value)
<a name="17559"/>17559:            end,
<a name="17560"/>17560:     Get  = fun(Sock) -&gt;
<a name="17561"/>17561:                    socket:getopt(Sock, socket, Opt)
<a name="17562"/>17562:            end,
<a name="17563"/>17563:     InitState = #{domain =&gt; inet,
<a name="17564"/>17564:                   type   =&gt; dgram,
<a name="17565"/>17565:                   proto  =&gt; udp,
<a name="17566"/>17566:                   set    =&gt; Set,
<a name="17567"/>17567:                   get    =&gt; Get},
<a name="api_opt_sock_buf_udp4-last_expr"/><a name="17568"/>17568: <b>    ok = api_opt_sock_buf</b>(InitState).
<a name="17569"/>17569: 
<a name="17570"/>17570: 
<a name="api_opt_sock_buf-1"/><a name="17571"/>17571: <b>api_opt_sock_buf</b>(InitState) -&gt;
<a name="17572"/>17572:     Seq = 
<a name="17573"/>17573:         [
<a name="17574"/>17574:          #{desc =&gt; &quot;local address&quot;,
<a name="17575"/>17575:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17576"/>17576:                            LSA = which_local_socket_addr(Domain),
<a name="17577"/>17577:                            {ok, State#{lsa =&gt; LSA}}
<a name="17578"/>17578:                    end},
<a name="17579"/>17579: 
<a name="17580"/>17580:          #{desc =&gt; &quot;open socket&quot;,
<a name="17581"/>17581:            cmd  =&gt; fun(#{domain := Domain,
<a name="17582"/>17582:                          type   := Type,
<a name="17583"/>17583:                          proto  := Proto} = State) -&gt;
<a name="17584"/>17584:                            Sock = sock_open(Domain, Type, Proto),
<a name="17585"/>17585:                            {ok, State#{sock =&gt; Sock}}
<a name="17586"/>17586:                    end},
<a name="17587"/>17587:          #{desc =&gt; &quot;bind&quot;,
<a name="17588"/>17588:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="17589"/>17589:                            case sock_bind(Sock, LSA) of
<a name="17590"/>17590:                                ok -&gt;
<a name="17591"/>17591:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="17592"/>17592:                                    ok;
<a name="17593"/>17593:                                {error, Reason} = ERROR -&gt;
<a name="17594"/>17594:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="17595"/>17595:                                    ERROR
<a name="17596"/>17596:                            end
<a name="17597"/>17597:                    end},
<a name="17598"/>17598:          #{desc =&gt; &quot;get current (default) buffer size&quot;,
<a name="17599"/>17599:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="17600"/>17600:                            case Get(Sock) of
<a name="17601"/>17601:                                {ok, Sz} -&gt;
<a name="17602"/>17602:                                    ?SEV_IPRINT(&quot;(default) buffer: ~p&quot;,
<a name="17603"/>17603:                                                [Sz]),
<a name="17604"/>17604:                                    {ok, State#{default_sz =&gt; Sz}};
<a name="17605"/>17605:                                {error, Reason} = ERROR -&gt;
<a name="17606"/>17606:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="17607"/>17607:                                                &quot;buffer size:&quot;
<a name="17608"/>17608:                                                &quot;   ~p&quot;, [Reason]),
<a name="17609"/>17609:                                    ERROR
<a name="17610"/>17610:                            end
<a name="17611"/>17611:                    end},
<a name="17612"/>17612: 
<a name="17613"/>17613:          #{desc =&gt; &quot;change buffer size (default + 1024)&quot;,
<a name="17614"/>17614:            cmd  =&gt; fun(#{sock       := Sock,
<a name="17615"/>17615:                          default_sz := DefaultSz,
<a name="17616"/>17616:                          set        := Set} = State) -&gt;
<a name="17617"/>17617:                            NewSz = DefaultSz + 1024,
<a name="17618"/>17618:                            ?SEV_IPRINT(&quot;try set new buffer size to ~w&quot;, [NewSz]),
<a name="17619"/>17619:                            case Set(Sock, NewSz) of
<a name="17620"/>17620:                                ok -&gt;
<a name="17621"/>17621:                                    ?SEV_IPRINT(&quot;Buffer size change success&quot;, []),
<a name="17622"/>17622:                                    {ok, State#{new_sz =&gt; NewSz}};
<a name="17623"/>17623:                                {error, Reason} = ERROR -&gt;
<a name="17624"/>17624:                                    ?SEV_EPRINT(&quot;Failed changing buffer size:&quot;
<a name="17625"/>17625:                                                &quot;   ~p&quot;, [Reason]),
<a name="17626"/>17626:                                    ERROR
<a name="17627"/>17627:                            end
<a name="17628"/>17628:                    end},
<a name="17629"/>17629: 
<a name="17630"/>17630:          #{desc =&gt; &quot;validate buffer change&quot;,
<a name="17631"/>17631:            cmd  =&gt; fun(#{sock   := Sock,
<a name="17632"/>17632:                          get    := Get,
<a name="17633"/>17633:                          new_sz := ExpSz} = _State) -&gt;
<a name="17634"/>17634:                            ?SEV_IPRINT(&quot;try validate buffer size (~w)&quot;, [ExpSz]),
<a name="17635"/>17635:                            case Get(Sock) of
<a name="17636"/>17636:                                {ok, Sz} when (Sz &gt;= ExpSz) -&gt;
<a name="17637"/>17637:                                    ?SEV_IPRINT(&quot;buffer size validated:&quot;
<a name="17638"/>17638:                                                &quot;~n   Sz: ~w (~w)&quot;, [Sz, ExpSz]),
<a name="17639"/>17639:                                    ok;
<a name="17640"/>17640:                                {ok, Sz} -&gt;
<a name="17641"/>17641:                                    ?SEV_EPRINT(&quot;buffer size invalid:&quot;
<a name="17642"/>17642:                                                &quot;~n   Sz:          ~w&quot;
<a name="17643"/>17643:                                                &quot;~n   Expected Sz: ~w&quot;, [Sz, ExpSz]),
<a name="17644"/>17644:                                    {error, {invalid_size, Sz, ExpSz}};
<a name="17645"/>17645:                                {error, Reason} = ERROR -&gt;
<a name="17646"/>17646:                                    ?SEV_EPRINT(&quot;Failed get buffer size:&quot;
<a name="17647"/>17647:                                                &quot;   ~p&quot;, [Reason]),
<a name="17648"/>17648:                                    ERROR
<a name="17649"/>17649:                            end
<a name="17650"/>17650:                    end},
<a name="17651"/>17651: 
<a name="17652"/>17652:          #{desc =&gt; &quot;close socket&quot;,
<a name="17653"/>17653:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="17654"/>17654:                            ok = socket:close(Sock),
<a name="17655"/>17655:                            {ok, maps:remove(sock, State)}
<a name="17656"/>17656:                    end},
<a name="17657"/>17657: 
<a name="17658"/>17658:          %% *** We are done ***
<a name="17659"/>17659:          ?SEV_FINISH_NORMAL
<a name="17660"/>17660:         ],
<a name="17661"/>17661:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_buf-last_expr"/><a name="17662"/>17662: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="17663"/>17663: 
<a name="17664"/>17664: 
<a name="17665"/>17665: 
<a name="17666"/>17666: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17667"/>17667: 
<a name="17668"/>17668: <i>%% Tests the 'RCVTIMEO' socket 'socket' option with IPv4 UDP:</i>
<a name="17669"/>17669: <i>%%</i>
<a name="17670"/>17670: <i>%%               socket:setopt(Sock, socket, rcvtimeo, #{sec  =&gt; integer(),</i>
<a name="17671"/>17671: <i>%%                                                       usec =&gt; integer()}).</i>
<a name="17672"/>17672: <i>%%</i>
<a name="17673"/>17673: <i>%% We should really test that the receive behaves as expected,</i>
<a name="17674"/>17674: <i>%% but we don't (we just set the value and read it back...)</i>
<a name="17675"/>17675: <i>%%</i>
<a name="17676"/>17676: 
<a name="api_opt_sock_rcvtimeo_udp4-1"/><a name="17677"/>17677: <b>api_opt_sock_rcvtimeo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17678"/>17678:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvtimeo_udp4-last_expr"/><a name="17679"/>17679: <b>    tc_try</b>(api_opt_sock_rcvtimeo_udp4,
<a name="17680"/>17680:            fun() -&gt; has_support_ipv4(), has_support_sock_rcvtimeo() end,
<a name="17681"/>17681:            fun() -&gt;
<a name="17682"/>17682:                    ok = api_opt_sock_timeo_udp4(rcvtimeo)
<a name="17683"/>17683:            end).
<a name="17684"/>17684: 
<a name="17685"/>17685: 
<a name="17686"/>17686: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17687"/>17687: 
<a name="17688"/>17688: <i>%% Tests the 'SNDTIMEO' socket 'socket' option with IPv4 UDP:</i>
<a name="17689"/>17689: <i>%%</i>
<a name="17690"/>17690: <i>%%               socket:setopt(Sock, socket, sndtimeo, integer()).</i>
<a name="17691"/>17691: <i>%%</i>
<a name="17692"/>17692: <i>%%</i>
<a name="17693"/>17693: 
<a name="api_opt_sock_sndtimeo_udp4-1"/><a name="17694"/>17694: <b>api_opt_sock_sndtimeo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17695"/>17695:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndtimeo_udp4-last_expr"/><a name="17696"/>17696: <b>    tc_try</b>(api_opt_sock_sndtimeo_udp4,
<a name="17697"/>17697:            fun() -&gt; has_support_ipv4(), has_support_sock_sndtimeo() end,
<a name="17698"/>17698:            fun() -&gt;
<a name="17699"/>17699:                    ok = api_opt_sock_timeo_udp4(sndtimeo)
<a name="17700"/>17700:            end).
<a name="17701"/>17701: 
<a name="17702"/>17702: 
<a name="17703"/>17703: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17704"/>17704: 
<a name="api_opt_sock_timeo_udp4-1"/><a name="17705"/>17705: <b>api_opt_sock_timeo_udp4</b>(Opt) -&gt;
<a name="17706"/>17706:     Set  = fun(Sock, Value) -&gt;
<a name="17707"/>17707:                    socket:setopt(Sock, socket, Opt, Value)
<a name="17708"/>17708:            end,
<a name="17709"/>17709:     Get  = fun(Sock) -&gt;
<a name="17710"/>17710:                    socket:getopt(Sock, socket, Opt)
<a name="17711"/>17711:            end,
<a name="17712"/>17712:     InitState = #{domain =&gt; inet,
<a name="17713"/>17713:                   type   =&gt; dgram,
<a name="17714"/>17714:                   proto  =&gt; udp,
<a name="17715"/>17715: 		  opt   =&gt; Opt,
<a name="17716"/>17716:                   set    =&gt; Set,
<a name="17717"/>17717:                   get    =&gt; Get},
<a name="api_opt_sock_timeo_udp4-last_expr"/><a name="17718"/>17718: <b>    ok = api_opt_sock_timeo</b>(InitState).
<a name="17719"/>17719: 
<a name="17720"/>17720: 
<a name="api_opt_sock_timeo-1"/><a name="17721"/>17721: <b>api_opt_sock_timeo</b>(InitState) -&gt;
<a name="17722"/>17722:     Seq = 
<a name="17723"/>17723:         [
<a name="17724"/>17724:          #{desc =&gt; &quot;local address&quot;,
<a name="17725"/>17725:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17726"/>17726:                            LSA = which_local_socket_addr(Domain),
<a name="17727"/>17727:                            {ok, State#{lsa =&gt; LSA}}
<a name="17728"/>17728:                    end},
<a name="17729"/>17729: 
<a name="17730"/>17730:          #{desc =&gt; &quot;open socket&quot;,
<a name="17731"/>17731:            cmd  =&gt; fun(#{domain := Domain,
<a name="17732"/>17732:                          type   := Type,
<a name="17733"/>17733:                          proto  := Proto} = State) -&gt;
<a name="17734"/>17734:                            Sock = sock_open(Domain, Type, Proto),
<a name="17735"/>17735:                            {ok, State#{sock =&gt; Sock}}
<a name="17736"/>17736:                    end},
<a name="17737"/>17737:          #{desc =&gt; &quot;bind&quot;,
<a name="17738"/>17738:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="17739"/>17739:                            case sock_bind(Sock, LSA) of
<a name="17740"/>17740:                                ok -&gt;
<a name="17741"/>17741:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="17742"/>17742:                                    ok;
<a name="17743"/>17743:                                {error, Reason} = ERROR -&gt;
<a name="17744"/>17744:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="17745"/>17745:                                    ERROR
<a name="17746"/>17746:                            end
<a name="17747"/>17747:                    end},
<a name="17748"/>17748:          #{desc =&gt; &quot;get current (default) timeout&quot;,
<a name="17749"/>17749:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="17750"/>17750:                            case Get(Sock) of
<a name="17751"/>17751:                                {ok, #{sec := _, usec := _} = TO} -&gt;
<a name="17752"/>17752:                                    ?SEV_IPRINT(&quot;(default) timeout: ~p&quot;, [TO]),
<a name="17753"/>17753:                                    {ok, State#{default_timeo =&gt; TO}};
<a name="17754"/>17754:                                {error, enoprotoopt = Reason} -&gt;
<a name="17755"/>17755:                                    ?SEV_IPRINT(&quot;Failed getting (default) timeout:&quot;
<a name="17756"/>17756:                                                &quot;   ~p&quot;, [Reason]),
<a name="17757"/>17757:                                    {skip, Reason};
<a name="17758"/>17758:                                {error, Reason} = ERROR -&gt;
<a name="17759"/>17759:                                    ?SEV_EPRINT(&quot;Failed getting (default) timeout:&quot;
<a name="17760"/>17760:                                                &quot;   ~p&quot;, [Reason]),
<a name="17761"/>17761:                                    ERROR
<a name="17762"/>17762:                            end
<a name="17763"/>17763:                    end},
<a name="17764"/>17764: 
<a name="17765"/>17765:          #{desc =&gt; &quot;change timeout&quot;,
<a name="17766"/>17766:            cmd  =&gt; fun(#{sock          := Sock,
<a name="17767"/>17767:                          default_timeo := #{sec := DefaultSec} = DefaultTO,
<a name="17768"/>17768:                          set           := Set} = State) -&gt;
<a name="17769"/>17769:                            NewTO = DefaultTO#{sec =&gt; DefaultSec + 100},
<a name="17770"/>17770:                            ?SEV_IPRINT(&quot;try set new timeout to ~w&quot;, [NewTO]),
<a name="17771"/>17771:                            case Set(Sock, NewTO) of
<a name="17772"/>17772:                                ok -&gt;
<a name="17773"/>17773:                                    ?SEV_IPRINT(&quot;Timeout change success&quot;, []),
<a name="17774"/>17774:                                    {ok, State#{new_timeo =&gt; NewTO}};
<a name="17775"/>17775:                                {error, Reason} = ERROR -&gt;
<a name="17776"/>17776:                                    ?SEV_EPRINT(&quot;Failed changing timeout:&quot;
<a name="17777"/>17777:                                                &quot;   ~p&quot;, [Reason]),
<a name="17778"/>17778:                                    ERROR
<a name="17779"/>17779:                            end
<a name="17780"/>17780:                    end},
<a name="17781"/>17781: 
<a name="17782"/>17782:          #{desc =&gt; &quot;validate timeout change&quot;,
<a name="17783"/>17783:            cmd  =&gt; fun(#{sock      := Sock,
<a name="17784"/>17784:                          get       := Get,
<a name="17785"/>17785:                          new_timeo := #{sec := ExpSec} = ExpTO} = _State) -&gt;
<a name="17786"/>17786:                            ?SEV_IPRINT(&quot;try validate timeout (~w)&quot;, [ExpTO]),
<a name="17787"/>17787:                            case Get(Sock) of
<a name="17788"/>17788:                                {ok, ExpTO} -&gt;
<a name="17789"/>17789:                                    ?SEV_IPRINT(&quot;timeout (exactly) validated&quot;),
<a name="17790"/>17790:                                    ok;
<a name="17791"/>17791:                                {ok, #{sec := Sec}} when (ExpSec =:= Sec) -&gt;
<a name="17792"/>17792: 				   %% For some reason OpenBSD &quot;adjusts&quot; the timeout,
<a name="17793"/>17793: 				   %% so that usec does not (always match)
<a name="17794"/>17794:                                    ?SEV_IPRINT(&quot;timeout (approx) validated&quot;),
<a name="17795"/>17795:                                    ok;
<a name="17796"/>17796:                                {ok, TO} -&gt;
<a name="17797"/>17797:                                    ?SEV_EPRINT(&quot;timeout invalid:&quot;
<a name="17798"/>17798:                                                &quot;~n   Timeout:          ~w&quot;
<a name="17799"/>17799:                                                &quot;~n   Expected Timeout: ~w&quot;,
<a name="17800"/>17800:                                                [TO, ExpTO]),
<a name="17801"/>17801:                                    {error, {invalid_timeo, TO, ExpTO}};
<a name="17802"/>17802:                                {error, edom = Reason} -&gt;
<a name="17803"/>17803: 				   %% On OpenBSD (at least) its possible that if the value
<a name="17804"/>17804: 				   %% is too far &quot;out of bounds&quot;, this will be the result:
<a name="17805"/>17805: 				   %%
<a name="17806"/>17806: 				   %%     &quot;Numerical argument out of domain&quot;
<a name="17807"/>17807: 				   %%
<a name="17808"/>17808:                                    ?SEV_IPRINT(&quot;Failed get timeout:&quot;
<a name="17809"/>17809:                                                &quot;   ~p&quot;, [Reason]),
<a name="17810"/>17810:                                    {skip, Reason};
<a name="17811"/>17811:                                {error, Reason} = ERROR -&gt;
<a name="17812"/>17812:                                    ?SEV_EPRINT(&quot;Failed get timeout:&quot;
<a name="17813"/>17813:                                                &quot;   ~p&quot;, [Reason]),
<a name="17814"/>17814:                                    ERROR
<a name="17815"/>17815:                            end
<a name="17816"/>17816:                    end},
<a name="17817"/>17817: 
<a name="17818"/>17818:          #{desc =&gt; &quot;close socket&quot;,
<a name="17819"/>17819:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="17820"/>17820:                            ok = socket:close(Sock),
<a name="17821"/>17821:                            {ok, maps:remove(sock, State)}
<a name="17822"/>17822:                    end},
<a name="17823"/>17823: 
<a name="17824"/>17824:          %% *** We are done ***
<a name="17825"/>17825:          ?SEV_FINISH_NORMAL
<a name="17826"/>17826:         ],
<a name="17827"/>17827:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_timeo-last_expr"/><a name="17828"/>17828: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="17829"/>17829: 
<a name="17830"/>17830: 
<a name="17831"/>17831: 
<a name="17832"/>17832: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17833"/>17833: 
<a name="17834"/>17834: <i>%% Tests the 'RCVLOWAT' socket 'socket' option with IPv4 UDP:</i>
<a name="17835"/>17835: <i>%%</i>
<a name="17836"/>17836: <i>%%               socket:setopt(Sock, socket, rcvlowat, integer()).</i>
<a name="17837"/>17837: <i>%%</i>
<a name="17838"/>17838: <i>%%</i>
<a name="17839"/>17839: 
<a name="api_opt_sock_rcvlowat_udp4-1"/><a name="17840"/>17840: <b>api_opt_sock_rcvlowat_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17841"/>17841:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvlowat_udp4-last_expr"/><a name="17842"/>17842: <b>    tc_try</b>(api_opt_sock_rcvlowat_udp4,
<a name="17843"/>17843:            fun() -&gt;
<a name="17844"/>17844:                    is_not_windows(), % einval on Windows
<a name="17845"/>17845:                    has_support_ipv4(),
<a name="17846"/>17846:                    has_support_sock_rcvlowat()
<a name="17847"/>17847:            end,
<a name="17848"/>17848:            fun() -&gt;
<a name="17849"/>17849:                    ok = api_opt_sock_lowat_udp4(rcvlowat)
<a name="17850"/>17850:            end).
<a name="17851"/>17851: 
<a name="17852"/>17852: 
<a name="17853"/>17853: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17854"/>17854: 
<a name="17855"/>17855: <i>%% Tests the 'SNDLOWAT' socket 'socket' option with IPv4 UDP:</i>
<a name="17856"/>17856: <i>%%</i>
<a name="17857"/>17857: <i>%%               socket:setopt(Sock, socket, sndlowat, integer()).</i>
<a name="17858"/>17858: <i>%%</i>
<a name="17859"/>17859: <i>%% This is (currently) not changeable on linux (among others),</i>
<a name="17860"/>17860: <i>%% so we skip if we get ENOPROTOOPT when attempting a change.</i>
<a name="17861"/>17861: <i>%%</i>
<a name="17862"/>17862: 
<a name="api_opt_sock_sndlowat_udp4-1"/><a name="17863"/>17863: <b>api_opt_sock_sndlowat_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="17864"/>17864:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndlowat_udp4-last_expr"/><a name="17865"/>17865: <b>    tc_try</b>(api_opt_sock_sndlowat_udp4,
<a name="17866"/>17866:            fun() -&gt;
<a name="17867"/>17867:                    is_not_windows(), % einval on Windows
<a name="17868"/>17868:                    has_support_ipv4(),
<a name="17869"/>17869:                    has_support_sock_sndlowat()
<a name="17870"/>17870:            end,
<a name="17871"/>17871:            fun() -&gt;
<a name="17872"/>17872:                    ok = api_opt_sock_lowat_udp4(sndlowat)
<a name="17873"/>17873:            end).
<a name="17874"/>17874: 
<a name="17875"/>17875: 
<a name="17876"/>17876: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17877"/>17877: 
<a name="api_opt_sock_lowat_udp4-1"/><a name="17878"/>17878: <b>api_opt_sock_lowat_udp4</b>(Opt) -&gt;
<a name="17879"/>17879:     Set  = fun(Sock, Value) -&gt;
<a name="17880"/>17880:                    socket:setopt(Sock, socket, Opt, Value)
<a name="17881"/>17881:            end,
<a name="17882"/>17882:     Get  = fun(Sock) -&gt;
<a name="17883"/>17883:                    socket:getopt(Sock, socket, Opt)
<a name="17884"/>17884:            end,
<a name="17885"/>17885:     InitState = #{domain =&gt; inet,
<a name="17886"/>17886:                   type   =&gt; dgram,
<a name="17887"/>17887:                   proto  =&gt; udp,
<a name="17888"/>17888:                   set    =&gt; Set,
<a name="17889"/>17889:                   get    =&gt; Get},
<a name="api_opt_sock_lowat_udp4-last_expr"/><a name="17890"/>17890: <b>    ok = api_opt_sock_lowat</b>(InitState).
<a name="17891"/>17891: 
<a name="17892"/>17892: 
<a name="api_opt_sock_lowat-1"/><a name="17893"/>17893: <b>api_opt_sock_lowat</b>(InitState) -&gt;
<a name="17894"/>17894:     Seq = 
<a name="17895"/>17895:         [
<a name="17896"/>17896:          #{desc =&gt; &quot;local address&quot;,
<a name="17897"/>17897:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17898"/>17898:                            LSA = which_local_socket_addr(Domain),
<a name="17899"/>17899:                            {ok, State#{lsa =&gt; LSA}}
<a name="17900"/>17900:                    end},
<a name="17901"/>17901: 
<a name="17902"/>17902:          #{desc =&gt; &quot;open socket&quot;,
<a name="17903"/>17903:            cmd  =&gt; fun(#{domain := Domain,
<a name="17904"/>17904:                          type   := Type,
<a name="17905"/>17905:                          proto  := Proto} = State) -&gt;
<a name="17906"/>17906:                            Sock = sock_open(Domain, Type, Proto),
<a name="17907"/>17907:                            {ok, State#{sock =&gt; Sock}}
<a name="17908"/>17908:                    end},
<a name="17909"/>17909:          #{desc =&gt; &quot;bind&quot;,
<a name="17910"/>17910:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="17911"/>17911:                            case sock_bind(Sock, LSA) of
<a name="17912"/>17912:                                ok -&gt;
<a name="17913"/>17913:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="17914"/>17914:                                    ok;
<a name="17915"/>17915:                                {error, Reason} = ERROR -&gt;
<a name="17916"/>17916:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="17917"/>17917:                                    ERROR
<a name="17918"/>17918:                            end
<a name="17919"/>17919:                    end},
<a name="17920"/>17920:          #{desc =&gt; &quot;get current (default) lowat&quot;,
<a name="17921"/>17921:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="17922"/>17922:                            case Get(Sock) of
<a name="17923"/>17923:                                {ok, LOWAT} -&gt;
<a name="17924"/>17924:                                    ?SEV_IPRINT(&quot;(default) lowat: ~p&quot;,
<a name="17925"/>17925:                                                [LOWAT]),
<a name="17926"/>17926:                                    {ok, State#{default_lowat =&gt; LOWAT}};
<a name="17927"/>17927:                                {error, enoprotoopt = Reason} -&gt;
<a name="17928"/>17928:                                    ?SEV_IPRINT(&quot;Failed getting (default) lowat:&quot;
<a name="17929"/>17929:                                                &quot;   ~p&quot;, [Reason]),
<a name="17930"/>17930:                                    {skip, Reason};
<a name="17931"/>17931:                                {error, Reason} = ERROR -&gt;
<a name="17932"/>17932:                                    ?SEV_EPRINT(&quot;Failed getting (default) lowat:&quot;
<a name="17933"/>17933:                                                &quot;   ~p&quot;, [Reason]),
<a name="17934"/>17934:                                    ERROR
<a name="17935"/>17935:                            end
<a name="17936"/>17936:                    end},
<a name="17937"/>17937: 
<a name="17938"/>17938:          #{desc =&gt; &quot;change lowat ( + 1 )&quot;,
<a name="17939"/>17939:            cmd  =&gt; fun(#{sock          := Sock,
<a name="17940"/>17940:                          default_lowat := DefaultLOWAT,
<a name="17941"/>17941:                          set           := Set} = State) -&gt;
<a name="17942"/>17942:                            NewLOWAT = DefaultLOWAT + 1,
<a name="17943"/>17943:                            ?SEV_IPRINT(&quot;try set new lowat to ~w&quot;, [NewLOWAT]),
<a name="17944"/>17944:                            case Set(Sock, NewLOWAT) of
<a name="17945"/>17945:                                ok -&gt;
<a name="17946"/>17946:                                    ?SEV_IPRINT(&quot;LOWAT change success&quot;, []),
<a name="17947"/>17947:                                    {ok, State#{new_lowat =&gt; NewLOWAT}};
<a name="17948"/>17948:                                {error, enoprotoopt} -&gt;
<a name="17949"/>17949:                                    ?SEV_IPRINT(&quot;LOWAT not changeable&quot;, []),
<a name="17950"/>17950:                                    {skip, &quot;Not changeable&quot;};
<a name="17951"/>17951:                                {error, Reason} = ERROR -&gt;
<a name="17952"/>17952:                                    ?SEV_EPRINT(&quot;Failed changing buffer size:&quot;
<a name="17953"/>17953:                                                &quot;   ~p&quot;, [Reason]),
<a name="17954"/>17954:                                    ERROR
<a name="17955"/>17955:                            end
<a name="17956"/>17956:                    end},
<a name="17957"/>17957: 
<a name="17958"/>17958:          #{desc =&gt; &quot;validate lowat&quot;,
<a name="17959"/>17959:            cmd  =&gt; fun(#{sock      := Sock,
<a name="17960"/>17960:                          get       := Get,
<a name="17961"/>17961:                          new_lowat := ExpLOWAT} = _State) -&gt;
<a name="17962"/>17962:                            ?SEV_IPRINT(&quot;try validate lowat (~w)&quot;, [ExpLOWAT]),
<a name="17963"/>17963:                            case Get(Sock) of
<a name="17964"/>17964:                                {ok, ExpLOWAT} -&gt;
<a name="17965"/>17965:                                    ?SEV_IPRINT(&quot;lowat validated:&quot;
<a name="17966"/>17966:                                                &quot;~n   LOWAT: ~w&quot;, [ExpLOWAT]),
<a name="17967"/>17967:                                    ok;
<a name="17968"/>17968:                                {ok, LOWAT} -&gt;
<a name="17969"/>17969:                                    ?SEV_EPRINT(&quot;lowat invalid:&quot;
<a name="17970"/>17970:                                                &quot;~n   LOWAT:          ~w&quot;
<a name="17971"/>17971:                                                &quot;~n   Expected LOWAT: ~w&quot;,
<a name="17972"/>17972:                                                [LOWAT, ExpLOWAT]),
<a name="17973"/>17973:                                    {error, {invalid_lowat, LOWAT, ExpLOWAT}};
<a name="17974"/>17974:                                {error, Reason} = ERROR -&gt;
<a name="17975"/>17975:                                    ?SEV_EPRINT(&quot;Failed get lowat:&quot;
<a name="17976"/>17976:                                                &quot;   ~p&quot;, [Reason]),
<a name="17977"/>17977:                                    ERROR
<a name="17978"/>17978:                            end
<a name="17979"/>17979:                    end},
<a name="17980"/>17980: 
<a name="17981"/>17981:          #{desc =&gt; &quot;close socket&quot;,
<a name="17982"/>17982:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="17983"/>17983:                            ok = socket:close(Sock),
<a name="17984"/>17984:                            {ok, maps:remove(sock, State)}
<a name="17985"/>17985:                    end},
<a name="17986"/>17986: 
<a name="17987"/>17987:          %% *** We are done ***
<a name="17988"/>17988:          ?SEV_FINISH_NORMAL
<a name="17989"/>17989:         ],
<a name="17990"/>17990:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_lowat-last_expr"/><a name="17991"/>17991: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="17992"/>17992: 
<a name="17993"/>17993: 
<a name="17994"/>17994: 
<a name="17995"/>17995: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17996"/>17996: 
<a name="17997"/>17997: <i>%% Tests that the timestamp control message header is received when</i>
<a name="17998"/>17998: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="17999"/>17999: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="18000"/>18000: <i>%% So, this is done on the receiving side: </i>
<a name="18001"/>18001: <i>%%</i>
<a name="18002"/>18002: <i>%%               socket:setopt(Sock, socket, timestamp, boolean()).</i>
<a name="18003"/>18003: <i>%%</i>
<a name="18004"/>18004: <i>%% All subsequent *received* messages will be timestamped.</i>
<a name="18005"/>18005: <i>%%</i>
<a name="18006"/>18006: 
<a name="api_opt_sock_timestamp_udp4-1"/><a name="18007"/>18007: <b>api_opt_sock_timestamp_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18008"/>18008:     ?TT(?SECS(5)),
<a name="api_opt_sock_timestamp_udp4-last_expr"/><a name="18009"/>18009: <b>    tc_try</b>(api_opt_sock_timestamp_udp4,
<a name="18010"/>18010:            fun() -&gt; has_support_ipv4(), has_support_sock_timestamp() end,
<a name="18011"/>18011:            fun() -&gt;
<a name="18012"/>18012:                    Set  = fun(Sock, Value) -&gt;
<a name="18013"/>18013:                                   socket:setopt(Sock, socket, timestamp, Value)
<a name="18014"/>18014:                           end,
<a name="18015"/>18015:                    Get  = fun(Sock) -&gt;
<a name="18016"/>18016:                                   socket:getopt(Sock, socket, timestamp)
<a name="18017"/>18017:                           end,
<a name="18018"/>18018:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="18019"/>18019:                                   Msg = #{addr =&gt; Dest,
<a name="18020"/>18020:                                              iov  =&gt; [Data]},
<a name="18021"/>18021:                                   socket:sendmsg(Sock, Msg)
<a name="18022"/>18022:                           end,
<a name="18023"/>18023:                    Recv = fun(Sock) -&gt;
<a name="18024"/>18024:                                   case socket:recvmsg(Sock) of
<a name="18025"/>18025:                                       {ok, #{addr := Source,
<a name="18026"/>18026:                                              ctrl := CMsgs,
<a name="18027"/>18027:                                              iov  := [Data]}} -&gt;
<a name="18028"/>18028:                                           {ok, {Source, CMsgs, Data}};
<a name="18029"/>18029:                                       {error, _} = ERROR -&gt;
<a name="18030"/>18030:                                           ERROR
<a name="18031"/>18031:                                   end
<a name="18032"/>18032:                           end,
<a name="18033"/>18033:                    InitState = #{domain =&gt; inet,
<a name="18034"/>18034:                                  proto  =&gt; udp,
<a name="18035"/>18035:                                  send   =&gt; Send,
<a name="18036"/>18036:                                  recv   =&gt; Recv,
<a name="18037"/>18037:                                  set    =&gt; Set,
<a name="18038"/>18038:                                  get    =&gt; Get},
<a name="18039"/>18039:                    ok = api_opt_sock_timestamp_udp(InitState)
<a name="18040"/>18040:            end).
<a name="18041"/>18041: 
<a name="18042"/>18042: 
<a name="18043"/>18043: 
<a name="18044"/>18044: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18045"/>18045: 
<a name="api_opt_sock_timestamp_udp-1"/><a name="18046"/>18046: <b>api_opt_sock_timestamp_udp</b>(InitState) -&gt;
<a name="18047"/>18047:     Seq = 
<a name="18048"/>18048:         [
<a name="18049"/>18049:          #{desc =&gt; &quot;local address&quot;,
<a name="18050"/>18050:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="18051"/>18051:                            LSASrc = which_local_socket_addr(Domain),
<a name="18052"/>18052:                            LSADst = which_local_socket_addr(Domain),
<a name="18053"/>18053:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="18054"/>18054:                                        lsa_dst =&gt; LSADst}};
<a name="18055"/>18055:                       (#{domain := Domain} = State) -&gt;
<a name="18056"/>18056:                            LSA = which_local_socket_addr(Domain),
<a name="18057"/>18057:                            {ok, State#{lsa_src =&gt; LSA,
<a name="18058"/>18058:                                        lsa_dst =&gt; LSA}}
<a name="18059"/>18059:                    end},
<a name="18060"/>18060: 
<a name="18061"/>18061:          #{desc =&gt; &quot;open src socket&quot;,
<a name="18062"/>18062:            cmd  =&gt; fun(#{domain := Domain,
<a name="18063"/>18063:                          proto  := Proto} = State) -&gt;
<a name="18064"/>18064:                            Sock = sock_open(Domain, dgram, Proto),
<a name="18065"/>18065:                            {ok, State#{sock_src =&gt; Sock}}
<a name="18066"/>18066:                    end},
<a name="18067"/>18067:          #{desc =&gt; &quot;bind src&quot;,
<a name="18068"/>18068:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="18069"/>18069:                            case sock_bind(Sock, LSA) of
<a name="18070"/>18070:                                ok -&gt;
<a name="18071"/>18071:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="18072"/>18072:                                    ok;
<a name="18073"/>18073:                                {error, Reason} = ERROR -&gt;
<a name="18074"/>18074:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="18075"/>18075:                                    ERROR
<a name="18076"/>18076:                            end
<a name="18077"/>18077:                    end},
<a name="18078"/>18078:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="18079"/>18079:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="18080"/>18080:                            SASrc = sock_sockname(Sock),
<a name="18081"/>18081:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="18082"/>18082:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="18083"/>18083:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="18084"/>18084:                    end},
<a name="18085"/>18085:          #{desc =&gt; &quot;get current (default) timestamp for src socket&quot;,
<a name="18086"/>18086:            cmd  =&gt; fun(#{sock_src := Sock, get := Get} = _State) -&gt;
<a name="18087"/>18087:                            case Get(Sock) of
<a name="18088"/>18088:                                {ok, false = Value} -&gt;
<a name="18089"/>18089:                                    ?SEV_IPRINT(&quot;src timestamp: ~p&quot;, [Value]),
<a name="18090"/>18090:                                    ok;
<a name="18091"/>18091:                                {ok, Unexpected} -&gt;
<a name="18092"/>18092:                                    ?SEV_EPRINT(&quot;Unexpected src timestamp: ~p&quot;,
<a name="18093"/>18093:                                                [Unexpected]),
<a name="18094"/>18094:                                    {error, {unexpected, Unexpected}};
<a name="18095"/>18095:                                {error, Reason} = ERROR -&gt;
<a name="18096"/>18096:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="18097"/>18097:                                                &quot;   ~p&quot;, [Reason]),
<a name="18098"/>18098:                                    ERROR
<a name="18099"/>18099:                            end
<a name="18100"/>18100:                    end},
<a name="18101"/>18101: 
<a name="18102"/>18102:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="18103"/>18103:            cmd  =&gt; fun(#{domain := Domain,
<a name="18104"/>18104:                          proto  := Proto} = State) -&gt;
<a name="18105"/>18105:                            Sock = sock_open(Domain, dgram, Proto),
<a name="18106"/>18106:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="18107"/>18107:                    end},
<a name="18108"/>18108:          #{desc =&gt; &quot;bind dst&quot;,
<a name="18109"/>18109:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="18110"/>18110:                            case sock_bind(Sock, LSA) of
<a name="18111"/>18111:                                ok -&gt;
<a name="18112"/>18112:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="18113"/>18113:                                    ok;
<a name="18114"/>18114:                                {error, Reason} = ERROR -&gt;
<a name="18115"/>18115:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="18116"/>18116:                                    ERROR
<a name="18117"/>18117:                            end
<a name="18118"/>18118:                    end},
<a name="18119"/>18119:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="18120"/>18120:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="18121"/>18121:                            SADst = sock_sockname(Sock),
<a name="18122"/>18122:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="18123"/>18123:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="18124"/>18124:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="18125"/>18125:                    end},
<a name="18126"/>18126: 
<a name="18127"/>18127:          #{desc =&gt; &quot;send req (to dst) (WO TIMESTAMP)&quot;,
<a name="18128"/>18128:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="18129"/>18129:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="18130"/>18130:                    end},
<a name="18131"/>18131:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="18132"/>18132:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="18133"/>18133:                            case Recv(Sock) of
<a name="18134"/>18134:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="18135"/>18135:                                    ok;
<a name="18136"/>18136:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="18137"/>18137:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="18138"/>18138:                                                &quot;~n   Expect Source: ~p&quot;
<a name="18139"/>18139:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="18140"/>18140:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="18141"/>18141:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="18142"/>18142:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="18143"/>18143:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="18144"/>18144:                                                [Src, BadSrc,
<a name="18145"/>18145:                                                 [], BadCHdrs,
<a name="18146"/>18146:                                                 ?BASIC_REQ, BadReq]),
<a name="18147"/>18147:                                    {error, {unexpected_data, UnexpData}};
<a name="18148"/>18148:                                {ok, UnexpData} -&gt;
<a name="18149"/>18149:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="18150"/>18150:                                                &quot;~n   Expect Source: ~p&quot;
<a name="18151"/>18151:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="18152"/>18152:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="18153"/>18153:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="18154"/>18154:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="18155"/>18155:                                    {error, {unexpected_data, UnexpData}};
<a name="18156"/>18156:                                {error, _} = ERROR -&gt;
<a name="18157"/>18157:                                    %% At the moment there is no way to get
<a name="18158"/>18158:                                    %% status or state for the socket...
<a name="18159"/>18159:                                    ERROR
<a name="18160"/>18160:                            end
<a name="18161"/>18161:                    end},
<a name="18162"/>18162:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="18163"/>18163:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="18164"/>18164:                            Send(Sock, ?BASIC_REP, Src)
<a name="18165"/>18165:                    end},
<a name="18166"/>18166:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="18167"/>18167:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="18168"/>18168:                            case Recv(Sock) of
<a name="18169"/>18169:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="18170"/>18170:                                    ok;
<a name="18171"/>18171:                                {ok, UnexpData} -&gt;
<a name="18172"/>18172:                                    {error, {unexpected_data, UnexpData}};
<a name="18173"/>18173:                                {error, _} = ERROR -&gt;
<a name="18174"/>18174:                                    %% At the moment there is no way to get
<a name="18175"/>18175:                                    %% status or state for the socket...
<a name="18176"/>18176:                                    ERROR
<a name="18177"/>18177:                            end
<a name="18178"/>18178:                    end},
<a name="18179"/>18179: 
<a name="18180"/>18180: 
<a name="18181"/>18181:          #{desc =&gt; &quot;enable timestamp on dst socket&quot;,
<a name="18182"/>18182:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="18183"/>18183:                            case Set(Sock, true) of
<a name="18184"/>18184:                                ok -&gt;
<a name="18185"/>18185:                                    ?SEV_IPRINT(&quot;dst timestamp enabled&quot;),
<a name="18186"/>18186:                                    ok;
<a name="18187"/>18187:                                {error, Reason} = ERROR -&gt;
<a name="18188"/>18188:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="18189"/>18189:                                                &quot;   ~p&quot;, [Reason]),
<a name="18190"/>18190:                                    ERROR
<a name="18191"/>18191:                            end
<a name="18192"/>18192:                    end},
<a name="18193"/>18193: 
<a name="18194"/>18194: 
<a name="18195"/>18195:          #{desc =&gt; &quot;send req 1 (to dst) (W TIMESTAMP)&quot;,
<a name="18196"/>18196:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="18197"/>18197:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="18198"/>18198:                    end},
<a name="18199"/>18199:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="18200"/>18200:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="18201"/>18201:                            case Recv(Sock) of
<a name="18202"/>18202:                                {ok, {Src, [#{level := socket,
<a name="18203"/>18203:                                              type  := timestamp,
<a name="18204"/>18204:                                              value := TS}], ?BASIC_REQ}} -&gt;
<a name="18205"/>18205:                                    ?SEV_IPRINT(&quot;received req *with* &quot;
<a name="18206"/>18206:                                                &quot;expected timestamp: &quot;
<a name="18207"/>18207:                                                &quot;~n   ~p&quot;, [TS]),
<a name="18208"/>18208:                                    ok;
<a name="18209"/>18209:                                {ok, {Src, CMsgs, ?BASIC_REQ}} -&gt;
<a name="18210"/>18210:                                    ?SEV_EPRINT(&quot;Unexpected control message(s):&quot;
<a name="18211"/>18211:                                                &quot;~n   CMsgs: ~p&quot;,
<a name="18212"/>18212:                                                [CMsgs]),
<a name="18213"/>18213:                                    {error, {unexpected_cmsgs, CMsgs}};
<a name="18214"/>18214:                                {ok, UnexpData} -&gt;
<a name="18215"/>18215:                                    {error, {unexpected_data, UnexpData}};
<a name="18216"/>18216:                                {error, _} = ERROR -&gt;
<a name="18217"/>18217:                                    %% At the moment there is no way to get
<a name="18218"/>18218:                                    %% status or state for the socket...
<a name="18219"/>18219:                                    ERROR
<a name="18220"/>18220:                            end
<a name="18221"/>18221:                    end},
<a name="18222"/>18222:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="18223"/>18223:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="18224"/>18224:                            Send(Sock, ?BASIC_REP, Src)
<a name="18225"/>18225:                    end},
<a name="18226"/>18226:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="18227"/>18227:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="18228"/>18228:                            case Recv(Sock) of
<a name="18229"/>18229:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="18230"/>18230:                                    ok;
<a name="18231"/>18231:                                {ok, UnexpData} -&gt;
<a name="18232"/>18232:                                    {error, {unexpected_data, UnexpData}};
<a name="18233"/>18233:                                {error, _} = ERROR -&gt;
<a name="18234"/>18234:                                    %% At the moment there is no way to get
<a name="18235"/>18235:                                    %% status or state for the socket...
<a name="18236"/>18236:                                    ERROR
<a name="18237"/>18237:                            end
<a name="18238"/>18238:                    end},
<a name="18239"/>18239: 
<a name="18240"/>18240: 
<a name="18241"/>18241:          #{desc =&gt; &quot;send req 2 (to dst) (W TIMESTAMP)&quot;,
<a name="18242"/>18242:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="18243"/>18243:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="18244"/>18244:                    end},
<a name="18245"/>18245:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="18246"/>18246:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="18247"/>18247:                            case Recv(Sock) of
<a name="18248"/>18248:                                {ok, {Src, [#{level := socket,
<a name="18249"/>18249:                                              type  := timestamp,
<a name="18250"/>18250:                                              value := TS}], ?BASIC_REQ}} -&gt;
<a name="18251"/>18251:                                    ?SEV_IPRINT(&quot;received req *with* &quot;
<a name="18252"/>18252:                                                &quot;expected timestamp: &quot;
<a name="18253"/>18253:                                                &quot;~n   ~p&quot;, [TS]),
<a name="18254"/>18254:                                    ok;
<a name="18255"/>18255:                                {ok, UnexpData} -&gt;
<a name="18256"/>18256:                                    {error, {unexpected_data, UnexpData}};
<a name="18257"/>18257:                                {error, _} = ERROR -&gt;
<a name="18258"/>18258:                                    %% At the moment there is no way to get
<a name="18259"/>18259:                                    %% status or state for the socket...
<a name="18260"/>18260:                                    ERROR
<a name="18261"/>18261:                            end
<a name="18262"/>18262:                    end},
<a name="18263"/>18263:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="18264"/>18264:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="18265"/>18265:                            Send(Sock, ?BASIC_REP, Src)
<a name="18266"/>18266:                    end},
<a name="18267"/>18267:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="18268"/>18268:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="18269"/>18269:                            case Recv(Sock) of
<a name="18270"/>18270:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="18271"/>18271:                                    ok;
<a name="18272"/>18272:                                {ok, UnexpData} -&gt;
<a name="18273"/>18273:                                    {error, {unexpected_data, UnexpData}};
<a name="18274"/>18274:                                {error, _} = ERROR -&gt;
<a name="18275"/>18275:                                    %% At the moment there is no way to get
<a name="18276"/>18276:                                    %% status or state for the socket...
<a name="18277"/>18277:                                    ERROR
<a name="18278"/>18278:                            end
<a name="18279"/>18279:                    end},
<a name="18280"/>18280: 
<a name="18281"/>18281: 
<a name="18282"/>18282:          #{desc =&gt; &quot;disable timestamps on dst socket&quot;,
<a name="18283"/>18283:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="18284"/>18284:                            case Set(Sock, false) of
<a name="18285"/>18285:                                ok -&gt;
<a name="18286"/>18286:                                    ?SEV_IPRINT(&quot;dst timestamp disabled&quot;),
<a name="18287"/>18287:                                    ok;
<a name="18288"/>18288:                                {error, Reason} = ERROR -&gt;
<a name="18289"/>18289:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="18290"/>18290:                                                &quot;   ~p&quot;, [Reason]),
<a name="18291"/>18291:                                    ERROR
<a name="18292"/>18292:                            end
<a name="18293"/>18293:                    end},
<a name="18294"/>18294: 
<a name="18295"/>18295: 
<a name="18296"/>18296:          #{desc =&gt; &quot;send req (to dst) (WO TIMESTAMP)&quot;,
<a name="18297"/>18297:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="18298"/>18298:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="18299"/>18299:                    end},
<a name="18300"/>18300:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="18301"/>18301:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="18302"/>18302:                            case Recv(Sock) of
<a name="18303"/>18303:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="18304"/>18304:                                    ?SEV_IPRINT(&quot;received req *without* timestamp&quot;),
<a name="18305"/>18305:                                    ok;
<a name="18306"/>18306:                                {ok, UnexpData} -&gt;
<a name="18307"/>18307:                                    {error, {unexpected_data, UnexpData}};
<a name="18308"/>18308:                                {error, _} = ERROR -&gt;
<a name="18309"/>18309:                                    %% At the moment there is no way to get
<a name="18310"/>18310:                                    %% status or state for the socket...
<a name="18311"/>18311:                                    ERROR
<a name="18312"/>18312:                            end
<a name="18313"/>18313:                    end},
<a name="18314"/>18314:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="18315"/>18315:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="18316"/>18316:                            Send(Sock, ?BASIC_REP, Src)
<a name="18317"/>18317:                    end},
<a name="18318"/>18318:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="18319"/>18319:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="18320"/>18320:                            case Recv(Sock) of
<a name="18321"/>18321:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="18322"/>18322:                                    ok;
<a name="18323"/>18323:                                {ok, UnexpData} -&gt;
<a name="18324"/>18324:                                    {error, {unexpected_data, UnexpData}};
<a name="18325"/>18325:                                {error, _} = ERROR -&gt;
<a name="18326"/>18326:                                    %% At the moment there is no way to get
<a name="18327"/>18327:                                    %% status or state for the socket...
<a name="18328"/>18328:                                    ERROR
<a name="18329"/>18329:                            end
<a name="18330"/>18330:                    end},
<a name="18331"/>18331: 
<a name="18332"/>18332: 
<a name="18333"/>18333:          #{desc =&gt; &quot;close src socket&quot;,
<a name="18334"/>18334:            cmd  =&gt; fun(#{domain   := local,
<a name="18335"/>18335:                          sock_src := Sock,
<a name="18336"/>18336:                          lsa_src  := #{path := Path}} = State) -&gt;
<a name="18337"/>18337:                            ok = socket:close(Sock),
<a name="18338"/>18338:                            State1 =
<a name="18339"/>18339:                                unlink_path(Path,
<a name="18340"/>18340:                                            fun() -&gt; maps:remove(lsa_src, State) end,
<a name="18341"/>18341:                                            fun() -&gt; State end),
<a name="18342"/>18342:                            {ok, maps:remove(sock_src, State1)};
<a name="18343"/>18343:                       (#{sock_src := Sock} = State) -&gt;
<a name="18344"/>18344:                            ok = socket:close(Sock),
<a name="18345"/>18345:                            {ok, maps:remove(sock_src, State)}
<a name="18346"/>18346:                    end},
<a name="18347"/>18347:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="18348"/>18348:            cmd  =&gt; fun(#{domain   := local,
<a name="18349"/>18349:                          sock_dst := Sock,
<a name="18350"/>18350:                          lsa_dst  := #{path := Path}} = State) -&gt;
<a name="18351"/>18351:                            ok = socket:close(Sock),
<a name="18352"/>18352:                            State1 =
<a name="18353"/>18353:                                unlink_path(Path,
<a name="18354"/>18354:                                            fun() -&gt; maps:remove(lsa_dst, State) end,
<a name="18355"/>18355:                                            fun() -&gt; State end),
<a name="18356"/>18356:                            {ok, maps:remove(sock_dst, State1)};
<a name="18357"/>18357:                       (#{sock_dst := Sock} = State) -&gt;
<a name="18358"/>18358:                            ok = socket:close(Sock),
<a name="18359"/>18359:                            {ok, maps:remove(sock_dst, State)}
<a name="18360"/>18360:                    end},
<a name="18361"/>18361: 
<a name="18362"/>18362:          %% *** We are done ***
<a name="18363"/>18363:          ?SEV_FINISH_NORMAL
<a name="18364"/>18364:         ],
<a name="18365"/>18365:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_timestamp_udp-last_expr"/><a name="18366"/>18366: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="18367"/>18367: 
<a name="18368"/>18368: 
<a name="18369"/>18369: 
<a name="18370"/>18370: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18371"/>18371: 
<a name="18372"/>18372: <i>%% Tests that the timestamp control message header is received when</i>
<a name="18373"/>18373: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="18374"/>18374: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="18375"/>18375: <i>%% So, this is done on the receiving side: </i>
<a name="18376"/>18376: <i>%%</i>
<a name="18377"/>18377: <i>%%               socket:setopt(Sock, socket, timestamp, boolean()).</i>
<a name="18378"/>18378: <i>%%</i>
<a name="18379"/>18379: <i>%% All subsequent *received* messages will be timestamped.</i>
<a name="18380"/>18380: <i>%%</i>
<a name="18381"/>18381: <i>%% There is no mention of this not working for TCP in the man page</i>
<a name="18382"/>18382: <i>%% on a SLES 11 SP4 machine (=&gt; 3.0.101-108.87), but it does not</i>
<a name="18383"/>18383: <i>%% (we don't get a timestamp control message header when its enabled).</i>
<a name="18384"/>18384: <i>%% It also does not work on SLES 12 SP2 (=&gt; 4.4.120-92.70), </i>
<a name="18385"/>18385: <i>%% so we start by skipping from that version (4.4.120) or older!</i>
<a name="18386"/>18386: <i>%% Don't actually know if its the distro or the (kernel) version...</i>
<a name="18387"/>18387: <i>%%</i>
<a name="18388"/>18388: 
<a name="api_opt_sock_timestamp_tcp4-1"/><a name="18389"/>18389: <b>api_opt_sock_timestamp_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18390"/>18390:     ?TT(?SECS(5)),
<a name="api_opt_sock_timestamp_tcp4-last_expr"/><a name="18391"/>18391: <b>    tc_try</b>(api_opt_sock_timestamp_tcp4,
<a name="18392"/>18392:            fun() -&gt;
<a name="18393"/>18393:                    has_support_ipv4(),
<a name="18394"/>18394:                    has_support_sock_timestamp(),
<a name="18395"/>18395:                    is_good_enough_linux({4,4,120}),
<a name="18396"/>18396:                    is_not_freebsd(),
<a name="18397"/>18397:                    is_not_openbsd(),
<a name="18398"/>18398:                    is_not_netbsd(),
<a name="18399"/>18399:                    is_not_darwin()
<a name="18400"/>18400:            end,
<a name="18401"/>18401:            fun() -&gt;
<a name="18402"/>18402:                    Set  = fun(Sock, Value) -&gt;
<a name="18403"/>18403:                                   socket:setopt(Sock, socket, timestamp, Value)
<a name="18404"/>18404:                           end,
<a name="18405"/>18405:                    Get  = fun(Sock) -&gt;
<a name="18406"/>18406:                                   socket:getopt(Sock, socket, timestamp)
<a name="18407"/>18407:                           end,
<a name="18408"/>18408:                    Send = fun(Sock, Data) -&gt;
<a name="18409"/>18409:                                   Msg = #{iov  =&gt; [Data]},
<a name="18410"/>18410:                                   socket:sendmsg(Sock, Msg)
<a name="18411"/>18411:                           end,
<a name="18412"/>18412:                    Recv = fun(Sock) -&gt;
<a name="18413"/>18413:                                   case socket:recvmsg(Sock) of
<a name="18414"/>18414:                                       {ok, #{ctrl := CMsgs,
<a name="18415"/>18415:                                              iov  := [Data]}} -&gt;
<a name="18416"/>18416:                                           {ok, {CMsgs, Data}};
<a name="18417"/>18417:                                       {error, _} = ERROR -&gt;
<a name="18418"/>18418:                                           ERROR
<a name="18419"/>18419:                                   end
<a name="18420"/>18420:                           end,
<a name="18421"/>18421:                    InitState = #{domain =&gt; inet,
<a name="18422"/>18422:                                  proto  =&gt; tcp,
<a name="18423"/>18423:                                  send   =&gt; Send,
<a name="18424"/>18424:                                  recv   =&gt; Recv,
<a name="18425"/>18425:                                  set    =&gt; Set,
<a name="18426"/>18426:                                  get    =&gt; Get},
<a name="18427"/>18427:                    ok = api_opt_sock_timestamp_tcp(InitState)
<a name="18428"/>18428:            end).
<a name="18429"/>18429: 
<a name="18430"/>18430: 
<a name="18431"/>18431: 
<a name="18432"/>18432: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18433"/>18433: 
<a name="api_opt_sock_timestamp_tcp-1"/><a name="18434"/>18434: <b>api_opt_sock_timestamp_tcp</b>(InitState) -&gt;
<a name="18435"/>18435:     process_flag(trap_exit, true),
<a name="18436"/>18436:     ServerSeq =
<a name="18437"/>18437:         [
<a name="18438"/>18438:          %% *** Wait for start order ***
<a name="18439"/>18439:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="18440"/>18440:            cmd  =&gt; fun(State) -&gt;
<a name="18441"/>18441:                            Tester = ?SEV_AWAIT_START(),
<a name="18442"/>18442:                            {ok, State#{tester =&gt; Tester}}
<a name="18443"/>18443:                    end},
<a name="18444"/>18444:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="18445"/>18445:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18446"/>18446:                            _MRef = erlang:monitor(process, Tester),
<a name="18447"/>18447:                            ok
<a name="18448"/>18448:                    end},
<a name="18449"/>18449: 
<a name="18450"/>18450:          %% *** Init part ***
<a name="18451"/>18451:          #{desc =&gt; &quot;which local address&quot;,
<a name="18452"/>18452:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="18453"/>18453:                            LSA = which_local_socket_addr(Domain),
<a name="18454"/>18454:                            {ok, State#{lsa =&gt; LSA}}
<a name="18455"/>18455:                    end},
<a name="18456"/>18456:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="18457"/>18457:            cmd  =&gt; fun(#{domain := Domain,
<a name="18458"/>18458:                          proto  := Proto} = State) -&gt;
<a name="18459"/>18459:                            case socket:open(Domain, stream, Proto) of
<a name="18460"/>18460:                                {ok, Sock} -&gt;
<a name="18461"/>18461:                                    {ok, State#{lsock =&gt; Sock}};
<a name="18462"/>18462:                                {error, _} = ERROR -&gt;
<a name="18463"/>18463:                                    ERROR
<a name="18464"/>18464:                            end
<a name="18465"/>18465:                    end},
<a name="18466"/>18466:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="18467"/>18467:            cmd  =&gt; fun(#{domain := local,
<a name="18468"/>18468:                          lsock  := LSock,
<a name="18469"/>18469:                          lsa    := LSA} = _State) -&gt;
<a name="18470"/>18470:                            case socket:bind(LSock, LSA) of
<a name="18471"/>18471:                                ok -&gt;
<a name="18472"/>18472:                                    ok; % We do not care about the port for local
<a name="18473"/>18473:                                {error, _} = ERROR -&gt;
<a name="18474"/>18474:                                    ERROR
<a name="18475"/>18475:                            end;
<a name="18476"/>18476:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="18477"/>18477:                            case sock_bind(LSock, LSA) of
<a name="18478"/>18478:                                ok -&gt;
<a name="18479"/>18479:                                    Port = sock_port(LSock),
<a name="18480"/>18480:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="18481"/>18481:                                    {ok, State#{lport =&gt; Port}};
<a name="18482"/>18482:                                {error, _} = ERROR -&gt;
<a name="18483"/>18483:                                    ERROR
<a name="18484"/>18484:                            end
<a name="18485"/>18485:                    end},
<a name="18486"/>18486:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="18487"/>18487:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="18488"/>18488:                            socket:listen(LSock)
<a name="18489"/>18489:                    end},
<a name="18490"/>18490:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="18491"/>18491:            cmd  =&gt; fun(#{domain := local,
<a name="18492"/>18492:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="18493"/>18493:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="18494"/>18494:                            ok;
<a name="18495"/>18495:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="18496"/>18496:                            %% This is actually not used for unix domain socket
<a name="18497"/>18497:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="18498"/>18498:                            ok
<a name="18499"/>18499:                    end},
<a name="18500"/>18500: 
<a name="18501"/>18501: 
<a name="18502"/>18502:          %% The actual test
<a name="18503"/>18503:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="18504"/>18504:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18505"/>18505:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="18506"/>18506:                    end},
<a name="18507"/>18507:          #{desc =&gt; &quot;await connection&quot;,
<a name="18508"/>18508:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="18509"/>18509:                            case socket:accept(LSock) of
<a name="18510"/>18510:                                {ok, Sock} -&gt;
<a name="18511"/>18511:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="18512"/>18512:                                    {ok, State#{csock =&gt; Sock}};
<a name="18513"/>18513:                                {error, _} = ERROR -&gt;
<a name="18514"/>18514:                                    ERROR
<a name="18515"/>18515:                            end
<a name="18516"/>18516:                    end},
<a name="18517"/>18517:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="18518"/>18518:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18519"/>18519:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="18520"/>18520:                            ok
<a name="18521"/>18521:                    end},
<a name="18522"/>18522: 
<a name="18523"/>18523:          %% *** First message ***
<a name="18524"/>18524: 
<a name="18525"/>18525:          #{desc =&gt; &quot;await (recv) request 1&quot;,
<a name="18526"/>18526:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="18527"/>18527:                            case Recv(Sock) of
<a name="18528"/>18528:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="18529"/>18529:                                    ok;
<a name="18530"/>18530:                                {error, _} = ERROR -&gt;
<a name="18531"/>18531:                                    ERROR
<a name="18532"/>18532:                            end
<a name="18533"/>18533:                    end},
<a name="18534"/>18534:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="18535"/>18535:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18536"/>18536:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="18537"/>18537:                            ok
<a name="18538"/>18538:                    end},
<a name="18539"/>18539:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="18540"/>18540:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18541"/>18541:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="18542"/>18542:                    end},
<a name="18543"/>18543:          #{desc =&gt; &quot;send reply&quot;,
<a name="18544"/>18544:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="18545"/>18545:                            Send(Sock, ?BASIC_REP)
<a name="18546"/>18546:                    end},
<a name="18547"/>18547:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="18548"/>18548:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18549"/>18549:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="18550"/>18550:                            ok
<a name="18551"/>18551:                    end},
<a name="18552"/>18552: 
<a name="18553"/>18553:          %% *** Second message ***
<a name="18554"/>18554: 
<a name="18555"/>18555:          #{desc =&gt; &quot;await (recv) request 2&quot;,
<a name="18556"/>18556:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="18557"/>18557:                            case Recv(Sock) of
<a name="18558"/>18558:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="18559"/>18559:                                    ok;
<a name="18560"/>18560:                                {error, _} = ERROR -&gt;
<a name="18561"/>18561:                                    ERROR
<a name="18562"/>18562:                            end
<a name="18563"/>18563:                    end},
<a name="18564"/>18564:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="18565"/>18565:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18566"/>18566:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="18567"/>18567:                            ok
<a name="18568"/>18568:                    end},
<a name="18569"/>18569:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="18570"/>18570:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18571"/>18571:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="18572"/>18572:                    end},
<a name="18573"/>18573:          #{desc =&gt; &quot;send reply&quot;,
<a name="18574"/>18574:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="18575"/>18575:                            Send(Sock, ?BASIC_REP)
<a name="18576"/>18576:                    end},
<a name="18577"/>18577:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="18578"/>18578:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18579"/>18579:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="18580"/>18580:                            ok
<a name="18581"/>18581:                    end},
<a name="18582"/>18582: 
<a name="18583"/>18583:          %% *** Third message ***
<a name="18584"/>18584: 
<a name="18585"/>18585:          #{desc =&gt; &quot;await (recv) request 3&quot;,
<a name="18586"/>18586:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="18587"/>18587:                            case Recv(Sock) of
<a name="18588"/>18588:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="18589"/>18589:                                    ok;
<a name="18590"/>18590:                                {error, _} = ERROR -&gt;
<a name="18591"/>18591:                                    ERROR
<a name="18592"/>18592:                            end
<a name="18593"/>18593:                    end},
<a name="18594"/>18594:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="18595"/>18595:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18596"/>18596:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="18597"/>18597:                            ok
<a name="18598"/>18598:                    end},
<a name="18599"/>18599:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="18600"/>18600:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18601"/>18601:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="18602"/>18602:                    end},
<a name="18603"/>18603:          #{desc =&gt; &quot;send reply&quot;,
<a name="18604"/>18604:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="18605"/>18605:                            Send(Sock, ?BASIC_REP)
<a name="18606"/>18606:                    end},
<a name="18607"/>18607:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="18608"/>18608:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18609"/>18609:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="18610"/>18610:                            ok
<a name="18611"/>18611:                    end},
<a name="18612"/>18612: 
<a name="18613"/>18613:          %% *** Termination ***
<a name="18614"/>18614:          #{desc =&gt; &quot;await terminate&quot;,
<a name="18615"/>18615:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="18616"/>18616:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="18617"/>18617:                                ok -&gt;
<a name="18618"/>18618:                                    {ok, maps:remove(tester, State)};
<a name="18619"/>18619:                                {error, _} = ERROR -&gt;
<a name="18620"/>18620:                                    ERROR
<a name="18621"/>18621:                            end
<a name="18622"/>18622:                    end},
<a name="18623"/>18623:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="18624"/>18624:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="18625"/>18625:                            ok = socket:close(Sock),
<a name="18626"/>18626:                            {ok, maps:remove(csock, State)}
<a name="18627"/>18627:                    end},
<a name="18628"/>18628:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="18629"/>18629:            cmd  =&gt; fun(#{domain   := local,
<a name="18630"/>18630:                          lsock    := Sock,
<a name="18631"/>18631:                          local_sa := #{path := Path}} = State) -&gt;
<a name="18632"/>18632:                            ok = socket:close(Sock),
<a name="18633"/>18633:                            State1 =
<a name="18634"/>18634:                                unlink_path(Path,
<a name="18635"/>18635:                                            fun() -&gt;
<a name="18636"/>18636:                                                    maps:remove(local_sa, State)
<a name="18637"/>18637:                                            end,
<a name="18638"/>18638:                                            fun() -&gt; State end),
<a name="18639"/>18639:                            {ok, maps:remove(lsock, State1)};
<a name="18640"/>18640:                       (#{lsock := LSock} = State) -&gt;
<a name="18641"/>18641:                            case socket:close(LSock) of
<a name="18642"/>18642:                                ok -&gt;
<a name="18643"/>18643:                                    {ok, maps:remove(lsock, State)};
<a name="18644"/>18644:                                {error, _} = ERROR -&gt;
<a name="18645"/>18645:                                    ERROR
<a name="18646"/>18646:                            end
<a name="18647"/>18647:                    end},
<a name="18648"/>18648: 
<a name="18649"/>18649:          %% *** We are done ***
<a name="18650"/>18650:          ?SEV_FINISH_NORMAL
<a name="18651"/>18651:         ],
<a name="18652"/>18652: 
<a name="18653"/>18653: 
<a name="18654"/>18654:     ClientSeq =
<a name="18655"/>18655:         [
<a name="18656"/>18656:          %% *** Wait for start order ***
<a name="18657"/>18657:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="18658"/>18658:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="18659"/>18659:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="18660"/>18660:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="18661"/>18661:                       (State) -&gt;
<a name="18662"/>18662:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="18663"/>18663:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="18664"/>18664:                    end},
<a name="18665"/>18665:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="18666"/>18666:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18667"/>18667:                            _MRef = erlang:monitor(process, Tester),
<a name="18668"/>18668:                            ok
<a name="18669"/>18669:                    end},
<a name="18670"/>18670: 
<a name="18671"/>18671:          %% *** The init part ***
<a name="18672"/>18672:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="18673"/>18673:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="18674"/>18674:                          server_path := Path} = State) -&gt;
<a name="18675"/>18675:                            LSA = which_local_socket_addr(Domain),
<a name="18676"/>18676:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="18677"/>18677:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="18678"/>18678:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="18679"/>18679:                            LSA = which_local_socket_addr(Domain),
<a name="18680"/>18680:                            SSA = LSA#{port =&gt; Port},
<a name="18681"/>18681:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="18682"/>18682:                    end},
<a name="18683"/>18683:          #{desc =&gt; &quot;create socket&quot;,
<a name="18684"/>18684:            cmd  =&gt; fun(#{domain := Domain,
<a name="18685"/>18685:                          proto  := Proto} = State) -&gt;
<a name="18686"/>18686:                            case socket:open(Domain, stream, Proto) of
<a name="18687"/>18687:                                {ok, Sock} -&gt;
<a name="18688"/>18688:                                    {ok, State#{sock =&gt; Sock}};
<a name="18689"/>18689:                                {error, _} = ERROR -&gt;
<a name="18690"/>18690:                                    ERROR
<a name="18691"/>18691:                            end
<a name="18692"/>18692:                    end},
<a name="18693"/>18693:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="18694"/>18694:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="18695"/>18695:                            case sock_bind(Sock, LSA) of
<a name="18696"/>18696:                                ok -&gt;
<a name="18697"/>18697:                                    ok;
<a name="18698"/>18698:                                {error, _} = ERROR -&gt;
<a name="18699"/>18699:                                    ERROR
<a name="18700"/>18700:                            end
<a name="18701"/>18701:                    end},
<a name="18702"/>18702:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="18703"/>18703:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18704"/>18704:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="18705"/>18705:                            ok
<a name="18706"/>18706:                    end},
<a name="18707"/>18707: 
<a name="18708"/>18708:          %% *** The actual test ***
<a name="18709"/>18709:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="18710"/>18710:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18711"/>18711:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="18712"/>18712:                    end},
<a name="18713"/>18713:          #{desc =&gt; &quot;connect to server&quot;,
<a name="18714"/>18714:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="18715"/>18715:                            socket:connect(Sock, SSA)
<a name="18716"/>18716:                    end},
<a name="18717"/>18717:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="18718"/>18718:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18719"/>18719:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="18720"/>18720:                            ok
<a name="18721"/>18721:                    end},
<a name="18722"/>18722: 
<a name="18723"/>18723:          %% *** First message (default=wo timestamp) ***
<a name="18724"/>18724: 
<a name="18725"/>18725:          #{desc =&gt; &quot;await continue (verify timestamp off)&quot;,
<a name="18726"/>18726:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18727"/>18727:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_timestamp)
<a name="18728"/>18728:                    end},
<a name="18729"/>18729:          #{desc =&gt; &quot;verify timestamp off&quot;,
<a name="18730"/>18730:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="18731"/>18731:                            case Get(Sock) of
<a name="18732"/>18732:                                {ok, false = _Value} -&gt;
<a name="18733"/>18733:                                    ?SEV_IPRINT(&quot;timestamp: ~p&quot;, [_Value]),
<a name="18734"/>18734:                                    ok;
<a name="18735"/>18735:                                {ok, Unexpected} -&gt;
<a name="18736"/>18736:                                    ?SEV_EPRINT(&quot;Unexpected timestamp: ~p&quot;,
<a name="18737"/>18737:                                                [Unexpected]),
<a name="18738"/>18738:                                    {error, {unexpected_timestamp, Unexpected}};
<a name="18739"/>18739:                                {error, enoprotoopt = Reason} -&gt;
<a name="18740"/>18740:                                    {skip, Reason};
<a name="18741"/>18741:                                {error, Reason} = ERROR -&gt;
<a name="18742"/>18742:                                    ?SEV_EPRINT(&quot;Failed getting timestamp:&quot;
<a name="18743"/>18743:                                                &quot;   ~p&quot;, [Reason]),
<a name="18744"/>18744:                                    ERROR
<a name="18745"/>18745:                            end                                   
<a name="18746"/>18746:                    end},
<a name="18747"/>18747:          #{desc =&gt; &quot;announce ready (timestamp off)&quot;,
<a name="18748"/>18748:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18749"/>18749:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_off),
<a name="18750"/>18750:                            ok
<a name="18751"/>18751:                    end},
<a name="18752"/>18752: 
<a name="18753"/>18753:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="18754"/>18754:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18755"/>18755:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="18756"/>18756:                    end},
<a name="18757"/>18757:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="18758"/>18758:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="18759"/>18759:                            Send(Sock, ?BASIC_REQ)
<a name="18760"/>18760:                    end},
<a name="18761"/>18761:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="18762"/>18762:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18763"/>18763:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="18764"/>18764:                            ok
<a name="18765"/>18765:                    end},
<a name="18766"/>18766:          #{desc =&gt; &quot;await recv reply 1 (from server, wo timestamp)&quot;,
<a name="18767"/>18767:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="18768"/>18768:                            case Recv(Sock) of
<a name="18769"/>18769:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="18770"/>18770:                                    ok;
<a name="18771"/>18771:                                {ok, {[], UnexpData}} -&gt;
<a name="18772"/>18772:                                    {error, {unexpected_reply_data, UnexpData}};
<a name="18773"/>18773:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="18774"/>18774:                                    {error, {unexpected_reply_cmsgs,
<a name="18775"/>18775:                                             BadCMsgs}};
<a name="18776"/>18776:                                {ok, BadReply} -&gt;
<a name="18777"/>18777:                                    {error, {unexpected_reply, BadReply}};
<a name="18778"/>18778:                                {error, _} = ERROR -&gt;
<a name="18779"/>18779:                                    ERROR
<a name="18780"/>18780:                            end
<a name="18781"/>18781:                    end},
<a name="18782"/>18782:          #{desc =&gt; &quot;announce ready 1 (recv reply)&quot;,
<a name="18783"/>18783:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18784"/>18784:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="18785"/>18785:                            ok
<a name="18786"/>18786:                    end},
<a name="18787"/>18787: 
<a name="18788"/>18788:          %% *** Second message (w timestamp) ***
<a name="18789"/>18789: 
<a name="18790"/>18790:          #{desc =&gt; &quot;await continue (enable timestamp)&quot;,
<a name="18791"/>18791:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18792"/>18792:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_timestamp)
<a name="18793"/>18793:                    end},
<a name="18794"/>18794:          #{desc =&gt; &quot;enable timestamp&quot;,
<a name="18795"/>18795:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="18796"/>18796:                            case Set(Sock, true) of
<a name="18797"/>18797:                                ok -&gt;
<a name="18798"/>18798:                                    ?SEV_IPRINT(&quot;timestamp enabled&quot;),
<a name="18799"/>18799:                                    ok;
<a name="18800"/>18800:                                {error, Reason} = ERROR -&gt;
<a name="18801"/>18801:                                    ?SEV_EPRINT(&quot;Failed enable timestamp:&quot;
<a name="18802"/>18802:                                                &quot;   ~p&quot;, [Reason]),
<a name="18803"/>18803:                                    ERROR
<a name="18804"/>18804:                            end                                   
<a name="18805"/>18805:                    end},
<a name="18806"/>18806:          %% Linux peculiarity observed here...
<a name="18807"/>18807:          %% Detected on Kernel 4.15.0-72 x96_64.
<a name="18808"/>18808:          %% The option set to enable receiving timestamps just above
<a name="18809"/>18809:          %% has failed to be effective down in &quot;await recv reply 2
<a name="18810"/>18810:          %% (from server, w timestamp)&quot; below, unless we put the
<a name="18811"/>18811:          %% sleep between setting the option and informing
<a name="18812"/>18812:          %% the writer that it shall write to the other socket end.
<a name="18813"/>18813:          %% A sleep 1 ms improves a lot but does not remove
<a name="18814"/>18814:          %% problem completely. Believe it or not.
<a name="18815"/>18815:          ?SEV_SLEEP(100),
<a name="18816"/>18816:          #{desc =&gt; &quot;announce ready (timestamp on)&quot;,
<a name="18817"/>18817:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18818"/>18818:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_on),
<a name="18819"/>18819:                            ok
<a name="18820"/>18820:                    end},
<a name="18821"/>18821: 
<a name="18822"/>18822:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="18823"/>18823:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18824"/>18824:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="18825"/>18825:                    end},
<a name="18826"/>18826:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="18827"/>18827:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="18828"/>18828:                            Send(Sock, ?BASIC_REQ)
<a name="18829"/>18829:                    end},
<a name="18830"/>18830:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="18831"/>18831:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18832"/>18832:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="18833"/>18833:                            ok
<a name="18834"/>18834:                    end},
<a name="18835"/>18835:          #{desc =&gt; &quot;await recv reply 2 (from server, w timestamp)&quot;,
<a name="18836"/>18836:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, get := Get}) -&gt;
<a name="18837"/>18837:                            case Recv(Sock) of
<a name="18838"/>18838:                                {ok, {[#{level := socket,
<a name="18839"/>18839:                                         type  := timestamp,
<a name="18840"/>18840:                                         value := TS}], ?BASIC_REP}} -&gt;
<a name="18841"/>18841:                                    ?SEV_IPRINT(&quot;received reply *with* &quot;
<a name="18842"/>18842:                                                &quot;expected timestamp: &quot;
<a name="18843"/>18843:                                                &quot;~n   ~p&quot;, [TS]),
<a name="18844"/>18844:                                    ok;
<a name="18845"/>18845:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="18846"/>18846:                                    ?SEV_EPRINT(&quot;received reply *with* &quot;
<a name="18847"/>18847:                                                &quot;unexpected cmsg headers:&quot;
<a name="18848"/>18848:                                                &quot;~n   ~p&quot;
<a name="18849"/>18849:                                                &quot;Current timestamp value: &quot;
<a name="18850"/>18850:                                                &quot;~n   ~p&quot;,
<a name="18851"/>18851:                                                [BadCMsgs, Get(Sock)]),
<a name="18852"/>18852:                                    {error, {unexpected_reply_cmsgs,
<a name="18853"/>18853:                                             BadCMsgs}};
<a name="18854"/>18854:                                {ok, BadReply} -&gt;
<a name="18855"/>18855:                                    {error, {unexpected_reply, BadReply}};
<a name="18856"/>18856:                                {error, _} = ERROR -&gt;
<a name="18857"/>18857:                                    ERROR
<a name="18858"/>18858:                            end
<a name="18859"/>18859:                    end},
<a name="18860"/>18860:          #{desc =&gt; &quot;announce ready 2 (recv reply)&quot;,
<a name="18861"/>18861:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18862"/>18862:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="18863"/>18863:                            ok
<a name="18864"/>18864:                    end},
<a name="18865"/>18865: 
<a name="18866"/>18866:          %% *** Third message (wo timestamp) ***
<a name="18867"/>18867: 
<a name="18868"/>18868:          #{desc =&gt; &quot;await continue (disable timestamp)&quot;,
<a name="18869"/>18869:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18870"/>18870:                            ?SEV_AWAIT_CONTINUE(Tester, tester, disable_timestamp)
<a name="18871"/>18871:                    end},
<a name="18872"/>18872:          #{desc =&gt; &quot;disable timestamp&quot;,
<a name="18873"/>18873:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="18874"/>18874:                            case Set(Sock, false) of
<a name="18875"/>18875:                                ok -&gt;
<a name="18876"/>18876:                                    ?SEV_IPRINT(&quot;timestamp disabled&quot;),
<a name="18877"/>18877:                                    ok;
<a name="18878"/>18878:                                {error, Reason} = ERROR -&gt;
<a name="18879"/>18879:                                    ?SEV_EPRINT(&quot;Failed disable timestamp:&quot;
<a name="18880"/>18880:                                                &quot;   ~p&quot;, [Reason]),
<a name="18881"/>18881:                                    ERROR
<a name="18882"/>18882:                            end                                   
<a name="18883"/>18883:                    end},
<a name="18884"/>18884:          #{desc =&gt; &quot;announce ready (timestamp off)&quot;,
<a name="18885"/>18885:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18886"/>18886:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_off),
<a name="18887"/>18887:                            ok
<a name="18888"/>18888:                    end},
<a name="18889"/>18889: 
<a name="18890"/>18890:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="18891"/>18891:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="18892"/>18892:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="18893"/>18893:                    end},
<a name="18894"/>18894:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="18895"/>18895:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="18896"/>18896:                            Send(Sock, ?BASIC_REQ)
<a name="18897"/>18897:                    end},
<a name="18898"/>18898:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="18899"/>18899:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18900"/>18900:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="18901"/>18901:                            ok
<a name="18902"/>18902:                    end},
<a name="18903"/>18903:          #{desc =&gt; &quot;await recv reply 3 (from server, wo timestamp)&quot;,
<a name="18904"/>18904:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="18905"/>18905:                            case Recv(Sock) of
<a name="18906"/>18906:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="18907"/>18907:                                    ?SEV_IPRINT(&quot;received reply *without* &quot;
<a name="18908"/>18908:                                                &quot;timestamp&quot;),
<a name="18909"/>18909:                                    ok;
<a name="18910"/>18910:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="18911"/>18911:                                    {error, {unexpected_reply_cmsgs,
<a name="18912"/>18912:                                             BadCMsgs}};
<a name="18913"/>18913:                                {ok, {[], BadData}} -&gt;
<a name="18914"/>18914:                                    {error, {unexpected_reply_data,
<a name="18915"/>18915:                                             BadData}};
<a name="18916"/>18916:                                {ok, BadReply} -&gt;
<a name="18917"/>18917:                                    {error, {unexpected_reply, BadReply}};
<a name="18918"/>18918:                                {error, _} = ERROR -&gt;
<a name="18919"/>18919:                                    ERROR
<a name="18920"/>18920:                            end
<a name="18921"/>18921:                    end},
<a name="18922"/>18922:          #{desc =&gt; &quot;announce ready 3 (recv reply)&quot;,
<a name="18923"/>18923:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18924"/>18924:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="18925"/>18925:                            ok
<a name="18926"/>18926:                    end},
<a name="18927"/>18927: 
<a name="18928"/>18928:          %% *** Termination ***
<a name="18929"/>18929:          #{desc =&gt; &quot;await terminate&quot;,
<a name="18930"/>18930:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="18931"/>18931:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="18932"/>18932:                                ok -&gt;
<a name="18933"/>18933:                                    {ok, maps:remove(tester, State)};
<a name="18934"/>18934:                                {error, _} = ERROR -&gt;
<a name="18935"/>18935:                                    ERROR
<a name="18936"/>18936:                            end
<a name="18937"/>18937:                    end},
<a name="18938"/>18938:          #{desc =&gt; &quot;close socket&quot;,
<a name="18939"/>18939:            cmd  =&gt; fun(#{domain   := local,
<a name="18940"/>18940:                          sock     := Sock,
<a name="18941"/>18941:                          local_sa := #{path := Path}} = State) -&gt;
<a name="18942"/>18942:                            ok = socket:close(Sock),
<a name="18943"/>18943:                            State1 =
<a name="18944"/>18944:                                unlink_path(Path,
<a name="18945"/>18945:                                            fun() -&gt;
<a name="18946"/>18946:                                                    maps:remove(local_sa, State)
<a name="18947"/>18947:                                            end,
<a name="18948"/>18948:                                            fun() -&gt; State end),
<a name="18949"/>18949:                            {ok, maps:remove(sock, State1)};
<a name="18950"/>18950:                       (#{sock := Sock} = State) -&gt;
<a name="18951"/>18951:                            ok = socket:close(Sock),
<a name="18952"/>18952:                            {ok, maps:remove(sock, State)}
<a name="18953"/>18953:                    end},
<a name="18954"/>18954: 
<a name="18955"/>18955:          %% *** We are done ***
<a name="18956"/>18956:          ?SEV_FINISH_NORMAL
<a name="18957"/>18957:         ],
<a name="18958"/>18958: 
<a name="18959"/>18959: 
<a name="18960"/>18960:     TesterSeq =
<a name="18961"/>18961:         [
<a name="18962"/>18962:          %% *** Init part ***
<a name="18963"/>18963:          #{desc =&gt; &quot;monitor server&quot;,
<a name="18964"/>18964:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="18965"/>18965:                            _MRef = erlang:monitor(process, Pid),
<a name="18966"/>18966:                            ok
<a name="18967"/>18967:                    end},
<a name="18968"/>18968:          #{desc =&gt; &quot;monitor client&quot;,
<a name="18969"/>18969:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="18970"/>18970:                            _MRef = erlang:monitor(process, Pid),
<a name="18971"/>18971:                            ok
<a name="18972"/>18972:                    end},
<a name="18973"/>18973: 
<a name="18974"/>18974:          %% Start the server
<a name="18975"/>18975:          #{desc =&gt; &quot;order server start&quot;,
<a name="18976"/>18976:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="18977"/>18977:                            ?SEV_ANNOUNCE_START(Pid),
<a name="18978"/>18978:                            ok
<a name="18979"/>18979:                    end},
<a name="18980"/>18980:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="18981"/>18981:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="18982"/>18982:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="18983"/>18983:                            {ok, State#{server_port =&gt; Port}}
<a name="18984"/>18984:                    end},
<a name="18985"/>18985: 
<a name="18986"/>18986:          %% Start the client
<a name="18987"/>18987:          #{desc =&gt; &quot;order client start&quot;,
<a name="18988"/>18988:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="18989"/>18989:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="18990"/>18990:                            ok
<a name="18991"/>18991:                    end},
<a name="18992"/>18992:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="18993"/>18993:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="18994"/>18994:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="18995"/>18995:                    end},
<a name="18996"/>18996: 
<a name="18997"/>18997:          %% *** The actual test ***
<a name="18998"/>18998:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="18999"/>18999:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19000"/>19000:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="19001"/>19001:                            ok
<a name="19002"/>19002:                    end},
<a name="19003"/>19003: <i>%%%         ?SEV_SLEEP(?SECS(1)),</i>
<a name="19004"/>19004:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="19005"/>19005:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19006"/>19006:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="19007"/>19007:                            ok
<a name="19008"/>19008:                    end},
<a name="19009"/>19009:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="19010"/>19010:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19011"/>19011:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="19012"/>19012:                    end},
<a name="19013"/>19013:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="19014"/>19014:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19015"/>19015:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="19016"/>19016:                    end},
<a name="19017"/>19017: 
<a name="19018"/>19018:          %% *** First message (default=wo timestamp) ***
<a name="19019"/>19019: 
<a name="19020"/>19020:          #{desc =&gt; &quot;order client to continue (with verify timestamp off)&quot;,
<a name="19021"/>19021:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19022"/>19022:                            ?SEV_ANNOUNCE_CONTINUE(Client, verify_timestamp),
<a name="19023"/>19023:                            ok
<a name="19024"/>19024:                    end},
<a name="19025"/>19025:          #{desc =&gt; &quot;await client ready (timestamp off)&quot;,
<a name="19026"/>19026:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19027"/>19027:                            ?SEV_AWAIT_READY(Client, client, timestamp_off)
<a name="19028"/>19028:                    end},
<a name="19029"/>19029: 
<a name="19030"/>19030:          #{desc =&gt; &quot;order client to continue (with send request 1)&quot;,
<a name="19031"/>19031:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19032"/>19032:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="19033"/>19033:                            ok
<a name="19034"/>19034:                    end},
<a name="19035"/>19035:          #{desc =&gt; &quot;await client ready (with send request 1)&quot;,
<a name="19036"/>19036:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19037"/>19037:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="19038"/>19038:                    end},
<a name="19039"/>19039:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="19040"/>19040:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19041"/>19041:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="19042"/>19042:                    end},
<a name="19043"/>19043:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="19044"/>19044:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19045"/>19045:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="19046"/>19046:                            ok
<a name="19047"/>19047:                    end},
<a name="19048"/>19048:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="19049"/>19049:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19050"/>19050:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="19051"/>19051:                    end},
<a name="19052"/>19052:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="19053"/>19053:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19054"/>19054:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="19055"/>19055:                    end},
<a name="19056"/>19056: 
<a name="19057"/>19057:          %% Second message (w timestamp)
<a name="19058"/>19058: 
<a name="19059"/>19059:          #{desc =&gt; &quot;order client to continue (with enable timestamp)&quot;,
<a name="19060"/>19060:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19061"/>19061:                            ?SEV_ANNOUNCE_CONTINUE(Client, enable_timestamp),
<a name="19062"/>19062:                            ok
<a name="19063"/>19063:                    end},
<a name="19064"/>19064:          #{desc =&gt; &quot;await client ready (timestamp on)&quot;,
<a name="19065"/>19065:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19066"/>19066:                            ?SEV_AWAIT_READY(Client, client, timestamp_on)
<a name="19067"/>19067:                    end},
<a name="19068"/>19068: 
<a name="19069"/>19069:          #{desc =&gt; &quot;order client to continue (with send request 2)&quot;,
<a name="19070"/>19070:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19071"/>19071:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="19072"/>19072:                            ok
<a name="19073"/>19073:                    end},
<a name="19074"/>19074:          #{desc =&gt; &quot;await client ready (with send request 2)&quot;,
<a name="19075"/>19075:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19076"/>19076:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="19077"/>19077:                    end},
<a name="19078"/>19078:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="19079"/>19079:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19080"/>19080:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="19081"/>19081:                    end},
<a name="19082"/>19082:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="19083"/>19083:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19084"/>19084:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="19085"/>19085:                            ok
<a name="19086"/>19086:                    end},
<a name="19087"/>19087:          #{desc =&gt; &quot;await server ready (with reply sent 2)&quot;,
<a name="19088"/>19088:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19089"/>19089:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="19090"/>19090:                    end},
<a name="19091"/>19091:          #{desc =&gt; &quot;await client ready (reply recv 2)&quot;,
<a name="19092"/>19092:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19093"/>19093:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="19094"/>19094:                    end},
<a name="19095"/>19095: 
<a name="19096"/>19096:          %% Third message (wo timestamp)
<a name="19097"/>19097: 
<a name="19098"/>19098:          #{desc =&gt; &quot;order client to continue (with disable timestamp)&quot;,
<a name="19099"/>19099:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19100"/>19100:                            ?SEV_ANNOUNCE_CONTINUE(Client, disable_timestamp),
<a name="19101"/>19101:                            ok
<a name="19102"/>19102:                    end},
<a name="19103"/>19103:          #{desc =&gt; &quot;await client ready (timestamp off)&quot;,
<a name="19104"/>19104:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19105"/>19105:                            ?SEV_AWAIT_READY(Client, client, timestamp_off)
<a name="19106"/>19106:                    end},
<a name="19107"/>19107: 
<a name="19108"/>19108:          #{desc =&gt; &quot;order client to continue (with send request 3)&quot;,
<a name="19109"/>19109:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19110"/>19110:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="19111"/>19111:                            ok
<a name="19112"/>19112:                    end},
<a name="19113"/>19113:          #{desc =&gt; &quot;await client ready (with send request 3)&quot;,
<a name="19114"/>19114:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19115"/>19115:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="19116"/>19116:                    end},
<a name="19117"/>19117:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="19118"/>19118:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19119"/>19119:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="19120"/>19120:                    end},
<a name="19121"/>19121:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="19122"/>19122:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19123"/>19123:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="19124"/>19124:                            ok
<a name="19125"/>19125:                    end},
<a name="19126"/>19126:          #{desc =&gt; &quot;await server ready (with reply sent 3)&quot;,
<a name="19127"/>19127:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19128"/>19128:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="19129"/>19129:                    end},
<a name="19130"/>19130:          #{desc =&gt; &quot;await client ready (reply recv 3)&quot;,
<a name="19131"/>19131:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19132"/>19132:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="19133"/>19133:                    end},
<a name="19134"/>19134: 
<a name="19135"/>19135: 
<a name="19136"/>19136:          %% *** Termination ***
<a name="19137"/>19137:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="19138"/>19138:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19139"/>19139:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="19140"/>19140:                            ok
<a name="19141"/>19141:                    end},
<a name="19142"/>19142:          #{desc =&gt; &quot;await client termination&quot;,
<a name="19143"/>19143:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="19144"/>19144:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="19145"/>19145:                            State1 = maps:remove(client, State),
<a name="19146"/>19146:                            {ok, State1}
<a name="19147"/>19147:                    end},
<a name="19148"/>19148:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="19149"/>19149:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19150"/>19150:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="19151"/>19151:                            ok
<a name="19152"/>19152:                    end},
<a name="19153"/>19153:          #{desc =&gt; &quot;await server termination&quot;,
<a name="19154"/>19154:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="19155"/>19155:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="19156"/>19156:                            State1 = maps:remove(server, State),
<a name="19157"/>19157:                            {ok, State1}
<a name="19158"/>19158:                    end},
<a name="19159"/>19159: 
<a name="19160"/>19160:          %% *** We are done ***
<a name="19161"/>19161:          ?SEV_FINISH_NORMAL
<a name="19162"/>19162:         ],
<a name="19163"/>19163: 
<a name="19164"/>19164: 
<a name="19165"/>19165:     i(&quot;start server evaluator&quot;),
<a name="19166"/>19166:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="19167"/>19167: 
<a name="19168"/>19168:     i(&quot;start client evaluator&quot;),
<a name="19169"/>19169:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="19170"/>19170: 
<a name="19171"/>19171:     i(&quot;start tester evaluator&quot;),
<a name="19172"/>19172:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="19173"/>19173:                         client =&gt; Client#ev.pid},
<a name="19174"/>19174:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="19175"/>19175: 
<a name="api_opt_sock_timestamp_tcp-last_expr"/><a name="19176"/>19176: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="19177"/>19177: 
<a name="19178"/>19178: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19179"/>19179: 
<a name="19180"/>19180: <i>%% Tests that the add_mambership and drop_membership ip options work.</i>
<a name="19181"/>19181: <i>%% We create one server and two clients. The server only send messages,</i>
<a name="19182"/>19182: <i>%% the clients only receives messages.</i>
<a name="19183"/>19183: <i>%% An UDP datagram is forbidden (RFC 1122) from having a source address</i>
<a name="19184"/>19184: <i>%% that is a multicast address (or a broadcast address).</i>
<a name="19185"/>19185: <i>%% So, the server create a socket &quot;for sending&quot; and the clients sockets</i>
<a name="19186"/>19186: <i>%% &quot;for receiving&quot;.</i>
<a name="19187"/>19187: <i>%% Sending socket:   Bound to the local address (and any port).</i>
<a name="19188"/>19188: <i>%%                   When sending, the dest will be the multicast address</i>
<a name="19189"/>19189: <i>%%                   and port of the receiving socket.</i>
<a name="19190"/>19190: <i>%% Receiving socket: Bound to the multicast address and port.</i>
<a name="api_opt_ip_add_drop_membership-0"/><a name="19191"/>19191: <b>api_opt_ip_add_drop_membership</b>() -&gt;
<a name="api_opt_ip_add_drop_membership-last_expr"/><a name="19192"/>19192: <b>    [{doc, &quot;OTP-15908 </b>(ERL-980)&quot;}].
<a name="19193"/>19193: 
<a name="api_opt_ip_add_drop_membership-1"/><a name="19194"/>19194: <b>api_opt_ip_add_drop_membership</b>(_Config) when is_list(_Config) -&gt;
<a name="19195"/>19195:     ?TT(?SECS(30)),
<a name="api_opt_ip_add_drop_membership-last_expr"/><a name="19196"/>19196: <b>    tc_try</b>(api_opt_ip_add_drop_membership,
<a name="19197"/>19197:            fun() -&gt;
<a name="19198"/>19198:                    has_support_ip_add_membership(),
<a name="19199"/>19199:                    has_support_ip_drop_membership(),
<a name="19200"/>19200:                    has_support_ip_multicast()
<a name="19201"/>19201:            end,
<a name="19202"/>19202:            fun() -&gt; api_opt_ip_add_drop_membership_do() end).
<a name="19203"/>19203: 
<a name="19204"/>19204: 
<a name="api_opt_ip_add_drop_membership_do-0"/><a name="19205"/>19205: <b>api_opt_ip_add_drop_membership_do</b>() -&gt;
<a name="19206"/>19206:     Set = fun(S, Key, Val) -&gt;
<a name="19207"/>19207:                   socket:setopt(S, ip, Key, Val)
<a name="19208"/>19208:           end,
<a name="19209"/>19209:     AddMembership  = fun(S, Val) -&gt; Set(S, add_membership,  Val) end,
<a name="19210"/>19210:     DropMembership = fun(S, Val) -&gt; Set(S, drop_membership, Val) end,
<a name="19211"/>19211: 
<a name="19212"/>19212:     ServerSeq =
<a name="19213"/>19213:         [
<a name="19214"/>19214:          %% *** Wait for start order part ***
<a name="19215"/>19215:          #{desc =&gt; &quot;await start&quot;,
<a name="19216"/>19216:            cmd  =&gt; fun(State) -&gt;
<a name="19217"/>19217:                            {Tester, MSA} = ?SEV_AWAIT_START(),
<a name="19218"/>19218:                            {ok, State#{tester =&gt; Tester, msa =&gt; MSA}}
<a name="19219"/>19219:                    end},
<a name="19220"/>19220:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="19221"/>19221:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19222"/>19222:                            _MRef = erlang:monitor(process, Tester),
<a name="19223"/>19223:                            ok
<a name="19224"/>19224:                    end},
<a name="19225"/>19225: 
<a name="19226"/>19226:          %% *** Init part ***
<a name="19227"/>19227:          #{desc =&gt; &quot;which local address&quot;,
<a name="19228"/>19228:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="19229"/>19229:                            LSA = which_local_socket_addr(Domain),
<a name="19230"/>19230:                            {ok, State#{local_sa =&gt; LSA}}
<a name="19231"/>19231:                    end},
<a name="19232"/>19232:          #{desc =&gt; &quot;create socket&quot;,
<a name="19233"/>19233:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="19234"/>19234:                            case socket:open(Domain, dgram, udp) of
<a name="19235"/>19235:                                {ok, Sock} -&gt;
<a name="19236"/>19236:                                    {ok, State#{sock =&gt; Sock}};
<a name="19237"/>19237:                                {error, _} = ERROR -&gt;
<a name="19238"/>19238:                                    ERROR
<a name="19239"/>19239:                            end
<a name="19240"/>19240:                    end},
<a name="19241"/>19241:          #{desc =&gt; &quot;make recv socket reuse addr&quot;,
<a name="19242"/>19242:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="19243"/>19243:                            case socket:setopt(Sock, socket, reuseaddr, true) of
<a name="19244"/>19244:                                ok -&gt;
<a name="19245"/>19245:                                    ok;
<a name="19246"/>19246:                                {error, Reason} = ERROR -&gt;
<a name="19247"/>19247:                                    ?SEV_EPRINT(&quot;Failed set reuseaddr: &quot;
<a name="19248"/>19248:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="19249"/>19249:                                    ERROR
<a name="19250"/>19250:                            end
<a name="19251"/>19251:                    end},
<a name="19252"/>19252:          #{desc =&gt; &quot;bind recv socket to multicast address&quot;,
<a name="19253"/>19253:            cmd  =&gt; fun(#{sock := Sock, msa := MSA} = State) -&gt;
<a name="19254"/>19254:                            case sock_bind(Sock, MSA) of
<a name="19255"/>19255:                                ok -&gt;
<a name="19256"/>19256:                                    Port = sock_port(Sock),
<a name="19257"/>19257:                                    ?SEV_IPRINT(&quot;bound to:&quot;
<a name="19258"/>19258:                                                &quot;~n   ~p&quot;, [Port]),
<a name="19259"/>19259:                                    {ok, State#{msa =&gt; MSA#{port =&gt; Port}}};
<a name="19260"/>19260:                                {error, _} = ERROR -&gt;
<a name="19261"/>19261:                                    ERROR
<a name="19262"/>19262:                            end
<a name="19263"/>19263:                    end},
<a name="19264"/>19264:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="19265"/>19265:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19266"/>19266:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="19267"/>19267:                            ok
<a name="19268"/>19268:                    end},
<a name="19269"/>19269: 
<a name="19270"/>19270:          %% The actual test
<a name="19271"/>19271:          #{desc =&gt; &quot;await continue (add_membership)&quot;,
<a name="19272"/>19272:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19273"/>19273:                            ?SEV_AWAIT_CONTINUE(Tester, tester, add_membership)
<a name="19274"/>19274:                    end},
<a name="19275"/>19275:          #{desc =&gt; &quot;add membership&quot;,
<a name="19276"/>19276:            cmd  =&gt; fun(#{sock     := Sock,
<a name="19277"/>19277:                          msa      := #{addr := MAddr},
<a name="19278"/>19278:                          local_sa := #{addr := Addr}} = State) -&gt;
<a name="19279"/>19279:                            MReq = #{multiaddr =&gt; MAddr,
<a name="19280"/>19280:                                     interface =&gt; Addr},
<a name="19281"/>19281:                            ?SEV_IPRINT(&quot;try add membership to:&quot;
<a name="19282"/>19282:                                        &quot;~n   ~p&quot;, [MReq]),
<a name="19283"/>19283:                            case AddMembership(Sock, MReq) of
<a name="19284"/>19284:                                ok -&gt;
<a name="19285"/>19285:                                    ?SEV_IPRINT(&quot;membership added&quot;),
<a name="19286"/>19286:                                    {ok, State#{mreq =&gt; MReq}};
<a name="19287"/>19287:                                {error, Reason} = ERROR -&gt;
<a name="19288"/>19288:                                    ?SEV_EPRINT(&quot;Failed adding membership to: &quot;
<a name="19289"/>19289:                                                &quot;~n   ~p&quot;
<a name="19290"/>19290:                                                &quot;~n   Reason:  ~p&quot;,
<a name="19291"/>19291:                                                [MReq, Reason]),
<a name="19292"/>19292:                                    ERROR
<a name="19293"/>19293:                            end
<a name="19294"/>19294:                    end},
<a name="19295"/>19295:          #{desc =&gt; &quot;announce ready (add-membership)&quot;,
<a name="19296"/>19296:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19297"/>19297:                            ?SEV_ANNOUNCE_READY(Tester, add_membership),
<a name="19298"/>19298:                            ok
<a name="19299"/>19299:                    end},
<a name="19300"/>19300: 
<a name="19301"/>19301:          #{desc =&gt; &quot;await continue (drop_membership)&quot;,
<a name="19302"/>19302:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19303"/>19303:                            ?SEV_AWAIT_CONTINUE(Tester, tester, drop_membership)
<a name="19304"/>19304:                    end},
<a name="19305"/>19305:          #{desc =&gt; &quot;drop membership&quot;,
<a name="19306"/>19306:            cmd  =&gt; fun(#{sock := Sock,
<a name="19307"/>19307:                          mreq := MReq} = State) -&gt;
<a name="19308"/>19308:                            ?SEV_IPRINT(&quot;try drop membership from:&quot;
<a name="19309"/>19309:                                        &quot;~n   ~p&quot;, [MReq]),
<a name="19310"/>19310:                            case DropMembership(Sock, MReq) of
<a name="19311"/>19311:                                ok -&gt;
<a name="19312"/>19312:                                    ?SEV_IPRINT(&quot;membership dropped&quot;),
<a name="19313"/>19313:                                    {ok, maps:remove(mreq, State)};
<a name="19314"/>19314:                                {error, Reason} = ERROR -&gt;
<a name="19315"/>19315:                                    ?SEV_EPRINT(&quot;Failed drop membership from: &quot;
<a name="19316"/>19316:                                                &quot;~n   ~p&quot;
<a name="19317"/>19317:                                                &quot;~n   Reason:  ~p&quot;,
<a name="19318"/>19318:                                                [MReq, Reason]),
<a name="19319"/>19319:                                    ERROR
<a name="19320"/>19320:                            end
<a name="19321"/>19321:                    end},
<a name="19322"/>19322:          #{desc =&gt; &quot;announce ready (drop-membership)&quot;,
<a name="19323"/>19323:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19324"/>19324:                            ?SEV_ANNOUNCE_READY(Tester, drop_membership),
<a name="19325"/>19325:                            ok
<a name="19326"/>19326:                    end},
<a name="19327"/>19327: 
<a name="19328"/>19328: 
<a name="19329"/>19329:          %% Termination
<a name="19330"/>19330:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="19331"/>19331:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="19332"/>19332:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="19333"/>19333:                                ok -&gt;
<a name="19334"/>19334:                                    {ok, maps:remove(tester, State)};
<a name="19335"/>19335:                                {error, _} = ERROR -&gt;
<a name="19336"/>19336:                                    ERROR
<a name="19337"/>19337:                            end
<a name="19338"/>19338:                    end},
<a name="19339"/>19339:          #{desc =&gt; &quot;close socket&quot;,
<a name="19340"/>19340:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="19341"/>19341:                            socket:close(Sock),
<a name="19342"/>19342:                            {ok, maps:remove(sock, State)}
<a name="19343"/>19343:                    end},
<a name="19344"/>19344: 
<a name="19345"/>19345:          %% *** We are done ***
<a name="19346"/>19346:          ?SEV_FINISH_NORMAL
<a name="19347"/>19347:         ],
<a name="19348"/>19348: 
<a name="19349"/>19349: 
<a name="19350"/>19350:     TesterSeq =
<a name="19351"/>19351:         [
<a name="19352"/>19352:          %% *** Init part ***
<a name="19353"/>19353:          #{desc =&gt; &quot;monitor server&quot;,
<a name="19354"/>19354:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19355"/>19355:                            _MRef = erlang:monitor(process, Server),
<a name="19356"/>19356:                            ok
<a name="19357"/>19357:                    end},
<a name="19358"/>19358: 
<a name="19359"/>19359:          %% Start the server
<a name="19360"/>19360:          #{desc =&gt; &quot;order server start&quot;,
<a name="19361"/>19361:            cmd  =&gt; fun(#{server := Pid, msa := MSA} = _State) -&gt;
<a name="19362"/>19362:                            ?SEV_ANNOUNCE_START(Pid, MSA),
<a name="19363"/>19363:                            ok
<a name="19364"/>19364:                    end},
<a name="19365"/>19365:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="19366"/>19366:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="19367"/>19367:                            case ?SEV_AWAIT_READY(Pid, server, init) of
<a name="19368"/>19368:                                ok -&gt;
<a name="19369"/>19369:                                    ok;
<a name="19370"/>19370:                                {error, Reason} = ERROR -&gt;
<a name="19371"/>19371:                                    ?SEV_EPRINT(&quot;Start of server failed: &quot;
<a name="19372"/>19372:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="19373"/>19373:                                    ERROR
<a name="19374"/>19374:                            end
<a name="19375"/>19375:                    end},
<a name="19376"/>19376: 
<a name="19377"/>19377: 
<a name="19378"/>19378:          %% *** The actual test ***
<a name="19379"/>19379:          #{desc =&gt; &quot;order server to continue (add-membership)&quot;,
<a name="19380"/>19380:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19381"/>19381:                            ?SEV_ANNOUNCE_CONTINUE(Server, add_membership),
<a name="19382"/>19382:                            ok
<a name="19383"/>19383:                    end},
<a name="19384"/>19384:          #{desc =&gt; &quot;await server ready (add-membership)&quot;,
<a name="19385"/>19385:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19386"/>19386:                            ?SEV_AWAIT_READY(Server, server, add_membership)
<a name="19387"/>19387:                    end},
<a name="19388"/>19388: 
<a name="19389"/>19389:          #{desc =&gt; &quot;order server to continue (drop-membership)&quot;,
<a name="19390"/>19390:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19391"/>19391:                            ?SEV_ANNOUNCE_CONTINUE(Server, drop_membership),
<a name="19392"/>19392:                            ok
<a name="19393"/>19393:                    end},
<a name="19394"/>19394:          #{desc =&gt; &quot;await server ready (drop-membership)&quot;,
<a name="19395"/>19395:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19396"/>19396:                            ?SEV_AWAIT_READY(Server, server, drop_membership)
<a name="19397"/>19397:                    end},
<a name="19398"/>19398: 
<a name="19399"/>19399:          ?SEV_SLEEP(?SECS(1)),
<a name="19400"/>19400: 
<a name="19401"/>19401:          %% *** Termination ***
<a name="19402"/>19402:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="19403"/>19403:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19404"/>19404:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="19405"/>19405:                            ok
<a name="19406"/>19406:                    end},
<a name="19407"/>19407:          #{desc =&gt; &quot;await server termination&quot;,
<a name="19408"/>19408:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="19409"/>19409:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="19410"/>19410:                            {ok, maps:remove(server, State)}
<a name="19411"/>19411:                    end},
<a name="19412"/>19412: 
<a name="19413"/>19413:          %% *** We are done ***
<a name="19414"/>19414:          ?SEV_FINISH_NORMAL
<a name="19415"/>19415:         ],
<a name="19416"/>19416: 
<a name="19417"/>19417: 
<a name="19418"/>19418:     Domain = inet,
<a name="19419"/>19419:     i(&quot;get multicast address&quot;),
<a name="19420"/>19420:     MAddr  = which_ip_multicast_address(),
<a name="19421"/>19421:     MSA    = #{family =&gt; Domain, addr =&gt; MAddr},
<a name="19422"/>19422: 
<a name="19423"/>19423:     i(&quot;start server evaluator&quot;),
<a name="19424"/>19424:     ServerInitState = #{domain =&gt; Domain},
<a name="19425"/>19425:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="19426"/>19426: 
<a name="19427"/>19427:     i(&quot;start tester evaluator&quot;),
<a name="19428"/>19428:     TesterInitState = #{domain  =&gt; Domain,
<a name="19429"/>19429:                         msa     =&gt; MSA,
<a name="19430"/>19430:                         server  =&gt; Server#ev.pid},
<a name="19431"/>19431:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="19432"/>19432: 
<a name="19433"/>19433:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_ip_add_drop_membership_do-last_expr"/><a name="19434"/>19434: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester, Server]).
<a name="19435"/>19435: 
<a name="19436"/>19436: 
<a name="19437"/>19437: 
<a name="which_ip_multicast_address-0"/><a name="19438"/>19438: <b>which_ip_multicast_address</b>() -&gt;
<a name="which_ip_multicast_address-last_expr"/><a name="19439"/>19439: <b>    which_multicast_address</b>(inet).
<a name="19440"/>19440: 
<a name="which_multicast_address-1"/><a name="19441"/>19441: <b>which_multicast_address</b>(Domain) -&gt;
<a name="which_multicast_address-last_expr"/><a name="19442"/>19442: <b>    case os:type</b>() of
<a name="19443"/>19443:         {unix, linux} -&gt;
<a name="19444"/>19444:             WhichMAddr = fun([_, _, MAddr]) -&gt; MAddr end,
<a name="19445"/>19445:             which_multicast_address2(Domain, WhichMAddr);
<a name="19446"/>19446: 
<a name="19447"/>19447:         {unix, sunos} -&gt;
<a name="19448"/>19448:             WhichMAddr = fun([_, MAddr, _]) -&gt; MAddr end,
<a name="19449"/>19449:             which_multicast_address2(Domain, WhichMAddr);
<a name="19450"/>19450: 
<a name="19451"/>19451:         Type -&gt;
<a name="19452"/>19452:             %% Actually, what is &quot;not supported&quot;. is netstat!
<a name="19453"/>19453:             not_supported({multicast, Type})
<a name="19454"/>19454:     end.
<a name="19455"/>19455: 
<a name="19456"/>19456: <i>%% Note that the 'netstat -g' table looks different on linux and SunOS</i>
<a name="19457"/>19457: <i>%% Linux: IfName - RefCnt - Group</i>
<a name="19458"/>19458: <i>%% SunOS: IfName - Group  - RefCnt</i>
<a name="19459"/>19459: 
<a name="which_multicast_address2-2"/><a name="19460"/>19460: <b>which_multicast_address2</b>(Domain, WhichMAddr) -&gt;
<a name="19461"/>19461:     IfName = which_local_host_ifname(Domain),
<a name="19462"/>19462:     %% On some platforms the netstat barfs out some crap on stderr
<a name="19463"/>19463:     %% before the actual info...
<a name="19464"/>19464:     %% ...without the 'n' (that is; just '-g') this command can take a
<a name="19465"/>19465:     %% *long* time. *With* the 'n' its much better. But just to be on
<a name="19466"/>19466:     %% the safe side, we add a timeout of 10 seconds.
<a name="which_multicast_address2-last_expr"/><a name="19467"/>19467: <b>    case ?SLIB:os_cmd</b>(&quot;netstat -gn 2&gt;/dev/null | grep &quot; ++ IfName, ?SECS(10)) of
<a name="19468"/>19468:         {error, timeout} -&gt;
<a name="19469"/>19469:             skip({netstat, timeout});
<a name="19470"/>19470:         {ok, []} -&gt;
<a name="19471"/>19471:             %% Can't figure out if we support multicast or not...
<a name="19472"/>19472:             not_supported(no_netstat);
<a name="19473"/>19473:         {ok, NetstatGroupsStr} -&gt;
<a name="19474"/>19474:             try
<a name="19475"/>19475:                 begin
<a name="19476"/>19476:                     NetstatGroups0   = string:tokens(NetstatGroupsStr, [$\n]),
<a name="19477"/>19477:                     NetstatGroups    = [string:tokens(G, [$ ]) || 
<a name="19478"/>19478:                                            G &lt;- NetstatGroups0],
<a name="19479"/>19479:                     MAddrs           = [WhichMAddr(NetstatGroup) || 
<a name="19480"/>19480:                                            NetstatGroup &lt;- NetstatGroups],
<a name="19481"/>19481:                     which_multicast_address3(Domain, MAddrs)
<a name="19482"/>19482:                 end
<a name="19483"/>19483:             catch
<a name="19484"/>19484:                 throw:E:_ -&gt;
<a name="19485"/>19485:                     throw(E);
<a name="19486"/>19486:                 C:E:S -&gt;
<a name="19487"/>19487:                     not_supported({multicast, {C,E,S}})
<a name="19488"/>19488:             end
<a name="19489"/>19489:     end.
<a name="19490"/>19490: 
<a name="which_multicast_address3-2"/><a name="19491"/>19491: <b>which_multicast_address3</b>(_Domain, []) -&gt;
<a name="19492"/>19492:     not_supported({multicast, no_valid_addrs});
<a name="19493"/>19493: <b>which_multicast_address3</b>(Domain, [MAddrStr|MAddrs]) -&gt;
<a name="19494"/>19494:     %% Even on linux some of these are not actually addresses, but
<a name="19495"/>19495:     %% &quot;host names&quot;, such as all-systems.mcast.net. But both
<a name="19496"/>19496:     %% address strings, such as &quot;224.0.0.251&quot; and host name strings
<a name="19497"/>19497:     %% gets translated into an address by the inet:inet:getaddr/2.
<a name="which_multicast_address3-last_expr"/><a name="19498"/>19498: <b>    case inet:getaddr</b>(MAddrStr, Domain) of
<a name="19499"/>19499:         {ok, MAddr} -&gt;
<a name="19500"/>19500:             MAddr;
<a name="19501"/>19501:         {error, _} -&gt;
<a name="19502"/>19502:             which_multicast_address3(Domain, MAddrs)
<a name="19503"/>19503:     end.
<a name="19504"/>19504:     
<a name="which_local_host_ifname-1"/><a name="19505"/>19505: <b>which_local_host_ifname</b>(Domain) -&gt;
<a name="which_local_host_ifname-last_expr"/><a name="19506"/>19506: <b>    case ?SLIB:which_local_host_info</b>(Domain) of
<a name="19507"/>19507:         {ok, #{name := Name}} -&gt;
<a name="19508"/>19508:             Name;
<a name="19509"/>19509:         {error, Reason} -&gt;
<a name="19510"/>19510:             not_supported({multicast, Reason})
<a name="19511"/>19511:     end.
<a name="19512"/>19512: 
<a name="19513"/>19513:     
<a name="19514"/>19514: 
<a name="19515"/>19515: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19516"/>19516: 
<a name="19517"/>19517: <i>%% Tests that the pktinfo control message header is received when</i>
<a name="19518"/>19518: <i>%% setting the socket 'ip' option pktinfo is set to true when using</i>
<a name="19519"/>19519: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="19520"/>19520: <i>%% So, this is done on the receiving side: </i>
<a name="19521"/>19521: <i>%%</i>
<a name="19522"/>19522: <i>%%               socket:setopt(Sock, ip, pktinfo, boolean()).</i>
<a name="19523"/>19523: <i>%%</i>
<a name="19524"/>19524: <i>%% For all subsequent *received* messages, the pktinfo control message</i>
<a name="19525"/>19525: <i>%% header will be with the message.</i>
<a name="19526"/>19526: <i>%%</i>
<a name="19527"/>19527: <i>%% Note that it *should* be possible to explicitly send pktinfo also,</i>
<a name="19528"/>19528: <i>%% but this have not yet been implemented (in socket), so that part</i>
<a name="19529"/>19529: <i>%% we do not test!!</i>
<a name="19530"/>19530: <i>%%</i>
<a name="19531"/>19531: 
<a name="api_opt_ip_pktinfo_udp4-1"/><a name="19532"/>19532: <b>api_opt_ip_pktinfo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="19533"/>19533:     ?TT(?SECS(5)),
<a name="api_opt_ip_pktinfo_udp4-last_expr"/><a name="19534"/>19534: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="19535"/>19535:            fun() -&gt; has_support_ipv4(), has_support_ip_pktinfo() end,
<a name="19536"/>19536:            fun() -&gt;
<a name="19537"/>19537:                    Set  = fun(Sock, Value) -&gt;
<a name="19538"/>19538:                                   socket:setopt(Sock, ip, pktinfo, Value)
<a name="19539"/>19539:                           end,
<a name="19540"/>19540:                    Get  = fun(Sock) -&gt;
<a name="19541"/>19541:                                   socket:getopt(Sock, ip, pktinfo)
<a name="19542"/>19542:                           end,
<a name="19543"/>19543:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="19544"/>19544:                                   Msg = #{addr =&gt; Dest,
<a name="19545"/>19545:                                           iov  =&gt; [Data]},
<a name="19546"/>19546:                                   socket:sendmsg(Sock, Msg);
<a name="19547"/>19547:                              (Sock, Data, Dest, Info) -&gt;
<a name="19548"/>19548:                                   %% We do not support this at the moment!!!
<a name="19549"/>19549:                                   CMsg = #{level =&gt; ip,
<a name="19550"/>19550:                                            type  =&gt; pktinfo,
<a name="19551"/>19551:                                            data  =&gt; Info},
<a name="19552"/>19552:                                   Msg  = #{addr =&gt; Dest,
<a name="19553"/>19553:                                            ctrl =&gt; [CMsg],
<a name="19554"/>19554:                                            iov  =&gt; [Data]},
<a name="19555"/>19555:                                   socket:sendmsg(Sock, Msg)
<a name="19556"/>19556:                           end,
<a name="19557"/>19557:                    Recv = fun(Sock) -&gt;
<a name="19558"/>19558:                                   case socket:recvmsg(Sock) of
<a name="19559"/>19559:                                       {ok, #{addr := Source,
<a name="19560"/>19560:                                              ctrl := CMsgs,
<a name="19561"/>19561:                                              iov  := [Data]}} -&gt;
<a name="19562"/>19562:                                           {ok, {Source, CMsgs, Data}};
<a name="19563"/>19563:                                       {error, _} = ERROR -&gt;
<a name="19564"/>19564:                                           ERROR
<a name="19565"/>19565:                                   end
<a name="19566"/>19566:                           end,
<a name="19567"/>19567:                    InitState = #{domain =&gt; inet,
<a name="19568"/>19568:                                  proto  =&gt; udp,
<a name="19569"/>19569:                                  send   =&gt; Send,
<a name="19570"/>19570:                                  recv   =&gt; Recv,
<a name="19571"/>19571:                                  set    =&gt; Set,
<a name="19572"/>19572:                                  get    =&gt; Get},
<a name="19573"/>19573:                    ok = api_opt_ip_pktinfo_udp(InitState)
<a name="19574"/>19574:            end).
<a name="19575"/>19575: 
<a name="19576"/>19576: 
<a name="19577"/>19577: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19578"/>19578: 
<a name="api_opt_ip_pktinfo_udp-1"/><a name="19579"/>19579: <b>api_opt_ip_pktinfo_udp</b>(InitState) -&gt;
<a name="19580"/>19580:     Seq = 
<a name="19581"/>19581:         [
<a name="19582"/>19582:          #{desc =&gt; &quot;local address&quot;,
<a name="19583"/>19583:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="19584"/>19584:                            LSASrc = which_local_socket_addr(Domain),
<a name="19585"/>19585:                            LSADst = which_local_socket_addr(Domain),
<a name="19586"/>19586:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="19587"/>19587:                                        lsa_dst =&gt; LSADst}};
<a name="19588"/>19588:                       (#{domain := Domain} = State) -&gt;
<a name="19589"/>19589:                            LSA = which_local_socket_addr(Domain),
<a name="19590"/>19590:                            {ok, State#{lsa_src =&gt; LSA,
<a name="19591"/>19591:                                        lsa_dst =&gt; LSA}}
<a name="19592"/>19592:                    end},
<a name="19593"/>19593: 
<a name="19594"/>19594:          #{desc =&gt; &quot;open src socket&quot;,
<a name="19595"/>19595:            cmd  =&gt; fun(#{domain := Domain,
<a name="19596"/>19596:                          proto  := Proto} = State) -&gt;
<a name="19597"/>19597:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19598"/>19598:                            {ok, State#{sock_src =&gt; Sock}}
<a name="19599"/>19599:                    end},
<a name="19600"/>19600:          #{desc =&gt; &quot;bind src&quot;,
<a name="19601"/>19601:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="19602"/>19602:                            case sock_bind(Sock, LSA) of
<a name="19603"/>19603:                                ok -&gt;
<a name="19604"/>19604:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19605"/>19605:                                    ok;
<a name="19606"/>19606:                                {error, Reason} = ERROR -&gt;
<a name="19607"/>19607:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19608"/>19608:                                    ERROR
<a name="19609"/>19609:                            end
<a name="19610"/>19610:                    end},
<a name="19611"/>19611:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="19612"/>19612:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="19613"/>19613:                            SASrc = sock_sockname(Sock),
<a name="19614"/>19614:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="19615"/>19615:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="19616"/>19616:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="19617"/>19617:                    end},
<a name="19618"/>19618: 
<a name="19619"/>19619:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="19620"/>19620:            cmd  =&gt; fun(#{domain := Domain,
<a name="19621"/>19621:                          proto  := Proto} = State) -&gt;
<a name="19622"/>19622:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19623"/>19623:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="19624"/>19624:                    end},
<a name="19625"/>19625:          #{desc =&gt; &quot;bind dst&quot;,
<a name="19626"/>19626:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="19627"/>19627:                            case sock_bind(Sock, LSA) of
<a name="19628"/>19628:                                ok -&gt;
<a name="19629"/>19629:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19630"/>19630:                                    ok;
<a name="19631"/>19631:                                {error, Reason} = ERROR -&gt;
<a name="19632"/>19632:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19633"/>19633:                                    ERROR
<a name="19634"/>19634:                            end
<a name="19635"/>19635:                    end},
<a name="19636"/>19636:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="19637"/>19637:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="19638"/>19638:                            SADst = sock_sockname(Sock),
<a name="19639"/>19639:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="19640"/>19640:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="19641"/>19641:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="19642"/>19642:                    end},
<a name="19643"/>19643:          #{desc =&gt; &quot;get default pktinfo for dst socket&quot;,
<a name="19644"/>19644:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="19645"/>19645:                            case Get(Sock) of
<a name="19646"/>19646:                                {ok, false = Value} -&gt;
<a name="19647"/>19647:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="19648"/>19648:                                    ok;
<a name="19649"/>19649:                                {ok, Unexpected} -&gt;
<a name="19650"/>19650:                                    ?SEV_EPRINT(&quot;Unexpected src pktinfo: ~p&quot;,
<a name="19651"/>19651:                                                [Unexpected]),
<a name="19652"/>19652:                                    {error, {unexpected, Unexpected}};
<a name="19653"/>19653:                                {error, Reason} = ERROR -&gt;
<a name="19654"/>19654:                                    ?SEV_EPRINT(&quot;Failed getting (default) pktinfo:&quot;
<a name="19655"/>19655:                                                &quot;   ~p&quot;, [Reason]),
<a name="19656"/>19656:                                    ERROR
<a name="19657"/>19657:                            end
<a name="19658"/>19658:                    end},
<a name="19659"/>19659: 
<a name="19660"/>19660:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) pktinfo)&quot;,
<a name="19661"/>19661:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19662"/>19662:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="19663"/>19663:                    end},
<a name="19664"/>19664:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="19665"/>19665:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19666"/>19666:                            case Recv(Sock) of
<a name="19667"/>19667:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="19668"/>19668:                                    ok;
<a name="19669"/>19669:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19670"/>19670:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19671"/>19671:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19672"/>19672:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="19673"/>19673:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19674"/>19674:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19675"/>19675:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19676"/>19676:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="19677"/>19677:                                                [Src, BadSrc,
<a name="19678"/>19678:                                                 [], BadCHdrs,
<a name="19679"/>19679:                                                 ?BASIC_REQ, BadReq]),
<a name="19680"/>19680:                                    {error, {unexpected_data, UnexpData}};
<a name="19681"/>19681:                                {ok, UnexpData} -&gt;
<a name="19682"/>19682:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19683"/>19683:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19684"/>19684:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19685"/>19685:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19686"/>19686:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="19687"/>19687:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19688"/>19688:                                    {error, {unexpected_data, UnexpData}};
<a name="19689"/>19689:                                {error, _} = ERROR -&gt;
<a name="19690"/>19690:                                    %% At the moment there is no way to get
<a name="19691"/>19691:                                    %% status or state for the socket...
<a name="19692"/>19692:                                    ERROR
<a name="19693"/>19693:                            end
<a name="19694"/>19694:                    end},
<a name="19695"/>19695: 
<a name="19696"/>19696: 
<a name="19697"/>19697:          %% *** We do not *yet* support sending pktinfo ***
<a name="19698"/>19698: 
<a name="19699"/>19699:          %% #{desc =&gt; &quot;send req (to dst) (w explicit pktinfo)&quot;,
<a name="19700"/>19700:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19701"/>19701:          %%                   Send(Sock, ?BASIC_REQ, Dst, PktInfo)
<a name="19702"/>19702:          %%           end},
<a name="19703"/>19703:          %% #{desc =&gt; &quot;recv req (from src) - wo pktinfo&quot;,
<a name="19704"/>19704:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19705"/>19705:          %%                   case Recv(Sock) of
<a name="19706"/>19706:          %%                       {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="19707"/>19707:          %%                           ok;
<a name="19708"/>19708:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19709"/>19709:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19710"/>19710:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="19711"/>19711:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="19712"/>19712:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19713"/>19713:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19714"/>19714:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="19715"/>19715:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="19716"/>19716:          %%                                       [Src, BadSrc,
<a name="19717"/>19717:          %%                                        [], BadCHdrs,
<a name="19718"/>19718:          %%                                        ?BASIC_REQ, BadReq]),
<a name="19719"/>19719:          %%                           {error, {unexpected_data, UnexpData}};
<a name="19720"/>19720:          %%                       {ok, UnexpData} -&gt;
<a name="19721"/>19721:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19722"/>19722:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="19723"/>19723:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19724"/>19724:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="19725"/>19725:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="19726"/>19726:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19727"/>19727:          %%                           {error, {unexpected_data, UnexpData}};
<a name="19728"/>19728:          %%                       {error, _} = ERROR -&gt;
<a name="19729"/>19729:          %%                           %% At the moment there is no way to get
<a name="19730"/>19730:          %%                           %% status or state for the socket...
<a name="19731"/>19731:          %%                           ERROR
<a name="19732"/>19732:          %%                   end
<a name="19733"/>19733:          %%           end},
<a name="19734"/>19734: 
<a name="19735"/>19735:          #{desc =&gt; &quot;enable pktinfo on dst socket&quot;,
<a name="19736"/>19736:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="19737"/>19737:                            case Set(Sock, true) of
<a name="19738"/>19738:                                ok -&gt;
<a name="19739"/>19739:                                    ?SEV_IPRINT(&quot;dst pktinfo enabled&quot;),
<a name="19740"/>19740:                                    ok;
<a name="19741"/>19741:                                {error, Reason} = ERROR -&gt;
<a name="19742"/>19742:                                    ?SEV_EPRINT(&quot;Failed setting pktinfo:&quot;
<a name="19743"/>19743:                                                &quot;   ~p&quot;, [Reason]),
<a name="19744"/>19744:                                    ERROR
<a name="19745"/>19745:                            end
<a name="19746"/>19746:                    end},
<a name="19747"/>19747: 
<a name="19748"/>19748:          #{desc =&gt; &quot;send req (to dst) (wo explicit pktinfo)&quot;,
<a name="19749"/>19749:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19750"/>19750:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="19751"/>19751:                    end},
<a name="19752"/>19752:          #{desc =&gt; &quot;recv req (from src) - w default pktinfo&quot;,
<a name="19753"/>19753:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19754"/>19754:                            case Recv(Sock) of
<a name="19755"/>19755:                                {ok, {Src, [#{level := ip,
<a name="19756"/>19756:                                              type  := pktinfo,
<a name="19757"/>19757:                                              value := #{addr     := Addr,
<a name="19758"/>19758:                                                         ifindex  := IfIdx,
<a name="19759"/>19759:                                                         spec_dst := SpecDst}}],
<a name="19760"/>19760:                                      ?BASIC_REQ}} -&gt;
<a name="19761"/>19761:                                    ?SEV_IPRINT(&quot;Got (default) Pkt Info: &quot;
<a name="19762"/>19762:                                                &quot;~n   Addr:      ~p&quot;
<a name="19763"/>19763:                                                &quot;~n   If Index:  ~p&quot;
<a name="19764"/>19764:                                                &quot;~n   Spec Dst:  ~p&quot;,
<a name="19765"/>19765:                                                [Addr, IfIdx, SpecDst]),
<a name="19766"/>19766:                                    ok;
<a name="19767"/>19767:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19768"/>19768:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19769"/>19769:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19770"/>19770:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="19771"/>19771:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19772"/>19772:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19773"/>19773:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19774"/>19774:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="19775"/>19775:                                                [Src, BadSrc,
<a name="19776"/>19776:                                                 [], BadCHdrs,
<a name="19777"/>19777:                                                 ?BASIC_REQ, BadReq]),
<a name="19778"/>19778:                                    {error, {unexpected_data, UnexpData}};
<a name="19779"/>19779:                                {ok, UnexpData} -&gt;
<a name="19780"/>19780:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19781"/>19781:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19782"/>19782:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19783"/>19783:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19784"/>19784:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="19785"/>19785:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19786"/>19786:                                    {error, {unexpected_data, UnexpData}};
<a name="19787"/>19787:                                {error, _} = ERROR -&gt;
<a name="19788"/>19788:                                    %% At the moment there is no way to get
<a name="19789"/>19789:                                    %% status or state for the socket...
<a name="19790"/>19790:                                    ERROR
<a name="19791"/>19791:                            end
<a name="19792"/>19792:                    end},
<a name="19793"/>19793: 
<a name="19794"/>19794: 
<a name="19795"/>19795:          %% *** We do not *yet* support sending pktinfo ***
<a name="19796"/>19796: 
<a name="19797"/>19797:          %% #{desc =&gt; &quot;send req (to dst) (w explicit pktinfo)&quot;,
<a name="19798"/>19798:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19799"/>19799:          %%                   Send(Sock, ?BASIC_REQ, Dst, PktInfo)
<a name="19800"/>19800:          %%           end},
<a name="19801"/>19801:          %% #{desc =&gt; &quot;recv req (from src) - w ttl = 100&quot;,
<a name="19802"/>19802:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19803"/>19803:          %%                   case Recv(Sock) of
<a name="19804"/>19804:          %%                       {ok, {Src, [#{level := ip,
<a name="19805"/>19805:          %%                                     type  := ttl,
<a name="19806"/>19806:          %%                                     data  := PktInfo}], ?BASIC_REQ}} -&gt;
<a name="19807"/>19807:          %%                           ?SEV_IPRINT(&quot;Got Pkt Info: &quot;
<a name="19808"/>19808:          %%                                       &quot;~n   ~p&quot;, [Info]),
<a name="19809"/>19809:          %%                           ok;
<a name="19810"/>19810:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19811"/>19811:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19812"/>19812:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="19813"/>19813:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="19814"/>19814:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19815"/>19815:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19816"/>19816:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="19817"/>19817:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="19818"/>19818:          %%                                       [Src, BadSrc,
<a name="19819"/>19819:          %%                                        [], BadCHdrs,
<a name="19820"/>19820:          %%                                        ?BASIC_REQ, BadReq]),
<a name="19821"/>19821:          %%                           {error, {unexpected_data, UnexpData}};
<a name="19822"/>19822:          %%                       {ok, UnexpData} -&gt;
<a name="19823"/>19823:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19824"/>19824:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="19825"/>19825:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19826"/>19826:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="19827"/>19827:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="19828"/>19828:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19829"/>19829:          %%                           {error, {unexpected_data, UnexpData}};
<a name="19830"/>19830:          %%                       {error, _} = ERROR -&gt;
<a name="19831"/>19831:          %%                           %% At the moment there is no way to get
<a name="19832"/>19832:          %%                           %% status or state for the socket...
<a name="19833"/>19833:          %%                           ERROR
<a name="19834"/>19834:          %%                   end
<a name="19835"/>19835:          %%           end},
<a name="19836"/>19836: 
<a name="19837"/>19837:          #{desc =&gt; &quot;close src socket&quot;,
<a name="19838"/>19838:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="19839"/>19839:                            ok = socket:close(Sock),
<a name="19840"/>19840:                            {ok, maps:remove(sock_src, State)}
<a name="19841"/>19841:                    end},
<a name="19842"/>19842:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="19843"/>19843:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="19844"/>19844:                            ok = socket:close(Sock),
<a name="19845"/>19845:                            {ok, maps:remove(sock_dst, State)}
<a name="19846"/>19846:                    end},
<a name="19847"/>19847: 
<a name="19848"/>19848:          %% *** We are done ***
<a name="19849"/>19849:          ?SEV_FINISH_NORMAL
<a name="19850"/>19850:         ],
<a name="19851"/>19851:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_pktinfo_udp-last_expr"/><a name="19852"/>19852: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="19853"/>19853: 
<a name="19854"/>19854: 
<a name="19855"/>19855: 
<a name="19856"/>19856: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19857"/>19857: 
<a name="19858"/>19858: <i>%% Tests that the options control message header is received when</i>
<a name="19859"/>19859: <i>%% setting the socket 'ip' option recvopts is set to true when using</i>
<a name="19860"/>19860: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="19861"/>19861: <i>%% So, this is done on the receiving side: </i>
<a name="19862"/>19862: <i>%%</i>
<a name="19863"/>19863: <i>%%               socket:setopt(Sock, ip, recvopts, boolean()).</i>
<a name="19864"/>19864: <i>%%</i>
<a name="19865"/>19865: <i>%% For all subsequent *received* messages, the options control message</i>
<a name="19866"/>19866: <i>%% header will be with the message.</i>
<a name="19867"/>19867: <i>%%</i>
<a name="19868"/>19868: <i>%% Note that it *should* be possible to explicitly send options also,</i>
<a name="19869"/>19869: <i>%% but this have not yet been implemented (in socket), so that part</i>
<a name="19870"/>19870: <i>%% we do not test!!</i>
<a name="19871"/>19871: <i>%%</i>
<a name="19872"/>19872: <i>%%</i>
<a name="19873"/>19873: <i>%% &lt;NOTE&gt;</i>
<a name="19874"/>19874: <i>%%</i>
<a name="19875"/>19875: <i>%% This test does not currently work. The recvopts is supposed to</i>
<a name="19876"/>19876: <i>%% result in a IP_OPTIONS control message header but does not!</i>
<a name="19877"/>19877: <i>%% So, exactly how we are suppose to use this option is unknown.</i>
<a name="19878"/>19878: <i>%% So, let the test code remain, but skip until we have figured out</i>
<a name="19879"/>19879: <i>%% how to test this.</i>
<a name="19880"/>19880: <i>%%</i>
<a name="19881"/>19881: <i>%% &lt;/NOTE&gt;</i>
<a name="19882"/>19882: <i>%%</i>
<a name="19883"/>19883: 
<a name="api_opt_ip_recvopts_udp4-1"/><a name="19884"/>19884: <b>api_opt_ip_recvopts_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="19885"/>19885:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvopts_udp4-last_expr"/><a name="19886"/>19886: <b>    tc_try</b>(api_opt_ip_recvopts_udp4,
<a name="19887"/>19887:            fun() -&gt;
<a name="19888"/>19888:                    has_support_ipv4(),
<a name="19889"/>19889:                    has_support_ip_recvopts(),
<a name="19890"/>19890:                    %% We also use the recvtos and timestamp options
<a name="19891"/>19891:                    %% in this test, so at least one of them must
<a name="19892"/>19892:                    %% be supported
<a name="19893"/>19893:                    has_support_ip_recvtos_and_or_sock_timestamp(),
<a name="19894"/>19894:                    not_yet_implemented()
<a name="19895"/>19895: 
<a name="19896"/>19896:            end,
<a name="19897"/>19897:            fun() -&gt;
<a name="19898"/>19898:                    Set  = fun(Sock, Value) -&gt;
<a name="19899"/>19899:                                   socket:setopt(Sock, ip, recvopts, Value)
<a name="19900"/>19900:                           end,
<a name="19901"/>19901:                    Get  = fun(Sock) -&gt;
<a name="19902"/>19902:                                   socket:getopt(Sock, ip, recvopts)
<a name="19903"/>19903:                           end,
<a name="19904"/>19904:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="19905"/>19905:                                   Msg = #{addr =&gt; Dest,
<a name="19906"/>19906:                                              iov  =&gt; [Data]},
<a name="19907"/>19907:                                   socket:sendmsg(Sock, Msg);
<a name="19908"/>19908:                              (Sock, Data, Dest, Info) -&gt;
<a name="19909"/>19909:                                   %% We do not support this at the moment!!!
<a name="19910"/>19910:                                   CMsg = #{level =&gt; ip,
<a name="19911"/>19911:                                               type  =&gt; options,
<a name="19912"/>19912:                                               data  =&gt; Info},
<a name="19913"/>19913:                                   Msg  = #{addr =&gt; Dest,
<a name="19914"/>19914:                                               ctrl =&gt; [CMsg],
<a name="19915"/>19915:                                               iov  =&gt; [Data]},
<a name="19916"/>19916:                                   socket:sendmsg(Sock, Msg)
<a name="19917"/>19917:                           end,
<a name="19918"/>19918:                    Recv = fun(Sock) -&gt;
<a name="19919"/>19919:                                   case socket:recvmsg(Sock) of
<a name="19920"/>19920:                                       {ok, #{addr := Source,
<a name="19921"/>19921:                                              ctrl := CMsgs,
<a name="19922"/>19922:                                              iov  := [Data]}} -&gt;
<a name="19923"/>19923:                                           {ok, {Source, CMsgs, Data}};
<a name="19924"/>19924:                                       {error, _} = ERROR -&gt;
<a name="19925"/>19925:                                           ERROR
<a name="19926"/>19926:                                   end
<a name="19927"/>19927:                           end,
<a name="19928"/>19928:                    InitState = #{domain =&gt; inet,
<a name="19929"/>19929:                                  proto  =&gt; udp,
<a name="19930"/>19930:                                  send   =&gt; Send,
<a name="19931"/>19931:                                  recv   =&gt; Recv,
<a name="19932"/>19932:                                  set    =&gt; Set,
<a name="19933"/>19933:                                  get    =&gt; Get},
<a name="19934"/>19934:                    ok = api_opt_ip_recvopts_udp(InitState)
<a name="19935"/>19935:            end).
<a name="19936"/>19936: 
<a name="19937"/>19937: 
<a name="19938"/>19938: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19939"/>19939: 
<a name="api_opt_ip_recvopts_udp-1"/><a name="19940"/>19940: <b>api_opt_ip_recvopts_udp</b>(InitState) -&gt;
<a name="19941"/>19941:     Seq = 
<a name="19942"/>19942:         [
<a name="19943"/>19943:          %% Start by figure out which of the ip:recvtos and/or socket:timestamp
<a name="19944"/>19944:          %% options we can use.
<a name="19945"/>19945:          #{desc =&gt; &quot;test for ip:recvtos&quot;,
<a name="19946"/>19946:            cmd  =&gt; fun(State) -&gt;
<a name="19947"/>19947:                            ?SEV_IPRINT(&quot;test for ip:recvtos&quot;),
<a name="19948"/>19948:                            case socket:is_supported(options, ip, recvtos) of
<a name="19949"/>19949:                                true -&gt;
<a name="19950"/>19950:                                    ?SEV_IPRINT(&quot;use ip:recvtos&quot;),
<a name="19951"/>19951:                                    {ok, State#{recvtos =&gt; true}};
<a name="19952"/>19952:                                false -&gt; 
<a name="19953"/>19953:                                    ?SEV_IPRINT(&quot;do *not* use ip:recvtos&quot;),
<a name="19954"/>19954:                                    {ok, State#{recvtos =&gt; false}}
<a name="19955"/>19955:                            end
<a name="19956"/>19956:                    end},
<a name="19957"/>19957:          #{desc =&gt; &quot;test for socket:timestamp&quot;,
<a name="19958"/>19958:            cmd  =&gt; fun(State) -&gt;
<a name="19959"/>19959:                            ?SEV_IPRINT(&quot;test for socket:timestamp&quot;),
<a name="19960"/>19960:                            case socket:is_supported(options, socket, timestamp) of
<a name="19961"/>19961:                                true -&gt;
<a name="19962"/>19962:                                    ?SEV_IPRINT(&quot;use socket:timestamp&quot;),
<a name="19963"/>19963:                                    {ok, State#{timestamp =&gt; true}};
<a name="19964"/>19964:                                false -&gt; 
<a name="19965"/>19965:                                    ?SEV_IPRINT(&quot;do *not* use socket:timestamp&quot;),
<a name="19966"/>19966:                                    {ok, State#{timestamp =&gt; false}}
<a name="19967"/>19967:                            end
<a name="19968"/>19968:                    end},
<a name="19969"/>19969: 
<a name="19970"/>19970:          #{desc =&gt; &quot;local address&quot;,
<a name="19971"/>19971:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="19972"/>19972:                            LSASrc = which_local_socket_addr(Domain),
<a name="19973"/>19973:                            LSADst = which_local_socket_addr(Domain),
<a name="19974"/>19974:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="19975"/>19975:                                        lsa_dst =&gt; LSADst}};
<a name="19976"/>19976:                       (#{domain := Domain} = State) -&gt;
<a name="19977"/>19977:                            LSA = which_local_socket_addr(Domain),
<a name="19978"/>19978:                            {ok, State#{lsa_src =&gt; LSA,
<a name="19979"/>19979:                                        lsa_dst =&gt; LSA}}
<a name="19980"/>19980:                    end},
<a name="19981"/>19981: 
<a name="19982"/>19982:          #{desc =&gt; &quot;open src socket&quot;,
<a name="19983"/>19983:            cmd  =&gt; fun(#{domain := Domain,
<a name="19984"/>19984:                          proto  := Proto} = State) -&gt;
<a name="19985"/>19985:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19986"/>19986:                            {ok, State#{sock_src =&gt; Sock}}
<a name="19987"/>19987:                    end},
<a name="19988"/>19988:          #{desc =&gt; &quot;bind src&quot;,
<a name="19989"/>19989:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="19990"/>19990:                            case sock_bind(Sock, LSA) of
<a name="19991"/>19991:                                ok -&gt;
<a name="19992"/>19992:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19993"/>19993:                                    ok;
<a name="19994"/>19994:                                {error, Reason} = ERROR -&gt;
<a name="19995"/>19995:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19996"/>19996:                                    ERROR
<a name="19997"/>19997:                            end
<a name="19998"/>19998:                    end},
<a name="19999"/>19999:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="20000"/>20000:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20001"/>20001:                            SASrc = sock_sockname(Sock),
<a name="20002"/>20002:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="20003"/>20003:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="20004"/>20004:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="20005"/>20005:                    end},
<a name="20006"/>20006: 
<a name="20007"/>20007:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="20008"/>20008:            cmd  =&gt; fun(#{domain := Domain,
<a name="20009"/>20009:                          proto  := Proto} = State) -&gt;
<a name="20010"/>20010:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20011"/>20011:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="20012"/>20012:                    end},
<a name="20013"/>20013:          #{desc =&gt; &quot;bind dst&quot;,
<a name="20014"/>20014:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="20015"/>20015:                            case sock_bind(Sock, LSA) of
<a name="20016"/>20016:                                ok -&gt;
<a name="20017"/>20017:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20018"/>20018:                                    ok;
<a name="20019"/>20019:                                {error, Reason} = ERROR -&gt;
<a name="20020"/>20020:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20021"/>20021:                                    ERROR
<a name="20022"/>20022:                            end
<a name="20023"/>20023:                    end},
<a name="20024"/>20024:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="20025"/>20025:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20026"/>20026:                            SADst = sock_sockname(Sock),
<a name="20027"/>20027:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="20028"/>20028:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="20029"/>20029:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="20030"/>20030:                    end},
<a name="20031"/>20031:          #{desc =&gt; &quot;default recvopts for dst socket&quot;,
<a name="20032"/>20032:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="20033"/>20033:                            case Get(Sock) of
<a name="20034"/>20034:                                {ok, false = Value} -&gt;
<a name="20035"/>20035:                                    ?SEV_IPRINT(&quot;dst recvopts: ~p&quot;, [Value]),
<a name="20036"/>20036:                                    ok;
<a name="20037"/>20037:                                {ok, Unexpected} -&gt;
<a name="20038"/>20038:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="20039"/>20039:                                                [Unexpected]),
<a name="20040"/>20040:                                    {error, {unexpected, Unexpected}};
<a name="20041"/>20041:                                {error, Reason} = ERROR -&gt;
<a name="20042"/>20042:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="20043"/>20043:                                                &quot;   ~p&quot;, [Reason]),
<a name="20044"/>20044:                                    ERROR
<a name="20045"/>20045:                            end
<a name="20046"/>20046:                    end},
<a name="20047"/>20047: 
<a name="20048"/>20048:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) options)&quot;,
<a name="20049"/>20049:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20050"/>20050:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20051"/>20051:                    end},
<a name="20052"/>20052:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="20053"/>20053:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20054"/>20054:                            case Recv(Sock) of
<a name="20055"/>20055:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20056"/>20056:                                    ok;
<a name="20057"/>20057:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20058"/>20058:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20059"/>20059:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20060"/>20060:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20061"/>20061:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20062"/>20062:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20063"/>20063:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20064"/>20064:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20065"/>20065:                                                [Src, BadSrc,
<a name="20066"/>20066:                                                 [], BadCHdrs,
<a name="20067"/>20067:                                                 ?BASIC_REQ, BadReq]),
<a name="20068"/>20068:                                    {error, {unexpected_data, UnexpData}};
<a name="20069"/>20069:                                {ok, UnexpData} -&gt;
<a name="20070"/>20070:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20071"/>20071:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20072"/>20072:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20073"/>20073:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20074"/>20074:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20075"/>20075:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20076"/>20076:                                    {error, {unexpected_data, UnexpData}};
<a name="20077"/>20077:                                {error, _} = ERROR -&gt;
<a name="20078"/>20078:                                    %% At the moment there is no way to get
<a name="20079"/>20079:                                    %% status or state for the socket...
<a name="20080"/>20080:                                    ERROR
<a name="20081"/>20081:                            end
<a name="20082"/>20082:                    end},
<a name="20083"/>20083: 
<a name="20084"/>20084: 
<a name="20085"/>20085:          %% *** We do not *yet* support sending options ***
<a name="20086"/>20086: 
<a name="20087"/>20087:          %% #{desc =&gt; &quot;send req (to dst) (w explicit options)&quot;,
<a name="20088"/>20088:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20089"/>20089:          %%                   Send(Sock, ?BASIC_REQ, Dst, Opts)
<a name="20090"/>20090:          %%           end},
<a name="20091"/>20091:          %% #{desc =&gt; &quot;recv req (from src) - wo options&quot;,
<a name="20092"/>20092:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20093"/>20093:          %%                   case Recv(Sock) of
<a name="20094"/>20094:          %%                       {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20095"/>20095:          %%                           ok;
<a name="20096"/>20096:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20097"/>20097:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20098"/>20098:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20099"/>20099:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="20100"/>20100:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20101"/>20101:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20102"/>20102:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20103"/>20103:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="20104"/>20104:          %%                                       [Src, BadSrc,
<a name="20105"/>20105:          %%                                        [], BadCHdrs,
<a name="20106"/>20106:          %%                                        ?BASIC_REQ, BadReq]),
<a name="20107"/>20107:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20108"/>20108:          %%                       {ok, UnexpData} -&gt;
<a name="20109"/>20109:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20110"/>20110:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20111"/>20111:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20112"/>20112:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20113"/>20113:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="20114"/>20114:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20115"/>20115:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20116"/>20116:          %%                       {error, _} = ERROR -&gt;
<a name="20117"/>20117:          %%                           %% At the moment there is no way to get
<a name="20118"/>20118:          %%                           %% status or state for the socket...
<a name="20119"/>20119:          %%                           ERROR
<a name="20120"/>20120:          %%                   end
<a name="20121"/>20121:          %%           end},
<a name="20122"/>20122: 
<a name="20123"/>20123:          #{desc =&gt; &quot;enable recvopts on dst socket&quot;,
<a name="20124"/>20124:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20125"/>20125:                            case Set(Sock, true) of
<a name="20126"/>20126:                                ok -&gt;
<a name="20127"/>20127:                                    ?SEV_IPRINT(&quot;dst recvopts enabled&quot;),
<a name="20128"/>20128:                                    ok;
<a name="20129"/>20129:                                {error, Reason} = ERROR -&gt;
<a name="20130"/>20130:                                    ?SEV_EPRINT(&quot;Failed setting recvopts:&quot;
<a name="20131"/>20131:                                                &quot;   ~p&quot;, [Reason]),
<a name="20132"/>20132:                                    ERROR
<a name="20133"/>20133:                            end
<a name="20134"/>20134:                    end},
<a name="20135"/>20135: 
<a name="20136"/>20136:          %% This specific option, recvtos, is tested in another test case
<a name="20137"/>20137:          %% Note that this may not actually be supported here!!
<a name="20138"/>20138:          #{desc =&gt; &quot;maybe enable ip:recvtos on dst socket&quot;,
<a name="20139"/>20139:            cmd  =&gt; fun(#{recvtos := true, sock_dst := Sock} = _State) -&gt;
<a name="20140"/>20140:                            ?SEV_IPRINT(&quot;enable ip:recvtos&quot;),
<a name="20141"/>20141:                            ok = socket:setopt(Sock, ip, recvtos, true);
<a name="20142"/>20142:                       (#{recvtos := false} = _State) -&gt;
<a name="20143"/>20143:                            ok
<a name="20144"/>20144:                    end},
<a name="20145"/>20145:          %% This specific option, timestamp, is tested in another test case
<a name="20146"/>20146:          #{desc =&gt; &quot;maybe enable socket:timestamp on dst socket&quot;,
<a name="20147"/>20147:            cmd  =&gt; fun(#{timestamp := true, sock_dst := Sock} = _State) -&gt;
<a name="20148"/>20148:                            ?SEV_IPRINT(&quot;enable socket:timestamp&quot;),
<a name="20149"/>20149:                            ok = socket:setopt(Sock, socket, timestamp, true);
<a name="20150"/>20150:                       (#{timestamp := false} = _State) -&gt;
<a name="20151"/>20151:                            ok
<a name="20152"/>20152:                    end},
<a name="20153"/>20153: 
<a name="20154"/>20154:          #{desc =&gt; &quot;send req (to dst) (wo explicit options)&quot;,
<a name="20155"/>20155:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20156"/>20156:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20157"/>20157:                    end},
<a name="20158"/>20158:          #{desc =&gt; &quot;recv req (from src) - w default options&quot;,
<a name="20159"/>20159:            cmd  =&gt; fun(#{recvtos := true, timestamp := true,
<a name="20160"/>20160:                          sock_dst := Sock,
<a name="20161"/>20161:                          sa_src   := Src,
<a name="20162"/>20162:                          recv     := Recv}) -&gt;
<a name="20163"/>20163:                            case Recv(Sock) of
<a name="20164"/>20164:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="20165"/>20165:                                  when (length(Opts) =:= 2) -&gt;
<a name="20166"/>20166:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="20167"/>20167:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="20168"/>20168:                                    ok;
<a name="20169"/>20169:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20170"/>20170:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20171"/>20171:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20172"/>20172:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20173"/>20173:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20174"/>20174:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20175"/>20175:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20176"/>20176:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20177"/>20177:                                                [Src, BadSrc,
<a name="20178"/>20178:                                                 [], BadCHdrs,
<a name="20179"/>20179:                                                 ?BASIC_REQ, BadReq]),
<a name="20180"/>20180:                                    {error, {unexpected_data, UnexpData}};
<a name="20181"/>20181:                                {ok, UnexpData} -&gt;
<a name="20182"/>20182:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20183"/>20183:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20184"/>20184:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20185"/>20185:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20186"/>20186:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20187"/>20187:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20188"/>20188:                                    {error, {unexpected_data, UnexpData}};
<a name="20189"/>20189:                                {error, _} = ERROR -&gt;
<a name="20190"/>20190:                                    %% At the moment there is no way to get
<a name="20191"/>20191:                                    %% status or state for the socket...
<a name="20192"/>20192:                                    ERROR
<a name="20193"/>20193:                            end;
<a name="20194"/>20194:                       (#{timestamp := true,
<a name="20195"/>20195:                          sock_dst := Sock,
<a name="20196"/>20196:                          sa_src   := Src,
<a name="20197"/>20197:                          recv     := Recv}) -&gt;
<a name="20198"/>20198:                            case Recv(Sock) of
<a name="20199"/>20199:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="20200"/>20200:                                  when (length(Opts) =:= 1) -&gt;
<a name="20201"/>20201:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="20202"/>20202:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="20203"/>20203:                                    ok;
<a name="20204"/>20204:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20205"/>20205:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20206"/>20206:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20207"/>20207:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20208"/>20208:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20209"/>20209:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20210"/>20210:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20211"/>20211:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20212"/>20212:                                                [Src, BadSrc,
<a name="20213"/>20213:                                                 [], BadCHdrs,
<a name="20214"/>20214:                                                 ?BASIC_REQ, BadReq]),
<a name="20215"/>20215:                                    {error, {unexpected_data, UnexpData}};
<a name="20216"/>20216:                                {ok, UnexpData} -&gt;
<a name="20217"/>20217:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20218"/>20218:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20219"/>20219:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20220"/>20220:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20221"/>20221:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20222"/>20222:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20223"/>20223:                                    {error, {unexpected_data, UnexpData}};
<a name="20224"/>20224:                                {error, _} = ERROR -&gt;
<a name="20225"/>20225:                                    %% At the moment there is no way to get
<a name="20226"/>20226:                                    %% status or state for the socket...
<a name="20227"/>20227:                                    ERROR
<a name="20228"/>20228:                            end;
<a name="20229"/>20229:                       (#{recvtos := true,
<a name="20230"/>20230:                          sock_dst := Sock,
<a name="20231"/>20231:                          sa_src   := Src,
<a name="20232"/>20232:                          recv     := Recv}) -&gt;
<a name="20233"/>20233:                            case Recv(Sock) of
<a name="20234"/>20234:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="20235"/>20235:                                  when (length(Opts) =:= 1) -&gt;
<a name="20236"/>20236:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="20237"/>20237:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="20238"/>20238:                                    ok;
<a name="20239"/>20239:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20240"/>20240:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20241"/>20241:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20242"/>20242:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20243"/>20243:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20244"/>20244:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20245"/>20245:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20246"/>20246:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20247"/>20247:                                                [Src, BadSrc,
<a name="20248"/>20248:                                                 [], BadCHdrs,
<a name="20249"/>20249:                                                 ?BASIC_REQ, BadReq]),
<a name="20250"/>20250:                                    {error, {unexpected_data, UnexpData}};
<a name="20251"/>20251:                                {ok, UnexpData} -&gt;
<a name="20252"/>20252:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20253"/>20253:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20254"/>20254:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20255"/>20255:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20256"/>20256:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20257"/>20257:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20258"/>20258:                                    {error, {unexpected_data, UnexpData}};
<a name="20259"/>20259:                                {error, _} = ERROR -&gt;
<a name="20260"/>20260:                                    %% At the moment there is no way to get
<a name="20261"/>20261:                                    %% status or state for the socket...
<a name="20262"/>20262:                                    ERROR
<a name="20263"/>20263:                            end
<a name="20264"/>20264:                    end},
<a name="20265"/>20265: 
<a name="20266"/>20266: 
<a name="20267"/>20267:          %% *** We do not *yet* support sending options ***
<a name="20268"/>20268: 
<a name="20269"/>20269:          %% #{desc =&gt; &quot;send req (to dst) (w explicit options)&quot;,
<a name="20270"/>20270:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20271"/>20271:          %%                   Send(Sock, ?BASIC_REQ, Dst, Opts)
<a name="20272"/>20272:          %%           end},
<a name="20273"/>20273:          %% #{desc =&gt; &quot;recv req (from src) - w options&quot;,
<a name="20274"/>20274:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20275"/>20275:          %%                   case Recv(Sock) of
<a name="20276"/>20276:          %%                       {ok, {Src, Opts, ?BASIC_REQ}} -&gt;
<a name="20277"/>20277:          %%                           ?SEV_IPRINT(&quot;Got Options: &quot;
<a name="20278"/>20278:          %%                                       &quot;~n   ~p&quot;, [Opts]),
<a name="20279"/>20279:          %%                           ok;
<a name="20280"/>20280:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20281"/>20281:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20282"/>20282:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20283"/>20283:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="20284"/>20284:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20285"/>20285:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20286"/>20286:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20287"/>20287:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="20288"/>20288:          %%                                       [Src, BadSrc,
<a name="20289"/>20289:          %%                                        [], BadCHdrs,
<a name="20290"/>20290:          %%                                        ?BASIC_REQ, BadReq]),
<a name="20291"/>20291:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20292"/>20292:          %%                       {ok, UnexpData} -&gt;
<a name="20293"/>20293:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20294"/>20294:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20295"/>20295:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20296"/>20296:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20297"/>20297:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="20298"/>20298:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20299"/>20299:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20300"/>20300:          %%                       {error, _} = ERROR -&gt;
<a name="20301"/>20301:          %%                           %% At the moment there is no way to get
<a name="20302"/>20302:          %%                           %% status or state for the socket...
<a name="20303"/>20303:          %%                           ERROR
<a name="20304"/>20304:          %%                   end
<a name="20305"/>20305:          %%           end},
<a name="20306"/>20306: 
<a name="20307"/>20307:          #{desc =&gt; &quot;close src socket&quot;,
<a name="20308"/>20308:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20309"/>20309:                            ok = socket:close(Sock),
<a name="20310"/>20310:                            {ok, maps:remove(sock_src, State)}
<a name="20311"/>20311:                    end},
<a name="20312"/>20312:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="20313"/>20313:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20314"/>20314:                            ok = socket:close(Sock),
<a name="20315"/>20315:                            {ok, maps:remove(sock_dst, State)}
<a name="20316"/>20316:                    end},
<a name="20317"/>20317: 
<a name="20318"/>20318:          %% *** We are done ***
<a name="20319"/>20319:          ?SEV_FINISH_NORMAL
<a name="20320"/>20320:         ],
<a name="20321"/>20321:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvopts_udp-last_expr"/><a name="20322"/>20322: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="20323"/>20323: 
<a name="20324"/>20324: 
<a name="20325"/>20325: 
<a name="20326"/>20326: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20327"/>20327: 
<a name="20328"/>20328: <i>%% Tests that the origdstaddr control message header is received when</i>
<a name="20329"/>20329: <i>%% setting the socket 'ip' option recvorigdstaddr is set to true when</i>
<a name="20330"/>20330: <i>%% using sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="20331"/>20331: <i>%% So, this is done on the receiving side: </i>
<a name="20332"/>20332: <i>%%</i>
<a name="20333"/>20333: <i>%%               socket:setopt(Sock, ip, recvorigdstaddr, boolean()).</i>
<a name="20334"/>20334: <i>%%</i>
<a name="20335"/>20335: <i>%% For all subsequent *received* messages, the origdstaddr control</i>
<a name="20336"/>20336: <i>%% message header will be with the message.</i>
<a name="20337"/>20337: <i>%%</i>
<a name="20338"/>20338: <i>%%</i>
<a name="20339"/>20339: 
<a name="api_opt_ip_recvorigdstaddr_udp4-1"/><a name="20340"/>20340: <b>api_opt_ip_recvorigdstaddr_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="20341"/>20341:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvorigdstaddr_udp4-last_expr"/><a name="20342"/>20342: <b>    tc_try</b>(api_opt_ip_recvorigdstaddr_udp4,
<a name="20343"/>20343:            fun() -&gt; has_support_ipv4(), has_support_ip_recvorigdstaddr() end,
<a name="20344"/>20344:            fun() -&gt;
<a name="20345"/>20345:                    Set  = fun(Sock, Value) -&gt;
<a name="20346"/>20346:                                   socket:setopt(Sock, ip, recvorigdstaddr, Value)
<a name="20347"/>20347:                           end,
<a name="20348"/>20348:                    Get  = fun(Sock) -&gt;
<a name="20349"/>20349:                                   socket:getopt(Sock, ip, recvorigdstaddr)
<a name="20350"/>20350:                           end,
<a name="20351"/>20351:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="20352"/>20352:                                   Msg = #{addr =&gt; Dest,
<a name="20353"/>20353:                                              iov  =&gt; [Data]},
<a name="20354"/>20354:                                   socket:sendmsg(Sock, Msg)
<a name="20355"/>20355:                           end,
<a name="20356"/>20356:                    Recv = fun(Sock) -&gt;
<a name="20357"/>20357:                                   case socket:recvmsg(Sock) of
<a name="20358"/>20358:                                       {ok, #{addr := Source,
<a name="20359"/>20359:                                              ctrl := CMsgs,
<a name="20360"/>20360:                                              iov  := [Data]}} -&gt;
<a name="20361"/>20361:                                           {ok, {Source, CMsgs, Data}};
<a name="20362"/>20362:                                       {error, _} = ERROR -&gt;
<a name="20363"/>20363:                                           ERROR
<a name="20364"/>20364:                                   end
<a name="20365"/>20365:                           end,
<a name="20366"/>20366:                    InitState = #{domain =&gt; inet,
<a name="20367"/>20367:                                  proto  =&gt; udp,
<a name="20368"/>20368:                                  send   =&gt; Send,
<a name="20369"/>20369:                                  recv   =&gt; Recv,
<a name="20370"/>20370:                                  set    =&gt; Set,
<a name="20371"/>20371:                                  get    =&gt; Get},
<a name="20372"/>20372:                    ok = api_opt_ip_recvorigdstaddr_udp(InitState)
<a name="20373"/>20373:            end).
<a name="20374"/>20374: 
<a name="20375"/>20375: 
<a name="20376"/>20376: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20377"/>20377: 
<a name="api_opt_ip_recvorigdstaddr_udp-1"/><a name="20378"/>20378: <b>api_opt_ip_recvorigdstaddr_udp</b>(InitState) -&gt;
<a name="20379"/>20379:     Seq = 
<a name="20380"/>20380:         [
<a name="20381"/>20381:          #{desc =&gt; &quot;local address&quot;,
<a name="20382"/>20382:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="20383"/>20383:                            LSASrc = which_local_socket_addr(Domain),
<a name="20384"/>20384:                            LSADst = which_local_socket_addr(Domain),
<a name="20385"/>20385:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="20386"/>20386:                                        lsa_dst =&gt; LSADst}};
<a name="20387"/>20387:                       (#{domain := Domain} = State) -&gt;
<a name="20388"/>20388:                            LSA = which_local_socket_addr(Domain),
<a name="20389"/>20389:                            {ok, State#{lsa_src =&gt; LSA,
<a name="20390"/>20390:                                        lsa_dst =&gt; LSA}}
<a name="20391"/>20391:                    end},
<a name="20392"/>20392: 
<a name="20393"/>20393:          #{desc =&gt; &quot;open src socket&quot;,
<a name="20394"/>20394:            cmd  =&gt; fun(#{domain := Domain,
<a name="20395"/>20395:                          proto  := Proto} = State) -&gt;
<a name="20396"/>20396:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20397"/>20397:                            {ok, State#{sock_src =&gt; Sock}}
<a name="20398"/>20398:                    end},
<a name="20399"/>20399:          #{desc =&gt; &quot;bind src&quot;,
<a name="20400"/>20400:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="20401"/>20401:                            case sock_bind(Sock, LSA) of
<a name="20402"/>20402:                                ok -&gt;
<a name="20403"/>20403:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20404"/>20404:                                    ok;
<a name="20405"/>20405:                                {error, Reason} = ERROR -&gt;
<a name="20406"/>20406:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20407"/>20407:                                    ERROR
<a name="20408"/>20408:                            end
<a name="20409"/>20409:                    end},
<a name="20410"/>20410:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="20411"/>20411:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20412"/>20412:                            SASrc = sock_sockname(Sock),
<a name="20413"/>20413:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="20414"/>20414:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="20415"/>20415:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="20416"/>20416:                    end},
<a name="20417"/>20417: 
<a name="20418"/>20418:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="20419"/>20419:            cmd  =&gt; fun(#{domain := Domain,
<a name="20420"/>20420:                          proto  := Proto} = State) -&gt;
<a name="20421"/>20421:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20422"/>20422:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="20423"/>20423:                    end},
<a name="20424"/>20424:          #{desc =&gt; &quot;bind dst&quot;,
<a name="20425"/>20425:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="20426"/>20426:                            case sock_bind(Sock, LSA) of
<a name="20427"/>20427:                                ok -&gt;
<a name="20428"/>20428:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20429"/>20429:                                    ok;
<a name="20430"/>20430:                                {error, Reason} = ERROR -&gt;
<a name="20431"/>20431:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20432"/>20432:                                    ERROR
<a name="20433"/>20433:                            end
<a name="20434"/>20434:                    end},
<a name="20435"/>20435:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="20436"/>20436:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20437"/>20437:                            SADst = sock_sockname(Sock),
<a name="20438"/>20438:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="20439"/>20439:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="20440"/>20440:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="20441"/>20441:                    end},
<a name="20442"/>20442:          #{desc =&gt; &quot;get default recvorigdstaddr for dst socket&quot;,
<a name="20443"/>20443:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="20444"/>20444:                            case Get(Sock) of
<a name="20445"/>20445:                                {ok, false = Value} -&gt;
<a name="20446"/>20446:                                    ?SEV_IPRINT(&quot;dst recvorigdstaddr: ~p&quot;, [Value]),
<a name="20447"/>20447:                                    ok;
<a name="20448"/>20448:                                {ok, Unexpected} -&gt;
<a name="20449"/>20449:                                    ?SEV_EPRINT(&quot;Unexpected src recvorigdstaddr: ~p&quot;,
<a name="20450"/>20450:                                                [Unexpected]),
<a name="20451"/>20451:                                    {error, {unexpected, Unexpected}};
<a name="20452"/>20452:                                {error, Reason} = ERROR -&gt;
<a name="20453"/>20453:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="20454"/>20454:                                                &quot;recvorigdstaddr:&quot;
<a name="20455"/>20455:                                                &quot;   ~p&quot;, [Reason]),
<a name="20456"/>20456:                                    ERROR
<a name="20457"/>20457:                            end
<a name="20458"/>20458:                    end},
<a name="20459"/>20459: 
<a name="20460"/>20460:          #{desc =&gt; &quot;send req (to dst) (when recvorigdstaddr disabled)&quot;,
<a name="20461"/>20461:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20462"/>20462:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="20463"/>20463:                    end},
<a name="20464"/>20464:          #{desc =&gt; &quot;recv req (from src) - wo origdstaddr&quot;,
<a name="20465"/>20465:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20466"/>20466:                            case Recv(Sock) of
<a name="20467"/>20467:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20468"/>20468:                                    ok;
<a name="20469"/>20469:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20470"/>20470:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20471"/>20471:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20472"/>20472:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20473"/>20473:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20474"/>20474:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20475"/>20475:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20476"/>20476:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20477"/>20477:                                                [Src, BadSrc,
<a name="20478"/>20478:                                                 [], BadCHdrs,
<a name="20479"/>20479:                                                 ?BASIC_REQ, BadReq]),
<a name="20480"/>20480:                                    {error, {unexpected_data, UnexpData}};
<a name="20481"/>20481:                                {ok, UnexpData} -&gt;
<a name="20482"/>20482:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20483"/>20483:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20484"/>20484:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20485"/>20485:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20486"/>20486:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20487"/>20487:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20488"/>20488:                                    {error, {unexpected_data, UnexpData}};
<a name="20489"/>20489:                                {error, _} = ERROR -&gt;
<a name="20490"/>20490:                                    %% At the moment there is no way to get
<a name="20491"/>20491:                                    %% status or state for the socket...
<a name="20492"/>20492:                                    ERROR
<a name="20493"/>20493:                            end
<a name="20494"/>20494:                    end},
<a name="20495"/>20495: 
<a name="20496"/>20496:          #{desc =&gt; &quot;enable recvorigdstaddr on dst socket&quot;,
<a name="20497"/>20497:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20498"/>20498:                            case Set(Sock, true) of
<a name="20499"/>20499:                                ok -&gt;
<a name="20500"/>20500:                                    ?SEV_IPRINT(&quot;dst recvorigdstaddr enabled&quot;),
<a name="20501"/>20501:                                    ok;
<a name="20502"/>20502:                                {error, Reason} = ERROR -&gt;
<a name="20503"/>20503:                                    ?SEV_EPRINT(&quot;Failed enable recvorigdstaddr:&quot;
<a name="20504"/>20504:                                                &quot;   ~p&quot;, [Reason]),
<a name="20505"/>20505:                                    ERROR
<a name="20506"/>20506:                            end
<a name="20507"/>20507:                    end},
<a name="20508"/>20508: 
<a name="20509"/>20509:          #{desc =&gt; &quot;send req (to dst) (when recvorigdstaddr enabled)&quot;,
<a name="20510"/>20510:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20511"/>20511:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="20512"/>20512:                    end},
<a name="20513"/>20513:          #{desc =&gt; &quot;recv req (from src) - w origdstaddr&quot;,
<a name="20514"/>20514:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20515"/>20515:                            case Recv(Sock) of
<a name="20516"/>20516:                                {ok, {Src, [#{level := ip,
<a name="20517"/>20517:                                              type  := origdstaddr,
<a name="20518"/>20518:                                              value := Addr}], ?BASIC_REQ}} -&gt;
<a name="20519"/>20519:                                    ?SEV_IPRINT(&quot;got origdstaddr &quot;
<a name="20520"/>20520:                                                &quot;control message header: &quot;
<a name="20521"/>20521:                                                &quot;~n   ~p&quot;, [Addr]),
<a name="20522"/>20522:                                    ok;
<a name="20523"/>20523:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20524"/>20524:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20525"/>20525:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20526"/>20526:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20527"/>20527:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20528"/>20528:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20529"/>20529:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20530"/>20530:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20531"/>20531:                                                [Src, BadSrc,
<a name="20532"/>20532:                                                 [#{level =&gt; ip,
<a name="20533"/>20533:                                                    type  =&gt; origdstaddr,
<a name="20534"/>20534:                                                    data  =&gt; &quot;something&quot;}], BadCHdrs,
<a name="20535"/>20535:                                                 ?BASIC_REQ, BadReq]),
<a name="20536"/>20536:                                    {error, {unexpected_data, UnexpData}};
<a name="20537"/>20537:                                {ok, UnexpData} -&gt;
<a name="20538"/>20538:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20539"/>20539:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20540"/>20540:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20541"/>20541:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20542"/>20542:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20543"/>20543:                                                [Src,
<a name="20544"/>20544:                                                 [#{level =&gt; ip,
<a name="20545"/>20545:                                                    type  =&gt; origdstaddr,
<a name="20546"/>20546:                                                    data  =&gt; &quot;something&quot;}],
<a name="20547"/>20547:                                                 ?BASIC_REQ, UnexpData]),
<a name="20548"/>20548:                                    {error, {unexpected_data, UnexpData}};
<a name="20549"/>20549:                                {error, _} = ERROR -&gt;
<a name="20550"/>20550:                                    %% At the moment there is no way to get
<a name="20551"/>20551:                                    %% status or state for the socket...
<a name="20552"/>20552:                                    ERROR
<a name="20553"/>20553:                            end
<a name="20554"/>20554:                    end},
<a name="20555"/>20555: 
<a name="20556"/>20556:          #{desc =&gt; &quot;close src socket&quot;,
<a name="20557"/>20557:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20558"/>20558:                            ok = socket:close(Sock),
<a name="20559"/>20559:                            {ok, maps:remove(sock_src, State)}
<a name="20560"/>20560:                    end},
<a name="20561"/>20561:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="20562"/>20562:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20563"/>20563:                            ok = socket:close(Sock),
<a name="20564"/>20564:                            {ok, maps:remove(sock_dst, State)}
<a name="20565"/>20565:                    end},
<a name="20566"/>20566: 
<a name="20567"/>20567:          %% *** We are done ***
<a name="20568"/>20568:          ?SEV_FINISH_NORMAL
<a name="20569"/>20569:         ],
<a name="20570"/>20570:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvorigdstaddr_udp-last_expr"/><a name="20571"/>20571: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="20572"/>20572: 
<a name="20573"/>20573: 
<a name="20574"/>20574: 
<a name="20575"/>20575: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20576"/>20576: 
<a name="20577"/>20577: <i>%% Tests that the tos control message header is received when</i>
<a name="20578"/>20578: <i>%% setting the socket 'ip' option recvtos is set to true when using</i>
<a name="20579"/>20579: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="20580"/>20580: <i>%% So, this is done on the receiving side: </i>
<a name="20581"/>20581: <i>%%</i>
<a name="20582"/>20582: <i>%%               socket:setopt(Sock, ip, recvtos, boolean()).</i>
<a name="20583"/>20583: <i>%%</i>
<a name="20584"/>20584: <i>%% For all subsequent *received* messages, the tos control message</i>
<a name="20585"/>20585: <i>%% header will be with the message.</i>
<a name="20586"/>20586: <i>%%</i>
<a name="20587"/>20587: <i>%% On some platforms it works sending TOS with the message (sendmsg with </i>
<a name="20588"/>20588: <i>%% a control message header), but since its not universal, we can't use</i>
<a name="20589"/>20589: <i>%% that method. Instead, set tos (true) on the sending socket.</i>
<a name="20590"/>20590: <i>%%</i>
<a name="20591"/>20591: 
<a name="api_opt_ip_recvtos_udp4-1"/><a name="20592"/>20592: <b>api_opt_ip_recvtos_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="20593"/>20593:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvtos_udp4-last_expr"/><a name="20594"/>20594: <b>    tc_try</b>(api_opt_ip_recvtos_udp4,
<a name="20595"/>20595:            fun() -&gt;
<a name="20596"/>20596:                    is_not_windows(), % IP_TOS on windows
<a name="20597"/>20597:                    has_support_ipv4(),
<a name="20598"/>20598:                    has_support_ip_recvtos(),
<a name="20599"/>20599:                    has_support_ip_tos() % Used in the test
<a name="20600"/>20600:            end,
<a name="20601"/>20601:            fun() -&gt;
<a name="20602"/>20602:                    Set  = fun(Sock, Value) -&gt;
<a name="20603"/>20603:                                   socket:setopt(Sock, ip, recvtos, Value)
<a name="20604"/>20604:                           end,
<a name="20605"/>20605:                    Get  = fun(Sock) -&gt;
<a name="20606"/>20606:                                   socket:getopt(Sock, ip, recvtos)
<a name="20607"/>20607:                           end,
<a name="20608"/>20608:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="20609"/>20609:                                   Msg = #{addr =&gt; Dest,
<a name="20610"/>20610:                                           iov  =&gt; [Data]},
<a name="20611"/>20611:                                   socket:sendmsg(Sock, Msg);
<a name="20612"/>20612:                              (Sock, Data, Dest, TOS) -&gt;
<a name="20613"/>20613:                                   CMsg = #{level =&gt; ip,
<a name="20614"/>20614:                                            type  =&gt; tos,
<a name="20615"/>20615:                                            data  =&gt; TOS},
<a name="20616"/>20616:                                   Msg  = #{addr =&gt; Dest,
<a name="20617"/>20617:                                            ctrl =&gt; [CMsg],
<a name="20618"/>20618:                                            iov  =&gt; [Data]},
<a name="20619"/>20619:                                   socket:sendmsg(Sock, Msg)
<a name="20620"/>20620:                           end,
<a name="20621"/>20621:                    Recv = fun(Sock) -&gt;
<a name="20622"/>20622:                                   case socket:recvmsg(Sock) of
<a name="20623"/>20623:                                       {ok, #{addr := Source,
<a name="20624"/>20624:                                              ctrl := CMsgs,
<a name="20625"/>20625:                                              iov  := [Data]}} -&gt;
<a name="20626"/>20626:                                           {ok, {Source, CMsgs, Data}};
<a name="20627"/>20627:                                       {error, _} = ERROR -&gt;
<a name="20628"/>20628:                                           ERROR
<a name="20629"/>20629:                                   end
<a name="20630"/>20630:                           end,
<a name="20631"/>20631:                    InitState = #{domain =&gt; inet,
<a name="20632"/>20632:                                  proto  =&gt; udp,
<a name="20633"/>20633:                                  send   =&gt; Send,
<a name="20634"/>20634:                                  recv   =&gt; Recv,
<a name="20635"/>20635:                                  set    =&gt; Set,
<a name="20636"/>20636:                                  get    =&gt; Get},
<a name="20637"/>20637:                    ok = api_opt_ip_recvtos_udp(InitState)
<a name="20638"/>20638:            end).
<a name="20639"/>20639: 
<a name="20640"/>20640: 
<a name="20641"/>20641: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20642"/>20642: 
<a name="api_opt_ip_recvtos_udp-1"/><a name="20643"/>20643: <b>api_opt_ip_recvtos_udp</b>(InitState) -&gt;
<a name="20644"/>20644:     Seq = 
<a name="20645"/>20645:         [
<a name="20646"/>20646:          #{desc =&gt; &quot;local address&quot;,
<a name="20647"/>20647:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="20648"/>20648:                            LSASrc = which_local_socket_addr(Domain),
<a name="20649"/>20649:                            LSADst = which_local_socket_addr(Domain),
<a name="20650"/>20650:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="20651"/>20651:                                        lsa_dst =&gt; LSADst}};
<a name="20652"/>20652:                       (#{domain := Domain} = State) -&gt;
<a name="20653"/>20653:                            LSA = which_local_socket_addr(Domain),
<a name="20654"/>20654:                            {ok, State#{lsa_src =&gt; LSA,
<a name="20655"/>20655:                                        lsa_dst =&gt; LSA}}
<a name="20656"/>20656:                    end},
<a name="20657"/>20657: 
<a name="20658"/>20658:          #{desc =&gt; &quot;open src socket&quot;,
<a name="20659"/>20659:            cmd  =&gt; fun(#{domain := Domain,
<a name="20660"/>20660:                          proto  := Proto} = State) -&gt;
<a name="20661"/>20661:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20662"/>20662:                            {ok, State#{sock_src =&gt; Sock}}
<a name="20663"/>20663:                    end},
<a name="20664"/>20664:          #{desc =&gt; &quot;bind src&quot;,
<a name="20665"/>20665:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="20666"/>20666:                            case sock_bind(Sock, LSA) of
<a name="20667"/>20667:                                ok -&gt;
<a name="20668"/>20668:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20669"/>20669:                                    ok;
<a name="20670"/>20670:                                {error, Reason} = ERROR -&gt;
<a name="20671"/>20671:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20672"/>20672:                                    ERROR
<a name="20673"/>20673:                            end
<a name="20674"/>20674:                    end},
<a name="20675"/>20675:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="20676"/>20676:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20677"/>20677:                            SASrc = sock_sockname(Sock),
<a name="20678"/>20678:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="20679"/>20679:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="20680"/>20680:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="20681"/>20681:                    end},
<a name="20682"/>20682: 
<a name="20683"/>20683:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="20684"/>20684:            cmd  =&gt; fun(#{domain := Domain,
<a name="20685"/>20685:                          proto  := Proto} = State) -&gt;
<a name="20686"/>20686:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20687"/>20687:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="20688"/>20688:                    end},
<a name="20689"/>20689:          #{desc =&gt; &quot;bind dst&quot;,
<a name="20690"/>20690:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="20691"/>20691:                            case sock_bind(Sock, LSA) of
<a name="20692"/>20692:                                ok -&gt;
<a name="20693"/>20693:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20694"/>20694:                                    ok;
<a name="20695"/>20695:                                {error, Reason} = ERROR -&gt;
<a name="20696"/>20696:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20697"/>20697:                                    ERROR
<a name="20698"/>20698:                            end
<a name="20699"/>20699:                    end},
<a name="20700"/>20700:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="20701"/>20701:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20702"/>20702:                            SADst = sock_sockname(Sock),
<a name="20703"/>20703:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="20704"/>20704:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="20705"/>20705:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="20706"/>20706:                    end},
<a name="20707"/>20707:          #{desc =&gt; &quot;default recvtos for dst socket&quot;,
<a name="20708"/>20708:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="20709"/>20709:                            case Get(Sock) of
<a name="20710"/>20710:                                {ok, false = Value} -&gt;
<a name="20711"/>20711:                                    ?SEV_IPRINT(&quot;dst recvtos: ~p&quot;, [Value]),
<a name="20712"/>20712:                                    ok;
<a name="20713"/>20713:                                {ok, Unexpected} -&gt;
<a name="20714"/>20714:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="20715"/>20715:                                                [Unexpected]),
<a name="20716"/>20716:                                    {error, {unexpected, Unexpected}};
<a name="20717"/>20717:                                {error, Reason} = ERROR -&gt;
<a name="20718"/>20718:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="20719"/>20719:                                                &quot;   ~p&quot;, [Reason]),
<a name="20720"/>20720:                                    ERROR
<a name="20721"/>20721:                            end
<a name="20722"/>20722:                    end},
<a name="20723"/>20723: 
<a name="20724"/>20724:          #{desc =&gt; &quot;send req (to dst) (wo explicit tos)&quot;,
<a name="20725"/>20725:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20726"/>20726:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20727"/>20727:                    end},
<a name="20728"/>20728:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="20729"/>20729:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20730"/>20730:                            case Recv(Sock) of
<a name="20731"/>20731:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20732"/>20732:                                    ok;
<a name="20733"/>20733:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20734"/>20734:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20735"/>20735:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20736"/>20736:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20737"/>20737:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20738"/>20738:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20739"/>20739:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20740"/>20740:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20741"/>20741:                                                [Src, BadSrc,
<a name="20742"/>20742:                                                 [], BadCHdrs,
<a name="20743"/>20743:                                                 ?BASIC_REQ, BadReq]),
<a name="20744"/>20744:                                    {error, {unexpected_data, UnexpData}};
<a name="20745"/>20745:                                {ok, UnexpData} -&gt;
<a name="20746"/>20746:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20747"/>20747:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20748"/>20748:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20749"/>20749:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20750"/>20750:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20751"/>20751:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20752"/>20752:                                    {error, {unexpected_data, UnexpData}};
<a name="20753"/>20753:                                {error, _} = ERROR -&gt;
<a name="20754"/>20754:                                    %% At the moment there is no way to get
<a name="20755"/>20755:                                    %% status or state for the socket...
<a name="20756"/>20756:                                    ERROR
<a name="20757"/>20757:                            end
<a name="20758"/>20758:                    end},
<a name="20759"/>20759: 
<a name="20760"/>20760:          #{desc =&gt; &quot;set tos = reliability on src sock&quot;,
<a name="20761"/>20761:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="20762"/>20762:                            ok = socket:setopt(Sock, ip, tos, reliability)
<a name="20763"/>20763:                    end},
<a name="20764"/>20764:          #{desc =&gt; &quot;send req (to dst) (w tos = reliability)&quot;,
<a name="20765"/>20765:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="20766"/>20766:                          sa_dst   := Dst,
<a name="20767"/>20767:                          send     := Send}) -&gt;
<a name="20768"/>20768:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20769"/>20769:                    end},
<a name="20770"/>20770: 
<a name="20771"/>20771:          %% #{desc =&gt; &quot;send req (to dst) (w explicit tos = reliability)&quot;,
<a name="20772"/>20772:          %%   cmd  =&gt; fun(#{sock_src := Sock,
<a name="20773"/>20773:          %%                 sa_dst   := Dst,
<a name="20774"/>20774:          %%                 send     := Send}) -&gt;
<a name="20775"/>20775:          %%                   socket:setopt(Sock, otp, debug, true),
<a name="20776"/>20776:          %%                   case Send(Sock, ?BASIC_REQ, Dst, reliability) of
<a name="20777"/>20777:          %%                       ok -&gt;
<a name="20778"/>20778:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="20779"/>20779:          %%                           ok;
<a name="20780"/>20780:          %%                       {error, Reason} -&gt;
<a name="20781"/>20781:          %%                           ?SEV_EPRINT(&quot;Failed sending message with tos: &quot;
<a name="20782"/>20782:          %%                                       &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="20783"/>20783:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="20784"/>20784:          %%                           {skip, &quot;Failed sending message with TOS&quot;}
<a name="20785"/>20785:          %%                   end
<a name="20786"/>20786:          %%           end},
<a name="20787"/>20787: 
<a name="20788"/>20788:          #{desc =&gt; &quot;recv req (from src) - wo explicit tos&quot;,
<a name="20789"/>20789:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20790"/>20790:                            case Recv(Sock) of
<a name="20791"/>20791:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20792"/>20792:                                    ok;
<a name="20793"/>20793:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20794"/>20794:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20795"/>20795:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20796"/>20796:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20797"/>20797:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20798"/>20798:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20799"/>20799:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20800"/>20800:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20801"/>20801:                                                [Src, BadSrc,
<a name="20802"/>20802:                                                 [], BadCHdrs,
<a name="20803"/>20803:                                                 ?BASIC_REQ, BadReq]),
<a name="20804"/>20804:                                    {error, {unexpected_data, UnexpData}};
<a name="20805"/>20805:                                {ok, UnexpData} -&gt;
<a name="20806"/>20806:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20807"/>20807:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20808"/>20808:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20809"/>20809:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20810"/>20810:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20811"/>20811:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20812"/>20812:                                    {error, {unexpected_data, UnexpData}};
<a name="20813"/>20813:                                {error, _} = ERROR -&gt;
<a name="20814"/>20814:                                    %% At the moment there is no way to get
<a name="20815"/>20815:                                    %% status or state for the socket...
<a name="20816"/>20816:                                    ERROR
<a name="20817"/>20817:                            end
<a name="20818"/>20818:                    end},
<a name="20819"/>20819: 
<a name="20820"/>20820:          #{desc =&gt; &quot;set tos = 0 on src sock (\&quot;disabled\&quot;)&quot;,
<a name="20821"/>20821:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="20822"/>20822:                            ok = socket:setopt(Sock, ip, tos, 0)
<a name="20823"/>20823:                    end},
<a name="20824"/>20824: 
<a name="20825"/>20825:          #{desc =&gt; &quot;enable recvtos on dst socket&quot;,
<a name="20826"/>20826:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20827"/>20827:                            case Set(Sock, true) of
<a name="20828"/>20828:                                ok -&gt;
<a name="20829"/>20829:                                    ?SEV_IPRINT(&quot;dst recvtos enabled&quot;),
<a name="20830"/>20830:                                    ok;
<a name="20831"/>20831:                                {error, Reason} = ERROR -&gt;
<a name="20832"/>20832:                                    ?SEV_EPRINT(&quot;Failed setting recvtos:&quot;
<a name="20833"/>20833:                                                &quot;   ~p&quot;, [Reason]),
<a name="20834"/>20834:                                    ERROR
<a name="20835"/>20835:                            end
<a name="20836"/>20836:                    end},
<a name="20837"/>20837: 
<a name="20838"/>20838:          #{desc =&gt; &quot;enable recvtos on dst socket&quot;,
<a name="20839"/>20839:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20840"/>20840:                            case Set(Sock, true) of
<a name="20841"/>20841:                                ok -&gt;
<a name="20842"/>20842:                                    ?SEV_IPRINT(&quot;dst recvtos enabled&quot;),
<a name="20843"/>20843:                                    ok;
<a name="20844"/>20844:                                {error, Reason} = ERROR -&gt;
<a name="20845"/>20845:                                    ?SEV_EPRINT(&quot;Failed setting recvtos:&quot;
<a name="20846"/>20846:                                                &quot;   ~p&quot;, [Reason]),
<a name="20847"/>20847:                                    ERROR
<a name="20848"/>20848:                            end
<a name="20849"/>20849:                    end},
<a name="20850"/>20850: 
<a name="20851"/>20851:          #{desc =&gt; &quot;extract the (expected) recvtos \&quot;default\&quot; value&quot;,
<a name="20852"/>20852:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20853"/>20853:                            {ok, DefValue} = socket:getopt(Sock, ip, tos),
<a name="20854"/>20854:                            ?SEV_IPRINT(&quot;(expected) recvtos def value: ~w&quot;,
<a name="20855"/>20855:                                        [DefValue]),
<a name="20856"/>20856:                            {ok, State#{dst_def_value =&gt; DefValue}}
<a name="20857"/>20857:                    end},
<a name="20858"/>20858: 
<a name="20859"/>20859:          #{desc =&gt; &quot;send req (to dst) (wo explicit tos)&quot;,
<a name="20860"/>20860:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20861"/>20861:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20862"/>20862:                    end},
<a name="20863"/>20863:          #{desc =&gt; &quot;recv req (from src) - w default tos&quot;,
<a name="20864"/>20864:            cmd  =&gt; fun(#{sock_dst      := Sock,
<a name="20865"/>20865:                          dst_def_value := DefValue,
<a name="20866"/>20866:                          sa_src        := Src,
<a name="20867"/>20867:                          recv          := Recv}) -&gt;
<a name="20868"/>20868:                            ExpCHdr1 = #{level =&gt; ip,
<a name="20869"/>20869:                                         type  =&gt; tos,
<a name="20870"/>20870:                                         value =&gt; DefValue,
<a name="20871"/>20871:                                         data  =&gt; any},
<a name="20872"/>20872:                            ExpCHdr2 = #{level =&gt; ip,
<a name="20873"/>20873:                                         type  =&gt; recvtos,
<a name="20874"/>20874:                                         value =&gt; DefValue,
<a name="20875"/>20875:                                         data  =&gt; any},
<a name="20876"/>20876:                            case Recv(Sock) of
<a name="20877"/>20877:                                {ok, {Src, [#{level := ip,
<a name="20878"/>20878:                                              type  := TOS,
<a name="20879"/>20879:                                              value := DefValue}], ?BASIC_REQ}}
<a name="20880"/>20880:                                  when (TOS =:= tos) orelse
<a name="20881"/>20881:                                       (TOS =:= recvtos) -&gt;
<a name="20882"/>20882:                                    ?SEV_IPRINT(&quot;got default TOS (~w) &quot;
<a name="20883"/>20883:                                                &quot;control message header&quot;, [TOS]),
<a name="20884"/>20884:                                    ok;
<a name="20885"/>20885:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20886"/>20886:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20887"/>20887:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20888"/>20888:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20889"/>20889:                                                &quot;~n   Expect CHdrs:&quot;
<a name="20890"/>20890:                                                &quot;~n     Alt 1:  ~p&quot;
<a name="20891"/>20891:                                                &quot;~n     Alt 2:  ~p&quot;
<a name="20892"/>20892:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20893"/>20893:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20894"/>20894:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20895"/>20895:                                                [Src, BadSrc,
<a name="20896"/>20896:                                                 ExpCHdr1, ExpCHdr2, BadCHdrs,
<a name="20897"/>20897:                                                 ?BASIC_REQ, BadReq]),
<a name="20898"/>20898:                                    {error, {unexpected_data, UnexpData}};
<a name="20899"/>20899:                                {ok, UnexpData} -&gt;
<a name="20900"/>20900:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20901"/>20901:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20902"/>20902:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20903"/>20903:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20904"/>20904:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20905"/>20905:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20906"/>20906:                                    {error, {unexpected_data, UnexpData}};
<a name="20907"/>20907:                                {error, _} = ERROR -&gt;
<a name="20908"/>20908:                                    %% At the moment there is no way to get
<a name="20909"/>20909:                                    %% status or state for the socket...
<a name="20910"/>20910:                                    ERROR
<a name="20911"/>20911:                            end
<a name="20912"/>20912:                    end},
<a name="20913"/>20913: 
<a name="20914"/>20914:          #{desc =&gt; &quot;set tos = reliability on src sock&quot;,
<a name="20915"/>20915:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="20916"/>20916:                            ok = socket:setopt(Sock, ip, tos, reliability)
<a name="20917"/>20917:                    end},
<a name="20918"/>20918: 
<a name="20919"/>20919:          #{desc =&gt; &quot;send req (to dst) (w tos = mincost)&quot;,
<a name="20920"/>20920:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20921"/>20921:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20922"/>20922:                    end},
<a name="20923"/>20923:          #{desc =&gt; &quot;recv req (from src) - w tos = reliability&quot;,
<a name="20924"/>20924:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20925"/>20925:                            case Recv(Sock) of
<a name="20926"/>20926:                                {ok, {Src, [#{level := ip,
<a name="20927"/>20927:                                              type  := TOS,
<a name="20928"/>20928:                                              value := reliability = TOSData}],
<a name="20929"/>20929:                                      ?BASIC_REQ}} 
<a name="20930"/>20930:                                  when ((TOS =:= tos) orelse (TOS =:= recvtos)) -&gt;
<a name="20931"/>20931:                                    ?SEV_IPRINT(&quot;got expected TOS (~w) = ~w &quot;
<a name="20932"/>20932:                                                &quot;control message header&quot;, 
<a name="20933"/>20933:                                                [TOS, TOSData]),
<a name="20934"/>20934:                                    ok;
<a name="20935"/>20935:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20936"/>20936:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20937"/>20937:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20938"/>20938:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20939"/>20939:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20940"/>20940:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20941"/>20941:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20942"/>20942:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20943"/>20943:                                                [Src, BadSrc,
<a name="20944"/>20944:                                                 [], BadCHdrs,
<a name="20945"/>20945:                                                 ?BASIC_REQ, BadReq]),
<a name="20946"/>20946:                                    {error, {unexpected_data, UnexpData}};
<a name="20947"/>20947:                                {ok, UnexpData} -&gt;
<a name="20948"/>20948:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20949"/>20949:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20950"/>20950:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20951"/>20951:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20952"/>20952:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20953"/>20953:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20954"/>20954:                                    {error, {unexpected_data, UnexpData}};
<a name="20955"/>20955:                                {error, _} = ERROR -&gt;
<a name="20956"/>20956:                                    %% At the moment there is no way to get
<a name="20957"/>20957:                                    %% status or state for the socket...
<a name="20958"/>20958:                                    ERROR
<a name="20959"/>20959:                            end
<a name="20960"/>20960:                    end},
<a name="20961"/>20961: 
<a name="20962"/>20962:          #{desc =&gt; &quot;close src socket&quot;,
<a name="20963"/>20963:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20964"/>20964:                            ok = socket:close(Sock),
<a name="20965"/>20965:                            {ok, maps:remove(sock_src, State)}
<a name="20966"/>20966:                    end},
<a name="20967"/>20967:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="20968"/>20968:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20969"/>20969:                            ok = socket:close(Sock),
<a name="20970"/>20970:                            {ok, maps:remove(sock_dst, State)}
<a name="20971"/>20971:                    end},
<a name="20972"/>20972: 
<a name="20973"/>20973:          %% *** We are done ***
<a name="20974"/>20974:          ?SEV_FINISH_NORMAL
<a name="20975"/>20975:         ],
<a name="20976"/>20976:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvtos_udp-last_expr"/><a name="20977"/>20977: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="20978"/>20978: 
<a name="20979"/>20979: 
<a name="20980"/>20980: 
<a name="20981"/>20981: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20982"/>20982: 
<a name="20983"/>20983: <i>%% Tests that the ttl control message header is received when</i>
<a name="20984"/>20984: <i>%% setting the socket 'ip' option recvttl is set to true when using</i>
<a name="20985"/>20985: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="20986"/>20986: <i>%% So, this is done on the receiving side: </i>
<a name="20987"/>20987: <i>%%</i>
<a name="20988"/>20988: <i>%%               socket:setopt(Sock, ip, recvttl, boolean()).</i>
<a name="20989"/>20989: <i>%%</i>
<a name="20990"/>20990: <i>%% For all subsequent *received* messages, the ttl control message</i>
<a name="20991"/>20991: <i>%% header will be with the message.</i>
<a name="20992"/>20992: <i>%%</i>
<a name="20993"/>20993: <i>%% On darwin we don't actually get the TTL we send even after we have</i>
<a name="20994"/>20994: <i>%% enabled TTL. Instead we get the default value (which was 64).</i>
<a name="20995"/>20995: <i>%% Possibly this is because we run the test in the same OS process and</i>
<a name="20996"/>20996: <i>%% even the same erlang process....</i>
<a name="20997"/>20997: <i>%% The same issue on OpenBSD (6.6).</i>
<a name="20998"/>20998: <i>%% Maybe we should send and receive from different VMs, until then</i>
<a name="20999"/>20999: <i>%% skip darwin and OpenBSD.</i>
<a name="21000"/>21000: <i>%%</i>
<a name="21001"/>21001: <i>%% Windows:</i>
<a name="21002"/>21002: <i>%% It seems like its possible to set and get the recvttl option,</i>
<a name="21003"/>21003: <i>%% but not to use the ttl control message header when sending.</i>
<a name="21004"/>21004: <i>%% The following is the list of types (for level ip) which are listed</i>
<a name="21005"/>21005: <i>%% as supported: IP_ORIGINAL_ARRIVAL_IF, IP_PKTINFO and IP_ECN</i>
<a name="21006"/>21006: 
<a name="api_opt_ip_recvttl_udp4-1"/><a name="21007"/>21007: <b>api_opt_ip_recvttl_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="21008"/>21008:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvttl_udp4-last_expr"/><a name="21009"/>21009: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="21010"/>21010:            fun() -&gt;
<a name="21011"/>21011:                    has_support_ipv4(),
<a name="21012"/>21012: 		   has_support_ip_recvttl(),
<a name="21013"/>21013: 		   is_not_openbsd(),
<a name="21014"/>21014: 		   is_not_darwin()
<a name="21015"/>21015: 	   end,
<a name="21016"/>21016:            fun() -&gt;
<a name="21017"/>21017:                    Set  = fun(Sock, Value) -&gt;
<a name="21018"/>21018:                                   socket:setopt(Sock, ip, recvttl, Value)
<a name="21019"/>21019:                           end,
<a name="21020"/>21020:                    Get  = fun(Sock) -&gt;
<a name="21021"/>21021:                                   socket:getopt(Sock, ip, recvttl)
<a name="21022"/>21022:                           end,
<a name="21023"/>21023:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="21024"/>21024:                                   Msg = #{addr =&gt; Dest,
<a name="21025"/>21025:                                           iov  =&gt; [Data]},
<a name="21026"/>21026:                                   socket:sendmsg(Sock, Msg);
<a name="21027"/>21027:                              (Sock, Data, Dest, TTL) -&gt;
<a name="21028"/>21028:                                   CMsg = #{level =&gt; ip,
<a name="21029"/>21029:                                            type  =&gt; ttl,
<a name="21030"/>21030:                                            value =&gt; TTL},
<a name="21031"/>21031:                                   Msg  = #{addr =&gt; Dest,
<a name="21032"/>21032:                                            ctrl =&gt; [CMsg],
<a name="21033"/>21033:                                            iov  =&gt; [Data]},
<a name="21034"/>21034:                                   socket:sendmsg(Sock, Msg)
<a name="21035"/>21035:                           end,
<a name="21036"/>21036:                    Recv = fun(Sock) -&gt;
<a name="21037"/>21037:                                   case socket:recvmsg(Sock) of
<a name="21038"/>21038:                                       {ok, #{addr := Source,
<a name="21039"/>21039:                                              ctrl := CMsgs,
<a name="21040"/>21040:                                              iov  := [Data]}} -&gt;
<a name="21041"/>21041:                                           {ok, {Source, CMsgs, Data}};
<a name="21042"/>21042:                                       {error, _} = ERROR -&gt;
<a name="21043"/>21043:                                           ERROR
<a name="21044"/>21044:                                   end
<a name="21045"/>21045:                           end,
<a name="21046"/>21046:                    InitState = #{domain =&gt; inet,
<a name="21047"/>21047:                                  proto  =&gt; udp,
<a name="21048"/>21048:                                  send   =&gt; Send,
<a name="21049"/>21049:                                  recv   =&gt; Recv,
<a name="21050"/>21050:                                  set    =&gt; Set,
<a name="21051"/>21051:                                  get    =&gt; Get},
<a name="21052"/>21052:                    ok = api_opt_ip_recvttl_udp(InitState)
<a name="21053"/>21053:            end).
<a name="21054"/>21054: 
<a name="21055"/>21055: 
<a name="21056"/>21056: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21057"/>21057: 
<a name="api_opt_ip_recvttl_udp-1"/><a name="21058"/>21058: <b>api_opt_ip_recvttl_udp</b>(InitState) -&gt;
<a name="21059"/>21059:     Seq = 
<a name="21060"/>21060:         [
<a name="21061"/>21061:          #{desc =&gt; &quot;local address&quot;,
<a name="21062"/>21062:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="21063"/>21063:                            LSASrc = which_local_socket_addr(Domain),
<a name="21064"/>21064:                            LSADst = which_local_socket_addr(Domain),
<a name="21065"/>21065:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="21066"/>21066:                                        lsa_dst =&gt; LSADst}};
<a name="21067"/>21067:                       (#{domain := Domain} = State) -&gt;
<a name="21068"/>21068:                            LSA = which_local_socket_addr(Domain),
<a name="21069"/>21069:                            {ok, State#{lsa_src =&gt; LSA,
<a name="21070"/>21070:                                        lsa_dst =&gt; LSA}}
<a name="21071"/>21071:                    end},
<a name="21072"/>21072: 
<a name="21073"/>21073:          #{desc =&gt; &quot;open src socket&quot;,
<a name="21074"/>21074:            cmd  =&gt; fun(#{domain := Domain,
<a name="21075"/>21075:                          proto  := Proto} = State) -&gt;
<a name="21076"/>21076:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21077"/>21077:                            {ok, State#{sock_src =&gt; Sock}}
<a name="21078"/>21078:                    end},
<a name="21079"/>21079:          #{desc =&gt; &quot;bind src&quot;,
<a name="21080"/>21080:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="21081"/>21081:                            case sock_bind(Sock, LSA) of
<a name="21082"/>21082:                                ok -&gt;
<a name="21083"/>21083:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="21084"/>21084:                                    ok;
<a name="21085"/>21085:                                {error, Reason} = ERROR -&gt;
<a name="21086"/>21086:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="21087"/>21087:                                    ERROR
<a name="21088"/>21088:                            end
<a name="21089"/>21089:                    end},
<a name="21090"/>21090:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="21091"/>21091:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21092"/>21092:                            SASrc = sock_sockname(Sock),
<a name="21093"/>21093:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="21094"/>21094:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="21095"/>21095:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="21096"/>21096:                    end},
<a name="21097"/>21097: 
<a name="21098"/>21098:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="21099"/>21099:            cmd  =&gt; fun(#{domain := Domain,
<a name="21100"/>21100:                          proto  := Proto} = State) -&gt;
<a name="21101"/>21101:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21102"/>21102:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="21103"/>21103:                    end},
<a name="21104"/>21104:          #{desc =&gt; &quot;bind dst&quot;,
<a name="21105"/>21105:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="21106"/>21106:                            case sock_bind(Sock, LSA) of
<a name="21107"/>21107:                                ok -&gt;
<a name="21108"/>21108:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="21109"/>21109:                                    ok;
<a name="21110"/>21110:                                {error, Reason} = ERROR -&gt;
<a name="21111"/>21111:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="21112"/>21112:                                    ERROR
<a name="21113"/>21113:                            end
<a name="21114"/>21114:                    end},
<a name="21115"/>21115:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="21116"/>21116:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21117"/>21117:                            SADst = sock_sockname(Sock),
<a name="21118"/>21118:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="21119"/>21119:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="21120"/>21120:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="21121"/>21121:                    end},
<a name="21122"/>21122:          #{desc =&gt; &quot;default recvttl for dst socket&quot;,
<a name="21123"/>21123:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="21124"/>21124:                            case Get(Sock) of
<a name="21125"/>21125:                                {ok, false = Value} -&gt;
<a name="21126"/>21126:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="21127"/>21127:                                    ok;
<a name="21128"/>21128:                                {ok, Unexpected} -&gt;
<a name="21129"/>21129:                                    ?SEV_EPRINT(&quot;Unexpected src recvttl: ~p&quot;,
<a name="21130"/>21130:                                                [Unexpected]),
<a name="21131"/>21131:                                    {error, {unexpected, Unexpected}};
<a name="21132"/>21132:                                {error, Reason} = ERROR -&gt;
<a name="21133"/>21133:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="21134"/>21134:                                                &quot;   ~p&quot;, [Reason]),
<a name="21135"/>21135:                                    ERROR
<a name="21136"/>21136:                            end
<a name="21137"/>21137:                    end},
<a name="21138"/>21138: 
<a name="21139"/>21139:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="21140"/>21140:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21141"/>21141:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21142"/>21142:                    end},
<a name="21143"/>21143:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="21144"/>21144:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21145"/>21145:                            case Recv(Sock) of
<a name="21146"/>21146:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21147"/>21147:                                    ok;
<a name="21148"/>21148:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21149"/>21149:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21150"/>21150:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21151"/>21151:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21152"/>21152:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21153"/>21153:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21154"/>21154:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21155"/>21155:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21156"/>21156:                                                [Src, BadSrc,
<a name="21157"/>21157:                                                 [], BadCHdrs,
<a name="21158"/>21158:                                                 ?BASIC_REQ, BadReq]),
<a name="21159"/>21159:                                    {error, {unexpected_data, UnexpData}};
<a name="21160"/>21160:                                {ok, UnexpData} -&gt;
<a name="21161"/>21161:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21162"/>21162:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21163"/>21163:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21164"/>21164:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21165"/>21165:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21166"/>21166:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21167"/>21167:                                    {error, {unexpected_data, UnexpData}};
<a name="21168"/>21168:                                {error, _} = ERROR -&gt;
<a name="21169"/>21169:                                    %% At the moment there is no way to get
<a name="21170"/>21170:                                    %% status or state for the socket...
<a name="21171"/>21171:                                    ERROR
<a name="21172"/>21172:                            end
<a name="21173"/>21173:                    end},
<a name="21174"/>21174: 
<a name="21175"/>21175:          #{desc =&gt; &quot;send req (to dst) (w explicit ttl = 100)&quot;,
<a name="21176"/>21176:            cmd  =&gt; fun(#{sock_src := SSock,
<a name="21177"/>21177:                          sock_dst := DSock, sa_dst := Dst,
<a name="21178"/>21178:                          send     := Send}) -&gt;
<a name="21179"/>21179:                            case Send(SSock, ?BASIC_REQ, Dst, 100) of
<a name="21180"/>21180:                                ok -&gt;
<a name="21181"/>21181:                                    ok;
<a name="21182"/>21182:                                {error, einval = Reason} -&gt;
<a name="21183"/>21183:                                    %% IF we can't send it the test will not work
<a name="21184"/>21184:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21185"/>21185:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="21186"/>21186:                                    (catch socket:close(SSock)),
<a name="21187"/>21187:                                    (catch socket:close(DSock)),
<a name="21188"/>21188:                                    {skip,
<a name="21189"/>21189: 				    ?F(&quot;Cannot send with TTL: ~p&quot;, [Reason])};
<a name="21190"/>21190:                                {error, enoprotoopt = Reason} -&gt;
<a name="21191"/>21191:                                    %% On some platforms this is not
<a name="21192"/>21192:                                    %% accepted (FreeBSD), so skip.
<a name="21193"/>21193:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="21194"/>21194:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="21195"/>21195:                                    (catch socket:close(SSock)),
<a name="21196"/>21196:                                    (catch socket:close(DSock)),
<a name="21197"/>21197:                                    {skip, Reason};
<a name="21198"/>21198: 
<a name="21199"/>21199:                                {error,
<a name="21200"/>21200:                                 {get_overlapped_result,
<a name="21201"/>21201:                                  #{file     := File,
<a name="21202"/>21202:                                    function := Function,
<a name="21203"/>21203:                                    line     := Line,
<a name="21204"/>21204:                                    raw_info := RawInfo,
<a name="21205"/>21205:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="21206"/>21206:                                    %% IF we can't send it the test will not work
<a name="21207"/>21207:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21208"/>21208:                                                &quot;~p =&gt; SKIP: &quot;
<a name="21209"/>21209:                                                &quot;~n   File:     ~s&quot;
<a name="21210"/>21210:                                                &quot;~n   Function: ~s&quot;
<a name="21211"/>21211:                                                &quot;~n   Line:     ~p&quot;
<a name="21212"/>21212:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="21213"/>21213:                                                [Info,
<a name="21214"/>21214:                                                 File, Function, Line,
<a name="21215"/>21215:                                                 RawInfo]),
<a name="21216"/>21216:                                    (catch socket:close(SSock)),
<a name="21217"/>21217:                                    (catch socket:close(DSock)),
<a name="21218"/>21218:                                    {skip,
<a name="21219"/>21219:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="21220"/>21220:                                {error, {get_overlapped_result,
<a name="21221"/>21221:                                         invalid_parameter = Info}} -&gt;
<a name="21222"/>21222:                                    %% IF we can't send it the test will not work
<a name="21223"/>21223:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21224"/>21224:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="21225"/>21225:                                    (catch socket:close(SSock)),
<a name="21226"/>21226:                                    (catch socket:close(DSock)),
<a name="21227"/>21227:                                    {skip,
<a name="21228"/>21228:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="21229"/>21229: 
<a name="21230"/>21230:                                {error,
<a name="21231"/>21231:                                 {completion_status,
<a name="21232"/>21232:                                  #{file     := File,
<a name="21233"/>21233:                                    function := Function,
<a name="21234"/>21234:                                    line     := Line,
<a name="21235"/>21235:                                    raw_info := RawInfo,
<a name="21236"/>21236:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="21237"/>21237:                                    %% IF we can't send it the test will not work
<a name="21238"/>21238:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21239"/>21239:                                                &quot;~p =&gt; SKIP: &quot;
<a name="21240"/>21240:                                                &quot;~n   File:     ~s&quot;
<a name="21241"/>21241:                                                &quot;~n   Function: ~s&quot;
<a name="21242"/>21242:                                                &quot;~n   Line:     ~p&quot;
<a name="21243"/>21243:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="21244"/>21244:                                                [Info,
<a name="21245"/>21245:                                                 File, Function, Line,
<a name="21246"/>21246:                                                 RawInfo]),
<a name="21247"/>21247:                                    (catch socket:close(SSock)),
<a name="21248"/>21248:                                    (catch socket:close(DSock)),
<a name="21249"/>21249:                                    {skip,
<a name="21250"/>21250:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="21251"/>21251:                                {error, {completion_status,
<a name="21252"/>21252:                                         invalid_parameter = Info}} -&gt;
<a name="21253"/>21253:                                    %% IF we can't send it the test will not work
<a name="21254"/>21254:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="21255"/>21255:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="21256"/>21256:                                    (catch socket:close(SSock)),
<a name="21257"/>21257:                                    (catch socket:close(DSock)),
<a name="21258"/>21258:                                    {skip,
<a name="21259"/>21259:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="21260"/>21260: 
<a name="21261"/>21261:                                {error, _Reason} = ERROR -&gt;
<a name="21262"/>21262:                                    ERROR
<a name="21263"/>21263:                            end
<a name="21264"/>21264:                    end},
<a name="21265"/>21265:          #{desc =&gt; &quot;recv req (from src) - wo ttl&quot;,
<a name="21266"/>21266:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21267"/>21267:                            case Recv(Sock) of
<a name="21268"/>21268:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21269"/>21269:                                    ok;
<a name="21270"/>21270:                                {ok, {Src, [#{level := ip,
<a name="21271"/>21271:                                              type  := TTLType,
<a name="21272"/>21272:                                              value := TTL}], ?BASIC_REQ}}
<a name="21273"/>21273:                                when ((TTLType =:= recvttl) andalso
<a name="21274"/>21274:                                      (TTL =:= 255)) -&gt;
<a name="21275"/>21275:                                    %% This is the behaviopur on Solaris (11)
<a name="21276"/>21276:                                    %% and maybe on other platforms...
<a name="21277"/>21277:                                    ?SEV_IPRINT(&quot;Got (default) TTL (~w): ~p&quot;,
<a name="21278"/>21278:                                                [TTLType, TTL]),
<a name="21279"/>21279:                                    ok;
<a name="21280"/>21280:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21281"/>21281:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21282"/>21282:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21283"/>21283:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21284"/>21284:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21285"/>21285:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21286"/>21286:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21287"/>21287:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21288"/>21288:                                                [Src, BadSrc,
<a name="21289"/>21289:                                                 [], BadCHdrs,
<a name="21290"/>21290:                                                 ?BASIC_REQ, BadReq]),
<a name="21291"/>21291:                                    {error, {unexpected_data, UnexpData}};
<a name="21292"/>21292:                                {ok, UnexpData} -&gt;
<a name="21293"/>21293:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21294"/>21294:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21295"/>21295:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21296"/>21296:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21297"/>21297:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21298"/>21298:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21299"/>21299:                                    {error, {unexpected_data, UnexpData}};
<a name="21300"/>21300:                                {error, _} = ERROR -&gt;
<a name="21301"/>21301:                                    %% At the moment there is no way to get
<a name="21302"/>21302:                                    %% status or state for the socket...
<a name="21303"/>21303:                                    ERROR
<a name="21304"/>21304:                            end
<a name="21305"/>21305:                    end},
<a name="21306"/>21306: 
<a name="21307"/>21307:          #{desc =&gt; &quot;enable recvttl on dst socket&quot;,
<a name="21308"/>21308:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="21309"/>21309:                            case Set(Sock, true) of
<a name="21310"/>21310:                                ok -&gt;
<a name="21311"/>21311:                                    ?SEV_IPRINT(&quot;dst recvttl enabled&quot;),
<a name="21312"/>21312:                                    ok;
<a name="21313"/>21313:                                {error, Reason} = ERROR -&gt;
<a name="21314"/>21314:                                    ?SEV_EPRINT(&quot;Failed enabling recvttl:&quot;
<a name="21315"/>21315:                                                &quot;   ~p&quot;, [Reason]),
<a name="21316"/>21316:                                    ERROR
<a name="21317"/>21317:                            end
<a name="21318"/>21318:                    end},
<a name="21319"/>21319: 
<a name="21320"/>21320:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="21321"/>21321:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21322"/>21322:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21323"/>21323:                    end},
<a name="21324"/>21324:          #{desc =&gt; &quot;recv req (from src) - w default ttl&quot;,
<a name="21325"/>21325:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21326"/>21326:                            case Recv(Sock) of
<a name="21327"/>21327:                                {ok, {Src, [#{level := ip,
<a name="21328"/>21328:                                              type  := TTLType,
<a name="21329"/>21329:                                              value := TTL}], ?BASIC_REQ}}
<a name="21330"/>21330:                                when ((TTLType =:= ttl) orelse 
<a name="21331"/>21331:                                      (TTLType =:= recvttl)) -&gt;
<a name="21332"/>21332:                                    ?SEV_IPRINT(&quot;Got (default) TTL (~w): ~p&quot;,
<a name="21333"/>21333:                                                [TTLType, TTL]),
<a name="21334"/>21334:                                    ok;
<a name="21335"/>21335:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21336"/>21336:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21337"/>21337:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21338"/>21338:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21339"/>21339:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21340"/>21340:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21341"/>21341:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21342"/>21342:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21343"/>21343:                                                [Src, BadSrc,
<a name="21344"/>21344:                                                 [#{level =&gt; ip,
<a name="21345"/>21345: 						   type  =&gt; ttl,
<a name="21346"/>21346: 						   value =&gt; &quot;something&quot;}],
<a name="21347"/>21347: 						BadCHdrs,
<a name="21348"/>21348:                                                 ?BASIC_REQ, BadReq]),
<a name="21349"/>21349:                                    {error, {unexpected_data, UnexpData}};
<a name="21350"/>21350:                                {ok, UnexpData} -&gt;
<a name="21351"/>21351:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21352"/>21352:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21353"/>21353:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21354"/>21354:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21355"/>21355:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21356"/>21356:                                                [Src, [#{level =&gt; ip,
<a name="21357"/>21357: 							type  =&gt; ttl,
<a name="21358"/>21358: 							value =&gt; &quot;something&quot;}],
<a name="21359"/>21359: 						?BASIC_REQ, UnexpData]),
<a name="21360"/>21360:                                    {error, {unexpected_data, UnexpData}};
<a name="21361"/>21361:                                {error, _} = ERROR -&gt;
<a name="21362"/>21362:                                    %% At the moment there is no way to get
<a name="21363"/>21363:                                    %% status or state for the socket...
<a name="21364"/>21364:                                    ERROR
<a name="21365"/>21365:                            end
<a name="21366"/>21366:                    end},
<a name="21367"/>21367: 
<a name="21368"/>21368:          #{desc =&gt; &quot;send req (to dst) (w explicit ttl = 100)&quot;,
<a name="21369"/>21369:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21370"/>21370:                            Send(Sock, ?BASIC_REQ, Dst, 100)
<a name="21371"/>21371:                    end},
<a name="21372"/>21372:          #{desc =&gt; &quot;recv req (from src) - w ttl = 100&quot;,
<a name="21373"/>21373:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21374"/>21374:                            case Recv(Sock) of
<a name="21375"/>21375:                                {ok, {Src, [#{level := ip,
<a name="21376"/>21376:                                              type  := TTLType,
<a name="21377"/>21377:                                              value := 100 = TTL}], ?BASIC_REQ}}
<a name="21378"/>21378:                                when ((TTLType =:= ttl) orelse
<a name="21379"/>21379:                                      (TTLType =:= recvttl)) -&gt;
<a name="21380"/>21380:                                    ?SEV_IPRINT(&quot;Got TTL (~w): ~p&quot;,
<a name="21381"/>21381:                                                [TTLType, TTL]),
<a name="21382"/>21382:                                    ok;
<a name="21383"/>21383:                                {ok, {Src, [#{level := ip,
<a name="21384"/>21384:                                              type  := TTLType,
<a name="21385"/>21385:                                              value := BadTTL}], ?BASIC_REQ}}
<a name="21386"/>21386:                                when ((TTLType =:= ttl) orelse
<a name="21387"/>21387:                                      (TTLType =:= recvttl)) -&gt;
<a name="21388"/>21388:                                    ?SEV_EPRINT(&quot;Unexpected TTL: &quot;
<a name="21389"/>21389:                                                &quot;~n   Expect TTL: ~p&quot;
<a name="21390"/>21390:                                                &quot;~n   Recv TTL:   ~p&quot;,
<a name="21391"/>21391:                                                [100, BadTTL]),
<a name="21392"/>21392:                                    {error, {unexpected_ttl, {100, BadTTL}}};
<a name="21393"/>21393:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21394"/>21394:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21395"/>21395:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21396"/>21396:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21397"/>21397:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21398"/>21398:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21399"/>21399:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21400"/>21400:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21401"/>21401:                                                [Src, BadSrc,
<a name="21402"/>21402:                                                 [#{level =&gt; ip,
<a name="21403"/>21403: 						   type  =&gt; ttl,
<a name="21404"/>21404: 						   value =&gt; 100}], BadCHdrs,
<a name="21405"/>21405:                                                 ?BASIC_REQ, BadReq]),
<a name="21406"/>21406:                                    {error, {unexpected_data, UnexpData}};
<a name="21407"/>21407:                                {ok, UnexpData} -&gt;
<a name="21408"/>21408:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21409"/>21409:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21410"/>21410:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21411"/>21411:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21412"/>21412:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21413"/>21413:                                                [Src, [#{level =&gt; ip,
<a name="21414"/>21414: 							type  =&gt; ttl,
<a name="21415"/>21415: 							value =&gt; 100}],
<a name="21416"/>21416: 						?BASIC_REQ, UnexpData]),
<a name="21417"/>21417:                                    {error, {unexpected_data, UnexpData}};
<a name="21418"/>21418:                                {error, _} = ERROR -&gt;
<a name="21419"/>21419:                                    %% At the moment there is no way to get
<a name="21420"/>21420:                                    %% status or state for the socket...
<a name="21421"/>21421:                                    ERROR
<a name="21422"/>21422:                            end
<a name="21423"/>21423:                    end},
<a name="21424"/>21424: 
<a name="21425"/>21425:          #{desc =&gt; &quot;close src socket&quot;,
<a name="21426"/>21426:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21427"/>21427:                            ok = socket:close(Sock),
<a name="21428"/>21428:                            {ok, maps:remove(sock_src, State)}
<a name="21429"/>21429:                    end},
<a name="21430"/>21430:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="21431"/>21431:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21432"/>21432:                            ok = socket:close(Sock),
<a name="21433"/>21433:                            {ok, maps:remove(sock_dst, State)}
<a name="21434"/>21434:                    end},
<a name="21435"/>21435: 
<a name="21436"/>21436:          %% *** We are done ***
<a name="21437"/>21437:          ?SEV_FINISH_NORMAL
<a name="21438"/>21438:         ],
<a name="21439"/>21439:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvttl_udp-last_expr"/><a name="21440"/>21440: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="21441"/>21441: 
<a name="21442"/>21442: 
<a name="21443"/>21443: 
<a name="21444"/>21444: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21445"/>21445: 
<a name="21446"/>21446: <i>%% Tests the ip socket option 'tos' can be set and retrieved from a</i>
<a name="21447"/>21447: <i>%% the socket its set on. It sets the type-of-server field in the IP</i>
<a name="21448"/>21448: <i>%% header for a TCP or UDP socket.</i>
<a name="21449"/>21449: <i>%% There is no way to fetch the value a received IP datagram.</i>
<a name="21450"/>21450: <i>%% Default value is supposed to be '0'.</i>
<a name="21451"/>21451: <i>%% </i>
<a name="21452"/>21452: 
<a name="api_opt_ip_tos_udp4-1"/><a name="21453"/>21453: <b>api_opt_ip_tos_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="21454"/>21454:     ?TT(?SECS(5)),
<a name="api_opt_ip_tos_udp4-last_expr"/><a name="21455"/>21455: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="21456"/>21456:            fun() -&gt;
<a name="21457"/>21457:                    is_not_windows(), % IP_TOS on windows
<a name="21458"/>21458:                    has_support_ipv4(),
<a name="21459"/>21459:                    has_support_ip_tos()
<a name="21460"/>21460:            end,
<a name="21461"/>21461:            fun() -&gt;
<a name="21462"/>21462:                    Set  = fun(Sock, Value) -&gt;
<a name="21463"/>21463:                                   socket:setopt(Sock, ip, tos, Value)
<a name="21464"/>21464:                           end,
<a name="21465"/>21465:                    Get  = fun(Sock) -&gt;
<a name="21466"/>21466:                                   socket:getopt(Sock, ip, tos)
<a name="21467"/>21467:                           end,
<a name="21468"/>21468:                    InitState = #{set =&gt; Set,
<a name="21469"/>21469:                                  get =&gt; Get},
<a name="21470"/>21470:                    ok = api_opt_ip_tos_udp(InitState)
<a name="21471"/>21471:            end).
<a name="21472"/>21472: 
<a name="21473"/>21473: 
<a name="21474"/>21474: 
<a name="21475"/>21475: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21476"/>21476: 
<a name="api_opt_ip_tos_udp-1"/><a name="21477"/>21477: <b>api_opt_ip_tos_udp</b>(InitState) -&gt;
<a name="21478"/>21478:     process_flag(trap_exit, true),
<a name="21479"/>21479:     %% mincost is not supported on all platforms.
<a name="21480"/>21480:     %% For instance, Solaris 10, does not have that constant.
<a name="21481"/>21481:     %% Instead it has two others with, what appears to be,
<a name="21482"/>21482:     %% completely different meanings...
<a name="21483"/>21483:     %% So, avoid the complication by not using this value...
<a name="21484"/>21484:     %% TOS1 = mincost,     TOS1Str = atom_to_list(TOS1),
<a name="21485"/>21485:     TOS2 = throughput,  TOS2Str = atom_to_list(TOS2),
<a name="21486"/>21486:     TOS3 = reliability, TOS3Str = atom_to_list(TOS3),
<a name="21487"/>21487:     TOS4 = lowdelay,    TOS4Str = atom_to_list(TOS4),
<a name="21488"/>21488:     TOS5 = 42,          TOS5Str = integer_to_list(TOS5),
<a name="21489"/>21489:     Seq =
<a name="21490"/>21490:         [
<a name="21491"/>21491:          #{desc =&gt; &quot;local address&quot;,
<a name="21492"/>21492:            cmd  =&gt; fun(State) -&gt;
<a name="21493"/>21493:                            LSA = which_local_socket_addr(inet),
<a name="21494"/>21494:                            {ok, State#{lsa =&gt; LSA}}
<a name="21495"/>21495:                    end},
<a name="21496"/>21496: 
<a name="21497"/>21497:          #{desc =&gt; &quot;open socket&quot;,
<a name="21498"/>21498:            cmd  =&gt; fun(State) -&gt;
<a name="21499"/>21499:                            Sock = sock_open(inet, dgram, udp),
<a name="21500"/>21500:                            {ok, State#{sock =&gt; Sock}}
<a name="21501"/>21501:                    end},
<a name="21502"/>21502:          #{desc =&gt; &quot;bind&quot;,
<a name="21503"/>21503:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="21504"/>21504:                            case sock_bind(Sock, LSA) of
<a name="21505"/>21505:                                ok -&gt;
<a name="21506"/>21506:                                    ?SEV_IPRINT(&quot;socket bound&quot;),
<a name="21507"/>21507:                                    ok;
<a name="21508"/>21508:                                {error, Reason} = ERROR -&gt;
<a name="21509"/>21509:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="21510"/>21510:                                    ERROR
<a name="21511"/>21511:                            end
<a name="21512"/>21512:                    end},
<a name="21513"/>21513: 
<a name="21514"/>21514:          #{desc =&gt; &quot;get default tos&quot;,
<a name="21515"/>21515:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21516"/>21516:                            case Get(Sock) of
<a name="21517"/>21517:                                {ok, 0 = Value} -&gt;
<a name="21518"/>21518:                                    ?SEV_IPRINT(&quot;expected default tos: ~p&quot;, [Value]),
<a name="21519"/>21519:                                    ok;
<a name="21520"/>21520:                                {ok, Value} -&gt;
<a name="21521"/>21521:                                    %% On FreeBSD 14 default value is not 0!
<a name="21522"/>21522:                                    case os:type() of
<a name="21523"/>21523:                                        {unix, freebsd} -&gt;
<a name="21524"/>21524:                                            case os:version() of
<a name="21525"/>21525:                                                {14, _, _}
<a name="21526"/>21526:                                                  when (Value =:= mincost) -&gt;
<a name="21527"/>21527:                                                    ok;
<a name="21528"/>21528:                                                _ -&gt;
<a name="21529"/>21529:                                                    ?SEV_EPRINT(&quot;Unexpected &quot;
<a name="21530"/>21530:                                                                &quot;default &quot;
<a name="21531"/>21531:                                                                &quot;tos: ~p&quot;,
<a name="21532"/>21532:                                                                [Value]),
<a name="21533"/>21533:                                                    {error, {unexpected, Value}}
<a name="21534"/>21534:                                            end;
<a name="21535"/>21535:                                        _ -&gt;
<a name="21536"/>21536:                                            ?SEV_EPRINT(&quot;Unexpected &quot;
<a name="21537"/>21537:                                                        &quot;default &quot;
<a name="21538"/>21538:                                                        &quot;tos: ~p&quot;,
<a name="21539"/>21539:                                                        [Value]),
<a name="21540"/>21540:                                            {error, {unexpected, Value}}
<a name="21541"/>21541:                                    end;
<a name="21542"/>21542:                                {error, Reason} = ERROR -&gt;
<a name="21543"/>21543:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21544"/>21544:                                                &quot;   ~p&quot;, [Reason]),
<a name="21545"/>21545:                                    ERROR
<a name="21546"/>21546:                            end
<a name="21547"/>21547:                    end},
<a name="21548"/>21548: 
<a name="21549"/>21549:          %% #{desc =&gt; &quot;set tos &quot; ++ TOS1Str,
<a name="21550"/>21550:          %%   cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21551"/>21551:          %%                   socket:setopt(Sock, otp, debug, true),
<a name="21552"/>21552:          %%                   case Set(Sock, TOS1) of
<a name="21553"/>21553:          %%                       ok -&gt;
<a name="21554"/>21554:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="21555"/>21555:          %%                           ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS1]),
<a name="21556"/>21556:          %%                           ok;
<a name="21557"/>21557:          %%                       {error, Reason} = ERROR -&gt;
<a name="21558"/>21558:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="21559"/>21559:          %%                           ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21560"/>21560:          %%                                       &quot;   ~p&quot;, [Reason]),
<a name="21561"/>21561:          %%                           ERROR
<a name="21562"/>21562:          %%                   end
<a name="21563"/>21563:          %%           end},
<a name="21564"/>21564:          %% #{desc =&gt; &quot;get tos (expect &quot; ++ TOS1Str ++ &quot;)&quot;,
<a name="21565"/>21565:          %%   cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21566"/>21566:          %%                   case Get(Sock) of
<a name="21567"/>21567:          %%                       {ok, TOS1 = Value} -&gt;
<a name="21568"/>21568:          %%                           ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21569"/>21569:          %%                           ok;
<a name="21570"/>21570:          %%                       {ok, Unexpected} -&gt;
<a name="21571"/>21571:          %%                           ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21572"/>21572:          %%                                       [Unexpected]),
<a name="21573"/>21573:          %%                           {error, {unexpected, Unexpected}};
<a name="21574"/>21574:          %%                       {error, Reason} = ERROR -&gt;
<a name="21575"/>21575:          %%                           ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21576"/>21576:          %%                                       &quot;   ~p&quot;, [Reason]),
<a name="21577"/>21577:          %%                           ERROR
<a name="21578"/>21578:          %%                   end
<a name="21579"/>21579:          %%           end},
<a name="21580"/>21580: 
<a name="21581"/>21581:          #{desc =&gt; &quot;set tos &quot; ++ TOS2Str,
<a name="21582"/>21582:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21583"/>21583:                            case Set(Sock, TOS2) of
<a name="21584"/>21584:                                ok -&gt;
<a name="21585"/>21585:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS2]),
<a name="21586"/>21586:                                    ok;
<a name="21587"/>21587:                                {error, Reason} = ERROR -&gt;
<a name="21588"/>21588:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21589"/>21589:                                                &quot;   ~p&quot;, [Reason]),
<a name="21590"/>21590:                                    ERROR
<a name="21591"/>21591:                            end
<a name="21592"/>21592:                    end},
<a name="21593"/>21593:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS2Str ++ &quot;)&quot;,
<a name="21594"/>21594:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21595"/>21595:                            case Get(Sock) of
<a name="21596"/>21596:                                {ok, TOS2 = Value} -&gt;
<a name="21597"/>21597:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21598"/>21598:                                    ok;
<a name="21599"/>21599:                                {ok, Unexpected} -&gt;
<a name="21600"/>21600:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21601"/>21601:                                                [Unexpected]),
<a name="21602"/>21602:                                    {error, {unexpected, Unexpected}};
<a name="21603"/>21603:                                {error, Reason} = ERROR -&gt;
<a name="21604"/>21604:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21605"/>21605:                                                &quot;   ~p&quot;, [Reason]),
<a name="21606"/>21606:                                    ERROR
<a name="21607"/>21607:                            end
<a name="21608"/>21608:                    end},
<a name="21609"/>21609: 
<a name="21610"/>21610:          #{desc =&gt; &quot;set tos &quot; ++ TOS3Str,
<a name="21611"/>21611:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21612"/>21612:                            case Set(Sock, TOS3) of
<a name="21613"/>21613:                                ok -&gt;
<a name="21614"/>21614:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS3]),
<a name="21615"/>21615:                                    ok;
<a name="21616"/>21616:                                {error, Reason} = ERROR -&gt;
<a name="21617"/>21617:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21618"/>21618:                                                &quot;   ~p&quot;, [Reason]),
<a name="21619"/>21619:                                    ERROR
<a name="21620"/>21620:                            end
<a name="21621"/>21621:                    end},
<a name="21622"/>21622:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS3Str ++ &quot;)&quot;,
<a name="21623"/>21623:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21624"/>21624:                            case Get(Sock) of
<a name="21625"/>21625:                                {ok, TOS3 = Value} -&gt;
<a name="21626"/>21626:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21627"/>21627:                                    ok;
<a name="21628"/>21628:                                {ok, Unexpected} -&gt;
<a name="21629"/>21629:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21630"/>21630:                                                [Unexpected]),
<a name="21631"/>21631:                                    {error, {unexpected, Unexpected}};
<a name="21632"/>21632:                                {error, Reason} = ERROR -&gt;
<a name="21633"/>21633:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21634"/>21634:                                                &quot;   ~p&quot;, [Reason]),
<a name="21635"/>21635:                                    ERROR
<a name="21636"/>21636:                            end
<a name="21637"/>21637:                    end},
<a name="21638"/>21638: 
<a name="21639"/>21639:          #{desc =&gt; &quot;set tos &quot; ++ TOS4Str,
<a name="21640"/>21640:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21641"/>21641:                            case Set(Sock, TOS4) of
<a name="21642"/>21642:                                ok -&gt;
<a name="21643"/>21643:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS4]),
<a name="21644"/>21644:                                    ok;
<a name="21645"/>21645:                                {error, Reason} = ERROR -&gt;
<a name="21646"/>21646:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21647"/>21647:                                                &quot;   ~p&quot;, [Reason]),
<a name="21648"/>21648:                                    ERROR
<a name="21649"/>21649:                            end
<a name="21650"/>21650:                    end},
<a name="21651"/>21651:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS4Str ++ &quot;)&quot;,
<a name="21652"/>21652:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21653"/>21653:                            case Get(Sock) of
<a name="21654"/>21654:                                {ok, TOS4 = Value} -&gt;
<a name="21655"/>21655:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21656"/>21656:                                    ok;
<a name="21657"/>21657:                                {ok, Unexpected} -&gt;
<a name="21658"/>21658:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21659"/>21659:                                                [Unexpected]),
<a name="21660"/>21660:                                    {error, {unexpected, Unexpected}};
<a name="21661"/>21661:                                {error, Reason} = ERROR -&gt;
<a name="21662"/>21662:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21663"/>21663:                                                &quot;   ~p&quot;, [Reason]),
<a name="21664"/>21664:                                    ERROR
<a name="21665"/>21665:                            end
<a name="21666"/>21666:                    end},
<a name="21667"/>21667: 
<a name="21668"/>21668:          #{desc =&gt; &quot;set tos &quot; ++ TOS5Str,
<a name="21669"/>21669:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21670"/>21670:                            case Set(Sock, TOS5) of
<a name="21671"/>21671:                                ok -&gt;
<a name="21672"/>21672:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS5]),
<a name="21673"/>21673:                                    ok;
<a name="21674"/>21674:                                {error, Reason} = ERROR -&gt;
<a name="21675"/>21675:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="21676"/>21676:                                                &quot;   ~p&quot;, [Reason]),
<a name="21677"/>21677:                                    ERROR
<a name="21678"/>21678:                            end
<a name="21679"/>21679:                    end},
<a name="21680"/>21680:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS5Str ++ &quot;)&quot;,
<a name="21681"/>21681:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="21682"/>21682:                            case Get(Sock) of
<a name="21683"/>21683:                                {ok, TOS5 = Value} -&gt;
<a name="21684"/>21684:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="21685"/>21685:                                    ok;
<a name="21686"/>21686:                                {ok, Unexpected} -&gt;
<a name="21687"/>21687:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="21688"/>21688:                                                [Unexpected]),
<a name="21689"/>21689:                                    {error, {unexpected, Unexpected}};
<a name="21690"/>21690:                                {error, Reason} = ERROR -&gt;
<a name="21691"/>21691:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="21692"/>21692:                                                &quot;   ~p&quot;, [Reason]),
<a name="21693"/>21693:                                    ERROR
<a name="21694"/>21694:                            end
<a name="21695"/>21695:                    end},
<a name="21696"/>21696: 
<a name="21697"/>21697:          #{desc =&gt; &quot;close socket&quot;,
<a name="21698"/>21698:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="21699"/>21699:                            ok = socket:close(Sock),
<a name="21700"/>21700:                            {ok, maps:remove(sock, State)}
<a name="21701"/>21701:                    end},
<a name="21702"/>21702: 
<a name="21703"/>21703:          %% *** We are done ***
<a name="21704"/>21704:          ?SEV_FINISH_NORMAL
<a name="21705"/>21705:         ],
<a name="21706"/>21706:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_tos_udp-last_expr"/><a name="21707"/>21707: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="21708"/>21708: 
<a name="21709"/>21709: 
<a name="21710"/>21710: 
<a name="21711"/>21711: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21712"/>21712: 
<a name="21713"/>21713: <i>%% Tests the ip socket option 'recverr' can be set and that the error</i>
<a name="21714"/>21714: <i>%% queue can be read.</i>
<a name="21715"/>21715: <i>%% </i>
<a name="21716"/>21716: 
<a name="api_opt_ip_recverr_udp4-1"/><a name="21717"/>21717: <b>api_opt_ip_recverr_udp4</b>(Config) when is_list(Config) -&gt;
<a name="21718"/>21718:     ?TT(?SECS(5)),
<a name="api_opt_ip_recverr_udp4-last_expr"/><a name="21719"/>21719: <b>    tc_try</b>(api_opt_ip_recverr_udp4,
<a name="21720"/>21720:            fun() -&gt;
<a name="21721"/>21721:                    has_support_ipv4(),
<a name="21722"/>21722:                    has_support_ip_recverr()
<a name="21723"/>21723:            end,
<a name="21724"/>21724:            fun() -&gt;
<a name="21725"/>21725:                    Set  = fun(Sock, Key, Value) -&gt;
<a name="21726"/>21726:                                   socket:setopt(Sock, ip, Key, Value)
<a name="21727"/>21727:                           end,
<a name="21728"/>21728:                    Get  = fun(Sock, Key) -&gt;
<a name="21729"/>21729:                                   socket:getopt(Sock, ip, Key)
<a name="21730"/>21730:                           end,
<a name="21731"/>21731:                    Send = fun(Sock, Data, Dest, Tmo) -&gt;
<a name="21732"/>21732:                                   socket:sendto(Sock, Data, Dest, [], Tmo)
<a name="21733"/>21733:                           end,
<a name="21734"/>21734:                    Recv = fun(Sock, Tmo) -&gt;
<a name="21735"/>21735:                                   socket:recvfrom(Sock, 0, [], Tmo)
<a name="21736"/>21736:                           end,
<a name="21737"/>21737:                    InitState = #{domain =&gt; inet,
<a name="21738"/>21738:                                  proto  =&gt; udp,
<a name="21739"/>21739:                                  send   =&gt; Send,
<a name="21740"/>21740:                                  recv   =&gt; Recv,
<a name="21741"/>21741:                                  set    =&gt; Set,
<a name="21742"/>21742:                                  get    =&gt; Get},
<a name="21743"/>21743:                    ok = api_opt_recverr_udp(Config, InitState)
<a name="21744"/>21744:            end).
<a name="21745"/>21745: 
<a name="21746"/>21746: 
<a name="21747"/>21747: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21748"/>21748: 
<a name="21749"/>21749: <i>%% Tests the ipv6 socket option 'recverr' can be set and that the error</i>
<a name="21750"/>21750: <i>%% queue can be read.</i>
<a name="21751"/>21751: <i>%% </i>
<a name="21752"/>21752: 
<a name="api_opt_ipv6_recverr_udp6-1"/><a name="21753"/>21753: <b>api_opt_ipv6_recverr_udp6</b>(Config) when is_list(Config) -&gt;
<a name="21754"/>21754:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_recverr_udp6-last_expr"/><a name="21755"/>21755: <b>    tc_try</b>(api_opt_ipv6_recverr_udp6,
<a name="21756"/>21756:            fun() -&gt;
<a name="21757"/>21757:                    has_support_ipv6(),
<a name="21758"/>21758:                    has_support_ipv6_recverr()
<a name="21759"/>21759:            end,
<a name="21760"/>21760:            fun() -&gt;
<a name="21761"/>21761:                    Set  = fun(Sock, Key, Value) -&gt;
<a name="21762"/>21762:                                   socket:setopt(Sock, ipv6, Key, Value)
<a name="21763"/>21763:                           end,
<a name="21764"/>21764:                    Get  = fun(Sock, Key) -&gt;
<a name="21765"/>21765:                                   socket:getopt(Sock, ipv6, Key)
<a name="21766"/>21766:                           end,
<a name="21767"/>21767:                    Send = fun(Sock, Data, Dest, Tmo) -&gt;
<a name="21768"/>21768:                                   socket:sendto(Sock, Data, Dest, [], Tmo)
<a name="21769"/>21769:                           end,
<a name="21770"/>21770:                    Recv = fun(Sock, Tmo) -&gt;
<a name="21771"/>21771:                                   socket:recvfrom(Sock, 0, [], Tmo)
<a name="21772"/>21772:                           end,
<a name="21773"/>21773:                    InitState = #{domain =&gt; inet6,
<a name="21774"/>21774:                                  proto  =&gt; udp,
<a name="21775"/>21775:                                  send   =&gt; Send,
<a name="21776"/>21776:                                  recv   =&gt; Recv,
<a name="21777"/>21777:                                  set    =&gt; Set,
<a name="21778"/>21778:                                  get    =&gt; Get},
<a name="21779"/>21779:                    ok = api_opt_recverr_udp(Config, InitState)
<a name="21780"/>21780:            end).
<a name="21781"/>21781: 
<a name="21782"/>21782: 
<a name="21783"/>21783: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21784"/>21784: 
<a name="api_opt_recverr_udp-2"/><a name="21785"/>21785: <b>api_opt_recverr_udp</b>(Config, InitState) -&gt;
<a name="21786"/>21786:     Seq = 
<a name="21787"/>21787:         [
<a name="21788"/>21788:          #{desc =&gt; &quot;create socket&quot;,
<a name="21789"/>21789:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="21790"/>21790:                            ?SEV_IPRINT(&quot;test for ip:recvtos&quot;),
<a name="21791"/>21791:                            case socket:open(Domain, dgram, udp) of
<a name="21792"/>21792:                                {ok, Sock} -&gt;
<a name="21793"/>21793:                                    {ok, State#{sock =&gt; Sock}};
<a name="21794"/>21794:                                {error, _} = ERROR -&gt; 
<a name="21795"/>21795:                                    ERROR
<a name="21796"/>21796:                            end
<a name="21797"/>21797:                    end},
<a name="21798"/>21798:          #{desc =&gt; &quot;bind (to loopback)&quot;,
<a name="21799"/>21799:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="21800"/>21800:                            case socket:bind(Sock, loopback) of
<a name="21801"/>21801:                                ok -&gt;
<a name="21802"/>21802:                                    case socket:sockname(Sock) of
<a name="21803"/>21803:                                        {ok, Addr} -&gt;
<a name="21804"/>21804:                                            ?SEV_IPRINT(
<a name="21805"/>21805:                                               &quot;bound to ~p&quot;, [Addr]),
<a name="21806"/>21806:                                            {ok, State#{addr =&gt; Addr}};
<a name="21807"/>21807:                                        {error, _} = ERROR_1 -&gt;
<a name="21808"/>21808:                                            ERROR_1
<a name="21809"/>21809:                                    end;
<a name="21810"/>21810:                                {error, _} = ERROR_2 -&gt;
<a name="21811"/>21811:                                    ERROR_2
<a name="21812"/>21812:                            end
<a name="21813"/>21813:                    end},
<a name="21814"/>21814: 
<a name="21815"/>21815:          #{desc =&gt; &quot;enable recverr&quot;,
<a name="21816"/>21816:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21817"/>21817:                            Set(Sock, recverr, true)
<a name="21818"/>21818:                    end},
<a name="21819"/>21819: 
<a name="21820"/>21820:          #{desc =&gt; &quot;disable mtu_discover&quot;,
<a name="21821"/>21821:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="21822"/>21822:                            Set(Sock, mtu_discover, dont)
<a name="21823"/>21823:                    end},
<a name="21824"/>21824: 
<a name="21825"/>21825:          #{desc =&gt; &quot;try (async) read (=&gt; select)&quot;,
<a name="21826"/>21826:            cmd  =&gt; fun(#{sock := Sock,
<a name="21827"/>21827:                          recv := Recv} = State) -&gt;
<a name="21828"/>21828:                            RecvRef = nowait(Config),
<a name="21829"/>21829:                            case Recv(Sock, RecvRef) of
<a name="21830"/>21830:                                {select, SelectInfo} when RecvRef =:= nowait -&gt;
<a name="21831"/>21831:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="21832"/>21832: 					       &quot;~n   ~p&quot;, [SelectInfo]),
<a name="21833"/>21833:                                    {ok, State#{async_tag =&gt; select,
<a name="21834"/>21834:                                                rselect   =&gt; SelectInfo}};
<a name="21835"/>21835:                                {select,
<a name="21836"/>21836:                                 {select_info, _Tag, RecvRef} = SelectInfo}
<a name="21837"/>21837:                                  when is_reference(RecvRef) -&gt;
<a name="21838"/>21838:                                    ?SEV_IPRINT(&quot;expected select ref: &quot;
<a name="21839"/>21839: 					       &quot;~n   ~p&quot;, [SelectInfo]),
<a name="21840"/>21840:                                    {ok, State#{async_tag =&gt; select,
<a name="21841"/>21841:                                                rselect   =&gt; SelectInfo}};
<a name="21842"/>21842: 
<a name="21843"/>21843:                                {completion, CI} when RecvRef =:= nowait -&gt;
<a name="21844"/>21844:                                    ?SEV_IPRINT(&quot;expected completion nowait: &quot;
<a name="21845"/>21845: 					       &quot;~n   ~p&quot;, [CI]),
<a name="21846"/>21846:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="21847"/>21847:                                                rcompletion =&gt; CI}};
<a name="21848"/>21848:                                {completion,
<a name="21849"/>21849:                                 {completion_info, _Tag, RecvRef} = CI}
<a name="21850"/>21850:                                  when is_reference(RecvRef) -&gt;
<a name="21851"/>21851:                                    ?SEV_IPRINT(&quot;expected completion ref: &quot;
<a name="21852"/>21852: 					       &quot;~n   ~p&quot;, [CI]),
<a name="21853"/>21853:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="21854"/>21854:                                                rcompletion =&gt; CI}};
<a name="21855"/>21855: 
<a name="21856"/>21856:                                {ok, _} -&gt;
<a name="21857"/>21857:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="21858"/>21858:                                    {error, unexpected_success};
<a name="21859"/>21859: 
<a name="21860"/>21860:                                {error, Reason} = ERROR -&gt;
<a name="21861"/>21861:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;, [Reason]),
<a name="21862"/>21862:                                    ERROR
<a name="21863"/>21863:                            end
<a name="21864"/>21864:                    end},
<a name="21865"/>21865: 
<a name="21866"/>21866:          #{desc =&gt; &quot;try send to nowhere&quot;,
<a name="21867"/>21867:            cmd  =&gt; fun(#{domain := Domain,
<a name="21868"/>21868:                          sock   := Sock,
<a name="21869"/>21869:                          send   := Send} = State) -&gt;
<a name="21870"/>21870:                            SendRef = nowait(Config),
<a name="21871"/>21871:                            Dest = #{family =&gt; Domain,
<a name="21872"/>21872:                                     addr   =&gt; if
<a name="21873"/>21873:                                                   (Domain =:= inet) -&gt;
<a name="21874"/>21874:                                                       {127,0,0,1};
<a name="21875"/>21875:                                                   (Domain =:= inet6) -&gt;
<a name="21876"/>21876:                                                       {0,0,0,0,0,0,0,1}
<a name="21877"/>21877:                                               end,
<a name="21878"/>21878:                                     port   =&gt; 44444},
<a name="21879"/>21879:                            case Send(Sock, &lt;&lt;&quot;ping&quot;&gt;&gt;, Dest, SendRef) of
<a name="21880"/>21880:                                ok -&gt;
<a name="21881"/>21881:                                    ?SEV_IPRINT(&quot;sent&quot;),
<a name="21882"/>21882:                                    {ok, State#{sent =&gt; true}};
<a name="21883"/>21883: 
<a name="21884"/>21884:                                {select, SelectInfo}
<a name="21885"/>21885:                                  when SendRef =:= nowait -&gt;
<a name="21886"/>21886:                                    ?SEV_IPRINT(&quot;expected select nowait: ~p&quot;,
<a name="21887"/>21887: 					       [SelectInfo]),
<a name="21888"/>21888:                                    {ok, State#{sent       =&gt; false,
<a name="21889"/>21889:                                                asynch_tag =&gt; select,
<a name="21890"/>21890:                                                sselect    =&gt; SelectInfo}};
<a name="21891"/>21891:                                {select,
<a name="21892"/>21892:                                 {select_info, _Tag, SendRef} = SelectInfo}
<a name="21893"/>21893:                                  when is_reference(SendRef) -&gt;
<a name="21894"/>21894:                                    ?SEV_IPRINT(&quot;expected select ref: ~p&quot;,
<a name="21895"/>21895: 					       [SelectInfo]),
<a name="21896"/>21896:                                    {ok, State#{sent       =&gt; false,
<a name="21897"/>21897:                                                asynch_tag =&gt; select,
<a name="21898"/>21898:                                                sselect    =&gt; SelectInfo}};
<a name="21899"/>21899: 
<a name="21900"/>21900:                                {completion, CI}
<a name="21901"/>21901:                                  when SendRef =:= nowait -&gt;
<a name="21902"/>21902:                                    ?SEV_IPRINT(&quot;expected completion nowait: ~p&quot;,
<a name="21903"/>21903: 					       [CI]),
<a name="21904"/>21904:                                    {ok, State#{sent       =&gt; false,
<a name="21905"/>21905:                                                asynch_tag  =&gt; completion,
<a name="21906"/>21906:                                                scompletion =&gt; CI}};
<a name="21907"/>21907:                                {completion,
<a name="21908"/>21908:                                 {completion_info, _Tag, SendRef} = CI}
<a name="21909"/>21909:                                  when is_reference(SendRef) -&gt;
<a name="21910"/>21910:                                    ?SEV_IPRINT(&quot;expected completion ref: ~p&quot;,
<a name="21911"/>21911: 					       [CI]),
<a name="21912"/>21912:                                    {ok, State#{sent       =&gt; false,
<a name="21913"/>21913:                                                asynch_tag  =&gt; completion,
<a name="21914"/>21914:                                                scompletion =&gt; CI}};
<a name="21915"/>21915: 
<a name="21916"/>21916:                                {error, Reason} = ERROR -&gt;
<a name="21917"/>21917:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="21918"/>21918: 					       [Reason]),
<a name="21919"/>21919:                                    ERROR
<a name="21920"/>21920:                            end
<a name="21921"/>21921:                    end},
<a name="21922"/>21922: 
<a name="21923"/>21923:          #{desc =&gt; &quot;await receive select|completion message&quot;,
<a name="21924"/>21924:            cmd  =&gt; fun(#{sent       := false,
<a name="21925"/>21925:                          asynch_tag := select,
<a name="21926"/>21926:                          sock       := Sock,
<a name="21927"/>21927:                          rselect    := {select_info, _, Ref}} = _State) -&gt;
<a name="21928"/>21928:                            receive
<a name="21929"/>21929:                                {'$socket', Sock, select, Ref} -&gt;
<a name="21930"/>21930:                                    ?SEV_IPRINT(&quot;received expected (read) &quot;
<a name="21931"/>21931:                                                &quot;select message: &quot;
<a name="21932"/>21932:                                                &quot;~n   ~p&quot;, [Ref]),
<a name="21933"/>21933:                                    ok
<a name="21934"/>21934:                            end;
<a name="21935"/>21935:                       (#{sent        := false,
<a name="21936"/>21936:                          asynch_tag  := completion,
<a name="21937"/>21937:                          sock        := Sock,
<a name="21938"/>21938:                          rcompletion := {completion_info, _, Ref}} = _State) -&gt;
<a name="21939"/>21939:                            receive
<a name="21940"/>21940:                                {'$socket', Sock, completion,
<a name="21941"/>21941:                                 {Ref, {error, econnrefused = Reason}}} -&gt;
<a name="21942"/>21942:                                    ?SEV_IPRINT(&quot;expected failure: ~p&quot;,
<a name="21943"/>21943:                                                [Reason]),
<a name="21944"/>21944:                                    ok;
<a name="21945"/>21945: 
<a name="21946"/>21946:                                {'$socket', Sock, completion,
<a name="21947"/>21947:                                 {Ref, {ok, _}}} -&gt;
<a name="21948"/>21948:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="21949"/>21949:                                    {error, unexpected_success};
<a name="21950"/>21950:                                {'$socket', Sock, completion,
<a name="21951"/>21951:                                 {Ref, {error, Reason} = ERROR}} -&gt;
<a name="21952"/>21952:                                    ?SEV_IPRINT(&quot;unexpected failure: ~p&quot;,
<a name="21953"/>21953:                                                [Reason]),
<a name="21954"/>21954:                                    ERROR
<a name="21955"/>21955: 
<a name="21956"/>21956:                            end;
<a name="21957"/>21957:                       (#{sent := true} = _State) -&gt;
<a name="21958"/>21958:                            ?SEV_IPRINT(&quot;no action needed&quot;),
<a name="21959"/>21959:                            ok
<a name="21960"/>21960:                    end},
<a name="21961"/>21961: 
<a name="21962"/>21962:          #{desc =&gt; &quot;try recv - expect econnrefused&quot;,
<a name="21963"/>21963:            cmd  =&gt; fun(#{asynch_tag := completion} = _State) -&gt;
<a name="21964"/>21964:                            ?SEV_IPRINT(&quot;already processed&quot;),
<a name="21965"/>21965:                            ok;
<a name="21966"/>21966:                       (#{sock := Sock,
<a name="21967"/>21967:                          recv := Recv} = _State) -&gt;
<a name="21968"/>21968:                            case Recv(Sock, infinity) of
<a name="21969"/>21969:                                {error, econnrefused = Reason} -&gt;
<a name="21970"/>21970:                                    ?SEV_IPRINT(&quot;expected failure: ~p&quot;,
<a name="21971"/>21971:                                                [Reason]),
<a name="21972"/>21972:                                    ok;
<a name="21973"/>21973:                                {ok, _} -&gt;
<a name="21974"/>21974:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="21975"/>21975:                                    {error, unexpected_success};
<a name="21976"/>21976:                                {select, SelectInfo} -&gt;
<a name="21977"/>21977:                                    ?SEV_EPRINT(&quot;unexpected select: ~p&quot;,
<a name="21978"/>21978:                                                [SelectInfo]),
<a name="21979"/>21979:                                    {error, unexpected_success};
<a name="21980"/>21980:                                {error, Reason} = ERROR -&gt;
<a name="21981"/>21981:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="21982"/>21982:                                                [Reason]),
<a name="21983"/>21983:                                    ERROR
<a name="21984"/>21984:                            end
<a name="21985"/>21985:                    end},
<a name="21986"/>21986: 
<a name="21987"/>21987:          #{desc =&gt; &quot;send to self&quot;,
<a name="21988"/>21988:            cmd  =&gt;
<a name="21989"/>21989:                fun(#{sock := Sock,
<a name="21990"/>21990:                      send := Send,
<a name="21991"/>21991:                      addr := Addr} = _State) -&gt;
<a name="21992"/>21992:                        case Send(Sock, &lt;&lt;&quot;ring&quot;&gt;&gt;, Addr, infinity) of
<a name="21993"/>21993:                            ok -&gt;
<a name="21994"/>21994:                                ?SEV_IPRINT(&quot;sent to self&quot;),
<a name="21995"/>21995:                                ok;
<a name="21996"/>21996:                            {error, _} = Error -&gt;
<a name="21997"/>21997:                                Error
<a name="21998"/>21998:                        end
<a name="21999"/>21999:                end},
<a name="22000"/>22000: 
<a name="22001"/>22001:          #{desc =&gt; &quot;try recv - expect data sent to self&quot;,
<a name="22002"/>22002:            cmd  =&gt; fun(#{sock := Sock,
<a name="22003"/>22003:                          addr := Addr,
<a name="22004"/>22004:                          recv := Recv} = _State) -&gt;
<a name="22005"/>22005:                            case Recv(Sock, infinity) of
<a name="22006"/>22006:                                {ok, {Addr, &lt;&lt;&quot;ring&quot;&gt;&gt;}} -&gt;
<a name="22007"/>22007:                                    ?SEV_IPRINT(&quot;receive expected&quot;),
<a name="22008"/>22008:                                    ok;
<a name="22009"/>22009: 
<a name="22010"/>22010:                                {select, SelectInfo} -&gt;
<a name="22011"/>22011:                                    ?SEV_EPRINT(&quot;unexpected select: ~p&quot;,
<a name="22012"/>22012:                                                [SelectInfo]),
<a name="22013"/>22013:                                    {error, unexpected_success};
<a name="22014"/>22014: 
<a name="22015"/>22015:                                {completion, CompletionInfo} -&gt;
<a name="22016"/>22016:                                    ?SEV_EPRINT(&quot;unexpected completion: ~p&quot;,
<a name="22017"/>22017:                                                [CompletionInfo]),
<a name="22018"/>22018:                                    {error, unexpected_success};
<a name="22019"/>22019: 
<a name="22020"/>22020:                                {error, Reason} = ERROR -&gt;
<a name="22021"/>22021:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="22022"/>22022:                                                [Reason]),
<a name="22023"/>22023:                                    ERROR
<a name="22024"/>22024:                            end
<a name="22025"/>22025:                    end},
<a name="22026"/>22026: 
<a name="22027"/>22027:          #{desc =&gt; &quot;try recv error queue&quot;,
<a name="22028"/>22028:            cmd  =&gt; fun(#{domain := Domain, sock := Sock} = State) -&gt;
<a name="22029"/>22029:                            %% Note that not all platforms that support
<a name="22030"/>22030:                            %% recverr, actually supports &quot;encoding&quot; the data
<a name="22031"/>22031:                            %% part, so we need to adjust for that.
<a name="22032"/>22032: 			   Origin = 
<a name="22033"/>22033: 			       if (Domain =:= inet)  -&gt; icmp;
<a name="22034"/>22034: 				  (Domain =:= inet6) -&gt; icmp6
<a name="22035"/>22035: 			       end,
<a name="22036"/>22036: 			   Level =
<a name="22037"/>22037: 			       if (Domain =:= inet)  -&gt; ip;
<a name="22038"/>22038: 				  (Domain =:= inet6) -&gt; ipv6
<a name="22039"/>22039: 			       end,
<a name="22040"/>22040:                            case socket:recvmsg(Sock, [errqueue], 0) of
<a name="22041"/>22041:                                {ok, #{addr  := #{family := Domain,
<a name="22042"/>22042: 						 addr   := Addr},
<a name="22043"/>22043:                                       flags := [errqueue],
<a name="22044"/>22044:                                       iov   := [&lt;&lt;&quot;ping&quot;&gt;&gt;],
<a name="22045"/>22045:                                       ctrl  := [#{level := Level,
<a name="22046"/>22046:                                                   type  := recverr,
<a name="22047"/>22047:                                                   value :=
<a name="22048"/>22048:                                                       #{code     := port_unreach,
<a name="22049"/>22049:                                                         data     := 0,
<a name="22050"/>22050:                                                         error    := econnrefused,
<a name="22051"/>22051:                                                         info     := 0,
<a name="22052"/>22052:                                                         offender := #{family := Domain,
<a name="22053"/>22053: 								      addr   := Addr},
<a name="22054"/>22054:                                                         origin   := Origin,
<a name="22055"/>22055:                                                         type     := dest_unreach}
<a name="22056"/>22056:                                                  }]} = Msg} -&gt;
<a name="22057"/>22057:                                    ?SEV_IPRINT(&quot;expected error queue (decoded): &quot;
<a name="22058"/>22058:                                                &quot;~n   ~p&quot;, [Msg]),
<a name="22059"/>22059:                                    {ok, State#{asynch_tag =&gt; none}};
<a name="22060"/>22060:                                {ok, #{addr  := #{family := Domain,
<a name="22061"/>22061: 						 addr   := _Addr},
<a name="22062"/>22062:                                       flags := [errqueue],
<a name="22063"/>22063:                                       iov   := [&lt;&lt;&quot;ping&quot;&gt;&gt;],
<a name="22064"/>22064:                                       value := [#{level := Level,
<a name="22065"/>22065:                                                   type  := recverr}]} = _Msg} -&gt;
<a name="22066"/>22066:                                    ?SEV_IPRINT(&quot;expected error queue&quot;),
<a name="22067"/>22067:                                    {ok, State#{asynch_tag =&gt; none}};
<a name="22068"/>22068: 
<a name="22069"/>22069:                                {completion, CI} -&gt;
<a name="22070"/>22070:                                    ?SEV_IPRINT(&quot;completion: &quot;
<a name="22071"/>22071:                                                &quot;~n   ~p&quot;, [CI]),
<a name="22072"/>22072:                                    {ok, State#{asynch_tag =&gt; completion,
<a name="22073"/>22073:                                                completion =&gt; CI}};
<a name="22074"/>22074: 
<a name="22075"/>22075:                                {error, timeout = Reason} = ERROR -&gt;
<a name="22076"/>22076:                                    case os:type() of
<a name="22077"/>22077:                                        {win32, nt} -&gt;
<a name="22078"/>22078:                                            ?SEV_IPRINT(&quot;failed reading &quot;
<a name="22079"/>22079:                                                        &quot;error queue: &quot;
<a name="22080"/>22080:                                                        &quot;~n   ~p&quot;, [Reason]),
<a name="22081"/>22081:                                            {skip,
<a name="22082"/>22082:                                             &quot;Test case does not &quot;
<a name="22083"/>22083:                                             &quot;work on Windows&quot;};
<a name="22084"/>22084:                                        _ -&gt;
<a name="22085"/>22085:                                            ?SEV_EPRINT(&quot;failed reading &quot;
<a name="22086"/>22086:                                                        &quot;error queue: &quot;
<a name="22087"/>22087:                                                        &quot;~n   ~p&quot;, [Reason]),
<a name="22088"/>22088:                                            ERROR
<a name="22089"/>22089:                                    end;
<a name="22090"/>22090: 
<a name="22091"/>22091:                                {error, Reason} = ERROR -&gt;
<a name="22092"/>22092:                                    ?SEV_EPRINT(&quot;failed reading error queue: &quot;
<a name="22093"/>22093:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="22094"/>22094:                                    ERROR
<a name="22095"/>22095:                            end
<a name="22096"/>22096:                    end},
<a name="22097"/>22097: 
<a name="22098"/>22098:          #{desc =&gt; &quot;await receive select message&quot;,
<a name="22099"/>22099:            cmd  =&gt; fun(#{asynch_tag := completion,
<a name="22100"/>22100:                          sock       := Sock,
<a name="22101"/>22101:                          completion := {completion_info, _, Ref}} = _State) -&gt;
<a name="22102"/>22102:                            receive
<a name="22103"/>22103:                                {'$socket', Sock, completion,
<a name="22104"/>22104:                                 {Ref, {ok, Info}}} -&gt;
<a name="22105"/>22105:                                    ?SEV_EPRINT(&quot;expected success: &quot;
<a name="22106"/>22106:                                                &quot;~n   ~p&quot;, [Info]),
<a name="22107"/>22107:                                    ok;
<a name="22108"/>22108: 
<a name="22109"/>22109:                                {'$socket', Sock, completion,
<a name="22110"/>22110:                                 {Ref, {error, Reason} = ERROR}} -&gt;
<a name="22111"/>22111:                                    ?SEV_IPRINT(&quot;unexpected failure: ~p&quot;,
<a name="22112"/>22112:                                                [Reason]),
<a name="22113"/>22113:                                    ERROR
<a name="22114"/>22114: 
<a name="22115"/>22115:                            end;
<a name="22116"/>22116:                       (#{asynch_tag := none} = _State) -&gt;
<a name="22117"/>22117:                            ?SEV_IPRINT(&quot;no action needed&quot;),
<a name="22118"/>22118:                            ok
<a name="22119"/>22119:                    end},
<a name="22120"/>22120: 
<a name="22121"/>22121:          #{desc =&gt; &quot;close socket&quot;,
<a name="22122"/>22122:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="22123"/>22123:                            ok = socket:close(Sock),
<a name="22124"/>22124:                            {ok, maps:remove(sock, State)}
<a name="22125"/>22125:                    end},
<a name="22126"/>22126: 
<a name="22127"/>22127:          %% *** We are done ***
<a name="22128"/>22128:          ?SEV_FINISH_NORMAL
<a name="22129"/>22129:         ],
<a name="22130"/>22130:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_recverr_udp-last_expr"/><a name="22131"/>22131: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22132"/>22132: 
<a name="22133"/>22133: 
<a name="22134"/>22134: 
<a name="22135"/>22135: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22136"/>22136: 
<a name="22137"/>22137: <i>%% This intended to test &quot;all&quot; of the (currently) supported IPv4</i>
<a name="22138"/>22138: <i>%% options that results in control message header(s).</i>
<a name="22139"/>22139: <i>%% So, this is done on the receiving side:</i>
<a name="22140"/>22140: <i>%%</i>
<a name="22141"/>22141: <i>%%      socket:setopt(Sock, ip, Flag, boolean()).</i>
<a name="22142"/>22142: <i>%%</i>
<a name="22143"/>22143: <i>%% For all subsequent *received* messages, a control message header</i>
<a name="22144"/>22144: <i>%% for each of the enabled options will be received with the message.</i>
<a name="22145"/>22145: <i>%%</i>
<a name="22146"/>22146: <i>%% Only allowed for dgram and raw,</i>
<a name="22147"/>22147: <i>%% although we only test this with dgram.</i>
<a name="22148"/>22148: <i>%%</i>
<a name="22149"/>22149: <i>%% Currently we *try* to use the following opts:</i>
<a name="22150"/>22150: <i>%%</i>
<a name="22151"/>22151: <i>%%      pktinfo         =&gt; pktinfo</i>
<a name="22152"/>22152: <i>%%      recvorigdstaddr =&gt; origdstaddr</i>
<a name="22153"/>22153: <i>%%      recvtos         =&gt; tos</i>
<a name="22154"/>22154: <i>%%      recvttl         =&gt; ttl</i>
<a name="22155"/>22155: <i>%%</i>
<a name="22156"/>22156: <i>%%</i>
<a name="22157"/>22157: <i>%% Every time we add a test case for a new option (that results in</i>
<a name="22158"/>22158: <i>%% a control message hedare), we should also add it here.</i>
<a name="22159"/>22159: <i>%%</i>
<a name="22160"/>22160: <i>%% Even though this is a IPv4 test case, we add the 'socket' timestamp</i>
<a name="22161"/>22161: <i>%% option (just to fill up), but in the test to see if we should run</i>
<a name="22162"/>22162: <i>%% the test (since its a IPv4 test case).</i>
<a name="22163"/>22163: <i>%%</i>
<a name="22164"/>22164: 
<a name="api_opt_ip_mopts_udp4-1"/><a name="22165"/>22165: <b>api_opt_ip_mopts_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="22166"/>22166:     ?TT(?SECS(5)),
<a name="api_opt_ip_mopts_udp4-last_expr"/><a name="22167"/>22167: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="22168"/>22168:            fun() -&gt;
<a name="22169"/>22169:                    has_support_ipv4(),
<a name="22170"/>22170:                    Opts =
<a name="22171"/>22171:                        [{ip, pktinfo},
<a name="22172"/>22172:                         {ip, recvorigdstaddr}] ++
<a name="22173"/>22173:                        case os:type() of
<a name="22174"/>22174:                            {win32, nt} -&gt;
<a name="22175"/>22175:                                [];
<a name="22176"/>22176:                            _ -&gt;
<a name="22177"/>22177:                                [{ip, recvtos},
<a name="22178"/>22178:                                 {ip, recvttl}]
<a name="22179"/>22179:                        end,
<a name="22180"/>22180: 		   case is_any_options_supported(Opts) of
<a name="22181"/>22181: 		       true -&gt;
<a name="22182"/>22182: 			   ok;
<a name="22183"/>22183: 		       false -&gt;
<a name="22184"/>22184: 			   skip(&quot;None of the needed options are supported&quot;)
<a name="22185"/>22185: 		   end
<a name="22186"/>22186:            end,
<a name="22187"/>22187:            fun() -&gt;
<a name="22188"/>22188: 		   %% If we get this far, we *know* that at least one of the
<a name="22189"/>22189: 		   %% options are available.
<a name="22190"/>22190: 
<a name="22191"/>22191: 		   %% This is list of all the options and there resulting
<a name="22192"/>22192: 		   %% control message header type(s):
<a name="22193"/>22193: 		   %%   [{level,
<a name="22194"/>22194: 		   %%     'ipv6 socket option',
<a name="22195"/>22195:                    %%     'control message header type',
<a name="22196"/>22196: 		   %%     default | value()}]
<a name="22197"/>22197: 		   Opts =
<a name="22198"/>22198: 		       case socket:is_supported(options, socket, timestamp) of
<a name="22199"/>22199: 			   true -&gt;
<a name="22200"/>22200: 			       [{socket, timestamp, timestamp, default}];
<a name="22201"/>22201: 			   false -&gt;
<a name="22202"/>22202: 			       []
<a name="22203"/>22203: 		       end ++
<a name="22204"/>22204: 		       case socket:is_supported(options, ip, pktinfo) of
<a name="22205"/>22205: 			   true -&gt;
<a name="22206"/>22206: 			       [{ip, pktinfo, pktinfo, default}];
<a name="22207"/>22207: 			   false -&gt;
<a name="22208"/>22208: 			       []
<a name="22209"/>22209: 		       end ++
<a name="22210"/>22210: 		       case socket:is_supported(options, ip, recvorigdstaddr) of
<a name="22211"/>22211: 			   true -&gt;
<a name="22212"/>22212: 			       [{ip, recvorigdstaddr, origdstaddr, default}];
<a name="22213"/>22213: 			   false -&gt;
<a name="22214"/>22214: 			       []
<a name="22215"/>22215: 		       end ++
<a name="22216"/>22216:                        case os:type() of
<a name="22217"/>22217:                            {win32, nt} -&gt;
<a name="22218"/>22218:                                [];
<a name="22219"/>22219:                            _ -&gt;
<a name="22220"/>22220:                                case socket:is_supported(options, ip, recvtos) of
<a name="22221"/>22221:                                    true -&gt;
<a name="22222"/>22222:                                        %% It seems that sending any of the
<a name="22223"/>22223:                                        %% TOS or TTL values will fail on: 
<a name="22224"/>22224:                                        %%    FreeBSD
<a name="22225"/>22225:                                        %%    Linux when
<a name="22226"/>22226:                                        %%      version =&lt; 3.12.60 (at least)
<a name="22227"/>22227:                                        %%      Don't know when this starts
<a name="22228"/>22228:                                        %%      working, but it works on: 
<a name="22229"/>22229:                                        %%         Ubunto 16.04.6 =&gt; 4.15.0-65
<a name="22230"/>22230:                                        %%         SLES 12 SP2 =&gt; 4.4.120-92.70
<a name="22231"/>22231:                                        %% so don't!
<a name="22232"/>22232:                                        %%
<a name="22233"/>22233:                                        %% The latest we know it not to work
<a name="22234"/>22234:                                        %% was a SLES 12 (plain) at 3.12.50-52.54
<a name="22235"/>22235:                                        %%
<a name="22236"/>22236:                                        [{ip, recvtos, tos, 
<a name="22237"/>22237:                                          case os:type() of
<a name="22238"/>22238:                                              {unix, freebsd} -&gt;
<a name="22239"/>22239:                                                  default;
<a name="22240"/>22240:                                              {unix, linux} -&gt;
<a name="22241"/>22241:                                                  case os:version() of
<a name="22242"/>22242:                                                      Vsn when Vsn &gt; {3,12,60} -&gt;
<a name="22243"/>22243:                                                          42;
<a name="22244"/>22244:                                                      _ -&gt;
<a name="22245"/>22245:                                                          default
<a name="22246"/>22246:                                                  end;
<a name="22247"/>22247:                                              _ -&gt; 
<a name="22248"/>22248:                                                  42
<a name="22249"/>22249:                                          end}];
<a name="22250"/>22250:                                    false -&gt;
<a name="22251"/>22251:                                        []
<a name="22252"/>22252:                                end
<a name="22253"/>22253: 		       end ++
<a name="22254"/>22254:                        case os:type() of
<a name="22255"/>22255:                            {unix, darwin} -&gt;
<a name="22256"/>22256:                                [];
<a name="22257"/>22257:                            {win32, nt} -&gt;
<a name="22258"/>22258:                                [];
<a name="22259"/>22259:                            _ -&gt;
<a name="22260"/>22260:                                case socket:is_supported(options, ip, recvttl) of
<a name="22261"/>22261:                                    true -&gt;
<a name="22262"/>22262: 				       %% It seems that sending any of the
<a name="22263"/>22263: 				       %% TOS or TTL values will fail on: 
<a name="22264"/>22264: 				       %%    FreeBSD and NetBSD
<a name="22265"/>22265: 				       %%    Linux when
<a name="22266"/>22266: 				       %%      version =&lt; 3.12.60 (at least)
<a name="22267"/>22267: 				       %% so don't!
<a name="22268"/>22268:                                        %% See recvtos above for more info.
<a name="22269"/>22269:                                        [{ip, recvttl, ttl,
<a name="22270"/>22270:                                          case os:type() of
<a name="22271"/>22271:                                              {unix, BSD} 
<a name="22272"/>22272:                                                when (BSD =:= freebsd) orelse
<a name="22273"/>22273:                                                     (BSD =:= netbsd) -&gt;
<a name="22274"/>22274:                                                  default;
<a name="22275"/>22275:                                              {unix, netbsd} -&gt;
<a name="22276"/>22276:                                                  default;
<a name="22277"/>22277: 					     {unix, linux} -&gt;
<a name="22278"/>22278: 						 case os:version() of
<a name="22279"/>22279: 						     Vsn when Vsn &gt; {3,12,60} -&gt;
<a name="22280"/>22280: 							 42;
<a name="22281"/>22281: 						     _ -&gt;
<a name="22282"/>22282: 							 default
<a name="22283"/>22283: 						 end;
<a name="22284"/>22284:                                              _ -&gt; 
<a name="22285"/>22285:                                                  42
<a name="22286"/>22286:                                          end}];
<a name="22287"/>22287:                                    false -&gt;
<a name="22288"/>22288:                                        []
<a name="22289"/>22289:                                end
<a name="22290"/>22290: 		       end,
<a name="22291"/>22291: 
<a name="22292"/>22292:                    Enable = fun(Sock, Level, Opt) -&gt;
<a name="22293"/>22293: 				    ?SEV_IPRINT(&quot;try enable [~w] ~p&quot;,
<a name="22294"/>22294:                                                 [Level, Opt]),
<a name="22295"/>22295: 				    socket:setopt(Sock, Level, Opt, true)
<a name="22296"/>22296:                             end,
<a name="22297"/>22297:                    Send = fun(Sock, Data, Dest, []) -&gt;
<a name="22298"/>22298:                                   Msg = #{addr =&gt; Dest,
<a name="22299"/>22299:                                           iov  =&gt; [Data]},
<a name="22300"/>22300:                                   socket:sendmsg(Sock, Msg);
<a name="22301"/>22301: 			     (Sock, Data, Dest, Hdrs) when is_list(Hdrs) -&gt;
<a name="22302"/>22302: 				  CMsgs = [#{level =&gt; Level,
<a name="22303"/>22303:                                              type  =&gt; Type,
<a name="22304"/>22304:                                              value =&gt; Val} ||
<a name="22305"/>22305:                                               {Level, Type, Val} &lt;- Hdrs],
<a name="22306"/>22306:                                   Msg   = #{addr =&gt; Dest,
<a name="22307"/>22307:                                             ctrl =&gt; CMsgs,
<a name="22308"/>22308:                                             iov  =&gt; [Data]},
<a name="22309"/>22309:                                   socket:sendmsg(Sock, Msg)
<a name="22310"/>22310:                           end,
<a name="22311"/>22311:                    Recv = fun(Sock) -&gt;
<a name="22312"/>22312:                                   case socket:recvmsg(Sock) of
<a name="22313"/>22313:                                       {ok, #{addr := Source,
<a name="22314"/>22314:                                              ctrl := CMsgs,
<a name="22315"/>22315:                                              iov  := [Data]}} -&gt;
<a name="22316"/>22316:                                           {ok, {Source, CMsgs, Data}};
<a name="22317"/>22317:                                       {error, _} = ERROR -&gt;
<a name="22318"/>22318:                                           ERROR
<a name="22319"/>22319:                                   end
<a name="22320"/>22320:                           end,
<a name="22321"/>22321:                    InitState = #{domain =&gt; inet,
<a name="22322"/>22322:                                  proto  =&gt; udp,
<a name="22323"/>22323: 				 opts   =&gt; Opts,
<a name="22324"/>22324:                                  send   =&gt; Send,
<a name="22325"/>22325:                                  recv   =&gt; Recv,
<a name="22326"/>22326:                                  enable =&gt; Enable},
<a name="22327"/>22327:                    ok = api_opt_ip_mopts_udp(InitState)
<a name="22328"/>22328:            end).
<a name="22329"/>22329: 
<a name="22330"/>22330: 
<a name="22331"/>22331: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22332"/>22332: 
<a name="api_opt_ip_mopts_udp-1"/><a name="22333"/>22333: <b>api_opt_ip_mopts_udp</b>(InitState) -&gt;
<a name="22334"/>22334:     Seq = 
<a name="22335"/>22335:         [
<a name="22336"/>22336:          #{desc =&gt; &quot;local address&quot;,
<a name="22337"/>22337:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="22338"/>22338:                            LSA = which_local_socket_addr(Domain),
<a name="22339"/>22339:                            {ok, State#{lsa_src =&gt; LSA,
<a name="22340"/>22340:                                        lsa_dst =&gt; LSA}}
<a name="22341"/>22341:                    end},
<a name="22342"/>22342: 
<a name="22343"/>22343:          #{desc =&gt; &quot;open src socket&quot;,
<a name="22344"/>22344:            cmd  =&gt; fun(#{domain := Domain,
<a name="22345"/>22345:                          proto  := Proto} = State) -&gt;
<a name="22346"/>22346:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22347"/>22347:                            {ok, State#{sock_src =&gt; Sock}}
<a name="22348"/>22348:                    end},
<a name="22349"/>22349:          #{desc =&gt; &quot;bind src&quot;,
<a name="22350"/>22350:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="22351"/>22351:                            case sock_bind(Sock, LSA) of
<a name="22352"/>22352:                                ok -&gt;
<a name="22353"/>22353:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22354"/>22354:                                    ok;
<a name="22355"/>22355:                                {error, Reason} = ERROR -&gt;
<a name="22356"/>22356:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22357"/>22357:                                    ERROR
<a name="22358"/>22358:                            end
<a name="22359"/>22359:                    end},
<a name="22360"/>22360:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="22361"/>22361:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22362"/>22362:                            SASrc = sock_sockname(Sock),
<a name="22363"/>22363:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="22364"/>22364:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="22365"/>22365:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="22366"/>22366:                    end},
<a name="22367"/>22367: 
<a name="22368"/>22368:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="22369"/>22369:            cmd  =&gt; fun(#{domain := Domain,
<a name="22370"/>22370:                          proto  := Proto} = State) -&gt;
<a name="22371"/>22371:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22372"/>22372:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="22373"/>22373:                    end},
<a name="22374"/>22374:          #{desc =&gt; &quot;bind dst&quot;,
<a name="22375"/>22375:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="22376"/>22376:                            case sock_bind(Sock, LSA) of
<a name="22377"/>22377:                                ok -&gt;
<a name="22378"/>22378:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22379"/>22379:                                    ok;
<a name="22380"/>22380:                                {error, Reason} = ERROR -&gt;
<a name="22381"/>22381:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22382"/>22382:                                    ERROR
<a name="22383"/>22383:                            end
<a name="22384"/>22384:                    end},
<a name="22385"/>22385:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="22386"/>22386:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22387"/>22387:                            SADst = sock_sockname(Sock),
<a name="22388"/>22388:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="22389"/>22389:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="22390"/>22390:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="22391"/>22391:                    end},
<a name="22392"/>22392: 
<a name="22393"/>22393:          #{desc =&gt; &quot;enable options on dst socket&quot;,
<a name="22394"/>22394:            cmd  =&gt; fun(#{sock_dst := DSock,
<a name="22395"/>22395: 			 sock_src := SSock,
<a name="22396"/>22396: 			 opts     := Opts,
<a name="22397"/>22397: 			 enable   := Enable} = _State) -&gt;
<a name="22398"/>22398: 			   %% If we fail to enable *any* of the options,
<a name="22399"/>22399: 			   %% we give up.
<a name="22400"/>22400: 			   E = fun({Level, Opt, _, _}) -&gt; 
<a name="22401"/>22401:                                        case Enable(DSock, Level, Opt) of
<a name="22402"/>22402:                                            ok -&gt;
<a name="22403"/>22403:                                                ?SEV_IPRINT(&quot;dst [~w] ~w enabled&quot;,
<a name="22404"/>22404:                                                            [Level, Opt]),
<a name="22405"/>22405:                                                ok;
<a name="22406"/>22406:                                            {error, enoprotoopt = Reason} -&gt;
<a name="22407"/>22407:                                                ?SEV_EPRINT(&quot;Expected &quot;
<a name="22408"/>22408:                                                            &quot;Failure: &quot;
<a name="22409"/>22409:                                                            &quot;~p =&gt; SKIP&quot;,
<a name="22410"/>22410:                                                            [Reason]),
<a name="22411"/>22411:                                                (catch socket:close(DSock)),
<a name="22412"/>22412:                                                (catch socket:close(SSock)),
<a name="22413"/>22413:                                                {skip, Reason};
<a name="22414"/>22414:                                            {error, Reason} = ERROR -&gt;
<a name="22415"/>22415:                                                ?SEV_EPRINT(&quot;Failed &quot;
<a name="22416"/>22416:                                                            &quot;setting ~w:&quot;
<a name="22417"/>22417:                                                            &quot;   ~p&quot;,
<a name="22418"/>22418:                                                            [Opt, Reason]),
<a name="22419"/>22419:                                                throw(ERROR)
<a name="22420"/>22420:                                        end
<a name="22421"/>22421: 			       end,
<a name="22422"/>22422: 			   lists:foreach(E, Opts),
<a name="22423"/>22423: 			   ok
<a name="22424"/>22424:                    end},
<a name="22425"/>22425: 
<a name="22426"/>22426:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="22427"/>22427:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="22428"/>22428: 			 sa_dst   := Dst,
<a name="22429"/>22429: 			 opts     := Opts,
<a name="22430"/>22430: 			 send     := Send}) -&gt;
<a name="22431"/>22431: 			   Hdrs = [{Level, Type, Data} ||
<a name="22432"/>22432: 				      {Level, _, Type, Data} &lt;- 
<a name="22433"/>22433: 					  Opts, (Data =/= default)],
<a name="22434"/>22434:                            Send(Sock, ?BASIC_REQ, Dst, Hdrs)
<a name="22435"/>22435:                    end},
<a name="22436"/>22436:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22437"/>22437:            cmd  =&gt; fun(#{sock_dst := Sock,
<a name="22438"/>22438: 			 sa_src   := Src,
<a name="22439"/>22439: 			 recv     := Recv,
<a name="22440"/>22440: 			 opts     := Opts}) -&gt;
<a name="22441"/>22441:                            case Recv(Sock) of
<a name="22442"/>22442:                                {ok, {Src, CMsgs, ?BASIC_REQ}}
<a name="22443"/>22443:                                  when length(CMsgs) =:= length(Opts)  -&gt;
<a name="22444"/>22444:                                    ?SEV_IPRINT(&quot;Got (expected) cmsg headers: &quot;
<a name="22445"/>22445: 					       &quot;~n   ~p&quot;, [CMsgs]),
<a name="22446"/>22446: 				   %% We should really verify the headers:
<a name="22447"/>22447: 				   %% values, types and so on...
<a name="22448"/>22448:                                    ok;
<a name="22449"/>22449:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22450"/>22450:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22451"/>22451:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22452"/>22452:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22453"/>22453:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22454"/>22454:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22455"/>22455:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22456"/>22456:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22457"/>22457:                                                [Src, BadSrc,
<a name="22458"/>22458:                                                 [{Level, Type} ||
<a name="22459"/>22459:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="22460"/>22460: 						BadCHdrs,
<a name="22461"/>22461: 						?BASIC_REQ, BadReq]),
<a name="22462"/>22462:                                    {error, {unexpected_data, UnexpData}};
<a name="22463"/>22463:                                {ok, UnexpData} -&gt;
<a name="22464"/>22464:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22465"/>22465:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22466"/>22466:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22467"/>22467:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22468"/>22468:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22469"/>22469:                                                [Src,
<a name="22470"/>22470:                                                 [{Level, Type} ||
<a name="22471"/>22471:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="22472"/>22472: 						?BASIC_REQ,
<a name="22473"/>22473:                                                 UnexpData]),
<a name="22474"/>22474:                                    {error, {unexpected_data, UnexpData}};
<a name="22475"/>22475:                                {error, _} = ERROR -&gt;
<a name="22476"/>22476:                                    %% At the moment there is no way to get
<a name="22477"/>22477:                                    %% status or state for the socket...
<a name="22478"/>22478:                                    ERROR
<a name="22479"/>22479:                            end
<a name="22480"/>22480:                    end},
<a name="22481"/>22481: 
<a name="22482"/>22482:          #{desc =&gt; &quot;close src socket&quot;,
<a name="22483"/>22483:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22484"/>22484:                            ok = socket:close(Sock),
<a name="22485"/>22485:                            {ok, maps:remove(sock_src, State)}
<a name="22486"/>22486:                    end},
<a name="22487"/>22487:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="22488"/>22488:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22489"/>22489:                            ok = socket:close(Sock),
<a name="22490"/>22490:                            {ok, maps:remove(sock_dst, State)}
<a name="22491"/>22491:                    end},
<a name="22492"/>22492: 
<a name="22493"/>22493:          %% *** We are done ***
<a name="22494"/>22494:          ?SEV_FINISH_NORMAL
<a name="22495"/>22495:         ],
<a name="22496"/>22496:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_mopts_udp-last_expr"/><a name="22497"/>22497: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22498"/>22498: 
<a name="22499"/>22499: 
<a name="22500"/>22500: 
<a name="22501"/>22501: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22502"/>22502: 
<a name="22503"/>22503: <i>%% Tests that the IPv6 pktinfo control message header is received on</i>
<a name="22504"/>22504: <i>%% incoming datagrams (UDP and RAW) when setting the socket 'ipv6'</i>
<a name="22505"/>22505: <i>%% option recvpktinfo is set to true when using.</i>
<a name="22506"/>22506: <i>%% So, this is done on the receiving side: </i>
<a name="22507"/>22507: <i>%%</i>
<a name="22508"/>22508: <i>%%               socket:setopt(Sock, ipv6, recvpktinfo, boolean()).</i>
<a name="22509"/>22509: <i>%%</i>
<a name="22510"/>22510: <i>%% For all subsequent *received* messages, the pktinfo control message</i>
<a name="22511"/>22511: <i>%% header will be with the message.</i>
<a name="22512"/>22512: <i>%%</i>
<a name="22513"/>22513: <i>%% Only allowed for dgram and raw,</i>
<a name="22514"/>22514: <i>%% although we only test this with dgram.</i>
<a name="22515"/>22515: <i>%%</i>
<a name="22516"/>22516: 
<a name="api_opt_ipv6_recvpktinfo_udp6-1"/><a name="22517"/>22517: <b>api_opt_ipv6_recvpktinfo_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="22518"/>22518:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_recvpktinfo_udp6-last_expr"/><a name="22519"/>22519: <b>    tc_try</b>(api_opt_ipv6_recvpktinfo_udp6,
<a name="22520"/>22520:            fun() -&gt;
<a name="22521"/>22521:                    has_support_ipv6(),
<a name="22522"/>22522:                    has_support_ipv6_recvpktinfo()
<a name="22523"/>22523:            end,
<a name="22524"/>22524:            fun() -&gt;
<a name="22525"/>22525:                    Set  = fun(Sock, Value) -&gt;
<a name="22526"/>22526:                                   socket:setopt(Sock, ipv6, recvpktinfo, Value)
<a name="22527"/>22527:                           end,
<a name="22528"/>22528:                    Get  = fun(Sock) -&gt;
<a name="22529"/>22529:                                   socket:getopt(Sock, ipv6, recvpktinfo)
<a name="22530"/>22530:                           end,
<a name="22531"/>22531:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="22532"/>22532:                                   Msg = #{addr =&gt; Dest,
<a name="22533"/>22533:                                              iov  =&gt; [Data]},
<a name="22534"/>22534:                                   socket:sendmsg(Sock, Msg);
<a name="22535"/>22535:                              (Sock, Data, Dest, Info) -&gt;
<a name="22536"/>22536:                                   %% We do not support this at the moment!!!
<a name="22537"/>22537:                                   CMsg = #{level =&gt; ipv6,
<a name="22538"/>22538:                                               type  =&gt; pktinfo,
<a name="22539"/>22539:                                               data  =&gt; Info},
<a name="22540"/>22540:                                   Msg  = #{addr =&gt; Dest,
<a name="22541"/>22541:                                               ctrl =&gt; [CMsg],
<a name="22542"/>22542:                                               iov  =&gt; [Data]},
<a name="22543"/>22543:                                   socket:sendmsg(Sock, Msg)
<a name="22544"/>22544:                           end,
<a name="22545"/>22545:                    Recv = fun(Sock) -&gt;
<a name="22546"/>22546:                                   case socket:recvmsg(Sock) of
<a name="22547"/>22547:                                       {ok, #{addr := Source,
<a name="22548"/>22548:                                              ctrl := CMsgs,
<a name="22549"/>22549:                                              iov  := [Data]}} -&gt;
<a name="22550"/>22550:                                           {ok, {Source, CMsgs, Data}};
<a name="22551"/>22551:                                       {error, _} = ERROR -&gt;
<a name="22552"/>22552:                                           ERROR
<a name="22553"/>22553:                                   end
<a name="22554"/>22554:                           end,
<a name="22555"/>22555:                    InitState = #{domain =&gt; inet6,
<a name="22556"/>22556:                                  proto  =&gt; udp,
<a name="22557"/>22557:                                  send   =&gt; Send,
<a name="22558"/>22558:                                  recv   =&gt; Recv,
<a name="22559"/>22559:                                  set    =&gt; Set,
<a name="22560"/>22560:                                  get    =&gt; Get},
<a name="22561"/>22561:                    ok = api_opt_ipv6_recvpktinfo_udp(InitState)
<a name="22562"/>22562:            end).
<a name="22563"/>22563: 
<a name="22564"/>22564: 
<a name="22565"/>22565: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22566"/>22566: 
<a name="api_opt_ipv6_recvpktinfo_udp-1"/><a name="22567"/>22567: <b>api_opt_ipv6_recvpktinfo_udp</b>(InitState) -&gt;
<a name="22568"/>22568:     Seq = 
<a name="22569"/>22569:         [
<a name="22570"/>22570:          #{desc =&gt; &quot;local address&quot;,
<a name="22571"/>22571:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="22572"/>22572:                            LSA = which_local_socket_addr(Domain),
<a name="22573"/>22573:                            {ok, State#{lsa_src =&gt; LSA,
<a name="22574"/>22574:                                        lsa_dst =&gt; LSA}}
<a name="22575"/>22575:                    end},
<a name="22576"/>22576: 
<a name="22577"/>22577:          #{desc =&gt; &quot;open src socket&quot;,
<a name="22578"/>22578:            cmd  =&gt; fun(#{domain := Domain,
<a name="22579"/>22579:                          proto  := Proto} = State) -&gt;
<a name="22580"/>22580:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22581"/>22581:                            {ok, State#{sock_src =&gt; Sock}}
<a name="22582"/>22582:                    end},
<a name="22583"/>22583:          #{desc =&gt; &quot;bind src&quot;,
<a name="22584"/>22584:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="22585"/>22585:                            case sock_bind(Sock, LSA) of
<a name="22586"/>22586:                                ok -&gt;
<a name="22587"/>22587:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22588"/>22588:                                    ok;
<a name="22589"/>22589:                                {error, Reason} = ERROR -&gt;
<a name="22590"/>22590:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22591"/>22591:                                    ERROR
<a name="22592"/>22592:                            end
<a name="22593"/>22593:                    end},
<a name="22594"/>22594:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="22595"/>22595:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22596"/>22596:                            SASrc = sock_sockname(Sock),
<a name="22597"/>22597:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="22598"/>22598:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="22599"/>22599:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="22600"/>22600:                    end},
<a name="22601"/>22601: 
<a name="22602"/>22602:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="22603"/>22603:            cmd  =&gt; fun(#{domain := Domain,
<a name="22604"/>22604:                          proto  := Proto} = State) -&gt;
<a name="22605"/>22605:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22606"/>22606:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="22607"/>22607:                    end},
<a name="22608"/>22608:          #{desc =&gt; &quot;bind dst&quot;,
<a name="22609"/>22609:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="22610"/>22610:                            case sock_bind(Sock, LSA) of
<a name="22611"/>22611:                                ok -&gt;
<a name="22612"/>22612:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22613"/>22613:                                    ok;
<a name="22614"/>22614:                                {error, Reason} = ERROR -&gt;
<a name="22615"/>22615:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22616"/>22616:                                    ERROR
<a name="22617"/>22617:                            end
<a name="22618"/>22618:                    end},
<a name="22619"/>22619:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="22620"/>22620:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22621"/>22621:                            SADst = sock_sockname(Sock),
<a name="22622"/>22622:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="22623"/>22623:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="22624"/>22624:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="22625"/>22625:                    end},
<a name="22626"/>22626:          #{desc =&gt; &quot;default pktinfo for dst socket&quot;,
<a name="22627"/>22627:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="22628"/>22628:                            case Get(Sock) of
<a name="22629"/>22629:                                {ok, false = Value} -&gt;
<a name="22630"/>22630:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="22631"/>22631:                                    ok;
<a name="22632"/>22632:                                {ok, Unexpected} -&gt;
<a name="22633"/>22633:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="22634"/>22634:                                                [Unexpected]),
<a name="22635"/>22635:                                    {error, {unexpected, Unexpected}};
<a name="22636"/>22636:                                {error, Reason} = ERROR -&gt;
<a name="22637"/>22637:                                    ?SEV_EPRINT(&quot;Failed getting (default) recvtos:&quot;
<a name="22638"/>22638:                                                &quot;   ~p&quot;, [Reason]),
<a name="22639"/>22639:                                    ERROR
<a name="22640"/>22640:                            end
<a name="22641"/>22641:                    end},
<a name="22642"/>22642: 
<a name="22643"/>22643:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) pktinfo)&quot;,
<a name="22644"/>22644:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22645"/>22645:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="22646"/>22646:                    end},
<a name="22647"/>22647:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22648"/>22648:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22649"/>22649:                            case Recv(Sock) of
<a name="22650"/>22650:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="22651"/>22651:                                    ok;
<a name="22652"/>22652:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22653"/>22653:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22654"/>22654:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22655"/>22655:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22656"/>22656:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22657"/>22657:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22658"/>22658:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22659"/>22659:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22660"/>22660:                                                [Src, BadSrc,
<a name="22661"/>22661:                                                 [], BadCHdrs,
<a name="22662"/>22662:                                                 ?BASIC_REQ, BadReq]),
<a name="22663"/>22663:                                    {error, {unexpected_data, UnexpData}};
<a name="22664"/>22664:                                {ok, UnexpData} -&gt;
<a name="22665"/>22665:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22666"/>22666:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22667"/>22667:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22668"/>22668:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22669"/>22669:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22670"/>22670:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22671"/>22671:                                    {error, {unexpected_data, UnexpData}};
<a name="22672"/>22672:                                {error, _} = ERROR -&gt;
<a name="22673"/>22673:                                    %% At the moment there is no way to get
<a name="22674"/>22674:                                    %% status or state for the socket...
<a name="22675"/>22675:                                    ERROR
<a name="22676"/>22676:                            end
<a name="22677"/>22677:                    end},
<a name="22678"/>22678: 
<a name="22679"/>22679:          #{desc =&gt; &quot;enable pktinfo on dst socket&quot;,
<a name="22680"/>22680:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="22681"/>22681:                            case Set(Sock, true) of
<a name="22682"/>22682:                                ok -&gt;
<a name="22683"/>22683:                                    ?SEV_IPRINT(&quot;dst pktinfo enabled&quot;),
<a name="22684"/>22684:                                    ok;
<a name="22685"/>22685:                                {error, Reason} = ERROR -&gt;
<a name="22686"/>22686:                                    ?SEV_EPRINT(&quot;Failed setting pktinfo:&quot;
<a name="22687"/>22687:                                                &quot;   ~p&quot;, [Reason]),
<a name="22688"/>22688:                                    ERROR
<a name="22689"/>22689:                            end
<a name="22690"/>22690:                    end},
<a name="22691"/>22691: 
<a name="22692"/>22692:          #{desc =&gt; &quot;send req (to dst) (wo explicit pktinfo)&quot;,
<a name="22693"/>22693:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22694"/>22694:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="22695"/>22695:                    end},
<a name="22696"/>22696:          #{desc =&gt; &quot;recv req (from src) - w default pktinfo&quot;,
<a name="22697"/>22697:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22698"/>22698:                            case Recv(Sock) of
<a name="22699"/>22699:                                {ok, {Src, [#{level := ipv6,
<a name="22700"/>22700:                                              type  := pktinfo,
<a name="22701"/>22701:                                              value := #{addr    := Addr,
<a name="22702"/>22702:                                                         ifindex := IfIdx}}],
<a name="22703"/>22703:                                      ?BASIC_REQ}} -&gt;
<a name="22704"/>22704:                                    ?SEV_IPRINT(&quot;Got (default) Pkt Info: &quot;
<a name="22705"/>22705:                                                &quot;~n   Addr:      ~p&quot;
<a name="22706"/>22706:                                                &quot;~n   If Index:  ~p&quot;,
<a name="22707"/>22707:                                                [Addr, IfIdx]),
<a name="22708"/>22708:                                    ok;
<a name="22709"/>22709:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22710"/>22710:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22711"/>22711:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22712"/>22712:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22713"/>22713:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22714"/>22714:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22715"/>22715:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22716"/>22716:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22717"/>22717:                                                [Src, BadSrc,
<a name="22718"/>22718:                                                 #{level =&gt; ipv6,
<a name="22719"/>22719:                                                   type  =&gt; pktinfo,
<a name="22720"/>22720:                                                   value =&gt; &quot;something&quot;} , BadCHdrs,
<a name="22721"/>22721:                                                 ?BASIC_REQ, BadReq]),
<a name="22722"/>22722:                                    {error, {unexpected_data, UnexpData}};
<a name="22723"/>22723:                                {ok, UnexpData} -&gt;
<a name="22724"/>22724:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22725"/>22725:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22726"/>22726:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22727"/>22727:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22728"/>22728:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22729"/>22729:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22730"/>22730:                                    {error, {unexpected_data, UnexpData}};
<a name="22731"/>22731:                                {error, _} = ERROR -&gt;
<a name="22732"/>22732:                                    %% At the moment there is no way to get
<a name="22733"/>22733:                                    %% status or state for the socket...
<a name="22734"/>22734:                                    ERROR
<a name="22735"/>22735:                            end
<a name="22736"/>22736:                    end},
<a name="22737"/>22737: 
<a name="22738"/>22738: 
<a name="22739"/>22739:          #{desc =&gt; &quot;close src socket&quot;,
<a name="22740"/>22740:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22741"/>22741:                            ok = socket:close(Sock),
<a name="22742"/>22742:                            {ok, maps:remove(sock_src, State)}
<a name="22743"/>22743:                    end},
<a name="22744"/>22744:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="22745"/>22745:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22746"/>22746:                            ok = socket:close(Sock),
<a name="22747"/>22747:                            {ok, maps:remove(sock_dst, State)}
<a name="22748"/>22748:                    end},
<a name="22749"/>22749: 
<a name="22750"/>22750:          %% *** We are done ***
<a name="22751"/>22751:          ?SEV_FINISH_NORMAL
<a name="22752"/>22752:         ],
<a name="22753"/>22753:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_recvpktinfo_udp-last_expr"/><a name="22754"/>22754: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22755"/>22755: 
<a name="22756"/>22756: 
<a name="22757"/>22757: 
<a name="22758"/>22758: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22759"/>22759: 
<a name="22760"/>22760: <i>%% Tests that the 'flow info' control message header is received when</i>
<a name="22761"/>22761: <i>%% setting the socket 'ipv6' option flowinfo  is set to true when using</i>
<a name="22762"/>22762: <i>%% sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="22763"/>22763: <i>%% So, this is done on the receiving side: </i>
<a name="22764"/>22764: <i>%%</i>
<a name="22765"/>22765: <i>%%               socket:setopt(Sock, ipv6, flowinfo, boolean()).</i>
<a name="22766"/>22766: <i>%%</i>
<a name="22767"/>22767: <i>%% For all subsequent *received* messages, the 'flow info' control message</i>
<a name="22768"/>22768: <i>%% header will be with the message.</i>
<a name="22769"/>22769: <i>%%</i>
<a name="22770"/>22770: <i>%% Only allowed for dgram and raw,</i>
<a name="22771"/>22771: <i>%% although we only test this with dgram.</i>
<a name="22772"/>22772: <i>%%</i>
<a name="22773"/>22773: <i>%% There seem to be some weirdness with the definition of this</i>
<a name="22774"/>22774: <i>%% option, so its defined in an include file we don't include</i>
<a name="22775"/>22775: <i>%% (directly or indirectly). And since some of the defines</i>
<a name="22776"/>22776: <i>%% occur in a file we *do* include (via netinet/in.h), we</i>
<a name="22777"/>22777: <i>%% leave it as is for now...</i>
<a name="22778"/>22778: <i>%%</i>
<a name="22779"/>22779: 
<a name="api_opt_ipv6_flowinfo_udp6-1"/><a name="22780"/>22780: <b>api_opt_ipv6_flowinfo_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="22781"/>22781:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_flowinfo_udp6-last_expr"/><a name="22782"/>22782: <b>    tc_try</b>(api_opt_ipv6_flowinfo_udp6,
<a name="22783"/>22783:            fun() -&gt;
<a name="22784"/>22784:                    has_support_ipv6(),
<a name="22785"/>22785:                    has_support_ipv6_flowinfo()
<a name="22786"/>22786:            end,
<a name="22787"/>22787:            fun() -&gt;
<a name="22788"/>22788:                    Set  = fun(Sock, Value) -&gt;
<a name="22789"/>22789:                                   socket:setopt(Sock, ipv6, flowinfo, Value)
<a name="22790"/>22790:                           end,
<a name="22791"/>22791:                    Get  = fun(Sock) -&gt;
<a name="22792"/>22792:                                   socket:getopt(Sock, ipv6, flowinfo)
<a name="22793"/>22793:                           end,
<a name="22794"/>22794:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="22795"/>22795:                                   Msg = #{addr =&gt; Dest,
<a name="22796"/>22796:                                              iov  =&gt; [Data]},
<a name="22797"/>22797:                                   socket:sendmsg(Sock, Msg)
<a name="22798"/>22798:                           end,
<a name="22799"/>22799:                    Recv = fun(Sock) -&gt;
<a name="22800"/>22800:                                   case socket:recvmsg(Sock) of
<a name="22801"/>22801:                                       {ok, #{addr := Source,
<a name="22802"/>22802:                                              ctrl := CMsgs,
<a name="22803"/>22803:                                              iov  := [Data]}} -&gt;
<a name="22804"/>22804:                                           {ok, {Source, CMsgs, Data}};
<a name="22805"/>22805:                                       {error, _} = ERROR -&gt;
<a name="22806"/>22806:                                           ERROR
<a name="22807"/>22807:                                   end
<a name="22808"/>22808:                           end,
<a name="22809"/>22809:                    InitState = #{domain =&gt; inet6,
<a name="22810"/>22810:                                  proto  =&gt; udp,
<a name="22811"/>22811:                                  send   =&gt; Send,
<a name="22812"/>22812:                                  recv   =&gt; Recv,
<a name="22813"/>22813:                                  set    =&gt; Set,
<a name="22814"/>22814:                                  get    =&gt; Get},
<a name="22815"/>22815:                    ok = api_opt_ipv6_flowinfo_udp(InitState)
<a name="22816"/>22816:            end).
<a name="22817"/>22817: 
<a name="22818"/>22818: 
<a name="22819"/>22819: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22820"/>22820: 
<a name="api_opt_ipv6_flowinfo_udp-1"/><a name="22821"/>22821: <b>api_opt_ipv6_flowinfo_udp</b>(InitState) -&gt;
<a name="22822"/>22822:     Seq = 
<a name="22823"/>22823:         [
<a name="22824"/>22824:          #{desc =&gt; &quot;local address&quot;,
<a name="22825"/>22825:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="22826"/>22826:                            LSA = which_local_socket_addr(Domain),
<a name="22827"/>22827:                            {ok, State#{lsa_src =&gt; LSA,
<a name="22828"/>22828:                                        lsa_dst =&gt; LSA}}
<a name="22829"/>22829:                    end},
<a name="22830"/>22830: 
<a name="22831"/>22831:          #{desc =&gt; &quot;open src socket&quot;,
<a name="22832"/>22832:            cmd  =&gt; fun(#{domain := Domain,
<a name="22833"/>22833:                          proto  := Proto} = State) -&gt;
<a name="22834"/>22834:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22835"/>22835:                            {ok, State#{sock_src =&gt; Sock}}
<a name="22836"/>22836:                    end},
<a name="22837"/>22837:          #{desc =&gt; &quot;bind src&quot;,
<a name="22838"/>22838:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="22839"/>22839:                            case sock_bind(Sock, LSA) of
<a name="22840"/>22840:                                ok -&gt;
<a name="22841"/>22841:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22842"/>22842:                                    ok;
<a name="22843"/>22843:                                {error, Reason} = ERROR -&gt;
<a name="22844"/>22844:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22845"/>22845:                                    ERROR
<a name="22846"/>22846:                            end
<a name="22847"/>22847:                    end},
<a name="22848"/>22848:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="22849"/>22849:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22850"/>22850:                            SASrc = sock_sockname(Sock),
<a name="22851"/>22851:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="22852"/>22852:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="22853"/>22853:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="22854"/>22854:                    end},
<a name="22855"/>22855: 
<a name="22856"/>22856:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="22857"/>22857:            cmd  =&gt; fun(#{domain := Domain,
<a name="22858"/>22858:                          proto  := Proto} = State) -&gt;
<a name="22859"/>22859:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22860"/>22860:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="22861"/>22861:                    end},
<a name="22862"/>22862:          #{desc =&gt; &quot;bind dst&quot;,
<a name="22863"/>22863:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="22864"/>22864:                            case sock_bind(Sock, LSA) of
<a name="22865"/>22865:                                ok -&gt;
<a name="22866"/>22866:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22867"/>22867:                                    ok;
<a name="22868"/>22868:                                {error, Reason} = ERROR -&gt;
<a name="22869"/>22869:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22870"/>22870:                                    ERROR
<a name="22871"/>22871:                            end
<a name="22872"/>22872:                    end},
<a name="22873"/>22873:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="22874"/>22874:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22875"/>22875:                            SADst = sock_sockname(Sock),
<a name="22876"/>22876:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="22877"/>22877:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="22878"/>22878:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="22879"/>22879:                    end},
<a name="22880"/>22880:          #{desc =&gt; &quot;default flowinfo for dst socket&quot;,
<a name="22881"/>22881:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="22882"/>22882:                            case Get(Sock) of
<a name="22883"/>22883:                                {ok, false = Value} -&gt;
<a name="22884"/>22884:                                    ?SEV_IPRINT(&quot;dst flowinfo: ~p&quot;, [Value]),
<a name="22885"/>22885:                                    ok;
<a name="22886"/>22886:                                {ok, Unexpected} -&gt;
<a name="22887"/>22887:                                    ?SEV_EPRINT(&quot;Unexpected src flowinfo: ~p&quot;,
<a name="22888"/>22888:                                                [Unexpected]),
<a name="22889"/>22889:                                    {error, {unexpected, Unexpected}};
<a name="22890"/>22890:                                {error, Reason} = ERROR -&gt;
<a name="22891"/>22891:                                    ?SEV_EPRINT(&quot;Failed getting (default) flowinfo:&quot;
<a name="22892"/>22892:                                                &quot;   ~p&quot;, [Reason]),
<a name="22893"/>22893:                                    ERROR
<a name="22894"/>22894:                            end
<a name="22895"/>22895:                    end},
<a name="22896"/>22896: 
<a name="22897"/>22897:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="22898"/>22898:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22899"/>22899:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="22900"/>22900:                    end},
<a name="22901"/>22901:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22902"/>22902:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22903"/>22903:                            case Recv(Sock) of
<a name="22904"/>22904:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="22905"/>22905:                                    ok;
<a name="22906"/>22906:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22907"/>22907:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22908"/>22908:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22909"/>22909:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22910"/>22910:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22911"/>22911:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22912"/>22912:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22913"/>22913:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22914"/>22914:                                                [Src, BadSrc,
<a name="22915"/>22915:                                                 [], BadCHdrs,
<a name="22916"/>22916:                                                 ?BASIC_REQ, BadReq]),
<a name="22917"/>22917:                                    {error, {unexpected_data, UnexpData}};
<a name="22918"/>22918:                                {ok, UnexpData} -&gt;
<a name="22919"/>22919:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22920"/>22920:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22921"/>22921:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22922"/>22922:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22923"/>22923:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22924"/>22924:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22925"/>22925:                                    {error, {unexpected_data, UnexpData}};
<a name="22926"/>22926:                                {error, _} = ERROR -&gt;
<a name="22927"/>22927:                                    %% At the moment there is no way to get
<a name="22928"/>22928:                                    %% status or state for the socket...
<a name="22929"/>22929:                                    ERROR
<a name="22930"/>22930:                            end
<a name="22931"/>22931:                    end},
<a name="22932"/>22932: 
<a name="22933"/>22933:          #{desc =&gt; &quot;enable flowinfo on dst socket&quot;,
<a name="22934"/>22934:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="22935"/>22935:                            case Set(Sock, true) of
<a name="22936"/>22936:                                ok -&gt;
<a name="22937"/>22937:                                    ?SEV_IPRINT(&quot;dst flowinfo enabled&quot;),
<a name="22938"/>22938:                                    ok;
<a name="22939"/>22939:                                {error, Reason} = ERROR -&gt;
<a name="22940"/>22940:                                    ?SEV_EPRINT(&quot;Failed setting flowinfo:&quot;
<a name="22941"/>22941:                                                &quot;   ~p&quot;, [Reason]),
<a name="22942"/>22942:                                    ERROR
<a name="22943"/>22943:                            end
<a name="22944"/>22944:                    end},
<a name="22945"/>22945: 
<a name="22946"/>22946:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="22947"/>22947:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22948"/>22948:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="22949"/>22949:                    end},
<a name="22950"/>22950:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22951"/>22951:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22952"/>22952:                            case Recv(Sock) of
<a name="22953"/>22953:                                {ok, {Src, [#{level := ipv6,
<a name="22954"/>22954:                                              type  := flowinfo,
<a name="22955"/>22955:                                              value := FlowID}], ?BASIC_REQ}} -&gt;
<a name="22956"/>22956:                                    ?SEV_IPRINT(&quot;Got flow info: &quot;
<a name="22957"/>22957: 					       &quot;~n   Flow ID: ~p&quot;, [FlowID]),
<a name="22958"/>22958:                                    ok;
<a name="22959"/>22959:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22960"/>22960:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22961"/>22961:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22962"/>22962:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22963"/>22963:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22964"/>22964:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22965"/>22965:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22966"/>22966:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22967"/>22967:                                                [Src, BadSrc,
<a name="22968"/>22968:                                                 #{level =&gt; ipv6,
<a name="22969"/>22969: 						  type  =&gt; flowinfo,
<a name="22970"/>22970: 						  value =&gt; &quot;something&quot;},
<a name="22971"/>22971: 						BadCHdrs,
<a name="22972"/>22972: 						?BASIC_REQ, BadReq]),
<a name="22973"/>22973:                                    {error, {unexpected_data, UnexpData}};
<a name="22974"/>22974:                                {ok, UnexpData} -&gt;
<a name="22975"/>22975:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22976"/>22976:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22977"/>22977:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22978"/>22978:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22979"/>22979:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22980"/>22980:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22981"/>22981:                                    {error, {unexpected_data, UnexpData}};
<a name="22982"/>22982:                                {error, _} = ERROR -&gt;
<a name="22983"/>22983:                                    %% At the moment there is no way to get
<a name="22984"/>22984:                                    %% status or state for the socket...
<a name="22985"/>22985:                                    ERROR
<a name="22986"/>22986:                            end
<a name="22987"/>22987:                    end},
<a name="22988"/>22988: 
<a name="22989"/>22989:          #{desc =&gt; &quot;close src socket&quot;,
<a name="22990"/>22990:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22991"/>22991:                            ok = socket:close(Sock),
<a name="22992"/>22992:                            {ok, maps:remove(sock_src, State)}
<a name="22993"/>22993:                    end},
<a name="22994"/>22994:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="22995"/>22995:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22996"/>22996:                            ok = socket:close(Sock),
<a name="22997"/>22997:                            {ok, maps:remove(sock_dst, State)}
<a name="22998"/>22998:                    end},
<a name="22999"/>22999: 
<a name="23000"/>23000:          %% *** We are done ***
<a name="23001"/>23001:          ?SEV_FINISH_NORMAL
<a name="23002"/>23002:         ],
<a name="23003"/>23003:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_flowinfo_udp-last_expr"/><a name="23004"/>23004: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23005"/>23005: 
<a name="23006"/>23006: 
<a name="23007"/>23007: 
<a name="23008"/>23008: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23009"/>23009: 
<a name="23010"/>23010: <i>%% Tests that the 'hop limit' control message header is received when</i>
<a name="23011"/>23011: <i>%% setting the socket 'ipv6' hoplimit or recvhoplimit option is set to </i>
<a name="23012"/>23012: <i>%% true when using sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="23013"/>23013: <i>%% So, this is done on the receiving side: </i>
<a name="23014"/>23014: <i>%%</i>
<a name="23015"/>23015: <i>%%      socket:setopt(Sock, ipv6, recvhoplimit | hoplimit, boolean()).</i>
<a name="23016"/>23016: <i>%%</i>
<a name="23017"/>23017: <i>%% For all subsequent *received* messages, the 'hop limit' control message</i>
<a name="23018"/>23018: <i>%% header will be with the message.</i>
<a name="23019"/>23019: <i>%% We make the assumption, that if 'recvhoplimit' is supported, then</i>
<a name="23020"/>23020: <i>%% that option is used to order the hoplimit control message, otherwise</i>
<a name="23021"/>23021: <i>%% hoplimit is used.</i>
<a name="23022"/>23022: <i>%%</i>
<a name="23023"/>23023: <i>%% Only allowed for dgram and raw,</i>
<a name="23024"/>23024: <i>%% although we only test this with dgram.</i>
<a name="23025"/>23025: <i>%%</i>
<a name="23026"/>23026: <i>%% &lt;Note&gt;</i>
<a name="23027"/>23027: <i>%%</i>
<a name="23028"/>23028: <i>%% There is also an IPV6_RECVHOPLIMIT option defined in the header</i>
<a name="23029"/>23029: <i>%% file (bits/in.h) with a different value. This is not mentioned</i>
<a name="23030"/>23030: <i>%% in the man page. Deprecated? More testing needed...</i>
<a name="23031"/>23031: <i>%%</i>
<a name="23032"/>23032: <i>%% &lt;/Note&gt;</i>
<a name="23033"/>23033: <i>%%</i>
<a name="23034"/>23034: 
<a name="api_opt_ipv6_hoplimit_udp6-1"/><a name="23035"/>23035: <b>api_opt_ipv6_hoplimit_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23036"/>23036:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_hoplimit_udp6-last_expr"/><a name="23037"/>23037: <b>    tc_try</b>(api_opt_ipv6_hoplimit_udp6,
<a name="23038"/>23038:            fun() -&gt;
<a name="23039"/>23039:                    has_support_ipv6(),
<a name="23040"/>23040:                    has_support_ipv6_hoplimit_or_recvhoplimit(),
<a name="23041"/>23041: 		   is_good_enough_darwin({9,8,0}),
<a name="23042"/>23042:                    is_good_enough_montavista(&quot;4.0.1&quot;)
<a name="23043"/>23043:            end,
<a name="23044"/>23044:            fun() -&gt;
<a name="23045"/>23045: 		   %% Begin by choosing which of the options we shall use
<a name="23046"/>23046: 		   Opt = case socket:is_supported(options, ipv6, recvhoplimit) of
<a name="23047"/>23047: 			     true  -&gt; recvhoplimit;
<a name="23048"/>23048: 			     false -&gt; hoplimit
<a name="23049"/>23049: 			 end,
<a name="23050"/>23050:                    Set  = fun(Sock, Value) -&gt;
<a name="23051"/>23051: 				  ?SEV_IPRINT(&quot;try set ~p: ~p&quot;, [Opt, Value]),
<a name="23052"/>23052:                                   socket:setopt(Sock, ipv6, Opt, Value)
<a name="23053"/>23053:                           end,
<a name="23054"/>23054:                    Get  = fun(Sock) -&gt;
<a name="23055"/>23055: 				  ?SEV_IPRINT(&quot;try get ~p&quot;, [Opt]),
<a name="23056"/>23056:                                   socket:getopt(Sock, ipv6, Opt)
<a name="23057"/>23057:                           end,
<a name="23058"/>23058:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="23059"/>23059:                                   Msg = #{addr =&gt; Dest,
<a name="23060"/>23060:                                              iov  =&gt; [Data]},
<a name="23061"/>23061:                                   socket:sendmsg(Sock, Msg)
<a name="23062"/>23062:                           end,
<a name="23063"/>23063:                    Recv = fun(Sock) -&gt;
<a name="23064"/>23064:                                   case socket:recvmsg(Sock) of
<a name="23065"/>23065:                                       {ok, #{addr := Source,
<a name="23066"/>23066:                                              ctrl := CMsgs,
<a name="23067"/>23067:                                              iov  := [Data]}} -&gt;
<a name="23068"/>23068:                                           {ok, {Source, CMsgs, Data}};
<a name="23069"/>23069:                                       {error, _} = ERROR -&gt;
<a name="23070"/>23070:                                           ERROR
<a name="23071"/>23071:                                   end
<a name="23072"/>23072:                           end,
<a name="23073"/>23073:                    InitState = #{domain =&gt; inet6,
<a name="23074"/>23074:                                  proto  =&gt; udp,
<a name="23075"/>23075:                                  send   =&gt; Send,
<a name="23076"/>23076:                                  recv   =&gt; Recv,
<a name="23077"/>23077:                                  set    =&gt; Set,
<a name="23078"/>23078:                                  get    =&gt; Get},
<a name="23079"/>23079:                    ok = api_opt_ipv6_hoplimit_udp(InitState)
<a name="23080"/>23080:            end).
<a name="23081"/>23081: 
<a name="23082"/>23082: 
<a name="23083"/>23083: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23084"/>23084: 
<a name="api_opt_ipv6_hoplimit_udp-1"/><a name="23085"/>23085: <b>api_opt_ipv6_hoplimit_udp</b>(InitState) -&gt;
<a name="23086"/>23086:     Seq = 
<a name="23087"/>23087:         [
<a name="23088"/>23088:          #{desc =&gt; &quot;local address&quot;,
<a name="23089"/>23089:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23090"/>23090:                            LSA = which_local_socket_addr(Domain),
<a name="23091"/>23091:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23092"/>23092:                                        lsa_dst =&gt; LSA}}
<a name="23093"/>23093:                    end},
<a name="23094"/>23094: 
<a name="23095"/>23095:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23096"/>23096:            cmd  =&gt; fun(#{domain := Domain,
<a name="23097"/>23097:                          proto  := Proto} = State) -&gt;
<a name="23098"/>23098:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23099"/>23099:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23100"/>23100:                    end},
<a name="23101"/>23101:          #{desc =&gt; &quot;bind src&quot;,
<a name="23102"/>23102:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23103"/>23103:                            case sock_bind(Sock, LSA) of
<a name="23104"/>23104:                                ok -&gt;
<a name="23105"/>23105:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23106"/>23106:                                    ok;
<a name="23107"/>23107:                                {error, Reason} = ERROR -&gt;
<a name="23108"/>23108:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23109"/>23109:                                    ERROR
<a name="23110"/>23110:                            end
<a name="23111"/>23111:                    end},
<a name="23112"/>23112:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23113"/>23113:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23114"/>23114:                            SASrc = sock_sockname(Sock),
<a name="23115"/>23115:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23116"/>23116:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23117"/>23117:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23118"/>23118:                    end},
<a name="23119"/>23119: 
<a name="23120"/>23120:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23121"/>23121:            cmd  =&gt; fun(#{domain := Domain,
<a name="23122"/>23122:                          proto  := Proto} = State) -&gt;
<a name="23123"/>23123:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23124"/>23124:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23125"/>23125:                    end},
<a name="23126"/>23126:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23127"/>23127:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23128"/>23128:                            case sock_bind(Sock, LSA) of
<a name="23129"/>23129:                                ok -&gt;
<a name="23130"/>23130:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23131"/>23131:                                    ok;
<a name="23132"/>23132:                                {error, Reason} = ERROR -&gt;
<a name="23133"/>23133:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23134"/>23134:                                    ERROR
<a name="23135"/>23135:                            end
<a name="23136"/>23136:                    end},
<a name="23137"/>23137:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23138"/>23138:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23139"/>23139:                            SADst = sock_sockname(Sock),
<a name="23140"/>23140:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23141"/>23141:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23142"/>23142:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23143"/>23143:                    end},
<a name="23144"/>23144:          #{desc =&gt; &quot;default [recv]hoplimit for dst socket&quot;,
<a name="23145"/>23145:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = State) -&gt;
<a name="23146"/>23146:                            case Get(Sock) of
<a name="23147"/>23147:                                {ok, false = Value} -&gt;
<a name="23148"/>23148:                                    ?SEV_IPRINT(&quot;dst [recv]hoplimit: ~p&quot;,
<a name="23149"/>23149: 					       [Value]),
<a name="23150"/>23150:                                    ok;
<a name="23151"/>23151:                                {ok, Unexpected} -&gt;
<a name="23152"/>23152:                                    ?SEV_EPRINT(&quot;Unexpected src [recv]hoplimit: ~p&quot;,
<a name="23153"/>23153:                                                [Unexpected]),
<a name="23154"/>23154:                                    {error, {unexpected, Unexpected}};
<a name="23155"/>23155:                                {error, enoprotoopt = Reason} -&gt;
<a name="23156"/>23156:                                    %% On some platforms this is not accepted
<a name="23157"/>23157:                                    %% for UDP, so skip this part (UDP).
<a name="23158"/>23158:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="23159"/>23159:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="23160"/>23160:                                    (catch socket:close(Sock)),
<a name="23161"/>23161:                                    (catch socket:close(maps:get_value(sock_src,
<a name="23162"/>23162: 								      State))),
<a name="23163"/>23163:                                    {skip, Reason};
<a name="23164"/>23164:                                {error, Reason} = ERROR -&gt;
<a name="23165"/>23165:                                    ?SEV_EPRINT(&quot;Failed getting (default) hoplimit:&quot;
<a name="23166"/>23166:                                                &quot;   ~p&quot;, [Reason]),
<a name="23167"/>23167:                                    ERROR
<a name="23168"/>23168:                            end
<a name="23169"/>23169:                    end},
<a name="23170"/>23170: 
<a name="23171"/>23171:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23172"/>23172:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23173"/>23173:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="23174"/>23174:                    end},
<a name="23175"/>23175:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23176"/>23176:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23177"/>23177:                            case Recv(Sock) of
<a name="23178"/>23178:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="23179"/>23179:                                    ok;
<a name="23180"/>23180:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23181"/>23181:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23182"/>23182:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23183"/>23183:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23184"/>23184:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23185"/>23185:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23186"/>23186:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23187"/>23187:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23188"/>23188:                                                [Src, BadSrc,
<a name="23189"/>23189:                                                 [], BadCHdrs,
<a name="23190"/>23190:                                                 ?BASIC_REQ, BadReq]),
<a name="23191"/>23191:                                    {error, {unexpected_data, UnexpData}};
<a name="23192"/>23192:                                {ok, UnexpData} -&gt;
<a name="23193"/>23193:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23194"/>23194:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23195"/>23195:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23196"/>23196:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23197"/>23197:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23198"/>23198:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="23199"/>23199:                                    {error, {unexpected_data, UnexpData}};
<a name="23200"/>23200:                                {error, _} = ERROR -&gt;
<a name="23201"/>23201:                                    %% At the moment there is no way to get
<a name="23202"/>23202:                                    %% status or state for the socket...
<a name="23203"/>23203:                                    ERROR
<a name="23204"/>23204:                            end
<a name="23205"/>23205:                    end},
<a name="23206"/>23206: 
<a name="23207"/>23207:          #{desc =&gt; &quot;enable [recv]hoplimit on dst socket&quot;,
<a name="23208"/>23208:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = State) -&gt;
<a name="23209"/>23209:                            case Set(Sock, true) of
<a name="23210"/>23210:                                ok -&gt;
<a name="23211"/>23211:                                    ?SEV_IPRINT(&quot;dst [recv]hoplimit enabled&quot;),
<a name="23212"/>23212:                                    ok;
<a name="23213"/>23213:                                {error, enoprotoopt = Reason} -&gt;
<a name="23214"/>23214:                                    %% On some platforms this is not accepted
<a name="23215"/>23215:                                    %% for UDP, so skip this part (UDP).
<a name="23216"/>23216:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="23217"/>23217:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="23218"/>23218:                                    (catch socket:close(Sock)),
<a name="23219"/>23219:                                    (catch socket:close(maps:get_value(sock_src,
<a name="23220"/>23220: 								      State))),
<a name="23221"/>23221:                                    {skip, Reason};
<a name="23222"/>23222:                                {error, Reason} = ERROR -&gt;
<a name="23223"/>23223:                                    ?SEV_EPRINT(&quot;Failed setting hoplimit:&quot;
<a name="23224"/>23224:                                                &quot;   ~p&quot;, [Reason]),
<a name="23225"/>23225:                                    ERROR
<a name="23226"/>23226:                            end
<a name="23227"/>23227:                    end},
<a name="23228"/>23228: 
<a name="23229"/>23229:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="23230"/>23230:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23231"/>23231:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="23232"/>23232:                    end},
<a name="23233"/>23233:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23234"/>23234:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23235"/>23235:                            case Recv(Sock) of
<a name="23236"/>23236:                                {ok, {Src, [#{level := ipv6,
<a name="23237"/>23237:                                              type  := hoplimit,
<a name="23238"/>23238:                                              value := HL}], ?BASIC_REQ}}
<a name="23239"/>23239:                                  when is_integer(HL) -&gt;
<a name="23240"/>23240:                                    ?SEV_IPRINT(&quot;Got hop limit: &quot;
<a name="23241"/>23241: 					       &quot;~n   Hop Limit: ~p&quot;, [HL]),
<a name="23242"/>23242:                                    ok;
<a name="23243"/>23243:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23244"/>23244:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23245"/>23245:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23246"/>23246:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23247"/>23247:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23248"/>23248:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23249"/>23249:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23250"/>23250:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23251"/>23251:                                                [Src, BadSrc,
<a name="23252"/>23252:                                                 #{level =&gt; ipv6,
<a name="23253"/>23253: 						  type  =&gt; hoplimit,
<a name="23254"/>23254: 						  value =&gt; &quot;something&quot;},
<a name="23255"/>23255: 						BadCHdrs,
<a name="23256"/>23256: 						?BASIC_REQ, BadReq]),
<a name="23257"/>23257:                                    {error, {unexpected_data, UnexpData}};
<a name="23258"/>23258:                                {ok, UnexpData} -&gt;
<a name="23259"/>23259:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23260"/>23260:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23261"/>23261:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23262"/>23262:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23263"/>23263:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23264"/>23264:                                                [Src, #{level =&gt; ipv6,
<a name="23265"/>23265: 						       type  =&gt; hoplimit,
<a name="23266"/>23266: 						       value =&gt; &quot;something&quot;},
<a name="23267"/>23267: 						?BASIC_REQ, UnexpData]),
<a name="23268"/>23268:                                    {error, {unexpected_data, UnexpData}};
<a name="23269"/>23269:                                {error, _} = ERROR -&gt;
<a name="23270"/>23270:                                    %% At the moment there is no way to get
<a name="23271"/>23271:                                    %% status or state for the socket...
<a name="23272"/>23272:                                    ERROR
<a name="23273"/>23273:                            end
<a name="23274"/>23274:                    end},
<a name="23275"/>23275: 
<a name="23276"/>23276:          #{desc =&gt; &quot;close src socket&quot;,
<a name="23277"/>23277:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23278"/>23278:                            ok = socket:close(Sock),
<a name="23279"/>23279:                            {ok, maps:remove(sock_src, State)}
<a name="23280"/>23280:                    end},
<a name="23281"/>23281:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="23282"/>23282:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23283"/>23283:                            ok = socket:close(Sock),
<a name="23284"/>23284:                            {ok, maps:remove(sock_dst, State)}
<a name="23285"/>23285:                    end},
<a name="23286"/>23286: 
<a name="23287"/>23287:          %% *** We are done ***
<a name="23288"/>23288:          ?SEV_FINISH_NORMAL
<a name="23289"/>23289:         ],
<a name="23290"/>23290:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_hoplimit_udp-last_expr"/><a name="23291"/>23291: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23292"/>23292: 
<a name="23293"/>23293: 
<a name="23294"/>23294: 
<a name="23295"/>23295: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23296"/>23296: 
<a name="23297"/>23297: <i>%% Tests that the 'tclass' control message header is received when</i>
<a name="23298"/>23298: <i>%% setting the socket 'ipv6' tclass or recvtclass option is set to </i>
<a name="23299"/>23299: <i>%% true when using sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="23300"/>23300: <i>%% So, this is done on the receiving side: </i>
<a name="23301"/>23301: <i>%%</i>
<a name="23302"/>23302: <i>%%      socket:setopt(Sock, ipv6, recvtclass | tclass, boolean()).</i>
<a name="23303"/>23303: <i>%%</i>
<a name="23304"/>23304: <i>%% For all subsequent *received* messages, the 'tclass' control message</i>
<a name="23305"/>23305: <i>%% header will be with the message.</i>
<a name="23306"/>23306: <i>%% We make the assumption, that if 'recvtclass' is supported, then</i>
<a name="23307"/>23307: <i>%% that option is used to order the tclass control message, otherwise</i>
<a name="23308"/>23308: <i>%% tclass is used.</i>
<a name="23309"/>23309: <i>%%</i>
<a name="23310"/>23310: <i>%% Only allowed for dgram and raw,</i>
<a name="23311"/>23311: <i>%% although we only test this with dgram.</i>
<a name="23312"/>23312: <i>%%</i>
<a name="23313"/>23313: <i>%% &lt;Note&gt;</i>
<a name="23314"/>23314: <i>%%</i>
<a name="23315"/>23315: <i>%% There is also an IPV6_RECVTCLASS option defined in the header</i>
<a name="23316"/>23316: <i>%% file (bits/in.h) with a different value. This is not mentioned</i>
<a name="23317"/>23317: <i>%% in the man page. Deprecated? More testing needed...</i>
<a name="23318"/>23318: <i>%%</i>
<a name="23319"/>23319: <i>%% &lt;/Note&gt;</i>
<a name="23320"/>23320: <i>%%</i>
<a name="23321"/>23321: 
<a name="api_opt_ipv6_tclass_udp6-1"/><a name="23322"/>23322: <b>api_opt_ipv6_tclass_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23323"/>23323:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_tclass_udp6-last_expr"/><a name="23324"/>23324: <b>    tc_try</b>(api_opt_ipv6_tclass_udp6,
<a name="23325"/>23325:            fun() -&gt;
<a name="23326"/>23326:                    has_support_ipv6(),
<a name="23327"/>23327:                    has_support_ipv6_tclass_or_recvtclass()
<a name="23328"/>23328:            end,
<a name="23329"/>23329:            fun() -&gt;
<a name="23330"/>23330: 		   %% Begin by choosing which of the options we shall use
<a name="23331"/>23331: 		   Opt = case socket:is_supported(options, ipv6, recvtclass) of
<a name="23332"/>23332: 			     true  -&gt; recvtclass;
<a name="23333"/>23333: 			     false -&gt; tclass
<a name="23334"/>23334: 			 end,
<a name="23335"/>23335:                    Set  = fun(Sock, Value) -&gt;
<a name="23336"/>23336: 				  ?SEV_IPRINT(&quot;try set ~p: ~p&quot;, [Opt, Value]),
<a name="23337"/>23337:                                   socket:setopt(Sock, ipv6, Opt, Value)
<a name="23338"/>23338:                           end,
<a name="23339"/>23339:                    Get  = fun(Sock) -&gt;
<a name="23340"/>23340: 				  ?SEV_IPRINT(&quot;try get ~p&quot;, [Opt]),
<a name="23341"/>23341:                                   socket:getopt(Sock, ipv6, Opt)
<a name="23342"/>23342:                           end,
<a name="23343"/>23343:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="23344"/>23344:                                   Msg = #{addr =&gt; Dest,
<a name="23345"/>23345:                                              iov  =&gt; [Data]},
<a name="23346"/>23346:                                   socket:sendmsg(Sock, Msg);
<a name="23347"/>23347: 			     (Sock, Data, Dest, TC) -&gt;
<a name="23348"/>23348:                                   TCHdr    = #{level =&gt; ipv6,
<a name="23349"/>23349: 					       type  =&gt; tclass,
<a name="23350"/>23350: 					       data  =&gt; TC},
<a name="23351"/>23351: 				  CMsgs = [TCHdr],
<a name="23352"/>23352:                                   Msg   = #{addr =&gt; Dest,
<a name="23353"/>23353: 					       ctrl =&gt; CMsgs,
<a name="23354"/>23354: 					       iov  =&gt; [Data]},
<a name="23355"/>23355:                                   socket:sendmsg(Sock, Msg)
<a name="23356"/>23356:                           end,
<a name="23357"/>23357:                    Recv = fun(Sock) -&gt;
<a name="23358"/>23358:                                   case socket:recvmsg(Sock) of
<a name="23359"/>23359:                                       {ok, #{addr := Source,
<a name="23360"/>23360:                                              ctrl := CMsgs,
<a name="23361"/>23361:                                              iov  := [Data]}} -&gt;
<a name="23362"/>23362:                                           {ok, {Source, CMsgs, Data}};
<a name="23363"/>23363:                                       {error, _} = ERROR -&gt;
<a name="23364"/>23364:                                           ERROR
<a name="23365"/>23365:                                   end
<a name="23366"/>23366:                           end,
<a name="23367"/>23367:                    InitState = #{domain =&gt; inet6,
<a name="23368"/>23368:                                  proto  =&gt; udp,
<a name="23369"/>23369:                                  send   =&gt; Send,
<a name="23370"/>23370:                                  recv   =&gt; Recv,
<a name="23371"/>23371:                                  set    =&gt; Set,
<a name="23372"/>23372:                                  get    =&gt; Get},
<a name="23373"/>23373:                    ok = api_opt_ipv6_tclass_udp(InitState)
<a name="23374"/>23374:            end).
<a name="23375"/>23375: 
<a name="23376"/>23376: 
<a name="23377"/>23377: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23378"/>23378: 
<a name="api_opt_ipv6_tclass_udp-1"/><a name="23379"/>23379: <b>api_opt_ipv6_tclass_udp</b>(InitState) -&gt;
<a name="23380"/>23380:     Seq = 
<a name="23381"/>23381:         [
<a name="23382"/>23382:          #{desc =&gt; &quot;local address&quot;,
<a name="23383"/>23383:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23384"/>23384:                            LSA = which_local_socket_addr(Domain),
<a name="23385"/>23385:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23386"/>23386:                                        lsa_dst =&gt; LSA}}
<a name="23387"/>23387:                    end},
<a name="23388"/>23388: 
<a name="23389"/>23389:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23390"/>23390:            cmd  =&gt; fun(#{domain := Domain,
<a name="23391"/>23391:                          proto  := Proto} = State) -&gt;
<a name="23392"/>23392:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23393"/>23393:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23394"/>23394:                    end},
<a name="23395"/>23395:          #{desc =&gt; &quot;bind src&quot;,
<a name="23396"/>23396:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23397"/>23397:                            case sock_bind(Sock, LSA) of
<a name="23398"/>23398:                                ok -&gt;
<a name="23399"/>23399:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23400"/>23400:                                    ok;
<a name="23401"/>23401:                                {error, Reason} = ERROR -&gt;
<a name="23402"/>23402:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23403"/>23403:                                    ERROR
<a name="23404"/>23404:                            end
<a name="23405"/>23405:                    end},
<a name="23406"/>23406:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23407"/>23407:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23408"/>23408:                            SASrc = sock_sockname(Sock),
<a name="23409"/>23409:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23410"/>23410:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23411"/>23411:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23412"/>23412:                    end},
<a name="23413"/>23413: 
<a name="23414"/>23414:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23415"/>23415:            cmd  =&gt; fun(#{domain := Domain,
<a name="23416"/>23416:                          proto  := Proto} = State) -&gt;
<a name="23417"/>23417:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23418"/>23418:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23419"/>23419:                    end},
<a name="23420"/>23420:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23421"/>23421:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23422"/>23422:                            case sock_bind(Sock, LSA) of
<a name="23423"/>23423:                                ok -&gt;
<a name="23424"/>23424:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23425"/>23425:                                    ok;
<a name="23426"/>23426:                                {error, Reason} = ERROR -&gt;
<a name="23427"/>23427:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23428"/>23428:                                    ERROR
<a name="23429"/>23429:                            end
<a name="23430"/>23430:                    end},
<a name="23431"/>23431:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23432"/>23432:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23433"/>23433:                            SADst = sock_sockname(Sock),
<a name="23434"/>23434:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23435"/>23435:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23436"/>23436:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23437"/>23437:                    end},
<a name="23438"/>23438:          #{desc =&gt; &quot;default [recv]tclass for dst socket&quot;,
<a name="23439"/>23439:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = State) -&gt;
<a name="23440"/>23440:                            case Get(Sock) of
<a name="23441"/>23441:                                {ok, false = Value} -&gt;
<a name="23442"/>23442:                                    ?SEV_IPRINT(&quot;dst [recv]tclass: ~p&quot;,
<a name="23443"/>23443: 					       [Value]),
<a name="23444"/>23444:                                    ok;
<a name="23445"/>23445:                                {ok, Unexpected} -&gt;
<a name="23446"/>23446:                                    ?SEV_EPRINT(&quot;Unexpected src [recv]tclass: ~p&quot;,
<a name="23447"/>23447:                                                [Unexpected]),
<a name="23448"/>23448:                                    {error, {unexpected, Unexpected}};
<a name="23449"/>23449:                                {error, enoprotoopt = Reason} -&gt;
<a name="23450"/>23450:                                    %% On some platforms this is not accepted
<a name="23451"/>23451:                                    %% for UDP, so skip this part (UDP).
<a name="23452"/>23452:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="23453"/>23453:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="23454"/>23454:                                    (catch socket:close(Sock)),
<a name="23455"/>23455:                                    (catch socket:close(maps:get_value(sock_src,
<a name="23456"/>23456: 								      State))),
<a name="23457"/>23457:                                    {skip, Reason};
<a name="23458"/>23458:                                {error, Reason} = ERROR -&gt;
<a name="23459"/>23459:                                    ?SEV_EPRINT(&quot;Failed getting (default) tclass:&quot;
<a name="23460"/>23460:                                                &quot;   ~p&quot;, [Reason]),
<a name="23461"/>23461:                                    ERROR
<a name="23462"/>23462:                            end
<a name="23463"/>23463:                    end},
<a name="23464"/>23464: 
<a name="23465"/>23465:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23466"/>23466:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23467"/>23467:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="23468"/>23468:                    end},
<a name="23469"/>23469:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23470"/>23470:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23471"/>23471:                            case Recv(Sock) of
<a name="23472"/>23472:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="23473"/>23473:                                    ok;
<a name="23474"/>23474:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23475"/>23475:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23476"/>23476:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23477"/>23477:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23478"/>23478:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23479"/>23479:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23480"/>23480:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23481"/>23481:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23482"/>23482:                                                [Src, BadSrc,
<a name="23483"/>23483:                                                 [], BadCHdrs,
<a name="23484"/>23484:                                                 ?BASIC_REQ, BadReq]),
<a name="23485"/>23485:                                    {error, {unexpected_data, UnexpData}};
<a name="23486"/>23486:                                {ok, UnexpData} -&gt;
<a name="23487"/>23487:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23488"/>23488:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23489"/>23489:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23490"/>23490:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23491"/>23491:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23492"/>23492:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="23493"/>23493:                                    {error, {unexpected_data, UnexpData}};
<a name="23494"/>23494:                                {error, _} = ERROR -&gt;
<a name="23495"/>23495:                                    %% At the moment there is no way to get
<a name="23496"/>23496:                                    %% status or state for the socket...
<a name="23497"/>23497:                                    ERROR
<a name="23498"/>23498:                            end
<a name="23499"/>23499:                    end},
<a name="23500"/>23500: 
<a name="23501"/>23501:          #{desc =&gt; &quot;enable [recv]tclass on dst socket&quot;,
<a name="23502"/>23502:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = State) -&gt;
<a name="23503"/>23503:                            case Set(Sock, true) of
<a name="23504"/>23504:                                ok -&gt;
<a name="23505"/>23505:                                    ?SEV_IPRINT(&quot;dst [recv]tclass enabled&quot;),
<a name="23506"/>23506:                                    ok;
<a name="23507"/>23507:                                {error, enoprotoopt = Reason} -&gt;
<a name="23508"/>23508:                                    %% On some platforms this is not accepted
<a name="23509"/>23509:                                    %% for UDP, so skip this part (UDP).
<a name="23510"/>23510:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="23511"/>23511:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="23512"/>23512:                                    (catch socket:close(Sock)),
<a name="23513"/>23513:                                    (catch socket:close(maps:get_value(sock_src,
<a name="23514"/>23514: 								      State))),
<a name="23515"/>23515:                                    {skip, Reason};
<a name="23516"/>23516:                                {error, Reason} = ERROR -&gt;
<a name="23517"/>23517:                                    ?SEV_EPRINT(&quot;Failed setting tclass:&quot;
<a name="23518"/>23518:                                                &quot;   ~p&quot;, [Reason]),
<a name="23519"/>23519:                                    ERROR
<a name="23520"/>23520:                            end
<a name="23521"/>23521:                    end},
<a name="23522"/>23522: 
<a name="23523"/>23523:          #{desc =&gt; &quot;send req (to dst) (wo explicit tc)&quot;,
<a name="23524"/>23524:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23525"/>23525:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="23526"/>23526:                    end},
<a name="23527"/>23527:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23528"/>23528:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23529"/>23529:                            case Recv(Sock) of
<a name="23530"/>23530:                                {ok, {Src, [#{level := ipv6,
<a name="23531"/>23531:                                              type  := tclass,
<a name="23532"/>23532:                                              value := TClass}], ?BASIC_REQ}}
<a name="23533"/>23533: 			       when is_integer(TClass) -&gt;
<a name="23534"/>23534:                                    ?SEV_IPRINT(&quot;Got tclass: &quot;
<a name="23535"/>23535: 					       &quot;~n   TClass: ~p&quot;, [TClass]),
<a name="23536"/>23536:                                    ok;
<a name="23537"/>23537:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23538"/>23538:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23539"/>23539:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23540"/>23540:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23541"/>23541:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23542"/>23542:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23543"/>23543:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23544"/>23544:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23545"/>23545:                                                [Src, BadSrc,
<a name="23546"/>23546:                                                 #{level =&gt; ipv6,
<a name="23547"/>23547: 						  type  =&gt; tclass,
<a name="23548"/>23548: 						  value =&gt; &quot;something&quot;},
<a name="23549"/>23549: 						BadCHdrs,
<a name="23550"/>23550: 						?BASIC_REQ, BadReq]),
<a name="23551"/>23551:                                    {error, {unexpected_data, UnexpData}};
<a name="23552"/>23552:                                {ok, UnexpData} -&gt;
<a name="23553"/>23553:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23554"/>23554:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23555"/>23555:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23556"/>23556:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23557"/>23557:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23558"/>23558:                                                [Src, #{level =&gt; ipv6,
<a name="23559"/>23559: 						       type  =&gt; tclass,
<a name="23560"/>23560: 						       value =&gt; &quot;something&quot;},
<a name="23561"/>23561: 						?BASIC_REQ, UnexpData]),
<a name="23562"/>23562:                                    {error, {unexpected_data, UnexpData}};
<a name="23563"/>23563:                                {error, _} = ERROR -&gt;
<a name="23564"/>23564:                                    %% At the moment there is no way to get
<a name="23565"/>23565:                                    %% status or state for the socket...
<a name="23566"/>23566:                                    ERROR
<a name="23567"/>23567:                            end
<a name="23568"/>23568:                    end},
<a name="23569"/>23569: 
<a name="23570"/>23570:          #{desc =&gt; &quot;send req (to dst) (w explicit tc = 1)&quot;,
<a name="23571"/>23571:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23572"/>23572:                            case Send(Sock, ?BASIC_REQ, Dst, 1) of
<a name="23573"/>23573:                                {error,
<a name="23574"/>23574:                                 {get_overlapped_result,
<a name="23575"/>23575:                                  #{file     := File,
<a name="23576"/>23576:                                    function := Function,
<a name="23577"/>23577:                                    line     := Line,
<a name="23578"/>23578:                                    raw_info := RawInfo,
<a name="23579"/>23579:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="23580"/>23580:                                    %% IF we can't send it the test will not work
<a name="23581"/>23581:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="23582"/>23582:                                                &quot;~p =&gt; SKIP: &quot;
<a name="23583"/>23583:                                                &quot;~n   File:     ~s&quot;
<a name="23584"/>23584:                                                &quot;~n   Function: ~s&quot;
<a name="23585"/>23585:                                                &quot;~n   Line:     ~p&quot;
<a name="23586"/>23586:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="23587"/>23587:                                                [Info,
<a name="23588"/>23588:                                                 File, Function, Line,
<a name="23589"/>23589:                                                 RawInfo]),
<a name="23590"/>23590:                                    (catch socket:close(Sock)),
<a name="23591"/>23591:                                    {skip,
<a name="23592"/>23592:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="23593"/>23593:                                {error, {get_overlapped_result,
<a name="23594"/>23594:                                         invalid_parameter = Info}} -&gt;
<a name="23595"/>23595:                                    %% IF we can't send it the test will not work
<a name="23596"/>23596:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="23597"/>23597:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="23598"/>23598:                                    (catch socket:close(Sock)),
<a name="23599"/>23599:                                    {skip,
<a name="23600"/>23600:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="23601"/>23601: 
<a name="23602"/>23602:                                {error,
<a name="23603"/>23603:                                 {completion_status,
<a name="23604"/>23604:                                  #{file     := File,
<a name="23605"/>23605:                                    function := Function,
<a name="23606"/>23606:                                    line     := Line,
<a name="23607"/>23607:                                    raw_info := RawInfo,
<a name="23608"/>23608:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="23609"/>23609:                                    %% IF we can't send it the test will not work
<a name="23610"/>23610:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="23611"/>23611:                                                &quot;~p =&gt; SKIP: &quot;
<a name="23612"/>23612:                                                &quot;~n   File:     ~s&quot;
<a name="23613"/>23613:                                                &quot;~n   Function: ~s&quot;
<a name="23614"/>23614:                                                &quot;~n   Line:     ~p&quot;
<a name="23615"/>23615:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="23616"/>23616:                                                [Info,
<a name="23617"/>23617:                                                 File, Function, Line,
<a name="23618"/>23618:                                                 RawInfo]),
<a name="23619"/>23619:                                    (catch socket:close(Sock)),
<a name="23620"/>23620:                                    {skip,
<a name="23621"/>23621:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="23622"/>23622:                                {error, {completion_status,
<a name="23623"/>23623:                                         invalid_parameter = Info}} -&gt;
<a name="23624"/>23624:                                    %% IF we can't send it the test will not work
<a name="23625"/>23625:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="23626"/>23626:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="23627"/>23627:                                    (catch socket:close(Sock)),
<a name="23628"/>23628:                                    {skip,
<a name="23629"/>23629:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="23630"/>23630: 
<a name="23631"/>23631:                                Other -&gt;
<a name="23632"/>23632:                                    Other
<a name="23633"/>23633:                            end
<a name="23634"/>23634:                    end},
<a name="23635"/>23635:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23636"/>23636:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23637"/>23637:                            case Recv(Sock) of
<a name="23638"/>23638:                                {ok, {Src, [#{level := ipv6,
<a name="23639"/>23639:                                              type  := tclass,
<a name="23640"/>23640:                                              value := 1 = TClass}], ?BASIC_REQ}}
<a name="23641"/>23641: 			       when is_integer(TClass) -&gt;
<a name="23642"/>23642:                                    ?SEV_IPRINT(&quot;Got (expected) tclass: &quot;
<a name="23643"/>23643: 					       &quot;~n   TClass: ~p&quot;, [TClass]),
<a name="23644"/>23644:                                    ok;
<a name="23645"/>23645:                                {ok, {_Src, [#{level := ipv6,
<a name="23646"/>23646: 					      type  := tclass,
<a name="23647"/>23647: 					      value := TClass}], ?BASIC_REQ}}
<a name="23648"/>23648: 			       when is_integer(TClass) -&gt;
<a name="23649"/>23649:                                    ?SEV_EPRINT(&quot;Unexpected tclass: &quot;
<a name="23650"/>23650:                                                &quot;~n   Expect TClass: ~p&quot;
<a name="23651"/>23651:                                                &quot;~n   Recv TClass:   ~p&quot;,
<a name="23652"/>23652:                                                [1, TClass]),
<a name="23653"/>23653:                                    {error, {unexpected_tclass, TClass}};
<a name="23654"/>23654:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23655"/>23655:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23656"/>23656:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23657"/>23657:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23658"/>23658:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23659"/>23659:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23660"/>23660:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23661"/>23661:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23662"/>23662:                                                [Src, BadSrc,
<a name="23663"/>23663:                                                 #{level =&gt; ipv6,
<a name="23664"/>23664: 						  type  =&gt; tclass,
<a name="23665"/>23665: 						  value =&gt; &quot;something&quot;},
<a name="23666"/>23666: 						BadCHdrs,
<a name="23667"/>23667: 						?BASIC_REQ, BadReq]),
<a name="23668"/>23668:                                    {error, {unexpected_data, UnexpData}};
<a name="23669"/>23669:                                {ok, UnexpData} -&gt;
<a name="23670"/>23670:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23671"/>23671:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23672"/>23672:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23673"/>23673:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23674"/>23674:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23675"/>23675:                                                [Src, #{level =&gt; ipv6,
<a name="23676"/>23676: 						       type  =&gt; tclass,
<a name="23677"/>23677: 						       value =&gt; &quot;something&quot;},
<a name="23678"/>23678: 						?BASIC_REQ, UnexpData]),
<a name="23679"/>23679:                                    {error, {unexpected_data, UnexpData}};
<a name="23680"/>23680: 
<a name="23681"/>23681:                                 {error, _} = ERROR -&gt;
<a name="23682"/>23682:                                    %% At the moment there is no way to get
<a name="23683"/>23683:                                    %% status or state for the socket...
<a name="23684"/>23684:                                    ERROR
<a name="23685"/>23685:                            end
<a name="23686"/>23686:                    end},
<a name="23687"/>23687: 
<a name="23688"/>23688:          #{desc =&gt; &quot;close src socket&quot;,
<a name="23689"/>23689:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23690"/>23690:                            ok = socket:close(Sock),
<a name="23691"/>23691:                            {ok, maps:remove(sock_src, State)}
<a name="23692"/>23692:                    end},
<a name="23693"/>23693:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="23694"/>23694:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23695"/>23695:                            ok = socket:close(Sock),
<a name="23696"/>23696:                            {ok, maps:remove(sock_dst, State)}
<a name="23697"/>23697:                    end},
<a name="23698"/>23698: 
<a name="23699"/>23699:          %% *** We are done ***
<a name="23700"/>23700:          ?SEV_FINISH_NORMAL
<a name="23701"/>23701:         ],
<a name="23702"/>23702:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_tclass_udp-last_expr"/><a name="23703"/>23703: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23704"/>23704: 
<a name="23705"/>23705: 
<a name="23706"/>23706: 
<a name="23707"/>23707: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23708"/>23708: 
<a name="23709"/>23709: <i>%% This intended to test &quot;all&quot; of the (currently) supported IPv6</i>
<a name="23710"/>23710: <i>%% options that results in control message header(s).</i>
<a name="23711"/>23711: <i>%% So, this is done on the receiving side: </i>
<a name="23712"/>23712: <i>%%</i>
<a name="23713"/>23713: <i>%%      socket:setopt(Sock, ipv6, Flag, boolean()).</i>
<a name="23714"/>23714: <i>%%</i>
<a name="23715"/>23715: <i>%% For all subsequent *received* messages, a control message header</i>
<a name="23716"/>23716: <i>%% for each of the enabled options will be received with the message.</i>
<a name="23717"/>23717: <i>%%</i>
<a name="23718"/>23718: <i>%% Only allowed for dgram and raw,</i>
<a name="23719"/>23719: <i>%% although we only test this with dgram.</i>
<a name="23720"/>23720: <i>%%</i>
<a name="23721"/>23721: <i>%% Currently we *try* to use the following opts:</i>
<a name="23722"/>23722: <i>%%</i>
<a name="23723"/>23723: <i>%%      recvpktinfo | pktinfo   =&gt; pktinfo</i>
<a name="23724"/>23724: <i>%%      flowinfo                =&gt; flowinfo</i>
<a name="23725"/>23725: <i>%%      recvhoplimit | hoplimit =&gt; hoplimit</i>
<a name="23726"/>23726: <i>%%      recvtclass | tclass     =&gt; tclass</i>
<a name="23727"/>23727: <i>%%</i>
<a name="23728"/>23728: <i>%%</i>
<a name="23729"/>23729: <i>%% Every time we add a test case for a new option (that results in</i>
<a name="23730"/>23730: <i>%% a control message hedare), we should also add it here.</i>
<a name="23731"/>23731: <i>%%</i>
<a name="23732"/>23732: <i>%% Even though this is a IPv6 test case, we add the 'socket' timestamp</i>
<a name="23733"/>23733: <i>%% option (just to fill up), but in the test to see if we should run</i>
<a name="23734"/>23734: <i>%% the test (since its a IPv6 test case).</i>
<a name="23735"/>23735: <i>%%</i>
<a name="23736"/>23736: 
<a name="api_opt_ipv6_mopts_udp6-1"/><a name="23737"/>23737: <b>api_opt_ipv6_mopts_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23738"/>23738:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_mopts_udp6-last_expr"/><a name="23739"/>23739: <b>    tc_try</b>(api_opt_ipv6_mopts_udp6,
<a name="23740"/>23740:            fun() -&gt;
<a name="23741"/>23741:                    has_support_ipv6(),
<a name="23742"/>23742:                    Opts =
<a name="23743"/>23743:                        [{ipv6, recvpktinfo},
<a name="23744"/>23744:                         {ipv6, flowinfo},
<a name="23745"/>23745:                         {ipv6, recvhoplimit},
<a name="23746"/>23746:                         {ipv6, hoplimit}] ++
<a name="23747"/>23747:                        case os:type() of
<a name="23748"/>23748:                            {win32, nt} -&gt;
<a name="23749"/>23749:                                [];
<a name="23750"/>23750:                            _ -&gt;
<a name="23751"/>23751:                                [{ipv6, recvtclass},
<a name="23752"/>23752:                                 {ipv6, tclass}]
<a name="23753"/>23753:                        end,
<a name="23754"/>23754: 		   case is_any_options_supported(Opts) of
<a name="23755"/>23755: 		       true -&gt;
<a name="23756"/>23756: 			   ok;
<a name="23757"/>23757: 		       false -&gt;
<a name="23758"/>23758: 			   skip(&quot;None of the needed options are supported&quot;)
<a name="23759"/>23759: 		   end,
<a name="23760"/>23760: 		   %% The problem here is hoplimit on darwin 9.8.0,
<a name="23761"/>23761: 		   %% but I can't be bothered to adjust the test case,
<a name="23762"/>23762: 		   %% just skip on that machine (there is only one)...
<a name="23763"/>23763: 		   is_good_enough_darwin({9,8,0}),
<a name="23764"/>23764:                    is_good_enough_montavista(&quot;4.0.1&quot;)
<a name="23765"/>23765:            end,
<a name="23766"/>23766:            fun() -&gt;
<a name="23767"/>23767: 		   %% If we get this far, we *know* that at least one of the
<a name="23768"/>23768: 		   %% options are available.
<a name="23769"/>23769: 
<a name="23770"/>23770: 		   %% This is list of all the options and there resulting
<a name="23771"/>23771: 		   %% control message header type(s):
<a name="23772"/>23772: 		   %%   [{'ipv6 socket option', 'control message header type'}]
<a name="23773"/>23773: 		   Opts =
<a name="23774"/>23774: 		       case socket:is_supported(options, socket, timestamp) of
<a name="23775"/>23775: 			   true -&gt;
<a name="23776"/>23776: 			       [{socket, timestamp, timestamp, default}];
<a name="23777"/>23777: 			   false -&gt;
<a name="23778"/>23778: 			       []
<a name="23779"/>23779: 		       end ++
<a name="23780"/>23780: 		       case socket:is_supported(options, ipv6, recvpktinfo) of
<a name="23781"/>23781: 			   true -&gt;
<a name="23782"/>23782: 			       [{ipv6, recvpktinfo, pktinfo, default}];
<a name="23783"/>23783: 			   false -&gt;
<a name="23784"/>23784: 			       []
<a name="23785"/>23785: 		       end ++
<a name="23786"/>23786: 		       case socket:is_supported(options, ipv6, flowinfo) of
<a name="23787"/>23787: 			   true -&gt;
<a name="23788"/>23788: 			       [{ipv6, flowinfo, flowinfo, default}];
<a name="23789"/>23789: 			   false -&gt;
<a name="23790"/>23790: 			       []
<a name="23791"/>23791: 		       end ++
<a name="23792"/>23792: 		       case socket:is_supported(options, ipv6, recvhoplimit) of
<a name="23793"/>23793: 			   true -&gt;
<a name="23794"/>23794: 			       [{ipv6, recvhoplimit, hoplimit, default}];
<a name="23795"/>23795: 			   false -&gt;
<a name="23796"/>23796: 			       case socket:is_supported(options, ipv6, hoplimit) of
<a name="23797"/>23797: 				   true -&gt;
<a name="23798"/>23798: 				       [{ipv6, hoplimit, hoplimit, default}];
<a name="23799"/>23799: 				   false -&gt;
<a name="23800"/>23800: 				       []
<a name="23801"/>23801: 			       end
<a name="23802"/>23802: 		       end ++
<a name="23803"/>23803:                        case os:type() of
<a name="23804"/>23804:                            {win32, nt} -&gt;
<a name="23805"/>23805:                                [];
<a name="23806"/>23806:                            _ -&gt;
<a name="23807"/>23807:                                case socket:is_supported(options,
<a name="23808"/>23808:                                                         ipv6, recvtclass) of
<a name="23809"/>23809:                                    true -&gt;
<a name="23810"/>23810:                                        [{ipv6, recvtclass, tclass, 42}];
<a name="23811"/>23811:                                    false -&gt;
<a name="23812"/>23812:                                        case socket:is_supported(options,
<a name="23813"/>23813:                                                                 ipv6, tclass) of
<a name="23814"/>23814:                                            true -&gt;
<a name="23815"/>23815:                                                [{ipv6, tclass, tclass, 42}];
<a name="23816"/>23816:                                            false -&gt;
<a name="23817"/>23817:                                                []
<a name="23818"/>23818:                                        end
<a name="23819"/>23819:                                end
<a name="23820"/>23820: 		       end,
<a name="23821"/>23821: 
<a name="23822"/>23822:                    Enable = fun(Sock, Level, Opt) -&gt;
<a name="23823"/>23823: 				    ?SEV_IPRINT(&quot;try enable [~w] ~p&quot;,
<a name="23824"/>23824:                                                 [Level, Opt]),
<a name="23825"/>23825: 				    socket:setopt(Sock, Level, Opt, true)
<a name="23826"/>23826:                             end,
<a name="23827"/>23827:                    Send = fun(Sock, Data, Dest, []) -&gt;
<a name="23828"/>23828:                                   Msg = #{addr =&gt; Dest,
<a name="23829"/>23829:                                              iov  =&gt; [Data]},
<a name="23830"/>23830:                                   socket:sendmsg(Sock, Msg);
<a name="23831"/>23831: 			     (Sock, Data, Dest, Hdrs) when is_list(Hdrs) -&gt;
<a name="23832"/>23832: 				  CMsgs = [#{level =&gt; Level,
<a name="23833"/>23833:                                              type  =&gt; Type,
<a name="23834"/>23834:                                              data  =&gt; Val} ||
<a name="23835"/>23835:                                               {Level, Type, Val} &lt;- Hdrs],
<a name="23836"/>23836:                                   Msg   = #{addr =&gt; Dest,
<a name="23837"/>23837:                                             ctrl =&gt; CMsgs,
<a name="23838"/>23838:                                             iov  =&gt; [Data]},
<a name="23839"/>23839:                                   socket:sendmsg(Sock, Msg)
<a name="23840"/>23840:                           end,
<a name="23841"/>23841:                    Recv = fun(Sock) -&gt;
<a name="23842"/>23842:                                   case socket:recvmsg(Sock) of
<a name="23843"/>23843:                                       {ok, #{addr := Source,
<a name="23844"/>23844:                                              ctrl := CMsgs,
<a name="23845"/>23845:                                              iov  := [Data]}} -&gt;
<a name="23846"/>23846:                                           {ok, {Source, CMsgs, Data}};
<a name="23847"/>23847:                                       {error, _} = ERROR -&gt;
<a name="23848"/>23848:                                           ERROR
<a name="23849"/>23849:                                   end
<a name="23850"/>23850:                           end,
<a name="23851"/>23851:                    InitState = #{domain =&gt; inet6,
<a name="23852"/>23852:                                  proto  =&gt; udp,
<a name="23853"/>23853: 				 opts   =&gt; Opts,
<a name="23854"/>23854:                                  send   =&gt; Send,
<a name="23855"/>23855:                                  recv   =&gt; Recv,
<a name="23856"/>23856:                                  enable =&gt; Enable},
<a name="23857"/>23857:                    ok = api_opt_ipv6_mopts_udp(InitState)
<a name="23858"/>23858:            end).
<a name="23859"/>23859: 
<a name="23860"/>23860: 
<a name="23861"/>23861: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23862"/>23862: 
<a name="api_opt_ipv6_mopts_udp-1"/><a name="23863"/>23863: <b>api_opt_ipv6_mopts_udp</b>(InitState) -&gt;
<a name="23864"/>23864:     Seq = 
<a name="23865"/>23865:         [
<a name="23866"/>23866:          #{desc =&gt; &quot;local address&quot;,
<a name="23867"/>23867:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23868"/>23868:                            LSA = which_local_socket_addr(Domain),
<a name="23869"/>23869:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23870"/>23870:                                        lsa_dst =&gt; LSA}}
<a name="23871"/>23871:                    end},
<a name="23872"/>23872: 
<a name="23873"/>23873:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23874"/>23874:            cmd  =&gt; fun(#{domain := Domain,
<a name="23875"/>23875:                          proto  := Proto} = State) -&gt;
<a name="23876"/>23876:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23877"/>23877:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23878"/>23878:                    end},
<a name="23879"/>23879:          #{desc =&gt; &quot;bind src&quot;,
<a name="23880"/>23880:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23881"/>23881:                            case sock_bind(Sock, LSA) of
<a name="23882"/>23882:                                ok -&gt;
<a name="23883"/>23883:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23884"/>23884:                                    ok;
<a name="23885"/>23885:                                {error, Reason} = ERROR -&gt;
<a name="23886"/>23886:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23887"/>23887:                                    ERROR
<a name="23888"/>23888:                            end
<a name="23889"/>23889:                    end},
<a name="23890"/>23890:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23891"/>23891:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23892"/>23892:                            SASrc = sock_sockname(Sock),
<a name="23893"/>23893:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23894"/>23894:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23895"/>23895:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23896"/>23896:                    end},
<a name="23897"/>23897: 
<a name="23898"/>23898:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23899"/>23899:            cmd  =&gt; fun(#{domain := Domain,
<a name="23900"/>23900:                          proto  := Proto} = State) -&gt;
<a name="23901"/>23901:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23902"/>23902:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23903"/>23903:                    end},
<a name="23904"/>23904:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23905"/>23905:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23906"/>23906:                            case sock_bind(Sock, LSA) of
<a name="23907"/>23907:                                ok -&gt;
<a name="23908"/>23908:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23909"/>23909:                                    ok;
<a name="23910"/>23910:                                {error, Reason} = ERROR -&gt;
<a name="23911"/>23911:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23912"/>23912:                                    ERROR
<a name="23913"/>23913:                            end
<a name="23914"/>23914:                    end},
<a name="23915"/>23915:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23916"/>23916:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23917"/>23917:                            SADst = sock_sockname(Sock),
<a name="23918"/>23918:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23919"/>23919:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23920"/>23920:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23921"/>23921:                    end},
<a name="23922"/>23922: 
<a name="23923"/>23923:          #{desc =&gt; &quot;enable options on dst socket&quot;,
<a name="23924"/>23924:            cmd  =&gt; fun(#{sock_dst := DSock,
<a name="23925"/>23925: 			 sock_src := SSock,
<a name="23926"/>23926: 			 opts     := Opts,
<a name="23927"/>23927: 			 enable   := Enable} = _State) -&gt;
<a name="23928"/>23928: 			   %% If we fail to enable *any* of the options,
<a name="23929"/>23929: 			   %% we give up.
<a name="23930"/>23930: 			   E = fun({Level, Opt, _, _}) -&gt; 
<a name="23931"/>23931:                                        case Enable(DSock, Level, Opt) of
<a name="23932"/>23932:                                            ok -&gt;
<a name="23933"/>23933:                                                ?SEV_IPRINT(&quot;dst [~w] ~w enabled&quot;,
<a name="23934"/>23934:                                                            [Level, Opt]),
<a name="23935"/>23935:                                                ok;
<a name="23936"/>23936:                                            {error, enoprotoopt = Reason} -&gt;
<a name="23937"/>23937:                                                ?SEV_EPRINT(&quot;Expected &quot;
<a name="23938"/>23938:                                                            &quot;Failure: &quot;
<a name="23939"/>23939:                                                            &quot;~p =&gt; SKIP&quot;,
<a name="23940"/>23940:                                                            [Reason]),
<a name="23941"/>23941:                                                (catch socket:close(DSock)),
<a name="23942"/>23942:                                                (catch socket:close(SSock)),
<a name="23943"/>23943:                                                {skip, Reason};
<a name="23944"/>23944:                                            {error, Reason} = ERROR -&gt;
<a name="23945"/>23945:                                                ?SEV_EPRINT(&quot;Failed &quot;
<a name="23946"/>23946:                                                            &quot;setting ~w:&quot;
<a name="23947"/>23947:                                                            &quot;   ~p&quot;,
<a name="23948"/>23948:                                                            [Opt, Reason]),
<a name="23949"/>23949:                                                throw(ERROR)
<a name="23950"/>23950:                                        end
<a name="23951"/>23951: 			       end,
<a name="23952"/>23952: 			   lists:foreach(E, Opts),
<a name="23953"/>23953: 			   ok
<a name="23954"/>23954:                    end},
<a name="23955"/>23955: 
<a name="23956"/>23956:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23957"/>23957:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="23958"/>23958: 			 sa_dst   := Dst,
<a name="23959"/>23959: 			 opts     := Opts,
<a name="23960"/>23960: 			 send     := Send}) -&gt;
<a name="23961"/>23961: 			   Hdrs = [{Level, Type, Data} ||
<a name="23962"/>23962: 				      {Level, _, Type, Data} &lt;- 
<a name="23963"/>23963: 					  Opts, (Data =/= default)],
<a name="23964"/>23964:                            Send(Sock, ?BASIC_REQ, Dst, Hdrs)
<a name="23965"/>23965:                    end},
<a name="23966"/>23966:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23967"/>23967:            cmd  =&gt; fun(#{sock_dst := Sock,
<a name="23968"/>23968: 			 sa_src   := Src,
<a name="23969"/>23969: 			 recv     := Recv,
<a name="23970"/>23970: 			 opts     := Opts}) -&gt;
<a name="23971"/>23971:                            case Recv(Sock) of
<a name="23972"/>23972:                                {ok, {Src, CMsgs, ?BASIC_REQ}}
<a name="23973"/>23973:                                  when length(CMsgs) =:= length(Opts)  -&gt;
<a name="23974"/>23974:                                    ?SEV_IPRINT(&quot;Got (expected) cmsg headers: &quot;
<a name="23975"/>23975: 					       &quot;~n   ~p&quot;, [CMsgs]),
<a name="23976"/>23976: 				   %% We should really verify the headers:
<a name="23977"/>23977: 				   %% values, types and so on...
<a name="23978"/>23978:                                    ok;
<a name="23979"/>23979:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23980"/>23980:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23981"/>23981:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23982"/>23982:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23983"/>23983:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23984"/>23984:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23985"/>23985:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23986"/>23986:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23987"/>23987:                                                [Src, BadSrc,
<a name="23988"/>23988:                                                 [{Level, Type} ||
<a name="23989"/>23989:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="23990"/>23990: 						BadCHdrs,
<a name="23991"/>23991: 						?BASIC_REQ, BadReq]),
<a name="23992"/>23992:                                    {error, {unexpected_data, UnexpData}};
<a name="23993"/>23993:                                {ok, UnexpData} -&gt;
<a name="23994"/>23994:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23995"/>23995:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23996"/>23996:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23997"/>23997:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23998"/>23998:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23999"/>23999:                                                [Src,
<a name="24000"/>24000:                                                 [{Level, Type} ||
<a name="24001"/>24001:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="24002"/>24002: 						?BASIC_REQ,
<a name="24003"/>24003:                                                 UnexpData]),
<a name="24004"/>24004:                                    {error, {unexpected_data, UnexpData}};
<a name="24005"/>24005:                                {error, _} = ERROR -&gt;
<a name="24006"/>24006:                                    %% At the moment there is no way to get
<a name="24007"/>24007:                                    %% status or state for the socket...
<a name="24008"/>24008:                                    ERROR
<a name="24009"/>24009:                            end
<a name="24010"/>24010:                    end},
<a name="24011"/>24011: 
<a name="24012"/>24012:          #{desc =&gt; &quot;close src socket&quot;,
<a name="24013"/>24013:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="24014"/>24014:                            ok = socket:close(Sock),
<a name="24015"/>24015:                            {ok, maps:remove(sock_src, State)}
<a name="24016"/>24016:                    end},
<a name="24017"/>24017:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="24018"/>24018:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="24019"/>24019:                            ok = socket:close(Sock),
<a name="24020"/>24020:                            {ok, maps:remove(sock_dst, State)}
<a name="24021"/>24021:                    end},
<a name="24022"/>24022: 
<a name="24023"/>24023:          %% *** We are done ***
<a name="24024"/>24024:          ?SEV_FINISH_NORMAL
<a name="24025"/>24025:         ],
<a name="24026"/>24026:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_mopts_udp-last_expr"/><a name="24027"/>24027: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="24028"/>24028: 
<a name="24029"/>24029: 
<a name="24030"/>24030: 
<a name="24031"/>24031: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24032"/>24032: 
<a name="24033"/>24033: <i>%% Tests that the congestion tcp socket option.</i>
<a name="24034"/>24034: <i>%%</i>
<a name="24035"/>24035: <i>%% According to the man page (on linux) for this option it *should* be</i>
<a name="24036"/>24036: <i>%% possible to both get and set *allowed* algorithms. But when we attempt</i>
<a name="24037"/>24037: <i>%% to set, we get 'enoent'.</i>
<a name="24038"/>24038: <i>%% According to /proc/sys/net/ipv4/tcp_allowed_congestion_control that</i>
<a name="24039"/>24039: <i>%% allgorithm was allowed, so...</i>
<a name="24040"/>24040: <i>%% For now, we only test that we can get (it could be a bug in our code)</i>
<a name="24041"/>24041: 
<a name="api_opt_tcp_congestion_tcp4-1"/><a name="24042"/>24042: <b>api_opt_tcp_congestion_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24043"/>24043:     ?TT(?SECS(5)),
<a name="api_opt_tcp_congestion_tcp4-last_expr"/><a name="24044"/>24044: <b>    tc_try</b>(api_opt_tcp_congestion_tcp4,
<a name="24045"/>24045:            fun() -&gt; has_support_ipv4(), has_support_tcp_congestion() end,
<a name="24046"/>24046:            fun() -&gt;
<a name="24047"/>24047:                    Set  = fun(Sock, Value) when is_list(Value) -&gt;
<a name="24048"/>24048:                                   socket:setopt(Sock, tcp, congestion, Value)
<a name="24049"/>24049:                           end,
<a name="24050"/>24050:                    Get  = fun(Sock) -&gt;
<a name="24051"/>24051:                                   socket:getopt(Sock, tcp, congestion)
<a name="24052"/>24052:                           end,
<a name="24053"/>24053:                    InitState = #{domain =&gt; inet,
<a name="24054"/>24054:                                  proto  =&gt; tcp,
<a name="24055"/>24055:                                  set    =&gt; Set,
<a name="24056"/>24056:                                  get    =&gt; Get},
<a name="24057"/>24057:                    ok = api_opt_tcp_congestion_tcp(InitState)
<a name="24058"/>24058:            end).
<a name="24059"/>24059: 
<a name="24060"/>24060: 
<a name="24061"/>24061: 
<a name="24062"/>24062: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24063"/>24063: 
<a name="api_opt_tcp_congestion_tcp-1"/><a name="24064"/>24064: <b>api_opt_tcp_congestion_tcp</b>(InitState) -&gt;
<a name="24065"/>24065:     process_flag(trap_exit, true),
<a name="24066"/>24066:     ServerSeq =
<a name="24067"/>24067:         [
<a name="24068"/>24068:          %% *** Wait for start order ***
<a name="24069"/>24069:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="24070"/>24070:            cmd  =&gt; fun(State) -&gt;
<a name="24071"/>24071:                            Tester = ?SEV_AWAIT_START(),
<a name="24072"/>24072:                            {ok, State#{tester =&gt; Tester}}
<a name="24073"/>24073:                    end},
<a name="24074"/>24074:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="24075"/>24075:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24076"/>24076:                            _MRef = erlang:monitor(process, Tester),
<a name="24077"/>24077:                            ok
<a name="24078"/>24078:                    end},
<a name="24079"/>24079: 
<a name="24080"/>24080:          %% *** Init part ***
<a name="24081"/>24081:          #{desc =&gt; &quot;which local address&quot;,
<a name="24082"/>24082:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24083"/>24083:                            LSA = which_local_socket_addr(Domain),
<a name="24084"/>24084:                            {ok, State#{lsa =&gt; LSA}}
<a name="24085"/>24085:                    end},
<a name="24086"/>24086:          #{desc =&gt; &quot;create socket&quot;,
<a name="24087"/>24087:            cmd  =&gt; fun(#{domain := Domain,
<a name="24088"/>24088:                          proto  := Proto} = State) -&gt;
<a name="24089"/>24089:                            case socket:open(Domain, stream, Proto) of
<a name="24090"/>24090:                                {ok, Sock} -&gt;
<a name="24091"/>24091:                                    {ok, State#{sock =&gt; Sock}};
<a name="24092"/>24092:                                {error, _} = ERROR -&gt;
<a name="24093"/>24093:                                    ERROR
<a name="24094"/>24094:                            end
<a name="24095"/>24095:                    end},
<a name="24096"/>24096:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24097"/>24097:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24098"/>24098:                            case sock_bind(LSock, LSA) of
<a name="24099"/>24099:                                ok -&gt;
<a name="24100"/>24100:                                    Port = sock_port(LSock),
<a name="24101"/>24101:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24102"/>24102:                                    ok;
<a name="24103"/>24103:                                {error, _} = ERROR -&gt;
<a name="24104"/>24104:                                    ERROR
<a name="24105"/>24105:                            end
<a name="24106"/>24106:                    end},
<a name="24107"/>24107:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="24108"/>24108:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24109"/>24109:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="24110"/>24110:                            ok
<a name="24111"/>24111:                    end},
<a name="24112"/>24112: 
<a name="24113"/>24113: 
<a name="24114"/>24114:          %% The actual test
<a name="24115"/>24115:          #{desc =&gt; &quot;await continue (get congestion)&quot;,
<a name="24116"/>24116:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24117"/>24117:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_congestion)
<a name="24118"/>24118:                    end},
<a name="24119"/>24119:          #{desc =&gt; &quot;get congestion&quot;,
<a name="24120"/>24120:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="24121"/>24121:                            case Get(Sock) of
<a name="24122"/>24122:                                {ok, Algorithm} -&gt;
<a name="24123"/>24123:                                    ?SEV_IPRINT(&quot;algorithm: ~s&quot;, [Algorithm]),
<a name="24124"/>24124:                                    {ok, State#{alg =&gt; Algorithm}};
<a name="24125"/>24125:                                {error, _} = ERROR -&gt;
<a name="24126"/>24126:                                    ERROR
<a name="24127"/>24127:                            end
<a name="24128"/>24128:                    end},
<a name="24129"/>24129:          #{desc =&gt; &quot;announce ready (get congestion)&quot;,
<a name="24130"/>24130:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24131"/>24131:                            ?SEV_ANNOUNCE_READY(Tester, get_congestion),
<a name="24132"/>24132:                            ok
<a name="24133"/>24133:                    end},
<a name="24134"/>24134: 
<a name="24135"/>24135: 
<a name="24136"/>24136:          %% *** Termination ***
<a name="24137"/>24137:          #{desc =&gt; &quot;await terminate&quot;,
<a name="24138"/>24138:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="24139"/>24139:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="24140"/>24140:                                ok -&gt;
<a name="24141"/>24141:                                    {ok, maps:remove(tester, State)};
<a name="24142"/>24142:                                {error, _} = ERROR -&gt;
<a name="24143"/>24143:                                    ERROR
<a name="24144"/>24144:                            end
<a name="24145"/>24145:                    end},
<a name="24146"/>24146:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24147"/>24147:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24148"/>24148:                            ok = socket:close(Sock),
<a name="24149"/>24149:                            {ok, maps:remove(sock, State)}
<a name="24150"/>24150:                    end},
<a name="24151"/>24151: 
<a name="24152"/>24152:          %% *** We are done ***
<a name="24153"/>24153:          ?SEV_FINISH_NORMAL
<a name="24154"/>24154:         ],
<a name="24155"/>24155: 
<a name="24156"/>24156: 
<a name="24157"/>24157:     TesterSeq =
<a name="24158"/>24158:         [
<a name="24159"/>24159:          %% *** Init part ***
<a name="24160"/>24160:          #{desc =&gt; &quot;monitor server&quot;,
<a name="24161"/>24161:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24162"/>24162:                            _MRef = erlang:monitor(process, Pid),
<a name="24163"/>24163:                            ok
<a name="24164"/>24164:                    end},
<a name="24165"/>24165: 
<a name="24166"/>24166:          %% Start the server
<a name="24167"/>24167:          #{desc =&gt; &quot;order server start&quot;,
<a name="24168"/>24168:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24169"/>24169:                            ?SEV_ANNOUNCE_START(Pid),
<a name="24170"/>24170:                            ok
<a name="24171"/>24171:                    end},
<a name="24172"/>24172:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="24173"/>24173:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24174"/>24174:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="24175"/>24175:                            ok
<a name="24176"/>24176:                    end},
<a name="24177"/>24177: 
<a name="24178"/>24178:          %% *** The actual test ***
<a name="24179"/>24179:          #{desc =&gt; &quot;order server to continue (with get-congestion)&quot;,
<a name="24180"/>24180:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24181"/>24181:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_congestion),
<a name="24182"/>24182:                            ok
<a name="24183"/>24183:                    end},
<a name="24184"/>24184:          #{desc =&gt; &quot;await server ready (get-congestion)&quot;,
<a name="24185"/>24185:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24186"/>24186:                            ?SEV_AWAIT_READY(Server, server, get_congestion)
<a name="24187"/>24187:                    end},
<a name="24188"/>24188: 
<a name="24189"/>24189: 
<a name="24190"/>24190:          %% *** Termination ***
<a name="24191"/>24191:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="24192"/>24192:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24193"/>24193:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="24194"/>24194:                            ok
<a name="24195"/>24195:                    end},
<a name="24196"/>24196:          #{desc =&gt; &quot;await server termination&quot;,
<a name="24197"/>24197:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="24198"/>24198:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="24199"/>24199:                            State1 = maps:remove(server, State),
<a name="24200"/>24200:                            {ok, State1}
<a name="24201"/>24201:                    end},
<a name="24202"/>24202: 
<a name="24203"/>24203:          %% *** We are done ***
<a name="24204"/>24204:          ?SEV_FINISH_NORMAL
<a name="24205"/>24205:         ],
<a name="24206"/>24206: 
<a name="24207"/>24207: 
<a name="24208"/>24208:     i(&quot;start server evaluator&quot;),
<a name="24209"/>24209:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="24210"/>24210: 
<a name="24211"/>24211:     i(&quot;start tester evaluator&quot;),
<a name="24212"/>24212:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="24213"/>24213:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="24214"/>24214: 
<a name="api_opt_tcp_congestion_tcp-last_expr"/><a name="24215"/>24215: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="24216"/>24216: 
<a name="24217"/>24217: 
<a name="24218"/>24218: 
<a name="24219"/>24219: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24220"/>24220: 
<a name="24221"/>24221: <i>%% Tests that the cork tcp socket option.</i>
<a name="24222"/>24222: <i>%%</i>
<a name="24223"/>24223: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="24224"/>24224: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="24225"/>24225: <i>%%</i>
<a name="24226"/>24226: <i>%% Reading the man page it seems like (on linux) that the</i>
<a name="24227"/>24227: <i>%% value resets itself after some (short) time...</i>
<a name="24228"/>24228: 
<a name="api_opt_tcp_cork_tcp4-1"/><a name="24229"/>24229: <b>api_opt_tcp_cork_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24230"/>24230:     ?TT(?SECS(5)),
<a name="api_opt_tcp_cork_tcp4-last_expr"/><a name="24231"/>24231: <b>    tc_try</b>(api_opt_tcp_cork_tcp4,
<a name="24232"/>24232:            fun() -&gt; has_support_ipv4(), has_support_tcp_cork() end,
<a name="24233"/>24233:            fun() -&gt;
<a name="24234"/>24234:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="24235"/>24235:                                   socket:setopt(Sock, tcp, cork, Value)
<a name="24236"/>24236:                           end,
<a name="24237"/>24237:                    Get  = fun(Sock) -&gt;
<a name="24238"/>24238:                                   socket:getopt(Sock, tcp, cork)
<a name="24239"/>24239:                           end,
<a name="24240"/>24240:                    InitState = #{domain =&gt; inet,
<a name="24241"/>24241:                                  proto  =&gt; tcp,
<a name="24242"/>24242:                                  set    =&gt; Set,
<a name="24243"/>24243:                                  get    =&gt; Get},
<a name="24244"/>24244:                    ok = api_opt_tcp_cork_tcp(InitState)
<a name="24245"/>24245:            end).
<a name="24246"/>24246: 
<a name="24247"/>24247: 
<a name="24248"/>24248: 
<a name="24249"/>24249: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24250"/>24250: 
<a name="api_opt_tcp_cork_tcp-1"/><a name="24251"/>24251: <b>api_opt_tcp_cork_tcp</b>(InitState) -&gt;
<a name="24252"/>24252:     process_flag(trap_exit, true),
<a name="24253"/>24253:     TesterSeq =
<a name="24254"/>24254:         [
<a name="24255"/>24255:          %% *** Init part ***
<a name="24256"/>24256:          #{desc =&gt; &quot;which local address&quot;,
<a name="24257"/>24257:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24258"/>24258:                            LSA = which_local_socket_addr(Domain),
<a name="24259"/>24259:                            {ok, State#{lsa =&gt; LSA}}
<a name="24260"/>24260:                    end},
<a name="24261"/>24261:          #{desc =&gt; &quot;create socket&quot;,
<a name="24262"/>24262:            cmd  =&gt; fun(#{domain := Domain,
<a name="24263"/>24263:                          proto  := Proto} = State) -&gt;
<a name="24264"/>24264:                            case socket:open(Domain, stream, Proto) of
<a name="24265"/>24265:                                {ok, Sock} -&gt;
<a name="24266"/>24266:                                    {ok, State#{sock =&gt; Sock}};
<a name="24267"/>24267:                                {error, _} = ERROR -&gt;
<a name="24268"/>24268:                                    ERROR
<a name="24269"/>24269:                            end
<a name="24270"/>24270:                    end},
<a name="24271"/>24271:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24272"/>24272:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24273"/>24273:                            case sock_bind(LSock, LSA) of
<a name="24274"/>24274:                                ok -&gt;
<a name="24275"/>24275:                                    Port = sock_port(LSock),
<a name="24276"/>24276:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24277"/>24277:                                    ok;
<a name="24278"/>24278:                                {error, _} = ERROR -&gt;
<a name="24279"/>24279:                                    ERROR
<a name="24280"/>24280:                            end
<a name="24281"/>24281:                    end},
<a name="24282"/>24282: 
<a name="24283"/>24283: 
<a name="24284"/>24284:          %% The actual test
<a name="24285"/>24285:          #{desc =&gt; &quot;get (default) cork (= false)&quot;,
<a name="24286"/>24286:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="24287"/>24287:                            case Get(Sock) of
<a name="24288"/>24288:                                {ok, false = Value} -&gt;
<a name="24289"/>24289:                                    ?SEV_IPRINT(&quot;cork default: ~p&quot;, [Value]),
<a name="24290"/>24290:                                    ok;
<a name="24291"/>24291:                                {error, _} = ERROR -&gt;
<a name="24292"/>24292:                                    ERROR
<a name="24293"/>24293:                            end
<a name="24294"/>24294:                    end},
<a name="24295"/>24295:          #{desc =&gt; &quot;enable cork (=&gt; true)&quot;,
<a name="24296"/>24296:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="24297"/>24297:                            case Set(Sock, true) of
<a name="24298"/>24298:                                ok -&gt;
<a name="24299"/>24299:                                    ?SEV_IPRINT(&quot;cork enabled&quot;),
<a name="24300"/>24300:                                    ok;
<a name="24301"/>24301:                                {error, _} = ERROR -&gt;
<a name="24302"/>24302:                                    ERROR
<a name="24303"/>24303:                            end
<a name="24304"/>24304:                    end},
<a name="24305"/>24305:          #{desc =&gt; &quot;get cork (= true)&quot;,
<a name="24306"/>24306:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="24307"/>24307:                            case Get(Sock) of
<a name="24308"/>24308:                                {ok, true = Value} -&gt;
<a name="24309"/>24309:                                    ?SEV_IPRINT(&quot;cork: ~p&quot;, [Value]),
<a name="24310"/>24310:                                    ok;
<a name="24311"/>24311:                                {error, _} = ERROR -&gt;
<a name="24312"/>24312:                                    ERROR
<a name="24313"/>24313:                            end
<a name="24314"/>24314:                    end},
<a name="24315"/>24315: 
<a name="24316"/>24316: 
<a name="24317"/>24317:          %% *** Termination ***
<a name="24318"/>24318:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24319"/>24319:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24320"/>24320:                            ok = socket:close(Sock),
<a name="24321"/>24321:                            {ok, maps:remove(sock, State)}
<a name="24322"/>24322:                    end},
<a name="24323"/>24323: 
<a name="24324"/>24324:          %% *** We are done ***
<a name="24325"/>24325:          ?SEV_FINISH_NORMAL
<a name="24326"/>24326:         ],
<a name="24327"/>24327: 
<a name="24328"/>24328:     i(&quot;start tester evaluator&quot;),
<a name="24329"/>24329:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="24330"/>24330: 
<a name="api_opt_tcp_cork_tcp-last_expr"/><a name="24331"/>24331: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="24332"/>24332: 
<a name="24333"/>24333: 
<a name="24334"/>24334: 
<a name="24335"/>24335: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24336"/>24336: 
<a name="24337"/>24337: <i>%% Tests that the maxseg tcp socket option.</i>
<a name="24338"/>24338: <i>%%</i>
<a name="24339"/>24339: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="24340"/>24340: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="24341"/>24341: <i>%%</i>
<a name="24342"/>24342: <i>%% Note that there is no point in reading this value back,</i>
<a name="24343"/>24343: <i>%% since the kernel imposes its own rules with regard</i>
<a name="24344"/>24344: <i>%% to what is an acceptable value.</i>
<a name="24345"/>24345: <i>%%</i>
<a name="24346"/>24346: 
<a name="api_opt_tcp_maxseg_tcp4-1"/><a name="24347"/>24347: <b>api_opt_tcp_maxseg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24348"/>24348:     ?TT(?SECS(5)),
<a name="api_opt_tcp_maxseg_tcp4-last_expr"/><a name="24349"/>24349: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="24350"/>24350:            fun() -&gt;
<a name="24351"/>24351:                    has_support_ipv4(),
<a name="24352"/>24352:                    has_support_tcp_maxseg()
<a name="24353"/>24353:            end,
<a name="24354"/>24354:            fun() -&gt;
<a name="24355"/>24355:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="24356"/>24356:                                   socket:setopt(Sock, tcp, maxseg, Value)
<a name="24357"/>24357:                           end,
<a name="24358"/>24358:                    Get  = fun(Sock) -&gt;
<a name="24359"/>24359:                                   socket:getopt(Sock, tcp, maxseg)
<a name="24360"/>24360:                           end,
<a name="24361"/>24361:                    InitState = #{domain =&gt; inet,
<a name="24362"/>24362:                                  proto  =&gt; tcp,
<a name="24363"/>24363:                                  set    =&gt; Set,
<a name="24364"/>24364:                                  get    =&gt; Get},
<a name="24365"/>24365:                    ok = api_opt_tcp_maxseg_tcp(InitState)
<a name="24366"/>24366:            end).
<a name="24367"/>24367: 
<a name="24368"/>24368: 
<a name="24369"/>24369: 
<a name="24370"/>24370: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24371"/>24371: 
<a name="api_opt_tcp_maxseg_tcp-1"/><a name="24372"/>24372: <b>api_opt_tcp_maxseg_tcp</b>(InitState) -&gt;
<a name="24373"/>24373:     process_flag(trap_exit, true),
<a name="24374"/>24374:     TesterSeq =
<a name="24375"/>24375:         [
<a name="24376"/>24376:          %% *** Init part ***
<a name="24377"/>24377:          #{desc =&gt; &quot;which local address&quot;,
<a name="24378"/>24378:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24379"/>24379:                            LSA = which_local_socket_addr(Domain),
<a name="24380"/>24380:                            {ok, State#{lsa =&gt; LSA}}
<a name="24381"/>24381:                    end},
<a name="24382"/>24382:          #{desc =&gt; &quot;create socket&quot;,
<a name="24383"/>24383:            cmd  =&gt; fun(#{domain := Domain,
<a name="24384"/>24384:                          proto  := Proto} = State) -&gt;
<a name="24385"/>24385:                            case socket:open(Domain, stream, Proto) of
<a name="24386"/>24386:                                {ok, Sock} -&gt;
<a name="24387"/>24387:                                    {ok, State#{sock =&gt; Sock}};
<a name="24388"/>24388:                                {error, _} = ERROR -&gt;
<a name="24389"/>24389:                                    ERROR
<a name="24390"/>24390:                            end
<a name="24391"/>24391:                    end},
<a name="24392"/>24392:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24393"/>24393:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24394"/>24394:                            case sock_bind(LSock, LSA) of
<a name="24395"/>24395:                                ok -&gt;
<a name="24396"/>24396:                                    Port = sock_port(LSock),
<a name="24397"/>24397:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24398"/>24398:                                    ok;
<a name="24399"/>24399:                                {error, _} = ERROR -&gt;
<a name="24400"/>24400:                                    ERROR
<a name="24401"/>24401:                            end
<a name="24402"/>24402:                    end},
<a name="24403"/>24403: 
<a name="24404"/>24404: 
<a name="24405"/>24405:          %% The actual test
<a name="24406"/>24406:          #{desc =&gt; &quot;get (default) maxseg&quot;,
<a name="24407"/>24407:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="24408"/>24408:                            case Get(Sock) of
<a name="24409"/>24409:                                {ok, DefMaxSeg} -&gt;
<a name="24410"/>24410:                                    ?SEV_IPRINT(&quot;maxseg default: ~p&quot;, [DefMaxSeg]),
<a name="24411"/>24411:                                    {ok, State#{def_maxseg =&gt; DefMaxSeg}};
<a name="24412"/>24412:                                {error, enoprotoopt = Reason} -&gt;
<a name="24413"/>24413:                                    {skip, Reason};
<a name="24414"/>24414:                                {error, _} = ERROR -&gt;
<a name="24415"/>24415:                                    ERROR
<a name="24416"/>24416:                            end
<a name="24417"/>24417:                    end},
<a name="24418"/>24418:          
<a name="24419"/>24419:          %% Note that there is no point in reading this value back,
<a name="24420"/>24420:          %% since the kernel imposes its own rules with regard
<a name="24421"/>24421:          %% to what is an acceptable value.
<a name="24422"/>24422:          %% So, even if the set operation is a success, the value
<a name="24423"/>24423:          %% still might not have changed.
<a name="24424"/>24424:          %%
<a name="24425"/>24425:          %% Note that not all platforms allow this to be set!
<a name="24426"/>24426:          %% Since this is the *last* operation in the test sequence
<a name="24427"/>24427:          %% (before termination) we also accept error reason = einval
<a name="24428"/>24428:          %% as success (rather then skip).
<a name="24429"/>24429:          %% The same goes for the error reason = enoprotoopt (Solaris).
<a name="24430"/>24430:          #{desc =&gt; &quot;(maybe) change maxseg (default + 16)&quot;,
<a name="24431"/>24431:            cmd  =&gt; fun(#{sock       := Sock,
<a name="24432"/>24432:                          set        := Set,
<a name="24433"/>24433:                          def_maxseg := DefMaxSeg} = _State) -&gt;
<a name="24434"/>24434:                            NewMaxSeg = DefMaxSeg + 16,
<a name="24435"/>24435:                            case Set(Sock, NewMaxSeg) of
<a name="24436"/>24436:                                ok -&gt;
<a name="24437"/>24437:                                    ?SEV_IPRINT(&quot;maxseg (maybe) changed (to ~w)&quot;,
<a name="24438"/>24438:                                                [NewMaxSeg]),
<a name="24439"/>24439:                                    ok;
<a name="24440"/>24440:                                {error, Reason} when (Reason =:= einval) orelse
<a name="24441"/>24441:                                                     (Reason =:= enoprotoopt) -&gt;
<a name="24442"/>24442:                                    ?SEV_IPRINT(&quot;change not allowed (~w)&quot;,
<a name="24443"/>24443:                                                [Reason]),
<a name="24444"/>24444:                                    ok;
<a name="24445"/>24445:                                {error, _} = ERROR -&gt;
<a name="24446"/>24446:                                    ERROR
<a name="24447"/>24447:                            end
<a name="24448"/>24448:                    end},
<a name="24449"/>24449: 
<a name="24450"/>24450:          %% *** Termination ***
<a name="24451"/>24451:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24452"/>24452:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24453"/>24453:                            ok = socket:close(Sock),
<a name="24454"/>24454:                            {ok, maps:remove(sock, State)}
<a name="24455"/>24455:                    end},
<a name="24456"/>24456: 
<a name="24457"/>24457:          %% *** We are done ***
<a name="24458"/>24458:          ?SEV_FINISH_NORMAL
<a name="24459"/>24459:         ],
<a name="24460"/>24460: 
<a name="24461"/>24461:     i(&quot;start tester evaluator&quot;),
<a name="24462"/>24462:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="24463"/>24463: 
<a name="api_opt_tcp_maxseg_tcp-last_expr"/><a name="24464"/>24464: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="24465"/>24465: 
<a name="24466"/>24466: 
<a name="24467"/>24467: 
<a name="24468"/>24468: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24469"/>24469: 
<a name="24470"/>24470: <i>%% Tests that the nodelay tcp socket option.</i>
<a name="24471"/>24471: <i>%%</i>
<a name="24472"/>24472: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="24473"/>24473: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="24474"/>24474: 
<a name="api_opt_tcp_nodelay_tcp4-1"/><a name="24475"/>24475: <b>api_opt_tcp_nodelay_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24476"/>24476:     ?TT(?SECS(5)),
<a name="api_opt_tcp_nodelay_tcp4-last_expr"/><a name="24477"/>24477: <b>    tc_try</b>(api_opt_tcp_nodelay_tcp4,
<a name="24478"/>24478:            fun() -&gt; has_support_ipv4(), has_support_tcp_nodelay() end,
<a name="24479"/>24479:            fun() -&gt;
<a name="24480"/>24480:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="24481"/>24481:                                   socket:setopt(Sock, tcp, nodelay, Value)
<a name="24482"/>24482:                           end,
<a name="24483"/>24483:                    Get  = fun(Sock) -&gt;
<a name="24484"/>24484:                                   socket:getopt(Sock, tcp, nodelay)
<a name="24485"/>24485:                           end,
<a name="24486"/>24486:                    InitState = #{domain =&gt; inet,
<a name="24487"/>24487:                                  proto  =&gt; tcp,
<a name="24488"/>24488:                                  set    =&gt; Set,
<a name="24489"/>24489:                                  get    =&gt; Get},
<a name="24490"/>24490:                    ok = api_opt_tcp_nodelay_tcp(InitState)
<a name="24491"/>24491:            end).
<a name="24492"/>24492: 
<a name="24493"/>24493: 
<a name="24494"/>24494: 
<a name="24495"/>24495: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24496"/>24496: 
<a name="api_opt_tcp_nodelay_tcp-1"/><a name="24497"/>24497: <b>api_opt_tcp_nodelay_tcp</b>(InitState) -&gt;
<a name="24498"/>24498:     process_flag(trap_exit, true),
<a name="24499"/>24499:     TesterSeq =
<a name="24500"/>24500:         [
<a name="24501"/>24501:          %% *** Init part ***
<a name="24502"/>24502:          #{desc =&gt; &quot;which local address&quot;,
<a name="24503"/>24503:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24504"/>24504:                            LSA = which_local_socket_addr(Domain),
<a name="24505"/>24505:                            {ok, State#{lsa =&gt; LSA}}
<a name="24506"/>24506:                    end},
<a name="24507"/>24507:          #{desc =&gt; &quot;create socket&quot;,
<a name="24508"/>24508:            cmd  =&gt; fun(#{domain := Domain,
<a name="24509"/>24509:                          proto  := Proto} = State) -&gt;
<a name="24510"/>24510:                            case socket:open(Domain, stream, Proto) of
<a name="24511"/>24511:                                {ok, Sock} -&gt;
<a name="24512"/>24512:                                    {ok, State#{sock =&gt; Sock}};
<a name="24513"/>24513:                                {error, _} = ERROR -&gt;
<a name="24514"/>24514:                                    ERROR
<a name="24515"/>24515:                            end
<a name="24516"/>24516:                    end},
<a name="24517"/>24517:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24518"/>24518:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="24519"/>24519:                            case sock_bind(Sock, LSA) of
<a name="24520"/>24520:                                ok -&gt;
<a name="24521"/>24521:                                    Port = sock_port(Sock),
<a name="24522"/>24522:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24523"/>24523:                                    ok;
<a name="24524"/>24524:                                {error, _} = ERROR -&gt;
<a name="24525"/>24525:                                    ERROR
<a name="24526"/>24526:                            end
<a name="24527"/>24527:                    end},
<a name="24528"/>24528: 
<a name="24529"/>24529: 
<a name="24530"/>24530:          %% The actual test
<a name="24531"/>24531:          #{desc =&gt; &quot;get (default) nodelay (= false)&quot;,
<a name="24532"/>24532:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="24533"/>24533:                            case Get(Sock) of
<a name="24534"/>24534:                                {ok, false = Value} -&gt;
<a name="24535"/>24535:                                    ?SEV_IPRINT(&quot;nodelay default: ~p&quot;, [Value]),
<a name="24536"/>24536:                                    ok;
<a name="24537"/>24537:                                {error, _} = ERROR -&gt;
<a name="24538"/>24538:                                    ERROR
<a name="24539"/>24539:                            end
<a name="24540"/>24540:                    end},
<a name="24541"/>24541:          #{desc =&gt; &quot;enable nodelay (=&gt; true)&quot;,
<a name="24542"/>24542:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="24543"/>24543:                            case Set(Sock, true) of
<a name="24544"/>24544:                                ok -&gt;
<a name="24545"/>24545:                                    ?SEV_IPRINT(&quot;nodelay enabled&quot;),
<a name="24546"/>24546:                                    ok;
<a name="24547"/>24547:                                {error, _} = ERROR -&gt;
<a name="24548"/>24548:                                    ERROR
<a name="24549"/>24549:                            end
<a name="24550"/>24550:                    end},
<a name="24551"/>24551:          #{desc =&gt; &quot;get nodelay (= true)&quot;,
<a name="24552"/>24552:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="24553"/>24553:                            case Get(Sock) of
<a name="24554"/>24554:                                {ok, true = Value} -&gt;
<a name="24555"/>24555:                                    ?SEV_IPRINT(&quot;nodelay: ~p&quot;, [Value]),
<a name="24556"/>24556:                                    ok;
<a name="24557"/>24557:                                {error, _} = ERROR -&gt;
<a name="24558"/>24558:                                    ERROR
<a name="24559"/>24559:                            end
<a name="24560"/>24560:                    end},
<a name="24561"/>24561: 
<a name="24562"/>24562: 
<a name="24563"/>24563:          %% *** Termination ***
<a name="24564"/>24564:          #{desc =&gt; &quot;close socket&quot;,
<a name="24565"/>24565:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24566"/>24566:                            ok = socket:close(Sock),
<a name="24567"/>24567:                            {ok, maps:remove(sock, State)}
<a name="24568"/>24568:                    end},
<a name="24569"/>24569: 
<a name="24570"/>24570:          %% *** We are done ***
<a name="24571"/>24571:          ?SEV_FINISH_NORMAL
<a name="24572"/>24572:         ],
<a name="24573"/>24573: 
<a name="24574"/>24574:     i(&quot;start tester evaluator&quot;),
<a name="24575"/>24575:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="24576"/>24576: 
<a name="api_opt_tcp_nodelay_tcp-last_expr"/><a name="24577"/>24577: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="24578"/>24578: 
<a name="24579"/>24579: 
<a name="24580"/>24580: 
<a name="24581"/>24581: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24582"/>24582: 
<a name="24583"/>24583: <i>%% Tests that the keepcnt tcp socket option.</i>
<a name="24584"/>24584: <i>%%</i>
<a name="24585"/>24585: <i>%% &quot;The maximum number of keepalive probes TCP should send before</i>
<a name="24586"/>24586: <i>%%  dropping the connection&quot;</i>
<a name="24587"/>24587: <i>%%</i>
<a name="24588"/>24588: 
<a name="api_opt_tcp_keepcnt_tcp4-1"/><a name="24589"/>24589: <b>api_opt_tcp_keepcnt_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24590"/>24590:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepcnt_tcp4-last_expr"/><a name="24591"/>24591: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="24592"/>24592:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepcnt() end,
<a name="24593"/>24593:            fun() -&gt;
<a name="24594"/>24594:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="24595"/>24595:                                   socket:setopt(Sock, tcp, keepcnt, Value)
<a name="24596"/>24596:                           end,
<a name="24597"/>24597:                    Get  = fun(Sock) -&gt;
<a name="24598"/>24598:                                   socket:getopt(Sock, tcp, keepcnt)
<a name="24599"/>24599:                           end,
<a name="24600"/>24600:                    InitState = #{domain =&gt; inet,
<a name="24601"/>24601:                                  proto  =&gt; tcp,
<a name="24602"/>24602:                                  set    =&gt; Set,
<a name="24603"/>24603:                                  get    =&gt; Get},
<a name="24604"/>24604:                    ok = api_opt_tcp_keepcnt_tcp(InitState)
<a name="24605"/>24605:            end).
<a name="24606"/>24606: 
<a name="24607"/>24607: 
<a name="24608"/>24608: 
<a name="24609"/>24609: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24610"/>24610: 
<a name="api_opt_tcp_keepcnt_tcp-1"/><a name="24611"/>24611: <b>api_opt_tcp_keepcnt_tcp</b>(InitState) -&gt;
<a name="24612"/>24612:     process_flag(trap_exit, true),
<a name="24613"/>24613:     ServerSeq =
<a name="24614"/>24614:         [
<a name="24615"/>24615:          %% *** Wait for start order ***
<a name="24616"/>24616:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="24617"/>24617:            cmd  =&gt; fun(State) -&gt;
<a name="24618"/>24618:                            Tester = ?SEV_AWAIT_START(),
<a name="24619"/>24619:                            {ok, State#{tester =&gt; Tester}}
<a name="24620"/>24620:                    end},
<a name="24621"/>24621:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="24622"/>24622:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24623"/>24623:                            _MRef = erlang:monitor(process, Tester),
<a name="24624"/>24624:                            ok
<a name="24625"/>24625:                    end},
<a name="24626"/>24626: 
<a name="24627"/>24627:          %% *** Init part ***
<a name="24628"/>24628:          #{desc =&gt; &quot;which local address&quot;,
<a name="24629"/>24629:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24630"/>24630:                            LSA = which_local_socket_addr(Domain),
<a name="24631"/>24631:                            {ok, State#{lsa =&gt; LSA}}
<a name="24632"/>24632:                    end},
<a name="24633"/>24633:          #{desc =&gt; &quot;create socket&quot;,
<a name="24634"/>24634:            cmd  =&gt; fun(#{domain := Domain,
<a name="24635"/>24635:                          proto  := Proto} = State) -&gt;
<a name="24636"/>24636:                            case socket:open(Domain, stream, Proto) of
<a name="24637"/>24637:                                {ok, Sock} -&gt;
<a name="24638"/>24638:                                    {ok, State#{sock =&gt; Sock}};
<a name="24639"/>24639:                                {error, _} = ERROR -&gt;
<a name="24640"/>24640:                                    ERROR
<a name="24641"/>24641:                            end
<a name="24642"/>24642:                    end},
<a name="24643"/>24643:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24644"/>24644:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24645"/>24645:                            case sock_bind(LSock, LSA) of
<a name="24646"/>24646:                                ok -&gt;
<a name="24647"/>24647:                                    Port = sock_port(LSock),
<a name="24648"/>24648:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24649"/>24649:                                    ok;
<a name="24650"/>24650:                                {error, _} = ERROR -&gt;
<a name="24651"/>24651:                                    ERROR
<a name="24652"/>24652:                            end
<a name="24653"/>24653:                    end},
<a name="24654"/>24654:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="24655"/>24655:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24656"/>24656:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="24657"/>24657:                            ok
<a name="24658"/>24658:                    end},
<a name="24659"/>24659: 
<a name="24660"/>24660: 
<a name="24661"/>24661:          %% The actual test
<a name="24662"/>24662:          #{desc =&gt; &quot;await continue (get keepcnt(1))&quot;,
<a name="24663"/>24663:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24664"/>24664:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepcnt)
<a name="24665"/>24665:                    end},
<a name="24666"/>24666:          #{desc =&gt; &quot;get keepcnt&quot;,
<a name="24667"/>24667:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="24668"/>24668:                            case Get(Sock) of
<a name="24669"/>24669:                                {ok, KeepCnt} -&gt;
<a name="24670"/>24670:                                    ?SEV_IPRINT(&quot;keepcnt: ~p&quot;, [KeepCnt]),
<a name="24671"/>24671:                                    {ok, State#{keepcnt =&gt; KeepCnt}};
<a name="24672"/>24672:                                {error, _} = ERROR -&gt;
<a name="24673"/>24673:                                    ERROR
<a name="24674"/>24674:                            end
<a name="24675"/>24675:                    end},
<a name="24676"/>24676:          #{desc =&gt; &quot;announce ready (get keepcnt(1))&quot;,
<a name="24677"/>24677:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24678"/>24678:                            ?SEV_ANNOUNCE_READY(Tester, get_keepcnt),
<a name="24679"/>24679:                            ok
<a name="24680"/>24680:                    end},
<a name="24681"/>24681: 
<a name="24682"/>24682: 
<a name="24683"/>24683:          #{desc =&gt; &quot;await continue (set keepcnt)&quot;,
<a name="24684"/>24684:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24685"/>24685:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepcnt)
<a name="24686"/>24686:                    end},
<a name="24687"/>24687:          #{desc =&gt; &quot;set keepcnt&quot;,
<a name="24688"/>24688:            cmd  =&gt; fun(#{sock    := Sock,
<a name="24689"/>24689:                          set     := Set,
<a name="24690"/>24690:                          keepcnt := KeepCnt} = State) -&gt;
<a name="24691"/>24691:                            NewKeepCnt =
<a name="24692"/>24692:                                if
<a name="24693"/>24693:                                    (KeepCnt &gt;= 255) -&gt;
<a name="24694"/>24694:                                        KeepCnt - 1;
<a name="24695"/>24695:                                    true -&gt;
<a name="24696"/>24696:                                        KeepCnt + 1
<a name="24697"/>24697:                                end,
<a name="24698"/>24698:                            case Set(Sock, NewKeepCnt) of
<a name="24699"/>24699:                                ok -&gt;
<a name="24700"/>24700:                                    ?SEV_IPRINT(&quot;keepcnt updated (to ~p)&quot;,
<a name="24701"/>24701:                                                [NewKeepCnt]),
<a name="24702"/>24702:                                    {ok, State#{keepcnt =&gt; NewKeepCnt}};
<a name="24703"/>24703:                                {error, _} = ERROR -&gt;
<a name="24704"/>24704:                                    ERROR
<a name="24705"/>24705:                            end
<a name="24706"/>24706:                    end},
<a name="24707"/>24707:          #{desc =&gt; &quot;announce ready (set keepcnt)&quot;,
<a name="24708"/>24708:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24709"/>24709:                            ?SEV_ANNOUNCE_READY(Tester, set_keepcnt),
<a name="24710"/>24710:                            ok
<a name="24711"/>24711:                    end},
<a name="24712"/>24712: 
<a name="24713"/>24713: 
<a name="24714"/>24714:          #{desc =&gt; &quot;await continue (get keepcnt(2))&quot;,
<a name="24715"/>24715:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24716"/>24716:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepcnt)
<a name="24717"/>24717:                    end},
<a name="24718"/>24718:          #{desc =&gt; &quot;get keepcnt(2)&quot;,
<a name="24719"/>24719:            cmd  =&gt; fun(#{sock    := Sock,
<a name="24720"/>24720:                          get     := Get,
<a name="24721"/>24721:                          keepcnt := ExpKeepCnt} = _State) -&gt;
<a name="24722"/>24722:                            case Get(Sock) of
<a name="24723"/>24723:                                {ok, KeepCnt} when (ExpKeepCnt =:= KeepCnt) -&gt;
<a name="24724"/>24724:                                    ?SEV_IPRINT(&quot;expected keepcnt (~p)&quot;,
<a name="24725"/>24725:                                                [ExpKeepCnt]),
<a name="24726"/>24726:                                    ok;
<a name="24727"/>24727:                                {ok, KeepCnt} -&gt;
<a name="24728"/>24728:                                    ?SEV_EPRINT(&quot;unexpected keepcnt:&quot;
<a name="24729"/>24729:                                                &quot;~n   Expected KeepCnt: ~p&quot;
<a name="24730"/>24730:                                                &quot;~n   Actual KeepCnt:   ~p&quot;,
<a name="24731"/>24731:                                                [ExpKeepCnt, KeepCnt]),
<a name="24732"/>24732:                                    {error,
<a name="24733"/>24733:                                     {unexpected_keepcnt, ExpKeepCnt, KeepCnt}};
<a name="24734"/>24734:                                {error, Reason} = ERROR -&gt;
<a name="24735"/>24735:                                    ?SEV_EPRINT(&quot;failed get keepcnt: &quot;
<a name="24736"/>24736:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="24737"/>24737:                                    ERROR
<a name="24738"/>24738:                            end
<a name="24739"/>24739:                    end},
<a name="24740"/>24740:          #{desc =&gt; &quot;announce ready (get keepcnt)&quot;,
<a name="24741"/>24741:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24742"/>24742:                            ?SEV_ANNOUNCE_READY(Tester, get_keepcnt),
<a name="24743"/>24743:                            ok
<a name="24744"/>24744:                    end},
<a name="24745"/>24745: 
<a name="24746"/>24746: 
<a name="24747"/>24747:          %% *** Termination ***
<a name="24748"/>24748:          #{desc =&gt; &quot;await terminate&quot;,
<a name="24749"/>24749:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="24750"/>24750:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="24751"/>24751:                                ok -&gt;
<a name="24752"/>24752:                                    {ok, maps:remove(tester, State)};
<a name="24753"/>24753:                                {error, _} = ERROR -&gt;
<a name="24754"/>24754:                                    ERROR
<a name="24755"/>24755:                            end
<a name="24756"/>24756:                    end},
<a name="24757"/>24757:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="24758"/>24758:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="24759"/>24759:                            ok = socket:close(Sock),
<a name="24760"/>24760:                            {ok, maps:remove(sock, State)}
<a name="24761"/>24761:                    end},
<a name="24762"/>24762: 
<a name="24763"/>24763:          %% *** We are done ***
<a name="24764"/>24764:          ?SEV_FINISH_NORMAL
<a name="24765"/>24765:         ],
<a name="24766"/>24766: 
<a name="24767"/>24767: 
<a name="24768"/>24768:     TesterSeq =
<a name="24769"/>24769:         [
<a name="24770"/>24770:          %% *** Init part ***
<a name="24771"/>24771:          #{desc =&gt; &quot;monitor server&quot;,
<a name="24772"/>24772:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24773"/>24773:                            _MRef = erlang:monitor(process, Pid),
<a name="24774"/>24774:                            ok
<a name="24775"/>24775:                    end},
<a name="24776"/>24776: 
<a name="24777"/>24777:          %% Start the server
<a name="24778"/>24778:          #{desc =&gt; &quot;order server start&quot;,
<a name="24779"/>24779:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24780"/>24780:                            ?SEV_ANNOUNCE_START(Pid),
<a name="24781"/>24781:                            ok
<a name="24782"/>24782:                    end},
<a name="24783"/>24783:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="24784"/>24784:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="24785"/>24785:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="24786"/>24786:                            ok
<a name="24787"/>24787:                    end},
<a name="24788"/>24788: 
<a name="24789"/>24789:          %% *** The actual test ***
<a name="24790"/>24790:          #{desc =&gt; &quot;order server to continue (with get-keepcnt(1))&quot;,
<a name="24791"/>24791:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24792"/>24792:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepcnt),
<a name="24793"/>24793:                            ok
<a name="24794"/>24794:                    end},
<a name="24795"/>24795:          #{desc =&gt; &quot;await server ready (get-keepcnt(1))&quot;,
<a name="24796"/>24796:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24797"/>24797:                            ?SEV_AWAIT_READY(Server, server, get_keepcnt)
<a name="24798"/>24798:                    end},
<a name="24799"/>24799: 
<a name="24800"/>24800:          #{desc =&gt; &quot;order server to continue (with set-keepcnt)&quot;,
<a name="24801"/>24801:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24802"/>24802:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepcnt),
<a name="24803"/>24803:                            ok
<a name="24804"/>24804:                    end},
<a name="24805"/>24805:          #{desc =&gt; &quot;await server ready (set-keepcnt)&quot;,
<a name="24806"/>24806:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24807"/>24807:                            ?SEV_AWAIT_READY(Server, server, set_keepcnt)
<a name="24808"/>24808:                    end},
<a name="24809"/>24809: 
<a name="24810"/>24810:          #{desc =&gt; &quot;order server to continue (with get-keepcnt(2))&quot;,
<a name="24811"/>24811:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24812"/>24812:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepcnt),
<a name="24813"/>24813:                            ok
<a name="24814"/>24814:                    end},
<a name="24815"/>24815:          #{desc =&gt; &quot;await server ready (get-keepcnt(2))&quot;,
<a name="24816"/>24816:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24817"/>24817:                            ?SEV_AWAIT_READY(Server, server, get_keepcnt)
<a name="24818"/>24818:                    end},
<a name="24819"/>24819: 
<a name="24820"/>24820: 
<a name="24821"/>24821:          %% *** Termination ***
<a name="24822"/>24822:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="24823"/>24823:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="24824"/>24824:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="24825"/>24825:                            ok
<a name="24826"/>24826:                    end},
<a name="24827"/>24827:          #{desc =&gt; &quot;await server termination&quot;,
<a name="24828"/>24828:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="24829"/>24829:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="24830"/>24830:                            State1 = maps:remove(server, State),
<a name="24831"/>24831:                            {ok, State1}
<a name="24832"/>24832:                    end},
<a name="24833"/>24833: 
<a name="24834"/>24834:          %% *** We are done ***
<a name="24835"/>24835:          ?SEV_FINISH_NORMAL
<a name="24836"/>24836:         ],
<a name="24837"/>24837: 
<a name="24838"/>24838: 
<a name="24839"/>24839:     i(&quot;start server evaluator&quot;),
<a name="24840"/>24840:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="24841"/>24841: 
<a name="24842"/>24842:     i(&quot;start tester evaluator&quot;),
<a name="24843"/>24843:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="24844"/>24844:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="24845"/>24845: 
<a name="api_opt_tcp_keepcnt_tcp-last_expr"/><a name="24846"/>24846: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="24847"/>24847: 
<a name="24848"/>24848: 
<a name="24849"/>24849: 
<a name="24850"/>24850: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24851"/>24851: 
<a name="24852"/>24852: <i>%% Tests that the keepidle tcp socket option.</i>
<a name="24853"/>24853: <i>%%</i>
<a name="24854"/>24854: <i>%% &quot;Gets or sets the number of seconds a TCP connection will remain</i>
<a name="24855"/>24855: <i>%%  idle before keepalive probes are sent to the remote.&quot;</i>
<a name="24856"/>24856: <i>%%</i>
<a name="24857"/>24857: 
<a name="api_opt_tcp_keepidle_tcp4-1"/><a name="24858"/>24858: <b>api_opt_tcp_keepidle_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24859"/>24859:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepidle_tcp4-last_expr"/><a name="24860"/>24860: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="24861"/>24861:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepidle() end,
<a name="24862"/>24862:            fun() -&gt;
<a name="24863"/>24863:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="24864"/>24864:                                   socket:setopt(Sock, tcp, keepidle, Value)
<a name="24865"/>24865:                           end,
<a name="24866"/>24866:                    Get  = fun(Sock) -&gt;
<a name="24867"/>24867:                                   socket:getopt(Sock, tcp, keepidle)
<a name="24868"/>24868:                           end,
<a name="24869"/>24869:                    InitState = #{domain =&gt; inet,
<a name="24870"/>24870:                                  proto  =&gt; tcp,
<a name="24871"/>24871:                                  set    =&gt; Set,
<a name="24872"/>24872:                                  get    =&gt; Get},
<a name="24873"/>24873:                    ok = api_opt_tcp_keepidle_tcp(InitState)
<a name="24874"/>24874:            end).
<a name="24875"/>24875: 
<a name="24876"/>24876: 
<a name="24877"/>24877: 
<a name="24878"/>24878: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24879"/>24879: 
<a name="api_opt_tcp_keepidle_tcp-1"/><a name="24880"/>24880: <b>api_opt_tcp_keepidle_tcp</b>(InitState) -&gt;
<a name="24881"/>24881:     process_flag(trap_exit, true),
<a name="24882"/>24882:     ServerSeq =
<a name="24883"/>24883:         [
<a name="24884"/>24884:          %% *** Wait for start order ***
<a name="24885"/>24885:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="24886"/>24886:            cmd  =&gt; fun(State) -&gt;
<a name="24887"/>24887:                            Tester = ?SEV_AWAIT_START(),
<a name="24888"/>24888:                            {ok, State#{tester =&gt; Tester}}
<a name="24889"/>24889:                    end},
<a name="24890"/>24890:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="24891"/>24891:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24892"/>24892:                            _MRef = erlang:monitor(process, Tester),
<a name="24893"/>24893:                            ok
<a name="24894"/>24894:                    end},
<a name="24895"/>24895: 
<a name="24896"/>24896:          %% *** Init part ***
<a name="24897"/>24897:          #{desc =&gt; &quot;which local address&quot;,
<a name="24898"/>24898:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24899"/>24899:                            LSA = which_local_socket_addr(Domain),
<a name="24900"/>24900:                            {ok, State#{lsa =&gt; LSA}}
<a name="24901"/>24901:                    end},
<a name="24902"/>24902:          #{desc =&gt; &quot;create socket&quot;,
<a name="24903"/>24903:            cmd  =&gt; fun(#{domain := Domain,
<a name="24904"/>24904:                          proto  := Proto} = State) -&gt;
<a name="24905"/>24905:                            case socket:open(Domain, stream, Proto) of
<a name="24906"/>24906:                                {ok, Sock} -&gt;
<a name="24907"/>24907:                                    {ok, State#{sock =&gt; Sock}};
<a name="24908"/>24908:                                {error, _} = ERROR -&gt;
<a name="24909"/>24909:                                    ERROR
<a name="24910"/>24910:                            end
<a name="24911"/>24911:                    end},
<a name="24912"/>24912:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="24913"/>24913:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="24914"/>24914:                            case sock_bind(LSock, LSA) of
<a name="24915"/>24915:                                ok -&gt;
<a name="24916"/>24916:                                    Port = sock_port(LSock),
<a name="24917"/>24917:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="24918"/>24918:                                    ok;
<a name="24919"/>24919:                                {error, _} = ERROR -&gt;
<a name="24920"/>24920:                                    ERROR
<a name="24921"/>24921:                            end
<a name="24922"/>24922:                    end},
<a name="24923"/>24923:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="24924"/>24924:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24925"/>24925:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="24926"/>24926:                            ok
<a name="24927"/>24927:                    end},
<a name="24928"/>24928: 
<a name="24929"/>24929: 
<a name="24930"/>24930:          %% The actual test
<a name="24931"/>24931:          #{desc =&gt; &quot;await continue (get keepidle(1))&quot;,
<a name="24932"/>24932:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24933"/>24933:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepidle)
<a name="24934"/>24934:                    end},
<a name="24935"/>24935:          #{desc =&gt; &quot;get keepidle&quot;,
<a name="24936"/>24936:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="24937"/>24937:                            case Get(Sock) of
<a name="24938"/>24938:                                {ok, KeepIdle} -&gt;
<a name="24939"/>24939:                                    ?SEV_IPRINT(&quot;keepidle: ~p&quot;, [KeepIdle]),
<a name="24940"/>24940:                                    {ok, State#{keepidle =&gt; KeepIdle}};
<a name="24941"/>24941:                                {error, _} = ERROR -&gt;
<a name="24942"/>24942:                                    ERROR
<a name="24943"/>24943:                            end
<a name="24944"/>24944:                    end},
<a name="24945"/>24945:          #{desc =&gt; &quot;announce ready (get keepidle(1))&quot;,
<a name="24946"/>24946:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24947"/>24947:                            ?SEV_ANNOUNCE_READY(Tester, get_keepidle),
<a name="24948"/>24948:                            ok
<a name="24949"/>24949:                    end},
<a name="24950"/>24950: 
<a name="24951"/>24951: 
<a name="24952"/>24952:          #{desc =&gt; &quot;await continue (set keepidle)&quot;,
<a name="24953"/>24953:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24954"/>24954:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepidle)
<a name="24955"/>24955:                    end},
<a name="24956"/>24956:          #{desc =&gt; &quot;set keepidle&quot;,
<a name="24957"/>24957:            cmd  =&gt; fun(#{sock     := Sock,
<a name="24958"/>24958:                          set      := Set,
<a name="24959"/>24959:                          keepidle := KeepIdle} = State) -&gt;
<a name="24960"/>24960:                            NewKeepIdle = KeepIdle + 1,
<a name="24961"/>24961:                            case Set(Sock, NewKeepIdle) of
<a name="24962"/>24962:                                ok -&gt;
<a name="24963"/>24963:                                    ?SEV_IPRINT(&quot;keepidle updated (to ~p)&quot;,
<a name="24964"/>24964:                                                [NewKeepIdle]),
<a name="24965"/>24965:                                    {ok, State#{keepidle =&gt; NewKeepIdle}};
<a name="24966"/>24966:                                {error, _} = ERROR -&gt;
<a name="24967"/>24967:                                    ERROR
<a name="24968"/>24968:                            end
<a name="24969"/>24969:                    end},
<a name="24970"/>24970:          #{desc =&gt; &quot;announce ready (set keepidle)&quot;,
<a name="24971"/>24971:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24972"/>24972:                            ?SEV_ANNOUNCE_READY(Tester, set_keepidle),
<a name="24973"/>24973:                            ok
<a name="24974"/>24974:                    end},
<a name="24975"/>24975: 
<a name="24976"/>24976: 
<a name="24977"/>24977:          #{desc =&gt; &quot;await continue (get keepidle(2))&quot;,
<a name="24978"/>24978:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24979"/>24979:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepidle)
<a name="24980"/>24980:                    end},
<a name="24981"/>24981:          #{desc =&gt; &quot;get keepidle(2)&quot;,
<a name="24982"/>24982:            cmd  =&gt; fun(#{sock     := Sock,
<a name="24983"/>24983:                          get      := Get,
<a name="24984"/>24984:                          keepidle := ExpKeepIdle} = _State) -&gt;
<a name="24985"/>24985:                            case Get(Sock) of
<a name="24986"/>24986:                                {ok, KeepIdle} when (ExpKeepIdle =:= KeepIdle) -&gt;
<a name="24987"/>24987:                                    ?SEV_IPRINT(&quot;expected keepidle (~p)&quot;,
<a name="24988"/>24988:                                                [ExpKeepIdle]),
<a name="24989"/>24989:                                    ok;
<a name="24990"/>24990:                                {ok, KeepIdle} -&gt;
<a name="24991"/>24991:                                    ?SEV_EPRINT(&quot;unexpected keepidle:&quot;
<a name="24992"/>24992:                                                &quot;~n   Expected KeepIdle: ~p&quot;
<a name="24993"/>24993:                                                &quot;~n   Actual KeepIdle:   ~p&quot;,
<a name="24994"/>24994:                                                [ExpKeepIdle, KeepIdle]),
<a name="24995"/>24995:                                    {error,
<a name="24996"/>24996:                                     {unexpected_keepidle,
<a name="24997"/>24997:                                      ExpKeepIdle, KeepIdle}};
<a name="24998"/>24998:                                {error, Reason} = ERROR -&gt;
<a name="24999"/>24999:                                    ?SEV_EPRINT(&quot;failed get keepidle: &quot;
<a name="25000"/>25000:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="25001"/>25001:                                    ERROR
<a name="25002"/>25002:                            end
<a name="25003"/>25003:                    end},
<a name="25004"/>25004:          #{desc =&gt; &quot;announce ready (get keepidle(2))&quot;,
<a name="25005"/>25005:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25006"/>25006:                            ?SEV_ANNOUNCE_READY(Tester, get_keepidle),
<a name="25007"/>25007:                            ok
<a name="25008"/>25008:                    end},
<a name="25009"/>25009: 
<a name="25010"/>25010: 
<a name="25011"/>25011:          %% *** Termination ***
<a name="25012"/>25012:          #{desc =&gt; &quot;await terminate&quot;,
<a name="25013"/>25013:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="25014"/>25014:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="25015"/>25015:                                ok -&gt;
<a name="25016"/>25016:                                    {ok, maps:remove(tester, State)};
<a name="25017"/>25017:                                {error, _} = ERROR -&gt;
<a name="25018"/>25018:                                    ERROR
<a name="25019"/>25019:                            end
<a name="25020"/>25020:                    end},
<a name="25021"/>25021:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="25022"/>25022:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25023"/>25023:                            ok = socket:close(Sock),
<a name="25024"/>25024:                            {ok, maps:remove(sock, State)}
<a name="25025"/>25025:                    end},
<a name="25026"/>25026: 
<a name="25027"/>25027:          %% *** We are done ***
<a name="25028"/>25028:          ?SEV_FINISH_NORMAL
<a name="25029"/>25029:         ],
<a name="25030"/>25030: 
<a name="25031"/>25031: 
<a name="25032"/>25032:     TesterSeq =
<a name="25033"/>25033:         [
<a name="25034"/>25034:          %% *** Init part ***
<a name="25035"/>25035:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25036"/>25036:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25037"/>25037:                            _MRef = erlang:monitor(process, Pid),
<a name="25038"/>25038:                            ok
<a name="25039"/>25039:                    end},
<a name="25040"/>25040: 
<a name="25041"/>25041:          %% Start the server
<a name="25042"/>25042:          #{desc =&gt; &quot;order server start&quot;,
<a name="25043"/>25043:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25044"/>25044:                            ?SEV_ANNOUNCE_START(Pid),
<a name="25045"/>25045:                            ok
<a name="25046"/>25046:                    end},
<a name="25047"/>25047:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25048"/>25048:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25049"/>25049:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="25050"/>25050:                            ok
<a name="25051"/>25051:                    end},
<a name="25052"/>25052: 
<a name="25053"/>25053:          %% *** The actual test ***
<a name="25054"/>25054:          #{desc =&gt; &quot;order server to continue (with get-keepidle(1))&quot;,
<a name="25055"/>25055:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25056"/>25056:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepidle),
<a name="25057"/>25057:                            ok
<a name="25058"/>25058:                    end},
<a name="25059"/>25059:          #{desc =&gt; &quot;await server ready (get-keepidle(1))&quot;,
<a name="25060"/>25060:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25061"/>25061:                            ?SEV_AWAIT_READY(Server, server, get_keepidle)
<a name="25062"/>25062:                    end},
<a name="25063"/>25063: 
<a name="25064"/>25064:          #{desc =&gt; &quot;order server to continue (with set-keepidle)&quot;,
<a name="25065"/>25065:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25066"/>25066:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepidle),
<a name="25067"/>25067:                            ok
<a name="25068"/>25068:                    end},
<a name="25069"/>25069:          #{desc =&gt; &quot;await server ready (set-keepidle)&quot;,
<a name="25070"/>25070:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25071"/>25071:                            ?SEV_AWAIT_READY(Server, server, set_keepidle)
<a name="25072"/>25072:                    end},
<a name="25073"/>25073: 
<a name="25074"/>25074:          #{desc =&gt; &quot;order server to continue (with get-keepidle(2))&quot;,
<a name="25075"/>25075:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25076"/>25076:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepidle),
<a name="25077"/>25077:                            ok
<a name="25078"/>25078:                    end},
<a name="25079"/>25079:          #{desc =&gt; &quot;await server ready (get-keepidle(2))&quot;,
<a name="25080"/>25080:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25081"/>25081:                            ?SEV_AWAIT_READY(Server, server, get_keepidle)
<a name="25082"/>25082:                    end},
<a name="25083"/>25083: 
<a name="25084"/>25084: 
<a name="25085"/>25085:          %% *** Termination ***
<a name="25086"/>25086:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="25087"/>25087:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25088"/>25088:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25089"/>25089:                            ok
<a name="25090"/>25090:                    end},
<a name="25091"/>25091:          #{desc =&gt; &quot;await server termination&quot;,
<a name="25092"/>25092:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25093"/>25093:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25094"/>25094:                            State1 = maps:remove(server, State),
<a name="25095"/>25095:                            {ok, State1}
<a name="25096"/>25096:                    end},
<a name="25097"/>25097: 
<a name="25098"/>25098:          %% *** We are done ***
<a name="25099"/>25099:          ?SEV_FINISH_NORMAL
<a name="25100"/>25100:         ],
<a name="25101"/>25101: 
<a name="25102"/>25102: 
<a name="25103"/>25103:     i(&quot;start server evaluator&quot;),
<a name="25104"/>25104:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="25105"/>25105: 
<a name="25106"/>25106:     i(&quot;start tester evaluator&quot;),
<a name="25107"/>25107:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="25108"/>25108:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="25109"/>25109: 
<a name="api_opt_tcp_keepidle_tcp-last_expr"/><a name="25110"/>25110: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="25111"/>25111: 
<a name="25112"/>25112: 
<a name="25113"/>25113: 
<a name="25114"/>25114: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25115"/>25115: 
<a name="25116"/>25116: <i>%% Tests that the keepintvl tcp socket option.</i>
<a name="25117"/>25117: <i>%%</i>
<a name="25118"/>25118: <i>%% &quot;Gets or sets the number of seconds a TCP connection will wait for</i>
<a name="25119"/>25119: <i>%%  a keepalive response before sending another keepalive probe.&quot;</i>
<a name="25120"/>25120: <i>%%</i>
<a name="25121"/>25121: 
<a name="api_opt_tcp_keepintvl_tcp4-1"/><a name="25122"/>25122: <b>api_opt_tcp_keepintvl_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25123"/>25123:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepintvl_tcp4-last_expr"/><a name="25124"/>25124: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="25125"/>25125:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepintvl() end,
<a name="25126"/>25126:            fun() -&gt;
<a name="25127"/>25127:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="25128"/>25128:                                   socket:setopt(Sock, tcp, keepintvl, Value)
<a name="25129"/>25129:                           end,
<a name="25130"/>25130:                    Get  = fun(Sock) -&gt;
<a name="25131"/>25131:                                   socket:getopt(Sock, tcp, keepintvl)
<a name="25132"/>25132:                           end,
<a name="25133"/>25133:                    InitState = #{domain =&gt; inet,
<a name="25134"/>25134:                                  proto  =&gt; tcp,
<a name="25135"/>25135:                                  set    =&gt; Set,
<a name="25136"/>25136:                                  get    =&gt; Get},
<a name="25137"/>25137:                    ok = api_opt_tcp_keepintvl_tcp(InitState)
<a name="25138"/>25138:            end).
<a name="25139"/>25139: 
<a name="25140"/>25140: 
<a name="25141"/>25141: 
<a name="25142"/>25142: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25143"/>25143: 
<a name="api_opt_tcp_keepintvl_tcp-1"/><a name="25144"/>25144: <b>api_opt_tcp_keepintvl_tcp</b>(InitState) -&gt;
<a name="25145"/>25145:     process_flag(trap_exit, true),
<a name="25146"/>25146:     ServerSeq =
<a name="25147"/>25147:         [
<a name="25148"/>25148:          %% *** Wait for start order ***
<a name="25149"/>25149:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="25150"/>25150:            cmd  =&gt; fun(State) -&gt;
<a name="25151"/>25151:                            Tester = ?SEV_AWAIT_START(),
<a name="25152"/>25152:                            {ok, State#{tester =&gt; Tester}}
<a name="25153"/>25153:                    end},
<a name="25154"/>25154:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="25155"/>25155:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25156"/>25156:                            _MRef = erlang:monitor(process, Tester),
<a name="25157"/>25157:                            ok
<a name="25158"/>25158:                    end},
<a name="25159"/>25159: 
<a name="25160"/>25160:          %% *** Init part ***
<a name="25161"/>25161:          #{desc =&gt; &quot;which local address&quot;,
<a name="25162"/>25162:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25163"/>25163:                            LSA = which_local_socket_addr(Domain),
<a name="25164"/>25164:                            {ok, State#{lsa =&gt; LSA}}
<a name="25165"/>25165:                    end},
<a name="25166"/>25166:          #{desc =&gt; &quot;create socket&quot;,
<a name="25167"/>25167:            cmd  =&gt; fun(#{domain := Domain,
<a name="25168"/>25168:                          proto  := Proto} = State) -&gt;
<a name="25169"/>25169:                            case socket:open(Domain, stream, Proto) of
<a name="25170"/>25170:                                {ok, Sock} -&gt;
<a name="25171"/>25171:                                    {ok, State#{sock =&gt; Sock}};
<a name="25172"/>25172:                                {error, _} = ERROR -&gt;
<a name="25173"/>25173:                                    ERROR
<a name="25174"/>25174:                            end
<a name="25175"/>25175:                    end},
<a name="25176"/>25176:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25177"/>25177:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="25178"/>25178:                            case sock_bind(LSock, LSA) of
<a name="25179"/>25179:                                ok -&gt;
<a name="25180"/>25180:                                    Port = sock_port(LSock),
<a name="25181"/>25181:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25182"/>25182:                                    ok;
<a name="25183"/>25183:                                {error, _} = ERROR -&gt;
<a name="25184"/>25184:                                    ERROR
<a name="25185"/>25185:                            end
<a name="25186"/>25186:                    end},
<a name="25187"/>25187:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25188"/>25188:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25189"/>25189:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="25190"/>25190:                            ok
<a name="25191"/>25191:                    end},
<a name="25192"/>25192: 
<a name="25193"/>25193: 
<a name="25194"/>25194:          %% The actual test
<a name="25195"/>25195:          #{desc =&gt; &quot;await continue (get keepintvl(1))&quot;,
<a name="25196"/>25196:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25197"/>25197:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepintvl)
<a name="25198"/>25198:                    end},
<a name="25199"/>25199:          #{desc =&gt; &quot;get keepintvl&quot;,
<a name="25200"/>25200:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="25201"/>25201:                            case Get(Sock) of
<a name="25202"/>25202:                                {ok, KeepIntVl} -&gt;
<a name="25203"/>25203:                                    ?SEV_IPRINT(&quot;keepintvl: ~p&quot;, [KeepIntVl]),
<a name="25204"/>25204:                                    {ok, State#{keepintvl =&gt; KeepIntVl}};
<a name="25205"/>25205:                                {error, _} = ERROR -&gt;
<a name="25206"/>25206:                                    ERROR
<a name="25207"/>25207:                            end
<a name="25208"/>25208:                    end},
<a name="25209"/>25209:          #{desc =&gt; &quot;announce ready (get keepintvl(1))&quot;,
<a name="25210"/>25210:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25211"/>25211:                            ?SEV_ANNOUNCE_READY(Tester, get_keepintvl),
<a name="25212"/>25212:                            ok
<a name="25213"/>25213:                    end},
<a name="25214"/>25214: 
<a name="25215"/>25215: 
<a name="25216"/>25216:          #{desc =&gt; &quot;await continue (set keepintvl)&quot;,
<a name="25217"/>25217:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25218"/>25218:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepintvl)
<a name="25219"/>25219:                    end},
<a name="25220"/>25220:          #{desc =&gt; &quot;set keepintvl&quot;,
<a name="25221"/>25221:            cmd  =&gt; fun(#{sock     := Sock,
<a name="25222"/>25222:                          set      := Set,
<a name="25223"/>25223:                          keepintvl := KeepIntVl} = State) -&gt;
<a name="25224"/>25224:                            NewKeepIntVl = KeepIntVl + 1,
<a name="25225"/>25225:                            case Set(Sock, NewKeepIntVl) of
<a name="25226"/>25226:                                ok -&gt;
<a name="25227"/>25227:                                    ?SEV_IPRINT(&quot;keepIntVl updated (to ~p)&quot;,
<a name="25228"/>25228:                                                [NewKeepIntVl]),
<a name="25229"/>25229:                                    {ok, State#{keepintvl =&gt; NewKeepIntVl}};
<a name="25230"/>25230:                                {error, _} = ERROR -&gt;
<a name="25231"/>25231:                                    ERROR
<a name="25232"/>25232:                            end
<a name="25233"/>25233:                    end},
<a name="25234"/>25234:          #{desc =&gt; &quot;announce ready (set keepintvl)&quot;,
<a name="25235"/>25235:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25236"/>25236:                            ?SEV_ANNOUNCE_READY(Tester, set_keepintvl),
<a name="25237"/>25237:                            ok
<a name="25238"/>25238:                    end},
<a name="25239"/>25239: 
<a name="25240"/>25240: 
<a name="25241"/>25241:          #{desc =&gt; &quot;await continue (get keepintvl(2))&quot;,
<a name="25242"/>25242:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25243"/>25243:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepintvl)
<a name="25244"/>25244:                    end},
<a name="25245"/>25245:          #{desc =&gt; &quot;get keepintvl(2)&quot;,
<a name="25246"/>25246:            cmd  =&gt; fun(#{sock      := Sock,
<a name="25247"/>25247:                          get       := Get,
<a name="25248"/>25248:                          keepintvl := ExpKeepIntVl} = _State) -&gt;
<a name="25249"/>25249:                            case Get(Sock) of
<a name="25250"/>25250:                                {ok, KeepIntVl}
<a name="25251"/>25251:                                  when (ExpKeepIntVl =:= KeepIntVl) -&gt;
<a name="25252"/>25252:                                    ?SEV_IPRINT(&quot;expected keepintvl (~p)&quot;,
<a name="25253"/>25253:                                                [ExpKeepIntVl]),
<a name="25254"/>25254:                                    ok;
<a name="25255"/>25255:                                {ok, KeepIntVl} -&gt;
<a name="25256"/>25256:                                    ?SEV_EPRINT(&quot;unexpected keepintvl:&quot;
<a name="25257"/>25257:                                                &quot;~n   Expected KeepIntVl: ~p&quot;
<a name="25258"/>25258:                                                &quot;~n   Actual KeepIntVl:   ~p&quot;,
<a name="25259"/>25259:                                                [ExpKeepIntVl, KeepIntVl]),
<a name="25260"/>25260:                                    {error,
<a name="25261"/>25261:                                     {unexpected_keepintvl,
<a name="25262"/>25262:                                      ExpKeepIntVl, KeepIntVl}};
<a name="25263"/>25263:                                {error, Reason} = ERROR -&gt;
<a name="25264"/>25264:                                    ?SEV_EPRINT(&quot;failed get keepintvl: &quot;
<a name="25265"/>25265:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="25266"/>25266:                                    ERROR
<a name="25267"/>25267:                            end
<a name="25268"/>25268:                    end},
<a name="25269"/>25269:          #{desc =&gt; &quot;announce ready (get keepintvl(2))&quot;,
<a name="25270"/>25270:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25271"/>25271:                            ?SEV_ANNOUNCE_READY(Tester, get_keepintvl),
<a name="25272"/>25272:                            ok
<a name="25273"/>25273:                    end},
<a name="25274"/>25274: 
<a name="25275"/>25275: 
<a name="25276"/>25276:          %% *** Termination ***
<a name="25277"/>25277:          #{desc =&gt; &quot;await terminate&quot;,
<a name="25278"/>25278:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="25279"/>25279:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="25280"/>25280:                                ok -&gt;
<a name="25281"/>25281:                                    {ok, maps:remove(tester, State)};
<a name="25282"/>25282:                                {error, _} = ERROR -&gt;
<a name="25283"/>25283:                                    ERROR
<a name="25284"/>25284:                            end
<a name="25285"/>25285:                    end},
<a name="25286"/>25286:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="25287"/>25287:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25288"/>25288:                            ok = socket:close(Sock),
<a name="25289"/>25289:                            {ok, maps:remove(sock, State)}
<a name="25290"/>25290:                    end},
<a name="25291"/>25291: 
<a name="25292"/>25292:          %% *** We are done ***
<a name="25293"/>25293:          ?SEV_FINISH_NORMAL
<a name="25294"/>25294:         ],
<a name="25295"/>25295: 
<a name="25296"/>25296: 
<a name="25297"/>25297:     TesterSeq =
<a name="25298"/>25298:         [
<a name="25299"/>25299:          %% *** Init part ***
<a name="25300"/>25300:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25301"/>25301:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25302"/>25302:                            _MRef = erlang:monitor(process, Pid),
<a name="25303"/>25303:                            ok
<a name="25304"/>25304:                    end},
<a name="25305"/>25305: 
<a name="25306"/>25306:          %% Start the server
<a name="25307"/>25307:          #{desc =&gt; &quot;order server start&quot;,
<a name="25308"/>25308:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25309"/>25309:                            ?SEV_ANNOUNCE_START(Pid),
<a name="25310"/>25310:                            ok
<a name="25311"/>25311:                    end},
<a name="25312"/>25312:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25313"/>25313:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25314"/>25314:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="25315"/>25315:                            ok
<a name="25316"/>25316:                    end},
<a name="25317"/>25317: 
<a name="25318"/>25318:          %% *** The actual test ***
<a name="25319"/>25319:          #{desc =&gt; &quot;order server to continue (with get-keepintvl(1))&quot;,
<a name="25320"/>25320:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25321"/>25321:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepintvl),
<a name="25322"/>25322:                            ok
<a name="25323"/>25323:                    end},
<a name="25324"/>25324:          #{desc =&gt; &quot;await server ready (get-keepintvl(1))&quot;,
<a name="25325"/>25325:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25326"/>25326:                            ?SEV_AWAIT_READY(Server, server, get_keepintvl)
<a name="25327"/>25327:                    end},
<a name="25328"/>25328: 
<a name="25329"/>25329:          #{desc =&gt; &quot;order server to continue (with set-keepintvl)&quot;,
<a name="25330"/>25330:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25331"/>25331:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepintvl),
<a name="25332"/>25332:                            ok
<a name="25333"/>25333:                    end},
<a name="25334"/>25334:          #{desc =&gt; &quot;await server ready (set-keepintvl)&quot;,
<a name="25335"/>25335:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25336"/>25336:                            ?SEV_AWAIT_READY(Server, server, set_keepintvl)
<a name="25337"/>25337:                    end},
<a name="25338"/>25338: 
<a name="25339"/>25339:          #{desc =&gt; &quot;order server to continue (with get-keepintvl(2))&quot;,
<a name="25340"/>25340:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25341"/>25341:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepintvl),
<a name="25342"/>25342:                            ok
<a name="25343"/>25343:                    end},
<a name="25344"/>25344:          #{desc =&gt; &quot;await server ready (get-keepintvl(2))&quot;,
<a name="25345"/>25345:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25346"/>25346:                            ?SEV_AWAIT_READY(Server, server, get_keepintvl)
<a name="25347"/>25347:                    end},
<a name="25348"/>25348: 
<a name="25349"/>25349: 
<a name="25350"/>25350:          %% *** Termination ***
<a name="25351"/>25351:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="25352"/>25352:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25353"/>25353:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25354"/>25354:                            ok
<a name="25355"/>25355:                    end},
<a name="25356"/>25356:          #{desc =&gt; &quot;await server termination&quot;,
<a name="25357"/>25357:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25358"/>25358:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25359"/>25359:                            State1 = maps:remove(server, State),
<a name="25360"/>25360:                            {ok, State1}
<a name="25361"/>25361:                    end},
<a name="25362"/>25362: 
<a name="25363"/>25363:          %% *** We are done ***
<a name="25364"/>25364:          ?SEV_FINISH_NORMAL
<a name="25365"/>25365:         ],
<a name="25366"/>25366: 
<a name="25367"/>25367: 
<a name="25368"/>25368:     i(&quot;start server evaluator&quot;),
<a name="25369"/>25369:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="25370"/>25370: 
<a name="25371"/>25371:     i(&quot;start tester evaluator&quot;),
<a name="25372"/>25372:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="25373"/>25373:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="25374"/>25374: 
<a name="api_opt_tcp_keepintvl_tcp-last_expr"/><a name="25375"/>25375: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="25376"/>25376: 
<a name="25377"/>25377: 
<a name="25378"/>25378: 
<a name="25379"/>25379: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25380"/>25380: 
<a name="25381"/>25381: <i>%% Tests that the cork udp socket option.</i>
<a name="25382"/>25382: <i>%%</i>
<a name="25383"/>25383: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="25384"/>25384: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="25385"/>25385: <i>%%</i>
<a name="25386"/>25386: 
<a name="api_opt_udp_cork_udp4-1"/><a name="25387"/>25387: <b>api_opt_udp_cork_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25388"/>25388:     ?TT(?SECS(5)),
<a name="api_opt_udp_cork_udp4-last_expr"/><a name="25389"/>25389: <b>    tc_try</b>(api_opt_udp_cork_udp4,
<a name="25390"/>25390:            fun() -&gt; has_support_ipv4(), has_support_udp_cork() end,
<a name="25391"/>25391:            fun() -&gt;
<a name="25392"/>25392:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="25393"/>25393:                                   socket:setopt(Sock, udp, cork, Value)
<a name="25394"/>25394:                           end,
<a name="25395"/>25395:                    Get  = fun(Sock) -&gt;
<a name="25396"/>25396:                                   socket:getopt(Sock, udp, cork)
<a name="25397"/>25397:                           end,
<a name="25398"/>25398:                    InitState = #{domain =&gt; inet,
<a name="25399"/>25399:                                  proto  =&gt; udp,
<a name="25400"/>25400:                                  set    =&gt; Set,
<a name="25401"/>25401:                                  get    =&gt; Get},
<a name="25402"/>25402:                    ok = api_opt_udp_cork_udp(InitState)
<a name="25403"/>25403:            end).
<a name="25404"/>25404: 
<a name="25405"/>25405: 
<a name="25406"/>25406: 
<a name="25407"/>25407: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25408"/>25408: 
<a name="api_opt_udp_cork_udp-1"/><a name="25409"/>25409: <b>api_opt_udp_cork_udp</b>(InitState) -&gt;
<a name="25410"/>25410:     process_flag(trap_exit, true),
<a name="25411"/>25411:     TesterSeq =
<a name="25412"/>25412:         [
<a name="25413"/>25413:          %% *** Init part ***
<a name="25414"/>25414:          #{desc =&gt; &quot;which local address&quot;,
<a name="25415"/>25415:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25416"/>25416:                            LSA = which_local_socket_addr(Domain),
<a name="25417"/>25417:                            {ok, State#{lsa =&gt; LSA}}
<a name="25418"/>25418:                    end},
<a name="25419"/>25419:          #{desc =&gt; &quot;create socket&quot;,
<a name="25420"/>25420:            cmd  =&gt; fun(#{domain := Domain,
<a name="25421"/>25421:                          proto  := Proto} = State) -&gt;
<a name="25422"/>25422:                            case socket:open(Domain, dgram, Proto) of
<a name="25423"/>25423:                                {ok, Sock} -&gt;
<a name="25424"/>25424:                                    {ok, State#{sock =&gt; Sock}};
<a name="25425"/>25425:                                {error, _} = ERROR -&gt;
<a name="25426"/>25426:                                    ERROR
<a name="25427"/>25427:                            end
<a name="25428"/>25428:                    end},
<a name="25429"/>25429:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25430"/>25430:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="25431"/>25431:                            case sock_bind(Sock, LSA) of
<a name="25432"/>25432:                                ok -&gt;
<a name="25433"/>25433:                                    Port = sock_port(Sock),
<a name="25434"/>25434:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25435"/>25435:                                    ok;
<a name="25436"/>25436:                                {error, _} = ERROR -&gt;
<a name="25437"/>25437:                                    ERROR
<a name="25438"/>25438:                            end
<a name="25439"/>25439:                    end},
<a name="25440"/>25440: 
<a name="25441"/>25441: 
<a name="25442"/>25442:          %% The actual test
<a name="25443"/>25443:          #{desc =&gt; &quot;get (default) cork (= false)&quot;,
<a name="25444"/>25444:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="25445"/>25445:                            case Get(Sock) of
<a name="25446"/>25446:                                {ok, false = Value} -&gt;
<a name="25447"/>25447:                                    ?SEV_IPRINT(&quot;cork default: ~p&quot;, [Value]),
<a name="25448"/>25448:                                    ok;
<a name="25449"/>25449:                                {error, _} = ERROR -&gt;
<a name="25450"/>25450:                                    ERROR
<a name="25451"/>25451:                            end
<a name="25452"/>25452:                    end},
<a name="25453"/>25453:          #{desc =&gt; &quot;enable cork (=&gt; true)&quot;,
<a name="25454"/>25454:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="25455"/>25455:                            case Set(Sock, true) of
<a name="25456"/>25456:                                ok -&gt;
<a name="25457"/>25457:                                    ?SEV_IPRINT(&quot;cork enabled&quot;),
<a name="25458"/>25458:                                    ok;
<a name="25459"/>25459:                                {error, _} = ERROR -&gt;
<a name="25460"/>25460:                                    ERROR
<a name="25461"/>25461:                            end
<a name="25462"/>25462:                    end},
<a name="25463"/>25463:          #{desc =&gt; &quot;get cork (= true)&quot;,
<a name="25464"/>25464:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="25465"/>25465:                            case Get(Sock) of
<a name="25466"/>25466:                                {ok, true = Value} -&gt;
<a name="25467"/>25467:                                    ?SEV_IPRINT(&quot;cork: ~p&quot;, [Value]),
<a name="25468"/>25468:                                    ok;
<a name="25469"/>25469:                                {error, _} = ERROR -&gt;
<a name="25470"/>25470:                                    ERROR
<a name="25471"/>25471:                            end
<a name="25472"/>25472:                    end},
<a name="25473"/>25473: 
<a name="25474"/>25474: 
<a name="25475"/>25475:          %% *** Termination ***
<a name="25476"/>25476:          #{desc =&gt; &quot;close socket&quot;,
<a name="25477"/>25477:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25478"/>25478:                            ok = socket:close(Sock),
<a name="25479"/>25479:                            {ok, maps:remove(sock, State)}
<a name="25480"/>25480:                    end},
<a name="25481"/>25481: 
<a name="25482"/>25482:          %% *** We are done ***
<a name="25483"/>25483:          ?SEV_FINISH_NORMAL
<a name="25484"/>25484:         ],
<a name="25485"/>25485: 
<a name="25486"/>25486:     i(&quot;start tester evaluator&quot;),
<a name="25487"/>25487:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="25488"/>25488: 
<a name="api_opt_udp_cork_udp-last_expr"/><a name="25489"/>25489: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="25490"/>25490: 
<a name="25491"/>25491: 
<a name="25492"/>25492: 
<a name="25493"/>25493: 
<a name="25494"/>25494: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25495"/>25495: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25496"/>25496: <i>%%                                                                     %%</i>
<a name="25497"/>25497: <i>%%                  API OPERATIONS WITH TIMEOUT                        %%</i>
<a name="25498"/>25498: <i>%%                                                                     %%</i>
<a name="25499"/>25499: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25500"/>25500: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25501"/>25501: 
<a name="25502"/>25502: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25503"/>25503: 
<a name="25504"/>25504: <i>%% This test case is intended to test the connect timeout option</i>
<a name="25505"/>25505: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_connect_tcp4-1"/><a name="25506"/>25506: <b>api_to_connect_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25507"/>25507:     ?TT(?SECS(10)),
<a name="25508"/>25508:     Cond = fun() -&gt; has_support_ipv4(), api_to_connect_cond() end,
<a name="api_to_connect_tcp4-last_expr"/><a name="25509"/>25509: <b>    tc_try</b>(api_to_connect_tcp4,
<a name="25510"/>25510:            Cond,
<a name="25511"/>25511:            fun() -&gt;
<a name="25512"/>25512:                    InitState = #{domain        =&gt; inet,
<a name="25513"/>25513:                                  backlog       =&gt; 1,
<a name="25514"/>25514:                                  timeout       =&gt; 5000,
<a name="25515"/>25515:                                  connect_limit =&gt; 3},
<a name="25516"/>25516:                    ok = api_to_connect_tcp(InitState)
<a name="25517"/>25517:            end).
<a name="25518"/>25518: 
<a name="api_to_connect_cond-0"/><a name="25519"/>25519: <b>api_to_connect_cond</b>() -&gt;
<a name="api_to_connect_cond-last_expr"/><a name="25520"/>25520: <b>    api_to_connect_cond</b>(os:type(), os:version()).
<a name="25521"/>25521: 
<a name="25522"/>25522: <i>%% I don't know exactly at which version this starts to work.</i>
<a name="25523"/>25523: <i>%% I know it does not work for 4.4.*, but is does for 4.15.</i>
<a name="25524"/>25524: <i>%% So, just to simplify, we require at least 4.15</i>
<a name="api_to_connect_cond-2"/><a name="25525"/>25525: <b>api_to_connect_cond</b>({unix, linux}, {Maj, Min, _Rev}) -&gt;
<a name="25526"/>25526:     if
<a name="25527"/>25527:         (Maj &gt; 4) -&gt;
<a name="25528"/>25528:             ok;
<a name="25529"/>25529:         ((Maj =:= 4) andalso (Min &gt;= 15)) -&gt;
<a name="25530"/>25530:             ok;
<a name="25531"/>25531:         true -&gt;
<a name="25532"/>25532:             skip(&quot;TC does not work&quot;)
<a name="25533"/>25533:     end;
<a name="25534"/>25534: <i>%% Only test on one machine, which has version 6.3, and there it does</i>
<a name="25535"/>25535: <i>%% not work, so disable for all.</i>
<a name="25536"/>25536: <b>api_to_connect_cond</b>({unix, openbsd}, _) -&gt;
<a name="25537"/>25537:     skip(&quot;TC does not work&quot;);
<a name="25538"/>25538: <b>api_to_connect_cond</b>({unix, freebsd}, {Maj, Min, _Rev}) -&gt;
<a name="25539"/>25539:     if
<a name="25540"/>25540:         ((Maj &gt;= 10) andalso (Min &gt;= 4)) -&gt;
<a name="25541"/>25541:             ok;
<a name="25542"/>25542:         true -&gt;
<a name="25543"/>25543:             skip(&quot;TC may not work&quot;)
<a name="25544"/>25544:     end;
<a name="25545"/>25545: <b>api_to_connect_cond</b>({unix, sunos}, {Maj, Min, _Rev}) -&gt;
<a name="25546"/>25546:     if
<a name="25547"/>25547:         ((Maj &gt;= 5) andalso (Min &gt;= 10)) -&gt;
<a name="25548"/>25548:             ok;
<a name="25549"/>25549:         true -&gt;
<a name="25550"/>25550:             skip(&quot;TC may not work&quot;)
<a name="25551"/>25551:     end;
<a name="25552"/>25552: <b>api_to_connect_cond</b>(_, _) -&gt;
<a name="api_to_connect_cond-last_expr"/><a name="25553"/>25553: <b>    skip</b>(&quot;TC may not work&quot;).
<a name="25554"/>25554: 
<a name="25555"/>25555: 
<a name="25556"/>25556: 
<a name="25557"/>25557: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25558"/>25558: 
<a name="25559"/>25559: <i>%% This test case is intended to test the connect timeout option</i>
<a name="25560"/>25560: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_connect_tcp6-1"/><a name="25561"/>25561: <b>api_to_connect_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="25562"/>25562:     ?TT(?SECS(10)),
<a name="api_to_connect_tcp6-last_expr"/><a name="25563"/>25563: <b>    tc_try</b>(api_to_connect_tcp6,
<a name="25564"/>25564:            fun() -&gt; has_support_ipv6(), api_to_connect_cond() end,
<a name="25565"/>25565:            fun() -&gt;
<a name="25566"/>25566:                    InitState = #{domain        =&gt; inet6,
<a name="25567"/>25567:                                  backlog       =&gt; 1,
<a name="25568"/>25568:                                  timeout       =&gt; 5000,
<a name="25569"/>25569:                                  connect_limit =&gt; 3},
<a name="25570"/>25570:                    ok = api_to_connect_tcp(InitState)
<a name="25571"/>25571:            end).
<a name="25572"/>25572: 
<a name="25573"/>25573: 
<a name="25574"/>25574: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25575"/>25575: <i>%% We use the backlog (listen) argument to test this.</i>
<a name="25576"/>25576: <i>%% Note that the behaviour of the TCP &quot;server side&quot; can vary when </i>
<a name="25577"/>25577: <i>%% a client connect to a &quot;busy&quot; server (full backlog).</i>
<a name="25578"/>25578: <i>%% For instance, on FreeBSD (11.2) the response when the backlog is full</i>
<a name="25579"/>25579: <i>%% is a econreset.</i>
<a name="25580"/>25580: 
<a name="api_to_connect_tcp-1"/><a name="25581"/>25581: <b>api_to_connect_tcp</b>(InitState) -&gt;
<a name="25582"/>25582:     process_flag(trap_exit, true),
<a name="25583"/>25583: 
<a name="25584"/>25584:     ServerSeq = 
<a name="25585"/>25585:         [
<a name="25586"/>25586:          %% *** Wait for start order part ***
<a name="25587"/>25587:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="25588"/>25588:            cmd  =&gt; fun(State) -&gt;
<a name="25589"/>25589:                            {Tester, Backlog} = ?SEV_AWAIT_START(),
<a name="25590"/>25590:                            {ok, State#{tester  =&gt; Tester,
<a name="25591"/>25591:                                        backlog =&gt; Backlog}}
<a name="25592"/>25592:                    end},
<a name="25593"/>25593:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="25594"/>25594:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="25595"/>25595:                            _MRef = erlang:monitor(process, Tester),
<a name="25596"/>25596:                            ok
<a name="25597"/>25597:                    end},
<a name="25598"/>25598: 
<a name="25599"/>25599:          %% *** Init part ***
<a name="25600"/>25600:          #{desc =&gt; &quot;which local address&quot;,
<a name="25601"/>25601:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25602"/>25602:                            LSA = which_local_socket_addr(Domain),
<a name="25603"/>25603:                            {ok, State#{local_sa =&gt; LSA}}
<a name="25604"/>25604:                    end},
<a name="25605"/>25605:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="25606"/>25606:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25607"/>25607:                            case socket:open(Domain, stream, tcp) of
<a name="25608"/>25608:                                {ok, Sock} -&gt;
<a name="25609"/>25609:                                    {ok, State#{lsock =&gt; Sock}};
<a name="25610"/>25610:                                {error, _} = ERROR -&gt;
<a name="25611"/>25611:                                    ERROR
<a name="25612"/>25612:                            end
<a name="25613"/>25613:                    end},
<a name="25614"/>25614:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25615"/>25615:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="25616"/>25616:                            case sock_bind(LSock, LSA) of
<a name="25617"/>25617:                                ok -&gt;
<a name="25618"/>25618:                                    Port = sock_port(LSock),
<a name="25619"/>25619:                                    {ok, State#{lport =&gt; Port}};
<a name="25620"/>25620:                                {error, _} = ERROR -&gt;
<a name="25621"/>25621:                                    ERROR
<a name="25622"/>25622:                            end
<a name="25623"/>25623:                    end},
<a name="25624"/>25624:          #{desc =&gt; &quot;make listen socket (with backlog = 1)&quot;,
<a name="25625"/>25625:            cmd  =&gt; fun(#{lsock := LSock, backlog := Backlog}) -&gt;
<a name="25626"/>25626:                            socket:listen(LSock, Backlog)
<a name="25627"/>25627:                    end},
<a name="25628"/>25628:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25629"/>25629:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="25630"/>25630:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="25631"/>25631:                            ok
<a name="25632"/>25632:                    end},
<a name="25633"/>25633: 
<a name="25634"/>25634:          %% Termination
<a name="25635"/>25635:          #{desc =&gt; &quot;await terminate&quot;,
<a name="25636"/>25636:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="25637"/>25637:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="25638"/>25638:                                ok -&gt;
<a name="25639"/>25639:                                    {ok, maps:remove(tester, State)};
<a name="25640"/>25640:                                {error, _} = ERROR -&gt;
<a name="25641"/>25641:                                    ERROR
<a name="25642"/>25642:                            end
<a name="25643"/>25643:                    end},
<a name="25644"/>25644:          #{desc =&gt; &quot;close socket&quot;,
<a name="25645"/>25645:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="25646"/>25646:                            sock_close(Sock),
<a name="25647"/>25647:                            State1 = maps:remove(lport, State),
<a name="25648"/>25648:                            State2 = maps:remove(sock,  State1),
<a name="25649"/>25649:                            {ok, State2}
<a name="25650"/>25650:                    end},
<a name="25651"/>25651: 
<a name="25652"/>25652:          %% *** We are done ***
<a name="25653"/>25653:          ?SEV_FINISH_NORMAL
<a name="25654"/>25654:         ],
<a name="25655"/>25655: 
<a name="25656"/>25656:     ClientSeq =
<a name="25657"/>25657:         [
<a name="25658"/>25658:          %% *** Wait for start order part ***
<a name="25659"/>25659:          #{desc =&gt; &quot;await start&quot;,
<a name="25660"/>25660:            cmd  =&gt; fun(State) -&gt;
<a name="25661"/>25661:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="25662"/>25662:                            {ok, State#{tester    =&gt; Tester,
<a name="25663"/>25663:                                        server_sa =&gt; ServerSA}}
<a name="25664"/>25664:                    end},
<a name="25665"/>25665:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="25666"/>25666:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="25667"/>25667:                            _MRef = erlang:monitor(process, Tester),
<a name="25668"/>25668:                            ok
<a name="25669"/>25669:                    end},
<a name="25670"/>25670: 
<a name="25671"/>25671:          %% *** Init part ***
<a name="25672"/>25672:          #{desc =&gt; &quot;which local address&quot;,
<a name="25673"/>25673:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25674"/>25674:                            LSA = which_local_socket_addr(Domain),
<a name="25675"/>25675:                            {ok, State#{local_sa =&gt; LSA}}
<a name="25676"/>25676:                    end},
<a name="25677"/>25677:          #{desc =&gt; &quot;create node&quot;,
<a name="25678"/>25678:            cmd  =&gt; fun(#{host := _Host} = State) -&gt;
<a name="25679"/>25679:                            {Peer, Node} = start_node(&quot;client&quot;),
<a name="25680"/>25680:                            {ok, State#{node =&gt; Node, peer =&gt; Peer}}
<a name="25681"/>25681:                    end},
<a name="25682"/>25682:          #{desc =&gt; &quot;monitor client node&quot;,
<a name="25683"/>25683:            cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="25684"/>25684:                            true = erlang:monitor_node(Node, true),
<a name="25685"/>25685:                            ok
<a name="25686"/>25686:                    end},
<a name="25687"/>25687:          #{desc =&gt; &quot;start remote client on client node&quot;,
<a name="25688"/>25688:            cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="25689"/>25689:                            Pid = api_toc_tcp_client_start(Node),
<a name="25690"/>25690:                            ?SEV_IPRINT(&quot;remote client ~p started&quot;, [Pid]),
<a name="25691"/>25691:                            {ok, State#{rclient =&gt; Pid}}
<a name="25692"/>25692:                    end},
<a name="25693"/>25693:          %% #{desc =&gt; &quot;monitor remote client&quot;,
<a name="25694"/>25694:          %%   cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="25695"/>25695:          %%                   _MRef = erlang:monitor(process, Pid),
<a name="25696"/>25696:          %%                   ok
<a name="25697"/>25697:          %%           end},
<a name="25698"/>25698:          #{desc =&gt; &quot;order remote client to start&quot;,
<a name="25699"/>25699:            cmd  =&gt; fun(#{rclient   := Client,
<a name="25700"/>25700:                          server_sa := ServerSA}) -&gt;
<a name="25701"/>25701:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="25702"/>25702:                            ok
<a name="25703"/>25703:                    end},
<a name="25704"/>25704:          #{desc =&gt; &quot;await remote client ready&quot;,
<a name="25705"/>25705:            cmd  =&gt; fun(#{tester  := Tester,
<a name="25706"/>25706:                          rclient := Client} = _State) -&gt;
<a name="25707"/>25707:                            ?SEV_AWAIT_READY(Client, rclient, init,
<a name="25708"/>25708:                                             [{tester, Tester}])
<a name="25709"/>25709:                    end},
<a name="25710"/>25710:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25711"/>25711:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25712"/>25712:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="25713"/>25713:                            ok
<a name="25714"/>25714:                    end},
<a name="25715"/>25715: 
<a name="25716"/>25716:          %% The actual test
<a name="25717"/>25717:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="25718"/>25718:            cmd  =&gt; fun(#{tester  := Tester,
<a name="25719"/>25719:                          rclient := Client} = State) -&gt;
<a name="25720"/>25720:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, connect,
<a name="25721"/>25721:                                                     [{rclient, Client}]) of
<a name="25722"/>25722:                                {ok, {ConTimeout, ConLimit}} -&gt;
<a name="25723"/>25723:                                    {ok, State#{connect_timeout =&gt; ConTimeout,
<a name="25724"/>25724:                                                connect_limit   =&gt; ConLimit}};
<a name="25725"/>25725:                                {error, _} = ERROR -&gt;
<a name="25726"/>25726:                                    ERROR
<a name="25727"/>25727:                            end
<a name="25728"/>25728:                    end},
<a name="25729"/>25729:          #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="25730"/>25730:            cmd  =&gt; fun(#{rclient         := RClient,
<a name="25731"/>25731:                          connect_timeout := ConTimeout,
<a name="25732"/>25732:                          connect_limit   := ConLimit}) -&gt;
<a name="25733"/>25733:                            ?SEV_ANNOUNCE_CONTINUE(RClient, connect,
<a name="25734"/>25734:                                                   {ConTimeout, ConLimit}),
<a name="25735"/>25735:                            ok
<a name="25736"/>25736:                    end},
<a name="25737"/>25737:          #{desc =&gt; &quot;await remote client ready (connect)&quot;,
<a name="25738"/>25738:            cmd  =&gt; fun(#{tester  := Tester,
<a name="25739"/>25739:                          rclient := RClient} = State) -&gt;
<a name="25740"/>25740:                            case ?SEV_AWAIT_READY(RClient, rclient, connect,
<a name="25741"/>25741:                                                  [{tester, Tester}]) of
<a name="25742"/>25742:                                {ok, ok = _Result} -&gt;
<a name="25743"/>25743:                                    ?SEV_IPRINT(&quot;ok =&gt; success&quot;),
<a name="25744"/>25744:                                    {ok, maps:remove(connect_limit, State)};
<a name="25745"/>25745:                                {ok, {error, {connect_limit_reached,R,L}}} -&gt;
<a name="25746"/>25746:                                    ?SEV_IPRINT(&quot;limit reached - skip: &quot;
<a name="25747"/>25747:                                                &quot;~n   R: ~p&quot;
<a name="25748"/>25748:                                                &quot;~n   L: ~p&quot;, [R, L]),
<a name="25749"/>25749:                                    {skip,
<a name="25750"/>25750:                                     ?SLIB:f(&quot;Connect limit reached ~w: ~w&quot;,
<a name="25751"/>25751:                                            [L, R])};
<a name="25752"/>25752:                                {ok, Result} -&gt;
<a name="25753"/>25753:                                    ?SEV_IPRINT(&quot;result: &quot;
<a name="25754"/>25754:                                                &quot;~n   ~p&quot;, [Result]),
<a name="25755"/>25755:                                    Result;
<a name="25756"/>25756:                                {error, _Reason} = ERROR -&gt;
<a name="25757"/>25757:                                    ?SEV_IPRINT(&quot;error: &quot;
<a name="25758"/>25758:                                                &quot;~n   ~p&quot;, [_Reason]),
<a name="25759"/>25759:                                    ERROR
<a name="25760"/>25760:                            end
<a name="25761"/>25761:                    end},
<a name="25762"/>25762: 
<a name="25763"/>25763:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="25764"/>25764:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25765"/>25765:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="25766"/>25766:                            ok
<a name="25767"/>25767:                    end},
<a name="25768"/>25768: 
<a name="25769"/>25769:          %% Termination
<a name="25770"/>25770:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="25771"/>25771:            cmd  =&gt; fun(#{tester  := Tester,
<a name="25772"/>25772:                          rclient := RClient} = State) -&gt;
<a name="25773"/>25773:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="25774"/>25774:                                                      [{rclient, RClient}]) of
<a name="25775"/>25775:                                ok -&gt;
<a name="25776"/>25776:                                    {ok, maps:remove(tester, State)};
<a name="25777"/>25777:                                {error, _} = ERROR -&gt;
<a name="25778"/>25778:                                    ERROR
<a name="25779"/>25779:                            end
<a name="25780"/>25780:                    end},
<a name="25781"/>25781:          #{desc =&gt; &quot;kill remote client&quot;,
<a name="25782"/>25782:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="25783"/>25783:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="25784"/>25784:                            ok
<a name="25785"/>25785:                    end},
<a name="25786"/>25786:          #{desc =&gt; &quot;await remote client termination&quot;,
<a name="25787"/>25787:            cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="25788"/>25788:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="25789"/>25789:                            State1 = maps:remove(rclient, State),
<a name="25790"/>25790:                            {ok, State1}
<a name="25791"/>25791:                    end},
<a name="25792"/>25792:          #{desc =&gt; &quot;stop client node&quot;,
<a name="25793"/>25793:            cmd  =&gt; fun(#{peer := Peer} = State) -&gt;
<a name="25794"/>25794:                            {ok,
<a name="25795"/>25795:                             try peer:stop(Peer) of
<a name="25796"/>25796:                                 ok -&gt;
<a name="25797"/>25797:                                     State#{node_stop =&gt; ok};
<a name="25798"/>25798:                                 {error, Reason} -&gt;
<a name="25799"/>25799:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="25800"/>25800:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="25801"/>25801:                                     State#{node_stop =&gt; error}
<a name="25802"/>25802:                             catch
<a name="25803"/>25803:                                 C:E:S -&gt;
<a name="25804"/>25804:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="25805"/>25805:                                                 &quot;~n   Class: ~p&quot;
<a name="25806"/>25806:                                                 &quot;~n   Error: ~p&quot;
<a name="25807"/>25807:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="25808"/>25808:                                     State#{node_stop =&gt; error}
<a name="25809"/>25809:                             end}
<a name="25810"/>25810:                    end},
<a name="25811"/>25811:          #{desc =&gt; &quot;await client node termination&quot;,
<a name="25812"/>25812:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State) -&gt;
<a name="25813"/>25813:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="25814"/>25814:                            receive
<a name="25815"/>25815:                                {nodedown, Node} -&gt;
<a name="25816"/>25816:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="25817"/>25817:                                    State1 = maps:remove(peer, State),
<a name="25818"/>25818:                                    State2 = maps:remove(node, State1),
<a name="25819"/>25819:                                    {ok, State2}
<a name="25820"/>25820:                            end;
<a name="25821"/>25821:                       (#{node_stop := error} = State) -&gt;
<a name="25822"/>25822:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="25823"/>25823:                            State1 = maps:remove(peer, State),
<a name="25824"/>25824:                            State2 = maps:remove(node, State1),
<a name="25825"/>25825:                            {ok, State2}
<a name="25826"/>25826:                    end},
<a name="25827"/>25827: 
<a name="25828"/>25828:          %% *** We are done ***
<a name="25829"/>25829:          ?SEV_FINISH_NORMAL
<a name="25830"/>25830:         ],
<a name="25831"/>25831: 
<a name="25832"/>25832:     TesterSeq =
<a name="25833"/>25833:         [
<a name="25834"/>25834:          %% *** Init part ***
<a name="25835"/>25835:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25836"/>25836:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25837"/>25837:                            _MRef = erlang:monitor(process, Server),
<a name="25838"/>25838:                            ok
<a name="25839"/>25839:                    end},
<a name="25840"/>25840:          #{desc =&gt; &quot;monitor client&quot;,
<a name="25841"/>25841:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="25842"/>25842:                            _MRef = erlang:monitor(process, Client),
<a name="25843"/>25843:                            ok
<a name="25844"/>25844:                    end},
<a name="25845"/>25845:          #{desc =&gt; &quot;which local address&quot;,
<a name="25846"/>25846:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25847"/>25847:                            LSA = which_local_socket_addr(Domain),
<a name="25848"/>25848:                            {ok, State#{local_sa =&gt; LSA}}
<a name="25849"/>25849:                    end},
<a name="25850"/>25850:          #{desc =&gt; &quot;order server start&quot;,
<a name="25851"/>25851:            cmd  =&gt; fun(#{server  := Server,
<a name="25852"/>25852:                          backlog := Backlog}) -&gt;
<a name="25853"/>25853:                            ?SEV_ANNOUNCE_START(Server, Backlog),
<a name="25854"/>25854:                            ok
<a name="25855"/>25855:                    end},
<a name="25856"/>25856:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25857"/>25857:            cmd  =&gt; fun(#{server := Server, local_sa := LSA} = State) -&gt;
<a name="25858"/>25858:                            {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="25859"/>25859:                            ServerSA = LSA#{port =&gt; Port},
<a name="25860"/>25860:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="25861"/>25861:                    end},
<a name="25862"/>25862:          #{desc =&gt; &quot;order client start&quot;,
<a name="25863"/>25863:            cmd  =&gt; fun(#{client    := Client,
<a name="25864"/>25864:                          server_sa := ServerSA}) -&gt;
<a name="25865"/>25865:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="25866"/>25866:                            ok
<a name="25867"/>25867:                    end},
<a name="25868"/>25868:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="25869"/>25869:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="25870"/>25870:                            ?SEV_AWAIT_READY(Client, client, init),
<a name="25871"/>25871:                            ok
<a name="25872"/>25872:                    end},
<a name="25873"/>25873: 
<a name="25874"/>25874:          %% The actual test
<a name="25875"/>25875:          %% The server does nothing (this is the point), no accept,
<a name="25876"/>25876:          %% the client tries to connect.
<a name="25877"/>25877:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="25878"/>25878:            cmd  =&gt; fun(#{client        := Client,
<a name="25879"/>25879:                          timeout       := Timeout,
<a name="25880"/>25880:                          connect_limit := ConLimit} = _State) -&gt;
<a name="25881"/>25881:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect,
<a name="25882"/>25882:                                                   {Timeout, ConLimit}),
<a name="25883"/>25883:                            ok
<a name="25884"/>25884:                    end},
<a name="25885"/>25885:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="25886"/>25886:            cmd  =&gt; fun(#{server := Server,
<a name="25887"/>25887:                          client := Client} = _State) -&gt;
<a name="25888"/>25888:                            case ?SEV_AWAIT_READY(Client, client, connect,
<a name="25889"/>25889:                                                  [{server, Server}]) of
<a name="25890"/>25890:                                ok -&gt;
<a name="25891"/>25891:                                    ok;
<a name="25892"/>25892:                                {error, _} = ERROR -&gt;
<a name="25893"/>25893:                                    ERROR
<a name="25894"/>25894:                            end
<a name="25895"/>25895:                    end},
<a name="25896"/>25896: 
<a name="25897"/>25897: 
<a name="25898"/>25898:          %% *** Terminate server ***
<a name="25899"/>25899:          #{desc =&gt; &quot;order client terminate&quot;,
<a name="25900"/>25900:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="25901"/>25901:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="25902"/>25902:                            ok
<a name="25903"/>25903:                    end},
<a name="25904"/>25904:          #{desc =&gt; &quot;await client down&quot;,
<a name="25905"/>25905:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="25906"/>25906:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="25907"/>25907:                            State1 = maps:remove(client,    State),
<a name="25908"/>25908:                            {ok, State1}
<a name="25909"/>25909:                    end},
<a name="25910"/>25910:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="25911"/>25911:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25912"/>25912:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25913"/>25913:                            ok
<a name="25914"/>25914:                    end},
<a name="25915"/>25915:          #{desc =&gt; &quot;await server down&quot;,
<a name="25916"/>25916:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25917"/>25917:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25918"/>25918:                            State1 = maps:remove(server,    State),
<a name="25919"/>25919:                            State2 = maps:remove(server_sa, State1),
<a name="25920"/>25920:                            {ok, State2}
<a name="25921"/>25921:                    end},
<a name="25922"/>25922: 
<a name="25923"/>25923:          %% *** We are done ***
<a name="25924"/>25924:          ?SEV_FINISH_NORMAL
<a name="25925"/>25925:         ],
<a name="25926"/>25926: 
<a name="25927"/>25927:     i(&quot;create server evaluator&quot;),
<a name="25928"/>25928:     ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="25929"/>25929:     Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="25930"/>25930: 
<a name="25931"/>25931:     i(&quot;create client evaluator&quot;),
<a name="25932"/>25932:     ClientInitState = #{host   =&gt; local_host(),
<a name="25933"/>25933:                         domain =&gt; maps:get(domain, InitState)},
<a name="25934"/>25934:     Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="25935"/>25935: 
<a name="25936"/>25936:     i(&quot;create tester evaluator&quot;),
<a name="25937"/>25937:     TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="25938"/>25938:                                  client =&gt; Client#ev.pid},
<a name="25939"/>25939:     Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="25940"/>25940: 
<a name="25941"/>25941:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_connect_tcp-last_expr"/><a name="25942"/>25942: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="25943"/>25943: 
<a name="25944"/>25944: 
<a name="api_toc_tcp_client_start-1"/><a name="25945"/>25945: <b>api_toc_tcp_client_start</b>(Node) -&gt;
<a name="api_toc_tcp_client_start-last_expr"/><a name="25946"/>25946: <b>    api_toc_tcp_client_start</b>(Node, 5000).
<a name="api_toc_tcp_client_start-2"/><a name="25947"/>25947: <b>api_toc_tcp_client_start</b>(Node, Timeout) -&gt;
<a name="25948"/>25948:     Self = self(),
<a name="25949"/>25949:     Fun  = fun() -&gt; api_toc_tcp_client(Self) end,
<a name="25950"/>25950:     {Pid, MRef} = erlang:spawn_monitor(Node, Fun),
<a name="api_toc_tcp_client_start-last_expr"/><a name="25951"/>25951:     receive
<a name="25952"/>25952:         {Pid, started} -&gt;
<a name="25953"/>25953:             Pid;
<a name="25954"/>25954:         {'DOWN', MRef, process, Pid, Reason} -&gt;
<a name="25955"/>25955:             {error, Reason};
<a name="25956"/>25956:         {nodedown, Node} = NODEDOWN -&gt;
<a name="25957"/>25957:             {error, NODEDOWN}
<a name="25958"/>25958:     after Timeout -&gt;
<a name="25959"/>25959:             {error, timeout}
<a name="25960"/>25960:     end.
<a name="25961"/>25961: 
<a name="api_toc_tcp_client-1"/><a name="25962"/>25962: <b>api_toc_tcp_client</b>(Parent) -&gt;
<a name="25963"/>25963:     api_toc_tcp_client_init(Parent),
<a name="25964"/>25964:     ServerSA = api_toc_tcp_client_await_start(Parent),
<a name="25965"/>25965:     Domain   = maps:get(family, ServerSA),
<a name="25966"/>25966:     api_toc_tcp_client_announce_ready(Parent, init),
<a name="25967"/>25967:     {To, ConLimit} = api_toc_tcp_client_await_continue(Parent, connect),
<a name="25968"/>25968:     Result = api_to_connect_tcp_await_timeout(To, ServerSA, Domain, ConLimit),
<a name="25969"/>25969:     ?SEV_IPRINT(&quot;(client) connect result: ~p&quot;, [Result]),
<a name="25970"/>25970:     api_toc_tcp_client_announce_ready(Parent, connect, Result),
<a name="25971"/>25971:     Reason = api_toc_tcp_client_await_terminate(Parent),
<a name="api_toc_tcp_client-last_expr"/><a name="25972"/>25972: <b>    exit</b>(Reason).
<a name="25973"/>25973: 
<a name="api_toc_tcp_client_init-1"/><a name="25974"/>25974: <b>api_toc_tcp_client_init</b>(Parent) -&gt;
<a name="25975"/>25975:     put(sname, &quot;rclient&quot;),
<a name="25976"/>25976:     %% i(&quot;api_toc_tcp_client_init -&gt; entry&quot;),
<a name="25977"/>25977:     _MRef = erlang:monitor(process, Parent),
<a name="25978"/>25978:     Parent ! {self(), started},
<a name="api_toc_tcp_client_init-last_expr"/><a name="25979"/>25979:     ok.
<a name="25980"/>25980: 
<a name="api_toc_tcp_client_await_start-1"/><a name="25981"/>25981: <b>api_toc_tcp_client_await_start</b>(Parent) -&gt;
<a name="25982"/>25982:     %% i(&quot;api_toc_tcp_client_await_start -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_start-last_expr"/><a name="25983"/>25983: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="25984"/>25984: 
<a name="api_toc_tcp_client_announce_ready-2"/><a name="25985"/>25985: <b>api_toc_tcp_client_announce_ready</b>(Parent, Slogan) -&gt;
<a name="api_toc_tcp_client_announce_ready-last_expr"/><a name="25986"/>25986: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="api_toc_tcp_client_announce_ready-3"/><a name="25987"/>25987: <b>api_toc_tcp_client_announce_ready</b>(Parent, Slogan, Result) -&gt;
<a name="api_toc_tcp_client_announce_ready-last_expr"/><a name="25988"/>25988: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan, Result).
<a name="25989"/>25989: 
<a name="api_toc_tcp_client_await_continue-2"/><a name="25990"/>25990: <b>api_toc_tcp_client_await_continue</b>(Parent, Slogan) -&gt;
<a name="25991"/>25991:     %% i(&quot;api_toc_tcp_client_await_continue -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_continue-last_expr"/><a name="25992"/>25992: <b>    case ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan) of
<a name="25993"/>25993:         ok -&gt;
<a name="25994"/>25994:             ok;
<a name="25995"/>25995:         {ok, Extra} -&gt;
<a name="25996"/>25996:             Extra;
<a name="25997"/>25997:         {error, Reason} -&gt;
<a name="25998"/>25998:             exit({await_continue, Slogan, Reason})
<a name="25999"/>25999:     end.
<a name="26000"/>26000: 
<a name="api_toc_tcp_client_await_terminate-1"/><a name="26001"/>26001: <b>api_toc_tcp_client_await_terminate</b>(Parent) -&gt;
<a name="26002"/>26002:     %% i(&quot;api_toc_tcp_client_await_terminate -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_terminate-last_expr"/><a name="26003"/>26003: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="26004"/>26004:         ok -&gt;
<a name="26005"/>26005:             ok;
<a name="26006"/>26006:         {error, Reason} -&gt;
<a name="26007"/>26007:             Reason
<a name="26008"/>26008:     end.
<a name="26009"/>26009: 
<a name="api_to_connect_tcp_await_timeout-4"/><a name="26010"/>26010: <b>api_to_connect_tcp_await_timeout</b>(To, ServerSA, Domain, ConLimit) -&gt;
<a name="26011"/>26011:     LSA = which_local_socket_addr(Domain),
<a name="26012"/>26012:     NewSock = fun() -&gt;
<a name="26013"/>26013:                       S = case socket:open(Domain, stream, tcp) of
<a name="26014"/>26014:                               {ok, Sock} -&gt;
<a name="26015"/>26015:                                   Sock;
<a name="26016"/>26016:                               {error, OReason} -&gt;
<a name="26017"/>26017:                                   ?FAIL({open, OReason})
<a name="26018"/>26018:                           end,
<a name="26019"/>26019:                       case socket:bind(S, LSA) of
<a name="26020"/>26020:                           ok -&gt;
<a name="26021"/>26021:                               S;
<a name="26022"/>26022:                           {error, BReason} -&gt;
<a name="26023"/>26023:                               ?FAIL({bind, BReason})
<a name="26024"/>26024:                       end
<a name="26025"/>26025:               end,
<a name="api_to_connect_tcp_await_timeout-last_expr"/><a name="26026"/>26026: <b>    api_to_connect_tcp_await_timeout</b>(1, ConLimit, To, ServerSA, NewSock, []).
<a name="26027"/>26027: 
<a name="api_to_connect_tcp_await_timeout-6"/><a name="26028"/>26028: <b>api_to_connect_tcp_await_timeout</b>(ID, ConLimit, _To, _ServerSA, _NewSock, Acc)
<a name="26029"/>26029:   when (ID &gt; ConLimit) -&gt;
<a name="26030"/>26030:     api_to_connect_tcp_await_timeout3(Acc),
<a name="26031"/>26031:     {error, {connect_limit_reached, ID, ConLimit}};
<a name="26032"/>26032: <b>api_to_connect_tcp_await_timeout</b>(ID, ConLimit, To, ServerSA, NewSock, Acc) -&gt;
<a name="api_to_connect_tcp_await_timeout-last_expr"/><a name="26033"/>26033: <b>    case api_to_connect_tcp_await_timeout2</b>(ID, To, ServerSA, NewSock) of
<a name="26034"/>26034:         ok -&gt;
<a name="26035"/>26035:             %% ?SEV_IPRINT(&quot;success when number of socks: ~w&quot;, [length(Acc)]),
<a name="26036"/>26036:             api_to_connect_tcp_await_timeout3(Acc),
<a name="26037"/>26037:             ok;
<a name="26038"/>26038:         {ok, Sock} -&gt;
<a name="26039"/>26039:             %% ?SEV_IPRINT(&quot;~w: unexpected success (connect)&quot;, [ID]),
<a name="26040"/>26040:             api_to_connect_tcp_await_timeout(ID+1, ConLimit,
<a name="26041"/>26041:                                              To, ServerSA, NewSock,
<a name="26042"/>26042:                                              [Sock|Acc]);
<a name="26043"/>26043:         {error, _} = ERROR -&gt;
<a name="26044"/>26044:             ERROR
<a name="26045"/>26045:     end.
<a name="26046"/>26046: 
<a name="api_to_connect_tcp_await_timeout2-4"/><a name="26047"/>26047: <b>api_to_connect_tcp_await_timeout2</b>(_ID, To, ServerSA, NewSock) -&gt;
<a name="26048"/>26048:     Sock = NewSock(),
<a name="26049"/>26049:     %% ?SEV_IPRINT(&quot;~w: try connect&quot;, [ID]),
<a name="26050"/>26050:     Start = ?TS(),
<a name="api_to_connect_tcp_await_timeout2-last_expr"/><a name="26051"/>26051: <b>    case socket:connect</b>(Sock, ServerSA, To) of
<a name="26052"/>26052:         {error, timeout} -&gt;
<a name="26053"/>26053:             Stop  = ?TS(),
<a name="26054"/>26054:             TDiff = Stop - Start,
<a name="26055"/>26055:             if
<a name="26056"/>26056:                 (TDiff &gt;= To) -&gt;
<a name="26057"/>26057:                     (catch socket:close(Sock)),
<a name="26058"/>26058:                     ok;
<a name="26059"/>26059:                 true -&gt;
<a name="26060"/>26060:                     (catch socket:close(Sock)),
<a name="26061"/>26061:                     ?FAIL({unexpected_timeout, TDiff, To})
<a name="26062"/>26062:             end;
<a name="26063"/>26063:         {error, econnreset = _Reason} -&gt;
<a name="26064"/>26064:             (catch socket:close(Sock)),
<a name="26065"/>26065:             ok;
<a name="26066"/>26066:         {error, Reason} -&gt;
<a name="26067"/>26067:             (catch socket:close(Sock)),
<a name="26068"/>26068:             ?FAIL({connect, Reason});
<a name="26069"/>26069:         ok -&gt;
<a name="26070"/>26070:             {ok, Sock}
<a name="26071"/>26071:     end.
<a name="26072"/>26072: 
<a name="api_to_connect_tcp_await_timeout3-1"/><a name="26073"/>26073: <b>api_to_connect_tcp_await_timeout3</b>([]) -&gt;
<a name="26074"/>26074:     ok;
<a name="26075"/>26075: <b>api_to_connect_tcp_await_timeout3</b>([Sock|Socka]) -&gt;
<a name="26076"/>26076:     (catch socket:close(Sock)),
<a name="api_to_connect_tcp_await_timeout3-last_expr"/><a name="26077"/>26077: <b>    api_to_connect_tcp_await_timeout3</b>(Socka).
<a name="26078"/>26078: 
<a name="26079"/>26079: 
<a name="26080"/>26080: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26081"/>26081: 
<a name="26082"/>26082: <i>%% This test case is intended to test the accept timeout option</i>
<a name="26083"/>26083: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_accept_tcp4-1"/><a name="26084"/>26084: <b>api_to_accept_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26085"/>26085:     ?TT(?SECS(10)),
<a name="api_to_accept_tcp4-last_expr"/><a name="26086"/>26086: <b>    tc_try</b>(api_to_accept_tcp4,
<a name="26087"/>26087:            fun() -&gt; has_support_ipv4() end,
<a name="26088"/>26088:            fun() -&gt;
<a name="26089"/>26089:                    InitState = #{domain =&gt; inet, timeout =&gt; 5000},
<a name="26090"/>26090:                    ok = api_to_accept_tcp(InitState)
<a name="26091"/>26091:            end).
<a name="26092"/>26092: 
<a name="26093"/>26093: 
<a name="26094"/>26094: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26095"/>26095: 
<a name="26096"/>26096: <i>%% This test case is intended to test the accept timeout option</i>
<a name="26097"/>26097: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_accept_tcp6-1"/><a name="26098"/>26098: <b>api_to_accept_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="26099"/>26099:     ?TT(?SECS(10)),
<a name="api_to_accept_tcp6-last_expr"/><a name="26100"/>26100: <b>    tc_try</b>(api_to_accept_tcp6,
<a name="26101"/>26101:            fun() -&gt; has_support_ipv6() end,
<a name="26102"/>26102:            fun() -&gt;
<a name="26103"/>26103:                    InitState = #{domain =&gt; inet6, timeout =&gt; 5000},
<a name="26104"/>26104:                    ok = api_to_accept_tcp(InitState)
<a name="26105"/>26105:            end).
<a name="26106"/>26106: 
<a name="26107"/>26107: 
<a name="26108"/>26108: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26109"/>26109: 
<a name="api_to_accept_tcp-1"/><a name="26110"/>26110: <b>api_to_accept_tcp</b>(InitState) -&gt;
<a name="26111"/>26111:     TesterSeq =
<a name="26112"/>26112:         [
<a name="26113"/>26113:          %% *** Init part ***
<a name="26114"/>26114:          #{desc =&gt; &quot;which local address&quot;,
<a name="26115"/>26115:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26116"/>26116:                            LSA = which_local_socket_addr(Domain),
<a name="26117"/>26117:                            {ok, State#{lsa =&gt; LSA}}
<a name="26118"/>26118:                    end},
<a name="26119"/>26119:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="26120"/>26120:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26121"/>26121:                            case socket:open(Domain, stream, tcp) of
<a name="26122"/>26122:                                {ok, Sock} -&gt;
<a name="26123"/>26123:                                    {ok, State#{lsock =&gt; Sock}};
<a name="26124"/>26124:                                {error, _} = ERROR -&gt;
<a name="26125"/>26125:                                    ERROR
<a name="26126"/>26126:                            end
<a name="26127"/>26127:                    end},
<a name="26128"/>26128:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26129"/>26129:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = _State) -&gt;
<a name="26130"/>26130:                            case sock_bind(LSock, LSA) of
<a name="26131"/>26131:                                ok -&gt;
<a name="26132"/>26132:                                    ok;
<a name="26133"/>26133:                                {error, _} = ERROR -&gt;
<a name="26134"/>26134:                                    ERROR
<a name="26135"/>26135:                            end
<a name="26136"/>26136:                    end},
<a name="26137"/>26137:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="26138"/>26138:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="26139"/>26139:                            socket:listen(LSock)
<a name="26140"/>26140:                    end},
<a name="26141"/>26141: 
<a name="26142"/>26142:          %% *** The actual test part ***
<a name="26143"/>26143:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="26144"/>26144:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="26145"/>26145:                            Start = ?TS(),
<a name="26146"/>26146:                            case socket:accept(LSock, To) of
<a name="26147"/>26147:                                {error, timeout} -&gt;
<a name="26148"/>26148:                                    {ok, State#{start =&gt; Start, stop =&gt; ?TS()}};
<a name="26149"/>26149:                                {ok, Sock} -&gt;
<a name="26150"/>26150:                                    (catch socket:close(Sock)),
<a name="26151"/>26151:                                    {error, unexpected_success};
<a name="26152"/>26152:                                {error, _} = ERROR -&gt;
<a name="26153"/>26153:                                    ERROR
<a name="26154"/>26154:                            end
<a name="26155"/>26155:                    end},
<a name="26156"/>26156:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="26157"/>26157:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="26158"/>26158:                            TDiff  = Stop - Start,
<a name="26159"/>26159:                            if
<a name="26160"/>26160:                                (TDiff &gt;= To) -&gt;
<a name="26161"/>26161:                                    ok;
<a name="26162"/>26162:                                true -&gt;
<a name="26163"/>26163:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="26164"/>26164:                            end
<a name="26165"/>26165:                    end},
<a name="26166"/>26166: 
<a name="26167"/>26167:          %% *** Close (listen) socket ***
<a name="26168"/>26168:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="26169"/>26169:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="26170"/>26170:                            sock_close(LSock),
<a name="26171"/>26171:                            {ok, maps:remove(sock3, State)}
<a name="26172"/>26172:                    end},
<a name="26173"/>26173: 
<a name="26174"/>26174:          %% *** We are done ***
<a name="26175"/>26175:          ?SEV_FINISH_NORMAL
<a name="26176"/>26176:         ],
<a name="26177"/>26177: 
<a name="26178"/>26178:     i(&quot;create tester evaluator&quot;),
<a name="26179"/>26179:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="26180"/>26180: 
<a name="26181"/>26181:     i(&quot;await evaluator&quot;),
<a name="api_to_accept_tcp-last_expr"/><a name="26182"/>26182: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="26183"/>26183: 
<a name="26184"/>26184: 
<a name="26185"/>26185: 
<a name="26186"/>26186: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26187"/>26187: 
<a name="26188"/>26188: <i>%% This test case is intended to test the multi accept timeout option</i>
<a name="26189"/>26189: <i>%% on an IPv4 TCP (stream) socket with multiple acceptor processes </i>
<a name="26190"/>26190: <i>%% (three in this case).</i>
<a name="api_to_maccept_tcp4-1"/><a name="26191"/>26191: <b>api_to_maccept_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26192"/>26192:     ?TT(?SECS(20)),
<a name="api_to_maccept_tcp4-last_expr"/><a name="26193"/>26193: <b>    tc_try</b>(api_to_maccept_tcp4,
<a name="26194"/>26194:            fun() -&gt; has_support_ipv4() end,
<a name="26195"/>26195:            fun() -&gt;
<a name="26196"/>26196:                    InitState = #{domain =&gt; inet, timeout =&gt; 5000},
<a name="26197"/>26197:                    ok = api_to_maccept_tcp(InitState)
<a name="26198"/>26198:            end).
<a name="26199"/>26199: 
<a name="26200"/>26200: 
<a name="26201"/>26201: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26202"/>26202: 
<a name="26203"/>26203: <i>%% This test case is intended to test the accept timeout option</i>
<a name="26204"/>26204: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_maccept_tcp6-1"/><a name="26205"/>26205: <b>api_to_maccept_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="26206"/>26206:     ?TT(?SECS(20)),
<a name="api_to_maccept_tcp6-last_expr"/><a name="26207"/>26207: <b>    tc_try</b>(api_to_maccept_tcp6,
<a name="26208"/>26208:            fun() -&gt; has_support_ipv6() end,
<a name="26209"/>26209:            fun() -&gt;
<a name="26210"/>26210:                    InitState = #{domain =&gt; inet6, timeout =&gt; 5000},
<a name="26211"/>26211:                    ok = api_to_maccept_tcp(InitState)
<a name="26212"/>26212:            end).
<a name="26213"/>26213: 
<a name="26214"/>26214: 
<a name="26215"/>26215: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26216"/>26216: 
<a name="api_to_maccept_tcp-1"/><a name="26217"/>26217: <b>api_to_maccept_tcp</b>(InitState) -&gt;
<a name="26218"/>26218:     PrimAcceptorSeq =
<a name="26219"/>26219:         [
<a name="26220"/>26220:          %% *** Init part ***
<a name="26221"/>26221:          #{desc =&gt; &quot;await start&quot;,
<a name="26222"/>26222:            cmd  =&gt; fun(State) -&gt;
<a name="26223"/>26223:                            Tester = ?SEV_AWAIT_START(),
<a name="26224"/>26224:                            {ok, State#{tester =&gt; Tester}}
<a name="26225"/>26225:                    end},
<a name="26226"/>26226:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26227"/>26227:            cmd  =&gt; fun(#{tester := Pid} = _State) -&gt;
<a name="26228"/>26228:                            _MRef = erlang:monitor(process, Pid),
<a name="26229"/>26229:                            ok
<a name="26230"/>26230:                    end},
<a name="26231"/>26231:          #{desc =&gt; &quot;which local address&quot;,
<a name="26232"/>26232:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26233"/>26233:                            LSA = which_local_socket_addr(Domain),
<a name="26234"/>26234:                            {ok, State#{lsa =&gt; LSA}}
<a name="26235"/>26235:                    end},
<a name="26236"/>26236:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="26237"/>26237:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26238"/>26238:                            case socket:open(Domain, stream, tcp) of
<a name="26239"/>26239:                                {ok, Sock} -&gt;
<a name="26240"/>26240:                                    {ok, State#{lsock =&gt; Sock}};
<a name="26241"/>26241:                                {error, _} = ERROR -&gt;
<a name="26242"/>26242:                                    ERROR
<a name="26243"/>26243:                            end
<a name="26244"/>26244:                    end},
<a name="26245"/>26245:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26246"/>26246:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = _State) -&gt;
<a name="26247"/>26247:                            case sock_bind(LSock, LSA) of
<a name="26248"/>26248:                                ok -&gt;
<a name="26249"/>26249:                                    ok;
<a name="26250"/>26250:                                {error, _} = ERROR -&gt;
<a name="26251"/>26251:                                    ERROR
<a name="26252"/>26252:                            end
<a name="26253"/>26253:                    end},
<a name="26254"/>26254:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="26255"/>26255:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="26256"/>26256:                            socket:listen(LSock)
<a name="26257"/>26257:                    end},
<a name="26258"/>26258:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26259"/>26259:            cmd  =&gt; fun(#{lsock := LSock, tester := Tester}) -&gt;
<a name="26260"/>26260:                            ?SEV_ANNOUNCE_READY(Tester, init, LSock),
<a name="26261"/>26261:                            ok
<a name="26262"/>26262:                    end},
<a name="26263"/>26263: 
<a name="26264"/>26264:          %% *** The actual test ***
<a name="26265"/>26265:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="26266"/>26266:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26267"/>26267:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="26268"/>26268:                    end},
<a name="26269"/>26269:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="26270"/>26270:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="26271"/>26271:                            Start = ?TS(),
<a name="26272"/>26272:                            case socket:accept(LSock, To) of
<a name="26273"/>26273:                                {error, timeout} -&gt;
<a name="26274"/>26274:                                    {ok, State#{start =&gt; Start, stop =&gt; ?TS()}};
<a name="26275"/>26275:                                {ok, Sock} -&gt;
<a name="26276"/>26276:                                    ?SEV_EPRINT(&quot;Unexpected accept success: &quot;
<a name="26277"/>26277:                                                &quot;~n   ~p&quot;, [Sock]),
<a name="26278"/>26278:                                    (catch socket:close(Sock)),
<a name="26279"/>26279:                                    {error, unexpected_success};
<a name="26280"/>26280:                                {error, _} = ERROR -&gt;
<a name="26281"/>26281:                                    ERROR
<a name="26282"/>26282:                            end
<a name="26283"/>26283:                    end},
<a name="26284"/>26284:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="26285"/>26285:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="26286"/>26286:                            TDiff  = Stop - Start,
<a name="26287"/>26287:                            if
<a name="26288"/>26288:                                (TDiff &gt;= To) -&gt;
<a name="26289"/>26289:                                    ok;
<a name="26290"/>26290:                                true -&gt;
<a name="26291"/>26291:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="26292"/>26292:                            end
<a name="26293"/>26293:                    end},
<a name="26294"/>26294:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="26295"/>26295:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26296"/>26296:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="26297"/>26297:                            ok
<a name="26298"/>26298:                    end},
<a name="26299"/>26299: 
<a name="26300"/>26300:          %% *** Terminate ***
<a name="26301"/>26301:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26302"/>26302:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26303"/>26303:                            ?SEV_AWAIT_TERMINATE(Tester, tester),
<a name="26304"/>26304:                            ok
<a name="26305"/>26305:                    end},
<a name="26306"/>26306:          %% *** Close (listen) socket ***
<a name="26307"/>26307:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="26308"/>26308:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="26309"/>26309:                            sock_close(LSock),
<a name="26310"/>26310:                            {ok, maps:remove(lsock, State)}
<a name="26311"/>26311:                    end},
<a name="26312"/>26312: 
<a name="26313"/>26313:          %% *** We are done ***
<a name="26314"/>26314:          ?SEV_FINISH_NORMAL
<a name="26315"/>26315:         ],
<a name="26316"/>26316: 
<a name="26317"/>26317: 
<a name="26318"/>26318:     SecAcceptorSeq =
<a name="26319"/>26319:         [
<a name="26320"/>26320:          %% *** Init part ***
<a name="26321"/>26321:          #{desc =&gt; &quot;await start&quot;,
<a name="26322"/>26322:            cmd  =&gt; fun(State) -&gt;
<a name="26323"/>26323:                            {Tester, LSock} = ?SEV_AWAIT_START(),
<a name="26324"/>26324:                            {ok, State#{tester =&gt; Tester,
<a name="26325"/>26325:                                        lsock  =&gt; LSock}}
<a name="26326"/>26326:                            
<a name="26327"/>26327:                    end},
<a name="26328"/>26328:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26329"/>26329:            cmd  =&gt; fun(#{tester := Pid} = _State) -&gt;
<a name="26330"/>26330:                            _MRef = erlang:monitor(process, Pid),
<a name="26331"/>26331:                            ok
<a name="26332"/>26332:                    end},
<a name="26333"/>26333:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26334"/>26334:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26335"/>26335:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="26336"/>26336:                            ok
<a name="26337"/>26337:                    end},
<a name="26338"/>26338: 
<a name="26339"/>26339:          %% *** The actual test part ***
<a name="26340"/>26340:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="26341"/>26341:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26342"/>26342:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="26343"/>26343:                    end},
<a name="26344"/>26344:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="26345"/>26345:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="26346"/>26346:                            Start = ?TS(),
<a name="26347"/>26347:                            case socket:accept(LSock, To) of
<a name="26348"/>26348:                                {error, timeout} -&gt;
<a name="26349"/>26349:                                    {ok, State#{start =&gt; Start, stop =&gt; ?TS()}};
<a name="26350"/>26350:                                {ok, Sock} -&gt;
<a name="26351"/>26351:                                    (catch socket:close(Sock)),
<a name="26352"/>26352:                                    {error, unexpected_success};
<a name="26353"/>26353:                                {error, _} = ERROR -&gt;
<a name="26354"/>26354:                                    ERROR
<a name="26355"/>26355:                            end
<a name="26356"/>26356:                    end},
<a name="26357"/>26357:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="26358"/>26358:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = State) -&gt;
<a name="26359"/>26359:                            TDiff  = Stop - Start,
<a name="26360"/>26360:                            if
<a name="26361"/>26361:                                (TDiff &gt;= To) -&gt;
<a name="26362"/>26362:                                    State1 = maps:remove(start, State),
<a name="26363"/>26363:                                    State2 = maps:remove(stop,  State1),
<a name="26364"/>26364:                                    {ok, State2};
<a name="26365"/>26365:                                true -&gt;
<a name="26366"/>26366:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="26367"/>26367:                            end
<a name="26368"/>26368:                    end},
<a name="26369"/>26369:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="26370"/>26370:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26371"/>26371:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="26372"/>26372:                            ok
<a name="26373"/>26373:                    end},
<a name="26374"/>26374: 
<a name="26375"/>26375:          %% *** Terminate ***
<a name="26376"/>26376:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26377"/>26377:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="26378"/>26378:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="26379"/>26379:                                ok -&gt;
<a name="26380"/>26380:                                    {ok, maps:remove(tester, State)};
<a name="26381"/>26381:                                {error, _} = ERROR -&gt;
<a name="26382"/>26382:                                    ERROR
<a name="26383"/>26383:                            end
<a name="26384"/>26384:                    end},
<a name="26385"/>26385: 
<a name="26386"/>26386:          %% *** We are done ***
<a name="26387"/>26387:          ?SEV_FINISH_NORMAL
<a name="26388"/>26388:         ],
<a name="26389"/>26389: 
<a name="26390"/>26390: 
<a name="26391"/>26391:     TesterSeq =
<a name="26392"/>26392:         [
<a name="26393"/>26393:          %% Init part
<a name="26394"/>26394:          #{desc =&gt; &quot;monitor prim-acceptor&quot;,
<a name="26395"/>26395:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26396"/>26396:                            _MRef = erlang:monitor(process, Pid),
<a name="26397"/>26397:                            ok
<a name="26398"/>26398:                    end},
<a name="26399"/>26399:          #{desc =&gt; &quot;monitor sec-acceptor 1&quot;,
<a name="26400"/>26400:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26401"/>26401:                            _MRef = erlang:monitor(process, Pid),
<a name="26402"/>26402:                            ok
<a name="26403"/>26403:                    end},
<a name="26404"/>26404:          #{desc =&gt; &quot;monitor sec-acceptor 2&quot;,
<a name="26405"/>26405:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26406"/>26406:                            _MRef = erlang:monitor(process, Pid),
<a name="26407"/>26407:                            ok
<a name="26408"/>26408:                    end},
<a name="26409"/>26409: 
<a name="26410"/>26410: 
<a name="26411"/>26411:          %% Start the prim-acceptor
<a name="26412"/>26412:          #{desc =&gt; &quot;start prim-acceptor&quot;,
<a name="26413"/>26413:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26414"/>26414:                            ?SEV_ANNOUNCE_START(Pid),
<a name="26415"/>26415:                            ok
<a name="26416"/>26416:                    end},
<a name="26417"/>26417:          #{desc =&gt; &quot;await prim-acceptor ready (init)&quot;,
<a name="26418"/>26418:            cmd  =&gt; fun(#{prim_acceptor := Pid} = State) -&gt;
<a name="26419"/>26419:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, prim_acceptor, init),
<a name="26420"/>26420:                            {ok, State#{lsock =&gt; Sock}}
<a name="26421"/>26421:                    end},
<a name="26422"/>26422: 
<a name="26423"/>26423:          %% Start sec-acceptor-1
<a name="26424"/>26424:          #{desc =&gt; &quot;start sec-acceptor 1&quot;,
<a name="26425"/>26425:            cmd  =&gt; fun(#{sec_acceptor1 := Pid, lsock := LSock} = _State) -&gt;
<a name="26426"/>26426:                            ?SEV_ANNOUNCE_START(Pid, LSock),
<a name="26427"/>26427:                            ok
<a name="26428"/>26428:                    end},
<a name="26429"/>26429:          #{desc =&gt; &quot;await sec-acceptor 1 ready (init)&quot;,
<a name="26430"/>26430:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26431"/>26431:                            ?SEV_AWAIT_READY(Pid, sec_acceptor1, init)
<a name="26432"/>26432:                    end},
<a name="26433"/>26433: 
<a name="26434"/>26434:          %% Start sec-acceptor-2
<a name="26435"/>26435:          #{desc =&gt; &quot;start sec-acceptor 2&quot;,
<a name="26436"/>26436:            cmd  =&gt; fun(#{sec_acceptor2 := Pid, lsock := LSock} = _State) -&gt;
<a name="26437"/>26437:                            ?SEV_ANNOUNCE_START(Pid, LSock),
<a name="26438"/>26438:                            ok
<a name="26439"/>26439:                    end},
<a name="26440"/>26440:          #{desc =&gt; &quot;await sec-acceptor 2 ready (init)&quot;,
<a name="26441"/>26441:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26442"/>26442:                            ?SEV_AWAIT_READY(Pid, sec_acceptor2, init)
<a name="26443"/>26443:                    end},
<a name="26444"/>26444: 
<a name="26445"/>26445:          %% Activate the acceptor(s)
<a name="26446"/>26446:          #{desc =&gt; &quot;active prim-acceptor&quot;,
<a name="26447"/>26447:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26448"/>26448:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="26449"/>26449:                            ok
<a name="26450"/>26450:                    end},
<a name="26451"/>26451:          #{desc =&gt; &quot;active sec-acceptor 1&quot;,
<a name="26452"/>26452:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26453"/>26453:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="26454"/>26454:                            ok
<a name="26455"/>26455:                    end},
<a name="26456"/>26456:          #{desc =&gt; &quot;active sec-acceptor 2&quot;,
<a name="26457"/>26457:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26458"/>26458:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="26459"/>26459:                            ok
<a name="26460"/>26460:                    end},
<a name="26461"/>26461: 
<a name="26462"/>26462:          %% Await acceptor(s) completions
<a name="26463"/>26463:          #{desc =&gt; &quot;await prim-acceptor ready (accept)&quot;,
<a name="26464"/>26464:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26465"/>26465:                            ?SEV_AWAIT_READY(Pid, prim_acceptor, accept)
<a name="26466"/>26466:                    end},
<a name="26467"/>26467:          #{desc =&gt; &quot;await sec-acceptor 1 ready (accept)&quot;,
<a name="26468"/>26468:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26469"/>26469:                            ?SEV_AWAIT_READY(Pid, sec_acceptor1, accept)
<a name="26470"/>26470:                    end},
<a name="26471"/>26471:          #{desc =&gt; &quot;await sec-acceptor 2 ready (accept)&quot;,
<a name="26472"/>26472:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26473"/>26473:                            ?SEV_AWAIT_READY(Pid, sec_acceptor2, accept)
<a name="26474"/>26474:                    end},
<a name="26475"/>26475: 
<a name="26476"/>26476:          %% Terminate
<a name="26477"/>26477:          #{desc =&gt; &quot;order prim-acceptor to terminate&quot;,
<a name="26478"/>26478:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="26479"/>26479:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="26480"/>26480:                            ok
<a name="26481"/>26481:                    end},
<a name="26482"/>26482:          #{desc =&gt; &quot;await prim-acceptor termination&quot;,
<a name="26483"/>26483:            cmd  =&gt; fun(#{prim_acceptor := Pid} = State) -&gt;
<a name="26484"/>26484:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="26485"/>26485:                                ok -&gt;
<a name="26486"/>26486:                                    State1 = maps:remove(prim_acceptor, State),
<a name="26487"/>26487:                                    {ok, State1};
<a name="26488"/>26488:                                {error, _} = ERROR -&gt;
<a name="26489"/>26489:                                    ERROR
<a name="26490"/>26490:                            end
<a name="26491"/>26491:                    end},
<a name="26492"/>26492:          #{desc =&gt; &quot;order sec-acceptor 1 to terminate&quot;,
<a name="26493"/>26493:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="26494"/>26494:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="26495"/>26495:                            ok
<a name="26496"/>26496:                    end},
<a name="26497"/>26497:          #{desc =&gt; &quot;await sec-acceptor 1 termination&quot;,
<a name="26498"/>26498:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = State) -&gt;
<a name="26499"/>26499:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="26500"/>26500:                                ok -&gt;
<a name="26501"/>26501:                                    State1 = maps:remove(sec_acceptor1, State),
<a name="26502"/>26502:                                    {ok, State1};
<a name="26503"/>26503:                                {error, _} = ERROR -&gt;
<a name="26504"/>26504:                                    ERROR
<a name="26505"/>26505:                            end
<a name="26506"/>26506:                    end},
<a name="26507"/>26507:          #{desc =&gt; &quot;order sec-acceptor 2 to terminate&quot;,
<a name="26508"/>26508:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="26509"/>26509:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="26510"/>26510:                            ok
<a name="26511"/>26511:                    end},
<a name="26512"/>26512:          #{desc =&gt; &quot;await sec-acceptor 2 termination&quot;,
<a name="26513"/>26513:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = State) -&gt;
<a name="26514"/>26514:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="26515"/>26515:                                ok -&gt;
<a name="26516"/>26516:                                    State1 = maps:remove(sec_acceptor2, State),
<a name="26517"/>26517:                                    {ok, State1};
<a name="26518"/>26518:                                {error, _} = ERROR -&gt;
<a name="26519"/>26519:                                    ERROR
<a name="26520"/>26520:                            end
<a name="26521"/>26521:                    end},
<a name="26522"/>26522:          
<a name="26523"/>26523:          %% *** We are done ***
<a name="26524"/>26524:          ?SEV_FINISH_NORMAL
<a name="26525"/>26525:         ],
<a name="26526"/>26526: 
<a name="26527"/>26527:     i(&quot;create prim-acceptor evaluator&quot;),
<a name="26528"/>26528:     PrimAInitState = InitState,
<a name="26529"/>26529:     PrimAcceptor = ?SEV_START(&quot;prim-acceptor&quot;, PrimAcceptorSeq, PrimAInitState),
<a name="26530"/>26530: 
<a name="26531"/>26531:     i(&quot;create sec-acceptor 1 evaluator&quot;),
<a name="26532"/>26532:     SecAInitState1 = maps:remove(domain, InitState),
<a name="26533"/>26533:     SecAcceptor1 = ?SEV_START(&quot;sec-acceptor-1&quot;, SecAcceptorSeq, SecAInitState1),
<a name="26534"/>26534:     
<a name="26535"/>26535:     i(&quot;create sec-acceptor 2 evaluator&quot;),
<a name="26536"/>26536:     SecAInitState2 = SecAInitState1,
<a name="26537"/>26537:     SecAcceptor2 = ?SEV_START(&quot;sec-acceptor-2&quot;, SecAcceptorSeq, SecAInitState2),
<a name="26538"/>26538: 
<a name="26539"/>26539:     i(&quot;create tester evaluator&quot;),
<a name="26540"/>26540:     TesterInitState = #{prim_acceptor =&gt; PrimAcceptor#ev.pid,
<a name="26541"/>26541:                         sec_acceptor1 =&gt; SecAcceptor1#ev.pid,
<a name="26542"/>26542:                         sec_acceptor2 =&gt; SecAcceptor2#ev.pid},
<a name="26543"/>26543:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="26544"/>26544: 
<a name="26545"/>26545:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_maccept_tcp-last_expr"/><a name="26546"/>26546: <b>    ok = ?SEV_AWAIT_FINISH</b>([PrimAcceptor, SecAcceptor1, SecAcceptor2, Tester]).
<a name="26547"/>26547: 
<a name="26548"/>26548: 
<a name="26549"/>26549: 
<a name="26550"/>26550: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26551"/>26551: 
<a name="26552"/>26552: <i>%% This test case is intended to test the send timeout option</i>
<a name="26553"/>26553: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_send_tcp4-1"/><a name="26554"/>26554: <b>api_to_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_send_tcp4-last_expr"/><a name="26555"/>26555: <b>    tc_try</b>(api_to_send_tcp4,
<a name="26556"/>26556:            fun() -&gt; has_support_ipv4() end,
<a name="26557"/>26557:            fun() -&gt;
<a name="26558"/>26558:                    not_yet_implemented()%% ,
<a name="26559"/>26559:                    %% ok = api_to_send_tcp(inet)
<a name="26560"/>26560:            end).
<a name="26561"/>26561: 
<a name="26562"/>26562: 
<a name="26563"/>26563: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26564"/>26564: 
<a name="26565"/>26565: <i>%% This test case is intended to test the send timeout option</i>
<a name="26566"/>26566: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_send_tcp6-1"/><a name="26567"/>26567: <b>api_to_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_send_tcp6-last_expr"/><a name="26568"/>26568: <b>    tc_try</b>(api_to_send_tcp6,
<a name="26569"/>26569:            fun() -&gt; has_support_ipv6() end,
<a name="26570"/>26570:            fun() -&gt;
<a name="26571"/>26571:                    not_yet_implemented()%% ,
<a name="26572"/>26572:                    %% ok = api_to_send_tcp(inet6)
<a name="26573"/>26573:            end).
<a name="26574"/>26574: 
<a name="26575"/>26575: 
<a name="26576"/>26576: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26577"/>26577: 
<a name="26578"/>26578: <i>%% This test case is intended to test the sendto timeout option</i>
<a name="26579"/>26579: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_sendto_udp4-1"/><a name="26580"/>26580: <b>api_to_sendto_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendto_udp4-last_expr"/><a name="26581"/>26581: <b>    tc_try</b>(api_to_sendto_udp4,
<a name="26582"/>26582:            fun () -&gt; has_support_ipv4() end,
<a name="26583"/>26583:            fun() -&gt;
<a name="26584"/>26584:                    not_yet_implemented()%% ,
<a name="26585"/>26585:                    %% ok = api_to_sendto_to_udp(inet)
<a name="26586"/>26586:            end).
<a name="26587"/>26587: 
<a name="26588"/>26588: 
<a name="26589"/>26589: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26590"/>26590: 
<a name="26591"/>26591: <i>%% This test case is intended to test the sendto timeout option</i>
<a name="26592"/>26592: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_sendto_udp6-1"/><a name="26593"/>26593: <b>api_to_sendto_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendto_udp6-last_expr"/><a name="26594"/>26594: <b>    tc_try</b>(api_to_sendto_udp6,
<a name="26595"/>26595:            fun() -&gt; has_support_ipv6() end,
<a name="26596"/>26596:            fun() -&gt;
<a name="26597"/>26597:                    not_yet_implemented()%% ,
<a name="26598"/>26598:                    %% ok = api_to_sendto_to_udp(inet6)
<a name="26599"/>26599:            end).
<a name="26600"/>26600: 
<a name="26601"/>26601: 
<a name="26602"/>26602: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26603"/>26603: 
<a name="26604"/>26604: <i>%% This test case is intended to test the sendmsg timeout option</i>
<a name="26605"/>26605: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_sendmsg_tcp4-1"/><a name="26606"/>26606: <b>api_to_sendmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendmsg_tcp4-last_expr"/><a name="26607"/>26607: <b>    tc_try</b>(api_to_sendmsg_tcp4,
<a name="26608"/>26608:            fun() -&gt; has_support_ipv4() end,
<a name="26609"/>26609:            fun() -&gt;
<a name="26610"/>26610:                    not_yet_implemented()%% ,
<a name="26611"/>26611:                    %% ok = api_to_sendmsg_tcp(inet)
<a name="26612"/>26612:            end).
<a name="26613"/>26613: 
<a name="26614"/>26614: 
<a name="26615"/>26615: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26616"/>26616: 
<a name="26617"/>26617: <i>%% This test case is intended to test the sendmsg timeout option</i>
<a name="26618"/>26618: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_sendmsg_tcp6-1"/><a name="26619"/>26619: <b>api_to_sendmsg_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendmsg_tcp6-last_expr"/><a name="26620"/>26620: <b>    tc_try</b>(api_to_sendmsg_tcp6,
<a name="26621"/>26621:            fun() -&gt; has_support_ipv6() end,
<a name="26622"/>26622:            fun() -&gt;
<a name="26623"/>26623:                    not_yet_implemented()%% ,
<a name="26624"/>26624:                    %% ok = api_to_sendmsg_tcp(inet6)
<a name="26625"/>26625:            end).
<a name="26626"/>26626: 
<a name="26627"/>26627: 
<a name="26628"/>26628: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26629"/>26629: 
<a name="26630"/>26630: <i>%% This test case is intended to test the recv timeout option</i>
<a name="26631"/>26631: <i>%% on an IPv4 UDP (dgram) socket. To test this we must connect</i>
<a name="26632"/>26632: <i>%% the socket.</i>
<a name="api_to_recv_udp4-1"/><a name="26633"/>26633: <b>api_to_recv_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_recv_udp4-last_expr"/><a name="26634"/>26634: <b>    tc_try</b>(api_to_recv_udp4,
<a name="26635"/>26635:            fun() -&gt; has_support_ipv4() end,
<a name="26636"/>26636:            fun() -&gt;
<a name="26637"/>26637:                    not_yet_implemented()%%,
<a name="26638"/>26638:                    %%ok = api_to_recv_udp(inet)
<a name="26639"/>26639:            end).
<a name="26640"/>26640: 
<a name="26641"/>26641: 
<a name="26642"/>26642: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26643"/>26643: 
<a name="26644"/>26644: <i>%% This test case is intended to test the recv timeout option</i>
<a name="26645"/>26645: <i>%% on an IPv6 UDP (dgram) socket. To test this we must connect</i>
<a name="26646"/>26646: <i>%% the socket.</i>
<a name="api_to_recv_udp6-1"/><a name="26647"/>26647: <b>api_to_recv_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_recv_udp6-last_expr"/><a name="26648"/>26648: <b>    tc_try</b>(api_to_recv_udp6,
<a name="26649"/>26649:            fun() -&gt; has_support_ipv6() end,
<a name="26650"/>26650:            fun() -&gt;
<a name="26651"/>26651:                    not_yet_implemented()%% ,
<a name="26652"/>26652:                    %% ok = api_to_recv_udp(inet6)
<a name="26653"/>26653:            end).
<a name="26654"/>26654: 
<a name="26655"/>26655: 
<a name="26656"/>26656: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26657"/>26657: 
<a name="26658"/>26658: <i>%% This test case is intended to test the recv timeout option</i>
<a name="26659"/>26659: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_recv_tcp4-1"/><a name="26660"/>26660: <b>api_to_recv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26661"/>26661:     ?TT(?SECS(10)),
<a name="api_to_recv_tcp4-last_expr"/><a name="26662"/>26662: <b>    tc_try</b>(api_to_recv_tcp4,
<a name="26663"/>26663:            fun() -&gt; has_support_ipv4() end,
<a name="26664"/>26664:            fun() -&gt;
<a name="26665"/>26665:                    Recv = fun(Sock, To) -&gt; socket:recv(Sock, 0, To) end,
<a name="26666"/>26666:                    InitState = #{domain  =&gt; inet,
<a name="26667"/>26667:                                  recv    =&gt; Recv,
<a name="26668"/>26668:                                  timeout =&gt; 2000},
<a name="26669"/>26669:                    ok = api_to_receive_tcp(InitState)
<a name="26670"/>26670:            end).
<a name="26671"/>26671: 
<a name="26672"/>26672: 
<a name="26673"/>26673: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26674"/>26674: 
<a name="26675"/>26675: <i>%% This test case is intended to test the recv timeout option</i>
<a name="26676"/>26676: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_recv_tcp6-1"/><a name="26677"/>26677: <b>api_to_recv_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="26678"/>26678:     ?TT(?SECS(10)),
<a name="api_to_recv_tcp6-last_expr"/><a name="26679"/>26679: <b>    tc_try</b>(api_to_recv_tcp6,
<a name="26680"/>26680:            fun() -&gt; has_support_ipv6() end,
<a name="26681"/>26681:            fun() -&gt;
<a name="26682"/>26682:                    case socket:is_supported(ipv6) of
<a name="26683"/>26683:                        true -&gt;
<a name="26684"/>26684:                            Recv = fun(Sock, To) -&gt; 
<a name="26685"/>26685:                                           socket:recv(Sock, 0, To)
<a name="26686"/>26686:                                   end,
<a name="26687"/>26687:                            InitState = #{domain  =&gt; inet6,
<a name="26688"/>26688:                                          recv    =&gt; Recv,
<a name="26689"/>26689:                                          timeout =&gt; 2000},
<a name="26690"/>26690:                            ok = api_to_receive_tcp(InitState);
<a name="26691"/>26691:                        false -&gt;
<a name="26692"/>26692:                            skip(&quot;ipv6 not supported&quot;)
<a name="26693"/>26693:                    end
<a name="26694"/>26694:            end).
<a name="26695"/>26695: 
<a name="26696"/>26696: 
<a name="26697"/>26697: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26698"/>26698: 
<a name="api_to_receive_tcp-1"/><a name="26699"/>26699: <b>api_to_receive_tcp</b>(InitState) -&gt;
<a name="26700"/>26700:     process_flag(trap_exit, true),
<a name="26701"/>26701: 
<a name="26702"/>26702:     ServerSeq = 
<a name="26703"/>26703:         [
<a name="26704"/>26704:          %% *** Wait for start order ***
<a name="26705"/>26705:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="26706"/>26706:            cmd  =&gt; fun(State) -&gt;
<a name="26707"/>26707:                            Tester = ?SEV_AWAIT_START(),
<a name="26708"/>26708:                            {ok, State#{tester =&gt; Tester}}
<a name="26709"/>26709:                    end},
<a name="26710"/>26710:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26711"/>26711:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26712"/>26712:                            _MRef = erlang:monitor(process, Tester),
<a name="26713"/>26713:                            ok
<a name="26714"/>26714:                    end},
<a name="26715"/>26715: 
<a name="26716"/>26716:          %% *** Init part ***
<a name="26717"/>26717:          #{desc =&gt; &quot;which local address&quot;,
<a name="26718"/>26718:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26719"/>26719:                            LSA = which_local_socket_addr(Domain),
<a name="26720"/>26720:                            {ok, State#{local_sa =&gt; LSA}}
<a name="26721"/>26721:                    end},
<a name="26722"/>26722:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="26723"/>26723:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26724"/>26724:                            case socket:open(Domain, stream, tcp) of
<a name="26725"/>26725:                                {ok, Sock} -&gt;
<a name="26726"/>26726:                                    {ok, State#{lsock =&gt; Sock}};
<a name="26727"/>26727:                                {error, _} = ERROR -&gt;
<a name="26728"/>26728:                                    ERROR
<a name="26729"/>26729:                            end
<a name="26730"/>26730:                    end},
<a name="26731"/>26731:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26732"/>26732:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="26733"/>26733:                            case sock_bind(LSock, LSA) of
<a name="26734"/>26734:                                ok -&gt;
<a name="26735"/>26735:                                    Port = sock_port(LSock),
<a name="26736"/>26736:                                    {ok, State#{lport =&gt; Port}};
<a name="26737"/>26737:                                {error, _} = ERROR -&gt;
<a name="26738"/>26738:                                    ERROR
<a name="26739"/>26739:                            end
<a name="26740"/>26740:                    end},
<a name="26741"/>26741:          #{desc =&gt; &quot;make listen socket (with backlog = 1)&quot;,
<a name="26742"/>26742:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="26743"/>26743:                            socket:listen(LSock, 1)
<a name="26744"/>26744:                    end},
<a name="26745"/>26745:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26746"/>26746:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="26747"/>26747:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="26748"/>26748:                            ok
<a name="26749"/>26749:                    end},
<a name="26750"/>26750: 
<a name="26751"/>26751:          %% *** The actual test ***
<a name="26752"/>26752:          #{desc =&gt; &quot;await continue (accept and recv)&quot;,
<a name="26753"/>26753:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26754"/>26754:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept_recv)
<a name="26755"/>26755:                    end},
<a name="26756"/>26756:          #{desc =&gt; &quot;attempt accept&quot;,
<a name="26757"/>26757:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="26758"/>26758:                            case socket:accept(LSock) of
<a name="26759"/>26759:                                {ok, Sock} -&gt;
<a name="26760"/>26760:                                    {ok, State#{sock =&gt; Sock}};
<a name="26761"/>26761:                                {error, _} = ERROR -&gt;
<a name="26762"/>26762:                                    ERROR
<a name="26763"/>26763:                            end
<a name="26764"/>26764:                    end},
<a name="26765"/>26765:          #{desc =&gt; &quot;attempt to recv (without success)&quot;,
<a name="26766"/>26766:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, timeout := To} = State) -&gt;
<a name="26767"/>26767:                            Start = ?TS(),
<a name="26768"/>26768:                            case Recv(Sock, To) of
<a name="26769"/>26769:                                {error, timeout} -&gt;
<a name="26770"/>26770:                                    {ok, State#{start =&gt; Start, stop =&gt; ?TS()}};
<a name="26771"/>26771:                                {ok, _Data} -&gt;
<a name="26772"/>26772:                                    {error, unexpected_success};
<a name="26773"/>26773:                                {error, _} = ERROR -&gt;
<a name="26774"/>26774:                                    ERROR
<a name="26775"/>26775:                            end
<a name="26776"/>26776:                    end},
<a name="26777"/>26777:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="26778"/>26778:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = State) -&gt;
<a name="26779"/>26779:                            TDiff  = Stop - Start,
<a name="26780"/>26780:                            if
<a name="26781"/>26781:                                (TDiff &gt;= To) -&gt;
<a name="26782"/>26782:                                    State1 = maps:remove(start, State),
<a name="26783"/>26783:                                    State2 = maps:remove(stop,  State1),
<a name="26784"/>26784:                                    {ok, State2};
<a name="26785"/>26785:                                true -&gt;
<a name="26786"/>26786:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="26787"/>26787:                            end
<a name="26788"/>26788:                    end},
<a name="26789"/>26789:          #{desc =&gt; &quot;announce ready (recv timeout success)&quot;,
<a name="26790"/>26790:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26791"/>26791:                            ?SEV_ANNOUNCE_READY(Tester, accept_recv),
<a name="26792"/>26792:                            ok
<a name="26793"/>26793:                    end},
<a name="26794"/>26794: 
<a name="26795"/>26795:          %% *** Termination ***
<a name="26796"/>26796:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26797"/>26797:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="26798"/>26798:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="26799"/>26799:                                ok -&gt;
<a name="26800"/>26800:                                    {ok, maps:remove(tester, State)};
<a name="26801"/>26801:                                {error, _} = ERROR -&gt;
<a name="26802"/>26802:                                    ERROR
<a name="26803"/>26803:                            end
<a name="26804"/>26804:                    end},
<a name="26805"/>26805:          #{desc =&gt; &quot;close (traffic) socket&quot;,
<a name="26806"/>26806:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="26807"/>26807:                            sock_close(Sock),
<a name="26808"/>26808:                            {ok, maps:remove(sock, State)}
<a name="26809"/>26809:                    end},
<a name="26810"/>26810:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="26811"/>26811:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="26812"/>26812:                            sock_close(LSock),
<a name="26813"/>26813:                            {ok, maps:remove(lsock, State)}
<a name="26814"/>26814:                    end},
<a name="26815"/>26815: 
<a name="26816"/>26816:          %% *** We are done ***
<a name="26817"/>26817:          ?SEV_FINISH_NORMAL
<a name="26818"/>26818:         ],
<a name="26819"/>26819: 
<a name="26820"/>26820:     ClientSeq =
<a name="26821"/>26821:         [
<a name="26822"/>26822:          %% *** Wait for start order part ***
<a name="26823"/>26823:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="26824"/>26824:            cmd  =&gt; fun(State) -&gt;
<a name="26825"/>26825:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="26826"/>26826:                            {ok, State#{tester      =&gt; Tester,
<a name="26827"/>26827:                                        server_port =&gt; Port}}
<a name="26828"/>26828:                    end},
<a name="26829"/>26829:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26830"/>26830:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26831"/>26831:                            _MRef = erlang:monitor(process, Tester),
<a name="26832"/>26832:                            ok
<a name="26833"/>26833:                    end},
<a name="26834"/>26834: 
<a name="26835"/>26835:          %% *** Init part ***
<a name="26836"/>26836:          #{desc =&gt; &quot;which local address&quot;,
<a name="26837"/>26837:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="26838"/>26838:                            LSA = which_local_socket_addr(Domain),
<a name="26839"/>26839:                            SSA = LSA#{port =&gt; Port},
<a name="26840"/>26840:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="26841"/>26841:                    end},
<a name="26842"/>26842:          #{desc =&gt; &quot;create socket&quot;,
<a name="26843"/>26843:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26844"/>26844:                            case socket:open(Domain, stream, tcp) of
<a name="26845"/>26845:                                {ok, Sock} -&gt;
<a name="26846"/>26846:                                    {ok, State#{sock =&gt; Sock}};
<a name="26847"/>26847:                                {error, _} = ERROR -&gt;
<a name="26848"/>26848:                                    ERROR
<a name="26849"/>26849:                            end
<a name="26850"/>26850:                    end},
<a name="26851"/>26851:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26852"/>26852:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="26853"/>26853:                            case sock_bind(Sock, LSA) of
<a name="26854"/>26854:                                ok -&gt;
<a name="26855"/>26855:                                    ok;
<a name="26856"/>26856:                                {error, _} = ERROR -&gt;
<a name="26857"/>26857:                                    ERROR
<a name="26858"/>26858:                            end
<a name="26859"/>26859:                    end},
<a name="26860"/>26860:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26861"/>26861:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26862"/>26862:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="26863"/>26863:                            ok
<a name="26864"/>26864:                    end},
<a name="26865"/>26865: 
<a name="26866"/>26866:          %% *** The actual test ***
<a name="26867"/>26867:          #{desc =&gt; &quot;await continue (with connect)&quot;,
<a name="26868"/>26868:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26869"/>26869:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="26870"/>26870:                    end},
<a name="26871"/>26871:          #{desc =&gt; &quot;connect&quot;,
<a name="26872"/>26872:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="26873"/>26873:                            sock_connect(Sock, SSA),
<a name="26874"/>26874:                            ok
<a name="26875"/>26875:                    end},
<a name="26876"/>26876: 
<a name="26877"/>26877:          %% *** Termination ***
<a name="26878"/>26878:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26879"/>26879:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="26880"/>26880:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="26881"/>26881:                                ok -&gt;
<a name="26882"/>26882:                                    {ok, maps:remove(tester, State)};
<a name="26883"/>26883:                                {error, _} = ERROR -&gt;
<a name="26884"/>26884:                                    ERROR
<a name="26885"/>26885:                            end
<a name="26886"/>26886:                    end},
<a name="26887"/>26887:          #{desc =&gt; &quot;close socket&quot;,
<a name="26888"/>26888:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="26889"/>26889:                            sock_close(Sock),
<a name="26890"/>26890:                            {ok, maps:remove(sock, State)}
<a name="26891"/>26891:                    end},
<a name="26892"/>26892: 
<a name="26893"/>26893:          %% *** We are done ***
<a name="26894"/>26894:          ?SEV_FINISH_NORMAL
<a name="26895"/>26895:         ],
<a name="26896"/>26896: 
<a name="26897"/>26897:     TesterSeq =
<a name="26898"/>26898:         [
<a name="26899"/>26899:          %% *** Init part ***
<a name="26900"/>26900:          #{desc =&gt; &quot;monitor server&quot;,
<a name="26901"/>26901:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26902"/>26902:                            _MRef = erlang:monitor(process, Server),
<a name="26903"/>26903:                            ok
<a name="26904"/>26904:                    end},
<a name="26905"/>26905:          #{desc =&gt; &quot;monitor client&quot;,
<a name="26906"/>26906:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26907"/>26907:                            _MRef = erlang:monitor(process, Client),
<a name="26908"/>26908:                            ok
<a name="26909"/>26909:                    end},
<a name="26910"/>26910: 
<a name="26911"/>26911:          %% *** Activate server ***
<a name="26912"/>26912:          #{desc =&gt; &quot;start server&quot;,
<a name="26913"/>26913:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26914"/>26914:                            ?SEV_ANNOUNCE_START(Server),
<a name="26915"/>26915:                            ok
<a name="26916"/>26916:                    end},
<a name="26917"/>26917:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="26918"/>26918:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="26919"/>26919:                            {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="26920"/>26920:                            {ok, State#{server_port =&gt; Port}}
<a name="26921"/>26921:                    end},
<a name="26922"/>26922:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="26923"/>26923:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26924"/>26924:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept_recv),
<a name="26925"/>26925:                            ok
<a name="26926"/>26926:                    end},
<a name="26927"/>26927: 
<a name="26928"/>26928:          %% *** Activate client ***
<a name="26929"/>26929:          #{desc =&gt; &quot;start client&quot;,
<a name="26930"/>26930:            cmd  =&gt; fun(#{client := Client, server_port := Port} = _State) -&gt;
<a name="26931"/>26931:                            ?SEV_ANNOUNCE_START(Client, Port),
<a name="26932"/>26932:                            ok
<a name="26933"/>26933:                    end},
<a name="26934"/>26934:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="26935"/>26935:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26936"/>26936:                            ?SEV_AWAIT_READY(Client, client, init)
<a name="26937"/>26937:                    end},
<a name="26938"/>26938: 
<a name="26939"/>26939:          %% *** The actual test ***
<a name="26940"/>26940:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="26941"/>26941:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26942"/>26942:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="26943"/>26943:                            ok
<a name="26944"/>26944:                    end},
<a name="26945"/>26945:          #{desc =&gt; &quot;await server ready (accept/recv)&quot;,
<a name="26946"/>26946:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26947"/>26947:                            ?SEV_AWAIT_READY(Server, server, accept_recv)
<a name="26948"/>26948:                    end},
<a name="26949"/>26949: 
<a name="26950"/>26950:          %% *** Termination ***
<a name="26951"/>26951:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="26952"/>26952:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26953"/>26953:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="26954"/>26954:                            ok
<a name="26955"/>26955:                    end},
<a name="26956"/>26956:          #{desc =&gt; &quot;await client termination&quot;,
<a name="26957"/>26957:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="26958"/>26958:                            case ?SEV_AWAIT_TERMINATION(Client) of
<a name="26959"/>26959:                                ok -&gt;
<a name="26960"/>26960:                                    State1 = maps:remove(client, State),
<a name="26961"/>26961:                                    {ok, State1};
<a name="26962"/>26962:                                {error, _} = ERROR -&gt;
<a name="26963"/>26963:                                    ERROR
<a name="26964"/>26964:                            end
<a name="26965"/>26965:                    end},
<a name="26966"/>26966:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="26967"/>26967:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26968"/>26968:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="26969"/>26969:                            ok
<a name="26970"/>26970:                    end},
<a name="26971"/>26971:          #{desc =&gt; &quot;await server termination&quot;,
<a name="26972"/>26972:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="26973"/>26973:                            case ?SEV_AWAIT_TERMINATION(Server) of
<a name="26974"/>26974:                                ok -&gt;
<a name="26975"/>26975:                                    State1 = maps:remove(server, State),
<a name="26976"/>26976:                                    State2 = maps:remove(server_port, State1),
<a name="26977"/>26977:                                    {ok, State2};
<a name="26978"/>26978:                                {error, _} = ERROR -&gt;
<a name="26979"/>26979:                                    ERROR
<a name="26980"/>26980:                            end
<a name="26981"/>26981:                    end},
<a name="26982"/>26982: 
<a name="26983"/>26983:          %% *** We are done ***
<a name="26984"/>26984:          ?SEV_FINISH_NORMAL
<a name="26985"/>26985:         ],
<a name="26986"/>26986: 
<a name="26987"/>26987:     
<a name="26988"/>26988:     i(&quot;start server evaluator&quot;),
<a name="26989"/>26989:     ServerInitState = InitState,
<a name="26990"/>26990:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="26991"/>26991: 
<a name="26992"/>26992:     i(&quot;start client evaluator&quot;),
<a name="26993"/>26993:     ClientInitState = InitState,
<a name="26994"/>26994:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="26995"/>26995: 
<a name="26996"/>26996:     i(&quot;start tester evaluator&quot;),
<a name="26997"/>26997:     TesterInitState = #{server =&gt; Server#ev.pid, 
<a name="26998"/>26998:                         client =&gt; Client#ev.pid},
<a name="26999"/>26999:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="27000"/>27000: 
<a name="27001"/>27001:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_receive_tcp-last_expr"/><a name="27002"/>27002: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="27003"/>27003: 
<a name="27004"/>27004: 
<a name="27005"/>27005: 
<a name="27006"/>27006: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27007"/>27007: 
<a name="27008"/>27008: <i>%% This test case is intended to test the recvfrom timeout option</i>
<a name="27009"/>27009: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_recvfrom_udp4-1"/><a name="27010"/>27010: <b>api_to_recvfrom_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="27011"/>27011:     ?TT(?SECS(10)),
<a name="api_to_recvfrom_udp4-last_expr"/><a name="27012"/>27012: <b>    tc_try</b>(api_to_recvfrom_udp4,
<a name="27013"/>27013:            fun() -&gt; has_support_ipv4() end,
<a name="27014"/>27014:            fun() -&gt;
<a name="27015"/>27015:                    Recv = fun(Sock, To) -&gt; socket:recvfrom(Sock, 0, To) end,
<a name="27016"/>27016:                    InitState = #{domain  =&gt; inet,
<a name="27017"/>27017:                                  recv    =&gt; Recv,
<a name="27018"/>27018:                                  timeout =&gt; 2000},
<a name="27019"/>27019:                    ok = api_to_receive_udp(InitState)
<a name="27020"/>27020:            end).
<a name="27021"/>27021: 
<a name="27022"/>27022: 
<a name="27023"/>27023: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27024"/>27024: 
<a name="27025"/>27025: <i>%% This test case is intended to test the recvfrom timeout option</i>
<a name="27026"/>27026: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_recvfrom_udp6-1"/><a name="27027"/>27027: <b>api_to_recvfrom_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27028"/>27028:     ?TT(?SECS(10)),
<a name="api_to_recvfrom_udp6-last_expr"/><a name="27029"/>27029: <b>    tc_try</b>(api_to_recvfrom_udp6,
<a name="27030"/>27030:            fun() -&gt; has_support_ipv6() end,
<a name="27031"/>27031:            fun() -&gt;
<a name="27032"/>27032:                    Recv = fun(Sock, To) -&gt; socket:recvfrom(Sock, 0, To) end,
<a name="27033"/>27033:                    InitState = #{domain  =&gt; inet6,
<a name="27034"/>27034:                                  recv    =&gt; Recv,
<a name="27035"/>27035:                                  timeout =&gt; 2000},
<a name="27036"/>27036:                    ok = api_to_receive_udp(InitState)
<a name="27037"/>27037:            end).
<a name="27038"/>27038: 
<a name="27039"/>27039: 
<a name="27040"/>27040: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27041"/>27041: 
<a name="api_to_receive_udp-1"/><a name="27042"/>27042: <b>api_to_receive_udp</b>(InitState) -&gt;
<a name="27043"/>27043:     TesterSeq =
<a name="27044"/>27044:         [
<a name="27045"/>27045:          %% *** Init part ***
<a name="27046"/>27046:          #{desc =&gt; &quot;which local address&quot;,
<a name="27047"/>27047:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27048"/>27048:                            LSA = which_local_socket_addr(Domain),
<a name="27049"/>27049:                            {ok, State#{lsa =&gt; LSA}}
<a name="27050"/>27050:                    end},
<a name="27051"/>27051:          #{desc =&gt; &quot;create socket&quot;,
<a name="27052"/>27052:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27053"/>27053:                            case socket:open(Domain, dgram, udp) of
<a name="27054"/>27054:                                {ok, Sock} -&gt;
<a name="27055"/>27055:                                    {ok, State#{sock =&gt; Sock}};
<a name="27056"/>27056:                                {error, _} = ERROR -&gt;
<a name="27057"/>27057:                                    ERROR
<a name="27058"/>27058:                            end
<a name="27059"/>27059:                    end},
<a name="27060"/>27060:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="27061"/>27061:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="27062"/>27062:                            case sock_bind(Sock, LSA) of
<a name="27063"/>27063:                                ok -&gt;
<a name="27064"/>27064:                                    ok;
<a name="27065"/>27065:                                {error, _} = ERROR -&gt;
<a name="27066"/>27066:                                    ERROR
<a name="27067"/>27067:                            end
<a name="27068"/>27068:                    end},
<a name="27069"/>27069: 
<a name="27070"/>27070:          %% *** The actual test ***
<a name="27071"/>27071:          #{desc =&gt; &quot;attempt to read (without success)&quot;,
<a name="27072"/>27072:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, timeout := To} = State) -&gt;
<a name="27073"/>27073:                            Start = ?TS(),
<a name="27074"/>27074:                            case Recv(Sock, To) of
<a name="27075"/>27075:                                {error, timeout} -&gt;
<a name="27076"/>27076:                                    {ok, State#{start =&gt; Start,
<a name="27077"/>27077:                                                stop =&gt; ?TS()}};
<a name="27078"/>27078:                                {ok, _} -&gt;
<a name="27079"/>27079:                                    {error, unexpected_success};
<a name="27080"/>27080:                                {error, _} = ERROR -&gt;
<a name="27081"/>27081:                                    ERROR
<a name="27082"/>27082:                            end
<a name="27083"/>27083:                    end},
<a name="27084"/>27084:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="27085"/>27085:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="27086"/>27086:                            TDiff  = Stop - Start,
<a name="27087"/>27087:                            if
<a name="27088"/>27088:                                (TDiff &gt;= To) -&gt;
<a name="27089"/>27089:                                    ok;
<a name="27090"/>27090:                                true -&gt;
<a name="27091"/>27091:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="27092"/>27092:                            end
<a name="27093"/>27093:                    end},
<a name="27094"/>27094:          
<a name="27095"/>27095:          %% *** Termination ***
<a name="27096"/>27096:          #{desc =&gt; &quot;close socket&quot;,
<a name="27097"/>27097:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="27098"/>27098:                            %% socket:setopt(Sock, otp, debug, true),
<a name="27099"/>27099:                            sock_close(Sock),
<a name="27100"/>27100:                            ok
<a name="27101"/>27101:                    end},
<a name="27102"/>27102: 
<a name="27103"/>27103:          %% *** We are done ***
<a name="27104"/>27104:          ?SEV_FINISH_NORMAL
<a name="27105"/>27105:         ],
<a name="27106"/>27106: 
<a name="27107"/>27107:     i(&quot;start tester evaluator&quot;),
<a name="27108"/>27108:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="27109"/>27109:     
<a name="27110"/>27110:     i(&quot;await evaluator&quot;),
<a name="api_to_receive_udp-last_expr"/><a name="27111"/>27111: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="27112"/>27112: 
<a name="27113"/>27113: 
<a name="27114"/>27114: 
<a name="27115"/>27115: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27116"/>27116: 
<a name="27117"/>27117: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="27118"/>27118: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_recvmsg_udp4-1"/><a name="27119"/>27119: <b>api_to_recvmsg_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="27120"/>27120:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_udp4-last_expr"/><a name="27121"/>27121: <b>    tc_try</b>(api_to_recvmsg_udp4,
<a name="27122"/>27122:            fun() -&gt; has_support_ipv4() end,
<a name="27123"/>27123:            fun() -&gt;
<a name="27124"/>27124:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="27125"/>27125:                    InitState = #{domain  =&gt; inet,
<a name="27126"/>27126:                                  recv    =&gt; Recv,
<a name="27127"/>27127:                                  timeout =&gt; 2000},
<a name="27128"/>27128:                    ok = api_to_receive_udp(InitState)
<a name="27129"/>27129:            end).
<a name="27130"/>27130: 
<a name="27131"/>27131: 
<a name="27132"/>27132: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27133"/>27133: 
<a name="27134"/>27134: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="27135"/>27135: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_recvmsg_udp6-1"/><a name="27136"/>27136: <b>api_to_recvmsg_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27137"/>27137:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_udp6-last_expr"/><a name="27138"/>27138: <b>    tc_try</b>(api_to_recvmsg_udp6,
<a name="27139"/>27139:            fun() -&gt; has_support_ipv6() end,
<a name="27140"/>27140:            fun() -&gt;
<a name="27141"/>27141:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="27142"/>27142:                    InitState = #{domain  =&gt; inet6,
<a name="27143"/>27143:                                  recv    =&gt; Recv,
<a name="27144"/>27144:                                  timeout =&gt; 2000},
<a name="27145"/>27145:                    ok = api_to_receive_udp(InitState)
<a name="27146"/>27146:            end).
<a name="27147"/>27147: 
<a name="27148"/>27148: 
<a name="27149"/>27149: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27150"/>27150: 
<a name="27151"/>27151: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="27152"/>27152: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_recvmsg_tcp4-1"/><a name="27153"/>27153: <b>api_to_recvmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="27154"/>27154:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_tcp4-last_expr"/><a name="27155"/>27155: <b>    tc_try</b>(api_to_recvmsg_tcp4,
<a name="27156"/>27156:            fun() -&gt; has_support_ipv4() end,
<a name="27157"/>27157:            fun() -&gt;
<a name="27158"/>27158:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="27159"/>27159:                    InitState = #{domain  =&gt; inet,
<a name="27160"/>27160:                                  recv    =&gt; Recv,
<a name="27161"/>27161:                                  timeout =&gt; 2000},
<a name="27162"/>27162:                    ok = api_to_receive_tcp(InitState)
<a name="27163"/>27163:            end).
<a name="27164"/>27164: 
<a name="27165"/>27165: 
<a name="27166"/>27166: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27167"/>27167: 
<a name="27168"/>27168: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="27169"/>27169: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_recvmsg_tcp6-1"/><a name="27170"/>27170: <b>api_to_recvmsg_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27171"/>27171:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_tcp6-last_expr"/><a name="27172"/>27172: <b>    tc_try</b>(api_to_recvmsg_tcp6,
<a name="27173"/>27173:            fun() -&gt; has_support_ipv6() end,
<a name="27174"/>27174:            fun() -&gt;
<a name="27175"/>27175:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="27176"/>27176:                    InitState = #{domain  =&gt; inet6,
<a name="27177"/>27177:                                  recv    =&gt; Recv,
<a name="27178"/>27178:                                  timeout =&gt; 2000},
<a name="27179"/>27179:                    ok = api_to_receive_tcp(InitState)
<a name="27180"/>27180:            end).
<a name="27181"/>27181: 
<a name="27182"/>27182: 
<a name="27183"/>27183: 
<a name="27184"/>27184: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27185"/>27185: 
<a name="sock_open-3"/><a name="27186"/>27186: <b>sock_open</b>(Domain, Type, Proto) -&gt;
<a name="sock_open-last_expr"/><a name="27187"/>27187: <b>    try socket:open</b>(Domain, Type, Proto) of
<a name="27188"/>27188:         {ok, Socket} -&gt;
<a name="27189"/>27189:             Socket;
<a name="27190"/>27190:         {error, Reason} -&gt;
<a name="27191"/>27191:             ?FAIL({open, Reason})
<a name="27192"/>27192:     catch
<a name="27193"/>27193:         C:E:S -&gt;
<a name="27194"/>27194:             ?FAIL({open, C, E, S})
<a name="27195"/>27195:     end.
<a name="27196"/>27196: 
<a name="27197"/>27197: 
<a name="sock_bind-2"/><a name="27198"/>27198: <b>sock_bind</b>(Sock, LSA) -&gt;
<a name="sock_bind-last_expr"/><a name="27199"/>27199: <b>    try socket:bind</b>(Sock, LSA) of
<a name="27200"/>27200:         ok = OK -&gt;
<a name="27201"/>27201:             OK;
<a name="27202"/>27202:         {error, eaddrnotavail = Reason} -&gt;
<a name="27203"/>27203:             ?SEV_IPRINT(&quot;Address not available&quot;),
<a name="27204"/>27204:             throw({skip, Reason});
<a name="27205"/>27205:         {error, _} = ERROR -&gt;
<a name="27206"/>27206:             ERROR
<a name="27207"/>27207:     catch
<a name="27208"/>27208:         C:E:S -&gt;
<a name="27209"/>27209:             ?FAIL({bind, C, E, S})
<a name="27210"/>27210:     end.
<a name="27211"/>27211: 
<a name="sock_connect-2"/><a name="27212"/>27212: <b>sock_connect</b>(Sock, SockAddr) -&gt;
<a name="sock_connect-last_expr"/><a name="27213"/>27213: <b>    try socket:connect</b>(Sock, SockAddr) of
<a name="27214"/>27214:         ok -&gt;
<a name="27215"/>27215:             ok;
<a name="27216"/>27216:         {error, Reason} -&gt;
<a name="27217"/>27217:             ?FAIL({connect, Reason})
<a name="27218"/>27218:     catch
<a name="27219"/>27219:         C:E:S -&gt;
<a name="27220"/>27220:             ?FAIL({connect, C, E, S})
<a name="27221"/>27221:     end.
<a name="27222"/>27222:     
<a name="sock_sockname-1"/><a name="27223"/>27223: <b>sock_sockname</b>(Sock) -&gt;
<a name="sock_sockname-last_expr"/><a name="27224"/>27224: <b>    try socket:sockname</b>(Sock) of
<a name="27225"/>27225:         {ok, SockAddr} -&gt;
<a name="27226"/>27226:             SockAddr;
<a name="27227"/>27227:         {error, Reason} -&gt;
<a name="27228"/>27228:             ?FAIL({sockname, Reason})
<a name="27229"/>27229:     catch
<a name="27230"/>27230:         C:E:S -&gt;
<a name="27231"/>27231:             ?FAIL({sockname, C, E, S})
<a name="27232"/>27232:     end.
<a name="27233"/>27233:     
<a name="sock_port-1"/><a name="27234"/>27234: <b>sock_port</b>(S) -&gt;
<a name="sock_port-last_expr"/><a name="27235"/>27235: <b>    case sock_sockname</b>(S) of
<a name="27236"/>27236:         #{port := Port} -&gt; Port;
<a name="27237"/>27237:         _               -&gt; undefined
<a name="27238"/>27238:     end.
<a name="27239"/>27239: 
<a name="sock_close-1"/><a name="27240"/>27240: <b>sock_close</b>(Sock) -&gt;
<a name="sock_close-last_expr"/><a name="27241"/>27241: <b>    try socket:close</b>(Sock) of
<a name="27242"/>27242:         ok -&gt;
<a name="27243"/>27243:             ok;
<a name="27244"/>27244:         {error, Reason} -&gt;
<a name="27245"/>27245:             i(&quot;sock_close -&gt; error: ~p&quot;, [Reason]),
<a name="27246"/>27246:             ?FAIL({close, Reason})
<a name="27247"/>27247:     catch
<a name="27248"/>27248:         C:E:S -&gt;
<a name="27249"/>27249:             i(&quot;sock_close -&gt; failed: ~p, ~p, ~p&quot;, [C, E, S]),
<a name="27250"/>27250:             ?FAIL({close, C, E, S})
<a name="27251"/>27251:     end.
<a name="27252"/>27252: 
<a name="27253"/>27253: 
<a name="27254"/>27254: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27255"/>27255: 
<a name="local_host-0"/><a name="27256"/>27256: <b>local_host</b>() -&gt;
<a name="local_host-last_expr"/><a name="27257"/>27257: <b>    try net_adm:localhost</b>() of
<a name="27258"/>27258:         Host when is_list(Host) -&gt;
<a name="27259"/>27259: 	    %% Convert to shortname if long
<a name="27260"/>27260: 	    case string:tokens(Host, [$.]) of
<a name="27261"/>27261: 		[H|_] -&gt;
<a name="27262"/>27262: 		    list_to_atom(H)
<a name="27263"/>27263: 	    end
<a name="27264"/>27264:     catch
<a name="27265"/>27265:         C:E:S -&gt;
<a name="27266"/>27266:             erlang:raise(C, E, S)
<a name="27267"/>27267:     end.
<a name="27268"/>27268: 
<a name="27269"/>27269: 
<a name="27270"/>27270: <i>%% The point of this is to &quot;ensure&quot; that paths from different test runs</i>
<a name="27271"/>27271: <i>%% don't clash.</i>
<a name="27272"/>27272: 
<a name="mk_unique_path-0"/><a name="27273"/>27273: <b>mk_unique_path</b>() -&gt;
<a name="mk_unique_path-last_expr"/><a name="27274"/>27274: <b>    ?SLIB:mk_unique_path</b>().
<a name="27275"/>27275: 
<a name="27276"/>27276: 
<a name="which_local_socket_addr-1"/><a name="27277"/>27277: <b>which_local_socket_addr</b>(local = Domain) -&gt;
<a name="27278"/>27278:     #{family =&gt; Domain,
<a name="27279"/>27279:       path   =&gt; mk_unique_path()};
<a name="27280"/>27280: 
<a name="27281"/>27281: <i>%% This gets the local socket address (not 127.0...)</i>
<a name="27282"/>27282: <i>%% We should really implement this using the (new) net module,</i>
<a name="27283"/>27283: <i>%% but until that gets the necessary functionality...</i>
<a name="27284"/>27284: <b>which_local_socket_addr</b>(Domain) -&gt;
<a name="which_local_socket_addr-last_expr"/><a name="27285"/>27285: <b>    case ?KLIB:which_local_host_info</b>(Domain) of
<a name="27286"/>27286:         {ok, [#{addr := Addr}|_]} -&gt;
<a name="27287"/>27287:             #{family =&gt; Domain,
<a name="27288"/>27288:               addr   =&gt; Addr};
<a name="27289"/>27289:         {error, Reason} -&gt;
<a name="27290"/>27290:             ?FAIL(Reason)
<a name="27291"/>27291:     end.
<a name="27292"/>27292: 
<a name="which_local_host_info-1"/><a name="27293"/>27293: <b>which_local_host_info</b>(Domain) -&gt;
<a name="which_local_host_info-last_expr"/><a name="27294"/>27294: <b>    case ?KLIB:which_local_host_info</b>(Domain) of
<a name="27295"/>27295:         {ok, [Info|_]} -&gt;
<a name="27296"/>27296:             {ok, Info#{family =&gt; Domain}};
<a name="27297"/>27297:         {error, Reason} -&gt;
<a name="27298"/>27298:             ?FAIL(Reason)
<a name="27299"/>27299:     end.
<a name="27300"/>27300: 
<a name="27301"/>27301: 
<a name="27302"/>27302: 
<a name="27303"/>27303: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27304"/>27304: 
<a name="27305"/>27305: <i>%% monitored_by() -&gt;</i>
<a name="27306"/>27306: <i>%%     monitored_by(self()).</i>
<a name="27307"/>27307: <i>%% monitored_by(Pid) -&gt;	</i>
<a name="27308"/>27308: <i>%%     {monitored_by, Refs} = erlang:process_info(Pid, monitored_by),</i>
<a name="27309"/>27309: <i>%%     Refs.</i>
<a name="27310"/>27310: 
<a name="27311"/>27311: 
<a name="27312"/>27312: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27313"/>27313: 
<a name="27314"/>27314: <i>%% Here are all the *general* test case condition functions.</i>
<a name="27315"/>27315: 
<a name="27316"/>27316: <i>%% We also need to (be able to) figure out the multicast address,</i>
<a name="27317"/>27317: <i>%% which we only support for some platforms (linux and sunos).</i>
<a name="27318"/>27318: <i>%% We don't do that here, but since we can only do that (find a</i>
<a name="27319"/>27319: <i>%% multicast address) for specific platforms, we check that we are</i>
<a name="27320"/>27320: <i>%% on of those platforms here.</i>
<a name="has_support_ip_multicast-0"/><a name="27321"/>27321: <b>has_support_ip_multicast</b>() -&gt;
<a name="has_support_ip_multicast-last_expr"/><a name="27322"/>27322: <b>    case os:type</b>() of
<a name="27323"/>27323:         {unix, OsName} when (OsName =:= linux) orelse
<a name="27324"/>27324:                             (OsName =:= sunos) -&gt;
<a name="27325"/>27325:             case ?SLIB:which_local_host_info(inet) of
<a name="27326"/>27326:                 {ok, #{flags := Flags}} -&gt;
<a name="27327"/>27327:                     case lists:member(multicast, Flags) of
<a name="27328"/>27328:                         true -&gt;
<a name="27329"/>27329:                             ok;
<a name="27330"/>27330:                         false -&gt;
<a name="27331"/>27331:                             not_supported(multicast)
<a name="27332"/>27332:                     end;
<a name="27333"/>27333:                 {error, Reason} -&gt;
<a name="27334"/>27334:                     not_supported({multicast, Reason})
<a name="27335"/>27335:             end;
<a name="27336"/>27336:         {unix, OsName} -&gt;
<a name="27337"/>27337:             skip(?F(&quot;Not Supported: platform ~w&quot;, [OsName]));
<a name="27338"/>27338:         Type -&gt;
<a name="27339"/>27339:             skip(?F(&quot;Not Supported: platform ~p&quot;, [Type]))
<a name="27340"/>27340:     end.
<a name="27341"/>27341: 
<a name="27342"/>27342: 
<a name="27343"/>27343: <i>%% --- SOCK socket option test functions ---</i>
<a name="27344"/>27344: 
<a name="has_support_sock_acceptconn-0"/><a name="27345"/>27345: <b>has_support_sock_acceptconn</b>() -&gt;
<a name="has_support_sock_acceptconn-last_expr"/><a name="27346"/>27346: <b>    has_support_socket_option_sock</b>(acceptconn).
<a name="27347"/>27347: 
<a name="has_support_sock_bindtodevice-0"/><a name="27348"/>27348: <b>has_support_sock_bindtodevice</b>() -&gt;
<a name="has_support_sock_bindtodevice-last_expr"/><a name="27349"/>27349: <b>    has_support_socket_option_sock</b>(bindtodevice).
<a name="27350"/>27350: 
<a name="has_support_sock_broadcast-0"/><a name="27351"/>27351: <b>has_support_sock_broadcast</b>() -&gt;
<a name="27352"/>27352:     has_support_ipv4(),
<a name="27353"/>27353:     has_support_socket_option_sock(broadcast),
<a name="has_support_sock_broadcast-last_expr"/><a name="27354"/>27354: <b>    case ?SLIB:which_local_host_info</b>(inet) of
<a name="27355"/>27355:         {ok, #{flags := Flags}} -&gt;
<a name="27356"/>27356:             case lists:member(broadcast, Flags) of
<a name="27357"/>27357:                 true -&gt;
<a name="27358"/>27358:                     ok;
<a name="27359"/>27359:                 false -&gt;
<a name="27360"/>27360:                     not_supported({broadcast, Flags})
<a name="27361"/>27361:             end;
<a name="27362"/>27362:         {error, Reason} -&gt;
<a name="27363"/>27363:             not_supported({broadcast, Reason})
<a name="27364"/>27364:     end.
<a name="27365"/>27365: 
<a name="has_support_sock_debug-0"/><a name="27366"/>27366: <b>has_support_sock_debug</b>() -&gt;
<a name="has_support_sock_debug-last_expr"/><a name="27367"/>27367: <b>    has_support_socket_option_sock</b>(debug).
<a name="27368"/>27368: 
<a name="has_support_sock_domain-0"/><a name="27369"/>27369: <b>has_support_sock_domain</b>() -&gt;
<a name="has_support_sock_domain-last_expr"/><a name="27370"/>27370: <b>    has_support_socket_option_sock</b>(domain).
<a name="27371"/>27371: 
<a name="has_support_sock_dontroute-0"/><a name="27372"/>27372: <b>has_support_sock_dontroute</b>() -&gt;
<a name="has_support_sock_dontroute-last_expr"/><a name="27373"/>27373: <b>    has_support_socket_option_sock</b>(dontroute).
<a name="27374"/>27374: 
<a name="has_support_sock_keepalive-0"/><a name="27375"/>27375: <b>has_support_sock_keepalive</b>() -&gt;
<a name="has_support_sock_keepalive-last_expr"/><a name="27376"/>27376: <b>    has_support_socket_option_sock</b>(keepalive).
<a name="27377"/>27377: 
<a name="has_support_sock_reuseaddr-0"/><a name="27378"/>27378: <b>has_support_sock_reuseaddr</b>() -&gt;
<a name="has_support_sock_reuseaddr-last_expr"/><a name="27379"/>27379: <b>    has_support_socket_option_sock</b>(reuseaddr).
<a name="27380"/>27380: 
<a name="has_support_sock_bsp_state-0"/><a name="27381"/>27381: <b>has_support_sock_bsp_state</b>() -&gt;
<a name="has_support_sock_bsp_state-last_expr"/><a name="27382"/>27382: <b>    has_support_socket_option_sock</b>(bsp_state).
<a name="27383"/>27383: 
<a name="has_support_sock_exclusiveaddruse-0"/><a name="27384"/>27384: <b>has_support_sock_exclusiveaddruse</b>() -&gt;
<a name="has_support_sock_exclusiveaddruse-last_expr"/><a name="27385"/>27385: <b>    has_support_socket_option_sock</b>(exclusiveaddruse).
<a name="27386"/>27386: 
<a name="has_support_sock_maxdg-0"/><a name="27387"/>27387: <b>has_support_sock_maxdg</b>() -&gt;
<a name="has_support_sock_maxdg-last_expr"/><a name="27388"/>27388: <b>    has_support_socket_option_sock</b>(maxdg).
<a name="27389"/>27389: 
<a name="has_support_sock_max_msg_size-0"/><a name="27390"/>27390: <b>has_support_sock_max_msg_size</b>() -&gt;
<a name="has_support_sock_max_msg_size-last_expr"/><a name="27391"/>27391: <b>    has_support_socket_option_sock</b>(max_msg_size).
<a name="27392"/>27392: 
<a name="has_support_sock_oobinline-0"/><a name="27393"/>27393: <b>has_support_sock_oobinline</b>() -&gt;
<a name="has_support_sock_oobinline-last_expr"/><a name="27394"/>27394: <b>    has_support_socket_option_sock</b>(oobinline).
<a name="27395"/>27395: 
<a name="has_support_sock_passcred-0"/><a name="27396"/>27396: <b>has_support_sock_passcred</b>() -&gt;
<a name="has_support_sock_passcred-last_expr"/><a name="27397"/>27397: <b>    has_support_socket_option_sock</b>(passcred).
<a name="27398"/>27398: 
<a name="has_support_sock_peek_off-0"/><a name="27399"/>27399: <b>has_support_sock_peek_off</b>() -&gt;
<a name="has_support_sock_peek_off-last_expr"/><a name="27400"/>27400: <b>    has_support_socket_option_sock</b>(peek_off).
<a name="27401"/>27401: 
<a name="has_support_sock_peercred-0"/><a name="27402"/>27402: <b>has_support_sock_peercred</b>() -&gt;
<a name="has_support_sock_peercred-last_expr"/><a name="27403"/>27403: <b>    has_support_socket_option_sock</b>(peercred).
<a name="27404"/>27404: 
<a name="has_support_sock_priority-0"/><a name="27405"/>27405: <b>has_support_sock_priority</b>() -&gt;
<a name="has_support_sock_priority-last_expr"/><a name="27406"/>27406: <b>    has_support_socket_option_sock</b>(priority).
<a name="27407"/>27407: 
<a name="has_support_sock_rcvbuf-0"/><a name="27408"/>27408: <b>has_support_sock_rcvbuf</b>() -&gt;
<a name="has_support_sock_rcvbuf-last_expr"/><a name="27409"/>27409: <b>    has_support_socket_option_sock</b>(rcvbuf).
<a name="27410"/>27410: 
<a name="has_support_sock_rcvlowat-0"/><a name="27411"/>27411: <b>has_support_sock_rcvlowat</b>() -&gt;
<a name="has_support_sock_rcvlowat-last_expr"/><a name="27412"/>27412: <b>    has_support_socket_option_sock</b>(rcvlowat).
<a name="27413"/>27413: 
<a name="has_support_sock_rcvtimeo-0"/><a name="27414"/>27414: <b>has_support_sock_rcvtimeo</b>() -&gt;
<a name="has_support_sock_rcvtimeo-last_expr"/><a name="27415"/>27415: <b>    has_support_socket_option_sock</b>(rcvtimeo).
<a name="27416"/>27416: 
<a name="has_support_sock_sndbuf-0"/><a name="27417"/>27417: <b>has_support_sock_sndbuf</b>() -&gt;
<a name="has_support_sock_sndbuf-last_expr"/><a name="27418"/>27418: <b>    has_support_socket_option_sock</b>(sndbuf).
<a name="27419"/>27419: 
<a name="has_support_sock_sndlowat-0"/><a name="27420"/>27420: <b>has_support_sock_sndlowat</b>() -&gt;
<a name="has_support_sock_sndlowat-last_expr"/><a name="27421"/>27421: <b>    has_support_socket_option_sock</b>(sndlowat).
<a name="27422"/>27422: 
<a name="has_support_sock_sndtimeo-0"/><a name="27423"/>27423: <b>has_support_sock_sndtimeo</b>() -&gt;
<a name="has_support_sock_sndtimeo-last_expr"/><a name="27424"/>27424: <b>    has_support_socket_option_sock</b>(sndtimeo).
<a name="27425"/>27425: 
<a name="has_support_sock_timestamp-0"/><a name="27426"/>27426: <b>has_support_sock_timestamp</b>() -&gt;
<a name="has_support_sock_timestamp-last_expr"/><a name="27427"/>27427: <b>    has_support_socket_option_sock</b>(timestamp).
<a name="27428"/>27428: 
<a name="27429"/>27429: 
<a name="27430"/>27430: <i>%% --- IP socket option test functions ---</i>
<a name="27431"/>27431: 
<a name="has_support_ip_add_membership-0"/><a name="27432"/>27432: <b>has_support_ip_add_membership</b>() -&gt;
<a name="has_support_ip_add_membership-last_expr"/><a name="27433"/>27433: <b>    has_support_socket_option_ip</b>(add_membership).
<a name="27434"/>27434: 
<a name="has_support_ip_drop_membership-0"/><a name="27435"/>27435: <b>has_support_ip_drop_membership</b>() -&gt;
<a name="has_support_ip_drop_membership-last_expr"/><a name="27436"/>27436: <b>    has_support_socket_option_ip</b>(drop_membership).
<a name="27437"/>27437: 
<a name="has_support_ip_pktinfo-0"/><a name="27438"/>27438: <b>has_support_ip_pktinfo</b>() -&gt;
<a name="has_support_ip_pktinfo-last_expr"/><a name="27439"/>27439: <b>    has_support_socket_option_ip</b>(pktinfo).
<a name="27440"/>27440: 
<a name="has_support_ip_recvopts-0"/><a name="27441"/>27441: <b>has_support_ip_recvopts</b>() -&gt;
<a name="has_support_ip_recvopts-last_expr"/><a name="27442"/>27442: <b>    has_support_socket_option_ip</b>(recvopts).
<a name="27443"/>27443: 
<a name="has_support_ip_recvorigdstaddr-0"/><a name="27444"/>27444: <b>has_support_ip_recvorigdstaddr</b>() -&gt;
<a name="has_support_ip_recvorigdstaddr-last_expr"/><a name="27445"/>27445: <b>    has_support_socket_option_ip</b>(recvorigdstaddr).
<a name="27446"/>27446: 
<a name="has_support_ip_recvtos-0"/><a name="27447"/>27447: <b>has_support_ip_recvtos</b>() -&gt;
<a name="has_support_ip_recvtos-last_expr"/><a name="27448"/>27448: <b>    has_support_socket_option_ip</b>(recvtos).
<a name="27449"/>27449: 
<a name="has_support_ip_recvtos_and_or_sock_timestamp-0"/><a name="27450"/>27450: <b>has_support_ip_recvtos_and_or_sock_timestamp</b>() -&gt;
<a name="has_support_ip_recvtos_and_or_sock_timestamp-last_expr"/><a name="27451"/>27451: <b>    case </b>(socket:is_supported(options, ip, recvtos) orelse 
<a name="27452"/>27452:           socket:is_supported(options, socket, timestamp)) of
<a name="27453"/>27453:         true -&gt;
<a name="27454"/>27454:             ok;
<a name="27455"/>27455:         false -&gt;
<a name="27456"/>27456:             skip(?F(&quot;Neither needed opts &quot;
<a name="27457"/>27457:                     &quot;ip:recvtos or socket:timestamp supported&quot;, []))
<a name="27458"/>27458:     end.
<a name="27459"/>27459: 
<a name="has_support_ip_recvttl-0"/><a name="27460"/>27460: <b>has_support_ip_recvttl</b>() -&gt;
<a name="has_support_ip_recvttl-last_expr"/><a name="27461"/>27461: <b>    has_support_socket_option_ip</b>(recvttl).
<a name="27462"/>27462: 
<a name="has_support_ip_tos-0"/><a name="27463"/>27463: <b>has_support_ip_tos</b>() -&gt;
<a name="has_support_ip_tos-last_expr"/><a name="27464"/>27464: <b>    has_support_socket_option_ip</b>(tos).
<a name="27465"/>27465: 
<a name="has_support_ip_recverr-0"/><a name="27466"/>27466: <b>has_support_ip_recverr</b>() -&gt;
<a name="has_support_ip_recverr-last_expr"/><a name="27467"/>27467: <b>    has_support_socket_option_ip</b>(recverr).
<a name="27468"/>27468: 
<a name="27469"/>27469: 
<a name="27470"/>27470: <i>%% --- IPv6 socket option test functions ---</i>
<a name="27471"/>27471: 
<a name="has_support_ipv6_flowinfo-0"/><a name="27472"/>27472: <b>has_support_ipv6_flowinfo</b>() -&gt;
<a name="has_support_ipv6_flowinfo-last_expr"/><a name="27473"/>27473: <b>    has_support_socket_option_ipv6</b>(flowinfo).
<a name="27474"/>27474: 
<a name="has_support_ipv6_hoplimit_or_recvhoplimit-0"/><a name="27475"/>27475: <b>has_support_ipv6_hoplimit_or_recvhoplimit</b>() -&gt;
<a name="27476"/>27476:     %% case (socket:is_supported(options, ipv6, recvhoplimit) orelse
<a name="27477"/>27477:     %%       socket:is_supported(options, ipv6, hoplimit)) of
<a name="has_support_ipv6_hoplimit_or_recvhoplimit-last_expr"/><a name="27478"/>27478: <b>    case is_any_options_supported</b>([{ipv6, recvhoplimit}, {ipv6, hoplimit}]) of
<a name="27479"/>27479: 	true -&gt;
<a name="27480"/>27480: 	    ok;
<a name="27481"/>27481: 	false -&gt;
<a name="27482"/>27482: 	    skip(?F(&quot;Neither recvhoplimit or hoplimit supported&quot;, []))
<a name="27483"/>27483:     end.
<a name="27484"/>27484: 
<a name="has_support_ipv6_recvpktinfo-0"/><a name="27485"/>27485: <b>has_support_ipv6_recvpktinfo</b>() -&gt;
<a name="has_support_ipv6_recvpktinfo-last_expr"/><a name="27486"/>27486: <b>    has_support_socket_option_ipv6</b>(recvpktinfo).
<a name="27487"/>27487: 
<a name="27488"/>27488: 
<a name="has_support_ipv6_tclass_or_recvtclass-0"/><a name="27489"/>27489: <b>has_support_ipv6_tclass_or_recvtclass</b>() -&gt;
<a name="has_support_ipv6_tclass_or_recvtclass-last_expr"/><a name="27490"/>27490: <b>    case is_any_options_supported</b>([{ipv6, recvtclass}, {ipv6, tclass}]) of
<a name="27491"/>27491: 	true -&gt;
<a name="27492"/>27492: 	    ok;
<a name="27493"/>27493: 	false -&gt;
<a name="27494"/>27494: 	    skip(?F(&quot;Neither recvtclass or tclass supported&quot;, []))
<a name="27495"/>27495:     end.
<a name="27496"/>27496: 
<a name="27497"/>27497: 
<a name="has_support_ipv6_recverr-0"/><a name="27498"/>27498: <b>has_support_ipv6_recverr</b>() -&gt;
<a name="has_support_ipv6_recverr-last_expr"/><a name="27499"/>27499: <b>    has_support_socket_option_ipv6</b>(recverr).
<a name="27500"/>27500: 
<a name="27501"/>27501: 
<a name="27502"/>27502: <i>%% --- TCP socket option test functions ---</i>
<a name="27503"/>27503: 
<a name="has_support_tcp_congestion-0"/><a name="27504"/>27504: <b>has_support_tcp_congestion</b>() -&gt;
<a name="has_support_tcp_congestion-last_expr"/><a name="27505"/>27505: <b>    has_support_socket_option_tcp</b>(congestion).
<a name="27506"/>27506: 
<a name="has_support_tcp_cork-0"/><a name="27507"/>27507: <b>has_support_tcp_cork</b>() -&gt;
<a name="has_support_tcp_cork-last_expr"/><a name="27508"/>27508: <b>    has_support_socket_option_tcp</b>(cork).
<a name="27509"/>27509: 
<a name="has_support_tcp_maxseg-0"/><a name="27510"/>27510: <b>has_support_tcp_maxseg</b>() -&gt;
<a name="has_support_tcp_maxseg-last_expr"/><a name="27511"/>27511: <b>    has_support_socket_option_tcp</b>(maxseg).
<a name="27512"/>27512: 
<a name="has_support_tcp_nodelay-0"/><a name="27513"/>27513: <b>has_support_tcp_nodelay</b>() -&gt;
<a name="has_support_tcp_nodelay-last_expr"/><a name="27514"/>27514: <b>    has_support_socket_option_tcp</b>(nodelay).
<a name="27515"/>27515: 
<a name="has_support_tcp_keepcnt-0"/><a name="27516"/>27516: <b>has_support_tcp_keepcnt</b>() -&gt;
<a name="has_support_tcp_keepcnt-last_expr"/><a name="27517"/>27517: <b>    has_support_socket_option_tcp</b>(keepcnt).
<a name="27518"/>27518: 
<a name="has_support_tcp_keepidle-0"/><a name="27519"/>27519: <b>has_support_tcp_keepidle</b>() -&gt;
<a name="has_support_tcp_keepidle-last_expr"/><a name="27520"/>27520: <b>    has_support_socket_option_tcp</b>(keepidle).
<a name="27521"/>27521: 
<a name="has_support_tcp_keepintvl-0"/><a name="27522"/>27522: <b>has_support_tcp_keepintvl</b>() -&gt;
<a name="has_support_tcp_keepintvl-last_expr"/><a name="27523"/>27523: <b>    has_support_socket_option_tcp</b>(keepintvl).
<a name="27524"/>27524: 
<a name="27525"/>27525: 
<a name="27526"/>27526: <i>%% --- UDP socket option test functions ---</i>
<a name="27527"/>27527: 
<a name="has_support_udp_cork-0"/><a name="27528"/>27528: <b>has_support_udp_cork</b>() -&gt;
<a name="has_support_udp_cork-last_expr"/><a name="27529"/>27529: <b>    has_support_socket_option_udp</b>(cork).
<a name="27530"/>27530: 
<a name="27531"/>27531: 
<a name="27532"/>27532: <i>%% --- General purpose socket option test functions ---</i>
<a name="27533"/>27533: 
<a name="has_support_socket_option_sock-1"/><a name="27534"/>27534: <b>has_support_socket_option_sock</b>(Opt) -&gt;
<a name="has_support_socket_option_sock-last_expr"/><a name="27535"/>27535: <b>    has_support_socket_option</b>(socket, Opt).
<a name="27536"/>27536: 
<a name="has_support_socket_option_ip-1"/><a name="27537"/>27537: <b>has_support_socket_option_ip</b>(Opt) -&gt;
<a name="has_support_socket_option_ip-last_expr"/><a name="27538"/>27538: <b>    has_support_socket_option</b>(ip, Opt).
<a name="27539"/>27539: 
<a name="has_support_socket_option_ipv6-1"/><a name="27540"/>27540: <b>has_support_socket_option_ipv6</b>(Opt) -&gt;
<a name="has_support_socket_option_ipv6-last_expr"/><a name="27541"/>27541: <b>    has_support_socket_option</b>(ipv6, Opt).
<a name="27542"/>27542: 
<a name="has_support_socket_option_tcp-1"/><a name="27543"/>27543: <b>has_support_socket_option_tcp</b>(Opt) -&gt;
<a name="has_support_socket_option_tcp-last_expr"/><a name="27544"/>27544: <b>    has_support_socket_option</b>(tcp, Opt).
<a name="27545"/>27545: 
<a name="has_support_socket_option_udp-1"/><a name="27546"/>27546: <b>has_support_socket_option_udp</b>(Opt) -&gt;
<a name="has_support_socket_option_udp-last_expr"/><a name="27547"/>27547: <b>    has_support_socket_option</b>(udp, Opt).
<a name="27548"/>27548: 
<a name="27549"/>27549: 
<a name="has_support_socket_option-2"/><a name="27550"/>27550: <b>has_support_socket_option</b>(Level, Option) -&gt;
<a name="has_support_socket_option-last_expr"/><a name="27551"/>27551: <b>    case socket:is_supported</b>(options, Level, Option) of
<a name="27552"/>27552:         true -&gt;
<a name="27553"/>27553:             ok;
<a name="27554"/>27554:         false -&gt;
<a name="27555"/>27555:             skip(?F(&quot;Not Supported: ~w option ~w&quot;, [Level, Option]))
<a name="27556"/>27556:     end.
<a name="27557"/>27557: 
<a name="is_any_options_supported-1"/><a name="27558"/>27558: <b>is_any_options_supported</b>(Options) -&gt;
<a name="27559"/>27559:     Pred = fun({Level, Option}) -&gt; socket:is_supported(options, Level, Option) end,
<a name="is_any_options_supported-last_expr"/><a name="27560"/>27560: <b>    lists:any</b>(Pred, Options).
<a name="27561"/>27561: 
<a name="27562"/>27562: 
<a name="27563"/>27563: <i>%% --- Send flag test functions ---</i>
<a name="27564"/>27564: 
<a name="has_support_msg_flag-1"/><a name="27565"/>27565: <b>has_support_msg_flag</b>(Flag) -&gt;
<a name="has_support_msg_flag-last_expr"/><a name="27566"/>27566: <b>    case socket:is_supported</b>(msg_flags, Flag) of
<a name="27567"/>27567:         true -&gt;
<a name="27568"/>27568:             ok;
<a name="27569"/>27569:         false -&gt;
<a name="27570"/>27570:             skip(?F(&quot;Message flag ~w *Not* Supported&quot;, [Flag]))
<a name="27571"/>27571:     end.
<a name="27572"/>27572: 
<a name="27573"/>27573: 
<a name="27574"/>27574: <i>%% Checks that the version is &quot;good enough&quot; (of the specified platform).</i>
<a name="27575"/>27575: 
<a name="is_good_enough_linux-1"/><a name="27576"/>27576: <b>is_good_enough_linux</b>(CondVsn) -&gt;
<a name="is_good_enough_linux-last_expr"/><a name="27577"/>27577: <b>    is_good_enough_platform</b>(unix, linux, CondVsn).
<a name="27578"/>27578: 
<a name="is_good_enough_darwin-1"/><a name="27579"/>27579: <b>is_good_enough_darwin</b>(CondVsn) -&gt;
<a name="is_good_enough_darwin-last_expr"/><a name="27580"/>27580: <b>    is_good_enough_platform</b>(unix, darwin, CondVsn).
<a name="27581"/>27581: 
<a name="is_good_enough_montavista-1"/><a name="27582"/>27582: <b>is_good_enough_montavista</b>(_Vsn) -&gt;
<a name="27583"/>27583:     %% We have *one* old M, which have kernel version 2.6.10.
<a name="27584"/>27584:     %% So if its that kernel version, we only need to check
<a name="27585"/>27585:     %% if its M (no need to figure out the version of M).
<a name="is_good_enough_montavista-last_expr"/><a name="27586"/>27586: <b>    case os:type</b>() of
<a name="27587"/>27587:         {unix, linux} -&gt;
<a name="27588"/>27588:             case os:version() of
<a name="27589"/>27589:                 {2,6,10} -&gt;
<a name="27590"/>27590:                     case etc_issue() of
<a name="27591"/>27591:                         &quot;MontaVista&quot; ++ _ = V -&gt; % Stone age MontaVista =&gt; Skip
<a name="27592"/>27592:                             skip(V);
<a name="27593"/>27593:                         _ -&gt;
<a name="27594"/>27594:                             ok
<a name="27595"/>27595:                     end;
<a name="27596"/>27596:                 _ -&gt;
<a name="27597"/>27597:                     ok
<a name="27598"/>27598:             end;
<a name="27599"/>27599:         _ -&gt;
<a name="27600"/>27600:             ok
<a name="27601"/>27601:     end.
<a name="27602"/>27602:                     
<a name="27603"/>27603: 
<a name="is_good_enough_platform-3"/><a name="27604"/>27604: <b>is_good_enough_platform</b>(Family, Name, CondVsn) -&gt;
<a name="is_good_enough_platform-last_expr"/><a name="27605"/>27605: <b>    case os:type</b>() of
<a name="27606"/>27606: 	{Family, Name} -&gt;
<a name="27607"/>27607: 	    ID = fun() -&gt; ?F(&quot;~w:~w&quot;, [Family, Name]) end,
<a name="27608"/>27608: 	    is_good_enough_platform2(os:version(), CondVsn, ID);
<a name="27609"/>27609: 	_ -&gt;
<a name="27610"/>27610: 	    ok
<a name="27611"/>27611:     end.
<a name="27612"/>27612: 
<a name="is_good_enough_platform2-3"/><a name="27613"/>27613: <b>is_good_enough_platform2</b>(Vsn, CondVsn, _) when (Vsn &gt; CondVsn) -&gt;
<a name="27614"/>27614:     ok;
<a name="27615"/>27615: <b>is_good_enough_platform2</b>(Vsn, CondVsn, ID) -&gt;
<a name="is_good_enough_platform2-last_expr"/><a name="27616"/>27616: <b>    skip</b>(?F(&quot;Not 'good enough' ~s (~p &lt;= ~p)&quot;, [ID(), Vsn, CondVsn])).
<a name="27617"/>27617: 
<a name="is_not_freebsd-0"/><a name="27618"/>27618: <b>is_not_freebsd</b>() -&gt;
<a name="is_not_freebsd-last_expr"/><a name="27619"/>27619: <b>    is_not_platform</b>(freebsd, &quot;FreeBSD&quot;).
<a name="27620"/>27620: 
<a name="is_not_openbsd-0"/><a name="27621"/>27621: <b>is_not_openbsd</b>() -&gt;
<a name="is_not_openbsd-last_expr"/><a name="27622"/>27622: <b>    is_not_platform</b>(openbsd, &quot;OpenBSD&quot;).
<a name="27623"/>27623: 
<a name="is_not_netbsd-0"/><a name="27624"/>27624: <b>is_not_netbsd</b>() -&gt;
<a name="is_not_netbsd-last_expr"/><a name="27625"/>27625: <b>    is_not_platform</b>(netbsd, &quot;NetBSD&quot;).
<a name="27626"/>27626: 
<a name="is_not_darwin-0"/><a name="27627"/>27627: <b>is_not_darwin</b>() -&gt;
<a name="is_not_darwin-last_expr"/><a name="27628"/>27628: <b>    is_not_platform</b>(darwin, &quot;Darwin&quot;).
<a name="27629"/>27629: 
<a name="etc_issue-0"/><a name="27630"/>27630: <b>etc_issue</b>() -&gt;
<a name="etc_issue-last_expr"/><a name="27631"/>27631: <b>    string:trim</b>(os:cmd(&quot;cat /etc/issue&quot;)).
<a name="27632"/>27632: 
<a name="is_not_windows-0"/><a name="27633"/>27633: <b>is_not_windows</b>() -&gt;
<a name="is_not_windows-last_expr"/><a name="27634"/>27634: <b>    case os:type</b>() of
<a name="27635"/>27635:         {win32, nt} -&gt;
<a name="27636"/>27636:             skip(&quot;This does not work on Windows&quot;);
<a name="27637"/>27637:         _ -&gt;
<a name="27638"/>27638:             ok
<a name="27639"/>27639:     end.
<a name="27640"/>27640: 
<a name="27641"/>27641: 
<a name="is_not_platform-2"/><a name="27642"/>27642: <b>is_not_platform</b>(Platform, PlatformStr)
<a name="27643"/>27643:   when is_atom(Platform) andalso is_list(PlatformStr) -&gt;
<a name="is_not_platform-last_expr"/><a name="27644"/>27644: <b>      case os:type</b>() of
<a name="27645"/>27645:           {unix, Platform} -&gt;
<a name="27646"/>27646:               skip(&quot;This does not work on &quot; ++ PlatformStr);
<a name="27647"/>27647:         _ -&gt;
<a name="27648"/>27648:             ok
<a name="27649"/>27649:     end.
<a name="27650"/>27650:   
<a name="27651"/>27651: 
<a name="unix_domain_socket_host_cond-0"/><a name="27652"/>27652: <b>unix_domain_socket_host_cond</b>() -&gt;
<a name="unix_domain_socket_host_cond-last_expr"/><a name="27653"/>27653: <b>    unix_domain_socket_host_cond</b>(os:type(), os:version()).
<a name="27654"/>27654: 
<a name="unix_domain_socket_host_cond-2"/><a name="27655"/>27655: <b>unix_domain_socket_host_cond</b>({unix, linux}, {M, _, _}) when (M &lt; 3) -&gt;
<a name="27656"/>27656:     skip(&quot;TC may not work on this version&quot;);
<a name="27657"/>27657: <b>unix_domain_socket_host_cond</b>(_, _) -&gt;
<a name="unix_domain_socket_host_cond-last_expr"/><a name="27658"/>27658:     ok.
<a name="27659"/>27659: 
<a name="has_support_unix_domain_socket-0"/><a name="27660"/>27660: <b>has_support_unix_domain_socket</b>() -&gt;
<a name="has_support_unix_domain_socket-last_expr"/><a name="27661"/>27661: <b>    case socket:is_supported</b>(local) of
<a name="27662"/>27662: 	true -&gt;
<a name="27663"/>27663: 	    ok;
<a name="27664"/>27664: 	false -&gt;
<a name="27665"/>27665: 	    skip(&quot;Not supported&quot;)
<a name="27666"/>27666:     end.
<a name="27667"/>27667: 
<a name="has_support_sctp-0"/><a name="27668"/>27668: <b>has_support_sctp</b>() -&gt;
<a name="has_support_sctp-last_expr"/><a name="27669"/>27669: <b>    case os:type</b>() of
<a name="27670"/>27670:         {win32, _} -&gt;
<a name="27671"/>27671:             skip(&quot;Not supported&quot;);
<a name="27672"/>27672:         {unix, netbsd} -&gt;
<a name="27673"/>27673:             %% XXX We will have to investigate this later...
<a name="27674"/>27674:             skip(&quot;Not supported&quot;);
<a name="27675"/>27675:         _ -&gt;
<a name="27676"/>27676:             case socket:is_supported(sctp) of
<a name="27677"/>27677:                 true -&gt;
<a name="27678"/>27678:                     ok;
<a name="27679"/>27679:                 false -&gt;
<a name="27680"/>27680:                     skip(&quot;Not supported&quot;)
<a name="27681"/>27681:             end
<a name="27682"/>27682:     end.
<a name="27683"/>27683: 
<a name="27684"/>27684: 
<a name="27685"/>27685: <i>%% The idea is that this function shall test if the test host has </i>
<a name="27686"/>27686: <i>%% support for IPv4 or IPv6. If not, there is no point in running corresponding tests.</i>
<a name="27687"/>27687: <i>%% Currently we just skip.</i>
<a name="has_support_ipv4-0"/><a name="27688"/>27688: <b>has_support_ipv4</b>() -&gt;
<a name="has_support_ipv4-last_expr"/><a name="27689"/>27689: <b>    ?KLIB:has_support_ipv4</b>().
<a name="27690"/>27690: 
<a name="has_support_ipv6-0"/><a name="27691"/>27691: <b>has_support_ipv6</b>() -&gt;
<a name="has_support_ipv6-last_expr"/><a name="27692"/>27692: <b>    ?KLIB:has_support_ipv6</b>().
<a name="27693"/>27693: 
<a name="inet_or_inet6-0"/><a name="27694"/>27694: <b>inet_or_inet6</b>() -&gt;
<a name="inet_or_inet6-last_expr"/><a name="27695"/>27695:     try
<a name="27696"/>27696:         has_support_ipv4(),
<a name="27697"/>27697:         inet
<a name="27698"/>27698:     catch
<a name="27699"/>27699:         throw:{skip, _Reason} -&gt;
<a name="27700"/>27700:             has_support_ipv6(),
<a name="27701"/>27701:             inet6
<a name="27702"/>27702:     end.
<a name="27703"/>27703: 
<a name="has_support_sendfile-0"/><a name="27704"/>27704: <b>has_support_sendfile</b>() -&gt;
<a name="has_support_sendfile-last_expr"/><a name="27705"/>27705: <b>    try socket:is_supported</b>(sendfile) of
<a name="27706"/>27706:         true -&gt;
<a name="27707"/>27707:             ok;
<a name="27708"/>27708:         false -&gt;
<a name="27709"/>27709:             skip(&quot;Not supported: sendfile&quot;)
<a name="27710"/>27710:     catch
<a name="27711"/>27711:         error : notsup -&gt;
<a name="27712"/>27712:             skip(&quot;Not supported: socket&quot;)
<a name="27713"/>27713:     end.
<a name="27714"/>27714: 
<a name="has_multi_scheds-0"/><a name="27715"/>27715: <b>has_multi_scheds</b>() -&gt;
<a name="has_multi_scheds-last_expr"/><a name="27716"/>27716: <b>    case erlang:system_info</b>(schedulers) of
<a name="27717"/>27717:         N when (N &gt; 1) -&gt;
<a name="27718"/>27718:             ok;
<a name="27719"/>27719:         _ -&gt;
<a name="27720"/>27720:             skip(&quot;Num schedulers *not* &gt; 1&quot;)
<a name="27721"/>27721:     end.
<a name="27722"/>27722: 
<a name="27723"/>27723: 
<a name="27724"/>27724: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27725"/>27725: 
<a name="unlink_path-1"/><a name="27726"/>27726: <b>unlink_path</b>(Path) -&gt;
<a name="unlink_path-last_expr"/><a name="27727"/>27727: <b>    unlink_path</b>(Path, fun() -&gt; ok end, fun() -&gt; ok end).
<a name="27728"/>27728: 
<a name="unlink_path-3"/><a name="27729"/>27729: <b>unlink_path</b>(Path, Success, Failure)
<a name="27730"/>27730:   when is_function(Success, 0), is_function(Failure, 0) -&gt;
<a name="unlink_path-last_expr"/><a name="27731"/>27731:     case Path of
<a name="27732"/>27732:         undefined -&gt;
<a name="27733"/>27733:             ?SEV_IPRINT(&quot;not a path to unlink&quot;),
<a name="27734"/>27734:                     Success();
<a name="27735"/>27735:         _ -&gt;
<a name="27736"/>27736:             ?SEV_IPRINT(&quot;try unlink path: &quot;
<a name="27737"/>27737:                         &quot;~n   ~s&quot;, [Path]),
<a name="27738"/>27738:             case file:delete(Path) of
<a name="27739"/>27739:                 ok -&gt;
<a name="27740"/>27740:                     ?SEV_IPRINT(&quot;path unlinked: &quot;
<a name="27741"/>27741:                                 &quot;~n   Path: ~s&quot;, [Path]),
<a name="27742"/>27742:                     Success();
<a name="27743"/>27743:                 Error -&gt;
<a name="27744"/>27744:                     ?SEV_EPRINT(&quot;unlink failed: &quot;
<a name="27745"/>27745:                                 &quot;~n   Path: ~s&quot;
<a name="27746"/>27746:                                 &quot;~n   Res:  ~p&quot;, [Path, Error]),
<a name="27747"/>27747:                     Failure()
<a name="27748"/>27748:             end
<a name="27749"/>27749:     end.
<a name="27750"/>27750: 
<a name="27751"/>27751: 
<a name="27752"/>27752: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27753"/>27753: 
<a name="not_supported-1"/><a name="27754"/>27754: <b>not_supported</b>(What) -&gt;
<a name="not_supported-last_expr"/><a name="27755"/>27755: <b>    skip</b>({not_supported, What}).
<a name="27756"/>27756: 
<a name="not_yet_implemented-0"/><a name="27757"/>27757: <b>not_yet_implemented</b>() -&gt;
<a name="not_yet_implemented-last_expr"/><a name="27758"/>27758: <b>    skip</b>(&quot;not yet implemented&quot;).
<a name="27759"/>27759: 
<a name="skip-1"/><a name="27760"/>27760: <b>skip</b>(Reason) -&gt;
<a name="skip-last_expr"/><a name="27761"/>27761: <b>    throw</b>({skip, Reason}).
<a name="27762"/>27762: 
<a name="27763"/>27763: 
<a name="27764"/>27764: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27765"/>27765: 
<a name="27766"/>27766: <i>%% *** tc_try/2,3 ***</i>
<a name="27767"/>27767: <i>%% Case:      Basically the test case name</i>
<a name="27768"/>27768: <i>%% TCCondFun: A fun that is evaluated before the actual test case</i>
<a name="27769"/>27769: <i>%%            The point of this is that it can performs checks to</i>
<a name="27770"/>27770: <i>%%            see if we shall run the test case at all.</i>
<a name="27771"/>27771: <i>%%            For instance, the test case may only work in specific</i>
<a name="27772"/>27772: <i>%%            conditions.</i>
<a name="27773"/>27773: <i>%% FCFun:     The test case fun</i>
<a name="tc_try-2"/><a name="27774"/>27774: <b>tc_try</b>(Case, TCFun) -&gt;
<a name="tc_try-last_expr"/><a name="27775"/>27775: <b>    ?TC_TRY</b>(Case, TCFun).
<a name="27776"/>27776: 
<a name="tc_try-3"/><a name="27777"/>27777: <b>tc_try</b>(Case, TCCondFun, TCFun) -&gt;
<a name="tc_try-last_expr"/><a name="27778"/>27778: <b>    ?TC_TRY</b>(Case, TCCondFun, TCFun).
<a name="27779"/>27779:    
<a name="27780"/>27780: 
<a name="27781"/>27781: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27782"/>27782: 
<a name="start_node-1"/><a name="27783"/>27783: <b>start_node</b>(Name) -&gt;
<a name="start_node-last_expr"/><a name="27784"/>27784: <b>    start_node</b>(Name, 5000).
<a name="27785"/>27785: 
<a name="start_node-2"/><a name="27786"/>27786: <b>start_node</b>(Name, Timeout) when is_integer(Timeout) andalso (Timeout &gt; 0) -&gt;
<a name="27787"/>27787:     Pa   = filename:dirname(code:which(?MODULE)),
<a name="27788"/>27788:     Args = [&quot;-pa&quot;, Pa,
<a name="27789"/>27789:             &quot;-s&quot;, atom_to_list(?PROXY), &quot;start&quot;, atom_to_list(node()),
<a name="27790"/>27790:             &quot;-s&quot;, &quot;global&quot;, &quot;sync&quot;],
<a name="start_node-last_expr"/><a name="27791"/>27791: <b>    try ?CT_PEER</b>(#{name      =&gt; Name,
<a name="27792"/>27792:                    wait_boot =&gt; Timeout,
<a name="27793"/>27793:                    args      =&gt; Args}) of
<a name="27794"/>27794:         {ok, Peer, Node} -&gt;
<a name="27795"/>27795:             ?SEV_IPRINT(&quot;Started node ~p - now (global) sync&quot;, [Name]),
<a name="27796"/>27796:             global:sync(), % Again, just in case...
<a name="27797"/>27797:             ?SEV_IPRINT(&quot;ping proxy&quot;),
<a name="27798"/>27798:             pong = ?PPING(Node),
<a name="27799"/>27799:             {Peer, Node};
<a name="27800"/>27800:         {error, Reason} -&gt;
<a name="27801"/>27801:             ?SEV_EPRINT(&quot;failed starting node ~p (=&gt; SKIP):&quot;
<a name="27802"/>27802:                         &quot;~n   ~p&quot;, [Name, Reason]),
<a name="27803"/>27803:             skip(Reason)
<a name="27804"/>27804:     catch
<a name="27805"/>27805:         Class:Reason:Stack -&gt;
<a name="27806"/>27806:             ?SEV_EPRINT(&quot;Failed starting node: &quot;
<a name="27807"/>27807:                         &quot;~n   Class:  ~p&quot;
<a name="27808"/>27808:                         &quot;~n   Reason: ~p&quot;
<a name="27809"/>27809:                         &quot;~n   Stack:  ~p&quot;,
<a name="27810"/>27810:                         [Class, Reason, Stack]),
<a name="27811"/>27811:             skip({node_start, Class, Reason})
<a name="27812"/>27812:     end.
<a name="27813"/>27813: 
<a name="27814"/>27814:             
<a name="27815"/>27815: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27816"/>27816: 
<a name="nowait-1"/><a name="27817"/>27817: <b>nowait</b>(Config) -&gt;
<a name="nowait-last_expr"/><a name="27818"/>27818: <b>    case lists:member</b>({select_handle, true}, Config) of
<a name="27819"/>27819:         true -&gt;
<a name="27820"/>27820:             make_ref();
<a name="27821"/>27821:         false -&gt;
<a name="27822"/>27822:             nowait
<a name="27823"/>27823:     end.
<a name="27824"/>27824: 
<a name="i-1"/><a name="27825"/>27825: <b>i</b>(F) -&gt;
<a name="i-last_expr"/><a name="27826"/>27826: <b>    i</b>(F, []).
<a name="27827"/>27827: 
<a name="i-2"/><a name="27828"/>27828: <b>i</b>(F, A) -&gt;
<a name="27829"/>27829:     FStr = ?F(&quot;[~s] &quot; ++ F, [?FTS()|A]),
<a name="27830"/>27830:     io:format(user, FStr ++ &quot;~n&quot;, []),
<a name="i-last_expr"/><a name="27831"/>27831: <b>    io:format</b>(FStr, []).
<a name="27832"/>27832: 
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
