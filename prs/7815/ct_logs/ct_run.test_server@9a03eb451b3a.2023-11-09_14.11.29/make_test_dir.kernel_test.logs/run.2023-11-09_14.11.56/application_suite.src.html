<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/kernel/make_test_dir/kernel_test/application_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 1996-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(application_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1, 
<a name="25"/>   25: 	 init_per_group/2,end_per_group/2
<a name="26"/>   26:      ]).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-export</b>([failover/1, failover_comp/1, permissions/1, load/1,
<a name="29"/>   29: 	 load_use_cache/1,
<a name="30"/>   30: 	 otp_1586/1, otp_2078/1, otp_2012/1, otp_2718/1, otp_2973/1,
<a name="31"/>   31: 	 otp_3002/1, otp_3184/1, otp_4066/1, otp_4227/1, otp_5363/1,
<a name="32"/>   32: 	 otp_5606/1,
<a name="33"/>   33: 	 start_phases/1, get_key/1, get_env/1, get_supervisor/1,
<a name="34"/>   34: 	 set_env/1, set_env_persistent/1, set_env_errors/1, optional_applications/1,
<a name="35"/>   35: 	 permit_false_start_local/1, permit_false_start_dist/1, script_start/1, 
<a name="36"/>   36: 	 nodedown_start/1, init2973/0, loop2973/0, loop5606/1, otp_16504/1]).
<a name="37"/>   37: 
<a name="38"/>   38: <b>-export</b>([config_change/1, persistent_env/1, invalid_app_file/1,
<a name="39"/>   39: 	 distr_changed_tc1/1, distr_changed_tc2/1,
<a name="40"/>   40: 	 ensure_started/1, ensure_all_started/1,
<a name="41"/>   41: 	 shutdown_func/1, do_shutdown/1, shutdown_timeout/1, shutdown_deadlock/1,
<a name="42"/>   42:          config_relative_paths/1, handle_many_config_files/1,
<a name="43"/>   43:          format_log_1/1, format_log_2/1,
<a name="44"/>   44:          configfd_bash/1, configfd_port_program/1]).
<a name="45"/>   45: 
<a name="46"/>   46: <b>-define</b>(TESTCASE, testcase_name).
<a name="47"/>   47: <b>-define</b>(testcase, proplists:get_value(?TESTCASE, Config)).
<a name="48"/>   48: 
<a name="49"/>   49: <b>-export</b>([init_per_testcase/2, end_per_testcase/2, start_type/0, 
<a name="50"/>   50: 	 start_phase/0, conf_change/0]).
<a name="51"/>   51: 
<a name="suite-0"/><a name="52"/>   52: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="53"/>   53:     [{ct_hooks,[ts_install_cth]},
<a name="54"/>   54:      {timetrap,{minutes,2}}].
<a name="55"/>   55: 
<a name="all-0"/><a name="56"/>   56: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="57"/>   57:     [failover, failover_comp, permissions, load,
<a name="58"/>   58:      load_use_cache, ensure_started, {group, reported_bugs}, start_phases,
<a name="59"/>   59:      script_start, nodedown_start, permit_false_start_local,
<a name="60"/>   60:      permit_false_start_dist, get_key, get_env, ensure_all_started,
<a name="61"/>   61:      set_env, set_env_persistent, set_env_errors, get_supervisor,
<a name="62"/>   62:      {group, distr_changed}, config_change, shutdown_func, shutdown_timeout,
<a name="63"/>   63:      shutdown_deadlock, config_relative_paths, optional_applications,
<a name="64"/>   64:      persistent_env, handle_many_config_files, format_log_1, format_log_2,
<a name="65"/>   65:      configfd_bash, configfd_port_program, invalid_app_file].
<a name="66"/>   66: 
<a name="groups-0"/><a name="67"/>   67: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="68"/>   68:     [{reported_bugs, [],
<a name="69"/>   69:       [otp_1586, otp_2078, otp_2012, otp_2718, otp_2973,
<a name="70"/>   70:        otp_3002, otp_3184, otp_4066, otp_4227, otp_5363,
<a name="71"/>   71:        otp_5606, otp_16504]},
<a name="72"/>   72:      {distr_changed, [],
<a name="73"/>   73:       [distr_changed_tc1, distr_changed_tc2]}].
<a name="74"/>   74: 
<a name="init_per_suite-1"/><a name="75"/>   75: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="76"/>   76:     Config.
<a name="77"/>   77: 
<a name="end_per_suite-1"/><a name="78"/>   78: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="79"/>   79:     ok.
<a name="80"/>   80: 
<a name="init_per_group-2"/><a name="81"/>   81: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="82"/>   82:     Config.
<a name="83"/>   83: 
<a name="end_per_group-2"/><a name="84"/>   84: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="85"/>   85:     Config.
<a name="86"/>   86: 
<a name="87"/>   87: 
<a name="88"/>   88: 
<a name="init_per_testcase-2"/><a name="89"/>   89: <b>init_per_testcase</b>(otp_2973=Case, Config) -&gt;
<a name="90"/>   90:     code:add_path(proplists:get_value(data_dir,Config)),
<a name="91"/>   91:     [{?TESTCASE, Case}|Config];
<a name="92"/>   92: <b>init_per_testcase</b>(Case, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="93"/>   93:     [{?TESTCASE, Case}|Config].
<a name="94"/>   94: 
<a name="end_per_testcase-2"/><a name="95"/>   95: <b>end_per_testcase</b>(otp_2973, Config) -&gt;
<a name="96"/>   96:     code:del_path(proplists:get_value(data_dir,Config)),
<a name="97"/>   97:     ok;
<a name="98"/>   98: <b>end_per_testcase</b>(_Case, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="99"/>   99:     ok.
<a name="100"/>  100: 
<a name="101"/>  101: <b>-define</b>(UNTIL(Seq), loop_until_true(fun() -&gt; Seq end)).
<a name="102"/>  102: 
<a name="103"/>  103: <b>-record</b>(st, {
<a name="104"/>  104:           normal = 0,
<a name="105"/>  105:           local = 0,
<a name="106"/>  106:           takeover = 0,
<a name="107"/>  107:           failover = 0
<a name="108"/>  108:          }).
<a name="109"/>  109: 
<a name="loop_until_true-1"/><a name="110"/>  110: <b>loop_until_true</b>(Fun) -&gt;
<a name="loop_until_true-last_expr"/><a name="111"/>  111: <b>    case Fun</b>() of
<a name="112"/>  112: 	true -&gt;
<a name="113"/>  113: 	    ok;
<a name="114"/>  114: 	_ -&gt;
<a name="115"/>  115: 	    timer:sleep(100),
<a name="116"/>  116: 	    loop_until_true(Fun)
<a name="117"/>  117:     end.
<a name="118"/>  118: 
<a name="119"/>  119: <i>%%-----------------------------------------------------------------</i>
<a name="120"/>  120: <i>%% Should be started in a CC view with:</i>
<a name="121"/>  121: <i>%% erl -sname XXX -rsh ctrsh where XX not in [cp1, cp2, cp3]</i>
<a name="122"/>  122: <i>%%-----------------------------------------------------------------</i>
<a name="123"/>  123: <i>%% Tests failover and takeover for distributed applications.  Tests</i>
<a name="124"/>  124: <i>%% start, load etc implicitly.</i>
<a name="failover-1"/><a name="125"/>  125: <b>failover</b>(Conf) when is_list(Conf) -&gt;
<a name="126"/>  126:     %% start a help process to check the start type
<a name="127"/>  127:     StPid = spawn_link(?MODULE, start_type, []),
<a name="128"/>  128:     yes = global:register_name(st_type, StPid),
<a name="129"/>  129: 
<a name="130"/>  130:     NodeNames = [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="131"/>  131:     NoSyncTime = config_fun_fast(config_fo(NodeNames)),
<a name="132"/>  132:     WithSyncTime = config_fun(config_fo(NodeNames)),
<a name="133"/>  133: 
<a name="134"/>  134:     %% Test [cp1, cp2, cp3]
<a name="135"/>  135:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="136"/>  136:     {ok, Cp2} = start_node_config(Ncp2, NoSyncTime, Conf),
<a name="137"/>  137:     {ok, Cp3} = start_node_config(Ncp3, WithSyncTime, Conf),
<a name="138"/>  138:     Cps = [Cp1, Cp2, Cp3],
<a name="139"/>  139:     wait_for_ready_net(),
<a name="140"/>  140: 
<a name="141"/>  141:     %% Start app1 and make sure cp1 starts it
<a name="142"/>  142:     {[ok,ok,ok],[]} = 
<a name="143"/>  143:         rpc:multicall(Cps, application, load, [app1()]),
<a name="144"/>  144:     ?UNTIL(is_loaded(app1, Cps)),
<a name="145"/>  145:     {[ok,ok,ok],[]} = 
<a name="146"/>  146:         rpc:multicall(Cps, application, start, [app1, permanent]),
<a name="147"/>  147:     ?UNTIL(is_started(app1, Cp1)),
<a name="148"/>  148:     false = is_started(app1, Cp2),
<a name="149"/>  149:     ok = get_start_type(#st{normal = 3}),
<a name="150"/>  150: 
<a name="151"/>  151:     %% Stop cp1 and make sure cp2 starts app1
<a name="152"/>  152:     stop_node_nice(Cp1),
<a name="153"/>  153:     ?UNTIL(is_started(app1, Cp2)),
<a name="154"/>  154:     ok = get_start_type(#st{normal = 3}),
<a name="155"/>  155: 
<a name="156"/>  156:     %% Restart cp1 and make sure it restarts app1
<a name="157"/>  157:     {ok, Cp1_2} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="158"/>  158:     global:sync(),
<a name="159"/>  159:     ok = rpc:call(Cp1_2, application, load, [app1()]),
<a name="160"/>  160:     ok = rpc:call(Cp1_2, application, start, [app1, permanent]),
<a name="161"/>  161:     ?UNTIL(is_started(app1, Cp1)),
<a name="162"/>  162:     ?UNTIL(not is_started(app1, Cp2)),
<a name="163"/>  163:     ok = get_start_type(#st{takeover = 3}),
<a name="164"/>  164: 
<a name="165"/>  165:     %% Test [{cp1, cp2}, cp3]
<a name="166"/>  166:     %% Start app_sp and make sure cp2 starts it (cp1 has more apps started)
<a name="167"/>  167:     {[ok,ok,ok],[]} =
<a name="168"/>  168:         rpc:multicall([Cp1_2, Cp2, Cp3], application, load, [app_sp()]),
<a name="169"/>  169:     {[ok,ok,ok],[]} = 
<a name="170"/>  170:         rpc:multicall([Cp1_2, Cp2, Cp3], application, start,[app_sp,permanent]),
<a name="171"/>  171:     ?UNTIL(is_started(app_sp, Cp2)),
<a name="172"/>  172:     false = is_started(app_sp, Cp1),
<a name="173"/>  173:     false = is_started(app_sp, Cp3),
<a name="174"/>  174:     ok = get_start_type(#st{normal = 3}),
<a name="175"/>  175: 	
<a name="176"/>  176:     %% Stop cp2 and make sure cp1 starts app_sp
<a name="177"/>  177:     stop_node_nice(Cp2),
<a name="178"/>  178:     ?UNTIL(is_started(app_sp, Cp1_2)),
<a name="179"/>  179:     ok = get_start_type(#st{failover = 3}),
<a name="180"/>  180: 	
<a name="181"/>  181:     %% Stop cp1 and make sure cp3 starts app_sp
<a name="182"/>  182:     stop_node_nice(Cp1_2),
<a name="183"/>  183:     ?UNTIL(is_started(app_sp, Cp3)),
<a name="184"/>  184:     ok = get_start_type(#st{normal = 3, failover = 3}),
<a name="185"/>  185: 
<a name="186"/>  186:     %% Restart cp2 and make sure it restarts app_sp
<a name="187"/>  187:     {ok, Cp2_2} = start_node_config(Ncp2, NoSyncTime, Conf),
<a name="188"/>  188:     global:sync(),
<a name="189"/>  189:     ok = rpc:call(Cp2_2, application, load, [app_sp()]),
<a name="190"/>  190:     ok = rpc:call(Cp2_2, application, start, [app_sp, permanent]),
<a name="191"/>  191:     ?UNTIL(is_started(app_sp, Cp2_2)),
<a name="192"/>  192:     ?UNTIL(not is_started(app_sp, Cp3)),
<a name="193"/>  193:     ok = get_start_type(#st{takeover = 3}),
<a name="194"/>  194: 
<a name="195"/>  195:     %% Restart cp1 and make sure it doesn't restart app_sp
<a name="196"/>  196:     {ok, Cp1_3} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="197"/>  197:     global:sync(),
<a name="198"/>  198:     ok = rpc:call(Cp1_3, application, load, [app_sp()]),
<a name="199"/>  199:     ok = rpc:call(Cp1_3, application, start, [app_sp, permanent]),
<a name="200"/>  200:     ct:sleep(500),
<a name="201"/>  201:     false = is_started(app_sp, Cp1_3),
<a name="202"/>  202:     true = is_started(app_sp, Cp2_2),
<a name="203"/>  203: 
<a name="204"/>  204:     %% Force takeover to cp1
<a name="205"/>  205:     ok = rpc:call(Cp1_3, application, takeover, [app_sp, permanent]),
<a name="206"/>  206:     ?UNTIL(is_started(app_sp, Cp1_3)),
<a name="207"/>  207:     ?UNTIL(not is_started(app_sp, Cp2_2)),
<a name="208"/>  208:     ok = get_start_type(#st{takeover = 3}),
<a name="209"/>  209: 
<a name="210"/>  210:     %% Kill one child process and see that it is started with type local
<a name="211"/>  211:     PP = global:whereis_name({ch,3}),
<a name="212"/>  212:     exit(PP, kill),
<a name="213"/>  213:     ok = get_start_type(#st{local = 1}),
<a name="214"/>  214: 
<a name="215"/>  215:     global:send(st_type, kill),
<a name="216"/>  216: 
<a name="217"/>  217:     stop_node_nice(Cp1_3),
<a name="218"/>  218:     stop_node_nice(Cp2_2),
<a name="219"/>  219:     stop_node_nice(Cp3),
<a name="failover-last_expr"/><a name="220"/>  220:     ok.
<a name="221"/>  221:     
<a name="222"/>  222: <i>%%-----------------------------------------------------------------</i>
<a name="223"/>  223: <i>%% Should be started in a CC view with:</i>
<a name="224"/>  224: <i>%% erl -sname XXX -rsh ctrsh where XX not in [cp1, cp2, cp3]</i>
<a name="225"/>  225: <i>%%-----------------------------------------------------------------</i>
<a name="226"/>  226: <i>%% Tests failover and takeover for distributed applications.  Tests</i>
<a name="227"/>  227: <i>%% start, load etc implicitly. The applications do not use start_phases</i>
<a name="228"/>  228: <i>%% i.e. the failover should be transferred to normal start type.</i>
<a name="failover_comp-1"/><a name="229"/>  229: <b>failover_comp</b>(Conf) when is_list(Conf) -&gt;
<a name="230"/>  230:     %% start a help process to check the start type
<a name="231"/>  231:     StPid = spawn_link(?MODULE, start_type, []),
<a name="232"/>  232:     yes = global:register_name(st_type, StPid),
<a name="233"/>  233: 
<a name="234"/>  234:     NodeNames = [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="235"/>  235:     NoSyncTime = config_fun_fast(config(NodeNames)),
<a name="236"/>  236:     WithSyncTime = config_fun(config(NodeNames)),
<a name="237"/>  237: 
<a name="238"/>  238:     %% Test [cp1, cp2, cp3]
<a name="239"/>  239:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="240"/>  240:     {ok, Cp2} = start_node_config(Ncp2, NoSyncTime, Conf),
<a name="241"/>  241:     {ok, Cp3} = start_node_config(Ncp3, WithSyncTime, Conf),
<a name="242"/>  242:     Cps = [Cp1, Cp2, Cp3],
<a name="243"/>  243:     wait_for_ready_net(),
<a name="244"/>  244: 
<a name="245"/>  245:     %% Start app1 and make sure cp1 starts it
<a name="246"/>  246:     {[ok,ok,ok],[]} = 
<a name="247"/>  247:         rpc:multicall(Cps, application, load, [app1()]),
<a name="248"/>  248:     ?UNTIL(is_loaded(app1, Cps)),
<a name="249"/>  249:     {[ok,ok,ok],[]} = 
<a name="250"/>  250:         rpc:multicall(Cps, application, start, [app1, permanent]),
<a name="251"/>  251:     ?UNTIL(is_started(app1, Cp1)),
<a name="252"/>  252:     false = is_started(app1, Cp2),
<a name="253"/>  253:     ok = get_start_type(#st{normal = 3}),
<a name="254"/>  254: 
<a name="255"/>  255:     %% Stop cp1 and make sure cp2 starts app1
<a name="256"/>  256:     stop_node_nice(Cp1),
<a name="257"/>  257:     ?UNTIL(is_started(app1, Cp2)),
<a name="258"/>  258:     ok = get_start_type(#st{normal = 3}),
<a name="259"/>  259: 
<a name="260"/>  260:     %% Restart cp1 and make sure it restarts app1
<a name="261"/>  261:     {ok, Cp1_2} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="262"/>  262:     global:sync(),
<a name="263"/>  263:     ok = rpc:call(Cp1_2, application, load, [app1()]),
<a name="264"/>  264:     ?UNTIL(is_loaded(app1, Cp1_2)),
<a name="265"/>  265:     ok = rpc:call(Cp1_2, application, start, [app1, permanent]),
<a name="266"/>  266:     ?UNTIL(is_started(app1, Cp1_2)),
<a name="267"/>  267:     ?UNTIL(not is_started(app1, Cp2)),
<a name="268"/>  268:     ok = get_start_type(#st{takeover = 3}),
<a name="269"/>  269: 
<a name="270"/>  270:     %% Test [{cp1, cp2}, cp3]
<a name="271"/>  271:     %% Start app3 and make sure cp2 starts it (cp1 has more apps started)
<a name="272"/>  272:     {[ok,ok,ok],[]} =
<a name="273"/>  273:         rpc:multicall([Cp1_2, Cp2, Cp3], application, load, [app3()]),
<a name="274"/>  274:     ?UNTIL(is_loaded(app3, [Cp1_2, Cp2, Cp3])),
<a name="275"/>  275:     {[ok,ok,ok],[]} = 
<a name="276"/>  276:         rpc:multicall([Cp1_2, Cp2, Cp3], application, start,[app3,permanent]),
<a name="277"/>  277:     ?UNTIL(is_started(app3, Cp2)),
<a name="278"/>  278:     false = is_started(app3, Cp1),
<a name="279"/>  279:     false = is_started(app3, Cp3),
<a name="280"/>  280:     ok = get_start_type(#st{normal = 3}),
<a name="281"/>  281: 	
<a name="282"/>  282:     %% Stop cp2 and make sure cp1 starts app3
<a name="283"/>  283:     stop_node_nice(Cp2),
<a name="284"/>  284:     ?UNTIL(is_started(app3, Cp1_2)),
<a name="285"/>  285:     ok = get_start_type(#st{normal = 3}),
<a name="286"/>  286: 	
<a name="287"/>  287:     %% Stop cp1 and make sure cp3 starts app3
<a name="288"/>  288:     stop_node_nice(Cp1_2),
<a name="289"/>  289:     ?UNTIL(is_started(app3, Cp3)),
<a name="290"/>  290:     ok = get_start_type(#st{normal = 6}),
<a name="291"/>  291: 
<a name="292"/>  292:     %% Restart cp2 and make sure it restarts app3
<a name="293"/>  293:     {ok, Cp2_2} = start_node_config(Ncp2, NoSyncTime, Conf),
<a name="294"/>  294:     global:sync(),
<a name="295"/>  295:     ok = rpc:call(Cp2_2, application, load, [app3()]),
<a name="296"/>  296:     ?UNTIL(is_loaded(app3, Cp2_2)),
<a name="297"/>  297:     ok = rpc:call(Cp2_2, application, start, [app3, permanent]),
<a name="298"/>  298:     ?UNTIL(is_started(app3, Cp2_2)),
<a name="299"/>  299:     ?UNTIL(not is_started(app3, Cp3)),
<a name="300"/>  300:     ok = get_start_type(#st{takeover = 3}),
<a name="301"/>  301: 
<a name="302"/>  302:     %% Restart cp1 and make sure it doesn't restart app3
<a name="303"/>  303:     {ok, Cp1_3} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="304"/>  304:     global:sync(),
<a name="305"/>  305:     ok = rpc:call(Cp1_3, application, load, [app3()]),
<a name="306"/>  306:     true = is_loaded(app3, Cp1_3),
<a name="307"/>  307:     ok = rpc:call(Cp1_3, application, start, [app3, permanent]),
<a name="308"/>  308:     ct:sleep(5000),
<a name="309"/>  309:     false = is_started(app3, Cp1_3),
<a name="310"/>  310:     true = is_started(app3, Cp2_2),
<a name="311"/>  311: 
<a name="312"/>  312:     %% Force takeover to cp1
<a name="313"/>  313:     ok = rpc:call(Cp1_3, application, takeover, [app3, permanent]),
<a name="314"/>  314:     ?UNTIL(is_started(app3, Cp1_3)),
<a name="315"/>  315:     ?UNTIL(not is_started(app3, Cp2_2)),
<a name="316"/>  316:     ok = get_start_type(#st{takeover = 3}),
<a name="317"/>  317: 
<a name="318"/>  318:     %% Kill one child process and see that it is started with type local
<a name="319"/>  319:     PP = global:whereis_name({ch,3}),
<a name="320"/>  320:     exit(PP, kill),
<a name="321"/>  321:     ok = get_start_type(#st{local = 1}),
<a name="322"/>  322: 
<a name="323"/>  323:     global:send(st_type, kill),
<a name="324"/>  324: 
<a name="325"/>  325:     stop_node_nice(Cp1_3),
<a name="326"/>  326:     stop_node_nice(Cp2_2),
<a name="327"/>  327:     stop_node_nice(Cp3),
<a name="failover_comp-last_expr"/><a name="328"/>  328:     ok.
<a name="329"/>  329: 
<a name="330"/>  330: <i>%%-----------------------------------------------------------------</i>
<a name="331"/>  331: <i>%% Should be started in a CC view with:</i>
<a name="332"/>  332: <i>%% erl -sname XXX -rsh ctrsh where XX not in [cp1, cp2, cp3]</i>
<a name="333"/>  333: <i>%%-----------------------------------------------------------------</i>
<a name="334"/>  334: <i>%% Tests permissions for distributed applications.</i>
<a name="permissions-1"/><a name="335"/>  335: <b>permissions</b>(Conf) when is_list(Conf) -&gt;
<a name="336"/>  336: 
<a name="337"/>  337:     NodeNames = [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="338"/>  338:     NoSyncTime = config_fun_fast(config2(NodeNames)),
<a name="339"/>  339:     WithSyncTime = config_fun(config2(NodeNames)),
<a name="340"/>  340: 
<a name="341"/>  341:     %% Test [cp1, cp2, cp3]
<a name="342"/>  342:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="343"/>  343:     {ok, Cp2} = start_node_config(Ncp2, NoSyncTime, Conf),
<a name="344"/>  344:     {ok, Cp3} = start_node_config(Ncp3, WithSyncTime, Conf),
<a name="345"/>  345:     Cps = [Cp1, Cp2, Cp3],
<a name="346"/>  346:     wait_for_ready_net(),
<a name="347"/>  347: 
<a name="348"/>  348:     %% Start app1 and make sure cp1 starts it
<a name="349"/>  349:     {[ok,ok,ok],[]} =
<a name="350"/>  350:         rpc:multicall(Cps, application, load, [app1()]),
<a name="351"/>  351:     ?UNTIL(is_loaded(app1, Cps)),
<a name="352"/>  352:     {[ok,ok,ok],[]} =
<a name="353"/>  353:         rpc:multicall(Cps, application, start, [app1, permanent]),
<a name="354"/>  354:     ?UNTIL(is_started(app1, Cp1)),
<a name="355"/>  355:     false = is_started(app1, Cp2),
<a name="356"/>  356: 
<a name="357"/>  357:     %% Unpermit app1 on cp1, make sure cp2 starts it
<a name="358"/>  358:     ok = rpc:call(Cp1, application, permit, [app1, false]),
<a name="359"/>  359:     false = is_started(app1, Cp1),
<a name="360"/>  360:     true = is_started(app1, Cp2),
<a name="361"/>  361: 
<a name="362"/>  362:     %% Unpermit app1 on cp2, make sure cp3 starts it
<a name="363"/>  363:     ok = rpc:call(Cp2, application, permit, [app1, false]),
<a name="364"/>  364:     false = is_started(app1, Cp1),
<a name="365"/>  365:     false = is_started(app1, Cp2),
<a name="366"/>  366:     true = is_started(app1, Cp3),
<a name="367"/>  367: 
<a name="368"/>  368:     %% Permit cp2 again
<a name="369"/>  369:     ok = rpc:call(Cp2, application, permit, [app1, true]),
<a name="370"/>  370:     false = is_started(app1, Cp1),
<a name="371"/>  371:     false = is_started(app1, Cp3),
<a name="372"/>  372:     true = is_started(app1, Cp2),
<a name="373"/>  373: 
<a name="374"/>  374:     %% Start app3, make sure no one starts it
<a name="375"/>  375:     {[ok,ok,ok],[]} = 
<a name="376"/>  376:         rpc:multicall(Cps, application, load, [app3()]),
<a name="377"/>  377:     ?UNTIL(is_loaded(app3, Cps)),
<a name="378"/>  378:     {[ok,ok,ok],[]} = 
<a name="379"/>  379:         rpc:multicall(Cps, application, start, [app3, permanent]),
<a name="380"/>  380:     ct:sleep(1000),
<a name="381"/>  381:     false = is_started(app3, Cp1),
<a name="382"/>  382:     false = is_started(app3, Cp2),
<a name="383"/>  383:     false = is_started(app3, Cp3),
<a name="384"/>  384: 
<a name="385"/>  385:     %% Permit app3 on Cp3
<a name="386"/>  386:     ok = rpc:call(Cp3, application, permit, [app3, true]),
<a name="387"/>  387:     true = is_started(app3, Cp3),
<a name="388"/>  388: 
<a name="389"/>  389:     %% Permit app3 on Cp2, make sure it starts it
<a name="390"/>  390:     ok = rpc:call(Cp2, application, permit, [app3, true]),
<a name="391"/>  391:     true = is_started(app3, Cp2),
<a name="392"/>  392:     false = is_started(app3, Cp3),
<a name="393"/>  393: 
<a name="394"/>  394:     %% Permit app3 on Cp1, make sure it doesn't start it
<a name="395"/>  395:     ok = rpc:call(Cp1, application, permit, [app3, true]),
<a name="396"/>  396:     false = is_started(app3, Cp1),
<a name="397"/>  397:     true = is_started(app3, Cp2),
<a name="398"/>  398:     false = is_started(app3, Cp3),
<a name="399"/>  399: 
<a name="400"/>  400:     %% Stop Cp2, make sure Cp1 starts app3
<a name="401"/>  401:     stop_node_nice(Cp2),
<a name="402"/>  402:     ?UNTIL(is_started(app3, Cp1)),
<a name="403"/>  403: 
<a name="404"/>  404:     stop_node_nice(Cp1),
<a name="405"/>  405:     stop_node_nice(Cp3),
<a name="permissions-last_expr"/><a name="406"/>  406:     ok.
<a name="407"/>  407: 
<a name="408"/>  408: <i>%%-----------------------------------------------------------------</i>
<a name="409"/>  409: <i>%% Should be started in a CC view with:</i>
<a name="410"/>  410: <i>%% erl -sname XXX -rsh ctrsh where XX not in [cp1, cp2, cp3]</i>
<a name="411"/>  411: <i>%%-----------------------------------------------------------------</i>
<a name="412"/>  412: <i>%% Tests loading of distributed applications.</i>
<a name="load-1"/><a name="413"/>  413: <b>load</b>(Conf) when is_list(Conf) -&gt;
<a name="414"/>  414:     NodeNames = [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="415"/>  415:     NoSyncTime = config_fun_fast(config3(NodeNames)),
<a name="416"/>  416:     WithSyncTime = config_fun(config3(NodeNames)),
<a name="417"/>  417: 
<a name="418"/>  418:     %% Test [cp1, cp2, cp3]
<a name="419"/>  419:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="420"/>  420:     {ok, Cp2} = start_node_config(Ncp2, NoSyncTime, Conf),
<a name="421"/>  421:     {ok, Cp3} = start_node_config(Ncp3, WithSyncTime, Conf),
<a name="422"/>  422:     Cps = [Cp1, Cp2, Cp3],
<a name="423"/>  423:     wait_for_ready_net(),
<a name="424"/>  424: 
<a name="425"/>  425:     {[ok,ok,ok],[]} = 
<a name="426"/>  426:         rpc:multicall(Cps, application, load, [app1(), d1(NodeNames)]),
<a name="427"/>  427:     ?UNTIL(is_loaded(app1, Cps)),
<a name="428"/>  428:     {[ok,ok,ok],[]} = 
<a name="429"/>  429:         rpc:multicall(Cps, application, start, [app1, permanent]),
<a name="430"/>  430:     ?UNTIL(is_started(app1, Cp1)),
<a name="431"/>  431:     false = is_started(app1, Cp2),
<a name="432"/>  432:     false = is_started(app1, Cp3),
<a name="433"/>  433: 
<a name="434"/>  434:     %% Load app1 with different specs and make sure we get an error
<a name="435"/>  435:     {[{error,_},{error,_}],[]} = 
<a name="436"/>  436:         rpc:multicall([Cp1, Cp2], application, load, [app1(), d1(NodeNames)]),
<a name="437"/>  437:     {error, _} = rpc:call(Cp3, application, load, [app1(), d2(NodeNames)]),
<a name="438"/>  438: 
<a name="439"/>  439:     stop_node_nice(Cp1),
<a name="440"/>  440:     stop_node_nice(Cp2),
<a name="441"/>  441:     stop_node_nice(Cp3),
<a name="load-last_expr"/><a name="442"/>  442:     ok.
<a name="443"/>  443:     
<a name="444"/>  444: <i>%%-----------------------------------------------------------------</i>
<a name="445"/>  445: <i>%% Same test as load/1, only with code path cache enabled.</i>
<a name="446"/>  446: <i>%%-----------------------------------------------------------------</i>
<a name="447"/>  447: <i>%% Tests loading of distributed applications. Code path cache enabled.</i>
<a name="load_use_cache-1"/><a name="448"/>  448: <b>load_use_cache</b>(Conf) when is_list(Conf) -&gt;
<a name="449"/>  449:     NodeNames = [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="450"/>  450:     NoSyncTime = config_fun_fast(config3(NodeNames)),
<a name="451"/>  451:     WithSyncTime = config_fun(config3(NodeNames)),
<a name="452"/>  452: 
<a name="453"/>  453:     %% Test [cp1, cp2, cp3]
<a name="454"/>  454:     {ok, Cp1} = start_node_with_cache(Ncp1, NoSyncTime, Conf),
<a name="455"/>  455:     {ok, Cp2} = start_node_with_cache(Ncp2, NoSyncTime, Conf),
<a name="456"/>  456:     {ok, Cp3} = start_node_with_cache(Ncp3, WithSyncTime, Conf),
<a name="457"/>  457:     Cps = [Cp1, Cp2, Cp3],
<a name="458"/>  458:     wait_for_ready_net(),
<a name="459"/>  459: 
<a name="460"/>  460:     {[ok,ok,ok],[]} = 
<a name="461"/>  461:         rpc:multicall(Cps, application, load, [app1(), d1(NodeNames)]),
<a name="462"/>  462:     ?UNTIL(is_loaded(app1, Cps)),
<a name="463"/>  463:     {[ok,ok,ok],[]} = 
<a name="464"/>  464:         rpc:multicall(Cps, application, start, [app1, permanent]),
<a name="465"/>  465:     ?UNTIL(is_started(app1, Cp1)),
<a name="466"/>  466:     false = is_started(app1, Cp2),
<a name="467"/>  467: 
<a name="468"/>  468:     %% Load app1 with different specs and make sure we get an error
<a name="469"/>  469:     {[{error,_},{error,_}],[]} = 
<a name="470"/>  470:         rpc:multicall([Cp1, Cp2], application, load, [app1(), d1(NodeNames)]),
<a name="471"/>  471:     {error, _} = rpc:call(Cp3, application, load, [app1(), d2(NodeNames)]),
<a name="472"/>  472: 
<a name="473"/>  473:     stop_node_nice(Cp1),
<a name="474"/>  474:     stop_node_nice(Cp2),
<a name="475"/>  475:     stop_node_nice(Cp3),
<a name="load_use_cache-last_expr"/><a name="476"/>  476:     ok.
<a name="477"/>  477: 
<a name="478"/>  478: <i>%%-----------------------------------------------------------------</i>
<a name="479"/>  479: <i>%% Should be started in a CC view with:</i>
<a name="480"/>  480: <i>%% erl -sname XXX -rsh ctrsh where XX not in [cp1, cp2, cp3]</i>
<a name="481"/>  481: <i>%%-----------------------------------------------------------------</i>
<a name="482"/>  482: <i>%% Tests new start phases and failover.</i>
<a name="start_phases-1"/><a name="483"/>  483: <b>start_phases</b>(Conf) when is_list(Conf) -&gt;
<a name="484"/>  484:     %% start a help process to check the start type
<a name="485"/>  485:     SpPid = spawn_link(?MODULE, start_phase, []),
<a name="486"/>  486:     yes = global:register_name(start_phase, SpPid),
<a name="487"/>  487: 
<a name="488"/>  488:     NodeNames = [Ncp1, _Ncp2, _Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="489"/>  489:     WithSyncTime = config_fun(config_sf(NodeNames)),
<a name="490"/>  490: 
<a name="491"/>  491:     {ok, Cp1} = start_node_config_sf(Ncp1, WithSyncTime, Conf),
<a name="492"/>  492:     wait_for_ready_net(),
<a name="493"/>  493: 
<a name="494"/>  494:     %%=============================
<a name="495"/>  495:     %%Example 1 in the user's guide
<a name="496"/>  496:     %%=============================
<a name="497"/>  497:     ok = rpc:call(Cp1, application, load, [myApp, 
<a name="498"/>  498:                                                  d_any3(myApp, NodeNames)]),
<a name="499"/>  499:     ?UNTIL(is_loaded(myApp, Cp1)),
<a name="500"/>  500:     ok = rpc:call(Cp1, application, start, [myApp, permanent]),
<a name="501"/>  501:     ?UNTIL(is_started(myApp, Cp1)),
<a name="502"/>  502:     ok = get_start_phase({sp, 0, 1, 0, 0, 1}),
<a name="503"/>  503:     ok = rpc:call(Cp1, application, stop, [myApp]),
<a name="504"/>  504: 
<a name="505"/>  505:     %%=============================
<a name="506"/>  506:     %%Example 2 in the user's guide
<a name="507"/>  507:     %%=============================
<a name="508"/>  508:     ok = rpc:call(Cp1, application, load, [topApp, 
<a name="509"/>  509:                                                  d_any3(topApp, NodeNames)]),
<a name="510"/>  510:     ?UNTIL(is_loaded(topApp, Cp1)),
<a name="511"/>  511:     ok = rpc:call(Cp1, application, start, [topApp, permanent]),
<a name="512"/>  512:     ?UNTIL(is_started(topApp, Cp1)),
<a name="513"/>  513:     ok = get_start_phase({sp, 0, 1, 0, 0, 1}),
<a name="514"/>  514:     ok = rpc:call(Cp1, application, stop, [topApp]),
<a name="515"/>  515: 	
<a name="516"/>  516:     %%=============================
<a name="517"/>  517:     %%Example 3 in the user's guide
<a name="518"/>  518:     %%=============================
<a name="519"/>  519:     ok = rpc:call(Cp1, application, load, [topApp2, 
<a name="520"/>  520:                                                  d_any3(topApp2, NodeNames)]),
<a name="521"/>  521:     ?UNTIL(is_loaded(topApp2, Cp1)),
<a name="522"/>  522:     ok = rpc:call(Cp1, application, start, [topApp2, permanent]),
<a name="523"/>  523:     ?UNTIL(is_started(topApp2, Cp1)),
<a name="524"/>  524:     ok = get_start_phase({sp, 0, 2, 0, 0, 3}),
<a name="525"/>  525:     ok = rpc:call(Cp1, application, stop, [topApp2]),
<a name="526"/>  526: 
<a name="527"/>  527:     %%=============================
<a name="528"/>  528:     %%Example 4 in the user's guide
<a name="529"/>  529:     %%=============================
<a name="530"/>  530:     ok = rpc:call(Cp1, application, load, [topApp3, 
<a name="531"/>  531:                                                  d_any3(topApp3, NodeNames)]),
<a name="532"/>  532:     ?UNTIL(is_loaded(topApp3, Cp1)),
<a name="533"/>  533:     ok = rpc:call(Cp1, application, start, [topApp3, permanent]),
<a name="534"/>  534:     ?UNTIL(is_started(topApp3, Cp1)),
<a name="535"/>  535:     ok = get_start_phase({sp, 1, 3, 3, 2, 4}),
<a name="536"/>  536:     ok = rpc:call(Cp1, application, stop, [topApp3]),
<a name="537"/>  537: 	
<a name="538"/>  538:     global:send(start_phase, kill),
<a name="539"/>  539: 
<a name="540"/>  540:     stop_node_nice(Cp1),
<a name="start_phases-last_expr"/><a name="541"/>  541:     ok.
<a name="542"/>  542: 
<a name="543"/>  543: 
<a name="544"/>  544: <i>%% Start distributed applications from within a boot script.  Test</i>
<a name="545"/>  545: <i>%%  same as failover.</i>
<a name="script_start-1"/><a name="546"/>  546: <b>script_start</b>(Conf) when is_list(Conf) -&gt;
<a name="547"/>  547:     %% start a help process to check the start type
<a name="548"/>  548:     StPid = spawn_link(?MODULE, start_type, []),
<a name="549"/>  549:     yes = global:register_name(st_type, StPid),
<a name="550"/>  550: 
<a name="551"/>  551: 
<a name="552"/>  552:     %% Create the .app files and the boot script
<a name="553"/>  553:     ok = create_app(),
<a name="554"/>  554:     {{KernelVer,StdlibVer}, _} = create_script(&quot;latest&quot;),
<a name="555"/>  555:     case is_real_system(KernelVer, StdlibVer) of
<a name="556"/>  556: 	      true -&gt;
<a name="557"/>  557: 		  Options = [];
<a name="558"/>  558: 	      false  -&gt;
<a name="559"/>  559: 		  Options = [local]
<a name="560"/>  560: 	  end,
<a name="561"/>  561:     ok = systools:make_script(&quot;latest&quot;, Options),
<a name="562"/>  562: 
<a name="563"/>  563:     NodeNames = [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="564"/>  564:     NoSyncTime = config_fun_fast(config_fo(NodeNames)),
<a name="565"/>  565:     WithSyncTime = config_fun(config_fo(NodeNames)),
<a name="566"/>  566: 
<a name="567"/>  567:     %% Test [cp1, cp2, cp3]
<a name="568"/>  568:     {ok, Cp1} = start_node_boot_config(Ncp1, NoSyncTime, Conf, latest),
<a name="569"/>  569:     {ok, Cp2} = start_node_boot_config(Ncp2, NoSyncTime, Conf, latest),
<a name="570"/>  570:     {ok, Cp3} = start_node_boot_config(Ncp3, WithSyncTime, Conf, latest),
<a name="571"/>  571:     wait_for_ready_net(),
<a name="572"/>  572: 
<a name="573"/>  573:     ?UNTIL(is_started(app1, Cp1)),
<a name="574"/>  574:     ?UNTIL(is_started(app2, Cp1)),
<a name="575"/>  575:     ?UNTIL(is_started(app_sp, Cp1)),
<a name="576"/>  576:     false = is_started(app1, Cp2),
<a name="577"/>  577:     ok = get_start_type(#st{normal = 9}),
<a name="578"/>  578: 
<a name="579"/>  579:     %% Stop cp1 and make sure cp2 starts app1, app2 normally (no
<a name="580"/>  580:     %% start_phases defined) and app_sp as failover (start_phases
<a name="581"/>  581:     %% defined)
<a name="582"/>  582:     stop_node_nice(Cp1),
<a name="583"/>  583:     ?UNTIL(is_started(app1, Cp2)),
<a name="584"/>  584:     ?UNTIL(is_started(app2, Cp2)),
<a name="585"/>  585:     ?UNTIL(is_started(app_sp, Cp2)),
<a name="586"/>  586:     ok = get_start_type(#st{normal = 6, failover = 3}),
<a name="587"/>  587: 	
<a name="588"/>  588:     %% Restart cp1, Cp1 takesover app1 and app2
<a name="589"/>  589:     {ok, Cp1_2} = start_node_boot_config(Ncp1, NoSyncTime, Conf, latest),
<a name="590"/>  590:     global:sync(),
<a name="591"/>  591:     ?UNTIL(is_started(app1, Cp1_2)),
<a name="592"/>  592:     false = is_started(app1, Cp2),
<a name="593"/>  593:     ?UNTIL(is_started(app2, Cp1_2)),
<a name="594"/>  594:     true = is_started(app_sp, Cp2),
<a name="595"/>  595:     ?UNTIL(not is_started(app1, Cp2)),
<a name="596"/>  596:     ?UNTIL(not is_started(app2, Cp2)),
<a name="597"/>  597:     ok = get_start_type(#st{takeover = 6}),
<a name="598"/>  598: 	
<a name="599"/>  599:     %% Stop cp2 and make sure cp1 starts app_sp.
<a name="600"/>  600:     false = is_started(app_sp, Cp1_2),
<a name="601"/>  601:     stop_node_nice(Cp2),
<a name="602"/>  602:     ?UNTIL(is_started(app_sp, Cp1_2)),
<a name="603"/>  603:     ok = get_start_type(#st{failover = 3}),
<a name="604"/>  604: 	
<a name="605"/>  605:     %% Stop cp1 and make sure cp3 starts app1, app2 and app_sp
<a name="606"/>  606:     stop_node_nice(Cp1_2),
<a name="607"/>  607:     ?UNTIL(is_started(app_sp, Cp3)),
<a name="608"/>  608:     ?UNTIL(is_started(app1, Cp3)),
<a name="609"/>  609:     ?UNTIL(is_started(app2, Cp3)),
<a name="610"/>  610:     ok = get_start_type(#st{normal = 6, failover = 3}),
<a name="611"/>  611: 	
<a name="612"/>  612:     %% Restart cp2 and make sure it takesover app1, app2 and app_sp
<a name="613"/>  613:     {ok, Cp2_2} = start_node_boot_config(Ncp2, NoSyncTime, Conf, latest),
<a name="614"/>  614:     global:sync(),
<a name="615"/>  615:     ?UNTIL(is_started(app_sp, Cp2_2)),
<a name="616"/>  616:     ?UNTIL(is_started(app1, Cp2_2)),
<a name="617"/>  617:     ?UNTIL(is_started(app2, Cp2_2)),
<a name="618"/>  618:     ?UNTIL(not is_started(app_sp, Cp3)),
<a name="619"/>  619:     ?UNTIL(not is_started(app1, Cp3)),
<a name="620"/>  620:     ?UNTIL(not is_started(app2, Cp3)),
<a name="621"/>  621:     ok = get_start_type(#st{takeover = 9}),
<a name="622"/>  622: 
<a name="623"/>  623:     %% Restart cp1 and make sure it takesover app1, app2
<a name="624"/>  624:     {ok, Cp1_3} = start_node_boot_config(Ncp1, NoSyncTime, Conf, latest),
<a name="625"/>  625:     global:sync(),
<a name="626"/>  626:     ?UNTIL(is_started(app1, Cp1_3)),
<a name="627"/>  627:     ?UNTIL(is_started(app2, Cp1_3)),
<a name="628"/>  628:     false = is_started(app_sp, Cp1_3),
<a name="629"/>  629:     true = is_started(app_sp, Cp2_2),
<a name="630"/>  630:     ?UNTIL(not is_started(app1, Cp2_2)),
<a name="631"/>  631:     ?UNTIL(not is_started(app2, Cp2_2)),
<a name="632"/>  632:     ok = get_start_type(#st{takeover = 6}),
<a name="633"/>  633: 
<a name="634"/>  634:     %% Force takeover to cp1
<a name="635"/>  635:     ok = rpc:call(Cp1_3, application, takeover, [app_sp, permanent]),
<a name="636"/>  636:     ?UNTIL(is_started(app_sp, Cp1_3)),
<a name="637"/>  637:     ?UNTIL(not is_started(app_sp, Cp2_2)),
<a name="638"/>  638:     ok = get_start_type(#st{takeover = 3}),
<a name="639"/>  639: 
<a name="640"/>  640:     %% Kill one child process and see that it is started with type local
<a name="641"/>  641:     PP = global:whereis_name({ch,3}),
<a name="642"/>  642:     exit(PP, kill),
<a name="643"/>  643:     ok = get_start_type(#st{local = 1}),
<a name="644"/>  644: 	
<a name="645"/>  645:     global:send(st_type, kill),
<a name="646"/>  646: 
<a name="647"/>  647:     stop_node_nice(Cp1_3),
<a name="648"/>  648:     stop_node_nice(Cp2_2),
<a name="649"/>  649:     stop_node_nice(Cp3),
<a name="650"/>  650:     
<a name="651"/>  651:     ok = file:delete(&quot;latest.boot&quot;),
<a name="652"/>  652:     ok = file:delete(&quot;latest.rel&quot;),
<a name="653"/>  653:     ok = file:delete(&quot;latest.script&quot;),
<a name="654"/>  654: 
<a name="script_start-last_expr"/><a name="655"/>  655:     ok.
<a name="656"/>  656: 
<a name="657"/>  657: <i>%% Start local applications with permission false.  Set</i>
<a name="658"/>  658: <i>%% permit true on different nodes.</i>
<a name="permit_false_start_local-1"/><a name="659"/>  659: <b>permit_false_start_local</b>(Conf) when is_list(Conf) -&gt;
<a name="660"/>  660:     %% This configuration does not start dist_ac.
<a name="661"/>  661:     Config = write_config_file(fun config_perm/1, Conf),
<a name="662"/>  662: 
<a name="663"/>  663:     %% Test [cp1, cp2, cp3]
<a name="664"/>  664:     [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="665"/>  665:     {ok, Cp1} = start_node(Ncp1, Config),
<a name="666"/>  666:     {ok, Cp2} = start_node(Ncp2, Config),
<a name="667"/>  667:     {ok, Cp3} = start_node(Ncp3, Config),
<a name="668"/>  668:     wait_for_ready_net(),
<a name="669"/>  669: 
<a name="670"/>  670:     {[ok,ok,ok],[]} = 
<a name="671"/>  671:         rpc:multicall([Cp1, Cp2, Cp3], application, load, [app1()]),
<a name="672"/>  672:     {[ok,ok,ok],[]} = 
<a name="673"/>  673:         rpc:multicall([Cp1, Cp2, Cp3], application, start, [app1, permanent]),
<a name="674"/>  674:     {[ok,ok,ok],[]} = 
<a name="675"/>  675:         rpc:multicall([Cp1, Cp2, Cp3], application, load, [app2()]),
<a name="676"/>  676:     {[ok,ok,ok],[]} = 
<a name="677"/>  677:         rpc:multicall([Cp1, Cp2, Cp3], application, start, [app2, permanent]),
<a name="678"/>  678:     {[ok,ok,ok],[]} = 
<a name="679"/>  679:         rpc:multicall([Cp1, Cp2, Cp3], application, load, [app3()]),
<a name="680"/>  680: 
<a name="681"/>  681:     ct:sleep(1000),
<a name="682"/>  682:     false = is_started(app1, Cp1),
<a name="683"/>  683:     false = is_started(app1, Cp2),
<a name="684"/>  684:     false = is_started(app1, Cp3),
<a name="685"/>  685: 
<a name="686"/>  686:     %% Permit a not started application
<a name="687"/>  687:     ok = rpc:call(Cp1, application, permit, [app3, true]),
<a name="688"/>  688:     ct:sleep(1000),
<a name="689"/>  689:     false = is_started(app3, Cp1),
<a name="690"/>  690:     false = is_started(app3, Cp2),
<a name="691"/>  691:     false = is_started(app3, Cp3),
<a name="692"/>  692: 
<a name="693"/>  693:     %% Permit a not loaded application
<a name="694"/>  694:     {error,{not_loaded,app_notloaded}} = 
<a name="695"/>  695: 	rpc:call(Cp1, application, permit, [app_notloaded, true]),
<a name="696"/>  696:     ct:sleep(1000),
<a name="697"/>  697:     false = is_started(app_notloaded, Cp1),
<a name="698"/>  698:     false = is_started(app_notloaded, Cp2),
<a name="699"/>  699:     false = is_started(app_notloaded, Cp3),
<a name="700"/>  700: 
<a name="701"/>  701:     %% Unpermit a not started application
<a name="702"/>  702:     ok = rpc:call(Cp1, application, permit, [app3, false]),
<a name="703"/>  703:     ct:sleep(1000),
<a name="704"/>  704:     false = is_started(app3, Cp1),
<a name="705"/>  705:     false = is_started(app3, Cp2),
<a name="706"/>  706:     false = is_started(app3, Cp3),
<a name="707"/>  707: 
<a name="708"/>  708:     %% Unpermit a not loaded application
<a name="709"/>  709:     {error,{not_loaded,app_notloaded}} = 
<a name="710"/>  710: 	rpc:call(Cp1, application, permit, [app_notloaded, false]),
<a name="711"/>  711:     ct:sleep(1000),
<a name="712"/>  712:     false = is_started(app_notloaded, Cp1),
<a name="713"/>  713:     false = is_started(app_notloaded, Cp2),
<a name="714"/>  714:     false = is_started(app_notloaded, Cp3),
<a name="715"/>  715: 
<a name="716"/>  716:     %% Permit app1 on CP1 and make sure it is started
<a name="717"/>  717:     ok = rpc:call(Cp1, application, permit, [app1, true]),
<a name="718"/>  718:     ?UNTIL(is_started(app1, Cp1)),
<a name="719"/>  719:     false = is_started(app1, Cp2),
<a name="720"/>  720:     false = is_started(app1, Cp3),
<a name="721"/>  721: 
<a name="722"/>  722:     %% Permit it again
<a name="723"/>  723:     ok = rpc:call(Cp1, application, permit, [app1, true]),
<a name="724"/>  724:     ct:sleep(1000),
<a name="725"/>  725:     true = is_started(app1, Cp1),
<a name="726"/>  726:     false = is_started(app1, Cp2),
<a name="727"/>  727:     false = is_started(app1, Cp3),
<a name="728"/>  728: 
<a name="729"/>  729:     %% Permit app2 on CP1 and make sure it is started
<a name="730"/>  730:     ok = rpc:call(Cp1, application, permit, [app2, true]),
<a name="731"/>  731:     ?UNTIL(is_started(app2, Cp1)),
<a name="732"/>  732:     false = is_started(app2, Cp2),
<a name="733"/>  733:     false = is_started(app2, Cp3),
<a name="734"/>  734: 
<a name="735"/>  735:     %% Permit app1 on CP2 and make sure it is started
<a name="736"/>  736:     ok = rpc:call(Cp2, application, permit, [app1, true]),
<a name="737"/>  737:     ?UNTIL(is_started(app1, Cp2)),
<a name="738"/>  738:     true = is_started(app1, Cp1),
<a name="739"/>  739:     false = is_started(app1, Cp3),
<a name="740"/>  740: 
<a name="741"/>  741:     %% Unpermit app1 on CP1 and make sure it is stopped
<a name="742"/>  742:     ok = rpc:call(Cp1, application, permit, [app1, false]),
<a name="743"/>  743:     ?UNTIL(false =:= is_started(app1, Cp1)),
<a name="744"/>  744:     true = is_started(app1, Cp2),
<a name="745"/>  745:     false = is_started(app1, Cp3),
<a name="746"/>  746: 
<a name="747"/>  747:     %% Unpermit it again
<a name="748"/>  748:     ok = rpc:call(Cp1, application, permit, [app1, false]),
<a name="749"/>  749:     ct:sleep(1000),
<a name="750"/>  750:     false = is_started(app1, Cp1),
<a name="751"/>  751:     true = is_started(app1, Cp2),
<a name="752"/>  752:     false = is_started(app1, Cp3),
<a name="753"/>  753: 
<a name="754"/>  754:     %% Permit app1 on CP1 and make sure it is started
<a name="755"/>  755:     ok = rpc:call(Cp1, application, permit, [app1, true]),
<a name="756"/>  756:     ?UNTIL(is_started(app1, Cp1)),
<a name="757"/>  757:     true = is_started(app1, Cp2),
<a name="758"/>  758:     false = is_started(app1, Cp3),
<a name="759"/>  759: 
<a name="760"/>  760:     %% Unpermit app1 on CP1 and make sure it is stopped
<a name="761"/>  761:     ok = rpc:call(Cp1, application, permit, [app1, false]),
<a name="762"/>  762:     ?UNTIL(false =:= is_started(app1, Cp1)),
<a name="763"/>  763:     true = is_started(app1, Cp2),
<a name="764"/>  764:     false = is_started(app1, Cp3),
<a name="765"/>  765: 
<a name="766"/>  766:     %% Unpermit app1 on CP2 and make sure it is stopped
<a name="767"/>  767:     ok = rpc:call(Cp2, application, permit, [app1, false]),
<a name="768"/>  768:     ct:sleep(1000),
<a name="769"/>  769:     ?UNTIL(false =:= is_started(app1, Cp2)),
<a name="770"/>  770:     false = is_started(app1, Cp1),
<a name="771"/>  771:     false = is_started(app1, Cp3),
<a name="772"/>  772: 
<a name="773"/>  773:     %% Unpermit app2 on CP1 and make sure it is stopped
<a name="774"/>  774:     ok = rpc:call(Cp1, application, permit, [app2, false]),
<a name="775"/>  775:     ?UNTIL(false =:= is_started(app2, Cp2)),
<a name="776"/>  776:     false = is_started(app2, Cp1),
<a name="777"/>  777:     false = is_started(app2, Cp3),
<a name="778"/>  778: 
<a name="779"/>  779:     stop_node_nice(Cp1),
<a name="780"/>  780:     stop_node_nice(Cp2),
<a name="781"/>  781:     stop_node_nice(Cp3),
<a name="permit_false_start_local-last_expr"/><a name="782"/>  782:     ok.
<a name="783"/>  783:     
<a name="784"/>  784: 
<a name="785"/>  785: <i>%% Start distributed applications with permission false.  Set</i>
<a name="786"/>  786: <i>%% permit true on different nodes.</i>
<a name="permit_false_start_dist-1"/><a name="787"/>  787: <b>permit_false_start_dist</b>(Conf) when is_list(Conf) -&gt;
<a name="788"/>  788:     NodeNames = [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="789"/>  789:     NoSyncTime = config_fun_fast(config_perm2(NodeNames)),
<a name="790"/>  790:     WithSyncTime = config_fun(config_perm2(NodeNames)),
<a name="791"/>  791: 
<a name="792"/>  792:     %% Test [cp1, cp2, cp3]
<a name="793"/>  793:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="794"/>  794:     {ok, Cp2} = start_node_config(Ncp2, NoSyncTime, Conf),
<a name="795"/>  795:     {ok, Cp3} = start_node_config(Ncp3, WithSyncTime, Conf),
<a name="796"/>  796:     Cps = [Cp1, Cp2, Cp3],
<a name="797"/>  797:     wait_for_ready_net(),
<a name="798"/>  798: 
<a name="799"/>  799:     {[ok,ok,ok],[]} = 
<a name="800"/>  800:         rpc:multicall(Cps, application, load, [app1()]),
<a name="801"/>  801:     ?UNTIL(is_loaded(app1, Cps)),
<a name="802"/>  802:     {[ok,ok,ok],[]} = 
<a name="803"/>  803:         rpc:multicall(Cps, application, start, [app1, permanent]),
<a name="804"/>  804:     {[ok,ok,ok],[]} = 
<a name="805"/>  805:         rpc:multicall(Cps, application, load, [app2()]),
<a name="806"/>  806: 
<a name="807"/>  807:     ct:sleep(1000),
<a name="808"/>  808:     false = is_started(app1, Cp1),
<a name="809"/>  809:     false = is_started(app1, Cp2),
<a name="810"/>  810:     false = is_started(app1, Cp3),
<a name="811"/>  811: 
<a name="812"/>  812:     %% Permit a not started application
<a name="813"/>  813:     ok = rpc:call(Cp1, application, permit, [app2, true]),
<a name="814"/>  814:     ct:sleep(1000),
<a name="815"/>  815:     false = is_started(app2, Cp1),
<a name="816"/>  816:     false = is_started(app2, Cp2),
<a name="817"/>  817:     false = is_started(app2, Cp3),
<a name="818"/>  818: 
<a name="819"/>  819:     %% Permit a not loaded application
<a name="820"/>  820:     {error,{not_loaded,app3}} = 
<a name="821"/>  821: 	rpc:call(Cp1, application, permit, [app3, true]),
<a name="822"/>  822:     ct:sleep(1000),
<a name="823"/>  823:     false = is_started(app3, Cp1),
<a name="824"/>  824:     false = is_started(app3, Cp2),
<a name="825"/>  825:     false = is_started(app3, Cp3),
<a name="826"/>  826: 
<a name="827"/>  827:     %% Unpermit a not started application
<a name="828"/>  828:     ok = rpc:call(Cp1, application, permit, [app2, false]),
<a name="829"/>  829:     {[ok,ok,ok],[]} = 
<a name="830"/>  830:         rpc:multicall([Cp1, Cp2, Cp3], application, start, [app2, permanent]),
<a name="831"/>  831:     ct:sleep(1000),
<a name="832"/>  832:     false = is_started(app2, Cp1),
<a name="833"/>  833:     false = is_started(app2, Cp2),
<a name="834"/>  834:     false = is_started(app2, Cp3),
<a name="835"/>  835: 
<a name="836"/>  836:     %% Unpermit a not loaded application
<a name="837"/>  837:     {error,{not_loaded,app3}} = 
<a name="838"/>  838: 	rpc:call(Cp1, application, permit, [app3, false]),
<a name="839"/>  839:     {[ok,ok,ok],[]} = 
<a name="840"/>  840:         rpc:multicall(Cps, application, load, [app3()]),
<a name="841"/>  841:     ?UNTIL(is_loaded(app3, Cps)),
<a name="842"/>  842:     {[ok,ok,ok],[]} = 
<a name="843"/>  843:         rpc:multicall(Cps, application, start, [app3, permanent]),
<a name="844"/>  844:     ct:sleep(1000),
<a name="845"/>  845:     false = is_started(app3, Cp1),
<a name="846"/>  846:     false = is_started(app3, Cp2),
<a name="847"/>  847:     false = is_started(app3, Cp3),
<a name="848"/>  848: 
<a name="849"/>  849:     %% Permit app1 on CP1 and make sure it is started
<a name="850"/>  850:     ok = rpc:call(Cp1, application, permit, [app1, true]),
<a name="851"/>  851:     ?UNTIL(is_started(app1, Cp1)),
<a name="852"/>  852:     false = is_started(app1, Cp2),
<a name="853"/>  853:     false = is_started(app1, Cp3),
<a name="854"/>  854: 
<a name="855"/>  855:     %% Permit it again
<a name="856"/>  856:     ok = rpc:call(Cp1, application, permit, [app1, true]),
<a name="857"/>  857:     ?UNTIL(is_started(app1, Cp1)),
<a name="858"/>  858:     false = is_started(app1, Cp2),
<a name="859"/>  859:     false = is_started(app1, Cp3),
<a name="860"/>  860: 
<a name="861"/>  861:     %% Permit app2 on CP1 and make sure it is started
<a name="862"/>  862:     ok = rpc:call(Cp1, application, permit, [app2, true]),
<a name="863"/>  863:     ?UNTIL(is_started(app2, Cp1)),
<a name="864"/>  864:     false = is_started(app2, Cp2),
<a name="865"/>  865:     false = is_started(app2, Cp3),
<a name="866"/>  866: 
<a name="867"/>  867:     %% Permit app1 on CP2 and make sure it is not started
<a name="868"/>  868:     ok = rpc:call(Cp2, application, permit, [app1, true]),
<a name="869"/>  869:     ct:sleep(1000),
<a name="870"/>  870:     true = is_started(app1, Cp1),
<a name="871"/>  871:     false = is_started(app1, Cp2),
<a name="872"/>  872:     false = is_started(app1, Cp3),
<a name="873"/>  873: 
<a name="874"/>  874:     %% Crash CP1 and make sure app1, but not app2, is started on CP2
<a name="875"/>  875:     stop_node_nice(Cp1),
<a name="876"/>  876:     ?UNTIL(is_started(app1, Cp2)),
<a name="877"/>  877:     false = is_started(app2, Cp2),
<a name="878"/>  878: 
<a name="879"/>  879:     %% Restart CP1 again, check nothing is running on it
<a name="880"/>  880:     {ok, Cp1_2} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="881"/>  881:     global:sync(),
<a name="882"/>  882:     ok = rpc:call(Cp1_2, application, load, [app1()]),
<a name="883"/>  883:     ?UNTIL(is_loaded(app1, Cp1_2)),
<a name="884"/>  884:     ok = rpc:call(Cp1_2, application, start, [app1, permanent]),
<a name="885"/>  885:     ok = rpc:call(Cp1_2, application, load, [app2()]),
<a name="886"/>  886:     ?UNTIL(is_loaded(app2, Cp1_2)),
<a name="887"/>  887:     ok = rpc:call(Cp1_2, application, start, [app2, permanent]),
<a name="888"/>  888:     ok = rpc:call(Cp1_2, application, load, [app3()]),
<a name="889"/>  889:     ?UNTIL(is_loaded(app3, Cp1_2)),
<a name="890"/>  890:     ok = rpc:call(Cp1_2, application, start, [app3, permanent]),
<a name="891"/>  891:     false = is_started(app1, Cp1_2),
<a name="892"/>  892:     false = is_started(app2, Cp1_2),
<a name="893"/>  893: 
<a name="894"/>  894:     %% Permit app3 on CP3 and make sure it is started
<a name="895"/>  895:     ok = rpc:call(Cp3, application, permit, [app3, true]),
<a name="896"/>  896:     ?UNTIL(is_started(app3, Cp3)),
<a name="897"/>  897:     false = is_started(app3, Cp1_2),
<a name="898"/>  898:     false = is_started(app3, Cp2),
<a name="899"/>  899: 
<a name="900"/>  900:     %% Permit app3 on CP1 and make sure it is moved there from CP3
<a name="901"/>  901:     ok = rpc:call(Cp1_2, application, permit, [app3, true]),
<a name="902"/>  902:     ?UNTIL(is_started(app3, Cp1_2)),
<a name="903"/>  903:     false = is_started(app3, Cp2),
<a name="904"/>  904:     false = is_started(app3, Cp3),
<a name="905"/>  905: 
<a name="906"/>  906:     %% Unpermit app3 on CP3 and CP1 and make sure it is stopped
<a name="907"/>  907:     ok = rpc:call(Cp3, application, permit, [app3, false]),
<a name="908"/>  908:     ok = rpc:call(Cp1_2, application, permit, [app3, false]),
<a name="909"/>  909:     ?UNTIL(false =:= is_started(app3, Cp1_2)),
<a name="910"/>  910:     false = is_started(app3, Cp2),
<a name="911"/>  911:     false = is_started(app3, Cp3),
<a name="912"/>  912: 
<a name="913"/>  913:     stop_node_nice(Cp1_2),
<a name="914"/>  914:     stop_node_nice(Cp2),
<a name="915"/>  915:     stop_node_nice(Cp3),
<a name="permit_false_start_dist-last_expr"/><a name="916"/>  916:     ok.
<a name="917"/>  917: 
<a name="918"/>  918: <i>%% app1 distributed as [cp1, cp2].  Call application:start(app1) on</i>
<a name="919"/>  919: <i>%% cp2, but not on cp1.  Kill cp1.  Make sure app1 is started on cp2.</i>
<a name="nodedown_start-1"/><a name="920"/>  920: <b>nodedown_start</b>(Conf) when is_list(Conf) -&gt;
<a name="921"/>  921:     NodeNames = [Ncp1, Ncp2] = node_names([cp1, cp2], Conf),
<a name="922"/>  922:     NoSyncTime = config_fun_fast(config4(NodeNames)),
<a name="923"/>  923:     WithSyncTime = config_fun(config4(NodeNames)),
<a name="924"/>  924: 
<a name="925"/>  925:     %% Test [cp1, cp2]
<a name="926"/>  926:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="927"/>  927:     {ok, Cp2} = start_node_config(Ncp2, WithSyncTime, Conf),
<a name="928"/>  928:     wait_for_ready_net(),
<a name="929"/>  929: 
<a name="930"/>  930:     %% Start app1 and make sure cp1 starts it
<a name="931"/>  931:     {[ok,ok],[]} = 
<a name="932"/>  932:         rpc:multicall([Cp1, Cp2], application, load, [app1()]),
<a name="933"/>  933:     _ = rpc:cast(Cp2, application, start, [app1, permanent]),
<a name="934"/>  934:     ct:sleep(1000),
<a name="935"/>  935: 
<a name="936"/>  936:     %% Crash CP1 and make sure app1 is started on CP2
<a name="937"/>  937:     stop_node_nice(Cp1),
<a name="938"/>  938:     ?UNTIL(is_started(app1, Cp2)),
<a name="939"/>  939:     
<a name="940"/>  940:     stop_node_nice(Cp2),
<a name="nodedown_start-last_expr"/><a name="941"/>  941:     ok.
<a name="942"/>  942: 
<a name="943"/>  943: 
<a name="944"/>  944: <i>%% Test application:ensure_started/1.</i>
<a name="ensure_started-1"/><a name="945"/>  945: <b>ensure_started</b>(_Conf) -&gt;
<a name="946"/>  946: 
<a name="947"/>  947:     {ok, Fd} = file:open(&quot;app1.app&quot;, [write]),
<a name="948"/>  948:     w_app1(Fd),
<a name="949"/>  949:     file:close(Fd),
<a name="950"/>  950: 
<a name="951"/>  951:     ok = application:ensure_started(app1),
<a name="952"/>  952:     ok = application:ensure_started(app1),
<a name="953"/>  953:     {error, {already_started, app1}} = application:start(app1),
<a name="954"/>  954:     ok = application:stop(app1),
<a name="955"/>  955:     {error,{&quot;no such file or directory&quot;, _ }} = application:ensure_started(hopefully_not_an_existing_app_file),
<a name="956"/>  956: 
<a name="957"/>  957:     ok = application:ensure_started(app1, permanent),
<a name="958"/>  958:     ok = application:ensure_started(app1, permanent),
<a name="959"/>  959:     ok = application:stop(app1),
<a name="960"/>  960:     ok = application:unload(app1),
<a name="ensure_started-last_expr"/><a name="961"/>  961:     ok.
<a name="962"/>  962: 
<a name="963"/>  963: <i>%% Test application:ensure_all_started/1-2-3.</i>
<a name="ensure_all_started-1"/><a name="964"/>  964: <b>ensure_all_started</b>(_Conf) -&gt;
<a name="965"/>  965:     do_ensure_all_started(serial),
<a name="966"/>  966:     do_ensure_all_started(concurrent),
<a name="ensure_all_started-last_expr"/><a name="967"/>  967:     ok.
<a name="968"/>  968: 
<a name="do_ensure_all_started-1"/><a name="969"/>  969: <b>do_ensure_all_started</b>(Mode) -&gt;
<a name="970"/>  970:     {ok, Fd1} = file:open(&quot;app1.app&quot;, [write]),
<a name="971"/>  971:     w_app1(Fd1),
<a name="972"/>  972:     file:close(Fd1),
<a name="973"/>  973:     {ok, Fd9} = file:open(&quot;app9.app&quot;, [write]),
<a name="974"/>  974:     w_app9(Fd9),
<a name="975"/>  975:     file:close(Fd9),
<a name="976"/>  976:     {ok, Fd10} = file:open(&quot;app10.app&quot;, [write]),
<a name="977"/>  977:     w_app10(Fd10, [app9], []),
<a name="978"/>  978:     file:close(Fd10),
<a name="979"/>  979:     {ok, FdErr} = file:open(&quot;app_chain_error.app&quot;, [write]),
<a name="980"/>  980:     w_app(FdErr, app_chain_error()),
<a name="981"/>  981:     file:close(FdErr),
<a name="982"/>  982:     {ok, FdErr2} = file:open(&quot;app_chain_error2.app&quot;, [write]),
<a name="983"/>  983:     w_app(FdErr2, app_chain_error2()),
<a name="984"/>  984:     file:close(FdErr2),
<a name="985"/>  985: 
<a name="986"/>  986:     %% Single app start/stop
<a name="987"/>  987:     false = lists:keyfind(app1, 1, application:which_applications()),
<a name="988"/>  988:     {ok, [app1]} = application:ensure_all_started(app1, temporary, Mode), % app1 started
<a name="989"/>  989:     {app1, _, _} = lists:keyfind(app1, 1, application:which_applications()),
<a name="990"/>  990:     {ok, []} = application:ensure_all_started(app1, temporary), % no start needed
<a name="991"/>  991:     {ok, []} = application:ensure_all_started(app1, permanent), % no start needed
<a name="992"/>  992:     ok = application:stop(app1),
<a name="993"/>  993:     false = lists:keyfind(app1, 1, application:which_applications()),
<a name="994"/>  994:     ok = application:unload(app1),
<a name="995"/>  995: 
<a name="996"/>  996:     %% App or dependency not found.
<a name="997"/>  997:     Name = hopefully_not_an_existing_app_file,
<a name="998"/>  998:     {error,{Name, {&quot;no such file or directory&quot;, _ }}} =
<a name="999"/>  999: 	application:ensure_all_started(Name),
<a name="1000"/> 1000: 
<a name="1001"/> 1001:     %% Start dependencies.
<a name="1002"/> 1002:     {error, {not_started, app9}} = application:start(app10),
<a name="1003"/> 1003:     {ok, [app9,app10]} = application:ensure_all_started(app10, temporary, Mode),
<a name="1004"/> 1004:     {app9, _, _} = lists:keyfind(app9, 1, application:which_applications()),
<a name="1005"/> 1005:     {app10, _, _} = lists:keyfind(app10, 1, application:which_applications()),
<a name="1006"/> 1006:     %% Only report apps/dependencies that actually needed to start
<a name="1007"/> 1007:     ok = application:stop(app10),
<a name="1008"/> 1008:     ok = application:unload(app10),
<a name="1009"/> 1009:     {ok, [app10]} = application:ensure_all_started(app10, temporary, Mode),
<a name="1010"/> 1010:     ok = application:stop(app9),
<a name="1011"/> 1011:     ok = application:unload(app9),
<a name="1012"/> 1012:     ok = application:stop(app10),
<a name="1013"/> 1013:     ok = application:unload(app10),
<a name="1014"/> 1014: 
<a name="1015"/> 1015:     %% Starts several
<a name="1016"/> 1016:     {ok, StartedSeveral} = application:ensure_all_started([app1, app10], temporary, Mode),
<a name="1017"/> 1017:     [app1,app10,app9] = lists:sort(StartedSeveral),
<a name="1018"/> 1018:     {app1, _, _} = lists:keyfind(app1, 1, application:which_applications()),
<a name="1019"/> 1019:     {app9, _, _} = lists:keyfind(app9, 1, application:which_applications()),
<a name="1020"/> 1020:     {app10, _, _} = lists:keyfind(app10, 1, application:which_applications()),
<a name="1021"/> 1021:     ok = application:stop(app1),
<a name="1022"/> 1022:     ok = application:unload(app1),
<a name="1023"/> 1023:     ok = application:stop(app9),
<a name="1024"/> 1024:     ok = application:unload(app9),
<a name="1025"/> 1025:     ok = application:stop(app10),
<a name="1026"/> 1026:     ok = application:unload(app10),
<a name="1027"/> 1027: 
<a name="1028"/> 1028:     %% Deeper failure chain. We have the following dependencies:
<a name="1029"/> 1029:     %% app_chain_error -&gt; app_chain_error2
<a name="1030"/> 1030:     %% app_chain_error2 -&gt; app10
<a name="1031"/> 1031:     %% app_chain_error2 -&gt; hopefully_not_an_existing_app
<a name="1032"/> 1032:     %% app10 -&gt; app 9
<a name="1033"/> 1033:     %% First we have none running and we expect to have neither app9
<a name="1034"/> 1034:     %% nor app10 running after failing to start
<a name="1035"/> 1035:     %% hopefully_not_an_existing_app
<a name="1036"/> 1036:     {error, {hopefully_not_an_existing_app, {&quot;no such file or directory&quot;, _}}}=
<a name="1037"/> 1037: 	application:ensure_all_started(app_chain_error, temporary, Mode),
<a name="1038"/> 1038:     false = lists:keyfind(app9, 1, application:which_applications()),
<a name="1039"/> 1039:     false = lists:keyfind(app10, 1, application:which_applications()),
<a name="1040"/> 1040:     false = lists:keyfind(app_chain_error2, 1, application:which_applications()),
<a name="1041"/> 1041:     false = lists:keyfind(app_chain_error, 1, application:which_applications()),
<a name="1042"/> 1042:     %% Here we will have app9 already running, and app10 should be
<a name="1043"/> 1043:     %% able to boot fine.
<a name="1044"/> 1044:     %% In this dependency failing, we expect app9 to still be running, but
<a name="1045"/> 1045:     %% not app10 after failing to start hopefully_not_an_existing_app
<a name="1046"/> 1046:     {ok, [app9]} = application:ensure_all_started(app9, temporary, Mode),
<a name="1047"/> 1047:     {error, {hopefully_not_an_existing_app, {&quot;no such file or directory&quot;, _}}}=
<a name="1048"/> 1048: 	application:ensure_all_started(app_chain_error),
<a name="1049"/> 1049:     {app9, _, _} = lists:keyfind(app9, 1, application:which_applications()),
<a name="1050"/> 1050:     false = lists:keyfind(app10, 1, application:which_applications()),
<a name="1051"/> 1051:     false = lists:keyfind(app_chain_error2,1,application:which_applications()),
<a name="1052"/> 1052:     false = lists:keyfind(app_chain_error, 1, application:which_applications()),
<a name="1053"/> 1053:     ok = application:stop(app9),
<a name="1054"/> 1054:     ok = application:unload(app9),
<a name="1055"/> 1055:     ok = application:unload(app10),
<a name="1056"/> 1056:     ok = application:unload(app_chain_error2),
<a name="1057"/> 1057:     ok = application:unload(app_chain_error),
<a name="do_ensure_all_started-last_expr"/><a name="1058"/> 1058:     ok.
<a name="1059"/> 1059: 
<a name="optional_applications-1"/><a name="1060"/> 1060: <b>optional_applications</b>(_Conf) -&gt;
<a name="1061"/> 1061:     {ok, Fd10} = file:open(&quot;app10.app&quot;, [write]),
<a name="1062"/> 1062:     w_app10(Fd10, [app9], []),
<a name="1063"/> 1063:     file:close(Fd10),
<a name="1064"/> 1064: 
<a name="1065"/> 1065:     {error,{not_started,app9}} = application:start(app10),
<a name="1066"/> 1066:     {ok, []} = application:get_key(app10, optional_applications),
<a name="1067"/> 1067:     ok = application:unload(app10),
<a name="1068"/> 1068: 
<a name="1069"/> 1069:     %% List app9 as an optional application and app10 starts
<a name="1070"/> 1070:     {ok, Fd10Opt} = file:open(&quot;app10.app&quot;, [write]),
<a name="1071"/> 1071:     w_app10(Fd10Opt, [app9], [app9]),
<a name="1072"/> 1072:     file:close(Fd10Opt),
<a name="1073"/> 1073: 
<a name="1074"/> 1074:     ok = application:start(app10),
<a name="1075"/> 1075:     {ok, [app9]} = application:get_key(app10, optional_applications),
<a name="1076"/> 1076:     false = lists:keymember(app9,1,application:which_applications()),
<a name="1077"/> 1077: 
<a name="1078"/> 1078:     ok = application:stop(app10),
<a name="1079"/> 1079:     ok = application:unload(app10),
<a name="1080"/> 1080: 
<a name="1081"/> 1081:     %% If app9 is defined, we can still start app10 without app9
<a name="1082"/> 1082:     {ok, Fd9} = file:open(&quot;app9.app&quot;, [write]),
<a name="1083"/> 1083:     w_app9(Fd9),
<a name="1084"/> 1084:     file:close(Fd9),
<a name="1085"/> 1085: 
<a name="1086"/> 1086:     ok = application:start(app10),
<a name="1087"/> 1087:     false = lists:keymember(app9,1,application:which_applications()),
<a name="1088"/> 1088: 
<a name="1089"/> 1089:     ok = application:stop(app10),
<a name="1090"/> 1090:     ok = application:unload(app10),
<a name="1091"/> 1091: 
<a name="1092"/> 1092:     %% But if we use ensure all started, then app9 is started too
<a name="1093"/> 1093:     {ok, [app9, app10]} = application:ensure_all_started(app10, temporary),
<a name="1094"/> 1094:     true = lists:keymember(app9,1,application:which_applications()),
<a name="1095"/> 1095: 
<a name="1096"/> 1096:     ok = application:stop(app9),
<a name="1097"/> 1097:     ok = application:unload(app9),
<a name="1098"/> 1098:     ok = application:stop(app10),
<a name="1099"/> 1099:     ok = application:unload(app10),
<a name="1100"/> 1100: 
<a name="1101"/> 1101:     %% Finally, let's have an optional dependency with a start error
<a name="1102"/> 1102:     {ok, Fd10Error} = file:open(&quot;app10.app&quot;, [write]),
<a name="1103"/> 1103:     w_app10(Fd10Error, [app_start_error], [app_start_error]),
<a name="1104"/> 1104:     file:close(Fd10Error),
<a name="1105"/> 1105: 
<a name="1106"/> 1106:     {ok, FdAppError} = file:open(&quot;app_start_error.app&quot;, [write]),
<a name="1107"/> 1107:     w_app_start_error(FdAppError),
<a name="1108"/> 1108:     file:close(FdAppError),
<a name="1109"/> 1109: 
<a name="1110"/> 1110:     {error,{app_start_error,_}} = application:ensure_all_started(app10, temporary),
<a name="1111"/> 1111:     ok = application:unload(app10),
<a name="optional_applications-last_expr"/><a name="1112"/> 1112:     ok.
<a name="1113"/> 1113: 
<a name="1114"/> 1114: <i>%%%-----------------------------------------------------------------</i>
<a name="1115"/> 1115: <i>%%% Testing of reported bugs and other tickets.</i>
<a name="1116"/> 1116: <i>%%%-----------------------------------------------------------------</i>
<a name="1117"/> 1117: 
<a name="1118"/> 1118: <i>%%-----------------------------------------------------------------</i>
<a name="1119"/> 1119: <i>%% Ticket: OTP-1586</i>
<a name="1120"/> 1120: <i>%% Slogan: recursive load of applications fails</i>
<a name="1121"/> 1121: <i>%%-----------------------------------------------------------------</i>
<a name="1122"/> 1122: <i>%% Test recursive load of applications.</i>
<a name="otp_1586-1"/><a name="1123"/> 1123: <b>otp_1586</b>(Conf) when is_list(Conf) -&gt;
<a name="1124"/> 1124:     Dir = proplists:get_value(priv_dir,Conf),
<a name="1125"/> 1125:     {ok, Fd} = file:open(filename:join(Dir, &quot;app5.app&quot;), [write]),
<a name="1126"/> 1126:     w_app5(Fd),
<a name="1127"/> 1127:     file:close(Fd),
<a name="otp_1586-last_expr"/><a name="1128"/> 1128:     try
<a name="1129"/> 1129: 	true = code:add_patha(Dir),
<a name="1130"/> 1130: 	ok = application:load(app4()),
<a name="1131"/> 1131: 	ok = application:unload(app4)
<a name="1132"/> 1132:     after
<a name="1133"/> 1133: 	_ = code:del_path(Dir)
<a name="1134"/> 1134:     end.
<a name="1135"/> 1135: 
<a name="1136"/> 1136: <i>%%-----------------------------------------------------------------</i>
<a name="1137"/> 1137: <i>%% Ticket: OTP-2078</i>
<a name="1138"/> 1138: <i>%% Slogan: start of distrib apps fails when the nodes start</i>
<a name="1139"/> 1139: <i>%%         simultaneously</i>
<a name="1140"/> 1140: <i>%%-----------------------------------------------------------------</i>
<a name="1141"/> 1141: <i>%% Test start of distrib apps fails when the nodes start simultaneously.</i>
<a name="otp_2078-1"/><a name="1142"/> 1142: <b>otp_2078</b>(Conf) when is_list(Conf) -&gt;
<a name="1143"/> 1143:     NodeNames = [Ncp1, Ncp2] = node_names([cp1, cp2], Conf),
<a name="1144"/> 1144:     NoSyncTime = config_fun_fast(config4(NodeNames)),
<a name="1145"/> 1145:     WithSyncTime = config_fun(config4(NodeNames)),
<a name="1146"/> 1146: 
<a name="1147"/> 1147:     %% Test [cp1, cp2]
<a name="1148"/> 1148:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="1149"/> 1149:     {ok, Cp2} = start_node_config(Ncp2, WithSyncTime, Conf),
<a name="1150"/> 1150:     Cps = [Cp1, Cp2],
<a name="1151"/> 1151:     wait_for_ready_net(),
<a name="1152"/> 1152: 
<a name="1153"/> 1153:     %% Start app1 and make sure cp1 starts it
<a name="1154"/> 1154:     {[ok,ok],[]} = 
<a name="1155"/> 1155:         rpc:multicall(Cps, application, load, [app1()]),
<a name="1156"/> 1156:     ?UNTIL(is_loaded(app1, Cps)),
<a name="1157"/> 1157:     ok = rpc:call(Cp1, application, start, [app1, permanent]),
<a name="1158"/> 1158:     ?UNTIL(is_started(app1, Cp1)),
<a name="1159"/> 1159:     false = is_started(app1, Cp2),
<a name="1160"/> 1160: 
<a name="1161"/> 1161:     %% Start app1 on cp2; make sure it works (the bug was that this start
<a name="1162"/> 1162:     %% returned error)
<a name="1163"/> 1163:     ok = rpc:call(Cp2, application, start, [app1, permanent]),
<a name="1164"/> 1164:     true = is_started(app1, Cp1),
<a name="1165"/> 1165:     false = is_started(app1, Cp2),
<a name="1166"/> 1166:     
<a name="1167"/> 1167:     stop_node_nice(Cp1),
<a name="1168"/> 1168:     stop_node_nice(Cp2),
<a name="otp_2078-last_expr"/><a name="1169"/> 1169:     ok.
<a name="1170"/> 1170: 
<a name="1171"/> 1171: <i>%% Test change of configuration parameters without changing code.</i>
<a name="otp_2012-1"/><a name="1172"/> 1172: <b>otp_2012</b>(Conf) when is_list(Conf) -&gt;
<a name="1173"/> 1173:     %% start a help process to check the config change
<a name="1174"/> 1174:     CcPid = spawn_link(?MODULE, conf_change, []),
<a name="1175"/> 1175:     yes = global:register_name(conf_change, CcPid),
<a name="1176"/> 1176: 
<a name="1177"/> 1177:     %% Write a .app file
<a name="1178"/> 1178:     {ok, Fd} = file:open(&quot;app1.app&quot;, [write]),
<a name="1179"/> 1179:     w_app1(Fd),
<a name="1180"/> 1180:     file:close(Fd),
<a name="1181"/> 1181:     {ok, Fd2} = file:open(&quot;app2.app&quot;, [write]),
<a name="1182"/> 1182:     w_app1(Fd2),
<a name="1183"/> 1183:     file:close(Fd2),
<a name="1184"/> 1184: 
<a name="1185"/> 1185:     %% Start app1
<a name="1186"/> 1186:     ok = application:load(app1()),
<a name="1187"/> 1187:     ok = application:start(app1, permanent),
<a name="1188"/> 1188: 
<a name="1189"/> 1189:     %% Read the current configuration parameters, and change them
<a name="1190"/> 1190:     EnvBefore = application_controller:prep_config_change(),
<a name="1191"/> 1191:     application_controller:test_change_apps([app1],[[{app1,[{new1, hi}, 
<a name="1192"/> 1192:                                                             {new2, moi}]}]]),
<a name="1193"/> 1193:     ok = application_controller:config_change(EnvBefore),
<a name="1194"/> 1194:     ok = get_conf_change([{[], [{new1, hi}, {new2, moi}], []}]),
<a name="1195"/> 1195:     
<a name="1196"/> 1196:     %% Start app2
<a name="1197"/> 1197:     ok = application:load(app2()),
<a name="1198"/> 1198:     ok = application:start(app2, permanent),
<a name="1199"/> 1199: 
<a name="1200"/> 1200:     %% Read the current configuration parameters, and change them again
<a name="1201"/> 1201:     EnvBefore2 = application_controller:prep_config_change(),
<a name="1202"/> 1202:     application_controller:test_change_apps([app1],[[{app1,[{new1, hello}, 
<a name="1203"/> 1203:                                                             {new3, mors}]}]]),
<a name="1204"/> 1204:     application_controller:test_change_apps([app2],[[{app2,[{new1, si}, 
<a name="1205"/> 1205:                                                             {new2, no}]}]]),
<a name="1206"/> 1206:     _EnvBefore22 = application_controller:prep_config_change(),
<a name="1207"/> 1207:     ok = application_controller:config_change(EnvBefore2),
<a name="1208"/> 1208:     
<a name="1209"/> 1209:     ok = get_conf_change([{[],[{new1,si},{new2,no}],[]},
<a name="1210"/> 1210:                                 {[{new1,hello}],[{new3,mors}],[new2]}]),
<a name="1211"/> 1211:     
<a name="1212"/> 1212:     ok = application:stop(app1),
<a name="1213"/> 1213:     ok = application:stop(app2),
<a name="otp_2012-last_expr"/><a name="1214"/> 1214:     ok.
<a name="1215"/> 1215: 
<a name="1216"/> 1216: <i>%%-----------------------------------------------------------------</i>
<a name="1217"/> 1217: <i>%% Ticket: OTP-2718</i>
<a name="1218"/> 1218: <i>%% Slogan: transient app which fails during start is ignored</i>
<a name="1219"/> 1219: <i>%%-----------------------------------------------------------------</i>
<a name="1220"/> 1220: <i>%% Test fail of transient app at start.</i>
<a name="otp_2718-1"/><a name="1221"/> 1221: <b>otp_2718</b>(Conf) when is_list(Conf) -&gt;
<a name="1222"/> 1222:     {ok, Cp1} = start_node_args(cp1, &quot;-pa &quot; ++ proplists:get_value(data_dir,Conf)),
<a name="1223"/> 1223:     wait_for_ready_net(),
<a name="1224"/> 1224: 
<a name="1225"/> 1225:     %% normal exit from the application
<a name="1226"/> 1226:     ok = rpc:call(Cp1, application, load, [app_trans_normal()]),
<a name="1227"/> 1227:     ?UNTIL(is_loaded(trans_normal, Cp1)),
<a name="1228"/> 1228:     {error, {{'EXIT',normal},_}} =
<a name="1229"/> 1229: 	rpc:call(Cp1, application, start, [trans_normal, transient]),
<a name="1230"/> 1230:     ct:sleep(2000),
<a name="1231"/> 1231:     false = is_started(trans_normal, Cp1),
<a name="1232"/> 1232: 
<a name="1233"/> 1233:     %% abnormal exit from the application
<a name="1234"/> 1234:     ok = rpc:call(Cp1, application, load, [app_trans_abnormal()]),
<a name="1235"/> 1235:     {error, {bad_return,{{trans_abnormal_sup,start,[normal,[]]},
<a name="1236"/> 1236: 			       {'EXIT',abnormal}}}} =
<a name="1237"/> 1237: 	rpc:call(Cp1, application, start, [trans_abnormal, transient]),
<a name="1238"/> 1238:     ct:sleep(3000),
<a name="1239"/> 1239:     {badrpc,nodedown} = which_applications(Cp1),
<a name="otp_2718-last_expr"/><a name="1240"/> 1240:     ok.
<a name="1241"/> 1241: 
<a name="1242"/> 1242: <i>%%-----------------------------------------------------------------</i>
<a name="1243"/> 1243: <i>%% Ticket: OTP-2973</i>
<a name="1244"/> 1244: <i>%% Slogan: application:start does not test if an appl is already starting...</i>
<a name="1245"/> 1245: <i>%%-----------------------------------------------------------------</i>
<a name="1246"/> 1246: <i>%% Test of two processes simultaneously starting the same application.</i>
<a name="otp_2973-1"/><a name="1247"/> 1247: <b>otp_2973</b>(Conf) when is_list(Conf) -&gt;
<a name="1248"/> 1248:     %% Write a .app file
<a name="1249"/> 1249:     {ok, Fd} = file:open(&quot;app0.app&quot;, [write]),
<a name="1250"/> 1250:     w_app(Fd, app0()),
<a name="1251"/> 1251:     file:close(Fd),
<a name="1252"/> 1252: 
<a name="1253"/> 1253:     Pid1 =  spawn_link(?MODULE, init2973, []),
<a name="1254"/> 1254:     Pid2 =  spawn_link(?MODULE, init2973, []),
<a name="1255"/> 1255: 
<a name="1256"/> 1256:     Pid1 ! {start, self(), app0},
<a name="1257"/> 1257:     Pid2 ! {start, self(), app0},
<a name="1258"/> 1258:     
<a name="1259"/> 1259:     {Res1, Res2} = receive 
<a name="1260"/> 1260: 			     {Pid1, res, Res1x} -&gt;
<a name="1261"/> 1261: 				 receive 
<a name="1262"/> 1262: 				     {Pid2, res, Res2x} -&gt;
<a name="1263"/> 1263: 					 {Res1x, Res2x}
<a name="1264"/> 1264: 				   after 2000 -&gt;
<a name="1265"/> 1265: 					   ct:fail(timeout_pid2)
<a name="1266"/> 1266: 				   end;
<a name="1267"/> 1267: 			     {Pid2, res, Res2x} -&gt;
<a name="1268"/> 1268: 				 receive 
<a name="1269"/> 1269: 				     {Pid1, res, Res1x} -&gt;
<a name="1270"/> 1270: 					 {Res1x, Res2x}
<a name="1271"/> 1271: 				 after 2000 -&gt;
<a name="1272"/> 1272: 					 ct:fail(timeout_pid1)
<a name="1273"/> 1273: 				 end
<a name="1274"/> 1274: 			 end,
<a name="1275"/> 1275: 
<a name="1276"/> 1276:     %% Stop it. Inteferes with other global.
<a name="1277"/> 1277:     ok = application:stop(app0),
<a name="1278"/> 1278: 
<a name="1279"/> 1279:     %% Test result.
<a name="1280"/> 1280:     case {Res1, Res2} of
<a name="1281"/> 1281: 	{ok, ok} -&gt;
<a name="1282"/> 1282: 	    ok;
<a name="1283"/> 1283: 	_ -&gt;
<a name="1284"/> 1284: 	    Txt = io_lib:format(&quot;Illegal results from start: ~p ~p &quot;,
<a name="1285"/> 1285: 				      [Res1, Res2]),
<a name="1286"/> 1286: 	    ct:fail(lists:flatten(Txt))
<a name="1287"/> 1287:     end,
<a name="1288"/> 1288: 
<a name="1289"/> 1289: 
<a name="1290"/> 1290:     %% Write a .app file
<a name="1291"/> 1291:     {ok, Fda} = file:open(&quot;app_start_error.app&quot;, [write]),
<a name="1292"/> 1292:     w_app_start_error(Fda),
<a name="1293"/> 1293:     file:close(Fda),
<a name="1294"/> 1294: 
<a name="1295"/> 1295:     Pid1 ! {start, self(), app_start_error},
<a name="1296"/> 1296:     Pid2 ! {start, self(), app_start_error},
<a name="1297"/> 1297:     
<a name="1298"/> 1298:     {Res1a, Res2a} = receive 
<a name="1299"/> 1299: 			       {Pid1, res, Res1y} -&gt;
<a name="1300"/> 1300: 				   receive 
<a name="1301"/> 1301: 				       {Pid2, res, Res2y} -&gt;
<a name="1302"/> 1302: 					   {Res1y, Res2y}
<a name="1303"/> 1303: 				   after 2000 -&gt;
<a name="1304"/> 1304: 					   ct:fail(timeout_pid2)
<a name="1305"/> 1305: 				   end;
<a name="1306"/> 1306: 			       {Pid2, res, Res2y} -&gt;
<a name="1307"/> 1307: 				   receive 
<a name="1308"/> 1308: 				       {Pid1, res, Res1y} -&gt;
<a name="1309"/> 1309: 					   {Res1y, Res2y}
<a name="1310"/> 1310: 				   after 2000 -&gt;
<a name="1311"/> 1311: 					   ct:fail(timeout_pid1)
<a name="1312"/> 1312: 				   end
<a name="1313"/> 1313: 			   end,
<a name="1314"/> 1314: 
<a name="1315"/> 1315:     case {Res1a, Res2a} of
<a name="1316"/> 1316: 	{{error,{'start error',{app_start_error,start,[normal,[]]}}}, 
<a name="1317"/> 1317: 	 {error,{'start error',{app_start_error,start,[normal,[]]}}}} -&gt;
<a name="1318"/> 1318: 	    ok;
<a name="1319"/> 1319: 	_ -&gt;
<a name="1320"/> 1320: 	    Txta = io_lib:format(&quot;Illegal results from start ~p ~p &quot;,[Res1a, Res2a]),
<a name="1321"/> 1321: 	    ct:fail(lists:flatten(Txta))
<a name="1322"/> 1322:     end,
<a name="1323"/> 1323: 
<a name="otp_2973-last_expr"/><a name="1324"/> 1324:     ok.
<a name="1325"/> 1325: 
<a name="1326"/> 1326: 
<a name="1327"/> 1327: 
<a name="1328"/> 1328: <i>%%-----------------------------------------------------------------</i>
<a name="1329"/> 1329: <i>%% Ticket: OTP-3184</i>
<a name="1330"/> 1330: <i>%% Slogan: crash the node if permanent appl has illegal env parameter values</i>
<a name="1331"/> 1331: <i>%%-----------------------------------------------------------------</i>
<a name="1332"/> 1332: <i>%% When a distributed application is started the permit flag is checked</i>
<a name="1333"/> 1333: <i>%% that the permit flag is not changed during the start.</i>
<a name="1334"/> 1334: <i>%% The check must only be made if the application is started on the own node.</i>
<a name="otp_3184-1"/><a name="1335"/> 1335: <b>otp_3184</b>(Conf) when is_list(Conf) -&gt;
<a name="1336"/> 1336:     NodeNames = [Ncp1, Ncp2] = node_names([cp1, cp2], Conf),
<a name="1337"/> 1337:     NoSyncTime = config_fun_fast(config3184(NodeNames)),
<a name="1338"/> 1338:     WithSyncTime = config_fun(config3184(NodeNames)),
<a name="1339"/> 1339: 
<a name="1340"/> 1340:     %% Test [cp1, cp2]
<a name="1341"/> 1341:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="1342"/> 1342:     {ok, Cp2} = start_node_config(Ncp2, WithSyncTime, Conf),
<a name="1343"/> 1343:     wait_for_ready_net(),
<a name="1344"/> 1344: 
<a name="1345"/> 1345:     %% Start app1 and make sure it is not started
<a name="1346"/> 1346:     {[ok,ok],[]} = 
<a name="1347"/> 1347:         rpc:multicall([Cp1, Cp2], application, load, [app1()]),
<a name="1348"/> 1348:     ct:sleep(3000),
<a name="1349"/> 1349:     false = is_started(app1, Cp1),
<a name="1350"/> 1350:     false = is_started(app1, Cp2),
<a name="1351"/> 1351: 
<a name="1352"/> 1352:     %% Start app1 on cp1
<a name="1353"/> 1353:     ok = rpc:call(Cp1, application, permit, [app1, true]),
<a name="1354"/> 1354:     ok = rpc:call(Cp1, application, start, [app1, permanent]),
<a name="1355"/> 1355:     ok = rpc:call(Cp2, application, start, [app1, permanent]),
<a name="1356"/> 1356:     ?UNTIL(is_started(app1, Cp1)),
<a name="1357"/> 1357:     false = is_started(app1, Cp2),
<a name="1358"/> 1358:     
<a name="1359"/> 1359:     %% Check that the application is marked as running in application_controller
<a name="1360"/> 1360:     X = rpc:call(Cp1, application_controller, info, []),
<a name="1361"/> 1361:     {value, {running, Xrunning}} = lists:keysearch(running, 1, X),
<a name="1362"/> 1362:     {value, Xapp1} = lists:keysearch(app1, 1, Xrunning),
<a name="1363"/> 1363:     {app1, _Xpid} = Xapp1,
<a name="1364"/> 1364: 
<a name="1365"/> 1365:     Y = rpc:call(Cp2, application_controller, info, []),
<a name="1366"/> 1366:     {value, {running, Yrunning}} = lists:keysearch(running, 1, Y),
<a name="1367"/> 1367:     {value, Yapp1} = lists:keysearch(app1, 1, Yrunning),
<a name="1368"/> 1368:     {app1, {distributed, Cp1}} = Yapp1,
<a name="1369"/> 1369: 
<a name="1370"/> 1370:     stop_node_nice(Cp1),
<a name="1371"/> 1371:     stop_node_nice(Cp2),
<a name="otp_3184-last_expr"/><a name="1372"/> 1372:     ok.
<a name="1373"/> 1373: 
<a name="1374"/> 1374: <i>%%-----------------------------------------------------------------</i>
<a name="1375"/> 1375: <i>%% Ticket: OTP-3002</i>
<a name="1376"/> 1376: <i>%% Slogan: crash the node if permanent appl has illegal env parameter values</i>
<a name="1377"/> 1377: <i>%%-----------------------------------------------------------------</i>
<a name="1378"/> 1378: <i>%% crash the node if permanent appl has illegal env parameter values.</i>
<a name="otp_3002-1"/><a name="1379"/> 1379: <b>otp_3002</b>(Conf) when is_list(Conf) -&gt;
<a name="1380"/> 1380:     %% Create the boot script
<a name="1381"/> 1381:     {{KernelVer,StdlibVer}, {LatestDir, LatestName}} =
<a name="1382"/> 1382: 	create_script_3002(&quot;script_3002&quot;),
<a name="1383"/> 1383:     ct:pal(?HI_VERBOSITY, &quot;LatestDir = ~p~n&quot;, [LatestDir]),
<a name="1384"/> 1384:     ct:pal(?HI_VERBOSITY, &quot;LatestName = ~p~n&quot;, [LatestName]),
<a name="1385"/> 1385: 
<a name="1386"/> 1386:     case is_real_system(KernelVer, StdlibVer) of
<a name="1387"/> 1387: 	      true -&gt;
<a name="1388"/> 1388: 		  Options = [];
<a name="1389"/> 1389: 	      false  -&gt;
<a name="1390"/> 1390: 		  Options = [local]
<a name="1391"/> 1391: 	  end,
<a name="1392"/> 1392: 
<a name="1393"/> 1393:     ok = systools:make_script(&quot;script_3002&quot;, Options),
<a name="1394"/> 1394:     ok = systools:script2boot(&quot;script_3002&quot;),
<a name="1395"/> 1395: 
<a name="1396"/> 1396:     {error, timeout} = start_node_boot_3002(cp1, &quot;script_3002&quot;),
<a name="1397"/> 1397: 
<a name="1398"/> 1398:     ok = file:delete(&quot;script_3002.boot&quot;),
<a name="1399"/> 1399:     ok = file:delete(&quot;script_3002.rel&quot;),
<a name="1400"/> 1400:     ok = file:delete(&quot;script_3002.script&quot;),
<a name="otp_3002-last_expr"/><a name="1401"/> 1401:     ok.
<a name="1402"/> 1402: 
<a name="1403"/> 1403: <i>%%-----------------------------------------------------------------</i>
<a name="1404"/> 1404: <i>%% Ticket: OTP-4066</i>
<a name="1405"/> 1405: <i>%% Slogan: dist_ac crashed if a distributed application that it</i>
<a name="1406"/> 1406: <i>%%         didn't know of was stopped by another dist_ac (bad_match</i>
<a name="1407"/> 1407: <i>%%         when it received dist_ac_app_stopped).</i>
<a name="1408"/> 1408: <i>%%-----------------------------------------------------------------</i>
<a name="1409"/> 1409: 
<a name="1410"/> 1410: <i>%% Check that application stop don't cause dist_ac crash.</i>
<a name="otp_4066-1"/><a name="1411"/> 1411: <b>otp_4066</b>(Conf) when is_list(Conf) -&gt;
<a name="1412"/> 1412:     %% Write config files
<a name="1413"/> 1413:     [Ncp1, Ncp2] = node_names([cp1, cp2], Conf),
<a name="1414"/> 1414:     Host = from($@, atom_to_list(node())),
<a name="1415"/> 1415:     Cp1 = list_to_atom(Ncp1 ++ &quot;@&quot; ++ Host),
<a name="1416"/> 1416:     Cp2 = list_to_atom(Ncp2 ++ &quot;@&quot; ++ Host),
<a name="1417"/> 1417:     AllNodes = [Cp1, Cp2],
<a name="1418"/> 1418:     App1Nodes = {app1, AllNodes},
<a name="1419"/> 1419: 
<a name="1420"/> 1420:     Dir = proplists:get_value(priv_dir,Conf),
<a name="1421"/> 1421:     {ok, FdC} = file:open(filename:join(Dir, &quot;otp_4066.config&quot;), [write]),
<a name="1422"/> 1422:     write_config(FdC, config_4066(AllNodes, 5000, [App1Nodes])),
<a name="1423"/> 1423:     file:close(FdC),
<a name="1424"/> 1424: 
<a name="1425"/> 1425:     %% Write the app1.app file
<a name="1426"/> 1426:     {ok, FdA12} = file:open(filename:join(Dir, &quot;app1.app&quot;), [write]),
<a name="1427"/> 1427:     w_app1(FdA12),
<a name="1428"/> 1428:     file:close(FdA12),
<a name="1429"/> 1429: 
<a name="1430"/> 1430:     Args1 = &quot;-pa &quot; ++ Dir ++ &quot; -config &quot; ++ filename:join(Dir, &quot;otp_4066&quot;),
<a name="1431"/> 1431:     Args2 =  &quot;-pa &quot; ++ Dir ++ &quot; -kernel start_dist_ac true&quot;,
<a name="1432"/> 1432: 
<a name="1433"/> 1433:     {ok, Cp2} = start_node_args(Ncp2, Args2),
<a name="1434"/> 1434:     %% Cp1 syncs with cp2 (which is known to be up).
<a name="1435"/> 1435:     {ok, Cp1} = start_node_args(Ncp1, Args1),
<a name="1436"/> 1436:     wait_for_ready_net(),
<a name="1437"/> 1437: 
<a name="1438"/> 1438:     ok = rpc:call(Cp1, application, start, [app1]),
<a name="1439"/> 1439:     wait_until_started(app1, [Cp1]),
<a name="1440"/> 1440:     io:format(&quot;--- App1 started at Cp1 ---~n&quot;, []),
<a name="1441"/> 1441:     print_dac_state(AllNodes),
<a name="1442"/> 1442: 
<a name="1443"/> 1443:     %% Cp2 previously crashed on this stop
<a name="1444"/> 1444:     ok = rpc:call(Cp1, application, stop, [app1]),
<a name="1445"/> 1445:     wait_until_stopped(app1, [Cp1]),
<a name="1446"/> 1446:     io:format(&quot;--- App1 stopped at Cp1 ---~n&quot;, []),
<a name="1447"/> 1447:     print_dac_state(AllNodes),
<a name="1448"/> 1448: 
<a name="1449"/> 1449:     ok = rpc:call(Cp1, application, start, [app1]),
<a name="1450"/> 1450:     wait_until_started(app1, [Cp1]),
<a name="1451"/> 1451:     io:format(&quot;--- App1 started at Cp1 ---~n&quot;, []),
<a name="1452"/> 1452:     print_dac_state(AllNodes),
<a name="1453"/> 1453: 
<a name="1454"/> 1454:     ok = rpc:call(Cp2, application, load, [app1, App1Nodes]),
<a name="1455"/> 1455:     ok = rpc:call(Cp2, application, start, [app1]),
<a name="1456"/> 1456:     io:format(&quot;--- App1 started at Cp2 ---~n&quot;, []),
<a name="1457"/> 1457:     print_dac_state(AllNodes),
<a name="1458"/> 1458: 
<a name="1459"/> 1459: 
<a name="1460"/> 1460:     stop_node_nice(Cp1),
<a name="1461"/> 1461:     wait_until_started(app1, [Cp2]),
<a name="1462"/> 1462:     io:format(&quot;--- Cp1 crashed; failover to Cp2  ---~n&quot;, []),
<a name="1463"/> 1463:     print_dac_state(Cp2),
<a name="1464"/> 1464: 
<a name="1465"/> 1465:     stop_node_nice(Cp2),
<a name="otp_4066-last_expr"/><a name="1466"/> 1466:     ok.
<a name="1467"/> 1467: 
<a name="config_4066-3"/><a name="1468"/> 1468: <b>config_4066</b>(SyncNodesOptional, SyncNodesTimeout, Distributed) -&gt;
<a name="config_4066-last_expr"/><a name="1469"/> 1469:     [{kernel, [{sync_nodes_optional,SyncNodesOptional},
<a name="1470"/> 1470: 	       {sync_nodes_timeout, SyncNodesTimeout},
<a name="1471"/> 1471: 	       {distributed, Distributed}]}].
<a name="1472"/> 1472: 
<a name="write_config-2"/><a name="1473"/> 1473: <b>write_config</b>(Fd, Config) -&gt;
<a name="write_config-last_expr"/><a name="1474"/> 1474: <b>    io:format</b>(Fd, &quot;~p.~n&quot;, [Config]).
<a name="1475"/> 1475: 
<a name="print_dac_state-1"/><a name="1476"/> 1476: <b>print_dac_state</b>(Node) when is_atom(Node) -&gt;
<a name="1477"/> 1477:     State = gen_server:call({dist_ac, Node}, info),
<a name="1478"/> 1478:     io:format(&quot; * dist_ac state on node ~p:~n    ~p~n&quot;,
<a name="1479"/> 1479:                        [Node, State]);
<a name="1480"/> 1480: <b>print_dac_state</b>(Nodes) when is_list(Nodes) -&gt;
<a name="print_dac_state-last_expr"/><a name="1481"/> 1481: <b>    lists:foreach</b>(fun (N) -&gt; print_dac_state(N) end, Nodes).
<a name="1482"/> 1482: 				
<a name="1483"/> 1483: 
<a name="1484"/> 1484: <i>%%-----------------------------------------------------------------</i>
<a name="1485"/> 1485: <i>%% Ticket: OTP-4227</i>
<a name="1486"/> 1486: <i>%% Slogan: Bad return value from application.</i>
<a name="1487"/> 1487: <i>%%-----------------------------------------------------------------</i>
<a name="1488"/> 1488: <i>%% Test start of depending app when required app crashed.</i>
<a name="otp_4227-1"/><a name="1489"/> 1489: <b>otp_4227</b>(Conf) when is_list(Conf) -&gt;
<a name="1490"/> 1490:     NodeNames = [Ncp1, Ncp2] = node_names([cp1, cp2], Conf),
<a name="1491"/> 1491:     NoSyncTime = config_fun_fast(config_4227(NodeNames)),
<a name="1492"/> 1492:     WithSyncTime = config_fun(config_4227(NodeNames)),
<a name="1493"/> 1493: 
<a name="1494"/> 1494:     %% Test [cp1, cp2]
<a name="1495"/> 1495:     {ok, Cp1} = start_node_config(Ncp1, NoSyncTime, Conf),
<a name="1496"/> 1496:     {ok, Cp2} = start_node_config(Ncp2, WithSyncTime, Conf),
<a name="1497"/> 1497:     Cps = [Cp1, Cp2],
<a name="1498"/> 1498:     wait_for_ready_net(),
<a name="1499"/> 1499: 
<a name="1500"/> 1500:     %% Try to start app10 which should fail since app9 is not started
<a name="1501"/> 1501:     {[ok,ok],[]} = 
<a name="1502"/> 1502:         rpc:multicall(Cps, application, load, [app9()]),
<a name="1503"/> 1503:     ?UNTIL(is_loaded(app9, Cps)),
<a name="1504"/> 1504:     {[ok,ok],[]} = 
<a name="1505"/> 1505:         rpc:multicall(Cps, application, load, [app10([app9], [])]),
<a name="1506"/> 1506:     {error, {not_started, app9}} = 
<a name="1507"/> 1507: 	rpc:call(Cp1, application, start, [app10]),
<a name="1508"/> 1508: 
<a name="1509"/> 1509:     %% Start app9 and brutally kill it, then try to start app10
<a name="1510"/> 1510:     ok = rpc:call(Cp1, application, start, [app9]),
<a name="1511"/> 1511:     ct:sleep(1000),
<a name="1512"/> 1512:     Pid9 = rpc:call(Cp1, erlang, whereis, [ch_sup19]),
<a name="1513"/> 1513:     true = erlang:is_pid(Pid9),
<a name="1514"/> 1514:     true = erlang:exit(Pid9, kill),
<a name="1515"/> 1515:     ct:sleep(1000),
<a name="1516"/> 1516: 
<a name="1517"/> 1517:     %% This gave {error, no_report} before the patch
<a name="1518"/> 1518:     {error, {not_running, app9}} = 
<a name="1519"/> 1519: 	rpc:call(Cp1, application, start, [app10]),
<a name="1520"/> 1520: 
<a name="1521"/> 1521:     stop_node_nice(Cp1),
<a name="1522"/> 1522:     stop_node_nice(Cp2),
<a name="otp_4227-last_expr"/><a name="1523"/> 1523:     ok.
<a name="1524"/> 1524: 
<a name="config_4227-1"/><a name="1525"/> 1525: <b>config_4227</b>([Ncp1, Ncp2]) -&gt;
<a name="config_4227-last_expr"/><a name="1526"/> 1526: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="1527"/> 1527:             M = from($@, atom_to_list(node())),
<a name="1528"/> 1528:             io:format(Fd, 
<a name="1529"/> 1529:                       &quot;[{kernel, &quot;
<a name="1530"/> 1530:                       &quot;  [{sync_nodes_optional, ['~s@~s','~s@~s']},&quot;
<a name="1531"/> 1531:                       &quot;   {sync_nodes_timeout, ~w},&quot;
<a name="1532"/> 1532:                       &quot;   {start_dist_ac, true},&quot;
<a name="1533"/> 1533:                       &quot;   {distributed, &quot;
<a name="1534"/> 1534:                       &quot;    [{app9,  ['~s@~s','~s@~s']}, &quot;
<a name="1535"/> 1535:                       &quot;     {app10, ['~s@~s','~s@~s']}]}]}].~n&quot;,
<a name="1536"/> 1536:                       [Ncp1, M, Ncp2, M,  
<a name="1537"/> 1537:                        SyncNodesTimeout,  
<a name="1538"/> 1538:                        Ncp1, M, Ncp2, M,  
<a name="1539"/> 1539:                        Ncp1, M, Ncp2, M])
<a name="1540"/> 1540:     end.
<a name="1541"/> 1541: 
<a name="1542"/> 1542: <i>%%-----------------------------------------------------------------</i>
<a name="1543"/> 1543: <i>%% Ticket: OTP-5363</i>
<a name="1544"/> 1544: <i>%% Slogan: Slow termination in application_master</i>
<a name="1545"/> 1545: <i>%%-----------------------------------------------------------------</i>
<a name="otp_5363-1"/><a name="1546"/> 1546: <b>otp_5363</b>(Conf) when is_list(Conf) -&gt;
<a name="1547"/> 1547:     %% When stopping an application, all processes having the
<a name="1548"/> 1548:     %% application master as group leader should get killed.
<a name="1549"/> 1549:     %% The killing was done in an inefficient way.
<a name="1550"/> 1550:     %%   In this test case, we will not test the efficiency of
<a name="1551"/> 1551:     %% the code, but only that the correct processes ARE killed.
<a name="1552"/> 1552: 
<a name="1553"/> 1553:     OldPath = code:get_path(),
<a name="1554"/> 1554:     code:add_patha(proplists:get_value(data_dir,Conf)),
<a name="1555"/> 1555:     try
<a name="1556"/> 1556: 	ok = application:load(app_group_leader()),
<a name="1557"/> 1557: 	ok = application:start(group_leader),
<a name="1558"/> 1558: 	case whereis(nisse) of
<a name="1559"/> 1559: 		  Pid when is_pid(Pid) -&gt;
<a name="1560"/> 1560: 		      Mref = erlang:monitor(process, Pid),
<a name="1561"/> 1561: 		      ok = application:stop(group_leader),
<a name="1562"/> 1562: 		      receive
<a name="1563"/> 1563: 			  {'DOWN',Mref,_,_,_} -&gt; ok
<a name="1564"/> 1564: 		      end,
<a name="1565"/> 1565: 		      undefined = whereis(nisse);
<a name="1566"/> 1566: 		  Bad -&gt;
<a name="1567"/> 1567: 		      io:format(&quot;~p\n&quot;, [Bad]),
<a name="1568"/> 1568: 		      ct:fail(failed)
<a name="1569"/> 1569: 	      end
<a name="1570"/> 1570:     after
<a name="1571"/> 1571:         code:set_path(OldPath)
<a name="1572"/> 1572:     end,
<a name="otp_5363-last_expr"/><a name="1573"/> 1573:     ok.
<a name="1574"/> 1574: 
<a name="1575"/> 1575: <i>%%-----------------------------------------------------------------</i>
<a name="1576"/> 1576: <i>%% Ticket: OTP-5606</i>
<a name="1577"/> 1577: <i>%% Slogan: Problems with starting a distributed application</i>
<a name="1578"/> 1578: <i>%%-----------------------------------------------------------------</i>
<a name="1579"/> 1579: <i>%% Test of several processes simultaneously starting the same</i>
<a name="1580"/> 1580: <i>%% distributed application.</i>
<a name="otp_5606-1"/><a name="1581"/> 1581: <b>otp_5606</b>(Conf) when is_list(Conf) -&gt;
<a name="1582"/> 1582: 
<a name="1583"/> 1583:     %% Write a config file
<a name="1584"/> 1584:     Dir = proplists:get_value(priv_dir, Conf),
<a name="1585"/> 1585:     {ok, Fd} = file:open(filename:join(Dir, &quot;sys.config&quot;), [write]),
<a name="1586"/> 1586:     NodeNames = [Ncp1, Ncp2] = node_names([cp1, cp2], Conf),
<a name="1587"/> 1587:     (config4(NodeNames))(Fd, 10000),
<a name="1588"/> 1588:     file:close(Fd),
<a name="1589"/> 1589:     Config = filename:join(Dir, &quot;sys&quot;),
<a name="1590"/> 1590:     
<a name="1591"/> 1591:     %% Test [cp1, cp2]
<a name="1592"/> 1592:     {ok, Cp1} = start_node(Ncp1, Config),
<a name="1593"/> 1593:     {ok, Cp2} = start_node(Ncp2, Config),
<a name="1594"/> 1594:     Cps = [Cp1, Cp2],
<a name="1595"/> 1595:     wait_for_ready_net(),
<a name="1596"/> 1596: 
<a name="1597"/> 1597:     %% Load app1 on both nodes
<a name="1598"/> 1598:     {[ok, ok], []} =
<a name="1599"/> 1599: 	rpc:multicall(Cps, application, load, [app1()]),
<a name="1600"/> 1600: 
<a name="1601"/> 1601:     %% Attempt to start app1 from different processes simultaneously
<a name="1602"/> 1602:     Pid11 =  spawn_link(Cp1, ?MODULE, loop5606, [self()]),
<a name="1603"/> 1603:     Pid12 =  spawn_link(Cp1, ?MODULE, loop5606, [self()]),
<a name="1604"/> 1604:     Pid13 =  spawn_link(Cp1, ?MODULE, loop5606, [self()]),
<a name="1605"/> 1605:     Pid2  =  spawn_link(Cp2, ?MODULE, loop5606, [self()]),
<a name="1606"/> 1606: 
<a name="1607"/> 1607:     Pid2 ! start,
<a name="1608"/> 1608:     Pid11 ! start,
<a name="1609"/> 1609:     Pid12 ! start,
<a name="1610"/> 1610:     Pid13 ! start,
<a name="1611"/> 1611: 
<a name="1612"/> 1612:     ResL = otp_5606_loop([]),
<a name="1613"/> 1613: 
<a name="1614"/> 1614:     case ResL of
<a name="1615"/> 1615: 	[ok, ok, ok, ok] -&gt;
<a name="1616"/> 1616: 	    ok;
<a name="1617"/> 1617: 	[Res1, Res2, Res3, Res4] -&gt;
<a name="1618"/> 1618: 	    Txt = io_lib:format(&quot;Illegal results from start ~p ~p ~p ~p&quot;,
<a name="1619"/> 1619: 				[Res1, Res2, Res3, Res4]),
<a name="1620"/> 1620: 	    ct:fail(lists:flatten(Txt))
<a name="1621"/> 1621:     end,
<a name="1622"/> 1622: 
<a name="1623"/> 1623:     {error, {already_started, app1}} = 
<a name="1624"/> 1624: 	rpc:call(Cp1, application, start, [app1]),
<a name="1625"/> 1625: 
<a name="1626"/> 1626:     stop_node_nice(Cp1),
<a name="1627"/> 1627:     stop_node_nice(Cp2),
<a name="otp_5606-last_expr"/><a name="1628"/> 1628:     ok.
<a name="1629"/> 1629: 
<a name="otp_5606_loop-1"/><a name="1630"/> 1630: <b>otp_5606_loop</b>(ResL) when length(ResL)&lt;4 -&gt;
<a name="1631"/> 1631:     receive 
<a name="1632"/> 1632: 	{_Pid, Res} -&gt;
<a name="1633"/> 1633: 	    otp_5606_loop([Res|ResL])
<a name="1634"/> 1634:     after 5000 -&gt;
<a name="1635"/> 1635: 	    ct:fail(timeout_waiting_for_res)
<a name="1636"/> 1636:     end;
<a name="1637"/> 1637: <b>otp_5606_loop</b>(ResL) -&gt;
<a name="otp_5606_loop-last_expr"/><a name="1638"/> 1638:     ResL.
<a name="1639"/> 1639: 
<a name="loop5606-1"/><a name="1640"/> 1640: <b>loop5606</b>(Pid) -&gt;
<a name="loop5606-last_expr"/><a name="1641"/> 1641:     receive
<a name="1642"/> 1642: 	start -&gt;
<a name="1643"/> 1643: 	    Res = application:start(app1),
<a name="1644"/> 1644: 	    Pid ! {self(), Res}
<a name="1645"/> 1645:     end.
<a name="1646"/> 1646: 
<a name="otp_16504-1"/><a name="1647"/> 1647: <b>otp_16504</b>(Config) when is_list(Config) -&gt;
<a name="1648"/> 1648:     {ok, Fd} = file:open(&quot;app1.app&quot;, [write]),
<a name="1649"/> 1649:     w_app1(Fd),
<a name="1650"/> 1650:     file:close(Fd),
<a name="1651"/> 1651:     register(test_application_stop_called, self()),
<a name="1652"/> 1652: 
<a name="1653"/> 1653:     ok = application:ensure_started(app1),
<a name="1654"/> 1654:     Master = application_controller:get_master(app1),
<a name="1655"/> 1655:     exit(Master, kill),
<a name="1656"/> 1656:     receive
<a name="1657"/> 1657:         {stop_called, _} -&gt;
<a name="1658"/> 1658:             ok
<a name="1659"/> 1659:     after 3000 -&gt;
<a name="1660"/> 1660:             ct:fail(stop_not_called)
<a name="1661"/> 1661:     end,
<a name="otp_16504-last_expr"/><a name="1662"/> 1662:     ok.
<a name="1663"/> 1663: 
<a name="1664"/> 1664: <i>%% Tests get_env/* functions.</i>
<a name="get_env-1"/><a name="1665"/> 1665: <b>get_env</b>(Conf) when is_list(Conf) -&gt;
<a name="1666"/> 1666:     ok = application:set_env(kernel, new_var, new_val),
<a name="1667"/> 1667:     {ok, new_val} = application:get_env(kernel, new_var),
<a name="1668"/> 1668:     undefined = application:get_env(undefined_app, a),
<a name="1669"/> 1669:     undefined = application:get_env(kernel, error_logger_xyz),
<a name="1670"/> 1670:     default   = application:get_env(kernel, error_logger_xyz, default),
<a name="get_env-last_expr"/><a name="1671"/> 1671:     ok.
<a name="1672"/> 1672: 
<a name="get_supervisor-1"/><a name="1673"/> 1673: <b>get_supervisor</b>(Conf) when is_list(Conf) -&gt;
<a name="1674"/> 1674:     undefined = application:get_supervisor(stdlib),
<a name="1675"/> 1675:     {ok, Pid} = application:get_supervisor(kernel),
<a name="1676"/> 1676:     Pid = erlang:whereis(kernel_sup),
<a name="get_supervisor-last_expr"/><a name="1677"/> 1677:     ok.
<a name="1678"/> 1678: 
<a name="1679"/> 1679: <i>%%-----------------------------------------------------------------</i>
<a name="1680"/> 1680: <i>%% Should be started in a CC view with:</i>
<a name="1681"/> 1681: <i>%% erl -sname XXX -rsh ctrsh where XX not in [cp1, cp2, cp3]</i>
<a name="1682"/> 1682: <i>%%-----------------------------------------------------------------</i>
<a name="1683"/> 1683: <i>%% Tests read the .app keys.</i>
<a name="get_key-1"/><a name="1684"/> 1684: <b>get_key</b>(Conf) when is_list(Conf) -&gt;
<a name="1685"/> 1685:     NodeNames = [Ncp1, _Ncp2, _Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="1686"/> 1686:     WithSyncTime = config_fun(config_inc(NodeNames)),
<a name="1687"/> 1687: 
<a name="1688"/> 1688:     %% Test [cp1, cp2, cp3]
<a name="1689"/> 1689:     {ok, Cp1} = start_node_config(Ncp1, WithSyncTime, Conf),
<a name="1690"/> 1690: 
<a name="1691"/> 1691:     ok = rpc:call(Cp1, application, load, [appinc(), d3(NodeNames)]),
<a name="1692"/> 1692:     ?UNTIL(is_loaded(appinc, Cp1)),
<a name="1693"/> 1693:     ok = rpc:call(Cp1, application, start, [appinc, permanent]),
<a name="1694"/> 1694:     ?UNTIL(is_started(appinc, Cp1)),
<a name="1695"/> 1695:     
<a name="1696"/> 1696:     {ok, &quot;Test of new app file, including appnew&quot;} =
<a name="1697"/> 1697: 	rpc:call(Cp1, application, get_key, [appinc, description]),
<a name="1698"/> 1698:     {ok, &quot;CXC 138 ai&quot;} = rpc:call(Cp1, application, get_key, [appinc ,id]),
<a name="1699"/> 1699:     {ok, &quot;2.0&quot;} = rpc:call(Cp1, application, get_key, [appinc, vsn]),
<a name="1700"/> 1700:     {ok, [kernel]} = rpc:call(Cp1, application, get_key, [appinc, applications]),
<a name="1701"/> 1701:     {ok, [appinc1, appinc2]} = 
<a name="1702"/> 1702: 	rpc:call(Cp1, application, get_key, [appinc, included_applications]),
<a name="1703"/> 1703:     {ok, []} = rpc:call(Cp1, application, get_key, [appinc, registered]),
<a name="1704"/> 1704:     {ok, [{init, [kalle]}, {takeover, []}, {go, [sune]}]} =
<a name="1705"/> 1705: 	rpc:call(Cp1, application, get_key, [appinc, start_phases]),
<a name="1706"/> 1706:     {ok, Env} = rpc:call(Cp1, application, get_key, [appinc ,env]),
<a name="1707"/> 1707:     [{own2,val2},{own_env1,value1}] = lists:sort(Env),
<a name="1708"/> 1708:     {ok, []} = rpc:call(Cp1, application, get_key, [appinc, modules]),
<a name="1709"/> 1709:     {ok, {application_starter, [ch_sup, {appinc, 41, 43}] }} = 
<a name="1710"/> 1710: 	rpc:call(Cp1, application, get_key, [appinc, mod]),
<a name="1711"/> 1711:     {ok, infinity} = rpc:call(Cp1, application, get_key, [appinc, maxP]),
<a name="1712"/> 1712:     {ok, infinity} = rpc:call(Cp1, application, get_key, [appinc, maxT]),
<a name="1713"/> 1713:     undefined = rpc:call(Cp1, application, get_key, [appinc, very_unknown]),
<a name="1714"/> 1714: 
<a name="1715"/> 1715:     {ok, [{description, &quot;Test of new app file, including appnew&quot;}, 
<a name="1716"/> 1716: 		{id, &quot;CXC 138 ai&quot;}, 
<a name="1717"/> 1717: 		{vsn, &quot;2.0&quot;}, 
<a name="1718"/> 1718: 		{modules, []}, 
<a name="1719"/> 1719: 		{maxP, infinity}, 
<a name="1720"/> 1720: 		{maxT, infinity}, 
<a name="1721"/> 1721: 		{registered, []}, 
<a name="1722"/> 1722: 		{included_applications, [appinc1, appinc2]}, 
<a name="1723"/> 1723: 		{optional_applications, []},
<a name="1724"/> 1724: 		{applications, [kernel]}, 
<a name="1725"/> 1725: 		{env, Env}, 
<a name="1726"/> 1726: 		{mod, {application_starter, [ch_sup, {appinc, 41, 43}] }}, 
<a name="1727"/> 1727: 		{start_phases, [{init, [kalle]}, {takeover, []}, {go, [sune]}]}]} = 
<a name="1728"/> 1728: 	rpc:call(Cp1, application, get_all_key, [appinc]),
<a name="1729"/> 1729:     [{own2,val2},{own_env1,value1}] = lists:sort(Env),
<a name="1730"/> 1730: 
<a name="1731"/> 1731:     {ok, &quot;Test of new app file, including appnew&quot;} =
<a name="1732"/> 1732: 	gen_server:call({global, {ch,41}}, {get_pid_key, description}),
<a name="1733"/> 1733:     {ok, &quot;CXC 138 ai&quot;} = 
<a name="1734"/> 1734: 	gen_server:call({global, {ch,41}}, {get_pid_key, id}),
<a name="1735"/> 1735:     {ok, &quot;2.0&quot;} = 
<a name="1736"/> 1736: 	gen_server:call({global, {ch,41}}, {get_pid_key, vsn}),
<a name="1737"/> 1737:     {ok, [kernel]} = 
<a name="1738"/> 1738: 	gen_server:call({global, {ch,41}}, {get_pid_key, applications}),
<a name="1739"/> 1739:     {ok, [appinc1, appinc2]} = 
<a name="1740"/> 1740: 	gen_server:call({global, {ch,41}}, {get_pid_key, included_applications}),
<a name="1741"/> 1741:     {ok, []} = 
<a name="1742"/> 1742: 	gen_server:call({global, {ch,41}}, {get_pid_key, registered}),
<a name="1743"/> 1743:     {ok, [{init, [kalle]}, {takeover, []}, {go, [sune]}]} =
<a name="1744"/> 1744: 	gen_server:call({global, {ch,41}}, {get_pid_key, start_phases}),
<a name="1745"/> 1745:     {ok, Env} = gen_server:call({global, {ch,41}}, {get_pid_key, env}),
<a name="1746"/> 1746:     [{own2,val2},{own_env1,value1}] = lists:sort(Env),
<a name="1747"/> 1747:     {ok, []} = 
<a name="1748"/> 1748: 	gen_server:call({global, {ch,41}}, {get_pid_key, modules}),
<a name="1749"/> 1749:     {ok, {application_starter, [ch_sup, {appinc, 41, 43}] }} = 
<a name="1750"/> 1750: 	gen_server:call({global, {ch,41}}, {get_pid_key, mod}),
<a name="1751"/> 1751:     {ok, infinity} = 
<a name="1752"/> 1752: 	gen_server:call({global, {ch,41}}, {get_pid_key, maxP}),
<a name="1753"/> 1753:     {ok, infinity} = 
<a name="1754"/> 1754: 	gen_server:call({global, {ch,41}}, {get_pid_key, maxT}),
<a name="1755"/> 1755:     undefined = 
<a name="1756"/> 1756: 	gen_server:call({global, {ch,41}}, {get_pid_key, very_unknown}),
<a name="1757"/> 1757: 
<a name="1758"/> 1758: 
<a name="1759"/> 1759: 
<a name="1760"/> 1760:     {ok, [{description, &quot;Test of new app file, including appnew&quot;}, 
<a name="1761"/> 1761: 		{id, &quot;CXC 138 ai&quot;}, 
<a name="1762"/> 1762: 		{vsn, &quot;2.0&quot;}, 
<a name="1763"/> 1763: 		{modules, []}, 
<a name="1764"/> 1764: 		{maxP, infinity}, 
<a name="1765"/> 1765: 		{maxT, infinity}, 
<a name="1766"/> 1766: 		{registered, []}, 
<a name="1767"/> 1767: 		{included_applications, [appinc1, appinc2]}, 
<a name="1768"/> 1768: 		{optional_applications, []},
<a name="1769"/> 1769: 		{applications, [kernel]}, 
<a name="1770"/> 1770: 		{env, Env}, 
<a name="1771"/> 1771: 		{mod, {application_starter, [ch_sup, {appinc, 41, 43}] }}, 
<a name="1772"/> 1772: 		{start_phases, [{init, [kalle]}, {takeover, []}, {go, [sune]}]}]} = 
<a name="1773"/> 1773: 	gen_server:call({global, {ch,41}}, get_pid_all_key),
<a name="1774"/> 1774:     [{own2,val2},{own_env1,value1}] = lists:sort(Env),
<a name="1775"/> 1775:     
<a name="1776"/> 1776:     stop_node_nice(Cp1),
<a name="get_key-last_expr"/><a name="1777"/> 1777:     ok.
<a name="1778"/> 1778: 
<a name="1779"/> 1779: <i>%%%-----------------------------------------------------------------</i>
<a name="1780"/> 1780: <i>%%% Testing of change of distributed parameter.</i>
<a name="1781"/> 1781: <i>%%%-----------------------------------------------------------------</i>
<a name="1782"/> 1782: 
<a name="1783"/> 1783: <i>%% Test change of distributed parameter.</i>
<a name="distr_changed_tc1-1"/><a name="1784"/> 1784: <b>distr_changed_tc1</b>(Conf) when is_list(Conf) -&gt;
<a name="1785"/> 1785: 
<a name="1786"/> 1786:     {OldKernel, OldEnv, {Cp1, Cp2, Cp3}, {_Ncp1, _Ncp2, _Ncp3}, _Config2} = 
<a name="1787"/> 1787: 	distr_changed_prep(Conf),
<a name="1788"/> 1788: 
<a name="1789"/> 1789:     NewDist = {distributed, [{app1, [Cp3]},
<a name="1790"/> 1790: 				   {app2, 5000, [Cp2]},
<a name="1791"/> 1791: 				   {app3, [Cp3, {Cp1, Cp2}]},
<a name="1792"/> 1792: 				   {app6, [Cp1, {Cp3, Cp2}]},
<a name="1793"/> 1793: 				   {app7, 1000, [Cp3]},
<a name="1794"/> 1794: 				   {app8, [Cp1, {Cp2, Cp3}]}]},
<a name="1795"/> 1795:     
<a name="1796"/> 1796:     NewKernel = [{kernel, lists:keyreplace(distributed, 1, OldKernel, NewDist)}],
<a name="1797"/> 1797:     ok = rpc:call(Cp1, application_controller, test_change_apps, 
<a name="1798"/> 1798: 			[[kernel], [NewKernel]]),
<a name="1799"/> 1799:     ok = rpc:call(Cp2, application_controller, test_change_apps, 
<a name="1800"/> 1800: 			[[kernel], [NewKernel]]),
<a name="1801"/> 1801:     ok = rpc:call(Cp3, application_controller, test_change_apps, 
<a name="1802"/> 1802: 			[[kernel], [NewKernel]]),
<a name="1803"/> 1803:     
<a name="1804"/> 1804:     {[ok,ok,ok],[]} = 
<a name="1805"/> 1805: 	rpc:multicall([Cp1, Cp2, Cp3], 
<a name="1806"/> 1806: 		      application_controller, config_change, [OldEnv]),
<a name="1807"/> 1807:     
<a name="1808"/> 1808:     ct:sleep(7000),
<a name="1809"/> 1809:     
<a name="1810"/> 1810:     DcInfo1 = rpc:call(Cp1, dist_ac, info, []),
<a name="1811"/> 1811:     DcInfo2 = rpc:call(Cp2, dist_ac, info, []),
<a name="1812"/> 1812:     DcInfo3 = rpc:call(Cp3, dist_ac, info, []),
<a name="1813"/> 1813: 
<a name="1814"/> 1814:     DcWa1 = which_applications(Cp1),
<a name="1815"/> 1815:     DcWa2 = which_applications(Cp2),
<a name="1816"/> 1816:     DcWa3 = which_applications(Cp3),
<a name="1817"/> 1817:     
<a name="1818"/> 1818:     Wa1 = lists:foldl(fun({A1, _N1, _V1}, AccIn) -&gt; [A1 | AccIn] end,
<a name="1819"/> 1819: 			    [], DcWa1),
<a name="1820"/> 1820:     Wa2 = lists:foldl(fun({A2, _N2, _V2}, AccIn) -&gt; [A2 | AccIn] end,
<a name="1821"/> 1821: 			    [], DcWa2),
<a name="1822"/> 1822:     Wa3 = lists:foldl(fun({A3, _N3, _V3}, AccIn) -&gt; [A3 | AccIn] end,
<a name="1823"/> 1823: 			    [], DcWa3),
<a name="1824"/> 1824:     case lists:sort(Wa1) of
<a name="1825"/> 1825: 	      [app1, app2, app3, kernel, stdlib] -&gt;
<a name="1826"/> 1826: 		  ok;
<a name="1827"/> 1827: 	      EWa1 -&gt;
<a name="1828"/> 1828: 		  X1 = io_lib:format(&quot;distribution error: Cp1 ~p &quot;,[EWa1]),
<a name="1829"/> 1829: 		  ct:fail(lists:flatten(X1))
<a name="1830"/> 1830: 	  end,
<a name="1831"/> 1831: 		  
<a name="1832"/> 1832:     case lists:sort(Wa2) of
<a name="1833"/> 1833: 	      [app6, app8, kernel, stdlib] -&gt;
<a name="1834"/> 1834: 		  ok;
<a name="1835"/> 1835: 	      EWa2 -&gt;
<a name="1836"/> 1836: 		  X2 = io_lib:format(&quot;distribution error: Cp2 ~p &quot;,[EWa2]),
<a name="1837"/> 1837: 		  ct:fail(lists:flatten(X2))
<a name="1838"/> 1838: 	  end,
<a name="1839"/> 1839: 		  
<a name="1840"/> 1840:     case lists:sort(Wa3) of
<a name="1841"/> 1841: 	      [app7, kernel, stdlib] -&gt;
<a name="1842"/> 1842: 		  ok;
<a name="1843"/> 1843: 	      EWa3 -&gt;
<a name="1844"/> 1844: 		  X3 = io_lib:format(&quot;distribution error: Cp3 ~p &quot;,[EWa3]),
<a name="1845"/> 1845: 		  ct:fail(lists:flatten(X3))
<a name="1846"/> 1846: 	  end,
<a name="1847"/> 1847: 		  
<a name="1848"/> 1848:     DcInfo1n = rpc:call(Cp1, dist_ac, info, []),
<a name="1849"/> 1849:     DcInfo2n = rpc:call(Cp2, dist_ac, info, []),
<a name="1850"/> 1850:     DcInfo3n = rpc:call(Cp3, dist_ac, info, []),
<a name="1851"/> 1851: 
<a name="1852"/> 1852:     %% Added afterwards. Got rid of some warnings for unused variables.
<a name="1853"/> 1853:     true = DcInfo1 =:= DcInfo1n,
<a name="1854"/> 1854:     true = DcInfo2 =:= DcInfo2n,
<a name="1855"/> 1855:     true = DcInfo3 =:= DcInfo3n,
<a name="1856"/> 1856: 
<a name="1857"/> 1857:     stop_node_nice(Cp1),
<a name="1858"/> 1858:     stop_node_nice(Cp2),   
<a name="1859"/> 1859:     stop_node_nice(Cp3),   
<a name="1860"/> 1860: 
<a name="1861"/> 1861:     ok = file:delete(&quot;dc.boot&quot;),
<a name="1862"/> 1862:     ok = file:delete(&quot;dc.rel&quot;),
<a name="1863"/> 1863:     ok = file:delete(&quot;dc.script&quot;),
<a name="1864"/> 1864: 
<a name="distr_changed_tc1-last_expr"/><a name="1865"/> 1865:     ok.
<a name="1866"/> 1866: 
<a name="1867"/> 1867: <i>%% Test change of distributed parameter, move appls by crashing a node.</i>
<a name="distr_changed_tc2-1"/><a name="1868"/> 1868: <b>distr_changed_tc2</b>(Conf) when is_list(Conf) -&gt;
<a name="1869"/> 1869: 
<a name="1870"/> 1870:     {OldKernel, OldEnv, {Cp1, Cp2, Cp3}, {Ncp1, _Ncp2, _Ncp3}, Config2} = 
<a name="1871"/> 1871: 	distr_changed_prep(Conf),
<a name="1872"/> 1872: 
<a name="1873"/> 1873:     NewDist = {distributed, [{app1, [Cp3]},
<a name="1874"/> 1874: 				   {app2, 5000, [Cp2]},
<a name="1875"/> 1875: 				   {app3, [Cp3, {Cp1, Cp2}]},
<a name="1876"/> 1876: 				   {app6, [Cp1, {Cp3, Cp2}]},
<a name="1877"/> 1877: 				   {app7, 1000, [Cp3]},
<a name="1878"/> 1878: 				   {app8, [Cp1, {Cp2, Cp3}]}]},
<a name="1879"/> 1879:     
<a name="1880"/> 1880:     NewKernel = [{kernel, lists:keyreplace(distributed, 1, OldKernel, NewDist)}],
<a name="1881"/> 1881:     ok = rpc:call(Cp1, application_controller, test_change_apps, 
<a name="1882"/> 1882: 			[[kernel], [NewKernel]]),
<a name="1883"/> 1883:     ok = rpc:call(Cp2, application_controller, test_change_apps, 
<a name="1884"/> 1884: 			[[kernel], [NewKernel]]),
<a name="1885"/> 1885:     ok = rpc:call(Cp3, application_controller, test_change_apps, 
<a name="1886"/> 1886: 			[[kernel], [NewKernel]]),
<a name="1887"/> 1887:     
<a name="1888"/> 1888:     {[ok,ok,ok],[]} = 
<a name="1889"/> 1889: 	rpc:multicall([Cp1, Cp2, Cp3], 
<a name="1890"/> 1890: 		      application_controller, config_change, [OldEnv]),
<a name="1891"/> 1891:     
<a name="1892"/> 1892:     ct:sleep(4000),
<a name="1893"/> 1893:     stop_node_nice(Cp1),   
<a name="1894"/> 1894:     ct:sleep(10000),
<a name="1895"/> 1895: 
<a name="1896"/> 1896:     _DcInfo2 = rpc:call(Cp2, dist_ac, info, []),
<a name="1897"/> 1897:     _DcInfo3 = rpc:call(Cp3, dist_ac, info, []),
<a name="1898"/> 1898: 
<a name="1899"/> 1899:     DcWa2 = which_applications(Cp2),
<a name="1900"/> 1900:     DcWa3 = which_applications(Cp3),
<a name="1901"/> 1901:     
<a name="1902"/> 1902:     Wa2 = lists:foldl(fun({A2, _N2, _V2}, AccIn) -&gt; [A2 | AccIn] end,
<a name="1903"/> 1903: 			    [], DcWa2),
<a name="1904"/> 1904:     Wa3 = lists:foldl(fun({A3, _N3, _V3}, AccIn) -&gt; [A3 | AccIn] end,
<a name="1905"/> 1905: 			    [], DcWa3),
<a name="1906"/> 1906: 		  
<a name="1907"/> 1907: 
<a name="1908"/> 1908:     case lists:sort(Wa2) of
<a name="1909"/> 1909: 	      [app2, app6, app8, kernel, stdlib] -&gt;
<a name="1910"/> 1910: 		  ok;
<a name="1911"/> 1911: 	      EWa2 -&gt;
<a name="1912"/> 1912: 		  X2 = io_lib:format(&quot;distribution error: Cp2 ~p &quot;,[EWa2]),
<a name="1913"/> 1913: 		  ct:fail(lists:flatten(X2))
<a name="1914"/> 1914: 	  end,
<a name="1915"/> 1915: 		  
<a name="1916"/> 1916:     case lists:sort(Wa3) of
<a name="1917"/> 1917: 	      [app1, app3, app7, kernel, stdlib] -&gt;
<a name="1918"/> 1918: 		  ok;
<a name="1919"/> 1919: 	      EWa3 -&gt;
<a name="1920"/> 1920: 		  X3 = io_lib:format(&quot;distribution error: Cp3 ~p &quot;,[EWa3]),
<a name="1921"/> 1921: 		  ct:fail(lists:flatten(X3))
<a name="1922"/> 1922: 	  end,
<a name="1923"/> 1923: 
<a name="1924"/> 1924: 
<a name="1925"/> 1925:     {ok, Cp1} = start_node_boot(Ncp1, Config2, dc),
<a name="1926"/> 1926:     ct:sleep(10000),
<a name="1927"/> 1927: 
<a name="1928"/> 1928:     _DcInfo1rs = rpc:call(Cp1, dist_ac, info, []),
<a name="1929"/> 1929:     _DcInfo2rs = rpc:call(Cp2, dist_ac, info, []),
<a name="1930"/> 1930:     _DcInfo3rs = rpc:call(Cp3, dist_ac, info, []),
<a name="1931"/> 1931: 
<a name="1932"/> 1932:     DcWa1rs = which_applications(Cp1),
<a name="1933"/> 1933:     DcWa2rs = which_applications(Cp2),
<a name="1934"/> 1934:     DcWa3rs = which_applications(Cp3),
<a name="1935"/> 1935:     
<a name="1936"/> 1936:     Wa1rs = lists:foldl(fun({A1, _N1, _V1}, AccIn) -&gt; [A1 | AccIn] end,
<a name="1937"/> 1937: 			      [], DcWa1rs),
<a name="1938"/> 1938:     Wa2rs = lists:foldl(fun({A2, _N2, _V2}, AccIn) -&gt; [A2 | AccIn] end,
<a name="1939"/> 1939: 			      [], DcWa2rs),
<a name="1940"/> 1940:     Wa3rs = lists:foldl(fun({A3, _N3, _V3}, AccIn) -&gt; [A3 | AccIn] end,
<a name="1941"/> 1941: 			      [], DcWa3rs),
<a name="1942"/> 1942: 		  
<a name="1943"/> 1943:     case lists:sort(Wa1rs) of
<a name="1944"/> 1944: 	      [app6, app8, kernel, stdlib] -&gt;
<a name="1945"/> 1945: 		  ok;
<a name="1946"/> 1946: 	      EWa1rs -&gt;
<a name="1947"/> 1947: 		  X1rs = io_lib:format(&quot;distribution error: Cp1 ~p &quot;,[EWa1rs]),
<a name="1948"/> 1948: 		  ct:fail(lists:flatten(X1rs))
<a name="1949"/> 1949: 	  end,
<a name="1950"/> 1950: 		  
<a name="1951"/> 1951:     case lists:sort(Wa2rs) of
<a name="1952"/> 1952: 	      [app2, kernel, stdlib] -&gt;
<a name="1953"/> 1953: 		  ok;
<a name="1954"/> 1954: 	      EWa2rs -&gt;
<a name="1955"/> 1955: 		  X2rs = io_lib:format(&quot;distribution error: Cp2 ~p &quot;,[EWa2rs]),
<a name="1956"/> 1956: 		  ct:fail(lists:flatten(X2rs))
<a name="1957"/> 1957: 	  end,
<a name="1958"/> 1958: 		  
<a name="1959"/> 1959:     case lists:sort(Wa3rs) of
<a name="1960"/> 1960: 	      [app1, app3, app7, kernel, stdlib] -&gt;
<a name="1961"/> 1961: 		  ok;
<a name="1962"/> 1962: 	      EWa3rs -&gt;
<a name="1963"/> 1963: 		  X3rs = io_lib:format(&quot;distribution error: Cp3 ~p &quot;,[EWa3rs]),
<a name="1964"/> 1964: 		  ct:fail(lists:flatten(X3rs))
<a name="1965"/> 1965: 	  end,
<a name="1966"/> 1966: 
<a name="1967"/> 1967: 
<a name="1968"/> 1968:     stop_node_nice(Cp1),
<a name="1969"/> 1969:     stop_node_nice(Cp2),
<a name="1970"/> 1970:     stop_node_nice(Cp3),
<a name="1971"/> 1971: 
<a name="1972"/> 1972:     ok = file:delete(&quot;dc.boot&quot;),
<a name="1973"/> 1973:     ok = file:delete(&quot;dc.rel&quot;),
<a name="1974"/> 1974:     ok = file:delete(&quot;dc.script&quot;),
<a name="1975"/> 1975: 
<a name="distr_changed_tc2-last_expr"/><a name="1976"/> 1976:     ok.
<a name="1977"/> 1977: 
<a name="get_relative_path-2"/><a name="1978"/> 1978: <b>get_relative_path</b>(AbsolutePath, RelativeTo) -&gt;
<a name="1979"/> 1979:     AbsolutePathList = filename:split(AbsolutePath),
<a name="1980"/> 1980:     RelativeToList = filename:split(RelativeTo),
<a name="1981"/> 1981:     CommonPath =
<a name="1982"/> 1982:         (fun GetCommonPath([], _, Acc) -&gt;
<a name="1983"/> 1983:                  lists:reverse(Acc);
<a name="1984"/> 1984:              GetCommonPath(_, [], Acc) -&gt;
<a name="1985"/> 1985:                  lists:reverse(Acc);
<a name="1986"/> 1986:              GetCommonPath([A | _], [B | _], Acc)
<a name="1987"/> 1987:                when A =/= B -&gt;
<a name="1988"/> 1988:                  lists:reverse(Acc);
<a name="1989"/> 1989:              GetCommonPath([N | Rest1], [N | Rest2], Acc) -&gt;
<a name="1990"/> 1990:                  GetCommonPath(Rest1, Rest2, [N | Acc])
<a name="1991"/> 1991:          end)(AbsolutePathList, RelativeToList, []),
<a name="1992"/> 1992:     CommonPathLength = length(CommonPath),
<a name="1993"/> 1993:     RelPathEnd = lists:nthtail(CommonPathLength, AbsolutePathList),
<a name="1994"/> 1994:     NrOfDowns = length(RelativeToList) - CommonPathLength,
<a name="get_relative_path-last_expr"/><a name="1995"/> 1995: <b>    filename:join</b>(lists:duplicate(NrOfDowns, &quot;..&quot;) ++ RelPathEnd).
<a name="1996"/> 1996: 
<a name="do_configfd_test_port_program-1"/><a name="1997"/> 1997: <b>do_configfd_test_port_program</b>(ErlProgram) -&gt;
<a name="1998"/> 1998:     PrintLogLevelString =
<a name="1999"/> 1999:         &quot;io_lib:format(\&quot;~p\&quot;,[element(2, application:get_env(kernel, logger_level))])&quot;,
<a name="2000"/> 2000:     DataDir = filename:join(filename:dirname(code:which(?MODULE)), &quot;application_SUITE_data&quot;),
<a name="2001"/> 2001:     OutFilePath = filename:join(DataDir, &quot;do_configfd_test_port.out&quot;),
<a name="2002"/> 2002:     ToEval =
<a name="2003"/> 2003:         lists:flatten(
<a name="2004"/> 2004:           io_lib:format(&quot;file:write_file(\&quot;~s\&quot;, ~s),erlang:halt()&quot;,
<a name="2005"/> 2005:                         [OutFilePath,
<a name="2006"/> 2006:                          PrintLogLevelString])),
<a name="2007"/> 2007:     Port = erlang:open_port(
<a name="2008"/> 2008:              {spawn_executable, ErlProgram},
<a name="2009"/> 2009:              [{args, [&quot;-configfd&quot;,
<a name="2010"/> 2010:                       &quot;0&quot;,
<a name="2011"/> 2011:                       &quot;-eval&quot;,
<a name="2012"/> 2012:                       ToEval]},
<a name="2013"/> 2013:               use_stdio,
<a name="2014"/> 2014:               stderr_to_stdout]),
<a name="2015"/> 2015:     Port ! {self(),{command,&quot;[{kernel, [{logger_level, warning}]}].&quot;}},
<a name="2016"/> 2016:     Port ! {self(),close},
<a name="2017"/> 2017:     (fun Read() -&gt;
<a name="2018"/> 2018:              receive
<a name="2019"/> 2019:                  {Port,closed} -&gt; ok;
<a name="2020"/> 2020:                  {Port, Message} -&gt;
<a name="2021"/> 2021:                      io:format(&quot;Got unexpected message: ~p&quot;, Message),
<a name="2022"/> 2022:                      Read()
<a name="2023"/> 2023:              end
<a name="2024"/> 2024:      end)(),
<a name="2025"/> 2025:     %% Check that the config file was read correctly in the port
<a name="2026"/> 2026:     %% program
<a name="2027"/> 2027:     ok =
<a name="2028"/> 2028:         (fun TryRead(0) -&gt;
<a name="2029"/> 2029:                  cannot_find_file;
<a name="2030"/> 2030:              TryRead(TriesLeft) -&gt;
<a name="2031"/> 2031:                  case file:read_file(OutFilePath) of
<a name="2032"/> 2032:                      {ok, &lt;&lt;&quot;warning&quot;&gt;&gt;} -&gt; ok;
<a name="2033"/> 2033:                      Error -&gt;
<a name="2034"/> 2034:                          %% It might take some time for the file to be
<a name="2035"/> 2035:                          %% written to disk after we have closed the
<a name="2036"/> 2036:                          %% config file descriptor
<a name="2037"/> 2037:                          io:format(&quot;INFO: File not written yet, trying again (~p)&quot;, [Error]),
<a name="2038"/> 2038:                          timer:sleep(250),
<a name="2039"/> 2039:                          TryRead(TriesLeft -1)
<a name="2040"/> 2040:                  end
<a name="2041"/> 2041:          end)(40),
<a name="do_configfd_test_port_program-last_expr"/><a name="2042"/> 2042: <b>    ok = file:delete</b>(OutFilePath).
<a name="2043"/> 2043: 
<a name="quote_sub_strings-1"/><a name="2044"/> 2044: <b>quote_sub_strings</b>(String) -&gt;
<a name="quote_sub_strings-last_expr"/><a name="2045"/> 2045: <b>    lists:flatmap</b>(
<a name="2046"/> 2046:       fun($&quot;) -&gt;
<a name="2047"/> 2047:               &quot;\\\&quot;&quot;;
<a name="2048"/> 2048:          (C) -&gt; [C]
<a name="2049"/> 2049:       end,
<a name="2050"/> 2050:       lists:flatten(String)).
<a name="2051"/> 2051: 
<a name="do_configfd_test_bash-0"/><a name="2052"/> 2052: <b>do_configfd_test_bash</b>() -&gt;
<a name="2053"/> 2053:     DataDir = filename:join(filename:dirname(code:which(?MODULE)), &quot;application_SUITE_data&quot;),
<a name="2054"/> 2054:     TestConfigPath1 = filename:join(DataDir, &quot;testconfigfd1.config&quot;),
<a name="2055"/> 2055:     TestConfigPath2 = filename:join(DataDir, &quot;testconfigfd2.config&quot;),
<a name="2056"/> 2056:     RunInBash =
<a name="2057"/> 2057:         fun(String) -&gt;
<a name="2058"/> 2058:                 Command =
<a name="2059"/> 2059:                     lists:flatten(io_lib:format(&quot;bash -c \&quot;~s\&quot;&quot;,
<a name="2060"/> 2060:                                                 [quote_sub_strings(String)])),
<a name="2061"/> 2061:                 Res = os:cmd(Command),
<a name="2062"/> 2062:                 io:format(&quot;Command:~n&quot;),
<a name="2063"/> 2063:                 io:format(&quot;~s~n&quot;, [Command]),
<a name="2064"/> 2064:                 io:format(&quot;Result:~n&quot;),
<a name="2065"/> 2065:                 io:format(&quot;~s~n&quot;, [Res]),
<a name="2066"/> 2066:                 Res
<a name="2067"/> 2067:         end,
<a name="2068"/> 2068:     PrintLogLevelString =
<a name="2069"/> 2069:         &quot;io:format(\&quot;~p\&quot;,[element(2, application:get_env(kernel, logger_level))])&quot;,
<a name="2070"/> 2070:     %% Single config from file descriptor
<a name="2071"/> 2071:     &quot;warning&quot; =
<a name="2072"/> 2072:         RunInBash(
<a name="2073"/> 2073:           io_lib:format(
<a name="2074"/> 2074:             &quot;erl &quot;
<a name="2075"/> 2075:             &quot;-noshell &quot;
<a name="2076"/> 2076:             &quot;-configfd 3 &quot;
<a name="2077"/> 2077:             &quot;-eval &quot;
<a name="2078"/> 2078:             &quot;'~s,erlang:halt()' &quot;
<a name="2079"/> 2079:             &quot;3&lt; \&quot;~s\&quot;&quot;,
<a name="2080"/> 2080:             [PrintLogLevelString,
<a name="2081"/> 2081:              TestConfigPath1])),
<a name="2082"/> 2082:     %% Single config with .config sufix
<a name="2083"/> 2083:     &quot;warning&quot; =
<a name="2084"/> 2084:         RunInBash(
<a name="2085"/> 2085:           io_lib:format(
<a name="2086"/> 2086:             &quot;erl &quot;
<a name="2087"/> 2087:             &quot;-noshell &quot;
<a name="2088"/> 2088:             &quot;-configfd 3.config &quot;
<a name="2089"/> 2089:             &quot;-eval &quot;
<a name="2090"/> 2090:             &quot;'~s,erlang:halt()' &quot;
<a name="2091"/> 2091:             &quot;3&lt; \&quot;~s\&quot;&quot;,
<a name="2092"/> 2092:             [PrintLogLevelString,
<a name="2093"/> 2093:              TestConfigPath1])),
<a name="2094"/> 2094:     %% Single config from file descriptor (stdin)
<a name="2095"/> 2095:     %% This should automatically turn on -noinput
<a name="2096"/> 2096:     &quot;warning&quot; =
<a name="2097"/> 2097:         RunInBash(
<a name="2098"/> 2098:           io_lib:format(
<a name="2099"/> 2099:             &quot;erl &quot;
<a name="2100"/> 2100:             &quot;-configfd 0 &quot;
<a name="2101"/> 2101:             &quot;-eval &quot;
<a name="2102"/> 2102:             &quot;'~s,erlang:halt()' &quot;
<a name="2103"/> 2103:             &quot;0&lt; \&quot;~s\&quot;&quot;,
<a name="2104"/> 2104:             [PrintLogLevelString,
<a name="2105"/> 2105:              TestConfigPath1])),
<a name="2106"/> 2106:     %% Configs from two different file descriptors
<a name="2107"/> 2107:     &quot;error&quot; =
<a name="2108"/> 2108:         RunInBash(
<a name="2109"/> 2109:           io_lib:format(
<a name="2110"/> 2110:             &quot;erl &quot;
<a name="2111"/> 2111:             &quot;-noshell &quot;
<a name="2112"/> 2112:             &quot;-configfd 4 &quot;
<a name="2113"/> 2113:             &quot;-configfd 5 &quot;
<a name="2114"/> 2114:             &quot;-eval &quot;
<a name="2115"/> 2115:             &quot;'~s,erlang:halt()' &quot;
<a name="2116"/> 2116:             &quot;4&lt; \&quot;~s\&quot; &quot;
<a name="2117"/> 2117:             &quot;5&lt; \&quot;~s\&quot; &quot;,
<a name="2118"/> 2118:             [PrintLogLevelString,
<a name="2119"/> 2119:              TestConfigPath1,
<a name="2120"/> 2120:              TestConfigPath2])),
<a name="2121"/> 2121:     %% Configs from two different file descriptors single parameter
<a name="2122"/> 2122:     &quot;error&quot; =
<a name="2123"/> 2123:         RunInBash(
<a name="2124"/> 2124:           io_lib:format(
<a name="2125"/> 2125:             &quot;erl &quot;
<a name="2126"/> 2126:             &quot;-noshell &quot;
<a name="2127"/> 2127:             &quot;-configfd 4 5 &quot;
<a name="2128"/> 2128:             &quot;-eval &quot;
<a name="2129"/> 2129:             &quot;'~s,erlang:halt()' &quot;
<a name="2130"/> 2130:             &quot;4&lt; \&quot;~s\&quot; &quot;
<a name="2131"/> 2131:             &quot;5&lt; \&quot;~s\&quot; &quot;,
<a name="2132"/> 2132:             [PrintLogLevelString,
<a name="2133"/> 2133:              TestConfigPath1,
<a name="2134"/> 2134:              TestConfigPath2])),
<a name="2135"/> 2135:     lists:foreach(
<a name="2136"/> 2136:       fun(Path) -&gt;
<a name="2137"/> 2137:               &quot;warning&quot; =
<a name="2138"/> 2138:                   RunInBash(
<a name="2139"/> 2139:                     io_lib:format(
<a name="2140"/> 2140:                       &quot;erl &quot;
<a name="2141"/> 2141:                       &quot;-noshell &quot;
<a name="2142"/> 2142:                       &quot;-configfd 3 &quot;
<a name="2143"/> 2143:                       &quot;-eval &quot;
<a name="2144"/> 2144:                       &quot;'~s,erlang:halt()' &quot;
<a name="2145"/> 2145:                       &quot;3&lt; &lt;(echo '[\&quot;~s\&quot;].') &quot;,
<a name="2146"/> 2146:                       [PrintLogLevelString,
<a name="2147"/> 2147:                        Path]))
<a name="2148"/> 2148:       end,
<a name="2149"/> 2149:       [%% Absolute paths
<a name="2150"/> 2150:        TestConfigPath1,
<a name="2151"/> 2151:        %% Without suffix
<a name="2152"/> 2152:        filename:join(filename:dirname(TestConfigPath1),
<a name="2153"/> 2153:                      filename:basename(TestConfigPath1, &quot;.config&quot;)),
<a name="2154"/> 2154:        %% Relative To CWD
<a name="2155"/> 2155:        get_relative_path(TestConfigPath1, erlang:element(2, file:get_cwd()))
<a name="2156"/> 2156:       ] ++
<a name="2157"/> 2157:           case filename:pathtype(init:script_name()) of
<a name="2158"/> 2158:               absolute -&gt;
<a name="2159"/> 2159:                   %% Relative to the boot script directory
<a name="2160"/> 2160:                   [get_relative_path(TestConfigPath1,
<a name="2161"/> 2161:                                      filename:dirname(init:script_name()))];
<a name="2162"/> 2162:               _ -&gt;
<a name="2163"/> 2163:                   io:format(&quot;Skip include relative to boot script dir test. &quot;
<a name="2164"/> 2164:                             &quot;init:script_name() returned a relative path.&quot;
<a name="2165"/> 2165:                             &quot;init:script_name() can return a relative path if&quot;
<a name="2166"/> 2166:                             &quot;prim_file:get_pwd() fails during boot.&quot;),
<a name="2167"/> 2167:                   []
<a name="2168"/> 2168:           end
<a name="2169"/> 2169:      ),
<a name="2170"/> 2170:     %% init:restart() should work
<a name="2171"/> 2171:     &quot;errorerror&quot; =
<a name="2172"/> 2172:         RunInBash(
<a name="2173"/> 2173:           io_lib:format(
<a name="2174"/> 2174:             &quot;erl &quot;
<a name="2175"/> 2175:             &quot;-noshell &quot;
<a name="2176"/> 2176:             &quot;-configfd 3 &quot;
<a name="2177"/> 2177:             &quot;-eval &quot;
<a name="2178"/> 2178:             &quot;'~s,init:restart(),~s,erlang:halt()' &quot;
<a name="2179"/> 2179:             &quot;3&lt; \&quot;~s\&quot; &quot;,
<a name="2180"/> 2180:             [PrintLogLevelString,
<a name="2181"/> 2181:              PrintLogLevelString,
<a name="2182"/> 2182:              TestConfigPath2])),
<a name="2183"/> 2183:     %% Check that invalid file descriptor gives error
<a name="2184"/> 2184:     true =
<a name="2185"/> 2185:         (&quot;magic42&quot; =/=
<a name="2186"/> 2186:              RunInBash(
<a name="2187"/> 2187:                &quot;erl &quot;
<a name="2188"/> 2188:                &quot;-noshell &quot;
<a name="2189"/> 2189:                &quot;-configfd invalid &quot;
<a name="2190"/> 2190:                &quot;-eval &quot;
<a name="2191"/> 2191:                &quot;'io:format(\&quot;magic42\&quot;),erlang:halt()' &quot;)),
<a name="2192"/> 2192:     %% Check that an incorrect suffix gives error
<a name="2193"/> 2193:     true =
<a name="2194"/> 2194:         (&quot;magic42&quot; =/=
<a name="2195"/> 2195:              RunInBash(
<a name="2196"/> 2196:                io_lib:format(
<a name="2197"/> 2197:                  &quot;erl &quot;
<a name="2198"/> 2198:                  &quot;-noshell &quot;
<a name="2199"/> 2199:                  &quot;-configfd 3.badsuffix &quot;
<a name="2200"/> 2200:                  &quot;-eval &quot;
<a name="2201"/> 2201:                  &quot;'io:format(\&quot;magic42\&quot;),erlang:halt()' &quot;
<a name="2202"/> 2202:                  &quot;3&lt; \&quot;~s\&quot;&quot;,
<a name="2203"/> 2203:                  [TestConfigPath1]))),
<a name="2204"/> 2204:     %% Check that an output only file descriptor gives error
<a name="2205"/> 2205:     true =
<a name="2206"/> 2206:         (&quot;magic42&quot; =/=
<a name="2207"/> 2207:              RunInBash(&quot;erl &quot;
<a name="2208"/> 2208:                        &quot;-noshell &quot;
<a name="2209"/> 2209:                        &quot;-configfd 3 &quot;
<a name="2210"/> 2210:                        &quot;-eval &quot;
<a name="2211"/> 2211:                        &quot;'io:format(\&quot;magic42\&quot;),erlang:halt()' &quot;
<a name="2212"/> 2212:                        &quot;3&gt; /dev/null &quot;)),
<a name="2213"/> 2213:     %% Check that file descriptor with a huge amount of data fails
<a name="2214"/> 2214:     case application:start(os_mon) of
<a name="2215"/> 2215:         ok -&gt; case total_memory() of
<a name="2216"/> 2216:                   Memory when is_integer(Memory),
<a name="2217"/> 2217:                               Memory &gt; 8 -&gt;
<a name="2218"/> 2218:                       application:stop(os_mon),
<a name="2219"/> 2219:                       Res = RunInBash(
<a name="2220"/> 2220:                               &quot;erl &quot;
<a name="2221"/> 2221:                               &quot;-noshell &quot;
<a name="2222"/> 2222:                               &quot;-configfd 3 &quot;
<a name="2223"/> 2223:                               &quot;-eval &quot;
<a name="2224"/> 2224:                               &quot;'io:format(\&quot;magic42\&quot;),erlang:halt()' &quot;
<a name="2225"/> 2225:                               &quot;3&lt; &lt;(erl -noshell -eval '(fun W(D) -&gt; io:put_chars(D), W([D,&lt;&lt;\&quot;00000000000000000\&quot;&gt;&gt;]) end)([])') &quot;),
<a name="2226"/> 2226:                       {match, _} = re:run(Res,&quot;Max size 134217728 bytes exceeded&quot;);
<a name="2227"/> 2227:                   _ -&gt;
<a name="2228"/> 2228:                       io:format(&quot;Skipped huge file check to avoid flaky test on machine with less than 8GB of memory&quot;)
<a name="2229"/> 2229:               end;
<a name="2230"/> 2230:         _ -&gt;
<a name="2231"/> 2231:             io:format(&quot;Skipped because we could not start os_mon&quot;)
<a name="2232"/> 2232:     end,
<a name="do_configfd_test_bash-last_expr"/><a name="2233"/> 2233:     ok.
<a name="2234"/> 2234: 
<a name="total_memory-0"/><a name="2235"/> 2235: <b>total_memory</b>() -&gt;
<a name="2236"/> 2236:     %% Total memory in GB.
<a name="total_memory-last_expr"/><a name="2237"/> 2237:     try
<a name="2238"/> 2238: 	SMD = memsup:get_system_memory_data(),
<a name="2239"/> 2239:         TM = proplists:get_value(
<a name="2240"/> 2240:                available_memory, SMD,
<a name="2241"/> 2241:                proplists:get_value(
<a name="2242"/> 2242:                  total_memory, SMD,
<a name="2243"/> 2243:                  proplists:get_value(
<a name="2244"/> 2244:                    system_total_memory, SMD))),
<a name="2245"/> 2245:         TM div (1024*1024*1024)
<a name="2246"/> 2246:     catch
<a name="2247"/> 2247: 	_ : _ -&gt;
<a name="2248"/> 2248: 	    undefined
<a name="2249"/> 2249:     end.
<a name="2250"/> 2250: 
<a name="2251"/> 2251: <i>%% Test that one can get configuration from file descriptor with the</i>
<a name="2252"/> 2252: <i>%% -configfd option</i>
<a name="configfd_bash-1"/><a name="2253"/> 2253: <b>configfd_bash</b>(Conf) when is_list(Conf) -&gt;
<a name="configfd_bash-last_expr"/><a name="2254"/> 2254: <b>    case os:type</b>() of
<a name="2255"/> 2255:     	{unix,_} -&gt;
<a name="2256"/> 2256:             case os:cmd(&quot;bash -c \&quot;echo -n yes_bash_shell_exists\&quot;&quot;) of
<a name="2257"/> 2257:                 &quot;yes_bash_shell_exists&quot; -&gt;
<a name="2258"/> 2258:                     do_configfd_test_bash();
<a name="2259"/> 2259:                 _ -&gt;
<a name="2260"/> 2260:                     {skip,&quot;Runs only when there is a bash shell&quot;}
<a name="2261"/> 2261:             end;
<a name="2262"/> 2262:         _ -&gt; {skip,&quot;Runs only on UNIX systems&quot;}
<a name="2263"/> 2263:     end.
<a name="2264"/> 2264: 
<a name="2265"/> 2265: <i>%% This test should work on all platforms</i>
<a name="configfd_port_program-1"/><a name="2266"/> 2266: <b>configfd_port_program</b>(Conf) when is_list(Conf) -&gt;
<a name="2267"/> 2267:     ErlProgram =
<a name="2268"/> 2268:         case os:find_executable(&quot;erl&quot;) of
<a name="2269"/> 2269:             false -&gt; os:find_executable(&quot;erl.exe&quot;);
<a name="2270"/> 2270:             Path -&gt; Path
<a name="2271"/> 2271:         end,
<a name="configfd_port_program-last_expr"/><a name="2272"/> 2272:     case ErlProgram of
<a name="2273"/> 2273:         false -&gt;
<a name="2274"/> 2274:             {skip,&quot;Cannot find erl program&quot;};
<a name="2275"/> 2275:         ErlProgramPath -&gt;
<a name="2276"/> 2276:             do_configfd_test_port_program(ErlProgramPath)
<a name="2277"/> 2277:     end.
<a name="2278"/> 2278: 
<a name="2279"/> 2279: 
<a name="2280"/> 2280: 
<a name="2281"/> 2281: <i>%%%-----------------------------------------------------------------</i>
<a name="2282"/> 2282: <i>%%% Testing of application configuration change</i>
<a name="2283"/> 2283: <i>%%%-----------------------------------------------------------------</i>
<a name="2284"/> 2284: <i>%% Test change of application configuration.</i>
<a name="config_change-1"/><a name="2285"/> 2285: <b>config_change</b>(Conf) when is_list(Conf) -&gt;
<a name="2286"/> 2286: 
<a name="2287"/> 2287:     %% Change to data_dir
<a name="2288"/> 2288:     {ok, CWD} = file:get_cwd(),
<a name="2289"/> 2289:     DataDir = proplists:get_value(data_dir, Conf),
<a name="2290"/> 2290:     ok = file:set_cwd(DataDir),
<a name="2291"/> 2291: 
<a name="2292"/> 2292:     %% Find out application data from boot script
<a name="2293"/> 2293:     Boot = filename:join([code:root_dir(), &quot;bin&quot;, &quot;start.boot&quot;]),
<a name="2294"/> 2294:     {ok, Bin} = file:read_file(Boot),
<a name="2295"/> 2295:     Appls0 = get_appls(binary_to_term(Bin)),
<a name="2296"/> 2296: 
<a name="2297"/> 2297:     %% And add app1 in order to test OTP-11864 - included config files
<a name="2298"/> 2298:     %% not read for new (not already loaded) applications
<a name="2299"/> 2299:     Appls = [app1() | Appls0],
<a name="2300"/> 2300: 
<a name="2301"/> 2301:     %% Simulate contents of &quot;sys.config&quot;
<a name="2302"/> 2302:     Config = [{stdlib, [{par1,sys},{par2,sys}]},
<a name="2303"/> 2303: 		    &quot;t1&quot;,
<a name="2304"/> 2304: 		    &quot;t2.config&quot;,
<a name="2305"/> 2305: 		    filename:join([DataDir, &quot;subdir&quot;, &quot;t3&quot;]),
<a name="2306"/> 2306: 		    {stdlib, [{par6,sys}]},
<a name="2307"/> 2307: 	            &quot;t4.config&quot;],
<a name="2308"/> 2308: 
<a name="2309"/> 2309:     %% Check that app1 is not loaded
<a name="2310"/> 2310:     false = lists:keymember(app1,1,application:loaded_applications()),
<a name="2311"/> 2311: 
<a name="2312"/> 2312:     %% Order application_controller to update configuration
<a name="2313"/> 2313:     ok = application_controller:change_application_data(Appls,
<a name="2314"/> 2314: 							      Config),
<a name="2315"/> 2315: 
<a name="2316"/> 2316:     %% Check that stdlib parameters are correctly set
<a name="2317"/> 2317:     Env = application:get_all_env(stdlib),
<a name="2318"/> 2318:     {value, {par1,sys}} = lists:keysearch(par1, 1, Env),
<a name="2319"/> 2319:     {value, {par2,t1}}  = lists:keysearch(par2, 1, Env),
<a name="2320"/> 2320:     {value, {par3,t1}}  = lists:keysearch(par3, 1, Env),
<a name="2321"/> 2321:     {value, {par4,t2}}  = lists:keysearch(par4, 1, Env),
<a name="2322"/> 2322:     {value, {par5,t3}}  = lists:keysearch(par5, 1, Env),
<a name="2323"/> 2323:     {value, {par6,sys}} = lists:keysearch(par6, 1, Env),
<a name="2324"/> 2324: 
<a name="2325"/> 2325:     %% Check that app1 parameters are correctly set after loading
<a name="2326"/> 2326:     [] = application:get_all_env(app1),
<a name="2327"/> 2327:     application:load(app1()),
<a name="2328"/> 2328:     App1Env = application:get_all_env(app1),
<a name="2329"/> 2329:     {value, {par1,t4}} = lists:keysearch(par1, 1, App1Env),
<a name="2330"/> 2330:     application:unload(app1),
<a name="2331"/> 2331: 
<a name="config_change-last_expr"/><a name="2332"/> 2332: <b>    ok = file:set_cwd</b>(CWD).
<a name="2333"/> 2333: 
<a name="2334"/> 2334: <i>%% This function is stolen from SASL module release_handler, OTP R10B</i>
<a name="get_appls-1"/><a name="2335"/> 2335: <b>get_appls</b>({script, _, Script}) -&gt;
<a name="get_appls-last_expr"/><a name="2336"/> 2336: <b>    get_appls</b>(Script, []).
<a name="2337"/> 2337: 
<a name="2338"/> 2338: <i>%% kernel is taken care of separately</i>
<a name="get_appls-2"/><a name="2339"/> 2339: <b>get_appls</b>([{kernelProcess, application_controller, 
<a name="2340"/> 2340: 	    {application_controller, start, [App]}} | T], Res) -&gt;
<a name="2341"/> 2341:     get_appls(T, [App | Res]);
<a name="2342"/> 2342: <i>%% other applications but kernel</i>
<a name="2343"/> 2343: <b>get_appls</b>([{apply, {application, load, [App]}} | T], Res) -&gt;
<a name="2344"/> 2344:     get_appls(T, [App | Res]);
<a name="2345"/> 2345: <b>get_appls</b>([_ | T], Res) -&gt;
<a name="2346"/> 2346:     get_appls(T, Res);
<a name="2347"/> 2347: <b>get_appls</b>([], Res) -&gt;
<a name="get_appls-last_expr"/><a name="2348"/> 2348:     Res.
<a name="2349"/> 2349: 
<a name="2350"/> 2350: <i>%% Test set_env/1.</i>
<a name="set_env-1"/><a name="2351"/> 2351: <b>set_env</b>(Conf) when is_list(Conf) -&gt;
<a name="2352"/> 2352:     ok = application:set_env([{appinc, [{own2, persist}, {not_in_app, persist}]},
<a name="2353"/> 2353: 			      {unknown_app, [{key, persist}]}]),
<a name="2354"/> 2354: 
<a name="2355"/> 2355:     %% own_env1 and own2 are set in appinc
<a name="2356"/> 2356:     undefined = application:get_env(appinc, own_env1),
<a name="2357"/> 2357:     {ok, persist} = application:get_env(appinc, own2),
<a name="2358"/> 2358:     {ok, persist} = application:get_env(appinc, not_in_app),
<a name="2359"/> 2359:     {ok, persist} = application:get_env(unknown_app, key),
<a name="2360"/> 2360: 
<a name="2361"/> 2361:     ok = application:load(appinc()),
<a name="2362"/> 2362:     {ok, value1} = application:get_env(appinc, own_env1),
<a name="2363"/> 2363:     {ok, val2} = application:get_env(appinc, own2),
<a name="2364"/> 2364:     {ok, persist} = application:get_env(appinc, not_in_app),
<a name="2365"/> 2365:     {ok, persist} = application:get_env(unknown_app, key),
<a name="2366"/> 2366: 
<a name="2367"/> 2367:     %% On reload, values are lost
<a name="2368"/> 2368:     ok = application:unload(appinc),
<a name="2369"/> 2369:     ok = application:load(appinc()),
<a name="2370"/> 2370:     {ok, value1} = application:get_env(appinc, own_env1),
<a name="2371"/> 2371:     {ok, val2} = application:get_env(appinc, own2),
<a name="2372"/> 2372:     undefined = application:get_env(appinc, not_in_app),
<a name="2373"/> 2373: 
<a name="2374"/> 2374:     %% Clean up
<a name="set_env-last_expr"/><a name="2375"/> 2375: <b>    ok = application:unload</b>(appinc).
<a name="2376"/> 2376: 
<a name="2377"/> 2377: <i>%% Test set_env/2 with persistent true.</i>
<a name="set_env_persistent-1"/><a name="2378"/> 2378: <b>set_env_persistent</b>(Conf) when is_list(Conf) -&gt;
<a name="2379"/> 2379:     Opts = [{persistent, true}],
<a name="2380"/> 2380:     ok = application:set_env([{appinc, [{own2, persist}, {not_in_app, persist}]},
<a name="2381"/> 2381: 			      {unknown_app, [{key, persist}]}], Opts),
<a name="2382"/> 2382: 
<a name="2383"/> 2383:     %% own_env1 and own2 are set in appinc
<a name="2384"/> 2384:     undefined = application:get_env(appinc, own_env1),
<a name="2385"/> 2385:     {ok, persist} = application:get_env(appinc, own2),
<a name="2386"/> 2386:     {ok, persist} = application:get_env(appinc, not_in_app),
<a name="2387"/> 2387:     {ok, persist} = application:get_env(unknown_app, key),
<a name="2388"/> 2388: 
<a name="2389"/> 2389:     ok = application:load(appinc()),
<a name="2390"/> 2390:     {ok, value1} = application:get_env(appinc, own_env1),
<a name="2391"/> 2391:     {ok, persist} = application:get_env(appinc, own2),
<a name="2392"/> 2392:     {ok, persist} = application:get_env(appinc, not_in_app),
<a name="2393"/> 2393:     {ok, persist} = application:get_env(unknown_app, key),
<a name="2394"/> 2394: 
<a name="2395"/> 2395:     %% On reload, values are not lost
<a name="2396"/> 2396:     ok = application:unload(appinc),
<a name="2397"/> 2397:     ok = application:load(appinc()),
<a name="2398"/> 2398:     {ok, value1} = application:get_env(appinc, own_env1),
<a name="2399"/> 2399:     {ok, persist} = application:get_env(appinc, own2),
<a name="2400"/> 2400:     {ok, persist} = application:get_env(appinc, not_in_app),
<a name="2401"/> 2401: 
<a name="2402"/> 2402:     %% Clean up
<a name="set_env_persistent-last_expr"/><a name="2403"/> 2403: <b>    ok = application:unload</b>(appinc).
<a name="2404"/> 2404: 
<a name="set_env_errors-1"/><a name="2405"/> 2405: <b>set_env_errors</b>(Conf) when is_list(Conf) -&gt;
<a name="2406"/> 2406:     &quot;application: 1; application name must be an atom&quot; =
<a name="2407"/> 2407: 	badarg_msg(fun() -&gt; application:set_env([{1, []}]) end),
<a name="2408"/> 2408: 
<a name="2409"/> 2409:     &quot;application: foo; parameters must be a list&quot; =
<a name="2410"/> 2410: 	badarg_msg(fun() -&gt; application:set_env([{foo, bar}]) end),
<a name="2411"/> 2411: 
<a name="2412"/> 2412:     &quot;invalid application config: foo_bar&quot; =
<a name="2413"/> 2413: 	badarg_msg(fun() -&gt; application:set_env([foo_bar]) end),
<a name="2414"/> 2414: 
<a name="2415"/> 2415:     &quot;application: foo; invalid parameter name: 1&quot; =
<a name="2416"/> 2416: 	badarg_msg(fun() -&gt; application:set_env([{foo, [{1, 2}]}]) end),
<a name="2417"/> 2417: 
<a name="2418"/> 2418:     &quot;application: foo; invalid parameter: config&quot; =
<a name="2419"/> 2419: 	badarg_msg(fun() -&gt; application:set_env([{foo, [config]}]) end),
<a name="2420"/> 2420: 
<a name="2421"/> 2421:     &quot;application: kernel; erroneous parameter: distributed&quot; =
<a name="2422"/> 2422: 	badarg_msg(fun() -&gt; application:set_env([{kernel, [{distributed, config}]}]) end),
<a name="2423"/> 2423: 
<a name="2424"/> 2424:     &quot;duplicate application config: foo&quot; =
<a name="2425"/> 2425: 	badarg_msg(fun() -&gt; application:set_env([{foo, []}, {foo, []}]) end),
<a name="2426"/> 2426: 
<a name="2427"/> 2427:     &quot;application: foo; duplicate parameter: bar&quot; =
<a name="2428"/> 2428: 	badarg_msg(fun() -&gt; application:set_env([{foo, [{bar, baz}, {bar, bat}]}]) end),
<a name="2429"/> 2429: 
<a name="set_env_errors-last_expr"/><a name="2430"/> 2430:     ok.
<a name="2431"/> 2431: 
<a name="badarg_msg-1"/><a name="2432"/> 2432: <b>badarg_msg</b>(Fun) -&gt;
<a name="badarg_msg-last_expr"/><a name="2433"/> 2433: <b>    try Fun</b>() of
<a name="2434"/> 2434: 	_ -&gt; ct:fail(try_succeeded)
<a name="2435"/> 2435:     catch
<a name="2436"/> 2436: 	error:{badarg, Msg} -&gt; Msg
<a name="2437"/> 2437:     end.
<a name="2438"/> 2438: 
<a name="2439"/> 2439: <i>%% Test set_env/4 and unset_env/3 with persistent true.</i>
<a name="persistent_env-1"/><a name="2440"/> 2440: <b>persistent_env</b>(Conf) when is_list(Conf) -&gt;
<a name="2441"/> 2441:     ok = application:set_env(appinc, own2, persist, [{persistent, true}]),
<a name="2442"/> 2442:     ok = application:set_env(appinc, key1, persist, [{persistent, true}]),
<a name="2443"/> 2443: 
<a name="2444"/> 2444:     %% own_env1 and own2 are set in appinc
<a name="2445"/> 2445:     ok = application:load(appinc()),
<a name="2446"/> 2446:     {ok, value1} = application:get_env(appinc, own_env1),
<a name="2447"/> 2447:     {ok, persist} = application:get_env(appinc, own2),
<a name="2448"/> 2448:     {ok, persist} = application:get_env(appinc, key1),
<a name="2449"/> 2449: 
<a name="2450"/> 2450:     %% Changing the environment after loaded reflects and should persist
<a name="2451"/> 2451:     ok = application:set_env(appinc, own_env1, persist, [{persistent, true}]),
<a name="2452"/> 2452:     {ok, persist} = application:get_env(appinc, own_env1),
<a name="2453"/> 2453:     {ok, persist} = application:get_env(appinc, own2),
<a name="2454"/> 2454:     {ok, persist} = application:get_env(appinc, key1),
<a name="2455"/> 2455: 
<a name="2456"/> 2456:     %% On reload, own_env1, own2 and key1 should all persist
<a name="2457"/> 2457:     ok = application:unload(appinc),
<a name="2458"/> 2458:     ok = application:load(appinc()),
<a name="2459"/> 2459:     {ok, persist} = application:get_env(appinc, own_env1),
<a name="2460"/> 2460:     {ok, persist} = application:get_env(appinc, own2),
<a name="2461"/> 2461:     {ok, persist} = application:get_env(appinc, key1),
<a name="2462"/> 2462: 
<a name="2463"/> 2463:     %% Unset own_env1 and key1, own2 should still persist
<a name="2464"/> 2464:     ok = application:unset_env(appinc, own_env1, [{persistent, true}]),
<a name="2465"/> 2465:     ok = application:unset_env(appinc, key1, [{persistent, true}]),
<a name="2466"/> 2466:     undefined = application:get_env(appinc, own_env1),
<a name="2467"/> 2467:     {ok, persist} = application:get_env(appinc, own2),
<a name="2468"/> 2468:     undefined = application:get_env(appinc, key1),
<a name="2469"/> 2469: 
<a name="2470"/> 2470:     %% own_env1 should be back to its application value on reload
<a name="2471"/> 2471:     ok = application:unload(appinc),
<a name="2472"/> 2472:     ok = application:load(appinc()),
<a name="2473"/> 2473:     {ok, value1} = application:get_env(appinc, own_env1),
<a name="2474"/> 2474:     {ok, persist} = application:get_env(appinc, own2),
<a name="2475"/> 2475:     undefined = application:get_env(appinc, key1),
<a name="2476"/> 2476: 
<a name="2477"/> 2477:     %% Clean up
<a name="persistent_env-last_expr"/><a name="2478"/> 2478: <b>    ok = application:unload</b>(appinc).
<a name="2479"/> 2479: 
<a name="2480"/> 2480: <i>%% Test that application app file error handling works as it should</i>
<a name="invalid_app_file-1"/><a name="2481"/> 2481: <b>invalid_app_file</b>(_Config) -&gt;
<a name="2482"/> 2482: 
<a name="2483"/> 2483:     {error,{bad_application,{application,&quot;name&quot;,[]}}}
<a name="2484"/> 2484:         = application:load({application, &quot;name&quot;,[]}),
<a name="2485"/> 2485:     {error,{invalid_options,#{}}}
<a name="2486"/> 2486:         = application:load({application, name,#{}}),
<a name="2487"/> 2487:     {error, {invalid_options,_}} =
<a name="2488"/> 2488:         application:load({application,name,[{env,[{&quot;key&quot;,value}]}]}),
<a name="2489"/> 2489:     {error, {invalid_options,_}} =
<a name="2490"/> 2490:         application:load({application,name,[{env,[key]}]}),
<a name="invalid_app_file-last_expr"/><a name="2491"/> 2491:     {error, {invalid_options,_}} =
<a name="2492"/> 2492:         application:load({application,name,[{env,[{key,value},{key,value}]}]}).
<a name="2493"/> 2493: 
<a name="2494"/> 2494: <i>%% Test more than one config file defined by one -config parameter:</i>
<a name="handle_many_config_files-1"/><a name="2495"/> 2495: <b>handle_many_config_files</b>(Conf) when is_list(Conf) -&gt;
<a name="2496"/> 2496: 
<a name="2497"/> 2497:     %% Write a config file
<a name="2498"/> 2498:     Dir = proplists:get_value(priv_dir, Conf),
<a name="2499"/> 2499:     {ok, Fd} = file:open(filename:join(Dir, &quot;sys.config&quot;), [write]),
<a name="2500"/> 2500:     io:format(Fd, &quot;[].~n&quot;, []),
<a name="2501"/> 2501:     file:close(Fd),
<a name="2502"/> 2502:     NodeName = node_name(n1, Conf),
<a name="2503"/> 2503:     Config = filename:join(Dir, &quot;sys&quot;),
<a name="2504"/> 2504: 
<a name="2505"/> 2505:     %% Node will be started with two -config
<a name="2506"/> 2506:     %% First one has one argument and second one has two arguments.
<a name="2507"/> 2507:     {ok, Node} = start_node(
<a name="2508"/> 2508:         NodeName,
<a name="2509"/> 2509:         Config,
<a name="2510"/> 2510:         &quot; -config &quot; ++ Config ++ &quot; &quot; ++ Config
<a name="2511"/> 2511:     ),
<a name="2512"/> 2512:     case rpc:call(Node, init, get_argument, [config]) of
<a name="2513"/> 2513:         {ok, [[Config], [Config, Config]]} -&gt; ok;
<a name="2514"/> 2514:         {ok, [[Config], [Config], [Config]]} -&gt; ok %% This happens on windows
<a name="2515"/> 2515:     end,
<a name="handle_many_config_files-last_expr"/><a name="2516"/> 2516: <b>    stop_node_nice</b>(Node).
<a name="2517"/> 2517: 
<a name="2518"/> 2518: <i>%%%-----------------------------------------------------------------</i>
<a name="2519"/> 2519: <i>%%% Tests the 'shutdown_func' kernel config parameter</i>
<a name="2520"/> 2520: <i>%%%-----------------------------------------------------------------</i>
<a name="2521"/> 2521: <i>%% Tests the 'shutdown_func' kernel config parameter.</i>
<a name="shutdown_func-1"/><a name="2522"/> 2522: <b>shutdown_func</b>(Config) when is_list(Config) -&gt;
<a name="2523"/> 2523:     {ok,Cp1} = start_node(?MODULE_STRING++&quot;_shutdown_func&quot;),
<a name="2524"/> 2524:     wait_for_ready_net(),
<a name="2525"/> 2525:     Tag = make_ref(),
<a name="2526"/> 2526:     ok = rpc:call(Cp1, application, set_env, 
<a name="2527"/> 2527:                         [kernel, shutdown_func, {?MODULE, do_shutdown}]),
<a name="2528"/> 2528:     ok = rpc:call(Cp1, application, set_env,
<a name="2529"/> 2529:                         [kernel, shutdown_func_test, {self(), Tag}]),
<a name="2530"/> 2530:     _ = rpc:call(Cp1, init, stop, []),
<a name="shutdown_func-last_expr"/><a name="2531"/> 2531:     receive
<a name="2532"/> 2532: 	      {Pid, Tag, shutting_down, shutdown} -&gt;
<a name="2533"/> 2533: 		  Mref = erlang:monitor(process, Pid),
<a name="2534"/> 2534: 		  Pid ! {self(), Tag, ok},
<a name="2535"/> 2535: 		  receive
<a name="2536"/> 2536: 		      {'DOWN', Mref, _, Pid, noconnection} -&gt;
<a name="2537"/> 2537: 			  ok
<a name="2538"/> 2538: 		  after 10000 -&gt;
<a name="2539"/> 2539: 			  ct:fail(timeout)
<a name="2540"/> 2540: 		  end
<a name="2541"/> 2541: 	  after 10000 -&gt;
<a name="2542"/> 2542: 		  ct:fail(timeout)
<a name="2543"/> 2543: 	  end.
<a name="2544"/> 2544: 
<a name="2545"/> 2545: 
<a name="2546"/> 2546: 
<a name="do_shutdown-1"/><a name="2547"/> 2547: <b>do_shutdown</b>(Reason) -&gt;
<a name="2548"/> 2548:     {ok, {Pid, Tag}} = application:get_env(kernel, shutdown_func_test),
<a name="2549"/> 2549:     Pid ! {self(), Tag, shutting_down, Reason},
<a name="do_shutdown-last_expr"/><a name="2550"/> 2550:     receive 
<a name="2551"/> 2551: 	{Pid, Tag, ok} -&gt; ok 
<a name="2552"/> 2552:     end.
<a name="2553"/> 2553: 
<a name="2554"/> 2554: 
<a name="2555"/> 2555: 
<a name="2556"/> 2556: <i>%%%-----------------------------------------------------------------</i>
<a name="2557"/> 2557: <i>%%% Tests the 'shutdown_timeout' kernel config parameter</i>
<a name="2558"/> 2558: <i>%%%-----------------------------------------------------------------</i>
<a name="shutdown_timeout-1"/><a name="2559"/> 2559: <b>shutdown_timeout</b>(Config) when is_list(Config) -&gt;
<a name="2560"/> 2560:     DataDir = proplists:get_value(data_dir,Config),
<a name="2561"/> 2561:     {ok,Cp1} = start_node(?MODULE_STRING++&quot;_shutdown_timeout&quot;),
<a name="2562"/> 2562:     wait_for_ready_net(),
<a name="2563"/> 2563:     ok = rpc:call(Cp1, application, set_env, [kernel, shutdown_timeout, 1000]),
<a name="2564"/> 2564:     rpc:call(Cp1, code, add_path, [filename:join([DataDir,deadlock])]),
<a name="2565"/> 2565:     ok = rpc:call(Cp1, application, start, [sasl]),
<a name="2566"/> 2566:     ok = rpc:call(Cp1, application, start, [deadlock]),
<a name="2567"/> 2567:     rpc:call(Cp1, deadlock, restart_and_fail, []),
<a name="2568"/> 2568: 
<a name="2569"/> 2569:     ok = net_kernel:monitor_nodes(true),
<a name="2570"/> 2570:     _ = rpc:call(Cp1, init, stop, []),
<a name="2571"/> 2571:     receive
<a name="2572"/> 2572: 	{nodedown,Cp1} -&gt;
<a name="2573"/> 2573: 	    ok
<a name="2574"/> 2574:     after 10000 -&gt;
<a name="2575"/> 2575: 	    ct:fail(&quot;timeout 10 sec: node termination hangs&quot;)
<a name="2576"/> 2576:     end,
<a name="shutdown_timeout-last_expr"/><a name="2577"/> 2577:     ok.
<a name="2578"/> 2578: 
<a name="2579"/> 2579: <i>%%%-----------------------------------------------------------------</i>
<a name="2580"/> 2580: <i>%%% Provokes a (previous) application shutdown deadlock</i>
<a name="2581"/> 2581: <i>%%%-----------------------------------------------------------------</i>
<a name="shutdown_deadlock-1"/><a name="2582"/> 2582: <b>shutdown_deadlock</b>(Config) when is_list(Config) -&gt;
<a name="2583"/> 2583:     DataDir = proplists:get_value(data_dir,Config),
<a name="2584"/> 2584:     code:add_path(filename:join([DataDir,deadlock])),
<a name="2585"/> 2585:     %% ok = rpc:call(Cp1, application, start, [sasl]),
<a name="2586"/> 2586:     ok = application:start(deadlock),
<a name="2587"/> 2587:     Tester = self(),
<a name="2588"/> 2588:     application:set_env(deadlock, fail_stop, Tester),
<a name="2589"/> 2589:     spawn(fun() -&gt; Tester ! {stop, application:stop(deadlock)} end),
<a name="2590"/> 2590: 
<a name="2591"/> 2591:     receive
<a name="2592"/> 2592: 	{deadlock, Server} -&gt;
<a name="2593"/> 2593: 	    spawn(fun() -&gt;
<a name="2594"/> 2594: 			  Master = application_controller:get_master(deadlock),
<a name="2595"/> 2595: 			  Child = application_master:get_child(Master),
<a name="2596"/> 2596: 			  Tester ! {child, Child}
<a name="2597"/> 2597: 		  end),
<a name="2598"/> 2598: 	    timer:sleep(100),
<a name="2599"/> 2599: 	    erlang:display({self(), &quot;Sending Continue&quot;, Server}),
<a name="2600"/> 2600: 	    Server ! continue
<a name="2601"/> 2601:     end,
<a name="2602"/> 2602:     [_|_] = application:which_applications(),
<a name="2603"/> 2603:     application:unload(deadlock), % clean up!
<a name="shutdown_deadlock-last_expr"/><a name="2604"/> 2604:     ok.
<a name="2605"/> 2605: 
<a name="2606"/> 2606: 
<a name="2607"/> 2607: <i>%%-----------------------------------------------------------------</i>
<a name="2608"/> 2608: <i>%% Relative paths in sys.config</i>
<a name="2609"/> 2609: <i>%%-----------------------------------------------------------------</i>
<a name="config_relative_paths-1"/><a name="2610"/> 2610: <b>config_relative_paths</b>(Config) -&gt;
<a name="2611"/> 2611:     Dir = ?config(priv_dir,Config),
<a name="2612"/> 2612:     SubDir = filename:join(Dir,&quot;subdir&quot;),
<a name="2613"/> 2613:     Sys = filename:join(SubDir,&quot;sys.config&quot;),
<a name="2614"/> 2614:     ok = filelib:ensure_dir(Sys),
<a name="2615"/> 2615:     ok = file:write_file(Sys,&quot;[\&quot;../up.config\&quot;,\&quot;current\&quot;].\n&quot;),
<a name="2616"/> 2616: 
<a name="2617"/> 2617:     Up = filename:join(Dir,&quot;up.config&quot;),
<a name="2618"/> 2618:     ok = file:write_file(Up,&quot;[{app1,[{key1,value}]}].\n&quot;),
<a name="2619"/> 2619: 
<a name="2620"/> 2620:     {ok,Cwd} = file:get_cwd(),
<a name="2621"/> 2621:     Current1 = filename:join(Cwd,&quot;current.config&quot;),
<a name="2622"/> 2622:     ok = file:write_file(Current1,&quot;[{app1,[{key2,value1}]}].\n&quot;),
<a name="2623"/> 2623: 
<a name="2624"/> 2624:     N1 = list_to_atom(lists:concat([?FUNCTION_NAME,&quot;_1&quot;])),
<a name="2625"/> 2625:     {ok,Node1} = start_node(N1,filename:rootname(Sys)),
<a name="2626"/> 2626:     ok = rpc:call(Node1, application, load, [app1()]),
<a name="2627"/> 2627:     {ok, value} = rpc:call(Node1, application, get_env,[app1,key1]),
<a name="2628"/> 2628:     {ok, value1} = rpc:call(Node1, application, get_env,[app1,key2]),
<a name="2629"/> 2629: 
<a name="2630"/> 2630:     Current2 = filename:join(SubDir,&quot;current.config&quot;),
<a name="2631"/> 2631:     ok = file:write_file(Current2,&quot;[{app1,[{key2,value2}]}].\n&quot;),
<a name="2632"/> 2632: 
<a name="2633"/> 2633:     N2 = list_to_atom(lists:concat([?FUNCTION_NAME,&quot;_2&quot;])),
<a name="2634"/> 2634:     {ok, Node2} = start_node(N2,filename:rootname(Sys)),
<a name="2635"/> 2635:     ok = rpc:call(Node2, application, load, [app1()]),
<a name="2636"/> 2636:     {ok, value} = rpc:call(Node2, application, get_env,[app1,key1]),
<a name="2637"/> 2637:     {ok, value2} = rpc:call(Node2, application, get_env,[app1,key2]),
<a name="2638"/> 2638: 
<a name="2639"/> 2639:     stop_node_nice([Node1,Node2]),
<a name="2640"/> 2640: 
<a name="config_relative_paths-last_expr"/><a name="2641"/> 2641:     ok.
<a name="2642"/> 2642: 
<a name="2643"/> 2643: <i>%%-----------------------------------------------------------------</i>
<a name="2644"/> 2644: <i>%% Utility functions</i>
<a name="2645"/> 2645: <i>%%-----------------------------------------------------------------</i>
<a name="app0-0"/><a name="2646"/> 2646: <b>app0</b>() -&gt;
<a name="app0-last_expr"/><a name="2647"/> 2647:     {application, app0,
<a name="2648"/> 2648:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2649"/> 2649:       {vsn, &quot;2.0&quot;},
<a name="2650"/> 2650:       {modules, []},
<a name="2651"/> 2651:       {registered, []},
<a name="2652"/> 2652:       {applications, [kernel]},
<a name="2653"/> 2653:       {mod, {ch_sup, {app0, 77, 80}}}]}.
<a name="2654"/> 2654: 
<a name="app1-0"/><a name="2655"/> 2655: <b>app1</b>() -&gt;
<a name="app1-last_expr"/><a name="2656"/> 2656:     {application, app1,
<a name="2657"/> 2657:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2658"/> 2658:       {vsn, &quot;2.0&quot;},
<a name="2659"/> 2659:       {modules, []},
<a name="2660"/> 2660:       {registered, []},
<a name="2661"/> 2661:       {applications, [kernel]},
<a name="2662"/> 2662:       {mod, {ch_sup, {app1, 1, 3}}}]}.
<a name="2663"/> 2663: 
<a name="app2-0"/><a name="2664"/> 2664: <b>app2</b>() -&gt;
<a name="app2-last_expr"/><a name="2665"/> 2665:     {application, app2,
<a name="2666"/> 2666:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2667"/> 2667:       {vsn, &quot;2.0&quot;},
<a name="2668"/> 2668:       {modules, []},
<a name="2669"/> 2669:       {registered, []},
<a name="2670"/> 2670:       {applications, [kernel]},
<a name="2671"/> 2671:       {mod, {ch_sup, {app2, 4, 6}}}]}.
<a name="2672"/> 2672: 
<a name="app3-0"/><a name="2673"/> 2673: <b>app3</b>() -&gt;
<a name="app3-last_expr"/><a name="2674"/> 2674:     {application, app3,
<a name="2675"/> 2675:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2676"/> 2676:       {vsn, &quot;2.0&quot;},
<a name="2677"/> 2677:       {modules, []},
<a name="2678"/> 2678:       {registered, []},
<a name="2679"/> 2679:       {applications, [kernel]},
<a name="2680"/> 2680:       {mod, {ch_sup, {app3, 7, 9}}}]}.
<a name="2681"/> 2681: 
<a name="app4-0"/><a name="2682"/> 2682: <b>app4</b>() -&gt;
<a name="app4-last_expr"/><a name="2683"/> 2683:     {application, app4,
<a name="2684"/> 2684:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2685"/> 2685:       {vsn, &quot;2.0&quot;},
<a name="2686"/> 2686:       {applications, [kernel]},
<a name="2687"/> 2687:       {included_applications, [app5]},
<a name="2688"/> 2688:       {mod, {ch_sup, {app3, 7, 9}}}]}.
<a name="2689"/> 2689: 
<a name="app5-0"/><a name="2690"/> 2690: <b>app5</b>() -&gt;
<a name="app5-last_expr"/><a name="2691"/> 2691:     {application, app5,
<a name="2692"/> 2692:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2693"/> 2693:       {vsn, &quot;2.0&quot;},
<a name="2694"/> 2694:       {applications, [kernel]},
<a name="2695"/> 2695:       {mod, {ch_sup, {app3, 7, 9}}}]}.
<a name="2696"/> 2696: 
<a name="app6-0"/><a name="2697"/> 2697: <b>app6</b>() -&gt;
<a name="app6-last_expr"/><a name="2698"/> 2698:     {application, app6,
<a name="2699"/> 2699:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2700"/> 2700:       {vsn, &quot;2.0&quot;},
<a name="2701"/> 2701:       {modules, []},
<a name="2702"/> 2702:       {registered, []},
<a name="2703"/> 2703:       {applications, [kernel]},
<a name="2704"/> 2704:       {mod, {ch_sup, {app6, 10, 12}}}]}.
<a name="2705"/> 2705: 
<a name="app7-0"/><a name="2706"/> 2706: <b>app7</b>() -&gt;
<a name="app7-last_expr"/><a name="2707"/> 2707:     {application, app7,
<a name="2708"/> 2708:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2709"/> 2709:       {vsn, &quot;2.0&quot;},
<a name="2710"/> 2710:       {modules, []},
<a name="2711"/> 2711:       {registered, []},
<a name="2712"/> 2712:       {applications, [kernel]},
<a name="2713"/> 2713:       {mod, {ch_sup, {app7, 13, 15}}}]}.
<a name="2714"/> 2714: 
<a name="app8-0"/><a name="2715"/> 2715: <b>app8</b>() -&gt;
<a name="app8-last_expr"/><a name="2716"/> 2716:     {application, app8,
<a name="2717"/> 2717:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2718"/> 2718:       {vsn, &quot;2.0&quot;},
<a name="2719"/> 2719:       {modules, []},
<a name="2720"/> 2720:       {registered, []},
<a name="2721"/> 2721:       {applications, [kernel]},
<a name="2722"/> 2722:       {mod, {ch_sup, {app7, 16, 18}}}]}.
<a name="2723"/> 2723: 
<a name="app9-0"/><a name="2724"/> 2724: <b>app9</b>() -&gt;
<a name="app9-last_expr"/><a name="2725"/> 2725:     {application, app9,
<a name="2726"/> 2726:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2727"/> 2727:       {vsn, &quot;2.0&quot;},
<a name="2728"/> 2728:       {modules, []},
<a name="2729"/> 2729:       {registered, []},
<a name="2730"/> 2730:       {applications, [kernel]},
<a name="2731"/> 2731:       {mod, {ch_sup, {app9, 19, 19}}}]}.
<a name="2732"/> 2732: 
<a name="app10-2"/><a name="2733"/> 2733: <b>app10</b>(Apps, OptionalApps) -&gt;
<a name="app10-last_expr"/><a name="2734"/> 2734:     {application, app10,
<a name="2735"/> 2735:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2736"/> 2736:       {vsn, &quot;2.0&quot;},
<a name="2737"/> 2737:       {modules, []},
<a name="2738"/> 2738:       {registered, []},
<a name="2739"/> 2739:       {applications, [kernel] ++ Apps},
<a name="2740"/> 2740:       {optional_applications, OptionalApps},
<a name="2741"/> 2741:       {mod, {ch_sup, {app10, 20, 20}}}]}.
<a name="2742"/> 2742: 
<a name="appinc-0"/><a name="2743"/> 2743: <b>appinc</b>() -&gt;
<a name="appinc-last_expr"/><a name="2744"/> 2744:     {application, appinc,
<a name="2745"/> 2745:      [{description, &quot;Test of new app file, including appnew&quot;},
<a name="2746"/> 2746:       {id, &quot;CXC 138 ai&quot;},
<a name="2747"/> 2747:       {vsn, &quot;2.0&quot;},
<a name="2748"/> 2748:       {applications, [kernel]},
<a name="2749"/> 2749:       {modules, []},
<a name="2750"/> 2750:       {registered, []},
<a name="2751"/> 2751:       {env, [{own_env1, value1}, {own2, val2}]},
<a name="2752"/> 2752:       {included_applications, [appinc1, appinc2]},
<a name="2753"/> 2753:       {start_phases, [{init, [kalle]}, {takeover, []}, {go, [sune]}]},
<a name="2754"/> 2754:       {mod, {application_starter, [ch_sup, {appinc, 41, 43}] }}]}. 
<a name="2755"/> 2755: 
<a name="2756"/> 2756: 
<a name="app_sp-0"/><a name="2757"/> 2757: <b>app_sp</b>() -&gt;
<a name="app_sp-last_expr"/><a name="2758"/> 2758:     {application, app_sp,
<a name="2759"/> 2759:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2760"/> 2760:       {vsn, &quot;2.0&quot;},
<a name="2761"/> 2761:       {start_phases, [{init, [kurt]}, {go, [sune]}]},
<a name="2762"/> 2762:       {applications, [kernel]},
<a name="2763"/> 2763:       {modules, []},
<a name="2764"/> 2764:       {registered, []},
<a name="2765"/> 2765:       {mod, {application_starter, [ch_sup, {app_sp, 31, 33}] }}]}. 
<a name="2766"/> 2766: 
<a name="app_trans_normal-0"/><a name="2767"/> 2767: <b>app_trans_normal</b>() -&gt;
<a name="app_trans_normal-last_expr"/><a name="2768"/> 2768:     {application, trans_normal,
<a name="2769"/> 2769:      [{description, &quot;A  CXC 138 11&quot;},
<a name="2770"/> 2770:       {vsn, &quot;1.0&quot;},
<a name="2771"/> 2771:       {modules, [{transient, 1}, {trans_normal_sup,1}]},
<a name="2772"/> 2772:       {registered, [trans_normal_sup]},
<a name="2773"/> 2773:       {applications, [kernel, stdlib]},
<a name="2774"/> 2774:       {mod, {trans_normal_sup, []}}]}.
<a name="2775"/> 2775: 
<a name="app_trans_abnormal-0"/><a name="2776"/> 2776: <b>app_trans_abnormal</b>() -&gt;
<a name="app_trans_abnormal-last_expr"/><a name="2777"/> 2777:     {application, trans_abnormal,
<a name="2778"/> 2778:      [{description, &quot;A  CXC 138 11&quot;},
<a name="2779"/> 2779:       {vsn, &quot;1.0&quot;},
<a name="2780"/> 2780:       {modules, [{transient, 1}, {trans_abnormal_sup,1}]},
<a name="2781"/> 2781:       {registered, [trans_abnormal_sup]},
<a name="2782"/> 2782:       {applications, [kernel, stdlib]},
<a name="2783"/> 2783:       {mod, {trans_abnormal_sup, []}}]}.
<a name="2784"/> 2784: 
<a name="app_start_error-0"/><a name="2785"/> 2785: <b>app_start_error</b>() -&gt;
<a name="app_start_error-last_expr"/><a name="2786"/> 2786:     {application, app_start_error,
<a name="2787"/> 2787:      [{description, &quot;ERTS  CXC 138 10&quot;},
<a name="2788"/> 2788:       {vsn, &quot;2.0&quot;},
<a name="2789"/> 2789:       {modules, []},
<a name="2790"/> 2790:       {registered, []},
<a name="2791"/> 2791:       {applications, [kernel]},
<a name="2792"/> 2792:       {mod, {app_start_error, []}}]}.
<a name="2793"/> 2793: 
<a name="app_chain_error-0"/><a name="2794"/> 2794: <b>app_chain_error</b>() -&gt;
<a name="app_chain_error-last_expr"/><a name="2795"/> 2795:     {application, app_chain_error,
<a name="2796"/> 2796:      [{description, &quot;ERTS  CXC 138 ce&quot;},
<a name="2797"/> 2797:       {vsn, &quot;2.0&quot;},
<a name="2798"/> 2798:       {modules, []},
<a name="2799"/> 2799:       {registered, []},
<a name="2800"/> 2800:       {applications, [kernel, app_chain_error2]},
<a name="2801"/> 2801:       {mod, {ch_sup, {app_chain_error, 20,20}}}]}.
<a name="2802"/> 2802: 
<a name="app_chain_error2-0"/><a name="2803"/> 2803: <b>app_chain_error2</b>() -&gt;
<a name="app_chain_error2-last_expr"/><a name="2804"/> 2804:     {application, app_chain_error2,
<a name="2805"/> 2805:      [{description, &quot;ERTS  CXC 138 ce2&quot;},
<a name="2806"/> 2806:       {vsn, &quot;2.0&quot;},
<a name="2807"/> 2807:       {modules, []},
<a name="2808"/> 2808:       {registered, []},
<a name="2809"/> 2809:       {applications, [kernel, app10, hopefully_not_an_existing_app]},
<a name="2810"/> 2810:       {mod, {ch_sup, {app_chain_error2, 21,21}}}]}.
<a name="2811"/> 2811: 
<a name="app_group_leader-0"/><a name="2812"/> 2812: <b>app_group_leader</b>() -&gt;
<a name="app_group_leader-last_expr"/><a name="2813"/> 2813:     {application, group_leader,
<a name="2814"/> 2814:      [{description, &quot;GROUP_LEADER  CXC 138 11&quot;},
<a name="2815"/> 2815:       {vsn, &quot;1.0&quot;},
<a name="2816"/> 2816:       {modules, [group_leader,group_leader_sup]},
<a name="2817"/> 2817:       {registered, [group_leader_sup]},
<a name="2818"/> 2818:       {applications, [kernel,stdlib]},
<a name="2819"/> 2819:       {mod, {group_leader_sup, []}}]}.
<a name="2820"/> 2820: 
<a name="2821"/> 2821: 
<a name="d1-1"/><a name="2822"/> 2822: <b>d1</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="2823"/> 2823:     M = from($@, atom_to_list(node())),
<a name="d1-last_expr"/><a name="2824"/> 2824: <b>    {app1, [list_to_atom</b>(Ncp1 ++ &quot;@&quot; ++ M),
<a name="2825"/> 2825: 	    list_to_atom(Ncp2 ++ &quot;@&quot; ++ M),
<a name="2826"/> 2826: 	    list_to_atom(Ncp3 ++ &quot;@&quot; ++ M)]}.
<a name="2827"/> 2827: 
<a name="d2-1"/><a name="2828"/> 2828: <b>d2</b>([Ncp1, _Ncp2, Ncp3]) -&gt;
<a name="2829"/> 2829:     M = from($@, atom_to_list(node())),
<a name="d2-last_expr"/><a name="2830"/> 2830: <b>    {app1, [list_to_atom</b>(Ncp1 ++ &quot;@&quot; ++ M),
<a name="2831"/> 2831: 	    list_to_atom(Ncp3 ++ &quot;@&quot; ++ M)]}.
<a name="2832"/> 2832: 
<a name="d3-1"/><a name="2833"/> 2833: <b>d3</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="2834"/> 2834:     M = from($@, atom_to_list(node())),
<a name="d3-last_expr"/><a name="2835"/> 2835: <b>    {appinc, [list_to_atom</b>(Ncp1 ++ &quot;@&quot; ++ M),
<a name="2836"/> 2836:               list_to_atom(Ncp2 ++ &quot;@&quot; ++ M),
<a name="2837"/> 2837:               list_to_atom(Ncp3 ++ &quot;@&quot; ++ M)]}.
<a name="2838"/> 2838: 
<a name="d_any3-2"/><a name="2839"/> 2839: <b>d_any3</b>(Any, [Ncp1, Ncp2, Ncp3]) -&gt;
<a name="2840"/> 2840:     M = from($@, atom_to_list(node())),
<a name="d_any3-last_expr"/><a name="2841"/> 2841: <b>    {Any, [list_to_atom</b>(Ncp1 ++ &quot;@&quot; ++ M),
<a name="2842"/> 2842:            list_to_atom(Ncp2 ++ &quot;@&quot; ++ M),
<a name="2843"/> 2843:            list_to_atom(Ncp3 ++ &quot;@&quot; ++ M)]}.
<a name="2844"/> 2844: 
<a name="2845"/> 2845: 
<a name="config-1"/><a name="2846"/> 2846: <b>config</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config-last_expr"/><a name="2847"/> 2847: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2848"/> 2848:             M = from($@, atom_to_list(node())),
<a name="2849"/> 2849:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2850"/> 2850:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="2851"/> 2851:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2852"/> 2852:                       &quot;{distributed, [{app1, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2853"/> 2853:                       &quot;{app2, 1000, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2854"/> 2854:                       &quot;{app3, 1000, [{'~s@~s', '~s@~s'}, '~s@~s']}]}]}].~n&quot;,
<a name="2855"/> 2855:                       [Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2856"/> 2856:                        SyncNodesTimeout,  Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2857"/> 2857:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2858"/> 2858:                        Ncp1, M, Ncp2, M, Ncp3, M])
<a name="2859"/> 2859:     end.
<a name="2860"/> 2860: 
<a name="config2-1"/><a name="2861"/> 2861: <b>config2</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config2-last_expr"/><a name="2862"/> 2862: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2863"/> 2863:             M = from($@, atom_to_list(node())),
<a name="2864"/> 2864:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2865"/> 2865:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="2866"/> 2866:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2867"/> 2867:                       &quot;{permissions, [{app3, false}]},&quot;
<a name="2868"/> 2868:                       &quot;{distributed, [{app1, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2869"/> 2869:                       &quot;{app2, 10000, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2870"/> 2870:                       &quot;{app3, 5000, [{'~s@~s', '~s@~s'}, '~s@~s']}]}]}].~n&quot;,
<a name="2871"/> 2871:                       [Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2872"/> 2872:                        SyncNodesTimeout,  
<a name="2873"/> 2873:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2874"/> 2874:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2875"/> 2875:                        Ncp1, M, Ncp2, M, Ncp3, M])
<a name="2876"/> 2876:     end.
<a name="2877"/> 2877: 
<a name="config3-1"/><a name="2878"/> 2878: <b>config3</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config3-last_expr"/><a name="2879"/> 2879: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2880"/> 2880:             M = from($@, atom_to_list(node())),
<a name="2881"/> 2881:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2882"/> 2882:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="2883"/> 2883:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2884"/> 2884:                       &quot;{start_dist_ac, true},&quot;
<a name="2885"/> 2885:                       &quot;{permissions, [{app3, false}]}]}].~n&quot;,
<a name="2886"/> 2886:                       [Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2887"/> 2887:                        SyncNodesTimeout])
<a name="2888"/> 2888:     end.
<a name="2889"/> 2889: 
<a name="config4-1"/><a name="2890"/> 2890: <b>config4</b>([Ncp1, Ncp2]) -&gt;
<a name="config4-last_expr"/><a name="2891"/> 2891: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2892"/> 2892:             M = from($@, atom_to_list(node())),
<a name="2893"/> 2893:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2894"/> 2894:                       &quot;['~s@~s','~s@~s']},&quot;
<a name="2895"/> 2895:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2896"/> 2896:                       &quot;{start_dist_ac, true},&quot;
<a name="2897"/> 2897:                       &quot;{distributed, [{app1, ['~s@~s', '~s@~s']}]}]}].~n&quot;,
<a name="2898"/> 2898:                       [Ncp1, M, Ncp2, M,  SyncNodesTimeout,  
<a name="2899"/> 2899:                        Ncp1, M, Ncp2, M])
<a name="2900"/> 2900:     end.
<a name="2901"/> 2901: 
<a name="config3184-1"/><a name="2902"/> 2902: <b>config3184</b>([Ncp1, Ncp2]) -&gt;
<a name="config3184-last_expr"/><a name="2903"/> 2903: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2904"/> 2904:             M = from($@, atom_to_list(node())),
<a name="2905"/> 2905:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2906"/> 2906:                       &quot;['~s@~s','~s@~s']},&quot;
<a name="2907"/> 2907:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2908"/> 2908:                       &quot;{permissions, [{app1, false}]},&quot;
<a name="2909"/> 2909:                       &quot;{distributed, [{app1, ['~s@~s', '~s@~s']}]}]}].~n&quot;,
<a name="2910"/> 2910:                       [Ncp1, M, Ncp2, M,  SyncNodesTimeout,  
<a name="2911"/> 2911:                        Ncp1, M, Ncp2, M])
<a name="2912"/> 2912:     end.
<a name="2913"/> 2913: 
<a name="config_perm-1"/><a name="2914"/> 2914: <b>config_perm</b>(Fd) -&gt;
<a name="config_perm-last_expr"/><a name="2915"/> 2915: <b>    io:format</b>(Fd, &quot;[{kernel, [{permissions, &quot;
<a name="2916"/> 2916: 	      &quot;[{app1, false}, {app2, false}, {app3, false}]} ]}].~n&quot;,[]).
<a name="2917"/> 2917: 
<a name="config_perm2-1"/><a name="2918"/> 2918: <b>config_perm2</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config_perm2-last_expr"/><a name="2919"/> 2919: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2920"/> 2920:             M = from($@, atom_to_list(node())),
<a name="2921"/> 2921:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2922"/> 2922:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="2923"/> 2923:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2924"/> 2924:                       &quot;{permissions, [{app1, false}, {app2, false}, {app3, false}]},&quot;
<a name="2925"/> 2925:                       &quot;{distributed, [{app1, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2926"/> 2926:                       &quot;{app2, 10000, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2927"/> 2927:                       &quot;{app3, 5000, [{'~s@~s', '~s@~s'}, '~s@~s']}]}]}].~n&quot;,
<a name="2928"/> 2928:                       [Ncp1, M, Ncp2, M, Ncp3, M,
<a name="2929"/> 2929:                        SyncNodesTimeout,
<a name="2930"/> 2930:                        Ncp1, M, Ncp2, M, Ncp3, M,
<a name="2931"/> 2931:                        Ncp1, M, Ncp2, M, Ncp3, M,
<a name="2932"/> 2932:                        Ncp1, M, Ncp2, M, Ncp3, M])
<a name="2933"/> 2933:     end.
<a name="2934"/> 2934: 
<a name="config_inc-1"/><a name="2935"/> 2935: <b>config_inc</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config_inc-last_expr"/><a name="2936"/> 2936: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2937"/> 2937:             M = from($@, atom_to_list(node())),
<a name="2938"/> 2938:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2939"/> 2939:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="2940"/> 2940:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2941"/> 2941:                       &quot;{distributed, [{appinc, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2942"/> 2942:                       &quot;{app2, 10000, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2943"/> 2943:                       &quot;{app3, 5000, [{'~s@~s', '~s@~s'}, '~s@~s']}]}]}].~n&quot;,
<a name="2944"/> 2944:                       [Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2945"/> 2945:                        SyncNodesTimeout,  
<a name="2946"/> 2946:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2947"/> 2947:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2948"/> 2948:                        Ncp1, M, Ncp2, M, Ncp3, M])
<a name="2949"/> 2949:     end.
<a name="2950"/> 2950: 
<a name="config_sf-1"/><a name="2951"/> 2951: <b>config_sf</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config_sf-last_expr"/><a name="2952"/> 2952: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2953"/> 2953:             M = from($@, atom_to_list(node())),
<a name="2954"/> 2954:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2955"/> 2955:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="2956"/> 2956:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2957"/> 2957:                       &quot;{distributed, [{myApp, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2958"/> 2958:                       &quot;{topApp, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2959"/> 2959:                       &quot;{inclOne, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2960"/> 2960:                       &quot;{inclTwo, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2961"/> 2961:                       &quot;{inclTwoTop, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2962"/> 2962:                       &quot;{incl2A, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2963"/> 2963:                       &quot;{incl2B, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2964"/> 2964:                       &quot;{with, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2965"/> 2965:                       &quot;{wrapper, ['~s@~s', '~s@~s', '~s@~s']}]}]}].~n&quot;,
<a name="2966"/> 2966:                       [Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2967"/> 2967:                        SyncNodesTimeout,   
<a name="2968"/> 2968:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2969"/> 2969:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2970"/> 2970:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2971"/> 2971:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2972"/> 2972:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2973"/> 2973:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2974"/> 2974:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2975"/> 2975:                        Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="2976"/> 2976:                        Ncp1, M, Ncp2, M, Ncp3, M])
<a name="2977"/> 2977:     end.
<a name="2978"/> 2978: 
<a name="config_fo-1"/><a name="2979"/> 2979: <b>config_fo</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config_fo-last_expr"/><a name="2980"/> 2980: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2981"/> 2981:             M = from($@, atom_to_list(node())),
<a name="2982"/> 2982:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2983"/> 2983:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="2984"/> 2984:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="2985"/> 2985:                       &quot;{distributed, [{app1, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2986"/> 2986:                       &quot;{app2, 2000, ['~s@~s', '~s@~s', '~s@~s']},&quot;
<a name="2987"/> 2987:                       &quot;{app_sp, 1000, [{'~s@~s', '~s@~s'}, '~s@~s']}]}]}].~n&quot;,
<a name="2988"/> 2988:                       [Ncp1, M, Ncp2, M, Ncp3, M,
<a name="2989"/> 2989:                        SyncNodesTimeout,
<a name="2990"/> 2990:                        Ncp1, M, Ncp2, M, Ncp3, M,
<a name="2991"/> 2991:                        Ncp1, M, Ncp2, M, Ncp3, M,
<a name="2992"/> 2992:                        Ncp1, M, Ncp2, M, Ncp3, M])
<a name="2993"/> 2993:     end.
<a name="2994"/> 2994: 
<a name="config_dc-1"/><a name="2995"/> 2995: <b>config_dc</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config_dc-last_expr"/><a name="2996"/> 2996: <b>    fun</b>(Fd, SyncNodesTimeout) -&gt;
<a name="2997"/> 2997:             M = from($@, atom_to_list(node())),
<a name="2998"/> 2998:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="2999"/> 2999:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="3000"/> 3000:                       &quot;{sync_nodes_timeout, ~w},&quot;
<a name="3001"/> 3001:                       &quot;{distributed, [{app1, ['~s@~s', '~s@~s']},&quot;
<a name="3002"/> 3002:                       &quot;               {app2, 10000, ['~s@~s']},&quot;
<a name="3003"/> 3003:                       &quot;               {app3, [{'~s@~s', '~s@~s'}]}, &quot;
<a name="3004"/> 3004:                       &quot;               {app6, [{'~s@~s', '~s@~s'}]}, &quot;
<a name="3005"/> 3005:                       &quot;               {app7, ['~s@~s']}, &quot;
<a name="3006"/> 3006:                       &quot;               {app8, ['~s@~s', {'~s@~s', '~s@~s'}]}&quot;
<a name="3007"/> 3007:                       &quot;              ]}]}].~n&quot;,
<a name="3008"/> 3008:                       [Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="3009"/> 3009:                        SyncNodesTimeout,  
<a name="3010"/> 3010:                        Ncp1, M, Ncp2, M,  
<a name="3011"/> 3011:                        Ncp1, M,  
<a name="3012"/> 3012:                        Ncp1, M, Ncp2, M,  
<a name="3013"/> 3013:                        Ncp3, M, Ncp2, M,  
<a name="3014"/> 3014:                        Ncp3, M,  
<a name="3015"/> 3015:                        Ncp2, M, Ncp1, M, Ncp3, M])
<a name="3016"/> 3016:     end.
<a name="3017"/> 3017: 
<a name="config_dc2-1"/><a name="3018"/> 3018: <b>config_dc2</b>([Ncp1, Ncp2, Ncp3]) -&gt;
<a name="config_dc2-last_expr"/><a name="3019"/> 3019: <b>    fun</b>(Fd) -&gt;
<a name="3020"/> 3020:             M = from($@, atom_to_list(node())),
<a name="3021"/> 3021:             io:format(Fd, &quot;[{kernel, [{sync_nodes_optional, &quot;
<a name="3022"/> 3022:                       &quot;['~s@~s','~s@~s','~s@~s']},&quot;
<a name="3023"/> 3023:                       &quot;{sync_nodes_timeout, 10000},&quot;
<a name="3024"/> 3024:                       &quot;{distributed, [{app1, ['~s@~s']},&quot;
<a name="3025"/> 3025:                       &quot;               {app2, 5000, ['~s@~s']},&quot;
<a name="3026"/> 3026:                       &quot;               {app3, ['~s@~s', {'~s@~s', '~s@~s'}]}, &quot;
<a name="3027"/> 3027:                       &quot;               {app6, ['~s@~s', {'~s@~s', '~s@~s'}]}, &quot;
<a name="3028"/> 3028:                       &quot;               {app7, 1000, ['~s@~s']}, &quot;
<a name="3029"/> 3029:                       &quot;               {app8, ['~s@~s', {'~s@~s', '~s@~s'}]}&quot;
<a name="3030"/> 3030:                       &quot;              ]}]}].~n&quot;,
<a name="3031"/> 3031:                       [Ncp1, M, Ncp2, M, Ncp3, M,  
<a name="3032"/> 3032:                        Ncp3, M, 
<a name="3033"/> 3033:                        Ncp2, M, 
<a name="3034"/> 3034:                        Ncp3, M, Ncp1, M, Ncp2, M, 
<a name="3035"/> 3035:                        Ncp1, M, Ncp3, M, Ncp2, M, 
<a name="3036"/> 3036:                        Ncp3, M,  
<a name="3037"/> 3037:                        Ncp1, M, Ncp2, M, Ncp3, M])
<a name="3038"/> 3038:     end.
<a name="3039"/> 3039: 
<a name="w_app1-1"/><a name="3040"/> 3040: <b>w_app1</b>(Fd) -&gt;
<a name="w_app1-last_expr"/><a name="3041"/> 3041: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app1()]).
<a name="3042"/> 3042: 
<a name="w_app2-1"/><a name="3043"/> 3043: <b>w_app2</b>(Fd) -&gt;
<a name="w_app2-last_expr"/><a name="3044"/> 3044: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app2()]).
<a name="3045"/> 3045: 
<a name="w_app3-1"/><a name="3046"/> 3046: <b>w_app3</b>(Fd) -&gt;
<a name="w_app3-last_expr"/><a name="3047"/> 3047: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app3()]).
<a name="3048"/> 3048: 
<a name="w_app5-1"/><a name="3049"/> 3049: <b>w_app5</b>(Fd) -&gt;
<a name="w_app5-last_expr"/><a name="3050"/> 3050: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app5()]).
<a name="3051"/> 3051: 
<a name="w_app6-1"/><a name="3052"/> 3052: <b>w_app6</b>(Fd) -&gt;
<a name="w_app6-last_expr"/><a name="3053"/> 3053: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app6()]).
<a name="3054"/> 3054: 
<a name="w_app7-1"/><a name="3055"/> 3055: <b>w_app7</b>(Fd) -&gt;
<a name="w_app7-last_expr"/><a name="3056"/> 3056: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app7()]).
<a name="3057"/> 3057: 
<a name="w_app8-1"/><a name="3058"/> 3058: <b>w_app8</b>(Fd) -&gt;
<a name="w_app8-last_expr"/><a name="3059"/> 3059: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app8()]).
<a name="3060"/> 3060: 
<a name="w_app9-1"/><a name="3061"/> 3061: <b>w_app9</b>(Fd) -&gt;
<a name="w_app9-last_expr"/><a name="3062"/> 3062: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app9()]).
<a name="3063"/> 3063: 
<a name="w_app10-3"/><a name="3064"/> 3064: <b>w_app10</b>(Fd, Deps, Optional) -&gt;
<a name="w_app10-last_expr"/><a name="3065"/> 3065: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app10(Deps, Optional)]).
<a name="3066"/> 3066: 
<a name="w_app_start_error-1"/><a name="3067"/> 3067: <b>w_app_start_error</b>(Fd) -&gt;
<a name="w_app_start_error-last_expr"/><a name="3068"/> 3068: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [app_start_error()]).
<a name="3069"/> 3069: 
<a name="w_app-2"/><a name="3070"/> 3070: <b>w_app</b>(Fd, AppData) -&gt;
<a name="w_app-last_expr"/><a name="3071"/> 3071: <b>    io:format</b>(Fd, &quot;~p.\n&quot;, [AppData]).
<a name="3072"/> 3072: 
<a name="from-2"/><a name="3073"/> 3073: <b>from</b>(H, [H | T]) -&gt; T;
<a name="3074"/> 3074: <b>from</b>(H, [_ | T]) -&gt; from(H, T);
<a name="from-last_expr"/><a name="3075"/> 3075: <b>from</b>(_H, []) -&gt; [].
<a name="3076"/> 3076: 
<a name="is_loaded-2"/><a name="3077"/> 3077: <b>is_loaded</b>(Name, [Node | Nodes]) -&gt;
<a name="3078"/> 3078:     Apps = rpc:call(Node, application, loaded_applications, []),
<a name="3079"/> 3079:     case lists:keysearch(Name, 1, Apps) of
<a name="3080"/> 3080: 	{value, _} -&gt; is_loaded(Name, Nodes);
<a name="3081"/> 3081: 	false -&gt; false
<a name="3082"/> 3082:     end;
<a name="3083"/> 3083: <b>is_loaded</b>(_Name, []) -&gt;
<a name="3084"/> 3084:     true;
<a name="3085"/> 3085: <b>is_loaded</b>(Name, Node) -&gt;
<a name="is_loaded-last_expr"/><a name="3086"/> 3086: <b>    is_loaded</b>(Name, [Node]).
<a name="3087"/> 3087: 
<a name="is_started-2"/><a name="3088"/> 3088: <b>is_started</b>(Name, Node) -&gt;
<a name="3089"/> 3089:     Apps = which_applications(Node),
<a name="is_started-last_expr"/><a name="3090"/> 3090: <b>    case lists:keysearch</b>(Name, 1, Apps) of
<a name="3091"/> 3091: 	{value, _} -&gt; true;
<a name="3092"/> 3092: 	false -&gt; false
<a name="3093"/> 3093:     end.
<a name="3094"/> 3094: 
<a name="3095"/> 3095: <i>%% Waits until application Name is started on at least one node.</i>
<a name="wait_until_started-2"/><a name="3096"/> 3096: <b>wait_until_started</b>(Name, Nodes) -&gt;
<a name="wait_until_started-last_expr"/><a name="3097"/> 3097: <b>    case lists:member</b>(true,
<a name="3098"/> 3098: 		      lists:map(fun (N) -&gt;
<a name="3099"/> 3099: 					is_started(Name, N)
<a name="3100"/> 3100: 				end,
<a name="3101"/> 3101: 				Nodes)) of
<a name="3102"/> 3102: 	true -&gt;
<a name="3103"/> 3103: 	    true;
<a name="3104"/> 3104: 	false -&gt;
<a name="3105"/> 3105: 	    ct:sleep(500),
<a name="3106"/> 3106: 	    wait_until_started(Name, Nodes)
<a name="3107"/> 3107:     end.
<a name="3108"/> 3108: 
<a name="3109"/> 3109: <i>%% Waits until application Name is stopped on all nodes.</i>
<a name="wait_until_stopped-2"/><a name="3110"/> 3110: <b>wait_until_stopped</b>(Name, Nodes) -&gt;
<a name="wait_until_stopped-last_expr"/><a name="3111"/> 3111: <b>    case lists:member</b>(true,
<a name="3112"/> 3112: 		      lists:map(fun (N) -&gt;
<a name="3113"/> 3113: 					is_started(Name, N)
<a name="3114"/> 3114: 				end,
<a name="3115"/> 3115: 				Nodes)) of
<a name="3116"/> 3116: 	false -&gt;
<a name="3117"/> 3117: 	    true;
<a name="3118"/> 3118: 	true -&gt;
<a name="3119"/> 3119: 	    ct:sleep(500),
<a name="3120"/> 3120: 	    wait_until_stopped(Name, Nodes)
<a name="3121"/> 3121:     end.
<a name="3122"/> 3122: 
<a name="3123"/> 3123: <i>%% The test server has no support for starting nodes in parallel. To</i>
<a name="3124"/> 3124: <i>%% avoid long delays a small sync_nodes_timeout is used. Use this</i>
<a name="3125"/> 3125: <i>%% function when starting all nodes but the last one, and when</i>
<a name="3126"/> 3126: <i>%% restarting nodes (then use global:sync() to synchronize).</i>
<a name="config_fun_fast-1"/><a name="3127"/> 3127: <b>config_fun_fast</b>(SysConfigFun) -&gt;
<a name="config_fun_fast-last_expr"/><a name="3128"/> 3128: <b>    fun</b>(Fd) -&gt; SysConfigFun(Fd, 1) end.
<a name="3129"/> 3129: 
<a name="config_fun-1"/><a name="3130"/> 3130: <b>config_fun</b>(SysConfigFun) -&gt;
<a name="config_fun-last_expr"/><a name="3131"/> 3131: <b>    fun</b>(Fd) -&gt; SysConfigFun(Fd, 10000) end.
<a name="3132"/> 3132: 
<a name="start_node_config-3"/><a name="3133"/> 3133: <b>start_node_config</b>(Name, SysConfigFun, Conf) -&gt;
<a name="3134"/> 3134:     ConfigFile = write_config_file(SysConfigFun, Conf),
<a name="start_node_config-last_expr"/><a name="3135"/> 3135: <b>    start_node</b>(Name, ConfigFile, &quot;&quot;).
<a name="3136"/> 3136: 
<a name="start_node-1"/><a name="3137"/> 3137: <b>start_node</b>(Name) -&gt;
<a name="3138"/> 3138:     Pa = filename:dirname(code:which(?MODULE)),
<a name="start_node-last_expr"/><a name="3139"/> 3139: <b>    test_server:start_node</b>(Name, slave, [{args, &quot; -pa &quot; ++ Pa}]).
<a name="3140"/> 3140: 
<a name="start_node-2"/><a name="3141"/> 3141: <b>start_node</b>(Name, ConfigFile) -&gt;
<a name="start_node-last_expr"/><a name="3142"/> 3142: <b>    start_node</b>(Name, ConfigFile, &quot;&quot;).
<a name="3143"/> 3143: 
<a name="start_node-3"/><a name="3144"/> 3144: <b>start_node</b>(Name, ConfigFile, ExtraArgs) -&gt;
<a name="3145"/> 3145:     Pa = filename:dirname(code:which(?MODULE)),
<a name="start_node-last_expr"/><a name="3146"/> 3146: <b>    test_server:start_node</b>(Name, slave, [{args, 
<a name="3147"/> 3147:                                           &quot; -pa &quot; ++ Pa ++ 
<a name="3148"/> 3148:                                           &quot; -config &quot; ++ ConfigFile ++ 
<a name="3149"/> 3149:                                           ExtraArgs}]).
<a name="3150"/> 3150: 
<a name="start_node_with_cache-3"/><a name="3151"/> 3151: <b>start_node_with_cache</b>(Name, SysConfigFun, Conf) -&gt;
<a name="3152"/> 3152:     ConfigFile = write_config_file(SysConfigFun, Conf),
<a name="start_node_with_cache-last_expr"/><a name="3153"/> 3153: <b>    start_node</b>(Name, ConfigFile, &quot; -code_path_cache&quot;).
<a name="3154"/> 3154: 
<a name="start_node_args-2"/><a name="3155"/> 3155: <b>start_node_args</b>(Name, Args) -&gt;
<a name="3156"/> 3156:     Pa = filename:dirname(code:which(?MODULE)),
<a name="start_node_args-last_expr"/><a name="3157"/> 3157: <b>    test_server:start_node</b>(Name, slave, [{args, &quot; -pa &quot; ++ Pa ++ &quot; &quot; ++ Args}]).
<a name="3158"/> 3158: 
<a name="start_node_boot_3002-2"/><a name="3159"/> 3159: <b>start_node_boot_3002</b>(Name, Boot) -&gt;
<a name="3160"/> 3160:     Pa = filename:dirname(code:which(?MODULE)),
<a name="3161"/> 3161:     ct:pal(?HI_VERBOSITY, &quot;start_node_boot ~p~n&quot;,
<a name="3162"/> 3162: 	   [&quot; -pa &quot; ++ Pa ++ &quot; -env ERL_CRASH_DUMP erl_crash_dump.&quot; ++
<a name="3163"/> 3163: 		atom_to_list(Name) ++ &quot; -boot &quot; ++ Boot ++
<a name="3164"/> 3164: 		&quot; -sasl dummy \&quot;missing &quot;]),
<a name="start_node_boot_3002-last_expr"/><a name="3165"/> 3165: <b>    test_server:start_node</b>(Name, slave, 
<a name="3166"/> 3166:                            [{args, &quot; -pa &quot; ++ Pa ++
<a name="3167"/> 3167:                              &quot; -env ERL_CRASH_DUMP erl_crash_dump.&quot; ++
<a name="3168"/> 3168:                              atom_to_list(Name) ++ &quot; -boot &quot; ++ Boot ++ 
<a name="3169"/> 3169:                              &quot; -sasl dummy \&quot;missing &quot;}]).
<a name="3170"/> 3170: 
<a name="start_node_boot_config-4"/><a name="3171"/> 3171: <b>start_node_boot_config</b>(Name, SysConfigFun, Conf, Boot) -&gt;
<a name="3172"/> 3172:     ConfigFile = write_config_file(SysConfigFun, Conf),
<a name="start_node_boot_config-last_expr"/><a name="3173"/> 3173: <b>    start_node</b>(Name, ConfigFile, &quot; -boot &quot; ++ atom_to_list(Boot)).
<a name="3174"/> 3174: 
<a name="start_node_boot-3"/><a name="3175"/> 3175: <b>start_node_boot</b>(Name, Config, Boot) -&gt;
<a name="3176"/> 3176:     Pa = filename:dirname(code:which(?MODULE)),
<a name="3177"/> 3177:     ct:pal(?HI_VERBOSITY,
<a name="3178"/> 3178: 	   &quot;start_node_boot ~p~n&quot;,[&quot; -pa &quot; ++ Pa ++ &quot; -config &quot; ++ Config ++
<a name="3179"/> 3179: 				       &quot; -boot &quot; ++ atom_to_list(Boot)]),
<a name="start_node_boot-last_expr"/><a name="3180"/> 3180: <b>    test_server:start_node</b>(Name, slave,
<a name="3181"/> 3181: 			   [{args, &quot; -pa &quot; ++ Pa ++ &quot; -config &quot; ++ Config ++
<a name="3182"/> 3182: 				 &quot; -boot &quot; ++ atom_to_list(Boot)}]).
<a name="3183"/> 3183: 
<a name="start_node_config_sf-3"/><a name="3184"/> 3184: <b>start_node_config_sf</b>(Name, SysConfigFun, Conf) -&gt;
<a name="3185"/> 3185:     ConfigFile = write_config_file(SysConfigFun, Conf),
<a name="3186"/> 3186:     DataDir = proplists:get_value(data_dir, Conf), % is it used?
<a name="start_node_config_sf-last_expr"/><a name="3187"/> 3187: <b>    start_node</b>(Name, ConfigFile, &quot; -pa &quot; ++ DataDir).
<a name="3188"/> 3188: 
<a name="write_config_file-2"/><a name="3189"/> 3189: <b>write_config_file</b>(SysConfigFun, Conf) -&gt;
<a name="3190"/> 3190:     Dir = proplists:get_value(priv_dir, Conf),
<a name="3191"/> 3191:     {ok, Fd} = file:open(filename:join(Dir, &quot;sys.config&quot;), [write]),
<a name="3192"/> 3192:     SysConfigFun(Fd),
<a name="3193"/> 3193:     file:close(Fd),
<a name="write_config_file-last_expr"/><a name="3194"/> 3194: <b>    filename:join</b>(Dir,&quot;sys&quot;).
<a name="3195"/> 3195: 
<a name="node_names-2"/><a name="3196"/> 3196: <b>node_names</b>(Names, Config) -&gt;
<a name="node_names-last_expr"/><a name="3197"/> 3197: <b>    [node_name</b>(Name, Config) || Name &lt;- Names].
<a name="3198"/> 3198: 
<a name="node_name-2"/><a name="3199"/> 3199: <b>node_name</b>(Name, Config) -&gt;
<a name="3200"/> 3200:     U = &quot;_&quot;,
<a name="3201"/> 3201:     L = integer_to_list(erlang:unique_integer([positive])),
<a name="node_name-last_expr"/><a name="3202"/> 3202: <b>    lists:concat</b>([Name,U,?testcase,U,U,L]).
<a name="3203"/> 3203: 
<a name="stop_node_nice-1"/><a name="3204"/> 3204: <b>stop_node_nice</b>(Node) when is_atom(Node) -&gt;
<a name="3205"/> 3205:     test_server:stop_node(Node);
<a name="3206"/> 3206: <b>stop_node_nice</b>(Nodes) when is_list(Nodes) -&gt;
<a name="stop_node_nice-last_expr"/><a name="3207"/> 3207: <b>    lists:foreach</b>(fun (N) -&gt; stop_node_nice(N) end, Nodes).
<a name="3208"/> 3208: 
<a name="3209"/> 3209: 
<a name="get_start_type-1"/><a name="3210"/> 3210: <b>get_start_type</b>(Expected) -&gt;
<a name="get_start_type-last_expr"/><a name="3211"/> 3211: <b>    get_start_type</b>(Expected, 30*5, #st{}).
<a name="3212"/> 3212: 
<a name="get_start_type-3"/><a name="3213"/> 3213: <b>get_start_type</b>(_Expected, 0, Ack) -&gt;
<a name="3214"/> 3214:     io:format(&quot;====== ~p ======~n&quot;, [Ack]),
<a name="3215"/> 3215:     ct:fail(not_valid_start_type);
<a name="3216"/> 3216: <b>get_start_type</b>(Expected, Times, Ack0) -&gt;
<a name="3217"/> 3217:     #st{normal = N0, local = L0, takeover = T0, failover = F0} = Ack0,
<a name="3218"/> 3218:     global:send(st_type, {st, read, self()}),
<a name="get_start_type-last_expr"/><a name="3219"/> 3219:     receive
<a name="3220"/> 3220:         {st, N, L, T, F} -&gt;
<a name="3221"/> 3221:             Ack = #st{normal = N0 + N, local = L0 + L, 
<a name="3222"/> 3222:                       takeover = T0 + T, failover = F0 + F},
<a name="3223"/> 3223:             if
<a name="3224"/> 3224:                 Ack =:= Expected -&gt;
<a name="3225"/> 3225:                     ok;
<a name="3226"/> 3226:                 true -&gt; 
<a name="3227"/> 3227:                     timer:sleep(200),
<a name="3228"/> 3228:                     get_start_type(Expected, Times-1, Ack)
<a name="3229"/> 3229:             end
<a name="3230"/> 3230:     after 30*1000 -&gt;
<a name="3231"/> 3231:             get_start_type(Expected, 0, Ack0)
<a name="3232"/> 3232:     end.
<a name="3233"/> 3233: 
<a name="start_type-0"/><a name="3234"/> 3234: <b>start_type</b>() -&gt;
<a name="start_type-last_expr"/><a name="3235"/> 3235: <b>    st</b>(0, 0, 0, 0).
<a name="3236"/> 3236: 
<a name="st-4"/><a name="3237"/> 3237: <b>st</b>(Normal, Local, Takeover, Failover) -&gt;
<a name="st-last_expr"/><a name="3238"/> 3238:     receive
<a name="3239"/> 3239: 	{st, normal} -&gt;
<a name="3240"/> 3240: 	    st(Normal+1, Local, Takeover, Failover);
<a name="3241"/> 3241: 	{st, local} -&gt;
<a name="3242"/> 3242: 	    st(Normal, Local+1, Takeover, Failover);
<a name="3243"/> 3243: 	{st, takeover} -&gt;
<a name="3244"/> 3244: 	    st(Normal, Local, Takeover+1, Failover);
<a name="3245"/> 3245: 	{st, failover} -&gt;
<a name="3246"/> 3246: 	    st(Normal, Local, Takeover, Failover+1);
<a name="3247"/> 3247: 	{st, read, From} -&gt;
<a name="3248"/> 3248: 	    From ! {st, Normal, Local, Takeover, Failover},
<a name="3249"/> 3249: 	    st(0, 0, 0, 0);
<a name="3250"/> 3250: 	kill -&gt;
<a name="3251"/> 3251: 	    exit(normal)
<a name="3252"/> 3252:     end.
<a name="3253"/> 3253: 
<a name="3254"/> 3254: 
<a name="get_start_phase-1"/><a name="3255"/> 3255: <b>get_start_phase</b>(Expected) -&gt;
<a name="3256"/> 3256:     global:send(start_phase, {sp, read, self()}),
<a name="get_start_phase-last_expr"/><a name="3257"/> 3257:     receive
<a name="3258"/> 3258: 	Expected -&gt;
<a name="3259"/> 3259: 	    ok;
<a name="3260"/> 3260: 	{sp, T1, I1, So1, Sp1, G1} -&gt;
<a name="3261"/> 3261:            io:format(&quot;=============== {sp,T,I,So,Sp,G} ~p ~n&quot;,[&quot; &quot;]),
<a name="3262"/> 3262:            io:format(&quot;=========== got ~p ~n&quot;,
<a name="3263"/> 3263:                               [{sp, T1, I1, So1, Sp1, G1}]),
<a name="3264"/> 3264:            io:format(&quot;====== expected ~p ~n&quot;, [Expected]),
<a name="3265"/> 3265:            ct:fail(not_valid_start_phase)
<a name="3266"/> 3266:     after 5000 -&gt;
<a name="3267"/> 3267:            ct:fail(not_valid_start_phase)
<a name="3268"/> 3268:     end.
<a name="3269"/> 3269: 
<a name="start_phase-0"/><a name="3270"/> 3270: <b>start_phase</b>() -&gt;
<a name="start_phase-last_expr"/><a name="3271"/> 3271: <b>    sp</b>(0, 0, 0, 0, 0).
<a name="3272"/> 3272: 
<a name="sp-5"/><a name="3273"/> 3273: <b>sp</b>(Top, Init, Some, Spec, Go) -&gt;
<a name="sp-last_expr"/><a name="3274"/> 3274:     receive
<a name="3275"/> 3275: 	{sp, top} -&gt;
<a name="3276"/> 3276: 	    sp(Top+1, Init, Some, Spec, Go);
<a name="3277"/> 3277: 	{sp, init} -&gt;
<a name="3278"/> 3278: 	    sp(Top, Init+1, Some, Spec, Go);
<a name="3279"/> 3279: 	{sp, some} -&gt;
<a name="3280"/> 3280: 	    sp(Top, Init, Some+1, Spec, Go);
<a name="3281"/> 3281: 	{sp, spec} -&gt;
<a name="3282"/> 3282: 	    sp(Top, Init, Some, Spec+1, Go);
<a name="3283"/> 3283: 	{sp, go} -&gt;
<a name="3284"/> 3284: 	    sp(Top, Init, Some, Spec, Go+1);
<a name="3285"/> 3285: 	{sp, read, From} -&gt;
<a name="3286"/> 3286: 	    From ! {sp, Top, Init, Some, Spec, Go},
<a name="3287"/> 3287: 	    sp(0, 0, 0, 0, 0);
<a name="3288"/> 3288: 	kill -&gt;
<a name="3289"/> 3289: 	    exit(normal)
<a name="3290"/> 3290:     end.
<a name="3291"/> 3291: 
<a name="get_conf_change-1"/><a name="3292"/> 3292: <b>get_conf_change</b>(Expected) -&gt;
<a name="3293"/> 3293:     global:send(conf_change, {cc, read, self()}),
<a name="get_conf_change-last_expr"/><a name="3294"/> 3294:     receive
<a name="3295"/> 3295: 	{cc, Expected} -&gt;
<a name="3296"/> 3296: 	    ok;
<a name="3297"/> 3297: 	{cc, List} -&gt;
<a name="3298"/> 3298: 	    io:format(&quot;====== ~p ======~n&quot;,[{cc, List}]),
<a name="3299"/> 3299: 	    ct:fail(not_valid_conf_change)
<a name="3300"/> 3300:     after 5000 -&gt;
<a name="3301"/> 3301: 	    ct:fail(not_valid_conf_change_to)
<a name="3302"/> 3302:     end.
<a name="3303"/> 3303: 
<a name="conf_change-0"/><a name="3304"/> 3304: <b>conf_change</b>() -&gt;
<a name="conf_change-last_expr"/><a name="3305"/> 3305: <b>    cc</b>([]).
<a name="3306"/> 3306: 
<a name="cc-1"/><a name="3307"/> 3307: <b>cc</b>(List) -&gt;
<a name="cc-last_expr"/><a name="3308"/> 3308:     receive
<a name="3309"/> 3309: 	{cc, New} -&gt;
<a name="3310"/> 3310: 	    cc(List ++ New);
<a name="3311"/> 3311: 	{cc, read, From} -&gt;
<a name="3312"/> 3312: 	    From ! {cc, List},
<a name="3313"/> 3313: 	    cc([]);
<a name="3314"/> 3314: 	kill -&gt;
<a name="3315"/> 3315: 	    exit(normal)
<a name="3316"/> 3316:     end.
<a name="3317"/> 3317: 
<a name="3318"/> 3318: 
<a name="3319"/> 3319: 
<a name="create_app-0"/><a name="3320"/> 3320: <b>create_app</b>() -&gt;
<a name="3321"/> 3321:     Dir = &quot;./&quot;,
<a name="3322"/> 3322:     App1 = Dir ++ &quot;app1&quot;,
<a name="3323"/> 3323:     {ok, Fd1} = file:open(App1++&quot;.app&quot;,[write]),
<a name="3324"/> 3324:     io:format(Fd1, &quot;~p. \n&quot;, [app1()]),
<a name="3325"/> 3325:     file:close(Fd1),
<a name="3326"/> 3326:     App2 = Dir ++ &quot;app2&quot;,
<a name="3327"/> 3327:     {ok, Fd2} = file:open(App2++&quot;.app&quot;,[write]),
<a name="3328"/> 3328:     io:format(Fd2, &quot;~p. \n&quot;, [app2()]),
<a name="3329"/> 3329:     file:close(Fd2),
<a name="3330"/> 3330:     App3 = Dir ++ &quot;app_sp&quot;,
<a name="3331"/> 3331:     {ok, Fd3} = file:open(App3++&quot;.app&quot;,[write]),
<a name="3332"/> 3332:     io:format(Fd3, &quot;~p. \n&quot;, [app_sp()]),
<a name="3333"/> 3333:     file:close(Fd3),
<a name="create_app-last_expr"/><a name="3334"/> 3334:     ok.
<a name="3335"/> 3335: 
<a name="3336"/> 3336: 
<a name="create_script-1"/><a name="3337"/> 3337: <b>create_script</b>(ScriptName) -&gt;
<a name="3338"/> 3338:     Dir = &quot;./&quot;,
<a name="3339"/> 3339:     Name = Dir ++ ScriptName,
<a name="3340"/> 3340:     Apps = which_applications(),
<a name="3341"/> 3341:     {value,{_,_,KernelVer}} = lists:keysearch(kernel,1,Apps),
<a name="3342"/> 3342:     {value,{_,_,StdlibVer}} = lists:keysearch(stdlib,1,Apps),
<a name="3343"/> 3343:     {ok,Fd} = file:open(Name++&quot;.rel&quot;,[write]),
<a name="3344"/> 3344:     io:format(Fd,
<a name="3345"/> 3345: 		    &quot;{release, {\&quot;Test release 3\&quot;, \&quot;LATEST\&quot;}, \n&quot;
<a name="3346"/> 3346: 		    &quot; {erts, \&quot;4.4\&quot;}, \n&quot;
<a name="3347"/> 3347: 		    &quot; [{kernel, \&quot;~s\&quot;}, {stdlib, \&quot;~s\&quot;}, \n&quot;
<a name="3348"/> 3348: 		    &quot;  {app1, \&quot;2.0\&quot;}, {app2, \&quot;2.0\&quot;}, {app_sp, \&quot;2.0\&quot;}]}.\n&quot;,
<a name="3349"/> 3349: 		    [KernelVer,StdlibVer]),
<a name="3350"/> 3350:     file:close(Fd),
<a name="create_script-last_expr"/><a name="3351"/> 3351:     {{KernelVer,StdlibVer},
<a name="3352"/> 3352:      {filename:dirname(Name), filename:basename(Name)}}.
<a name="3353"/> 3353: 
<a name="3354"/> 3354: 
<a name="3355"/> 3355: 
<a name="create_script_dc-1"/><a name="3356"/> 3356: <b>create_script_dc</b>(ScriptName) -&gt;
<a name="3357"/> 3357:     Dir = &quot;./&quot;,
<a name="3358"/> 3358:     Name = Dir ++ ScriptName,
<a name="3359"/> 3359:     Apps = which_applications(),
<a name="3360"/> 3360:     {value,{_,_,KernelVer}} = lists:keysearch(kernel,1,Apps),
<a name="3361"/> 3361:     {value,{_,_,StdlibVer}} = lists:keysearch(stdlib,1,Apps),
<a name="3362"/> 3362:     {ok,Fd} = file:open(Name++&quot;.rel&quot;,[write]),
<a name="3363"/> 3363:     io:format(Fd,
<a name="3364"/> 3364: 		    &quot;{release, {\&quot;Test release 3\&quot;, \&quot;LATEST\&quot;}, \n&quot;
<a name="3365"/> 3365: 		    &quot; {erts, \&quot;4.4\&quot;}, \n&quot;
<a name="3366"/> 3366: 		    &quot; [{kernel, \&quot;~s\&quot;}, {stdlib, \&quot;~s\&quot;}, \n&quot;
<a name="3367"/> 3367: 		    &quot;  {app1, \&quot;2.0\&quot;}, {app2, \&quot;2.0\&quot;}, {app3, \&quot;2.0\&quot;}, \n&quot;
<a name="3368"/> 3368: 		    &quot;  {app6, \&quot;2.0\&quot;}, {app7, \&quot;2.0\&quot;}, {app8, \&quot;2.0\&quot;}]}.\n&quot;,
<a name="3369"/> 3369: 		    [KernelVer,StdlibVer]),
<a name="3370"/> 3370:     file:close(Fd),
<a name="create_script_dc-last_expr"/><a name="3371"/> 3371:     {{KernelVer,StdlibVer},
<a name="3372"/> 3372:      {filename:dirname(Name), filename:basename(Name)}}.
<a name="3373"/> 3373: 
<a name="3374"/> 3374: 
<a name="create_script_3002-1"/><a name="3375"/> 3375: <b>create_script_3002</b>(ScriptName) -&gt;
<a name="3376"/> 3376:     Dir = &quot;./&quot;,
<a name="3377"/> 3377:     Name = Dir ++ ScriptName,
<a name="3378"/> 3378:     Apps = which_applications(),
<a name="3379"/> 3379:     {value,{_,_,KernelVer}} = lists:keysearch(kernel,1,Apps),
<a name="3380"/> 3380:     {value,{_,_,StdlibVer}} = lists:keysearch(stdlib,1,Apps),
<a name="3381"/> 3381:     {value,{_,_,SaslVer}} = lists:keysearch(sasl,1,Apps),
<a name="3382"/> 3382:     {ok,Fd} = file:open(Name++&quot;.rel&quot;,[write]),
<a name="3383"/> 3383:     io:format(Fd,
<a name="3384"/> 3384: 		    &quot;{release, {\&quot;Test release 3\&quot;, \&quot;LATEST\&quot;}, \n&quot;
<a name="3385"/> 3385: 		    &quot; {erts, \&quot;4.4\&quot;}, \n&quot;
<a name="3386"/> 3386: 		    &quot; [{kernel, \&quot;~s\&quot;}, {stdlib, \&quot;~s\&quot;}, \n&quot;
<a name="3387"/> 3387: 		    &quot;  {sasl, \&quot;~s\&quot;}]}.\n&quot;,
<a name="3388"/> 3388: 		    [KernelVer, StdlibVer, SaslVer]),
<a name="3389"/> 3389:     file:close(Fd),
<a name="create_script_3002-last_expr"/><a name="3390"/> 3390:     {{KernelVer,StdlibVer},
<a name="3391"/> 3391:      {filename:dirname(Name), filename:basename(Name)}}.
<a name="3392"/> 3392: 
<a name="3393"/> 3393: 
<a name="3394"/> 3394: 
<a name="distr_changed_prep-1"/><a name="3395"/> 3395: <b>distr_changed_prep</b>(Conf) when is_list(Conf) -&gt;
<a name="3396"/> 3396: 
<a name="3397"/> 3397:     %% Write .app files
<a name="3398"/> 3398:     {ok, Fd1} = file:open(&quot;app1.app&quot;, [write]),
<a name="3399"/> 3399:     w_app1(Fd1),
<a name="3400"/> 3400:     file:close(Fd1),
<a name="3401"/> 3401:     {ok, Fd2} = file:open(&quot;app2.app&quot;, [write]),
<a name="3402"/> 3402:     w_app2(Fd2),
<a name="3403"/> 3403:     file:close(Fd2),
<a name="3404"/> 3404:     {ok, Fd3} = file:open(&quot;app3.app&quot;, [write]),
<a name="3405"/> 3405:     w_app3(Fd3),
<a name="3406"/> 3406:     file:close(Fd3),
<a name="3407"/> 3407:     {ok, Fd4} = file:open(&quot;app6.app&quot;, [write]),
<a name="3408"/> 3408:     w_app6(Fd4),
<a name="3409"/> 3409:     file:close(Fd4),
<a name="3410"/> 3410:     {ok, Fd5} = file:open(&quot;app7.app&quot;, [write]),
<a name="3411"/> 3411:     w_app7(Fd5),
<a name="3412"/> 3412:     file:close(Fd5),
<a name="3413"/> 3413:     {ok, Fd6} = file:open(&quot;app8.app&quot;, [write]),
<a name="3414"/> 3414:     w_app8(Fd6),
<a name="3415"/> 3415:     file:close(Fd6),
<a name="3416"/> 3416: 
<a name="3417"/> 3417: 
<a name="3418"/> 3418:     %% Create the .app files and the boot script
<a name="3419"/> 3419:     {{KernelVer,StdlibVer}, _} = create_script_dc(&quot;dc&quot;),
<a name="3420"/> 3420: 
<a name="3421"/> 3421:     case is_real_system(KernelVer, StdlibVer) of
<a name="3422"/> 3422: 	      true -&gt;
<a name="3423"/> 3423: 		  Options = [];
<a name="3424"/> 3424: 	      false  -&gt;
<a name="3425"/> 3425: 		  Options = [local]
<a name="3426"/> 3426: 	  end,
<a name="3427"/> 3427: 
<a name="3428"/> 3428:     ok = systools:make_script(&quot;dc&quot;, Options),
<a name="3429"/> 3429:     
<a name="3430"/> 3430:     NodeNames = [Ncp1, Ncp2, Ncp3] = node_names([cp1, cp2, cp3], Conf),
<a name="3431"/> 3431:     NoSyncTime = config_fun_fast(config_dc(NodeNames)),
<a name="3432"/> 3432:     WithSyncTime = config_fun(config_dc(NodeNames)),
<a name="3433"/> 3433: 
<a name="3434"/> 3434:     Dir = proplists:get_value(priv_dir,Conf),
<a name="3435"/> 3435:     {ok, Fd_dc2} = file:open(filename:join(Dir, &quot;sys2.config&quot;), [write]),
<a name="3436"/> 3436:     (config_dc2(NodeNames))(Fd_dc2),
<a name="3437"/> 3437:     file:close(Fd_dc2),
<a name="3438"/> 3438:     Config2 = filename:join(Dir, &quot;sys2&quot;),
<a name="3439"/> 3439:     
<a name="3440"/> 3440:     %% Test [cp1, cp2, cp3]
<a name="3441"/> 3441:     {ok, Cp1} = start_node_boot_config(Ncp1, NoSyncTime, Conf, dc),
<a name="3442"/> 3442:     {ok, Cp2} = start_node_boot_config(Ncp2, NoSyncTime, Conf, dc),
<a name="3443"/> 3443:     {ok, Cp3} = start_node_boot_config(Ncp3, WithSyncTime, Conf, dc),
<a name="3444"/> 3444:     global:sync(),
<a name="3445"/> 3445: 
<a name="3446"/> 3446:     %% Read the current configuration parameters, and change them
<a name="3447"/> 3447:     OldEnv = rpc:call(Cp1, application_controller, prep_config_change, []),
<a name="3448"/> 3448:     {value, {kernel, OldKernel}} = lists:keysearch(kernel, 1, OldEnv),
<a name="distr_changed_prep-last_expr"/><a name="3449"/> 3449:     {OldKernel, OldEnv, {Cp1, Cp2, Cp3}, {Ncp1, Ncp2, Ncp3}, Config2}.
<a name="3450"/> 3450: 
<a name="3451"/> 3451: <i>%% Test report callback for Logger handler error_logger</i>
<a name="format_log_1-1"/><a name="3452"/> 3452: <b>format_log_1</b>(_Config) -&gt;
<a name="3453"/> 3453:     FD = application:get_env(kernel, error_logger_format_depth),
<a name="3454"/> 3454:     application:unset_env(kernel, error_logger_format_depth),
<a name="3455"/> 3455:     Term = lists:seq(1, 15),
<a name="3456"/> 3456:     Application = my_application,
<a name="3457"/> 3457:     Error = exit,
<a name="3458"/> 3458:     Node = Term,
<a name="3459"/> 3459:     Report = #{label=&gt;{application_controller,Error},
<a name="3460"/> 3460:                report=&gt;[{application,Application},
<a name="3461"/> 3461:                         {exited,Term},
<a name="3462"/> 3462:                         {type,Term}]},
<a name="3463"/> 3463:     {F1, A1} = application_controller:format_log(Report),
<a name="3464"/> 3464:     FExpected1 = &quot;    application: ~tp~n&quot;
<a name="3465"/> 3465:         &quot;    exited: ~tp~n&quot;
<a name="3466"/> 3466:         &quot;    type: ~tp~n&quot;,
<a name="3467"/> 3467:     ct:log(&quot;F1: ~ts~nA1: ~tp&quot;, [F1,A1]),
<a name="3468"/> 3468:     FExpected1 = F1,
<a name="3469"/> 3469:     [Application,Term,Term] = A1,
<a name="3470"/> 3470: 
<a name="3471"/> 3471:     Progress = #{label=&gt;{application_controller,progress},
<a name="3472"/> 3472:                  report=&gt;[{application,Application},{started_at,Node}]},
<a name="3473"/> 3473:     {PF1,PA1} = application_controller:format_log(Progress),
<a name="3474"/> 3474:     PFExpected1 = &quot;    application: ~tp~n    started_at: ~tp~n&quot;,
<a name="3475"/> 3475:     ct:log(&quot;PF1: ~ts~nPA1: ~tp&quot;, [PF1,PA1]),
<a name="3476"/> 3476:     PFExpected1 = PF1,
<a name="3477"/> 3477:     [Application,Node] = PA1,
<a name="3478"/> 3478: 
<a name="3479"/> 3479:     Depth = 10,
<a name="3480"/> 3480:     ok = application:set_env(kernel, error_logger_format_depth, Depth),
<a name="3481"/> 3481:     Limited = [1,2,3,4,5,6,7,8,9,'...'],
<a name="3482"/> 3482:     {F2,A2} = application_controller:format_log(Report),
<a name="3483"/> 3483:     FExpected2 = &quot;    application: ~tP~n&quot;
<a name="3484"/> 3484:         &quot;    exited: ~tP~n&quot;
<a name="3485"/> 3485:         &quot;    type: ~tP~n&quot;,
<a name="3486"/> 3486:     ct:log(&quot;F2: ~ts~nA2: ~tp&quot;, [F2,A2]),
<a name="3487"/> 3487:     FExpected2 = F2,
<a name="3488"/> 3488:     Limited = [1,2,3,4,5,6,7,8,9,'...'],
<a name="3489"/> 3489:     [Application,Depth,Limited,Depth,Limited,Depth] = A2,
<a name="3490"/> 3490: 
<a name="3491"/> 3491:     {PF2,PA2} = application_controller:format_log(Progress),
<a name="3492"/> 3492:     PFExpected2 = &quot;    application: ~tP~n    started_at: ~tP~n&quot;,
<a name="3493"/> 3493:     ct:log(&quot;PF2: ~ts~nPA2: ~tp&quot;, [PF2,PA2]),
<a name="3494"/> 3494:     PFExpected2 = PF2,
<a name="3495"/> 3495:     [Application,Depth,Limited,Depth] = PA2,
<a name="3496"/> 3496: 
<a name="3497"/> 3497:     case FD of
<a name="3498"/> 3498:         undefined -&gt;
<a name="3499"/> 3499:             application:unset_env(kernel, error_logger_format_depth);
<a name="3500"/> 3500:         _ -&gt;
<a name="3501"/> 3501:             application:set_env(kernel, error_logger_format_depth, FD)
<a name="3502"/> 3502:     end,
<a name="format_log_1-last_expr"/><a name="3503"/> 3503:     ok.
<a name="3504"/> 3504: 
<a name="3505"/> 3505: <i>%% Test report callback for any Logger handler</i>
<a name="format_log_2-1"/><a name="3506"/> 3506: <b>format_log_2</b>(_Config) -&gt;
<a name="3507"/> 3507:     Term = lists:seq(1, 15),
<a name="3508"/> 3508:     Application = my_application,
<a name="3509"/> 3509:     Error = exit,
<a name="3510"/> 3510:     Node = Term,
<a name="3511"/> 3511:     Report = #{label=&gt;{application_controller,Error},
<a name="3512"/> 3512:                report=&gt;[{application,Application},
<a name="3513"/> 3513:                         {exited,Term},
<a name="3514"/> 3514:                         {type,Term}]},
<a name="3515"/> 3515:     FormatOpts1 = #{},
<a name="3516"/> 3516:     Str1 = flatten_format_log(Report, FormatOpts1),
<a name="3517"/> 3517:     L1 = length(Str1),
<a name="3518"/> 3518:     Expected1 = &quot;    application: my_application\n&quot;
<a name="3519"/> 3519:         &quot;    exited: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]\n&quot;
<a name="3520"/> 3520:         &quot;    type: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]\n&quot;,
<a name="3521"/> 3521:     ct:log(&quot;Str1: ~ts&quot;, [Str1]),
<a name="3522"/> 3522:     ct:log(&quot;length(Str1): ~p&quot;, [L1]),
<a name="3523"/> 3523:     true = Expected1 =:= Str1,
<a name="3524"/> 3524: 
<a name="3525"/> 3525:     Progress = #{label=&gt;{application_controller,progress},
<a name="3526"/> 3526:                  report=&gt;[{application,Application},{started_at,Node}]},
<a name="3527"/> 3527:     PStr1 = flatten_format_log(Progress, FormatOpts1),
<a name="3528"/> 3528:     PL1 = length(PStr1),
<a name="3529"/> 3529:     PExpected1 = &quot;    application: my_application\n&quot;
<a name="3530"/> 3530:         &quot;    started_at: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]\n&quot;,
<a name="3531"/> 3531:     ct:log(&quot;PStr1: ~ts&quot;, [PStr1]),
<a name="3532"/> 3532:     ct:log(&quot;length(PStr1): ~p&quot;, [PL1]),
<a name="3533"/> 3533:     true = PExpected1 =:= PStr1,
<a name="3534"/> 3534: 
<a name="3535"/> 3535:     Depth = 10,
<a name="3536"/> 3536:     FormatOpts2 = #{depth=&gt;Depth},
<a name="3537"/> 3537:     Str2 = flatten_format_log(Report, FormatOpts2),
<a name="3538"/> 3538:     L2 = length(Str2),
<a name="3539"/> 3539:     Expected2 = &quot;    application: my_application\n&quot;
<a name="3540"/> 3540:         &quot;    exited: [1,2,3,4,5,6,7,8,9|...]\n&quot;
<a name="3541"/> 3541:         &quot;    type: [1,2,3,4,5,6,7,8,9|...]\n&quot;,
<a name="3542"/> 3542:     ct:log(&quot;Str2: ~ts&quot;, [Str2]),
<a name="3543"/> 3543:     ct:log(&quot;length(Str2): ~p&quot;, [L2]),
<a name="3544"/> 3544:     true = Expected2 =:= Str2,
<a name="3545"/> 3545: 
<a name="3546"/> 3546:     PStr2 = flatten_format_log(Progress, FormatOpts2),
<a name="3547"/> 3547:     PL2 = length(PStr2),
<a name="3548"/> 3548:     PExpected2 = &quot;    application: my_application\n&quot;
<a name="3549"/> 3549:         &quot;    started_at: [1,2,3,4,5,6,7,8,9|...]\n&quot;,
<a name="3550"/> 3550:     ct:log(&quot;PStr2: ~ts&quot;, [PStr2]),
<a name="3551"/> 3551:     ct:log(&quot;length(PStr2): ~p&quot;, [PL2]),
<a name="3552"/> 3552:     true = PExpected2 =:= PStr2,
<a name="3553"/> 3553: 
<a name="3554"/> 3554:     FormatOpts3 = #{chars_limit=&gt;200},
<a name="3555"/> 3555:     Str3 = flatten_format_log(Report, FormatOpts3),
<a name="3556"/> 3556:     L3 = length(Str3),
<a name="3557"/> 3557:     Expected3 = &quot;    application: my_application\n&quot;
<a name="3558"/> 3558:         &quot;    exited: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]\n&quot;
<a name="3559"/> 3559:         &quot;    type: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]\n&quot;,
<a name="3560"/> 3560:     ct:log(&quot;Str3: ~ts&quot;, [Str3]),
<a name="3561"/> 3561:     ct:log(&quot;length(Str3): ~p&quot;, [L3]),
<a name="3562"/> 3562:     true = Expected3 =:= Str3,
<a name="3563"/> 3563: 
<a name="3564"/> 3564:     PFormatOpts3 = #{chars_limit=&gt;80},
<a name="3565"/> 3565:     PStr3 = flatten_format_log(Progress, PFormatOpts3),
<a name="3566"/> 3566:     PL3 = length(PStr3),
<a name="3567"/> 3567:     PExpected3 = &quot;    application: my_application\n&quot;
<a name="3568"/> 3568:         &quot;    started_at:&quot;,
<a name="3569"/> 3569:     ct:log(&quot;PStr3: ~ts&quot;, [PStr3]),
<a name="3570"/> 3570:     ct:log(&quot;length(PStr3): ~p&quot;, [PL3]),
<a name="3571"/> 3571:     true = lists:prefix(PExpected3, PStr3),
<a name="3572"/> 3572:     true = PL3 &lt; PL1,
<a name="3573"/> 3573: 
<a name="3574"/> 3574:     FormatOpts4 = #{single_line=&gt;true},
<a name="3575"/> 3575:     Str4 = flatten_format_log(Report, FormatOpts4),
<a name="3576"/> 3576:     L4 = length(Str4),
<a name="3577"/> 3577: 
<a name="3578"/> 3578:     Expected4 = &quot;Application: my_application. &quot;
<a name="3579"/> 3579:         &quot;Exited: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]. &quot;
<a name="3580"/> 3580:         &quot;Type: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].&quot;,
<a name="3581"/> 3581:     ct:log(&quot;Str4: ~ts&quot;, [Str4]),
<a name="3582"/> 3582:     ct:log(&quot;length(Str4): ~p&quot;, [L4]),
<a name="3583"/> 3583:     true = Expected4 =:= Str4,
<a name="3584"/> 3584: 
<a name="3585"/> 3585:     PStr4 = flatten_format_log(Progress, FormatOpts4),
<a name="3586"/> 3586:     PL4 = length(PStr4),
<a name="3587"/> 3587:     PExpected4 = &quot;Application: my_application. &quot;
<a name="3588"/> 3588:         &quot;Started at: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].&quot;,
<a name="3589"/> 3589:     ct:log(&quot;PStr4: ~ts&quot;, [PStr4]),
<a name="3590"/> 3590:     ct:log(&quot;length(PStr4): ~p&quot;, [PL4]),
<a name="3591"/> 3591:     true = PExpected4 =:= PStr4,
<a name="3592"/> 3592: 
<a name="3593"/> 3593:     FormatOpts5 = #{single_line=&gt;true, depth=&gt;Depth},
<a name="3594"/> 3594:     Str5 = flatten_format_log(Report, FormatOpts5),
<a name="3595"/> 3595:     L5 = length(Str5),
<a name="3596"/> 3596:     Expected5 = &quot;Application: my_application. &quot;
<a name="3597"/> 3597:         &quot;Exited: [1,2,3,4,5,6,7,8,9|...]. &quot;
<a name="3598"/> 3598:         &quot;Type: [1,2,3,4,5,6,7,8,9|...].&quot;,
<a name="3599"/> 3599:     ct:log(&quot;Str5: ~ts&quot;, [Str5]),
<a name="3600"/> 3600:     ct:log(&quot;length(Str5): ~p&quot;, [L5]),
<a name="3601"/> 3601:     true = Expected5 =:= Str5,
<a name="3602"/> 3602: 
<a name="3603"/> 3603:     PStr5 = flatten_format_log(Progress, FormatOpts5),
<a name="3604"/> 3604:     PL5 = length(PStr5),
<a name="3605"/> 3605:     PExpected5 = &quot;Application: my_application. &quot;
<a name="3606"/> 3606:         &quot;Started at: [1,2,3,4,5,6,7,8,9|...].&quot;,
<a name="3607"/> 3607:     ct:log(&quot;PStr5: ~ts&quot;, [PStr5]),
<a name="3608"/> 3608:     ct:log(&quot;length(PStr5): ~p&quot;, [PL5]),
<a name="3609"/> 3609:     true = PExpected5 =:= PStr5,
<a name="3610"/> 3610: 
<a name="3611"/> 3611:     FormatOpts6 = #{single_line=&gt;true, chars_limit=&gt;100},
<a name="3612"/> 3612:     Str6 = flatten_format_log(Report, FormatOpts6),
<a name="3613"/> 3613:     L6 = length(Str6),
<a name="3614"/> 3614:     Expected6 = &quot;Application: my_application. Exited:&quot;,
<a name="3615"/> 3615:     ct:log(&quot;Str6: ~ts&quot;, [Str6]),
<a name="3616"/> 3616:     ct:log(&quot;length(Str6): ~p&quot;, [L6]),
<a name="3617"/> 3617:     true = lists:prefix(Expected6, Str6),
<a name="3618"/> 3618:     true = L6 &lt; L4,
<a name="3619"/> 3619: 
<a name="3620"/> 3620:     PFormatOpts6 = #{single_line=&gt;true, chars_limit=&gt;60},
<a name="3621"/> 3621:     PStr6 = flatten_format_log(Progress, PFormatOpts6),
<a name="3622"/> 3622:     PL6 = length(PStr6),
<a name="3623"/> 3623:     PExpected6 = &quot;Application: my_application. Started at:&quot;,
<a name="3624"/> 3624:     ct:log(&quot;PStr6: ~ts&quot;, [PStr6]),
<a name="3625"/> 3625:     ct:log(&quot;length(PStr6): ~p&quot;, [PL6]),
<a name="3626"/> 3626:     true = lists:prefix(PExpected6, PStr6),
<a name="3627"/> 3627:     true = PL6 &lt; PL4,
<a name="3628"/> 3628: 
<a name="format_log_2-last_expr"/><a name="3629"/> 3629:     ok.
<a name="3630"/> 3630: 
<a name="flatten_format_log-2"/><a name="3631"/> 3631: <b>flatten_format_log</b>(Report, Format) -&gt;
<a name="flatten_format_log-last_expr"/><a name="3632"/> 3632: <b>    lists:flatten</b>(application_controller:format_log(Report, Format)).
<a name="3633"/> 3633: 
<a name="3634"/> 3634: <i>%%% Copied from init_SUITE.erl.</i>
<a name="is_real_system-2"/><a name="3635"/> 3635: <b>is_real_system</b>(KernelVsn, StdlibVsn) -&gt;
<a name="3636"/> 3636:     LibDir = code:lib_dir(),
<a name="is_real_system-last_expr"/><a name="3637"/> 3637: <b>    case file:read_file_info</b>(LibDir ++ &quot;/kernel-&quot; ++ KernelVsn) of
<a name="3638"/> 3638: 	{ok, _} -&gt;
<a name="3639"/> 3639: 	    case file:read_file_info(LibDir ++ &quot;/stdlib-&quot; ++ StdlibVsn) of
<a name="3640"/> 3640: 		{ok, _} -&gt;
<a name="3641"/> 3641: 		    true;
<a name="3642"/> 3642: 		_ -&gt;
<a name="3643"/> 3643: 		    false
<a name="3644"/> 3644: 	    end;
<a name="3645"/> 3645: 	_ -&gt;
<a name="3646"/> 3646: 	    false
<a name="3647"/> 3647:     end.
<a name="3648"/> 3648:     
<a name="init2973-0"/><a name="3649"/> 3649: <b>init2973</b>() -&gt; 
<a name="init2973-last_expr"/><a name="3650"/> 3650: <b>    loop2973</b>().
<a name="3651"/> 3651: 
<a name="3652"/> 3652: 
<a name="loop2973-0"/><a name="3653"/> 3653: <b>loop2973</b>() -&gt; 
<a name="loop2973-last_expr"/><a name="3654"/> 3654:     receive
<a name="3655"/> 3655: 	{start, From, App} -&gt;
<a name="3656"/> 3656: 	    Res = application:start(App),
<a name="3657"/> 3657: 	    From ! {self(), res, Res},
<a name="3658"/> 3658: 	    loop2973();
<a name="3659"/> 3659: 
<a name="3660"/> 3660: 	kill -&gt;
<a name="3661"/> 3661: 	    exit(normal)
<a name="3662"/> 3662:     end.
<a name="3663"/> 3663: 
<a name="wait_for_ready_net-0"/><a name="3664"/> 3664: <b>wait_for_ready_net</b>() -&gt;
<a name="3665"/> 3665:     Nodes = lists:sort([node() | nodes()]),
<a name="wait_for_ready_net-last_expr"/><a name="3666"/> 3666: <b>    ?UNTIL</b>(begin
<a name="3667"/> 3667:                lists:all(fun(N) -&gt; Nodes =:= get_known(N) end, Nodes) and
<a name="3668"/> 3668:                lists:all(fun(N) -&gt; 
<a name="3669"/> 3669:                                  LNs = rpc:call(N, erlang, nodes, []),
<a name="3670"/> 3670:                                  Nodes =:= lists:sort([N | LNs])
<a name="3671"/> 3671:                          end, Nodes)
<a name="3672"/> 3672:            end).
<a name="3673"/> 3673: 
<a name="get_known-1"/><a name="3674"/> 3674: <b>get_known</b>(Node) -&gt;
<a name="get_known-last_expr"/><a name="3675"/> 3675: <b>    case catch gen_server:call</b>({global_name_server,Node}, get_known) of
<a name="3676"/> 3676:         {'EXIT', _} -&gt;
<a name="3677"/> 3677:             [list, without, nodenames];
<a name="3678"/> 3678:         Known -&gt; 
<a name="3679"/> 3679:             lists:sort([Node | Known])
<a name="3680"/> 3680:     end.
<a name="3681"/> 3681: 
<a name="which_applications-0"/><a name="3682"/> 3682: <b>which_applications</b>() -&gt;
<a name="which_applications-last_expr"/><a name="3683"/> 3683: <b>    application_controller:which_applications</b>(infinity).
<a name="3684"/> 3684: 
<a name="which_applications-1"/><a name="3685"/> 3685: <b>which_applications</b>(Node) -&gt;
<a name="which_applications-last_expr"/><a name="3686"/> 3686: <b>    rpc:call</b>(Node, application, which_applications, [infinity]).
</pre>
</body>
</html>
