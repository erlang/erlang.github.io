<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/zstd_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2006-2025. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(zstd_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <b>-export</b>([all/0, suite/0, groups/0, init_per_suite/1, end_per_suite/1,
<a name="23"/>   23:          init_per_group/2, end_per_group/2]).
<a name="24"/>   24: 
<a name="25"/>   25: <b>-export</b>([bulk/1, bulk_with_dict/1,
<a name="26"/>   26:          pledge/1,
<a name="27"/>   27:          cstream/1, cstream_with_dict/1,
<a name="28"/>   28:          dstream/1, dstream_with_dict/1,
<a name="29"/>   29:          parameters/1, dict_api/1,
<a name="30"/>   30:          doc_tests/1
<a name="31"/>   31:         ]).
<a name="32"/>   32: 
<a name="33"/>   33: <b>-export</b>([generate_dict/0]).
<a name="34"/>   34: 
<a name="35"/>   35: <b>-include_lib</b>(&quot;stdlib/include/assert.hrl&quot;).
<a name="36"/>   36: 
<a name="suite-0"/><a name="suite-last_expr"/><a name="37"/>   37: <b>suite</b>() -&gt; [].
<a name="38"/>   38: 
<a name="all-0"/><a name="39"/>   39: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="40"/>   40:     [{group, zstd}].
<a name="41"/>   41: 
<a name="groups-0"/><a name="42"/>   42: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="43"/>   43:     [{zstd, [parallel],
<a name="44"/>   44:       [bulk,
<a name="45"/>   45:        cstream,
<a name="46"/>   46:        pledge,
<a name="47"/>   47:        dstream,
<a name="48"/>   48:        parameters,
<a name="49"/>   49:        {group, dict} ]},
<a name="50"/>   50:      {dict, [parallel],
<a name="51"/>   51:       [ bulk_with_dict,
<a name="52"/>   52:         cstream_with_dict,
<a name="53"/>   53:         dstream_with_dict,
<a name="54"/>   54:         dict_api,
<a name="55"/>   55:         doc_tests ]} ].
<a name="56"/>   56: 
<a name="init_per_suite-1"/><a name="57"/>   57: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="58"/>   58:     Config.
<a name="59"/>   59: 
<a name="generate_dict-0"/><a name="60"/>   60: <b>generate_dict</b>() -&gt;
<a name="61"/>   61:     DataDir = filename:join([os:getenv(&quot;ERL_TOP&quot;), &quot;lib&quot;, &quot;stdlib&quot;,
<a name="62"/>   62:                              &quot;test&quot;, &quot;zstd_SUITE_data&quot;]),
<a name="63"/>   63:     ok = filelib:ensure_path(DataDir),
<a name="64"/>   64:     TrainingSetDir = filename:join(DataDir,&quot;training&quot;),
<a name="65"/>   65:     Dict = filename:join(DataDir, &quot;dict&quot;),
<a name="66"/>   66:     ok = file:make_dir(TrainingSetDir),
<a name="67"/>   67:     generate_training_set(TrainingSetDir, 1_000),
<a name="68"/>   68:     io:format(&quot;~ts~n&quot;,[os:cmd(&quot;zstd --train &quot; ++
<a name="69"/>   69:                                   TrainingSetDir ++ &quot;/* -o &quot; ++ Dict)]),
<a name="70"/>   70:     file:del_dir_r(TrainingSetDir),
<a name="generate_dict-last_expr"/><a name="71"/>   71:     ok.
<a name="72"/>   72: 
<a name="generate_training_set-2"/><a name="73"/>   73: <b>generate_training_set</b>(_Dir, 0) -&gt; [];
<a name="74"/>   74: <b>generate_training_set</b>(Dir, N) -&gt;
<a name="75"/>   75:     ok = file:write_file(filename:join(Dir, integer_to_list(N)),
<a name="76"/>   76:                          lists:duplicate(rand:uniform(10000), integer_to_list(N))),
<a name="generate_training_set-last_expr"/><a name="77"/>   77: <b>    generate_training_set</b>(Dir, N - 1).
<a name="78"/>   78: 
<a name="init_per_group-2"/><a name="79"/>   79: <b>init_per_group</b>(dict, Config) -&gt;
<a name="80"/>   80:     Dict = filename:join(proplists:get_value(data_dir, Config),
<a name="81"/>   81:                          &quot;dict&quot;),
<a name="82"/>   82: 
<a name="83"/>   83:     [{dict, Dict} | Config];
<a name="84"/>   84: <b>init_per_group</b>(_, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="85"/>   85:     Config.
<a name="86"/>   86: 
<a name="end_per_group-2"/><a name="87"/>   87: <b>end_per_group</b>(_, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="88"/>   88:     Config.
<a name="89"/>   89: 
<a name="end_per_suite-1"/><a name="90"/>   90: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="91"/>   91:     ok.
<a name="92"/>   92: 
<a name="bulk-1"/><a name="93"/>   93: <b>bulk</b>(_Config) -&gt;
<a name="94"/>   94: 
<a name="95"/>   95:     Data = ~&quot;abc&quot;,
<a name="96"/>   96:     Compressed = zstd:compress(Data),
<a name="97"/>   97:     ?assertEqual(Data, iob(zstd:decompress(Compressed))),
<a name="98"/>   98: 
<a name="99"/>   99:     Compressed = zstd:compress(binary_to_list(Data)),
<a name="100"/>  100:     ?assertEqual(Data, iob(zstd:decompress(Compressed))),
<a name="101"/>  101: 
<a name="102"/>  102:     Compressed = zstd:compress([Data]),
<a name="103"/>  103:     ?assertEqual(Data, iob(zstd:decompress(Compressed))),
<a name="104"/>  104: 
<a name="105"/>  105:     %% Test decompressing of multiple frames
<a name="106"/>  106:     DoubleCompressed = [zstd:compress([Data]), zstd:compress([Data])],
<a name="107"/>  107:     ?assertEqual(&lt;&lt;Data/binary,Data/binary&gt;&gt;,
<a name="108"/>  108:                  iob(zstd:decompress(DoubleCompressed))),
<a name="109"/>  109: 
<a name="110"/>  110:     %% Test compression of a large amount of data
<a name="111"/>  111:     Iter = lists:seq(0,large_data_size()),
<a name="112"/>  112:     IOV = lists:duplicate(10, iob([rand:uniform(255) || _ &lt;- Iter])),
<a name="113"/>  113:     IOVCompressed = zstd:compress(IOV, #{ compressionLevel =&gt; -20 }),
<a name="114"/>  114:     ?assertEqual(iob(IOV), iob(zstd:decompress(IOVCompressed))),
<a name="115"/>  115: 
<a name="116"/>  116:     %% bulk with context
<a name="117"/>  117:     {ok, CCxt} = zstd:context(compress, #{ compressionLevel =&gt; 15 }),
<a name="118"/>  118:     CCtxCompressed = zstd:compress(Data, CCxt),
<a name="119"/>  119:     {ok, DCxt} = zstd:context(decompress),
<a name="120"/>  120:     ?assertEqual(iob(Data), iob(zstd:decompress(CCtxCompressed, DCxt))),
<a name="121"/>  121:     zstd:close(CCxt),
<a name="122"/>  122:     zstd:close(DCxt),
<a name="123"/>  123: 
<a name="124"/>  124:     P = self(),
<a name="125"/>  125:     spawn(fun() -&gt; {ok, Ctx} = zstd:context(compress), P ! {ctx, Ctx} end),
<a name="126"/>  126:     OtherCCtx = receive {ctx, Ctx} -&gt; Ctx end,
<a name="127"/>  127: 
<a name="128"/>  128:     {'EXIT',{not_on_controlling_process, _}} =
<a name="129"/>  129:         catch zstd:compress(Data, OtherCCtx),
<a name="130"/>  130:     {'EXIT',{not_on_controlling_process, _}} =
<a name="131"/>  131:         catch zstd:stream(OtherCCtx, Data),
<a name="132"/>  132:     {'EXIT',{not_on_controlling_process, _}} =
<a name="133"/>  133:         catch zstd:finish(OtherCCtx, Data),
<a name="134"/>  134:     {'EXIT',{not_on_controlling_process, _}} =
<a name="135"/>  135:         catch zstd:set_parameter(OtherCCtx, compressionLevel, 14),
<a name="136"/>  136:     {'EXIT',{not_on_controlling_process, _}} =
<a name="137"/>  137:         catch zstd:set_parameter(OtherCCtx, dictionary, ~&quot;abc&quot;),
<a name="138"/>  138:     {'EXIT',{not_on_controlling_process, _}} =
<a name="139"/>  139:         catch zstd:set_parameter(OtherCCtx, setPledgeSrcSize, 0),
<a name="140"/>  140:     {'EXIT',{not_on_controlling_process, _}} =
<a name="141"/>  141:         catch zstd:get_parameter(OtherCCtx, compressionLevel),
<a name="142"/>  142: 
<a name="bulk-last_expr"/><a name="143"/>  143:     ok.
<a name="144"/>  144: 
<a name="bulk_with_dict-1"/><a name="145"/>  145: <b>bulk_with_dict</b>(Config) -&gt;
<a name="146"/>  146: 
<a name="147"/>  147:     {ok, Dict} = file:read_file(proplists:get_value(dict, Config)),
<a name="148"/>  148:     Data = ~&quot;abc&quot;,
<a name="149"/>  149: 
<a name="150"/>  150:     Compressed = zstd:compress(Data, #{ dictionary =&gt; Dict }),
<a name="151"/>  151:     ?assertEqual(Data, iob(zstd:decompress(Compressed, #{ dictionary =&gt; Dict }))),
<a name="152"/>  152: 
<a name="153"/>  153:     {ok, CDict} = zstd:dict(compress, Dict),
<a name="154"/>  154:     {ok, DDict} = zstd:dict(decompress, Dict),
<a name="155"/>  155:     Compressed = zstd:compress(Data, #{ dictionary =&gt; CDict }),
<a name="156"/>  156:     ?assertEqual(Data, iob(zstd:decompress(Compressed, #{ dictionary =&gt; DDict }))),
<a name="157"/>  157: 
<a name="158"/>  158:     {'EXIT',{{zstd_error, ~&quot;Dictionary mismatch&quot;},_}} =
<a name="159"/>  159:         catch zstd:decompress(Compressed),
<a name="160"/>  160: 
<a name="161"/>  161:     P = self(),
<a name="162"/>  162:     spawn(fun() -&gt; {ok, Ctx} = zstd:context(compress), P ! {ctx, Ctx} end),
<a name="163"/>  163:     OtherCCtx = receive {ctx, Ctx} -&gt; Ctx end,
<a name="164"/>  164: 
<a name="165"/>  165:     {'EXIT',{not_on_controlling_process, _}} =
<a name="166"/>  166:         catch zstd:set_parameter(OtherCCtx, dictionary, CDict),
<a name="167"/>  167: 
<a name="bulk_with_dict-last_expr"/><a name="168"/>  168:     ok.
<a name="169"/>  169: 
<a name="cstream-1"/><a name="170"/>  170: <b>cstream</b>(_Config) -&gt;
<a name="171"/>  171: 
<a name="172"/>  172:     {ok, CCtx} = zstd:context(compress),
<a name="173"/>  173: 
<a name="174"/>  174:     Data = ~&quot;aaa&quot;,
<a name="175"/>  175: 
<a name="176"/>  176:     {done, C1} = zstd:finish(CCtx, Data),
<a name="177"/>  177:     ?assertEqual(Data, iob(zstd:decompress(C1))),
<a name="178"/>  178: 
<a name="179"/>  179:     {continue, C2_1} = zstd:stream(CCtx, ~&quot;a&quot;),
<a name="180"/>  180:     {continue, C2_2} = zstd:stream(CCtx, ~&quot;a&quot;),
<a name="181"/>  181:     {done, C2_3} = zstd:finish(CCtx, ~&quot;a&quot;),
<a name="182"/>  182:     ?assertEqual(Data, iob(zstd:decompress([C2_1, C2_2, C2_3]))),
<a name="183"/>  183: 
<a name="184"/>  184:     {continue, C3_1} = zstd:stream(CCtx, ~&quot;aaa&quot;),
<a name="185"/>  185:     ok = zstd:reset(CCtx),
<a name="186"/>  186:     {continue, C3_1} = zstd:stream(CCtx, [~&quot;aaa&quot;]),
<a name="187"/>  187:     {done, C3_2} = zstd:finish(CCtx, &lt;&lt;&gt;&gt;),
<a name="188"/>  188:     ?assertEqual(Data, iob(zstd:decompress([C3_1, C3_2]))),
<a name="189"/>  189: 
<a name="190"/>  190:     %% Test compression of a large amount of data
<a name="191"/>  191:     LargeData = iob([rand:uniform(255) || _ &lt;- lists:seq(0,large_data_size())]),
<a name="192"/>  192: 
<a name="193"/>  193:     %% On debug emulator we set some parameters to make the threshold for when
<a name="194"/>  194:     %% zstd fills it internal buffers lower so that we get {continue, Remain, Data}
<a name="195"/>  195:     [ begin
<a name="196"/>  196:           ok = zstd:set_parameter(CCtx, targetCBlockSize, 1340),
<a name="197"/>  197:           ok = zstd:set_parameter(CCtx, windowLog, 10),
<a name="198"/>  198:           ok = zstd:set_parameter(CCtx, chainLog, 6),
<a name="199"/>  199:           ok = zstd:set_parameter(CCtx, hashLog, 6)
<a name="200"/>  200:       end || erlang:system_info(emu_type) =:= debug],
<a name="201"/>  201:     {continue, Remain, C4_1} = zstd:stream(CCtx, LargeData),
<a name="202"/>  202:     {done, C4_2} = zstd:finish(CCtx, [Remain]),
<a name="203"/>  203:     ?assertEqual(iob([LargeData]), iob(zstd:decompress([C4_1,C4_2]))),
<a name="204"/>  204: 
<a name="205"/>  205:     {done, C5_1} = zstd:finish(CCtx, [LargeData, LargeData]),
<a name="206"/>  206:     ?assertEqual(iob([LargeData, LargeData]), iob(zstd:decompress([C5_1]))),
<a name="207"/>  207: 
<a name="208"/>  208:     ok = zstd:close(CCtx),
<a name="209"/>  209:     {'EXIT',{badarg,_}} = catch zstd:finish(CCtx, Data),
<a name="210"/>  210: 
<a name="cstream-last_expr"/><a name="211"/>  211:     ok.
<a name="212"/>  212: 
<a name="pledge-1"/><a name="213"/>  213: <b>pledge</b>(_Config) -&gt;
<a name="214"/>  214: 
<a name="215"/>  215:     AAAAs = iob(lists:duplicate(10_000, $a)),
<a name="216"/>  216:     BBBBs = iob(lists:duplicate(10_000, $b)),
<a name="217"/>  217: 
<a name="218"/>  218:     {ok, CCtx} = zstd:context(compress),
<a name="219"/>  219:     {continue, C1_1} = zstd:stream(CCtx, AAAAs),
<a name="220"/>  220:     {done, C1_2} = zstd:finish(CCtx, BBBBs),
<a name="221"/>  221: 
<a name="222"/>  222:     {ok, #{ frameContentSize := undefined } } = zstd:get_frame_header([C1_1, C1_2]),
<a name="223"/>  223:     ?assertEqual(&lt;&lt;AAAAs/binary,BBBBs/binary&gt;&gt;,
<a name="224"/>  224:                  iob(zstd:decompress([&lt;&lt;Byte&gt;&gt; || &lt;&lt;Byte&gt;&gt; &lt;= iob([C1_1,C1_2])]))),
<a name="225"/>  225:     ?assertEqual(&lt;&lt;AAAAs/binary,BBBBs/binary&gt;&gt;, iob(zstd:decompress(iob([C1_1,C1_2])))),
<a name="226"/>  226: 
<a name="227"/>  227:     ok = zstd:set_parameter(CCtx, pledgedSrcSize, 20_000 ),
<a name="228"/>  228:     {continue, C2_1} = zstd:stream(CCtx, AAAAs),
<a name="229"/>  229:     {done, C2_2} = zstd:finish(CCtx, BBBBs),
<a name="230"/>  230: 
<a name="231"/>  231:     {ok, #{ frameContentSize := 20_000 } } = zstd:get_frame_header([C2_1, C2_2]),
<a name="232"/>  232:     ?assertEqual(&lt;&lt;AAAAs/binary,BBBBs/binary&gt;&gt;,
<a name="233"/>  233:                  iob(zstd:decompress([&lt;&lt;Byte&gt;&gt; || &lt;&lt;Byte&gt;&gt; &lt;= iob([C2_1, C2_2])]))),
<a name="234"/>  234:     ?assertEqual(&lt;&lt;AAAAs/binary,BBBBs/binary&gt;&gt;, iob(zstd:decompress(iob([C2_1, C2_2])))),
<a name="235"/>  235: 
<a name="236"/>  236:     ok = zstd:set_parameter(CCtx, pledgedSrcSize, 20 ),
<a name="237"/>  237:     {'EXIT',{{zstd_error, ~&quot;Src size is incorrect&quot;},_}} = catch zstd:stream(CCtx, AAAAs),
<a name="238"/>  238: 
<a name="239"/>  239:     ok = zstd:set_parameter(CCtx, pledgedSrcSize, 20_001 ),
<a name="240"/>  240:     {continue, C2_1} = zstd:stream(CCtx, AAAAs),
<a name="241"/>  241:     {'EXIT',{{zstd_error, ~&quot;Src size is incorrect&quot;},_}} = catch zstd:finish(CCtx, BBBBs),
<a name="242"/>  242: 
<a name="pledge-last_expr"/><a name="243"/>  243:     ok.
<a name="244"/>  244: 
<a name="cstream_with_dict-1"/><a name="245"/>  245: <b>cstream_with_dict</b>(Config) -&gt;
<a name="246"/>  246: 
<a name="247"/>  247:     {ok, Dict} = file:read_file(proplists:get_value(dict, Config)),
<a name="248"/>  248:     DictID = zstd:get_dict_id(Dict),
<a name="249"/>  249:     {ok, CCtx} = zstd:context(compress),
<a name="250"/>  250: 
<a name="251"/>  251:     zstd:set_parameter(CCtx, dictionary, Dict),
<a name="252"/>  252: 
<a name="253"/>  253:     Data = ~&quot;aaa&quot;,
<a name="254"/>  254:     {done, C1} = zstd:finish(CCtx, Data),
<a name="255"/>  255:     ?assertEqual(Data, iob(zstd:decompress(C1, #{ dictionary =&gt; Dict }))),
<a name="256"/>  256:     DictID = zstd:get_dict_id(C1),
<a name="257"/>  257: 
<a name="258"/>  258:     {continue, C2_1} = zstd:stream(CCtx, ~&quot;a&quot;),
<a name="259"/>  259:     {continue, C2_2} = zstd:stream(CCtx, ~&quot;a&quot;),
<a name="260"/>  260:     {done, C2_3} = zstd:finish(CCtx, ~&quot;a&quot;),
<a name="261"/>  261:     ?assertEqual(Data, iob(zstd:decompress([C2_1, C2_2, C2_3], #{ dictionary =&gt; Dict }))),
<a name="262"/>  262: 
<a name="263"/>  263:     {continue, C3_1} = zstd:stream(CCtx, ~&quot;aaa&quot;),
<a name="264"/>  264:     ok = zstd:reset(CCtx),
<a name="265"/>  265:     {continue, C3_1} = zstd:stream(CCtx, ~&quot;aaa&quot;),
<a name="266"/>  266:     {done, C3_2} = zstd:finish(CCtx, &lt;&lt;&gt;&gt;),
<a name="267"/>  267:     ?assertEqual(Data, iob(zstd:decompress([C3_1, C3_2], #{ dictionary =&gt; Dict }))),
<a name="268"/>  268: 
<a name="269"/>  269:     zstd:set_parameter(CCtx, dictionary, &quot;&quot;),
<a name="270"/>  270: 
<a name="271"/>  271:     {done, C4} = zstd:finish(CCtx, Data),
<a name="272"/>  272:     ?assertEqual(Data, iob(zstd:decompress(C4))),
<a name="273"/>  273:     0 = zstd:get_dict_id(C4),
<a name="274"/>  274: 
<a name="275"/>  275:     {continue, C4_1} = zstd:stream(CCtx, ~&quot;a&quot;),
<a name="276"/>  276:     {continue, C4_2} = zstd:stream(CCtx, ~&quot;a&quot;),
<a name="277"/>  277:     {done, C4_3} = zstd:finish(CCtx, ~&quot;a&quot;),
<a name="278"/>  278:     ?assertEqual(Data, iob(zstd:decompress([C4_1, C4_2, C4_3]))),
<a name="279"/>  279: 
<a name="280"/>  280:     {continue, C5_1} = zstd:stream(CCtx, ~&quot;aaa&quot;),
<a name="281"/>  281:     ok = zstd:reset(CCtx),
<a name="282"/>  282:     {continue, C5_1} = zstd:stream(CCtx, ~&quot;aaa&quot;),
<a name="283"/>  283:     {done, C5_2} = zstd:finish(CCtx, &lt;&lt;&gt;&gt;),
<a name="284"/>  284:     ?assertEqual(Data, iob(zstd:decompress([C5_1, C5_2]))),
<a name="285"/>  285: 
<a name="286"/>  286:     {'EXIT',{{zstd_error, ~&quot;Dictionary mismatch&quot;}, _}} =
<a name="287"/>  287:         catch iob(zstd:decompress(iob([C1, C4]))),
<a name="288"/>  288: 
<a name="cstream_with_dict-last_expr"/><a name="289"/>  289:     ok.
<a name="290"/>  290: 
<a name="dstream-1"/><a name="291"/>  291: <b>dstream</b>(_Config) -&gt;
<a name="292"/>  292: 
<a name="293"/>  293:     {ok, DCtx} = zstd:context(decompress),
<a name="294"/>  294: 
<a name="295"/>  295:     Data = ~&quot;aaa&quot;,
<a name="296"/>  296:     CompressedData = zstd:compress(Data),
<a name="297"/>  297:     {First, Last} = lists:split(4, binary_to_list(iob(CompressedData))),
<a name="298"/>  298: 
<a name="299"/>  299:     {done, D1} = zstd:finish(DCtx, CompressedData),
<a name="300"/>  300:     ?assertEqual(Data, iob(D1)),
<a name="301"/>  301: 
<a name="302"/>  302:     {continue, D2_1} = zstd:stream(DCtx, First),
<a name="303"/>  303:     {done, D2_2} = zstd:finish(DCtx, Last),
<a name="304"/>  304:     ?assertEqual(Data, iob([D2_1, D2_2])),
<a name="305"/>  305: 
<a name="306"/>  306:     {continue, D3_1} = zstd:stream(DCtx, First),
<a name="307"/>  307:     ok = zstd:reset(DCtx),
<a name="308"/>  308:     {continue, D3_1} = zstd:stream(DCtx, [First]),
<a name="309"/>  309:     {continue, D3_2} = zstd:stream(DCtx, Last),
<a name="310"/>  310:     {done, D3_3} = zstd:finish(DCtx, &lt;&lt;&gt;&gt;),
<a name="311"/>  311:     ?assertEqual(Data, iob([D3_1, D3_2, D3_3])),
<a name="312"/>  312: 
<a name="313"/>  313:     ok = zstd:close(DCtx),
<a name="314"/>  314:     {'EXIT',{badarg,_}} = catch zstd:finish(DCtx, Data),
<a name="315"/>  315: 
<a name="dstream-last_expr"/><a name="316"/>  316:     ok.
<a name="317"/>  317: 
<a name="dstream_with_dict-1"/><a name="318"/>  318: <b>dstream_with_dict</b>(Config) -&gt;
<a name="319"/>  319: 
<a name="320"/>  320:     {ok, Dict} = file:read_file(proplists:get_value(dict, Config)),
<a name="321"/>  321:     {ok, DCtx} = zstd:context(decompress),
<a name="322"/>  322: 
<a name="323"/>  323:     Data = ~&quot;aaa&quot;,
<a name="324"/>  324:     CompressedData = zstd:compress(Data, #{ dictionary =&gt; Dict }),
<a name="325"/>  325:     {First, Last} = lists:split(4, binary_to_list(iob(CompressedData))),
<a name="326"/>  326: 
<a name="327"/>  327:     ok = zstd:set_parameter(DCtx, dictionary, Dict),
<a name="328"/>  328: 
<a name="329"/>  329:     {done, D1} = zstd:finish(DCtx, CompressedData),
<a name="330"/>  330:     Data = iob(D1),
<a name="331"/>  331: 
<a name="332"/>  332:     {continue, D2_1} = zstd:stream(DCtx, First),
<a name="333"/>  333:     {done, D2_2} = zstd:finish(DCtx, Last),
<a name="334"/>  334:     Data = iob([D2_1, D2_2]),
<a name="335"/>  335: 
<a name="336"/>  336:     {continue, D3_1} = zstd:stream(DCtx, First),
<a name="337"/>  337:     ok = zstd:reset(DCtx),
<a name="338"/>  338:     {continue, D3_1} = zstd:stream(DCtx, [First]),
<a name="339"/>  339:     {continue, D3_2} = zstd:stream(DCtx, Last),
<a name="340"/>  340:     {done, D3_3} = zstd:finish(DCtx, &lt;&lt;&gt;&gt;),
<a name="341"/>  341:     Data =  iob([D3_1, D3_2, D3_3]),
<a name="342"/>  342: 
<a name="343"/>  343:     ok = zstd:set_parameter(DCtx, dictionary, &lt;&lt;&gt;&gt;),
<a name="344"/>  344:     {'EXIT',{{zstd_error, ~&quot;Dictionary mismatch&quot;}, _}} =
<a name="345"/>  345:         catch zstd:finish(DCtx, CompressedData),
<a name="346"/>  346: 
<a name="dstream_with_dict-last_expr"/><a name="347"/>  347:     ok.
<a name="348"/>  348: 
<a name="parameters-1"/><a name="349"/>  349: <b>parameters</b>(_Config) -&gt;
<a name="350"/>  350: 
<a name="351"/>  351:     {ok, CCxt} = zstd:context(compress),
<a name="352"/>  352: 
<a name="353"/>  353:     CParams = [{compressionLevel, 5},
<a name="354"/>  354:                {windowLog, 10},
<a name="355"/>  355:                {hashLog, 6},
<a name="356"/>  356:                {chainLog, 6},
<a name="357"/>  357:                {searchLog, 1},
<a name="358"/>  358:                {minMatch, 5},
<a name="359"/>  359:                {targetLength, 5},
<a name="360"/>  360:                {strategy, fast},
<a name="361"/>  361:                {targetCBlockSize, 5},
<a name="362"/>  362:                {enableLongDistanceMatching, true},
<a name="363"/>  363:                {ldmHashLog, 6},
<a name="364"/>  364:                {ldmMinMatch, 6},
<a name="365"/>  365:                {ldmBucketSizeLog, 5},
<a name="366"/>  366:                {ldmHashRateLog, 5},
<a name="367"/>  367:                {contentSizeFlag, false},
<a name="368"/>  368:                {checksumFlag, true},
<a name="369"/>  369:                {dictIDFlag, false}],
<a name="370"/>  370: 
<a name="371"/>  371:     %% Check that we can get default parameters
<a name="372"/>  372:     [case {Key, zstd:get_parameter(CCxt, Key)} of
<a name="373"/>  373:          {Key, V} when is_integer(V), is_integer(Value) -&gt;
<a name="374"/>  374:              ok;
<a name="375"/>  375:          {Key, V} when is_boolean(V), is_boolean(Value)  -&gt;
<a name="376"/>  376:              ok;
<a name="377"/>  377:          {Key, V} when is_atom(V), is_atom(Value) -&gt;
<a name="378"/>  378:              ok
<a name="379"/>  379:      end || {Key, Value} &lt;- CParams],
<a name="380"/>  380: 
<a name="381"/>  381:     %% Set all available parameters
<a name="382"/>  382:     [ok = zstd:set_parameter(CCxt, Key, Value) || {Key, Value} &lt;- CParams],
<a name="383"/>  383: 
<a name="384"/>  384:     %% Check that we can get the non-default parameters
<a name="385"/>  385:     %% We cannot check that the actual values are correct as zstd
<a name="386"/>  386:     %% changes some of them when set.
<a name="387"/>  387:     [case {Key, zstd:get_parameter(CCxt, Key)} of
<a name="388"/>  388:          {Key, V} when is_integer(V), is_integer(Value) -&gt;
<a name="389"/>  389:              ok;
<a name="390"/>  390:          {Key, V} when is_boolean(V), is_boolean(Value)  -&gt;
<a name="391"/>  391:              ok;
<a name="392"/>  392:          {Key, V} when is_atom(V), is_atom(Value) -&gt;
<a name="393"/>  393:              ok
<a name="394"/>  394:      end || {Key, Value} &lt;- CParams],
<a name="395"/>  395: 
<a name="396"/>  396:     zstd:close(CCxt),
<a name="397"/>  397: 
<a name="398"/>  398:     {ok, DCxt} = zstd:context(decompress),
<a name="399"/>  399: 
<a name="400"/>  400:     DParams = [{windowLogMax, 10}],
<a name="401"/>  401: 
<a name="402"/>  402:     %% Check that we can get default parameters
<a name="403"/>  403:     [case zstd:get_parameter(DCxt, Key) of
<a name="404"/>  404:          V when is_integer(V), is_integer(Value) -&gt;
<a name="405"/>  405:              ok
<a name="406"/>  406:      end || {Key, Value} &lt;- DParams],
<a name="407"/>  407: 
<a name="408"/>  408:     %% Set all available parameters
<a name="409"/>  409:     [ok = zstd:set_parameter(DCxt, Key, Value) || {Key, Value} &lt;- DParams],
<a name="410"/>  410: 
<a name="411"/>  411:     %% Check that we can get the non-default parameters
<a name="412"/>  412:     %% We cannot check that the actual values are correct as zstd
<a name="413"/>  413:     %% changes some of them when set.
<a name="414"/>  414:     [case zstd:get_parameter(DCxt, Key) of
<a name="415"/>  415:          V when is_integer(V), is_integer(Value) -&gt;
<a name="416"/>  416:              ok
<a name="417"/>  417:      end || {Key, Value} &lt;- DParams],
<a name="418"/>  418: 
<a name="419"/>  419:     zstd:close(DCxt),
<a name="420"/>  420: 
<a name="parameters-last_expr"/><a name="421"/>  421:     ok.
<a name="422"/>  422: 
<a name="dict_api-1"/><a name="423"/>  423: <b>dict_api</b>(Config) -&gt;
<a name="424"/>  424: 
<a name="425"/>  425:     {ok, Dict} = file:read_file(proplists:get_value(dict, Config)),
<a name="426"/>  426:     DictId = zstd:get_dict_id(Dict),
<a name="427"/>  427: 
<a name="428"/>  428:     {ok, CDict} = zstd:dict(compress, Dict, #{ compressionLevel =&gt; -5 }),
<a name="429"/>  429:     DictId = zstd:get_dict_id(CDict),
<a name="430"/>  430: 
<a name="431"/>  431:     {ok, DDict} = zstd:dict(decompress, Dict),
<a name="432"/>  432:     DictId = zstd:get_dict_id(DDict),
<a name="433"/>  433: 
<a name="434"/>  434:     {ok, CCtx} = zstd:context(compress, #{ dictionary =&gt; CDict }),
<a name="435"/>  435:     {'EXIT', _} = catch zstd:set_parameter(CCtx, dictionary, DDict),
<a name="436"/>  436: 
<a name="437"/>  437:     {ok, DCtx} = zstd:context(decompress, #{ dictionary =&gt; DDict }),
<a name="438"/>  438:     {'EXIT', _} = catch zstd:set_parameter(DCtx, dictionary, CDict),
<a name="439"/>  439: 
<a name="dict_api-last_expr"/><a name="440"/>  440:     ok.
<a name="441"/>  441: 
<a name="442"/>  442: 
<a name="doc_tests-1"/><a name="443"/>  443: <b>doc_tests</b>(Config) -&gt;
<a name="doc_tests-last_expr"/><a name="444"/>  444: <b>    case erlang:system_info</b>(emu_type) of
<a name="445"/>  445:         debug -&gt;
<a name="446"/>  446:             %% As return values from decompress are split into an iovec with
<a name="447"/>  447:             %% multiple element on debug emulators, we skip running these test
<a name="448"/>  448:             {skip, &quot;Don't run in debug emulator&quot;};
<a name="449"/>  449:         _ -&gt;
<a name="450"/>  450:             {ok, Dict} = file:read_file(proplists:get_value(dict, Config)),
<a name="451"/>  451:             DictBinding = erl_eval:add_binding('Dict', Dict, erl_eval:new_bindings()),
<a name="452"/>  452:             File = filename:join(proplists:get_value(priv_dir, Config), &quot;example&quot;),
<a name="453"/>  453:             ok = file:write_file(File, ~&quot;lorem ipsum&quot;),
<a name="454"/>  454:             shell_docs:test(
<a name="455"/>  455:               zstd,
<a name="456"/>  456:               [
<a name="457"/>  457:                {module_doc, erl_eval:add_binding('File', File, erl_eval:new_bindings())},
<a name="458"/>  458:                {{function, get_dict_id, 1}, DictBinding},
<a name="459"/>  459:                {{function, dict, 3}, DictBinding}
<a name="460"/>  460:               ]
<a name="461"/>  461:              )
<a name="462"/>  462:     end.
<a name="463"/>  463: 
<a name="iob-1"/><a name="464"/>  464: <b>iob</b>(IOList) -&gt;
<a name="iob-last_expr"/><a name="465"/>  465: <b>    erlang:iolist_to_binary</b>(IOList).
<a name="466"/>  466: 
<a name="467"/>  467: <i>%% Doing enif_inspect on a large binary is very slow in debug</i>
<a name="468"/>  468: <i>%% build as it does a checksum of entire binary every time.</i>
<a name="469"/>  469: <i>%% So we limit the size of the input data in debug builds.</i>
<a name="large_data_size-0"/><a name="470"/>  470: <b>large_data_size</b>() -&gt;
<a name="large_data_size-last_expr"/><a name="471"/>  471: <b>    case erlang:system_info</b>(emu_type) =:= debug of
<a name="472"/>  472:         true -&gt; 2_000;
<a name="473"/>  473:         false -&gt; 1_000_000
<a name="474"/>  474:     end.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
