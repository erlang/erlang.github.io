<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/kernel/make_test_dir/kernel_test/zlib_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2005-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-module</b>(zlib_SUITE).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct_event.hrl&quot;).
<a name="25"/>   25: 
<a name="26"/>   26: <b>-export</b>([suite/0, all/0, groups/0]).
<a name="27"/>   27: 
<a name="28"/>   28: <i>%% API group</i>
<a name="29"/>   29: <b>-export</b>([api_open_close/1]).
<a name="30"/>   30: <b>-export</b>([api_deflateInit/1, api_deflateSetDictionary/1, api_deflateReset/1,
<a name="31"/>   31:          api_deflateParams/1, api_deflate/1, api_deflateEnd/1]).
<a name="32"/>   32: <b>-export</b>([api_inflateInit/1, api_inflateReset/1, api_inflate2/1, api_inflate3/1,
<a name="33"/>   33:          api_inflateChunk/1, api_safeInflate/1, api_inflateEnd/1]).
<a name="34"/>   34: <b>-export</b>([api_inflateSetDictionary/1, api_inflateGetDictionary/1]).
<a name="35"/>   35: <b>-export</b>([api_crc32/1, api_adler32/1]).
<a name="36"/>   36: <b>-export</b>([api_un_compress/1, api_un_zip/1, api_g_un_zip/1]).
<a name="37"/>   37: 
<a name="38"/>   38: <i>%% Examples group</i>
<a name="39"/>   39: <b>-export</b>([intro/1]).
<a name="40"/>   40: 
<a name="41"/>   41: <i>%% Usage group</i>
<a name="42"/>   42: <b>-export</b>([zip_usage/1, gz_usage/1, gz_usage2/1, compress_usage/1,
<a name="43"/>   43:          dictionary_usage/1, large_deflate/1, crc/1, adler/1,
<a name="44"/>   44:          only_allow_owner/1, sub_heap_binaries/1]).
<a name="45"/>   45: 
<a name="46"/>   46: <i>%% Bench group</i>
<a name="47"/>   47: <b>-export</b>([inflate_bench_zeroed/1, inflate_bench_rand/1,
<a name="48"/>   48:        deflate_bench_zeroed/1, deflate_bench_rand/1,
<a name="49"/>   49:        chunk_bench_zeroed/1, chunk_bench_rand/1]).
<a name="50"/>   50: 
<a name="51"/>   51: <i>%% Others</i>
<a name="52"/>   52: <b>-export</b>([smp/1, otp_9981/1, otp_7359/1]).
<a name="53"/>   53: 
<a name="54"/>   54: <b>-define</b>(m(Guard, Expression),
<a name="55"/>   55:     fun() -&gt;
<a name="56"/>   56:         Actual = (catch (Expression)),
<a name="57"/>   57:         case Actual of
<a name="58"/>   58:             Guard -&gt; Actual;
<a name="59"/>   59:             _Other -&gt;
<a name="60"/>   60:                 ct:fail(&quot;Failed to match ~p, actual result was ~p&quot;,
<a name="61"/>   61:                     [??Guard, Actual])
<a name="62"/>   62:         end
<a name="63"/>   63:     end()).
<a name="64"/>   64: 
<a name="65"/>   65: <b>-define</b>(EXIT(Reason), {'EXIT',{Reason,[{_,_,_,_}|_]}}).
<a name="66"/>   66: 
<a name="suite-0"/><a name="67"/>   67: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="68"/>   68:     [{ct_hooks,[ts_install_cth]},
<a name="69"/>   69:      {timetrap,{minutes,1}}].
<a name="70"/>   70: 
<a name="all-0"/><a name="71"/>   71: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="72"/>   72:     [{group, api}, {group, examples}, {group, func},
<a name="73"/>   73:      {group, bench}, smp,
<a name="74"/>   74:      otp_9981,
<a name="75"/>   75:      otp_7359].
<a name="76"/>   76: 
<a name="groups-0"/><a name="77"/>   77: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="78"/>   78:     [{api, [],
<a name="79"/>   79:       [api_open_close, api_deflateInit,
<a name="80"/>   80:        api_deflateSetDictionary, api_deflateReset,
<a name="81"/>   81:        api_deflateParams, api_deflate, api_deflateEnd,
<a name="82"/>   82:        api_inflateInit, api_inflateSetDictionary, api_inflateGetDictionary,
<a name="83"/>   83:        api_inflateReset, api_inflate2, api_inflate3, api_inflateChunk,
<a name="84"/>   84:        api_safeInflate, api_inflateEnd, api_crc32,
<a name="85"/>   85:        api_adler32, api_un_compress, api_un_zip,
<a name="86"/>   86:        api_g_un_zip]},
<a name="87"/>   87:      {examples, [], [intro]},
<a name="88"/>   88:      {func, [],
<a name="89"/>   89:       [zip_usage, gz_usage, gz_usage2, compress_usage,
<a name="90"/>   90:        dictionary_usage, large_deflate, crc, adler,
<a name="91"/>   91:        only_allow_owner, sub_heap_binaries]},
<a name="92"/>   92:      {bench,
<a name="93"/>   93:       [inflate_bench_zeroed, inflate_bench_rand,
<a name="94"/>   94:        deflate_bench_zeroed, deflate_bench_rand,
<a name="95"/>   95:        chunk_bench_zeroed, chunk_bench_rand]}].
<a name="96"/>   96: 
<a name="97"/>   97: <i>%% Test open/0 and close/1.</i>
<a name="api_open_close-1"/><a name="98"/>   98: <b>api_open_close</b>(Config) when is_list(Config) -&gt;
<a name="99"/>   99:     Fd1 = zlib:open(),
<a name="100"/>  100:     Fd2 = zlib:open(),
<a name="101"/>  101:     ?m(false,Fd1 == Fd2),
<a name="102"/>  102:     ?m(ok,zlib:close(Fd1)),
<a name="103"/>  103:     ?m(?EXIT(not_initialized), zlib:close(Fd1)),
<a name="104"/>  104:     ?m(ok,zlib:close(Fd2)),
<a name="105"/>  105: 
<a name="106"/>  106:     %% Make sure that we don't get any EXIT messages if trap_exit is enabled.
<a name="107"/>  107:     process_flag(trap_exit, true),
<a name="108"/>  108:     Fd3 = zlib:open(),
<a name="109"/>  109:     ?m(ok,zlib:close(Fd3)),
<a name="api_open_close-last_expr"/><a name="110"/>  110:     receive
<a name="111"/>  111: 	Any -&gt; ct:fail({unexpected_message,Any})
<a name="112"/>  112:     after 10 -&gt; ok
<a name="113"/>  113:     end.
<a name="114"/>  114: 
<a name="115"/>  115: <i>%% Test deflateInit/2 and /6.</i>
<a name="api_deflateInit-1"/><a name="116"/>  116: <b>api_deflateInit</b>(Config) when is_list(Config) -&gt;
<a name="117"/>  117:     Z1 = zlib:open(),
<a name="118"/>  118: 
<a name="119"/>  119:     ?m(?EXIT(badarg), zlib:deflateInit(gurka, none)),
<a name="120"/>  120: 
<a name="121"/>  121:     ?m(?EXIT(bad_compression_level), zlib:deflateInit(gurka, gurka)),
<a name="122"/>  122:     ?m(?EXIT(bad_compression_level), zlib:deflateInit(Z1, gurka)),
<a name="123"/>  123:     Levels = [none, default, best_speed, best_compression] ++ lists:seq(0,9),
<a name="124"/>  124:     lists:foreach(fun(Level) -&gt;
<a name="125"/>  125: 			  Z = zlib:open(),
<a name="126"/>  126: 			  ?m(ok, zlib:deflateInit(Z, Level)),
<a name="127"/>  127: 			  ?m(ok,zlib:close(Z))
<a name="128"/>  128: 		  end, Levels),
<a name="129"/>  129:     %% /6
<a name="130"/>  130:     ?m(?EXIT(bad_compression_level),
<a name="131"/>  131:         zlib:deflateInit(Z1,gurka,deflated,-15,8,default)),
<a name="132"/>  132: 
<a name="133"/>  133:     ?m(?EXIT(bad_compression_method),
<a name="134"/>  134:         zlib:deflateInit(Z1,default,undefined,-15,8,default)),
<a name="135"/>  135: 
<a name="136"/>  136:     ?m(?EXIT(bad_compression_strategy),
<a name="137"/>  137:         zlib:deflateInit(Z1,default,deflated,-15,8,0)),
<a name="138"/>  138:     ?m(?EXIT(bad_compression_strategy),
<a name="139"/>  139:         zlib:deflateInit(Z1,default,deflated,-15,8,undefined)),
<a name="140"/>  140: 
<a name="141"/>  141:     ?m(?EXIT(bad_windowbits),
<a name="142"/>  142:         zlib:deflateInit(Z1,default,deflated,48,8,default)),
<a name="143"/>  143:     ?m(?EXIT(bad_windowbits),
<a name="144"/>  144:         zlib:deflateInit(Z1,default,deflated,-20,8,default)),
<a name="145"/>  145:     ?m(?EXIT(bad_windowbits),
<a name="146"/>  146:         zlib:deflateInit(Z1,default,deflated,-7,8,default)),
<a name="147"/>  147:     ?m(?EXIT(bad_windowbits),
<a name="148"/>  148:         zlib:deflateInit(Z1,default,deflated,7,8,default)),
<a name="149"/>  149: 
<a name="150"/>  150:     ?m(?EXIT(bad_memlevel),
<a name="151"/>  151:         zlib:deflateInit(Z1,default,deflated,-15,0,default)),
<a name="152"/>  152:     ?m(?EXIT(bad_memlevel),
<a name="153"/>  153:         zlib:deflateInit(Z1,default,deflated,-15,10,default)),
<a name="154"/>  154: 
<a name="155"/>  155:     lists:foreach(fun(Level) -&gt;
<a name="156"/>  156: 			  Z = zlib:open(),
<a name="157"/>  157: 			  ?m(ok, zlib:deflateInit(Z, Level, deflated, -15, 8, default)),
<a name="158"/>  158: 			  ?m(ok,zlib:close(Z))
<a name="159"/>  159: 		  end, Levels),
<a name="160"/>  160: 
<a name="161"/>  161:     lists:foreach(fun(Wbits) -&gt;
<a name="162"/>  162: 			  Z11 = zlib:open(),
<a name="163"/>  163: 			  ?m(ok, zlib:deflateInit(Z11,best_compression,deflated,
<a name="164"/>  164: 						  Wbits,8,default)),
<a name="165"/>  165: 			  Z12 = zlib:open(),
<a name="166"/>  166: 			  ?m(ok, zlib:deflateInit(Z12,default,deflated,-Wbits,8,default)),
<a name="167"/>  167: 			  ?m(ok,zlib:close(Z11)),
<a name="168"/>  168: 			  ?m(ok,zlib:close(Z12))
<a name="169"/>  169: 		  end, lists:seq(9, 15)),
<a name="170"/>  170: 
<a name="171"/>  171:     lists:foreach(fun(MemLevel) -&gt;
<a name="172"/>  172: 			  Z = zlib:open(),
<a name="173"/>  173: 			  ?m(ok, zlib:deflateInit(Z,default,deflated,-15, 
<a name="174"/>  174: 						  MemLevel,default)),
<a name="175"/>  175: 			  ?m(ok,zlib:close(Z))
<a name="176"/>  176: 		  end, lists:seq(1,8)),
<a name="177"/>  177: 
<a name="178"/>  178:     Strategies = [filtered,huffman_only,rle,default],
<a name="179"/>  179:     lists:foreach(fun(Strategy) -&gt;
<a name="180"/>  180: 			  Z = zlib:open(),
<a name="181"/>  181: 			  ?m(ok, zlib:deflateInit(Z,best_speed,deflated,-15,8,Strategy)),
<a name="182"/>  182: 			  ?m(ok,zlib:close(Z))
<a name="183"/>  183: 		  end, Strategies),
<a name="184"/>  184:     ?m(ok, zlib:deflateInit(Z1,default,deflated,-15,8,default)),
<a name="185"/>  185: 
<a name="186"/>  186:     %% Let it crash for any reason; we don't care about the order in which the
<a name="187"/>  187:     %% parameters are checked.
<a name="188"/>  188:     ?m(?EXIT(_), zlib:deflateInit(Z1,none,deflated,-15,8,default)),
<a name="189"/>  189: 
<a name="api_deflateInit-last_expr"/><a name="190"/>  190: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="191"/>  191: 
<a name="192"/>  192: <i>%% Test deflateSetDictionary.</i>
<a name="api_deflateSetDictionary-1"/><a name="193"/>  193: <b>api_deflateSetDictionary</b>(Config) when is_list(Config) -&gt;
<a name="194"/>  194:     Z1 = zlib:open(),
<a name="195"/>  195:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="196"/>  196:     ?m(Id when is_integer(Id), zlib:deflateSetDictionary(Z1, &lt;&lt;1,1,2,3,4,5,1&gt;&gt;)),
<a name="197"/>  197:     ?m(Id when is_integer(Id), zlib:deflateSetDictionary(Z1, [1,1,2,3,4,5,1])),
<a name="198"/>  198:     ?m(?EXIT(badarg), zlib:deflateSetDictionary(Z1, gurka)),
<a name="199"/>  199:     ?m(?EXIT(badarg), zlib:deflateSetDictionary(Z1, 128)),
<a name="200"/>  200:     ?m(L when is_list(L), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, none)),
<a name="201"/>  201:     ?m(?EXIT(stream_error), zlib:deflateSetDictionary(Z1,&lt;&lt;1,1,2,3,4,5,1&gt;&gt;)),
<a name="api_deflateSetDictionary-last_expr"/><a name="202"/>  202: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="203"/>  203: 
<a name="204"/>  204: <i>%% Test deflateReset.</i>
<a name="api_deflateReset-1"/><a name="205"/>  205: <b>api_deflateReset</b>(Config) when is_list(Config) -&gt;
<a name="206"/>  206:     Z1 = zlib:open(),
<a name="207"/>  207:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="208"/>  208:     ?m(L when is_list(L), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, none)),
<a name="209"/>  209:     ?m(ok, zlib:deflateReset(Z1)),
<a name="210"/>  210:     ?m(ok, zlib:deflateReset(Z1)),
<a name="211"/>  211:     %% FIXME how do I make this go wrong??
<a name="api_deflateReset-last_expr"/><a name="212"/>  212: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="213"/>  213: 
<a name="214"/>  214: <i>%% Test deflateParams.</i>
<a name="api_deflateParams-1"/><a name="215"/>  215: <b>api_deflateParams</b>(Config) when is_list(Config) -&gt;
<a name="216"/>  216:     Levels = [none, default, best_speed, best_compression] ++ lists:seq(0, 9),
<a name="217"/>  217:     Strategies = [filtered, huffman_only, rle, default],
<a name="218"/>  218: 
<a name="219"/>  219:     Z1 = zlib:open(),
<a name="220"/>  220:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="221"/>  221: 
<a name="222"/>  222:     ApiTest =
<a name="223"/>  223:         fun(Level, Strategy) -&gt;
<a name="224"/>  224:             ?m(ok, zlib:deflateParams(Z1, Level, Strategy)),
<a name="225"/>  225:             ?m(ok, zlib:deflateReset(Z1))
<a name="226"/>  226:         end,
<a name="227"/>  227: 
<a name="228"/>  228:     [ ApiTest(Level, Strategy) || Level &lt;- Levels, Strategy &lt;- Strategies ],
<a name="229"/>  229: 
<a name="230"/>  230:     ?m(ok, zlib:close(Z1)),
<a name="231"/>  231: 
<a name="232"/>  232:     FlushTest =
<a name="233"/>  233:         fun FlushTest(Size, Level, Strategy) -&gt;
<a name="234"/>  234:             Z = zlib:open(),
<a name="235"/>  235:             ok = zlib:deflateInit(Z, default),
<a name="236"/>  236:             Data = gen_determ_rand_bytes(Size),
<a name="237"/>  237:             case zlib:deflate(Z, Data, none) of
<a name="238"/>  238:                 [&lt;&lt;120, 156&gt;&gt;] -&gt;
<a name="239"/>  239:                     %% All data is present in the internal zlib state, and will
<a name="240"/>  240:                     %% be flushed on deflateParams.
<a name="241"/>  241: 
<a name="242"/>  242:                     ok = zlib:deflateParams(Z, Level, Strategy),
<a name="243"/>  243:                     Compressed = [&lt;&lt;120, 156&gt;&gt;, zlib:deflate(Z, &lt;&lt;&gt;&gt;, finish)],
<a name="244"/>  244:                     Data = zlib:uncompress(Compressed),
<a name="245"/>  245:                     zlib:close(Z),
<a name="246"/>  246: 
<a name="247"/>  247:                     FlushTest(Size + (1 bsl 10), Level, Strategy);
<a name="248"/>  248:                 _Other -&gt;
<a name="249"/>  249:                     ok
<a name="250"/>  250:             end
<a name="251"/>  251:         end,
<a name="252"/>  252: 
<a name="253"/>  253:     [ FlushTest(1, Level, Strategy) || Level &lt;- Levels, Strategy &lt;- Strategies ],
<a name="254"/>  254: 
<a name="api_deflateParams-last_expr"/><a name="255"/>  255:     ok.
<a name="256"/>  256: 
<a name="257"/>  257: <i>%% Test deflate.</i>
<a name="api_deflate-1"/><a name="258"/>  258: <b>api_deflate</b>(Config) when is_list(Config) -&gt;
<a name="259"/>  259:     Z1 = zlib:open(),
<a name="260"/>  260:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="261"/>  261:     ?m([B] when is_binary(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, finish)),
<a name="262"/>  262:     ?m(ok, zlib:deflateReset(Z1)),
<a name="263"/>  263:     ?m([B] when is_binary(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, finish)),
<a name="264"/>  264:     ?m(ok, zlib:deflateReset(Z1)),
<a name="265"/>  265:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;)),
<a name="266"/>  266:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, none)),
<a name="267"/>  267:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, sync)),
<a name="268"/>  268:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, full)),
<a name="269"/>  269:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;&gt;&gt;, finish)),
<a name="270"/>  270: 
<a name="271"/>  271:     ?m(?EXIT(badarg), zlib:deflate(gurka, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, full)),
<a name="272"/>  272: 
<a name="273"/>  273:     ?m(?EXIT(bad_flush_mode), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, asdj)),
<a name="274"/>  274:     ?m(?EXIT(bad_flush_mode), zlib:deflate(Z1, &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;, 198)),
<a name="275"/>  275: 
<a name="276"/>  276:     %% Causes problems ERROR REPORT
<a name="277"/>  277:     ?m(?EXIT(badarg), zlib:deflate(Z1, [asdj,asd], none)),
<a name="278"/>  278: 
<a name="api_deflate-last_expr"/><a name="279"/>  279: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="280"/>  280: 
<a name="281"/>  281: <i>%% Test deflateEnd.</i>
<a name="api_deflateEnd-1"/><a name="282"/>  282: <b>api_deflateEnd</b>(Config) when is_list(Config) -&gt;
<a name="283"/>  283:     Z1 = zlib:open(),
<a name="284"/>  284:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="285"/>  285:     ?m(ok, zlib:deflateEnd(Z1)),
<a name="286"/>  286:     ?m(?EXIT(not_initialized), zlib:deflateEnd(Z1)),
<a name="287"/>  287:     ?m(?EXIT(badarg), zlib:deflateEnd(gurka)),
<a name="288"/>  288:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="289"/>  289:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;&quot;Kilroy was here&quot;&gt;&gt;)),
<a name="290"/>  290:     ?m(?EXIT(data_error), zlib:deflateEnd(Z1)),
<a name="291"/>  291:     ?m(ok, zlib:deflateInit(Z1, default)),
<a name="292"/>  292:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;&quot;Kilroy was here&quot;&gt;&gt;)),
<a name="293"/>  293:     ?m(B when is_list(B), zlib:deflate(Z1, &lt;&lt;&quot;Kilroy was here&quot;&gt;&gt;, finish)),
<a name="294"/>  294:     ?m(ok, zlib:deflateEnd(Z1)),
<a name="295"/>  295: 
<a name="api_deflateEnd-last_expr"/><a name="296"/>  296: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="297"/>  297: 
<a name="298"/>  298: <i>%% Test inflateInit /1 and /2.</i>
<a name="api_inflateInit-1"/><a name="299"/>  299: <b>api_inflateInit</b>(Config) when is_list(Config) -&gt;
<a name="300"/>  300:     Z1 = zlib:open(),
<a name="301"/>  301:     ?m(?EXIT(badarg), zlib:inflateInit(gurka)),
<a name="302"/>  302:     ?m(ok, zlib:inflateInit(Z1)),
<a name="303"/>  303:     ?m(?EXIT(already_initialized), zlib:inflateInit(Z1, 15)),
<a name="304"/>  304:     lists:foreach(fun(Wbits) -&gt;
<a name="305"/>  305: 			  Z11 = zlib:open(),
<a name="306"/>  306: 			  ?m(ok, zlib:inflateInit(Z11,Wbits)),
<a name="307"/>  307: 			  Z12 = zlib:open(),
<a name="308"/>  308: 			  ?m(ok, zlib:inflateInit(Z12,-Wbits)),
<a name="309"/>  309: 			  ?m(ok,zlib:close(Z11)),
<a name="310"/>  310: 			  ?m(ok,zlib:close(Z12))
<a name="311"/>  311: 		  end, lists:seq(8,15)),
<a name="312"/>  312:     ?m(?EXIT(badarg), zlib:inflateInit(gurka, -15)),
<a name="313"/>  313:     ?m(?EXIT(bad_windowbits), zlib:inflateInit(Z1, 7)),
<a name="314"/>  314:     ?m(?EXIT(bad_windowbits), zlib:inflateInit(Z1, -7)),
<a name="315"/>  315:     ?m(?EXIT(bad_windowbits), zlib:inflateInit(Z1, 48)),
<a name="316"/>  316:     ?m(?EXIT(bad_windowbits), zlib:inflateInit(Z1, -16)),
<a name="api_inflateInit-last_expr"/><a name="317"/>  317: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="318"/>  318: 
<a name="319"/>  319: <i>%% Test inflateSetDictionary.</i>
<a name="api_inflateSetDictionary-1"/><a name="320"/>  320: <b>api_inflateSetDictionary</b>(Config) when is_list(Config) -&gt;
<a name="321"/>  321:     Z1 = zlib:open(),
<a name="322"/>  322:     ?m(ok, zlib:inflateInit(Z1)),
<a name="323"/>  323:     ?m(?EXIT(badarg), zlib:inflateSetDictionary(gurka,&lt;&lt;1,1,1,1,1&gt;&gt;)),
<a name="324"/>  324:     ?m(?EXIT(badarg), zlib:inflateSetDictionary(Z1,102)),
<a name="325"/>  325:     ?m(?EXIT(badarg), zlib:inflateSetDictionary(Z1,gurka)),
<a name="326"/>  326:     Dict = &lt;&lt;1,1,1,1,1&gt;&gt;,
<a name="327"/>  327:     ?m(?EXIT(stream_error), zlib:inflateSetDictionary(Z1,Dict)),
<a name="api_inflateSetDictionary-last_expr"/><a name="328"/>  328: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="329"/>  329: 
<a name="330"/>  330: <i>%% Test inflateGetDictionary.</i>
<a name="api_inflateGetDictionary-1"/><a name="331"/>  331: <b>api_inflateGetDictionary</b>(Config) when is_list(Config) -&gt;
<a name="332"/>  332:     Z1 = zlib:open(),
<a name="333"/>  333:     zlib:inflateInit(Z1),
<a name="334"/>  334:     IsOperationSupported =
<a name="335"/>  335:         case catch zlib:inflateGetDictionary(Z1) of
<a name="336"/>  336:             ?EXIT(not_supported) -&gt; false;
<a name="337"/>  337:             _ -&gt; true
<a name="338"/>  338:         end,
<a name="339"/>  339:     zlib:close(Z1),
<a name="api_inflateGetDictionary-last_expr"/><a name="340"/>  340: <b>    api_inflateGetDictionary_if_supported</b>(IsOperationSupported).
<a name="341"/>  341: 
<a name="api_inflateGetDictionary_if_supported-1"/><a name="342"/>  342: <b>api_inflateGetDictionary_if_supported</b>(false) -&gt;
<a name="343"/>  343:     {skip, &quot;inflateGetDictionary/1 unsupported in current setup&quot;};
<a name="344"/>  344: <b>api_inflateGetDictionary_if_supported</b>(true) -&gt;
<a name="345"/>  345:     % Compress payload using custom dictionary
<a name="346"/>  346:     Z1 = zlib:open(),
<a name="347"/>  347:     ?m(ok, zlib:deflateInit(Z1)),
<a name="348"/>  348:     Dict = &lt;&lt;&quot;foobar barfoo foo bar far boo&quot;&gt;&gt;,
<a name="349"/>  349:     Checksum = zlib:deflateSetDictionary(Z1, Dict),
<a name="350"/>  350:     Payload = &lt;&lt;&quot;foobarbarbar&quot;&gt;&gt;,
<a name="351"/>  351:     Compressed = zlib:deflate(Z1, Payload, finish),
<a name="352"/>  352:     ?m(ok, zlib:close(Z1)),
<a name="353"/>  353: 
<a name="354"/>  354:     % Decompress and test dictionary extraction with inflate/2
<a name="355"/>  355:     Z2 = zlib:open(),
<a name="356"/>  356:     ?m(ok, zlib:inflateInit(Z2)),
<a name="357"/>  357:     ?m(&lt;&lt;&gt;&gt;, iolist_to_binary(zlib:inflateGetDictionary(Z2))),
<a name="358"/>  358:     ?m(?EXIT(stream_error), zlib:inflateSetDictionary(Z2, Dict)),
<a name="359"/>  359:     ?m(?EXIT({need_dictionary,Checksum}), zlib:inflate(Z2, Compressed)),
<a name="360"/>  360:     ?m(ok, zlib:inflateSetDictionary(Z2, Dict)),
<a name="361"/>  361:     ?m(Dict, iolist_to_binary(zlib:inflateGetDictionary(Z2))),
<a name="362"/>  362:     Payload = iolist_to_binary(zlib:inflate(Z2, [])),
<a name="363"/>  363:     ?m(ok, zlib:close(Z2)),
<a name="364"/>  364:     ?m(?EXIT(not_initialized), zlib:inflateSetDictionary(Z2, Dict)),
<a name="365"/>  365: 
<a name="366"/>  366:     %% ... And do the same for inflate/3
<a name="367"/>  367:     Z3 = zlib:open(),
<a name="368"/>  368:     ?m(ok, zlib:inflateInit(Z3)),
<a name="369"/>  369:     ?m(&lt;&lt;&gt;&gt;, iolist_to_binary(zlib:inflateGetDictionary(Z3))),
<a name="370"/>  370:     ?m(?EXIT(stream_error), zlib:inflateSetDictionary(Z3, Dict)),
<a name="371"/>  371: 
<a name="372"/>  372:     {need_dictionary, Checksum, _Output = []} =
<a name="373"/>  373:         zlib:inflate(Z3, Compressed, [{exception_on_need_dict, false}]),
<a name="374"/>  374: 
<a name="375"/>  375:     ?m(ok, zlib:inflateSetDictionary(Z3, Dict)),
<a name="376"/>  376:     ?m(Dict, iolist_to_binary(zlib:inflateGetDictionary(Z3))),
<a name="377"/>  377: 
<a name="378"/>  378:     Payload = iolist_to_binary(
<a name="379"/>  379:         zlib:inflate(Z3, [], [{exception_on_need_dict, false}])),
<a name="380"/>  380: 
<a name="381"/>  381:     ?m(ok, zlib:close(Z3)),
<a name="382"/>  382:     ?m(?EXIT(not_initialized), zlib:inflateSetDictionary(Z3, Dict)),
<a name="383"/>  383: 
<a name="api_inflateGetDictionary_if_supported-last_expr"/><a name="384"/>  384:     ok.
<a name="385"/>  385: 
<a name="386"/>  386: <i>%% Test inflateReset.</i>
<a name="api_inflateReset-1"/><a name="387"/>  387: <b>api_inflateReset</b>(Config) when is_list(Config) -&gt;
<a name="388"/>  388:     Z1 = zlib:open(),
<a name="389"/>  389:     ?m(ok, zlib:inflateInit(Z1)),
<a name="390"/>  390:     ?m(?EXIT(badarg), zlib:inflateReset(gurka)),
<a name="391"/>  391:     ?m(ok, zlib:inflateReset(Z1)),
<a name="api_inflateReset-last_expr"/><a name="392"/>  392: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="393"/>  393: 
<a name="394"/>  394: <i>%% Test inflate/2</i>
<a name="api_inflate2-1"/><a name="395"/>  395: <b>api_inflate2</b>(Config) when is_list(Config) -&gt;
<a name="396"/>  396:     Data = [&lt;&lt;1,2,2,3,3,3,4,4,4,4&gt;&gt;],
<a name="397"/>  397:     Compressed = zlib:compress(Data),
<a name="398"/>  398: 
<a name="399"/>  399:     Z1 = zlib:open(),
<a name="400"/>  400:     ?m(ok, zlib:inflateInit(Z1)),
<a name="401"/>  401:     ?m([], zlib:inflate(Z1, &lt;&lt;&gt;&gt;)),
<a name="402"/>  402:     ?m(Data, zlib:inflate(Z1, Compressed)),
<a name="403"/>  403:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="404"/>  404:     ?m(ok, zlib:inflateInit(Z1)),
<a name="405"/>  405:     ?m(Data, zlib:inflate(Z1, Compressed)),
<a name="406"/>  406:     ?m(?EXIT(badarg), zlib:inflate(gurka, Compressed)),
<a name="407"/>  407:     ?m(?EXIT(badarg), zlib:inflate(Z1, 4384)),
<a name="408"/>  408:     ?m(?EXIT(badarg), zlib:inflate(Z1, [atom_list])),
<a name="409"/>  409:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="410"/>  410:     ?m(ok, zlib:inflateInit(Z1)),
<a name="411"/>  411:     ?m(?EXIT(data_error), zlib:inflate(Z1, &lt;&lt;2,1,2,1,2&gt;&gt;)),
<a name="412"/>  412:     ?m(ok, zlib:close(Z1)),
<a name="413"/>  413: 
<a name="414"/>  414:     %% OTP-17299: we failed to fully flush the zlib state if we ran out of
<a name="415"/>  415:     %% input and filled the internal output buffer at the same time.
<a name="416"/>  416:     EdgeCaseData = &lt;&lt;&quot;gurka&quot;, 0:16384/integer-unit:8&gt;&gt;,
<a name="417"/>  417:     EdgeCaseZipped = zlib:zip(EdgeCaseData),
<a name="418"/>  418:     Z2 = zlib:open(),
<a name="419"/>  419:     ?m(ok, zlib:inflateInit(Z2, -15)),
<a name="420"/>  420:     Unzipped = iolist_to_binary(zlib:inflate(Z2, EdgeCaseZipped)),
<a name="421"/>  421:     ?m(EdgeCaseData, Unzipped),
<a name="422"/>  422:     ?m(ok, zlib:inflateEnd(Z2)),
<a name="423"/>  423:     ?m(ok, zlib:close(Z2)),
<a name="424"/>  424: 
<a name="api_inflate2-last_expr"/><a name="425"/>  425:     ok.
<a name="426"/>  426: 
<a name="427"/>  427: <i>%% Test inflate/3; same as inflate/2 but with the default options inverted.</i>
<a name="api_inflate3-1"/><a name="428"/>  428: <b>api_inflate3</b>(Config) when is_list(Config) -&gt;
<a name="429"/>  429:     Data = [&lt;&lt;1,2,2,3,3,3,4,4,4,4&gt;&gt;],
<a name="430"/>  430:     Options = [{exception_on_need_dict, false}],
<a name="431"/>  431:     Compressed = zlib:compress(Data),
<a name="432"/>  432:     Z1 = zlib:open(),
<a name="433"/>  433:     ?m(ok, zlib:inflateInit(Z1)),
<a name="434"/>  434:     ?m([], zlib:inflate(Z1, &lt;&lt;&gt;&gt;, Options)),
<a name="435"/>  435:     ?m(Data, zlib:inflate(Z1, Compressed)),
<a name="436"/>  436:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="437"/>  437:     ?m(ok, zlib:inflateInit(Z1)),
<a name="438"/>  438:     ?m(Data, zlib:inflate(Z1, Compressed, Options)),
<a name="439"/>  439:     ?m(?EXIT(badarg), zlib:inflate(gurka, Compressed, Options)),
<a name="440"/>  440:     ?m(?EXIT(badarg), zlib:inflate(Z1, 4384, Options)),
<a name="441"/>  441:     ?m(?EXIT(badarg), zlib:inflate(Z1, [atom_list], Options)),
<a name="442"/>  442:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="443"/>  443:     ?m(ok, zlib:inflateInit(Z1)),
<a name="444"/>  444:     ?m(?EXIT(data_error), zlib:inflate(Z1, &lt;&lt;2,1,2,1,2&gt;&gt;, Options)),
<a name="api_inflate3-last_expr"/><a name="445"/>  445: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="446"/>  446: 
<a name="447"/>  447: <i>%% Test inflateChunk.</i>
<a name="api_inflateChunk-1"/><a name="448"/>  448: <b>api_inflateChunk</b>(Config) when is_list(Config) -&gt;
<a name="449"/>  449:     ChunkSize = 1024,
<a name="450"/>  450:     Data = &lt;&lt; &lt;&lt;(I rem 150)&gt;&gt; || I &lt;- lists:seq(1, 3 * ChunkSize) &gt;&gt;,
<a name="451"/>  451:     Part1 = binary:part(Data, 0, ChunkSize),
<a name="452"/>  452:     Part2 = binary:part(Data, ChunkSize, ChunkSize),
<a name="453"/>  453:     Part3 = binary:part(Data, ChunkSize * 2, ChunkSize),
<a name="454"/>  454: 
<a name="455"/>  455:     Compressed = zlib:compress(Data),
<a name="456"/>  456:     Z1 = zlib:open(),
<a name="457"/>  457: 
<a name="458"/>  458:     zlib:setBufSize(Z1, ChunkSize),
<a name="459"/>  459: 
<a name="460"/>  460:     ?m(ok, zlib:inflateInit(Z1)),
<a name="461"/>  461: 
<a name="462"/>  462:     0 = iolist_size(zlib:inflateChunk(Z1, &lt;&lt;&gt;&gt;)),
<a name="463"/>  463: 
<a name="464"/>  464:     {more, Part1AsIOList} = zlib:inflateChunk(Z1, Compressed),
<a name="465"/>  465:     {more, Part2AsIOList} = zlib:inflateChunk(Z1),
<a name="466"/>  466:     {more, Part3AsIOList} = zlib:inflateChunk(Z1),
<a name="467"/>  467: 
<a name="468"/>  468:     [] = zlib:inflateChunk(Z1),
<a name="469"/>  469:     [] = zlib:inflateChunk(Z1),
<a name="470"/>  470:     [] = zlib:inflateChunk(Z1),
<a name="471"/>  471: 
<a name="472"/>  472:     ?m(Part1, iolist_to_binary(Part1AsIOList)),
<a name="473"/>  473:     ?m(Part2, iolist_to_binary(Part2AsIOList)),
<a name="474"/>  474:     ?m(Part3, iolist_to_binary(Part3AsIOList)),
<a name="475"/>  475: 
<a name="476"/>  476:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="477"/>  477:     ?m(ok, zlib:inflateInit(Z1)),
<a name="478"/>  478: 
<a name="479"/>  479:     ?m({more, Part1AsIOList}, zlib:inflateChunk(Z1, Compressed)),
<a name="480"/>  480: 
<a name="481"/>  481:     ?m(ok, zlib:inflateReset(Z1)),
<a name="482"/>  482: 
<a name="483"/>  483:     zlib:setBufSize(Z1, byte_size(Data) + 1),
<a name="484"/>  484: 
<a name="485"/>  485:     DataAsIOList = zlib:inflateChunk(Z1, Compressed),
<a name="486"/>  486:     ?m(Data, iolist_to_binary(DataAsIOList)),
<a name="487"/>  487: 
<a name="488"/>  488:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="489"/>  489:     ?m(ok, zlib:inflateInit(Z1)),
<a name="490"/>  490: 
<a name="491"/>  491:     ?m(?EXIT(badarg), zlib:inflateChunk(gurka, Compressed)),
<a name="492"/>  492:     ?m(?EXIT(badarg), zlib:inflateChunk(Z1, 4384)),
<a name="493"/>  493: 
<a name="494"/>  494:     ?m(?EXIT(data_error), zlib:inflateEnd(Z1)),
<a name="495"/>  495: 
<a name="api_inflateChunk-last_expr"/><a name="496"/>  496: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="497"/>  497: 
<a name="498"/>  498: <i>%% Test safeInflate as a mirror of inflateChunk, but ignore the stuff about</i>
<a name="499"/>  499: <i>%% exact chunk sizes.</i>
<a name="api_safeInflate-1"/><a name="500"/>  500: <b>api_safeInflate</b>(Config) when is_list(Config) -&gt;
<a name="501"/>  501:     Data = &lt;&lt; &lt;&lt;(I rem 150)&gt;&gt; || I &lt;- lists:seq(1, 20 bsl 10) &gt;&gt;,
<a name="502"/>  502:     Compressed = zlib:compress(Data),
<a name="503"/>  503:     Z1 = zlib:open(),
<a name="504"/>  504: 
<a name="505"/>  505:     ?m(ok, zlib:inflateInit(Z1)),
<a name="506"/>  506: 
<a name="507"/>  507:     SafeInflateLoop =
<a name="508"/>  508:         fun
<a name="509"/>  509:             Loop({continue, Chunk}, Output) -&gt;
<a name="510"/>  510:                 Loop(zlib:safeInflate(Z1, []), [Output, Chunk]);
<a name="511"/>  511:             Loop({finished, Chunk}, Output) -&gt;
<a name="512"/>  512:                 [Output, Chunk]
<a name="513"/>  513:         end,
<a name="514"/>  514: 
<a name="515"/>  515:     Decompressed = SafeInflateLoop(zlib:safeInflate(Z1, Compressed), []),
<a name="516"/>  516:     Data = iolist_to_binary(Decompressed),
<a name="517"/>  517: 
<a name="518"/>  518:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="519"/>  519:     ?m(ok, zlib:inflateInit(Z1)),
<a name="520"/>  520: 
<a name="521"/>  521:     {continue, Partial} = zlib:safeInflate(Z1, Compressed),
<a name="522"/>  522:     PBin = iolist_to_binary(Partial),
<a name="523"/>  523:     PSize = byte_size(PBin),
<a name="524"/>  524:     &lt;&lt;PBin:PSize/binary, Rest/binary&gt;&gt; = Data,
<a name="525"/>  525: 
<a name="526"/>  526:     ?m(ok, zlib:inflateReset(Z1)),
<a name="527"/>  527: 
<a name="528"/>  528:     {continue, Partial} = zlib:safeInflate(Z1, Compressed),
<a name="529"/>  529:     PBin = iolist_to_binary(Partial),
<a name="530"/>  530:     PSize = byte_size(PBin),
<a name="531"/>  531:     &lt;&lt;PBin:PSize/binary, Rest/binary&gt;&gt; = Data,
<a name="532"/>  532: 
<a name="533"/>  533:     ?m(ok, zlib:inflateReset(Z1)),
<a name="534"/>  534: 
<a name="535"/>  535:     SafeInflateLoop(zlib:safeInflate(Z1, Compressed), []),
<a name="536"/>  536: 
<a name="537"/>  537:     ?m({finished, []}, zlib:safeInflate(Z1, Compressed)),
<a name="538"/>  538:     ?m({finished, []}, zlib:safeInflate(Z1, Compressed)),
<a name="539"/>  539: 
<a name="540"/>  540:     ?m(ok, zlib:inflateReset(Z1)),
<a name="541"/>  541:     ?m(?EXIT(badarg), zlib:safeInflate(gurka, Compressed)),
<a name="542"/>  542:     ?m(?EXIT(badarg), zlib:safeInflate(Z1, 4384)),
<a name="543"/>  543:     ?m(?EXIT(data_error), zlib:inflateEnd(Z1)),
<a name="api_safeInflate-last_expr"/><a name="544"/>  544: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="545"/>  545: 
<a name="546"/>  546: <i>%% Test inflateEnd.</i>
<a name="api_inflateEnd-1"/><a name="547"/>  547: <b>api_inflateEnd</b>(Config) when is_list(Config) -&gt;
<a name="548"/>  548:     Z1 = zlib:open(),
<a name="549"/>  549:     ?m(?EXIT(not_initialized), zlib:inflateEnd(Z1)),
<a name="550"/>  550:     ?m(ok, zlib:inflateInit(Z1)),
<a name="551"/>  551:     ?m(?EXIT(badarg), zlib:inflateEnd(gurka)),
<a name="552"/>  552:     ?m(?EXIT(data_error), zlib:inflateEnd(Z1)),
<a name="553"/>  553:     ?m(?EXIT(not_initialized), zlib:inflateEnd(Z1)),
<a name="554"/>  554:     ?m(ok, zlib:inflateInit(Z1)),
<a name="555"/>  555:     ?m(B when is_list(B), zlib:inflate(Z1, zlib:compress(&quot;abc&quot;))),
<a name="556"/>  556:     ?m(ok, zlib:inflateEnd(Z1)),
<a name="api_inflateEnd-last_expr"/><a name="557"/>  557: <b>    ?m</b>(ok, zlib:close(Z1)).
<a name="558"/>  558: 
<a name="559"/>  559: <i>%% Test crc32.</i>
<a name="api_crc32-1"/><a name="560"/>  560: <b>api_crc32</b>(Config) when is_list(Config) -&gt;
<a name="561"/>  561:     Z1 = zlib:open(),
<a name="562"/>  562:     ?m(ok, zlib:deflateInit(Z1,best_speed,deflated,-15,8,default)),
<a name="563"/>  563:     Bin = &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;,
<a name="564"/>  564:     Compressed1 = ?m(L when is_list(L), zlib:deflate(Z1, Bin, none)),
<a name="565"/>  565:     Compressed2 = ?m(L when is_list(L), zlib:deflate(Z1, &lt;&lt;&gt;&gt;, finish)),
<a name="566"/>  566:     Compressed = list_to_binary(Compressed1 ++ Compressed2),
<a name="567"/>  567:     CRC1 = ?m( CRC1 when is_integer(CRC1), zlib:crc32(Z1)),
<a name="568"/>  568:     ?m(CRC1 when is_integer(CRC1), zlib:crc32(Z1,Bin)),
<a name="569"/>  569:     ?m(CRC1 when is_integer(CRC1), zlib:crc32(Z1,binary_to_list(Bin))),
<a name="570"/>  570:     ?m(CRC2 when is_integer(CRC2), zlib:crc32(Z1,Compressed)),
<a name="571"/>  571:     CRC2 = ?m(CRC2 when is_integer(CRC2), zlib:crc32(Z1,0,Compressed)),
<a name="572"/>  572:     ?m(CRC3 when CRC2 /= CRC3, zlib:crc32(Z1,234,Compressed)),
<a name="573"/>  573:     ?m(?EXIT(badarg), zlib:crc32(gurka)),
<a name="574"/>  574:     ?m(?EXIT(badarg), zlib:crc32(Z1, not_a_binary)),
<a name="575"/>  575:     ?m(?EXIT(badarg), zlib:crc32(gurka, &lt;&lt;1,1,2,4,4&gt;&gt;)),
<a name="576"/>  576:     ?m(?EXIT(badarg), zlib:crc32(Z1, 2298929, not_a_binary)),
<a name="577"/>  577:     ?m(?EXIT(badarg), zlib:crc32(Z1, not_an_int, &lt;&lt;123,123,123,35,231&gt;&gt;)),
<a name="578"/>  578:     ?m(?EXIT(badarg), zlib:crc32_combine(Z1, not_an_int, 123123, 123)),
<a name="579"/>  579:     ?m(?EXIT(badarg), zlib:crc32_combine(Z1, noint, 123123, 123)),
<a name="580"/>  580:     ?m(?EXIT(badarg), zlib:crc32_combine(Z1, 123123, noint, 123)),
<a name="581"/>  581:     ?m(?EXIT(badarg), zlib:crc32_combine(Z1, 123123, 123, noint)),
<a name="582"/>  582:     ?m(ok, zlib:deflateEnd(Z1)),
<a name="api_crc32-last_expr"/><a name="583"/>  583: <b>    ?m</b>(ok, zlib:close(Z1)).    
<a name="584"/>  584: 
<a name="585"/>  585: <i>%% Test adler32.</i>
<a name="api_adler32-1"/><a name="586"/>  586: <b>api_adler32</b>(Config) when is_list(Config) -&gt;
<a name="587"/>  587:     Z1 = zlib:open(),
<a name="588"/>  588:     ?m(ok, zlib:deflateInit(Z1,best_speed,deflated,-15,8,default)),
<a name="589"/>  589:     Bin = &lt;&lt;1,1,1,1,1,1,1,1,1&gt;&gt;,
<a name="590"/>  590:     Compressed1 = ?m(L when is_list(L), zlib:deflate(Z1, Bin, none)),
<a name="591"/>  591:     Compressed2 = ?m(L when is_list(L), zlib:deflate(Z1, &lt;&lt;&gt;&gt;, finish)),
<a name="592"/>  592:     Compressed = list_to_binary(Compressed1 ++ Compressed2),
<a name="593"/>  593:     ?m(ADLER1 when is_integer(ADLER1), zlib:adler32(Z1,Bin)),
<a name="594"/>  594:     ?m(ADLER1 when is_integer(ADLER1), zlib:adler32(Z1,binary_to_list(Bin))),
<a name="595"/>  595:     ADLER2 = ?m(ADLER2 when is_integer(ADLER2), zlib:adler32(Z1,Compressed)),
<a name="596"/>  596:     ?m(ADLER2 when is_integer(ADLER2), zlib:adler32(Z1,1,Compressed)),
<a name="597"/>  597:     ?m(ADLER3 when ADLER2 /= ADLER3, zlib:adler32(Z1,234,Compressed)),
<a name="598"/>  598:     ?m(?EXIT(badarg), zlib:adler32(Z1, not_a_binary)),
<a name="599"/>  599:     ?m(?EXIT(badarg), zlib:adler32(gurka, &lt;&lt;1,1,2,4,4&gt;&gt;)),
<a name="600"/>  600:     ?m(?EXIT(badarg), zlib:adler32(Z1, 2298929, not_a_binary)),
<a name="601"/>  601:     ?m(?EXIT(badarg), zlib:adler32(Z1, not_an_int, &lt;&lt;123,123,123,35,231&gt;&gt;)),
<a name="602"/>  602:     ?m(?EXIT(badarg), zlib:adler32_combine(Z1, noint, 123123, 123)),
<a name="603"/>  603:     ?m(?EXIT(badarg), zlib:adler32_combine(Z1, 123123, noint, 123)),
<a name="604"/>  604:     ?m(?EXIT(badarg), zlib:adler32_combine(Z1, 123123, 123, noint)),
<a name="605"/>  605:     ?m(ok, zlib:deflateEnd(Z1)),
<a name="api_adler32-last_expr"/><a name="606"/>  606: <b>    ?m</b>(ok, zlib:close(Z1)).    
<a name="607"/>  607: 
<a name="608"/>  608: <i>%% Test compress.</i>
<a name="api_un_compress-1"/><a name="609"/>  609: <b>api_un_compress</b>(Config) when is_list(Config) -&gt;
<a name="610"/>  610:     ?m(?EXIT(badarg),zlib:compress(not_a_binary)),
<a name="611"/>  611:     Bin = &lt;&lt;1,11,1,23,45&gt;&gt;,
<a name="612"/>  612:     Comp = zlib:compress(Bin),
<a name="613"/>  613:     ?m(?EXIT(badarg),zlib:uncompress(not_a_binary)),
<a name="614"/>  614:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;171,171,171,171,171&gt;&gt;)),
<a name="615"/>  615:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;&gt;&gt;)),
<a name="616"/>  616:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;120&gt;&gt;)),
<a name="617"/>  617:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;120,156&gt;&gt;)),
<a name="618"/>  618:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;120,156,3&gt;&gt;)),
<a name="619"/>  619:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;120,156,3,0&gt;&gt;)),
<a name="620"/>  620:     ?m(?EXIT(data_error), zlib:uncompress(&lt;&lt;0,156,3,0,0,0,0,1&gt;&gt;)),
<a name="621"/>  621:     ?m(Bin, zlib:uncompress(binary_to_list(Comp))),
<a name="api_un_compress-last_expr"/><a name="622"/>  622: <b>    ?m</b>(Bin, zlib:uncompress(Comp)).
<a name="623"/>  623: 
<a name="624"/>  624: <i>%% Test zip.</i>
<a name="api_un_zip-1"/><a name="625"/>  625: <b>api_un_zip</b>(Config) when is_list(Config) -&gt;
<a name="626"/>  626:     ?m(?EXIT(badarg),zlib:zip(not_a_binary)),
<a name="627"/>  627:     Bin = &lt;&lt;1,11,1,23,45&gt;&gt;,
<a name="628"/>  628:     Comp = zlib:zip(Bin),
<a name="629"/>  629:     ?m(Comp, zlib:zip(binary_to_list(Bin))),
<a name="630"/>  630:     ?m(?EXIT(badarg),zlib:unzip(not_a_binary)),
<a name="631"/>  631:     ?m(?EXIT(data_error), zlib:unzip(&lt;&lt;171,171,171,171,171&gt;&gt;)),
<a name="632"/>  632:     ?m(?EXIT(data_error), zlib:unzip(&lt;&lt;&gt;&gt;)),
<a name="633"/>  633:     ?m(Bin, zlib:unzip(Comp)),
<a name="634"/>  634:     ?m(Bin, zlib:unzip(binary_to_list(Comp))),
<a name="635"/>  635: 
<a name="636"/>  636:     %% OTP-6396
<a name="637"/>  637:     B =
<a name="638"/>  638:         &lt;&lt;131,104,19,100,0,13,99,95,99,105,100,95,99,115,103,115,110,95,50,97,
<a name="639"/>  639:           1,107,0,4,208,161,246,29,107,0,3,237,166,224,107,0,6,66,240,153,0,2,
<a name="640"/>  640:           10,1,0,8,97,116,116,97,99,104,101,100,104,2,100,0,22,117,112,100,97,
<a name="641"/>  641:           116,101,95,112,100,112,95,99,111,110,116,101,120,116,95,114,101,113,
<a name="642"/>  642:           107,0,114,69,3,12,1,11,97,31,113,150,64,104,132,61,64,104,12,3,197,
<a name="643"/>  643:           31,113,150,64,104,132,61,64,104,12,1,11,97,31,115,150,64,104,116,73,
<a name="644"/>  644:           64,104,0,0,0,0,0,0,65,149,16,61,65,149,16,61,1,241,33,4,5,0,33,4,4,10
<a name="645"/>  645:           ,6,10,181,4,10,6,10,181,38,15,99,111,109,109,97,110,100,1,114,45,97,
<a name="646"/>  646:           112,110,45,49,3,99,111,109,5,109,110,99,57,57,6,109,99,99,50,52,48,4,
<a name="647"/>  647:           103,112,114,115,8,0,104,2,104,2,100,0,8,97,99,116,105,118,97,116,101,
<a name="648"/>  648:           104,23,100,0,11,112,100,112,95,99,111,110,116,1,120,116,100,0,7,112,
<a name="649"/>  649:           114,105,109,97,114,121,97,1,100,0,9,117,110,100,101,102,105,110,101,
<a name="650"/>  650:           100,97,1,97,4,97,4,97,7,100,0,9,117,110,100,101,102,105,110,101,100,
<a name="651"/>  651:           100,0,9,117,110,100,101,102,105,110,10100,100,0,9,117,110,100,101,
<a name="652"/>  652:           102,105,110,101,100,100,0,5,102,97,108,115,101,100,0,9,117,110,100,
<a name="653"/>  653:           101,102,105,110,101,100,100,0,9,117,110,100,101,102,105,110,101,100,
<a name="654"/>  654:           100,0,9,117,110,100,101,102,105,1,101,100,97,0,100,0,9,117,110,100,
<a name="655"/>  655:           101,102,105,110,101,100,107,0,4,16,0,1,144,107,0,4,61,139,186,181,
<a name="656"/>  656:           107,0,4,10,8,201,49,100,0,9,117,110,100,101,102,105,110,101,100,100,
<a name="657"/>  657:           0,9,117,110,100,101,102,105,0,101,100,100,0,9,117,110,100,101,102,
<a name="658"/>  658:           105,110,101,100,104,2,104,3,98,0,0,7,214,97,11,97,20,104,3,97,17,97,
<a name="659"/>  659:           16,97,21,106,108,0,0,0,3,104,2,97,1,104,2,104,3,98,0,0,7,214,97,11,
<a name="660"/>  660:           97,20,104,3,97,17,97,167,20,104,2,97,4,104,2,104,3,98,0,0,7,214,97,
<a name="661"/>  661:           11,97,20,104,3,97,17,97,16,97,21,104,2,97,10,104,2,104,3,98,0,0,7,
<a name="662"/>  662:           214,97,11,97,20,104,3,97,17,97,16,97,26,106,100,0,5,118,101,114,57,
<a name="663"/>  663:           57,100,0,9,117,110,0,101,102,105,110,101,100,107,0,2,0,244,107,0,4,
<a name="664"/>  664:           10,6,102,195,107,0,4,10,6,102,195,100,0,9,117,110,100,101,102,105,
<a name="665"/>  665:           110,101,100,100,0,9,117,110,100,101,102,105,110,101,100,107,0,125,
<a name="666"/>  666:           248,143,0,203,25115,157,116,65,185,65,172,55,87,164,88,225,50,203,
<a name="667"/>  667:           251,115,157,116,65,185,65,172,55,87,164,88,225,50,0,0,82,153,50,0,
<a name="668"/>  668:           200,98,87,148,237,193,185,65,149,167,69,144,14,16,153,50,3,81,70,94,
<a name="669"/>  669:           13,109,193,1,120,5,181,113,198,118,50,3,81,70,94,13,109,193,185,120,
<a name="670"/>  670:           5,181,113,198,118,153,3,81,70,94,13,109,193,185,120,5,181,113,198,
<a name="671"/>  671:           118,153,50,16,1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,113,92,2,119,128,0,0,
<a name="672"/>  672:           108,0,0,1,107,0,114,69,3,12,1,11,97,31,113,150,64,104,132,61,64,104,
<a name="673"/>  673:           12,3,11,97,31,113,150,64,104,132,61,64,104,12,1,11,97,31,115,150,64,
<a name="674"/>  674:           104,116,73,64,104,0,0,0,0,0,0,65,149,16,61,65,149,16,61,1,241,33,4,0,
<a name="675"/>  675:           33,4,4,10,6,10,181,4,10,6,10,181,38,15,99,111,109,109,97,110,100,101,
<a name="676"/>  676:           114,45,97,112,110,45,49,3,99,111,109,5,109,110,99,57,57,6,109,99,99,
<a name="677"/>  677:           50,52,48,4,103,112,114,115,8,0,106&gt;&gt;,
<a name="678"/>  678: 
<a name="679"/>  679:     Z = zlib:zip(B),
<a name="api_un_zip-last_expr"/><a name="680"/>  680: <b>    ?m</b>(B, zlib:unzip(Z)).
<a name="681"/>  681: 
<a name="682"/>  682: <i>%% Test gunzip.</i>
<a name="api_g_un_zip-1"/><a name="683"/>  683: <b>api_g_un_zip</b>(Config) when is_list(Config) -&gt;
<a name="684"/>  684:     ?m(?EXIT(badarg),zlib:gzip(not_a_binary)),
<a name="685"/>  685:     Bin = &lt;&lt;1,11,1,23,45&gt;&gt;,
<a name="686"/>  686:     Comp = zlib:gzip(Bin),
<a name="687"/>  687: 
<a name="688"/>  688:     ?m(Comp, zlib:gzip(binary_to_list(Bin))),
<a name="689"/>  689:     ?m(?EXIT(badarg), zlib:gunzip(not_a_binary)),
<a name="690"/>  690:     ?m(?EXIT(data_error), zlib:gunzip(&lt;&lt;171,171,171,171,171&gt;&gt;)),
<a name="691"/>  691:     ?m(?EXIT(data_error), zlib:gunzip(&lt;&lt;&gt;&gt;)),
<a name="692"/>  692:     ?m(Bin, zlib:gunzip(Comp)),
<a name="693"/>  693:     ?m(Bin, zlib:gunzip(binary_to_list(Comp))),
<a name="694"/>  694: 
<a name="695"/>  695:     %% RFC 1952:
<a name="696"/>  696:     %%
<a name="697"/>  697:     %% &quot;A gzip file consists of a series of &quot;members&quot; (compressed data
<a name="698"/>  698:     %% sets). [...] The members simply appear one after another in the file,
<a name="699"/>  699:     %% with no additional information before, between, or after them.&quot;
<a name="700"/>  700:     Concatenated = &lt;&lt;Bin/binary, Bin/binary&gt;&gt;,
<a name="701"/>  701:     ?m(Concatenated, zlib:gunzip([Comp, Comp])),
<a name="702"/>  702: 
<a name="703"/>  703:     %% Don't explode if the uncompressed size is a perfect multiple of the
<a name="704"/>  704:     %% internal inflate chunk size.
<a name="705"/>  705:     ChunkSizedData = &lt;&lt;0:16384/unit:8&gt;&gt;,
<a name="706"/>  706:     ?m(ChunkSizedData, zlib:gunzip(zlib:gzip(ChunkSizedData))),
<a name="707"/>  707: 
<a name="708"/>  708:     %% Bad CRC; bad length.
<a name="709"/>  709:     BadCrc = bad_crc_data(),
<a name="710"/>  710:     ?m(?EXIT(data_error),(catch zlib:gunzip(BadCrc))),
<a name="711"/>  711:     BadLen = bad_len_data(),
<a name="712"/>  712:     ?m(?EXIT(data_error),(catch zlib:gunzip(BadLen))),
<a name="api_g_un_zip-last_expr"/><a name="713"/>  713:     ok.
<a name="714"/>  714: 
<a name="bad_crc_data-0"/><a name="715"/>  715: <b>bad_crc_data</b>() -&gt;
<a name="716"/>  716:     %% zlib:zip(&lt;&lt;42&gt;&gt;), one byte changed.
<a name="bad_crc_data-last_expr"/><a name="717"/>  717:     &lt;&lt;31,139,8,0,0,0,0,0,0,3,211,2,0,91,39,185,9,1,0,0,0&gt;&gt;.
<a name="718"/>  718: 
<a name="bad_len_data-0"/><a name="719"/>  719: <b>bad_len_data</b>() -&gt;
<a name="720"/>  720:     %% zlib:zip(&lt;&lt;42&gt;&gt;), one byte changed.
<a name="bad_len_data-last_expr"/><a name="721"/>  721:     &lt;&lt;31,139,8,0,0,0,0,0,0,3,211,2,0,91,38,185,9,2,0,0,0&gt;&gt;.
<a name="722"/>  722: 
<a name="723"/>  723: 
<a name="intro-1"/><a name="724"/>  724: <b>intro</b>(Config) when is_list(Config) -&gt;
<a name="725"/>  725:     D = &lt;&lt;&quot;This is a binary&quot;&gt;&gt;,
<a name="726"/>  726:     [put({ex, N}, &lt;&lt;&quot;This is a binary&quot;&gt;&gt;) || N &lt;- [0,1,2,3,4]],
<a name="727"/>  727:     put({ex, 5}, end_of_data),
<a name="728"/>  728:     put(ex,0),
<a name="729"/>  729:     Read = fun() -&gt;
<a name="730"/>  730: 		   N = get(ex),
<a name="731"/>  731: 		   put(ex,N+1),
<a name="732"/>  732: 		   get({ex,N})
<a name="733"/>  733: 	   end,
<a name="734"/>  734: 
<a name="735"/>  735:     Z = zlib:open(),
<a name="736"/>  736:     ok = zlib:deflateInit(Z,default),
<a name="737"/>  737: 
<a name="738"/>  738:     Compress = fun(end_of_data, _Cont) -&gt; [];
<a name="739"/>  739: 		  (Data, Cont) -&gt;
<a name="740"/>  740: 		       [zlib:deflate(Z, Data)|Cont(Read(),Cont)]
<a name="741"/>  741: 	       end,
<a name="742"/>  742:     Compressed = Compress(Read(),Compress),
<a name="743"/>  743:     Last = zlib:deflate(Z, [], finish),
<a name="744"/>  744:     ok = zlib:deflateEnd(Z),
<a name="745"/>  745:     zlib:close(Z),
<a name="746"/>  746:     Res = list_to_binary([Compressed|Last]),
<a name="747"/>  747:     Orig = list_to_binary(lists:duplicate(5, D)),
<a name="intro-last_expr"/><a name="748"/>  748: <b>    ?m</b>(Orig, zlib:uncompress(Res)).
<a name="749"/>  749: 
<a name="750"/>  750: 
<a name="751"/>  751: <i>%% Test deflate large file, which had a bug reported on erlang-bugs.</i>
<a name="large_deflate-1"/><a name="752"/>  752: <b>large_deflate</b>(Config) when is_list(Config) -&gt;
<a name="large_deflate-last_expr"/><a name="753"/>  753: <b>    large_deflate_do</b>().
<a name="large_deflate_do-0"/><a name="754"/>  754: <b>large_deflate_do</b>() -&gt;
<a name="755"/>  755:     Plain = gen_determ_rand_bytes(64 bsl 10),
<a name="756"/>  756:     Deflated = zlib:zip(Plain),
<a name="large_deflate_do-last_expr"/><a name="757"/>  757: <b>    ?m</b>(Plain, zlib:unzip(Deflated)).
<a name="758"/>  758: 
<a name="759"/>  759: <i>%% Test a standard compressed zip file.</i>
<a name="zip_usage-1"/><a name="760"/>  760: <b>zip_usage</b>(Config) when is_list(Config) -&gt;
<a name="761"/>  761:     zip_usage(zip_usage({get_arg,Config}));
<a name="762"/>  762: <b>zip_usage</b>({get_arg,Config}) -&gt;
<a name="763"/>  763:     Out = get_data_dir(Config),
<a name="764"/>  764:     {ok,ZIP} = file:read_file(filename:join(Out,&quot;zipdoc.zip&quot;)),
<a name="765"/>  765:     {ok,ORIG} = file:read_file(filename:join(Out,&quot;zipdoc&quot;)),
<a name="766"/>  766:     {run,ZIP,ORIG};
<a name="767"/>  767: <b>zip_usage</b>({run,ZIP,ORIG}) -&gt;    
<a name="768"/>  768:     &lt;&lt;_:14/binary, CRC:32/little,
<a name="769"/>  769:       CompSz:32/little, UnCompSz:32/little,_:31/binary,
<a name="770"/>  770:       Compressed:CompSz/binary, _/binary&gt;&gt; = ZIP,
<a name="771"/>  771: 
<a name="772"/>  772:     %%io:format(&quot;CRC ~p CSz ~p UnCSz ~p ~n&quot;, [CRC,CompSz,UnCompSz]),
<a name="773"/>  773:     Split = split_bin(Compressed,[]),
<a name="774"/>  774:     Z = zlib:open(),
<a name="775"/>  775: 
<a name="776"/>  776:     ?m(ok, zlib:inflateInit(Z, -15)),
<a name="777"/>  777:     Bs = [zlib:inflate(Z, Part) || Part &lt;- Split],
<a name="778"/>  778:     UC0 = list_to_binary(Bs),
<a name="779"/>  779:     ?m(UnCompSz, byte_size(UC0)),
<a name="780"/>  780:     ?m(CRC, zlib:crc32(Z)),
<a name="781"/>  781:     ?m(true, zlib:crc32(Z,UC0) == zlib:crc32(Z,ORIG)),
<a name="782"/>  782:     ?m(ok, zlib:inflateEnd(Z)),
<a name="783"/>  783: 
<a name="784"/>  784:     UC1 = zlib:unzip(Compressed),
<a name="785"/>  785:     ?m(UnCompSz, byte_size(UC1)),
<a name="786"/>  786:     ?m(true, zlib:crc32(Z,UC1) == zlib:crc32(Z,ORIG)),
<a name="787"/>  787: 
<a name="788"/>  788:     ?m(ok, zlib:inflateInit(Z, -15)),
<a name="789"/>  789:     UC2 = zlib:inflate(Z, Compressed),
<a name="790"/>  790:     ?m(UnCompSz, byte_size(list_to_binary(UC2))),
<a name="791"/>  791:     ?m(CRC, zlib:crc32(Z)),
<a name="792"/>  792:     ?m(true, zlib:crc32(Z,UC2) == zlib:crc32(Z,ORIG)),
<a name="793"/>  793:     ?m(ok, zlib:inflateEnd(Z)),
<a name="794"/>  794: 
<a name="795"/>  795:     ?m(ok, zlib:inflateInit(Z, -15)),
<a name="796"/>  796:     UC3 = zlib:inflate(Z, Split), % Test multivec.
<a name="797"/>  797:     ?m(UnCompSz, byte_size(list_to_binary(UC3))),
<a name="798"/>  798:     ?m(true, zlib:crc32(Z,UC3) == zlib:crc32(Z,ORIG)),
<a name="799"/>  799:     ?m(CRC, zlib:crc32(Z)),
<a name="800"/>  800:     ?m(ok, zlib:inflateEnd(Z)),
<a name="801"/>  801: 
<a name="802"/>  802:     ?m(ok, zlib:inflateInit(Z, -15)),
<a name="803"/>  803:     ?m(ok, zlib:setBufSize(Z, UnCompSz *2)),
<a name="804"/>  804:     UC4 = zlib:inflate(Z, Compressed),
<a name="805"/>  805:     ?m(UnCompSz, byte_size(list_to_binary(UC4))),
<a name="806"/>  806:     ?m(CRC, zlib:crc32(Z)),
<a name="807"/>  807:     ?m(CRC, zlib:crc32(Z,UC4)),
<a name="808"/>  808:     ?m(true, zlib:crc32(Z,UC4) == zlib:crc32(Z,ORIG)),
<a name="809"/>  809:     ?m(ok, zlib:inflateEnd(Z)),
<a name="810"/>  810: 
<a name="811"/>  811:     C1 = zlib:zip(ORIG),
<a name="812"/>  812:     UC5 =  zlib:unzip(C1),
<a name="813"/>  813:     ?m(CRC, zlib:crc32(Z,UC5)),
<a name="814"/>  814:     ?m(true,zlib:crc32(Z,UC5) == zlib:crc32(Z,ORIG)),
<a name="815"/>  815: 
<a name="816"/>  816:     ?m(ok, zlib:deflateInit(Z, default, deflated, -15, 8, default)),
<a name="817"/>  817:     C2 = zlib:deflate(Z, ORIG, finish),
<a name="818"/>  818:     ?m(ORIG, zlib:unzip(C2)),
<a name="819"/>  819:     ?m(ok, zlib:deflateEnd(Z)),
<a name="820"/>  820: 
<a name="821"/>  821:     ?m(ok, zlib:deflateInit(Z, none, deflated, -15, 8, filtered)),
<a name="822"/>  822:     ?m(ok, zlib:deflateParams(Z, default, default)),
<a name="823"/>  823:     C3 = zlib:deflate(Z, ORIG, finish),
<a name="824"/>  824:     ?m(ORIG, zlib:unzip(C3)),
<a name="825"/>  825:     ?m(ok, zlib:deflateEnd(Z)),
<a name="826"/>  826: 
<a name="827"/>  827:     ok = zlib:close(Z),
<a name="zip_usage-last_expr"/><a name="828"/>  828:     ok.
<a name="829"/>  829: 
<a name="830"/>  830: <i>%% Test a standard compressed gzipped file.</i>
<a name="gz_usage-1"/><a name="831"/>  831: <b>gz_usage</b>(Config) when is_list(Config) -&gt;
<a name="832"/>  832:     gz_usage(gz_usage({get_arg,Config}));
<a name="833"/>  833: <b>gz_usage</b>({get_arg,Config}) -&gt;
<a name="834"/>  834:     Out = get_data_dir(Config),
<a name="835"/>  835:     {ok,GZIP} = file:read_file(filename:join(Out,&quot;zipdoc.1.gz&quot;)),
<a name="836"/>  836:     {ok,ORIG} = file:read_file(filename:join(Out,&quot;zipdoc&quot;)),
<a name="837"/>  837:     {ok,GZIP2} = file:read_file(filename:join(Out,&quot;zipdoc.txt.gz&quot;)),
<a name="838"/>  838:     {run,GZIP,ORIG,GZIP2};    
<a name="839"/>  839: <b>gz_usage</b>({run,GZIP,ORIG,GZIP2}) -&gt;
<a name="840"/>  840:     Z = zlib:open(),
<a name="841"/>  841:     UC1 = zlib:gunzip(GZIP),
<a name="842"/>  842:     ?m(true,zlib:crc32(Z,UC1) == zlib:crc32(Z,ORIG)),
<a name="843"/>  843:     UC3 = zlib:gunzip(GZIP2),
<a name="844"/>  844:     ?m(true,zlib:crc32(Z,UC3) == zlib:crc32(Z,ORIG)),
<a name="845"/>  845:     Compressed = zlib:gzip(ORIG),
<a name="846"/>  846:     UC5 = zlib:gunzip(Compressed),
<a name="847"/>  847:     ?m(true,zlib:crc32(Z,UC5) == zlib:crc32(Z,ORIG)),
<a name="gz_usage-last_expr"/><a name="848"/>  848: <b>    ok = zlib:close</b>(Z).
<a name="849"/>  849: 
<a name="850"/>  850: <i>%% Test more of a standard compressed gzipped file.</i>
<a name="gz_usage2-1"/><a name="851"/>  851: <b>gz_usage2</b>(Config) -&gt;
<a name="gz_usage2-last_expr"/><a name="852"/>  852: <b>    case os:find_executable</b>(&quot;gzip&quot;) of
<a name="853"/>  853: 	Name when is_list(Name) -&gt;
<a name="854"/>  854: 	    Z = zlib:open(),
<a name="855"/>  855: 	    Out = get_data_dir(Config),
<a name="856"/>  856: 	    {ok,ORIG} = file:read_file(filename:join(Out,&quot;zipdoc&quot;)),
<a name="857"/>  857: 	    Compressed = zlib:gzip(ORIG),
<a name="858"/>  858: 	    GzOutFile = filename:join(Out,&quot;out.gz&quot;),
<a name="859"/>  859: 	    OutFile = filename:join(Out,&quot;out.txt&quot;),
<a name="860"/>  860: 	    ?m(ok, file:write_file(GzOutFile,Compressed)),
<a name="861"/>  861: 	    os:cmd(&quot;gzip -c -d &quot; ++ GzOutFile ++ &quot; &gt; &quot; ++ OutFile),
<a name="862"/>  862: 	    case file:read_file(OutFile) of
<a name="863"/>  863: 		{ok,ExtDecompressed} -&gt;
<a name="864"/>  864: 		    ?m(true, 
<a name="865"/>  865: 		       zlib:crc32(Z,ExtDecompressed) == zlib:crc32(Z,ORIG));
<a name="866"/>  866: 		Error -&gt;
<a name="867"/>  867: 		    io:format(&quot;Couldn't test external decompressor ~p\n&quot;, 
<a name="868"/>  868: 			      [Error])
<a name="869"/>  869: 	    end,
<a name="870"/>  870: 	    ok = zlib:close(Z),
<a name="871"/>  871: 	    ok;
<a name="872"/>  872: 	false -&gt;
<a name="873"/>  873: 	    {skipped,&quot;No gzip in path&quot;}
<a name="874"/>  874:     end.
<a name="875"/>  875: 
<a name="876"/>  876: 
<a name="877"/>  877: 
<a name="878"/>  878: <i>%% Test that (de)compress funcs work with standard tools, for example</i>
<a name="879"/>  879: <i>%% a chunk from a png file.</i>
<a name="compress_usage-1"/><a name="880"/>  880: <b>compress_usage</b>(Config) when is_list(Config) -&gt;
<a name="881"/>  881:     compress_usage(compress_usage({get_arg,Config}));
<a name="882"/>  882: <b>compress_usage</b>({get_arg,Config}) -&gt;
<a name="883"/>  883:     Out = get_data_dir(Config),
<a name="884"/>  884:     {ok,C1} = file:read_file(filename:join(Out,&quot;png-compressed.zlib&quot;)),
<a name="885"/>  885:     {run,C1};
<a name="886"/>  886: <b>compress_usage</b>({run,C1}) -&gt;
<a name="887"/>  887:     Z = zlib:open(),
<a name="888"/>  888:     %% See that we can uncompress a file generated with external prog.
<a name="889"/>  889:     UC1 = zlib:uncompress(C1),
<a name="890"/>  890:     %% Check that the crc are correct.
<a name="891"/>  891:     ?m(4125865008,zlib:crc32(Z,UC1)),
<a name="892"/>  892:     C2 = zlib:compress(UC1),
<a name="893"/>  893:     UC2 = zlib:uncompress(C2),
<a name="894"/>  894:     %% Check that the crc are correct.
<a name="895"/>  895:     ?m(4125865008,zlib:crc32(Z,UC2)),
<a name="896"/>  896: 
<a name="897"/>  897:     ok = zlib:close(Z),
<a name="898"/>  898: 
<a name="899"/>  899:     D = [&lt;&lt;&quot;We tests some partial&quot;&gt;&gt;,
<a name="900"/>  900: 	 &lt;&lt;&quot;data, sent over&quot;&gt;&gt;,
<a name="901"/>  901: 	 &lt;&lt;&quot;the stream&quot;&gt;&gt;,
<a name="902"/>  902: 	 &lt;&lt;&quot;we check that we can unpack&quot;&gt;&gt;,
<a name="903"/>  903: 	 &lt;&lt;&quot;every message we get&quot;&gt;&gt;],
<a name="904"/>  904: 
<a name="905"/>  905:     ZC = zlib:open(),
<a name="906"/>  906:     ZU = zlib:open(),
<a name="907"/>  907:     Test = fun(finish, {_,Tot}) -&gt;
<a name="908"/>  908: 		   Compressed = zlib:deflate(ZC, &lt;&lt;&gt;&gt;, finish),
<a name="909"/>  909: 		   Data = zlib:inflate(ZU, Compressed),
<a name="910"/>  910: 		   [Tot|Data];
<a name="911"/>  911: 	      (Data, {Op,Tot}) -&gt;
<a name="912"/>  912: 		   Compressed = zlib:deflate(ZC, Data, Op),
<a name="913"/>  913: 		   Res1 = ?m([Data],zlib:inflate(ZU, Compressed)),
<a name="914"/>  914: 		   {Op, [Tot|Res1]}
<a name="915"/>  915: 	   end,
<a name="916"/>  916:     zlib:deflateInit(ZC),
<a name="917"/>  917:     zlib:inflateInit(ZU),
<a name="918"/>  918:     T1 = lists:foldl(Test,{sync,[]},D++[finish]),
<a name="919"/>  919:     ?m(true, list_to_binary(D) == list_to_binary(T1)),
<a name="920"/>  920:     zlib:deflateEnd(ZC),
<a name="921"/>  921:     zlib:inflateEnd(ZU),
<a name="922"/>  922: 
<a name="923"/>  923:     zlib:deflateInit(ZC),
<a name="924"/>  924:     zlib:inflateInit(ZU),
<a name="925"/>  925:     T2 = lists:foldl(Test,{full,[]},D++[finish]),
<a name="926"/>  926:     ?m(true, list_to_binary(D) == list_to_binary(T2)),
<a name="927"/>  927:     zlib:deflateEnd(ZC),
<a name="928"/>  928:     zlib:inflateEnd(ZU),
<a name="929"/>  929: 
<a name="930"/>  930:     ok = zlib:close(ZC),
<a name="compress_usage-last_expr"/><a name="931"/>  931: <b>    ok = zlib:close</b>(ZU).
<a name="932"/>  932: 
<a name="933"/>  933: 
<a name="934"/>  934: <i>%% Check that crc works as expected.</i>
<a name="crc-1"/><a name="935"/>  935: <b>crc</b>(Config) when is_list(Config) -&gt;
<a name="936"/>  936:     crc(crc({get_arg,Config}));
<a name="937"/>  937: <b>crc</b>({get_arg,Config}) -&gt;
<a name="938"/>  938:     Out = get_data_dir(Config),
<a name="939"/>  939:     {ok,C1} = file:read_file(filename:join(Out,&quot;zipdoc&quot;)),
<a name="940"/>  940:     {run,C1};
<a name="941"/>  941: <b>crc</b>({run,C1}) -&gt;
<a name="942"/>  942:     Z = zlib:open(),
<a name="943"/>  943:     Crc = zlib:crc32(Z, C1),
<a name="944"/>  944:     Bins = split_bin(C1,[]),
<a name="945"/>  945:     %%io:format(&quot;Length ~p ~p ~n&quot;, [length(Bins), [size(Bin) || Bin &lt;- Bins]]),
<a name="946"/>  946:     Last = lists:last(Bins),
<a name="947"/>  947:     SCrc = lists:foldl(fun(Bin,Crc0) -&gt;  
<a name="948"/>  948: 			       Crc1 = zlib:crc32(Z, Crc0, Bin),
<a name="949"/>  949: 			       ?m(false, Crc == Crc1 andalso Bin /= Last),
<a name="950"/>  950: 			       Crc1
<a name="951"/>  951: 		       end, 0, Bins),
<a name="952"/>  952:     ?m(Crc,SCrc),
<a name="953"/>  953:     [First|Rest] = Bins,
<a name="954"/>  954:     Combine = fun(Bin, CS1) -&gt;
<a name="955"/>  955: 		      CS2 = zlib:crc32(Z, Bin),
<a name="956"/>  956: 		      S2 = byte_size(Bin),
<a name="957"/>  957: 		      zlib:crc32_combine(Z,CS1,CS2,S2)
<a name="958"/>  958: 	      end,
<a name="959"/>  959:     Comb = lists:foldl(Combine, zlib:crc32(Z, First), Rest),
<a name="960"/>  960:     ?m(Crc,Comb),
<a name="crc-last_expr"/><a name="961"/>  961: <b>    ok = zlib:close</b>(Z).
<a name="962"/>  962: 
<a name="963"/>  963: <i>%% Check that adler works as expected.</i>
<a name="adler-1"/><a name="964"/>  964: <b>adler</b>(Config) when is_list(Config) -&gt;
<a name="965"/>  965:     adler(adler({get_arg,Config}));
<a name="966"/>  966: <b>adler</b>({get_arg,Config}) -&gt;
<a name="967"/>  967:     Out = get_data_dir(Config),
<a name="968"/>  968:     File1 = filename:join(Out,&quot;zipdoc&quot;),
<a name="969"/>  969:     {ok,C1} = file:read_file(File1),
<a name="970"/>  970:     {run,C1};
<a name="971"/>  971: <b>adler</b>({run,C1}) -&gt;
<a name="972"/>  972:     Z = zlib:open(),
<a name="973"/>  973:     ?m(1, zlib:adler32(Z,&lt;&lt;&gt;&gt;)),
<a name="974"/>  974:     Crc = zlib:adler32(Z, C1),
<a name="975"/>  975:     Bins = split_bin(C1,[]),
<a name="976"/>  976:     Last = lists:last(Bins),
<a name="977"/>  977:     SCrc = lists:foldl(fun(Bin,Crc0) -&gt;  
<a name="978"/>  978: 			       Crc1 = zlib:adler32(Z, Crc0, Bin),
<a name="979"/>  979: 			       ?m(false, Crc == Crc1 andalso Bin /= Last),
<a name="980"/>  980: 			       Crc1
<a name="981"/>  981: 		       end, zlib:adler32(Z,&lt;&lt;&gt;&gt;), Bins),
<a name="982"/>  982:     ?m(Crc,SCrc),
<a name="983"/>  983:     [First|Rest] = Bins,
<a name="984"/>  984:     Combine = fun(Bin, CS1) -&gt;
<a name="985"/>  985: 		      CS2 = zlib:adler32(Z, Bin),
<a name="986"/>  986: 		      S2 = byte_size(Bin),
<a name="987"/>  987: 		      zlib:adler32_combine(Z,CS1,CS2,S2)
<a name="988"/>  988: 	      end,
<a name="989"/>  989:     Comb = lists:foldl(Combine, zlib:adler32(Z, First), Rest),
<a name="990"/>  990:     ?m(Crc,Comb),
<a name="adler-last_expr"/><a name="991"/>  991: <b>    ok = zlib:close</b>(Z).
<a name="992"/>  992: 
<a name="993"/>  993: <i>%% Test dictionary usage.</i>
<a name="dictionary_usage-1"/><a name="994"/>  994: <b>dictionary_usage</b>(Config) when is_list(Config) -&gt;
<a name="995"/>  995:     dictionary_usage(dictionary_usage({get_arg,Config}));
<a name="996"/>  996: <b>dictionary_usage</b>({get_arg,_Config}) -&gt;
<a name="997"/>  997:     {run}; % no args
<a name="998"/>  998: <b>dictionary_usage</b>({run}) -&gt;
<a name="999"/>  999:     Z1 = zlib:open(),
<a name="1000"/> 1000:     Dict = &lt;&lt;&quot;Anka&quot;&gt;&gt;,
<a name="1001"/> 1001:     Data = &lt;&lt;&quot;Kalle Anka&quot;&gt;&gt;,
<a name="1002"/> 1002:     ?m(ok, zlib:deflateInit(Z1)),
<a name="1003"/> 1003:     DictID = zlib:deflateSetDictionary(Z1, Dict),
<a name="1004"/> 1004:     %% io:format(&quot;DictID = ~p\n&quot;, [DictID]),
<a name="1005"/> 1005:     B1 = zlib:deflate(Z1, Data),
<a name="1006"/> 1006:     B2 = zlib:deflate(Z1, &lt;&lt;&gt;&gt;, finish),
<a name="1007"/> 1007:     ?m(ok, zlib:deflateEnd(Z1)),
<a name="1008"/> 1008:     ?m(ok, zlib:close(Z1)),
<a name="1009"/> 1009:     Compressed = list_to_binary([B1,B2]),
<a name="1010"/> 1010:     %% io:format(&quot;~p\n&quot;, [Compressed]),
<a name="1011"/> 1011: 
<a name="1012"/> 1012:     %% Now uncompress.
<a name="1013"/> 1013:     Z2 = zlib:open(),
<a name="1014"/> 1014:     ?m(ok, zlib:inflateInit(Z2)),
<a name="1015"/> 1015: 
<a name="1016"/> 1016:     ?m(?EXIT({need_dictionary, DictID}), zlib:inflate(Z2, Compressed)),
<a name="1017"/> 1017: 
<a name="1018"/> 1018:     ?m(ok, zlib:inflateSetDictionary(Z2, Dict)),
<a name="1019"/> 1019:     ?m(ok, zlib:inflateSetDictionary(Z2, binary_to_list(Dict))),
<a name="1020"/> 1020: 
<a name="1021"/> 1021:     Uncompressed = ?m(B when is_list(B), zlib:inflate(Z2, [])),
<a name="1022"/> 1022: 
<a name="1023"/> 1023:     ?m(ok, zlib:inflateEnd(Z2)),
<a name="1024"/> 1024:     ?m(ok, zlib:close(Z2)),    
<a name="dictionary_usage-last_expr"/><a name="1025"/> 1025: <b>    ?m</b>(Data, list_to_binary(Uncompressed)).
<a name="1026"/> 1026: 
<a name="split_bin-2"/><a name="1027"/> 1027: <b>split_bin</b>(&lt;&lt;Part:1997/binary,Rest/binary&gt;&gt;, Acc) -&gt;
<a name="1028"/> 1028:     split_bin(Rest, [Part|Acc]);
<a name="1029"/> 1029: <b>split_bin</b>(Last,Acc) -&gt;
<a name="split_bin-last_expr"/><a name="1030"/> 1030: <b>    lists:reverse</b>([Last|Acc]).
<a name="1031"/> 1031: 
<a name="only_allow_owner-1"/><a name="1032"/> 1032: <b>only_allow_owner</b>(Config) when is_list(Config) -&gt;
<a name="1033"/> 1033:     Z = zlib:open(),
<a name="1034"/> 1034:     Owner = self(),
<a name="1035"/> 1035: 
<a name="1036"/> 1036:     ?m(ok, zlib:inflateInit(Z)),
<a name="1037"/> 1037:     ?m(ok, zlib:inflateReset(Z)),
<a name="1038"/> 1038: 
<a name="1039"/> 1039:     {Pid, Ref} = spawn_monitor(
<a name="1040"/> 1040:         fun() -&gt;
<a name="1041"/> 1041:             ?m(?EXIT(not_on_controlling_process), zlib:inflateReset(Z)),
<a name="1042"/> 1042:             Owner ! '$transfer_ownership',
<a name="1043"/> 1043:             receive
<a name="1044"/> 1044:                 '$ownership_transferred' -&gt;
<a name="1045"/> 1045:                     ?m(ok, zlib:inflateReset(Z))
<a name="1046"/> 1046:             after 200 -&gt;
<a name="1047"/> 1047:                 ct:fail(&quot;Never received transfer signal.&quot;)
<a name="1048"/> 1048:             end
<a name="1049"/> 1049:         end),
<a name="only_allow_owner-last_expr"/><a name="1050"/> 1050: <b>    ownership_transfer_check</b>(Z, Pid, Ref).
<a name="1051"/> 1051: 
<a name="ownership_transfer_check-3"/><a name="1052"/> 1052: <b>ownership_transfer_check</b>(Z, WorkerPid, Ref) -&gt;
<a name="ownership_transfer_check-last_expr"/><a name="1053"/> 1053:     receive
<a name="1054"/> 1054:         '$transfer_ownership' -&gt;
<a name="1055"/> 1055:             zlib:set_controlling_process(Z, WorkerPid),
<a name="1056"/> 1056:             WorkerPid ! '$ownership_transferred',
<a name="1057"/> 1057:             ownership_transfer_check(Z, WorkerPid, Ref);
<a name="1058"/> 1058:         {'DOWN', Ref, process, WorkerPid, normal} -&gt;
<a name="1059"/> 1059:             ok;
<a name="1060"/> 1060:         {'DOWN', Ref, process, WorkerPid, Reason} -&gt;
<a name="1061"/> 1061:             ct:fail(&quot;Spawned worker crashed with reason ~p.&quot;, [Reason])
<a name="1062"/> 1062:     after 200 -&gt;
<a name="1063"/> 1063:         ct:fail(&quot;Spawned worker timed out.&quot;)
<a name="1064"/> 1064:     end.
<a name="1065"/> 1065: 
<a name="sub_heap_binaries-1"/><a name="1066"/> 1066: <b>sub_heap_binaries</b>(Config) when is_list(Config) -&gt;
<a name="1067"/> 1067:     Compressed = zlib:compress(&lt;&lt;&quot;gurka&quot;&gt;&gt;),
<a name="1068"/> 1068:     ConfLen = erlang:length(Config),
<a name="1069"/> 1069: 
<a name="1070"/> 1070:     HeapBin = &lt;&lt;ConfLen:8/integer, Compressed/binary&gt;&gt;,
<a name="1071"/> 1071:     &lt;&lt;_:8/integer, SubHeapBin/binary&gt;&gt; = HeapBin,
<a name="1072"/> 1072: 
<a name="1073"/> 1073:     ?m(&lt;&lt;&quot;gurka&quot;&gt;&gt;, zlib:uncompress(SubHeapBin)),
<a name="sub_heap_binaries-last_expr"/><a name="1074"/> 1074:     ok.
<a name="1075"/> 1075: 
<a name="1076"/> 1076: <i>%% Check concurrent access to zlib driver.</i>
<a name="smp-1"/><a name="1077"/> 1077: <b>smp</b>(Config) -&gt;
<a name="1078"/> 1078:     NumOfProcs = lists:min([8,erlang:system_info(schedulers)]),
<a name="1079"/> 1079:     io:format(&quot;smp starting ~p workers\n&quot;,[NumOfProcs]),
<a name="1080"/> 1080: 
<a name="1081"/> 1081:     %% Tests to run in parallel.
<a name="1082"/> 1082:     Funcs =
<a name="1083"/> 1083:         [zip_usage, gz_usage, compress_usage, dictionary_usage,
<a name="1084"/> 1084:             crc, adler],
<a name="1085"/> 1085: 
<a name="1086"/> 1086:     %% We get all function arguments here to avoid repeated parallel
<a name="1087"/> 1087:     %% file read access.
<a name="1088"/> 1088:     UsageArgs =
<a name="1089"/> 1089:         list_to_tuple([{F, ?MODULE:F({get_arg,Config})} || F &lt;- Funcs]),
<a name="1090"/> 1090:     Parent = self(),
<a name="1091"/> 1091: 
<a name="1092"/> 1092:     WorkerFun =
<a name="1093"/> 1093:         fun() -&gt;
<a name="1094"/> 1094:             worker(rand:uniform(9999), UsageArgs, Parent)
<a name="1095"/> 1095:         end,
<a name="1096"/> 1096: 
<a name="1097"/> 1097:     Pids = [spawn_link(WorkerFun) || _ &lt;- lists:seq(1, NumOfProcs)],
<a name="smp-last_expr"/><a name="1098"/> 1098: <b>    wait_pids</b>(Pids).
<a name="1099"/> 1099: 
<a name="worker-3"/><a name="1100"/> 1100: <b>worker</b>(Seed, FnATpl, Parent) -&gt;
<a name="1101"/> 1101:     io:format(&quot;smp worker ~p, seed=~p~n&quot;,[self(),Seed]),
<a name="1102"/> 1102:     rand:seed(exsplus, {Seed,Seed,Seed}),
<a name="1103"/> 1103:     worker_loop(100, FnATpl),
<a name="worker-last_expr"/><a name="1104"/> 1104: <b>    Parent ! self</b>().
<a name="1105"/> 1105: 
<a name="worker_loop-2"/><a name="1106"/> 1106: <b>worker_loop</b>(0, _FnATpl) -&gt;
<a name="1107"/> 1107:     large_deflate_do(), % the time consuming one as finale
<a name="1108"/> 1108:     ok;
<a name="1109"/> 1109: <b>worker_loop</b>(N, FnATpl) -&gt;
<a name="1110"/> 1110:     {F,A} = element(rand:uniform(tuple_size(FnATpl)), FnATpl),
<a name="1111"/> 1111:     ?MODULE:F(A),
<a name="worker_loop-last_expr"/><a name="1112"/> 1112: <b>    worker_loop</b>(N-1, FnATpl).
<a name="1113"/> 1113: 
<a name="wait_pids-1"/><a name="1114"/> 1114: <b>wait_pids</b>([]) -&gt; 
<a name="1115"/> 1115:     ok;
<a name="1116"/> 1116: <b>wait_pids</b>(Pids) -&gt;
<a name="wait_pids-last_expr"/><a name="1117"/> 1117:     receive
<a name="1118"/> 1118: 	Pid -&gt;
<a name="1119"/> 1119: 	    true = lists:member(Pid,Pids),
<a name="1120"/> 1120: 	    Others = lists:delete(Pid,Pids),
<a name="1121"/> 1121: 	    io:format(&quot;wait_pid got ~p, still waiting for ~p\n&quot;,[Pid,Others]),
<a name="1122"/> 1122: 	    wait_pids(Others)
<a name="1123"/> 1123:     end.
<a name="1124"/> 1124: 
<a name="1125"/> 1125: 
<a name="1126"/> 1126: <i>%% Deflate/inflate data with size close to multiple of internal buffer size.</i>
<a name="otp_7359-1"/><a name="1127"/> 1127: <b>otp_7359</b>(_Config) -&gt;
<a name="1128"/> 1128:     %% Find compressed size
<a name="1129"/> 1129:     ZTry = zlib:open(),
<a name="1130"/> 1130:     ok = zlib:deflateInit(ZTry),
<a name="1131"/> 1131:     ISize = zlib:getBufSize(ZTry),
<a name="1132"/> 1132:     IData = list_to_binary([Byte band 255 || Byte &lt;- lists:seq(1,ISize)]),
<a name="1133"/> 1133:     ISize = byte_size(IData),
<a name="1134"/> 1134: 
<a name="1135"/> 1135:     DSize = iolist_size(zlib:deflate(ZTry, IData, sync)),
<a name="1136"/> 1136:     zlib:close(ZTry),
<a name="1137"/> 1137: 
<a name="1138"/> 1138:     io:format(&quot;Deflated try ~p -&gt; ~p bytes~n&quot;, [ISize, DSize]),
<a name="1139"/> 1139: 
<a name="1140"/> 1140:     %% Try deflate and inflate with different internal buffer sizes
<a name="1141"/> 1141:     ISpan = 1,
<a name="1142"/> 1142:     DSpan = 10, % use larger span around deflated size as it may vary depending on buf size
<a name="1143"/> 1143: 
<a name="1144"/> 1144:     Cases = [{DS,IS} || DMul&lt;-[1,2],
<a name="1145"/> 1145: 			DS &lt;- lists:seq((DSize div DMul)-DSpan,
<a name="1146"/> 1146: 					(DSize div DMul)+DSpan),
<a name="1147"/> 1147: 			IMul&lt;-[1,2],
<a name="1148"/> 1148: 			IS &lt;- lists:seq((ISize div IMul)-ISpan,
<a name="1149"/> 1149: 					(ISize div IMul)+ISpan)],
<a name="1150"/> 1150: 
<a name="otp_7359-last_expr"/><a name="1151"/> 1151: <b>    lists:foreach</b>(fun(Case) -&gt; otp_7359_def_inf(IData,Case) end,
<a name="1152"/> 1152: 		  Cases).
<a name="1153"/> 1153: 
<a name="1154"/> 1154: 
<a name="otp_7359_def_inf-2"/><a name="1155"/> 1155: <b>otp_7359_def_inf</b>(Data,{DefSize,InfSize}) -&gt;    
<a name="1156"/> 1156:     %%io:format(&quot;Try: DefSize=~p InfSize=~p~n&quot;, [DefSize,InfSize]),
<a name="1157"/> 1157:     ZDef = zlib:open(),
<a name="1158"/> 1158:     ok = zlib:deflateInit(ZDef),
<a name="1159"/> 1159:     ok = zlib:setBufSize(ZDef,DefSize),
<a name="1160"/> 1160:     DefData = iolist_to_binary(zlib:deflate(ZDef, Data, sync)),
<a name="1161"/> 1161:     %%io:format(&quot;Deflated ~p(~p) -&gt; ~p(~p) bytes~n&quot;, 
<a name="1162"/> 1162:     %%          [byte_size(Data), InfSize, byte_size(DefData), DefSize]),
<a name="1163"/> 1163:     ok = zlib:close(ZDef),
<a name="1164"/> 1164: 
<a name="1165"/> 1165:     ZInf = zlib:open(),
<a name="1166"/> 1166:     ok = zlib:inflateInit(ZInf),
<a name="1167"/> 1167:     ok = zlib:setBufSize(ZInf,InfSize),
<a name="1168"/> 1168:     Data = iolist_to_binary(zlib:inflate(ZInf, DefData)),
<a name="1169"/> 1169:     ok = zlib:close(ZInf),
<a name="otp_7359_def_inf-last_expr"/><a name="1170"/> 1170:     ok.
<a name="1171"/> 1171: 
<a name="otp_9981-1"/><a name="1172"/> 1172: <b>otp_9981</b>(Config) when is_list(Config) -&gt;
<a name="1173"/> 1173:     Ports = lists:sort(erlang:ports()),
<a name="1174"/> 1174:     Invalid = &lt;&lt;&quot;My invalid data&quot;&gt;&gt;,
<a name="1175"/> 1175:     catch zlib:compress(invalid),
<a name="1176"/> 1176:     Ports = lists:sort(erlang:ports()),
<a name="1177"/> 1177:     catch zlib:uncompress(Invalid),
<a name="1178"/> 1178:     Ports = lists:sort(erlang:ports()),
<a name="1179"/> 1179:     catch zlib:zip(invalid),
<a name="1180"/> 1180:     Ports = lists:sort(erlang:ports()),
<a name="1181"/> 1181:     catch zlib:unzip(Invalid),
<a name="1182"/> 1182:     Ports = lists:sort(erlang:ports()),
<a name="1183"/> 1183:     catch zlib:gzip(invalid),
<a name="1184"/> 1184:     Ports = lists:sort(erlang:ports()),
<a name="1185"/> 1185:     catch zlib:gunzip(Invalid),
<a name="1186"/> 1186:     Ports = lists:sort(erlang:ports()),
<a name="otp_9981-last_expr"/><a name="1187"/> 1187:     ok.
<a name="1188"/> 1188: 
<a name="1189"/> 1189: <b>-define</b>(BENCH_SIZE, (16 bsl 20)).
<a name="1190"/> 1190: 
<a name="1191"/> 1191: <b>-define</b>(DECOMPRESS_BENCH(Name, What, Data),
<a name="1192"/> 1192:         Name(Config) when is_list(Config) -&gt;
<a name="1193"/> 1193:         Uncompressed = Data,
<a name="1194"/> 1194:         Compressed = zlib:compress(Uncompressed),
<a name="1195"/> 1195:         What(Compressed, byte_size(Uncompressed))).
<a name="1196"/> 1196: 
<a name="1197"/> 1197: <b>-define</b>(COMPRESS_BENCH(Name, What, Data),
<a name="1198"/> 1198:         Name(Config) when is_list(Config) -&gt;
<a name="1199"/> 1199:         Compressed = Data,
<a name="1200"/> 1200:         What(Compressed, byte_size(Compressed))).
<a name="1201"/> 1201: 
<a name="inflate_bench_zeroed-1"/><a name="inflate_bench_zeroed-last_expr"/><a name="1202"/> 1202: <b>?DECOMPRESS_BENCH</b>(inflate_bench_zeroed, throughput_bench_inflate,
<a name="1203"/> 1203:     &lt;&lt;0:(8 * ?BENCH_SIZE)&gt;&gt;).
<a name="inflate_bench_rand-1"/><a name="inflate_bench_rand-last_expr"/><a name="1204"/> 1204: <b>?DECOMPRESS_BENCH</b>(inflate_bench_rand, throughput_bench_inflate,
<a name="1205"/> 1205:     gen_determ_rand_bytes(?BENCH_SIZE)).
<a name="1206"/> 1206: 
<a name="chunk_bench_zeroed-1"/><a name="chunk_bench_zeroed-last_expr"/><a name="1207"/> 1207: <b>?DECOMPRESS_BENCH</b>(chunk_bench_zeroed, throughput_bench_chunk,
<a name="1208"/> 1208:     &lt;&lt;0:(8 * ?BENCH_SIZE)&gt;&gt;).
<a name="chunk_bench_rand-1"/><a name="chunk_bench_rand-last_expr"/><a name="1209"/> 1209: <b>?DECOMPRESS_BENCH</b>(chunk_bench_rand, throughput_bench_chunk,
<a name="1210"/> 1210:     gen_determ_rand_bytes(?BENCH_SIZE)).
<a name="1211"/> 1211: 
<a name="deflate_bench_zeroed-1"/><a name="deflate_bench_zeroed-last_expr"/><a name="1212"/> 1212: <b>?COMPRESS_BENCH</b>(deflate_bench_zeroed, throughput_bench_deflate,
<a name="1213"/> 1213:     &lt;&lt;0:(8 * ?BENCH_SIZE)&gt;&gt;).
<a name="deflate_bench_rand-1"/><a name="deflate_bench_rand-last_expr"/><a name="1214"/> 1214: <b>?COMPRESS_BENCH</b>(deflate_bench_rand, throughput_bench_deflate,
<a name="1215"/> 1215:     gen_determ_rand_bytes(?BENCH_SIZE)).
<a name="1216"/> 1216: 
<a name="throughput_bench_inflate-2"/><a name="1217"/> 1217: <b>throughput_bench_inflate</b>(Compressed, Size) -&gt;
<a name="1218"/> 1218:     Z = zlib:open(),
<a name="1219"/> 1219:     zlib:inflateInit(Z),
<a name="1220"/> 1220: 
<a name="throughput_bench_inflate-last_expr"/><a name="1221"/> 1221: <b>    submit_throughput_results</b>(Size,
<a name="1222"/> 1222:         fun() -&gt;
<a name="1223"/> 1223:             zlib:inflate(Z, Compressed)
<a name="1224"/> 1224:         end).
<a name="1225"/> 1225: 
<a name="throughput_bench_deflate-2"/><a name="1226"/> 1226: <b>throughput_bench_deflate</b>(Uncompressed, Size) -&gt;
<a name="1227"/> 1227:     Z = zlib:open(),
<a name="1228"/> 1228:     zlib:deflateInit(Z),
<a name="1229"/> 1229: 
<a name="throughput_bench_deflate-last_expr"/><a name="1230"/> 1230: <b>    submit_throughput_results</b>(Size,
<a name="1231"/> 1231:         fun() -&gt;
<a name="1232"/> 1232:             zlib:deflate(Z, Uncompressed, finish)
<a name="1233"/> 1233:         end).
<a name="1234"/> 1234: 
<a name="throughput_bench_chunk-2"/><a name="1235"/> 1235: <b>throughput_bench_chunk</b>(Compressed, Size) -&gt;
<a name="1236"/> 1236:     Z = zlib:open(),
<a name="1237"/> 1237:     zlib:inflateInit(Z),
<a name="1238"/> 1238: 
<a name="1239"/> 1239:     ChunkLoop =
<a name="1240"/> 1240:         fun
<a name="1241"/> 1241:             Loop({more, _}) -&gt; Loop(zlib:inflateChunk(Z));
<a name="1242"/> 1242:             Loop(_) -&gt; ok
<a name="1243"/> 1243:         end,
<a name="1244"/> 1244: 
<a name="throughput_bench_chunk-last_expr"/><a name="1245"/> 1245: <b>    submit_throughput_results</b>(Size,
<a name="1246"/> 1246:         fun() -&gt;
<a name="1247"/> 1247:             ChunkLoop(zlib:inflateChunk(Z, Compressed))
<a name="1248"/> 1248:         end).
<a name="1249"/> 1249: 
<a name="submit_throughput_results-2"/><a name="1250"/> 1250: <b>submit_throughput_results</b>(Size, Fun) -&gt;
<a name="1251"/> 1251:     TimeTaken = measure_perf_counter(Fun, millisecond),
<a name="1252"/> 1252: 
<a name="1253"/> 1253:     KBPS = trunc((Size bsr 10) / (TimeTaken / 1000)),
<a name="1254"/> 1254:     ct_event:notify(#event{ name = benchmark_data, data = [{value,KBPS}] }),
<a name="submit_throughput_results-last_expr"/><a name="1255"/> 1255: <b>    {comment, io_lib:format</b>(&quot;~p ms, ~p KBPS&quot;, [TimeTaken, KBPS])}.
<a name="1256"/> 1256: 
<a name="measure_perf_counter-2"/><a name="1257"/> 1257: <b>measure_perf_counter</b>(Fun, Unit) -&gt;
<a name="1258"/> 1258:     Start = os:perf_counter(Unit),
<a name="1259"/> 1259:     Fun(),
<a name="measure_perf_counter-last_expr"/><a name="1260"/> 1260: <b>    os:perf_counter</b>(Unit) - Start.
<a name="1261"/> 1261: 
<a name="1262"/> 1262: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1263"/> 1263: <i>%%% Helps with testing directly %%%%%%%%%%%%%</i>
<a name="1264"/> 1264: 
<a name="get_data_dir-1"/><a name="1265"/> 1265: <b>get_data_dir</b>(Config) -&gt;
<a name="get_data_dir-last_expr"/><a name="1266"/> 1266: <b>    try proplists:get_value</b>(data_dir,Config) of
<a name="1267"/> 1267:         undefined -&gt;
<a name="1268"/> 1268:             &quot;./zlib_SUITE_data&quot;;
<a name="1269"/> 1269:         Dir -&gt;
<a name="1270"/> 1270:             Dir
<a name="1271"/> 1271:     catch
<a name="1272"/> 1272:         _:_ -&gt; &quot;./zlib_SUITE_data&quot;
<a name="1273"/> 1273:     end.
<a name="1274"/> 1274: 
<a name="1275"/> 1275: <i>%% Generates a bunch of statistically random bytes using the size as seed.</i>
<a name="gen_determ_rand_bytes-1"/><a name="1276"/> 1276: <b>gen_determ_rand_bytes</b>(Size) -&gt;
<a name="gen_determ_rand_bytes-last_expr"/><a name="1277"/> 1277: <b>    gen_determ_rand_bytes</b>(Size, erlang:md5_init(), &lt;&lt;&gt;&gt;).
<a name="gen_determ_rand_bytes-3"/><a name="1278"/> 1278: <b>gen_determ_rand_bytes</b>(Size, _Context, Acc) when Size =&lt; 0 -&gt;
<a name="1279"/> 1279:     Acc;
<a name="1280"/> 1280: <b>gen_determ_rand_bytes</b>(Size, Context0, Acc) when Size &gt; 0 -&gt;
<a name="1281"/> 1281:     Context = erlang:md5_update(Context0, &lt;&lt;Size/integer&gt;&gt;),
<a name="1282"/> 1282:     Checksum = erlang:md5_final(Context),
<a name="gen_determ_rand_bytes-last_expr"/><a name="1283"/> 1283: <b>    gen_determ_rand_bytes</b>(Size - 16, Context, &lt;&lt;Acc/binary, Checksum/binary&gt;&gt;).
</pre>
</body>
</html>
