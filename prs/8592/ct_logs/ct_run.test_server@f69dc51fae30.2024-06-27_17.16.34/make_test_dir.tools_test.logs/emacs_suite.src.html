<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/tools/make_test_dir/tools_test/emacs_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2005-2021. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(emacs_SUITE).
<a name="21"/>   21: 
<a name="22"/>   22: <i>%%-define(line_trace, 1).</i>
<a name="23"/>   23: 
<a name="24"/>   24: <b>-export</b>([all/0, init_per_testcase/2, end_per_testcase/2]).
<a name="25"/>   25: 
<a name="26"/>   26: <b>-export</b>([bif_highlight/1,
<a name="27"/>   27:          load_interpreted/1,  compile_and_load/1,
<a name="28"/>   28:          indent/1,
<a name="29"/>   29:          tests_interpreted/1, tests_compiled/1
<a name="30"/>   30:         ]).
<a name="31"/>   31: 
<a name="all-0"/><a name="32"/>   32: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="33"/>   33:     [bif_highlight, load_interpreted, compile_and_load,
<a name="34"/>   34:      indent,
<a name="35"/>   35:      tests_interpreted, tests_compiled
<a name="36"/>   36:     ].
<a name="37"/>   37: 
<a name="init_per_testcase-2"/><a name="38"/>   38: <b>init_per_testcase</b>(Case, Config) -&gt;
<a name="39"/>   39:     ErlangEl = filename:join([code:lib_dir(tools),&quot;emacs&quot;,&quot;erlang.el&quot;]),
<a name="init_per_testcase-last_expr"/><a name="40"/>   40: <b>    case file:read_file_info</b>(ErlangEl) of
<a name="41"/>   41:         {ok, _} -&gt;
<a name="42"/>   42:             case Case =:= bif_highlight orelse emacs_version_ok(24.3) of
<a name="43"/>   43:                 false -&gt; {skip, &quot;Old or no emacs found&quot;};
<a name="44"/>   44:                 _ -&gt; [{el, ErlangEl}|Config]
<a name="45"/>   45:             end;
<a name="46"/>   46:         _ -&gt;
<a name="47"/>   47:             {skip, &quot;Could not find erlang.el&quot;}
<a name="48"/>   48:     end.
<a name="49"/>   49: 
<a name="end_per_testcase-2"/><a name="50"/>   50: <b>end_per_testcase</b>(_Case, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="51"/>   51:     ok.
<a name="52"/>   52: 
<a name="bif_highlight-1"/><a name="53"/>   53: <b>bif_highlight</b>(Config) -&gt;
<a name="54"/>   54:     ErlangEl = proplists:get_value(el,Config),
<a name="55"/>   55:     {ok, Bin} = file:read_file(ErlangEl),
<a name="56"/>   56: 
<a name="57"/>   57:     %% All auto-imported bifs
<a name="58"/>   58:     IntBifs = lists:usort(
<a name="59"/>   59:                 [F  || {F,A} &lt;- erlang:module_info(exports),
<a name="60"/>   60:                        erl_internal:bif(F,A)]),
<a name="61"/>   61: 
<a name="62"/>   62:     %% all bif which need erlang: prefix and are not operands
<a name="63"/>   63:     ExtBifs = lists:usort(
<a name="64"/>   64:                 [F  || {F,A} &lt;- erlang:module_info(exports),
<a name="65"/>   65:                        not erl_internal:bif(F,A) andalso
<a name="66"/>   66:                            not is_atom(catch erl_internal:op_type(F,A))]),
<a name="67"/>   67: 
<a name="68"/>   68:     check_bif_highlight(Bin, &lt;&lt;&quot;erlang-int-bifs&quot;&gt;&gt;, IntBifs),
<a name="bif_highlight-last_expr"/><a name="69"/>   69: <b>    check_bif_highlight</b>(Bin, &lt;&lt;&quot;erlang-ext-bifs&quot;&gt;&gt;, ExtBifs).
<a name="70"/>   70: 
<a name="71"/>   71: 
<a name="check_bif_highlight-3"/><a name="72"/>   72: <b>check_bif_highlight</b>(Bin, Tag, Compare) -&gt;
<a name="73"/>   73:     [_H,Match,_T] =
<a name="74"/>   74:         re:split(Bin,&lt;&lt;&quot;defvar &quot;,Tag/binary,
<a name="75"/>   75:                        &quot;[^(]*\\(([^)]*)&quot;&gt;&gt;,[]),
<a name="76"/>   76:     EmacsBifs = [list_to_atom(S) ||
<a name="77"/>   77:                   S &lt;- string:tokens(binary_to_list(Match),&quot; '\&quot;\n&quot;)],
<a name="78"/>   78: 
<a name="79"/>   79:     ct:log(&quot;Comparing ~s&quot;, [Tag]),
<a name="80"/>   80:     ct:log(&quot;Emacs ~p&quot;,[EmacsBifs]),
<a name="81"/>   81:     ct:log(&quot;Erlang ~p&quot;,[Compare]),
<a name="82"/>   82: 
<a name="83"/>   83:     ct:log(&quot;Only in Erlang ~p&quot;,[Compare -- EmacsBifs]),
<a name="84"/>   84:     ct:log(&quot;Only in Emacs ~p&quot;,[EmacsBifs -- Compare]),
<a name="85"/>   85:     [] = Compare -- EmacsBifs,
<a name="check_bif_highlight-last_expr"/><a name="86"/>   86:     [] = EmacsBifs -- Compare.
<a name="87"/>   87: 
<a name="88"/>   88: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="89"/>   89: 
<a name="load_interpreted-1"/><a name="90"/>   90: <b>load_interpreted</b>(_Config) -&gt;
<a name="91"/>   91:     _ = emacs([&quot;-l erlang.el -f erlang-mode&quot;]),
<a name="load_interpreted-last_expr"/><a name="92"/>   92:     ok.
<a name="93"/>   93: 
<a name="compile_and_load-1"/><a name="94"/>   94: <b>compile_and_load</b>(_Config) -&gt;
<a name="95"/>   95:     Dir = emacs_dir(),
<a name="96"/>   96:     Files0 = filelib:wildcard(&quot;*.el&quot;, Dir),
<a name="97"/>   97:     Files = case emacs_version_ok(24.3) of
<a name="98"/>   98:                 %% erldoc.el depends on cl-lib which was introduced in 24.3.
<a name="99"/>   99:                 false -&gt; Files0 -- [&quot;erldoc.el&quot;];
<a name="100"/>  100:                 _ -&gt; Files0
<a name="101"/>  101:             end,
<a name="102"/>  102:     Unforgiving =
<a name="103"/>  103:         case emacs_version_ok(24) of
<a name="104"/>  104:             Ver when Ver &lt; 25 -&gt;
<a name="105"/>  105:                 &quot;&quot;;
<a name="106"/>  106:             Ver when Ver &lt; 26 -&gt;
<a name="107"/>  107:                 %% Workaround byte-compile-error-on-warn which seem broken in
<a name="108"/>  108:                 %% Emacs 25.
<a name="109"/>  109:                 &quot;\&quot;(advice-add #'display-warning :after &quot;
<a name="110"/>  110:                     &quot;(lambda (_ f &amp;optional _ _) (error \\\&quot;%s\\\&quot; f)))\&quot;&quot;;
<a name="111"/>  111:             _ -&gt;
<a name="112"/>  112:                 &quot;\&quot;(setq byte-compile-error-on-warn t)\&quot;&quot;
<a name="113"/>  113:         end,
<a name="114"/>  114:     %% Add files here whenever they are cleaned of warnings.
<a name="115"/>  115:     NoWarn = [&quot;erlang.el&quot;, &quot;erlang-test.el&quot;, &quot;erlang-edoc.el&quot;, &quot;erlang-start.el&quot;, &quot;erldoc.el&quot;],
<a name="116"/>  116:     Compile = fun(File) -&gt;
<a name="117"/>  117:                       Pedantic = case lists:member(File, NoWarn) andalso Unforgiving /= &quot;&quot; of
<a name="118"/>  118:                                      true -&gt; [&quot;--eval &quot;, Unforgiving, &quot; &quot;];
<a name="119"/>  119:                                      false -&gt; &quot; &quot;
<a name="120"/>  120:                                  end,
<a name="121"/>  121:                       emacs([Pedantic,
<a name="122"/>  122:                              &quot; -f batch-byte-compile &quot;, dquote(filename:join(Dir, File))]),
<a name="123"/>  123:                       true
<a name="124"/>  124:               end,
<a name="125"/>  125:     lists:foreach(Compile, Files),
<a name="126"/>  126:     emacs([&quot;-l erlang.elc -f erlang-mode&quot;]),
<a name="compile_and_load-last_expr"/><a name="127"/>  127:     ok.
<a name="128"/>  128: 
<a name="tests_interpreted-1"/><a name="129"/>  129: <b>tests_interpreted</b>(_Config) -&gt;
<a name="tests_interpreted-last_expr"/><a name="130"/>  130: <b>    case emacs_version_ok</b>(25) of
<a name="131"/>  131:         false -&gt; {skip, &quot;Old or no emacs found&quot;};
<a name="132"/>  132:         _ -&gt;
<a name="133"/>  133:             emacs([&quot;-l erlang.el &quot;,
<a name="134"/>  134:                    &quot;-l erlang-test.el -f ert-run-tests-batch-and-exit&quot;]),
<a name="135"/>  135:             ok
<a name="136"/>  136:     end.
<a name="137"/>  137: 
<a name="tests_compiled-1"/><a name="138"/>  138: <b>tests_compiled</b>(_Config) -&gt;
<a name="tests_compiled-last_expr"/><a name="139"/>  139: <b>    case emacs_version_ok</b>(25) of
<a name="140"/>  140:         false -&gt; {skip, &quot;Old or no emacs found&quot;};
<a name="141"/>  141:         _ -&gt;
<a name="142"/>  142:             emacs([&quot;-l erlang.elc &quot;,
<a name="143"/>  143:                    &quot;-l erlang-test.elc -f ert-run-tests-batch-and-exit&quot;]),
<a name="144"/>  144:             ok
<a name="145"/>  145:     end.
<a name="146"/>  146: 
<a name="147"/>  147: 
<a name="dquote-1"/><a name="148"/>  148: <b>dquote</b>(Str) -&gt;
<a name="dquote-last_expr"/><a name="149"/>  149:     &quot;\&quot;&quot; ++ Str ++ &quot;\&quot;&quot;.
<a name="150"/>  150: 
<a name="151"/>  151: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="152"/>  152: 
<a name="indent-1"/><a name="153"/>  153: <b>indent</b>(Config) -&gt;
<a name="154"/>  154:     Def = filename:dirname(code:which(?MODULE))
<a name="155"/>  155:         ++ &quot;/&quot;
<a name="156"/>  156:         ++ ?MODULE_STRING
<a name="157"/>  157:         ++ &quot;_data&quot;,
<a name="158"/>  158:     Dir = proplists:get_value(data_dir, Config, Def),
<a name="159"/>  159:     OrigFs = filelib:wildcard(Dir ++ &quot;/*&quot;),
<a name="160"/>  160:     io:format(&quot;Dir: ~s~nFs: ~p~n&quot;, [Dir, OrigFs]),
<a name="161"/>  161:     Fs = [{File, unindent(File)} || File &lt;- OrigFs,
<a name="162"/>  162:                                     filename:extension(File) =:= &quot;&quot;],
<a name="163"/>  163:     Indent = fun(File) -&gt;
<a name="164"/>  164:                      emacs([
<a name="165"/>  165:                             File, &quot; &quot;,
<a name="166"/>  166:                             &quot;--eval '(indent-region (point-min) (point-max) nil)' &quot;,
<a name="167"/>  167:                             &quot;--eval '(save-buffer 0)'&quot;
<a name="168"/>  168:                            ]),
<a name="169"/>  169:                      ok
<a name="170"/>  170:              end,
<a name="171"/>  171:     [Indent(File) || {_, File} &lt;- Fs],
<a name="172"/>  172:     Res = [diff(Orig, File) || {Orig, File} &lt;- Fs],
<a name="173"/>  173:     [file:delete(File) || {ok, File} &lt;- Res],       %% Cleanup
<a name="174"/>  174:     [] = [Fail || {fail, Fail} &lt;- Res],
<a name="indent-last_expr"/><a name="175"/>  175:     ok.
<a name="176"/>  176: 
<a name="unindent-1"/><a name="177"/>  177: <b>unindent</b>(Input) -&gt;
<a name="178"/>  178:     Output = Input ++ &quot;.erl&quot;,
<a name="179"/>  179:     {ok, Bin} = file:read_file(Input),
<a name="180"/>  180:     Lines0 = string:split(Bin, &quot;\n&quot;, all),
<a name="181"/>  181:     Lines = [string:trim(Line, leading, [$\s,$\t]) || Line &lt;- Lines0],
<a name="182"/>  182:     %% io:format(&quot;File: ~s lines: ~w~n&quot;, [Input, length(Lines0)]),
<a name="183"/>  183:     %% [io:format(&quot;~s~n&quot;, [L]) || L &lt;- Lines],
<a name="184"/>  184:     ok = file:write_file(Output, lists:join(&quot;\n&quot;, Lines)),
<a name="unindent-last_expr"/><a name="185"/>  185:     Output.
<a name="186"/>  186: 
<a name="diff-2"/><a name="187"/>  187: <b>diff</b>(Orig, File) -&gt;
<a name="diff-last_expr"/><a name="188"/>  188: <b>    case os:cmd</b>([&quot;diff &quot;, Orig, &quot; &quot;, File]) of
<a name="189"/>  189:         &quot;&quot; -&gt; {ok, File};
<a name="190"/>  190:         Diff -&gt;
<a name="191"/>  191:             io:format(&quot;Fail: ~s vs ~s~n~s~n~n&quot;,[Orig, File, Diff]),
<a name="192"/>  192:             {fail, File}
<a name="193"/>  193:     end.
<a name="194"/>  194: 
<a name="emacs_version_ok-1"/><a name="195"/>  195: <b>emacs_version_ok</b>(AcceptVer) -&gt;
<a name="196"/>  196:     VersionLine = os:cmd(&quot;emacs --version | head -n 1&quot;),
<a name="197"/>  197:     io:format(&quot;~s~n&quot;, [VersionLine]),
<a name="emacs_version_ok-last_expr"/><a name="198"/>  198:     case VersionLine of
<a name="199"/>  199:         &quot;GNU Emacs &quot; ++ Ver -&gt;
<a name="200"/>  200:             case string:to_float(Ver) of
<a name="201"/>  201:                 {Vsn, _} when Vsn &gt;= AcceptVer -&gt;
<a name="202"/>  202:                     Vsn;
<a name="203"/>  203:                 _ -&gt;
<a name="204"/>  204:                     false
<a name="205"/>  205:             end;
<a name="206"/>  206:         Res -&gt;
<a name="207"/>  207:             io:format(&quot;Emacs version fail~n~s~n~n&quot;,[Res]),
<a name="208"/>  208:             false
<a name="209"/>  209:     end.
<a name="210"/>  210: 
<a name="emacs-1"/><a name="211"/>  211: <b>emacs</b>(EmacsCmds) when is_list(EmacsCmds) -&gt;
<a name="212"/>  212:     Cmd = [&quot;emacs &quot;,
<a name="213"/>  213:            &quot;--batch --quick &quot;,
<a name="214"/>  214:            &quot;--directory &quot;, dquote(emacs_dir()), &quot; &quot;,
<a name="215"/>  215:            &quot;--eval \&quot;(require 'erlang-start)\&quot; &quot;
<a name="216"/>  216:            | EmacsCmds],
<a name="217"/>  217:     io:format(&quot;Cmd: ~ts~n&quot;, [Cmd]),
<a name="218"/>  218:     Res0 = os:cmd(Cmd ++ &quot; ; echo $?&quot;),
<a name="219"/>  219:     Rows = string:lexemes(Res0, [&quot;\r\n&quot;, $\n]),
<a name="220"/>  220:     Res = lists:last(Rows),
<a name="221"/>  221:     Output = string:join(lists:droplast(Rows), &quot;\n&quot;),
<a name="222"/>  222:     io:format(&quot; =&gt; ~s ~ts~n&quot;, [Res, Output]),
<a name="223"/>  223:     &quot;0&quot; = Res,
<a name="emacs-last_expr"/><a name="224"/>  224:     Output.
<a name="225"/>  225: 
<a name="emacs_dir-0"/><a name="226"/>  226: <b>emacs_dir</b>() -&gt;
<a name="emacs_dir-last_expr"/><a name="227"/>  227: <b>    filename:join</b>([code:lib_dir(tools), &quot;emacs&quot;]).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
