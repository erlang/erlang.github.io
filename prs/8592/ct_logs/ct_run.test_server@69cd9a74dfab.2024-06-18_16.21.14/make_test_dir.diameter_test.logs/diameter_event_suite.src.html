<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/diameter/make_test_dir/diameter_test/diameter_event_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2013-2022. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <i>%% Tests of events sent as a consequence of diameter:subscribe/1.</i>
<a name="23"/>   23: <i>%% Watchdog events are dealt with more extensively in the watchdog</i>
<a name="24"/>   24: <i>%% suite.</i>
<a name="25"/>   25: <i>%%</i>
<a name="26"/>   26: 
<a name="27"/>   27: <b>-module</b>(diameter_event_SUITE).
<a name="28"/>   28: 
<a name="29"/>   29: <i>%% testcase, no common_test dependency</i>
<a name="30"/>   30: <b>-export</b>([run/0]).
<a name="31"/>   31: 
<a name="32"/>   32: <i>%% common_test wrapping</i>
<a name="33"/>   33: <b>-export</b>([suite/0,
<a name="34"/>   34:          all/0,
<a name="35"/>   35:          traffic/1]).
<a name="36"/>   36: 
<a name="37"/>   37: <i>%% internal</i>
<a name="38"/>   38: <b>-export</b>([up/1,
<a name="39"/>   39:          down/1,
<a name="40"/>   40:          cea_timeout/1]).
<a name="41"/>   41: 
<a name="42"/>   42: <b>-include_lib</b>(&quot;diameter/include/diameter.hrl&quot;).
<a name="43"/>   43: 
<a name="44"/>   44: <i>%% ===========================================================================</i>
<a name="45"/>   45: 
<a name="46"/>   46: <b>-define</b>(util, diameter_util).
<a name="47"/>   47: 
<a name="48"/>   48: <b>-define</b>(ADDR, {127,0,0,1}).
<a name="49"/>   49: <b>-define</b>(REALM, &quot;REALM&quot;).
<a name="50"/>   50: 
<a name="51"/>   51: <b>-define</b>(SERVER, &quot;SERVER.SERVER-REALM&quot;).
<a name="52"/>   52: <b>-define</b>(CLIENT, &quot;CLIENT.CLIENT-REALM&quot;).
<a name="53"/>   53: 
<a name="54"/>   54: <b>-define</b>(DICT_COMMON, ?DIAMETER_DICT_COMMON).
<a name="55"/>   55: <b>-define</b>(DICT_ACCT,   ?DIAMETER_DICT_ACCOUNTING).
<a name="56"/>   56: 
<a name="57"/>   57: <b>-define</b>(SERVER_CAPX_TMO, 6000).
<a name="58"/>   58: 
<a name="59"/>   59: <i>%% Config for diameter:start_service/2.</i>
<a name="60"/>   60: <b>-define</b>(SERVICE(Host, Dicts),
<a name="61"/>   61:         [{'Origin-Host', Host},
<a name="62"/>   62:          {'Origin-Realm', realm(Host)},
<a name="63"/>   63:          {'Host-IP-Address', [?ADDR]},
<a name="64"/>   64:          {'Vendor-Id', 12345},
<a name="65"/>   65:          {'Product-Name', &quot;OTP/diameter&quot;},
<a name="66"/>   66:          {'Acct-Application-Id', [D:id() || D &lt;- Dicts]},
<a name="67"/>   67:          {decode_format, map}
<a name="68"/>   68:          | [{application, [{dictionary, D},
<a name="69"/>   69:                            {module, #diameter_callback{}}]}
<a name="70"/>   70:             || D &lt;- Dicts]]).
<a name="71"/>   71: 
<a name="72"/>   72: <i>%% Diameter Result-Code's:</i>
<a name="73"/>   73: <b>-define</b>(NO_COMMON_APP, 5010).
<a name="74"/>   74: 
<a name="75"/>   75: <i>%% ===========================================================================</i>
<a name="76"/>   76: 
<a name="suite-0"/><a name="77"/>   77: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="78"/>   78:     [{timetrap, {seconds, 90}}].
<a name="79"/>   79: 
<a name="all-0"/><a name="80"/>   80: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="81"/>   81:     [traffic].
<a name="82"/>   82: 
<a name="traffic-1"/><a name="83"/>   83: <b>traffic</b>(_Config) -&gt;
<a name="traffic-last_expr"/><a name="84"/>   84: <b>    run</b>().
<a name="85"/>   85: 
<a name="86"/>   86: <i>%% ===========================================================================</i>
<a name="87"/>   87: 
<a name="88"/>   88: <i>%% run/0</i>
<a name="89"/>   89: 
<a name="run-0"/><a name="90"/>   90: <b>run</b>() -&gt;
<a name="91"/>   91:     ok = diameter:start(),
<a name="run-last_expr"/><a name="92"/>   92:     try
<a name="93"/>   93:         ?util:run([{fun traffic/0, 60000}])
<a name="94"/>   94:     after
<a name="95"/>   95:         ok = diameter:stop()
<a name="96"/>   96:     end.
<a name="97"/>   97: 
<a name="98"/>   98: <i>%% traffic/0</i>
<a name="99"/>   99: 
<a name="traffic-0"/><a name="100"/>  100: <b>traffic</b>() -&gt;
<a name="101"/>  101:     PortNr = start_server(),
<a name="102"/>  102:     Config = [{portnr, PortNr}],
<a name="103"/>  103:     Funs = [up, down, cea_timeout],
<a name="traffic-last_expr"/><a name="104"/>  104: <b>    ?util:run</b>([[{?MODULE, F, [[{name, F} | Config]]} || F &lt;- Funs]]).
<a name="105"/>  105: 
<a name="106"/>  106: <i>%% start_server/0</i>
<a name="107"/>  107: 
<a name="start_server-0"/><a name="108"/>  108: <b>start_server</b>() -&gt;
<a name="109"/>  109:     diameter:subscribe(?SERVER),
<a name="110"/>  110:     ok = diameter:start_service(?SERVER, ?SERVICE(?SERVER, [?DICT_COMMON])),
<a name="111"/>  111:     LRef = ?util:listen(?SERVER, tcp, [{capabilities_cb, fun capx_cb/2},
<a name="112"/>  112:                                        {capx_timeout, ?SERVER_CAPX_TMO}]),
<a name="113"/>  113:     [PortNr] = ?util:lport(tcp, LRef),
<a name="114"/>  114:     start = event(?SERVER),
<a name="start_server-last_expr"/><a name="115"/>  115:     PortNr.
<a name="116"/>  116: 
<a name="117"/>  117: <i>%% Connect with matching capabilities and expect the connection to</i>
<a name="118"/>  118: <i>%% come up.</i>
<a name="up-1"/><a name="119"/>  119: <b>up</b>(Config) -&gt;
<a name="120"/>  120:     {Svc, Ref, T} = connect(Config, [{strict_mbit, false},
<a name="121"/>  121:                                      {connect_timer, 5000},
<a name="122"/>  122:                                      {watchdog_timer, 15000}]),
<a name="123"/>  123:     start = event(Svc),
<a name="124"/>  124:     {{up, Ref, {TPid, Caps}, T, #diameter_packet{msg = M}}, _}
<a name="125"/>  125:         = {event(Svc), T},
<a name="126"/>  126:     ['CEA' | #{}] = M,  %% assert
<a name="127"/>  127:     {watchdog, Ref, _, {initial, okay}, _} = event(Svc),
<a name="128"/>  128:     %% Kill the transport process and see that the connection is
<a name="129"/>  129:     %% reestablished after a watchdog timeout, not after connect_timer
<a name="130"/>  130:     %% expiry.
<a name="131"/>  131:     exit(TPid, kill),
<a name="132"/>  132:     {{down, Ref, {TPid, Caps}, T}, _} = {event(Svc), T},
<a name="133"/>  133:     {watchdog, Ref, _, {okay, down}, _} = event(Svc),
<a name="up-last_expr"/><a name="134"/>  134: <b>    {reconnect, Ref, _} = event</b>(Svc, 10000, 20000).
<a name="135"/>  135: 
<a name="136"/>  136: <i>%% Connect with non-matching capabilities and expect CEA from the peer</i>
<a name="137"/>  137: <i>%% to indicate as much and then for the transport to be restarted</i>
<a name="138"/>  138: <i>%% (after connect_timer).</i>
<a name="down-1"/><a name="139"/>  139: <b>down</b>(Config) -&gt;
<a name="140"/>  140:     {Svc, Ref, T} = connect(Config, [{capabilities, [{'Acct-Application-Id',
<a name="141"/>  141:                                                       [?DICT_ACCT:id()]}]},
<a name="142"/>  142:                                      {applications, [?DICT_ACCT]},
<a name="143"/>  143:                                      {connect_timer, 5000},
<a name="144"/>  144:                                      {watchdog_timer, 20000}]),
<a name="145"/>  145:     start = event(Svc),
<a name="146"/>  146:     {{closed, Ref, {'CEA', ?NO_COMMON_APP, _, #diameter_packet{msg = M}}, T},
<a name="147"/>  147:      _}
<a name="148"/>  148:         = {event(Svc), T},
<a name="149"/>  149:     ['CEA' | #{}] = M,  %% assert
<a name="down-last_expr"/><a name="150"/>  150: <b>    {reconnect, Ref, _} = event</b>(Svc, 4000, 10000).
<a name="151"/>  151: 
<a name="152"/>  152: <i>%% Connect with matching capabilities but have the server delay its</i>
<a name="153"/>  153: <i>%% CEA and cause the client to timeout.</i>
<a name="cea_timeout-1"/><a name="154"/>  154: <b>cea_timeout</b>(Config) -&gt;
<a name="155"/>  155:     {Svc, Ref, T} = connect(Config, [{capx_timeout, ?SERVER_CAPX_TMO div 2},
<a name="156"/>  156:                                      {connect_timer, 2*?SERVER_CAPX_TMO}]),
<a name="157"/>  157:     start = event(Svc),
<a name="cea_timeout-last_expr"/><a name="158"/>  158: <b>    {{closed, Ref, {'CEA', timeout}, T}, _} = {event</b>(Svc), T}.
<a name="159"/>  159: 
<a name="160"/>  160: <i>%% ----------------------------------------</i>
<a name="161"/>  161: 
<a name="162"/>  162: <i>%% Keep the server from sending CEA until the client has timed out.</i>
<a name="capx_cb-2"/><a name="163"/>  163: <b>capx_cb</b>(_, #diameter_caps{origin_host = {_, &quot;cea_timeout-&quot; ++ _}}) -&gt;
<a name="164"/>  164:     receive after ?SERVER_CAPX_TMO -&gt; ok end;
<a name="165"/>  165: 
<a name="166"/>  166: <i>%% Or not.</i>
<a name="167"/>  167: <b>capx_cb</b>(_, _Caps) -&gt;
<a name="capx_cb-last_expr"/><a name="168"/>  168:     ok.
<a name="169"/>  169: 
<a name="170"/>  170: <i>%% ----------------------------------------</i>
<a name="171"/>  171: 
<a name="172"/>  172: <i>%% Use the testcase name to construct Origin-Host of the client so</i>
<a name="173"/>  173: <i>%% that the server can match on it in capx_cb/2.</i>
<a name="connect-2"/><a name="174"/>  174: <b>connect</b>(Config, Opts) -&gt;
<a name="175"/>  175:     Pre = atom_to_list(proplists:get_value(name, Config)),
<a name="176"/>  176:     Name = Pre ++ uniq() ++ ?CLIENT,
<a name="177"/>  177:     diameter:subscribe(Name),
<a name="178"/>  178:     ok = start_service(Name, ?SERVICE(Name, [?DICT_COMMON, ?DICT_ACCT])),
<a name="179"/>  179:     {connect, _} = T = opts(Config, Opts),
<a name="180"/>  180:     {ok, Ref} = diameter:add_transport(Name, T),
<a name="connect-last_expr"/><a name="181"/>  181:     {Name, Ref, T}.
<a name="182"/>  182: 
<a name="uniq-0"/><a name="183"/>  183: <b>uniq</b>() -&gt;
<a name="uniq-last_expr"/><a name="184"/>  184: <b>    &quot;-&quot; ++ diameter_util:unique_string</b>().
<a name="185"/>  185: 
<a name="event-1"/><a name="186"/>  186: <b>event</b>(Name) -&gt;
<a name="event-last_expr"/><a name="187"/>  187:     receive #diameter_event{service = Name, info = T} -&gt; T end.
<a name="188"/>  188: 
<a name="event-3"/><a name="189"/>  189: <b>event</b>(Name, TL, TH) -&gt;
<a name="190"/>  190:     T0 = diameter_lib:now(),
<a name="191"/>  191:     Event = event(Name),
<a name="192"/>  192:     DT = diameter_lib:micro_diff(T0) div 1000,
<a name="193"/>  193:     {true, true, DT, Event} = {TL &lt; DT, DT &lt; TH, DT, Event},
<a name="event-last_expr"/><a name="194"/>  194:     Event.
<a name="195"/>  195: 
<a name="start_service-2"/><a name="196"/>  196: <b>start_service</b>(Name, Opts) -&gt;
<a name="start_service-last_expr"/><a name="197"/>  197: <b>    diameter:start_service</b>(Name, [{monitor, self()} | Opts]).
<a name="198"/>  198: 
<a name="opts-2"/><a name="199"/>  199: <b>opts</b>(Config, Opts) -&gt;
<a name="200"/>  200:     PortNr = proplists:get_value(portnr, Config),
<a name="201"/>  201: 
<a name="opts-last_expr"/><a name="202"/>  202:     {connect, [{transport_module, diameter_tcp},
<a name="203"/>  203:                {transport_config, [{ip, ?ADDR}, {port, 0},
<a name="204"/>  204:                                    {raddr, ?ADDR}, {rport, PortNr}]}
<a name="205"/>  205:                | Opts]}.
<a name="206"/>  206: 
<a name="realm-1"/><a name="207"/>  207: <b>realm</b>(Host) -&gt;
<a name="realm-last_expr"/><a name="208"/>  208: <b>    tl</b>(lists:dropwhile(fun(C) -&gt; C /= $. end, Host)).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
