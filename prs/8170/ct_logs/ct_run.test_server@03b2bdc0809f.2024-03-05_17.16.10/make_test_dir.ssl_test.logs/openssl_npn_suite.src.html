<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/ssl/make_test_dir/ssl_test/openssl_npn_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2019-2022. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <i>%%</i>
<a name="21"/>   21: 
<a name="22"/>   22: <b>-module</b>(openssl_npn_SUITE).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="25"/>   25: 
<a name="26"/>   26: <i>%% Common test</i>
<a name="27"/>   27: <b>-export</b>([all/0,
<a name="28"/>   28:          groups/0,
<a name="29"/>   29:          init_per_suite/1,
<a name="30"/>   30:          init_per_group/2,
<a name="31"/>   31:          init_per_testcase/2,
<a name="32"/>   32:          end_per_suite/1,
<a name="33"/>   33:          end_per_group/2,
<a name="34"/>   34:          end_per_testcase/2
<a name="35"/>   35:         ]).
<a name="36"/>   36: 
<a name="37"/>   37: <i>%% Test cases</i>
<a name="38"/>   38: <b>-export</b>([erlang_client_openssl_server_npn/0,
<a name="39"/>   39:          erlang_client_openssl_server_npn/1,
<a name="40"/>   40:          erlang_server_openssl_client_npn/0,
<a name="41"/>   41:          erlang_server_openssl_client_npn/1,
<a name="42"/>   42:          erlang_server_openssl_client_npn_only_client/1,
<a name="43"/>   43:          erlang_server_openssl_client_npn_only_server/1,
<a name="44"/>   44:          erlang_client_openssl_server_npn_only_client/1,
<a name="45"/>   45:          erlang_client_openssl_server_npn_only_server/1,
<a name="46"/>   46:          erlang_server_openssl_client_npn_renegotiate/1,
<a name="47"/>   47:          erlang_client_openssl_server_npn_renegotiate/0,
<a name="48"/>   48:          erlang_client_openssl_server_npn_renegotiate/1
<a name="49"/>   49:         ]).
<a name="50"/>   50: 
<a name="51"/>   51: <b>-define</b>(OPENSSL_QUIT, &quot;Q\n&quot;).
<a name="52"/>   52: <b>-define</b>(OPENSSL_RENEGOTIATE, &quot;R\n&quot;).
<a name="53"/>   53: <b>-define</b>(SLEEP, 1000).
<a name="54"/>   54: 
<a name="55"/>   55: <i>%%--------------------------------------------------------------------</i>
<a name="56"/>   56: <i>%% Common Test interface functions -----------------------------------</i>
<a name="57"/>   57: <i>%%--------------------------------------------------------------------</i>
<a name="all-0"/><a name="58"/>   58: <b>all</b>() -&gt; 
<a name="59"/>   59:     %% NPN is not supported in TLS-1.3 (replaced by ALPN and deprecated in TLS 1.2)
<a name="60"/>   60:     %% OpenSSL DTLS support for NPN is either not there or broken.
<a name="all-last_expr"/><a name="61"/>   61:     [{group, 'tlsv1.2'},
<a name="62"/>   62:      {group, 'tlsv1.1'},
<a name="63"/>   63:      {group, 'tlsv1'}].
<a name="64"/>   64: 
<a name="groups-0"/><a name="65"/>   65: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="66"/>   66: <b>    [{'tlsv1.2', [], npn_tests</b>() ++ npn_renegotiate_tests()},
<a name="67"/>   67:      {'tlsv1.1', [], npn_tests() ++ npn_renegotiate_tests()},
<a name="68"/>   68:      {'tlsv1', [], npn_tests() ++ npn_renegotiate_tests()}
<a name="69"/>   69:     ].
<a name="70"/>   70:  
<a name="npn_tests-0"/><a name="71"/>   71: <b>npn_tests</b>() -&gt;
<a name="npn_tests-last_expr"/><a name="72"/>   72:     [erlang_client_openssl_server_npn,
<a name="73"/>   73:      erlang_server_openssl_client_npn,
<a name="74"/>   74:      erlang_server_openssl_client_npn_only_client,
<a name="75"/>   75:      erlang_server_openssl_client_npn_only_server,
<a name="76"/>   76:      erlang_client_openssl_server_npn_only_client,
<a name="77"/>   77:      erlang_client_openssl_server_npn_only_server].
<a name="78"/>   78: 
<a name="npn_renegotiate_tests-0"/><a name="79"/>   79: <b>npn_renegotiate_tests</b>() -&gt;
<a name="npn_renegotiate_tests-last_expr"/><a name="80"/>   80:            [
<a name="81"/>   81:             erlang_server_openssl_client_npn_renegotiate,
<a name="82"/>   82:             erlang_client_openssl_server_npn_renegotiate
<a name="83"/>   83:            ].
<a name="84"/>   84: 
<a name="init_per_suite-1"/><a name="85"/>   85: <b>init_per_suite</b>(Config0) -&gt;
<a name="86"/>   86:     Config1 = ssl_test_lib:init_per_suite(Config0, openssl),
<a name="init_per_suite-last_expr"/><a name="87"/>   87: <b>    case ssl_test_lib:check_openssl_npn_support</b>(Config1) of
<a name="88"/>   88:         true -&gt;
<a name="89"/>   89:             ssl_test_lib:make_rsa_cert(Config1);
<a name="90"/>   90:         false -&gt;
<a name="91"/>   91:             {skip, &quot;npn_not_supported&quot;}
<a name="92"/>   92:     end.
<a name="93"/>   93: 
<a name="end_per_suite-1"/><a name="94"/>   94: <b>end_per_suite</b>(Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="95"/>   95: <b>    ssl_test_lib:end_per_suite</b>(Config).
<a name="96"/>   96: 
<a name="init_per_group-2"/><a name="97"/>   97: <b>init_per_group</b>(GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="98"/>   98: <b>    ssl_test_lib:init_per_group_openssl</b>(GroupName, Config).
<a name="99"/>   99: 
<a name="end_per_group-2"/><a name="100"/>  100: <b>end_per_group</b>(GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="101"/>  101: <b>    ssl_test_lib:end_per_group</b>(GroupName, Config).
<a name="102"/>  102: 
<a name="init_per_testcase-2"/><a name="103"/>  103: <b>init_per_testcase</b>(TestCase, Config) -&gt; 
<a name="104"/>  104:     ct:timetrap({seconds, 30}),
<a name="init_per_testcase-last_expr"/><a name="105"/>  105: <b>    special_init</b>(TestCase, Config).
<a name="106"/>  106: 
<a name="special_init-2"/><a name="107"/>  107: <b>special_init</b>(erlang_client_openssl_server_npn_renegotiate, Config) -&gt;
<a name="108"/>  108:     {ok, Version} = application:get_env(ssl, protocol_version),
<a name="109"/>  109:     ssl_test_lib:check_sane_openssl_renegotiate(Config, Version);
<a name="110"/>  110: <b>special_init</b>(erlang_server_openssl_client_npn_renegotiate, Config) -&gt;
<a name="111"/>  111:     {ok, Version} = application:get_env(ssl, protocol_version),
<a name="112"/>  112:     case ssl_test_lib:check_sane_openssl_renegotiate(Config, Version) of
<a name="113"/>  113:         Config -&gt;
<a name="114"/>  114:             ssl_test_lib:openssl_allows_client_renegotiate(Config);
<a name="115"/>  115:         Skip -&gt;
<a name="116"/>  116:             Skip
<a name="117"/>  117:     end;
<a name="118"/>  118: <b>special_init</b>(_, Config) -&gt;
<a name="special_init-last_expr"/><a name="119"/>  119:     Config.
<a name="120"/>  120: 
<a name="end_per_testcase-2"/><a name="121"/>  121: <b>end_per_testcase</b>(_, Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="122"/>  122:     Config.
<a name="123"/>  123: 
<a name="124"/>  124: <i>%%--------------------------------------------------------------------</i>
<a name="125"/>  125: <i>%% Test Cases --------------------------------------------------------</i>
<a name="126"/>  126: <i>%%--------------------------------------------------------------------</i>
<a name="127"/>  127: 
<a name="erlang_client_openssl_server_npn-0"/><a name="128"/>  128: <b>erlang_client_openssl_server_npn</b>() -&gt;
<a name="erlang_client_openssl_server_npn-last_expr"/><a name="129"/>  129:     [{doc,&quot;Test erlang client with openssl server doing npn negotiation&quot;}].
<a name="130"/>  130: 
<a name="erlang_client_openssl_server_npn-1"/><a name="131"/>  131: <b>erlang_client_openssl_server_npn</b>(Config) when is_list(Config) -&gt;
<a name="132"/>  132:     ServerOpts = proplists:get_value(server_rsa_verify_opts, Config),
<a name="133"/>  133:     ClientOpts =  ssl_test_lib:ssl_options(client_rsa_verify_opts, Config),
<a name="134"/>  134:     NpnProtocol = &lt;&lt;&quot;spdy/2&quot;&gt;&gt;,
<a name="135"/>  135:    
<a name="136"/>  136:     {Server, OpenSSLPort} =
<a name="137"/>  137:         ssl_test_lib:start_server(openssl, [{np,&quot;http/1.1,spdy/2&quot;},return_port],
<a name="138"/>  138:                                   [{server_opts, ServerOpts} | Config]),
<a name="139"/>  139:     Port = ssl_test_lib:inet_port(Server),
<a name="140"/>  140:     
<a name="141"/>  141:     {Client, CSocket} =
<a name="142"/>  142:         ssl_test_lib:start_client(erlang, [{port, Port},
<a name="143"/>  143:                                            return_socket],
<a name="144"/>  144:                                   [{client_opts,
<a name="145"/>  145:                                     [{client_preferred_next_protocols,
<a name="146"/>  146:                                       {client, [NpnProtocol], &lt;&lt;&quot;http/1.1&quot;&gt;&gt;}} | ClientOpts]}
<a name="147"/>  147:                                   | Config]),
<a name="148"/>  148: 
<a name="149"/>  149:     case ssl:negotiated_protocol(CSocket) of
<a name="150"/>  150:         {ok, NpnProtocol} -&gt;
<a name="151"/>  151:             ok;
<a name="152"/>  152:         Result -&gt;
<a name="153"/>  153:             ct:fail({error, {{expected,  NpnProtocol}, {got, Result}}})
<a name="154"/>  154:     end,
<a name="155"/>  155:     ssl_test_lib:sanity_check(Client, OpenSSLPort),
<a name="erlang_client_openssl_server_npn-last_expr"/><a name="156"/>  156: <b>    ssl:close</b>(CSocket).
<a name="157"/>  157: 
<a name="158"/>  158: <i>%%--------------------------------------------------------------------</i>
<a name="erlang_client_openssl_server_npn_renegotiate-0"/><a name="159"/>  159: <b>erlang_client_openssl_server_npn_renegotiate</b>() -&gt;
<a name="erlang_client_openssl_server_npn_renegotiate-last_expr"/><a name="160"/>  160:     [{doc,&quot;Test erlang client with openssl server doing npn negotiation and renegotiate&quot;}].
<a name="161"/>  161: 
<a name="erlang_client_openssl_server_npn_renegotiate-1"/><a name="162"/>  162: <b>erlang_client_openssl_server_npn_renegotiate</b>(Config) when is_list(Config) -&gt;
<a name="163"/>  163:       
<a name="164"/>  164:     ServerOpts = proplists:get_value(server_rsa_verify_opts, Config),
<a name="165"/>  165:     ClientOpts =  ssl_test_lib:ssl_options(client_rsa_verify_opts, Config),
<a name="166"/>  166:     NpnProtocol = &lt;&lt;&quot;spdy/2&quot;&gt;&gt;,
<a name="167"/>  167:    
<a name="168"/>  168:     Server = ssl_test_lib:start_server(openssl, [{np,&quot;http/1.1,spdy/2&quot;}],
<a name="169"/>  169:                                        [{server_opts, ServerOpts} | Config]),
<a name="170"/>  170:     Port = ssl_test_lib:inet_port(Server),
<a name="171"/>  171:     
<a name="172"/>  172:     {_, CSocket} =
<a name="173"/>  173:         ssl_test_lib:start_client(erlang, [{port, Port},
<a name="174"/>  174:                                            return_socket],
<a name="175"/>  175:                                   [{client_opts,
<a name="176"/>  176:                                     [{client_preferred_next_protocols,
<a name="177"/>  177:                                       {client, [NpnProtocol], &lt;&lt;&quot;http/1.1&quot;&gt;&gt;}} | ClientOpts]} | Config]),
<a name="178"/>  178:     
<a name="179"/>  179:     case ssl:negotiated_protocol(CSocket) of
<a name="180"/>  180:         {ok, NpnProtocol} -&gt;
<a name="181"/>  181:             ok;
<a name="182"/>  182:         Result -&gt;
<a name="183"/>  183:             ct:fail({error, {{expected,  NpnProtocol}, {got, Result}}})
<a name="184"/>  184:     end,
<a name="185"/>  185:     ssl_test_lib:send(Server, ?OPENSSL_RENEGOTIATE),
<a name="186"/>  186:     ct:sleep(1000),
<a name="187"/>  187:     %%% Should still be the same as initially negotiated
<a name="erlang_client_openssl_server_npn_renegotiate-last_expr"/><a name="188"/>  188: <b>    case ssl:negotiated_protocol</b>(CSocket) of
<a name="189"/>  189:         {ok, NpnProtocol} -&gt;
<a name="190"/>  190:             ok;
<a name="191"/>  191:         Other -&gt;
<a name="192"/>  192:             ct:fail({error, {{expected,  NpnProtocol}, {got, Other}}})
<a name="193"/>  193:     end.
<a name="194"/>  194:     
<a name="195"/>  195: <i>%%--------------------------------------------------------------------------</i>
<a name="erlang_server_openssl_client_npn-0"/><a name="196"/>  196: <b>erlang_server_openssl_client_npn</b>() -&gt;
<a name="erlang_server_openssl_client_npn-last_expr"/><a name="197"/>  197:     [{doc,&quot;Test erlang server with openssl client and npn negotiation&quot;}].
<a name="198"/>  198: 
<a name="erlang_server_openssl_client_npn-1"/><a name="199"/>  199: <b>erlang_server_openssl_client_npn</b>(Config) when is_list(Config) -&gt;
<a name="200"/>  200:     ClientOpts = proplists:get_value(client_rsa_opts, Config),
<a name="201"/>  201:     ServerOpts =  ssl_test_lib:ssl_options(server_rsa_verify_opts, Config),
<a name="202"/>  202:     Protocol = &lt;&lt;&quot;spdy/2&quot;&gt;&gt;,
<a name="203"/>  203:     Server = ssl_test_lib:start_server(erlang, [{from, self()}],  
<a name="204"/>  204:                                        [{server_opts, [{next_protocols_advertised, 
<a name="205"/>  205:                                                         [&lt;&lt;&quot;spdy/2&quot;&gt;&gt;]} |ServerOpts]} | Config]),
<a name="206"/>  206:     Port = ssl_test_lib:inet_port(Server),
<a name="207"/>  207:     {_Client, OpenSSLPort} =
<a name="208"/>  208:         ssl_test_lib:start_client(openssl, [{port, Port},
<a name="209"/>  209:                                             {np, &quot;spdy/2&quot;},
<a name="210"/>  210:                                             {options, ClientOpts},
<a name="211"/>  211:                                             return_port], Config),
<a name="212"/>  212:     Server ! get_socket,
<a name="213"/>  213:     SSocket = 
<a name="214"/>  214:         receive 
<a name="215"/>  215:             {Server, {socket, Socket}} -&gt;
<a name="216"/>  216:                 Socket
<a name="217"/>  217:         end,
<a name="218"/>  218:     case ssl:negotiated_protocol(SSocket) of
<a name="219"/>  219:         {ok, Protocol} -&gt;
<a name="220"/>  220:             ok;
<a name="221"/>  221:         Result -&gt;
<a name="222"/>  222:             ct:fail({error, {{expected, Protocol}, {got, Result}}})
<a name="223"/>  223:     end,
<a name="224"/>  224:     ssl_test_lib:sanity_check(Server, OpenSSLPort),
<a name="erlang_server_openssl_client_npn-last_expr"/><a name="225"/>  225: <b>    ssl:close</b>(SSocket).
<a name="226"/>  226: 
<a name="227"/>  227:    
<a name="228"/>  228: <i>%%--------------------------------------------------------------------------</i>
<a name="229"/>  229: <i>%% erlang_server_openssl_client_npn_renegotiate() -&gt;</i>
<a name="230"/>  230: <i>%%     [{doc,&quot;Test erlang server with openssl client and npn negotiation with renegotiation&quot;}].</i>
<a name="231"/>  231: 
<a name="erlang_server_openssl_client_npn_renegotiate-1"/><a name="232"/>  232: <b>erlang_server_openssl_client_npn_renegotiate</b>(Config) when is_list(Config) -&gt;
<a name="233"/>  233:     ClientOpts = proplists:get_value(client_rsa_verify_opts, Config),
<a name="234"/>  234:     ServerOpts =  ssl_test_lib:ssl_options(server_rsa_verify_opts, Config),
<a name="235"/>  235:     NpnProtocol = &lt;&lt;&quot;spdy/2&quot;&gt;&gt;,
<a name="236"/>  236:     Server =
<a name="237"/>  237:         ssl_test_lib:start_server(erlang, [{from, self()}],
<a name="238"/>  238:                                   [{server_opts, [{next_protocols_advertised,
<a name="239"/>  239:                                                    [NpnProtocol]} | ServerOpts]} | Config]),
<a name="240"/>  240:     Port = ssl_test_lib:inet_port(Server),
<a name="241"/>  241:     {_Client, OpenSSLPort} = 
<a name="242"/>  242:         ssl_test_lib:start_client(openssl, [{port, Port}, {np, &quot;spdy/2&quot;}, 
<a name="243"/>  243:                                             {options, ClientOpts}, return_port], Config),
<a name="244"/>  244:     
<a name="245"/>  245:     Server ! get_socket,
<a name="246"/>  246:     SSocket = 
<a name="247"/>  247:         receive 
<a name="248"/>  248:             {Server, {socket, Socket}} -&gt;
<a name="249"/>  249:                 Socket
<a name="250"/>  250:         end,
<a name="251"/>  251:     case ssl:negotiated_protocol(SSocket) of
<a name="252"/>  252:         {ok, NpnProtocol} -&gt;
<a name="253"/>  253:             ok;
<a name="254"/>  254:         Result -&gt;
<a name="255"/>  255:             ct:fail({error, {{expected,  NpnProtocol}, {got, Result}}})
<a name="256"/>  256:     end,
<a name="257"/>  257:     ssl_test_lib:sanity_check(Server, OpenSSLPort),
<a name="258"/>  258:     ssl:renegotiate(SSocket),
<a name="259"/>  259:     case ssl:negotiated_protocol(SSocket) of
<a name="260"/>  260:         {ok, NpnProtocol} -&gt;
<a name="261"/>  261:             ok;
<a name="262"/>  262:         Other -&gt;
<a name="263"/>  263:             ct:fail({error, {{expected,  NpnProtocol}, {got, Other}}})
<a name="264"/>  264:     end,
<a name="265"/>  265:     ssl_test_lib:sanity_check(Server, OpenSSLPort),
<a name="erlang_server_openssl_client_npn_renegotiate-last_expr"/><a name="266"/>  266: <b>    ssl:close</b>(SSocket).
<a name="267"/>  267: <i>%%--------------------------------------------------------------------------</i>
<a name="erlang_client_openssl_server_npn_only_client-1"/><a name="268"/>  268: <b>erlang_client_openssl_server_npn_only_client</b>(Config) when is_list(Config) -&gt;
<a name="269"/>  269:     ServerOpts = proplists:get_value(server_rsa_verify_opts, Config),
<a name="270"/>  270:     ClientOpts =  ssl_test_lib:ssl_options(client_rsa_verify_opts, Config),
<a name="271"/>  271:    
<a name="272"/>  272:     {Server, OpenSSLPort} =
<a name="273"/>  273:         ssl_test_lib:start_server(openssl, [{np,&quot;spdy/2&quot;}, return_port],
<a name="274"/>  274:                                   [{server_opts, ServerOpts} | Config]),
<a name="275"/>  275:     Port = ssl_test_lib:inet_port(Server),
<a name="276"/>  276:     
<a name="277"/>  277:     {Client, CSocket} =
<a name="278"/>  278:         ssl_test_lib:start_client(erlang, [{port, Port},
<a name="279"/>  279:                                            return_socket],
<a name="280"/>  280:                                   [{client_opts, ClientOpts} | Config]),
<a name="281"/>  281: 
<a name="282"/>  282:     case ssl:negotiated_protocol(CSocket) of
<a name="283"/>  283:         {error, protocol_not_negotiated} -&gt;
<a name="284"/>  284:             ok;
<a name="285"/>  285:         Result -&gt;
<a name="286"/>  286:             ct:fail({error, {{expected, undefined}, {got, Result}}})
<a name="287"/>  287:     end,
<a name="288"/>  288:     ssl_test_lib:sanity_check(Client, OpenSSLPort),
<a name="erlang_client_openssl_server_npn_only_client-last_expr"/><a name="289"/>  289: <b>    ssl:close</b>(CSocket).
<a name="290"/>  290: 
<a name="291"/>  291: <i>%%--------------------------------------------------------------------------</i>
<a name="erlang_client_openssl_server_npn_only_server-1"/><a name="292"/>  292: <b>erlang_client_openssl_server_npn_only_server</b>(Config) when is_list(Config) -&gt;
<a name="293"/>  293:    ServerOpts = proplists:get_value(server_rsa_verify_opts, Config),
<a name="294"/>  294:     ClientOpts =  ssl_test_lib:ssl_options(client_rsa_verify_opts, Config),
<a name="295"/>  295:    
<a name="296"/>  296:     {Server, OpenSSLPort} =
<a name="297"/>  297:         ssl_test_lib:start_server(openssl, [{np,&quot;spdy/2&quot;}, return_port],
<a name="298"/>  298:                                   [{server_opts, ServerOpts} | Config]),
<a name="299"/>  299:     Port = ssl_test_lib:inet_port(Server),
<a name="300"/>  300:     
<a name="301"/>  301:     {Client, CSocket} =
<a name="302"/>  302:         ssl_test_lib:start_client(erlang, [{port, Port},
<a name="303"/>  303:                                            return_socket],
<a name="304"/>  304:                                   [{client_opts, ClientOpts} | Config]),
<a name="305"/>  305:     
<a name="306"/>  306:     case ssl:negotiated_protocol(CSocket) of
<a name="307"/>  307:         {error, protocol_not_negotiated} -&gt;
<a name="308"/>  308:             ok;
<a name="309"/>  309:         Result -&gt;
<a name="310"/>  310:             ct:fail({error, {{expected, undefined}, {got, Result}}})
<a name="311"/>  311:     end,
<a name="312"/>  312:     ssl_test_lib:sanity_check(Client, OpenSSLPort),
<a name="erlang_client_openssl_server_npn_only_server-last_expr"/><a name="313"/>  313: <b>    ssl:close</b>(CSocket).
<a name="314"/>  314:         
<a name="315"/>  315: <i>%%--------------------------------------------------------------------------</i>
<a name="erlang_server_openssl_client_npn_only_server-1"/><a name="316"/>  316: <b>erlang_server_openssl_client_npn_only_server</b>(Config) when is_list(Config) -&gt;
<a name="317"/>  317:   ClientOpts = proplists:get_value(client_rsa_verify_opts, Config),
<a name="318"/>  318:     ServerOpts =  ssl_test_lib:ssl_options(server_rsa_verify_opts, Config),
<a name="319"/>  319:     Server =
<a name="320"/>  320:         ssl_test_lib:start_server(erlang, [{from, self()}],
<a name="321"/>  321:                                   [{server_opts,
<a name="322"/>  322:                                     [{next_protocols_advertised,
<a name="323"/>  323:                                       [&lt;&lt;&quot;spdy/2&quot;&gt;&gt;, &lt;&lt;&quot;http/1.1&quot;&gt;&gt;]}
<a name="324"/>  324:                                     | ServerOpts]} | Config]),
<a name="325"/>  325:     Port = ssl_test_lib:inet_port(Server),
<a name="326"/>  326:     {_Client, OpenSSLPort} = ssl_test_lib:start_client(openssl, [{port, Port},
<a name="327"/>  327:                                                                  {options, ClientOpts},
<a name="328"/>  328:                                                                  return_port], Config),
<a name="329"/>  329: 
<a name="330"/>  330:     Server ! get_socket,
<a name="331"/>  331:     SSocket =
<a name="332"/>  332:         receive
<a name="333"/>  333:             {Server, {socket, Socket}} -&gt;
<a name="334"/>  334:                 Socket
<a name="335"/>  335:         end,
<a name="336"/>  336:     case ssl:negotiated_protocol(SSocket) of
<a name="337"/>  337:         {error, protocol_not_negotiated} -&gt;
<a name="338"/>  338:             ok;
<a name="339"/>  339:         Result -&gt;
<a name="340"/>  340:             ct:fail({error, {{expected, undefined}, {got, Result}}})
<a name="341"/>  341:     end,
<a name="342"/>  342:     ssl_test_lib:sanity_check(Server, OpenSSLPort),
<a name="erlang_server_openssl_client_npn_only_server-last_expr"/><a name="343"/>  343: <b>    ssl:close</b>(SSocket).
<a name="344"/>  344: 
<a name="345"/>  345: <i>%%--------------------------------------------------------------------------</i>
<a name="erlang_server_openssl_client_npn_only_client-1"/><a name="346"/>  346: <b>erlang_server_openssl_client_npn_only_client</b>(Config) when is_list(Config) -&gt;
<a name="347"/>  347:     ClientOpts = proplists:get_value(client_rsa_verify_opts, Config),
<a name="348"/>  348:     ServerOpts =  ssl_test_lib:ssl_options(server_rsa_verify_opts, Config),
<a name="349"/>  349:     Server = ssl_test_lib:start_server(erlang, [{from, self()}],  
<a name="350"/>  350:                                        [{server_opts, [ServerOpts]} | Config]),
<a name="351"/>  351:     Port = ssl_test_lib:inet_port(Server),
<a name="352"/>  352:     {_Client, OpenSSLPort}
<a name="353"/>  353:         = ssl_test_lib:start_client(openssl, [{port, Port},
<a name="354"/>  354:                                               {np, &quot;spdy/2&quot;},
<a name="355"/>  355:                                               {options, ClientOpts},
<a name="356"/>  356:                                               return_port], Config),
<a name="357"/>  357:     
<a name="358"/>  358:     Server ! get_socket,
<a name="359"/>  359:     SSocket = 
<a name="360"/>  360:         receive 
<a name="361"/>  361:             {Server, {socket, Socket}} -&gt;
<a name="362"/>  362:                 Socket
<a name="363"/>  363:         end,
<a name="364"/>  364:     case ssl:negotiated_protocol(SSocket) of
<a name="365"/>  365:         {error, protocol_not_negotiated} -&gt;
<a name="366"/>  366:             ok;
<a name="367"/>  367:         Result -&gt;
<a name="368"/>  368:             ct:fail({error, {{expected, undefined}, {got, Result}}})
<a name="369"/>  369:     end,
<a name="370"/>  370:     ssl_test_lib:sanity_check(Server, OpenSSLPort),
<a name="erlang_server_openssl_client_npn_only_client-last_expr"/><a name="371"/>  371: <b>    ssl:close</b>(SSocket).
<a name="372"/>  372: 
<a name="373"/>  373: <i>%%--------------------------------------------------------------------</i>
<a name="374"/>  374: <i>%% Internal functions  -----------------------------------------------</i>
<a name="375"/>  375: <i>%%--------------------------------------------------------------------</i>
</pre>
</body>
</html>
